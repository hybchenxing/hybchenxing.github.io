<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Drupal XSS漏洞（CVE-2019-6341） | hybcx's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline.css"><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/friends/"><span class="navItemTitle">Friends</span></a></li><li class="navItem"><a class="navBlock" href="/about"><span class="navItemTitle">About</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>Drupal XSS漏洞（CVE-2019-6341）</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-09-16T06:12:29.710Z" id="date"> 2023-09-16</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-19T11:10:29.175Z" id="updated"> 2023-09-19</time></div></span><br><span>Word Count: <div class="control">1.6k</div></span><br><span>Read Time: <div class="control">6 min</div></span></div></div><hr><div id="post-content"><h2 id="0x01-漏洞概述"><a href="#0x01-漏洞概述" class="headerlink" title="0x01-漏洞概述"></a>0x01-漏洞概述</h2>
<ul>
<li>影响软件：Drupal</li>
<li>方式：通过文件模块或者子系统上传恶意文件触发XSS漏洞</li>
<li>参考链接：<a target="_blank" rel="noopener" href="https://paper.seebug.org/897/">Drupal 1-click to RCE 分析</a></li>
<li>效果：JS代码执行（Cookies 资料窃取、会话劫持、钓鱼欺骗、网页挂马等）</li>
</ul>
<h2 id="0x02-漏洞环境"><a href="#0x02-漏洞环境" class="headerlink" title="0x02-漏洞环境"></a>0x02-漏洞环境</h2>
<p>执行如下命令启动drupal 8.5.0的环境：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d<br></code></pre></td></tr></table></figure>
<p>环境启动后，访问 <code>http://your-ip:8080/</code> 将会看到drupal的安装页面，一路默认配置下一步安装。因为没有mysql环境，所以安装的时候可以选择sqlite数据库。</p>
<h2 id="0x03-Drupal资料"><a href="#0x03-Drupal资料" class="headerlink" title="0x03-Drupal资料"></a>0x03-Drupal资料</h2>
<p>GPT回答:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Drupal是一种独立开源的内容管理系统（Content Management System，简称CMS）。它是用PHP编程语言开发的，并使用MySQL或PostgreSQL数据库进入数据存储。Drupal提供了一套功能强大和灵活的工具，用于构建和管理网站、博客、社区网站、电子商务平台和其他各种在线应用。<br><br>Drupal提供了许许多多的功能和模块，使用用户足够的创建和管理各种类型的内容，包括文章、页面、图像、多媒体文件和用户帐户。它还具有强大的用户角色和权限管理系统，使网站管理人员足够对不同的用户给予不同的访问权限。<br><br>Drupal的主要优点之一是其灵性和可扩展性。它拥有一个很大的社区，提供了数以千计的模块和主题，可以根据不同的需求和要求进行定制。这使Drupal成为一个非常强大的和适合性能强的平台，可以用于构建各种模板和类型的网站。<br><br>总的来说，Drupal是一种功能强大、灵魂活动和可扩展的开源内部管理系统，用于构建和管理各种类型的网站和在线应用。<br><br>何为内容管理系统(CMS):<br><br>内容管理系统（Content Management System，CMS）可以用来管理、组织和发布各种类型的内容。它提供了一套工具和功能，使用户能够轻松创建、编辑、存储和分发内容，而无需编写代码或具备深入的技术知识。<br></code></pre></td></tr></table></figure>
<h2 id="0x04-漏洞原理"><a href="#0x04-漏洞原理" class="headerlink" title="0x04-漏洞原理"></a>0x04-漏洞原理</h2>
<h3 id="3-1-无后缀文件写入"><a href="#3-1-无后缀文件写入" class="headerlink" title="3-1-无后缀文件写入"></a>3.1 无后缀文件写入</h3>
<p>在Drupal的机制中，设定了这样一条规则。</p>
<p>用户上传的图片文件名将会被保留，如果出现文件名相同的情况，那么文件名后面就会被跟上<code>_0</code>,<code>_1</code>依次递增。</p>
<p>在Drupal中为了兼容各种编码，在处理上传文件名时，Drupal会对文件名对相应的处理，如果出现值小于<code>0x20</code>的字符，那么就会将其转化为<code>_</code>。</p>
<p>![image-20230615205051359](Drupal XSS漏洞（CVE-2019-6341）\image-20230615205051359.png)</p>
<p>但如果文件名中，如果出现了<code>\x80</code>到<code>\xff</code>的字符时，PHP就会抛出<code>PREG_BAD_UTF8_ERROR</code>，如果发生错误，那么<code>preg_replace</code>就会返回NULL，<code>$basename</code>就会被置为NULL。</p>
<p>![image-20230615205106915](Drupal XSS漏洞（CVE-2019-6341）\image-20230615205106915.png)</p>
<p>当basename为空时，后面的文件内容会被写入到形似<code>_0</code>的文件内</p>
<p>![image-20230615205120047](Drupal XSS漏洞（CVE-2019-6341）\image-20230615205120047.png)</p>
<p>在这个基础下，原本会被上传到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/sites/default/files/pictures/&lt;YYYY-MM&gt;/<br></code></pre></td></tr></table></figure>
<p>则会被写入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/sites/default/files/pictures/&lt;YYYY-MM&gt;/_0<br></code></pre></td></tr></table></figure>
<p><strong>当服务端开启了评论头像上传，或者是拥有作者账号时</strong></p>
<p>攻击者可以通过上传一张恶意构造的gif图，然后再上传一张带有恶意字符的同一张图，那么就会将恶意图片的内容写入到相应目录的<code>_0</code>中</p>
<p>![image-20230615210437063](Drupal XSS漏洞（CVE-2019-6341）\image-20230615210437063.png)</p>
<p>但如果我们直接访问这个文件时，该文件可能不会解析，这是因为</p>
<ol>
<li>浏览器首先会根据服务端给出的content-type解析页面，而服务端一般不会给空后缀的文件设置<code>content-type</code>，或者设置为<code>application/octet-stream</code></li>
<li>其次浏览器会根据文件内容做简单的判断，如果文件的开头为<code>&lt;html&gt;</code>，则部分浏览器会将其解析为html</li>
<li>部分浏览器还可能会设置默认的content-type，但大部分浏览器会选择不解析该文件。</li>
</ol>
<p>这时候我们就需要一个很特殊的小trick了，<strong>a标签可以设置打开文件的type(only not for chrome)</strong></p>
<p>当你访问该页面时，页面会被解析为html并执行相应的代码。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;a&#x27;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://127.0.0.1/drupal-8.6.2/sites/default/files/2019-04/_6&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/html&quot;</span>&gt;</span>321321<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> a  = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;a&#x27;</span>)</span><br><span class="language-javascript">    a.<span class="hljs-title function_">click</span>()</span><br><span class="language-javascript">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>当被攻击者访问该页面时，我们就可以执行任意的xss，这为后续的利用带来了很大的便利，我们有了一个同源环境下的任意js执行点，让我们继续看。</p>
<h2 id="0x05-漏洞复现"><a href="#0x05-漏洞复现" class="headerlink" title="0x05-漏洞复现"></a>0x05-漏洞复现</h2>
<p>该漏洞需要利用drupal文件模块上传文件的漏洞，伪造一个图片文件，上传，文件的内容实际是一段HTML代码，内嵌JS，这样其他用户在访问这个链接时，就可能触发XSS漏洞。</p>
<p>Drupal 的图片默认存储位置为 <code>/sites/default/files/pictures/&lt;YYYY-MM&gt;/</code>，默认存储名称为其原来的名称，所以之后在利用漏洞时，可以知道上传后的图片的具体位置。</p>
<p>使用PoC上传构造好的伪造GIF文件，PoC参考<a target="_blank" rel="noopener" href="https://github.com/thezdi/PoC/tree/master/Drupal">thezdi/PoC</a>的PoC。</p>
<p>如图，输入如下命令，即可使用PoC构造样本并完成上传功能，第一个参数为目标IP 第二个参数为目标端口。</p>
<p>![image-20230615212825825](Drupal XSS漏洞（CVE-2019-6341）\image-20230615212825825.png)</p>
<p>上传成功后，访问图片位置，即可触发 XSS 漏洞，如下图所示。</p>
<p>尖端：</p>
<ol>
<li>因为 Chrome 和 FireFox 浏览器自带部分过滤 XSS 功能，所以验证存在时可使用 Edge 浏览器或者 IE 浏览器。</li>
<li>访问的图片名称为_0的原因是因为 Drupal 的规则机制，具体原理见<a target="_blank" rel="noopener" href="https://paper.seebug.org/897/">Drupal 1-click to RCE 分析</a></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/var/www/html/drupal/sites/default/files/pictures/YYYY-MM<br></code></pre></td></tr></table></figure>
<p>这里的时间应该是你上传的时候的北京时间因此我这里的访问路径为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">http://185.243.241.45:8080/sites/default/files/pictures/2023-06/_0<br></code></pre></td></tr></table></figure>
<p>![image-20230615213558660](Drupal XSS漏洞（CVE-2019-6341）\image-20230615213558660.png)</p>
<p>但不知为何我这里edge浏览器也不显示弹窗</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/09/16/Nginx-%E6%96%87%E4%BB%B6%E5%90%8D%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E/">← Next Nginx-文件名逻辑漏洞CVE-2013-4547</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/09/11/Elasticsearch%E5%86%99%E5%85%A5webshell%E6%BC%8F%E6%B4%9E%EF%BC%88WooYun-2015-110216%EF%BC%89/">Elasticsearch写入webshell漏洞（WooYun-2015-110216） Prev →</a></div></div></div><div id="comments"><div id="waline"></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">hybcx</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E6%BC%8F%E6%B4%9E%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">0x01-漏洞概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">0x02-漏洞环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-Drupal%E8%B5%84%E6%96%99"><span class="toc-number">3.</span> <span class="toc-text">0x03-Drupal资料</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">0x04-漏洞原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%97%A0%E5%90%8E%E7%BC%80%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 无后缀文件写入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">0x05-漏洞复现</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script type="module">import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
window.waline = init;
</script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {if (document.querySelector('#waline'))
 waline({
   el: '#waline',
   dark: ':root[theme-mode="dark"]',
   serverURL: 'https://waline-blog-iwqdtxise-hybchenxing.vercel.app',
   path: window.location.pathname,
 });document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>