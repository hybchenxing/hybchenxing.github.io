<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>BlueCMS代码审计 | hybcx</title><meta name="keywords" content="PHP代码审计"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="BlueCMS代码审计"><meta name="application-name" content="BlueCMS代码审计"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="BlueCMS代码审计"><meta property="og:url" content="http://hybcx.xyz/2024/05/29/bluecms-dai-ma-shen-ji/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 环境搭建 这里不赘述，网上搜搜都有的，我也把参考文章放到了文末，主要还是细心问题，还是可以搭建成功的（但我却踩了很多坑 0x02 前置知识 明确目标： 在审计之前，我们首先先确定自己此次审计的目地，一般会有三种情况：  为了提升自己的审计经验 项目中为了审计出能进一步利用的漏洞，一般需要g"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 环境搭建 这里不赘述，网上搜搜都有的，我也把参考文章放到了文末，主要还是细心问题，还是可以搭建成功的（但我却踩了很多坑 0x02 前置知识 明确目标： 在审计之前，我们首先先确定自己此次审计的目地，一般会有三种情况：  为了提升自己的审计经验 项目中为了审计出能进一步利用的漏洞，一般需要g"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/05/29/bluecms-dai-ma-shen-ji/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'BlueCMS代码审计',
  postAI: '',
  pageFillDescription: '0x01 环境搭建, 0x02 前置知识, 明确目标：, 使用框架, 审计流程, BlueCMS简介, 0x03 前期审计, 入口点分析, 找后台, 0x04 漏洞审计, 前台sql注入, $_SERVER绕过, Insert注入1, Insert注入2, Insert注入3, 宽字节注入, 后台万能密码, 编辑会员sql注入, 后台导航sql注入, 后台属性列表sql注入, 任意文件读取, 任意文件写入, 任意文件删除, 第一处, 第二处, 第三处, 任意文件包含, XSS漏洞, 第一处, 第二处, 第三处, SSRF漏洞, 0x05 总结, 0x06 参考文章环境搭建这里不赘述网上搜搜都有的我也把参考文章放到了文末主要还是细心问题还是可以搭建成功的但我却踩了很多坑前置知识明确目标在审计之前我们首先先确定自己此次审计的目地一般会有三种情况为了提升自己的审计经验项目中为了审计出能进一步利用的漏洞一般需要这种级别的为了挖点洞去换钱或者换如果是为了提升审计经验应该要去重点关注历史漏洞并去复现如果是为了能审出漏洞去用作渗透中的进一步利用那么我觉得可以重点使用等自动化代码审计然后关注下面的文件上传包含注入等等有严重危害的漏洞如果是为了挖搞证书什么的那么全方位按步骤过一遍是不错的选择使用框架判断是否使用了框架是蛮重要的能帮助我们快速定位有用的函数集筛选不需要去看的代码一般来说我觉得使用了框架的更好审计一点因为使用了框架的他的函数集文件各种方法会比较规整在某些固定文件夹中清晰可见当然需要我们先对框架有所了解目前比较主流的设计模式是即多层模型视图控制器在此不多赘述的主流框架几乎都使用了设计模式底下的开发框架目前见的比较多的有等审计流程看了一篇文章是这样说的代码审计过程是基础语法巩固特性各类漏洞挖掘方法早期程序代码审计实战模式程序代码审计实战这位师傅选择的实战依次是这样的这个我认为我也可以采用这个路线难度逐渐提升在对这几个系统的代码审计过程中也能感受到开发技术的发展和趋势直到发现已经实现了一个模型的程序相信完成这步后再审计非模式程序的代码就会具有清晰的思路与十足的把握简介是一款应用于地方分类信息的门户系统本文下载的源码为版可以追溯到年左右了该系统确实很老但审计该系统有一个好处是即使现在开发技术十分成熟了但仍有人因为经验缺乏或时间原因会开发出类似这样简单的系统甚至比更简单通过对实战审计能够熟悉这类简单的程序逻辑被认为是练手代码审计的绝佳项目以至于现在百度的关键词全是代码审计那为什么都被审计烂了我还要在发一篇的代码审计博客呢首先确实经典是一个入门的好项目其次是无架构时期最早流行的一批是早期程序代码审计实战系列最标志的第一环本地部署好后先访问进行安装感觉过程有点不过返回首页后会发现安装成功按照要求完成之后访问首页出现上图即可代表安装成功前期审计这里主要还是跟着文章走没思路入口点分析首先分析目录结构通过目录结构能够看出简单的程序逻辑目录结构主要是关注入口点也就是文件位置该下的程序就位于根目录下这是不安全的会导致整个文件被窃取的风险接下来跟着文章自行分析一边这个入口文件首先定义了常量然后包含了两个文件至于做什么先不用管然后这里调用了函数参数里面是一个跟进去发现就是一个更新任务的意思大概意思就是动态包含文件中间部分逻辑相同无非就是调用函数获取当前数据库信息比如新闻列表分类信息推荐信息之类的然后就是通过下面这一部分代码渲染到前端页面上这里可以看到采用的是模板引擎渲染这里也就知道了这个所谓的入口文件只是单纯的做一个前端页面显示的工作这里那篇文章说到这里可以判断出前台是一个多入口的模式注意多入口的系统需要对每个入口文件单独做出安全过滤他们都会加载同一个文件来实现再这个上就是然后跟进文件前面的部分依旧是定义常量包含某些文件然后判断如果没有开启的话就调用函数转义这些参数的内容但是没有过滤过滤然后就是参数在这里充当连接数据库的作用下面这里是引入了对象同时还有对用户的处理达到某些条件将会最后就是关于一些以及会话的处理了先不关注这里回到最初看一下那个过滤函数的内容毕竟有过滤那如果能绕过就有造成漏洞的可能如上图函数先判读参数是否是数组如果是的话递归调用本函数直到不是数组然后调用自带的函数进行特殊字符的转移接下来可以再关注数据库连接的内容当前目录的内容大致如下这里可以看到初始化变量然后调用构造函数初始化一些信息并且能看到这里的数据库编码方式为说不定存在宽字符注入然后函数中用函数来连接数据库判断数据库版本信息然后选择执行对应的语句剩下没展示的就是一些自定义的执行函数找后台后台一般只有通过身份验证后才能访问提前就有一层安全保障但后台程序一般都是漏洞百出我们很多时候只有靠后台才能拿到服务器的这里具体分析一下的后台逻辑这里的后台文件我们看目录不难猜到有一个这里截取部分代码前面不用说下面就是判断参数的值来对应的展示后台页面这里文章说到关注可以知道后台是通过来实现的这样后台程序的所有功能都可以依附在下实现在早期的中基本都是这种实现方案管理中心你的浏览器不支持框架这里同时还看到了该页面加载了文件这个与类似但不同的是在最后的部分前者是根据的信息判断当前管理员的用户名和密码是否存在与数据库中这一部分先判断如果管理员当前处于登陆状态并且对应的是存在的则调用更新当前管理员用户的信息如果当前管理员用户的信息是空的就回去判断对应的信息如果对应的数据都存在则调用函数判断该用户的账号密码是否在数据库中如果该用户是管理员的话调用更新信息如果没有设置的信息就程序自己设置为空然后跳转到登陆页面这里和就防止了未授权也就是想直接访问的后台页面是不可能的漏洞审计目前我的自动话代码审计工具只有个之后了解一下前台注入直接上一手自动化如上图看到一个可能的注入我们跟进去看看被打击到了太菜了很简单但还是没看出来可以看到这里先是加载了文件我们知道其中存在着函数的对特数字符的过滤然后判断参数是否存在如果为空则赋值为空不为空则经过函数的处理也就是去除字符串首位空字符没啥用如果为空则首页然后后退出不是空的话就连接数据库进行语句的查询中间部分没啥用到最后就是对回显的内容进行处理对其中的换行符双引号之类的进行转移防止被当成特殊字符对待这里重点看查询语句当时尴尬了以为是双引号闭合的没发现只是单纯的字符串拼接同时对没啥过滤除了这样就能知道就是单纯的数字型注入我们看一下数据库对应的表可以看到有列那我们直接联合注入即可这里为了方便我就将源代码的对注释部分取消了让其直接回显到页面懒这里看到回显位是根据数据库的内容我们一步到位拿到管理员密码解密一下就是绕过我们知道在上面提到的函数中并没有对做出过滤我们可以通过这个传入外部数据造成漏洞接下来可以看一下这个在哪里被调用过马后炮的话就是顺着那片文章的思路我们尝试倒着找一次因为没有对做出限制我们可以全局搜索的使用情况如上图能够看到有很多地方都是用到了在我看了文章以及自身的思考之后发现对于这种情况我们不必盲目的尝试我认为可以都先看一遍重点关注其中参数可控的比如举几个与漏洞无关的例子这里是获取头的明显可控这里一个是获取访问者的还有一个是也就是服务就这样一个个看过去最后可以看到我们此次的漏洞点如下图这里明显是对于是可控的抓包修改即可但是当我们找到这种类似的情况又该如何利用那就是看该值赋给了哪个参数比如我们的漏洞点这里赋值给了变量而这个变量又在函数中我们可以看一下谁调用了这个函数注入如下图这里能看到有两个地方调用过先看第一个可以看到这里直接调用函数来获取然后语句插入到数据库中我们往上看往上看的原因是我们需要找到该语句是否有回显的地方否则即使有注入点看不到也没办法不过突然想到时间盲注似乎可以不必在乎这里它通过进行渲染很明显只显示发送评论的内容那我们需要想办法将注入语句插入到上面的地方才能让其有回显这里的其他参数就不赘述了我们翻看就能知道只有当参数为参数存在的时候才行或者直接在下面的地方输入内容点击评论抓包也可这里我也是搜了几个注入的方式但不行最终找了几篇文章才知道的我知道了我当时出不来的原因就是脑子太死用的不灵活那个语句完全不适用于这个地方不会变通因为这里对是通过获取的我们直接伪造头或者即可同时有个知识点语句的话我们可以这样可以多插几个的因此如下图最终查看即可这里我们上面也提过可以无脑跑一下抓包在头上个标记然后即可注入来到第二个调用点我们发现该函数的值被赋值给了一个变量那就继续追踪这个变量如下图能看到有八个调用点这里都随便看看就知道只有的地方还有点意思剩下的虽然有调用点但是没办法进一步利用比如中这里虽然将参数值插入了进去但是并没有页面回显的地方但是如下图我们可以考虑时间盲注这里也证明是可行的不过当我采用上述同样的注入手法发现总是抱错这里不太理解为何注入追踪到发现这是一个留言板的功能话不多说直接尝试注入这里注入的时候还遇到点问题就是参数的值的问题如下图这里如果我们点击了发布成功之后显示给我们的超链接就会调用这一块函数这里认为当参数值为的时候才会正常的去显示评论页面我当时给赋值为了导致我死活见不到我留言的内容宽字节注入后台万能密码因为我们知道这个数据库选择了编码那大概率有地方能够利用宽字节注入绕过过滤我们直接定位到文章所说的地方代码逻辑就是当我们尝试在后台登陆的时候会跳转到上面这段代码块首先判断我们输入的用户名和密码是否为空存在的话就调用函数检查这两个数据在数据库是否存在这个函数内部就是常规的查询语句我们很容易想到万能密码不过我们知道传入的数据会被函数过滤但因为是编码所以可以宽字节绕过如下图成功登录编辑会员注入这里也是偶然看到的看文章说这里存在某个宽字节注入但是没找到倒是找到了联合注入通读一遍代码就知道这里可疑了没有任何过滤因为不需要单引号因此这个函数的过滤也就没用了这里是数字型注入后台导航注入根据定位到这里然后直接数字型注入即可后台属性列表注入这个点也很疑惑也说明了我手工注入有点垃圾啊这个是看的文章了解到的首先定位到发现下图位置存在注入因为这里对参数没有任何过滤我们直接输入即可我开始的为但是页面只说语法错误但我不理解为何出不来信息或许又是跟我的环境有关但当我尝试用去跑的时候发现延时注入是可以使用的它使用的如下类似的下面这一个地方也是跟上述差不多任意文件读取这里根据文章所说中存在任意文件读取我们同时可以结合能看到敏感函数的位置定位到下图能看到对传入的参数没有过滤这里的就是根目录也就是说我们只需要向上跳两级即可根据各个文件的位置任意读文件了如下图任意文件写入这里当时没注意直接看了文章的思路了我们在刚刚的代码处往下看就知道它将文件输入的内容进行的处理了然后就根据定义的文件路径写入该文件我们跟进一下这个函数看看这里无非就是调用自带的函数我们看一下这个函数的作用这里突然就能联想到这个对全局的参数还做了某个过滤就是我们知道这个函数是转移单引号这些字符而恰恰相反是去除这些转移符号这相当于没有过滤那我们直接根据代码写入文件即可蚁剑连接也成功任意文件删除第一处这里也是看文章得到的之前也注意过不过忽略了因为某些原因首先根据代码审计系统知道在的位置存在函数可能会有任意文件删除漏洞我们跟进看看第一个就是文章所说的在这里是当等于这个值的时候接受一个参数然后进入数据库查询之后如果对应的文件存在的话就删除很明显这里没有对进行任何过滤我们直接遍历的话就能删除任意文件我们可以尝试删除可以看到抱错这里原因在于数据库初始化的时候并没有这个表导致这里抱错但如果这个表存在的话是不会影响后续的执行的我们不妨注释一下测试如上图发现删除成功第二处我们先创建一个测试文件然后继续跟踪的调用到了下面这里这里的调用是当的时候并且只要为空就到了下面的代码块然后我们只需要给赋值即可依旧没有任何过滤最终执行发现文件成功删除第三处我们继续往上跟踪可以看到下面这里依旧没有任何过滤然后调用到这一块代码也很简单往上走然后满足各个必要的参数的存在即可如下如图所示除了文件路径之外其他参数都是必要的执行后我们发现成功删除文件任意文件包含这里没有复现成功感觉是我自身环境的问题吧我们先看漏洞点搜寻下的函数发现只有下图位置中存在可控的可能性只要我们选择然后给传参进行目录遍历即可包含任意函数不过需要注意的是这里后面有的后缀存在思路一般会有截断或者依靠系统文件路径长度限制个字节个字节因为这里版本那肯定不是截断因此会尝试长度截断这里无非就是这样的后面一堆来截断但是我却不能复现出来猜测是某些环境配置的问题导致我当前的文件系统依旧可以处理这样长度的路径这里如果成功的话找一下哪里可以上传配合图片马即可补充一下突然发现一篇文章说了类似的问题他是这样说的然后他尝试了的版本然后成功了但我在复现的时候还是没成功估计就是环境每搭好或者是又变化了下面是它成功的截图漏洞第一处依旧是在中找函数跟踪发现如下图的地方存在可以地方他对大部分参数只进行了的处理很明显如果该参数参与了前端的渲染那么就可以造成存储型这里测试了一番发现只有邮件地址这里可以生效第二处这一个地方也是刚刚关注了但是以为过滤的没毛病我就认为没利用点了如上图的地方这里依旧是然后这里并没有对和这两个参数做出实体转义这意味着有可能造成我们跟踪一下这两个变量其中参数做了过滤这里的正则也就是匹配形如的这类标签这里是可以绕过的比如标签或者是双写绕过这里似乎必须抓包改或者大写绕过第三处与上面一样需要在提交他前端有检测的代码直接写入会被转义漏洞点还是中的用户注册部分利用点就是这个地方没有进行实体转义然后直接访问即可同时这里在测试的时候发现还存在验证码复用的问题漏洞定位到这里的的对于和协议的检测采用的是弱比较类型我们知道这个函数返回的是字符串首次出现的位置假如我们给传值为那经过这个函数返回的肯定就是首次出现的地方就是但由于是弱比较类型故很明显返回的是故会成功赋值给下面的变量接下来看一下哪里调用过这个变量也就是下面的这里将当作了上传的路径函数就是用来上传头像的与上面配合也就形成了我们直接输入如下如果这里的换成了强等于那就没事儿了不过协议过滤也不完整总结总体感觉下来对新手入门来说审计这个是蛮简单的可以说只要扫出来的可以漏洞我认为基本都是可以测出来的我感觉除了上述介绍到的依旧存在其他漏洞感觉审的足够了也就没继续了可以说自己找出来的和看文章提示的开吧对于这种类型的我感觉首先判断出总体功能点在哪防御函数在哪先看防御类函数是否做到了真正的防御然后转到功能点跟着自动化出来的漏洞点去一个个看正向或者逆向追踪变量等等这种无的感觉无脑审都行继续勉励仍有不足参考文章可能是全网最详细的远程调试代码的教程代码审计一条龙思路通过学习代码审计从小众入坑代码审计代码审计学习代码审计代码审计入门篇',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-06-03 17:12:49',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" itemprop="url">PHP代码审计</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>PHP代码审计</span></a></span></div></div><h1 class="post-title" itemprop="name headline">BlueCMS代码审计</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-05-29T09:35:28.000Z" title="发表于 2024-05-29 17:35:28">2024-05-29</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-06-03T09:12:49.344Z" title="更新于 2024-06-03 17:12:49">2024-06-03</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">6.8k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>22分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="BlueCMS代码审计"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/05/29/bluecms-dai-ma-shen-ji/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/05/29/bluecms-dai-ma-shen-ji/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/05/29/bluecms-dai-ma-shen-ji/"><header><a class="post-meta-categories" href="/categories/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" itemprop="url">PHP代码审计</a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" tabindex="-1" itemprop="url">PHP代码审计</a><h1 id="CrawlerTitle" itemprop="name headline">BlueCMS代码审计</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-05-29T09:35:28.000Z" title="发表于 2024-05-29 17:35:28">2024-05-29</time><time itemprop="dateCreated datePublished" datetime="2024-06-03T09:12:49.344Z" title="更新于 2024-06-03 17:12:49">2024-06-03</time></header><h1 id="0x01-环境搭建">0x01 环境搭建</h1>
<p>这里不赘述，网上搜搜都有的，我也把参考文章放到了文末，主要还是细心问题，还是可以搭建成功的（但我却踩了很多坑</p>
<h1 id="0x02-前置知识">0x02 前置知识</h1>
<h2 id="明确目标">明确目标：</h2>
<p>在审计之前，我们首先先确定自己此次审计的目地，一般会有三种情况：</p>
<ul>
<li>为了提升自己的审计经验</li>
<li>项目中为了审计出能进一步利用的漏洞，一般需要getshell、ssrf这种级别的。</li>
<li>为了挖点洞，去换钱或者换cve&amp;cnvd。</li>
</ul>
<blockquote>
<p>如果是为了提升审计经验，应该要去重点关注历史漏洞，并去复现。</p>
<p>如果是为了能审出漏洞，去用作渗透中的进一步利用，那么我觉得，可以重点使用xcheck、Fotify等自动化代码审计，然后关注下面的文件上传、包含、sql注入等等有严重危害的漏洞</p>
<p>如果是为了挖0day，搞证书什么的，那么全方位按步骤过一遍，是不错的选择。</p>
</blockquote>
<h2 id="使用框架">使用框架</h2>
<p>判断是否使用了框架，是蛮重要的，能帮助我们快速定位有用的函数集，筛选不需要去看的代码。</p>
<p>一般来说，我觉得使用了框架的更好审计一点，因为使用了框架的，他的函数集文件（各种方法function）会比较规整，在某些固定文件夹中，清晰可见，当然需要我们先对框架有所了解。</p>
<p>目前比较主流的设计模式是MVC，即多层模型（M）、视图（V）、控制器（C），在此不多赘述，php的主流框架几乎都使用了MVC设计模式。PHP底下的开发框架目前见的比较多的有Laravel，ThinkPHP，yi等。</p>
<h2 id="审计流程">审计流程</h2>
<p>看了一篇文章是这样说的，PHP代码审计过程是：</p>
<p>PHP基础语法巩固-》PHP特性-》各类漏洞挖掘方法-》早期CMS程序代码审计实战-》MVC模式程序代码审计实战。</p>
<p>这位师傅选择的CMS实战依次是这样的：BlueCMS, SeaCMS, DedeCMS, PhpCMS 这 4 个CMS（我认为我也可以采用这个路线）难度逐渐提升。在对这几个系统的代码审计过程中，也能感受到 web 开发技术的发展和趋势，直到PhpCMS，发现已经实现了一个MVC模型的程序。相信完成这步后再审计非 MVC 模式程序的代码就会具有清晰的思路与十足的把握。</p>
<h2 id="bluecms简介">BlueCMS简介</h2>
<p>BlueCMS 是一款应用于地方分类信息的门户系统，本文下载的源码为 BlueCMS v1.6 sp1版，可以追溯到2010年左右了，该系统确实很老，但审计该系统有一个好处是，即使现在web开发技术十分成熟了，但仍有人因为经验缺乏或时间原因会开发出类似BlueCMS这样简单的系统，甚至比BlueCMS更简单。通过对 BlueCMS 实战审计，能够熟悉这类简单 CMS 的程序逻辑。</p>
<p>BlueCMS 被认为是练手代码审计的绝佳项目，以至于现在百度BlueCMS的关键词全是代码审计。那为什么 BlueCMS 都被审计烂了，我还要在发一篇BlueCMS的代码审计博客呢？首先BlueCMS确实经典，是一个入门的好项目；其次BlueCMS是无MVC架构时期最早流行的一批CMS，是早期CMS程序代码审计实战系列最标志的第一环。</p>
<p>BlueCMS本地部署好后，先访问 /install/index.php 进行安装，感觉过程有点bug，不过返回首页后会发现安装成功。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657686.png" alt="image-20240529211358964"></p>
<p>按照要求完成之后，访问首页出现上图即可代表安装成功</p>
<h1 id="0x03-前期审计">0x03 前期审计</h1>
<p>这里主要还是跟着文章走，没思路。</p>
<h2 id="入口点分析">入口点分析</h2>
<p>首先分析目录结构</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657687.png" alt="image-20240529211521552"></p>
<p>通过目录结构能够看出简单的程序逻辑，目录结构主要是关注入口点，也就是index.php文件位置，该CMS下的程序，index.php就位于根目录下，这是不安全的，会导致整个文件被窃取的风险。</p>
<p>接下来跟着文章自行分析一边这个入口文件</p>
<pre><code class="hljs php"><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">"IN_BLUE"</span>,<span class="hljs-literal">true</span>);
<span class="hljs-keyword">require_once</span>(<span class="hljs-string">'include/common.inc.php'</span>);
<span class="hljs-keyword">require_once</span>(BLUE_ROOT.<span class="hljs-string">'include/index.fun.php'</span>);</code></pre>
<p>首先定义了常量，然后包含了两个文件，至于做什么先不用管，然后这里调用了do_task函数，参数里面是一个update_info，跟进去发现就是一个更新任务的意思</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657688.png" alt="image-20240529212253545"></p>
<p>大概意思就是动态包含php文件</p>
<p>中间部分逻辑相同，无非就是调用函数，获取当前数据库信息，比如新闻列表，分类信息、推荐信息之类的。然后就是通过下面这一部分代码，渲染到前端页面上，这里可以看到采用的是smarty模板引擎渲染</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657689.png" alt="image-20240529213352376"></p>
<p>这里也就知道了，index.php这个所谓的入口文件，只是单纯的做一个前端页面显示的工作。这里那篇文章说到：这里可以判断出前台是一个多入口的模式，注意多入口的系统需要对每个入口文件单独做出安全过滤，他们都会加载同一个文件来实现，再这个CMS上就是common.inc.php</p>
<p>然后跟进/include/common.inc.php文件，前面的部分依旧是定义常量，包含某些文件</p>
<pre><code class="hljs php"><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">get_magic_quotes_gpc</span>())
{
    <span class="hljs-variable">$_POST</span> = <span class="hljs-title function_ invoke__">deep_addslashes</span>(<span class="hljs-variable">$_POST</span>);
    <span class="hljs-variable">$_GET</span> = <span class="hljs-title function_ invoke__">deep_addslashes</span>(<span class="hljs-variable">$_GET</span>);
    <span class="hljs-variable">$_COOKIES</span> = <span class="hljs-title function_ invoke__">deep_addslashes</span>(<span class="hljs-variable">$_COOKIES</span>);
    <span class="hljs-variable">$_REQUEST</span> = <span class="hljs-title function_ invoke__">deep_addslashes</span>(<span class="hljs-variable">$_REQUEST</span>);
}</code></pre>
<p>然后判断，如果没有开启GPC的话，就调用deep_addslashes函数转义这些参数的内容，但是没有过滤$_SERVER过滤，然后就是$db参数在这里充当连接数据库的作用</p>
<p>下面这里是引入了smarty对象</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657690.png" alt="image-20240529214400110"></p>
<p>同时还有对用户IP的处理，达到某些条件，将会🈲IP</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657691.png" alt="image-20240529214438219"></p>
<p>最后就是关于一些cookie以及session会话的处理了，先不关注，这里回到最初，看一下那个过滤函数的内容，毕竟有过滤，那如果能绕过，就有造成漏洞的可能</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657692.png" alt="image-20240529214720162"></p>
<p>如上图，函数先判读参数是否是数组，如果是的话，递归调用本函数，直到不是数组，然后调用PHP自带的函数addslashes进行特殊字符的转移</p>
<p>接下来可以再关注数据库连接的内容：当前目录的mysql.class.php，内容大致如下</p>
<pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">mysql</span> </span>{

	<span class="hljs-keyword">var</span> <span class="hljs-variable">$linkid</span>=<span class="hljs-literal">null</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$dbhost</span>, <span class="hljs-variable">$dbuser</span>, <span class="hljs-variable">$dbpw</span>, <span class="hljs-variable">$dbname</span> = <span class="hljs-string">''</span>, <span class="hljs-variable">$dbcharset</span> = <span class="hljs-string">'gbk'</span>, <span class="hljs-variable">$connect</span> = <span class="hljs-number">1</span></span>) </span>{
    	<span class="hljs-variable language_">$this</span> -&gt; <span class="hljs-title function_ invoke__">mysql</span>(<span class="hljs-variable">$dbhost</span>, <span class="hljs-variable">$dbuser</span>, <span class="hljs-variable">$dbpw</span>, <span class="hljs-variable">$dbname</span>, <span class="hljs-variable">$dbcharset</span>, <span class="hljs-variable">$connect</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mysql</span>(<span class="hljs-params"><span class="hljs-variable">$dbhost</span>, <span class="hljs-variable">$dbuser</span>, <span class="hljs-variable">$dbpw</span>, <span class="hljs-variable">$dbname</span> = <span class="hljs-string">''</span>, <span class="hljs-variable">$dbcharset</span> = <span class="hljs-string">'gbk'</span>, <span class="hljs-variable">$connect</span>=<span class="hljs-number">1</span></span>)</span>{
    	<span class="hljs-variable">$func</span> = <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$connect</span>) ? <span class="hljs-string">'mysql_pconnect'</span> : <span class="hljs-string">'mysql_connect'</span>;
    	<span class="hljs-keyword">if</span>(!<span class="hljs-variable language_">$this</span>-&gt;linkid = @<span class="hljs-variable">$func</span>(<span class="hljs-variable">$dbhost</span>, <span class="hljs-variable">$dbuser</span>, <span class="hljs-variable">$dbpw</span>, <span class="hljs-literal">true</span>)){
    		<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">dbshow</span>(<span class="hljs-string">'Can not connect to Mysql!'</span>);
    	} <span class="hljs-keyword">else</span> {
    		<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">dbversion</span>() &gt; <span class="hljs-string">'4.1'</span>){
    			<span class="hljs-title function_ invoke__">mysql_query</span>( <span class="hljs-string">"SET NAMES gbk"</span>);
    			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">dbversion</span>() &gt; <span class="hljs-string">'5.0.1'</span>){
    				<span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-string">"SET sql_mode = ''"</span>,<span class="hljs-variable">$this</span>-&gt;linkid);
    			}
    		}
    	}
    	<span class="hljs-keyword">if</span>(<span class="hljs-variable">$dbname</span>){
    		<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">mysql_select_db</span>(<span class="hljs-variable">$dbname</span>, <span class="hljs-variable">$this</span>-&gt;linkid)===<span class="hljs-literal">false</span>){
    			<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">dbshow</span>(<span class="hljs-string">"Can't select MySQL database(<span class="hljs-subst">$dbname</span>)!"</span>);
    		}
    	}
    }</code></pre>
<p>这里可以看到初始化变量，然后调用构造函数，初始化一些信息，并且能看到这里的数据库编码方式为gbk，说不定存在宽字符注入，然后mysql函数中，用mysql_pconnect函数来连接数据库，判断数据库版本信息，然后选择执行对应的语句，剩下没展示的就是一些自定义的sql执行函数</p>
<h2 id="找后台">找后台</h2>
<p>后台一般只有通过身份验证后才能访问，提前就有一层安全保障，但后台程序一般都是漏洞百出，我们很多时候只有靠后台才能拿到服务器的shell。这里具体分析一下BlueCMS的后台逻辑</p>
<p>这里的后台文件，我们看目录不难猜到，有一个/admin/index.php，这里截取部分代码，前面不用说，下面就是判断act参数的值，来对应的展示后台页面</p>
<pre><code class="hljs php"><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">'IN_BLUE'</span>, <span class="hljs-literal">true</span>);

<span class="hljs-keyword">require_once</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>) . <span class="hljs-string">"/include/common.inc.php"</span>);
<span class="hljs-comment">//require_once(dirname(__FILE__). "/include/menu.fun.php");</span>

<span class="hljs-variable">$act</span>=!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">'act'</span>]) ? <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">'act'</span>]) : <span class="hljs-string">''</span>;

<span class="hljs-keyword">if</span>(<span class="hljs-variable">$act</span>==<span class="hljs-string">''</span>)
{
<span class="hljs-variable">$smarty</span>-&gt;<span class="hljs-title function_ invoke__">display</span>(<span class="hljs-string">'index.htm'</span>);
}
<span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$act</span>==<span class="hljs-string">'top'</span>)
{
	<span class="hljs-variable">$smarty</span>-&gt;<span class="hljs-title function_ invoke__">assign</span>(<span class="hljs-string">'admin_name'</span>, <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'admin_name'</span>]);
	<span class="hljs-variable">$smarty</span>-&gt;<span class="hljs-title function_ invoke__">display</span>(<span class="hljs-string">'top.htm'</span>);
}
<span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$act</span>==<span class="hljs-string">'menu'</span>)
{
	<span class="hljs-variable">$cat_list</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">getall</span>(<span class="hljs-string">"SELECT cat_id, cat_name FROM "</span>.<span class="hljs-title function_ invoke__">table</span>(<span class="hljs-string">'category'</span>).<span class="hljs-string">" WHERE parentid=0 ORDER BY show_order,cat_id"</span>);
	<span class="hljs-variable">$arc_cat_list</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">getall</span>(<span class="hljs-string">"SELECT cat_id, cat_name FROM "</span>.<span class="hljs-title function_ invoke__">table</span>(<span class="hljs-string">'arc_cat'</span>).<span class="hljs-string">" WHERE parent_id=0 ORDER BY show_order, cat_id"</span>);
	<span class="hljs-title function_ invoke__">template_assign</span>(<span class="hljs-keyword">array</span>(<span class="hljs-string">'cat_list'</span>, <span class="hljs-string">'arc_cat_list'</span>), <span class="hljs-keyword">array</span>(<span class="hljs-variable">$cat_list</span>, <span class="hljs-variable">$arc_cat_list</span>));
	<span class="hljs-comment">/*if($_SESSION['admin_purview'][0] != 'all'){</span>
<span class="hljs-comment">		if(!file_exists(BLUE_ROOT.DATA.'admin/menu'.$_SESSION['admin_id'].'.html')){</span>
<span class="hljs-comment">			create_menu($_SESSION['admin_id']);</span>
<span class="hljs-comment">		}</span>
<span class="hljs-comment">		//read_menu($_SESSION['admin_id']);</span>
<span class="hljs-comment">		$smarty-&gt;display(BLUE_ROOT.'data/admin/menu2.html');</span>
<span class="hljs-comment">	}else{*/</span>
		<span class="hljs-variable">$smarty</span>-&gt;<span class="hljs-title function_ invoke__">display</span>(<span class="hljs-string">'menu.htm'</span>);
	<span class="hljs-comment">//}</span>
}
<span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$act</span> == <span class="hljs-string">'main'</span>)
{</code></pre>
<p>这里文章说到：关注 index.htm 可以知道后台是通过frame来实现的，这样后台程序的所有功能都可以依附在index.php下实现，在早期的CMS中，基本都是这种实现方案</p>
<pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span> <span class="hljs-string">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/1999/xhtml"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Content-Type"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"text/html; charset=gb2312"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>BlueCMS管理中心<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">frameset</span> <span class="hljs-attr">rows</span>=<span class="hljs-string">"76,*"</span> <span class="hljs-attr">frameborder</span>=<span class="hljs-string">"no"</span> <span class="hljs-attr">border</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">framespacing</span>=<span class="hljs-string">"0"</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">frame</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"index.php?act=top"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"topFrame"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"topFrame"</span> <span class="hljs-attr">scrolling</span>=<span class="hljs-string">"no"</span> <span class="hljs-attr">noresize</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">frameset</span> <span class="hljs-attr">cols</span>=<span class="hljs-string">"176,*"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"bodyFrame"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bodyFrame"</span> <span class="hljs-attr">frameborder</span>=<span class="hljs-string">"no"</span> <span class="hljs-attr">border</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">framespacing</span>=<span class="hljs-string">"0"</span>  &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">frame</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"index.php?act=menu"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"menuFrame"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"menuFrame"</span> <span class="hljs-attr">scrolling</span>=<span class="hljs-string">"yes"</span> <span class="hljs-attr">noresize</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">frame</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"index.php?act=main"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"mainFrame"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"mainFrame"</span> <span class="hljs-attr">scrolling</span>=<span class="hljs-string">"auto"</span> <span class="hljs-attr">noresize</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">frameset</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">frameset</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">noframes</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>你的浏览器不支持框架<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">noframes</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre>
<p>这里同时还看到了该页面加载了/admin/include/common.inc.php文件，这个与/include/common.inc.php类似，但不同的是在最后的部分，前者是根据cookie的信息，判断当前管理员的用户名和密码是否存在与数据库中</p>
<blockquote>
<p>这一部分先判断，如果管理员当前处于登陆状态，并且对应的admin_id是存在的，则调用update_admin_info更新当前管理员用户的信息。</p>
<p>如果当前管理员用户的信息是空的，就回去判断对应的cookie信息，如果对应的数据都存在，则调用check_cookie函数，判断该用户的账号密码是否在数据库中，如果该用户是管理员的话，调用update_admin_info更新信息；如果没有设置cookie的信息，就程序自己设置cookie为空，然后跳转到登陆页面。（这里和就防止了未授权，也就是想直接访问index.php的后台页面是不可能的）</p>
</blockquote>
<h1 id="0x04-漏洞审计">0x04 漏洞审计</h1>
<p>目前我的自动话代码审计工具只有个seay，之后了解一下Fotify</p>
<h2 id="前台sql注入">前台sql注入</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657693.png" alt="image-20240529221746370"></p>
<p>直接上一手自动化，如上图看到一个可能的sql注入，我们跟进去看看/ad_js.php（被打击到了，太菜了，很简单，但还是没看出来）</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">'IN_BLUE'</span>, <span class="hljs-literal">true</span>);
<span class="hljs-keyword">require_once</span> <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>) . <span class="hljs-string">'/include/common.inc.php'</span>;

<span class="hljs-variable">$ad_id</span> = !<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'ad_id'</span>]) ? <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'ad_id'</span>]) : <span class="hljs-string">''</span>;
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$ad_id</span>))
{
	<span class="hljs-keyword">echo</span> <span class="hljs-string">'Error!'</span>;
	<span class="hljs-keyword">exit</span>();
}

<span class="hljs-variable">$ad</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">getone</span>(<span class="hljs-string">"SELECT * FROM "</span>.<span class="hljs-title function_ invoke__">table</span>(<span class="hljs-string">'ad'</span>).<span class="hljs-string">" WHERE ad_id ="</span>.<span class="hljs-variable">$ad_id</span>);
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$ad</span>[<span class="hljs-string">'time_set'</span>] == <span class="hljs-number">0</span>)
{
	<span class="hljs-variable">$ad_content</span> = <span class="hljs-variable">$ad</span>[<span class="hljs-string">'content'</span>];
}
<span class="hljs-keyword">else</span>
{
	<span class="hljs-keyword">if</span>(<span class="hljs-variable">$ad</span>[<span class="hljs-string">'end_time'</span>] &lt; <span class="hljs-title function_ invoke__">time</span>())
	{
		<span class="hljs-variable">$ad_content</span> = <span class="hljs-variable">$ad</span>[<span class="hljs-string">'exp_content'</span>];
	}
	<span class="hljs-keyword">else</span>
	{
		<span class="hljs-variable">$ad_content</span> = <span class="hljs-variable">$ad</span>[<span class="hljs-string">'content'</span>];
	}
}
<span class="hljs-variable">$ad_content</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'"'</span>, <span class="hljs-string">'\"'</span>,<span class="hljs-variable">$ad_content</span>);
<span class="hljs-variable">$ad_content</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">"\r"</span>, <span class="hljs-string">"\\r"</span>,<span class="hljs-variable">$ad_content</span>);
<span class="hljs-variable">$ad_content</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">"\n"</span>, <span class="hljs-string">"\\n"</span>,<span class="hljs-variable">$ad_content</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;!--\r\ndocument.write(\""</span>.<span class="hljs-variable">$ad_content</span>.<span class="hljs-string">"\");\r\n--&gt;\r\n"</span>;

<span class="hljs-meta">?&gt;</span></code></pre>
<p>可以看到这里先是加载了/include/common.inc.php文件，我们知道其中存在着addslashes函数的对特数字符的过滤，然后判断ad_id参数是否存在，如果为空，则赋值为空，不为空，则经过trim函数的处理（也就是去除字符串首位空字符，没啥用），如果为空，则首页然后error后退出。不是空的话，就连接数据库进行语句的查询，中间部分没啥用，到最后就是对回显的内容进行处理，对其中的换行符、双引号之类的进行转移，防止被当成特殊字符对待。</p>
<p>这里重点看sql查询语句<code>$ad = $db-&gt;getone("SELECT * FROM ".table('ad')." WHERE ad_id =".$ad_id);</code></p>
<p>tips：当时尴尬了，以为是双引号闭合的，没发现只是单纯的字符串拼接，同时对ad_id没啥过滤（除了addslashes），这样就能知道就是单纯的数字型注入，我们看一下数据库对应的ad表</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657694.png" alt="image-20240529223422628"></p>
<p>可以看到有7列，那我们直接联合注入即可，这里为了方便，我就将源代码的，对html注释部分取消了，让其直接回显到页面（懒~）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657696.png" alt="image-20240529224619157"></p>
<p>这里看到回显位是7，根据数据库的内容，我们一步到位拿到管理员密码，MD5解密一下就是123</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657697.png" alt="image-20240529225222940"></p>
<h2 id="_server绕过">$_SERVER绕过</h2>
<p>我们知道在上面提到的函数中common.inc.php并没有对$_SERVER做出过滤，我们可以通过这个传入外部数据造成漏洞，接下来可以看一下，这个在哪里被调用过</p>
<p>马后炮的话，就是顺着那片文章的思路，我们尝试倒着找一次，因为没有对$_SERVER做出限制，我们可以全局搜索$_SERVER的使用情况</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657698.png" alt="image-20240530002814774"></p>
<p>如上图，能够看到有很多地方都是用到了，在我看了文章以及自身的思考之后，发现，对于这种情况，我们不必盲目的尝试，我认为可以都先看一遍，重点关注其中参数可控的，比如举几个与漏洞无关的例子</p>
<p>这里是获取UA头的，明显可控</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657699.png" alt="image-20240530002931916"></p>
<p>这里一个是获取addr访问者IP的，还有一个是software也就是web服务</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657700.png" alt="image-20240530003019862"></p>
<p>就这样一个个看过去，最后可以看到我们此次的漏洞点。如下图，这里明显是对于IP是可控的（bp抓包修改即可）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657701.png" alt="image-20240530003135962"></p>
<p>但是当我们找到这种类似的情况，又该如何利用，那就是看该值赋给了哪个参数，比如我们的漏洞点这里，赋值给了ip变量，而这个变量又在getip函数中，我们可以看一下，谁调用了这个函数</p>
<h3 id="insert注入1">Insert注入1</h3>
<p>如下图，这里能看到有两个地方调用过</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657702.png" alt="image-20240530003336994"></p>
<p>先看第一个，可以看到这里直接调用getip函数来获取IP，然后insert语句插入到数据库中，我们往上看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657703.png" alt="image-20240530020924513"></p>
<p>往上看的原因是，我们需要找到该语句是否有回显的地方，否则，即使有注入点，看不到也没办法（不过突然想到时间盲注似乎可以不必在乎）</p>
<p>这里它通过comment.htm进行渲染，很明显只显示发送评论的内容，那我们需要想办法将sql注入语句插入到上面的content地方，才能让其有回显</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657704.png" alt="image-20240530021146341"></p>
<p>这里的其他参数就不赘述了，我们翻看就能知道，只有当act参数为send，参数id存在的时候才行，或者直接在下面的地方，输入内容，点击评论抓包也可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657705.png" alt="image-20240530021339004"></p>
<p>这里我也是搜了几个注入的方式，但不行，最终找了几篇文章才知道的（我知道了我当时出不来的原因就是脑子太死，用的不灵活，那个sql语句完全不适用于这个地方，不会变通）</p>
<p>因为这里对是通过$_SERVER[‘REMOTE_ADDR’]获取的IP，我们直接伪造xff头或者client-ip即可，同时有个知识点：</p>
<pre><code class="hljs scss">insert语句的话，我们可以insert into <span class="hljs-selector-tag">table</span> (a,b,c) values (‘fuck1′,’fuck2′,’fuck3′),(‘fuck4′,’fuck5′,’fuck6′)……这样可以多插几个的。</code></pre>
<p>因此payload如下图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657706.png" alt="image-20240530021623117"></p>
<pre><code class="hljs scss">Client-IP: <span class="hljs-number">1</span><span class="hljs-string">','</span><span class="hljs-number">1</span><span class="hljs-string">'),('</span><span class="hljs-string">', '</span><span class="hljs-number">1</span><span class="hljs-string">', '</span><span class="hljs-number">0</span><span class="hljs-string">', '</span><span class="hljs-number">0</span><span class="hljs-string">', '</span><span class="hljs-number">0</span><span class="hljs-string">',(select concat(admin_name,0x3a,pwd) from blue_admin limit 0,1),'</span><span class="hljs-number">1645457407</span><span class="hljs-string">','</span>sss<span class="hljs-string">','</span><span class="hljs-number">1</span><span class="hljs-string">')#</span></code></pre>
<p>最终查看即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657707.png" alt="image-20240530021658989"></p>
<p>这里我们上面也提过，可以无脑sqlmap跑一下，bp抓包，在xff头上个标记：*，然后sqlmap即可</p>
<pre><code class="hljs scss">python3 sqlmap<span class="hljs-selector-class">.py</span> -r "<span class="hljs-number">1</span><span class="hljs-selector-class">.txt</span>" <span class="hljs-attr">--batch</span> <span class="hljs-attr">--level</span> <span class="hljs-number">4</span> -dbs</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657708.png" alt="image-20240530061857377"></p>
<h3 id="insert注入2">Insert注入2</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657709.png" alt="image-20240530062045695"></p>
<p>来到第二个调用点，我们发现该函数的值被赋值给了一个变量，那就继续追踪这个变量。</p>
<p>如下图，能看到有八个调用点，这里都随便看看就知道，只有guest_book.php，publish.php的地方还有点意思，剩下的虽然有调用点，但是没办法进一步利用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657710.png" alt="image-20240530062219822"></p>
<p>比如publish.php中，这里虽然将online_ip参数值插入了进去，但是并没有页面回显的地方</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657711.png" alt="image-20240530064021119"></p>
<p>但是如下图，我们可以考虑时间盲注，这里也证明是可行的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657712.png" alt="image-20240530065646820"></p>
<p>不过当我采用上述同样的insert注入手法，发现总是抱错，这里不太理解为何</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657713.png" alt="image-20240530072848417"></p>
<h3 id="insert注入3">Insert注入3</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657714.png" alt="image-20240530072940591"></p>
<p>追踪到guest_book.php，发现这是一个留言板的功能，话不多说，直接尝试注入</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657715.png" alt="image-20240530074051542"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657716.png" alt="image-20240530074103221"></p>
<p>这里注入的时候还遇到点问题，就是rid参数的值的问题，如下图，这里如果我们点击了发布成功之后显示给我们的超链接，就会调用act=list这一块函数，这里认为，当rid参数值为0的时候，才会正常的去显示评论页面。</p>
<p>我当时给rid赋值为了1，导致我死活见不到我留言的内容。。。。。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657717.png" alt="image-20240530074031351"></p>
<h2 id="宽字节注入">宽字节注入</h2>
<h3 id="后台万能密码">后台万能密码</h3>
<p>因为我们知道这个数据库选择了GBK编码，那大概率有地方能够利用宽字节注入绕过过滤。我们直接定位到文章所说的地方：/admin/login.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657718.png" alt="image-20240530081902826"></p>
<p>代码逻辑就是，当我们尝试在后台登陆的时候，会跳转到上面这段代码块，首先判断我们输入的用户名和密码是否为空，存在的话，就调用check_admin函数，检查这两个数据在数据库是否存在。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657719.png" alt="image-20240530082011371"></p>
<p>这个函数内部就是常规的查询语句，我们很容易想到万能密码。不过我们知道post传入的数据会被addslashes函数过滤，但因为是GBK编码，所以可以宽字节绕过。如下图，成功登录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657720.png" alt="image-20240530081833757"></p>
<h2 id="编辑会员sql注入">编辑会员sql注入</h2>
<p>这里也是偶然看到的，看文章说这里存在某个宽字节注入，但是没找到，倒是找到了联合注入：/admin/user.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657721.png" alt="image-20240530084250536"></p>
<p>通读一遍代码就知道这里可疑了，没有任何过滤，因为不需要单引号，因此这个addslashes函数的过滤也就没用了，这里是数字型注入</p>
<pre><code class="hljs scss">http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/bluecms/admin/user.php?act=edit&amp;user_id=-<span class="hljs-number">1</span> union select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-built_in">user</span>(),<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,<span class="hljs-built_in">version</span>(),<span class="hljs-built_in">group_concat</span>(pwd),<span class="hljs-number">15</span>,<span class="hljs-number">16</span>,<span class="hljs-number">17</span> from blue_admin%<span class="hljs-number">23</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657722.png" alt="image-20240530085044866"></p>
<h2 id="后台导航sql注入">后台导航sql注入</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657723.png" alt="image-20240531094448701"></p>
<p>根据seay定位到这里，然后直接数字型注入即可</p>
<pre><code class="hljs scss">http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/bluecms/admin/nav.php?act=edit&amp;navid=<span class="hljs-number">1</span> union select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-built_in">user</span>(),<span class="hljs-built_in">version</span>(),<span class="hljs-built_in">group_concat</span>(pwd),<span class="hljs-number">6</span> from blue_admin</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657724.png" alt="image-20240531094436952"></p>
<h2 id="后台属性列表sql注入">后台属性列表sql注入</h2>
<p>这个点也很疑惑，也说明了，我手工注入有点垃圾啊。这个是看的文章了解到的。</p>
<p>首先定位到admin/attachment.php，发现下图位置存在sql注入，因为这里对att_id参数没有任何过滤，我们直接输入即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657725.png" alt="image-20240531114841497"></p>
<p>我开始的payload为：</p>
<pre><code class="hljs scss">http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/bluecms/admin/attachment.php?act=del&amp;att_id=<span class="hljs-built_in">updatexml</span>(<span class="hljs-number">1</span>,<span class="hljs-built_in">concat</span>(<span class="hljs-number">0</span>x7e,<span class="hljs-built_in">database</span>()),<span class="hljs-number">1</span>)</code></pre>
<p>但是页面只说语法错误，但我不理解为何出不来信息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657726.png" alt="image-20240531115502538"></p>
<p>或许又是跟我的环境有关</p>
<p>但当我尝试用sqlmap去跑的时候，发现延时注入是可以使用的，它使用的payload如下：</p>
<pre><code class="hljs scss">att_id=(SELECT <span class="hljs-number">4477</span> FROM (SELECT(SLEEP(<span class="hljs-number">5</span>)))tVeo)</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657727.png" alt="image-20240531115600303"></p>
<p>类似的下面这一个地方，也是跟上述差不多/admin/ad.php</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657728.png" alt="image-20240531120037644"></p>
<h2 id="任意文件读取">任意文件读取</h2>
<p>这里根据文章所说：/admin/tpl_manage.php中存在任意文件读取，我们同时可以结合seay能看到敏感函数的位置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657729.png" alt="image-20240530090323104"></p>
<p>定位到下图，能看到对传入的参数tpl_name没有过滤，这里的blue_root就是根目录，也就是说，我们只需要向上跳两级即可根据各个文件的位置，任意读文件了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657730.png" alt="image-20240530090336820"></p>
<p>如下图：<code>http://127.0.0.1/bluecms/admin/tpl_manage.php?act=edit&amp;tpl_name=../../index.php</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657731.png" alt="image-20240530090227895"></p>
<h2 id="任意文件写入">任意文件写入</h2>
<p>这里当时没注意，直接看了文章的思路了。</p>
<p>我们在刚刚的代码处往下看，就知道</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657732.png" alt="image-20240530091056161"></p>
<p>它将文件输入的内容进行deep_stripslashes的处理了，然后就根据定义的文件路径，写入该文件，我们跟进一下这个函数看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657733.png" alt="image-20240530091143390"></p>
<p>这里无非就是调用PHP自带的stripslashes函数，我们看一下这个函数的作用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657734.png" alt="image-20240530091215391"></p>
<p>这里突然就能联想到，这个CMS对全局的post参数还做了某个过滤，就是addslashes，我们知道这个函数是转移单引号这些字符，而stripslashes恰恰相反，是去除这些转移符号，这相当于没有过滤！！</p>
<p>那我们直接根据代码写入文件即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657735.png" alt="image-20240530091332668"></p>
<p>蚁剑连接也成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657736.png" alt="image-20240530090956158"></p>
<h2 id="任意文件删除">任意文件删除</h2>
<h3 id="第一处">第一处</h3>
<p>这里也是看文章得到的，之前也注意过，不过忽略了（因为某些原因）</p>
<p>首先根据seay代码审计系统，知道在user.php的位置存在unlink函数，可能会有任意文件删除漏洞，我们跟进看看，第一个就是文章所说的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657737.png" alt="image-20240530211805975"></p>
<p>在这里是当act等于这个值的时候，接受一个id参数，然后sql进入数据库查询，之后如果，对应的文件存在的话，就删除，很明显。这里没有对id进行任何过滤，我们直接遍历的话就能删除任意文件，我们可以尝试删除。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657738.png" alt="image-20240530212626869"></p>
<p>可以看到抱错，这里原因在于数据库初始化的时候，并没有conpany_image这个表，导致这里抱错，但如果这个表存在的话，是不会影响后续unlink的执行的，我们不妨注释一下，测试。</p>
<pre><code class="hljs scss">http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/bluecms/user.php?act=del_pic&amp;id=templates/default/shell.php</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657739.png" alt="image-20240530213151815"></p>
<p>如上图，发现删除成功。</p>
<h3 id="第二处">第二处</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657740.png" alt="image-20240530213452813"></p>
<p>我们先创建一个测试文件，然后继续跟踪unlink的调用，到了下面这里</p>
<p>这里的调用是当act=edit_user_info的时候，并且只要face_pic1为空，就到了下面的else代码块，然后我们只需要给face_pic3赋值即可（依旧没有任何过滤）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657741.png" alt="image-20240530213523580"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657742.png" alt="image-20240530213622120"></p>
<p>最终执行，发现文件成功删除</p>
<h3 id="第三处">第三处</h3>
<p>我们继续往上跟踪，可以看到下面这里依旧没有任何过滤，然后调用到这一块代码也很简单，往上走，然后满足各个必要的参数的存在即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657743.png" alt="image-20240530214011771"></p>
<p>payload如下：如图所示，除了文件路径之外，其他参数都是必要的，执行后我们发现成功删除文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657744.png" alt="image-20240530214053781"></p>
<h2 id="任意文件包含">任意文件包含</h2>
<p>这里没有复现成功，感觉是我自身环境的问题吧。我们先看漏洞点</p>
<p>搜寻user.php下的include函数，发现只有下图位置中，存在可控的可能性，只要我们选择act=pay然后，给pay传参进行目录遍历，即可包含任意函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657745.png" alt="image-20240530221837742"></p>
<p>不过需要注意的是，这里后面有index.php的后缀存在，思路一般会有%00截断，或者依靠系统文件路径长度限制</p>
<pre><code class="hljs scss">Windows <span class="hljs-number">259</span>个字节
Linux <span class="hljs-number">4096</span>个字节</code></pre>
<p>因为这里版本5.4.45，那肯定不是00截断，因此会尝试长度截断，这里无非就是这样的payload，后面一堆.来截断，但是我却不能复现出来，猜测是某些环境配置的问题，导致我当前的NTFS文件系统依旧可以处理这样长度的路径。。。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657746.png" alt="image-20240530222058218"></p>
<p>这里如果成功的话，找一下哪里可以上传，配合图片马即可</p>
<p>补充一下，突然发现一篇文章说了类似的问题，他是这样说的：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657747.png" alt="image-20240531120529547"></p>
<p>然后他尝试了5.2.17的版本，然后成功了，但我在复现的时候还是没成功，估计就是环境每搭好，或者是又变化了。下面是它成功的截图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657748.png" alt="image-20240531122816340"></p>
<h2 id="xss漏洞">XSS漏洞</h2>
<h3 id="第一处">第一处</h3>
<p>依旧是在user.php中，找trim函数，跟踪发现如下图的地方，存在可以地方，他对大部分参数只进行了trim的处理，很明显，如果该参数参与了前端的渲染，那么就可以造成存储型xss</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657749.png" alt="image-20240531084351112"></p>
<p>这里测试了一番，发现只有邮件地址这里可以生效</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657750.png" alt="image-20240531084824498"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657751.png" alt="image-20240531083456258"></p>
<h3 id="第二处">第二处</h3>
<p>这一个地方也是刚刚关注了，但是以为过滤的没毛病，我就认为没利用点了。。。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657752.png" alt="image-20240531085012585"></p>
<p>如上图的地方，这里依旧是user.php，然后这里并没有对content和descript这两个参数做出实体转义，这意味着有可能造成xss，我们跟踪一下这两个变量</p>
<p>其中content参数做了过滤，这里的正则也就是匹配形如<code>&lt;script&gt;、&lt;iframe&gt;、&lt;frame&gt;、&lt;meta&gt;</code>的这类标签</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657753.png" alt="image-20240531085117100"></p>
<p>这里是可以绕过的，比如img标签或者是双写绕过（这里似乎必须抓包改）</p>
<pre><code class="hljs scss">&lt;scr&lt;script&gt;ipt&gt;<span class="hljs-built_in">alert</span>(<span class="hljs-number">1</span>)&lt;/scri&lt;script&gt;pt&gt; <span class="hljs-comment">//或者大写绕过</span>
&lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>=<span class="hljs-number">1</span> onerror=<span class="hljs-built_in">alert</span>(<span class="hljs-number">1</span>)&gt;</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657754.png" alt="image-20240531090053979"></p>
<h3 id="第三处">第三处</h3>
<p>与上面一样，需要在bp提交，他前端有检测的代码，直接写入，会被转义</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657755.png" alt="image-20240531091701949"></p>
<p>漏洞点还是user.php中的用户注册部分，利用点就是email这个地方，没有进行实体转义</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657756.png" alt="image-20240531091821800"></p>
<p>然后直接访问user.php即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657757.png" alt="image-20240531091450987"></p>
<p>同时这里在测试的时候，发现还存在验证码复用的问题。</p>
<h2 id="ssrf漏洞">SSRF漏洞</h2>
<p>定位到/user.php，这里的face_pic1的，对于http和https协议的检测，采用的是弱比较类型</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657758.png" alt="image-20240531124041362"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657759.png" alt="image-20240531124127171"></p>
<p>我们知道这个函数strops返回的是，字符串首次出现的位置，假如我们给face_pic传值为<a target="_blank" rel="noopener" href="http://xxx">http://xxx</a>，那经过这个函数，返回的肯定就是0（首次出现的地方就是0），但由于是弱比较类型，故0!=false很明显返回的是false，故会成功赋值给下面的face_pic变量</p>
<p>接下来看一下哪里调用过这个face_pic变量，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657760.png" alt="image-20240531124649117"></p>
<p>也就是下面的这里将face_pic当作了上传的路径，img_upload函数就是用来上传头像的，与上面配合也就形成了ssrf，我们直接输入如下payload</p>
<pre><code class="hljs scss">face_pic1=http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">9999</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202406031657761.png" alt="image-20240531124024399"></p>
<p>如果这里的strops换成了强等于，那就没事儿了，不过协议过滤也不完整。</p>
<h1 id="0x05-总结">0x05 总结</h1>
<p>总体感觉下来，对新手入门来说，审计这个CMS是蛮简单的。可以说只要seay扫出来的可以漏洞，我认为基本都是可以测出来的。</p>
<p>我感觉除了上述介绍到的，依旧存在其他漏洞，感觉审的足够了，也就没继续了。可以说自己找出来的，和看文章提示的，46开吧。对于这种类型的CMS，我感觉首先判断出总体CMS功能点在哪，防御函数在哪，先看防御类函数是否做到了真正的防御，然后转到功能点，跟着自动化出来的漏洞点，去一个个看，正向或者逆向追踪变量等等。</p>
<p>这种无MVC的感觉无脑审都行。继续勉励仍有不足</p>
<h1 id="0x06-参考文章">0x06 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://www.xiebruce.top/1191.html">可能是全网最详细的PhpStorm+xdebug远程调试php代码的教程</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/265092">PHP代码审计一条龙思路</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/284008.html">通过 BlueCMS 学习 php 代码审计</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/196190.html">从小众blueCMS入坑代码审计</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/BOHB-yunying/p/12643510.html">bluecms v1.6 sp1 代码审计学习</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7074?time__1311=n4%2BxnD0GDti%3D0%3DGCDR7Dlhjm5x7TlOo%2BBG7bD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-14">bluecms v1.6 sp1 代码审计</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6946?time__1311=n4%2BxnD0DRDyD9iDcA%2BD%2Fia4TwiKitKorDuYD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-0">PHP代码审计入门篇bluecms</a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/05/29/bluecms-dai-ma-shen-ji/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/05/29/bluecms-dai-ma-shen-ji/')">BlueCMS代码审计</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/05/29/bluecms-dai-ma-shen-ji/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=BlueCMS代码审计&amp;url=http://hybcx.xyz/2024/05/29/bluecms-dai-ma-shen-ji/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>PHP代码审计<span class="tagsPageCount">2</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/05/26/flask-nei-cun-ma-xue-xi/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Flask内存马学习</div></div></a></div><div class="next-post pull-right"><a href="/2024/06/01/ju-zhen-bei/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">矩阵杯</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/06/01/seacms-dai-ma-shen-ji/" title="SeaCMS代码审计"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-01</div><div class="title">SeaCMS代码审计</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">0x01 环境搭建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">2.</span> <span class="toc-text">0x02 前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%8E%E7%A1%AE%E7%9B%AE%E6%A0%87"><span class="toc-number">2.1.</span> <span class="toc-text">明确目标：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%86%E6%9E%B6"><span class="toc-number">2.2.</span> <span class="toc-text">使用框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A1%E8%AE%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">审计流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bluecms%E7%AE%80%E4%BB%8B"><span class="toc-number">2.4.</span> <span class="toc-text">BlueCMS简介</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E5%89%8D%E6%9C%9F%E5%AE%A1%E8%AE%A1"><span class="toc-number">3.</span> <span class="toc-text">0x03 前期审计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E7%82%B9%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">入口点分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%BE%E5%90%8E%E5%8F%B0"><span class="toc-number">3.2.</span> <span class="toc-text">找后台</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E6%BC%8F%E6%B4%9E%E5%AE%A1%E8%AE%A1"><span class="toc-number">4.</span> <span class="toc-text">0x04 漏洞审计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5"><span class="toc-number">4.1.</span> <span class="toc-text">前台sql注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_server%E7%BB%95%E8%BF%87"><span class="toc-number">4.2.</span> <span class="toc-text">$_SERVER绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#insert%E6%B3%A8%E5%85%A51"><span class="toc-number">4.2.1.</span> <span class="toc-text">Insert注入1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#insert%E6%B3%A8%E5%85%A52"><span class="toc-number">4.2.2.</span> <span class="toc-text">Insert注入2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#insert%E6%B3%A8%E5%85%A53"><span class="toc-number">4.2.3.</span> <span class="toc-text">Insert注入3</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%BD%E5%AD%97%E8%8A%82%E6%B3%A8%E5%85%A5"><span class="toc-number">4.3.</span> <span class="toc-text">宽字节注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E4%B8%87%E8%83%BD%E5%AF%86%E7%A0%81"><span class="toc-number">4.3.1.</span> <span class="toc-text">后台万能密码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E4%BC%9A%E5%91%98sql%E6%B3%A8%E5%85%A5"><span class="toc-number">4.4.</span> <span class="toc-text">编辑会员sql注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E5%AF%BC%E8%88%AAsql%E6%B3%A8%E5%85%A5"><span class="toc-number">4.5.</span> <span class="toc-text">后台导航sql注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E5%B1%9E%E6%80%A7%E5%88%97%E8%A1%A8sql%E6%B3%A8%E5%85%A5"><span class="toc-number">4.6.</span> <span class="toc-text">后台属性列表sql注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">4.7.</span> <span class="toc-text">任意文件读取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="toc-number">4.8.</span> <span class="toc-text">任意文件写入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4"><span class="toc-number">4.9.</span> <span class="toc-text">任意文件删除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E5%A4%84"><span class="toc-number">4.9.1.</span> <span class="toc-text">第一处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%A4%84"><span class="toc-number">4.9.2.</span> <span class="toc-text">第二处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E5%A4%84"><span class="toc-number">4.9.3.</span> <span class="toc-text">第三处</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">4.10.</span> <span class="toc-text">任意文件包含</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xss%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.11.</span> <span class="toc-text">XSS漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E5%A4%84"><span class="toc-number">4.11.1.</span> <span class="toc-text">第一处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%A4%84"><span class="toc-number">4.11.2.</span> <span class="toc-text">第二处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E5%A4%84"><span class="toc-number">4.11.3.</span> <span class="toc-text">第三处</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssrf%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.12.</span> <span class="toc-text">SSRF漏洞</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">0x05 总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">6.</span> <span class="toc-text">0x06 参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>