<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>THM-反病毒简介 | hybcx</title><meta name="keywords" content="TryHackMe"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="THM-反病毒简介"><meta name="application-name" content="THM-反病毒简介"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="THM-反病毒简介"><meta property="og:url" content="http://hybcx.xyz/2024/08/01/thm-fan-bing-du-jian-jie/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="了解防病毒软件的工作原理以及使用哪些检测技术来绕过恶意文件检查。 0x01 简介 反病毒(AV-Antivirus)软件是一种基本的基于主机(host-based)的安全解决方案，它可用于检测和防止在终端用户(最终用户)计算机内发生的恶意软件攻击。反病毒软件由不同的模块、功能和检测技术组成，我们将在"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="了解防病毒软件的工作原理以及使用哪些检测技术来绕过恶意文件检查。 0x01 简介 反病毒(AV-Antivirus)软件是一种基本的基于主机(host-based)的安全解决方案，它可用于检测和防止在终端用户(最终用户)计算机内发生的恶意软件攻击。反病毒软件由不同的模块、功能和检测技术组成，我们将在"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/08/01/thm-fan-bing-du-jian-jie/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'THM-反病毒简介',
  postAI: '',
  pageFillDescription: '0x01 简介, 学习目标, 前置学习基础, 0x02 反病毒软件(Antivirus Software), 什么是AV(反病毒)软件, AV软件会寻找什么, AV软件与其他安全产品, AV软件的过去和现在, 0x03 AV(反病毒)功能, 反病毒引擎, 扫描器, 检测技术, 压缩器和归档, PE解析和解包器, 模拟器, 其他常见功能, 0x04 部署与本文相关的实验环境, 0x05 AV(反病毒)静态检测, 静态检测介绍, 创建自己的签名数据库, Yara静态检测规则, 0x06 其他检测技术, 动态检测介绍, 启发式和行为检测介绍, 检测方法总结, 0x07 AV(反病毒)测试和AV指纹识别, AV(反病毒)供应商, AV测试环境, VirusTotal平台, VirusTotal的替代品, AV指纹识别, SharpEDRChecker工具, AV指纹检查脚本(C编写), 0x08 总结了解防病毒软件的工作原理以及使用哪些检测技术来绕过恶意文件检查简介反病毒软件是一种基本的基于主机的安全解决方案它可用于检测和防止在终端用户最终用户计算机内发生的恶意软件攻击反病毒软件由不同的模块功能和检测技术组成我们将在本文内容中进行介绍现代反病毒软件是一个程序或一组程序旨在防止搜索检测和删除软件病毒以及其他恶意软件如蠕虫木马广告软件等作为红队成员或者渗透测试人员熟悉和了解反病毒软件及其检测技术的工作原理至关重要一旦掌握了这些知识我们就可以更好地去尝试研究规避技术学习目标了解什么是反病毒软件了解反病毒所使用的检测方法了解如何枚举目标机器中已安装的反病毒软件在模拟环境中进行测试以便更好地理解本文的相关知识点前置学习基础基于主机的检测解决方案的一般知识企业网络环境红队关于哈希加密的一般知识哈希密码学习有关规则的基础知识恶意样本检测工具学习反病毒软件什么是反病毒软件反病毒软件是额外的安全层旨在检测并防止目标操作系统中恶意文件的执行传播反病毒软件是一个基于主机的应用程序会在后台实时运行以监控和检查当前和最新下载的文件反病毒软件会使用不同的技术来检查并确定某文件是否属于恶意文件我们在下文内容中将简单介绍这些技术有趣的是世界上第一个反病毒软件的设计目的只是为了检测和删除电脑中的计算机病毒如今情况已经得到改变现代反病毒软件既可以检测并删除计算机病毒也可以检测和阻止其他有害文件安全威胁软件会寻找什么传统的反病毒软件会在运行时寻找具有预定义恶意模式或签名的恶意软件所谓恶意软件即有害软件其主要目的是对目标计算机造成损害包括但不限于获得对目标机器的完全访问权限窃取密码等敏感信息加密文件以及导致文件损坏向计算机注入其他恶意软件或者用户不需要的广告利用受感染的机器执行进一步的攻击例如僵尸网络攻击等软件与其他安全产品除了反病毒软件之外其他基于主机的安全解决方案也可为端点设备提供实时保护例如端点检测和响应就是一种安全解决方案它可为主机提供基于行为分析的实时保护端点设备是指网络中连接的最终用户设备或终端设备这些设备通常是组织网络中的最后一站直接由用户使用一些常见的端点设备包括个人计算机移动设备服务器网络设备路由器交换机防火墙反病毒应用程序能够执行扫描检测和删除恶意文件另一方面能够监控目标机器中的各种安全检查包括文件活动内存网络连接注册表进程等现代反病毒产品旨在将传统反病毒功能和其他高级安全功能功能等集成到一款产品中从而提供抵御数字威胁的全面保护有关基于主机的安全解决方案的更多信息建议参考以下内容企业网络环境红队软件的过去和现在迈克菲联合公司在年开始推行了第一个反病毒软件它被称为当时该软件的主要目标是删除感染了电脑的病毒随后其他公司也陆续加入到了与病毒的战斗中早期的反病毒软件被称为扫描器它们是能够搜索文件中的恶意模式的命令行软件如今反病毒软件主要使用图形用户界面来执行恶意文件扫描和其他安全任务并且恶意软件程序的范围也扩大了现在的恶意软件通常以和其他操作系统上的受害者为目标现代反病毒软件支持大多数设备和平台包括和现代反病毒软件的技术也得到了改进变得更加智能和复杂具备一系列安全功能在下一小节中我们将简单介绍一些反病毒功能反病毒功能反病毒引擎反病毒引擎负责查找并删除恶意代码恶意文件良好的反病毒软件能够实现有效且可靠的反病毒核心可以准确迅速地分析恶意文件此外反病毒引擎还能够处理和支持各种文件类型包括归档文件它可以自提取解压缩并检查所有的压缩文件大多数产品具有相同的常见功能但具体的实现方式不同包括但不限于以下功能扫描器检测技术压缩器和归档解包器脱壳器模拟器扫描器大多数反病毒产品都包含扫描器功能软件能够实时或者按需运行以执行扫描此功能可通过或命令行界面被使用用户可以在需要检查文件目录时使用它软件的扫描功能必须支持扫描已知的恶意文件类型这样才能进行有效地检测以及消除安全威胁此外根据反病毒软件的不同该功能还可能支持其他类型的扫描包括漏洞扫描电子邮件扫描内存扫描注册表扫描等检测技术反病毒检测技术能够搜索并检测恶意文件在反病毒引擎中可以使用不同的检测技术包括基于签名的检测这属于传统的反病毒技术会在文件中查找预定义的恶意模式和签名启发式检测它是一种更先进的技术主要是分析可疑文件的各种行为方法动态检测包括监控系统调用和以及在隔离环境中进行测试和分析通过使用上述检测技术良好的反病毒引擎能够准确快速地检测恶意文件并减少误报结果压缩器和归档压缩器和归档功能应该被包含在任何软件中该功能支持检测并能够处理各种系统文件类型包括压缩文件或归档文件等压缩器和归档恶意代码通常会试图通过隐藏在压缩文件中来逃避基于主机的安全解决方案因此在用户打开存档中的文件之前反病毒软件必须解压缩并且扫描所有文件解析和解包器恶意软件可以通过在有效载荷中进行压缩和加密来隐藏并打包其恶意代码这类恶意软件会在运行时自行解压缩和解密从而使得执行静态分析变得更加困难因此反病毒软件必须能够在恶意软件运行时之前就检测并解包脱壳大多数已知的打包加壳程序等从而进行静态分析恶意软件开发人员会使用各种技术例如通过打包加壳来缩小大小并且改变恶意文件的结构打包加壳会压缩原始的可执行文件以使其变得更加难以分析因此反病毒软件必须具有解包脱壳功能将被压缩或受保护的可执行文件解包脱壳为原始代码软件必须具备的另一个功能是充当标头解析器对可执行文件进行解析有助于区分恶意软件和合法软件此处指的是文件的全称为它是一种文件格式代表可移植可执行文件位位中的文件格式包含各种信息和资源例如目标代码图标文件字体文件和核心转储核心转储是指在计算机系统中发生严重错误或程序崩溃时操作系统会将程序的内存内容保存到一个被称为的文件中这个文件包含了程序在崩溃瞬间的内存映像通常以二进制格式存储模拟器模拟器是一种反病毒功能它能够对可疑文件进行进一步分析一旦模拟器收到相关请求就会在虚拟化和受控的环境中运行可疑文件等它会监控可执行文件在执行过程中的行为包括调用注册表调用以及其他文件调用以下是模拟器可能会收集的特征的示例调用内存转储文件系统修改日志事件正在运行的进程请求当收集到足够多的特征来检测恶意软件时模拟器就会停止可疑文件的执行其他常见功能以下是反病毒产品的一些其他常见功能自我保护驱动程序可防止恶意软件去攻击实际的反病毒软件防火墙和网络检查功能命令行和图形界面工具守护进程或服务管理控制台在和类系统中守护进程是指在后台运行的进程通常在系统启动时启动并在系统关闭时终止在操作系统中服务是一个在后台运行的应用程序或进程它提供一种或多种功能可以作为系统服务在系统启动时启动术语和都描述了在计算机系统中以无人值守方式运行的后台进程或服务它们可以执行特定的功能而无需用户直接参与部署与本文相关的实验环境在与本文相关的实验房间中我们将被提供一台虚拟机通过点击按钮完成环境部署之后我们就可以使用浏览器内置页面来访问目标实验虚拟机浏览器页面将类似于下图所示如果浏览器页面没有自动进行拆分我们还可以在相关实验房间页面中点击按钮除了内置的浏览器页面之外我们还可以通过连接并访问目标实验虚拟机但这需要我们先部署或者使用本地机连接到所提供的节点如果想通过进行远程访问时请使用以下凭据进行验证通过客户端连接到反病毒静态检测一般来说反病毒检测可以分为三种主要方法静态检测静态检测侧重于分析文件或程序的静态属性如二进制代码文件结构和特定的标识符它包括了签名检测将可疑文件的签名与已知病毒的签名数据库进行比对以此来识别潜在的恶意软件动态检测动态检测会关注文件或程序的实际执行过程和行为而不仅仅是它们的静态特征启发式和行为检测启发式检测基于经验和启发式规则试图识别可能表明恶意行为的模式或特征它是根据先前的经验和规则进行推断而不仅仅依赖于已知病毒的签名行为检测关注文件或程序的实际行为通过监控系统中的实时活动来检测潜在的异常行为或恶意行为启发式检测和行为检测通常会被结合使用静态检测介绍静态检测技术是最简单的反病毒检测类型它是基于恶意文件的预定义签名来进行检测的简而言之静态检测会在检测时使用模式匹配技术例如查找唯一字符串校验和字节码值序列加密的值等然后再将操作系统内现有文件的签名与软件的签名数据库进行比对如果签名数据库中有现有文件的签名那么软件就会认为与签名关联的文件是恶意的此方法在针对静态恶意软件时非常有效值指的是十六进制值是一种数值表示法使用基数为的数字系统每个十六进制数位对应四个二进制位在计算机领域十六进制经常被用于表示二进制数据因为它更紧凑而且更容易转换为二进制每两个十六进制数字对应一个字节位二进制例如字节的十六进制值对应二进制值在本小节中我们将使用基于签名的检测方法属于静态检测来了解反病毒产品如何检测恶意文件值得注意的是该技术仅适用于检查具有签名数据库中预先生成的签名的已知恶意文件因此相关的静态签名数据库需要时不时进行更新我们会使用反病毒软件来演示基于签名的检测是如何识别恶意文件的软件将预装在为我们提供的实验虚拟机中我们可以通过以下路径来访问它我们还将扫描一些恶意软件样本这些样本可以在实验虚拟机的桌面上找到文件夹将包含以下文件它是一个包含字符串的测试文件仿恶意文件可用于测试软件的有效性它不是可能损坏你的计算机的真正恶意软件如果想了解更多相关信息请访问官方网站它是一个程序使用了众所周知的技术来尝试建立反向连接包括创建进程和执行它是一个程序使用了进程注入和加密技术来尝试建立反向连接包括将注入到现有的正在运行的进程中它是一个程序用于枚举目标计算机中的软件请注意该文件不是恶意的它是一个包含命令行的文本文件请注意该文件不是恶意的软件会自带数据库在安装过程中我们需要下载最近更新的版本我们可以尝试在实验虚拟机中使用二进制文件来扫描文件夹并检查针对这些示例文件的测试情况根据上面的输出结果软件分析了文件夹下的全部文件并对其中两个文件做了相关标记然而软件错误地将文件识别为非恶意的我们可以继续运行命令这将让我们看到在扫描期间加载和使用的所有模块例如使用解包脱壳方法来分离文件并查找预定义的恶意字节码值序列这其实是在检测时所使用的方式实际上中所使用的的字节码值是预先定义并被添加到的数据库中的然而对使用了加密技术这就导致产生了在数据库中找不到的不同字节码值序列因此文件才未被识别为恶意文件能够使用基于签名的技术将测试文件检测为仿恶意文件为了确认这一点我们可以在调试模式下重新扫描一下测试文件在对应输出的某个地方我们将看到以下消息现在让我们生成的值并验证此值是否会与上面的输出消息中的值相匹配为此我们将使用可以看到文件的值与所检测到的值是匹配的创建自己的签名数据库的功能之一就是能够让我们创建自己的数据库这将允许我们包含在官方数据库中找不到的签名项目接下来让我们尝试为我们之前未曾检测成功的文件创建签名并将其添加到一个数据库中以下是我们可以采取的相关执行步骤为文件生成签名将生成的签名添加到扩展名为的数据库中针对相关文件使用我们的新数据库重新进行扫描首先我们将使用套件中的工具上文有提到并通过命令参数来为文件生成对应的哈希值如上述输出所示我们所生成的哈希字符串包含以下结构注意会在扫描过程中使用生成的值进行比较现在我们已经有了的哈希值让我们创建一个自己的数据库我们可以在上述命令后面添加从而将生成的哈希值输出到指定数据库文件中如果指定的数据库文件不存在就会自动进行数据库创建执行上述命令之后我们将会在执行该命令的当前目录中看到一个文件其中包含了我们所生成的哈希值最后我们就可以使用我们所创建的数据库来重新进行扫描并查看对应的扫描结果使用新数据库重新扫描静态检测规则是有助于静态检测的工具之一能够帮助恶意软件工程师更好地分类和检测恶意软件使用的是基于规则的检测因此为了检测新的恶意软件我们需要创建新的规则可以通过处理规则来检测恶意文件此规则与我们在上文提及的签名数据库中的规则类似为了创建规则我们需要先检查和分析可疑软件然后再根据调查结果来编写一条规则接下来我们将以为例来介绍相关过程首先让我们分析并使用工具来列出该二进制文件中的所有人类可读的字符串作为结果我们将看到所有的函数变量以及一些无意义的字符串但是如果我们仔细观察就可以从中找到一些具有唯一性的字符串并能将它们编写到我们的规则中例如文件会使用一个程序数据库其中包含了程序在编译过程中的类型和符号调试信息我们将使用上述命令所输出的路径作为我们将要创建的规则中的唯一字符串示例以下是我们将在检测中使用的规则让我们进一步解释一下上述规则此规则以开头这代表我们的规则名称如果规则匹配的话将使用此名称进行文件标记规则的元数据部分是一般信息包含用户可以填写的作者和描述规则的字符串部分包含我们想要查找到的字符串或字节码在此处我们填写的是程序的数据库路径注意我们在路径中添加了额外的来转义特殊字符这并不会违反规则在规则的条件部分中我们指定条件为能否在要检查的内容中找到我们所定义的字符串如果找到了就会标记相关文件请注意规则必须存储在扩展名为的文件中以便进行处理完成上述操作之后我们就可以使用我们所创建的规则来重新对文件夹进行扫描使用规则扫描如上述结果所示工具将根据我们所提供的规则对二进制文件进行标记然而我们还发现给出了误报结果它对文件也做了标记我们打开文件发现在该文件内容中确实存在我们在规则中所指定的唯一字符串我们需要对上述规则做出改进以减少误报结果为此我们将在规则中指定文件类型通常文件的类型可以使用魔法数字二进制文件的前两个字节来识别例如可执行文件始终以值或者十六进制值作为开头为了确认这一点我们可以使用应用程序一个免费的十六进制编辑器来检查二进制文件并查看该文件的前两个字节应用程序已经预装在实验虚拟机中了解上述信息将有助于我们改进规则以进行更准确的检测以下是改进后的规则在新规则中我们增加了一个内容为的唯一字符串它将作为文件类型的标识符此外我们还更新了规则的条件部分现在的条件是如果在位置处找到了字符串则表明可以开始检查文件如果唯一的字符串数据库路径又出现在我们所找到的二进制文件中在规则的条件部分我们对和中的两个定义使用了运算符这样我们只有在两个定义同时满足的时候才算匹配成功现在我们已经更新了规则我们可以再次进行扫描重新修改后的规则进行扫描如上面的输出所示我们使用改进之后的规则成功地减少了误报结果以上内容是关于反病毒软件如何工作的简单示例在现实世界中反病毒软件供应商也在努力对抗恶意软件并改进其产品和数据库从而提高检测结果的准确性以及提高检测性能基于签名的检测的缺点是如果恶意的二进制文件被修改了那么该文件将具有不同的哈希值并且软件的签名数据库可能不包含该值因此如果攻击者知道反病毒软件会寻找什么以及如何分析二进制文件那么他们就很容易绕过基于签名的检测技术其他检测技术静态检测的概念相对简单在本小节中我们将讨论其他不同类型的检测技术动态检测介绍动态检测方法比静态检测更先进更复杂动态检测更侧重于使用不同的方法在运行时检查文件下图为动态检测的扫描流程第一种动态检测方法是通过监控检测引擎会检查应用程序调用并且会使用监控调用另一种动态检测方法是使用沙箱进行分析沙箱是一种虚拟化环境用于运行与主机分离的恶意文件这种检测方法通常是在隔离环境中完成的主要目标是分析恶意软件在系统中的行为方式一旦恶意文件被成功确认软件将根据相关的二进制文件的特征来创建唯一的签名和规则然后新的签名和规则会被推送到软件的云数据库中以供日后使用使用沙箱的动态检测也有缺点它需要在虚拟环境中执行和运行恶意软件一段有限的时间以保护系统资源与其他检测技术一样恶意软件开发者也可以尝试绕过动态检测恶意软件开发人员可以将软件设置为不在虚拟或模拟环境中运行以尝试避免恶意软件被动态分析例如他们可以在软件的恶意活动开始之前先检查系统是否会生成关于软件执行的真实进程或者让恶意软件在执行之前等待一段时间启发式和行为检测介绍启发式和行为检测在现代反病毒产品中已变得至关重要现代反病毒软件经常依靠这种类型的检测来检测恶意软件启发式分析会使用各种技术包括静态和动态启发式方法静态启发式分析是一个反编译如果可能的话和提取恶意软件源代码的过程并且还会将提取到的源代码与其他众所周知的病毒的源代码进行比较病毒源代码是先前已知的并且会在启发式数据库中预定义如果源代码的匹配程度达到或超过百分比阈值则被提取的源代码将被标记为恶意代码当安全研究人员在隔离和安全的环境中分析可疑软件时他们会标记恶意软件并且会创建行为规则以匹配目标计算机内软件的恶意活动而动态启发式分析正是基于这些预定义的行为规则进行的而关于行为规则的示例则如下所示某个进程在尝试与包含用户哈希票据等信息的进程进行交互某个进程打开了侦听端口并在等待接收来自于命令与控制服务器的命令下图为启发式和行为检测的扫描流程检测方法总结让我们总结一下现代反病毒软件如何作为一个单元包括所有组件工作并如何结合各种功能和检测技术来实现其反病毒引擎以下是关于反病毒引擎的组件示例在上图中我们可以看到可疑的文件被传递给反病毒软件进行扫描软件识别出这是一个压缩文件因此它应用解压缩功能来提取文件这就得到了一个文件接下来软件会识别文件类型以了解要使用哪个模块由于识别到所以它会执行解析操作以提取相关二进制文件的信息和其他特征然后软件还会检查文件是否被加壳如果是则会使用解包器来脱壳最后软件会将收集到的信息和相关的二进制文件继续传递给反病毒引擎反病毒引擎会进行指纹扫描和启发式分析从而检测可疑文件是否为恶意并会给出一个结果反病毒测试和指纹识别反病毒供应商市场上的很多反病毒供应商都主要专注于为家庭或企业用户部署安全产品而现代反病毒软件已经得到改进并且能够将反病毒功能与其他安全功能相结合此处的其他安全功能是指防火墙加密反垃圾邮件端点检测与响应漏洞扫描等值得注意的是我们很难说哪种反病毒软件是最好的这一切都取决于用户的偏好和体验如今反病毒供应商除了关注终端用户安全之外还会关注业务安全如果想了解有关企业供应商的更多信息可以查看以下链接页面的企业供应商列表测试环境测试环境是检查可疑恶意文件的好地方你可以上传文件到测试环境中以进行扫描此外等在线平台也会使用各种检测技术并在很短时间内给出针对可疑文件的检查结果作为红队成员或渗透测试人员我们必须面对多种知名的反病毒应用程序来测试有效载荷从而检查我们所使用的绕过技术规避技术的有效性平台是一个著名的基于的扫描平台可用于检查可疑恶意文件它允许用户上传文件并使用多种反病毒检测引擎进行扫描会将已上传的文件传递给反病毒引擎进行检查然后返回结果并报告文件是否是恶意的会应用很多检查点包括检查列入了黑名单的或服务检查签名进行二进制分析进行行为分析以及检查调用此外二进制文件会被放置在模拟和隔离的环境中运行检查从而获得更好的检测结果如果想了解平台的更多信息并查看此平台的其他功能可以访问的官方网站的替代品是一个很方便的扫描平台具有强大的功能但是它有一个共享策略会把所有的扫描结果与反病毒供应商共享从而改进供应商的产品并更新关于已知恶意软件的数据库作为红队成员我们并不希望使用这种共享策略因为这会让我们在攻防演练中所使用的恶意植入程序和有效载荷失去实战效果除了平台之外我们还可以使用一些没有共享策略的替代解决方案来面向不同的产品进行恶意软件测试当然这可能存在一些限制例如用户每天所能扫描的文件数量有限必须经过付费订阅才能进行无限制的测试等等建议仅在不共享信息的在线网站上测试我们的恶意软件例如每天能进行六次免费扫描指纹识别作为红队成员在我们获得了对目标机器的初始访问权限之后我们可能并不知道目标机上安装了哪些反病毒软件因此查找并识别目标机上安装了哪些基于主机的安全产品包括软件就非常重要指纹识别是确定目标机上存在哪些软件的必要过程了解目标机安装了哪些反病毒软件对于我们创建相同的环境来测试绕过技术规避技术也非常有帮助在此我们将介绍基于静态特征来查看和识别反病毒软件的不同方法这些静态特征包括服务名称进程名称域名注册表项和文件系统下表列出了一些知名且常用的反病毒软件名称服务名称进程名称趋势科技卡巴斯基迈克菲工具对软件进行指纹识别的一种方法是使用这样的公开工具它是用编写的工具可用于在目标计算机上执行各种检查包括检查软件可以检查目标计算机上的文件元数据正在运行的进程已加载的文件注册表项服务目录和文件在为我们提供的实验虚拟机中已经放置好了现在我们需要做的就是编译该项目我们可以在实验虚拟机的桌面上找到相关项目的快捷方式然后双击并在中打开即可如下图所示我们将对项目进行编译编译完成后我们可在的输出部分找到已编译版本的路径此外我们还能在目录下找到已编译版本的副本我们尝试运行一下相关文件并查看对应的结果如上所示根据文件夹和服务能够找到注意程序可能会被软件标记为恶意程序因为它会执行各种检查和调用指纹检查脚本编写枚举软件的另一种方法是编写一个属于我们自己的程序所提供的实验虚拟机中有一个简单的可用于进行指纹检查的程序我们可以在实验虚拟机的桌面上找到该项目的快捷方式然后还可以双击此项目以便使用打开它该程序程序的代码如下所示它的主要目标是根据一个包含了常见的应用程序的预定义列表来确定目标计算机是否安装了一些软件让我们进一步解释一下上述代码我们在数组中预定义了一个包含常见的应用程序的列表然后我们使用查询来列出目标计算机中当前正在运行的所有进程并将它们存储在变量中接下来我们检查当前正在运行的进程并验证它们是否存在于预定义数组中如果成功地找到了匹配项那么就证明目标计算机上已经安装了软件即管理规范命令行上述程序会利用一个对象来列出当前运行的进程而这些进程又可能被反病毒软件监控所以如果反病毒软件在监控查询或者时实现不佳则可能导致软件在扫描上述程序时出现误报结果将上述程序标记为恶意我们可以基于上述代码编译一个版本的程序程序并将其上传到网站然后检查结果如果我们将上述程序上传到网站并检查结果我们会惊讶地发现显示有二个供应商将我们的程序标记为恶意显然这是一个误报结果导致这种结果的原因可能是一些反病毒供应商的软件使用了机器学习分类器或基于规则的检测方法但是实施效果不佳报告链接在检测部分有规则如果执行期间的系统事件匹配在沙箱环境中则认为该文件是恶意的这个结果很可能是基于规则的由于进程重影技术而标记了我们的程序如下面的屏幕截图所示查看相关报告的部分我们可以看到关于程序对注册表项模块和查询的所有调用情况如果我们使用重新编译上述程序程序然后再将其上传到网站并查看结果这次我们可以看到多了二个供应商将该程序标记为恶意文件报告链接注意如果你尝试向网站提交可疑文件它可能会给你不同的结果请记住会与反病毒供应商共享检测报告包括误报结果以改进供应商的反病毒检测引擎总结在本文内容中我们简单介绍了反病毒软件及其使用的检测方法我们简单讨论了静态检测技术并展示了开源反病毒软件将如何基于静态分析来检测恶意文件此外我们还展示了如何创建自己的数据库以及使用规则来检查基于官方数据库而未能成功检测的恶意文件一旦我们获得了对于目标机器的初始访问权限我们就需要在执行进一步操作例如权限提升或横向移动之前枚举目标计算机这样做的目的之一就是为了不触发可疑活动警报不然就可能导致我们失去对于目标计算机的初始访问权限为此我们还简单介绍了一些用于进行指纹识别的方法例如使用公开的工具或者编写属于自己的识别脚本作为红队成员了解反病毒软件的工作原理以及其如何检测恶意应用程序非常重要因为这能够帮助我们更好地实施绕过技术规避技术',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-08-05 21:05:27',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/TryHackMe/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>TryHackMe</span></a></span></div></div><h1 class="post-title" itemprop="name headline">THM-反病毒简介</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-08-01T08:10:33.000Z" title="发表于 2024-08-01 16:10:33">2024-08-01</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-08-05T13:05:27.162Z" title="更新于 2024-08-05 21:05:27">2024-08-05</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">10.8k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>35分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="THM-反病毒简介"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/08/01/thm-fan-bing-du-jian-jie/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/08/01/thm-fan-bing-du-jian-jie/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/08/01/thm-fan-bing-du-jian-jie/"><header><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a><a href="/tags/TryHackMe/" tabindex="-1" itemprop="url">TryHackMe</a><h1 id="CrawlerTitle" itemprop="name headline">THM-反病毒简介</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-08-01T08:10:33.000Z" title="发表于 2024-08-01 16:10:33">2024-08-01</time><time itemprop="dateCreated datePublished" datetime="2024-08-05T13:05:27.162Z" title="更新于 2024-08-05 21:05:27">2024-08-05</time></header><p>了解防病毒软件的工作原理以及使用哪些检测技术来绕过恶意文件检查。</p>
<h1 id="0x01-简介">0x01 简介</h1>
<p>反病毒(AV-Antivirus)软件是一种基本的基于主机(host-based)的安全解决方案，它可用于检测和防止在终端用户(最终用户)计算机内发生的恶意软件攻击。反病毒软件由不同的模块、功能和检测技术组成，我们将在本文内容中进行介绍。</p>
<p>tips：现代反病毒软件是一个程序或一组程序，旨在防止、搜索、检测和删除软件病毒以及其他恶意软件(如蠕虫、木马、广告软件等)。</p>
<p>作为红队成员或者渗透测试人员，熟悉和了解反病毒(AV)软件及其检测技术的工作原理至关重要，一旦掌握了这些知识，我们就可以更好地去尝试研究AV规避技术。</p>
<h3 id="学习目标"><strong>学习目标</strong></h3>
<ul>
<li>了解什么是反病毒(AV-Antivirus)软件？</li>
<li>了解反病毒(AV)所使用的检测方法；</li>
<li>了解如何枚举目标机器中已安装的反病毒(AV)软件；</li>
<li>在模拟环境中进行测试，以便更好地理解本文的相关知识点。</li>
</ul>
<h3 id="前置学习基础"><strong>前置学习基础</strong></h3>
<ul>
<li>基于主机的检测解决方案的一般知识：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/17378401.html">【THM】The Lay of the Land(企业网络环境)-红队</a></li>
<li>关于哈希加密的一般知识：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/16735711.html">【THM】Hashing-Crypto 101(哈希-密码)-学习</a></li>
<li>有关Yara规则的基础知识：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/17902549.html">【THM】Yara(恶意样本检测工具)-学习</a></li>
</ul>
<h1 id="0x02-反病毒软件antivirus-software">0x02 反病毒软件(Antivirus Software)</h1>
<h2 id="什么是av反病毒软件">什么是AV(反病毒)软件</h2>
<p>反病毒(AV)软件是额外的安全层，旨在检测并防止目标操作系统中恶意文件的执行、传播。</p>
<p>反病毒软件是一个基于主机的应用程序，会在后台实时运行以监控和检查当前和最新下载的文件。反病毒软件会使用不同的技术来检查并确定某文件是否属于恶意文件，我们在下文内容中将简单介绍这些技术。</p>
<p>有趣的是，世界上第一个反病毒软件的设计目的只是为了检测和删除电脑中的计算机病毒；如今，情况已经得到改变，现代反病毒软件既可以检测并删除计算机病毒也可以检测和阻止其他有害文件、安全威胁。</p>
<h2 id="av软件会寻找什么">AV软件会寻找什么</h2>
<p>传统的反病毒软件会在运行时寻找具有预定义恶意模式或签名的恶意软件，所谓恶意软件即有害软件，其主要目的是对目标计算机造成损害，包括但不限于：</p>
<ul>
<li>获得对目标机器的完全访问权限。</li>
<li>窃取密码等敏感信息。</li>
<li>加密文件以及导致文件损坏。</li>
<li>向计算机注入其他恶意软件或者用户不需要的广告。</li>
<li>利用受感染的机器执行进一步的攻击，例如僵尸网络攻击等。</li>
</ul>
<h2 id="av软件与其他安全产品">AV软件与其他安全产品</h2>
<p>除了反病毒软件之外，其他基于主机的安全解决方案也可为端点设备提供实时保护，例如端点检测和响应(EDR)就是一种安全解决方案，它可为主机提供基于行为分析的实时保护。</p>
<p>tips：端点设备是指网络中连接的最终用户设备或终端设备，这些设备通常是组织网络中的最后一站，直接由用户使用；一些常见的端点设备包括个人计算机、移动设备、服务器、网络设备(路由器、交换机、防火墙)。</p>
<p>反病毒应用程序能够执行扫描、检测和删除恶意文件，另一方面，EDR能够监控目标机器中的各种安全检查，包括文件活动、内存、网络连接、Windows注册表、进程等。</p>
<p>现代反病毒产品旨在将传统反病毒功能和其他高级安全功能(EDR功能等)集成到一款产品中，从而提供抵御数字威胁的全面保护。</p>
<p>有关基于主机的安全解决方案的更多信息，建议参考以下内容：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/17378401.html">【THM】The Lay of the Land(企业网络环境)-红队</a></p>
<h2 id="av软件的过去和现在">AV软件的过去和现在</h2>
<p>迈克菲联合公司(McAfee Associates, Inc)在1987年开始推行了第一个AV(反病毒)软件，它被称为VirusScan。当时该软件的主要目标是删除感染了John McAfee电脑的"Brain" 病毒，随后，其他公司也陆续加入到了与病毒的战斗中。早期的反病毒软件被称为扫描器，它们是能够搜索文件中的恶意模式的命令行软件。</p>
<p>如今，反病毒软件主要使用图形用户界面(GUI)来执行恶意文件扫描和其他安全任务，并且恶意软件/程序的范围也扩大了，现在的恶意软件通常以Windows和其他操作系统上的受害者为目标。</p>
<p>现代AV(反病毒)软件支持大多数设备和平台，包括Windows、Linux、macOS、Android和iOS；现代反病毒软件的技术也得到了改进，变得更加智能和复杂，具备一系列安全功能。</p>
<p>在下一小节中，我们将简单介绍一些反病毒功能。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103643.png" alt></p>
<h1 id="0x03-av反病毒功能">0x03 AV(反病毒)功能</h1>
<h2 id="反病毒引擎">反病毒引擎</h2>
<p>反病毒引擎负责查找并删除恶意代码、恶意文件，良好的反病毒软件能够实现有效且可靠的反病毒核心，可以准确迅速地分析恶意文件；此外，反病毒引擎还能够处理和支持各种文件类型(包括归档文件)，它可以自提取(解压缩)并检查所有的压缩文件。</p>
<p>大多数AV产品具有相同的常见功能(但具体的实现方式不同)，包括但不限于以下功能：</p>
<ul>
<li>Scanner 扫描器</li>
<li>Detection techniques 检测技术</li>
<li>Compressors and Archives 压缩器和归档</li>
<li>Unpackers 解包器(脱壳器)</li>
<li>Emulators 模拟器</li>
</ul>
<h2 id="扫描器">扫描器</h2>
<p>大多数AV(反病毒)产品都包含扫描器功能：AV软件能够实时或者按需运行以执行扫描。此功能可通过GUI或命令行界面被使用，用户可以在需要检查文件、目录时使用它。</p>
<p>AV软件的扫描功能必须支持扫描已知的恶意文件类型，这样才能进行有效地检测以及消除安全威胁；此外，根据反病毒软件的不同，该功能还可能支持其他类型的扫描，包括漏洞扫描、电子邮件扫描、Windows内存扫描、Windows注册表扫描等。</p>
<h2 id="检测技术">检测技术</h2>
<p>AV(反病毒)检测技术能够搜索并检测恶意文件，在AV(反病毒)引擎中可以使用不同的检测技术，包括：</p>
<ul>
<li>基于签名的检测：这属于传统的反病毒技术，会在文件中查找预定义的恶意模式和签名。</li>
<li>启发式检测：它是一种更先进的技术，主要是分析可疑文件的各种行为方法。</li>
<li>动态检测：包括监控系统调用和APIs，以及在隔离环境中进行测试和分析。</li>
</ul>
<p>通过使用上述检测技术，良好的反病毒引擎能够准确、快速地检测恶意文件，并减少误报结果。</p>
<h2 id="压缩器和归档">压缩器和归档</h2>
<p>压缩器和归档功能应该被包含在任何AV软件中，该功能支持检测并能够处理各种系统文件类型，包括压缩文件或归档文件：ZIP、TGZ、7z、XAR、RAR等。</p>
<p>tips:Compressors and Archives-压缩器和归档。</p>
<p>恶意代码通常会试图通过隐藏在压缩文件中来逃避基于主机的安全解决方案，因此，在用户打开存档中的文件之前，反病毒软件必须解压缩并且扫描所有文件。</p>
<h2 id="pe解析和解包器">PE解析和解包器</h2>
<p>恶意软件可以通过在有效载荷(payload)中进行压缩和加密，来隐藏并打包其恶意代码。这类恶意软件会在运行时自行解压缩和解密，从而使得执行静态分析变得更加困难；因此，反病毒软件必须能够在恶意软件运行时之前就检测并解包(脱壳)大多数已知的打包/加壳程序(UPX、Armadillo、ASPack等)从而进行静态分析。</p>
<p>恶意软件开发人员会使用各种技术，例如通过打包(加壳)来缩小大小并且改变恶意文件的结构。打包(加壳)会压缩原始的可执行文件以使其变得更加难以分析，因此反病毒软件必须具有解包(脱壳)功能，将被压缩或受保护的可执行文件解包(脱壳)为原始代码。</p>
<p>AV软件必须具备的另一个功能是充当Windows PE标头解析器，对可执行文件进行PE解析有助于区分恶意软件和合法软件(此处指的是.exe文件)。</p>
<p>tips：PE的全称为Portable Executable，它是一种文件格式，代表可移植可执行文件。</p>
<p>Windows(32位、64位)中的PE文件格式包含各种信息和资源，例如目标代码、DLLs、图标文件、字体文件和核心转储。</p>
<p>tips：“核心转储” 是指在计算机系统中发生严重错误或程序崩溃时，操作系统会将程序的内存内容保存到一个被称为"core dump"的文件中，这个文件包含了程序在崩溃瞬间的内存映像，通常以二进制格式存储。</p>
<h2 id="模拟器">模拟器</h2>
<p>模拟器是一种反病毒功能，它能够对可疑文件进行进一步分析。一旦模拟器收到相关请求，就会在虚拟化和受控的环境中运行可疑文件(exe、DLL、PDF等)，它会监控可执行文件在执行过程中的行为，包括Windows APIs调用、注册表调用以及其他Windows文件调用。</p>
<p>以下是模拟器可能会收集的特征的示例：</p>
<ul>
<li>API calls：API调用；</li>
<li>Memory dumps：内存转储；</li>
<li>Filesystem modifications：文件系统修改；</li>
<li>Log events：日志事件；</li>
<li>Running processes：正在运行的进程；</li>
<li>Web requests：Web请求。</li>
</ul>
<p>当收集到足够多的特征来检测恶意软件时，模拟器就会停止可疑文件的执行。</p>
<h2 id="其他常见功能">其他常见功能</h2>
<p>以下是AV(反病毒)产品的一些其他常见功能：</p>
<ul>
<li>自我保护驱动程序，可防止恶意软件去攻击实际的反病毒软件；</li>
<li>防火墙和网络检查功能；</li>
<li>命令行和图形界面工具；</li>
<li>守护进程或服务；</li>
<li>管理控制台。</li>
</ul>
<p>tips：在Unix和类Unix系统中，“daemon-守护进程” 是指在后台运行的进程，通常在系统启动时启动，并在系统关闭时终止；在Windows操作系统中，“service-服务” 是一个在后台运行的应用程序或进程，它提供一种或多种功能，可以作为系统服务在系统启动时启动；术语daemon和service都描述了在计算机系统中以无人值守方式运行的后台进程或服务，它们可以执行特定的功能而无需用户直接参与。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103645.png" alt></p>
<h1 id="0x04-部署与本文相关的实验环境">0x04 部署与本文相关的实验环境</h1>
<p>在与本文相关的Tryhackme实验房间中，我们将被提供一台Windows 10 Pro虚拟机。</p>
<p>通过点击按钮完成环境部署之后，我们就可以使用浏览器内置页面来访问目标实验虚拟机，浏览器页面将类似于下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103646.png" alt></p>
<p>如果浏览器页面没有自动进行拆分，我们还可以在相关实验房间页面中点击"Show Split View" 按钮：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103647.png" alt></p>
<p>除了内置的浏览器页面之外，我们还可以通过RDP连接并访问目标实验虚拟机，但这需要我们先部署AttackBox或者使用本地kali机连接到THM所提供的VPN节点。</p>
<p>如果想通过RDP进行远程访问时，请使用以下凭据进行验证：</p>
<ul>
<li>Machine IP:&nbsp;<code>MACHINE_IP</code></li>
<li>Username:&nbsp;<code>thm</code></li>
<li>Password:&nbsp;<code>TryHackM3</code></li>
</ul>
<pre><code class="hljs scss"><span class="hljs-comment">// 通过 RDP 客户端连接到 VM</span>
user<span class="hljs-keyword">@machine</span>$ xfreerdp /<span class="hljs-attribute">v</span>:MACHINE_IP /<span class="hljs-attribute">u</span>:thm /<span class="hljs-attribute">p</span>:TryHackM3</code></pre>
<h1 id="0x05-av反病毒静态检测">0x05 AV(反病毒)静态检测</h1>
<p>一般来说，AV(反病毒)检测可以分为三种主要方法：</p>
<ol>
<li>
<p>静态检测(Static Detection)：静态检测侧重于分析文件或程序的静态属性，如二进制代码、文件结构和特定的标识符；它包括了签名检测，将可疑文件的签名与已知病毒的签名数据库进行比对，以此来识别潜在的恶意软件。</p>
</li>
<li>
<p>动态检测(Dynamic Detection)：动态检测会关注文件或程序的实际执行过程和行为，而不仅仅是它们的静态特征。</p>
</li>
<li>
<p>启发式和行为检测(Heuristic and Behavioral Detection)：</p>
<ul>
<li>启发式检测：基于经验和启发式规则，试图识别可能表明恶意行为的模式或特征，它是根据先前的经验和规则进行推断，而不仅仅依赖于已知病毒的签名。</li>
<li>行为检测：关注文件或程序的实际行为，通过监控系统中的实时活动，来检测潜在的异常行为或恶意行为。</li>
</ul>
</li>
</ol>
<p>tips：启发式检测和行为检测通常会被结合使用。</p>
<h2 id="静态检测介绍">静态检测介绍</h2>
<p>静态检测技术是最简单的反病毒检测类型，它是基于恶意文件的预定义签名来进行检测的。</p>
<p>简而言之，静态检测会在检测时使用模式匹配技术，例如查找唯一字符串、CRC(校验和)、字节码/Hex值序列、加密的hash值(MD5、SHA1等)，然后再将操作系统内现有文件的签名与AV软件的签名数据库进行比对，如果签名数据库中有现有文件的签名，那么AV软件就会认为与签名关联的文件是恶意的，此方法在针对静态恶意软件时非常有效。</p>
<p>tips："Hex值"指的是十六进制值，是一种数值表示法，使用基数为16的数字系统，每个十六进制数位对应四个二进制位。在计算机领域，十六进制经常被用于表示二进制数据，因为它更紧凑而且更容易转换为二进制；每两个十六进制数字对应一个字节(8位二进制)，例如，字节的十六进制值&nbsp;<code>1A</code>&nbsp;对应二进制值&nbsp;<code>00011010</code>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103648.png" alt></p>
<p>在本小节中，我们将使用基于签名的检测方法(属于静态检测)来了解反病毒产品如何检测恶意文件。值得注意的是，该技术仅适用于检查具有签名数据库中预先生成的签名的已知恶意文件，因此，相关的静态签名数据库需要时不时进行更新。</p>
<p>我们会使用<code>ClamAV</code>反病毒软件来演示基于签名的检测是如何识别恶意文件的，ClamAV软件将预装在THM为我们提供的实验虚拟机中，我们可以通过以下路径来访问它：<code>c:\Program Files\ClamAV\clamscan.exe</code>。我们还将扫描一些恶意软件样本，这些样本可以在实验虚拟机的桌面上找到，"Samples"文件夹将包含以下文件：</p>
<ol>
<li>EICAR，它是一个包含ASCII字符串的测试文件(仿恶意文件)，可用于测试AV软件的有效性，它不是可能损坏你的计算机的真正恶意软件；如果想了解更多相关信息，请访问<a target="_blank" rel="noopener" href="https://www.eicar.org/">EICAR官方网站</a>；</li>
<li>Backdoor 1，它是一个C#程序，使用了众所周知的技术来尝试建立反向连接，包括创建进程和执行Metasploit Framework shellcode。</li>
<li>Backdoor 2，它是一个C#程序，使用了进程注入和加密技术来尝试建立反向连接，包括将Metasploit shellcode注入到现有的正在运行的进程中。</li>
<li>AV-Check，它是一个C#程序，用于枚举目标计算机中的AV软件，请注意，该文件不是恶意的。</li>
<li>notes.txt，它是一个包含命令行的文本文件，请注意，该文件不是恶意的。</li>
</ol>
<p>ClamAV软件会自带数据库，在安装过程中，我们需要下载最近更新的版本。我们可以尝试在实验虚拟机中使用<code>clamscan.exe</code>二进制文件来扫描"Samples"文件夹，并检查ClamAV针对这些示例文件的测试情况。</p>
<pre><code class="hljs scss">c:\&gt;<span class="hljs-string">"c:\Program Files\ClamAV\clamscan.exe"</span> c:\Users\thm\Desktop\Samples
Loading:    <span class="hljs-number">22s</span>, ETA:   <span class="hljs-number">0s</span> [========================&gt;]    <span class="hljs-number">8.61</span>M/<span class="hljs-number">8.61</span>M sigs
Compiling:   <span class="hljs-number">4s</span>, ETA:   <span class="hljs-number">0s</span> [========================&gt;]       <span class="hljs-number">41</span>/<span class="hljs-number">41</span> tasks

C:\Users\thm\Desktop\Samples\AV-Check.exe: OK
C:\Users\thm\Desktop\Samples\backdoor1.exe: Win.Malware.Swrort-<span class="hljs-number">9872015</span>-<span class="hljs-number">0</span> FOUND
C:\Users\thm\Desktop\Samples\backdoor2.exe: OK
C:\Users\thm\Desktop\Samples\eicar.com: Win.Test.EICAR_HDB-<span class="hljs-number">1</span> FOUND
C:\Users\thm\Desktop\Samples\notes.txt: OK</code></pre>
<p>根据上面的输出结果，ClamAV软件分析了Samples文件夹下的全部文件，并对其中两个文件做了相关标记；然而，ClamAV软件错误地将backdoor2文件识别为非恶意的。</p>
<p>我们可以继续运行<code>clamscan.exe --debug &lt;file_to_scan&gt;</code>命令，这将让我们看到在扫描期间加载和使用的所有模块。例如，使用解包(脱壳)方法来分离文件并查找预定义的恶意字节码值序列，这其实是ClamAV在检测backdoor1.exe时所使用的方式。</p>
<p>实际上，backdoor1中所使用的Metasploit shellcode的字节码值，是预先定义并被添加到ClamAV的数据库中的；然而，backdoor2对Metasploit shellcode使用了加密技术 (XOR)，这就导致产生了在ClamAV数据库中找不到的不同字节码值序列，因此backdoor2文件才未被识别为恶意文件。</p>
<p>ClamAV能够使用基于md5签名的技术将EICAR.COM测试文件检测为仿恶意文件，为了确认这一点，我们可以在调试模式下(<code>--debug</code>)重新扫描一下EICAR.COM测试文件，在对应输出的某个地方，我们将看到以下消息：</p>
<pre><code class="hljs scss">LibClamAV debug: FP SIGNATURE: <span class="hljs-number">44</span>d88612fea8a8f36de82e1278abb02f:<span class="hljs-number">68</span>:Win.Test.EICAR_HDB-<span class="hljs-number">1</span>  # Name: eicar.com, Type: CL_TYPE_TEXT_ASCII</code></pre>
<p>现在让我们生成EICAR.COM的md5值，并验证此md5值是否会与上面的输出消息中的md5值相匹配，为此我们将使用<code>sigtool</code></p>
<pre><code class="hljs scss">c:\&gt;<span class="hljs-string">"c:\Program Files\ClamAV\sigtool.exe"</span> --md5 c:\Users\thm\Desktop\Samples\eicar.com
<span class="hljs-number">44</span>d88612fea8a8f36de82e1278abb02f:<span class="hljs-number">68</span>:eicar.com</code></pre>
<p>可以看到，eicar.com文件的md5值与ClamAV所检测到的值是匹配的：<code>44d88612fea8a8f36de82e1278abb02f</code>。</p>
<h2 id="创建自己的签名数据库">创建自己的签名数据库</h2>
<p>ClamAV的功能之一就是能够让我们创建自己的数据库，这将允许我们包含在官方ClamAV数据库中找不到的签名项目。接下来，让我们尝试为我们之前未曾检测成功的Backdoor 2文件创建签名，并将其添加到一个数据库中，以下是我们可以采取的相关执行步骤：</p>
<ol>
<li>为文件生成MD5签名；</li>
<li>将生成的签名添加到扩展名为".hdb"的数据库中；</li>
<li>针对相关文件，使用我们的新数据库重新进行ClamAV扫描。</li>
</ol>
<p>首先，我们将使用ClamAV套件中的<code>sigtool</code>工具(上文有提到)，并通过<code>-md5</code>命令参数来为<code>backdoor2.exe</code>文件生成对应的MD5哈希值。</p>
<pre><code class="hljs scss">C:\Users\thm\Desktop\Samples&gt;<span class="hljs-string">"c:\Program Files\ClamAV\sigtool.exe"</span> --md5 backdoor2.exe
<span class="hljs-number">75047189991</span>b1d119fdb477fef333ceb:<span class="hljs-number">6144</span>:backdoor2.exe</code></pre>
<p>如上述输出所示，我们所生成的哈希字符串包含以下结构：<code>Hash:Size-in-byte:FileName</code>。注意，ClamAV会在扫描过程中使用生成的值进行比较。</p>
<p>现在，我们已经有了backdoor2的MD5哈希值，让我们创建一个自己的数据库，我们可以在上述<code>sigtool</code>命令后面添加<code>&gt; thm.hdb</code>，从而将生成的哈希值输出到指定数据库文件中(如果指定的数据库文件不存在，就会自动进行数据库创建)。</p>
<pre><code class="hljs scss">C:\Users\thm\Desktop\Samples&gt;<span class="hljs-string">"c:\Program Files\ClamAV\sigtool.exe"</span> --md5 backdoor2.exe &gt; thm.hdb</code></pre>
<p>执行上述命令之后，我们将会在执行该命令的当前目录中看到一个<code>thm.hdb</code>文件，其中包含了我们所生成的md5哈希值。</p>
<p>最后，我们就可以使用我们所创建的数据库<code>thm.hdb</code>来重新进行ClamAV扫描，并查看对应的扫描结果：</p>
<pre><code class="hljs scss">#使用新数据库重新扫描backdoor2<span class="hljs-selector-class">.exe</span> C:\Users\thm\Desktop\Samples&gt;<span class="hljs-string">"c:\Program Files\ClamAV\clamscan.exe"</span> -d thm.hdb backdoor2.exe Loading: <span class="hljs-number">0s</span>, ETA: <span class="hljs-number">0s</span> [========================&gt;] <span class="hljs-number">1</span>/<span class="hljs-number">1</span> sigs Compiling: <span class="hljs-number">0s</span>, ETA: <span class="hljs-number">0s</span> [========================&gt;] <span class="hljs-number">10</span>/<span class="hljs-number">10</span> tasks C:\Users\thm\Desktop\Samples\backdoor2.exe: backdoor2.exe.UNOFFICIAL FOUND</code></pre>
<h2 id="yara静态检测规则">Yara静态检测规则</h2>
<p><a target="_blank" rel="noopener" href="http://virustotal.github.io/yara/">Yara</a>是有助于静态检测的工具之一，Yara能够帮助恶意软件工程师更好地分类和检测恶意软件。</p>
<p>Yara使用的是基于规则的检测，因此为了检测新的恶意软件，我们需要创建新的规则。ClamAV可以通过处理Yara规则来检测恶意文件，此规则与我们在上文提及的签名数据库中的规则类似。</p>
<p>为了创建规则，我们需要先检查和分析可疑软件，然后再根据调查结果来编写一条规则，接下来我们将以AV-Check.exe为例来介绍相关过程。</p>
<p>首先，让我们分析AV-Check.exe并使用strings工具来列出该二进制文件中的所有人类可读的字符串，作为结果，我们将看到所有的函数、变量以及一些无意义的字符串；但是，如果我们仔细观察，就可以从中找到一些具有唯一性的字符串并能将它们编写到我们的规则中。例如，AV-Check文件会使用一个程序数据库(.pdb)，其中包含了程序在编译过程中的类型和符号调试信息。</p>
<pre><code class="hljs scss">C:\Users\thm\Desktop\Samples&gt;strings AV-Check.exe | findstr pdb
C:\Users\thm\source\repos\AV-Check\AV-Check\obj\Debug\AV-Check.pdb</code></pre>
<p>我们将使用上述命令所输出的路径作为我们将要创建的Yara规则中的唯一字符串示例，以下是我们将在检测中使用的Yara规则：</p>
<pre><code class="hljs scss">rule thm_demo_rule {
	meta:
		author = <span class="hljs-string">"THM: Intro-to-AV-Room"</span>
		description = <span class="hljs-string">"Look at how the Yara rule works with ClamAV"</span>
	strings:
		<span class="hljs-variable">$a</span> = <span class="hljs-string">"C:\\Users\\thm\\source\\repos\\AV-Check\\AV-Check\\obj\\Debug\\AV-Check.pdb"</span>
	condition:
		<span class="hljs-variable">$a</span>
}</code></pre>
<p>让我们进一步解释一下上述Yara规则：</p>
<ul>
<li>此规则以<code>rule thm_demo_rule</code>开头，这代表我们的规则名称，如果规则匹配的话，ClamAV将使用此名称进行文件标记。</li>
<li>规则的元(meta)数据部分是一般信息，包含用户可以填写的作者和描述。</li>
<li>规则的字符串(strings)部分包含我们想要查找到的字符串或字节码，在此处，我们填写的是<code>C#</code>程序的数据库路径；注意，我们在路径中添加了额外的&nbsp;<code>\</code>来转义特殊字符，这并不会违反规则。</li>
<li>在规则的条件(condition)部分中，我们指定条件为——能否在要检查的内容中找到我们所定义的字符串，如果找到了就会标记相关文件。</li>
</ul>
<p>请注意，Yara规则必须存储在扩展名为<code>.yara</code>的文件中，以便ClamAV进行处理。</p>
<p>完成上述操作之后，我们就可以使用我们所创建的Yara规则来重新对<code>c:\Users\thm\Desktop\Samples</code>文件夹进行ClamAV扫描：</p>
<pre><code class="hljs scss">#使用 Yara 规则扫描 C:\Users\thm&gt;<span class="hljs-string">"c:\Program Files\ClamAV\clamscan.exe"</span> -d Desktop\Files\thm-demo-<span class="hljs-number">1</span>.yara Desktop\Samples Loading: <span class="hljs-number">0s</span>, ETA: <span class="hljs-number">0s</span> [========================&gt;] <span class="hljs-number">1</span>/<span class="hljs-number">1</span> sigs Compiling: <span class="hljs-number">0s</span>, ETA: <span class="hljs-number">0s</span> [========================&gt;] <span class="hljs-number">40</span>/<span class="hljs-number">40</span> tasks C:\Users\thm\Desktop\Samples\AV-Check.exe: YARA.thm_demo_rule.UNOFFICIAL FOUND C:\Users\thm\Desktop\Samples\backdoor1.exe: OK C:\Users\thm\Desktop\Samples\backdoor2.exe: OK C:\Users\thm\Desktop\Samples\eicar.com: OK C:\Users\thm\Desktop\Samples\notes.txt: YARA.thm_demo_rule.UNOFFICIAL FOUND</code></pre>
<p>如上述结果所示，ClamAV工具将根据我们所提供的Yara规则对AV-Check.exe二进制文件进行标记，然而，我们还发现ClamAV给出了误报结果，它对notes.txt文件也做了标记。我们打开notes.txt文件，发现在该文件内容中确实存在我们在Yara规则中所指定的唯一字符串。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103649.png" alt></p>
<p>我们需要对上述Yara规则做出改进以减少误报结果，为此我们将在规则中指定文件类型。通常，文件的类型可以使用魔法数字(二进制文件的前两个字节)来识别，例如，<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/DOS_MZ_executable">可执行文件</a>(.exe)始终以ASCII值"MZ"或者十六进制值"4D 5A"作为开头。</p>
<p>为了确认这一点，我们可以使用<a target="_blank" rel="noopener" href="https://mh-nexus.de/en/hxd/">HxD</a>应用程序(一个免费的十六进制编辑器)来检查AV-Check.exe二进制文件并查看该文件的前两个字节。</p>
<p>tips:HxD应用程序已经预装在实验虚拟机中。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103650.png" alt></p>
<p>了解上述信息将有助于我们改进Yara规则以进行更准确的检测，以下是改进后的Yara规则：</p>
<pre><code class="hljs scss">rule thm_demo_rule {
	meta:
		author = <span class="hljs-string">"THM: Intro-to-AV-Room"</span>
		description = <span class="hljs-string">"Look at how the Yara rule works with ClamAV"</span>
	strings:
		<span class="hljs-variable">$a</span> = <span class="hljs-string">"C:\\Users\\thm\\source\\repos\\AV-Check\\AV-Check\\obj\\Debug\\AV-Check.pdb"</span>
		<span class="hljs-variable">$b</span> = <span class="hljs-string">"MZ"</span>
	condition:
		<span class="hljs-variable">$b</span> at <span class="hljs-number">0</span> and <span class="hljs-variable">$a</span>
}</code></pre>
<p>在新Yara规则中，我们增加了一个内容为"MZ"的唯一字符串$b，它将作为.exe文件类型的标识符，此外我们还更新了规则的condition(条件)部分，现在的条件是：</p>
<ol>
<li>如果在位置 0 处找到了字符串"MZ"，则表明可以开始检查文件；</li>
<li>如果唯一的字符串(<code>C#</code>数据库路径)又出现在我们所找到的二进制文件中；</li>
<li>在规则的条件(condition)部分，我们对1和2中的两个定义使用了AND运算符，这样我们只有在两个定义同时满足的时候才算匹配成功。</li>
</ol>
<p>现在我们已经更新了Yara规则，我们可以再次进行ClamAV扫描：</p>
<pre><code class="hljs scss">#重新修改后的Yara规则进行ClamAV扫描 C:\Users\thm&gt;<span class="hljs-string">"c:\Program Files\ClamAV\clamscan.exe"</span> -d Desktop\Files\thm-demo-<span class="hljs-number">2</span>.yara Desktop\Samples Loading: <span class="hljs-number">0s</span>, ETA: <span class="hljs-number">0s</span> [========================&gt;] <span class="hljs-number">1</span>/<span class="hljs-number">1</span> sigs Compiling: <span class="hljs-number">0s</span>, ETA: <span class="hljs-number">0s</span> [========================&gt;] <span class="hljs-number">40</span>/<span class="hljs-number">40</span> tasks C:\Users\thm\Desktop\Samples\AV-Check.exe: YARA.thm_demo_rule.UNOFFICIAL FOUND C:\Users\thm\Desktop\Samples\backdoor1.exe: OK C:\Users\thm\Desktop\Samples\backdoor2.exe: OK C:\Users\thm\Desktop\Samples\eicar.com: OK C:\Users\thm\Desktop\Samples\notes.txt: OK</code></pre>
<p>如上面的输出所示，我们使用改进之后的Yara规则成功地减少了误报结果。</p>
<p>以上内容是关于反病毒软件如何工作的简单示例，在现实世界中，反病毒软件供应商也在努力对抗恶意软件并改进其产品和数据库，从而提高检测结果的准确性以及提高检测性能。</p>
<p>基于签名的检测的缺点是：如果恶意的二进制文件被修改了，那么该文件将具有不同的哈希值，并且AV软件的签名数据库可能不包含该值。因此，如果攻击者知道反病毒软件会寻找什么以及如何分析二进制文件，那么他们就很容易绕过基于签名的检测技术。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103651.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103652.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103653.png" alt></p>
<h1 id="0x06-其他检测技术">0x06 其他检测技术</h1>
<p>静态检测的概念相对简单，在本小节中，我们将讨论其他不同类型的检测技术。</p>
<h2 id="动态检测介绍">动态检测介绍</h2>
<p>动态(Dynamic)检测方法比静态检测更先进、更复杂。动态检测更侧重于使用不同的方法在运行时检查文件，下图为动态检测的扫描流程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103654.png" alt></p>
<p>第一种动态检测方法是通过监控Windows APIs。检测引擎会检查Windows应用程序调用，并且会使用Windows&nbsp;<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/winmsg/about-hooks">Hooks</a>监控Windows API调用。</p>
<p>另一种动态检测方法是使用沙箱进行分析，沙箱是一种虚拟化环境，用于运行与主机分离的恶意文件。这种检测方法通常是在隔离环境中完成的，主要目标是分析恶意软件在系统中的行为方式；一旦恶意文件被成功确认，AV软件将根据相关的二进制文件的特征来创建唯一的签名和规则，然后新的签名和规则会被推送到AV软件的云数据库中以供日后使用。</p>
<p>使用沙箱的动态检测也有缺点，它需要在虚拟环境中执行和运行恶意软件一段有限的时间以保护系统资源。与其他AV检测技术一样，恶意软件开发者也可以尝试绕过动态检测。恶意软件开发人员可以将软件设置为不在虚拟或模拟环境中运行，以尝试避免恶意软件被动态分析；例如，他们可以在软件的恶意活动开始之前先检查系统是否会生成关于软件执行的真实进程，或者让恶意软件在执行之前等待一段时间。</p>
<h2 id="启发式和行为检测介绍">启发式和行为检测介绍</h2>
<p>启发式和行为检测在现代AV(反病毒)产品中已变得至关重要，现代反病毒软件经常依靠这种类型的检测来检测恶意软件。</p>
<p>启发式(Heuristic)分析会使用各种技术，包括静态和动态启发式方法：</p>
<ol>
<li>静态启发式分析是一个反编译(如果可能的话)和提取恶意软件源代码的过程，并且还会将提取到的源代码与其他众所周知的病毒的源代码进行比较；病毒源代码是先前已知的，并且会在启发式(Heuristic)数据库中预定义，如果源代码的匹配程度达到或超过百分比阈值，则被提取的源代码将被标记为恶意代码。</li>
<li>当安全研究人员在隔离和安全的环境中分析可疑软件时，他们会标记恶意软件，并且会创建行为规则以匹配目标计算机内软件的恶意活动，而动态启发式分析正是基于这些预定义的行为规则进行的。</li>
</ol>
<p>而关于行为(Behavioral)规则的示例则如下所示：</p>
<ul>
<li>某个进程在尝试与包含用户NTLM哈希、Kerberos票据等信息的LSASS.exe进程进行交互；</li>
<li>某个进程打开了侦听端口并在等待接收来自于C2(命令与控制)服务器的命令。</li>
</ul>
<p>下图为启发式和行为检测的扫描流程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103655.png" alt></p>
<h2 id="检测方法总结">检测方法总结</h2>
<p>让我们总结一下现代反病毒软件如何作为一个单元(包括所有组件)工作，并如何结合各种功能和检测技术来实现其反病毒引擎。以下是关于反病毒引擎的组件示例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103656.png" alt></p>
<p>在上图中，我们可以看到可疑的<code>Foobar.zip</code>文件被传递给反病毒软件进行扫描，AV软件识别出这是一个压缩文件(.zip)，因此它应用解压缩功能来提取文件，这就得到了一个exe文件(<code>Foobar.exe</code>)；接下来，AV软件会识别文件类型以了解要使用哪个模块，由于识别到exe，所以它会执行PE解析操作以提取相关二进制文件的信息和其他特征；然后，AV软件还会检查文件是否被加壳，如果是，则会使用解包器来脱壳；最后AV软件会将收集到的信息和相关的二进制文件继续传递给反病毒引擎，反病毒引擎会进行指纹扫描和启发式分析，从而检测可疑文件是否为恶意并会给出一个结果。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103657.png" alt></p>
<h1 id="0x07-av反病毒测试和av指纹识别">0x07 AV(反病毒)测试和AV指纹识别</h1>
<h2 id="av反病毒供应商">AV(反病毒)供应商</h2>
<p>市场上的很多反病毒(AV)供应商都主要专注于为家庭或企业用户部署安全产品，而现代反病毒软件已经得到改进并且能够将反病毒功能与其他安全功能相结合，此处的其他安全功能是指：防火墙、加密、反垃圾邮件、EDR(端点检测与响应)、漏洞扫描、VPN等。</p>
<p>值得注意的是，我们很难说哪种反病毒软件是最好的，这一切都取决于用户的偏好和体验；如今，AV(反病毒)供应商除了关注终端用户安全之外，还会关注业务安全。如果想了解有关企业AV供应商的更多信息，可以查看以下链接页面的企业AV供应商列表：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.av-comparatives.org/list-of-enterprise-av-vendors-pc/">https://www.av-comparatives.org/list-of-enterprise-av-vendors-pc/</a></p>
</blockquote>
<h2 id="av测试环境">AV测试环境</h2>
<p>AV测试环境是检查可疑/恶意文件的好地方，你可以上传文件到测试环境中以进行扫描；此外，VirusTotal等在线平台也会使用各种检测技术并在很短时间内给出针对可疑文件的检查结果。</p>
<p>作为红队成员或渗透测试人员，我们必须面对多种知名的反病毒应用程序来测试有效载荷，从而检查我们所使用的绕过技术(AV规避技术)的有效性。</p>
<h3 id="virustotal平台">VirusTotal平台</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103658.png" alt></p>
<p>VirusTotal是一个著名的基于Web的扫描平台，可用于检查可疑/恶意文件，它允许用户上传文件并使用70多种反病毒检测引擎进行扫描。VirusTotal会将已上传的文件传递给反病毒引擎进行检查，然后返回结果并报告文件是否是恶意的。</p>
<p>VirusTotal会应用很多检查点，包括检查列入了黑名单的URLs或服务、检查签名、进行二进制分析、进行行为分析以及检查API调用，此外，二进制文件会被放置在模拟和隔离的环境中运行、检查，从而获得更好的检测结果。</p>
<p>如果想了解VirusTotal平台的更多信息并查看此平台的其他功能，可以访问<a target="_blank" rel="noopener" href="https://www.virustotal.com/">VirusTotal的官方网站</a>。</p>
<h3 id="virustotal的替代品">VirusTotal的替代品</h3>
<p>VirusTotal是一个很方便的AV扫描平台，具有强大的功能，但是它有一个共享策略，会把所有的AV扫描结果与反病毒供应商共享，从而改进AV供应商的产品并更新关于已知恶意软件的数据库。作为红队成员，我们并不希望使用这种共享策略，因为这会让我们在攻防演练中所使用的恶意植入程序和有效载荷失去实战效果。</p>
<p>除了VirusTotal平台之外，我们还可以使用一些没有共享策略的替代解决方案来面向不同的AV产品进行恶意软件测试；当然，这可能存在一些限制，例如用户每天所能扫描的文件数量有限，必须经过付费订阅才能进行无限制的测试等等。</p>
<p>建议仅在不共享信息的在线网站上测试我们的恶意软件，例如：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://antiscan.me/">AntiscanMe</a>(每天能进行六次免费AV扫描)；</li>
<li><a target="_blank" rel="noopener" href="https://virusscan.jotti.org/">Virus Scan Jotti’s malware scan</a></li>
</ul>
<h2 id="av指纹识别">AV指纹识别</h2>
<p>作为红队成员，在我们获得了对目标机器的初始访问权限之后，我们可能并不知道目标机上安装了哪些反病毒软件；因此，查找并识别目标机上安装了哪些基于主机的安全产品(包括AV软件)就非常重要。</p>
<p>AV指纹识别是确定目标机上存在哪些AV软件的必要过程，了解目标机安装了哪些反病毒软件对于我们创建相同的环境来测试绕过技术(AV规避技术)也非常有帮助。</p>
<p>在此，我们将介绍基于静态特征来查看和识别反病毒软件的不同方法，这些静态特征包括服务名称、进程名称、域名、注册表项(registry keys)和文件系统。</p>
<p>下表列出了一些知名且常用的反病毒(AV)软件：</p>
<table>
<thead>
<tr>
<th>AV名称</th>
<th>服务名称</th>
<th>进程名称</th>
</tr>
</thead>
<tbody>
<tr>
<td>Microsoft Defender</td>
<td>WinDefend</td>
<td>MSMpEng.exe</td>
</tr>
<tr>
<td>Trend Micro(趋势科技)</td>
<td>TMBMSRV</td>
<td>TMBMSRV.exe</td>
</tr>
<tr>
<td>Avira</td>
<td>AntivirService, Avira.ServiceHost</td>
<td>avguard.exe, Avira.ServiceHost.exe</td>
</tr>
<tr>
<td>Bitdefender</td>
<td>VSSERV</td>
<td>bdagent.exe, vsserv.exe</td>
</tr>
<tr>
<td>Kaspersky(卡巴斯基)</td>
<td>AVP&lt;Version #&gt;</td>
<td>avp.exe, ksde.exe</td>
</tr>
<tr>
<td>AVG</td>
<td>AVG Antivirus</td>
<td>AVGSvc.exe</td>
</tr>
<tr>
<td>Norton</td>
<td>Norton Security</td>
<td>NortonSecurity.exe</td>
</tr>
<tr>
<td>McAfee(迈克菲)</td>
<td>McAPExe, Mfemms</td>
<td>MCAPExe.exe, mfemms.exe</td>
</tr>
<tr>
<td>Panda</td>
<td>PavPrSvr</td>
<td>PavPrSvr.exe</td>
</tr>
<tr>
<td>Avast</td>
<td>Avast Antivirus</td>
<td>afwServ.exe, AvastSvc.exe</td>
</tr>
</tbody>
</table>
<h3 id="sharpedrchecker工具">SharpEDRChecker工具</h3>
<p>对AV软件进行指纹识别的一种方法是使用<a target="_blank" rel="noopener" href="https://github.com/PwnDexter/SharpEDRChecker">SharpEDRChecker</a>这样的公开工具，它是用C#编写的工具，可用于在目标计算机上执行各种检查，包括检查AV软件。</p>
<p>tips：SharpEDRChecker可以检查目标计算机上的文件元数据、正在运行的进程、已加载的DLL文件、注册表项、服务、目录和文件。</p>
<p>在THM为我们提供的实验虚拟机中已经放置好了SharpEDRChecker，现在我们需要做的就是编译该项目，我们可以在实验虚拟机的桌面上找到相关项目的快捷方式，然后双击并在Microsoft Visual Studio 2022中打开即可。如下图所示，我们将对SharpEDRChecker项目进行编译。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103659.png" alt></p>
<p>编译完成后，我们可在Visual Studio的输出部分找到已编译版本的路径(此外我们还能在<code>C:\Users\thm\Desktop\Files</code>目录下找到已编译版本的副本)，我们尝试运行一下相关exe文件，并查看对应的结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103660.png" alt></p>
<pre><code class="hljs scss">C:\&gt; SharpEDRChecker.exe

[!] Directory Summary:
   [-] C:\Program Files\Windows Defender : defender
   [-] C:\Program Files\Windows Defender Advanced Threat Protection : defender, threat
   [-] C:\Program Files (x86)\Windows Defender : defender

[!] Service Summary:
   [-] PsShutdownSvc : sysinternal
   [-] Sense : defender, threat
   [-] WdNisSvc : defender, nissrv
   [-] WinDefend : antimalware, defender, malware, msmpeng
   [-] wscsvc : antivirus</code></pre>
<p>如上所示，根据文件夹和服务能够找到Windows Defender。</p>
<p>注意：SharpEDRChecker程序可能会被AV软件标记为恶意程序，因为它会执行各种检查和API调用。</p>
<h3 id="av指纹检查脚本c编写">AV指纹检查脚本(C#编写)</h3>
<p>枚举AV软件的另一种方法是编写一个属于我们自己的程序，THM所提供的实验虚拟机中有一个简单的、可用于进行AV指纹检查的C#程序，我们可以在实验虚拟机的桌面上找到该项目(AV-Check)的快捷方式，然后还可以双击此项目以便使用Microsoft Visual Studio 2022打开它。</p>
<p>该C#程序(AV-Check程序)的代码如下所示，它的主要目标是根据一个包含了常见的AV应用程序的预定义列表来确定目标计算机是否安装了一些AV软件：</p>
<pre><code class="hljs c#"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Management;

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
    {
        <span class="hljs-keyword">var</span> status = <span class="hljs-literal">false</span>;
        Console.WriteLine(<span class="hljs-string">"[+] Antivirus check is running .. "</span>);
        <span class="hljs-built_in">string</span>[] AV_Check = { 
            <span class="hljs-string">"MsMpEng.exe"</span>, <span class="hljs-string">"AdAwareService.exe"</span>, <span class="hljs-string">"afwServ.exe"</span>, <span class="hljs-string">"avguard.exe"</span>, <span class="hljs-string">"AVGSvc.exe"</span>, 
            <span class="hljs-string">"bdagent.exe"</span>, <span class="hljs-string">"BullGuardCore.exe"</span>, <span class="hljs-string">"ekrn.exe"</span>, <span class="hljs-string">"fshoster32.exe"</span>, <span class="hljs-string">"GDScan.exe"</span>, 
            <span class="hljs-string">"avp.exe"</span>, <span class="hljs-string">"K7CrvSvc.exe"</span>, <span class="hljs-string">"McAPExe.exe"</span>, <span class="hljs-string">"NortonSecurity.exe"</span>, <span class="hljs-string">"PavFnSvr.exe"</span>, 
            <span class="hljs-string">"SavService.exe"</span>, <span class="hljs-string">"EnterpriseService.exe"</span>, <span class="hljs-string">"WRSA.exe"</span>, <span class="hljs-string">"ZAPrivacyService.exe"</span> 
        };
        <span class="hljs-keyword">var</span> searcher = <span class="hljs-keyword">new</span> ManagementObjectSearcher(<span class="hljs-string">"select * from win32_process"</span>);
        <span class="hljs-keyword">var</span> processList = searcher.Get();
        <span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> process <span class="hljs-keyword">in</span> processList)
        {
            <span class="hljs-built_in">int</span> _index = Array.IndexOf(AV_Check, process[<span class="hljs-string">"Name"</span>].ToString());
            <span class="hljs-keyword">if</span> (_index &gt; <span class="hljs-number">-1</span>)
            {
                Console.WriteLine(<span class="hljs-string">"--AV Found: {0}"</span>, process[<span class="hljs-string">"Name"</span>].ToString());
                status = <span class="hljs-literal">true</span>;
            }
            i++;
        }
        <span class="hljs-keyword">if</span> (!status) { Console.WriteLine(<span class="hljs-string">"--AV software is not found!"</span>);  }
    }
}</code></pre>
<p>让我们进一步解释一下上述代码：</p>
<p>我们在<code>AV_Check</code>数组中预定义了一个包含常见的AV应用程序的列表，然后，我们使用WMIC查询(<code>select * from win32_process</code>)来列出目标计算机中当前正在运行的所有进程，并将它们存储在<code>processList</code>变量中，接下来，我们检查当前正在运行的进程并验证它们是否存在于预定义数组中，如果成功地找到了匹配项，那么就证明目标计算机上已经安装了AV软件。</p>
<p>tips：WMIC，即“Windows管理规范命令行”(Windows Management Instrumentation Command-Line)。</p>
<p>上述C#程序会利用一个WMIC对象来列出当前运行的进程，而这些进程又可能被反病毒软件监控，所以如果反病毒软件在监控WMIC查询或者Windows API时实现不佳，则可能导致AV软件在扫描上述C#程序时出现误报结果(将上述C#程序标记为恶意)。</p>
<p>我们可以基于上述代码编译一个x86版本的C#程序(AV-Check程序)，并将其上传到VirusTotal网站，然后检查结果。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103661.png" alt></p>
<p>如果我们将上述AV-Check程序上传到VirusTotal网站并检查结果，我们会惊讶地发现VirusTotal显示有二个AV供应商将我们的C#程序标记为恶意，显然这是一个误报结果。导致这种结果的原因可能是一些反病毒供应商的软件使用了机器学习分类器或基于规则的检测方法，但是实施效果不佳。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103662.png" alt></p>
<p>VirusTotal报告链接：<a target="_blank" rel="noopener" href="https://www.virustotal.com/gui/file/5f7d3e6cf58596a0186d89c20004c76805769f9ef93dc39e346e7331eee9e7ff?nocache=1">https://www.virustotal.com/gui/file/5f7d3e6cf58596a0186d89c20004c76805769f9ef93dc39e346e7331eee9e7ff?nocache=1</a></p>
<p>在“检测”部分，有 Sigma 规则，如果执行期间的系统事件匹配（在沙箱环境中），则认为该文件是恶意的。这个结果很可能是基于规则的； VirusTotal 由于<a target="_blank" rel="noopener" href="https://pentestlaboratories.com/2021/12/08/process-ghosting/">进程重影技术</a>而标记了我们的程序，如下面的屏幕截图所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103663.png" alt></p>
<p>查看相关VirusTotal报告的Behavior部分，我们可以看到关于AV-Check程序对Windows API、注册表项、模块和WMIC查询的所有调用情况。</p>
<p>如果我们使用x64 CPU重新编译上述C#程序(AV-Check程序)，然后再将其上传到VirusTotal网站并查看结果，这次我们可以看到多了二个AV供应商将该程序标记为恶意文件。</p>
<p>VirusTotal报告链接：<a target="_blank" rel="noopener" href="https://www.virustotal.com/gui/file/b092173827888ed62adea0c2bf4f451175898d158608cf7090e668952314e308?nocache=1">https://www.virustotal.com/gui/file/b092173827888ed62adea0c2bf4f451175898d158608cf7090e668952314e308?nocache=1</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052103664.png" alt></p>
<p>注意：如果你尝试向VirusTotal网站提交可疑文件，它可能会给你不同的结果，请记住，VirusTotal会与反病毒供应商共享检测报告(包括误报结果)，以改进AV供应商的反病毒检测引擎。</p>
<h1 id="0x08-总结">0x08 总结</h1>
<p>在本文内容中，我们简单介绍了反病毒(AV)软件及其使用的检测方法。</p>
<p>我们简单讨论了静态检测技术，并展示了开源反病毒软件ClamAV将如何基于静态分析来检测恶意文件，此外，我们还展示了如何创建自己的数据库以及使用Yara规则来检查基于官方数据库而未能成功检测的恶意文件。</p>
<p>一旦我们获得了对于目标机器的初始访问权限，我们就需要在执行进一步操作(例如权限提升或横向移动)之前枚举目标计算机，这样做的目的之一就是为了不触发可疑活动警报，不然就可能导致我们失去对于目标计算机的初始访问权限；为此，我们还简单介绍了一些用于进行AV指纹识别的方法，例如使用公开的工具或者编写属于自己的AV识别脚本。</p>
<p>作为红队成员，了解反病毒(AV)软件的工作原理以及其如何检测恶意应用程序非常重要，因为这能够帮助我们更好地实施绕过技术(AV规避技术)。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/08/01/thm-fan-bing-du-jian-jie/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/08/01/thm-fan-bing-du-jian-jie/')">THM-反病毒简介</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/08/01/thm-fan-bing-du-jian-jie/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=THM-反病毒简介&amp;url=http://hybcx.xyz/2024/08/01/thm-fan-bing-du-jian-jie/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/TryHackMe/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TryHackMe<span class="tagsPageCount">42</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/31/thm-lan-yong-windows-nei-bu-ji-zhi/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM-滥用Windows内部机制</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/01/thm-shellcode-mian-sha/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM-ShellCode免杀</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-08</div><div class="title">THM-ByPass_UAC</div></div></a></div><div><a href="/2024/02/14/thm-basic-pentesting/" title="THM-Basic Pentesting"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-14</div><div class="title">THM-Basic Pentesting</div></div></a></div><div><a href="/2024/07/10/thm-c2-jian-jie/" title="THM-C2简介"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-10</div><div class="title">THM-C2简介</div></div></a></div><div><a href="/2024/06/17/thm-corp/" title="THM-Corp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-17</div><div class="title">THM-Corp</div></div></a></div><div><a href="/2024/06/09/thm-enumerating-active-directory/" title="THM-Enumerating Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-09</div><div class="title">THM-Enumerating Active Directory</div></div></a></div><div><a href="/2024/07/16/thm-enumeration/" title="THM-Enumeration"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">THM-Enumeration</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">0x01 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.0.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80"><span class="toc-number">1.0.2.</span> <span class="toc-text">前置学习基础</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E5%8F%8D%E7%97%85%E6%AF%92%E8%BD%AF%E4%BB%B6antivirus-software"><span class="toc-number">2.</span> <span class="toc-text">0x02 反病毒软件(Antivirus Software)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFav%E5%8F%8D%E7%97%85%E6%AF%92%E8%BD%AF%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text">什么是AV(反病毒)软件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#av%E8%BD%AF%E4%BB%B6%E4%BC%9A%E5%AF%BB%E6%89%BE%E4%BB%80%E4%B9%88"><span class="toc-number">2.2.</span> <span class="toc-text">AV软件会寻找什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#av%E8%BD%AF%E4%BB%B6%E4%B8%8E%E5%85%B6%E4%BB%96%E5%AE%89%E5%85%A8%E4%BA%A7%E5%93%81"><span class="toc-number">2.3.</span> <span class="toc-text">AV软件与其他安全产品</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#av%E8%BD%AF%E4%BB%B6%E7%9A%84%E8%BF%87%E5%8E%BB%E5%92%8C%E7%8E%B0%E5%9C%A8"><span class="toc-number">2.4.</span> <span class="toc-text">AV软件的过去和现在</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-av%E5%8F%8D%E7%97%85%E6%AF%92%E5%8A%9F%E8%83%BD"><span class="toc-number">3.</span> <span class="toc-text">0x03 AV(反病毒)功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E7%97%85%E6%AF%92%E5%BC%95%E6%93%8E"><span class="toc-number">3.1.</span> <span class="toc-text">反病毒引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E5%99%A8"><span class="toc-number">3.2.</span> <span class="toc-text">扫描器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%8A%80%E6%9C%AF"><span class="toc-number">3.3.</span> <span class="toc-text">检测技术</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E5%99%A8%E5%92%8C%E5%BD%92%E6%A1%A3"><span class="toc-number">3.4.</span> <span class="toc-text">压缩器和归档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pe%E8%A7%A3%E6%9E%90%E5%92%8C%E8%A7%A3%E5%8C%85%E5%99%A8"><span class="toc-number">3.5.</span> <span class="toc-text">PE解析和解包器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E5%99%A8"><span class="toc-number">3.6.</span> <span class="toc-text">模拟器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%B8%B8%E8%A7%81%E5%8A%9F%E8%83%BD"><span class="toc-number">3.7.</span> <span class="toc-text">其他常见功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%9C%AC%E6%96%87%E7%9B%B8%E5%85%B3%E7%9A%84%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">4.</span> <span class="toc-text">0x04 部署与本文相关的实验环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-av%E5%8F%8D%E7%97%85%E6%AF%92%E9%9D%99%E6%80%81%E6%A3%80%E6%B5%8B"><span class="toc-number">5.</span> <span class="toc-text">0x05 AV(反病毒)静态检测</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%A3%80%E6%B5%8B%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">静态检测介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E7%AD%BE%E5%90%8D%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">5.2.</span> <span class="toc-text">创建自己的签名数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#yara%E9%9D%99%E6%80%81%E6%A3%80%E6%B5%8B%E8%A7%84%E5%88%99"><span class="toc-number">5.3.</span> <span class="toc-text">Yara静态检测规则</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E5%85%B6%E4%BB%96%E6%A3%80%E6%B5%8B%E6%8A%80%E6%9C%AF"><span class="toc-number">6.</span> <span class="toc-text">0x06 其他检测技术</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%A3%80%E6%B5%8B%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.1.</span> <span class="toc-text">动态检测介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8F%91%E5%BC%8F%E5%92%8C%E8%A1%8C%E4%B8%BA%E6%A3%80%E6%B5%8B%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.2.</span> <span class="toc-text">启发式和行为检测介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93"><span class="toc-number">6.3.</span> <span class="toc-text">检测方法总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-av%E5%8F%8D%E7%97%85%E6%AF%92%E6%B5%8B%E8%AF%95%E5%92%8Cav%E6%8C%87%E7%BA%B9%E8%AF%86%E5%88%AB"><span class="toc-number">7.</span> <span class="toc-text">0x07 AV(反病毒)测试和AV指纹识别</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#av%E5%8F%8D%E7%97%85%E6%AF%92%E4%BE%9B%E5%BA%94%E5%95%86"><span class="toc-number">7.1.</span> <span class="toc-text">AV(反病毒)供应商</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#av%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83"><span class="toc-number">7.2.</span> <span class="toc-text">AV测试环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#virustotal%E5%B9%B3%E5%8F%B0"><span class="toc-number">7.2.1.</span> <span class="toc-text">VirusTotal平台</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virustotal%E7%9A%84%E6%9B%BF%E4%BB%A3%E5%93%81"><span class="toc-number">7.2.2.</span> <span class="toc-text">VirusTotal的替代品</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#av%E6%8C%87%E7%BA%B9%E8%AF%86%E5%88%AB"><span class="toc-number">7.3.</span> <span class="toc-text">AV指纹识别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sharpedrchecker%E5%B7%A5%E5%85%B7"><span class="toc-number">7.3.1.</span> <span class="toc-text">SharpEDRChecker工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#av%E6%8C%87%E7%BA%B9%E6%A3%80%E6%9F%A5%E8%84%9A%E6%9C%ACc%E7%BC%96%E5%86%99"><span class="toc-number">7.3.2.</span> <span class="toc-text">AV指纹检查脚本(C#编写)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-%E6%80%BB%E7%BB%93"><span class="toc-number">8.</span> <span class="toc-text">0x08 总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>