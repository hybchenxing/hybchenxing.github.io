<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>THM-Nmap | hybcx's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline.css"><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/friends/"><span class="navItemTitle">Friends</span></a></li><li class="navItem"><a class="navBlock" href="/about"><span class="navItemTitle">About</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>THM-Nmap</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2024-02-16T09:45:21.092Z" id="date"> 2024-02-16</time></div></span><br><span>Last Update: <div class="control"><time datetime="2024-02-16T12:14:14.173Z" id="updated"> 2024-02-16</time></div></span><br><span>Word Count: <div class="control">6.2k</div></span><br><span>Read Time: <div class="control">22 min</div></span></div></div><hr><div id="post-content"><h1>0x01 简介</h1>
<p>对于黑客来说，知识就是力量。您对目标系统或网络的了解越多，可用的选项就越多。这使得在进行任何利用尝试之前必须进行适当的枚举。</p>
<p>假设我们已获得一个 IP（或多个 IP 地址）来执行安全审核。在我们做任何其他事情之前，我们需要了解我们正在攻击的“景观”。这意味着我们需要确定目标上正在运行哪些服务。</p>
<p>例如，也许其中一个正在运行 Web 服务器，另一个则充当 Windows Active Directory 域控制器。建立景观“地图”的第一个阶段是所谓的端口扫描。当计算机运行网络服务时，它会打开一个称为“端口”的网络结构来接收连接。端口对于发出多个网络请求或提供多个可用服务是必需的。</p>
<p>例如，当您在网络浏览器中同时加载多个网页时，程序必须有某种方法来确定哪个选项卡正在加载哪个网页。这是通过使用本地计算机上的不同端口建立与远程网络服务器的连接来完成的。同样，如果您希望一台服务器能够运行多个服务（例如，您可能希望您的 Web 服务器同时运行该站点的 HTTP 和 HTTPS 版本），那么您需要某种方法将流量引导至适当的服务。端口再次是解决这个问题的方法。网络连接是在两个端口之间建立的 - 一个在服务器上侦听的开放端口和一个在您自己的计算机上随机选择的端口。例如，当您连接到网页时，您的计算机可能会打开端口 49534 以连接到服务器的端口 443。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216175656420.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216175656420.png" alt="image-20240216175656420"></p>
<p>与前面的示例一样，该图显示了当您同时连接到多个网站时会发生什么情况。您的计算机打开一个不同的高编号端口（随机），用于与远程服务器的所有通信。</p>
<p>每台计算机共有65535个可用端口；然而，其中许多已注册为标准端口。例如，HTTP Web 服务几乎总是可以在服务器的端口 80 上找到。 HTTPS Web 服务可以在端口 443 上找到。Windows NETBIOS 可以在端口 139 上找到，SMB 可以在端口 445 上找到。需要注意的是；然而，特别是在 CTF 设置中，即使这些标准端口被更改也并非闻所未闻，这使得我们更有必要对目标执行适当的枚举。</p>
<p>如果我们不知道服务器打开了哪些端口，那么我们就没有成功攻击目标的希望；因此，我们从端口扫描开始任何攻击至关重要。这可以通过多种方式来完成——通常使用名为 nmap 的工具，这是本​​次会议的重点。 Nmap 可用于执行许多不同类型的端口扫描 - 其中最常见的将在接下来的任务中介绍；然而，基本理论是这样的：nmap 将依次连接到目标的每个端口。根据端口的响应方式，可以将其确定为开放、关闭或过滤（通常由防火墙）。一旦我们知道哪些端口是开放的，我们就可以查看每个端口上正在运行的服务——手动，或者更常见的是使用 nmap。</p>
<p>那么，为什么是 nmap？简而言之，它目前成为行业标准是有原因的：没有其他端口扫描工具能够接近其功能（尽管一些新来者现在在速度上与它相匹配）。它是一个非常强大的工具 - 其脚本引擎使其更加强大，可用于扫描漏洞，在某些情况下甚至可以直接执行漏洞利用！再次，这将在接下来的任务中更多地涉及。</p>
<p>现在，了解以下内容很重要：什么是端口扫描；为什么有必要； nmap 是任何类型初始枚举的首选工具。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216180627248.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216180627248.png" alt="image-20240216180627248"></p>
<h1>0x02 Nmap选项</h1>
<p>与大多数渗透测试工具一样，nmap 是从终端运行的。有适用于 Windows 和 Linux 的版本。对于这个房间，我们假设您使用的是 Linux；但是，开关应该是相同的。 Nmap 默认安装在 Kali Linux 和 TryHackMe Attack Box 中。</p>
<p>可以通过在终端命令行中输入 <code>nmap</code> 来访问 Nmap，然后输入我们将在下面介绍的一些“开关”（告诉程序执行不同操作的命令参数）。</p>
<p>为此，您所需要的只是 nmap 的帮助菜单（使用 <code>nmap -h</code> 访问）和/或 nmap 手册页（使用 <code>man nmap</code> 访问）。对于每个答案，除非另有说明，否则请包括开关的所有部分。这包括开头的连字符 ( <code>-</code> )。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216182551471.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216182551471.png" alt="image-20240216182551471"></p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216182606759.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216182606759.png" alt="image-20240216182606759"></p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216182616793.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216182616793.png" alt="image-20240216182616793"></p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216182629146.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216182629146.png" alt="image-20240216182629146"></p>
<h1>0x03 扫描类型概述</h1>
<p>使用Nmap进行端口扫描时，有三种基本扫描类型。这些都是：</p>
<ul>
<li>TCP 连接扫描 ( <code>-sT</code> )</li>
<li>SYN“半开”扫描 ( <code>-sS</code> )</li>
<li>UDP 扫描 ( <code>-sU</code> )</li>
</ul>
<p>此外，还有几种不太常见的端口扫描类型，我们还将介绍其中一些类型（尽管不太详细）。这些都是：</p>
<ul>
<li>TCP 空扫描 ( <code>-sN</code> )</li>
<li>TCP FIN 扫描 ( <code>-sF</code> )</li>
<li>TCP 圣诞节扫描 ( <code>-sX</code> )</li>
</ul>
<p>其中大多数（UDP 扫描除外）的用途非常相似，但是每次扫描的工作方式有所不同。这意味着，虽然在大多数情况下您可能会选择前三种扫描之一，但值得注意的是还存在其他扫描类型。</p>
<p>在网络扫描方面，我们还将简要介绍一下 ICMP（或“ping”）扫描。</p>
<h1>0x04 TCP 扫描</h1>
<p>要了解 TCP 连接扫描 ( <code>-sT</code> )，熟悉 TCP 三向握手非常重要。如果您对这个术语比较陌生，那么建议您先完成网络介绍，然后再继续。</p>
<p>简要回顾一下，三向握手由三个阶段组成。首先，连接终端（在本例中是我们的攻击机器）向目标服务器发送一个设置了 SYN 标志的 TCP 请求。然后，服务器使用包含 SYN 标志以及 ACK 标志的 TCP 响应来确认该数据包。最后，我们的终端通过发送设置了 ACK 标志的 TCP 请求来完成握手。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216182935748.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216182935748.png" alt="image-20240216182935748"></p>
<p>这是 TCP/IP 网络的基本原则之一，但它与 Nmap 有何关系？</p>
<p>顾名思义，TCP Connect 扫描的工作原理是依次与每个目标端口执行三向握手。换句话说，Nmap 尝试连接到每个指定的 TCP 端口，并通过收到的响应来确定服务是否打开。</p>
<p>例如，如果端口关闭，RFC 9293 指出：</p>
<p>“…如果连接不存在（关闭），则将发送重置以响应除另一个重置之外的任何传入分段。通过这种方式拒绝与现有连接不匹配的 SYN 分段。”</p>
<p>换句话说，如果Nmap向关闭的端口发送设置了SYN标志的TCP请求，目标服务器将使用设置了RST（重置）标志的TCP数据包进行响应。通过此响应，Nmap 可以确定端口已关闭。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216183041765.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216183041765.png" alt="image-20240216183041765"></p>
<p>但是，如果请求发送到开放端口，目标将使用设置了 SYN/ACK 标志的 TCP 数据包进行响应。然后，Nmap 将此端口标记为打开（并通过发回设置了 ACK 的 TCP 数据包来完成握手）。</p>
<p>这一切都很好，但是，还有第三种可能性。</p>
<p>如果端口是开放的，但隐藏在防火墙后面怎么办？</p>
<p>许多防火墙配置为简单地丢弃传入数据包。 Nmap 发送 TCP SYN 请求，但没有收到任何回复。这表明该端口受到防火墙保护，因此该端口被视为被过滤。</p>
<p>也就是说，配置防火墙以响应 RST TCP 数据包非常容易。例如，在 Linux 的 IPtables 中，命令的简单版本如下：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">iptables -<span class="hljs-selector-tag">I</span> <span class="hljs-selector-tag">INPUT</span> -<span class="hljs-selector-tag">p</span> tcp <span class="hljs-attr">--dport</span> &lt;port&gt; -j REJECT <span class="hljs-attr">--reject-with</span> tcp-reset<br></code></pre></td></tr></table></figure>
<p>这使得获得目标的准确读数变得极其困难（如果不是不可能的话）。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216183218824.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216183218824.png" alt="image-20240216183218824"></p>
<h1>0x05 SYN 扫描</h1>
<p>与 TCP 扫描一样，SYN 扫描 ( <code>-sS</code> ) 用于扫描一个或多个目标的 TCP 端口范围；然而，这两种扫描类型的工作方式略有不同。 SYN 扫描有时称为“半开放”扫描或“隐形”扫描。Where TCP scans perform a full three-way handshake with the target, SYN scans sends back a RST TCP packet after receiving a SYN/ACK from the server (this prevents the server from repeatedly trying to make the request). In other words, the sequence for scanning an <strong>open</strong> port looks like this:<br>
TCP 扫描与目标执行完整的三向握手，SYN 扫描在从服务器接收到 SYN/ACK 后发回 RST TCP 数据包（这可以防止服务器重复尝试发出请求）。换句话说，扫描开放端口的顺序如下所示：</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216183300156.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216183300156.png" alt="image-20240216183300156"></p>
<p>这对于我们黑客来说有很多好处：</p>
<ul>
<li>它可用于绕过旧的入侵检测系统，因为它们正在寻找完整的三向握手。现代 IDS 解决方案通常不再出现这种情况；正是由于这个原因，SYN 扫描仍然经常被称为“隐形”扫描。</li>
<li>侦听开放端口的应用程序通常不会记录 SYN 扫描，因为标准做法是在完全建立连接后记录连接。这再次体现了 SYN 扫描的隐秘性。</li>
<li>无需费心为每个端口完成（和断开连接）三向握手，SYN 扫描比标准 TCP 连接扫描要快得多。</li>
</ul>
<p>然而，SYN 扫描有一些缺点，即：</p>
<ul>
<li>它们需要 sudo 权限 [1] 才能在 Linux 中正常工作。这是因为 SYN 扫描需要能够创建原始数据包（而不是完整的 TCP 握手），默认情况下只有 root 用户才拥有此权限。</li>
<li>不稳定的服务有时会因 SYN 扫描而中断，如果客户端提供了用于测试的生产环境，这可能会出现问题。</li>
</ul>
<p>总而言之，利大于弊。</p>
<p>因此，如果使用 sudo 权限运行，SYN 扫描是 Nmap 使用的默认扫描。如果在没有 sudo 权限的情况下运行，Nmap 默认进行我们在上一个任务中看到的 TCP 连接扫描。</p>
<p>当使用 SYN 扫描来识别关闭和过滤的端口时，适用与 TCP 连接扫描完全相同的规则。</p>
<p>如果端口关闭，则服务器会使用 RST TCP 数据包进行响应。如果端口被防火墙过滤，则 TCP SYN 数据包将被丢弃，或者通过 TCP 重置进行欺骗。</p>
<p>在这方面，两次扫描是相同的：最大的区别在于它们处理开放端口的方式。</p>
<p>[1] 还可以通过为 Nmap 提供 CAP_NET_RAW、CAP_NET_ADMIN 和 CAP_NET_BIND_SERVICE 功能来使 SYN 扫描发挥作用；但是，这可能无法让许多 NSE 脚本正常运行。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216183522702.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216183522702.png" alt="image-20240216183522702"></p>
<h1>0x06 UDP 扫描</h1>
<p>与 TCP 不同，UDP 连接是无状态的。这意味着，UDP 连接不是通过来回“握手”来启动连接，而是依赖于将数据包发送到目标端口，并本质上希望它们能够成功。这使得 UDP 非常适合依赖速度而不是质量的连接（例如视频共享），但缺乏确认使得 UDP 扫描变得更加困难（并且速度慢得多）。 Nmap UDP 扫描的开关是 ( <code>-sU</code> )</p>
<p>当数据包发送到开放的 UDP 端口时，不应有响应。发生这种情况时，Nmap 将端口称为 <code>open|filtered</code> 。换句话说，它怀疑端口是开放的，但可能被防火墙阻止。如果它收到 UDP 响应（这是非常不寻常的），则该端口被标记为打开。更常见的是没有响应，在这种情况下，会再次发送请求以进行双重检查。如果仍然没有响应，则端口被标记为打开|已过滤并且 Nmap 继续前进。</p>
<p>当数据包发送到关闭的 UDP 端口时，目标应使用 ICMP (ping) 数据包进行响应，其中包含该端口无法访问的消息。这清楚地识别了关闭的端口，Nmap 将其标记为关闭的端口并继续前进。</p>
<p>由于难以识别 UDP 端口是否实际打开，因此与各种 TCP 扫描相比，UDP 扫描往往非常慢（在连接良好的情况下扫描前 1000 个端口大约需要 20 分钟）。因此，在启用 <code>--top-ports &lt;number&gt;</code> 的情况下运行 Nmap 扫描通常是一个好习惯。例如，使用 <code>nmap -sU --top-ports 20 &lt;target&gt;</code> 进行扫描。将扫描前 20 个最常用的 UDP 端口，从而获得更可接受的扫描时间。</p>
<p>当扫描 UDP 端口时，Nmap 通常发送完全空的请求——只是原始的 UDP 数据包。也就是说，对于通常被知名服务占用的端口，它将发送特定于协议的有效负载，该有效负载更有可能引发响应，从而得出更准确的结果。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216184103251.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216184103251.png" alt="image-20240216184103251"></p>
<h1>0x07 NULL、FIN、Xmas扫描</h1>
<p>NULL、FIN 和 Xmas TCP 端口扫描比我们已经介绍过的其他端口扫描不太常用，因此我们不会在这里深入讨论。这三者都是相互关联的，之所以使用，主要是因为相对而言，它们比 SYN“隐形”扫描更加隐蔽。从 NULL 扫描开始：</p>
<ul>
<li>顾名思义，NULL 扫描 ( <code>-sN</code> ) 是指发送 TCP 请求时根本没有设置任何标志。根据 RFC，如果端口关闭，目标主机应使用 RST 进行响应。</li>
</ul>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216184306773.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216184306773.png" alt="image-20240216184306773"></p>
<ul>
<li>FIN 扫描 ( <code>-sF</code> ) 的工作方式几乎相同；但是，不是发送完全空的数据包，而是发送带有 FIN 标志的请求（通常用于正常关闭活动连接）。如果端口关闭，Nmap 再次期望 RST。</li>
</ul>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216184329439.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216184329439.png" alt="image-20240216184329439"></p>
<ul>
<li>与此类中的其他两个扫描一样，Xmas 扫描 ( <code>-sX</code> ) 发送格式错误的 TCP 数据包，并期望关闭端口的 RST 响应。它被称为圣诞扫描，因为当在 Wireshark 中将其视为数据包捕获时，它设置的标志（PSH、URG 和 FIN）使其看起来像一棵闪烁的圣诞树。</li>
</ul>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216184406875.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216184406875.png" alt="image-20240216184406875"></p>
<p>这些扫描对开放端口的预期响应也是相同的，并且与 UDP 扫描的响应非常相似。如果端口打开，则不会对格式错误的数据包做出响应。不幸的是（与开放的 UDP 端口一样），如果端口受防火墙保护，这也是预期的行为，因此 NULL、FIN 和 Xmas 扫描将仅将端口识别为开放|过滤、关闭或过滤。如果某个端口被这些扫描之一识别为已过滤，则通常是因为目标已响应 ICMP 无法到达的数据包。</p>
<p>还值得注意的是，虽然 RFC 793 要求网络主机对关闭端口使用 RST TCP 数据包响应格式错误的数据包，而对开放端口根本不响应；实际情况并非总是如此。特别是，众所周知，Microsoft Windows（以及许多 Cisco 网络设备）会使用 RST 响应任何格式错误的 TCP 数据包 - 无论端口是否实际打开。这会导致所有端口显示为关闭。</p>
<p>也就是说，这里的目标当然是绕过防火墙。许多防火墙配置为将传入的 TCP 数据包丢弃到设置了 SYN 标志的阻止端口（从而阻止新的连接发起请求）。通过发送不包含 SYN 标志的请求，我们可以有效地绕过这种防火墙。虽然这在理论上很好，但大多数现代 IDS 解决方案都熟悉这些扫描类型，因此在处理现代系统时不要依赖它们 100% 有效。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216184836853.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216184836853.png" alt="image-20240216184836853"></p>
<h1>0x08 ICMP 扫描</h1>
<p>在黑盒分配中首次连接到目标网络时，我们的第一个目标是获取网络结构的“地图”，或者换句话说，我们希望查看哪些 IP 地址包含活动主机，哪些不包含活动主机。</p>
<p>实现此目的的一种方法是使用 Nmap 执行所谓的“ping 扫描”。顾名思义，Nmap 向指定网络的每个可能的 IP 地址发送 ICMP 数据包。当它收到响应时，它将响应的 IP 地址标记为活动的。由于我们将在后面的任务中看到的原因，这并不总是准确的；然而，它可以提供一些基线，因此值得讨论。</p>
<p>为了执行 ping 扫描，我们将 <code>-sn</code> 开关与 IP 范围结合使用，可以使用连字符 ( <code>-</code> ) 或 CIDR 表示法指定 IP 范围。即我们可以使用以下命令扫描 <code>192.168.0.x</code> 网络：</p>
<ul>
<li><code>nmap -sn 192.168.0.1-254</code>or <code>nmap -sn 192.168.0.0/24</code></li>
</ul>
<p><code>-sn</code> 开关告诉 Nmap 不要扫描任何端口——强制它主要依靠 ICMP 回显数据包（或本地网络上的 ARP 请求，如果使用 sudo 运行或直接以 root 用户身份运行）来识别目标。除了 ICMP 回显请求之外， <code>-sn</code> 开关还会导致 nmap 向目标的端口 443 发送 TCP SYN 数据包以及 TCP ACK（如果不以 root 身份运行，则发送 TCP SYN）数据包发送至目标的 80 端口。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216185316277.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216185316277.png" alt="image-20240216185316277"></p>
<p>这里图上去掉+符号</p>
<h1>0x09 NSE 脚本概述</h1>
<p>Nmap 脚本引擎 (NSE) 是 Nmap 的一个非常强大的补充，相当大地扩展了它的功能。 NSE 脚本是用 Lua 编程语言编写的，可用于执行多种操作：从扫描漏洞到自动利用漏洞。 NSE 对于侦察特别有用，但是，值得注意的是脚本库的范围有多大。</p>
<p>有很多类别可供选择。一些有用的类别包括：</p>
<ul>
<li><code>safe</code> :- 不会影响目标</li>
<li><code>intrusive</code> ：- 不安全：可能影响目标</li>
<li><code>vuln</code> ：- 扫描漏洞</li>
<li><code>exploit</code> ：- 尝试利用漏洞</li>
<li><code>auth</code> ：- 尝试绕过正在运行的服务的身份验证（例如匿名登录 FTP 服务器）</li>
<li><code>brute</code> ：- 尝试暴力破解正在运行的服务的凭据</li>
<li><code>discovery</code> ：- 尝试查询正在运行的服务以获取有关网络的更多信息（例如查询 SNMP 服务器）。</li>
</ul>
<p>可以在此处找到更详尽的列表：<a target="_blank" rel="noopener" href="https://nmap.org/book/nse-usage.html">here</a></p>
<p>在下一个任务中，我们将了解如何与 NSE 交互并使用这些类别中的脚本。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216185557080.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216185557080.png" alt="image-20240216185557080"></p>
<h1>0x10 使用 NSE 脚本</h1>
<p>在任务 3 中，我们非常简要地了解了使用 <code>--script=vuln</code> 从 <code>vuln</code> 类别激活 NSE 脚本的 <code>--script</code> 开关。其他类别的工作方式完全相同也就不足为奇了。如果运行命令 <code>--script=safe</code> ，则将针对目标运行任何适用的安全脚本（注意：仅激活针对活动服务的脚本）。</p>
<p>要运行特定脚本，我们将使用 <code>--script=&lt;script-name&gt;</code> ，例如 <code>--script=http-fileupload-exploiter</code> 。</p>
<p>通过用逗号分隔多个脚本可以以这种方式同时运行。例如： <code>--script=smb-enum-users,smb-enum-shares</code> 。</p>
<p>某些脚本需要参数（例如，凭据，如果它们正在利用经过身份验证的漏洞）。这些可以通过 <code>--script-args</code> Nmap 开关给出。一个例子是 <code>http-put</code> 脚本（用于使用 PUT 方法上传文件）。这需要两个参数：将文件上传到的 URL 以及文件在磁盘上的位置。例如：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">nmap -<span class="hljs-selector-tag">p</span> <span class="hljs-number">80</span> <span class="hljs-attr">--script</span> http-put <span class="hljs-attr">--script-args</span> http-put<span class="hljs-selector-class">.url</span>=&#x27;/dav/shell<span class="hljs-selector-class">.php</span>&#x27;,http-put<span class="hljs-selector-class">.file</span>=&#x27;./shell<span class="hljs-selector-class">.php</span>&#x27;<br></code></pre></td></tr></table></figure>
<p>请注意，参数以逗号分隔，并用句点连接到相应的脚本（即 <code>&lt;script-name&gt;.&lt;argument&gt;</code> ）。</p>
<p>可以在此处找到脚本及其相应参数（以及示例用例）的完整列表：<a target="_blank" rel="noopener" href="https://nmap.org/nsedoc/">here</a></p>
<p>Nmap 脚本带有内置帮助菜单，可以使用 <code>nmap --script-help &lt;script-name&gt;</code> 访问。这往往不像上面给出的链接那么广泛，但是，在本地工作时它仍然很有用。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216190408747.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216190408747.png" alt="image-20240216190408747"></p>
<h1>0x11 NSE 搜索脚本</h1>
<p>好的，我们知道了如何使用 Nmap 中的脚本，但我们还不知道如何找到这些脚本。</p>
<p>为此，我们有两种选择，最好将它们结合使用。第一个是 Nmap 网站上的页面（在上一个任务中提到），其中包含所有官方脚本的列表。第二个是攻击机器上的本地存储。 Nmap 将其脚本存储在 Linux 上的 <code>/usr/share/nmap/scripts</code> 处。默认情况下，所有 NSE 脚本都存储在该目录中——当您指定脚本时，Nmap 会在该目录中查找脚本。</p>
<p>有两种方法可以搜索已安装的脚本。一种是使用 <code>/usr/share/nmap/scripts/script.db</code> 文件。尽管有扩展名，但这实际上并不是一个数据库，而是一个包含每个可用脚本的文件名和类别的格式化文本文件。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216190524152.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216190524152.png" alt="image-20240216190524152"></p>
<p>Nmap 使用此文件来跟踪（并利用）脚本引擎的脚本；但是，我们也可以通过 grep 来查找脚本。例如： <code>grep &quot;ftp&quot; /usr/share/nmap/scripts/script.db</code> 。</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216190540863.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216190540863.png" alt="image-20240216190540863"></p>
<p>搜索脚本的第二种方法非常简单，使用 <code>ls</code> 命令。例如，我们可以使用 <code>ls -l /usr/share/nmap/scripts/*ftp*</code> 获得与上一个屏幕截图相同的结果：</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216190618291.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216190618291.png" alt="image-20240216190618291"></p>
<p>请注意搜索词两侧使用星号 ( <code>*</code> )相同的技术也可用于搜索脚本类别。例如：<br>
<code>grep &quot;safe&quot; /usr/share/nmap/scripts/script.db</code></p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216190644073.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216190644073.png" alt="image-20240216190644073"></p>
<p>我们之前提到过，Nmap 网站包含一系列脚本，那么，如果本地 <code>scripts</code> 目录中缺少其中一个脚本，会发生什么情况？标准 <code>sudo apt update &amp;&amp; sudo apt install nmap</code> 应该可以解决这个问题；但是，也可以通过从 Nmap ( <code>sudo wget -O /usr/share/nmap/scripts/&lt;script-name&gt;.nse https://svn.nmap.org/nmap/scripts/&lt;script-name&gt;.nse</code> ) 下载脚本来手动安装脚本。然后必须跟随着 <code>nmap --script-updatedb</code> ，它更新 <code>script.db</code> 文件以包含新下载的脚本。</p>
<p>值得注意的是，如果您要制作自己的 NSE 脚本并将其添加到 Nmap 中，则需要相同的“updatedb”命令——这是一项非常易于管理的任务，只需具备一些 Lua 基础知识即可！</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216191029146.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216191029146.png" alt="image-20240216191029146"></p>
<p>第二问题问的是依赖：</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216191046335.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216191046335.png" alt="image-20240216191046335"></p>
<h1>0x12 防火墙规避</h1>
<p>我们已经看到了一些绕过防火墙的技术（想想隐形扫描，以及 NULL、FIN 和 Xmas 扫描）；然而，还有另一种非常常见的防火墙配置，我们必须知道如何绕过它。</p>
<p>您的典型 Windows 主机将使用其默认防火墙阻止所有 ICMP 数据包。这就带来了一个问题：我们不仅经常使用 ping 来手动建立目标的活动，Nmap 默认情况下也会做同样的事情。这意味着 Nmap 会将具有此防火墙配置的主机注册为死亡主机，并且根本不扫描它。</p>
<p>因此，我们需要一种方法来绕过这个配置。幸运的是，Nmap 为此提供了一个选项： <code>-Pn</code> ，它告诉 Nmap 在扫描主机之前不必费心 ping 主机。这意味着 Nmap 将始终将目标主机视为活动的，从而有效地绕过 ICMP 块；然而，它的代价是可能需要很长时间才能完成扫描（如果主机确实死了，那么 Nmap 仍然会检查并仔细检查每个指定的端口）。</p>
<p>值得注意的是，如果您已经直接位于本地网络上，Nmap 还可以使用 ARP 请求来确定主机活动。</p>
<p>Nmap 认为还有多种其他开关可用于规避防火墙。我们不会详细介绍这些内容，但是可以在这里找到它们：<a target="_blank" rel="noopener" href="https://nmap.org/book/man-bypass-firewalls-ids.html">here</a></p>
<p>以下开关尤其值得注意：</p>
<ul>
<li><code>-f</code> ：- 用于对数据包进行分段（即将它们分成更小的部分），从而降低防火墙或 IDS 检测到数据包的可能性。</li>
<li><code>-f</code> 的替代方案，但提供对数据包大小的更多控制： <code>--mtu &lt;number&gt;</code> ，接受用于发送的数据包的最大传输单元大小。这必须是 8 的倍数。</li>
<li><code>--scan-delay &lt;time&gt;ms</code> ：- 用于在发送的数据包之间添加延迟。如果网络不稳定，这非常有用，而且还可以逃避任何可能存在的基于时间的防火墙/IDS 触发器。</li>
<li><code>--badsum</code> ：- 这用于生成数据包的无效校验和。任何真正的 TCP/IP 堆栈都会丢弃此数据包，但是，防火墙可能会自动响应，而无需检查数据包的校验和。因此，该开关可用于确定防火墙/IDS 的存在。</li>
</ul>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216191652525.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216191652525.png" alt="image-20240216191652525"></p>
<h1>0x13 实践</h1>
<p>采用直接ping目标机或者nmap 的-PE选项确定ping请求</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">nmap -sX -<span class="hljs-selector-tag">p</span> <span class="hljs-number">1</span>-<span class="hljs-number">999</span> -Pn <span class="hljs-number">10.10</span><span class="hljs-selector-class">.162</span><span class="hljs-selector-class">.155</span> -vv<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216193100002.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216193100002.png" alt="image-20240216193100002"></p>
<p>这里说999个端口都是被过滤的</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">nmap -sS -<span class="hljs-selector-tag">p</span> <span class="hljs-number">1</span>-<span class="hljs-number">5000</span> -Pn <span class="hljs-number">10.10</span><span class="hljs-selector-class">.162</span><span class="hljs-selector-class">.155</span> -vv<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216193418154.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216193418154.png" alt="image-20240216193418154"></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">nmap -Pn <span class="hljs-attr">--script</span>=ftp-anon -<span class="hljs-selector-tag">p</span> <span class="hljs-number">21</span> <span class="hljs-number">10.10</span><span class="hljs-selector-class">.162</span><span class="hljs-selector-class">.155</span> -vv<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216193801089.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216193801089.png" alt="image-20240216193801089"></p>
<p>可以看到允许登录21端口</p>
<p class='item-img' data-src='https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216193832775.png'><img src="https://gitee.com/he-yi-beichen-star/local_images/raw/master/images/image-20240216193832775.png" alt="image-20240216193832775"></p>
<h1>0x14 参考文章</h1>
<p><a target="_blank" rel="noopener" href="https://grumpyghost1011.medium.com/nmap-room-tryhackme-walkthrough-%EF%B8%8F-4fdf25829f1d"><strong>Nmap Room Tryhackme Walkthrough</strong></a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2024/02/19/THM-Persisting%20Active%20Directory/">← Next THM-Persisting Active Directory</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2024/02/16/THM-Lateral%20Movement%20and%20Pivoting/">THM-Lateral Movement and Pivoting Prev →</a></div></div></div><div id="comments"><div id="waline"></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">hybcx</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">0x01 简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">0x02 Nmap选项</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">0x03 扫描类型概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">0x04 TCP 扫描</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">0x05 SYN 扫描</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">0x06 UDP 扫描</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">0x07 NULL、FIN、Xmas扫描</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">8.</span> <span class="toc-text">0x08 ICMP 扫描</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">9.</span> <span class="toc-text">0x09 NSE 脚本概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">10.</span> <span class="toc-text">0x10 使用 NSE 脚本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">11.</span> <span class="toc-text">0x11 NSE 搜索脚本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">12.</span> <span class="toc-text">0x12 防火墙规避</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">13.</span> <span class="toc-text">0x13 实践</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">14.</span> <span class="toc-text">0x14 参考文章</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script type="module">import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
window.waline = init;
</script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {if (document.querySelector('#waline'))
 waline({
   el: '#waline',
   dark: ':root[theme-mode="dark"]',
   serverURL: 'https://waline-blog-iwqdtxise-hybchenxing.vercel.app',
   path: window.location.pathname,
 });document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>